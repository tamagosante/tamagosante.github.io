const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-eHP58yiE.js","assets/react-vendor-Byz07MLO.js","assets/utils-DJ2ViQ2u.js","assets/radix-ui-v9Pxfv0s.js","assets/ui-utils-BxIQ3qGg.js","assets/icons-vtiX7BHn.js","assets/index-BKEMbhBP.css"])))=>i.map(i=>d[i]);
var Cu=Object.defineProperty;var ju=(e,s,n)=>s in e?Cu(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n;var qe=(e,s,n)=>ju(e,typeof s!="symbol"?s+"":s,n);import{R as He,j as t,r as p,b as Cs}from"./react-vendor-Byz07MLO.js";import{cd as dl,ce as Kn,N as T,cf as ku,cg as zs,ch as ee,ci as Dt,cj as Iu,ck as Au,K as Ve,ai as Q,aT as ke,J as fe,cl as Tu,cm as $s,cn as Ls,co as Ft,cp as Pe,cq as bs,cr as Ns,cs as It,aS as Eu,aV as Ws,ct as un,cu as nn,cv as eo,cw as qn,cx as ct,cy as Ar,cz as At,aK as ul,ah as ps,cA as hl,cB as Ru,cC as Go,ab as We,a as se,V as Ie,bd as es,a_ as _t,a$ as Ut,b0 as Vt,cD as Mu,aU as oi,cE as ai,z as Yo,F as Tr,cb as Xo,E as pl,T as Er,bU as gl,bV as Pu,bW as fl,bX as ml,bY as xl,ac as et,I as ze,cF as dt,aW as ri,aQ as Du,aA as St,aB as Ct,aC as jt,cG as Ou,cH as yl,S as yt,h as wt,i as vt,j as bt,k as Qe,aj as Xe,ad as to,ae as Ko,af as so,ag as nt,L as Fe,m as Lu,n as Wu,o as ii,p as ci,cI as fs,B as lt,l as qo,aZ as Hu,cJ as li,cK as di,cL as Fu,bO as ui,bP as Bu,cM as zu,b2 as $u,g as ya,b3 as _u,b4 as hi,az as Rr,be as wl,bm as Us,cN as Uu,cO as Wn,Q as Es,ay as Rs,R as Ms,cP as Vu,cQ as Ps,al as cs,am as pi,aw as hn,cR as Gu,cS as Hn,cT as Fn,cU as Bn,cV as Yu,cW as on,cX as Xu,cY as Ku,cZ as ar,c_ as qu,c$ as vl,d0 as bl,d1 as Ho,d2 as Nl,d3 as Zu,d4 as Ju,y as jn,d5 as Qu,ar as eh,d6 as Oa,d7 as th,d8 as sh,d9 as nh,da as Sl,u as oh,r as ah,s as rh,M as ih,w as rr,db as ch,dc as lh,bb as gi,dd as dh,de as uh,bI as hh,bJ as ph,bK as La,bL as Wa,df as Ha,dg as gh,aE as fh,bZ as mh,b_ as xh,dh as yh,b9 as wh,ba as vh,di as bh,dj as Nh}from"./index-eHP58yiE.js";import{g as Sh,c as ht,V as zn,I as Cl,K as Ch,S as jh,C as kh,R as Ih,a as Ah,d as Th}from"./VimInputHandlerV2-DJs-ook4.js";import{t as Ee}from"./utils-DJ2ViQ2u.js";import{a as Me}from"./ui-utils-BxIQ3qGg.js";import{bf as fi,f as go,be as wa,aA as Zn,ch as no,o as Pt,C as vn,aJ as Eh,b as Rh,I as Mh,b0 as Fo,c8 as va,aT as Hs,bl as jl,a as ft,a1 as Ph,p as Dh,cl as Oh,a5 as Zt,T as Nt,cm as Lh,cn as Wh,W as kl,ae as Hh,a$ as Fh,co as Bh,b6 as ts,c as Fs,N as Mr,bA as ba,cp as Il,S as hs,e as Bt,A as oo,cq as Al,bz as zh,cr as $h,b7 as an,b3 as Tl,w as Tt,cs as El,ct as Na,cu as _h,cv as Uh,cw as Vh,cx as Gh,cy as Yh,cz as Xh,H as Kh,aQ as _s,$ as Zo,cA as Pr,cB as qh,a3 as Rl,a4 as Ml,cC as Pl,cD as Dl,cE as Ol,cF as Ll,a6 as fo,cG as Bs,cH as Wl,cI as Hl,cJ as kn,cK as Zh,L as mi,cL as Jt,cM as Ds,bp as ao,bq as ro,aa as pn,cN as Sa,cO as ir,aV as Jh,cP as xi,m as Fl,bC as mo,ap as io,ar as co,cQ as Dr,cR as Or,aq as Bl,cS as Bo,bs as lo,cT as zl,aW as Lr,ad as Wr,bK as Qh,cU as ep,a9 as Ca,bB as Hr,aw as vs,R as ja,cV as tp,cW as sp,cX as np,bU as op,cY as ap,cZ as rp,c_ as $l,c$ as Fr,X as Ke,az as uo,cc as _l,d0 as Ul,G as ip,x as Ss,d1 as cp,a7 as lp,F as Vl,b8 as dp,c5 as up,q as ss,ck as hp,bb as ka,d as xo,ai as pp,u as Gl,E as us,d2 as Ia,b5 as gp,y as fp,U as ho,a8 as Jo,d3 as Yl,av as mp,d4 as xp,bL as yp,ci as wp,d5 as vp,d6 as yi,d7 as wi,d8 as Qo,aY as bp,ao as Os,D as zo,t as Xl,bi as Np,d9 as Sp,_ as Kl,aR as Cp,bc as jp,da as kp,db as Ip,dc as Ap,dd as Tp,de as Ep,bt as Rp,l as Mp,ce as Pp,df as Dp,ca as Op,cb as Lp,K as Wp,au as Hp,j as ea,dg as Fp,dh as ql,di as Bp,ba as zp,dj as $p,r as Zl,dk as _p,bu as Up,dl as Vp}from"./icons-vtiX7BHn.js";import{V as Kt,E as Gp,D as Yp}from"./logging-DNAPNJun.js";import{U as po}from"./UiButtonWithExpandOption-h1AbWOIL.js";import{T as Xp}from"./TextareaPopoverAtCursor-BhwkV6wH.js";import{d as Kp,t as vi}from"./definitionHelper-DuYF3Asi.js";import{D as gn}from"./DraggableCrudTree-CyO8j1zi.js";import{globalFacadeRegistry as at}from"./globalFacadeRegistry-BlelMPVg.js";import{W as fn,S as Jn,C as qp,a as Zp,N as Jp,I as Qp,e as bi}from"./WorkflowRowItem-iqt932NO.js";import{a as eg,U as tg}from"./UiDataTable-BJzbkTin.js";import{a as Ni}from"./markdownToHtml-C-4HvgxL.js";import{D as sg}from"./DragDropManager-KcuPnjwl.js";import{D as ng}from"./DraggableTree-Dr3LK8bf.js";import{u as og}from"./useOcr-BhvO77pd.js";import{A as ag,a as rg}from"./alert-D9C8hSnn.js";import{J as Jl}from"./JsonViewerApp-BHZpouoC.js";import{a as ig,b as cg}from"./easy-form-DAFxRHyz.js";import{S as lg}from"./SessionSidebar-BExSPAHd.js";import{u as dg,S as ug}from"./SlashCommandMenu-DAHzvOSL.js";import{g as hg}from"./cursorPosition-otMhJ5rZ.js";import{a as Si}from"./string-4WCj7OpV.js";import{u as pg,b as gg,a as fg}from"./react-hooks-rjLLAVfy.js";import{M as mg}from"./MobileSheet-8BahCbCX.js";const xg=e=>e;function Ot(e,s=xg){const n=He.useSyncExternalStore(e.subscribe,He.useCallback(()=>s(e.getState()),[e,s]),He.useCallback(()=>s(e.getInitialState()),[e,s]));return He.useDebugValue(n),n}const Ci=e=>{const s=dl(e),n=o=>Ot(s,o);return Object.assign(n,s),n},wC=(e=>e?Ci(e):Ci),js=[],$=e=>Ot(T,e),mn=e=>Ot(Kn,e),yg=(e,s)=>e.replace(/(\d+\.\d+)/g,n=>parseFloat(n).toFixed(s)),wg=(e,s,n)=>{var a,i;if(s===0&&n===0)return e;let o="",r=0;for(;r<e.length;){const c=e[r];if(/[A-Za-z]/.test(c)){o+=c,r++;continue}if(/[\s,]/.test(c)){o+=c,r++;continue}let l="";for(;r<e.length&&/[\d.\-+eE]/.test(e[r]);)l+=e[r],r++;if(l){const d=((i=(a=o.match(/[A-Za-z](?=[^A-Za-z]*$)/))==null?void 0:a[0])==null?void 0:i.toUpperCase())||"M",u=(o.slice(o.lastIndexOf(d)+1).match(/-?\d+\.?\d*/g)||[]).length,f=parseFloat(l);let m=f;if(d==="H")m=f+s;else if(d==="V")m=f+n;else if(d==="A"){const y=u%7;y===5?m=f+s:y===6&&(m=f+n)}else u%2===0?m=f+s:m=f+n;o+=m}}return o},vg=(e,s)=>{if(s>=1||e.length<=2)return e;const n=Math.max(1,Math.floor(1/s)),o=[];o.push(e[0]);for(let r=n;r<e.length-1;r+=n)o.push(e[r]);return e.length>1&&o.push(e[e.length-1]),o},Ql=(e,s)=>{const n=s/100,o=Math.max(0,Math.floor(s/100*4));return{points:vg(e.points,n),smoothedPath:yg(e.smoothedPath,o)}},ed=(e,s)=>e.type==="freehand"&&e.stroke?{...e,stroke:Ql(e.stroke,s)}:e,td=(e,s)=>{if(s>=100)return e;const n={...e};return e.stroke&&(n.stroke=Ql(e.stroke,s)),e.elements&&(n.elements=e.elements.map(o=>ed(o,s))),n},sd=p.createContext(null),bg=({children:e,value:s})=>t.jsx(sd.Provider,{value:s,children:e}),nd=()=>{const e=p.useContext(sd);if(e===null)throw new Error("useCanvasRef must be used within a CanvasRefProvider");return e},Ng=e=>{const s=nd(),n=p.useRef(e);p.useEffect(()=>{n.current=e},[e]),p.useEffect(()=>{const o=s.current;if(!o)return;const r=N=>{var k,S;const b=["[data-prevent-canvas-click]"],A=N.target;b.some(E=>A.closest(E))||(S=(k=n.current.pointer)==null?void 0:k.onPointerDown)==null||S.call(k,N)},a=N=>{var b,A;return(A=(b=n.current.pointer)==null?void 0:b.onPointerMove)==null?void 0:A.call(b,N)},i=N=>{var b,A;return(A=(b=n.current.pointer)==null?void 0:b.onPointerUp)==null?void 0:A.call(b,N)},c=N=>{var b,A;return(A=(b=n.current.pointer)==null?void 0:b.onPointerLeave)==null?void 0:A.call(b,N)},l=N=>{var k,S;const b=["#itemList"],A=N.target;b.some(E=>A.closest(E))||(S=(k=n.current).wheel)==null||S.call(k,N)},d=N=>{var b,A;return(A=(b=n.current.keyboard)==null?void 0:b.onKeyDown)==null?void 0:A.call(b,N)},h=N=>{var b,A;return(A=(b=n.current.keyboard)==null?void 0:b.onKeyUp)==null?void 0:A.call(b,N)},u=N=>{var b,A;return(A=(b=n.current.keyboard)==null?void 0:b.onCopy)==null?void 0:A.call(b,N)},f=N=>{var b,A;return(A=(b=n.current.touch)==null?void 0:b.onTouchStart)==null?void 0:A.call(b,N)},m=N=>{var b,A;return(A=(b=n.current.touch)==null?void 0:b.onTouchMove)==null?void 0:A.call(b,N)},y=N=>{var b,A;return(A=(b=n.current.touch)==null?void 0:b.onTouchEnd)==null?void 0:A.call(b,N)},{pointer:g,wheel:x,touch:w,keyboard:v}=e;return g!=null&&g.onPointerDown&&o.addEventListener("pointerdown",r),g!=null&&g.onPointerMove&&o.addEventListener("pointermove",a),g!=null&&g.onPointerUp&&window.addEventListener("pointerup",i),g!=null&&g.onPointerLeave&&o.addEventListener("pointerleave",c),x&&o.addEventListener("wheel",l,{passive:!1}),w!=null&&w.onTouchStart&&o.addEventListener("touchstart",f,{passive:!1}),w!=null&&w.onTouchMove&&o.addEventListener("touchmove",m,{passive:!1}),w!=null&&w.onTouchEnd&&o.addEventListener("touchend",y,{passive:!1}),v!=null&&v.onKeyDown&&window.addEventListener("keydown",d),v!=null&&v.onKeyUp&&window.addEventListener("keyup",h),v!=null&&v.onCopy&&window.addEventListener("copy",u),()=>{g!=null&&g.onPointerDown&&o.removeEventListener("pointerdown",r),g!=null&&g.onPointerMove&&o.removeEventListener("pointermove",a),g!=null&&g.onPointerUp&&window.removeEventListener("pointerup",i),g!=null&&g.onPointerLeave&&o.removeEventListener("pointerleave",c),x&&o.removeEventListener("wheel",l),w!=null&&w.onTouchStart&&o.removeEventListener("touchstart",f),w!=null&&w.onTouchMove&&o.removeEventListener("touchmove",m),w!=null&&w.onTouchEnd&&o.removeEventListener("touchend",y),v!=null&&v.onKeyDown&&window.removeEventListener("keydown",d),v!=null&&v.onKeyUp&&window.removeEventListener("keyup",h)}},[s])},Br=()=>{const e=nd();return p.useCallback(s=>{const n=e.current;if(!n)return console.error("Canvas container ref not available in useGetRelativeMousePos"),{x:0,y:0};const o=n.getBoundingClientRect();return{x:s.clientX-o.left,y:s.clientY-o.top}},[e])};function Sg(e){var a,i;const s=e;if(!s){(a=window.getSelection())==null||a.removeAllRanges();return}const n=s.tagName==="TEXTAREA",o=s.tagName==="INPUT",r=s.isContentEditable||!!s.closest('[contenteditable="true"]');n||o||r||(i=window.getSelection())==null||i.removeAllRanges()}function Cg(e){const{selector:s,delay:n=ku,onFocused:o}=e,r=document.createElement("input");r.style.cssText="position:absolute;opacity:0;height:0;width:0;pointer-events:none;",document.body.appendChild(r),r.focus(),setTimeout(()=>{const a=document.querySelector(s);a&&(a.getAttribute("contenteditable")!=="true"&&(a.contentEditable="true"),a.focus({preventScroll:!0}),o==null||o(a)),r.remove()},n)}const xn=new zs("useCanvasMouseEventsV2",$s.useCanvasMouseEventsV2),jg=e=>{const s=e.target,n=s.closest("[data-canvas-container]");return!n||s.closest("[data-ui-panel]")?null:n},kg=()=>{p.useEffect(()=>{const e=()=>{if(document.pointerLockElement===null){const s=T.getState().uiState.mode,n=T.getState().uiState.zoomSubMode;if(s===ee.ZOOM&&n==="zoom:lock"){const o=T.getState().setZoomSubMode;o("zoom"),xn.log("Pointer lock released, reset to zoom mode")}}};return document.addEventListener("pointerlockchange",e),()=>{document.removeEventListener("pointerlockchange",e)}},[])},Ig=e=>{const s=Br(),n=mn(i=>i.setMousePosition),o=T.getState(),r=o.uiState.mode,a=o.setIsPanning;return p.useCallback(i=>{const c=s(i);n(c),xn.log("Generic Pointer Down:",c.x,c.y),Sg(i.target);const l=T.getState().uiState.mode,d=T.getState().uiState.zoomSubMode;if(l===ee.ZOOM&&i.button===0){const x=jg(i);if(x){const w=T.getState().setZoomSubMode;d==="zoom:lock"?document.exitPointerLock():(x.requestPointerLock(),w("zoom:lock")),i.preventDefault();return}}if(!(i.button===1||i.button===0&&r===ee.MOVE||i.button===-1))return;const u=i.target,f=u.closest("[data-node-id]"),m=u.id.includes("resize-handle-"),y=u.closest("[data-ui-panel]");if(m||y)return;let g=!1;r===ee.MOVE?g=!0:f||(g=!0),g&&(xn.log("Starting Panning"),a(!0),e(c),i.preventDefault())},[s,n,a,e,r])},Ag=()=>{var i;const e=Br(),s=T.getState(),n=(i=s.uiState)==null?void 0:i.isPanning,o=mn(c=>c.setMousePosition),r=s.setActiveCanvasViewState,a=mn(c=>c.mousePosition);return p.useCallback(c=>{const l=T.getState().uiState.mode,d=T.getState().uiState.zoomSubMode,h=document.pointerLockElement!==null;if(l===ee.ZOOM&&d==="zoom:lock"&&h){const m=c.movementX,y=c.movementY;r(g=>({...g,offset:{x:g.offset.x+m,y:g.offset.y+y}}));return}const f=e(c);if(n&&a){const m=f.x-a.x,y=f.y-a.y;if(c.pointerType==="touch"){o(f);return}r(g=>({...g,offset:{x:g.offset.x+m,y:g.offset.y+y}}))}o(f)},[e,o,n,a,r])},Tg=e=>{var a;const s=Br(),n=T.getState(),o=(a=n.uiState)==null?void 0:a.isPanning,r=n.setIsPanning;return p.useCallback(i=>{const c=s(i);xn.log("Generic Pointer Up:",c.x,c.y),o&&(r(!1),e(null),xn.log("Stopped Panning"))},[s,o,r,e])},Eg=e=>{var a;const s=T.getState(),n=(a=s.uiState)==null?void 0:a.isPanning,o=s.setIsPanning,r=mn(i=>i.setMousePosition);return p.useCallback(()=>{n&&(o(!1),e(null),xn.log("Stopped Panning (Mouse Leave)")),r(null)},[n,o,e,r])},In={current:null},Fa={current:null},Ba={current:0},Rg=()=>{const e=T.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=mn(r=>r.mousePosition);return p.useCallback(r=>{r.preventDefault();const a=s();if(!a)return;const{scale:i,offset:c}=a.viewState,d=T.getState().uiState.mode===ee.ZOOM;if(r.ctrlKey||r.metaKey||d){if(!o)return;const{min:h,max:u,intensity:f}=Q.zoom,m=r.deltaY<0?1:-1;let y;if(i<=.1){const k=i+m*.01;y=Math.max(h,Math.min(u,k)),y=Math.round(y*100)/100}else{const k=i+m*f*i,S=Math.max(h,Math.min(u,k));y=(m>0?Math.ceil:Math.floor)(S*10)/10}if(y===i)return;const g=Dt(o,i,c),x=o.x-g.x*y,w=o.y-g.y*y,v=isNaN(x)?0:x,N=isNaN(w)?0:w,b=isNaN(y)?1:y,A=performance.now(),R=A-Ba.current;In.current={newScale:b,newOffsetX:v,newOffsetY:N},R>=16?(n(k=>({...k,scale:b,offset:{x:v,y:N}})),Ba.current=A,In.current=null):(Fa.current&&clearTimeout(Fa.current),Fa.current=setTimeout(()=>{if(In.current){const{newScale:k,newOffsetX:S,newOffsetY:E}=In.current;n(C=>({...C,scale:k,offset:{x:S,y:E}})),Ba.current=performance.now(),In.current=null}},16-R))}else n(h=>{var w,v;let u=r.deltaX,f=r.deltaY;r.shiftKey&&(u=f,f=0);const m=(((w=h.offset)==null?void 0:w.x)??0)-u,y=(((v=h.offset)==null?void 0:v.y)??0)-f,g=isNaN(m)?0:m,x=isNaN(y)?0:y;return{...h,offset:{x:g,y:x}}})},[s,n,o])};let Is=null;const Mg=()=>p.useCallback(e=>{var f;const s=Date.now(),n={time:s,x:e.clientX,y:e.clientY};if(Is){const m=s-Is.time,y=Math.sqrt(Math.pow(n.x-Is.x,2)+Math.pow(n.y-Is.y,2));if(m>Iu||y>Au){Is=n;return}}else{Is=n;return}Is=null;const o=T.getState();if(o.uiState.mode!==ee.SELECT||e.target.closest("[data-node-id], [data-arrow-id], [data-test='canvas-chat-input-container'], [data-prevent-canvas-click]"))return;const i=o.getCanvasMouseCoords();if(!i)return;const c=window.innerWidth<Ls,l=Ve(10),d=Q.chatInput.mobile.fontConfig,h=c?d.cssFontSize:void 0,u=c?d.baseNodeHeight:ke.DEFAULT_NODE_HEIGHT;if(o.addNode({id:l,x:i.x,y:i.y,content:"",type:fe.TEXT,height:u,...c&&{styles:{fontSize:h}}}),o.setNodeToFocusId(l),c&&((f=o.projectCanvas.getActive())==null?void 0:f.viewState)){const y=document.querySelector("[data-canvas-container]"),g=(y==null?void 0:y.getBoundingClientRect().top)??0,x=(y==null?void 0:y.getBoundingClientRect().left)??0,w=window.innerWidth,v=window.innerHeight,N=ke.DEFAULT_NODE_WIDTH,b=ke.DEFAULT_NODE_HEIGHT,A=w/2,R=(v-g)/2+g,k=i.x+N/2,S=i.y+b/2,E=A-x-k,C=R-g-S;o.setActiveCanvasViewState(I=>({...I,targetView:{targetOffset:{x:E,y:C},targetScale:1,animationStartTime:0,animationDuration:Tu}}))}c&&Cg({selector:`#NodeContainerV2-${l} .markdown-textarea`}),e.preventDefault(),e.stopPropagation()},[]),ot={createTemporaryDrawing:(e,s,n=Ft)=>{const o=e===Pe.FREEHAND;return{subMode:e,points:o?[s]:[],startPoint:o?void 0:s,endPoint:o?void 0:s,style:n}},updateFreehandPoints:(e,s)=>({...e,points:[...e.points,s]}),updateShapeEndPoint:(e,s)=>({...e,endPoint:s}),canFinalizeDraw:e=>e.subMode===Pe.FREEHAND?e.points.length>=2:!e.startPoint||!e.endPoint?!1:Math.hypot(e.endPoint.x-e.startPoint.x,e.endPoint.y-e.startPoint.y)>=5,simplifyPoints:(e,s=2)=>{if(e.length<=2)return e;const n=s*s,o=(i,c,l)=>{let d=0,h=c;const u=i[c],f=i[l],m=f.x-u.x,y=f.y-u.y,g=m*m+y*y;for(let x=c+1;x<l;x++){const w=i[x];let v;if(g===0)v=(w.x-u.x)**2+(w.y-u.y)**2;else{const N=Math.max(0,Math.min(1,((w.x-u.x)*m+(w.y-u.y)*y)/g)),b=u.x+N*m,A=u.y+N*y;v=(w.x-b)**2+(w.y-A)**2}v>d&&(d=v,h=x)}return{index:h,distance:d}},r=(i,c,l,d)=>{const{index:h,distance:u}=o(i,c,l);u>n&&(d[h]=!0,r(i,c,h,d),r(i,h,l,d))},a=new Array(e.length).fill(!1);return a[0]=!0,a[e.length-1]=!0,r(e,0,e.length-1,a),e.filter((i,c)=>a[c])},smoothToSVGPath:(e,s=.5)=>{if(e.length===0)return"";if(e.length===1)return`M ${e[0].x} ${e[0].y}`;if(e.length===2)return`M ${e[0].x} ${e[0].y} L ${e[1].x} ${e[1].y}`;const n=(r,a,i,c)=>{const l=s,d=a.x+(i.x-r.x)*l/6,h=a.y+(i.y-r.y)*l/6,u=i.x-(c.x-a.x)*l/6,f=i.y-(c.y-a.y)*l/6;return`C ${d} ${h}, ${u} ${f}, ${i.x} ${i.y}`};let o=`M ${e[0].x} ${e[0].y}`;o+=" "+n(e[0],e[0],e[1],e[2]||e[1]);for(let r=1;r<e.length-2;r++)o+=" "+n(e[r-1],e[r],e[r+1],e[r+2]);if(e.length>2){const r=e.length-1;o+=" "+n(e[r-2],e[r-1],e[r],e[r])}return o},pointsToPolylinePath:e=>e.length===0?"":e.length===1?`M ${e[0].x} ${e[0].y}`:`M ${e[0].x} ${e[0].y} `+e.slice(1).map(s=>`L ${s.x} ${s.y}`).join(" "),generateShapeSVGPath:e=>{const{shapeType:s,startPoint:n,endPoint:o}=e;switch(s){case"line":return`M ${n.x} ${n.y} L ${o.x} ${o.y}`;case"rectangle":{const r=Math.min(n.x,o.x),a=Math.min(n.y,o.y),i=Math.abs(o.x-n.x),c=Math.abs(o.y-n.y);return`M ${r} ${a} h ${i} v ${c} h ${-i} Z`}case"square":{const r=Math.min(Math.abs(o.x-n.x),Math.abs(o.y-n.y)),a=o.x>=n.x?n.x:n.x-r,i=o.y>=n.y?n.y:n.y-r;return`M ${a} ${i} h ${r} v ${r} h ${-r} Z`}case"circle":{const r=(n.x+o.x)/2,a=(n.y+o.y)/2,i=Math.hypot(o.x-n.x,o.y-n.y)/2;return`M ${r-i} ${a} A ${i} ${i} 0 1 0 ${r+i} ${a} A ${i} ${i} 0 1 0 ${r-i} ${a}`}case"ellipse":{const r=Math.abs(o.x-n.x),a=Math.abs(o.y-n.y),i=o.x>=n.x?1:-1,c=o.y>=n.y?1:-1,l=n.x+i*r/2,d=n.y+c*a/2,h=r/2,u=a/2;return`M ${l-h} ${d} A ${h} ${u} 0 1 0 ${l+h} ${d} A ${h} ${u} 0 1 0 ${l-h} ${d}`}case"arrow":{const r=o.x-n.x,a=o.y-n.y,i=Math.hypot(r,a);if(i<1)return"";const c=r/i,l=a/i,d=Math.min(20,Math.max(8,i*.2)),h=d*.6,u=o.x-c*d,f=o.y-l*d,m=-l,y=c,g=u+m*h,x=f+y*h,w=u-m*h,v=f-y*h;return`M ${n.x} ${n.y} L ${u} ${f} M ${o.x} ${o.y} L ${g} ${x} L ${w} ${v} Z`}default:return""}},calculateFreehandBounds:e=>{if(e.length===0)return{x:0,y:0,width:0,height:0};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e)a.x<s&&(s=a.x),a.y<n&&(n=a.y),a.x>o&&(o=a.x),a.y>r&&(r=a.y);return{x:s,y:n,width:o-s,height:r-n}},calculateShapeBounds:(e,s,n)=>{if(n==="circle"){const c=(e.x+s.x)/2,l=(e.y+s.y)/2,d=Math.hypot(s.x-e.x,s.y-e.y)/2;return{x:c-d,y:l-d,width:d*2,height:d*2}}if(n==="square"){const c=Math.min(Math.abs(s.x-e.x),Math.abs(s.y-e.y)),l=s.x>=e.x?e.x:e.x-c,d=s.y>=e.y?e.y:e.y-c;return{x:l,y:d,width:c,height:c}}const o=Math.min(e.x,s.x),r=Math.min(e.y,s.y),a=Math.abs(s.x-e.x),i=Math.abs(s.y-e.y);return{x:o,y:r,width:a,height:i}},calculateBounds:e=>e.drawType==="freehand"&&e.stroke?ot.calculateFreehandBounds(e.stroke.points):e.drawType==="shape"&&e.shape?ot.calculateShapeBounds(e.shape.startPoint,e.shape.endPoint,e.shape.shapeType):{x:0,y:0,width:0,height:0},normalizePoints:(e,s)=>e.map(n=>({x:n.x-s.x,y:n.y-s.y})),finalizeDrawing:e=>{if(!ot.canFinalizeDraw(e))return null;const s=(e.style.strokeWidth??2)/2;if(e.subMode===Pe.FREEHAND){const c=ot.calculateFreehandBounds(e.points),l={x:c.x-s,y:c.y-s},h=e.points.length>20?ot.simplifyPoints(e.points,2):e.points,u=ot.normalizePoints(h,l),f=ot.smoothToSVGPath(u);return{drawType:"freehand",stroke:{points:ot.normalizePoints(e.points,l),smoothedPath:f},style:e.style}}if(!e.startPoint||!e.endPoint)return null;const o={[Pe.RECTANGLE]:"rectangle",[Pe.SQUARE]:"square",[Pe.CIRCLE]:"circle",[Pe.ELLIPSE]:"ellipse",[Pe.LINE]:"line",[Pe.ARROW]:"arrow",[Pe.FREEHAND]:"rectangle"}[e.subMode],r=ot.calculateShapeBounds(e.startPoint,e.endPoint,o),a={x:r.x-s,y:r.y-s};return{drawType:"shape",shape:{shapeType:o,startPoint:{x:e.startPoint.x-a.x,y:e.startPoint.y-a.y},endPoint:{x:e.endPoint.x-a.x,y:e.endPoint.y-a.y}},style:e.style}},getSubModeFromKey:e=>{switch(e){case"1":return Pe.FREEHAND;case"2":return Pe.RECTANGLE;case"3":return Pe.SQUARE;case"4":return Pe.CIRCLE;case"5":return Pe.ELLIPSE;case"6":return Pe.LINE;case"7":return Pe.ARROW;default:return null}},getSubModeLabel:e=>{switch(e){case Pe.FREEHAND:return"Freehand";case Pe.RECTANGLE:return"Rectangle";case Pe.SQUARE:return"Square";case Pe.CIRCLE:return"Circle";case Pe.ELLIPSE:return"Ellipse";case Pe.LINE:return"Line";case Pe.ARROW:return"Arrow";default:return"Draw"}}};class Ye{static buildTextNode(s,n,o){return{id:Ve(10),type:fe.TEXT,content:n,x:s.x,y:s.y,width:s.width,height:s.height,styles:o}}static buildTextNodeV2(s){return{id:Ve(10),type:fe.TEXT,content:s.content||"",x:s.x||0,y:s.y||0,width:s.width||100,height:s.height||100,styles:s.styles||{},options:s.options||{lockSize:!0},...s}}static buildTableNode(s){return{id:Ve(10),type:fe.TABLE,content:null,data:{columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},x:s.x,y:s.y,width:s.width||400,height:s.height||250,styles:{textAlign:"left"}}}static buildTextCardNode(s){return{id:Ve(10),type:fe.TEXTCARD,title:"",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||150,styles:{textAlign:"left"}}}static buildWorkflowOrchestrationNode(s){return{id:`wf-orchestration-${Ve(6)}`,type:fe.WORKFLOW_ORCHESTRATION,title:"Workflow",content:"",x:s.x,y:s.y,width:s.width||400,height:s.height||500,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:[{id:"row_1",label:"Step 1",order:1,stepType:"source",children:[]}]}}}}static buildWorkflowSourceNode(s){return{id:`wf-source-${Ve(6)}`,type:fe.WORKFLOW_SOURCE,title:"Source",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||200,data:{displayFormat:"raw"}}}static buildWorkflowDefinitionNode(s){return{id:`wf-def-${Ve(6)}`,type:fe.WORKFLOW_DEFINITION,title:"Workflow Runner",content:"",x:s.x,y:s.y,width:s.width||280,height:s.height||180,data:{definitionId:void 0,instanceId:void 0,lastExecutionStatus:"idle"}}}static buildOCRNode(s){return{id:`ocr-${Ve(6)}`,type:fe.OCR,title:"OCR",content:"",x:s.x,y:s.y,width:s.width||350,height:s.height||500,data:{image:void 0,extractedText:void 0,detectedLanguage:void 0,confidence:void 0}}}static buildImageNode(s){return{id:`img-${Ve(6)}`,type:fe.IMAGE,title:"Image",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||250,data:{image:void 0}}}static buildWorkflowStepNode(s){return{id:`wf-step-${Ve(6)}`,type:fe.WORKFLOW_STEP,title:"Workflow Step",content:"",x:s.x,y:s.y,width:s.width||260,height:s.height||180,data:{stepType:void 0,config:{}}}}static buildVocabularyNode(s){return{id:`vocab-${Ve(6)}`,type:fe.VOCABULARY,title:"Vocabulary",content:"",x:s.x,y:s.y,width:s.width||320,height:s.height||280,data:{vocabType:"vocabulary",term:"",definition:"",sourceWord:"",translationWord:""}}}static buildDrawingNode(s,n){return{id:`draw-${Ve(6)}`,type:fe.DRAWING,content:"",x:s.x,y:s.y,width:s.width||100,height:s.height||100,data:n}}}const Pg=Object.freeze(Object.defineProperty({__proto__:null,CanvasNodeBuilderV2:Ye},Symbol.toStringTag,{value:"Module"}));function Aa(e,s,n="right",o={}){var h;const{shouldFocus:r=!0,createArrow:a=!0}=o,i=T.getState();let c=e.width,l=e.height;if(!c||!l){const u=Q.nodeOptions.maxNodeWidth;c=Math.min(bs(e.content),u)+Ns.textNodeXPadding,l=It(e.content,c,e)}switch((h=i.projectCanvas.getActive())==null||h.viewState.offset,n){case"left":e.x=s.x-c-ke.nodeSpacing*3,e.y=s.y;break;case"right":e.x=s.x+(s.width??0)+ke.nodeSpacing*3,e.y=s.y;break;case"above":e.y=s.y-ke.nodeSpacing*3;break;case"below":e.y=s.y+(s.height??0)+ke.nodeSpacing;break}const d={...e,width:c,height:l};if(i.addNode(d,void 0,{dontOverlap:!0,dontSelect:!0}),r&&i.setNodeToFocusId(s.id),a){const u=()=>Math.random().toString(36).slice(2,10),f=m=>({x:(m.x??0)+(m.width??0)/2,y:(m.y??0)+(m.height??0)/2});window.setTimeout(()=>{i.arrow.add({id:u(),startNodeId:s.id,endNodeId:d.id,startPoint:f(s),endPoint:f(d)})},0)}}function od(e,s,n){let o=e;for(;o&&!o.hasAttribute("data-text-position-container");)o=o.parentElement;if(!o)return null;const r=window.getComputedStyle(e),a=document.createElement("div");a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.visibility="hidden",a.style.font=r.font,a.style.fontSize=r.fontSize,a.style.fontFamily=r.fontFamily,a.style.fontWeight=r.fontWeight,a.style.lineHeight=r.lineHeight,a.style.letterSpacing=r.letterSpacing,a.style.wordSpacing=r.wordSpacing,a.style.padding=r.padding,a.style.width=`${e.clientWidth}px`,a.style.border="none",a.style.whiteSpace=r.whiteSpace,a.style.wordWrap=r.wordWrap,a.style.overflowWrap=r.overflowWrap,a.textContent=e.value,o?o.appendChild(a):document.body.appendChild(a);try{const i=document.createRange(),c=a.firstChild;if(!c||c.nodeType!==Node.TEXT_NODE)return null;i.setStart(c,s),i.setEnd(c,n);const l=i.getClientRects();if(l.length===0)return null;const d=l[0],h=o==null?void 0:o.getBoundingClientRect();if(!h)return null;const u={top:d.top-h.top,left:d.left-h.left},f=parseFloat(r.paddingTop)||0,m=parseFloat(r.paddingLeft)||0,y=u.top-f,g=u.left-m;return{top:y,left:g,width:d.width,height:d.height}}finally{o&&a.parentNode===o?o.removeChild(a):a.parentNode===document.body&&document.body.removeChild(a)}}const $t=e=>/[\w\u00C0-\u024F]/.test(e);function ji(e,s){if(!e||s<0||s>e.length)return!1;const n=e[s]||"",o=e[s-1]||"",r=$t(o),a=$t(n);return r&&!a||!r&&a}function Dg(e,s){if(!e||s<0||s>e.length)return null;const n=e[s]||"",o=e[s-1]||"";if(!$t(n)&&!$t(o))return null;let r=s;for(;r>0&&$t(e[r-1]);)r--;let a=s;for(;a<e.length&&$t(e[a]);)a++;return r<a?{start:r,end:a,word:e.substring(r,a)}:null}function ki(e,s){const n=Dg(e,s);return n?{start:n.start,end:n.end}:null}function Ii(e,s){if(!e||s<0||s>e.length)return null;let n=s;for(;n>0&&!$t(e[n-1]);)n--;if(n===0)return null;let o=n;for(;o>0&&$t(e[o-1]);)o--;let r=s;for(;r<e.length&&!$t(e[r]);)r++;if(r>=e.length)return null;let a=r;for(;a<e.length&&$t(e[a]);)a++;return{start:o,end:a}}function Ai(e,s){for(;s>0&&$t(e[s-1]);)s--;return s}function Ti(e,s){for(;s<e.length&&$t(e[s]);)s++;return s}function Og(e,s,n){var u;const o=document.createRange(),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let a=0,i=null,c=0,l=null,d=0,h;for(;h=r.nextNode();){const f=((u=h.textContent)==null?void 0:u.length)||0;if(!i&&a+f>=s&&(i=h,c=s-a),!l&&a+f>=n){l=h,d=n-a;break}a+=f}if(i&&l)try{return o.setStart(i,c),o.setEnd(l,d),o}catch(f){return console.warn("Failed to create text range:",f),null}return null}var cr=(e=>(e.CONTENT_CAPTURE="content-capture",e.REGULAR="regular",e))(cr||{});const ad=(e,s)=>{const n=new Set(s.map(o=>o.id));return e.filter(o=>o.startNodeId&&o.endNodeId&&n.has(o.startNodeId)&&n.has(o.endNodeId))},Lg=e=>e.type===fe.GROUP||e.type==="GROUP",Wg=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=[...e];for(const r of e)if(Lg(r)){const a=r.data,i=(a==null?void 0:a.childNodeIds)??[];for(const c of i)if(!n.has(c)){const l=s.find(d=>d.id===c);l&&(o.push(l),n.add(c))}}return o},Hg=(e,s,n)=>{const o=ad(s,e),r={nodes:e};return o.length>0&&(r.arrows=o),n!=null&&n.canvasConfig&&(r.canvasConfig=n.canvasConfig),r},rd=e=>{var l;const s=T.getState(),n=s.projectCanvas.getActive();if(!n)return null;const{nodes:o,arrows:r,selectedNodes:a}=n.coreState,i=a.length>0?Wg(a,o):o;if(i.length===0)return null;const c=e!=null&&e.includeConfig?(l=s.preferences)==null?void 0:l.canvasConfig:void 0;return Hg(i,r,{canvasConfig:c})},id=async(e,s)=>{var n;try{const o=JSON.stringify(e,null,2);if(await navigator.clipboard.writeText(o),(s==null?void 0:s.showToast)!==!1){const r=(n=e.arrows)!=null&&n.length?` and ${e.arrows.length} arrow(s)`:"";Ee.success(`Copied ${e.nodes.length} node(s)${r}`)}return!0}catch(o){return console.error("Failed to copy to clipboard:",o),(s==null?void 0:s.showToast)!==!1&&Ee.error("Failed to copy to clipboard"),!1}},cd=async e=>{const s=rd({includeConfig:e==null?void 0:e.includeConfig});return s?id(s,{showToast:e==null?void 0:e.showToast}):(Ee.info("No nodes to copy"),!1)},Fg=e=>{try{const s=JSON.parse(e);if(!s)return null;const n=Array.isArray(s.nodes)&&s.nodes.length>0,o=Array.isArray(s.arrows)&&s.arrows.length>0;return n||o?s:null}catch{return null}};function Bg(e){const s=e.split(Eu);if(s.length===2)try{return{type:"content-capture",data:JSON.parse(s[1])}}catch{}const n=Fg(e);return n?{type:"content-capture",data:n}:{type:"regular",content:s[0]}}const zg={id:"noDuplicateHeaders",name:"No Duplicate Headers",description:"Warn when same header text appears multiple times",defaultSeverity:"warning",check:(e,s)=>{const n=[],o=new Map;for(let r=0;r<s.length;r++){const a=s[r].match(/^#{1,6}\s+(.+)$/);if(a){const i=a[1].trim().toLowerCase(),c=o.get(i);c!==void 0?n.push({ruleId:"no-duplicate-headers",severity:"warning",message:`Duplicate header "${a[1].trim()}" (first seen on line ${c})`,line:r+1}):o.set(i,r+1)}}return n}},$g={id:"headerIncrement",name:"Header Increment",description:"Headers should only increment by one level",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=0;r<s.length;r++){const a=s[r].match(/^(#{1,6})\s+/);if(a){const i=a[1].length;o>0&&i>o+1&&n.push({ruleId:"header-increment",severity:"warning",message:`Header level jumped from H${o} to H${i} (should be H${o+1})`,line:r+1}),o=i}}return n}},_g={id:"noEmptyHeaders",name:"No Empty Headers",description:"Headers must have content after the # markers",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^#{1,6}\s*$/.test(r)&&n.push({ruleId:"no-empty-headers",severity:"error",message:"Header has no content",line:o+1})}return n}},Ug={id:"firstHeaderH1",name:"First Header H1",description:"Document should start with H1",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].match(/^(#{1,6})\s+/);if(r){const a=r[1].length;a!==1&&n.push({ruleId:"first-header-h1",severity:"info",message:`First header should be H1, found H${a}`,line:o+1});break}}return n}},Vg={id:"noTrailingSpaces",name:"No Trailing Spaces",description:"Lines shouldn't end with trailing spaces",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];r.endsWith(" ")&&!r.endsWith("  ")&&n.push({ruleId:"no-trailing-spaces",severity:"warning",message:"Line has trailing spaces",line:o+1,column:r.trimEnd().length+1})}return n}},Gg={id:"noMultipleBlanks",name:"No Multiple Blanks",description:"No more than 1 consecutive blank line",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0,r=0;for(let a=0;a<s.length;a++)s[a].trim()===""?(o===0&&(r=a+1),o++):(o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:a}),o=0);return o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:s.length}),n}},Yg={id:"noLeadingWhitespace",name:"No Leading Whitespace",description:"Content shouldn't start with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let a=0;a<s.length&&s[a].trim()==="";a++)o++;o>0&&n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`Content starts with ${o} blank line(s)`,line:1,endLine:o});const r=s.find(a=>a.trim()!=="");if(r&&/^\s+/.test(r)){const a=r.match(/^(\s+)/),i=a?a[1].length:0;n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`First content line starts with ${i} whitespace character(s)`,line:o+1,column:1})}return n}},Xg={id:"noTrailingWhitespace",name:"No Trailing Whitespace",description:"Content shouldn't end with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=s.length-1;r>=0&&s[r].trim()==="";r--)o++;return o>0&&n.push({ruleId:"no-trailing-whitespace",severity:"warning",message:`Content ends with ${o} blank line(s)`,line:s.length-o+1,endLine:s.length}),n}},Kg={id:"consistentEmphasis",name:"Consistent Emphasis",description:"Use same style for emphasis (* vs _)",defaultSeverity:"info",check:e=>{const s=[],n=e.match(new RegExp("(?<!\\*)\\*(?!\\*)([^*]+)(?<!\\*)\\*(?!\\*)","g")),o=e.match(new RegExp("(?<!_)_(?!_)([^_]+)(?<!_)_(?!_)","g"));n&&o&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both *italic* and _italic_",line:1});const r=e.match(/\*\*([^*]+)\*\*/g),a=e.match(/__([^_]+)__/g);return r&&a&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both **bold** and __bold__",line:1}),s}},qg={id:"noSpaceInEmphasis",name:"No Space in Emphasis",description:"No spaces inside emphasis markers",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\*\*\s+[^*]+\*\*|\*\*[^*]+\s+\*\*/);a&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside bold markers: ** text ** should be **text**",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(new RegExp("(?<!\\*)\\*\\s+[^*]+\\*(?!\\*)|\\*[^*]+\\s+\\*(?!\\*)"));i&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside italic markers: * text * should be *text*",line:o+1,column:r.indexOf(i[0])+1})}return n}},Zg={id:"noEmptyLinks",name:"No Empty Links",description:"Links must have both text and URL",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\[\]\([^)]+\)/);a&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no text: [](url)",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(/\[[^\]]+\]\(\s*\)/);i&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no URL: [text]()",line:o+1,column:r.indexOf(i[0])+1})}return n}},Jg={id:"noBareUrls",name:"No Bare URLs",description:"URLs should be wrapped in link syntax [text](url)",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=new RegExp("(?<!\\]\\()https?:\\/\\/[^\\s\\)]+","g");let i;for(;(i=a.exec(r))!==null;)r.substring(0,i.index).endsWith("](")||n.push({ruleId:"no-bare-urls",severity:"info",message:`Bare URL found: ${i[0].substring(0,30)}...`,line:o+1,column:i.index+1})}return n}},Qg={id:"consistentListMarker",name:"Consistent List Marker",description:"Use same marker for unordered lists (- vs * vs +)",defaultSeverity:"info",check:(e,s)=>{const n=[],o=new Set;let r=0,a="";for(let i=0;i<s.length;i++){const c=s[i].match(/^(\s*)([*+-])\s+/);if(c){const l=c[2];o.size===0&&(r=i+1,a=l),o.add(l)}}return o.size>1&&n.push({ruleId:"consistent-list-marker",severity:"info",message:`Mixed list markers: using ${Array.from(o).join(", ")} (first "${a}" on line ${r})`,line:1}),n}},ef={id:"noEmptyListItems",name:"No Empty List Items",description:"List items must have content",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^\s*[*+-]\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty list item",line:o+1}),/^\s*\d+\.\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty ordered list item",line:o+1})}return n}},tf={id:"orderedListPrefix",name:"Ordered List Prefix",description:"Ordered lists should use 1. or sequential numbering",defaultSeverity:"info",check:(e,s)=>{const n=[];let o=1,r=!1;for(let a=0;a<s.length;a++){const i=s[a].match(/^(\s*)(\d+)\.\s+/);if(i){const c=parseInt(i[2],10);r||(r=!0,o=1),c!==1&&c!==o&&n.push({ruleId:"ordered-list-prefix",severity:"info",message:`Ordered list item ${c}. should be ${o}. (or use 1. for all)`,line:a+1}),o++}else s[a].trim()===""&&(r=!1,o=1)}return n}},sf={id:"tableColumnCount",name:"Table Column Count",description:"All table rows should have the same column count",defaultSeverity:"error",check:(e,s)=>{const n=[];let o=-1,r=0;for(let a=0;a<s.length;a++){const i=s[a].trim();if(i.startsWith("|")||i.includes("|")&&/\|.+\|/.test(i)){const c=i.split("|").filter(l=>l.trim()!=="").length;o===-1?(o=a+1,r=c):c!==r&&(/^[\s|:-]+$/.test(i)||n.push({ruleId:"table-column-count",severity:"error",message:`Table row has ${c} columns, expected ${r}`,line:a+1}))}else o!==-1&&i===""&&(o=-1,r=0)}return n}},nf={id:"noEmptyTableCells",name:"No Empty Table Cells",description:"Warn on empty table cells",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].trim();if(!/^[\s|:-]+$/.test(r)&&(r.startsWith("|")||r.includes("|")&&/\|.+\|/.test(r))){const a=r.split("|");for(let i=1;i<a.length-1;i++)a[i].trim()===""&&n.push({ruleId:"no-empty-table-cells",severity:"info",message:`Empty table cell in column ${i}`,line:o+1})}}return n}},of=[zg,$g,_g,Ug,Vg,Gg,Yg,Xg,Kg,qg,Zg,Jg,Qg,ef,tf,sf,nf],af=Object.fromEntries(of.map(e=>[e.id,e]));function rf(e,s){const n=[],o=e.split(`
`);for(const[r,a]of Object.entries(s)){if(!(a!=null&&a.enabled))continue;const i=af[r];if(!i){console.warn(`Unknown lint rule: ${r}`);continue}const c=i.check(e,o),l=a.severity??i.defaultSeverity;for(const d of c)n.push({...d,severity:l})}return n.sort((r,a)=>r.line!==a.line?r.line-a.line:(r.column??0)-(a.column??0)),n}function cf(e){return{total:e.length,errors:e.filter(s=>s.severity==="error").length,warnings:e.filter(s=>s.severity==="warning").length,infos:e.filter(s=>s.severity==="info").length}}function lf(e){if(e.length===0)return"No issues found.";const s=e.map(o=>{const r=o.column?`${o.line}:${o.column}`:`${o.line}`,a=o.severity.toUpperCase().padEnd(7);return`  ${r.padEnd(8)} ${a} ${o.message} (${o.ruleId})`}),n=cf(e);return s.push(""),s.push(`Found ${n.total} issue(s): ${n.errors} error(s), ${n.warnings} warning(s), ${n.infos} info(s)`),s.join(`
`)}function df(e){let s=e.split(`
`);for(;s.length>0&&s[0].trim()==="";)s.shift();for(s.length>0&&(s[0]=s[0].trimStart());s.length>0&&s[s.length-1].trim()==="";)s.pop();const n=[];let o=!1;for(const r of s)if(r.trim()==="")o||n.push(r),o=!0;else{const i=o?r.trimStart():r;n.push(i),o=!1}return n.join(`
`)}const Ei={noEmptyHeaders:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},noEmptyLinks:{enabled:!0},noEmptyListItems:{enabled:!0},tableColumnCount:{enabled:!0}},uf={noDuplicateHeaders:{enabled:!0},headerIncrement:{enabled:!0},noEmptyHeaders:{enabled:!0},firstHeaderH1:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},consistentEmphasis:{enabled:!0},noSpaceInEmphasis:{enabled:!0},noEmptyLinks:{enabled:!0},noBareUrls:{enabled:!0},consistentListMarker:{enabled:!0},noEmptyListItems:{enabled:!0},orderedListPrefix:{enabled:!0},tableColumnCount:{enabled:!0},noEmptyTableCells:{enabled:!0}};function hf(e){switch(e){case"disabled":return null;case"simple":return{...Ei};case"comprehensive":return{...uf};default:return{...Ei}}}function Ri(e,s,n){let o=0,r=!1;const a=[];function i(c){var l,d,h,u,f,m,y;if(r)return!0;if(c===s)return c.nodeType===Node.TEXT_NODE?(a.push(`FOUND target text node "${(l=c.textContent)==null?void 0:l.substring(0,20)}", adding targetOffset ${n}`),o+=n):a.push(`FOUND target element node, type=${c.tagName}`),r=!0,!0;if(c.nodeType===Node.TEXT_NODE){const g=((d=c.textContent)==null?void 0:d.length)||0;a.push(`text "${(h=c.textContent)==null?void 0:h.substring(0,20)}" +${g} → ${o+g}`),o+=g}else if(c.nodeType===Node.ELEMENT_NODE){const g=c,x=g.tagName;if(x==="BR")return a.push(`BR +1 → ${o+1}`),o+=1,!1;let w=0,v=!1,N=!1;if(x==="H1")w=2;else if(x==="H2")w=3;else if(x==="H3")w=4;else if(x==="BLOCKQUOTE")w=2;else if(g.classList.contains("list-item-ul"))w=2,v=!0,((u=g.previousElementSibling)!=null&&u.classList.contains("list-item-ul")||(f=g.previousElementSibling)!=null&&f.classList.contains("list-item-ol"))&&(N=!0);else if(g.classList.contains("list-item-ol")){const A=g.querySelector("span:first-child");w=((A==null?void 0:A.textContent)||"1.").length+1,v=!0,((m=g.previousElementSibling)!=null&&m.classList.contains("list-item-ul")||(y=g.previousElementSibling)!=null&&y.classList.contains("list-item-ol"))&&(N=!0)}else if(g.classList.contains("empty-line"))return a.push(`empty-line +1 → ${o+1}`),o+=1,!1;N&&(a.push(`newline before block +1 → ${o+1}`),o+=1),w>0&&a.push(`${x} prefix +${w} → ${o+w}`),o+=w;const b=Array.from(c.childNodes);for(let A=0;A<b.length;A++)if(!(v&&A===0&&b[A].nodeName==="SPAN")&&i(b[A]))return!0}return!1}return i(e),o}let ut=null,za=!1;typeof window<"u"&&(window.addEventListener("keydown",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(za=!0)},!0),window.addEventListener("keyup",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(za=!1)},!0),document.addEventListener("selectionchange",()=>{const e=window.getSelection();za||!e||e.isCollapsed||(ut={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,text:e.toString(),timestamp:Date.now()})}));const st=class st{static lintPastedContent(s){const n=Q.lint.onPastePreset,o=hf(n);if(!o)return;const r=rf(s,o);r.length>0&&(console.warn(`[Markdown Linter] Found ${r.length} issue(s) in pasted content:`),console.warn(lf(r)))}onMouseDown(s){const n=T.getState(),o=n.uiState,{mode:r,addNodeType:a}=o,i=n.getCanvasMouseCoords();if(r!==ee.ADD||a!==fe.TEXT||!i)return!1;const c=Ye.buildTextNode(i,"");return n.addNode(c),n.setNodeToFocusId(c.id),!0}async onPaste(s){var y,g;const n=T.getState(),o=await Sh();if(!o)return!1;const r=Bg(o);if(r.type===cr.CONTENT_CAPTURE){const x=n.getCanvasMouseCoords();if(x)return this.createNodesFromContentCapture(r.data,x),n.setNodeToFocusId(null),s.preventDefault(),!0}const a=r.type===cr.REGULAR?r.content:o,i=df(a),{mode:c,addNodeType:l,nodeToFocusId:d}=n.uiState,h=((y=n.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??[];if(d){const x=n.getNodeById(d);if(x&&typeof x.content=="string"&&h.length>0){const v=(x.content||"")+i;if(!((g=x.options)!=null&&g.lockSize)){let b;const A=document.querySelector("textarea[data-node-textarea]");if(A){const C=window.getComputedStyle(A).lineHeight;if(C&&C!=="normal"){const I=parseFloat(C);isNaN(I)||(b=I)}}const R=Ws(v,b,x),k=Math.min(R.width,Q.paste.maxWidth);let S=R.height;k<R.width&&(S=It(v,k,x)),n.updateNode(x.id,{...x,content:v,width:k,height:S})}else n.updateNode(x.id,{...x,content:v});return s.preventDefault(),st.lintPastedContent(i),!0}}const u=n.getCanvasMouseCoords(),f=c===ee.ADD&&l===fe.TEXT&&u,m=!d&&u;if(f){const x=Ye.buildTextNode(u,i);return n.addNode(x),n.setNodeToFocusId(null),n.setMode(ee.SELECT),n.setAddNodeType(null),s.preventDefault(),st.lintPastedContent(i),!0}else if(m){const x=n.getSegmentedButtonAction("canvas-fit-width");let w=null;if(x){const R=/Set width to (\d+)px/.exec(x);R&&(w=parseInt(R[1],10))}let v,N,b;if(w)N=It(i,w),v=w,b=!0;else{const R=document.querySelector("textarea[data-node-textarea]");R&&window.getComputedStyle(R).lineHeight;const k=Ws(i);v=Math.min(k.width,Q.paste.maxWidth),v<k.width?N=It(i,v):N=k.height,b=!1}const A=Ye.buildTextNodeV2({x:u.x,y:u.y,width:v,height:N,content:i,styles:{textAlign:"left"},options:{lockSize:b}});return n.addNode(A),n.setNodeToFocusId(null),s.preventDefault(),st.lintPastedContent(i),!0}return!1}isGroupNodeType(s){return s.type===fe.GROUP||s.type==="GROUP"}createNodesFromContentCapture(s,n){const o=T.getState(),{pasteWidth:r,nodeGap:a}=Q.contentCapture,i=Math.min(...s.nodes.map(w=>w.x)),c=Math.min(...s.nodes.map(w=>w.y)),l=n.x-i,d=n.y-c,h=new Map,u=s.nodes.every(w=>w.width&&w.height);let f=n.y;const m=[];for(const w of s.nodes){const v=w.content||"",N=this.isGroupNodeType(w);let b,A,R;w.width&&w.height?(b=w.width,A=w.height,R=u?w.y+d:f):(b=r,A=It(v,r),R=f);let k;if(N){const S=new Date().toISOString();k={...w,id:Ve(10),type:fe.GROUP,x:w.x+l,y:R,width:b,height:A,createdAt:S,updatedAt:S}}else k={...w,id:Ve(10),x:w.x+l,y:R,width:b,height:A,content:v,styles:w.styles??{textAlign:"left"},options:w.options??{lockSize:!u},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};h.set(w.id,k.id),m.push({oldNode:w,newNode:k}),u||(f+=A+a)}for(const{oldNode:w,newNode:v}of m){if(w.groupId){const N=h.get(w.groupId);N?v.groupId=N:delete v.groupId}else delete v.groupId;if(this.isGroupNodeType(w)){const N=w.data,A=((N==null?void 0:N.childNodeIds)??[]).map(R=>h.get(R)).filter(R=>R!==void 0);v.data={...N??{},childNodeIds:A}}o.addNode(v,void 0,{skipUndo:!0})}const y=m.map(({newNode:w})=>({type:"node:create",node:w})),g=[];for(const w of s.arrows??[]){const v=w.startNodeId?h.get(w.startNodeId):null,N=w.endNodeId?h.get(w.endNodeId):null;if(v&&N){const b={id:Ve(10),startNodeId:v,endNodeId:N,startPoint:{x:0,y:0},endPoint:{x:0,y:0}};o.arrow.add(b),g.push(b),y.push({type:"arrow:create",arrow:b})}}y.length>0&&o.undo.commit({type:"batch",label:`Paste ${m.length} node${m.length!==1?"s":""}${g.length>0?` and ${g.length} arrow${g.length!==1?"s":""}`:""}`,operations:y});const x=m.map(w=>w.newNode);o.setSelectedNodes(x),g.length>0&&o.arrow.setSelected(g)}onCopy(s){var u,f;const{focus:n,sourceNode:o,side:r="right"}=s||{focus:!0},a=T.getState(),{mode:i,nodeToFocusId:c}=a.uiState;if(!i)return null;const l=((u=a.projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??[],d=Date.now();let h=!1;if(st.lastCopyTimestamp&&d-st.lastCopyTimestamp<st.DOUBLE_COPY_INTERVAL_MS&&(h=!0),st.lastCopyTimestamp=d,h)return null;{let m=o;return m||(m=l[0],m||(m=(((f=a.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??[]).find(w=>w.id===c))),pf(m,n?c:null,n,r)}}highlightAndCreateNode(s,n="right"){var d;const o=T.getState(),r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c=!1,l=null;if(a){const h=r,u=h.value;let f=h.selectionStart,m=h.selectionEnd;if(f===m)if(ji(u,f)){const y=Ii(u,f);y&&(f=y.start,m=y.end)}else{const y=ki(u,f);y&&(f=y.start,m=y.end)}else f=Ai(u,f),m=Ti(u,m);(f!==h.selectionStart||m!==h.selectionEnd)&&h.setSelectionRange(f,m),c=f!==m}else if(i){const h=window.getSelection(),u=r.textContent||"";let f=!!(h&&!h.isCollapsed&&h.toString().trim());if(h&&h.rangeCount>0){const m=h.getRangeAt(0),y=document.createRange();y.setStart(r,0),y.setEnd(m.startContainer,m.startOffset);let g=y.toString().length;const x=document.createRange();x.setStart(r,0),x.setEnd(m.endContainer,m.endOffset);let w=x.toString().length;if(g===w)if(ji(u,g)){const v=Ii(u,g);v&&(g=v.start,w=v.end)}else{const v=ki(u,g);v&&(g=v.start,w=v.end)}else g=Ai(u,g),w=Ti(u,w);if(g!==w){const v=Og(r,g,w);v&&(h.removeAllRanges(),h.addRange(v),l=v.cloneRange(),f=!0)}}c=f,c&&h&&h.rangeCount>0&&!l&&(l=h.getRangeAt(0).cloneRange())}if(c){s.preventDefault();const{nodeToFocusId:h}=o.uiState,u=o.projectCanvas.getActive();let m=((u==null?void 0:u.coreState.selectedNodes)??[])[0];!m&&h&&(m=((u==null?void 0:u.coreState.nodes)??[]).find(v=>v.id===h));const y=a?r.selectionStart:0,g=a?r.selectionEnd:0;st.dismissPopoverCallback&&st.dismissPopoverCallback();const x=this.onCopy({focus:!1,sourceNode:m,side:n});if(setTimeout(()=>{if(r.focus(),a)r.setSelectionRange(y,g);else if(i&&l){const w=window.getSelection();w&&(w.removeAllRanges(),w.addRange(l))}},0),m!=null&&m.highlights&&m.highlights.length>1&&x){const v=(((d=o.projectCanvas.getActive())==null?void 0:d.coreState.nodes)??[]).find(b=>b.id===m.id),N=window.__showLinkedNodesPopover;N&&v&&N(v,x)}}else{const{nodeToFocusId:h}=o.uiState,u=o.projectCanvas.getActive();let m=((u==null?void 0:u.coreState.selectedNodes)??[])[0];if(!m&&h&&(m=((u==null?void 0:u.coreState.nodes)??[]).find(g=>g.id===h)),m!=null&&m.highlights&&m.highlights.length>0){s.preventDefault();const y=window.__showLinkedNodesPopover;y&&y(m,null)}}}static registerSelectionCallback(s){st.selectionChangeCallback=s}static unregisterSelectionCallback(){st.selectionChangeCallback=null}static registerDismissPopoverCallback(s){st.dismissPopoverCallback=s}static unregisterDismissPopoverCallback(){st.dismissPopoverCallback=null}onTextSelect(s,n,o){const r=n!==o;st.selectionChangeCallback&&st.selectionChangeCallback(r)}};qe(st,"lastCopyTimestamp",null),qe(st,"DOUBLE_COPY_INTERVAL_MS",400),qe(st,"selectionChangeCallback",null),qe(st,"dismissPopoverCallback",null);let ls=st;function pf(e,s,n=!0,o="right"){var I,O,H,L;if(!e)return console.warn("No target node found for copy action."),null;const r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c="",l=null,d=0,h=0;if(a){const W=r;d=W.selectionStart,h=W.selectionEnd,c=W.value.substring(d,h);const P=od(W,d,h);if(P)l=new DOMRect(0,P.top,P.width,P.height);else{const j=ke.LINE_HEIGHT,M=4,z=W.value.substring(0,d).split(`
`).length-1,_=M+z*j;l=new DOMRect(0,_,0,j)}}else if(i){const W=window.getSelection(),P=5e3,j=ut&&((I=ut.anchorNode)==null?void 0:I.nodeType)===Node.TEXT_NODE&&ut.text.length>0,M=ut&&j&&Date.now()-ut.timestamp<P;let B,U,z;if(M&&ut)B=ut.anchorNode,U=ut.focusNode,z=ut.focusOffset,c=ut.text;else if(W)B=W.anchorNode,U=W.focusNode,z=W.focusOffset,c=W.toString();else return null;const _=W;if(_&&_.rangeCount>0){const G=_.getRangeAt(0),F=r.getBoundingClientRect(),D=G.getClientRects();if(D.length>0){const ue=D[0],le=ue.top-F.top;l=new DOMRect(0,le,ue.width,ue.height)}const V=e.content||"",J=ue=>{let le=ue;for(;le&&le!==r;){if(le.nodeType===Node.ELEMENT_NODE){const xe=le.parentElement;if(xe&&(xe.classList.contains("list-item-ul")||xe.classList.contains("list-item-ol"))){const je=xe.querySelector("span:first-child");if(je&&(le===je||je.contains(ue)))return!0}}le=le.parentNode}return!1},ie=ue=>{let le=ue;for(;le&&le!==r;){const ye=le.parentElement;if(ye&&(ye.classList.contains("list-item-ul")||ye.classList.contains("list-item-ol"))){const xe=ye.querySelector("span:nth-child(2)");if(xe!=null&&xe.firstChild)return xe.firstChild}le=le.parentNode}return null};let Se,me,Z,ge;if(M&&(ut!=null&&ut.anchorNode)?(Se=ut.anchorNode,me=ut.anchorOffset,Z=ut.anchorNode,ge=ut.anchorOffset+ut.text.length):(Se=G.startContainer,me=G.startOffset,Z=G.endContainer,ge=G.endOffset),J(Se)){const ue=ie(Se);ue&&(Se=ue,me=0)}const we=ue=>{let le=ue;for(;le&&le!==r;){if(le.nodeType===Node.ELEMENT_NODE){const ye=le,xe=ye.tagName;if(xe==="H1"||xe==="H2"||xe==="H3"||xe==="DIV"||xe==="P"||xe==="BLOCKQUOTE"||ye.classList.contains("list-item-ul")||ye.classList.contains("list-item-ol"))return ye}le=le.parentNode}return null},te=we(Se),X=we(Z),K=U?we(U):null,ne=B?we(B):null,ce=c.includes(`
`);if(te&&te!==X&&ce&&!(B===U)){const ue=ne!==K;if(ue&&ne&&!K){const le=(U==null?void 0:U.textContent)||"",ye=z;let xe=ye,je=ye;for(;xe>0&&/\S/.test(le[xe-1]);)xe--;for(;je<le.length&&/\S/.test(le[je]);)je++;if(xe===je&&ye>0)for(je=ye,xe=ye-1;xe>0&&/\S/.test(le[xe-1]);)xe--;xe<je&&U&&(Se=U,me=xe,Z=U,ge=je)}else if(ue&&!ne&&K){const ye=document.createTreeWalker(K,NodeFilter.SHOW_TEXT).nextNode();ye&&(Se=ye,me=0)}else if(ue&&K&&ne){const le=document.createTreeWalker(te,NodeFilter.SHOW_TEXT);let ye=null,xe;for(;xe=le.nextNode();)ye=xe;ye&&(Z=ye,ge=((O=ye.textContent)==null?void 0:O.length)||0)}else{const le=document.createTreeWalker(te,NodeFilter.SHOW_TEXT);let ye=null,xe;for(;xe=le.nextNode();)ye=xe;ye&&(Z=ye,ge=((H=ye.textContent)==null?void 0:H.length)||0)}}const q=Ri(r,Se,me),he=Ri(r,Z,ge);d=Math.min(q,he),h=Math.max(q,he),c=V.substring(d,h)}}else{const W=window.getSelection();if(c=(W==null?void 0:W.toString())||"",W&&W.rangeCount>0){const P=W.getRangeAt(0).cloneRange(),j=document.createElement("span");j.style.position="absolute",j.textContent="​",P.insertNode(j),l=j.getBoundingClientRect(),(L=j.parentNode)==null||L.removeChild(j)}}const u=T.getState();let f;const m="rgb(198, 183, 0)";if(Q.highlightAndCreate.createHighlight&&(a||i)&&d!==h){const W=e.highlights||[],P=W.find(j=>j.start===d&&j.end===h);if(P)f=P.id;else{f=Math.random().toString(36).slice(2,10);const j={id:f,start:d,end:h,color:m,createdAt:Date.now()},M=[...W,j];u.updateNode(e.id,{highlights:M})}}const g=u.getSegmentedButtonAction("canvas-fit-width");let x=null;if(g){const W=/Set width to (\d+)px/.exec(g);W&&(x=parseInt(W[1],10))}let w,v,N;const b=document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(b&&window.getComputedStyle(b).lineHeight,x)v=It(c,x),w=x,N=!0;else{const W=Ws(c);w=W.width,v=W.height,N=!1}const A=Ye.buildTextNodeV2({content:c,width:w,height:v,linkedHighlightId:f,linkedSourceNodeId:e.id,options:{lockSize:N}});let R=e.y;if(l){const W=l.top;R=e.y+W,l.height&&(R+=l.height/2)}const k=A.height??v,S=R-k/2,E=s||e.id,C=Q.highlightAndCreate.createConnectingArrow;if(Aa(A,{...e,y:S,id:E},o,{shouldFocus:n,createArrow:C}),f){const W=u.getNodeById(e.id),j=((W==null?void 0:W.highlights)||[]).map(M=>M.id===f?{...M,linkedNodeId:A.id}:M);u.updateNode(e.id,{highlights:j})}return A.id}const gf=1e3,ff=500,mf=500,xf=250,yf=2e3,wf=1e3,vf=500;class bf{handleArrowKey(s,n=!1,o=!1){const r=T.getState(),a=r.projectCanvas.getActive();if(!a)return!1;const i=a.coreState.selectedNodes??[];if(i.length===0)return!1;const c=a.coreState.nodes??[],l=new Set(i.map(m=>m.id)),d=c.filter(m=>l.has(m.id));let h=gf,u=ff;o?(h=yf,u=wf):n&&(h=mf,u=xf);const f=d.map(m=>{const y={id:m.id};switch(s.key){case"ArrowLeft":{const g=m.x,w=Math.round(g/h)-1;y.x=w*h;break}case"ArrowRight":{const g=m.x,w=Math.round(g/h)+1;y.x=w*h;break}case"ArrowUp":{const g=m.y,w=Math.round(g/u)-1;y.y=w*u;break}case"ArrowDown":{const g=m.y,w=Math.round(g/u)+1;y.y=w*u;break}}return y});return r.updateNodes(f),this.animateViewportToCenter(f,a),s.preventDefault(),!0}animateViewportToCenter(s,n){if(s.length===0||!n)return;const r=T.getState().setActiveCanvasViewState,a=n.viewState,i=a.scale,c=a.offset,l=n.coreState.nodes??[],d=new Map(l.map(R=>[R.id,R]));let h=0,u=0;s.forEach(R=>{const k=d.get(R.id);if(k){const S=R.x??k.x,E=R.y??k.y;h+=S,u+=E}});const f=h/s.length,m=u/s.length,y=window.innerWidth,g=window.innerHeight,x=y/2-f*i,w=g/2-m*i,v=performance.now(),N=c.x,b=c.y,A=R=>{const k=R-v,S=Math.min(k/vf,1),E=1-Math.pow(1-S,3),C=N+(x-N)*E,I=b+(w-b)*E;r(O=>({...O,offset:{x:C,y:I}})),S<1&&requestAnimationFrame(A)};requestAnimationFrame(A)}}const Mi=!0,Nf=1/3;function Sf(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}class Cf{async onPaste(s){try{const n=await navigator.clipboard.read();for(const o of n){const r=o.types.find(u=>u.startsWith("image/"));if(!r)continue;const a=await o.getType(r);if(!a)continue;const i=Math.round(a.size/1024),c=await this.blobToDataUrl(a);let l,d;if(Mi){const u=await Sf(c,Nf);l=u.dataUrl,d=u.size}const h=Mi?Math.round(l.length*3/4/1024):i;return this.createImageNode(l,d,h),s.preventDefault(),!0}}catch(n){console.debug("ImageModeHandler: Clipboard read failed",n)}return!1}blobToDataUrl(s){return new Promise((n,o)=>{const r=new FileReader;r.onload=()=>n(r.result),r.onerror=o,r.readAsDataURL(s)})}createImageNode(s,n,o){const r=T.getState(),a=r.getCanvasMouseCoords();if(!a){console.warn("ImageModeHandler: No mouse position available");return}const i=300,c=n.height/n.width,l=Math.round(i*c),d=Ye.buildImageNode({x:a.x,y:a.y,width:i,height:Math.max(l,100)});d.data={image:s,imageSize:n,fileSizeKB:o},r.addNode(d),r.setNodeToFocusId(d.id)}}function jf(){const e=document.activeElement;if(!e)return null;const s=["INPUT","TEXTAREA"].includes(e.nodeName??""),n=e.contentEditable==="true";return s||n}class kf{constructor(){qe(this,"activeCallback",null)}registerCallback(s){this.activeCallback=s}unregisterCallback(s){this.activeCallback===s&&(this.activeCallback=null)}applyHighlight(s){return this.activeCallback?(this.activeCallback(s),!0):!1}hasActiveCallback(){return this.activeCallback!==null}}const $n=new kf,If=new zs("useCanvasKeyboardEventsV2",$s.useCanvasKeyboardEventsV2),Af=["q","Q","$","%","5"],Tf=()=>{const e=T.getState(),s=e.setMode,n=e.setZoomSubMode,o=e.setWriteSubMode,r=e.toggleWriteSubMode,a=e.setArrowSubMode,i=e.toggleArrowSubMode,c=e.setMessageSubMode,l=e.toggleMessageSubMode,d=e.setDrawSubMode,h=e.toggleDrawSubMode,u=e.setAddNodeType,f=e.setNodeToFocusId,m=e.duplicateNodes,y=e.setSelectedNodes,g=e.arrow.setSelected,x=e.deleteSelectedNodes,w=e.deleteSelectedArrows,v=e.setActiveCanvasViewState,N=e.toggleOverlayVisibility,b=p.useRef(new ls),A=p.useRef(new bf),R=p.useRef(new Cf),k=p.useRef(0);return p.useCallback(S=>{var W;const E=T.getState().uiState.mode;if(E===ee.VIM)return;if(S.key==="Escape"){const P=Date.now(),M=P-k.current<400;if(k.current=P,M){const U=document.querySelector('[data-test="canvas-chat-input-container"] textarea');U==null||U.focus();return}if(T.getState().uiState.activeGroupId){T.getState().group.setActiveGroupId(null);return}E===ee.SELECT&&y([]),s(ee.SELECT),f(null),u(null);return}if((S.key==="h"||S.key==="H")&&(S.ctrlKey||S.metaKey)){S.preventDefault(),$n.applyHighlight();return}const C=S.key==="Enter"&&S.ctrlKey,I=S.key==="a"&&E===ee.WRITE;if(E===ee.WRITE&&!C&&!I)return;const O=jf(),H=Af.includes(S.key);if(O&&!H)return;if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(S.key)){const P=e.projectCanvas.getActive(),j=(P==null?void 0:P.coreState.selectedNodes)??[];if(E===ee.GRID&&j.length>0){const M=S.ctrlKey,B=S.shiftKey;if(A.current.handleArrowKey(S,M,B))return}if(S.ctrlKey&&j.length>0&&E!==ee.GRID){const M=e.uiState.lastUpdatedNodeId;if(!M)return;const B=(W=P==null?void 0:P.coreState.nodes)==null?void 0:W.find(z=>z.id===M);if(!B)return;const U=j.map(z=>{const _={id:z.id};switch(S.key){case"ArrowLeft":case"ArrowRight":_.x=B.x;break;case"ArrowUp":case"ArrowDown":_.y=B.y;break}return _});e.updateNodes(U),S.preventDefault();return}if(j.length===0){const M=S.shiftKey?100:30;v(B=>{let U=0,z=0;switch(S.key){case"ArrowUp":z=M;break;case"ArrowDown":z=-M;break;case"ArrowLeft":U=M;break;case"ArrowRight":U=-M;break}return{...B,offset:{x:B.offset.x+U,y:B.offset.y+z}}}),S.preventDefault();return}}switch(S.key){case".":{S.preventDefault(),T.getState().executeGlobalLastAction();break}case"a":{if(S.preventDefault(),S.ctrlKey||S.metaKey){const M=e.projectCanvas.getActive(),B=(M==null?void 0:M.coreState.nodes)??[];y(B);break}const P=e.uiState.addNodeType;E===ee.ADD&&P===fe.TEXT?(s(ee.WRITE),o(un.AUDIO)):E===ee.WRITE?r():E===ee.DRAW_ARROW?i():(s(ee.DRAW_ARROW),a(eo.DEFAULT));break}case"c":if(S.ctrlKey||S.metaKey){const P=window.getSelection();if(P&&P.toString().trim().length>0)break;S.preventDefault(),cd();break}S.preventDefault(),console.clear();break;case"d":if(S.preventDefault(),S.ctrlKey){m();break}y([]),g([]),s(ee.DRAW);break;case"v":if(S.ctrlKey){const P=e.projectCanvas.getActive();if(((P==null?void 0:P.coreState.selectedNodes)??[]).some(B=>B.type===fe.OCR||B.type===fe.IMAGE))break;(async()=>await R.current.onPaste(S)||await b.current.onPaste(S))();break}s(ee.SELECT);break;case"g":if(S.ctrlKey){T.getState().group.createFromSelected()&&S.preventDefault();break}s(ee.GRID);break;case"h":case"H":E===ee.MOVE?(s(ee.ZOOM),n("zoom")):E===ee.ZOOM?s(ee.MOVE):s(ee.MOVE);break;case"i":s(ee.VIM);break;case"m":{E===ee.MESSAGE?l():(s(ee.MESSAGE),c(nn.DEFAULT));break}case"n":{T.getState().setCustomNodeDropdownOpen(!0);break}case"q":if(S.ctrlKey){b.current.onCopy();break}break;case"r":S.altKey&&(S.preventDefault(),T.getState().executeGlobalLastAction());break;case"s":(S.ctrlKey||S.metaKey)&&(S.preventDefault(),T.getState().saveCanvasData());break;case"Q":if(S.ctrlKey&&S.shiftKey){b.current.onCopy();break}break;case"$":{b.current.highlightAndCreateNode(S,"right");break}case"%":case"5":{b.current.highlightAndCreateNode(S,"left");break}case"t":s(ee.ADD),u(fe.TEXT);break;case"w":{const P=e.uiState.addNodeType;E===ee.ADD&&P===fe.TEXT&&(s(ee.WRITE),o(un.WRITE));break}case"u":case"U":(S.ctrlKey||S.metaKey)&&S.shiftKey&&(S.preventDefault(),T.getState().setUiState(P=>({...P,undoTreeExplorerOpen:!P.undoTreeExplorerOpen})));break;case"y":(S.ctrlKey||S.metaKey)&&(S.preventDefault(),T.getState().undo.redo());break;case"z":if(S.ctrlKey||S.metaKey){S.preventDefault(),S.shiftKey?T.getState().undo.redo():T.getState().undo.undo();break}N();break;case"1":case"2":case"3":case"4":if(E===ee.DRAW){S.preventDefault();const P=ot.getSubModeFromKey(S.key);P&&d(P)}break;case"Tab":E===ee.DRAW&&(S.preventDefault(),h());break;case"Delete":case"Backspace":x(),w(),S.preventDefault();break}},[s,f,u,y,e,v,g,N,x,w,o,r,i,a,m,n,l,c,d,h])},Ef=()=>p.useCallback(e=>{If.log("Key Up:",e.key)},[]),ta=(e,s)=>e.x<s.x+s.width&&e.x+e.width>s.x&&e.y<s.y+s.height&&e.y+e.height>s.y,sa=e=>({x:e.x,y:e.y,width:e.width??100,height:e.height??50}),Rf=(e,s,n)=>{const{x1:o,y1:r,x2:a,y2:i}=n,{x:c,y:l}=e,{x:d,y:h}=s,u=d-c,f=h-l;let m=-1/0,y=1/0;const g=(w,v,N,b)=>{if(Math.abs(v)<1e-6)return w>=N&&w<=b;let A=(N-w)/v,R=(b-w)/v;return A>R&&([A,R]=[R,A]),m=Math.max(m,A),y=Math.min(y,R),m<=y};if(!g(c,u,o,a)||!g(l,f,r,i)||m>1||y<0)return null;const x=Math.max(0,m);return x<=1?{x:c+x*u,y:l+x*f}:null},gt=(e,s,n,o,r)=>{var d;if(!e)return s;const a=o.find(h=>h.id===e);if((a==null?void 0:a.width)===void 0||a.height===void 0)return s;if(r){const h=`[data-row-connector="${r}"][data-node-id="${e}"]`,u=document.querySelector(h);if(u){const f=u.getBoundingClientRect(),m=document.querySelector("[data-canvas-content]");if(m){const y=m.getBoundingClientRect(),g=f.left+f.width/2-y.left,x=f.top+f.height/2-y.top,v=(d=T.getState().projectCanvas.getActive())==null?void 0:d.viewState;return v?Dt({x:g,y:x},v.scale,v.offset):{x:g,y:x}}}else return s}const i=qn(a),c=ct(a);return Rf(n,c,i)??c},Mf=(e,s,n,o,r)=>{if(r===0){const a=n/o;return Math.abs(e)*a>=Math.abs(s)}return Math.abs(e)*r>=Math.abs(s)},rn=(e,s,n,o,r=0,a=Q.arrows.CUBIC_HORIZONTAL_BIAS)=>{if(!e)return s;const i=o.find(u=>u.id===e);if(!(i!=null&&i.width)||!i.height)return s;const c=ct(i),l=n.x-c.x,d=n.y-c.y;return Mf(l,d,i.width,i.height,a)?l>0?{x:i.x+i.width-r,y:c.y}:{x:i.x+r,y:c.y}:d>0?{x:c.x,y:i.y+i.height-r}:{x:c.x,y:i.y+r}};function Pi(e,s,n){switch(s){case"fixed-minimum":return Math.max(e*.5,50)*n;case"no-minimum":return e*.5*n;case"scaled-minimum":const o=Math.min(e*.3,50);return Math.max(e*.5,o)*n;case"proportional":return Math.max(e*.4,10)*n;default:return Math.max(e*.5,50)*n}}function Pf(e,s,n,o){const r=s.x-e.x,a=s.y-e.y,i=Math.abs(r),c=Math.abs(a),l=(o==null?void 0:o.dx)??r,d=(o==null?void 0:o.dy)??a,h=Q.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,u=Q.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,f=Q.arrows.CUBIC_CONTROL_DISTANCE_MODE;let m,y;if(n==="horizontal"){const g=Pi(i,f,h),x=l>0?1:-1,w=u?-1:1;m={x:e.x+x*g*w,y:e.y},y={x:s.x-x*g*w,y:s.y}}else{const g=Pi(c,f,h),x=d>0?1:-1,w=u?-1:1;m={x:e.x,y:e.y+x*g*w},y={x:s.x,y:s.y-x*g*w}}return[m,y]}const na=(e,s,n,o,r=0)=>{if(!e)return s;const a=o.find(l=>l.id===e);if(!(a!=null&&a.width)||!a.height)return s;const i=ct(a);return n.x-i.x>0?{x:a.x+a.width-r,y:i.y}:{x:a.x+r,y:i.y}},ld=(e,s,n)=>{if(!e)return s;const o=n.find(a=>a.id===e);return!(o!=null&&o.width)||!o.height?s:{x:ct(o).x,y:o.y+o.height}};function dd(e,s,n){const o=e.type??Q.arrows.type,r=Q.arrows.CUBIC_HORIZONTAL_BIAS,a=-10,i=s.find(u=>u.id===e.startNodeId),c=s.find(u=>u.id===e.endNodeId),l=o==="TreeCubic"||o==="TreeLStep"||o==="TreeZShape";let d;if(l&&i&&c){const u=ct(i);d=na(e.endNodeId,e.endPoint,u,s,a)}else if((o==="Cubic"||o==="Orthogonal")&&i&&c){const u=ct(i);d=rn(e.endNodeId,e.endPoint,u,s,a,r)}else if(o==="Step"&&i&&c){const u=ct(i),f=ct(c),m=f.x-u.x,y=f.y-u.y,x=Math.abs(m)*r>=Math.abs(y)?.001:1e3;d=rn(e.endNodeId,e.endPoint,u,s,a,x)}else{const u=i?gt(e.startNodeId,e.startPoint,e.endPoint,s,e.startRowId):e.startPoint;d=c?gt(e.endNodeId,e.endPoint,u,s,e.endRowId):e.endPoint}let h;if(o==="TreeLStep"&&i)h=ld(e.startNodeId,e.startPoint,s);else if((o==="TreeCubic"||o==="TreeZShape")&&i&&c){const u=ct(c);h=na(e.startNodeId,e.startPoint,u,s,0)}else if((o==="Cubic"||o==="Step"||o==="Orthogonal")&&i&&c){const u=ct(c);h=rn(e.startNodeId,e.startPoint,u,s,0,r)}else{const u=c?gt(e.endNodeId,e.endPoint,e.startPoint,s,e.endRowId):e.endPoint;h=i?gt(e.startNodeId,e.startPoint,u,s,e.startRowId):e.startPoint}return{actualStartPoint:h,actualEndPoint:d}}function Df(e,s,n){const{actualStartPoint:o,actualEndPoint:r}=dd(e,s),a=Math.min(o.x,r.x),i=Math.min(o.y,r.y),c=Math.max(o.x,r.x),l=Math.max(o.y,r.y);return{x:a,y:i,width:c-a,height:l-i}}const lr={SELECTION_BOX_END:"selectionBoxEnd"};class Of{constructor(){qe(this,"listeners",{})}subscribe(s,n){return this.listeners[s]||(this.listeners[s]=[]),this.listeners[s].push(n),()=>{this.unsubscribe(s,n)}}unsubscribe(s,n){this.listeners[s]&&(this.listeners[s]=this.listeners[s].filter(o=>o!==n))}dispatch(s,n){this.listeners[s]&&this.listeners[s].forEach(o=>{try{o(n)}catch(r){console.error(`Error in event listener for ${s} event:`,r)}})}}const ud=new Of,As=new zs("useSelectionHandler",$s.useSelectionHandler),Lf=e=>e?Q.autoScroll.edgeThresholdMobile:Q.autoScroll.edgeThreshold,bo=Q.autoScroll.scrollSpeed,zr=e=>{const n=e.target.closest("[data-canvas-container]");if(!n)return console.warn("Canvas container not found, falling back to offsetX/Y"),{x:e.offsetX,y:e.offsetY};const o=n.getBoundingClientRect();return{x:e.clientX-o.left,y:e.clientY-o.top}},Wf=()=>{const e=T.getState(),s=e.setSelectionBox,n=e.setPendingSelectionStart,o=e.setSelectedNodes,r=e.setNodeToFocusId,a=e.arrow.setSelected,i=Ar();return p.useCallback(c=>{var A,R,k,S,E;const l=zr(c),d=T.getState(),h=d.uiState.mode,u=(A=d.uiState)==null?void 0:A.isPanning;if(h===ee.MOVE||((R=T.getState().uiState)==null?void 0:R.dragInfo))return;const m=c.target,y=m.closest("[data-node-id]"),g=m.closest("[data-arrow-id]"),x=m.closest("[data-group-id]"),w=m.closest("[data-ui-panel]"),v=m.closest("[data-grid-svg]"),N=v&&v.getAttribute("data-grid-active")==="true",b=!!m.closest("foreignObject");if((h===ee.SELECT||h===ee.GRID||h===ee.WRITE||h===ee.VIM)&&(c.button===0||c.button===-1)&&!u){if(y||g||x||w||N||b)return;const C=c.shiftKey&&!c.ctrlKey&&!c.metaKey,I=e.projectCanvas.getActive();if((k=I==null?void 0:I.coreState.nodes)==null?void 0:k.some(z=>z.isEditing))return;const H=(I==null?void 0:I.coreState.selectedNodes)??[],L=(I==null?void 0:I.coreState.nodes)??[],W=(I==null?void 0:I.viewState.scale)??1,P=(I==null?void 0:I.viewState.offset)??{x:0,y:0};if(C&&H.length>0){const z=Dt(l,W,P),_=H[H.length-1],G=[{x:_.x,y:_.y},{x:_.x+(_.width??0),y:_.y},{x:_.x,y:_.y+(_.height??0)},{x:_.x+(_.width??0),y:_.y+(_.height??0)}];let F=G[0],D=0;G.forEach(ge=>{const we=Math.sqrt(Math.pow(ge.x-z.x,2)+Math.pow(ge.y-z.y,2));we>D&&(D=we,F=ge)});const V={x:Math.min(F.x,z.x),y:Math.min(F.y,z.y),width:Math.abs(F.x-z.x),height:Math.abs(F.y-z.y)},J=(I==null?void 0:I.coreState.activeLayerId)??At,ie=L.filter(ge=>{if((ge.layerId??At)!==J)return!1;const te=sa(ge);return ta(te,V)}),Se=new Set(H.map(ge=>ge.id)),me=ie.filter(ge=>!Se.has(ge.id)),Z=[...H,...me];o(Z);return}if(As.log("Selection Mouse Down on Background:",l.x,l.y),h===ee.WRITE){const z=e.projectCanvas.getActive(),_=(z==null?void 0:z.viewState.scale)??1,G=(z==null?void 0:z.viewState.offset)??{x:0,y:0},F=Dt(l,_,G);ul(async()=>{const{CanvasNodeBuilderV2:D}=await Promise.resolve().then(()=>Pg);return{CanvasNodeBuilderV2:D}},void 0).then(({CanvasNodeBuilderV2:D})=>{const V=D.buildTextNode(F,"");V.isEditing=!0,e.addNode(V,""),e.setNodeToFocusId(V.id)});return}const j=(S=T.getState().uiState)==null?void 0:S.pendingSelectionStart,M=(E=T.getState().uiState)==null?void 0:E.selectionBox;if(j&&M){n(null);return}const B=Dt(l,W,P);n(B),o([]),a([]),r(null);const U=c.pointerType==="touch";if(i&&U)return;s({start:l,end:l})}},[s,n,o,r,a,e,i])},Hf=()=>{const e=T.getState(),s=e.setSelectionBox,n=e.setActiveCanvasViewState,o=$(d=>d.uiState.selectionBox),r=ps(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useCallback(()=>{var y,g;const d=T.getState().projectCanvas.getActive(),h=(y=T.getState().uiState)==null?void 0:y.selectionBox;if(!d||!h){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const u=d.viewState.offset;let f=0,m=0;if(f=i.current.x,m=i.current.y,f!==0||m!==0){n(w=>({...w,offset:{x:u.x+f,y:u.y+m}}));const x=(g=T.getState().uiState)==null?void 0:g.selectionBox;if(x){const w={x:x.start.x+f,y:x.start.y+m};s({start:w,end:x.end})}}a.current=requestAnimationFrame(l)},[n,s]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useEffect(()=>{o||(c.current=null)},[o]),p.useCallback(d=>{var W,P,j,M,B;if((W=T.getState().uiState)==null?void 0:W.dragInfo)return;const u=zr(d),f=(P=T.getState().uiState)==null?void 0:P.pendingSelectionStart,m=T.getState().projectCanvas.getActive(),y=(m==null?void 0:m.viewState.scale)??1,g=(m==null?void 0:m.viewState.offset)??{x:0,y:0};if((j=m==null?void 0:m.coreState.nodes)==null?void 0:j.some(U=>U.isEditing))return;const w=(d.buttons&1)!==0;if(f&&d.shiftKey&&!w){const U=f.x*y+g.x,z=f.y*y+g.y;s({start:{x:U,y:z},end:u});return}if(f&&!d.shiftKey&&!w){((M=T.getState().uiState)==null?void 0:M.selectionBox)&&s(null);return}if(!o)return;const v=(B=T.getState().uiState)==null?void 0:B.selectionBox;if(!v)return;const N=window.innerWidth,b=window.innerHeight;let A=0,R=0;c.current&&(A=u.x-c.current.x,R=u.y-c.current.y),c.current={x:u.x,y:u.y},s({start:v.start,end:u});const k=d.clientX,S=d.clientY,E=Lf(r),C=S<E&&R<0,I=S>b-E&&R>0,O=k<E&&A<0,H=k>N-E&&A>0,L=C||I||O||H;if(L){let U=0,z=0;C&&(z=bo),I&&(z=-bo),O&&(U=bo),H&&(U=-bo),i.current={x:U,y:z},a.current===null&&(a.current=requestAnimationFrame(l))}else!L&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null,i.current={x:0,y:0})},[s,o,l,r])},Ff=()=>{var c;const e=T.getState(),s=e.setSelectionBox,n=e.setPendingSelectionStart,o=(c=e.uiState)==null?void 0:c.selectionBox,r=e.projectCanvas.getActive,a=e.setSelectedNodes,i=e.arrow.setSelected;return p.useCallback(l=>{var v,N,b;if((v=T.getState().uiState)==null?void 0:v.dragInfo)return;const h=zr(l),u=r(),f=(u==null?void 0:u.coreState.nodes)??[],m=(u==null?void 0:u.coreState.arrows)??[],y=(u==null?void 0:u.viewState.scale)??1,g=(u==null?void 0:u.viewState.offset)??{x:0,y:0},x=(N=T.getState().uiState)==null?void 0:N.selectionBox,w=(b=T.getState().uiState)==null?void 0:b.pendingSelectionStart;if(x){As.log("Selection Mouse Up:",h.x,h.y),As.log("Stopped Marquee Selection");const A={x:Math.min(x.start.x,h.x),y:Math.min(x.start.y,h.y),width:Math.abs(x.start.x-h.x),height:Math.abs(x.start.y-h.y)},R=Dt({x:A.x,y:A.y},y,g),k=Dt({x:A.x+A.width,y:A.y+A.height},y,g),S={x:R.x,y:R.y,width:k.x-R.x,height:k.y-R.y},E=5;if(A.width<E&&A.height<E){const L=T.getState().uiState.activeGroupId;if(L){const W=f.find(P=>P.id===L);if(W){const P=sa(W),j=Dt(h,y,g);j.x>=P.x&&j.x<=P.x+P.width&&j.y>=P.y&&j.y<=P.y+P.height||T.getState().group.setActiveGroupId(null)}else T.getState().group.setActiveGroupId(null)}w||(s(null),a([]),i([]));return}const C=T.getState().uiState.activeGroupId,I=(u==null?void 0:u.coreState.activeLayerId)??At,O=f.filter(L=>{if(C&&L.id===C||(L.layerId??At)!==I)return!1;const P=sa(L);return ta(P,S)});As.log("Selected Nodes by Marquee:",O.map(L=>L.content)),a(O);const H=m.filter(L=>{const W=Df(L,f),P=ta(W,S);return As.log(">>>> _ >>>> ~ useSelectionHandler.ts:164 ~ arrowBBox:",W),P});As.log("Selected Arrows by Marquee:",H.map(L=>L.id)),i(H),O.length>0&&(ud.dispatch(lr.SELECTION_BOX_END,{selectedNodes:O}),As.log(`Dispatched ${lr.SELECTION_BOX_END} event with nodes:`,O.map(L=>L.id))),s(null),n(null)}},[o,r,s,n,a,i])},Bf=()=>{const e=Kn.getState().mousePosition??null,n=T.getState().projectCanvas.getActive,o=n(),r=(o==null?void 0:o.viewState.scale)??1,a=(o==null?void 0:o.viewState.offset)??{x:0,y:0},i=p.useMemo(()=>e?Dt(e,r,a):null,[e,r,a]);return{screenCoords:e,canvasCoords:i}},Et={"I am dragging a node near the <edge> edge":"I am dragging a node near the <edge> edge","I am dragging a node near the top edge":"I am dragging a node near the top edge","I am dragging a node toward the <edge> edge":"I am dragging a node toward the <edge> edge","I am in GRID mode":"I am in GRID mode","I am in MOVE mode":"I am in MOVE mode","I am in SELECT mode":"I am in SELECT mode","I am in WRITE mode":"I am in WRITE mode","I have a canvas with nodes":"I have a canvas with nodes","I have selected a node":"I have selected a node","auto-scroll is active":"auto-scroll is active"},os={"I click on a node":"I click on a node","I hold Ctrl and click on another node":"I hold Ctrl and click on another node","I hold Ctrl and click on one of the selected nodes":"I hold Ctrl and click on one of the selected nodes","I hold Shift and click on a node":"I hold Shift and click on a node"},zf=e=>e?Q.autoScroll.edgeThresholdMobile:Q.autoScroll.edgeThreshold,$o=Q.autoScroll.edgeThreshold;let hd=!1;const $f=e=>{hd=e};let dr=0,pd=0;const _o={[Et["I have a canvas with nodes"]]:()=>{const e=T.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.nodes.length)??0)>0},[Et["I have selected a node"]]:()=>{const e=T.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.selectedNodes.length)??0)>0},[Et["I am dragging a node near the top edge"]]:(e,s=$o)=>T.getState().uiState.dragInfo?(e??dr)<s:!1,[Et["I am dragging a node near the <edge> edge"]]:(e,s,n,o=$o)=>{if(!T.getState().uiState.dragInfo)return!1;const i=s??pd,c=n??dr;switch(e){case"top":return c<o;case"bottom":return c>window.innerHeight-o;case"left":return i<o;case"right":return i>window.innerWidth-o;default:return!1}},[Et["auto-scroll is active"]]:()=>hd,[Et["I am dragging a node toward the <edge> edge"]]:(e,s,n,o=$o)=>{if(!T.getState().uiState.dragInfo)return!1;const i=_o[Et["I am dragging a node near the <edge> edge"]](e,void 0,void 0,o);if(!i)return!1;if(s===void 0&&n===void 0)return i;switch(e){case"top":return(n??0)<0;case"bottom":return(n??0)>0;case"left":return(s??0)<0;case"right":return(s??0)>0;default:return!1}}},_f=(e,s)=>{pd=e,dr=s},ys=Q.autoScroll.scrollSpeed,gd=(e,s,n=$o)=>{if(e===null||s===null)return{x:0,y:0};let o=0,r=0;const a=window.innerWidth,i=window.innerHeight;return e<n?o=ys:e>a-n&&(o=-ys),s<n?r=ys:s>i-n&&(r=-ys),{x:o,y:r}},Uf=(e,s)=>({x:-e.x/s,y:-e.y/s}),No={getScrollDeltaForMousePosition:(e,s)=>gd(e,s),shouldScroll:e=>e.x!==0||e.y!==0,applyDeltaToPosition:(e,s,n)=>({x:Number((e+n.x).toFixed(2)),y:Number((s+n.y).toFixed(2))})},qs={calculateScrollDelta:(e,s)=>{if(e){const n=gd(e.x,e.y),o=No.shouldScroll(n);return{delta:n,shouldUpdateLastDelta:o}}return{delta:s,shouldUpdateLastDelta:!1}},calculateNewOffset:(e,s)=>({x:e.x+s.x,y:e.y+s.y}),updateNodesForScroll:(e,s,n)=>e.map(o=>{if(s.has(o.id)){const r=No.applyDeltaToPosition(o.x,o.y,n);return{...o,...r}}return o}),updateSelectedNodesForScroll:(e,s)=>e.map(n=>{const o=No.applyDeltaToPosition(n.x,n.y,s);return{...n,...o}}),updateArrowsForScroll:(e,s,n)=>e.map(o=>{let r=o.startPoint,a=o.endPoint;return o.startNodeId&&s.has(o.startNodeId)&&(r={x:Number((o.startPoint.x+n.x).toFixed(2)),y:Number((o.startPoint.y+n.y).toFixed(2))}),o.endNodeId&&s.has(o.endNodeId)&&(a={x:Number((o.endPoint.x+n.x).toFixed(2)),y:Number((o.endPoint.y+n.y).toFixed(2))}),r!==o.startPoint||a!==o.endPoint?{...o,startPoint:r,endPoint:a}:o}),processAutoScrollFrame:e=>{const{mousePosition:s,lastScrollDelta:n,currentOffset:o,scale:r,nodes:a,selectedNodes:i,arrows:c=[]}=e,{delta:l}=qs.calculateScrollDelta(s,n);if(!No.shouldScroll(l))return{shouldScroll:!1,scrollDelta:l,newOffset:o,updatedNodes:a,updatedSelectedNodes:i,updatedArrows:c};const h=qs.calculateNewOffset(o,l),u=Uf(l,r),f=new Set(i.map(x=>x.id)),m=qs.updateNodesForScroll(a,f,u),y=qs.updateSelectedNodesForScroll(i,u),g=qs.updateArrowsForScroll(c,f,u);return{shouldScroll:!0,scrollDelta:l,newOffset:h,updatedNodes:m,updatedSelectedNodes:y,updatedArrows:g}}},ur={isShiftPressed:e=>e.shiftKey&&!e.ctrlKey&&!e.metaKey,isCtrlPressed:e=>e.ctrlKey||e.metaKey,noModifiersPressed:e=>!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey},Vf=e=>{const s=T.getState().projectCanvas.getActive();return(s==null?void 0:s.coreState.selectedNodes.some(n=>n.id===e))??!1},So=()=>{const e=T.getState().projectCanvas.getActive();return(e==null?void 0:e.coreState.selectedNodes)??[]},hr={isClickOnEditingElement:e=>!!e.closest("[data-is-editing='true']"),hasActiveTextSelection:()=>{const e=window.getSelection();return e!==null&&!e.isCollapsed&&e.toString().length>0},getSelectedText:()=>{const e=window.getSelection();return(e==null?void 0:e.toString())??""},isInsideTextInput:e=>{const s=e.tagName.toLowerCase();return s==="textarea"||s==="input"?!0:!!e.closest('textarea, input, [contenteditable="true"]')}},Gf=(e,s)=>{const n=[];for(const o of s)o.startNodeId===e&&o.endNodeId&&n.push(o.endNodeId);return n},Yf=(e,s)=>s.filter(n=>n.endNodeId===e).length,fd=(e,s,n,o=!1)=>{const r=new Set(e),a=new Set,i=[...e],c=new Set(e);for(;i.length>0;){const d=i.shift(),h=Gf(d,n);for(const u of h)c.has(u)||s.some(f=>f.id===u)&&(c.add(u),!(o&&Yf(u,n)>1)&&(a.add(u),i.push(u)))}return s.filter(d=>a.has(d.id)&&!r.has(d.id))},Xf=(e,s)=>{const n=new Set,o=e.filter(r=>r.isCollapsed);for(const r of o)fd([r.id],e,s,!0).forEach(i=>n.add(i.id));return n};let Kf=!0;const Di={isDragInProgress:()=>{var s;const e=(s=T.getState().uiState)==null?void 0:s.dragInfo;return e!=null},isDragWithSelectedNodes:()=>{var o;const e=T.getState();if(!((o=e.uiState)==null?void 0:o.dragInfo))return!1;const n=e.projectCanvas.getActive();return((n==null?void 0:n.coreState.selectedNodes.length)??0)>0},isFirstMoveEvent:()=>Kf,[Et["I am in SELECT mode"]]:()=>T.getState().uiState.mode===ee.SELECT,[Et["I am in GRID mode"]]:()=>T.getState().uiState.mode===ee.GRID,[Et["I am in MOVE mode"]]:()=>T.getState().uiState.mode===ee.MOVE,[Et["I am in WRITE mode"]]:()=>T.getState().uiState.mode===ee.WRITE,canDragInCurrentMode:()=>{const e=T.getState().uiState.mode;return e===ee.SELECT||e===ee.GRID||e===ee.WRITE||e===ee.VIM},isPrimaryButton:e=>e.button===0||e.button===-1},An={calculateScreenDelta:e=>{const{screenCoords:s,prevScreenPos:n}=e;if(!s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:null,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!0};if(s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:s,newDragDirection:null,isFirstMoveEvent:!0,shouldSkipFrame:!0};if(s&&n){const o={x:s.x-n.x,y:s.y-n.y},r=o.x!==0||o.y!==0?o:null;return{screenDelta:o,newPrevScreenPos:s,newDragDirection:r,isFirstMoveEvent:!1,shouldSkipFrame:!1}}return{screenDelta:{x:0,y:0},newPrevScreenPos:n,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!1}},screenDeltaToCanvasDelta:(e,s)=>({x:e.x/s,y:e.y/s}),checkAutoScrollEdges:e=>{const{screenCoords:s,dragDirection:n,draggedNode:o,scale:r,offset:a,edgeThreshold:i}=e;let c=!1;o&&(c=o.y*r+a.y<=0&&n.y<0);const l=c,d=_o[Et["I am dragging a node toward the <edge> edge"]]("bottom",n.x,n.y,i),h=_o[Et["I am dragging a node toward the <edge> edge"]]("left",n.x,n.y,i),u=_o[Et["I am dragging a node toward the <edge> edge"]]("right",n.x,n.y,i);return{shouldAutoScroll:l||d||h||u}},calculateMouseLeftWindowDelta:e=>{const{lastCoords:s,viewportWidth:n,viewportHeight:o}=e;if(!s)return{shouldStartAutoScroll:!1,scrollDelta:{x:0,y:0}};let r=0,a=0;return s.x<n/2?r=ys:r=-ys,s.y<o/2?a=ys:a=-ys,{shouldStartAutoScroll:!0,scrollDelta:{x:r,y:a}}},calculateNodeMoves:e=>{const{canvasDelta:s,draggedNodeId:n,selectedNodes:o,nodes:r,arrows:a,isCtrlPressed:i,isShiftPressed:c}=e;if(Math.abs(s.x)<.1&&Math.abs(s.y)<.1)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const l=new Set(o.map(g=>g.id));let d=new Set(l);if(i){const g=c??!1;fd(Array.from(l),r,a,g).forEach(w=>d.add(w.id))}for(const g of o)if(g.type===fe.GROUP){const x=g.data,w=x==null?void 0:x.childNodeIds;if(w)for(const v of w)d.add(v)}if(d.size===0)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const h=s.x,u=s.y;let f=null;for(let g=0;g<r.length;g++){const x=r[g];d.has(x.id)&&(f||(f=r.slice()),f[g]={...x,x:x.x+h,y:x.y+u})}let m=null;for(let g=0;g<o.length;g++){const x=o[g];d.has(x.id)&&(m||(m=o.slice()),m[g]={...x,x:x.x+h,y:x.y+u})}let y=null;for(let g=0;g<a.length;g++){const x=a[g],w=x.startNodeId&&d.has(x.startNodeId),v=x.endNodeId&&d.has(x.endNodeId);(w||v)&&(y||(y=a.slice()),y[g]={...x,startPoint:w?{x:x.startPoint.x+h,y:x.startPoint.y+u}:x.startPoint,endPoint:v?{x:x.endPoint.x+h,y:x.endPoint.y+u}:x.endPoint})}return{shouldUpdate:!0,updatedNodes:f??r,updatedSelectedNodes:m??o,updatedArrows:y??a}}},qf=(e,s)=>{const n=[{x:e.x,y:e.y},{x:e.x+(e.width??0),y:e.y},{x:e.x,y:e.y+(e.height??0)},{x:e.x+(e.width??0),y:e.y+(e.height??0)}];let o=n[0],r=0;return n.forEach(a=>{const i=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2));i>r&&(r=i,o=a)}),o},Zf=(e,s)=>({x:Math.min(e.x,s.x),y:Math.min(e.y,s.y),width:Math.abs(e.x-s.x),height:Math.abs(e.y-s.y)}),Jf=(e,s)=>e.filter(n=>{const o=sa(n);return ta(o,s)}),Qf=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=s.filter(r=>!n.has(r.id));return[...e,...o]},Zs={[os["I hold Shift and click on a node"]]:(e,s)=>{const o=T.getState().projectCanvas.getActive(),r=(o==null?void 0:o.coreState.selectedNodes)??[],a=(o==null?void 0:o.coreState.nodes)??[];if(r.length===0)return[e];const i=r[r.length-1],c=qf(i,s),l=Zf(c,s),d=Jf(a,l);return Qf(r,d)},[os["I hold Ctrl and click on one of the selected nodes"]]:e=>So().filter(n=>n.id!==e.id),[os["I hold Ctrl and click on another node"]]:e=>[...So(),e],[os["I click on a node"]]:(e,s)=>s?So():[e],handleNodeMouseDown:e=>{const{node:s,event:n,canvasCoords:o}=e,r=T.getState(),a=r.projectCanvas.getActive(),i=So(),c=Vf(s.id),l=(a==null?void 0:a.coreState.activeLayerId)??At,d=s.layerId??At;if(d!==l)return{action:"wrong_layer",shouldStartDrag:!1,newSelection:i,targetLayerId:d,clickedNode:s};const h=s.groupId,u=r.uiState.activeGroupId,f=(a==null?void 0:a.coreState.nodes)??[];if(s.type===fe.GROUP&&c&&i.length===1&&u!==s.id)return r.group.setActiveGroupId(s.id),{action:"keep_selection",shouldStartDrag:!0,newSelection:i,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};if(h&&h!==u){const g=f.find(x=>x.id===h&&x.type===fe.GROUP);if(g)return i.length===1&&i[0].id===g.id?(r.group.setActiveGroupId(h),{action:"replace_selection",shouldStartDrag:!0,newSelection:Zs[os["I click on a node"]](s,c),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}):{action:"select_group",shouldStartDrag:!1,newSelection:[g],selectedGroup:g}}if(ur.isShiftPressed(n)&&i.length>0)return{action:"shift_select",shouldStartDrag:!1,newSelection:Zs[os["I hold Shift and click on a node"]](s,o)};if(ur.isCtrlPressed(n))return c?{action:"ctrl_toggle_remove",shouldStartDrag:!1,newSelection:Zs[os["I hold Ctrl and click on one of the selected nodes"]](s)}:{action:"ctrl_toggle_add",shouldStartDrag:!0,newSelection:Zs[os["I hold Ctrl and click on another node"]](s),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};u&&h!==u&&r.group.setActiveGroupId(null);const y=Zs[os["I click on a node"]](s,c);return{action:c?"keep_selection":"replace_selection",shouldStartDrag:!0,newSelection:y,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}}},Wt={isNodeInsideGroup:(e,s)=>hl(e,s),isNodeInGroup:e=>e.groupId!==void 0&&e.groupId!==null,isGroupNode:e=>e.type===fe.GROUP,canBeAddedToGroup:e=>!Wt.isGroupNode(e)&&!Wt.isNodeInGroup(e),isValidDropCandidate:e=>!Wt.isGroupNode(e)},$a={filterValidDropCandidates:e=>e.filter(Wt.canBeAddedToGroup),filterNodesInGroups:e=>e.filter(Wt.isNodeInGroup),filterGroupNodes:e=>e.filter(Wt.isGroupNode),getCurrentGroupForNode:(e,s)=>{if(e.groupId)return s.find(n=>n.id===e.groupId)},findGroupDropTargets:(e,s)=>e.filter(n=>n.type===fe.GROUP&&!s.has(n.id))},md={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Set(s.map(i=>i.id)),a=$a.findGroupDropTargets(n,r);for(const i of s){if(Wt.isGroupNode(i)||Wt.isNodeInGroup(i))continue;const c=a.find(l=>l.id===o?!1:Wt.isNodeInsideGroup(i,l));if(c)return{hoveredGroupId:c.id,hasValidDropTarget:!0}}return{hoveredGroupId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Map,a=[],i=new Set(s.map(d=>d.id)),c=$a.findGroupDropTargets(n,i);for(const d of s){if(Wt.isGroupNode(d))continue;if(Wt.isNodeInGroup(d)){const u=$a.getCurrentGroupForNode(d,c);u&&!Wt.isNodeInsideGroup(d,u)&&a.push(d.id);continue}const h=c.find(u=>u.id===o?!1:Wt.isNodeInsideGroup(d,u));if(h){const u=r.get(h.id)||[];u.push(d.id),r.set(h.id,u)}}const l=r.size>0||a.length>0;return{nodesToAddToGroups:r,nodesToRemoveFromGroups:a,hasChanges:l}}},em=69,tm=41,sm=45,pr={isTableNode:e=>e.type===fe.TABLE,isPointInsideNode:(e,s)=>{const n=qn(s);return e.x>=n.x1&&e.x<=n.x2&&e.y>=n.y1&&e.y<=n.y2},hasValidTableData:e=>{const s=e.data;return!!(s!=null&&s.columns)&&Array.isArray(s.columns)&&s.columns.length>0}},_n={getNodeCenter:e=>{const s=qn(e);return{x:(s.x1+s.x2)/2,y:(s.y1+s.y2)/2}},findTableDropTargets:(e,s)=>e.filter(n=>pr.isTableNode(n)&&!s.has(n.id)),calculateTargetColumn:(e,s)=>{const n=s.data;if(!(n!=null&&n.columns)||n.columns.length===0)return null;const o=qn(s),r=o.x2-o.x1,a=e-o.x1,i=n.columnOrder&&n.columnOrder.length>0?n.columnOrder.map(f=>n.columns.find(m=>m.key===f)).filter(f=>f!==void 0):n.columns;let c=0;for(const f of i)c+=f.width?parseInt(f.width,10):150;const l=r/c;let d=0;const h=[];for(let f=0;f<i.length;f++){const m=i[f],g=(m.width?parseInt(m.width,10):150)*l,x=d;d+=g,h.push({key:m.key,relStart:Math.round(x),relEnd:Math.round(d),absStart:Math.round(o.x1+x),absEnd:Math.round(o.x1+d)})}for(let f=0;f<h.length;f++){const m=h[f];if(a<m.relEnd)return{columnIndex:f,columnKey:m.key}}const u=i[i.length-1];return{columnIndex:i.length-1,columnKey:u.key}},calculateTargetRow:(e,s)=>{const n=s.data;if(!(n!=null&&n.rows)||n.rows.length===0)return null;const o=qn(s),r=e-o.y1,a=em+tm;if(r<a)return null;const i=Math.floor((r-a)/sm);if(i<0)return null;if(i>=n.rows.length){const c=n.rows[n.rows.length-1];return{rowIndex:n.rows.length-1,rowId:c.id}}return{rowIndex:i,rowId:n.rows[i].id}},extractNodeContent:e=>e.content===null||e.content===void 0?"":String(e.content)},xd={calculateTableDropTarget:e=>{const{droppedNode:s,allNodes:n,mousePosition:o}=e,r=o??_n.getNodeCenter(s),a=new Set([s.id]),i=_n.findTableDropTargets(n,a);for(const c of i){if(!pr.isPointInsideNode(r,c)||!pr.hasValidTableData(c))continue;const l=_n.calculateTargetColumn(r.x,c);if(!l)continue;const d=_n.calculateTargetRow(r.y,c);return{targetTableId:c.id,columnIndex:l.columnIndex,columnKey:l.columnKey,rowIndex:(d==null?void 0:d.rowIndex)??null,rowId:(d==null?void 0:d.rowId)??null}}return{targetTableId:null,columnIndex:null,columnKey:null,rowIndex:null,rowId:null}}};var tt=(e=>(e.DICTIONARY="dictionary",e.FLASHCARD="flashcard",e.WORD_LIST="word_list",e.ETYMOLOGY="etymology",e.VOCABULARY="vocabulary",e))(tt||{});const cn={isVocabularyNode:e=>e.type===fe.VOCABULARY,isVocabularyMode:e=>{if(!cn.isVocabularyNode(e))return!1;const s=e.data;return(s==null?void 0:s.vocabType)===tt.VOCABULARY},isTextNode:e=>e.type===fe.TEXT,canBeDroppedOnVocab:e=>cn.isTextNode(e),isNodeInsideVocabNode:(e,s)=>hl(e,s)},Tn={findVocabularyDropTargets:(e,s)=>e.filter(n=>cn.isVocabularyMode(n)&&!s.has(n.id)),extractNodeContent:e=>typeof e.content=="string"?e.content.trim():"",sortNodesByPosition:e=>[...e].sort((s,n)=>s.x+s.y-(n.x+n.y))},yd={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n}=e,o=new Set(s.map(a=>a.id)),r=Tn.findVocabularyDropTargets(n,o);for(const a of s){if(!cn.canBeDroppedOnVocab(a))continue;const i=r.find(c=>cn.isNodeInsideVocabNode(a,c));if(i)return{hoveredVocabNodeId:i.id,hasValidDropTarget:!0}}return{hoveredVocabNodeId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,targetVocabNode:n}=e,o=s.filter(cn.canBeDroppedOnVocab);if(o.length===0)return{sourceWord:"",translationWord:"",nodeIdsToDelete:[],hasChanges:!1};const r=n.data,a=(r==null?void 0:r.sourceWord)||"",i=(r==null?void 0:r.translationWord)||"";let c=a,l=i;const d=[];if(o.length>=2){const u=Tn.sortNodesByPosition(o);c=Tn.extractNodeContent(u[0]),l=Tn.extractNodeContent(u[u.length-1]),d.push(...o.map(f=>f.id))}else{const u=Tn.extractNodeContent(o[0]);a?l=u:c=u,d.push(o[0].id)}return{sourceWord:c,translationWord:l,nodeIdsToDelete:d,hasChanges:c!==a||l!==i}}},xt=new zs("useNodeDragHandler",$s.useCanvasMouseEventsV2),nm=e=>{const s=e.target,n=s.closest('[data-test="chat-messages-container"]'),o=s.closest('[data-test="chat-header"]');return n!==null&&o===null};let Qn=null,Un=null;const _a=()=>{Qn&&(clearTimeout(Qn),Qn=null),Un=null},Qt=new Map,Oi=(e,s,n,o,r)=>{const a=T.getState(),i=Zs.handleNodeMouseDown({node:e,event:s,canvasCoords:n});if(i.action==="wrong_layer"&&i.targetLayerId&&i.clickedNode){a.setUiState(c=>({...c,switchLayerDialog:{isOpen:!0,targetLayerId:i.targetLayerId,clickedNodeId:i.clickedNode.id}})),xt.log(`Node Mouse Down: Node ${e.id} is on layer ${i.targetLayerId}, not current layer`);return}if(i.action==="select_group"&&i.selectedGroup){r([i.selectedGroup]),xt.log("Node Mouse Down: Selected parent group node",i.selectedGroup.id,"instead of node",e.id);return}if(r(i.newSelection),xt.log(`Node Mouse Down: ${i.action}`,e.id,"Selection count:",i.newSelection.length),i.shouldStartDrag&&i.dragStartOffset){const c={};for(const l of i.newSelection)c[l.id]={x:l.x,y:l.y};c[e.id]||(c[e.id]={x:e.x,y:e.y}),o({draggedNodeId:e.id,dragStartOffset:i.dragStartOffset,initialNodePosition:{x:e.x,y:e.y},initialPositions:c}),xt.log("Node Drag Start on:",e.id,"tracking",Object.keys(c).length,"nodes")}},om=e=>{const s=T.getState(),n=s.setDragInfo,o=s.setSelectedNodes;return p.useCallback(r=>{const a=T.getState().getCanvasMouseCoords();if(!Di.canDragInCurrentMode()||!Di.isPrimaryButton(r))return;r.stopPropagation();const i=r.target;if(hr.isClickOnEditingElement(i)){xt.log("Node Mouse Down: Clicked on editing node, skipping drag initialization");return}if(!a){xt.warn("Node Mouse Down: Canvas coordinates not available.");return}if(nm(r)){xt.log("Node Mouse Down: Inside ChatNode scroll area, starting hold-to-drag timer"),_a(),Un={x:r.clientX,y:r.clientY},T.getState().setChatNodeHoldToDrag({nodeId:e.id,isHolding:!0,isReady:!1});let c=!1;const l=h=>{if(!c&&Un){const u=h.clientX-Un.x,f=h.clientY-Un.y;Math.sqrt(u*u+f*f)>Q.holdToDrag.movementThresholdPx&&(xt.log("Node Mouse Down: Movement exceeded threshold, cancelling hold"),_a(),T.getState().setChatNodeHoldToDrag(null),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d))}},d=()=>{c||(xt.log("Node Mouse Down: Pointer up before hold complete, cancelling hold"),_a(),T.getState().setChatNodeHoldToDrag(null),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d))};document.addEventListener("pointermove",l),document.addEventListener("pointerup",d),Qn=setTimeout(()=>{xt.log("Node Mouse Down: Hold timer complete, starting drag"),Qn=null,c=!0,document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d),T.getState().setChatNodeHoldToDrag({nodeId:e.id,isHolding:!1,isReady:!0}),a&&Oi(e,r,a,n,o)},Q.holdToDrag.holdDelayMs);return}Oi(e,r,a,n,o)},[e,n,o])},am=()=>{const e=T.getState(),s=$(h=>h.uiState.dragInfo),n=e.setActiveCanvasCoreState,o=e.setActiveCanvasViewState;Bf();const r=ps(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useRef({x:0,y:0});p.useEffect(()=>{s&&(c.current=null)},[s]);const d=p.useCallback(()=>{var m;const h=T.getState().projectCanvas.getActive(),u=(m=T.getState().uiState)==null?void 0:m.dragInfo;if(!h||!u){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const f=qs.processAutoScrollFrame({mousePosition:Kn.getState().mousePosition??null,lastScrollDelta:i.current,currentOffset:h.viewState.offset,scale:h.viewState.scale,nodes:h.coreState.nodes,selectedNodes:h.coreState.selectedNodes,arrows:h.coreState.arrows||[]});f.shouldScroll&&(i.current=f.scrollDelta,o(y=>({...y,offset:f.newOffset})),n(y=>({...y,nodes:f.updatedNodes,selectedNodes:f.updatedSelectedNodes,arrows:f.updatedArrows}))),a.current=requestAnimationFrame(d)},[o,n]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useCallback(h=>{var E,C,I;const u=(E=T.getState().uiState)==null?void 0:E.dragInfo;if(!u)return;const f=T.getState().viewLayer.getActiveId();let m;if(f){const O=((C=T.getState().projectCanvas.getActive())==null?void 0:C.coreState.selectedNodes)??[],H=T.getState().viewLayer.getNodesWithEffectivePositions();if(O.length>0)m=O.map(L=>H.find(P=>P.id===L.id)??L);else if(u.draggedNodeId){const L=H.find(W=>W.id===u.draggedNodeId);m=L?[L]:[]}else m=[]}else m=((I=T.getState().projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes)??[];if(m.length===0)return;const y=Kn.getState().mousePosition??null,g=An.calculateScreenDelta({screenCoords:y,prevScreenPos:c.current});if(g.newPrevScreenPos!==null&&(c.current=g.newPrevScreenPos),g.newDragDirection&&(l.current=g.newDragDirection),g.shouldSkipFrame)return;const x=T.getState().projectCanvas.getActive();if(!x)return;const w=x.viewState.scale,v=An.screenDeltaToCanvasDelta(g.screenDelta,w);if(y){_f(y.x,y.y);const O=x.coreState.nodes.find(W=>W.id===u.draggedNodeId),H=zf(r),L=An.checkAutoScrollEdges({screenCoords:y,dragDirection:l.current,draggedNode:O,scale:w,offset:x.viewState.offset,edgeThreshold:H});$f(L.shouldAutoScroll),L.shouldAutoScroll&&a.current===null?a.current=requestAnimationFrame(d):!L.shouldAutoScroll&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null)}else if(a.current===null){const O=An.calculateMouseLeftWindowDelta({lastCoords:Kn.getState().mousePosition??null,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight});O.shouldStartAutoScroll&&(i.current=O.scrollDelta,a.current=requestAnimationFrame(d))}const N=h.target;if(hr.isClickOnEditingElement(N)||hr.hasActiveTextSelection())return;const b=T.getState().viewLayer.getActiveId(),A=b?T.getState().viewLayer.getNodesWithEffectivePositions():x.coreState.nodes,R=b?A:A.map(O=>{const H=Qt.get(O.id);return H?{...O,x:O.x+H.dx,y:O.y+H.dy}:O}),k=b?m:m.map(O=>{const H=Qt.get(O.id);return H?{...O,x:O.x+H.dx,y:O.y+H.dy}:O}),S=An.calculateNodeMoves({canvasDelta:v,draggedNodeId:u.draggedNodeId,selectedNodes:k,nodes:R,arrows:x.coreState.arrows||[],isCtrlPressed:ur.isCtrlPressed(h),isShiftPressed:h.shiftKey});if(S.shouldUpdate){if(b){const j=[],M=[];for(const U of S.updatedSelectedNodes)U.type===fe.GROUP?M.push({id:U.id,x:U.x,y:U.y}):j.push({id:U.id,x:U.x,y:U.y});const B=new Set(S.updatedSelectedNodes.map(U=>U.id));for(const U of S.updatedNodes){if(B.has(U.id)||U.type===fe.GROUP)continue;const z=A.find(_=>_.id===U.id);z&&(z.x!==U.x||z.y!==U.y)&&j.push({id:U.id,x:U.x,y:U.y})}j.length>0&&T.getState().viewLayer.updateNodePositions(j);for(const U of M)T.getState().viewLayer.updateGroupNode(b,U.id,{x:U.x,y:U.y});n(U=>({...U,selectedNodes:S.updatedSelectedNodes,arrows:S.updatedArrows}))}else{for(const j of S.updatedSelectedNodes){const M=A.find(B=>B.id===j.id);if(M){const B=j.x-M.x,U=j.y-M.y;Qt.set(j.id,{dx:B,dy:U});const z=document.getElementById(`NodeContainerV2-${j.id}`);z&&(z.style.transform=`translate(${j.x}px, ${j.y}px)`)}}T.getState().incrementDragVersion()}const O=md.calculateHoveredDropTarget({draggedNodes:S.updatedSelectedNodes,allNodes:S.updatedNodes,activeGroupId:T.getState().uiState.activeGroupId??null}),H=T.getState().uiState.hoveredDropTargetGroupId;O.hoveredGroupId!==H&&T.getState().setHoveredDropTargetGroupId(O.hoveredGroupId);const L=yd.calculateHoveredDropTarget({draggedNodes:S.updatedSelectedNodes,allNodes:S.updatedNodes}),W=T.getState().uiState.hoveredDropTargetVocabNodeId;L.hoveredVocabNodeId!==W&&T.getState().setHoveredDropTargetVocabNodeId(L.hoveredVocabNodeId);const P=S.updatedSelectedNodes.length===1?S.updatedSelectedNodes[0]:null;if(P){const j=document.querySelector("[data-canvas-container]"),M=j==null?void 0:j.getBoundingClientRect(),B=M?{x:h.clientX-M.left,y:h.clientY-M.top}:null,U=(x==null?void 0:x.viewState.scale)??1,z=(x==null?void 0:x.viewState.offset)??{x:0,y:0},_=B?{x:(B.x-z.x)/U,y:(B.y-z.y)/U}:null,G=xd.calculateTableDropTarget({droppedNode:P,allNodes:S.updatedNodes,mousePosition:_??void 0}),F=T.getState().uiState.tableDropTarget,D=G.targetTableId&&G.columnKey?{tableId:G.targetTableId,columnKey:G.columnKey,rowId:G.rowId,rowIndex:G.rowIndex}:null;((F==null?void 0:F.tableId)!==(D==null?void 0:D.tableId)||(F==null?void 0:F.columnKey)!==(D==null?void 0:D.columnKey)||(F==null?void 0:F.rowId)!==(D==null?void 0:D.rowId))&&T.getState().setTableDropTarget(D)}else T.getState().uiState.tableDropTarget&&T.getState().setTableDropTarget(null)}},[n,d,r])},rm=()=>{const e=T.getState(),s=$(o=>o.uiState.dragInfo),n=e.setDragInfo;return p.useCallback(o=>{var r,a,i;if(s){xt.log("Node Drag End (Pointer Up on):",s.draggedNodeId);const c=T.getState().projectCanvas.getActive(),l=(c==null?void 0:c.coreState.nodes)??[],d=l.find(u=>u.id===s.draggedNodeId);if(d){const f=T.getState().viewLayer.getActiveId()?T.getState().viewLayer.getNodesWithEffectivePositions():l,m=f.find(A=>A.id===d.id)??d,y=document.querySelector("[data-canvas-container]"),g=y==null?void 0:y.getBoundingClientRect(),x=(c==null?void 0:c.viewState.scale)??1,w=(c==null?void 0:c.viewState.offset)??{x:0,y:0},v=g?{x:o.clientX-g.left,y:o.clientY-g.top}:null,N=v?{x:(v.x-w.x)/x,y:(v.y-w.y)/x}:null,b=xd.calculateTableDropTarget({droppedNode:m,allNodes:f,mousePosition:N??void 0});if(b.targetTableId&&b.columnKey){const A=_n.extractNodeContent(d);let R=!1;if(b.rowId!==null?(R=T.getState().table.updateCellFromDrop(b.targetTableId,b.rowId,b.columnKey,A),R&&xt.log(`Updated cell in table ${b.targetTableId}, row: ${b.rowId}, column: ${b.columnKey}`)):(R=T.getState().table.addRowFromDrop(b.targetTableId,b.columnKey,A),R&&xt.log(`Dropped node ${d.id} onto table ${b.targetTableId}, column: ${b.columnKey}`)),R){let k=Q.canvasTable.dropBehavior;try{const S=localStorage.getItem("watcher-table-node-drop-config");S&&(k=JSON.parse(S).dropBehavior)}catch{}k==="delete"?(T.getState().deleteNodeById(d.id),T.getState().setSelectedNodes([])):k==="copy"&&s.initialNodePosition&&T.getState().updateNode(d.id,{x:s.initialNodePosition.x,y:s.initialNodePosition.y}),T.getState().setHoveredDropTargetGroupId(null),T.getState().setHoveredDropTargetVocabNodeId(null),n(null);return}}}const h=T.getState().uiState.hoveredDropTargetVocabNodeId;if(h&&d){const u=(c==null?void 0:c.coreState.selectedNodes)??[],f=u.length>0?u:[d],m=l.find(y=>y.id===h);if(m){const y=yd.calculateDropResult({droppedNodes:f,targetVocabNode:m});if(y.hasChanges){const g=m.data??{};T.getState().updateNode(h,{data:{...g,sourceWord:y.sourceWord,translationWord:y.translationWord}});for(const x of y.nodeIdsToDelete)T.getState().deleteNodeById(x);T.getState().setSelectedNodes([]),xt.log(`Dropped nodes onto vocab node ${h}: source="${y.sourceWord}", translation="${y.translationWord}"`),T.getState().setHoveredDropTargetGroupId(null),T.getState().setHoveredDropTargetVocabNodeId(null),T.getState().setTableDropTarget(null),n(null);return}}}if(d){const u=(c==null?void 0:c.coreState.selectedNodes)??[],f=u.length>0?u:[d],m=md.calculateDropResult({droppedNodes:f,allNodes:l,activeGroupId:T.getState().uiState.activeGroupId??null});if(m.hasChanges){for(const[y,g]of m.nodesToAddToGroups)xt.log(`Adding nodes ${g.join(", ")} to group ${y}`),T.getState().group.addNodesToGroup(y,g);m.nodesToRemoveFromGroups.length>0&&(xt.log(`Removing nodes ${m.nodesToRemoveFromGroups.join(", ")} from their groups`),T.getState().group.removeNodesFromGroup(m.nodesToRemoveFromGroups))}}if(T.getState().setHoveredDropTargetGroupId(null),T.getState().setHoveredDropTargetVocabNodeId(null),T.getState().setTableDropTarget(null),Qt.size>0){const u=((r=T.getState().projectCanvas.getActive())==null?void 0:r.coreState.nodes)??[],f=((a=T.getState().projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],m=u.map(g=>{const x=Qt.get(g.id);return x?{...g,x:g.x+x.dx,y:g.y+x.dy}:g}),y=f.map(g=>{const x=Qt.get(g.id);return x?{...g,x:g.x+x.dx,y:g.y+x.dy}:g});T.getState().setActiveCanvasCoreState(g=>({...g,nodes:m,selectedNodes:y})),Qt.clear()}if(s.initialPositions){const u=((i=T.getState().projectCanvas.getActive())==null?void 0:i.coreState.nodes)??[],f=[];for(const[m,y]of Object.entries(s.initialPositions)){const g=u.find(x=>x.id===m);g&&(g.x!==y.x||g.y!==y.y)&&f.push({nodeId:m,from:y,to:{x:g.x,y:g.y}})}if(f.length>0){const m=Ru(f);T.getState().undo.commit(m),xt.log("Committed move operation for",f.length,"nodes")}}T.getState().setChatNodeHoldToDrag(null),n(null)}},[s,n])},gr=new Map,Co=20,im=300,ms=(e,s)=>{const n=Ar(),o=p.useRef(null),r=p.useCallback(()=>{o.current&&(clearTimeout(o.current),o.current=null),T.getState().setNodeHoldToResize(null)},[]);return p.useCallback(a=>{const i=T.getState(),c=i.uiState.mode,l=i.setResizingNode;if(c!==ee.SELECT||a.button!==0&&a.button!==-1)return;a.stopPropagation();const d=i.projectCanvas.getActive(),h=(d==null?void 0:d.viewState.scale)??1,u=(d==null?void 0:d.viewState.offset)??{x:0,y:0},f={x:a.clientX,y:a.clientY},m=Dt(f,h,u),y=d==null?void 0:d.coreState.nodes.find(x=>x.id===e.id),g={x:(y==null?void 0:y.x)??e.x,y:(y==null?void 0:y.y)??e.y,width:(y==null?void 0:y.width)??e.width??100,height:(y==null?void 0:y.height)??e.height??50};if(n){r(),i.setNodeHoldToResize({nodeId:e.id,edge:s,isHolding:!0,isReady:!1,touchX:a.clientX,touchY:a.clientY}),o.current=setTimeout(()=>{var w;(w=navigator.vibrate)==null||w.call(navigator,50),i.setNodeHoldToResize({nodeId:e.id,edge:s,isHolding:!1,isReady:!0,touchX:a.clientX,touchY:a.clientY}),l({id:e.id,handle:s,startNodeRect:g,startPointerPos:m})},im);const x=()=>{r(),document.removeEventListener("pointerup",x),document.removeEventListener("pointercancel",x)};document.addEventListener("pointerup",x),document.addEventListener("pointercancel",x);return}l({id:e.id,handle:s,startNodeRect:g,startPointerPos:m})},[e,s,n,r])},cm=()=>{var n;const e=T.getState(),s=(n=e.uiState)==null?void 0:n.resizingNode;return p.useCallback(o=>{if(!s)return;const{id:r,handle:a,startNodeRect:i,startPointerPos:c}=s,l=e.projectCanvas.getActive(),d=(l==null?void 0:l.viewState.scale)??1,h=(l==null?void 0:l.viewState.offset)??{x:0,y:0},u={x:o.clientX,y:o.clientY},f=Dt(u,d,h),m=f.x-c.x,y=f.y-c.y;let g=i.x,x=i.y,w=i.width,v=i.height;a.includes("left")&&(w=Math.round(Math.max(Co,i.width-m)),g=i.x+i.width-w),a.includes("right")&&(w=Math.round(Math.max(Co,i.width+m))),a.includes("top")&&(v=Math.round(Math.max(Co,i.height-y)),x=i.y+i.height-v),a.includes("bottom")&&(v=Math.round(Math.max(Co,i.height+y))),gr.set(r,{x:g,y:x,width:w,height:v});const N=document.getElementById(`NodeContainerV2-${r}`);if(N){N.style.transform=`translate(${g}px, ${x}px)`,N.style.width=`${w}px`,N.style.height=`${v}px`;const b=N.querySelector('[data-test="draw-node-svg"]');b&&(b.style.width=`${w}px`,b.style.height=`${v}px`)}},[s,e])};function lm(e,s){const n=e.x+(e.width??100),o=e.y+(e.height??50),r=s.x+s.width,a=s.y+s.height;return e.x>=s.x&&e.y>=s.y&&n<=r&&o<=a}const dm=()=>{var r;const e=T.getState(),s=(r=e.uiState)==null?void 0:r.resizingNode,n=e.setResizingNode,o=e.updateNode;return p.useCallback(a=>{var i;if(s){const{id:c,handle:l,startNodeRect:d}=s,h=gr.get(c),u=l.includes("top")||l.includes("bottom"),f=l.includes("left")||l.includes("right"),m=e.projectCanvas.getActive(),y=m==null?void 0:m.coreState.nodes.find(g=>g.id===c);if(h)if(u)o(c,{x:h.x,y:h.y,width:h.width,height:h.height,options:{lockSize:!0}});else if(f){const g=((i=y==null?void 0:y.data)==null?void 0:i.nodeType)==="workflowOrchestration";if(y&&y.content&&!g){const x=It(y.content,h.width,y);o(c,{x:h.x,y:h.y,width:h.width,height:x,options:{lockSize:!0}})}else o(c,{x:h.x,y:h.y,width:h.width,height:h.height})}else o(c,{x:h.x,y:h.y,width:h.width,height:h.height});if(y&&y.type===fe.GROUP&&Q.groups.autoAddNodesOnExpand){const g=y.data,x=new Set((g==null?void 0:g.childNodeIds)??[]),w=(m==null?void 0:m.coreState.nodes)??[],v=h??{x:y.x,y:y.y,width:y.width??100,height:y.height??50},N=w.filter(b=>b.id===c||b.type===fe.GROUP||x.has(b.id)||b.groupId&&b.groupId!==c?!1:lm(b,v));if(N.length>0){const b=N.map(A=>A.id);e.group.addNodesToGroup(c,b)}}if(h&&(h.x!==d.x||h.y!==d.y||h.width!==d.width||h.height!==d.height)){const x={type:"node:resize",nodeId:c,from:d,to:h};T.getState().undo.commit(x)}gr.delete(c),n(null),e.setNodeHoldToResize(null)}},[s,n,o,e])},um=30,oa=(e,s)=>{const n=document.elementsFromPoint(e,s);for(const a of n){const i=a.getAttribute("data-row-connector"),c=a.getAttribute("data-node-id");if(i&&c)return{nodeId:c,rowId:i}}const o=document.querySelectorAll("[data-row-connector]");let r=null;return o.forEach(a=>{const i=a.getBoundingClientRect(),c=i.left+i.width/2,l=i.top+i.height/2,d=Math.sqrt(Math.pow(e-c,2)+Math.pow(s-l,2));if(d<=um){const h=a.getAttribute("data-row-connector")??"",u=a.getAttribute("data-node-id")??"";h&&u&&(!r||d<r.distance)&&(r={nodeId:u,rowId:h,distance:d})}}),r},hm=Q.arrows.reverseArrowOnMultipleConnect,Mt=new zs("useArrowDrawingV2",$s.useArrowDrawingV2),pm=()=>p.useCallback(e=>{const s=T.getState(),n=s.uiState.mode,o=s.uiState.arrowSubMode,r=s.uiState.temporaryArrow,a=s.projectCanvas.getActive(),i=s.arrow.setTemporary,c=s.arrow.add,l=s.getCanvasMouseCoords,d=(a==null?void 0:a.coreState.nodes)??[],h=o===eo.STAY;if(n!==ee.DRAW_ARROW)return;Mt.log("Fired in DRAW_ARROW mode.");const u=l();if(!u){Mt.log("No click point found.");return}const f=T.getState().uiState.activeGroupId,y=Go(u,d,f?[f]:void 0),g=(y==null?void 0:y.id)??null;if(r!=null&&r.startNodeId&&g&&g!==r.startNodeId){Mt.log(`Click-click: Creating arrow from ${r.startNodeId} to ${g}`);const x=gt(g,u,r.startPoint,d,null),w={id:Ve(10),startPoint:r.startPoint,endPoint:x,startNodeId:r.startNodeId,endNodeId:g,label:""};c(w),h?i({startPoint:u,endPoint:u,startNodeId:g}):(i(null),s.setMode(ee.SELECT)),e.stopPropagation();return}if(!g){r?(Mt.log("Clicked on background - cancelling temporary arrow."),i(null)):Mt.log("Clicked on background - ignoring (arrows must start from a node)."),e.stopPropagation();return}Mt.log(`Starting arrow draw from node: ${g}`),i({startPoint:u,endPoint:u,startNodeId:g}),e.stopPropagation()},[]),gm=pm,fm=()=>p.useCallback(e=>{const s=T.getState(),n=s.uiState.mode,o=s.uiState.temporaryArrow,r=s.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.nodes)??[],i=s.arrow.setTemporary,c=s.getCanvasMouseCoords;if(n!==ee.DRAW_ARROW||!o)return;let l=c();if(!l)return;const d=oa(e.clientX,e.clientY);d&&(l=gt(d.nodeId,l,o.startPoint,a,d.rowId)),i({...o,endPoint:l}),e.stopPropagation()},[]),mm=fm,jo=(e,s)=>{const n=T.getState(),o=n.setMode,r=n.arrow.setTemporary,a=n.uiState.mode;return p.useCallback(i=>{if(a!==ee.SELECT)return;Mt.log(`useQuickArrowHandleMouseDownHandler: Fired on node ${e.id}, handle ${s}.`),i.stopPropagation();const c=e.width??100,l=e.height??50;let d;switch(s){case"top":d={x:e.x+c/2,y:e.y};break;case"bottom":d={x:e.x+c/2,y:e.y+l};break;case"left":d={x:e.x,y:e.y+l/2};break;case"right":d={x:e.x+c,y:e.y+l/2};break}Mt.log("Switching to DRAW_ARROW mode."),o(ee.DRAW_ARROW),Mt.log("Setting temporary arrow from node",e.id),r({startPoint:d,endPoint:d,startNodeId:e.id})},[e,s,r,o,a])},xm=()=>p.useCallback(e=>{var k;const s=T.getState(),n=s.uiState.mode,o=s.uiState.arrowSubMode,r=s.uiState.temporaryArrow,a=s.projectCanvas.getActive(),i=s.arrow.setTemporary,c=s.arrow.add,l=s.setMode,d=(a==null?void 0:a.coreState.nodes)??[],h=(a==null?void 0:a.coreState.selectedNodes)??[],u=s.getCanvasMouseCoords,f=o===eo.STAY;if(n!==ee.DRAW_ARROW||!r)return;Mt.log("useArrowPointerUpHandler: Fired.");const m=u();if(!m){Mt.log("No final mouse coords found.");return}const{startPoint:y,startNodeId:g}=r,w=Math.sqrt(Math.pow(m.x-y.x,2)+Math.pow(m.y-y.y,2))>10,v=T.getState().uiState.activeGroupId,N=v?[v]:void 0;let b=null,A=null;const R=oa(e.clientX,e.clientY);if(R)b=R.nodeId,A=R.rowId;else{const S=Go(m,d,N);S&&(((k=S.data)==null?void 0:k.nodeType)==="workflowOrchestration"||(b=S.id))}if(w&&b&&b!==g&&h.length===0){Mt.log(`Drag mode: Creating arrow from ${g} to ${b}`);const S=gt(b,m,y,d,A),E={id:Ve(10),startPoint:y,endPoint:S,startNodeId:g??null,endNodeId:b,endRowId:A,label:""};c(E),f?i(null):(i(null),l(ee.SELECT)),e.stopPropagation();return}if(w&&h.length>0&&b){h.forEach(S=>{if(b&&b!==S.id){const E=gt(b,m,y,d,A),C=hm&&h.length>1,I={id:Ve(10),startPoint:C?E:y,endPoint:C?y:E,startNodeId:C?b:S.id??null,endNodeId:C?S.id??null:b,startRowId:C?A:void 0,endRowId:C?void 0:A,label:""};c(I)}}),i(null),f||l(ee.SELECT),e.stopPropagation();return}if(!w&&b===g){Mt.log("Click on start node - waiting for second click on target node"),e.stopPropagation();return}if(!b){Mt.log("Released on empty space - canceling arrow"),i(null),e.stopPropagation();return}e.stopPropagation()},[]),ym=xm;let Uo=null;const $r=()=>Uo,wd=()=>{const e=p.useRef(null),s=p.useRef([]),n=p.useRef(null),o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),i=p.useRef(!1),c=$(h=>h.uiState.canvasWidth??0),l=$(h=>h.uiState.canvasHeight??0),d=$(h=>h.uiState.mode);return p.useEffect(()=>{const h=e.current;if(!h)return;const u=h.getBoundingClientRect();if(u.width===0||u.height===0)return;const f=window.devicePixelRatio||1;h.width=u.width*f,h.height=u.height*f;const m=h.getContext("2d");m&&m.scale(f,f)},[c,l,d]),p.useEffect(()=>{const h=e.current;if(!h){Uo=null;return}const u=()=>{const g=T.getState().projectCanvas.getActive();return(g==null?void 0:g.viewState)??{offset:{x:0,y:0},scale:1}},f=(g,x)=>{const w=h.getBoundingClientRect();return{x:g-w.left,y:x-w.top}},m=g=>{if(!a.current||s.current.length<2)return;const{scale:x}=u(),w=window.devicePixelRatio||1;g.clearRect(0,0,h.width/w,h.height/w);const v=(a.current.opacity??1)<1;g.beginPath(),g.strokeStyle=a.current.strokeColor,g.lineWidth=a.current.strokeWidth*x,g.globalAlpha=a.current.opacity??1,g.lineCap=v?"butt":"round",g.lineJoin=v?"bevel":"round";const N=s.current;g.moveTo(N[0].x,N[0].y);for(let b=1;b<N.length;b++)g.lineTo(N[b].x,N[b].y);g.stroke(),g.globalAlpha=1},y=g=>{if(!a.current||s.current.length<2)return;const{scale:x}=u(),w=s.current,v=w[w.length-2],N=w[w.length-1];g.beginPath(),g.strokeStyle=a.current.strokeColor,g.lineWidth=a.current.strokeWidth*x,g.globalAlpha=a.current.opacity??1,g.lineCap="round",g.lineJoin="round",g.moveTo(v.x,v.y),g.lineTo(N.x,N.y),g.stroke(),g.globalAlpha=1};return Uo={startStroke:(g,x,w)=>{const v=h==null?void 0:h.getContext("2d");if(!v||!h)return;const N=window.devicePixelRatio||1;v.clearRect(0,0,h.width/N,h.height/N),a.current=w;const b=f(g,x);s.current=[b],n.current=b,o.current=b,r.current=b,i.current=!0},addPoint:(g,x)=>{var E;if(!i.current||!o.current||!r.current)return;const w=h==null?void 0:h.getContext("2d");if(!w)return;let v=f(g,x);const N=(((E=a.current)==null?void 0:E.opacity)??1)<1;if(N){const C=T.getState().getDrawAxisLock();C==="horizontal"?v={x:v.x,y:r.current.y}:C==="vertical"&&(v={x:r.current.x,y:v.y})}const b=Q.drawing.minPointDistance,A=v,R=A.x-o.current.x,k=A.y-o.current.y;Math.sqrt(R*R+k*k)>=b&&(s.current.push({...A}),o.current=A,N?m(w):y(w))},endStroke:()=>{if(!i.current)return null;const g=h==null?void 0:h.getContext("2d");if(g&&h){const N=window.devicePixelRatio||1;g.clearRect(0,0,h.width/N,h.height/N)}const{offset:x,scale:w}=u(),v=s.current.map(N=>({x:(N.x-x.x)/w,y:(N.y-x.y)/w}));return s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1,v.length>1?v:null},clear:()=>{const g=h==null?void 0:h.getContext("2d");if(g&&h){const x=window.devicePixelRatio||1;g.clearRect(0,0,h.width/x,h.height/x)}s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1}},()=>{Uo=null}},[d]),d!==ee.DRAW?null:t.jsx("canvas",{ref:e,"data-test":"temporary-drawing-canvas","data-temporary-drawing-canvas":!0,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",touchAction:"none",zIndex:9999}})};wd.displayName="TemporaryDrawingCanvas";const Rt=new zs("useDrawingV2",$s.useDrawingV2);let Vn=null,tn=null,aa=null,sn=null,ra=[],ia=!1,ca=0;const wm=3;let Ua=null,Li=null,Va=null,Wi=null;const yn=new Map,vd=()=>{ia||(sn=document.querySelector("[data-temporary-drawing-canvas]"),ra=Array.from(document.querySelectorAll(".markdown-textarea")),ra.forEach(e=>{const s=e;yn.has(e)||yn.set(e,s.getAttribute("contenteditable")||""),s.style.setProperty("pointer-events","auto","important"),s.style.setProperty("user-select","text","important"),s.setAttribute("contenteditable","true"),s.setAttribute("inputmode","none")}),ia=!0,ca=0)},vm=()=>{ra.forEach(e=>{const s=e;s.style.removeProperty("pointer-events"),s.style.removeProperty("user-select")}),sn=null,ra=[],ia=!1,ca=0},bm=(e,s)=>{var o;if(ca++,ca%wm!==1)return;ia||vd(),sn&&(sn.style.visibility="hidden");let n=null;if(typeof document.caretRangeFromPoint=="function")n=document.caretRangeFromPoint(e,s);else{const r=(o=document.caretPositionFromPoint)==null?void 0:o.call(document,e,s);r!=null&&r.offsetNode&&(n=document.createRange(),n.setStart(r.offsetNode,r.offset),n.setEnd(r.offsetNode,r.offset))}if(n&&n.startContainer.nodeType===Node.TEXT_NODE){const r=n.startContainer.parentElement;if((r==null?void 0:r.closest("[data-node-id]"))!==null){const i=window.getSelection();if(i)if(Vn){const c=Vn.screenX,l=Vn.screenY,d=fr(c,l);if(!d)return;const h=document.createRange(),u=d.node,f=d.offset,m=n.startContainer,y=n.startOffset,g=u.compareDocumentPosition(m);(u===m?f<=y:!(g&Node.DOCUMENT_POSITION_PRECEDING))?(h.setStart(u,f),h.setEnd(m,y)):(h.setStart(m,y),h.setEnd(u,f)),i.removeAllRanges(),i.addRange(h)}else{Vn={node:n.startContainer,offset:n.startOffset,screenX:e,screenY:s},i.removeAllRanges();const c=document.createRange();c.setStart(n.startContainer,n.startOffset),c.setEnd(n.startContainer,n.startOffset),i.addRange(c)}}}sn&&(sn.style.visibility="")},bd=()=>{Vn=null,tn=null,aa=null,vm(),yn.forEach((e,s)=>{const n=s;e?n.setAttribute("contenteditable",e):n.removeAttribute("contenteditable"),n.removeAttribute("inputmode")}),yn.clear()},fr=(e,s)=>{const n=typeof document.caretRangeFromPoint=="function",o=typeof document.caretPositionFromPoint=="function";if(n){const r=document.caretRangeFromPoint(e,s);if(r&&r.startContainer.nodeType===Node.TEXT_NODE)return{node:r.startContainer,offset:r.startOffset}}else if(o){const r=document.caretPositionFromPoint(e,s);if(r!=null&&r.offsetNode&&r.offsetNode.nodeType===Node.TEXT_NODE)return{node:r.offsetNode,offset:r.offset}}return null},Nm=(e,s,n,o)=>{const r=document.querySelector("[data-temporary-drawing-canvas]"),a=r==null?void 0:r.style.visibility;r&&(r.style.visibility="hidden"),document.querySelectorAll(".markdown-textarea").forEach(d=>{const h=d;yn.has(d)||yn.set(d,h.getAttribute("contenteditable")||""),h.setAttribute("contenteditable","true"),h.setAttribute("inputmode","none")});const c=fr(e,s),l=fr(n,o);if(r&&(r.style.visibility=a||""),c&&l){const d=window.getSelection();if(d){d.removeAllRanges();const h=document.createRange(),u=c.node.compareDocumentPosition(l.node);(c.node===l.node?c.offset<=l.offset:!(u&Node.DOCUMENT_POSITION_PRECEDING))?(h.setStart(c.node,c.offset),h.setEnd(l.node,l.offset)):(h.setStart(l.node,l.offset),h.setEnd(c.node,c.offset)),d.addRange(h)}}},Sm=(e,s)=>{var S,E,C;const n=window.getSelection();if(!n||n.isCollapsed)return;const o=n.toString().trim();if(!o)return;const r=((S=n.anchorNode)==null?void 0:S.nodeType)===Node.TEXT_NODE?n.anchorNode.parentElement:n.anchorNode,a=((E=n.focusNode)==null?void 0:E.nodeType)===Node.TEXT_NODE?n.focusNode.parentElement:n.focusNode,i=(r==null?void 0:r.closest("[data-node-id]"))??(a==null?void 0:a.closest("[data-node-id]"));if(!i)return;const c=i.getAttribute("data-node-id");if(!c)return;const l=T.getState(),d=l.getNodeById(c);if(!d)return;const h=Ws(o,void 0,d),u=Ye.buildTextNodeV2({content:o,width:h.width,height:h.height,linkedSourceNodeId:d.id,options:{lockSize:!1}});let f=d;if(e==="left"&&Li===d.id&&Ua){const I=l.getNodeById(Ua);I&&(f=I)}else if(e==="right"&&Wi===d.id&&Va){const I=l.getNodeById(Va);I&&(f=I)}const m=(C=l.projectCanvas.getActive())==null?void 0:C.viewState,y=(m==null?void 0:m.offset)??{y:0},g=(m==null?void 0:m.scale)??1,x=document.querySelector("[data-canvas-container]"),w=x==null?void 0:x.getBoundingClientRect(),v=(w==null?void 0:w.top)??0,b=(s-v-y.y)/g,A=Q.highlightAndCreate.createConnectingArrow,R=u.height??h.height,k=b-R/2;Aa(u,{...f,y:k},e,{shouldFocus:!1,createArrow:A}),e==="left"?(Ua=u.id,Li=d.id):(Va=u.id,Wi=d.id)};let Ga=null,Ya=0;const Cm=e=>{const{level:s}=Q.drawing.compression;return td(e,s)},jm=e=>{const{level:s}=Q.drawing.compression;return ed(e,s)};let ds=null,la=!1;const km=()=>{const e=T.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getDrawSubMode,r=e.getDrawStyle;return p.useCallback(a=>{if(a.pointerType==="pen"&&a.button===1&&(la=!0),T.getState().uiState.mode!==ee.DRAW||a.button!==0&&a.button!==-1||a.buttons&4||a.pointerType==="pen"&&la)return;a.preventDefault(),Rt.log("Fired in DRAW mode.");const c=$r();if(a.pointerType==="touch"&&ds!==null&&a.pointerId!==ds){Rt.log("Second touch detected, canceling drawing."),c==null||c.clear(),n(null),ds=null;return}const l=s();if(!l){Rt.log("No start point found.");return}const d=o(),h=r();Rt.log(`Starting draw with sub-mode: ${d}, pointerId: ${a.pointerId}`),ds=a.pointerId;const u=ot.createTemporaryDrawing(d,l,h);n(u),d===Pe.FREEHAND&&(Rt.log(`canvasAPI available: ${!!c}`),c?(c.startStroke(a.clientX,a.clientY,h),bd(),tn=a.clientX,aa=a.clientY,(h.opacity??1)<1&&vd()):Rt.log("WARNING: canvasAPI is null in mouseDown!")),a.stopPropagation()},[s,n,o,r])},Im=()=>{const e=T.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getTemporaryDrawing;return p.useCallback(r=>{var c;if(T.getState().uiState.mode!==ee.DRAW)return;const i=o();if(i&&!(ds!==null&&r.pointerId!==ds)){if(i.subMode===Pe.FREEHAND){const l=$r();if(l){const d=((c=r.getCoalescedEvents)==null?void 0:c.call(r))??[r];for(const u of d)l.addPoint(u.clientX,u.clientY);(i.style.opacity??1)<1&&bm(r.clientX,r.clientY)}else Rt.log("WARNING: canvasAPI is null in mouseMove!")}else{const l=s();if(!l)return;const d=ot.updateShapeEndPoint(i,l);n(d)}r.stopPropagation()}},[s,n,o])},Am=e=>e.elements&&e.elements.length>0?e.elements:e.drawType&&e.style?[{type:e.drawType,stroke:e.stroke,shape:e.shape,style:e.style}]:[],Tm=(e,s)=>{const n=Math.min(e.x,s.x),o=Math.min(e.y,s.y),r=Math.max(e.x+(e.width??0),s.x+s.width),a=Math.max(e.y+(e.height??0),s.y+s.height);return{x:n,y:o,width:r-n,height:a-o}},Em=(e,s,n)=>e.map(o=>({x:o.x+s,y:o.y+n})),Rm=()=>{const e=T.getState(),s=e.addNode,n=e.updateNode,o=e.getNodeById,r=e.setTemporaryDrawing,a=e.getTemporaryDrawing,i=e.undo.commit;return p.useCallback(c=>{var C;if(c.pointerType==="pen"&&la&&(c.buttons&4||(la=!1)),T.getState().uiState.mode!==ee.DRAW)return;const d=a();if(!d||ds!==null&&c.pointerId!==ds)return;const h=tn!==null&&c.clientX<tn?"left":"right",u=window.getSelection(),f=(u==null?void 0:u.toString().trim())||"";tn!==null&&aa!==null&&f.length===0&&Nm(tn,aa,c.clientX,c.clientY),Sm(h,c.clientY),(C=window.getSelection())==null||C.removeAllRanges(),bd(),Rt.log("useDrawMouseUpHandler: Fired.");const m=$r(),y=(m==null?void 0:m.endStroke())??null;if(d.subMode===Pe.FREEHAND&&(!y||y.length<2)){Rt.log("Freehand drawing too short, discarding."),E();return}const x={[Pe.RECTANGLE]:"rectangle",[Pe.SQUARE]:"square",[Pe.CIRCLE]:"circle",[Pe.ELLIPSE]:"ellipse",[Pe.LINE]:"line",[Pe.ARROW]:"arrow",[Pe.FREEHAND]:"line"}[d.subMode],w=d.subMode===Pe.FREEHAND?ot.calculateFreehandBounds(y):ot.calculateShapeBounds(d.startPoint,d.endPoint,x),v=d.style.strokeWidth??2,N={x:w.x-v,y:w.y-v,width:w.width+v*2,height:w.height+v*2};if(d.subMode!==Pe.FREEHAND&&!ot.canFinalizeDraw(d)){Rt.log("Shape too small or invalid, discarding."),E();return}const b=Date.now(),A=Q.drawing.strokeGroupingTimeoutMs,R=Ga?o(Ga):void 0;if(b-Ya<A&&R&&R.type===fe.DRAWING&&R){Rt.log("Grouping with existing node:",R.id);const I=R.data,O=Am(I),H=Tm(R,N),L=R.x-H.x,W=R.y-H.y,P=O.map(_=>{if(_.type==="freehand"&&_.stroke){const G=Em(_.stroke.points,L,W),F=wg(_.stroke.smoothedPath,L,W);return{..._,stroke:{points:G,smoothedPath:F}}}return _.type==="shape"&&_.shape?{..._,shape:{..._.shape,startPoint:{x:_.shape.startPoint.x+L,y:_.shape.startPoint.y+W},endPoint:{x:_.shape.endPoint.x+L,y:_.shape.endPoint.y+W}}}:_}),j=Hi(d,N,H,y),M=jm(j),B={elements:[...P,M],intrinsicWidth:H.width,intrinsicHeight:H.height},U={x:R.x,y:R.y,width:R.width,height:R.height,data:I},z={x:H.x,y:H.y,width:H.width,height:H.height,data:B};n(R.id,z),i({type:"node:update",nodeId:R.id,from:U,to:z}),Ya=b,Rt.log("Merged into node:",R.id)}else{const I=Hi(d,N,N,y),O=Cm({elements:[I],intrinsicWidth:N.width,intrinsicHeight:N.height}),H={id:Ve(10),x:N.x,y:N.y,width:N.width,height:N.height,type:fe.DRAWING,data:O,content:""};s(H,void 0,{dontSelect:!0}),Ga=H.id,Ya=b,Rt.log("Created DRAWING node:",H.id)}E();function E(){Rt.log("Resetting temporary drawing state."),r(null),ds=null,c.stopPropagation()}},[s,n,o,r,a,i])};function Hi(e,s,n,o=null){if(s.x-n.x,s.y-n.y,e.subMode===Pe.FREEHAND){const d=(o??e.points).map(u=>({x:u.x-n.x,y:u.y-n.y})),h=ot.smoothToSVGPath(d);return{type:"freehand",stroke:{points:d,smoothedPath:h},style:e.style}}const r=e.startPoint,a=e.endPoint;return{type:"shape",shape:{shapeType:{[Pe.RECTANGLE]:"rectangle",[Pe.SQUARE]:"square",[Pe.CIRCLE]:"circle",[Pe.ELLIPSE]:"ellipse",[Pe.LINE]:"line",[Pe.ARROW]:"arrow",[Pe.FREEHAND]:"line"}[e.subMode],startPoint:{x:r.x-n.x,y:r.y-n.y},endPoint:{x:a.x-n.x,y:a.y-n.y}},style:e.style}}const Fi=(e,s)=>{const n=e.clientX-s.clientX,o=e.clientY-s.clientY;return Math.sqrt(n*n+o*o)},Bi=(e,s)=>({x:(e.clientX+s.clientX)/2,y:(e.clientY+s.clientY)/2}),zi=()=>Q.holdToSelect,Mm=()=>{const e=T.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=e.setIsPanning,r=e.setSelectionBox,a=e.setPendingSelectionStart,i=e.setIsHoldSelectActive,c=e.setHoldSelectProgress,l=Ar(),d=$(L=>L.uiState.isHoldSelectActive??!1),h=p.useRef(null),u=20,f=10,m=L=>Number.isFinite(L)&&Math.abs(L)<1e10,y=(L,W)=>!m(L)||!m(W.x)||!m(W.y)?(R.current=null,k.current=null,S.current=null,h.current=null,null):{scale:L,offset:W},g=p.useRef(null),x=p.useRef(null),w=p.useRef(null),v=p.useRef(null),N=p.useRef(null),b=p.useRef(null),A=p.useRef(null),R=p.useRef(null),k=p.useRef(null),S=p.useRef(null),E=p.useCallback(()=>{x.current&&(clearTimeout(x.current),x.current=null),w.current&&(clearTimeout(w.current),w.current=null),N.current=null,c(null)},[c]),C=p.useCallback((L,W)=>{if(!W)return{x:L.clientX,y:L.clientY};const P=W.getBoundingClientRect();return{x:L.clientX-P.left,y:L.clientY-P.top}},[]),I=p.useCallback(L=>{var M;const W=T.getState().projectCanvas.getActive();if(!W)return;const P=T.getState().uiState.mode,j=L.target;if(b.current=j.closest("[data-canvas-container]"),L.touches.length===1){const B=L.touches[0],U=j.closest("[data-node-id]"),z=j.id.includes("resize-handle-"),_=j.closest("[data-ui-panel]");if(U||z||_){g.current=null,E();return}if(l){const G=zi();E(),v.current={x:B.clientX,y:B.clientY},N.current=Date.now(),w.current=setTimeout(()=>{const F=N.current?Date.now()-N.current:0,V=G.holdDurationMs-F-100;V>0&&c({touchX:B.clientX,touchY:B.clientY,durationMs:V})},G.indicatorDelayMs),x.current=setTimeout(()=>{var D;c(null),i(!0),(D=navigator.vibrate)==null||D.call(navigator,50);const F=C(B,b.current);r({start:F,end:F}),o(!1),g.current=null},G.holdDurationMs),g.current={startX:B.clientX,startY:B.clientY,initialOffsetX:W.viewState.offset.x,initialOffsetY:W.viewState.offset.y},o(!0),h.current=null;return}if(P===ee.DRAW||P===ee.SELECT){g.current=null;return}g.current={startX:B.clientX,startY:B.clientY,initialOffsetX:W.viewState.offset.x,initialOffsetY:W.viewState.offset.y},o(!0),h.current=null}else if(L.touches.length===2){A.current&&(clearTimeout(A.current),A.current=null),r(null),a(null),l&&(E(),i(!1),v.current=null);const B=L.touches[0],U=L.touches[1],z=Fi(B,U),_=Bi(B,U);if(h.current){const G=((M=k.current)==null?void 0:M.scale)??W.viewState.scale;if(!m(G)){h.current=null,R.current=null,k.current=null;return}h.current={...h.current,initialDistance:z,initialScale:G}}else{const G=W.viewState.scale,F=W.viewState.offset;if(!m(G)||!m(F.x)||!m(F.y))return;const D=Dt(_,G,F);h.current={initialDistance:z,initialScale:G,initialOffsetX:F.x,initialOffsetY:F.y,center:_,anchorInCanvas:D,gestureType:"undetermined"},R.current=G}g.current=null,o(!1)}else h.current=null,g.current=null,o(!1),l&&(E(),i(!1),v.current=null)},[s,o,r,a,l,E,C]),O=p.useCallback(L=>{var P,j,M,B;if(s()){if(L.touches.length===1){const U=L.touches[0];if(l&&d){L.preventDefault();const z=C(U,b.current),_=(P=T.getState().uiState)==null?void 0:P.selectionBox;_&&r({start:_.start,end:z});return}if(l&&v.current&&x.current){const z=zi(),_=U.clientX-v.current.x,G=U.clientY-v.current.y;Math.hypot(_,G)>z.movementThresholdPx&&(E(),v.current=null)}if(g.current){L.preventDefault();const z=U.clientX-g.current.startX,_=U.clientY-g.current.startY;n(G=>({...G,offset:{x:g.current.initialOffsetX+z,y:g.current.initialOffsetY+_}}))}}else if(L.touches.length===2&&h.current){L.preventDefault();const U=L.touches[0],z=L.touches[1],_=Fi(U,z),G=Bi(U,z),F=Math.abs(_-h.current.initialDistance);if(h.current.gestureType==="undetermined")if(F>u){h.current.gestureType="zoom",S.current=null;const D=(j=T.getState().projectCanvas.getActive())==null?void 0:j.viewState,V=(D==null?void 0:D.scale)??h.current.initialScale,J=(D==null?void 0:D.offset)??{x:h.current.initialOffsetX,y:h.current.initialOffsetY},ie=Dt(h.current.center,V,J);R.current=V,k.current={scale:V,offset:J},h.current.initialDistance=_,h.current.initialScale=V,h.current.initialOffsetX=J.x,h.current.initialOffsetY=J.y,h.current.anchorInCanvas=ie}else{const D=Math.abs(G.x-h.current.center.x),V=Math.abs(G.y-h.current.center.y);(D>u||V>u)&&(h.current.gestureType="pan",o(!0))}if(h.current.gestureType==="zoom"){if(S.current===null){const te=((M=s())==null?void 0:M.coreState.nodes)??[],X=(B=T.getState().projectCanvas.getActive())==null?void 0:B.viewState;if(te.length>0&&X){const K=te[0],ne=Math.round(K.x*X.scale+X.offset.x),ce=Math.round(K.y*X.scale+X.offset.y);S.current={x:ne,y:ce,scale:X.scale,anchor:{x:Math.round(h.current.anchorInCanvas.x),y:Math.round(h.current.anchorInCanvas.y)},center:{x:Math.round(h.current.center.x),y:Math.round(h.current.center.y)}}}return}if(_<f||h.current.initialDistance<f)return;const D=_/h.current.initialDistance;let V=h.current.initialScale*D;if(!m(D)||!m(V))return;const{min:J,max:ie}=Q.zoom;V=Math.max(J,Math.min(ie,V)),R.current!==null&&(V=R.current+(V-R.current)*.4),R.current=V;const Se=h.current.anchorInCanvas,me=h.current.center,Z=me.x-Se.x*V,ge=me.y-Se.y*V,we=y(V,{x:Z,y:ge});if(!we)return;k.current={scale:we.scale,offset:we.offset},n(te=>({...te,scale:we.scale,offset:we.offset})),S.current={x:0,y:0,scale:V,anchor:{x:Math.round(Se.x),y:Math.round(Se.y)},center:{x:Math.round(me.x),y:Math.round(me.y)}}}else if(h.current.gestureType==="pan"){const D=G.x-h.current.center.x,V=G.y-h.current.center.y,J=h.current.initialOffsetX+D,ie=h.current.initialOffsetY+V;n(Se=>({...Se,offset:{x:J,y:ie}}))}}}},[s,n,o,l,d,E,C,r]),H=p.useCallback(L=>{const W=T.getState().uiState.mode;if(L.touches.length===0)A.current&&(clearTimeout(A.current),A.current=null),h.current=null,g.current=null,R.current=null,k.current=null,S.current=null,o(!1),l&&(E(),v.current=null,d&&i(!1));else if(L.touches.length===1){if(A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{h.current=null,A.current=null},150),l&&(E(),i(!1),v.current=null),!l&&(W===ee.DRAW||W===ee.SELECT)){g.current=null,o(!1);return}if(!g.current){const P=T.getState().projectCanvas.getActive();if(P){const j=L.touches[0];g.current={startX:j.clientX,startY:j.clientY,initialOffsetX:P.viewState.offset.x,initialOffsetY:P.viewState.offset.y},o(!0)}}}else L.touches.length>=2&&(g.current=null,o(!1),l&&(E(),i(!1),v.current=null))},[o,l,d,E]);return{handleTouchStart:I,handleTouchMove:O,handleTouchEnd:H}},Pm=e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,Dm={offset:{x:0,y:0},scale:1,targetView:null},Om=()=>{const e=$(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.viewState)??Dm}),s=T.getState(),n=s.projectCanvas.getActive,o=s.setActiveCanvasViewState,r=p.useRef(null),a=p.useRef({x:0,y:0}),i=p.useRef(1),c=p.useRef(!1);p.useEffect(()=>{const l=e.offset,d=e.scale,h=e.targetView;if(h){if(h.animationStartTime===0){const f=performance.now();o(m=>({...m,targetView:m.targetView?{...m.targetView,animationStartTime:f}:null}));return}c.current||(a.current=l,i.current=d,c.current=!0);const u=f=>{var A;const m=(A=n())==null?void 0:A.viewState,y=m==null?void 0:m.targetView;if(!y){r.current&&(cancelAnimationFrame(r.current),r.current=null);return}const g=f-y.animationStartTime,x=Math.min(g/y.animationDuration,1),w=Pm(x),v=a.current.x+(y.targetOffset.x-a.current.x)*w,N=a.current.y+(y.targetOffset.y-a.current.y)*w,b=i.current+(y.targetScale-i.current)*w;o(R=>({...R,offset:{x:v,y:N},scale:b})),x<1?r.current=requestAnimationFrame(u):(o(R=>({...R,offset:y.targetOffset,scale:y.targetScale,targetView:null})),c.current=!1,r.current=null)};r.current=requestAnimationFrame(u)}return()=>{r.current&&(cancelAnimationFrame(r.current),r.current=null)}},[e,n,o])};class mr{static isInGivenAreaInCanvas(s,n,o){if(n.x===void 0||n.y===void 0)return!1;let r=!0,a=!0;if(o.xRatio!==void 0){const i=s.x+o.xRatio*s.width;r=n.x>=i}if(o.yRatio!==void 0){const i=s.y+o.yRatio*s.height;a=n.y>=i}return r&&a}static createGridForCanvas(s,n=3){const{width:o,height:r}=s,a=[],i=o/n,c=r/n;for(let l=0;l<=n;l++){const d=[];for(let h=0;h<=n;h++)d.push({x:h*i,y:l*c});a.push(d)}return a}static focusElementAndMoveCursorToEnd(s){if(!s)return;s.hasAttribute("tabindex")||s.setAttribute("tabindex","-1"),s.focus();const n=document.createRange(),o=window.getSelection();if(o)try{n.selectNodeContents(s),n.collapse(!1),o.removeAllRanges(),o.addRange(n)}catch(r){console.error("Failed to set cursor position:",r)}}}qe(mr,"getCanvasCenter",(s,n,o)=>{if(!s)return console.warn("Container not available for center calculation."),{x:0,y:0};if(!n)return console.warn("Offset not available for center calculation."),{x:0,y:0};const{clientWidth:r,clientHeight:a}=s,i=r/2,c=a/2,l=(i-n.x)/o,d=(c-n.y)/o;return{x:l,y:d}});const ko=new zs("WriteModeHandlerV2",$s.WriteModeHandlerV2);class Lm{constructor(){qe(this,"s")}onKeyDown(s){const n=T.getState();this.s=n;const o=this.s.uiState,a=s.target.closest("#CanvasAppV2"),i=this.s.projectCanvas.getActive(),c=i==null?void 0:i.viewState,l=(c==null?void 0:c.offset)??{x:0,y:0},d=(c==null?void 0:c.scale)??1;if(!a||!c)return ko.warn("Canvas or active canvas viewState not available."),!0;if(s.key==="Enter"&&s.ctrlKey){const g=this.s.getEditingNode();if(!g)return!0;this.s.unselectNodeById(g.id);const x={x:g.x,y:g.y+(g.height??30)+30},w=Ye.buildTextNode(x,""),v={x:(0-l.x)/d,y:(0-l.y)/d,width:a.clientWidth/d,height:a.clientHeight/d},N=mr.isInGivenAreaInCanvas(v,w,{yRatio:Q.writeMode.scrollYRatio});return this.addNode(w),N&&setTimeout(()=>{n.scrollToNode(w,Q.writeMode.scrollDuration,{verticalOnly:!0})},50),!0}if(o.nodeToFocusId)return!0;const{mode:f}=o;if(f!==ee.WRITE)return!1;const m=s.key,y=s.ctrlKey||s.metaKey;if(m.length===1&&!y&&m!=="Enter"){const g=T.getState(),x=g.uiState.writeModeStartPosition,w=x??mr.getCanvasCenter(a,l,d),v=Ye.buildTextNode(w,"");return this.addNode(v),x&&g.setWriteModeStartPosition(null),ko.log(`WRITE Mode: Key "${m}" pressed. Created node ${v.id} at position (${w.x}, ${w.y}) and requested focus.`),!0}return m==="Escape"?(ko.log("WRITE Mode: Escape pressed. Global handler will switch mode."),!1):(ko.log(`WRITE Mode: Key "${m}" ignored by WriteModeHandler.`),!0)}onKeyUp(s){return!0}addNode(s){s.isEditing=!0,this.s.addNode(s,""),this.s.setNodeToFocusId(s.id)}}class Wm{onMouseDown(s){const n=T.getState(),o=n.uiState,{mode:r,addNodeType:a}=o;if(r!==ee.ADD)return!1;const i=n.getCanvasMouseCoords();if(!i)return!1;let c=!1;if(a===fe.TABLE){const l=Ye.buildTableNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.TEXTCARD){const l=Ye.buildTextCardNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.WORKFLOW_ORCHESTRATION){const l=Ye.buildWorkflowOrchestrationNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.WORKFLOW_SOURCE){const l=Ye.buildWorkflowSourceNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.WORKFLOW_DEFINITION){const l=Ye.buildWorkflowDefinitionNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.OCR){const l=Ye.buildOCRNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.IMAGE){const l=Ye.buildImageNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.WORKFLOW_STEP){const l=Ye.buildWorkflowStepNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===fe.VOCABULARY){const l=Ye.buildVocabularyNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}return c?(n.setMode(ee.SELECT),n.setAddNodeType(null),s.stopPropagation(),!0):!1}}const Hm=()=>{const[e,s]=p.useState(null),n=p.useRef(new Lm),o=p.useRef(new ls),r=p.useRef(new Wm),a=Ig(s),i=Ag(),c=Tg(s),l=Eg(s),d=Rg(),h=Mg(),u=Tf(),f=Ef(),m=Wf(),y=Hf(),g=Ff(),x=am(),w=rm(),v=cm(),N=dm(),b=gm(),A=mm(),R=ym(),k=km(),S=Im(),E=Rm(),{handleTouchStart:C,handleTouchMove:I,handleTouchEnd:O}=Mm(),H=T.getState(),L=H.setMode,W=H.setAddNodeType,P=H.uiState,j=He.useMemo(()=>({pointer:{onPointerDown:M=>{const B=T.getState().uiState.mode;B===ee.DRAW&&M.preventDefault(),!(B===ee.ADD&&r.current.onMouseDown(M))&&(a(M),m(M),b(M),k(M),o.current.onMouseDown(M))},onPointerMove:M=>{i(M),y(M),x(M),v(M),A(M),S(M)},onPointerUp:M=>{c(M),g(M),w(M),N(M),R(M),E(M),h(M)},onPointerLeave:l},wheel:d,touch:{onTouchStart:C,onTouchMove:I,onTouchEnd:O},keyboard:{onKeyDown:M=>{n.current.onKeyDown(M),u(M)},onKeyUp:f}}),[a,m,b,k,i,y,x,v,A,S,c,g,w,N,R,E,l,d,C,I,O,u,f,h,L,W,P.mode,P.addNodeType,r]);return Ng(j),Om(),kg(),null},$i=1280,Fm=({top:e,bottom:s,left:n,right:o,topLeft:r,topRight:a,bottomLeft:i,bottomRight:c,alwaysVisibleBottomLeft:l,footer:d,isContentVisible:h=!0,topMargin:u})=>{const[f,m]=p.useState(()=>typeof window<"u"?window.innerWidth<Ls:!1),[y,g]=p.useState(()=>typeof window<"u"?window.innerWidth<$i:!1);p.useEffect(()=>{const S=()=>{m(window.innerWidth<Ls),g(window.innerWidth<$i)};return window.addEventListener("resize",S),()=>window.removeEventListener("resize",S)},[]);const x=p.useRef(null),[w,v]=p.useState(50);p.useEffect(()=>{if(!x.current)return;const S=new ResizeObserver(E=>{var I;const C=((I=E[0])==null?void 0:I.contentRect.height)??50;v(C)});return S.observe(x.current),()=>S.disconnect()},[]);const N=f?w+8:8,[b,A]=p.useState({top:!1,bottom:!1,left:!1,right:!1,topLeft:!1,topRight:!1,bottomLeft:!1,alwaysVisibleBottomLeft:!1}),R=S=>{A(E=>({...E,[S]:!E[S]}))},k=(S,E,C)=>t.jsx(se,{variant:"ghost",size:"icon",onClick:()=>R(S),className:`h-11 w-11 bg-background/30 backdrop-blur-sm hover:bg-background/50 transition-colors ${C}`,"data-prevent-canvas-click":!0,"data-ui-panel":!0,title:`Toggle ${S}`,"data-test":"mobile-toggle",children:t.jsx(E,{className:"h-5 w-5 opacity-70"})});return t.jsxs("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:We.canvasOverlay},"data-ui-panel":"canvas-overlay","data-test":"canvas-overlay-container",children:[e&&t.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{top:u||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top",children:e}),h&&s&&t.jsxs("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom",children:[t.jsx("div",{className:"hidden md:block","data-test":"canvas-overlay-bottom-desktop",children:s}),t.jsxs("div",{className:"flex flex-col items-center gap-2 md:hidden","data-test":"canvas-overlay-bottom-mobile",children:[b.bottom&&t.jsx("div",{children:s}),k("bottom",fi,"")]})]}),h&&n&&t.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-left",children:f?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[k("left",fi,""),b.left&&t.jsx("div",{children:n})]}):n}),h&&o&&t.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-right",children:f?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[b.right&&t.jsx("div",{children:o}),k("right",go,"")]}):o}),h&&r&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{top:u||"1rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-left",children:f?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[k("topLeft",wa,""),b.topLeft&&t.jsx("div",{children:r})]}):r}),h&&a&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{top:u||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-right",children:f?t.jsxs("div",{className:"flex flex-col items-end gap-1",children:[k("topRight",Zn,""),b.topRight&&t.jsx("div",{children:a})]}):a}),h&&i&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-left",children:f?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[b.bottomLeft&&t.jsx("div",{children:i}),k("bottomLeft",no,"")]}):i}),l&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:h&&i?`${N+60}px`:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-always-visible-bottom-left",children:f?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[b.alwaysVisibleBottomLeft&&t.jsx("div",{children:l}),k("alwaysVisibleBottomLeft",no,"")]}):l}),c&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-right",children:c}),d&&t.jsx("div",{ref:x,className:"absolute left-0 right-0 flex justify-center pointer-events-auto",style:{bottom:f?0:h?ke.chatInput.BOTTOM_VISIBLE:ke.chatInput.BOTTOM_HIDDEN},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-footer",children:d})]})},Bm={offset:{x:0,y:0},scale:1,targetView:null},zm=()=>{var d,h;const e=$(u=>{var f;return((f=u.projectCanvas.getActive())==null?void 0:f.viewState)??Bm}),s=$(u=>u.uiState.selectionBox),n=mn(u=>u.mousePosition)??null,o=e.scale??1,r=e.offset??{x:0,y:0},a=u=>{const f=Math.max(.01,Math.min(4,u));T.getState().setActiveCanvasViewState(m=>({...m,scale:f}))},i=u=>{let f;u==="up"?o<.1?f=Math.round((o+.01)*100)/100:f=Math.round((o+.1)*10)/10:o<=.1?f=Math.round((o-.01)*100)/100:f=Math.round((o-.1)*10)/10,a(f)},c=u=>{u.key==="ArrowUp"?(u.preventDefault(),i("up")):u.key==="ArrowDown"&&(u.preventDefault(),i("down"))},l=()=>{T.getState().setActiveCanvasViewState(u=>({...u,offset:{x:0,y:0},scale:1,targetView:null}))};return t.jsxs("div",{className:"text-xs p-1 bg-background/30 backdrop-blur-sm rounded pointer-events-auto",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("label",{className:"opacity-70",children:"Zoom:"}),t.jsx("input",{type:"number",value:o.toFixed(2),onChange:u=>a(parseFloat(u.target.value)||1),onKeyDown:c,min:"0.01",max:"4.0",step:"any",className:"w-16 px-1 py-0.5 text-xs border-0 rounded bg-background/50","data-test":"canvas-debug-zoom-input"}),t.jsx("button",{onClick:l,className:"px-1.5 py-0.5 text-xs border-0 rounded bg-background/50 hover:bg-background/70 transition-colors",title:"Reset view to 0,0","data-test":"canvas-debug-reset-button",children:"Reset"})]}),t.jsxs("div",{children:["Offset: X: ",((d=r==null?void 0:r.x)==null?void 0:d.toFixed(0))??0,", Y: ",((h=r==null?void 0:r.y)==null?void 0:h.toFixed(0))??0]}),t.jsxs("div",{children:["Mouse:"," ",n?`X: ${n.x.toFixed(0)}, Y: ${n.y.toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["M+O:"," ",n&&r?`X: ${(n.x-r.x).toFixed(0)}, Y: ${(n.y-r.y).toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["SelBox:",s?t.jsxs(t.Fragment,{children:[t.jsx("div",{children:`S:(${s.start.x.toFixed(0)},${s.start.y.toFixed(0)})`}),t.jsx("div",{children:` E:(${s.end.x.toFixed(0)},${s.end.y.toFixed(0)})`})]}):"N/A"]})]})},rt=e=>{const{className:s,mainAction:n,dropdownActions:o=[],dropdownColumns:r,variant:a,size:i,dropdownMenuClassName:c,dropdownTriggerButtonId:l="options-menu-button",dropdownPosition:d="bottom",dropdownHorizontalAlign:h="container-right",persistenceKey:u,isOpen:f,onOpenChange:m,dropdownVerticalOffset:y=0,restoreRepeatAction:g,facade:x,...w}=e,v=r&&r.length>0,N=v?r.flatMap(q=>q.actions):o,[b,A]=p.useState(!1),R=f!==void 0,k=R?f:b,S=q=>{const he=typeof q=="function"?q(k):q;R||A(he),m==null||m(he)},E=p.useRef(null),C=p.useRef(null),[I,O]=p.useState(h),[H,L]=p.useState(d),[W,P]=p.useState(!1),[j,M]=p.useState({top:0,left:0}),B=p.useRef(new Map),[U,z]=p.useState(new Map),_=()=>u?T.getState().getSegmentedButtonAction(u):null,[G,F]=p.useState(_),[D,V]=p.useState(null),J=p.useRef(null),ie=p.useRef(!1);p.useEffect(()=>{var ue,le,ye;if(ie.current||!u)return;const q=T.getState().getSegmentedButtonAction(u),be=(((le=(ue=T.getState().actions)==null?void 0:ue.history)==null?void 0:le.entries)??[]).filter(xe=>xe.source===u);for(const xe of be){const je=N.find(Oe=>Oe.label===xe.label&&Oe.onClick);if(je){T.getState().setSegmentedButtonAction(u,xe.label,()=>je.onClick,{skipHistoryUpdate:!0,skipLabelUpdate:!0});continue}if(x){const Oe=x.getActions();let oe=!1;const ae=Oe.find(Ce=>Ce.label===xe.label);if(ae&&(T.getState().setSegmentedButtonAction(u,xe.label,()=>()=>x.execute(ae.id),{skipHistoryUpdate:!0,actionId:ae.id,skipLabelUpdate:!0}),oe=!0),!oe)for(const Ce of Oe){const Y=(ye=Ce.subActions)==null?void 0:ye.find(re=>re.title===xe.label);if(Y){T.getState().setSegmentedButtonAction(u,xe.label,()=>()=>x.execute(Y.id),{skipHistoryUpdate:!0,actionId:Y.id,skipLabelUpdate:!0}),oe=!0;break}}if(oe)continue}if(g){const Oe=g(xe.label);Oe&&T.getState().setSegmentedButtonAction(u,xe.label,()=>Oe,{skipHistoryUpdate:!0,skipLabelUpdate:!0})}}if(q){const xe=N.find(je=>je.label===q&&je.onClick);if(xe)J.current=xe.onClick,F(q);else if(g){const je=g(q);je&&(V({label:q,execute:je}),F(null),J.current=je,T.getState().setSegmentedButtonAction(u,q,()=>J.current,{skipHistoryUpdate:!0}))}}ie.current=!0},[u,g,N]);const Se=q=>{q.stopPropagation(),S(he=>(he||P(!1),!he))},me=q=>{var ue;if(!x)return;const he=x.getActions(),be=he.find(le=>le.label===q);if(be)return be.id;for(const le of he){const ye=(ue=le.subActions)==null?void 0:ue.find(xe=>xe.title===q);if(ye)return ye.id}},Z=()=>{if(D){if(D.execute(),u){const q=me(D.label);T.getState().setSegmentedButtonAction(u,D.label,()=>J.current,{actionId:q})}return}if(G){const q=N.find(he=>he.label===G);if(q&&!q.disabled&&q.onClick){if(q.onClick(),J.current=q.onClick,u){const he=me(G);T.getState().setSegmentedButtonAction(u,G,()=>J.current,{actionId:he})}}else n.onClick()}else n.onClick()},ge=(q,he)=>{if(q(),F(he),V(null),J.current=q,u){const be=me(he);T.getState().setSegmentedButtonAction(u,he,()=>J.current,{actionId:be})}S(!1)},te={registerRepeatAction:(q,he)=>{if(V({label:q,execute:he}),F(null),J.current=he,u){const be=me(q);T.getState().setSegmentedButtonAction(u,q,()=>J.current,{actionId:be})}S(!1)},closeDropdown:()=>S(!1)};p.useEffect(()=>{if(k&&E.current){const q=E.current.getBoundingClientRect(),he=window.innerWidth,be=window.innerHeight,ue=16,le=224,ye=200;let xe=0,je=0;d==="top"?xe=q.top-ye-8+y:xe=q.bottom+4+y,h==="container-right"?je=q.right-le:(h==="container-edge-right"||h==="middle-right")&&(je=q.right,h==="middle-right"&&(je-=le/2)),je+le>he-ue?(je=he-ue-le,O("container-right")):je<ue?(je=ue,O("container-edge-right")):O(h),xe+ye>be-ue?(xe=q.top-ye-8,L("top")):xe<ue?(xe=q.bottom+4,L("bottom")):L(d),M({top:xe,left:je}),P(!0)}},[k,h,d,y]);const X=p.useRef(!1),K=p.useRef(!1);p.useEffect(()=>{k||(K.current=!1)},[k]),p.useEffect(()=>{const q=be=>{var le,ye;const ue=be.target;X.current||(le=E.current)!=null&&le.contains(ue)||(ye=C.current)!=null&&ye.contains(ue)||ue.closest("[data-radix-popper-content-wrapper]")||ue.closest("[data-radix-select-viewport]")||ue.closest('[role="listbox"]')||ue.closest('[data-test="draggable-popover-wrapper"]')||ue.closest("[data-radix-select-trigger]")||ue.closest('[role="combobox"]')||S(!1)},he=new MutationObserver(be=>{for(const ue of be)if(ue.type==="childList"){const le=Array.from(ue.addedNodes),ye=Array.from(ue.removedNodes);le.some(xe=>xe instanceof HTMLElement&&xe.hasAttribute("data-radix-popper-content-wrapper"))&&(X.current=!0),ye.some(xe=>xe instanceof HTMLElement&&xe.hasAttribute("data-radix-popper-content-wrapper"))&&setTimeout(()=>{X.current=!1},100)}});return k&&(document.addEventListener("pointerdown",q,!0),he.observe(document.body,{childList:!0})),()=>{document.removeEventListener("pointerdown",q,!0),he.disconnect()}},[k]);const ne=N&&N.length>0;let ce=n.text||n.label;if(n.disabled&&n.disabledTooltip)ce=n.disabledTooltip;else if(D)ce=D.label;else if(G){const q=N.find(he=>he.label===G);q&&(ce=q.label)}const de=q=>{const he=q.target;he.closest("[data-radix-select-trigger]")||he.closest('[role="combobox"]')||q.stopPropagation()};return t.jsxs("div",{id:"UiSegmentedButton",ref:E,"data-prevent-canvas-click":!0,className:Ie("ui-segmented-button","relative inline-flex items-stretch",s),...w,children:[t.jsx(es,{delayDuration:300,children:t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"main-action-tooltip-wrapper",children:t.jsxs(se,{variant:a,size:i,onClick:q=>{q.stopPropagation(),Z()},"aria-label":n.label,disabled:n.disabled,className:Ie("ui-segmented-button__main-action",{"rounded-r-none":ne,"border-r-0":ne&&a==="outline","focus:z-10":ne,"!opacity-40":n.disabled}),children:[n.icon,n.text&&t.jsx("span",{children:n.text})]})})}),t.jsx(Vt,{children:t.jsx("p",{children:ce})})]})}),ne&&t.jsxs(t.Fragment,{children:[t.jsx(se,{id:l,variant:a,size:i,onClick:Se,"aria-haspopup":"true","aria-expanded":k,"aria-label":"Toggle dropdown options",disabled:n.disabled||!N.some(q=>!q.disabled),className:Ie("ui-segmented-button__dropdown-trigger","rounded-l-none",i!=="icon"&&"px-1",{"focus:z-10":ne}),children:t.jsx(Pt,{className:"ui-segmented-button__caret-icon w-1.5 h-2.5"})}),k&&Cs.createPortal(t.jsx("div",{ref:C,onPointerDown:de,onPointerUp:de,onClick:de,className:Ie("ui-segmented-button__dropdown-menu","fixed rounded-md shadow-lg",v?"w-auto":"w-56","bg-popover text-popover-foreground border","transition-opacity duration-75",{"opacity-0 pointer-events-none":!W,"opacity-100":W},c),style:{zIndex:We.toolbarDropdown,top:j.top,left:j.left},role:"menu","aria-orientation":"vertical","aria-labelledby":l,"data-test":"segmented-button-dropdown-portal",children:v?t.jsx("div",{className:"grid gap-2 p-2",style:{gridTemplateColumns:r.some(q=>q.width)?r.map(q=>q.width||"1fr").join(" "):`repeat(${r.length}, 1fr)`},role:"none","data-test":"segmented-button-multi-column",children:r.map((q,he)=>{const be=q.maxHeight??(q.matchHeightToColumn!==void 0?U.get(q.matchHeightToColumn):void 0),ue=be!==void 0;return t.jsxs("div",{className:"flex flex-col gap-1","data-test":"segmented-button-column",children:[q.header&&t.jsx("span",{className:"text-xs font-medium text-muted-foreground px-1",children:q.header}),t.jsx("div",{className:Ie("flex flex-col gap-1",ue&&"overflow-y-auto"),style:be?{maxHeight:typeof be=="number"?`${be}px`:be}:void 0,ref:le=>{if(le){if(q.matchHeightToColumn===void 0&&!q.maxHeight){const ye=le.scrollHeight;B.current.get(he)!==ye&&(B.current.set(he,ye),z(new Map(B.current)))}ue&&!K.current&&(K.current=!0,setTimeout(()=>{const ye=le.querySelector('[data-selected="true"]');if(ye){const je=Array.from(le.querySelectorAll('[data-test="segmented-button-action"]')).indexOf(ye),Oe=28,ae=Oe+4,Ce=le.clientHeight,re=je*ae-Ce/2+Oe/2,ve=le.scrollHeight-Ce;le.scrollTop=Math.max(0,Math.min(re,ve))}},0))}},children:q.actions.map((le,ye)=>le.customRender?t.jsx("div",{children:le.customRender(te)},ye):t.jsxs(se,{variant:le.selected?"secondary":"ghost",size:"sm",onClick:()=>ge(le.onClick,le.label),disabled:le.disabled,className:Ie("h-7 px-2 justify-start",le.selected&&"font-medium"),role:"menuitem",title:le.label,"data-test":"segmented-button-action","data-selected":le.selected,children:[le.icon&&t.jsx("span",{className:"mr-1",children:le.icon}),t.jsx("span",{className:"text-xs",children:le.label})]},ye))})]},he)})}):t.jsx("div",{className:"py-1",role:"none",children:o.map((q,he)=>q.customRender?t.jsx("div",{children:q.customRender(te)},he):t.jsxs(se,{variant:"ghost",size:"sm",onClick:()=>ge(q.onClick,q.label),disabled:q.disabled,className:Ie("ui-segmented-button__dropdown-item","w-full justify-start text-left font-normal"),role:"menuitem",children:[q.icon&&t.jsx("span",{className:"mr-2",children:q.icon})," ",q.label,q.selected&&t.jsx(vn,{className:"ml-auto h-4 w-4"})]},he))})}),document.body)]})]})},$m={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8},_m=e=>{const{className:s,variant:n}=e,o=T.getState(),r=o.setMode,a=o.setAddNodeType,i=o.setSelectionBox,c=$(k=>k.uiState.customNodeDropdownOpen??!1),l=k=>{T.getState().setCustomNodeDropdownOpen(k)},d=()=>{r(ee.ADD),a(fe.TABLE),i(null)},h=()=>{r(ee.ADD),a(fe.TEXTCARD),i(null)},u=()=>{r(ee.ADD),a(fe.WORKFLOW_ORCHESTRATION),i(null)},f=()=>{r(ee.ADD),a(fe.WORKFLOW_SOURCE),i(null)},m=()=>{r(ee.ADD),a(fe.WORKFLOW_DEFINITION),i(null)},y=()=>{r(ee.ADD),a(fe.OCR),i(null)},g=()=>{r(ee.ADD),a(fe.IMAGE),i(null)},x=()=>{r(ee.ADD),a(fe.WORKFLOW_STEP),i(null)},w=()=>{r(ee.ADD),a(fe.VOCABULARY),i(null)},v=[{label:"1: Table",icon:t.jsx(Eh,{className:"h-2.5 w-2.5"}),onClick:d},{label:"2: Text Card",icon:t.jsx(Rh,{className:"h-2.5 w-2.5"}),onClick:h},{label:"3: Image",icon:t.jsx(Mh,{className:"h-2.5 w-2.5"}),onClick:g},{label:"4: OCR",icon:t.jsx(Fo,{className:"h-2.5 w-2.5"}),onClick:y},{label:"5: Vocabulary",icon:t.jsx(va,{className:"h-2.5 w-2.5"}),onClick:w},{label:"6: Workflow",icon:t.jsx(Hs,{className:"h-2.5 w-2.5"}),onClick:u},{label:"7: Source",icon:t.jsx(jl,{className:"h-2.5 w-2.5"}),onClick:f},{label:"8: WF Runner",icon:t.jsx(ft,{className:"h-2.5 w-2.5"}),onClick:m},{label:"9: WF Step",icon:t.jsx(Ph,{className:"h-2.5 w-2.5"}),onClick:x}],[N,b]=p.useState(v[0]),A=k=>{b(k),k.onClick(),l(!1)},R=()=>{N.onClick()};return p.useEffect(()=>{if(!c)return;const k=S=>{const E=$m[S.key];E!==void 0&&E<v.length?(S.preventDefault(),A(v[E])):S.key==="Escape"&&l(!1)};return window.addEventListener("keydown",k),()=>window.removeEventListener("keydown",k)},[c,v]),t.jsx("div",{id:"ToolbarAddCustomNode",className:Me("",s),"data-test":"toolbar-add-custom-node-button",children:t.jsx(rt,{size:"sm",variant:n??"default",mainAction:{icon:N.icon,onClick:R,text:"(n)",label:`Add ${N.label}`},dropdownActions:v.map(k=>({...k,onClick:()=>A(k)})),dropdownPosition:"top",dropdownHorizontalAlign:"middle-right",dropdownVerticalOffset:-30,isOpen:c,onOpenChange:l})})},Um=()=>{const e=$(u=>u.uiState.mode),s=$(u=>u.uiState.addNodeType),n=$(u=>u.uiState.writeSubMode),o=e===ee.ADD&&s===fe.TEXT,r=e===ee.WRITE,a=r&&n===un.AUDIO,i=()=>{const u=T.getState();r?u.toggleWriteSubMode():o?(u.setMode(ee.WRITE),u.setWriteSubMode(un.WRITE)):(u.setMode(ee.ADD),u.setAddNodeType(fe.TEXT))},c=o||r,l=()=>a?t.jsx(Dh,{className:"h-4 w-4"}):r?t.jsx(Oh,{className:"h-4 w-4"}):t.jsx(Zt,{className:"h-4 w-4"}),d=()=>a?"Audio Mode (click to toggle)":r?"Write Mode (click for audio)":o?"Text Mode (click for write, or w/a)":"Text (t)",h=()=>a?"(a)":r?"(w)":"(T)";return t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-text-mode-wrapper",children:[t.jsxs(se,{variant:c?"default":"secondary",size:"sm",className:Me(a&&"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 text-white"),onClick:i,title:d(),"data-test":"canvas-toolbar-text-mode-button",children:[l(),t.jsx("span",{className:"hidden md:inline ml-1",children:h()})]}),t.jsx(es,{children:t.jsxs(_t,{delayDuration:200,children:[t.jsx(Ut,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-text-mode-info-icon",children:t.jsx(Zn,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Vt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-text-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-text-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Text Mode (t):"})," Click to add text nodes"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Write Mode (t→w):"})," Create nodes with Ctrl+Enter"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Audio Mode (t→a):"})," Auto-starts voice recording"]}),t.jsx("p",{className:"text-muted-foreground",children:"Click button to cycle through modes"})]})})]})})]})};class Vm{constructor(){qe(this,"currentNodeId",null);qe(this,"nodes",[]);qe(this,"yBandThreshold",100)}setNodes(s){this.nodes=s}setCurrentNode(s){this.currentNodeId=s}getCurrentNodeId(){return this.currentNodeId}getCurrentNode(){return this.currentNodeId?this.nodes.find(s=>s.id===this.currentNodeId)??null:null}getSortedNodes(){return[...this.nodes].sort((s,n)=>s.x!==n.x?s.x-n.x:s.y-n.y)}getCurrentIndex(){return this.getSortedNodes().findIndex(n=>n.id===this.currentNodeId)}getNodesInSameRow(s){return this.nodes.filter(n=>Math.abs(n.y-s.y)<=this.yBandThreshold)}moveLeft(){const s=this.getCurrentIndex();return s<=0?null:this.getSortedNodes()[s-1]??null}moveRight(){const s=this.getCurrentIndex(),n=this.getSortedNodes();return s<0||s>=n.length-1?null:n[s+1]??null}moveUp(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y<s.y-this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?r.y-o.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveDown(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y>s.y+this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?o.y-r.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveToLineStart(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>o.x-r.x),n[0]??null)}moveToLineEnd(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>r.x-o.x),n[0]??null)}moveToDocumentStart(){return this.getSortedNodes()[0]??null}moveToDocumentEnd(){const s=this.getSortedNodes();return s[s.length-1]??null}moveNext(){return this.moveRight()}movePrev(){return this.moveLeft()}}const it=new Vm;function Gm(e){const s=T.getState();s.setSelectedNodes([e]),it.setCurrentNode(e.id),s.scrollToNode(e.id,300)}function zt(e,s){const n=e();return n?(Gm(n),!0):!1}let Vo=null;function _i(e){Vo=e}function Ui(){return T.getState().setMode(ee.SELECT),Vo==null||Vo.popIdIf(Kt.canvasVim),!0}function Ym(e){const s=T.getState(),n=s.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.selectedNodes)??[];return o.length>0&&s.setNodeToFocusId(o[0].id),e==null||e.executeCommand(ht.enterInsertMode,""),!0}function Xm(e){return T.getState().setNodeToFocusId(null),e==null||e.executeCommand(ht.enterNormalMode,""),!0}const Km=[{key:"i",command:ht.enterInsertMode,desc:"Enter insert mode - edit selected node",execute:(e,s,n)=>Ym(n),preventUndoRedo:!0},{key:"h",command:ht.cursorLeft,desc:"Move to previous node (left in spatial order)",execute:()=>zt(()=>it.moveLeft()),preventUndoRedo:!0},{key:"l",command:ht.cursorRight,desc:"Move to next node (right in spatial order)",execute:()=>zt(()=>it.moveRight()),preventUndoRedo:!0},{key:"k",command:ht.cursorUp,desc:"Move to node above",execute:()=>zt(()=>it.moveUp()),preventUndoRedo:!0},{key:"j",command:ht.cursorDown,desc:"Move to node below",execute:()=>zt(()=>it.moveDown()),preventUndoRedo:!0},{key:"0",command:ht.cursorLineStart,desc:"Move to first node in row",execute:()=>zt(()=>it.moveToLineStart()),preventUndoRedo:!0},{key:"$",command:ht.cursorLineEnd,desc:"Move to last node in row",execute:()=>zt(()=>it.moveToLineEnd()),preventUndoRedo:!0},{key:"<Shift>$",command:ht.cursorLineEnd,desc:"Move to last node in row",execute:()=>zt(()=>it.moveToLineEnd()),preventUndoRedo:!0},{key:"gg",command:ht.goToFirstLine,desc:"Move to first node",execute:()=>zt(()=>it.moveToDocumentStart()),preventUndoRedo:!0},{key:"<Shift>G",command:ht.goToLastLine,desc:"Move to last node",execute:()=>zt(()=>it.moveToDocumentEnd()),preventUndoRedo:!0},{key:"G",command:ht.goToLastLine,desc:"Move to last node",execute:()=>zt(()=>it.moveToDocumentEnd()),preventUndoRedo:!0},{key:"w",command:ht.cursorWordForwardStart,desc:"Move to next node",execute:()=>zt(()=>it.moveNext()),preventUndoRedo:!0},{key:"b",command:ht.cursorBackwordsStartWord,desc:"Move to previous node",execute:()=>zt(()=>it.movePrev()),preventUndoRedo:!0},{key:"q",command:ht.enterNormalMode,desc:"Exit vim mode",execute:()=>Ui(),preventUndoRedo:!0},{key:"<Escape>",command:ht.enterNormalMode,desc:"Exit vim mode",execute:()=>Ui(),preventUndoRedo:!0}],qm=[{key:"<Escape>",command:ht.enterNormalMode,desc:"Exit insert mode - return to normal mode",execute:(e,s,n)=>Xm(n),preventUndoRedo:!0}];function Zm(){return{[zn.NORMAL]:Km,[zn.INSERT]:qm,[zn.VISUAL]:[],[zn.ALL]:[]}}function Js(e){var c,l;const s=((c=e.state)==null?void 0:c.activeProjectId)??null,n=s?((l=e.state)==null?void 0:l.projects[s])??null:null,o=(n==null?void 0:n.activeWorkspaceId)??null,r=o?(n==null?void 0:n.workspaces[o])??null:null,a=(r==null?void 0:r.activeCanvasId)??null,i=a?(r==null?void 0:r.canvases[a])??null:null;return{project:n,workspace:r,canvas:i,path:{projectId:s,workspaceId:o,canvasId:a}}}const Vi=[],Gi=[],Ge={selectMode:e=>e.uiState.mode,selectIsSelectMode:e=>e.uiState.mode===ee.SELECT,selectIsMoveMode:e=>e.uiState.mode===ee.MOVE,selectIsDrawArrowMode:e=>e.uiState.mode===ee.DRAW_ARROW,selectIsAddTextMode:e=>e.uiState.mode===ee.ADD,selectIsAddTableMode:e=>e.uiState.mode===ee.ADD,selectIsWriteMode:e=>e.uiState.mode===ee.WRITE,selectActiveCanvas:e=>{const{canvas:s}=Js(e);return s},selectActiveCanvasId:e=>{const{path:s}=Js(e);return s.canvasId},selectActiveProjectId:e=>{var s;return((s=e.state)==null?void 0:s.activeProjectId)??null},selectActiveWorkspaceId:e=>{const{path:s}=Js(e);return s.workspaceId},selectAllNodes:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.coreState.nodes)??Vi},selectNode:e=>s=>Ge.selectAllNodes(s).find(o=>o.id===e)??null,selectSelectedNodes:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedNodes)??Vi},selectIsNodeSelected:e=>s=>Ge.selectSelectedNodes(s).some(o=>o.id===e),selectAllArrows:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.coreState.arrows)??Gi},selectArrow:e=>s=>Ge.selectAllArrows(s).find(o=>o.id===e)??null,selectSelectedArrows:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedArrows)??Gi},selectIsArrowSelected:e=>s=>Ge.selectSelectedArrows(s).some(o=>o.id===e),selectArrowsConnectedToNode:e=>s=>Ge.selectAllArrows(s).filter(o=>o.startNodeId===e||o.endNodeId===e),selectCanvasOffset:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.viewState.offset)??{x:0,y:0}},selectCanvasScale:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.viewState.scale)??1},selectCanvasDimensions:e=>({width:e.uiState.canvasWidth??0,height:e.uiState.canvasHeight??0}),selectViewState:e=>{const s=Ge.selectActiveCanvas(e);return(s==null?void 0:s.viewState)??null},selectTemporaryArrow:e=>e.uiState.temporaryArrow,selectSelectionBox:e=>e.uiState.selectionBox,selectDragInfo:e=>e.uiState.dragInfo,selectResizingNode:e=>e.uiState.resizingNode,selectAddNodeType:e=>e.uiState.addNodeType,selectIsDragging:e=>e.uiState.dragInfo!==null,selectIsResizing:e=>e.uiState.resizingNode!==null,selectIsSelectionBoxActive:e=>e.uiState.selectionBox!==null,selectIsDrawingArrow:e=>e.uiState.temporaryArrow!==null,selectHasSelectedNodes:e=>Ge.selectSelectedNodes(e).length>0,selectHasSelectedArrows:e=>Ge.selectSelectedArrows(e).length>0,selectNodeCount:e=>Ge.selectAllNodes(e).length,selectArrowCount:e=>Ge.selectAllArrows(e).length,selectSelectedNodeCount:e=>Ge.selectSelectedNodes(e).length,selectSelectedArrowCount:e=>Ge.selectSelectedArrows(e).length,selectHasContent:e=>{const s=Ge.selectNodeCount(e),n=Ge.selectArrowCount(e);return s>0||n>0},selectIsCanvasEmpty:e=>!Ge.selectHasContent(e),selectCanvasStats:e=>({nodeCount:Ge.selectNodeCount(e),arrowCount:Ge.selectArrowCount(e),selectedNodeCount:Ge.selectSelectedNodeCount(e),selectedArrowCount:Ge.selectSelectedArrowCount(e),hasContent:Ge.selectHasContent(e)}),selectAllProjects:e=>{var s;return((s=e.state)==null?void 0:s.projects)??{}},selectActiveProject:e=>{const{project:s}=Js(e);return s},selectActiveWorkspace:e=>{const{workspace:s}=Js(e);return s}};let Yi=!1;function Jm(){const e=window.__vimContainer;if(e)return e;const s=Yp.createContainer();return Gp.register(s),Ch.register(s),jh.register(s),kh.register(s),Ih.register(s),Ah.register(s),window.__vimContainer=s,s}function Qm(e){if(Yi)return;const s=e.get(Th),n=Zm();s.registerCommands(Kt.canvasVim,n),Yi=!0}function Xi(e){if(e.getInstanceMap(Kt.canvasVim))return;const n={id:Kt.canvasVim,mode:zn.NORMAL,cursor:{line:0,col:0},lines:[]};e.registerAndInit({vimId:Kt.canvasVim,vimState:n})}function ex(){const[e,s]=p.useState(!1),n=p.useRef(null),o=p.useRef(null),r=$(Ge.selectAllNodes),a=$(Ge.selectSelectedNodes),i=$(d=>d.uiState.mode);p.useEffect(()=>{const d=Jm();return n.current=d.get(Cl),Qm(d),_i(n.current),()=>{_i(null)}},[]),p.useEffect(()=>{it.setNodes(r)},[r]),p.useEffect(()=>{var h;const d=((h=a[0])==null?void 0:h.id)??null;it.setCurrentNode(d)},[a]),p.useEffect(()=>{const d=n.current;if(!d)return;const h=i===ee.VIM;if(h&&!e){Xi(d),d.setActiveId(Kt.canvasVim);const u=T.getState();u.setNodeToFocusId(null);const f=u.getEditingNode();f&&u.updateNode(f.id,{isEditing:!1});const m=d.getVimCore(Kt.canvasVim);if(m&&m.executeCommand(ht.enterNormalMode,""),a.length===0&&r.length>0){const y=o.current,g=y?r.find(x=>x.id===y):null;if(g)T.getState().setSelectedNodes([g]),it.setCurrentNode(g.id),T.getState().scrollToNode(g.id,Q.writeMode.scrollDuration);else{const x=it.moveToDocumentStart();x&&(T.getState().setSelectedNodes([x]),it.setCurrentNode(x.id))}}s(!0)}else!h&&e&&(a.length>0&&(o.current=a[0].id),d.popIdIf(Kt.canvasVim),s(!1))},[i,e,r,a]);const c=p.useCallback(d=>{const h=n.current;if(h){if(d){if(Xi(h),h.setActiveId(Kt.canvasVim),a.length===0&&r.length>0){const u=it.moveToDocumentStart();u&&(T.getState().setSelectedNodes([u]),it.setCurrentNode(u.id))}}else h.popIdIf(Kt.canvasVim);s(d)}},[r,a]),l=p.useCallback(()=>{c(!e)},[e,c]);return{vimEnabled:e,setVimEnabled:c,toggleVimMode:l}}const da=({onSelect:e})=>{const s=$(c=>{var l;return(l=c.undo.getCurrent())==null?void 0:l.id}),{undoPath:n,redoPath:o}=p.useMemo(()=>{const c=T.getState();return{undoPath:c.undo.getPath(),redoPath:c.undo.getRedoPath()}},[s]),r=p.useMemo(()=>{const c=[...o].reverse(),l=[...n].reverse();return[...c,...l]},[n,o]);if(r.length===0)return t.jsx("div",{className:"p-3 text-sm text-muted-foreground","data-test":"unified-history-empty",children:"No history available"});const a=c=>new Date(c).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=o.length;return t.jsx("div",{className:"flex flex-col h-full overflow-y-auto","data-test":"unified-history-list",children:r.map((c,l)=>{const d=l<i,h=c.id===s;return t.jsxs("button",{type:"button",onClick:()=>e(c.id),className:Me("flex items-center gap-2 px-3 py-2 text-left transition-colors border-b border-border last:border-b-0",h&&"bg-accent/50",d&&"opacity-50",!d&&"hover:bg-accent",d&&"hover:bg-accent/30"),"data-test":"unified-history-item","data-redo":d,"data-current":h,children:[t.jsx("span",{className:"text-xs text-muted-foreground w-16 shrink-0",children:a(c.timestamp)}),t.jsx("span",{className:"text-sm truncate flex-1",children:c.label??Mu(c.operation)}),h&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"●"})]},c.id)})})},ua=({size:e="icon"})=>{const s=()=>{window.confirm("Clear all undo/redo history? This cannot be undone.")&&T.getState().undo.clear()};return t.jsx(se,{variant:"ghost",size:e,onClick:s,title:"Clear history",className:"h-6 w-6 p-0","data-test":"clear-history-button",children:t.jsx(Nt,{className:"h-3.5 w-3.5 text-muted-foreground hover:text-destructive"})})},ha=({size:e="icon"})=>{const s=()=>{const n=T.getState().undo.getPath();n.length>0&&T.getState().undo.jumpTo(n[0].id)};return t.jsx(se,{variant:"ghost",size:e,onClick:s,title:"Jump to start",className:"h-6 w-6 p-0","data-test":"jump-to-start-button",children:t.jsx(Lh,{className:"h-3.5 w-3.5 text-muted-foreground"})})},pa=({size:e="icon"})=>{const s=()=>{const n=T.getState().undo.getRedoPath();n.length>0&&T.getState().undo.jumpTo(n[n.length-1].id)};return t.jsx(se,{variant:"ghost",size:e,onClick:s,title:"Jump to end",className:"h-6 w-6 p-0","data-test":"jump-to-end-button",children:t.jsx(Wh,{className:"h-3.5 w-3.5 text-muted-foreground"})})},tx=e=>{const{className:s,style:n}=e;ps();const o=$(v=>v.uiState.mode),r=$(v=>v.uiState.addNodeType),a=$(v=>v.uiState.zoomSubMode),i=$(v=>v.uiState.arrowSubMode),c=$(v=>v.uiState.messageSubMode),l=$(v=>v.undo.canUndo()),d=$(v=>v.undo.canRedo()),{setVimEnabled:h}=ex(),u=T.getState(),f=u.setMode,m=u.setZoomSubMode,y=u.saveCanvasData,g=()=>{T.getState().undo.undo()},x=()=>{T.getState().undo.redo()},w=v=>{o===ee.VIM&&v!==ee.VIM&&h(!1),v===ee.VIM&&h(!0),f(v)};return t.jsxs("div",{className:Me("p-2 bg-background border shadow pointer-events-auto rounded flex items-center","max-md:flex-wrap max-md:gap-2 max-md:w-full max-md:max-w-lg md:space-x-2",s),style:{...n},onMouseDown:v=>v.stopPropagation(),"data-ui-panel":"canvas-toolbar",children:[t.jsxs(se,{variant:o===ee.SELECT?"default":"secondary",size:"sm",onClick:()=>w(ee.SELECT),title:"Select (v)","data-test":"canvas-toolbar-select-mode-button",children:[t.jsx(kl,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(v)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-move-mode-wrapper",children:[t.jsxs(se,{variant:o===ee.MOVE||o===ee.ZOOM?"default":"secondary",size:"sm",className:Me(o===ee.ZOOM&&a==="zoom:lock"&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{o===ee.MOVE?(w(ee.ZOOM),m("zoom")):o===ee.ZOOM?(document.pointerLockElement&&document.exitPointerLock(),w(ee.MOVE)):w(ee.MOVE)},title:o===ee.ZOOM&&a==="zoom:lock"?"Zoom:Lock Mode (click or Esc to exit)":o===ee.ZOOM?"Zoom Mode (h to toggle Pan)":"Pan Mode (h to toggle Zoom)","data-test":"canvas-toolbar-move-mode-button",children:[o===ee.ZOOM?t.jsx(Hh,{className:"h-4 w-4"}):t.jsx(Fh,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(h)"})]}),t.jsx(es,{children:t.jsxs(_t,{delayDuration:200,children:[t.jsx(Ut,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-move-mode-info-icon",children:t.jsx(Zn,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Vt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-move-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-move-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Pan Mode (h):"})," Drag to pan the canvas"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom Mode (h again):"})," Scroll or drag to zoom"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom:Lock:"})," Double-click canvas to lock zoom, move mouse to zoom"]}),t.jsx("p",{className:"text-muted-foreground",children:"Press 'h' to toggle between Pan and Zoom"})]})})]})})]}),t.jsxs(se,{variant:o===ee.GRID?"default":"secondary",size:"sm",onClick:()=>w(ee.GRID),title:"Grid Mode (g)","data-test":"canvas-toolbar-grid-mode-button",children:[t.jsx(Bh,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(g)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-vim-mode-wrapper",children:[t.jsxs(se,{variant:o===ee.VIM?"default":"secondary",size:"sm",onClick:()=>w(ee.VIM),title:"Vim Navigation Mode (i)","data-test":"canvas-toolbar-vim-mode-button",children:[t.jsx("span",{className:"text-sm font-bold","data-test":"vim-mode-icon",children:"V"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(i)"})]}),t.jsx(es,{children:t.jsxs(_t,{delayDuration:200,children:[t.jsx(Ut,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-vim-mode-info-icon",children:t.jsx(Zn,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Vt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-vim-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-vim-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Vim Mode:"})," Navigate nodes with vim keybindings"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"h/l:"})," Previous/next node (X-first order)"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"j/k:"})," Node below/above"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"0/$:"})," First/last node in row"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"gg/G:"})," First/last node"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"w/b:"})," Next/previous node"]})]})})]})})]}),t.jsxs(se,{variant:o===ee.DRAW_ARROW?"default":"secondary",size:"sm",className:Me(o===ee.DRAW_ARROW&&i===eo.STAY&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>w(ee.DRAW_ARROW),title:o===ee.DRAW_ARROW&&i===eo.STAY?"Draw Arrow: Stay Mode (a to toggle, Esc to exit)":"Draw Arrow (a)","data-test":"canvas-toolbar-draw-arrow-button",children:[t.jsx(ts,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(a)"})]}),t.jsxs(se,{variant:o===ee.DRAW?"default":"secondary",size:"sm",onClick:()=>w(ee.DRAW),title:"Draw Mode (d) - Freehand, Rectangle, Circle, Line","data-test":"canvas-toolbar-draw-mode-button",children:[t.jsx(Fs,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(d)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-message-mode-wrapper",children:[t.jsxs(se,{variant:o===ee.MESSAGE?"default":"secondary",size:"sm",className:Me(o===ee.MESSAGE&&c===nn.AUTOFOCUS&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{o===ee.MESSAGE?T.getState().toggleMessageSubMode():(w(ee.MESSAGE),T.getState().setMessageSubMode(nn.DEFAULT))},title:o===ee.MESSAGE&&c===nn.AUTOFOCUS?"Message:Autofocus Mode (m) - Auto-focus chat on window focus":"Message Mode (m) - Add chat node","data-test":"canvas-toolbar-message-mode-button",children:[t.jsx(Mr,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(m)"})]}),t.jsx(es,{children:t.jsxs(_t,{delayDuration:200,children:[t.jsx(Ut,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-message-mode-info-icon",children:t.jsx(Zn,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Vt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-message-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-message-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Message Mode (m):"})," Chat input ready for messaging"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Message:Autofocus (m again):"})," Auto-focus chat input when window is refocused"]}),t.jsx("p",{className:"text-muted-foreground",children:"Press 'm' to toggle between modes"})]})})]})})]}),t.jsx(Um,{}),t.jsx(_m,{variant:o===ee.ADD&&(r===fe.TABLE||r===fe.TEXTCARD||r===fe.OCR||r===fe.VOCABULARY||r===fe.WORKFLOW_ORCHESTRATION||r===fe.WORKFLOW_SOURCE||r===fe.WORKFLOW_DEFINITION)?"default":"secondary"}),t.jsx(po,{expandContent:t.jsx(da,{onSelect:v=>T.getState().undo.jumpTo(v)}),expandTitle:"History",onClick:g,onHoldRepeat:g,holdRepeatInterval:Q.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!l,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"canvas-toolbar-undo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(ha,{}),t.jsx(pa,{}),t.jsx(ua,{})]}),children:t.jsx(ba,{className:"h-4 w-4"})}),t.jsx(po,{expandContent:t.jsx(da,{onSelect:v=>T.getState().undo.jumpTo(v)}),expandTitle:"History",onClick:x,onHoldRepeat:x,holdRepeatInterval:Q.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!d,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"canvas-toolbar-redo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(ha,{}),t.jsx(pa,{}),t.jsx(ua,{})]}),children:t.jsx(Il,{className:"h-4 w-4"})}),t.jsx(se,{variant:"secondary",size:"sm",onClick:y,title:"Save to Local Storage and API","data-test":"canvas-toolbar-save-button",children:t.jsx(hs,{className:"h-4 w-4"})})]})},sx=({startX:e,startY:s,endX:n,endY:o})=>{const r=Math.min(e,n),a=Math.min(s,o),i=Math.abs(e-n),c=Math.abs(s-o);return i===0||c===0?null:t.jsx("div",{className:"absolute border border-ring bg-ring/20 pointer-events-none",style:{left:`${r}px`,top:`${a}px`,width:`${i}px`,height:`${c}px`,zIndex:20}})},nx=He.memo(sx),ox=()=>{const e=$(s=>s.uiState.selectionBox);return e?t.jsx(nx,{startX:e.start.x,startY:e.start.y,endX:e.end.x,endY:e.end.y}):null},ax=({node:e})=>t.jsxs("div",{className:Me("bg-background border border-foreground p-2",e.className),style:{width:e.width?`${e.width}px`:"100px",height:e.height?`${e.height}px`:"50px",whiteSpace:"pre-line"},children:[e.content||"Rect"," "]});class rx{createHighlight(s,n,o){return{id:n??Ve(),start:s.start,end:s.end,color:s.color,createdAt:o??Date.now()}}validateHighlight(s,n){return s.start<0?{valid:!1,error:"Highlight start cannot be negative"}:s.end>n?{valid:!1,error:`Highlight end (${s.end}) exceeds text length (${n})`}:s.start>=s.end?{valid:!1,error:"Highlight start must be less than end"}:{valid:!0}}findOverlapping(s,n,o,r){const a=(r==null?void 0:r.includeTouching)??!1;return s.filter(i=>a?!(i.end<n||i.start>o):!(i.end<=n||i.start>=o))}deleteHighlight(s,n){return s.filter(o=>o.id!==n)}sortHighlights(s){return[...s].sort((n,o)=>n.start!==o.start?n.start-o.start:n.end-o.end)}}function Ki(e,s,n){let o=0,r=!1;function a(i){var c;if(r)return!0;if(i===s)return i.nodeType===Node.TEXT_NODE&&(o+=n),r=!0,!0;if(i.nodeType===Node.TEXT_NODE)o+=((c=i.textContent)==null?void 0:c.length)||0;else if(i.nodeType===Node.ELEMENT_NODE){const l=i,d=l.tagName;if(d==="BR")return o+=1,!1;let h=0,u=!1;if(d==="H1")h=2;else if(d==="H2")h=3;else if(d==="H3")h=4;else if(d==="BLOCKQUOTE")h=2;else if(l.classList.contains("list-item-ul"))h=2,u=!0;else if(l.classList.contains("list-item-ol")){const m=l.querySelector("span:first-child");h=((m==null?void 0:m.textContent)||"1.").length+1,u=!0}else if(l.classList.contains("empty-line"))return o+=1,!1;o+=h;const f=Array.from(i.childNodes);for(let m=0;m<f.length;m++)if(!(u&&m===0&&f[m].nodeName==="SPAN")&&a(f[m]))return!0}return!1}return a(e),o}function ix(e){if(e instanceof HTMLTextAreaElement){const s=e.selectionStart,n=e.selectionEnd;return s===n?null:{start:s,end:n}}if(e.isContentEditable){const s=window.getSelection();if(!s||s.isCollapsed||s.rangeCount===0)return null;const n=s.getRangeAt(0),o=Ki(e,n.startContainer,n.startOffset),r=Ki(e,n.endContainer,n.endOffset);return o===r?null:{start:o,end:r}}return null}const cx="rgb(198, 183, 0)";function lx({textareaRef:e,node:s,updateNode:n,enabled:o=!0,defaultColor:r=cx}){const a=p.useRef(new rx),i=p.useCallback(d=>{if(!e.current||!o)return;const h=ix(e.current);if(!h)return;const u=s.highlights||[],f=a.current.findOverlapping(u,h.start,h.end);if(f.length>0){let v=u;for(const N of f)v=a.current.deleteHighlight(v,N.id);if(n(s.id,{highlights:v.length>0?v:void 0}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(h.end,h.end);else{const N=window.getSelection();N&&N.collapseToEnd()}console.log("🗑️ Highlights removed:",f.length);return}const m=a.current.createHighlight({start:h.start,end:h.end,color:d||r}),y=s.content||"",g=a.current.validateHighlight(m,y.length);if(!g.valid){console.error("useTextHighlighting: Invalid highlight",g.error);return}const x=[...u,m],w=a.current.sortHighlights(x);if(n(s.id,{highlights:w}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(h.end,h.end);else{const v=window.getSelection();v&&v.collapseToEnd()}console.log("✨ Highlight applied:",{start:h.start,end:h.end,color:m.color})},[e,o,s,n,r]),c=d=>{const h=s.highlights||[],u=a.current.deleteHighlight(h,d);n(s.id,{highlights:u.length>0?u:void 0}),console.log("🗑️ Highlight removed:",d)},l=()=>{n(s.id,{highlights:void 0}),console.log("🧹 All highlights cleared")};return p.useEffect(()=>{if(!o||!e.current)return;const d=()=>{$n.registerCallback(i)},h=()=>{$n.unregisterCallback(i)},u=e.current;return u.addEventListener("focus",d),u.addEventListener("blur",h),document.activeElement===u&&$n.registerCallback(i),()=>{u.removeEventListener("focus",d),u.removeEventListener("blur",h),$n.unregisterCallback(i)}},[o,e,i]),{applyHighlight:i,removeHighlight:c,clearAllHighlights:l}}function wn(e,s="content"){const n=p.useRef(null),o=p.useCallback(a=>{n.current=a},[]),r=p.useCallback(a=>{const i=n.current;i!==null&&i!==a&&T.getState().undo.commit({type:"node:update",nodeId:e,from:{[s]:i},to:{[s]:a}}),n.current=null},[e,s]);return{onEditStart:o,onEditEnd:r}}function yo(e,s={}){var x;const{duration:n=500,targetScale:o,highlightYOffset:r}=s,a=T.getState(),i=(x=a.projectCanvas.getActive())==null?void 0:x.viewState;if(!i)return;const c=document.getElementById("CanvasAppV2");if(!c)return;const l=c.getBoundingClientRect(),d=l.width/2,h=l.height/2,u=o??i.scale,f=e.x*u,m=e.y*u,y=r!==void 0?m+r*u:m+(e.height||0)*u/2,g={x:d-f-(e.width||0)*u/2,y:h-y};a.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:g,targetScale:u,animationStartTime:performance.now(),animationDuration:n}})),a.setSelectedNodes([e]),a.setNodeToFocusId(e.id)}function qi(e,s){let n=0;function o(r){var a,i,c,l,d;if(r.nodeType===Node.TEXT_NODE){const h=((a=r.textContent)==null?void 0:a.length)||0;if(n+h>=s){const u=s-n,f=Math.min(u,h);return{node:r,offset:f}}return n+=h,null}if(r.nodeType===Node.ELEMENT_NODE){const h=r,u=h.tagName;if(u==="BR")return n+1>s?{node:r.parentNode,offset:Array.from(r.parentNode.childNodes).indexOf(r)}:(n+=1,null);let f=0,m=!1,y=!1;if(u==="H1")f=2;else if(u==="H2")f=3;else if(u==="H3")f=4;else if(u==="BLOCKQUOTE")f=2;else if(h.classList.contains("list-item-ul"))f=2,m=!0,((i=h.previousElementSibling)!=null&&i.classList.contains("list-item-ul")||(c=h.previousElementSibling)!=null&&c.classList.contains("list-item-ol"))&&(y=!0);else if(h.classList.contains("list-item-ol")){const x=h.querySelector("span:first-child");f=((x==null?void 0:x.textContent)||"1.").length+1,m=!0,((l=h.previousElementSibling)!=null&&l.classList.contains("list-item-ul")||(d=h.previousElementSibling)!=null&&d.classList.contains("list-item-ol"))&&(y=!0)}else if(h.classList.contains("empty-line"))return n+1>s?{node:h,offset:0}:(n+=1,null);y&&(n+=1),n+=f;const g=Array.from(r.childNodes);for(let x=0;x<g.length;x++){if(m&&x===0&&g[x].nodeName==="SPAN")continue;const w=o(g[x]);if(w)return w}}return null}return o(e)}const dx=({text:e,highlights:s,className:n})=>!s||s.length===0?null:t.jsx(ux,{text:e,highlights:s,className:n}),ux=({text:e,highlights:s,className:n})=>{const o=p.useRef(null),r=p.useRef(null),[a,i]=p.useState([]),[c,l]=p.useState(0),[d,h]=p.useState(1);p.useEffect(()=>{var g;const f=T.subscribe(x=>{var N;const w=(N=x.projectCanvas.getActive())==null?void 0:N.viewState,v=(w==null?void 0:w.scale)??1;h(v)}),y=(g=T.getState().projectCanvas.getActive())==null?void 0:g.viewState;return h((y==null?void 0:y.scale)??1),f},[]);const u=f=>{var x;if(!f)return;const g=(((x=T.getState().projectCanvas.getActive())==null?void 0:x.coreState.nodes)??[]).find(w=>w.id===f);if(!g){console.warn(`Linked node ${f} not found`);return}yo(g,{duration:400})};return p.useEffect(()=>{var g,x;const f=o.current;if(!f)return;const m=((g=f.parentElement)==null?void 0:g.querySelector("textarea"))||((x=f.parentElement)==null?void 0:x.querySelector(".markdown-textarea"));if(!m)return;l(m.clientWidth);const y=new ResizeObserver(w=>{for(const v of w)v.target===m&&l(m.clientWidth)});return y.observe(m),()=>{y.disconnect()}},[]),p.useEffect(()=>{if(!o.current||!r.current||!s||s.length===0){i([]);return}const f=requestAnimationFrame(()=>{var k,S,E,C;if(!o.current||!r.current)return;const m=o.current,y=((k=m.parentElement)==null?void 0:k.querySelector("textarea"))||((S=m.parentElement)==null?void 0:S.querySelector(".markdown-textarea"));if(!y){i([]);return}const g=r.current,x=window.getComputedStyle(y);g.style.font=x.font,g.style.fontSize=x.fontSize,g.style.fontFamily=x.fontFamily,g.style.fontWeight=x.fontWeight,g.style.lineHeight=x.lineHeight,g.style.letterSpacing=x.letterSpacing,g.style.wordSpacing=x.wordSpacing,g.style.padding=x.padding,g.style.paddingLeft=x.paddingLeft,g.style.paddingRight=x.paddingRight,g.style.paddingTop=x.paddingTop,g.style.paddingBottom=x.paddingBottom,g.style.width=`${y.clientWidth}px`,g.style.border="none";const w=parseFloat(x.borderTopWidth)||0,v=parseFloat(x.borderLeftWidth)||0;g.style.top=`${w}px`,g.style.left=`${v}px`,g.style.wordWrap=x.wordWrap,g.style.whiteSpace=x.whiteSpace,g.style.overflowWrap=x.overflowWrap,g.style.boxSizing=x.boxSizing,g.style.textAlign=x.textAlign,g.style.direction=x.direction,g.style.wordBreak=x.wordBreak,g.textContent=e;const N=y.getBoundingClientRect(),b=m.getBoundingClientRect(),A=y.classList.contains("markdown-textarea"),R=[];for(const I of s){const O=Math.min(I.start,e.length),H=Math.min(I.end,e.length);if(O>=H)continue;const L=e.substring(O,H);try{let W;if(A){const P=qi(y,O),j=qi(y,H),M=((E=P==null?void 0:P.node.textContent)==null?void 0:E.length)??0,B=((C=j==null?void 0:j.node.textContent)==null?void 0:C.length)??0,U=P&&P.offset>=0&&P.offset<=M,z=j&&j.offset>=0&&j.offset<=B;if(!P||!j||!U||!z)continue;const _=document.createRange();_.setStart(P.node,P.offset),_.setEnd(j.node,j.offset),W=_.getClientRects()}else{const P=document.createRange(),j=g.firstChild;if(!j||j.nodeType!==Node.TEXT_NODE)continue;P.setStart(j,O),P.setEnd(j,H),W=P.getClientRects()}for(let P=0;P<W.length;P++){const j=W[P],M={top:j.top-b.top,left:j.left-b.left},B={top:j.top-N.top,left:j.left-N.left},U=parseFloat(x.borderTopWidth)||0,z=M.top-U,_=parseFloat(x.paddingLeft)||0,G=A?B.left:B.left-_,F=j.width,D=j.height;if(F<1)continue;const V=z/d,J=G/d,ie=F/d+8,Se=D/d;R.push({id:`${I.id}-${P}`,top:V,left:J,width:ie,height:Se,color:I.color,linkedNodeId:I.linkedNodeId,highlightedText:L})}}catch(W){console.error("Error calculating highlight rect:",W)}}i(R)});return()=>{cancelAnimationFrame(f)}},[e,s,c,d]),t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:r,className:Me("mirror-div absolute inset-0 pointer-events-none whitespace-pre-wrap"),"aria-hidden":"true"}),t.jsx("div",{ref:o,className:Me("highlight-renderer","absolute inset-0","z-20","pointer-events-none",n),"aria-hidden":"true",children:a.map(f=>t.jsx("mark",{"data-test":"highlight-mark",className:Me("absolute",f.linkedNodeId?"cursor-pointer pointer-events-auto":"pointer-events-none"),onClick:f.linkedNodeId?()=>u(f.linkedNodeId):void 0,style:{top:`${f.top}px`,left:`${f.left}px`,width:`${f.width}px`,height:`${f.height}px`,backgroundColor:f.color,opacity:.4,borderRadius:"2px"}},f.id))})]})};function hx(e,s){const n=e.split(`
`);let o=0;for(let r=0;r<n.length;r++){const a=n[r].length,i=o+a;if(s<=i)return r;o=i+1}return n.length-1}function px(e,s,n=ke.DEFAULT_PADDING,o=ke.LINE_HEIGHT){const r=hx(e,s.start);return n+r*o+o/2}function gx({textareaRef:e,onCopy:s,onHighlight:n,onDelete:o,onLink:r,onHighlightAndCreateNode:a,onDefine:i}){const[c,l]=p.useState(!1),[d,h]=p.useState({start:0,end:0}),u=p.useRef({start:0,end:0}),f=p.useRef(null),m=p.useRef(!1);p.useEffect(()=>{const x=()=>{m.current=!0,l(!1)};return ls.registerDismissPopoverCallback(x),()=>{ls.unregisterDismissPopoverCallback()}},[]),p.useEffect(()=>(ls.registerSelectionCallback(x=>{l(x)}),f.current=setInterval(()=>{const x=e.current;if(!x)return;const w=x.selectionStart,v=x.selectionEnd,N=w!==v;N&&((w!==u.current.start||v!==u.current.end)&&(m.current=!1),u.current={start:w,end:v},h({start:w,end:v})),m.current||l(N)},100),()=>{ls.unregisterSelectionCallback(),f.current&&clearInterval(f.current)}),[e]);const y=()=>{const x=e.current;return x?(x.value??"").substring(d.start,d.end):""},g=(x,w)=>{x.preventDefault(),x.stopPropagation(),m.current=!0;const v=e.current;v&&(v.focus(),v.setSelectionRange(d.start,d.end)),w&&w(),setTimeout(()=>{l(!1)},20)};return t.jsx(Xp,{inputRef:e,show:c,updateOn:d,offset:{top:4,left:0},children:t.jsxs("div",{className:"text-selection-popover bg-popover text-popover-foreground border border-border rounded-md shadow-lg p-1","data-test":"text-selection-popover",onPointerDown:x=>{x.preventDefault()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center gap-1",children:[s&&t.jsx("button",{"data-test":"text-selection-copy-button",onPointerDown:x=>g(x,s),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Create linked node",children:t.jsx(Bt,{className:"w-4 h-4"})}),a&&t.jsx("button",{"data-test":"text-selection-highlight-create-button",onPointerDown:x=>g(x,a),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight & create linked node",children:t.jsx(oo,{className:"w-4 h-4"})}),i&&t.jsx("button",{"data-test":"text-selection-define-button",onPointerDown:x=>g(x,i),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Define word",children:t.jsx(va,{className:"w-4 h-4"})}),n&&t.jsx("button",{"data-test":"text-selection-highlight-button",onPointerDown:x=>g(x,n),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight text",children:t.jsx(Al,{className:"w-4 h-4"})}),r&&t.jsx("button",{"data-test":"text-selection-link-button",onPointerDown:x=>g(x,r),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Link to node",children:t.jsx(zh,{className:"w-4 h-4"})}),o&&t.jsx("button",{"data-test":"text-selection-delete-button",onPointerDown:x=>g(x,o),className:"action-button p-2 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors",title:"Delete selection",children:t.jsx(Nt,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"selection-preview text-xs text-muted-foreground mt-1 px-2 py-1 max-w-[200px] truncate",children:['"',y(),'"']})]})})}function fx({input:e,lastKeyWasEnter:s=!1,pendingNewlines:n=0,computedLineHeight:o=ke.LINE_HEIGHT,currentNodeHeight:r=0}){const a=e.split(/\n|&nbsp;/);let i=a.length,c=ke.DEFAULT_NODE_HEIGHT;if(i===1&&!s&&n===0)return c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:0,headerExtraLines:0};i+=n;let l=0,d=!1,h=!0;const u=n>0;let f=0;for(let m=0;m<a.length;m++){const g=a[m].trimStart(),x=g.startsWith("- ")||/^\d+\.\s/.test(g),w=m===a.length-1;x&&!d&&!h&&(!w||u)&&(l+=1),(!w||u)&&(g.startsWith("# ")?f+=.5:g.startsWith("## ")?f+=.3:g.startsWith("### ")&&(f+=.1)),d=x,h=!1}return i+=l+f,c+=(i-1)*o,c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:l,headerExtraLines:f}}const Zi=(e,s)=>{const o=T.getState().projectCanvas.getActive();if(!o)return null;const a=(o.coreState.nodes||[]).filter(c=>c.linkedSourceNodeId===e&&Array.isArray(c.tags)&&c.tags.some(l=>l.title===s));return a.length===0?null:Math.max(...a.map(c=>(c.y??0)+(c.height??0)))},Ji=e=>({id:Math.random().toString(36).slice(2,10),title:e}),Qi=e=>({x:(e.x??0)+(e.width??0)/2,y:(e.y??0)+(e.height??0)/2}),ec=(e,s)=>{const n=T.getState(),o=()=>Math.random().toString(36).slice(2,10);window.setTimeout(()=>{n.arrow.add({id:o(),startNodeId:e.id,endNodeId:s.id,startPoint:Qi(e),endPoint:Qi(s),type:"TreeLStep"})},0)},mx=He.memo(({node:e,isEditing:s,preventEdit:n})=>{const o=p.useCallback(()=>{const i=T.getState(),c=i.getNodeById(e.id);if(!c)return;const l=ke.DEFAULT_NODE_WIDTH,d=ke.DEFAULT_NODE_HEIGHT,h=40,u=c.x-l/2,f=Zi(c.id,"left"),m=f!==null?f+h:c.y+(c.height??0)+h,y=Ye.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});y.x=u,y.y=m,y.width=l,y.height=d,y.tags=[Ji("left")],i.addNode(y,void 0,{dontOverlap:!0}),i.setNodeToFocusId(y.id),ec(c,y)},[e.id]),r=p.useCallback(()=>{const i=T.getState(),c=i.getNodeById(e.id);if(!c)return;const l=ke.DEFAULT_NODE_WIDTH,d=ke.DEFAULT_NODE_HEIGHT,h=40,u=c.x+(c.width??0)-l/2,f=Zi(c.id,"right"),m=f!==null?f+h:c.y+(c.height??0)+h,y=Ye.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});y.x=u,y.y=m,y.width=l,y.height=d,y.tags=[Ji("right")],i.addNode(y,void 0,{dontOverlap:!0}),i.setNodeToFocusId(y.id),ec(c,y)},[e.id]);return!s||n||!(e.content&&e.content.trim().length>0)?null:t.jsxs(t.Fragment,{children:[t.jsx(se,{"data-test":"create-left-child-node-button",size:"icon",variant:"ghost",className:"create-left-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),o()},title:"Create linked node on the left",children:"+"}),t.jsx(se,{"data-test":"create-right-child-node-button",size:"icon",variant:"ghost",className:"create-right-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${2*(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),r()},title:"Create linked node on the right",children:"+"})]})}),Nd=new Map;function xx(e){const s=e.data;if((s==null?void 0:s.vocabType)!==tt.VOCABULARY)return null;const n=s.sourceWord||"",o=s.translationWord||"",r=bs(n),a=bs(o),i=Math.max(r,a);return{width:Math.max(i+Ns.textNodeXPadding,ke.VOCAB_NODE_MIN_WIDTH),height:null}}Nd.set(fe.VOCABULARY,xx);function tc(e){const s=Nd.get(e.type);return s?s(e):null}const Xa=()=>{var e;return((e=T.getState().projectCanvas.getActive())==null?void 0:e.coreState.selectedNodes)??[]},Ka=()=>T.getState().updateNode;function bn(){const e=p.useCallback(r=>{const a=r||Xa(),i=Ka();if(a.length===0)return;const c=oi(),l=a.map(d=>{if(!(d!=null&&d.id))return null;const h=tc(d);if(h){const m={...d,width:h.width};return h.height!==null&&(m.height=h.height),{id:d.id,payload:m}}if(!d.content||typeof d.content!="string")return null;const{width:u,height:f}=Ws(d.content,c,d);return u>0?{id:d.id,payload:{...d,width:u,height:f}}:null}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const h={width:d.payload.width,options:{...d.payload.options,lockSize:!0}};d.payload.height!==void 0&&(h.height=d.payload.height),i(d.id,h)})},[]),s=p.useCallback((r,a)=>{const i=a||Xa(),c=Ka(),l=i.map(d=>{if(!(d!=null&&d.id))return null;const h=tc(d);if(h){const m={...d,width:r,options:{...d.options,lockSize:!0}};return h.height!==null&&(m.height=h.height),{id:d.id,payload:m}}const u=d.content||"",f=It(u,r,d);return{id:d.id,payload:{...d,width:r,height:f,options:{...d.options,lockSize:!0}}}}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const h={width:d.payload.width,options:d.payload.options};d.payload.height!==void 0&&(h.height=d.payload.height),c(d.id,h)})},[]),n=p.useCallback((r,a,i)=>{if(r.length===0)return;const c=Ka(),l=i??Q.arrange.gap,d=oi();r.map(u=>{if(!(u!=null&&u.id)||!u.content||typeof u.content!="string")return null;const{width:f,height:m}=Ws(u.content,d,u);return f>0?{id:u.id,width:f,height:m}:null}).filter(u=>u!==null).forEach(u=>{c(u.id,{width:u.width,height:u.height,options:{lockSize:!1}})}),setTimeout(()=>{const u=T.getState();let f=a;r.forEach(m=>{const y=u.getNodeById(m.id);y&&(u.updateNode(m.id,{y:f}),f+=(y.height??0)+l)})},10)},[]);return p.useMemo(()=>({fitNodeDimensions:e,setFixedWidth:s,fitAndRepositionNodes:n,get selectedNodes(){return Xa()}}),[e,s,n])}const Sd=p.createContext({inChat:!1});function yx(){return p.useContext(Sd)}function wx(e){const s=p.useCallback(()=>ai.has(e),[e]);return p.useSyncExternalStore(n=>ai.subscribe(n),s,s)}const ga=new Map;let Cd={targetScreenYRatio:.8,animationDuration:300,stabilizationDelay:10,minKeyboardHeight:100,listenerTimeout:2e3};function vx(e){var d;const{nodeId:s,nodeY:n}=e,o=Cd,r=document.querySelector(`[data-node-id="${s}"]`);r==null||r.getBoundingClientRect().top;let a=0,i=null;const c=()=>{var m;const h=window.innerHeight,u=((m=window.visualViewport)==null?void 0:m.height)||window.innerHeight,f=h-u;if(f>o.minKeyboardHeight&&f!==a){a=f,i&&clearTimeout(i),i=setTimeout(()=>{var y;(y=window.visualViewport)==null||y.removeEventListener("resize",c),l()},o.stabilizationDelay);return}},l=()=>{var b;const h=((b=window.visualViewport)==null?void 0:b.height)||window.innerHeight,u=T.getState(),f=u.projectCanvas.getActive(),m=(f==null?void 0:f.viewState.offset)||{x:0,y:0},y=(f==null?void 0:f.viewState.scale)||1,g=document.querySelector(`[data-node-id="${s}"]`),x=g==null?void 0:g.getBoundingClientRect(),w=(x==null?void 0:x.top)??n*y+m.y,N=h*o.targetScreenYRatio-w;u.setActiveCanvasViewState(A=>({...A,targetView:{targetOffset:{x:m.x,y:m.y+N},targetScale:y,animationStartTime:0,animationDuration:o.animationDuration}})),ga.set(s,N)};(d=window.visualViewport)==null||d.addEventListener("resize",c),setTimeout(()=>{var h;(h=window.visualViewport)==null||h.removeEventListener("resize",c),i&&clearTimeout(i)},o.listenerTimeout)}function bx(e){var i,c;const s=Cd,n=ga.get(e);if(!n)return;ga.delete(e);let o=window.innerHeight-(((i=window.visualViewport)==null?void 0:i.height)||window.innerHeight),r=null;const a=()=>{var u;const l=window.innerHeight,d=((u=window.visualViewport)==null?void 0:u.height)||window.innerHeight,h=l-d;h!==o&&(o=h,r&&clearTimeout(r),r=setTimeout(()=>{var f;if(h<s.minKeyboardHeight){(f=window.visualViewport)==null||f.removeEventListener("resize",a);const m=T.getState(),y=m.projectCanvas.getActive(),{scale:g,offset:x}=(y==null?void 0:y.viewState)||{scale:1,offset:{x:0,y:0}};m.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:{x:x.x,y:x.y-n},targetScale:g,animationStartTime:0,animationDuration:s.animationDuration}}))}},s.stabilizationDelay))};(c=window.visualViewport)==null||c.addEventListener("resize",a),setTimeout(()=>{var l;(l=window.visualViewport)==null||l.removeEventListener("resize",a),r&&clearTimeout(r)},s.listenerTimeout)}function Nx(e){var n;const s=((n=window.visualViewport)==null?void 0:n.height)||window.innerHeight;return e>s/2}const Sx="type here...",Cx=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??Tr},jd=He.memo(({node:e})=>{var Se,me,Z,ge,we,te;const s=p.useRef(null),n=p.useRef(null),[o,r]=p.useState(e.isEditing??!1),a=p.useRef(Date.now()),[i,c]=p.useState(e.content||""),l=p.useRef(0),d=ps(),h=Yo(Cx),u=wx(e.id),{inChat:f,containerWidth:m,onSendMessage:y}=yx(),{onEditStart:g,onEditEnd:x}=wn(e.id,"content");p.useEffect(()=>{if(s.current){const X=s.current.getTextArea();X&&(n.current=X)}},[s.current]);const{updateNodeContent:w,updateNode:v,setMode:N,deleteNodeById:b}=T.getState(),A=$(X=>X.uiState.nodeToFocusId),R=$(X=>X.uiState.mode),k=$(X=>X.uiState.writeSubMode);$(X=>{var K;return((K=X.uiState.dragInfo)==null?void 0:K.draggedNodeId)===e.id});const S=$(X=>{var K,ne;return((ne=(K=X.projectCanvas.getActive())==null?void 0:K.coreState.selectedNodes)==null?void 0:ne.some(ce=>ce.id===e.id))??!1}),E=$(X=>{var K,ne;return((ne=(K=X.projectCanvas.getActive())==null?void 0:K.coreState.selectedNodes)==null?void 0:ne.length)??0}),C=S&&A===e.id,{fitNodeDimensions:I,setFixedWidth:O}=bn(),H=X=>{const K=X.target.value,ne=(i.match(/\n/g)||[]).length,de=(K.match(/\n/g)||[]).length-ne;de>0&&(l.current=Math.max(0,l.current-de)),c(K),w(e.id,K)},L=p.useCallback(X=>{var ue;X.preventDefault();const K=X.clipboardData.getData("text"),ne=(ue=s.current)==null?void 0:ue.getTextArea();if(!ne)return;const ce=ne.selectionStart,de=ne.selectionEnd,q=ne.value;if(!q)return;const he=q.substring(0,ce)+K+q.substring(de);ne.value=he;const be=ce+K.length;ne.setSelectionRange(be,be),c(he),w(e.id,he),setTimeout(()=>{const ye=T.getState().getNodeById(e.id);ye!=null&&ye.width&&O(ye.width,[ye])},10)},[e.id,w,O]),W=p.useCallback(()=>{setTimeout(()=>{const K=T.getState().getNodeById(e.id);K!=null&&K.width&&O(K.width,[K])},10)},[e.id,O]),P=p.useCallback(()=>{setTimeout(()=>{const K=T.getState().getNodeById(e.id);K&&I([K])},10)},[e.id,I]),j=p.useCallback(()=>{setTimeout(()=>{const K=T.getState().getNodeById(e.id);K!=null&&K.width&&O(K.width,[K])},10)},[e.id,O]);lx({textareaRef:n,node:e,updateNode:v,enabled:o,defaultColor:void 0});const M=p.useCallback(X=>{r(X),v(e.id,{isEditing:X})},[v,e.id]),B=p.useCallback(()=>{var K,ne;if(document.querySelector("[data-radix-popper-content-wrapper]"))return;const X=Date.now()-a.current;if(!i.trim()){if(X<200){requestAnimationFrame(()=>{var de;const ce=(de=s.current)==null?void 0:de.getTextArea();ce&&ce.focus({preventScroll:!0})});return}b(e.id);return}l.current=0,w(e.id,i),x(i),M(!1),v(e.id,{isEditing:!1}),(K=window.getSelection())==null||K.removeAllRanges(),(ne=e.options)!=null&&ne.lockSize||setTimeout(()=>{const de=T.getState().getNodeById(e.id);de!=null&&de.width&&O(de.width,[de])},10),ga.has(e.id)&&bx(e.id)},[e.id,e.width,e.height,(Se=e.options)==null?void 0:Se.lockSize,w,i,v,O,x,b]),U=p.useCallback(X=>{var de,q,he;const K=window.getSelection();K==null||K.rangeCount,(de=K==null?void 0:K.anchorNode)==null||de.nodeName,K==null||K.anchorOffset,(q=K==null?void 0:K.focusNode)==null||q.nodeName,K==null||K.focusOffset,K==null||K.isCollapsed,(he=K==null?void 0:K.toString())==null||he.substring(0,30);const ce=X.currentTarget.getBoundingClientRect();X.clientX,X.clientY,Math.round(ce.left),Math.round(ce.top),Math.round(ce.right),Math.round(ce.bottom),X.clientX>=ce.left&&X.clientX<=ce.right&&X.clientY>=ce.top&&X.clientY<=ce.bottom,e.isEditing&&X.shiftKey},[e.isEditing,e.id]),z=p.useCallback(()=>{var K;if(!e.isEditing)return;const X=(K=s.current)==null?void 0:K.getTextArea();X&&X.focus()},[e.isEditing]),_=p.useCallback(X=>{if(!X)return"";if("value"in X&&typeof X.value=="string")return X.value;const K=de=>{let q="";for(const he of de.childNodes)if(he.nodeType===Node.TEXT_NODE)q+=he.textContent||"";else if(he.nodeType===Node.ELEMENT_NODE){const be=he;if(be.tagName==="BR")q+=`
`;else if(be.tagName==="DIV"||be.tagName==="P"){const ue=K(be);q+=ue+`
`}else q+=K(be)}return q};return K(X).replace(/\n+$/,"")},[]),G=p.useCallback(X=>{var le,ye,xe,je,Oe;if(X.key==="Escape"){B(),M(!1),T.getState().uiState.mode!==ee.VIM&&N(ee.SELECT),(ye=(le=s.current)==null?void 0:le.getTextArea())==null||ye.blur();return}if(X.key==="Enter"&&X.ctrlKey){const oe=(xe=s.current)==null?void 0:xe.getTextArea(),ae=_(oe);w(e.id,ae);return}if(f&&X.key==="Enter"&&!X.shiftKey&&!d){X.preventDefault(),w(e.id,i),y==null||y();return}let K=i;if(X.key==="Backspace"||X.key==="Delete"){const oe=(je=s.current)==null?void 0:je.getTextArea();if(oe){const ae=oe.selectionStart,Ce=oe.selectionEnd;ae!==Ce?K=i.substring(0,ae)+i.substring(Ce):X.key==="Backspace"&&ae>0?K=i.substring(0,ae-1)+i.substring(ae):X.key==="Delete"&&ae<i.length&&(K=i.substring(0,ae)+i.substring(ae+1))}}if(X.key==="Enter"){const oe=K.split(`
`),ae=oe[oe.length-1].replace(/\u200B/g,"");/^(\s*)-\s*$/.test(ae)||/^(\s*)(\d+)\.\s*$/.test(ae)?l.current=0:l.current+=1}else l.current=0;const ne=he();let ce=be(K,X.key==="Enter",l.current,ne);const de=ue(K);let q=(Oe=e.options)!=null&&Oe.lockSize?e.width:de;if(f&&m&&q!==void 0&&q>m&&(q=m),X.key==="Enter"&&l.current>0){const oe=(e.height??0)+ne;ce=Math.max(ce,oe)}v(e.id,{width:q,height:ce,isEditing:!0});function he(){var ae;const oe=(ae=s.current)==null?void 0:ae.getTextArea();if(oe){const Y=window.getComputedStyle(oe).lineHeight;if(Y&&Y!=="normal"){const re=parseFloat(Y);if(!isNaN(re))return re}}return ke.LINE_HEIGHT}function be(oe,ae=!1,Ce=0,Y=ke.LINE_HEIGHT){return fx({input:oe,lastKeyWasEnter:ae,pendingNewlines:Ce,computedLineHeight:Y,currentNodeHeight:e.height??0}).finalHeight}function ue(oe,ae=ke.DEFAULT_NODE_WIDTH,Ce=Ns.textNodeXPadding){const ve=oe.split(/\n/).map(Te=>Xo(Te)).reduce((Te,Re)=>Math.max(Te,Re),0)+Ce,Ae=Math.max(ve,ae);return X.key==="Backspace"||X.key==="Delete"?Math.min(Ae,e.width??Ae):Math.max(Ae,e.width??0)}},[B,w,v,e.id,e.width,e.height,(me=e.options)==null?void 0:me.lockSize,i,N,f,m,y,d]);p.useEffect(()=>{!A&&o&&M(!1)},[A,o,M]),p.useEffect(()=>{!S&&o&&M(!1)},[S,o,M]),p.useEffect(()=>{var ce,de;if(!C)return;const X=!o,K=e.content||"";if(M(!0),c(K),X&&g(K),!X)return;const ne=(ce=s.current)==null?void 0:ce.getTextArea();if(ne){ne.readOnly=!1,ne.focus({preventScroll:!0}),ne.click();const q=((de=ne.value)==null?void 0:de.length)??0;ne.selectionStart=ne.selectionEnd=q}window.setTimeout(()=>{var be,ue;const q=(be=s.current)==null?void 0:be.getTextArea();if(q&&document.activeElement!==q){q.readOnly=!1,q.focus({preventScroll:!0}),q.click();const le=((ue=q.value)==null?void 0:ue.length)??0;q.selectionStart=q.selectionEnd=le}},50)},[C,e.content,o,g]),p.useEffect(()=>{var K;const X=(K=s.current)==null?void 0:K.getTextArea();if(X)return X.addEventListener("blur",B),()=>{X.removeEventListener("blur",B)}},[B,e.id,e.width,e.height,(Z=e.options)==null?void 0:Z.lockSize]),p.useEffect(()=>{c(e.content||"")},[e.content]);const F=p.useCallback(()=>{const K=T.getState().TextModeHandler;if(K){const ne=new K;ne&&typeof ne.onCopy=="function"&&ne.onCopy()}},[]),D=p.useCallback(()=>{var K,ne;const X=new KeyboardEvent("keydown",{key:"h",ctrlKey:!0,bubbles:!0});(ne=(K=s.current)==null?void 0:K.getTextArea())==null||ne.dispatchEvent(X)},[]),V=p.useCallback(()=>{var de;const X=(de=s.current)==null?void 0:de.getTextArea();if(!X)return;const K=X.selectionStart,ne=X.selectionEnd,ce=i.substring(0,K)+i.substring(ne);c(ce),w(e.id,ce),setTimeout(()=>{var q,he;(he=(q=s.current)==null?void 0:q.getTextArea())==null||he.setSelectionRange(K,K)},0)},[i,e.id,w]),J=p.useCallback(()=>{var ce;if(!((ce=s.current)==null?void 0:ce.getTextArea()))return;const K=new ls,ne=new KeyboardEvent("keydown",{key:"!"});K.highlightAndCreateNode(ne)},[]),ie=p.useCallback(async()=>{var ae,Ce;const X=(ae=s.current)==null?void 0:ae.getTextArea();if(!X)return;const K=X.selectionStart,ne=X.selectionEnd,de=X.value.substring(K,ne);if(!de.trim())return;const q=T.getState(),he="rgb(198, 183, 0)",be=await Kp(de.trim(),"English");let ue;if(K!==ne){const Y=e.highlights||[],re=Y.find(ve=>ve.start===K&&ve.end===ne);if(re)ue=re.id;else{ue=Math.random().toString(36).slice(2,10);const ve={id:ue,start:K,end:ne,color:he,createdAt:Date.now()},Ae=[...Y,ve];q.updateNode(e.id,{highlights:Ae})}}const le=`${de}

${be.definition}`,ye=Ye.buildTextNodeV2({content:le,linkedHighlightId:ue,linkedSourceNodeId:e.id}),xe=od(X,K,ne),je=(Ce=q.projectCanvas.getActive())==null?void 0:Ce.viewState,Oe=(je==null?void 0:je.scale)??1;let oe=e.y;if(xe){const Y=xe.top/Oe;oe=e.y+Y}if(Aa(ye,{...e,y:oe,id:e.id}),ue){const Y=q.getNodeById(e.id),ve=((Y==null?void 0:Y.highlights)||[]).map(Ae=>Ae.id===ue?{...Ae,linkedNodeId:ye.id}:Ae);q.updateNode(e.id,{highlights:ve})}},[e]);return t.jsxs(t.Fragment,{children:[e.linkedHighlightId&&e.linkedSourceNodeId&&S&&E===1&&t.jsx("div",{className:"absolute z-50 cursor-pointer","data-test":"text-node-linked-highlight-indicator",style:{left:`${(e.width||0)+8}px`,top:"4px"},onClick:X=>{var he;X.stopPropagation();const ce=(((he=T.getState().projectCanvas.getActive())==null?void 0:he.coreState.nodes)??[]).find(be=>be.id===e.linkedSourceNodeId);if(!ce)return;const de=(ce.highlights||[]).find(be=>be.id===e.linkedHighlightId);let q;de&&typeof ce.content=="string"&&(q=px(ce.content,de,4,ke.LINE_HEIGHT)),yo(ce,{duration:400,highlightYOffset:q})},title:"Navigate to source highlight",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18","data-test":"text-node-linked-highlight-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-600 hover:text-yellow-700",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}),t.jsx(mx,{node:e,isEditing:!!o,preventEdit:!1}),u&&!o&&t.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 z-50",title:"Transcription in progress...","data-test":"text-node-transcription-indicator"}),t.jsxs("div",{className:"relative w-full h-full","data-text-position-container":"true","data-test":"text-node-position-container",children:[!o&&S&&E<=1&&d&&t.jsx("div",{className:"absolute inset-0 z-20 cursor-pointer",onClick:z,onTouchEnd:X=>{X.preventDefault(),z()},"data-text-node-click-overlay":"true","data-test":"text-node-mobile-click-overlay"}),o&&t.jsx(gx,{textareaRef:n,onCopy:F,onHighlight:D,onDelete:V,onHighlightAndCreateNode:J,onDefine:ie,"data-test":"text-node-selection-popover"}),t.jsx(dx,{text:i,highlights:e.highlights,"data-test":"text-node-highlight-renderer"}),t.jsx(pl,{ref:s,value:i,onChange:H,onPaste:L,onPasteComplete:W,onBlur:B,onKeyDown:G,onMouseDown:U,onClick:z,placeholder:Sx,readOnly:!o,showFilePicker:!1,showAudioButton:o||u,showConfigButton:o||u,audioButtonVariant:"muted",autoStartAudioRecording:C&&R===ee.WRITE&&k===un.AUDIO,onAudioTranscriptionComplete:P,audioNodeId:e.id,useMarkdown:!0,showBuiltInPopover:!1,keyboard:h,onModeChange:j,"data-test":"text-node-textarea",className:Me("relative","m-0 p-1 w-full h-full","min-h-0","resize-none","border","rounded-[3px]",e.className,{"overflow-hidden":!d||!o,"overflow-y-auto":d&&o,"pointer-events-none":!o&&!S||E>1,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!i&&!o},"bg-primary/1"),style:{zIndex:We.nodeTextarea,textAlign:(ge=e.styles)==null?void 0:ge.textAlign,fontSize:(we=e.styles)==null?void 0:we.fontSize,lineHeight:(te=e.styles)!=null&&te.fontSize?`${Math.round(parseFloat(e.styles.fontSize)*1.5)}px`:void 0,border:f?"none":void 0}})]})]})}),jx=()=>{var a;const e=T.getState(),s=((a=e.projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],n=e.updateNodes,o=p.useMemo(()=>{var i;if(s.length===1)return(i=s[0].styles)==null?void 0:i.textAlign},[s]);return{handleAlignmentChange:p.useCallback(i=>{if(s.length===0)return;const c=s.map(l=>({...l,id:l.id,styles:{...l.styles,textAlign:i}}));n(c)},[s,n]),currentAlignment:o}},Nn=p.forwardRef((e,s)=>{const{className:n,children:o}=e;return t.jsx(se,{ref:s,id:"ConfigurationButton",variant:"secondary",size:"icon","aria-label":"Configuration button",className:`h-6 w-6 p-0.5 rounded hover:bg-secondary/80 flex-shrink-0 flex items-center justify-center ${n||null}`,...e,children:o})});Nn.displayName="ConfigurationButton";function kx(e,s,n=!1){let o=null;const r=function(...a){const i=this,c=()=>{o=null,n||e.apply(i,a)},l=n&&!o;o!==null&&clearTimeout(o),o=setTimeout(c,s),l&&e.apply(i,a)};return r.cancel=()=>{o!==null&&(clearTimeout(o),o=null)},r}const Ix=Q.text.debounceInput,Ax=e=>{const{className:s,content:n,onValueChange:o}=e,[r,a]=p.useState(n),i=p.useCallback(kx(l=>{o==null||o(l)},Ix),[o]),c=l=>{const d=l.target.value;a(d),i(d)};return t.jsx(Er,{id:"CanvasTextEditor",className:Me("h-[90%]","bg-background",s),style:{fontSize:Q.text.fontSize},value:r,onChange:c,"data-test":"canvas-text-editor-textarea"})},kd=e=>{var h;const{className:s}=e,n=T.getState(),o=n.projectCanvas.getActive(),r=o==null?void 0:o.coreState,a=n.updateNodeSubContent,c=((r==null?void 0:r.selectedNodes)??[])[0],l=(h=c==null?void 0:c.content)==null?void 0:h.toString().slice(0,30),d=p.useCallback(u=>{c&&a(c.id,u)},[c,a]);return t.jsxs(gl,{children:[t.jsx(Pu,{asChild:!0,children:t.jsx(Nn,{id:"CanvasTextEditorButton",className:s,tooltip:"Open Text Editor",variant:"ghost","data-test":"canvas-text-editor-button",children:t.jsx($h,{})})}),t.jsxs(fl,{id:"canvas-text-editor-dialog",className:"sm:max-w-[70vw] h-[80vh] bg-secondary",style:{display:"unset"},"aria-describedby":"Text editor dialog",children:[t.jsx(ml,{children:t.jsx(xl,{children:l})}),t.jsx(Ax,{content:c==null?void 0:c.subContent,onValueChange:d})]})]})},Tx={width:380,height:500},Ex="Presets",Rx="No presets yet. Create one from current settings.";function Id({isVisible:e,onClose:s,triggerPosition:n,renderConfigSection:o,getCurrentConfig:r,presetActions:a,onApplyPreset:i,title:c=Ex,initialSize:l=Tx,emptyMessage:d=Rx,headerActions:h}){const[u,f]=p.useState(null),[m,y]=p.useState(""),[g,x]=p.useState(null),[w,v]=p.useState(!1),N=a.getAll(),b=a.getFavoriteIds(),A=a.getActiveId(),R=u?a.getById(u):null,k=g??r(),S=p.useMemo(()=>{const F=N.filter(V=>b.includes(V.id)),D=N.filter(V=>!b.includes(V.id));return[...F,...D]},[N,b]),E=p.useMemo(()=>S.map(F=>({id:F.id,label:F.name,icon:b.includes(F.id)?t.jsx(an,{className:"h-3 w-3 fill-yellow-400 text-yellow-400"}):void 0,data:F})),[S,b]),C=p.useCallback(F=>{x(D=>({...D??r(),...F}))},[r]),I=p.useCallback(()=>{v(!0),f(null),y("New Preset"),x(r())},[r]),O=p.useCallback(()=>{if(!m.trim()||!g)return;const F=a.create(m.trim(),g);v(!1),y(""),x(null),a.apply(F);const D=a.getById(F);D&&i&&i(D)},[m,g,a,i]),H=p.useCallback(()=>{v(!1),y(""),x(null)},[]),L=p.useCallback(F=>{f(F.id),v(!1),x(F.config)},[]),W=p.useCallback(()=>{!u||!g||(a.updateConfig(u,g),f(null),x(null))},[u,g,a]),P=p.useCallback(()=>{f(null),x(null)},[]),j=p.useCallback(F=>{const D=F.data;a.apply(D.id),i&&i(D)},[a,i]),M=p.useCallback((F,D)=>{a.rename(F,D)},[a]),B=p.useCallback(F=>{a.delete(F),u===F&&(f(null),x(null))},[a,u]),U=p.useCallback(F=>{const D=F.map(V=>V.id);a.reorder(D)},[a]),z=p.useCallback(F=>{const D=F.data;return[{id:"apply-execute",icon:t.jsx(ft,{className:"h-3 w-3"}),title:"Apply & Execute",onClick:()=>{a.apply(D.id),i&&i(D)}}]},[a,i]),_=p.useCallback(F=>{const D=F.data,V=b.includes(D.id);return[{id:"toggle-favorite",label:V?"Remove from favorites":"Add to favorites",icon:t.jsx(an,{className:`h-4 w-4 mr-2 ${V?"fill-yellow-400 text-yellow-400":""}`}),onClick:()=>a.toggleFavorite(D.id)},{id:"rename",label:"Rename",icon:t.jsx(Fs,{className:"h-4 w-4 mr-2"}),onClick:()=>{const J=window.prompt("Rename preset:",D.name);J&&J.trim()&&J!==D.name&&a.rename(D.id,J.trim())}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Bt,{className:"h-4 w-4 mr-2"}),onClick:()=>a.duplicate(D.id)},{id:"edit-settings",label:"Edit settings",icon:t.jsx(Tl,{className:"h-4 w-4 mr-2"}),onClick:()=>L(D)}]},[b,a,L]),G=w||u!==null;return t.jsx(et,{isVisible:e,onClose:s,title:c,triggerPosition:n,initialSize:l,resizable:!0,shouldCloseManually:!0,headerActions:h,children:t.jsxs("div",{className:"flex flex-col h-full overflow-hidden","data-test":"preset-manager-popover",children:[t.jsx("div",{className:"px-3 py-2 border-b border-border","data-test":"preset-create-section",children:w?t.jsx("div",{className:"space-y-2","data-test":"preset-create-form",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ze,{value:m,onChange:F=>y(F.target.value),placeholder:"Preset name",className:"flex-1 h-8 text-sm",autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(se,{size:"sm",onClick:O,disabled:!m.trim(),"data-test":"preset-save-button",children:"Save"}),t.jsx(se,{size:"sm",variant:"ghost",onClick:H,"data-test":"preset-cancel-button",children:"Cancel"})]})}):R?t.jsx("div",{className:"space-y-2","data-test":"preset-edit-form",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-sm font-medium truncate",children:["Editing: ",R.name]}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx(se,{size:"sm",onClick:W,"data-test":"preset-update-button",children:"Update"}),t.jsx(se,{size:"sm",variant:"ghost",onClick:P,"data-test":"preset-cancel-edit-button",children:"Cancel"})]})]})}):t.jsxs(se,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:I,"data-test":"preset-create-button",children:[t.jsx(Tt,{className:"h-4 w-4 mr-2"}),"New from current settings"]})}),G&&t.jsx("div",{className:"px-3 py-2 border-b border-border overflow-auto max-h-[75%] shrink-0","data-test":"preset-config-section",children:o({currentConfig:k,onConfigChange:C,isEditingPreset:u!==null,editingPresetName:R==null?void 0:R.name})}),t.jsx("div",{className:"flex-1 overflow-auto px-1 py-2","data-test":"preset-list-section",children:E.length===0?t.jsx("div",{className:"text-center text-muted-foreground text-sm py-8 px-4","data-test":"preset-empty-message",children:d}):t.jsx(gn,{data:E,selectedId:A,onItemClick:j,onUpdate:M,onDelete:B,onReorder:U,quickActions:z,moreOptionsItems:_,dropdownZIndex:We.draggablePopoverDropdown,enableEdit:!1,enableDelete:!0,enableDrag:!0,deleteConfirmMessage:F=>`Delete preset "${F.label}"? This cannot be undone.`})})]})})}const{animation:sc}=Q,Mx=(e=!1,s=!0,n=!1,o=20)=>{const{fitAndRepositionNodes:r}=bn(),a=p.useCallback(m=>{const y=T.getState(),g=y.projectCanvas.getActive(),x=(g==null?void 0:g.coreState.selectedNodes)??[],w=y.addNode,v=y.deleteSelectedNodes,N=y.setSelectedNodes,b=y.updateNodes,A=y.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const R=x[0];if(!R.content||typeof R.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}const k=m==="paragraph"?/(\n\n)/:m==="line"?/(\n)/:m==="comma"?/(,)/:m==="period"?/(\.)/:m==="whitespace"?/(\s+)/:new RegExp(`([${ke.CUSTOM_CHARACTERS.join("")}])`),S=R.content.split(k),E=[];for(let M=0;M<S.length;M+=2){const B=S[M],U=S[M+1];(B||U)&&E.push(s?(B||"")+(U||""):B||"")}if(E.length===0){console.warn("useNodeSplitter: No segments found after split.");return}if(E.length===1&&E[0]===R.content){console.warn(`useNodeSplitter: No ${m==="paragraph"?"double newline":m==="line"?"single newline":m==="comma"?"comma":m==="period"?"period":m==="whitespace"?"whitespace":"custom character"} found to split content. Original node not modified.`);return}const C=R.x,I=R.y;R.width;const O=R.id;e||v();let H=n?C:I,L=0;const W=[],P=new Map;let j=n?C:I;E.forEach((M,B)=>{const U=m==="comma"||m==="paragraph"||m==="period"||m==="custom"||m==="whitespace"?M.trim():M;if((m==="paragraph"||m==="comma"||m==="period"||m==="custom"||m==="whitespace")&&U===""&&E.length>1)return;const z=Math.min(bs(U),Q.nodeOptions.maxNodeWidth)+Ns.textNodeXPadding,_=It(U,z,R);let G,F;if(n?(F=I,B===0?G=C:G=H+L+o):(G=C,B===0?F=I:F=H+L+o),e&&B===0){b([{id:O,content:U,width:z,height:_}]),H=n?G:F,L=n?z:_,j=(n?G+z:F+_)+o;return}const D=O+"-split-"+B,V=Ye.buildTextNodeV2({...R,id:D,title:"",x:C,y:I,width:z,height:_,content:U});P.set(D,{x:G,y:F}),w(V),W.push(V),e&&A({id:Ve(10),startNodeId:O,endNodeId:V.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),H=n?G:F,L=n?z:_}),W.length>0&&(N(W),setTimeout(()=>{const B=T.getState().updateNodes,U=[];P.forEach((z,_)=>{U.push({id:_,x:z.x,y:z.y})}),U.length>0&&B(U),n||r(W,j,o)},sc.splitDelayMs))},[r,e,s,n,o]),i=p.useCallback(()=>{a("paragraph")},[a]),c=p.useCallback(()=>{a("line")},[a]),l=p.useCallback(()=>{a("comma")},[a]),d=p.useCallback(()=>{a("period")},[a]),h=p.useCallback(()=>{a("custom")},[a]),u=p.useCallback(()=>{a("whitespace")},[a]),f=p.useCallback(m=>{const y=T.getState(),g=y.projectCanvas.getActive(),x=(g==null?void 0:g.coreState.selectedNodes)??[],w=y.addNode,v=y.deleteSelectedNodes,N=y.setSelectedNodes,b=y.updateNodes,A=y.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const R=x[0];if(!R.content||typeof R.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}let k;try{k=new RegExp(`(${m})`,"g")}catch(M){console.error("useNodeSplitter: Invalid regex pattern",M);return}const S=R.content.split(k),E=[];for(let M=0;M<S.length;M+=2){const B=S[M]||"",U=S[M+1]||"",z=s?(B+U).trim():B.trim();z&&E.push(z)}if(E.length===0){console.warn("useNodeSplitter: No segments found with regex pattern.");return}if(E.length===1&&E[0]===R.content.trim()){console.warn("useNodeSplitter: Regex pattern did not match content.");return}const C=R.x,I=R.y,O=R.id;e||v();let H=n?C:I,L=0;const W=[],P=new Map;let j=n?C:I;E.forEach((M,B)=>{if(M==="")return;const U=Math.min(bs(M),Q.nodeOptions.maxNodeWidth)+Ns.textNodeXPadding,z=It(M,U,R);let _,G;if(n?(G=I,B===0?_=C:_=H+L+o):(_=C,B===0?G=I:G=H+L+o),e&&B===0){b([{id:O,content:M,width:U,height:z}]),H=n?_:G,L=n?U:z,j=(n?_+U:G+z)+o;return}const F=O+"-split-"+B,D=Ye.buildTextNodeV2({...R,id:F,title:"",x:C,y:I,width:U,height:z,content:M});P.set(F,{x:_,y:G}),w(D),W.push(D),e&&A({id:Ve(10),startNodeId:O,endNodeId:D.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),H=n?_:G,L=n?U:z}),W.length>0&&(N(W),setTimeout(()=>{const B=T.getState().updateNodes,U=[];P.forEach((z,_)=>{U.push({id:_,x:z.x,y:z.y})}),U.length>0&&B(U),n||r(W,j,o)},sc.splitDelayMs))},[e,s,n,o,r]);return{splitNodeContentByParagraph:i,splitNodeContentByLine:c,splitNodeContentByComma:l,splitNodeContentByPeriod:d,splitNodeContentByCustomCharacter:h,splitNodeContentByWhitespace:u,splitNodeContentByRegex:f}};function Px(e){return!e||e.trim()===""?0:e.trim().split(/\s+/).filter(s=>s.length>0).length}const Dx=[".","!","?",":",";"],Ox=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","Ph.D","M.D","B.A","M.A","B.S","M.S","Inc","Ltd","Co","Corp","etc","vs","e.g","i.e","a.m","p.m","St","Ave","Blvd","Rd","vol","no"];function Lx(e,s){if(s<=0||s>=e.length-1)return!1;let n=s-1;for(;n>=0&&/[a-zA-Z.]/.test(e[n]);)n--;n++;const o=e.substring(n,s);return!!(Ox.includes(o)||o.length===1&&/[A-Z]/.test(o)||s>1&&e[s-2]===".")}function Wx(e,s){const n=[".","!","?",","];let o=e.length;for(const r of n){const a=e.indexOf(r,s);a!==-1&&a<o&&(o=a)}return o}function Hx(e,s){const n=[];for(let r=0;r<e.length;r++)e[r]===","&&n.push(r);const o=[];for(let r=0;r<n.length;r++){const a=n[r],i=Wx(e,a+1),c=e.substring(a+1,i).trim();Px(c)>=s&&o.push(a)}return o}function nc(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(Dx.includes(o)){if(o==="."&&Lx(e,n)){s+=o,n++;continue}for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}function oc(e,s=3){if(!e)return e;const n=Hx(e,s);if(n.length===0)return e;let o=e;for(let r=n.length-1;r>=0;r--){const a=n[r];let i=a+1;for(;i<o.length&&o[i]===" ";)i++;o=o.substring(0,a+1)+`
`+o.substring(i)}return o}const Fx=["&",";","-",":"];function ac(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(Fx.includes(o)){for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}const Bx=()=>{const e=p.useCallback((a,i=3)=>{const c=T.getState(),l=c.projectCanvas.getActive(),d=(l==null?void 0:l.coreState.selectedNodes)??[],h=c.updateNodeContent;if(d.length===0){console.warn("useNodeInsideSplitter: No nodes selected.");return}d.forEach(u=>{if(!u.content||typeof u.content!="string"){console.warn(`useNodeInsideSplitter: Node ${u.id} has no content to split.`);return}let f;if(a==="sentence")f=nc(u.content);else if(a==="smartComma")f=oc(u.content,i);else if(a==="smartCharacter")f=ac(u.content);else if(a==="all")f=nc(u.content),f=oc(f,i),f=ac(f);else{console.warn(`useNodeInsideSplitter: Unknown mode "${a}"`);return}if(f===u.content){console.warn(`useNodeInsideSplitter: No ${a==="sentence"?"sentence endings":"qualifying commas"} found in node ${u.id}. Content not modified.`);return}h(u.id,f);const m=c.getSegmentedButtonAction("canvas-fit-width");let y=null;if(m){const v=m.match(/Set width to (\d+)px/);v&&(y=parseInt(v[1],10))}let g,x,w;if(y)x=It(f,y,u),g=y,w=!0;else{let v;const N=document.querySelector("textarea[data-node-textarea]");if(N){const R=window.getComputedStyle(N).lineHeight;if(R&&R!=="normal"){const k=parseFloat(R);isNaN(k)||(v=k)}}const b=Ws(f,v,u);g=b.width,x=b.height,w=!1}c.updateNode(u.id,{content:f,width:g,height:x,options:{...u.options,lockSize:w}})})},[]),s=p.useCallback(()=>{e("sentence")},[e]),n=p.useCallback((a=3)=>{e("smartComma",a)},[e]),o=p.useCallback(()=>{e("smartCharacter")},[e]),r=p.useCallback((a=3)=>{e("all",a)},[e]);return{splitInsideBySentence:s,splitInsideBySmartComma:n,splitInsideBySmartCharacter:o,splitInsideByAll:r}};function zx({action:e,mode:s,isSelected:n,onSelect:o,onSplitRegex:r,selectedNodeContent:a}){const[i,c]=p.useState(""),[l,d]=p.useState([]),h=s==="record",u=m=>{if(c(m),m&&a)try{const y=new RegExp(m,"g"),g=a.match(y)||[];d(g.slice(0,3))}catch{d([])}else d([])},f=()=>{i&&(h?o(e.id,{pattern:i}):r(i))};return t.jsxs("div",{"data-test":"regex-action-section",children:[t.jsx("div",{className:Ie("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",h&&n&&"bg-primary/10 border border-primary",!h&&"hover:bg-accent"),"data-test":"regex-action-row",children:t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]})}),t.jsxs("div",{className:"px-3 py-1.5 space-y-1","data-test":"regex-input-section",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ze,{type:"text",value:i,onChange:m=>u(m.target.value),placeholder:"Enter regex pattern...",className:"h-6 text-xs flex-1",onClick:m=>m.stopPropagation(),"data-test":"regex-pattern-input"}),t.jsx(se,{size:"sm",variant:"secondary",className:"h-6 text-xs px-2",onClick:m=>{m.stopPropagation(),f()},disabled:!i,"data-test":"regex-split-button",children:"Split"})]}),l.length>0&&t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:["Matches: ",l.map(m=>`"${m}"`).join(", "),l.length===3&&"..."]})]})]})}function $x({action:e,mode:s,isSelected:n,onSelect:o,onSplitSmartComma:r}){const[a,i]=p.useState(3),c=s==="record",l=()=>{c?o(e.id,{minWords:a}):r(a)};return t.jsxs("div",{"data-test":"smart-comma-action-section",className:"px-3 py-1.5",children:[t.jsxs("div",{className:Ie("flex items-center gap-2 text-sm",c&&n&&"text-primary"),"data-test":"smart-comma-action-row",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 mt-1",onPointerDown:d=>d.stopPropagation(),children:[t.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Min words:"}),t.jsx(ze,{type:"number",min:"1",max:"20",value:a,onChange:d=>i(Math.max(1,parseInt(d.target.value)||3)),className:"h-5 w-10 text-xs px-1",onClick:d=>d.stopPropagation(),"data-test":"smart-comma-min-words-input"}),t.jsx(se,{size:"sm",variant:"secondary",className:"h-5 text-[10px] px-2",onClick:d=>{d.stopPropagation(),l()},"data-test":"smart-comma-split-button",children:"Split"})]})]})}class _x{constructor(s,n,o=""){qe(this,"namespace","canvas.split");this.hooks=s,this.storeActions=n,this.selectedNodeContent=o}getActions(){return[{id:"byParagraph",label:"Paragraph",category:"Node Split",icon:t.jsx(El,{className:"h-3.5 w-3.5"})},{id:"byLine",label:"Line",category:"Node Split",icon:t.jsx(Na,{className:"h-3.5 w-3.5"})},{id:"byComma",label:"Comma",category:"Node Split",icon:t.jsx(_h,{className:"h-3.5 w-3.5"})},{id:"byPeriod",label:"Period",category:"Node Split",icon:t.jsx(Uh,{className:"h-3.5 w-3.5"})},{id:"bySpecial",label:"Special",category:"Node Split",icon:t.jsx(oo,{className:"h-3.5 w-3.5"})},{id:"byWhitespace",label:"Whitespace",category:"Node Split",icon:t.jsx(Vh,{className:"h-3.5 w-3.5"})},{id:"byRegex",label:"Regex",category:"Node Split",icon:t.jsx(Gh,{className:"h-3.5 w-3.5"}),params:[{name:"pattern",type:"string",label:"Regex Pattern",default:""}],customRender:s=>t.jsx(zx,{...s,onSplitRegex:this.hooks.splitByRegex,selectedNodeContent:this.selectedNodeContent})},{id:"textBySentence",label:"Sentence",category:"Text Split",icon:t.jsx(Yh,{className:"h-3.5 w-3.5"})},{id:"textBySmartComma",label:"Smart Comma",category:"Text Split",icon:t.jsx(Xh,{className:"h-3.5 w-3.5"}),params:[{name:"minWords",type:"number",label:"Minimum Words",default:3}],customRender:s=>t.jsx($x,{...s,onSplitSmartComma:this.hooks.textSplitBySmartComma})},{id:"textBySmartChar",label:"Smart Char",category:"Text Split",icon:t.jsx(Kh,{className:"h-3.5 w-3.5"})},{id:"textByAll",label:"All",category:"Text Split",icon:t.jsx(_s,{className:"h-3.5 w-3.5"})}]}getConfig(){return{keepArrows:this.storeActions.getKeepArrows(),keepMatch:this.storeActions.getKeepMatch(),horizontal:this.storeActions.getHorizontal(),gap:this.storeActions.getGap()}}setConfig(s){s.keepArrows!==void 0&&this.storeActions.setKeepArrows(s.keepArrows),s.keepMatch!==void 0&&this.storeActions.setKeepMatch(s.keepMatch),s.horizontal!==void 0&&this.storeActions.setHorizontal(s.horizontal),s.gap!==void 0&&this.storeActions.setGap(s.gap)}execute(s,n){switch(s){case"byParagraph":this.hooks.splitByParagraph();break;case"byLine":this.hooks.splitByLine();break;case"byComma":this.hooks.splitByComma();break;case"byPeriod":this.hooks.splitByPeriod();break;case"byWhitespace":this.hooks.splitByWhitespace();break;case"bySpecial":this.hooks.splitBySpecial();break;case"byRegex":n!=null&&n.pattern&&this.hooks.splitByRegex(n.pattern);break;case"textBySentence":this.hooks.textSplitBySentence();break;case"textBySmartComma":this.hooks.textSplitBySmartComma((n==null?void 0:n.minWords)??3);break;case"textBySmartChar":this.hooks.textSplitBySmartChar();break;case"textByAll":this.hooks.textSplitByAll(3);break;default:console.warn(`Unknown split action: ${s}`)}}}class Ux{constructor(){qe(this,"sources",new Map)}register(s,n){this.sources.set(s,n)}unregister(s){this.sources.delete(s)}has(s){return this.sources.has(s)}getAllActions(){return Array.from(this.sources.values()).map(s=>({source:s.name,actions:s.getActions()}))}get size(){return this.sources.size}getKeys(){return Array.from(this.sources.keys())}}const pt=new Ux;function Ad(){const e=$(w=>{var v;return((v=w.preferences)==null?void 0:v.keepArrowsOnSplit)??!1}),s=$(w=>{var v;return((v=w.preferences)==null?void 0:v.keepSplitMatch)??!1}),n=$(w=>{var v;return((v=w.preferences)==null?void 0:v.splitHorizontally)??!1}),o=$(w=>{var v;return((v=w.preferences)==null?void 0:v.splitNodeGap)??15}),r=$(w=>w.setKeepArrowsOnSplit),a=$(w=>w.setKeepSplitMatch),i=$(w=>w.setSplitHorizontally),c=$(w=>w.setSplitNodeGap),l=Mx(e,s,n,o),d=Bx(),u=T.getState().projectCanvas.getActive(),f=(u==null?void 0:u.coreState.selectedNodes)??[],m=f.length===1&&typeof f[0].content=="string"?f[0].content:"",y=p.useMemo(()=>({splitByParagraph:l.splitNodeContentByParagraph,splitByLine:l.splitNodeContentByLine,splitByComma:l.splitNodeContentByComma,splitByPeriod:l.splitNodeContentByPeriod,splitByWhitespace:l.splitNodeContentByWhitespace,splitBySpecial:l.splitNodeContentByCustomCharacter,splitByRegex:l.splitNodeContentByRegex,textSplitBySentence:d.splitInsideBySentence,textSplitBySmartComma:d.splitInsideBySmartComma,textSplitBySmartChar:d.splitInsideBySmartCharacter,textSplitByAll:d.splitInsideByAll}),[l.splitNodeContentByParagraph,l.splitNodeContentByLine,l.splitNodeContentByComma,l.splitNodeContentByPeriod,l.splitNodeContentByWhitespace,l.splitNodeContentByCustomCharacter,l.splitNodeContentByRegex,d.splitInsideBySentence,d.splitInsideBySmartComma,d.splitInsideBySmartCharacter,d.splitInsideByAll]),g=p.useMemo(()=>({getKeepArrows:()=>{var w;return((w=T.getState().preferences)==null?void 0:w.keepArrowsOnSplit)??!1},setKeepArrows:r,getKeepMatch:()=>{var w;return((w=T.getState().preferences)==null?void 0:w.keepSplitMatch)??!1},setKeepMatch:a,getHorizontal:()=>{var w;return((w=T.getState().preferences)==null?void 0:w.splitHorizontally)??!1},setHorizontal:i,getGap:()=>{var w;return((w=T.getState().preferences)==null?void 0:w.splitNodeGap)??15},setGap:c}),[r,a,i,c]),x=p.useMemo(()=>new _x(y,g,m),[y,g,m]);return p.useEffect(()=>(pt.register("split",{name:"Split",getActions:()=>x.getActions()}),at.register("split",x),()=>{pt.unregister("split"),at.unregister("split")}),[x]),x}function Vx({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a}){const i=s==="record",c=e.subActions&&e.subActions.length>0;return t.jsxs("div",{className:Ie("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",i&&n&&"bg-primary/10 border border-primary",!i&&"hover:bg-accent"),"data-test":"toolbar-action-row",children:[t.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>o(e.id),"data-test":"toolbar-action-button",children:[e.icon,t.jsx("span",{children:e.label})]}),c&&t.jsx("div",{className:"flex items-center gap-0.5 ml-2",children:e.subActions.map(l=>t.jsx(se,{variant:"outline",size:"icon",className:Ie("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",i&&n&&l.id===e.id&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),o(l.id)},title:l.title,"data-test":"toolbar-sub-action",children:l.icon},l.id))})]})}function fa({facade:e,mode:s,selectedActionId:n,selectedActionParams:o,onActionSelect:r,onActionExecuted:a,showConfig:i=!1,configOverride:c,onConfigChange:l,categories:d,className:h}){const u=e.getActions(),f=d?u.filter(N=>d.includes(N.category||"Other")):u,m=e.getConfig(),y=c??m,g=(N,b)=>{var A,R;if(s==="execute"){if(e.execute(N,b),a){const k=f.find(E=>{var C;return E.id===N||((C=E.subActions)==null?void 0:C.some(I=>I.id===N))}),S=((R=(A=k==null?void 0:k.subActions)==null?void 0:A.find(E=>E.id===N))==null?void 0:R.title)??(k==null?void 0:k.label)??N;a(S,()=>e.execute(N,b))}}else r==null||r(N,b)},x=N=>{l?l(N):e.setConfig(N)},w=f.reduce((N,b)=>{const A=b.category||"Other";return N[A]||(N[A]=[]),N[A].push(b),N},{}),v=Object.keys(w);return t.jsx("div",{className:Ie("flex flex-col",h),"data-test":"toolbar-actions-panel",children:v.map((N,b)=>t.jsxs("div",{"data-test":"action-category",children:[b>0&&t.jsx("div",{className:"h-px bg-border my-1"}),v.length>1&&t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:N}),w[N].map(A=>{var k;const R=n===A.id||(((k=A.subActions)==null?void 0:k.some(S=>S.id===n))??!1);return A.customRender?t.jsx(He.Fragment,{children:A.customRender({action:A,mode:s,isSelected:R,onSelect:g,config:y,onConfigChange:x})},A.id):t.jsx(Vx,{action:A,mode:s,isSelected:R,onSelect:g,config:y,onConfigChange:x},A.id)})]},N))})}const Gx=[],Yx=[];function Xx({currentConfig:e,onConfigChange:s,facade:n,onExecuteSplit:o,canExecute:r}){const a=p.useCallback((l,d)=>{const u={byParagraph:"paragraph",byLine:"line",byComma:"comma",byPeriod:"period",bySpecial:"custom",byWhitespace:"whitespace",byRegex:"regex"}[l];u&&(s({splitMode:u}),d!=null&&d.pattern&&s({regexPattern:d.pattern}))},[s]),i=p.useMemo(()=>({keepArrows:e.keepArrowsOnSplit,keepMatch:e.keepSplitMatch,horizontal:e.splitHorizontally,gap:e.splitNodeGap}),[e]),c={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex"};return t.jsxs("div",{className:"space-y-2","data-test":"split-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"split-action-selector",children:t.jsx(fa,{facade:n,mode:"record",selectedActionId:c[e.splitMode],onActionSelect:a,configOverride:i,onConfigChange:l=>{l.keepArrows!==void 0&&s({keepArrowsOnSplit:l.keepArrows}),l.keepMatch!==void 0&&s({keepSplitMatch:l.keepMatch}),l.horizontal!==void 0&&s({splitHorizontally:l.horizontal}),l.gap!==void 0&&s({splitNodeGap:l.gap})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepArrowsOnSplit,onChange:l=>s({keepArrowsOnSplit:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Arrows"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepSplitMatch,onChange:l=>s({keepSplitMatch:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Match"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.splitHorizontally,onChange:l=>s({splitHorizontally:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Horiz"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Gap:"}),t.jsx(ze,{type:"number",min:"0",max:"100",value:e.splitNodeGap,onChange:l=>s({splitNodeGap:Math.max(0,parseInt(l.target.value)||15)}),className:"h-5 w-12 text-[10px] px-1","data-test":"split-config-gap"})]})]}),t.jsxs(se,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(c[e.splitMode]),disabled:!r,"data-test":"split-execute-button",children:[t.jsx(ft,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function Kx({isVisible:e,onClose:s,triggerPosition:n,currentSplitMode:o,currentRegexPattern:r,onSplitAction:a}){const i=Ad(),c=p.useCallback(P=>{var j,M;return((M=(j=P.preferences)==null?void 0:j.splitPresets)==null?void 0:M.presets)??Gx},[]),l=$(c),d=$(P=>{var j,M;return((M=(j=P.preferences)==null?void 0:j.splitPresets)==null?void 0:M.favoriteIds)??Yx}),h=$(P=>{var j,M;return((M=(j=P.preferences)==null?void 0:j.splitPresets)==null?void 0:M.activePresetId)??null}),u=$(P=>{var j;return((j=P.preferences)==null?void 0:j.keepArrowsOnSplit)??!1}),f=$(P=>{var j;return((j=P.preferences)==null?void 0:j.keepSplitMatch)??!1}),m=$(P=>{var j;return((j=P.preferences)==null?void 0:j.splitHorizontally)??!1}),y=$(P=>{var j;return((j=P.preferences)==null?void 0:j.splitNodeGap)??15}),g=$(P=>P.setKeepArrowsOnSplit),x=$(P=>P.setKeepSplitMatch),w=$(P=>P.setSplitHorizontally),v=$(P=>P.setSplitNodeGap),N=$(P=>P.createSplitPreset),b=$(P=>P.updateSplitPreset),A=$(P=>P.duplicateSplitPreset),R=$(P=>P.deleteSplitPreset),k=$(P=>P.renameSplitPreset),S=$(P=>P.applySplitPreset),E=$(P=>P.toggleSplitPresetFavorite),C=$(P=>P.setActiveSplitPresetId),I=p.useMemo(()=>({getAll:()=>l,getById:P=>l.find(j=>j.id===P),getFavorites:()=>l.filter(P=>d.includes(P.id)),getFavoriteIds:()=>d,getActiveId:()=>h,create:(P,j)=>N(P,j),update:(P,j)=>{b(P,j)},updateConfig:(P,j)=>{const M=l.find(B=>B.id===P);M&&b(P,{config:{...M.config,...j}})},duplicate:P=>A(P),delete:P=>{R(P)},rename:(P,j)=>{k(P,j)},reorder:P=>{},apply:P=>{S(P)},setActive:P=>{C(P)},toggleFavorite:P=>{E(P)},isFavorite:P=>d.includes(P)}),[l,d,h,N,b,A,R,k,S,C,E]),O=p.useCallback(()=>({splitMode:o,regexPattern:o==="regex"?r:void 0,keepArrowsOnSplit:u,keepSplitMatch:f,splitHorizontally:m,splitNodeGap:y}),[o,r,u,f,m,y]),H=p.useCallback(P=>{a&&(a(P),Ee.success("Executed split action"))},[a]),L=p.useCallback(P=>{a?(requestAnimationFrame(()=>{a(P.config.splitMode)}),Ee.success(`Applied and executed "${P.name}" (${P.config.splitMode})`)):Ee.success(`Applied preset "${P.name}" settings`)},[a]),W=p.useCallback(P=>{const j=M=>{P.onConfigChange(M),M.keepArrowsOnSplit!==void 0&&g(M.keepArrowsOnSplit),M.keepSplitMatch!==void 0&&x(M.keepSplitMatch),M.splitHorizontally!==void 0&&w(M.splitHorizontally),M.splitNodeGap!==void 0&&v(M.splitNodeGap)};return t.jsx(Xx,{...P,onConfigChange:j,facade:i,onExecuteSplit:H,canExecute:!!a})},[i,H,a,g,x,w,v]);return t.jsx(Id,{isVisible:e,onClose:s,triggerPosition:n,title:"Split Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:W,getCurrentConfig:O,presetActions:I,onApplyPreset:L})}const rc="canvas-split-regex-history",ic="canvas-split-before-enabled",qx=10,Zx=({onSplit:e,selectedNodeContent:s=""})=>{const n=p.useCallback(()=>{try{const g=localStorage.getItem(rc);return g?JSON.parse(g):[]}catch{return[]}},[]),[o,r]=p.useState(()=>n()[0]||""),[a,i]=p.useState(()=>{try{return localStorage.getItem(ic)==="true"}catch{return!1}}),[c,l]=p.useState(null),[d,h]=p.useState(0);p.useEffect(()=>{try{localStorage.setItem(ic,String(a))}catch(g){console.warn("Failed to save split before preference",g)}},[a]);const u=p.useCallback((g,x)=>g?x?`\\n(?=${g})`:g:"",[]),f=p.useCallback(g=>{if(!g)return;const w=n().filter(N=>N!==g),v=[g,...w].slice(0,qx);try{localStorage.setItem(rc,JSON.stringify(v))}catch(N){console.warn("Failed to save regex history",N)}},[n]);p.useEffect(()=>{if(!o){l(null),h(0);return}try{const g=u(o,a),x=new RegExp(`(${g})`,"g");if(l(!0),s){const w=s.match(x);h(w?w.length:0)}else h(0)}catch{l(!1),h(0)}},[o,s,a,u]);const m=p.useCallback(()=>{if(!o||!c)return;f(o);const g=u(o,a);e(g)},[o,c,e,f,a,u]),y=p.useCallback(g=>{g.key==="Enter"&&(g.preventDefault(),g.stopPropagation(),m())},[m]);return t.jsxs("div",{className:"regex-split-item px-1 py-1 space-y-0.5",onPointerDown:g=>{g.stopPropagation()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsx("span",{className:"text-xs text-foreground",children:"Regex"}),t.jsx("button",{onPointerDown:g=>{g.stopPropagation(),m()},disabled:!c,className:Ie("p-0.5 rounded transition-colors",c?"hover:bg-accent text-accent-foreground cursor-pointer":"opacity-50 cursor-not-allowed"),title:"Execute split",style:{touchAction:"none"},"data-test":"regex-split-execute-button",children:t.jsx(ft,{className:"h-2.5 w-2.5"})})]}),t.jsxs("div",{className:"relative px-1",children:[t.jsx("input",{type:"text",value:o,onChange:g=>r(g.target.value),onKeyDown:y,placeholder:"Art \\d+",className:Ie("w-full px-1.5 py-0.5 text-[10px] border rounded h-5","bg-background text-foreground","focus:outline-none focus:ring-1 focus:ring-primary",c===!1&&"border-destructive focus:ring-destructive",c===!0&&"border-green-500 focus:ring-green-500"),onPointerDown:g=>{g.stopPropagation()},style:{touchAction:"auto"},"data-test":"regex-split-pattern-input"}),t.jsxs("div",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none",children:[c===!0&&t.jsx(vn,{className:"h-2 w-2 text-green-500"}),c===!1&&t.jsx(Zo,{className:"h-2 w-2 text-destructive"})]})]}),t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsxs("label",{className:"flex items-center gap-1 text-[9px] cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:g=>i(g.target.checked),className:"w-2 h-2 cursor-pointer",onPointerDown:g=>{g.stopPropagation()},"data-test":"regex-split-before-checkbox"}),t.jsx("span",{className:"text-muted-foreground",children:"Before"})]}),c&&d>0&&t.jsx("span",{className:"text-[9px] text-muted-foreground",children:d}),c===!1&&o&&t.jsx("span",{className:"text-[9px] text-destructive",children:"!"})]})]})},Jx=[],Qx=[],ey=e=>{const{className:s}=e,n=Ad(),o=$(j=>{var M;return((M=j.preferences)==null?void 0:M.keepArrowsOnSplit)??!1}),r=$(j=>j.setKeepArrowsOnSplit),a=$(j=>{var M;return((M=j.preferences)==null?void 0:M.keepSplitMatch)??!1}),i=$(j=>j.setKeepSplitMatch),c=$(j=>{var M;return((M=j.preferences)==null?void 0:M.splitHorizontally)??!1}),l=$(j=>j.setSplitHorizontally),d=$(j=>{var M;return((M=j.preferences)==null?void 0:M.splitNodeGap)??15}),h=$(j=>j.setSplitNodeGap),u=$(j=>{var M,B;return((B=(M=j.preferences)==null?void 0:M.splitPresets)==null?void 0:B.presets)??Jx}),f=$(j=>{var M,B;return((B=(M=j.preferences)==null?void 0:M.splitPresets)==null?void 0:B.favoriteIds)??Qx}),m=$(j=>j.applySplitPreset),y=p.useMemo(()=>u.filter(j=>f.includes(j.id)),[u,f]),[g,x]=p.useState(!1),[w,v]=p.useState(),N=p.useRef(null),b=p.useCallback(()=>{if(N.current){const j=N.current.getBoundingClientRect();v({x:j.left,y:j.bottom+4})}x(!0)},[]),A=p.useCallback(()=>{x(!1)},[]),R=p.useCallback(j=>{const B={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex","text:sentence":"textBySentence","text:smartComma":"textBySmartComma","text:smartChar":"textBySmartChar","text:all":"textByAll"}[j]||j;n.execute(B)},[n]),k=p.useCallback(j=>{const M=u.find(B=>B.name===j);return M?()=>{m(M.id),R(M.config.splitMode)}:null},[u,m,R]),E=T.getState().projectCanvas.getActive(),C=(E==null?void 0:E.coreState.selectedNodes)??[],I=C.length===1&&typeof C[0].content=="string"?C[0].content:"",O=n.getActions(),H=O.filter(j=>j.category==="Node Split"&&j.id!=="byRegex"),L=O.filter(j=>j.category==="Text Split"),W=[{header:"Node",width:"150px",actions:[...H.map(j=>({label:j.label,icon:j.icon,onClick:()=>n.execute(j.id)})),{label:"Regex",customRender:()=>t.jsx(Zx,{onSplit:j=>n.execute("byRegex",{pattern:j}),selectedNodeContent:I})}]},{header:"Text",width:"150px",actions:L.map(j=>j.customRender?{label:j.label,customRender:()=>j.customRender({action:j,mode:"execute",isSelected:!1,onSelect:(M,B)=>n.execute(M,B),config:{},onConfigChange:()=>{}})}:{label:j.label,icon:j.icon,onClick:()=>n.execute(j.id)})},{header:"Config",width:"150px",actions:[{label:"Presets",customRender:({registerRepeatAction:j})=>t.jsxs("div",{"data-test":"split-presets-section",className:"mt-1 pt-1",children:[t.jsxs("button",{ref:N,className:"flex items-center gap-2 w-full px-1 py-1 text-sm rounded-sm hover:bg-accent text-left",onClick:b,"data-test":"split-presets-button",children:[t.jsx(Pr,{className:"h-3 w-3"}),t.jsx("span",{className:"text-xs",children:"Presets"})]}),y.length>0&&t.jsxs("div",{className:"px-1 py-1","data-test":"split-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"split-favorite-presets-grid",children:y.map(M=>t.jsxs(se,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:B=>{B.stopPropagation(),m(M.id),R(M.config.splitMode),j(M.name,()=>{m(M.id),R(M.config.splitMode)})},title:`Apply & Execute: ${M.name}`,"data-test":"split-favorite-preset-button",children:[t.jsx(ft,{className:"h-2 w-2 mr-1"}),M.name]},M.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},{label:"Keep arrows",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:j=>r(j.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-[10px]",children:"Keep arrows"})]})},{label:"Keep match",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:j=>i(j.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-[10px]",children:"Keep match"})]})},{label:"Horizontal",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:j=>l(j.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-[10px]",children:"Horizontal"})]})},{label:"Gap",customRender:()=>t.jsxs("div",{className:"flex items-center gap-1 px-1 py-0.5",children:[t.jsx("span",{className:"text-[10px]",children:"Gap:"}),t.jsx(ze,{type:"number",min:"0",max:"100",value:d,onChange:j=>h(Math.max(0,parseInt(j.target.value)||15)),className:"h-5 w-12 text-[10px] px-1",onClick:j=>j.stopPropagation(),"data-test":"split-config-gap"}),t.jsx("span",{className:"text-[10px]",children:"px"})]})}]}],P={label:"Split",icon:t.jsx(qh,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("byParagraph")};return t.jsxs(t.Fragment,{children:[t.jsx("div",{id:"CanvasTextSplitButtonContainer",className:Ie("flex items-center",s),"data-test":"toolbar-split-button",children:t.jsx(rt,{mainAction:P,dropdownColumns:W,variant:"outline",size:"compact",persistenceKey:"toolbar-split-button",facade:n,restoreRepeatAction:k,"data-test":"canvas-split-nodes-button"})}),t.jsx(Kx,{isVisible:g,onClose:A,triggerPosition:w,currentSplitMode:"paragraph",onSplitAction:R})]})};class ty{constructor(s,n){qe(this,"namespace","canvas.textFormatting");this.hooks=s,this.storeActions=n}getActions(){return[{id:"style:bold",label:"Bold",category:"Style",icon:t.jsx(Rl,{className:"h-3 w-3"})},{id:"style:italic",label:"Italic",category:"Style",icon:t.jsx(Ml,{className:"h-3 w-3"})},{id:"style:strikethrough",label:"Strikethrough",category:"Style",icon:t.jsx(Pl,{className:"h-3 w-3"})},{id:"heading:h1",label:"Heading 1",category:"Headings",icon:t.jsx(Dl,{className:"h-3 w-3"})},{id:"heading:h2",label:"Heading 2",category:"Headings",icon:t.jsx(Ol,{className:"h-3 w-3"})},{id:"heading:h3",label:"Heading 3",category:"Headings",icon:t.jsx(Ll,{className:"h-3 w-3"})},{id:"list:bullet",label:"Bullet list",category:"Lists",icon:t.jsx(fo,{className:"h-3 w-3"})},{id:"list:numbered",label:"Numbered list",category:"Lists",icon:t.jsx(Bs,{className:"h-3 w-3"})},{id:"list:indent",label:"Indent",category:"Lists",icon:t.jsx(Wl,{className:"h-3 w-3"})},{id:"list:outdent",label:"Outdent",category:"Lists",icon:t.jsx(Hl,{className:"h-3 w-3"})},{id:"style:fontSize:small",label:"Small",category:"Font Size",icon:t.jsx(Zt,{className:"h-3 w-3"})},{id:"style:fontSize:normal",label:"Normal",category:"Font Size",icon:t.jsx(Zt,{className:"h-3 w-3"})},{id:"style:fontSize:large",label:"Large",category:"Font Size",icon:t.jsx(Zt,{className:"h-3 w-3"})},{id:"style:fontSize:xlarge",label:"X-Large",category:"Font Size",icon:t.jsx(Zt,{className:"h-3 w-3"})}]}getConfig(){return{firstLineOnly:this.storeActions.getFirstLineOnly()}}setConfig(s){s.firstLineOnly!==void 0&&this.storeActions.setFirstLineOnly(s.firstLineOnly)}execute(s,n){switch(s){case"style:bold":this.hooks.applyBold();break;case"style:italic":this.hooks.applyItalic();break;case"style:strikethrough":this.hooks.applyStrikethrough();break;case"heading:h1":this.hooks.applyH1();break;case"heading:h2":this.hooks.applyH2();break;case"heading:h3":this.hooks.applyH3();break;case"list:bullet":this.hooks.applyUnorderedList();break;case"list:numbered":this.hooks.applyOrderedList();break;case"list:indent":this.hooks.applyIndent();break;case"list:outdent":this.hooks.applyOutdent();break;case"style:fontSize:small":this.hooks.applyFontSize("small");break;case"style:fontSize:normal":this.hooks.applyFontSize("normal");break;case"style:fontSize:large":this.hooks.applyFontSize("large");break;case"style:fontSize:xlarge":this.hooks.applyFontSize("xlarge");break;default:console.warn(`TextFormattingFacade: Unknown action "${s}"`)}}}const Lt=e=>{const s=at.get("textFormatting");s?s.execute(e):console.warn(`TextFormattingFacade: Facade not registered, cannot execute "${e}"`)};dt("style:bold",()=>Lt("style:bold"));dt("style:italic",()=>Lt("style:italic"));dt("style:strikethrough",()=>Lt("style:strikethrough"));dt("heading:h1",()=>Lt("heading:h1"));dt("heading:h2",()=>Lt("heading:h2"));dt("heading:h3",()=>Lt("heading:h3"));dt("list:bullet",()=>Lt("list:bullet"));dt("list:numbered",()=>Lt("list:numbered"));dt("list:indent",()=>Lt("list:indent"));dt("list:outdent",()=>Lt("list:outdent"));dt("style:fontSize:small",()=>Lt("style:fontSize:small"));dt("style:fontSize:normal",()=>Lt("style:fontSize:normal"));dt("style:fontSize:large",()=>Lt("style:fontSize:large"));dt("style:fontSize:xlarge",()=>Lt("style:fontSize:xlarge"));function qa(e,s,n,o,r){const a=e.substring(0,s),i=e.substring(s,n),c=e.substring(n),l=o.length,d=r.length;return s>=l&&a.endsWith(o)&&c.startsWith(r)?{newText:a.substring(0,a.length-l)+i+c.substring(d),newStart:s-l,newEnd:n-l}:{newText:a+o+i+r+c,newStart:s+l,newEnd:n+l}}function sy(e,s,n){const o=s==="1. "&&n!==void 0?`${n}. `:s;if(s==="1. "){const i=/^\d+\.\s/.exec(e);if(i)return e.substring(i[0].length)}else if(e.startsWith(s))return e.substring(s.length);const r=/^(#{1,3}\s)/.exec(e);if(r&&s.startsWith("#"))return o+e.substring(r[1].length);const a=/^(\s*[-*]\s|\s*\d+\.\s)/.exec(e);return a&&(s==="- "||/^\d+\.\s/.exec(s))?o+e.substring(a[1].length):o+e}function En(e,s,n,o=!1){const r=e.split(`
`);if(o){const u=n==="1. ",f=r.every(y=>u?/^\d+\.\s/.test(y):y.startsWith(n));return{newText:r.map((y,g)=>{if(f){if(u){const x=/^\d+\.\s/.exec(y);return x?y.substring(x[0].length):y}return y.startsWith(n)?y.substring(n.length):y}return sy(y,n,u?g+1:void 0)}).join(`
`),newCursorPos:0}}let a=0,i=0;for(let u=0;u<r.length;u++){if(a+r[u].length>=s){i=u;break}a+=r[u].length+1}const c=r[i],l=a;if(c.startsWith(n)){r[i]=c.substring(n.length);const u=Math.max(l,s-n.length);return{newText:r.join(`
`),newCursorPos:u}}const d=/^(#{1,3}\s)/.exec(c);if(d&&n.startsWith("#")){r[i]=n+c.substring(d[1].length);const u=n.length-d[1].length;return{newText:r.join(`
`),newCursorPos:s+u}}const h=/^(\s*[-*]\s|\s*\d+\.\s)/.exec(c);if(h&&(n==="- "||/^\d+\.\s/.exec(n))){r[i]=n+c.substring(h[1].length);const u=n.length-h[1].length;return{newText:r.join(`
`),newCursorPos:s+u}}return r[i]=n+c,{newText:r.join(`
`),newCursorPos:s+n.length}}function ny(e,s){if(s)return"  "+e;{let n=0;for(let o=0;o<Math.min(2,e.length)&&e[o]===" ";o++)n++;return n>0?e.substring(n):e}}function cc(e,s,n,o=!1){const r=e.split(`
`);if(o)return{newText:r.map(d=>ny(d,n)).join(`
`),newCursorPos:0};let a=0,i=0;for(let l=0;l<r.length;l++){if(a+r[l].length>=s){i=l;break}a+=r[l].length+1}const c=r[i];if(n)return r[i]="  "+c,{newText:r.join(`
`),newCursorPos:s+2};{let l=0;for(let d=0;d<Math.min(2,c.length)&&c[d]===" ";d++)l++;return l>0?(r[i]=c.substring(l),{newText:r.join(`
`),newCursorPos:Math.max(a,s-l)}):{newText:e,newCursorPos:s}}}const Td=(e=!0)=>{const{fitNodeDimensions:s}=bn(),n=p.useCallback(r=>{const a=T.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length!==1){console.warn("useTextFormatting: Expected exactly one selected node");return}const l=c[0],d=typeof l.content=="string"?l.content:"",h=0,u=d.length,f=!e;let m;switch(r){case"bold":m=qa(d,h,u,"**","**");break;case"italic":m=qa(d,h,u,"_","_");break;case"strikethrough":m=qa(d,h,u,"~~","~~");break;case"h1":{const y=En(d,h,"# ",f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}case"h2":{const y=En(d,h,"## ",f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}case"h3":{const y=En(d,h,"### ",f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}case"unorderedList":{const y=En(d,h,"- ",f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}case"orderedList":{const y=En(d,h,"1. ",f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}case"indent":{const y=cc(d,h,!0,f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}case"outdent":{const y=cc(d,h,!1,f);m={newText:y.newText,newCursorPos:y.newCursorPos};break}default:return}a.updateNodeContent(l.id,m.newText),setTimeout(()=>{const y=T.getState().getNodeById(l.id);y&&s([y])},10)},[s,e]),o=p.useCallback(r=>{const a=T.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length===0){console.warn("useTextFormatting: No nodes selected for font size change");return}const l=ke.FONT_SIZE_PRESETS[r],d=`${l}px`,h=Math.round(l*1.5),u=[],f=[...c].sort((v,N)=>v.y-N.y),m=Math.min(...c.map(v=>v.x)),y=Math.min(...c.map(v=>v.y)),g=.1,x=["BEFORE font size change:"];for(const v of f){const N=Math.round((v.x-m)*g),b=Math.round((v.y-y)*g),A=Math.round((v.width??0)*g),R=Math.round((v.height??0)*g),k=" ".repeat(N);x.push(`y=${b.toString().padStart(3)}: ${k}[${v.id.slice(-4)} w:${A} h:${R}]`)}for(const v of c.filter(N=>N.type!==fe.CHAT)){const N=v.styles??{},b=v.height,A={...N,fontSize:d},R=(typeof v.content=="string"?v.content:"").replace(/\n+$/,""),k=window.getComputedStyle(document.body),S=k.fontFamily,C=`${k.fontWeight} ${l}px ${S}`,I=bs(R,C)+Ns.textNodeXPadding,O=Math.max(v.width??ke.DEFAULT_NODE_WIDTH,I),L=ri(R,O,C,h)+ke.NODE_Y_PADDING;u.push({type:"node:update",nodeId:v.id,from:{styles:N,height:b,width:v.width},to:{styles:A,height:L,width:O}}),a.updateNode(v.id,{styles:A,height:L,width:O})}u.length===1?a.undo.commit(u[0]):u.length>1&&a.undo.commit({type:"batch",label:`Apply ${r} font size to ${u.length} nodes`,operations:u});const w=c.filter(v=>v.type!==fe.CHAT);if(w.length>1){const v=(w[0].height??32)/2,N=new Map;for(const R of w){let k=!1;for(const[S,E]of N)if(Math.abs(R.y-S)<=v){E.push(R),k=!0;break}k||N.set(R.y,[R])}const b=Array.from(N.keys()).sort((R,k)=>R-k),A=[];for(let R=1;R<b.length;R++){const k=b[R-1],S=b[R],E=N.get(k)??[],C=Math.max(...E.map(O=>O.height??0)),I=S-k-C;A.push(I)}for(const[R,k]of N){if(k.length<=1)continue;const S=[...k].sort((I,O)=>I.x-O.x),E=S[0].x,C=[];for(let I=1;I<S.length;I++){const O=S[I-1],L=S[I].x-(O.x+(O.width??0));C.push(L)}setTimeout(()=>{const I=T.getState();let O=E;S.forEach((H,L)=>{const W=I.getNodeById(H.id);if(W){I.updateNode(H.id,{x:O});const P=C[L]??0;O+=(W.width??0)+P}})},10)}if(b.length>1){const R=new Map;for(const[E,C]of N){const I=C.map(W=>W.x),O=C.map(W=>W.width??0),H=Math.min(...I),L=Math.max(...I.map((W,P)=>W+O[P]));R.set(E,{minX:H,maxX:L})}const k=(E,C)=>{const I=R.get(E),O=R.get(C);return!I||!O?!1:I.minX<O.maxX&&O.minX<I.maxX};let S=!0;for(let E=1;E<b.length;E++)if(!k(b[E-1],b[E])){S=!1;break}if(S){const E=b[0];setTimeout(()=>{const C=T.getState();let I=E;b.forEach((O,H)=>{const L=N.get(O)??[];L.forEach(M=>{C.updateNode(M.id,{y:I})});const W=L.map(M=>C.getNodeById(M.id)).filter(M=>M!==null),P=Math.max(...W.map(M=>M.height??0)),j=A[H]??0;I+=P+j})},10)}}setTimeout(()=>{const R=T.getState(),k=w.map(H=>R.getNodeById(H.id)).filter(H=>H!==null),S=[...k].sort((H,L)=>H.y-L.y),E=Math.min(...k.map(H=>H.x)),C=Math.min(...k.map(H=>H.y)),I=.1,O=["AFTER repositioning:"];for(const H of S){const L=Math.round((H.x-E)*I),W=Math.round((H.y-C)*I),P=Math.round((H.width??0)*I),j=Math.round((H.height??0)*I),M=" ".repeat(L);O.push(`y=${W.toString().padStart(3)}: ${M}[${H.id.slice(-4)} w:${P} h:${j}]`)}},50)}},[]);return{applyBold:p.useCallback(()=>n("bold"),[n]),applyItalic:p.useCallback(()=>n("italic"),[n]),applyStrikethrough:p.useCallback(()=>n("strikethrough"),[n]),applyH1:p.useCallback(()=>n("h1"),[n]),applyH2:p.useCallback(()=>n("h2"),[n]),applyH3:p.useCallback(()=>n("h3"),[n]),applyUnorderedList:p.useCallback(()=>n("unorderedList"),[n]),applyOrderedList:p.useCallback(()=>n("orderedList"),[n]),applyIndent:p.useCallback(()=>n("indent"),[n]),applyOutdent:p.useCallback(()=>n("outdent"),[n]),applyFontSize:o,applyFontSizePx:p.useCallback(r=>{const a=T.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length===0){console.warn("useTextFormatting: No nodes selected for font size change");return}const l=`${r}px`,d=Math.round(r*1.5);for(const h of c.filter(u=>u.type!==fe.CHAT)){const f={...h.styles??{},fontSize:l},m=(typeof h.content=="string"?h.content:"").replace(/\n+$/,""),y=window.getComputedStyle(document.body),g=y.fontFamily,w=`${y.fontWeight} ${r}px ${g}`,v=bs(m,w)+Ns.textNodeXPadding,N=Math.max(h.width??ke.DEFAULT_NODE_WIDTH,v),A=ri(m,N,w,d)+ke.NODE_Y_PADDING;a.updateNode(h.id,{styles:f,height:A,width:N})}},[])}};function oy(){const[e,s]=p.useState(!1),{applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:h,applyOutdent:u,applyFontSize:f}=Td(e),m=p.useMemo(()=>({applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:h,applyOutdent:u,applyFontSize:f}),[n,o,r,a,i,c,l,d,h,u,f]),y=p.useCallback(()=>e,[e]),g=p.useMemo(()=>({getFirstLineOnly:y,setFirstLineOnly:s}),[y]),x=p.useMemo(()=>new ty(m,g),[m,g]);return p.useEffect(()=>(pt.register("textFormatting",{name:"Text Formatting",getActions:()=>x.getActions()}),at.register("textFormatting",x),()=>{pt.unregister("textFormatting"),at.unregister("textFormatting")}),[x]),{facade:x,firstLineOnly:e,setFirstLineOnly:s}}const ay=e=>{const{className:s}=e,{facade:n,firstLineOnly:o,setFirstLineOnly:r}=oy(),a={icon:t.jsx(Zt,{className:"h-4 w-4"}),onClick:()=>n.execute("style:bold"),label:"Text formatting"},i=[{header:"Style",width:"120px",actions:[{label:"Bold",icon:t.jsx(Rl,{className:"h-3 w-3"}),onClick:()=>n.execute("style:bold")},{label:"Italic",icon:t.jsx(Ml,{className:"h-3 w-3"}),onClick:()=>n.execute("style:italic")},{label:"Strikethrough",icon:t.jsx(Pl,{className:"h-3 w-3"}),onClick:()=>n.execute("style:strikethrough")}]},{header:"Headings",width:"120px",actions:[{label:"Heading 1",icon:t.jsx(Dl,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h1")},{label:"Heading 2",icon:t.jsx(Ol,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h2")},{label:"Heading 3",icon:t.jsx(Ll,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h3")}]},{header:"Lists",width:"130px",actions:[{label:"Bullet list",icon:t.jsx(fo,{className:"h-3 w-3"}),onClick:()=>n.execute("list:bullet")},{label:"Numbered list",icon:t.jsx(Bs,{className:"h-3 w-3"}),onClick:()=>n.execute("list:numbered")},{label:"Indent",icon:t.jsx(Wl,{className:"h-3 w-3"}),onClick:()=>n.execute("list:indent")},{label:"Outdent",icon:t.jsx(Hl,{className:"h-3 w-3"}),onClick:()=>n.execute("list:outdent")},{label:"First line only",icon:null,customRender:()=>t.jsx("div",{className:"px-2 py-1",onPointerDown:c=>c.stopPropagation(),children:t.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:c=>r(c.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:c=>c.stopPropagation(),"data-test":"toolbar-formatting-first-line-only-checkbox"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"First line only"})]})})}]}];return t.jsx("div",{className:Ie("flex items-center",s),"data-test":"toolbar-text-formatting-button",children:t.jsx(rt,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-text-formatting",facade:n,dropdownMenuClassName:"w-auto min-w-0"})})},ry="fontSize",Ed=[8,9,10,11,12,14,16,18,20,24,28,32,36,48,64,72,96];class iy{constructor(s){qe(this,"namespace","canvas.fontSize");this.hooks=s}getActions(){return[{id:"fontSize:small",label:"Small",category:"Font Size",icon:t.jsx(Zt,{className:"h-2.5 w-2.5"})},{id:"fontSize:normal",label:"Normal",category:"Font Size",icon:t.jsx(Zt,{className:"h-3 w-3"})},{id:"fontSize:large",label:"Large",category:"Font Size",icon:t.jsx(Zt,{className:"h-3.5 w-3.5"})},{id:"fontSize:xlarge",label:"X-Large",category:"Font Size",icon:t.jsx(Zt,{className:"h-4 w-4"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){if(s.startsWith("fontSize:px:")){const o=parseInt(s.replace("fontSize:px:",""),10);if(!isNaN(o)){this.hooks.applyFontSizePx(o);return}}switch(s){case"fontSize:small":this.hooks.applyFontSize("small");break;case"fontSize:normal":this.hooks.applyFontSize("normal");break;case"fontSize:large":this.hooks.applyFontSize("large");break;case"fontSize:xlarge":this.hooks.applyFontSize("xlarge");break;default:console.warn(`FontSizeFacade: Unknown action "${s}"`)}}}const wo=e=>{const s=at.get(ry);s?s.execute(e):console.warn(`FontSizeFacade: Facade not registered, cannot execute "${e}"`)};dt("fontSize:small",()=>wo("fontSize:small"));dt("fontSize:normal",()=>wo("fontSize:normal"));dt("fontSize:large",()=>wo("fontSize:large"));dt("fontSize:xlarge",()=>wo("fontSize:xlarge"));for(const e of Ed){const s=`fontSize:px:${e}`;dt(s,()=>wo(s))}const Io="fontSize";function cy(){const{applyFontSize:e,applyFontSizePx:s}=Td(!1),n=p.useMemo(()=>({applyFontSize:e,applyFontSizePx:s}),[e,s]),o=p.useMemo(()=>new iy(n),[n]);return p.useEffect(()=>(pt.register(Io,{name:"Font Size",getActions:()=>o.getActions()}),at.register(Io,o),()=>{pt.unregister(Io),at.unregister(Io)}),[o]),{facade:o}}const Ao={Small:ke.FONT_SIZE_PRESETS.small,Normal:ke.FONT_SIZE_PRESETS.normal,Large:ke.FONT_SIZE_PRESETS.large,"X-Large":ke.FONT_SIZE_PRESETS.xlarge},ly=e=>{var l,d;const{className:s}=e,{facade:n}=cy(),o=$(h=>{var u;return((u=h.projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??js}),r=o.length>0?parseInt(((d=(l=o[0].styles)==null?void 0:l.fontSize)==null?void 0:d.replace("px",""))??"16",10):null,a={icon:t.jsx(kn,{className:"h-4 w-4"}),onClick:()=>n.execute("fontSize:normal"),label:"Font size"},i=[{label:"Small",icon:t.jsx(kn,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("fontSize:small"),selected:r===Ao.Small},{label:"Normal",icon:t.jsx(kn,{className:"h-3 w-3"}),onClick:()=>n.execute("fontSize:normal"),selected:r===Ao.Normal},{label:"Large",icon:t.jsx(kn,{className:"h-3.5 w-3.5"}),onClick:()=>n.execute("fontSize:large"),selected:r===Ao.Large},{label:"X-Large",icon:t.jsx(kn,{className:"h-4 w-4"}),onClick:()=>n.execute("fontSize:xlarge"),selected:r===Ao["X-Large"]}],c=[{header:"Size",width:"60px",matchHeightToColumn:1,actions:Ed.map(h=>({label:`${h}`,icon:null,onClick:()=>n.execute(`fontSize:px:${h}`),selected:r===h}))},{header:"Presets",width:"90px",actions:i}];return t.jsx("div",{className:Ie("flex items-center",s),"data-test":"toolbar-font-size-button",children:t.jsx(rt,{mainAction:a,dropdownColumns:c,variant:"outline",size:"compact",persistenceKey:"toolbar-font-size",facade:n,dropdownMenuClassName:"w-auto min-w-0"})})},Za=e=>{let s="";if(typeof e.content=="string"&&(s+=e.content+`
`),e.subContent){if(typeof e.subContent=="string")s+=e.subContent+`
`;else if(typeof e.subContent=="object"&&"lines"in e.subContent){const{lines:n}=e.subContent;typeof n=="string"?s+=n+`
`:Array.isArray(n)&&n.forEach(o=>{typeof o=="string"?s+=o+`
`:o&&Array.isArray(o.words)&&(s+=o.words.join(" ")+`
`)})}}return s.trim()},dy=e=>{const{className:s,variant:n}=e,o=T.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.selectedNodes)??[],i=o.addNode,c=o.setNodeToFocusId,l=async(g,x)=>{if(a.length===0){console.log(`AI ${g}: No nodes selected.`);return}let w=a.map(Za).join(`

---

`);if(x&&(w=`${x}:

${w}`),!w.trim()){console.log(`AI ${g}: Selected nodes have no text content.`);return}console.log(`AI ${g} - Prompt:`,w);try{const v=await Du.generateCompletion(w,void 0,{stream:!1});console.log(`AI ${g} - Response:`,v);const N=v==null?void 0:v.response;if(typeof N=="string"&&N.trim()){let b={x:100,y:100};if(a.length>0){const R=a[0];b={x:R.x,y:R.y+(R.height??ke.DEFAULT_NODE_HEIGHT)+ke.nodeSpacing}}const A=Ye.buildTextNode(b,N);i(A),c(A.id),console.log(`AI ${g}: Created new node ${A.id} with AI response.`)}else(typeof N!="string"||!N.trim())&&console.log(`AI ${g}: Received empty or invalid response from AI.`)}catch(v){console.error(`AI ${g} - Error:`,v)}},d=()=>{l("Generate Text","Continue writing based on the following text")},h=()=>{l("Summarize Selection","Summarize the following text")},u=()=>{l("Ask Question","Based on the following, answer any implied questions or provide information")},f=async()=>{if(a.length===0){console.log("Translate to VN: No nodes selected.");return}const g=a.map(Za).join(`

`);if(!g.trim()){console.log("Translate to VN: Selected nodes have no text content.");return}console.log("Translate to VN - Input:",g);try{const x=await vi(g,"English","Vietnamese");console.log("Translate to VN - Response:",x);const w=x.output;if(w!=null&&w.trim()){let v={x:100,y:100};if(a.length>0){const b=a[0];v={x:b.x,y:b.y+(b.height??ke.DEFAULT_NODE_HEIGHT)+ke.nodeSpacing}}const N=Ye.buildTextNode(v,w);i(N),c(N.id),console.log(`Translate to VN: Created new node ${N.id} with Vietnamese translation.`)}else console.log("Translate to VN: Received empty translation.")}catch(x){console.error("Translate to VN - Error:",x)}},m=async()=>{if(a.length===0){console.log("Translate to EN: No nodes selected.");return}const g=a.map(Za).join(`

`);if(!g.trim()){console.log("Translate to EN: Selected nodes have no text content.");return}console.log("Translate to EN - Input:",g);try{const x=await vi(g,"Vietnamese","English");console.log("Translate to EN - Response:",x);const w=x.output;if(w!=null&&w.trim()){let v={x:100,y:100};if(a.length>0){const b=a[0];v={x:b.x,y:b.y+(b.height??ke.DEFAULT_NODE_HEIGHT)+ke.nodeSpacing}}const N=Ye.buildTextNode(v,w);i(N),c(N.id),console.log(`Translate to EN: Created new node ${N.id} with English translation.`)}else console.log("Translate to EN: Received empty translation.")}catch(x){console.error("Translate to EN - Error:",x)}},y=[{label:"Generate Text",icon:t.jsx(oo,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Summarize",icon:t.jsx(Zh,{className:"h-2.5 w-2.5"}),onClick:h},{label:"Ask Question",icon:t.jsx(Mr,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Translate to VN",icon:t.jsx(mi,{className:"h-2.5 w-2.5"}),onClick:f},{label:"Translate to EN",icon:t.jsx(mi,{className:"h-2.5 w-2.5"}),onClick:m}];return t.jsx("div",{id:"ToolbarAi",className:Me("ToolbarAi",s),"data-test":"toolbar-ai-button",children:t.jsx(rt,{size:"compact",variant:n??"secondary",mainAction:{icon:t.jsx(oo,{className:"h-2.5 w-2.5"}),onClick:()=>{console.log("Main AI Action clicked")},text:"AI",label:"Trigger AI actions"},dropdownActions:y,dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})};class uy{constructor(s){qe(this,"namespace","canvas.fitWidth");this.hooks=s}getActions(){return[{id:"width:350",label:"Set width to 350px",category:"Width",icon:t.jsx(Jt,{className:"h-3 w-3"})},{id:"width:550",label:"Set width to 550px",category:"Width",icon:t.jsx(Jt,{className:"h-3 w-3"})},{id:"width:700",label:"Set width to 700px",category:"Width",icon:t.jsx(Jt,{className:"h-3 w-3"})},{id:"width:850",label:"Set width to 850px",category:"Width",icon:t.jsx(Jt,{className:"h-3 w-3"})},{id:"fit:dimensions",label:"Fit node dimensions",category:"Fit",icon:t.jsx(Ds,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"width:350":this.hooks.setWidth350();break;case"width:550":this.hooks.setWidth550();break;case"width:700":this.hooks.setWidth700();break;case"width:850":this.hooks.setWidth850();break;case"fit:dimensions":this.hooks.fitDimensions();break;default:console.warn(`FitWidthFacade: Unknown action "${s}"`)}}}function hy(){const{setFixedWidth:e,fitNodeDimensions:s}=bn(),n=p.useCallback(()=>e(350),[e]),o=p.useCallback(()=>e(550),[e]),r=p.useCallback(()=>e(700),[e]),a=p.useCallback(()=>e(850),[e]),i=p.useCallback(()=>s(),[s]),c=p.useMemo(()=>({setWidth350:n,setWidth550:o,setWidth700:r,setWidth850:a,fitDimensions:i}),[n,o,r,a,i]),l=p.useMemo(()=>new uy(c),[c]);return p.useEffect(()=>(pt.register("fitWidth",{name:"Fit Width",getActions:()=>l.getActions()}),at.register("fitWidth",l),()=>{pt.unregister("fitWidth"),at.unregister("fitWidth")}),[l]),l}const py=()=>{const{selectedNodes:e}=bn(),s=hy(),n=e.length===0,o=[{label:"Set width to 350px",icon:t.jsx(Jt,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:350"),disabled:n},{label:"Set width to 550px",icon:t.jsx(Jt,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:550"),disabled:n},{label:"Set width to 700px",icon:t.jsx(Jt,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:700"),disabled:n},{label:"Set width to 850px",icon:t.jsx(Jt,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:850"),disabled:n},{label:"Fit node dimensions",icon:t.jsx(Ds,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("fit:dimensions"),disabled:n}],r=o[0];return t.jsx(rt,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"canvas-fit-width",facade:s,"data-test":"canvas-fit-width-button"})},as=50,Rd=()=>{const s=T.getState().projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=p.useCallback((f,m)=>{const y=T.getState(),g=y.projectCanvas.getActive(),x=(g==null?void 0:g.coreState.selectedNodes)??[],w=(g==null?void 0:g.coreState.nodes)??{},v=y.updateNode;if(x.length!==1){console.warn("useNodePusher: Exactly one node must be selected to push/pull other nodes.");return}const N=x[0],b=[],A=Object.values(w),R=m==="pull"?f==="up"?"down":f==="down"?"up":f==="left"?"right":"left":f;A.forEach(k=>{if(k.id===N.id)return;let S=!1;const E={id:k.id};switch(R){case"down":k.y>=N.y+(N.height??0)&&(E.y=k.y+(m==="push"?as:-as),S=!0);break;case"up":k.y+(k.height??0)<=(N.y??0)&&(E.y=k.y+(m==="push"?-as:as),S=!0);break;case"right":k.x>=N.x+(N.width??0)&&(E.x=k.x+(m==="push"?as:-as),S=!0);break;case"left":k.x+(k.width??0)<=N.x&&(E.x=k.x+(m==="push"?-as:as),S=!0);break}S&&b.push(E)}),b.length>0?(b.forEach(k=>v(k.id,k)),console.log(`${m==="push"?"Pushed":"Pulled"} ${b.length} nodes ${f} by ${as}px.`)):console.warn(`No nodes found to ${m} ${f}.`)},[]),r=p.useCallback(()=>o("down","push"),[o]),a=p.useCallback(()=>o("up","push"),[o]),i=p.useCallback(()=>o("left","push"),[o]),c=p.useCallback(()=>o("right","push"),[o]),l=p.useCallback(()=>o("down","pull"),[o]),d=p.useCallback(()=>o("up","pull"),[o]),h=p.useCallback(()=>o("left","pull"),[o]),u=p.useCallback(()=>o("right","pull"),[o]);return{pushNodesDown:r,pushNodesUp:a,pushNodesLeft:i,pushNodesRight:c,pullNodesDown:l,pullNodesUp:d,pullNodesLeft:h,pullNodesRight:u,selectedNodes:n}};class gy{constructor(s){qe(this,"namespace","canvas.nodeOperations");this.hooks=s}getActions(){return[{id:"push:up",label:"Push up",category:"Push",icon:t.jsx(ao,{className:"h-3 w-3"})},{id:"push:down",label:"Push down",category:"Push",icon:t.jsx(ro,{className:"h-3 w-3"})},{id:"push:left",label:"Push left",category:"Push",icon:t.jsx(pn,{className:"h-3 w-3"})},{id:"push:right",label:"Push right",category:"Push",icon:t.jsx(ts,{className:"h-3 w-3"})},{id:"pull:up",label:"Pull up",category:"Pull",icon:t.jsx(ao,{className:"h-3 w-3"})},{id:"pull:down",label:"Pull down",category:"Pull",icon:t.jsx(ro,{className:"h-3 w-3"})},{id:"pull:left",label:"Pull left",category:"Pull",icon:t.jsx(pn,{className:"h-3 w-3"})},{id:"pull:right",label:"Pull right",category:"Pull",icon:t.jsx(ts,{className:"h-3 w-3"})},{id:"join:newline",label:"Join with newline",category:"Join",icon:t.jsx(Na,{className:"h-3 w-3"})},{id:"join:space",label:"Join with space",category:"Join",icon:t.jsx(Sa,{className:"h-3 w-3"})},{id:"lines:remove-extra",label:"Remove extra lines",category:"Lines",icon:t.jsx(ir,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"push:up":this.hooks.pushUp();break;case"push:down":this.hooks.pushDown();break;case"push:left":this.hooks.pushLeft();break;case"push:right":this.hooks.pushRight();break;case"pull:up":this.hooks.pullUp();break;case"pull:down":this.hooks.pullDown();break;case"pull:left":this.hooks.pullLeft();break;case"pull:right":this.hooks.pullRight();break;case"join:newline":this.hooks.joinWithNewline();break;case"join:space":this.hooks.joinWithSpace();break;case"lines:remove-extra":this.hooks.removeExtraLines();break;default:console.warn(`NodeOperationsFacade: Unknown action "${s}"`)}}}const Md=()=>{const e=T.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=(s==null?void 0:s.coreState.arrows)??[];e.addNode,e.deleteSelectedNodes;const r=e.deleteNodeById,a=e.setSelectedNodes,i=e.updateNodes,c=e.arrow.setAll,l=p.useCallback(u=>{if(n.length<2){console.warn("useNodeJoiner: At least two nodes must be selected to join.");return}const f=[...n].sort((N,b)=>N.y<b.y?-1:N.y>b.y?1:N.x<b.x?-1:N.x>b.x?1:0),m=f[0],y=f.slice(1),g=f.reduce((N,b)=>(b.width??0)>(N.width??0)?b:N,f[0]),x=f.map(N=>typeof N.content=="string"?N.content.trim():"").filter(N=>N.length>0).join(u);if(x.length===0&&f.every(N=>!(typeof N.content=="string"&&N.content.trim()))){console.warn("useNodeJoiner: All selected nodes have empty content. No node created.");return}const w=g.width??ke.DEFAULT_NODE_WIDTH,v=It(x,w,m);i([{id:m.id,content:x,width:g.width,height:v}]);{const N=new Set(y.map(R=>R.id)),A=o.map(R=>{const k=R.startNodeId&&N.has(R.startNodeId),S=R.endNodeId&&N.has(R.endNodeId);return k&&S||k&&R.endNodeId===m.id||S&&R.startNodeId===m.id?null:k||S?{...R,startNodeId:k?m.id:R.startNodeId,endNodeId:S?m.id:R.endNodeId}:R}).filter(R=>R!==null).filter((R,k,S)=>R?k===S.findIndex(E=>E&&E.startNodeId===R.startNodeId&&E.endNodeId===R.endNodeId):!1);c(A)}y.forEach(N=>{r(N.id)}),a([m]),console.log("Nodes joined into first node:",m.id)},[n,o,i,r,a,c]),d=p.useCallback(()=>{l(" ")},[l]),h=p.useCallback(()=>{l(`
`)},[l]);return{joinNodes:d,joinNodesWithNewline:h,selectedNodes:n}},fy=()=>{const e=T.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=e.updateNode;return{removeExtraNewLines:p.useCallback(()=>{if(n.length!==1){console.warn("useNodeLineManipulation: Exactly one node must be selected.");return}const a=n[0];if(!a.content||typeof a.content!="string"){console.warn("useNodeLineManipulation: Selected node has no content to modify.");return}const i=a.content.replace(/\n\n+/g,`
`);if(i===a.content){console.warn("useNodeLineManipulation: No extra new lines found. Node content not changed.");return}const c=It(i,a.width??0,a),l={id:a.id,content:i,height:c};o(l.id,l),console.log("Action: Removed extra new lines from node content.")},[n,o])}};function _r(){const{pushNodesUp:e,pushNodesDown:s,pushNodesLeft:n,pushNodesRight:o,pullNodesUp:r,pullNodesDown:a,pullNodesLeft:i,pullNodesRight:c}=Rd(),{joinNodes:l,joinNodesWithNewline:d}=Md(),{removeExtraNewLines:h}=fy(),u=p.useMemo(()=>({pushUp:e,pushDown:s,pushLeft:n,pushRight:o,pullUp:r,pullDown:a,pullLeft:i,pullRight:c,joinWithNewline:d,joinWithSpace:l,removeExtraLines:h}),[e,s,n,o,r,a,i,c,d,l,h]),f=p.useMemo(()=>new gy(u),[u]);return p.useEffect(()=>(pt.register("nodeOperations",{name:"Node Operations",getActions:()=>f.getActions()}),at.register("nodeOperations",f),()=>{pt.unregister("nodeOperations"),at.unregister("nodeOperations")}),[f]),f}const my=e=>{const{className:s}=e,{selectedNodes:n}=Rd(),o=_r(),r=n.length!==1,a={icon:t.jsx(Jh,{className:"h-4 w-4"}),onClick:()=>o.execute("push:down"),label:"Push/Pull nodes",disabled:r},i=[{header:"Push",actions:[{label:"Push Up",icon:t.jsx(ao,{className:"h-3 w-3"}),onClick:()=>o.execute("push:up"),disabled:r},{label:"Push Down",icon:t.jsx(ro,{className:"h-3 w-3"}),onClick:()=>o.execute("push:down"),disabled:r},{label:"Push Left",icon:t.jsx(pn,{className:"h-3 w-3"}),onClick:()=>o.execute("push:left"),disabled:r},{label:"Push Right",icon:t.jsx(ts,{className:"h-3 w-3"}),onClick:()=>o.execute("push:right"),disabled:r}]},{header:"Pull",actions:[{label:"Pull Up",icon:t.jsx(ao,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:up"),disabled:r},{label:"Pull Down",icon:t.jsx(ro,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:down"),disabled:r},{label:"Pull Left",icon:t.jsx(pn,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:left"),disabled:r},{label:"Pull Right",icon:t.jsx(ts,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:right"),disabled:r}]}];return t.jsx("div",{id:"PushNodesButtonContainer",className:Ie("flex items-center",s),"data-test":"toolbar-push-pull-nodes-button",children:t.jsx(rt,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-push-nodes",facade:o,dropdownMenuClassName:"w-auto min-w-0"})})},xy=()=>{const{selectedNodes:e}=Md(),s=_r(),n=e.length<2,o=[{label:"Join with newline",icon:t.jsx(Na,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:newline"),disabled:n},{label:"Join with space",icon:t.jsx(Sa,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:space"),disabled:n}],r={...o[0]};return t.jsx(rt,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"toolbar-join-nodes",facade:s,"data-test":"canvas-join-nodes-button"})},Ta=[{name:"Red",value:"#ef4444",twClass:"bg-red-500"},{name:"Orange",value:"#f97316",twClass:"bg-orange-500"},{name:"Yellow",value:"#eab308",twClass:"bg-yellow-500"},{name:"Green",value:"#22c55e",twClass:"bg-green-500"},{name:"Teal",value:"#14b8a6",twClass:"bg-teal-500"},{name:"Cyan",value:"#06b6d4",twClass:"bg-cyan-500"},{name:"Blue",value:"#3b82f6",twClass:"bg-blue-500"},{name:"Violet",value:"#8b5cf6",twClass:"bg-violet-500"},{name:"Purple",value:"#a855f7",twClass:"bg-purple-500"},{name:"Pink",value:"#ec4899",twClass:"bg-pink-500"},{name:"White",value:"#ffffff",twClass:"bg-white"},{name:"Border",value:"hsl(240 5.9% 90%)",twClass:"bg-border"},{name:"Muted",value:"hsl(var(--muted-light))",twClass:"bg-muted"},{name:"Black",value:"#000000",twClass:"bg-black"},{name:"Transparent",value:"transparent",twClass:"bg-transparent border-dashed border-neutral-400"}],Ea=e=>{if(e.startsWith("hsl(")){const s=/hsl\(\s*(\d+)\s*,\s*(\d+%)\s*,\s*(\d+%)\s*\)/.exec(e);if(s){const n=parseInt(s[1]),o=parseInt(s[2])/100,r=parseInt(s[3])/100;if(o===0){const d=Math.round(r*255).toString(16).padStart(2,"0");return`#${d}${d}${d}`}const a=d=>(d+n/30)%12,i=o*Math.min(r,1-r),c=d=>r-i*Math.max(-1,Math.min(a(d)-3,Math.min(9-a(d),1))),l=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${l(c(0))}${l(c(8))}${l(c(4))}`}}return console.warn(`convertHslToHex: Could not convert HSL string "${e}" to HEX. Returning as is or black.`),e.startsWith("#")?e:"#000000"},yy=({currentColor:e,onColorSelect:s,currentBorderWidth:n,onBorderWidthChange:o})=>{const[r,a]=p.useState(e),[i,c]=p.useState(n);p.useEffect(()=>{a(e)},[e]),p.useEffect(()=>{c(n)},[n]);const l=h=>{a(h),s(h)},d=h=>{const u=parseInt(h.target.value,10);isNaN(u)||(c(u),o(u))};return t.jsxs("div",{className:"p-2 grid grid-cols-5 gap-2 bg-popover rounded-md shadow-md",children:[Ta.map(h=>t.jsx("button",{type:"button",title:h.name,onClick:()=>l(h.value),className:Ie("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",h.twClass,h.value===r?"ring-2 ring-ring ring-offset-2":"border-muted ring-0",h.value==="white"&&"border-neutral-300"),style:h.value.startsWith("hsl(")?{backgroundColor:h.value}:{},"aria-label":`Select color ${h.name}`,"data-test":"color-picker-option"},h.value)),t.jsx("input",{type:"color",value:r.startsWith("hsl")?Ea(r):r,onChange:h=>l(h.target.value),className:"mt-2 w-full col-span-5 h-8 bg-secondary","data-test":"color-picker-custom-color-input"}),t.jsxs("div",{className:"mt-3 pt-3 border-t border-border col-span-5",children:[t.jsx("label",{htmlFor:"border-width-input",className:"block text-sm font-medium text-foreground mb-1",children:"Border Width"}),t.jsx("input",{type:"number",id:"border-width-input",value:i,onChange:d,min:"0",max:"50",className:"mt-1 w-full col-span-5 h-8 p-2 rounded-md border border-input bg-background text-foreground focus:ring-ring focus:border-ring","data-test":"color-picker-border-width-input"})]})]})},Ja="canvas-border-width",wy=()=>{var S,E,C,I;const e=$(O=>O.updateNode),s=$(O=>{var H;return((H=O.projectCanvas.getActive())==null?void 0:H.coreState.selectedNodes)??[]}),n=p.useRef(null),[o,r]=p.useState(!1),[a,i]=p.useState("hsl(var(--primary))"),[c,l]=p.useState("1px"),[d,h]=p.useState("solid"),u=T.getState().getLastUsedBorder(),f=u.lastUsedColor,m=u.lastUsedWidth,y=u.lastUsedStyle;p.useEffect(()=>{if(s.length===1){const H=s[0].styles,L=(H==null?void 0:H.borderColor)||"hsl(var(--primary))",W=(H==null?void 0:H.borderWidth)||"1px",P=(H==null?void 0:H.borderStyle)||"solid";i(L),l(W),h(P)}else s.length===0&&(i("hsl(var(--primary))"),l("1px"),h("solid"))},[s]);const g=(O,H,L)=>{s.forEach(W=>{const P={...W.styles,borderWidth:O,borderStyle:H,borderColor:L};O===void 0&&H===void 0&&L===void 0&&(P.border=void 0);const j={styles:P};e(W.id,j)})},x=()=>{g(m,y,f)},w=()=>()=>{var W;const O=T.getState(),H=O.getLastUsedBorder();(((W=O.projectCanvas.getActive())==null?void 0:W.coreState.selectedNodes)??[]).forEach(P=>{const j={...P.styles,borderWidth:H.lastUsedWidth,borderStyle:H.lastUsedStyle,borderColor:H.lastUsedColor};O.updateNode(P.id,{styles:j})})};n.current=w();const v=O=>{g(c,d,O),i(O),T.getState().setLastUsedBorder(O,c,d),T.getState().setSegmentedButtonAction(Ja,"Apply last used border color",()=>n.current)},N=O=>{const H=`${O}px`;g(H,d,a),l(H),T.getState().setLastUsedBorder(a,H,d),T.getState().setSegmentedButtonAction(Ja,"Apply last used border color",()=>n.current)},b=()=>{l(void 0),h(void 0),i(void 0),g(void 0,void 0,void 0)},A=[{label:"Apply last used border color",icon:t.jsx("span",{style:{color:f==="transparent"?void 0:f,display:"inline-flex"},children:t.jsx(xi,{className:"h-2.5 w-2.5"})}),onClick:()=>{x()},disabled:s.length===0},{label:"Set Border Color",icon:t.jsx("span",{style:{color:a==="transparent"?void 0:a,display:"inline-flex"},children:t.jsx(Fl,{className:"h-2.5 w-2.5"})}),onClick:()=>{r(!0)},disabled:s.length===0},{label:"Remove Border",icon:t.jsx(mo,{className:"h-2.5 w-2.5"}),onClick:()=>{b()},disabled:s.length===0||!((E=(S=s[0])==null?void 0:S.styles)!=null&&E.borderWidth)&&!((I=(C=s[0])==null?void 0:C.styles)!=null&&I.border)}],R={...A[0],icon:t.jsx("span",{style:{color:a==="transparent"?void 0:a,display:"inline-flex"},children:t.jsx(xi,{className:"h-2.5 w-2.5"})})},k=O=>{if(!O)return 1;const H=parseInt(O,10);return isNaN(H)?1:H};return t.jsxs(St,{open:o,onOpenChange:r,children:[t.jsx(Ct,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"canvas-border-width-button",children:t.jsx(rt,{mainAction:R,dropdownActions:A,variant:"outline",size:"compact",persistenceKey:Ja})})}),t.jsx(jt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:O=>O.preventDefault(),"data-test":"canvas-border-width-popover",children:t.jsx(yy,{currentColor:a,onColorSelect:v,currentBorderWidth:k(c),onBorderWidthChange:N})})]})},vy=e=>{const{className:s}=e,n=_r(),o={icon:t.jsx(ir,{}),onClick:()=>n.execute("lines:remove-extra"),label:"Remove extra new lines"},r=[{label:"Remove extra new lines",icon:t.jsx(ir,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("lines:remove-extra")}];return t.jsx("div",{id:"ToolbarLinesButtonContainer",className:Ie("flex items-center",s),"data-test":"toolbar-lines-button",children:t.jsx(rt,{mainAction:o,dropdownActions:r,variant:"outline",size:"compact",persistenceKey:"toolbar-lines",facade:n})})},by=e=>{const{className:s,...n}=e,o=()=>{var i;const r=T.getState();(((i=r.projectCanvas.getActive())==null?void 0:i.coreState.selectedNodes)??[]).length>0&&r.deleteSelectedNodes()};return t.jsx(Nn,{id:"ToolbarDeleteNodesButton",className:s,type:"button",onClick:o,"data-test":"toolbar-delete-nodes-button",...n,children:t.jsx(Nt,{className:"h-2.5 w-2.5"})})};class Ny{constructor(s){qe(this,"namespace","canvas.alignment");this.hooks=s}getActions(){return[{id:"node:left",label:"Align left",category:"Node",icon:t.jsx(io,{className:"h-3 w-3"})},{id:"node:right",label:"Align right",category:"Node",icon:t.jsx(co,{className:"h-3 w-3"})},{id:"node:top",label:"Align top",category:"Node",icon:t.jsx(Dr,{className:"h-3 w-3"})},{id:"node:bottom",label:"Align bottom",category:"Node",icon:t.jsx(Or,{className:"h-3 w-3"})},{id:"text:left",label:"Text left",category:"Text",icon:t.jsx(io,{className:"h-3 w-3"})},{id:"text:center",label:"Text center",category:"Text",icon:t.jsx(Bl,{className:"h-3 w-3"})},{id:"text:right",label:"Text right",category:"Text",icon:t.jsx(co,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"node:left":this.hooks.alignNodesLeft();break;case"node:right":this.hooks.alignNodesRight();break;case"node:top":this.hooks.alignNodesTop();break;case"node:bottom":this.hooks.alignNodesBottom();break;case"text:left":this.hooks.alignTextLeft();break;case"text:center":this.hooks.alignTextCenter();break;case"text:right":this.hooks.alignTextRight();break;default:console.warn(`AlignmentFacade: Unknown action "${s}"`)}}}const Sy=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.y??0)-(c.y??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.y??0,l=i.height??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},Cy=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.x??0)-(c.x??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.x??0,l=i.width??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},jy=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="left"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.x??0)-(i.x??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.x??0)+(i.width??0);if((c.x??0)<l+n){const h=l+n;o.set(c.id,{x:h}),r[a]={...c,x:h}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.x??0)+(a.width??0);return(i.x??0)+(i.width??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.x??0;if((c.x??0)+(c.width??0)>l-n){const h=l-n-(c.width??0);o.set(c.id,{x:h}),r[a]={...c,x:h}}}}return o},ky=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="top"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.y??0)-(i.y??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.y??0)+(i.height??0);if((c.y??0)<l+n){const h=l+n;o.set(c.id,{y:h}),r[a]={...c,y:h}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.y??0)+(a.height??0);return(i.y??0)+(i.height??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.y??0;if((c.y??0)+(c.height??0)>l-n){const h=l-n-(c.height??0);o.set(c.id,{y:h}),r[a]={...c,y:h}}}}return o};function Iy(){const e=p.useCallback(r=>{var f;const a=T.getState(),i=((f=a.projectCanvas.getActive())==null?void 0:f.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.filter(m=>typeof m.x=="number"&&typeof m.y=="number"&&typeof m.width=="number"&&typeof m.height=="number");if(c.length===0)return;const l=r==="left"||r==="right"?Sy(c):Cy(c);let d;switch(r){case"left":d=Math.min(...c.map(m=>m.x));break;case"right":d=Math.max(...c.map(m=>(m.x??0)+(m.width??0)));break;case"top":d=Math.min(...c.map(m=>m.y));break;case"bottom":d=Math.max(...c.map(m=>(m.y??0)+(m.height??0)));break;default:return}const h=new Map;for(const m of c)switch(r){case"left":h.set(m.id,{x:d});break;case"right":h.set(m.id,{x:d-(m.width??0)});break;case"top":h.set(m.id,{y:d});break;case"bottom":h.set(m.id,{y:d-(m.height??0)});break}const u=ke.NODE_ALIGNMENT_PADDING;for(const m of l){const y=m.map(x=>{const w=h.get(x.id);return w?{...x,...w}:x});(r==="left"||r==="right"?jy(y,r,u):ky(y,r,u)).forEach((x,w)=>{const v=h.get(w)||{};h.set(w,{...v,...x})})}h.forEach((m,y)=>{a.updateNode(y,m)})},[]),s=p.useCallback(r=>{var l;const a=T.getState(),i=((l=a.projectCanvas.getActive())==null?void 0:l.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.map(d=>({...d,id:d.id,styles:{...d.styles,textAlign:r}}));a.updateNodes(c)},[]),n=p.useMemo(()=>({alignNodesLeft:()=>e("left"),alignNodesRight:()=>e("right"),alignNodesTop:()=>e("top"),alignNodesBottom:()=>e("bottom"),alignTextLeft:()=>s("left"),alignTextCenter:()=>s("center"),alignTextRight:()=>s("right")}),[e,s]),o=p.useMemo(()=>new Ny(n),[n]);return p.useEffect(()=>(pt.register("alignment",{name:"Alignment",getActions:()=>o.getActions()}),at.register("alignment",o),()=>{pt.unregister("alignment"),at.unregister("alignment")}),[o]),o}const Qa={left:t.jsx(io,{className:"h-3 w-3"}),right:t.jsx(co,{className:"h-3 w-3"}),top:t.jsx(Dr,{className:"h-3 w-3"}),bottom:t.jsx(Or,{className:"h-3 w-3"})},lc={left:t.jsx(io,{className:"h-3 w-3"}),center:t.jsx(Bl,{className:"h-3 w-3"}),right:t.jsx(co,{className:"h-3 w-3"})},Ay=e=>{const{className:s,value:n,defaultValue:o="left",onAlignmentChange:r,textAlignValue:a,defaultTextAlignValue:i="left",onTextAlignmentChange:c}=e,l=Iy(),[d,h]=p.useState(n??o),[u,f]=p.useState(a??i);p.useEffect(()=>{n!==void 0&&h(n)},[n]),p.useEffect(()=>{a!==void 0&&f(a)},[a]);const m=w=>{r==null||r(w),h(w),l.execute(`node:${w}`)},y=w=>{c==null||c(w),f(w),l.execute(`text:${w}`)},g={icon:t.jsx(t.Fragment,{children:Qa[d]}),onClick:()=>m(d),label:`Align nodes ${d}`,text:""},x=[{header:"Node",width:"100px",actions:Object.keys(Qa).map(w=>({label:`Node ${w}`,icon:Qa[w],onClick:()=>m(w)}))},{header:"Text",width:"100px",actions:Object.keys(lc).map(w=>({label:`Text ${w}`,icon:lc[w],onClick:()=>y(w)}))}];return t.jsx("div",{id:"ToolbarNodesAlignmentButton",className:Ie("flex items-center",s),"data-test":"toolbar-nodes-alignment-button",children:t.jsx(rt,{mainAction:g,dropdownColumns:x,variant:"outline",size:"compact",persistenceKey:"toolbar-alignment",facade:l,dropdownMenuClassName:"w-auto min-w-0"})})};function Ur({nodeGap:e,gridColumns:s,gridRows:n,onNodeGapChange:o,onGridColumnsChange:r,onGridRowsChange:a,showFavorites:i=!1,isGapFavorite:c=!1,isColumnsFavorite:l=!1,isRowsFavorite:d=!1,onToggleGapFavorite:h,onToggleColumnsFavorite:u,onToggleRowsFavorite:f,compact:m=!1,showRows:y=!0,className:g}){const x=m?"h-5 w-12 text-[10px] px-1":"h-7 w-20 text-xs",w=m?"text-muted-foreground text-[10px]":"text-xs text-muted-foreground min-w-[60px]",v=m?"flex items-center gap-3":"space-y-3",N=m?"flex items-center gap-1":"flex items-center gap-2";return t.jsxs("div",{className:Ie(v,g),"data-test":"arrange-config-form",children:[t.jsxs("div",{className:N,"data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:w,children:"Gap:"}),t.jsx(ze,{type:"number",min:"0",max:"200",value:e,onChange:b=>o(Math.max(0,Math.min(200,parseInt(b.target.value)||0))),className:x,"data-test":"arrange-config-gap-input"}),!m&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"px"}),m&&t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"px"}),i&&t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:h,title:c?"Remove from favorites":"Add to favorites","data-test":"arrange-config-gap-favorite-button",children:t.jsx(an,{className:Ie("h-3.5 w-3.5",c&&"fill-yellow-400 text-yellow-400")})})]}),t.jsxs("div",{className:N,"data-test":"arrange-config-columns-row",children:[t.jsx("span",{className:w,children:"Cols:"}),t.jsx(ze,{type:"number",min:"1",max:"10",value:s,onChange:b=>r(Math.max(1,Math.min(10,parseInt(b.target.value)||3))),className:x,"data-test":"arrange-config-columns-input"}),!m&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:u,title:l?"Remove from favorites":"Add to favorites","data-test":"arrange-config-columns-favorite-button",children:t.jsx(an,{className:Ie("h-3.5 w-3.5",l&&"fill-yellow-400 text-yellow-400")})})]}),y&&n!==void 0&&a&&t.jsxs("div",{className:N,"data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:w,children:"Rows:"}),t.jsx(ze,{type:"number",min:"1",max:"10",value:n,onChange:b=>a(Math.max(1,Math.min(10,parseInt(b.target.value)||3))),className:x,"data-test":"arrange-config-rows-input"}),!m&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:f,title:d?"Remove from favorites":"Add to favorites","data-test":"arrange-config-rows-favorite-button",children:t.jsx(an,{className:Ie("h-3.5 w-3.5",d&&"fill-yellow-400 text-yellow-400")})})]})]})}function Ty(e){if(e.length<2)return[...e];const n=e.reduce((o,r)=>o+(r.height??100),0)/e.length*.5;return[...e].sort((o,r)=>Math.abs(o.y-r.y)<n?o.x-r.x:o.y-r.y)}const er=Ty;function Pd(e){return e.map(s=>({...s,width:s.width??100,height:s.height??31}))}function Ey(e,s){if(e.length===0)return[];if(e.length===1)return[[...e]];const n=Pd(e),r=n.reduce((d,h)=>d+h.height,0)/n.length*s,a=[...e].sort((d,h)=>d.y-h.y),i=[];let c=[a[0]],l=a[0].y;for(let d=1;d<a.length;d++){const h=a[d];Math.abs(h.y-l)<=r?c.push(h):(i.push(c),c=[h],l=h.y)}return c.length>0&&i.push(c),i}function Ry(e,s){if(e.length===0)return[];if(e.length===1)return[...e];const{cleanUpGap:n,rowThreshold:o}=s,r=Pd(e),a=new Map;r.forEach(h=>{a.set(h.id,{width:h.width,height:h.height})});const i=Ey(e,o),l=[...i[0]].sort((h,u)=>h.x-u.x)[0].x,d=[];for(const h of i){const u=[...h].sort((g,x)=>g.x-x.x),m=u[0].y;let y=l;for(const g of u){const x=a.get(g.id);d.push({...g,x:y,y:m}),y+=x.width+n}}return d}const Vs=[];function My(){const e=$(j=>{var M;return((M=j.projectCanvas.getActive())==null?void 0:M.coreState.selectedNodes)??Vs}),s=$(j=>{var M;return((M=j.projectCanvas.getActive())==null?void 0:M.coreState.nodes)??Vs}),{updateNode:n}=T.getState(),[o,r]=p.useState("content"),a=p.useRef(Vs);e.length===0?a.current=Vs:(e.length!==a.current.length||!e.every((j,M)=>{var B;return j.id===((B=a.current[M])==null?void 0:B.id)}))&&(a.current=e);const i=p.useRef(Vs);s.length===0?i.current=Vs:(s.length!==i.current.length||!s.every((j,M)=>{var B;return j.id===((B=i.current[M])==null?void 0:B.id)}))&&(i.current=s);const c=j=>{if(j)return j;const B=T.getState().projectCanvas.getActive(),U=(B==null?void 0:B.coreState.selectedNodes)??[],z=(B==null?void 0:B.coreState.nodes)??[];return U.length>=2?U:z},l=j=>{const M={timestamp:Date.now(),nodePositions:Object.fromEntries(j.map(B=>[B.id,{x:B.x,y:B.y,width:B.width,height:B.height}]))};T.getState().setArrangeSnapshot(M)},d=p.useCallback((j,M)=>{const B=c(j);if(B.length<2)return;l(B);const U=T.getState().getArrangeNodeGap(),z=[...B].sort((F,D)=>F.y-D.y);let _;M==="left"?_=Math.min(...B.map(F=>F.x)):M==="right"&&(_=Math.max(...B.map(D=>D.x+(D.width||200))));let G=z[0].y;z.forEach((F,D)=>{const V={};D===0?G=F.y+(F.height||100)+U:(V.y=G,G=G+(F.height||100)+U),M==="left"&&_!==void 0?V.x=_:M==="right"&&_!==void 0&&(V.x=_-(F.width||200)),Object.keys(V).length>0&&n(F.id,V)})},[n]),h=p.useCallback(j=>{d(j,"left")},[d]),u=p.useCallback(j=>{d(j,"right")},[d]),f=p.useCallback((j,M)=>{const B=c(j),U=T.getState().getArrangeNodeGap();if(B.length<2)return;l(B);const z=[...B].sort((F,D)=>F.x-D.x);let _;M==="top"?_=Math.min(...B.map(F=>F.y)):M==="bottom"&&(_=Math.max(...B.map(D=>D.y+(D.height||100))));let G=z[0].x;z.forEach((F,D)=>{const V={},J=F.width||200;D===0?G=F.x+J+U:(V.x=G,G=G+J+U),M==="top"&&_!==void 0?V.y=_:M==="bottom"&&_!==void 0&&(V.y=_-(F.height||100)),Object.keys(V).length>0&&n(F.id,V)})},[n]),m=p.useCallback(j=>{f(j,"top")},[f]),y=p.useCallback(j=>{f(j,"bottom")},[f]),g=(j,M)=>{const B=j.content||"";return It(B,M,j)},x=j=>{const M=T.getState().group.createFromSelected(`[Arrange] ${j}`);M&&T.getState().addTagToNode(M,{id:Ve(8),title:"action:arrange"})},w=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B=T.getState().getArrangeNodeGap(),U=T.getState().getArrangeGridColumns(),z=Math.max(...M.map(ie=>ie.width??ke.DEFAULT_NODE_WIDTH)),_=er(M),G=_[0].x,F=_[0].y,D=_.map(ie=>g(ie,z)),V=Math.ceil(_.length/U),J=[];for(let ie=0;ie<V;ie++){let Se=0;for(let me=0;me<U;me++){const Z=ie*U+me;Z<D.length&&(Se=Math.max(Se,D[Z]))}J.push(Se)}_.forEach((ie,Se)=>{const me=Se%U,Z=Math.floor(Se/U),ge=G+me*(z+B),we=Z===0?F:F+J.slice(0,Z).reduce((X,K)=>X+K+B,0),te=D[Se];n(ie.id,{x:ge,y:we,width:z,height:te,options:{...ie.options,lockSize:!0}})}),x("Grid")},[n]),v=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B=T.getState().getArrangeNodeGap(),U=T.getState().getArrangeGridColumns(),z=Math.max(...M.map(J=>J.width??ke.DEFAULT_NODE_WIDTH)),_=er(M),G=_[0].x,F=_[0].y,D=Array(U).fill(F),V=_.map(J=>g(J,z));_.forEach((J,ie)=>{const Se=D.indexOf(Math.min(...D)),me=G+Se*(z+B),Z=D[Se],ge=V[ie];n(J.id,{x:me,y:Z,width:z,height:ge,options:{...J.options,lockSize:!0}}),D[Se]=Z+ge+B}),x("Masonry")},[n]),N=(j,M)=>{switch(M){case"content":return String(j.content??"").toLowerCase();case"title":return String(j.title??"").toLowerCase();case"x":return j.x;case"y":return j.y;case"width":return j.width??0;case"height":return j.height??0;case"createdAt":return j.createdAt??"";case"updatedAt":return j.updatedAt??"";case"id":return j.id;case"type":return j.type;default:return""}},b=p.useCallback((j,M="asc",B)=>{const U=c(B);if(U.length<2)return;const z=er(U).map(G=>({x:G.x,y:G.y}));[...U].sort((G,F)=>{const D=N(G,j),V=N(F,j);let J;return typeof D=="number"&&typeof V=="number"?J=D-V:J=String(D).localeCompare(String(V)),M==="asc"?J:-J}).forEach((G,F)=>{const D=z[F];(G.x!==D.x||G.y!==D.y)&&n(G.id,{x:D.x,y:D.y})})},[n]),A=p.useCallback((j,M)=>{b(j??o,"asc",M)},[b,o]),R=p.useCallback((j,M)=>{b(j??o,"desc",M)},[b,o]),k=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B={cleanUpGap:Q.arrange.cleanUpGap,rowThreshold:Q.arrange.cleanUpRowThreshold};Ry(M,B).forEach(z=>{const _=M.find(G=>G.id===z.id);_&&(_.x!==z.x||_.y!==z.y)&&n(z.id,{x:z.x,y:z.y})})},[n]),S=j=>{const B=T.getState().projectCanvas.getActive(),U=(B==null?void 0:B.coreState.arrows)??[],z=new Set(j.map(_=>_.id));return U.filter(_=>_.startNodeId&&_.endNodeId&&z.has(_.startNodeId)&&z.has(_.endNodeId))},E=j=>{const M=j.width??ke.DEFAULT_NODE_WIDTH,B=j.height??100;return{x:j.x+M/2,y:j.y+B/2}},C=(j,M,B)=>{const{arrow:U}=T.getState();for(const z of j){if(!z.startNodeId||!z.endNodeId)continue;const _=M.get(z.startNodeId),G=M.get(z.endNodeId);if(!_||!G)continue;const D=T.getState().projectCanvas.getActive(),V=(D==null?void 0:D.coreState.nodes)??[],J=V.find(Z=>Z.id===z.startNodeId),ie=V.find(Z=>Z.id===z.endNodeId);if(!J||!ie)continue;const Se=E(J),me=E(ie);U.update(z.id,{type:B,startPoint:Se,endPoint:me})}},I=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B=T.getState().getArrangeNodeGap(),U=S(M),z=new Map(M.map(me=>[me.id,me])),_=M.filter(me=>!U.some(ge=>ge.endNodeId===me.id)),G=_.reduce((me,Z)=>Z.x<me.x||Z.x===me.x&&Z.y<me.y?Z:me,_[0]),F=[..._].sort((me,Z)=>me.x!==Z.x?me.x-Z.x:me.y-Z.y),D=new Set,V=(G==null?void 0:G.x)??M[0].x,J=(G==null?void 0:G.y)??M[0].y,ie=(me,Z,ge)=>{if(D.has(me.id))return{width:0,height:0};D.add(me.id);const we=U.filter(q=>q.startNodeId===me.id&&q.endNodeId&&!D.has(q.endNodeId)).map(q=>z.get(q.endNodeId)).filter(q=>q!==void 0);n(me.id,{x:Z,y:ge});const te=me.width??ke.DEFAULT_NODE_WIDTH,X=me.height??100;if(we.length===0)return{width:te,height:X};const K=Z+te+B;let ne=ge,ce=0;for(const q of we){const he=ie(q,K,ne),be=q.height??100;ne+=Math.max(be,he.height)+B,ce=Math.max(ce,he.width)}const de=ne-ge-B;return{width:te+B+ce,height:Math.max(X,de)}};let Se=J;for(const me of F){const Z=ie(me,V,Se),ge=me.height??100;Se+=Math.max(ge,Z.height)+B}C(U,z,"TreeZShape")},[n]),O=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B=T.getState().getArrangeNodeGap(),U=S(M),z=new Map(M.map(me=>[me.id,me])),_=M.filter(me=>!U.some(ge=>ge.endNodeId===me.id)),G=_.reduce((me,Z)=>Z.x<me.x||Z.x===me.x&&Z.y<me.y?Z:me,_[0]),F=[..._].sort((me,Z)=>me.x!==Z.x?me.x-Z.x:me.y-Z.y),D=new Set,V=(G==null?void 0:G.x)??M[0].x,J=(G==null?void 0:G.y)??M[0].y,ie=(me,Z,ge)=>{if(D.has(me.id))return{width:0,height:0};D.add(me.id);const we=U.filter(q=>q.startNodeId===me.id&&q.endNodeId&&!D.has(q.endNodeId)).map(q=>z.get(q.endNodeId)).filter(q=>q!==void 0);n(me.id,{x:Z,y:ge});const te=me.width??ke.DEFAULT_NODE_WIDTH,X=me.height??100;if(we.length===0)return{width:te,height:X};const K=ge+X+B;let ne=Z,ce=0;for(const q of we){const he=ie(q,ne,K),be=q.width??ke.DEFAULT_NODE_WIDTH;ne+=Math.max(be,he.width)+B,ce=Math.max(ce,he.height)}const de=ne-Z-B;return{width:Math.max(te,de),height:X+B+ce}};let Se=V;for(const me of F){const Z=ie(me,Se,J),ge=me.width??ke.DEFAULT_NODE_WIDTH;Se+=Math.max(ge,Z.width)+B}C(U,z,"TreeLStep")},[n]),H=(j,M)=>{const B=[...j].sort((G,F)=>G.y-F.y),U=[];let z=[],_=null;for(const G of B)_===null||Math.abs(G.y-_)<=M?(z.push(G),_===null&&(_=G.y)):(U.push(z),z=[G],_=G.y);return z.length>0&&U.push(z),U},L=(j,M)=>{const B=[...j].sort((G,F)=>G.x-F.x),U=[];let z=[],_=null;for(const G of B)_===null||Math.abs(G.x-_)<=M?(z.push(G),_===null&&(_=G.x)):(U.push(z),z=[G],_=G.x);return z.length>0&&U.push(z),U},W=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B=T.getState().getCycleRowBuffer(),U=H(M,B);if(U.length<2)return;const z=U.map(G=>Math.min(...G.map(F=>F.y)));[U[U.length-1],...U.slice(0,-1)].forEach((G,F)=>{const D=z[F],V=Math.min(...G.map(ie=>ie.y)),J=D-V;for(const ie of G)n(ie.id,{y:ie.y+J})})},[n]),P=p.useCallback(j=>{const M=c(j);if(M.length<2)return;l(M);const B=T.getState().getCycleRowBuffer(),U=L(M,B);if(U.length<2)return;const z=U.map(G=>Math.min(...G.map(F=>F.x)));[U[U.length-1],...U.slice(0,-1)].forEach((G,F)=>{const D=z[F],V=Math.min(...G.map(ie=>ie.x)),J=D-V;for(const ie of G)n(ie.id,{x:ie.x+J})})},[n]);return{arrangeVertically:d,arrangeVerticallyAlignLeft:h,arrangeVerticallyAlignRight:u,arrangeHorizontally:f,arrangeHorizontallyAlignTop:m,arrangeHorizontallyAlignBottom:y,arrangeGrid:w,arrangeMasonry:v,cleanUp:k,arrangeByArrowsVertical:I,arrangeByArrowsHorizontal:O,cycleRowsHorizontal:W,cycleColumnsVertical:P,sortNodes:b,sortNodesAsc:A,sortNodesDesc:R,sortKey:o,setSortKey:r,sortableKeys:Ou,selectedNodes:a.current}}function Py({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a,sortableKeys:i}){const c=s==="record",l=d=>{o(d==="asc"?"sort:asc":"sort:desc",{sortKey:r.sortKey})};return t.jsxs("div",{"data-test":"sort-action-section",children:[t.jsxs("div",{className:Ie("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",c&&n&&"bg-primary/10 border border-primary",!c&&"hover:bg-accent"),"data-test":"sort-action-row",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[t.jsxs(yt,{value:r.sortKey,onValueChange:d=>a({sortKey:d}),children:[t.jsx(wt,{className:"h-6 w-[90px] text-xs px-2","data-test":"sort-key-selector",children:t.jsx(vt,{})}),t.jsx(bt,{children:i.map(d=>t.jsx(Qe,{value:d,"data-test":"sort-key-option",children:yl[d]},d))})]}),t.jsx(se,{variant:"outline",size:"icon",className:Ie("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:asc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("asc")},title:"Sort ascending","data-test":"sort-asc-button",children:t.jsx(ao,{className:"h-3 w-3"})}),t.jsx(se,{variant:"outline",size:"icon",className:Ie("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:desc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("desc")},title:"Sort descending","data-test":"sort-desc-button",children:t.jsx(ro,{className:"h-3 w-3"})})]})]}),t.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 text-xs text-muted-foreground hover:bg-accent rounded-sm cursor-pointer","data-test":"sort-by-last-arrange-row",children:[t.jsx(Xe,{checked:r.sortByLastArrange,onCheckedChange:d=>a({sortByLastArrange:d===!0}),className:"h-3.5 w-3.5","data-test":"sort-by-last-arrange-checkbox"}),t.jsxs("span",{children:["By last arranged: ",r.lastArrangeOption||"none"]})]})]})}class Dy{constructor(s,n){qe(this,"namespace","canvas.arrange");this.hooks=s,this.storeActions=n}getActions(){const s=this.hooks.sortableKeys;return[{id:"vertical",label:"Arrange vertically",category:"Vertical",icon:t.jsx(Bo,{className:"h-3.5 w-3.5"}),subActions:[{id:"vertical:left",icon:t.jsx(io,{className:"h-3 w-3"}),title:"Align left"},{id:"vertical:right",icon:t.jsx(co,{className:"h-3 w-3"}),title:"Align right"}]},{id:"horizontal",label:"Arrange horizontally",category:"Horizontal",icon:t.jsx(Ds,{className:"h-3.5 w-3.5"}),subActions:[{id:"horizontal:top",icon:t.jsx(Dr,{className:"h-3 w-3"}),title:"Align top"},{id:"horizontal:bottom",icon:t.jsx(Or,{className:"h-3 w-3"}),title:"Align bottom"}]},{id:"grid",label:"Grid",category:"Layout",icon:t.jsx(lo,{className:"h-3.5 w-3.5"})},{id:"masonry",label:"Masonry",category:"Layout",icon:t.jsx(zl,{className:"h-3.5 w-3.5"})},{id:"cleanup",label:"Clean up",category:"Layout",icon:t.jsx(oo,{className:"h-3.5 w-3.5"})},{id:"groupByArrows",label:"Group by Arrows",category:"Layout",icon:t.jsx(Lr,{className:"h-3.5 w-3.5"}),subActions:[{id:"groupByArrows:vertical",icon:t.jsx(Bo,{className:"h-3 w-3"}),title:"Vertical"},{id:"groupByArrows:horizontal",icon:t.jsx(Ds,{className:"h-3 w-3"}),title:"Horizontal"}]},{id:"cycle",label:"Cycle",category:"Layout",icon:t.jsx(Wr,{className:"h-3.5 w-3.5"}),subActions:[{id:"cycle:horizontal",icon:t.jsx(Bo,{className:"h-3 w-3"}),title:"Cycle Rows"},{id:"cycle:vertical",icon:t.jsx(Ds,{className:"h-3 w-3"}),title:"Cycle Columns"}]},{id:"sort:asc",label:"Sort",category:"Sort",icon:t.jsx(Qh,{className:"h-3.5 w-3.5"}),params:[{name:"sortKey",type:"select",label:"Sort by",default:"createdAt",options:Object.entries(yl).map(([n,o])=>({value:n,label:o}))}],customRender:n=>t.jsx(Py,{...n,sortableKeys:s})}]}getConfig(){return{nodeGap:this.storeActions.getArrangeNodeGap(),gridColumns:this.storeActions.getArrangeGridColumns(),gridRows:this.storeActions.getArrangeGridRows(),sortByLastArrange:this.storeActions.getSortByLastArrange(),sortKey:this.hooks.sortKey,lastArrangeOption:this.storeActions.getLastArrangeOption()}}setConfig(s){s.nodeGap!==void 0&&this.storeActions.setArrangeNodeGap(s.nodeGap),s.gridColumns!==void 0&&this.storeActions.setArrangeGridColumns(s.gridColumns),s.gridRows!==void 0&&this.storeActions.setArrangeGridRows(s.gridRows),s.sortByLastArrange!==void 0&&this.storeActions.setSortByLastArrange(s.sortByLastArrange),s.sortKey!==void 0&&this.hooks.setSortKey(s.sortKey)}execute(s,n){n!=null&&n.sortKey&&this.hooks.setSortKey(n.sortKey);const o={vertical:"Arrange vertically","vertical:left":"Arrange vertically (left)","vertical:right":"Arrange vertically (right)",horizontal:"Arrange horizontally","horizontal:top":"Arrange horizontally (top)","horizontal:bottom":"Arrange horizontally (bottom)",grid:"Grid",masonry:"Masonry",cleanup:"Clean up",groupByArrows:"Group by Arrows (vertical)","groupByArrows:vertical":"Group by Arrows (vertical)","groupByArrows:horizontal":"Group by Arrows (horizontal)",cycle:"Cycle (horizontal)","cycle:horizontal":"Cycle (horizontal)","cycle:vertical":"Cycle (vertical)"};o[s]&&this.storeActions.setLastArrangeOption(o[s]);const r=a=>{var i;if(this.storeActions.getSortByLastArrange()){const c=this.storeActions.getLastArrangeOption();if(c){const l={"Arrange vertically":this.hooks.arrangeVertically,"Arrange vertically (left)":this.hooks.arrangeVerticallyAlignLeft,"Arrange vertically (right)":this.hooks.arrangeVerticallyAlignRight,"Arrange horizontally":this.hooks.arrangeHorizontally,"Arrange horizontally (top)":this.hooks.arrangeHorizontallyAlignTop,"Arrange horizontally (bottom)":this.hooks.arrangeHorizontallyAlignBottom,Grid:this.hooks.arrangeGrid,Masonry:this.hooks.arrangeMasonry,"Clean up":this.hooks.cleanUp,"Group by Arrows (vertical)":this.hooks.arrangeByArrowsVertical,"Group by Arrows (horizontal)":this.hooks.arrangeByArrowsHorizontal,"Cycle (horizontal)":this.hooks.cycleRowsHorizontal,"Cycle (vertical)":this.hooks.cycleColumnsVertical};(i=l[c])==null||i.call(l)}}a==="asc"?this.hooks.sortNodesAsc():this.hooks.sortNodesDesc()};switch(s){case"vertical":this.hooks.arrangeVertically();break;case"vertical:left":this.hooks.arrangeVerticallyAlignLeft();break;case"vertical:right":this.hooks.arrangeVerticallyAlignRight();break;case"horizontal":this.hooks.arrangeHorizontally();break;case"horizontal:top":this.hooks.arrangeHorizontallyAlignTop();break;case"horizontal:bottom":this.hooks.arrangeHorizontallyAlignBottom();break;case"grid":this.hooks.arrangeGrid();break;case"masonry":this.hooks.arrangeMasonry();break;case"cleanup":this.hooks.cleanUp();break;case"groupByArrows":case"groupByArrows:vertical":this.hooks.arrangeByArrowsVertical();break;case"groupByArrows:horizontal":this.hooks.arrangeByArrowsHorizontal();break;case"cycle":case"cycle:horizontal":this.hooks.cycleRowsHorizontal();break;case"cycle:vertical":this.hooks.cycleColumnsVertical();break;case"sort:asc":r("asc");break;case"sort:desc":r("desc");break;default:console.warn(`Unknown action: ${s}`)}}executePreset(s){const o=this.storeActions.getArrangePresets().find(r=>r.id===s);o&&(this.storeActions.applyArrangePreset(s),this.execute(o.config.arrangeMode))}}function Dd(){const e=My(),s=$(v=>v.getArrangeNodeGap),n=$(v=>v.setArrangeNodeGap),o=$(v=>v.getArrangeGridColumns),r=$(v=>v.setArrangeGridColumns),a=$(v=>v.getArrangeGridRows),i=$(v=>v.setArrangeGridRows),c=$(v=>v.getSortByLastArrange),l=$(v=>v.setSortByLastArrange),d=$(v=>v.getLastArrangeOption),h=$(v=>v.setLastArrangeOption),u=$(v=>v.getCycleRowBuffer),f=$(v=>v.setCycleRowBuffer),m=$(v=>v.getArrangePresets),y=$(v=>v.applyArrangePreset),g=p.useMemo(()=>({arrangeVertically:e.arrangeVertically,arrangeVerticallyAlignLeft:e.arrangeVerticallyAlignLeft,arrangeVerticallyAlignRight:e.arrangeVerticallyAlignRight,arrangeHorizontally:e.arrangeHorizontally,arrangeHorizontallyAlignTop:e.arrangeHorizontallyAlignTop,arrangeHorizontallyAlignBottom:e.arrangeHorizontallyAlignBottom,arrangeGrid:e.arrangeGrid,arrangeMasonry:e.arrangeMasonry,cleanUp:e.cleanUp,arrangeByArrowsVertical:e.arrangeByArrowsVertical,arrangeByArrowsHorizontal:e.arrangeByArrowsHorizontal,cycleRowsHorizontal:e.cycleRowsHorizontal,cycleColumnsVertical:e.cycleColumnsVertical,sortNodesAsc:e.sortNodesAsc,sortNodesDesc:e.sortNodesDesc,sortKey:e.sortKey,setSortKey:e.setSortKey,sortableKeys:e.sortableKeys}),[e.arrangeVertically,e.arrangeVerticallyAlignLeft,e.arrangeVerticallyAlignRight,e.arrangeHorizontally,e.arrangeHorizontallyAlignTop,e.arrangeHorizontallyAlignBottom,e.arrangeGrid,e.arrangeMasonry,e.cleanUp,e.arrangeByArrowsVertical,e.arrangeByArrowsHorizontal,e.cycleRowsHorizontal,e.cycleColumnsVertical,e.sortNodesAsc,e.sortNodesDesc,e.sortKey,e.setSortKey,e.sortableKeys]),x=p.useMemo(()=>({getArrangeNodeGap:s,setArrangeNodeGap:n,getArrangeGridColumns:o,setArrangeGridColumns:r,getArrangeGridRows:a,setArrangeGridRows:i,getSortByLastArrange:c,setSortByLastArrange:l,getLastArrangeOption:()=>d()??void 0,setLastArrangeOption:h,getCycleRowBuffer:u,setCycleRowBuffer:f,getArrangePresets:m,applyArrangePreset:y}),[s,n,o,r,a,i,c,l,d,h,u,f,m,y]),w=p.useMemo(()=>new Dy(g,x),[g,x]);return p.useEffect(()=>(pt.register("arrange",{name:"Arrange",getActions:()=>w.getActions()}),at.register("arrange",w),()=>{pt.unregister("arrange"),at.unregister("arrange")}),[w]),w}const Oy=[],Ly=[];function Wy({currentConfig:e,onConfigChange:s,facade:n,onExecuteArrange:o,canExecute:r}){const a=p.useCallback((c,l)=>{s({arrangeMode:c}),l!=null&&l.sortKey},[s]),i=p.useMemo(()=>({nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,sortByLastArrange:e.sortByLastArrange,sortKey:n.getConfig().sortKey,lastArrangeOption:n.getConfig().lastArrangeOption}),[e,n]);return t.jsxs("div",{className:"space-y-2","data-test":"arrange-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"arrange-action-selector",children:t.jsx(fa,{facade:n,mode:"record",selectedActionId:e.arrangeMode,onActionSelect:a,configOverride:i,onConfigChange:c=>{c.nodeGap!==void 0&&s({nodeGap:c.nodeGap}),c.gridColumns!==void 0&&s({gridColumns:c.gridColumns}),c.sortByLastArrange!==void 0&&s({sortByLastArrange:c.sortByLastArrange})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1","data-test":"arrange-config-section",children:[t.jsx(Ur,{nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,onNodeGapChange:c=>s({nodeGap:c}),onGridColumnsChange:c=>s({gridColumns:c}),onGridRowsChange:c=>s({gridRows:c}),compact:!0,showRows:!0}),t.jsxs(se,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(e.arrangeMode),disabled:!r,"data-test":"arrange-execute-button",children:[t.jsx(ft,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function Hy({isVisible:e,onClose:s,triggerPosition:n,onArrangeAction:o,onPresetApplied:r}){const[a,i]=p.useState(!1),[c,l]=p.useState(0),d=p.useRef({currentConfig:null,isEditingPreset:!1}),h=Dd(),u=p.useCallback(D=>{var V,J;return((J=(V=D.preferences)==null?void 0:V.arrangePresets)==null?void 0:J.presets)??Oy},[]),f=$(u),m=$(D=>{var V,J;return((J=(V=D.preferences)==null?void 0:V.arrangePresets)==null?void 0:J.favoriteIds)??Ly}),y=$(D=>{var V,J;return((J=(V=D.preferences)==null?void 0:V.arrangePresets)==null?void 0:J.activePresetId)??null}),g=$(D=>{var V,J;return((J=(V=D.preferences)==null?void 0:V.arrangeButton)==null?void 0:J.nodeGap)??ke.ARRANGE_NODE_GAP}),x=$(D=>{var V,J;return((J=(V=D.preferences)==null?void 0:V.arrangeButton)==null?void 0:J.gridColumns)??ke.ARRANGE_GRID_COLUMNS}),w=$(D=>D.getArrangeGridRows()),v=$(D=>{var V,J;return((J=(V=D.preferences)==null?void 0:V.arrangeButton)==null?void 0:J.sortByLastArrange)??!1}),N=$(D=>D.setArrangeNodeGap),b=$(D=>D.setArrangeGridColumns);$(D=>D.setArrangeGridRows);const A=$(D=>D.setSortByLastArrange),R=$(D=>D.createArrangePreset),k=$(D=>D.updateArrangePreset),S=$(D=>D.duplicateArrangePreset),E=$(D=>D.deleteArrangePreset),C=$(D=>D.renameArrangePreset),I=$(D=>D.applyArrangePreset),O=$(D=>D.toggleArrangePresetFavorite),H=$(D=>D.setActiveArrangePresetId),L=p.useMemo(()=>({getAll:()=>f,getById:D=>f.find(V=>V.id===D),getFavorites:()=>f.filter(D=>m.includes(D.id)),getFavoriteIds:()=>m,getActiveId:()=>y,create:(D,V)=>R(D,V),update:(D,V)=>{k(D,V)},updateConfig:(D,V)=>{const J=f.find(ie=>ie.id===D);J&&k(D,{config:{...J.config,...V}})},duplicate:D=>S(D),delete:D=>{E(D)},rename:(D,V)=>{C(D,V)},reorder:D=>{},apply:D=>{I(D)},setActive:D=>{H(D)},toggleFavorite:D=>{O(D)},isFavorite:D=>m.includes(D)}),[f,m,y,R,k,S,E,C,I,H,O]),W=p.useCallback(()=>({arrangeMode:"vertical",nodeGap:g,gridColumns:x,gridRows:w,sortByLastArrange:v}),[g,x,w,v]),P=p.useCallback(D=>{o&&(o(D),Ee.success(`Executed ${D} arrange`))},[o]),j=p.useCallback(D=>{o?(requestAnimationFrame(()=>{o(D.config.arrangeMode)}),Ee.success(`Applied and executed "${D.name}" (${D.config.arrangeMode})`),r&&r(D.id,D.name,()=>{I(D.id),o(D.config.arrangeMode)})):Ee.success(`Applied preset "${D.name}" settings`)},[o,r,I]),M=p.useCallback(D=>{d.current={currentConfig:D.currentConfig,isEditingPreset:D.isEditingPreset,editingPresetName:D.editingPresetName};const V=J=>{D.onConfigChange(J),d.current.currentConfig&&(d.current={...d.current,currentConfig:{...d.current.currentConfig,...J}}),a&&requestAnimationFrame(()=>{l(ie=>ie+1)}),J.nodeGap!==void 0&&N(J.nodeGap),J.gridColumns!==void 0&&b(J.gridColumns),J.sortByLastArrange!==void 0&&A(J.sortByLastArrange)};return t.jsx(Wy,{...D,onConfigChange:V,facade:h,onExecuteArrange:P,canExecute:!!o})},[h,P,o,N,b,A,a]),B=p.useCallback(()=>{a||l(D=>D+1),i(!a)},[a]),U=p.useCallback(()=>{l(D=>D+1)},[]),z=p.useMemo(()=>t.jsx("button",{className:`p-1 rounded hover:bg-accent transition-colors ${a?"bg-accent text-accent-foreground":""}`,onClick:B,"aria-label":a?"Hide debug panel":"Show debug panel",title:a?"Hide debug panel":"Show debug panel","data-test":"preset-debug-toggle",children:t.jsx(wa,{size:14})}),[a,B]),_=["activePreset","allPresets"],G=p.useMemo(()=>{const D=d.current,V=y?f.find(ie=>ie.id===y):null,J={mode:D.isEditingPreset?"editing":"creating",editingPresetName:D.editingPresetName||null,currentConfig:D.currentConfig,activePreset:V?{id:V.id,name:V.name,config:V.config}:null,allPresets:f.map(ie=>({id:ie.id,name:ie.name,isFavorite:m.includes(ie.id),config:ie.config}))};return Object.fromEntries(Object.entries(J).filter(([ie])=>!_.includes(ie)))},[c,y,f,m]),F=p.useMemo(()=>n?{x:n.x+400,y:n.y}:{x:500,y:100},[n]);return t.jsxs(t.Fragment,{children:[t.jsx(Id,{isVisible:e,onClose:s,triggerPosition:n,title:"Arrange Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:M,getCurrentConfig:W,presetActions:L,onApplyPreset:j,headerActions:z}),t.jsx(et,{isVisible:e&&a,onClose:()=>i(!1),title:"Preset Debug",triggerPosition:F,initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:U,"aria-label":"Refresh debug data",title:"Refresh debug data","data-test":"preset-debug-refresh",children:t.jsx(Wr,{size:14})}),children:t.jsx("div",{className:"p-3 overflow-auto h-full font-mono text-xs","data-test":"preset-debug-content",children:t.jsx("pre",{className:"whitespace-pre-wrap break-words",children:JSON.stringify(G,null,2)})})})]})}function Fy({isVisible:e,onClose:s,triggerPosition:n}){const o=$(g=>{var x,w;return((w=(x=g.preferences)==null?void 0:x.arrangeButton)==null?void 0:w.nodeGap)??ke.ARRANGE_NODE_GAP}),r=$(g=>{var x,w;return((w=(x=g.preferences)==null?void 0:x.arrangeButton)==null?void 0:w.gridColumns)??ke.ARRANGE_GRID_COLUMNS}),a=$(g=>g.getArrangeGridRows()),i=$(g=>g.setArrangeNodeGap),c=$(g=>g.setArrangeGridColumns),l=$(g=>g.setArrangeGridRows),d=$(g=>g.toggleArrangeConfigFavorite),h=$(g=>g.isArrangeConfigFavorite),u=p.useCallback((g,x)=>{const w=h(g,x);d(g,x),Ee.success(w?"Removed from favorites":"Added to favorites")},[d,h]),f=h("gap",o),m=h("columns",r),y=h("rows",a);return t.jsx(et,{isVisible:e,onClose:s,title:"Arrange Config",triggerPosition:n,initialSize:{width:280,height:200},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3","data-test":"arrange-config-content",children:t.jsx(Ur,{nodeGap:o,gridColumns:r,gridRows:a,onNodeGapChange:i,onGridColumnsChange:c,onGridRowsChange:l,showFavorites:!0,showRows:!0,isGapFavorite:f,isColumnsFavorite:m,isRowsFavorite:y,onToggleGapFavorite:()=>u("gap",o),onToggleColumnsFavorite:()=>u("columns",r),onToggleRowsFavorite:()=>u("rows",a)})})})}const By=[],zy=[],$y=[],dc="canvas-arrange-nodes",_y=()=>{const e=Dd(),n=$(M=>Ge.selectSelectedNodes(M).length)<2,o=$(M=>{var B,U;return((U=(B=M.preferences)==null?void 0:B.arrangePresets)==null?void 0:U.presets)??By}),r=$(M=>{var B,U;return((U=(B=M.preferences)==null?void 0:B.arrangePresets)==null?void 0:U.favoriteIds)??$y}),a=p.useMemo(()=>o.filter(M=>r.includes(M.id)),[o,r]),i=$(M=>{var B;return((B=M.preferences)==null?void 0:B.arrangeConfigFavorites)??zy}),c=$(M=>{var B,U;return((U=(B=M.preferences)==null?void 0:B.arrangeButton)==null?void 0:U.nodeGap)??ke.ARRANGE_NODE_GAP}),l=$(M=>{var B,U;return((U=(B=M.preferences)==null?void 0:B.arrangeButton)==null?void 0:U.gridColumns)??ke.ARRANGE_GRID_COLUMNS}),d=$(M=>M.getArrangeGridRows()),h=$(M=>M.setArrangeNodeGap),u=$(M=>M.setArrangeGridColumns),f=$(M=>M.setArrangeGridRows),[m,y]=p.useState(!1),[g,x]=p.useState(),w=p.useRef(null),v=p.useRef(null),[N,b]=p.useState(!1),[A,R]=p.useState(),k=p.useRef(null),S=p.useCallback(()=>{if(w.current){const M=w.current.getBoundingClientRect();x({x:M.left,y:M.bottom+4})}y(!0)},[]),E=p.useCallback(()=>{y(!1)},[]),C=p.useCallback(()=>{if(N)b(!1);else{if(k.current){const M=k.current.getBoundingClientRect();R({x:M.left,y:M.bottom+4})}b(!0)}},[N]),I=p.useCallback(()=>{b(!1)},[]),O=p.useCallback((M,B,U)=>{v.current=U,T.getState().setSegmentedButtonAction(dc,B,()=>v.current)},[]),H=p.useCallback(M=>{e.execute(M)},[e]),L=p.useCallback(M=>{var z;const B=o.find(_=>_.name===M);if(B)return()=>e.executePreset(B.id);const U=e.getActions();for(const _ of U){if(_.label===M)return()=>e.execute(_.id);const G=(z=_.subActions)==null?void 0:z.find(F=>F.title===M);if(G)return()=>e.execute(G.id)}return null},[o,e]),W=p.useCallback((M,B,U)=>{e.executePreset(M),U(B,()=>e.executePreset(M))},[e]),P=[{width:"180px",actions:[{label:"Arrange Actions",customRender:({registerRepeatAction:M})=>t.jsx(fa,{facade:e,mode:"execute",onActionExecuted:M,categories:["Vertical","Horizontal","Layout"]})}]},{width:"230px",actions:[{label:"Presets",customRender:({registerRepeatAction:M})=>t.jsxs("div",{"data-test":"arrange-presets-section",children:[t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Presets"}),t.jsxs("button",{ref:w,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:S,"data-test":"arrange-presets-button",children:[t.jsx(Pr,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),a.length>0&&t.jsxs("div",{className:"px-3 py-1","data-test":"arrange-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"arrange-favorite-presets-grid",children:a.map(B=>t.jsxs(se,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:U=>{U.stopPropagation(),W(B.id,B.name,M)},title:`Apply & Execute: ${B.name}`,"data-test":"arrange-favorite-preset-button",children:[t.jsx(ft,{className:"h-2 w-2 mr-1"}),B.name]},B.id))})]})]})},{label:"Sort Actions",customRender:({registerRepeatAction:M})=>t.jsxs("div",{"data-test":"arrange-sort-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Sort"}),t.jsx(fa,{facade:e,mode:"execute",onActionExecuted:M,categories:["Sort"]})]})},{label:"Config",customRender:()=>{const M=i.filter(_=>_.type==="gap"),B=i.filter(_=>_.type==="columns"),U=i.filter(_=>_.type==="rows"),z=i.length>0;return t.jsxs("div",{"data-test":"arrange-config-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsxs("div",{className:"px-3 py-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Config"}),t.jsx("button",{ref:k,className:"p-0.5 rounded hover:bg-accent",onClick:C,title:"Toggle config popover","data-test":"arrange-config-button",children:t.jsx(go,{className:"h-3 w-3 text-muted-foreground"})})]}),z&&t.jsxs("div",{className:"px-3 py-1 space-y-1.5","data-test":"arrange-config-quick-access-section",children:[M.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Gap:"}),t.jsx(ze,{type:"number",min:"0",max:"200",value:c,onChange:_=>h(Math.max(0,Math.min(200,parseInt(_.target.value)||0))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-gap-input"})]}),B.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-cols-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Cols:"}),t.jsx(ze,{type:"number",min:"1",max:"10",value:l,onChange:_=>u(Math.max(1,Math.min(10,parseInt(_.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-cols-input"})]}),U.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Rows:"}),t.jsx(ze,{type:"number",min:"1",max:"10",value:d,onChange:_=>f(Math.max(1,Math.min(10,parseInt(_.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-rows-input"})]})]})]})}}]}],j={label:"Arrange",icon:t.jsx(ep,{className:"h-2.5 w-2.5"}),onClick:()=>e.execute("vertical"),disabled:n,disabledTooltip:"Select at least 2 nodes to arrange"};return t.jsxs(t.Fragment,{children:[t.jsx(rt,{mainAction:j,dropdownColumns:P,variant:"outline",size:"compact",persistenceKey:dc,facade:e,restoreRepeatAction:L,"data-test":"canvas-arrange-nodes-button"}),t.jsx(Hy,{isVisible:m,onClose:E,triggerPosition:g,onArrangeAction:H,onPresetApplied:O}),t.jsx(Fy,{isVisible:N,onClose:I,triggerPosition:A})]})};function Vr(){const e=$(d=>{var h,u;return((u=(h=d.actions)==null?void 0:h.history)==null?void 0:u.entries)??js}),s=$(d=>{var h,u;return(u=(h=d.actions)==null?void 0:h.history)==null?void 0:u.lastAction}),n=$(d=>d.getGlobalActionHistory),o=$(d=>d.getGlobalLastAction),r=$(d=>d.clearGlobalActionHistory),a=$(d=>d.executeGlobalLastAction),i=$(d=>d.executeActionById),c=$(d=>d.hasExecutor),l=p.useCallback(d=>i(d.executorId),[i]);return{history:e,lastAction:s,getHistory:n,getLastAction:o,clearHistory:r,executeLastAction:a,executeAction:l,hasExecutor:c}}class Uy{fromHistoryEntry(s){if(!s.actionId)return console.warn("ActionReferenceResolver: Cannot create reference without actionId"),null;const n=this.extractFacadeKeyFromSource(s.source);return n?{facadeKey:n,actionId:s.actionId,params:s.params,label:s.label}:(console.warn(`ActionReferenceResolver: Cannot derive facadeKey from source "${s.source}"`),null)}extractFacadeKeyFromSource(s){const n={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(n[s])return n[s];const o=s.split("-");return o.length>=2?o[1]:null}execute(s){const n=at.get(s.facadeKey);if(!n)return{success:!1,error:`Facade "${s.facadeKey}" not found in registry`};try{return n.execute(s.actionId,s.params),{success:!0}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async executeSequence(s,n){const o=[];for(let r=0;r<s.length;r++){const{action:a,delayMs:i}=s[r],c=Math.max(i,ke.PRESET_STEP_DELAY_MS);r>0&&await new Promise(d=>setTimeout(d,c));const l=this.execute(a);o.push(l),n==null||n(r,l),l.success||console.warn(`ActionReferenceResolver: Step ${r} failed for "${a.label}": ${l.error}`)}return o}}const Vy=new Uy,Gy=[],Yy=[];function Gr(){const e=Ot(T,h=>{var u,f;return((f=(u=h.actions)==null?void 0:u.sequencePresets)==null?void 0:f.presets)??Gy}),s=Ot(T,h=>{var u,f;return((f=(u=h.actions)==null?void 0:u.sequencePresets)==null?void 0:f.favoriteIds)??Yy}),n=p.useCallback(h=>T.getState().getSequencePresetById(h),[]),o=p.useCallback((h,u)=>T.getState().createSequencePreset(h,u),[]),r=p.useCallback((h,u)=>{T.getState().updateSequencePreset(h,u)},[]),a=p.useCallback(h=>T.getState().duplicateSequencePreset(h),[]),i=p.useCallback(h=>{T.getState().deleteSequencePreset(h)},[]),c=p.useCallback(h=>{T.getState().toggleSequencePresetFavorite(h)},[]),l=p.useCallback(h=>s.includes(h),[s]),d=p.useCallback(async h=>{const u=T.getState().getSequencePresetById(h);if(!u){console.warn(`useSequencePresets: Preset "${h}" not found`);return}const f=u.steps.map(m=>({action:m.action,delayMs:m.delayMs}));await Vy.executeSequence(f)},[]);return{presets:e,favoriteIds:s,getPresetById:n,createPreset:o,updatePreset:r,duplicatePreset:a,deletePreset:i,toggleFavorite:c,isFavorite:l,executePreset:d}}const Xy=({presetsButtonRef:e,onOpenPresetsPopover:s,closeDropdown:n,favoritePresets:o,onExecutePreset:r,dataTestPrefix:a,maxFavorites:i=6})=>{const c=()=>{n==null||n(),s()};return t.jsxs("div",{"data-test":"preset-and-quick-access-section",children:[t.jsxs("button",{ref:e,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:c,"data-test":"preset-and-quick-access-presets-button",children:[t.jsx(Pr,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),o.length>0&&t.jsxs("div",{className:"px-3 py-1.5 border-t border-border/50 mt-1","data-test":"preset-quick-access-section",children:[t.jsx("div",{className:"text-[10px] text-muted-foreground mb-1.5",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-1","data-test":"preset-favorite-presets-grid",children:o.slice(0,i).map(l=>t.jsxs(se,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:d=>{d.stopPropagation(),r(l.id,l.name)},title:`Execute: ${l.name}`,"data-test":"preset-favorite-preset-button",children:[t.jsx(ft,{className:"h-2.5 w-2.5 mr-1"}),l.name]},l.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},Ky=[];function qy(){const e=Ot(T,a=>{var i,c;return((c=(i=a.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)??Ky}),s=p.useCallback(a=>T.getState().getVisualWorkflowPresetById(a),[]),n=p.useCallback((a,i,c)=>T.getState().createVisualWorkflowPreset(a,i,c),[]),o=p.useCallback((a,i)=>{T.getState().updateVisualWorkflowPreset(a,i)},[]),r=p.useCallback(a=>{T.getState().deleteVisualWorkflowPreset(a)},[]);return{visualWorkflows:e,getPresetById:s,createPreset:n,updatePreset:o,deletePreset:r}}const Zy={content:!0,title:!1,id:!1,type:!1,tags:!1},Jy={horizontal:"Horizontal",vertical:"Vertical",grid:"Grid",masonry:"Masonry"},Qy={GAP:Q.arrange.gap,LANE_GAP:Q.slice.laneGap,LANE_HEADER_OFFSET:Q.slice.laneHeaderOffset,GRID_COLUMNS:Q.arrange.gridColumns},{GAP:Ht,LANE_GAP:ew,LANE_HEADER_OFFSET:Gn,GRID_COLUMNS:Xt}=Qy,tw=e=>{const s=new Map;for(const n of e)if(n.tags)for(const o of n.tags)s.has(o.title)||s.set(o.title,o);return Array.from(s.values()).sort((n,o)=>n.title.localeCompare(o.title))},Yr=(e,s)=>{var n;return((n=e.tags)==null?void 0:n.some(o=>o.title===s))??!1},Od=(e,s)=>e.filter(n=>Yr(n,s)),Ld=100,Wd=200,ws=e=>e.height??Ld,ln=e=>e.width??Wd,sw=(e,s)=>{if(e.length===0)return Ld;switch(s){case"horizontal":return Math.max(...e.map(ws));case"vertical":return e.reduce((o,r)=>o+ws(r),0)+(e.length-1)*Ht;case"grid":{const n=Math.ceil(e.length/Xt);let o=0;for(let r=0;r<n;r++){const a=r*Xt,i=Math.min(a+Xt,e.length),c=e.slice(a,i),l=Math.max(...c.map(ws));o+=l}return o+(n-1)*Ht}case"masonry":{const n=Array(Xt).fill(0);return e.forEach(o=>{const r=n.indexOf(Math.min(...n));n[r]+=ws(o)+Ht}),Math.max(...n)-Ht}}},nw=(e,s,n,o)=>{const r=[];switch(o){case"horizontal":{let a=s;e.forEach(i=>{r.push({id:i.id,x:a,y:n+Gn}),a+=ln(i)+Ht});break}case"vertical":{let a=n+Gn;e.forEach(i=>{r.push({id:i.id,x:s,y:a}),a+=ws(i)+Ht});break}case"grid":{const a=Math.ceil(e.length/Xt),i=[n+Gn];for(let l=0;l<a-1;l++){const d=l*Xt,h=Math.min(d+Xt,e.length),u=e.slice(d,h),f=Math.max(...u.map(ws));i.push(i[l]+f+Ht)}const c=Math.max(...e.map(ln));e.forEach((l,d)=>{const h=Math.floor(d/Xt);r.push({id:l.id,x:s+d%Xt*(c+Ht),y:i[h]})});break}case"masonry":{const a=Math.max(...e.map(ln)),i=Array(Xt).fill(0);e.forEach(c=>{const l=i.indexOf(Math.min(...i));r.push({id:c.id,x:s+l*(a+Ht),y:n+Gn+i[l]}),i[l]+=ws(c)+Ht});break}}return r},ow=(e,s)=>{if(e.length===0)return Wd;switch(s){case"horizontal":return e.reduce((o,r)=>o+ln(r),0)+(e.length-1)*Ht;case"vertical":return Math.max(...e.map(ln));case"grid":case"masonry":{const n=Math.max(...e.map(ln)),o=Math.min(e.length,Xt);return o*n+(o-1)*Ht}}},aw=(e,s,n="horizontal")=>{if(s.length===0)return{updates:[],laneCount:0,nodesPerLane:new Map,lanes:[]};const o=[...s].sort(),r=[],a=new Map,i=[],c=new Set,l=Math.min(...e.map(u=>u.x));let d=0;o.forEach(u=>{const f=Od(e,u).filter(x=>!c.has(x.id));if(f.length===0)return;const m=nw(f,l,d,n);r.push(...m),f.forEach(x=>c.add(x.id)),a.set(u,f.length);const y=sw(f,n),g=ow(f,n);i.push({tagTitle:u,nodeIds:f.map(x=>x.id),bounds:{x:l,y:d,width:g,height:y+Gn}}),d+=y+ew});const h=e.filter(u=>!c.has(u.id));if(h.length>0){const u=[...h].sort((m,y)=>m.y-y.y);let f=d;for(const m of u)r.push({id:m.id,x:l,y:f}),f+=ws(m)+Ht}return{updates:r,laneCount:o.length,nodesPerLane:a,lanes:i}},rw=(e,s)=>{const n=new Map;for(const o of s){const r=e.filter(a=>Yr(a,o.title)).length;n.set(o.title,r)}return n},iw={split:{whitespace:{facadeKey:"split",actionId:"byWhitespace"},line:{facadeKey:"split",actionId:"byLine"},paragraph:{facadeKey:"split",actionId:"byParagraph"},comma:{facadeKey:"split",actionId:"byComma"},period:{facadeKey:"split",actionId:"byPeriod"}},arrange:{horizontal:{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:top":{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:center":{facadeKey:"arrange",actionId:"horizontal:center"},"horizontal:bottom":{facadeKey:"arrange",actionId:"horizontal:bottom"},vertical:{facadeKey:"arrange",actionId:"vertical:left"},"vertical:left":{facadeKey:"arrange",actionId:"vertical:left"},"vertical:center":{facadeKey:"arrange",actionId:"vertical:center"},"vertical:right":{facadeKey:"arrange",actionId:"vertical:right"},grid:{facadeKey:"arrange",actionId:"grid"},masonry:{facadeKey:"arrange",actionId:"masonry"}},align:{left:{facadeKey:"alignment",actionId:"left"},center:{facadeKey:"alignment",actionId:"center"},right:{facadeKey:"alignment",actionId:"right"},top:{facadeKey:"alignment",actionId:"top"},middle:{facadeKey:"alignment",actionId:"middle"},bottom:{facadeKey:"alignment",actionId:"bottom"}},group:{create:{facadeKey:"grouping",actionId:"group"},ungroup:{facadeKey:"grouping",actionId:"ungroup"}},collapse:{collapse:{facadeKey:"collapse",actionId:"collapse"},expand:{facadeKey:"collapse",actionId:"expand"}}};function cw(e,s){const n=iw[e];if(!n)return null;const o=n[s];return o||null}function lw(e){return e.type==="GROUP"&&Yr(e,"workflow")}function dw(e){if(e.type===fe.WORKFLOW_STEP){const o=e.data;if(!(o!=null&&o.stepType))return console.warn(`VisualWorkflowParser: WORKFLOW_STEP node ${e.id} has no stepType configured`),null;const a={toolbarAction:"toolbarAction",if:"if",tagUpdate:"nodeUpdate",loop:"loop",source:"source"}[o.stepType];if(!a)return console.warn(`VisualWorkflowParser: Unknown stepType "${o.stepType}" in node ${e.id}`),null;let i=o.config;return{nodeId:e.id,order:0,stepType:a,config:i||{},label:e.title||o.stepType}}const s=(e.title||"").trim().toLowerCase();if(!s)return null;const n=s.match(/^([^:]+):\s*(.+)$/);if(n){const[,o,r]=n,a=o.trim(),i=r.trim();if(a==="if")return{nodeId:e.id,order:0,stepType:"if",config:{condition:i},label:`If: ${i}`};if(a==="tag")return{nodeId:e.id,order:0,stepType:"nodeUpdate",config:{simpleFieldUpdates:[{field:"tags",template:i}]},label:`Tag: ${i}`};const c=cw(a,i);return c?{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:c.facadeKey,actionId:c.actionId,params:c.params||{}},label:`${a}: ${i}`}:{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:a,actionId:i,params:{}},label:`${a}: ${i}`}}return s==="loop"?{nodeId:e.id,order:0,stepType:"loop",config:{},label:"Loop"}:s==="source"?{nodeId:e.id,order:0,stepType:"source",config:{},label:"Source"}:(console.warn(`VisualWorkflowParser: Unknown step pattern "${s}"`),null)}function uw(e,s){const n=new Map,o=new Map;e.forEach(c=>{n.set(c.id,[]),o.set(c.id,0)}),s.forEach(c=>{if(c.startNodeId&&c.endNodeId){const l=n.get(c.startNodeId)||[];l.push(c.endNodeId),n.set(c.startNodeId,l),o.set(c.endNodeId,(o.get(c.endNodeId)||0)+1)}});const r=[];o.forEach((c,l)=>{c===0&&r.push(l)});const a=[],i=new Map(e.map(c=>[c.id,c]));for(;r.length>0;){const c=r.shift(),l=i.get(c);l&&a.push(l),(n.get(c)||[]).forEach(h=>{const u=(o.get(h)||0)-1;o.set(h,u),u===0&&r.push(h)})}return a.length!==e.length?(console.warn("VisualWorkflowParser: Cycle detected in workflow graph"),e):a}function xr(e,s,n){const o=e.data,r=(o==null?void 0:o.childNodeIds)||[];if(r.length===0)return[];const a=s.filter(d=>r.includes(d.id)),i=n.filter(d=>d.startNodeId&&d.endNodeId&&r.includes(d.startNodeId)&&r.includes(d.endNodeId)),c=uw(a,i),l=[];return c.forEach((d,h)=>{const u=dw(d);u&&(u.order=h+1,l.push(u))}),l}function hw(e){return e.map(s=>({id:`visual_step_${s.nodeId}`,label:s.label,order:s.order,stepType:s.stepType,config:s.config}))}function Hd(e,s){return{id:`${e}_orchestration`,type:fe.WORKFLOW_ORCHESTRATION,x:0,y:0,width:200,height:100,title:"Visual Workflow",content:"",data:{nodeType:"workflowOrchestration",parameters:{rows:s}}}}async function pw(e,s,n,o=[]){try{const r=xr(e,s,n);if(r.length===0)return{success:!1,error:"No workflow steps found in group",nodeUpdates:[]};const a=hw(r),i=Hd(e.id,a),c=[i,...s],l=n,d=new fn;d.loadWorkflow(c,l);const h=await d.executeWorkflow(i.id,o),u=h.nodeUpdates||[];return{success:h.success,error:h.error,nodeUpdates:u,executionId:h.executionId,duration:h.duration}}catch(r){return console.error("VisualWorkflowAdapter: Execution error:",r),{success:!1,error:r instanceof Error?r.message:String(r),nodeUpdates:[]}}}function gw(e){return e.map((s,n)=>({id:`preset_step_${s.id}`,label:s.label,order:n,stepType:s.stepType,config:s.config}))}async function fw(e){try{const s=T.getState(),n=s.projectCanvas.getActive();if(!n)return{success:!1,error:"No active canvas",nodeUpdates:[]};const o=n.coreState.selectedNodes,r=n.coreState.nodes,a=n.coreState.arrows;if(e.steps.length===0)return{success:!1,error:"No workflow steps in preset",nodeUpdates:[]};const i=gw(e.steps),c=Hd(`preset_${e.id}`,i),l=[c,...r],d=a,h=new fn;h.loadWorkflow(l,d);const u=await h.executeWorkflow(c.id,o),f=u.nodeUpdates||[];return u.success&&f.length>0&&f.forEach(({nodeId:m,updates:y})=>{s.updateNode(m,y)}),{success:u.success,error:u.error,nodeUpdates:f,executionId:u.executionId,duration:u.duration}}catch(s){return console.error("VisualWorkflowAdapter: Preset execution error:",s),{success:!1,error:s instanceof Error?s.message:String(s),nodeUpdates:[]}}}const mw=({onStartRecording:e,onStartSelection:s,isRecording:n=!1,capturedStepsCount:o=0,onStopRecording:r,onCancelRecording:a,className:i})=>{const{presets:c,executePreset:l,deletePreset:d,duplicatePreset:h,updatePreset:u,toggleFavorite:f,isFavorite:m}=Gr(),{visualWorkflows:y,deletePreset:g,updatePreset:x}=qy(),[w,v]=p.useState(null),[N,b]=p.useState([]),[A,R]=p.useState(void 0),k=p.useRef({x:0,y:0});p.useEffect(()=>{const D=V=>{k.current={x:V.clientX,y:V.clientY}};return window.addEventListener("mousemove",D),()=>window.removeEventListener("mousemove",D)},[]);const S=p.useCallback(async D=>{const V=c.find(J=>J.id===D);V&&(await l(D),T.getState().setSegmentedButtonAction("sequence-presets-panel",V.name,()=>()=>{l(D)}))},[l,c]),E=p.useCallback(D=>{R({...k.current}),v(D),b(D.steps.map(V=>({...V})))},[]),C=p.useCallback(()=>{w&&u(w.id,{steps:N}),v(null),b([])},[w,N,u]),I=p.useCallback(()=>{v(null),b([])},[]),O=p.useCallback(D=>{h(D)},[h]),H=p.useCallback(D=>{const V=T.getState();V.projectCanvas.switch(D.canvasId),setTimeout(()=>{V.scrollToNode(D.groupNodeId,500)},100)},[]),[L,W]=p.useState(null),P=p.useCallback(async D=>{if(!L){W(D.id);try{const V=await fw(D);V.success?Ee.success(`Executed: ${D.name}`,{description:`${V.nodeUpdates.length} node${V.nodeUpdates.length!==1?"s":""} updated`,duration:3e3}):Ee.error(`Failed: ${D.name}`,{description:V.error||"Unknown error",duration:4e3})}catch(V){Ee.error("Execution failed",{description:V instanceof Error?V.message:"Unknown error",duration:4e3})}finally{W(null)}}},[L]),j=p.useMemo(()=>c.map(D=>({id:D.id,label:D.name,data:D})),[c]),M=p.useCallback(D=>{console.log("Preset reorder:",D.map(V=>V.id))},[]),B=p.useCallback(D=>[{id:"execute",icon:t.jsx(ft,{className:"h-3 w-3"}),title:"Execute preset",onClick:()=>S(D.id)}],[S]),U=p.useCallback(D=>{const V=D.data,J=m(V.id);return[{id:"toggle-favorite",label:J?"Remove from favorites":"Add to favorites",icon:t.jsx(an,{className:Ie("h-4 w-4 mr-2",J&&"fill-yellow-400 text-yellow-400")}),onClick:()=>f(V.id)},{id:"rename",label:"Rename",icon:t.jsx(Fs,{className:"h-4 w-4 mr-2"}),onClick:()=>{const ie=window.prompt("Rename preset:",V.name);ie&&ie.trim()&&ie!==V.name&&u(V.id,{name:ie.trim()})}},{id:"edit-steps",label:"Edit steps",icon:t.jsx(Tl,{className:"h-4 w-4 mr-2"}),onClick:()=>E(V)},{id:"duplicate",label:"Duplicate",icon:t.jsx(Bt,{className:"h-4 w-4 mr-2"}),onClick:()=>O(D.id)}]},[O,E,u,f,m]),z=p.useMemo(()=>N.map((D,V)=>({id:D.id,label:`${V+1}. ${D.action.label}`,data:D})),[N]),_=p.useCallback(D=>{const V=D.map(J=>J.data);b(V)},[]),G=p.useCallback(D=>{b(V=>V.filter(J=>J.id!==D))},[]),F=p.useCallback((D,V,J,ie)=>{const Se=D.data;return t.jsxs("div",{"data-test":"edit-step-item",children:[ie,t.jsxs("div",{className:"pl-8 -mt-1 mb-1 text-[10px] text-muted-foreground",children:[Se.action.facadeKey," → ",Se.action.actionId]})]})},[]);return t.jsxs("div",{className:Ie("flex flex-col h-full",i),"data-test":"sequence-presets-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"presets-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:n?t.jsxs(t.Fragment,{children:[t.jsx(Ca,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",o,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(Bs,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[c.length+y.length," preset",c.length+y.length!==1?"s":""]})]})}),n?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(se,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:D=>r==null?void 0:r({x:D.clientX,y:D.clientY}),"data-test":"presets-stop-recording",children:"Stop"}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:a,"data-test":"presets-cancel-recording",children:"Cancel"})]}):t.jsxs(to,{children:[t.jsx(Ko,{asChild:!0,children:t.jsxs(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs","data-test":"presets-create-button",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"}),"New"]})}),t.jsxs(so,{align:"end",style:{zIndex:We.draggablePopoverDropdown},children:[t.jsx(nt,{onClick:e,"data-test":"presets-create-from-recording",children:"Record actions"}),t.jsx(nt,{onClick:s,"data-test":"presets-create-from-selection",children:"Select from history"})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"presets-list",children:c.length===0&&y.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(Bs,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No presets yet"}),t.jsx("span",{className:"text-xs text-center",children:"Create a preset to save action sequences"})]}):t.jsxs(t.Fragment,{children:[c.length>0&&t.jsx(gn,{data:j,onDelete:d,onReorder:M,enableEdit:!1,enableDelete:!0,enableDrag:!0,quickActions:B,moreOptionsItems:U,dropdownZIndex:We.draggablePopoverDropdown,className:"py-1"}),y.length>0&&t.jsxs("div",{"data-test":"visual-workflow-presets",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-muted/50 border-y border-border/50",children:[t.jsx(Hs,{className:"h-3 w-3 text-muted-foreground"}),t.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wider",children:["Visual Workflows (",y.length,")"]})]}),t.jsx("div",{className:"py-1",children:y.map(D=>t.jsxs("div",{className:Ie("group flex items-center gap-2 px-3 py-2 hover:bg-muted/50 transition-colors",D.sourceLocation&&"cursor-pointer"),onClick:()=>{D.sourceLocation&&H(D.sourceLocation)},"data-test":"visual-workflow-item",children:[t.jsx(Hs,{className:"h-3.5 w-3.5 text-primary/70 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm font-medium truncate",children:D.name}),t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:[D.steps.length," step",D.steps.length!==1?"s":""," • ",D.steps.map(V=>V.stepType).filter((V,J,ie)=>ie.indexOf(V)===J).join(", ")]})]}),t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx(se,{variant:"ghost",size:"sm",className:Ie("h-6 w-6 p-0",L===D.id&&"text-primary animate-pulse"),onClick:V=>{V.stopPropagation(),P(D)},disabled:L!==null,title:L===D.id?"Executing...":"Execute workflow","data-test":"visual-workflow-execute-button",children:t.jsx(ft,{className:"h-3 w-3"})}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:V=>{V.stopPropagation();const J=window.prompt("Rename workflow:",D.name);J&&J.trim()&&J!==D.name&&x(D.id,{name:J.trim()})},title:"Rename","data-test":"visual-workflow-rename-button",children:t.jsx(Fs,{className:"h-3 w-3"})}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:text-destructive",onClick:V=>{V.stopPropagation(),g(D.id)},title:"Delete","data-test":"visual-workflow-delete-button",children:t.jsx(Nt,{className:"h-3 w-3"})})]})]},D.id))})]})]})}),t.jsx(et,{isVisible:!!w,onClose:I,title:`Edit Steps: ${(w==null?void 0:w.name)??""}`,initialSize:{width:360,height:380},triggerPosition:A,resizable:!0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"edit-steps-popover",children:[t.jsxs("div",{className:"flex-1 px-4 py-2 overflow-y-auto",children:[t.jsxs(Fe,{className:"text-xs text-muted-foreground mb-2 block",children:["Steps (",N.length,") - drag to reorder"]}),N.length===0?t.jsx("div",{className:"text-xs text-muted-foreground text-center py-4",children:"No steps in this preset"}):t.jsx(gn,{data:z,onDelete:G,onReorder:_,enableEdit:!1,enableDelete:!0,enableDrag:!0,renderNode:F,dropdownZIndex:We.draggablePopoverDropdown+10,className:"text-xs"})]}),t.jsxs("div",{className:"px-4 py-3 border-t bg-muted/20 flex justify-end gap-2",children:[t.jsx(se,{variant:"outline",size:"sm",onClick:I,"data-test":"edit-steps-cancel",children:"Cancel"}),t.jsx(se,{size:"sm",onClick:C,disabled:N.length===0,"data-test":"edit-steps-save",children:"Save"})]})]})})]})},xw=[];function yw(){const e=Ot(T,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.isRecording)??!1}),s=Ot(T,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.capturedSteps)??xw}),n=Ot(T,c=>{var l,d;return(d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.startedAt}),o=p.useCallback(()=>{T.getState().startRecording()},[]),r=p.useCallback(()=>T.getState().stopRecording(),[]),a=p.useCallback(()=>{T.getState().cancelRecording()},[]),i=p.useMemo(()=>n?Date.now()-n:0,[n]);return{isRecording:e,capturedSteps:s,startedAt:n,startRecording:o,stopRecording:r,cancelRecording:a,recordingDuration:i}}const ww=[],vw=[],bw=e=>{const s={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(s[e])return s[e];const n=e.split("-");return n.length>=2?n[1]:null};function Nw(){const e=Ot(T,d=>{var h,u;return((u=(h=d.actions)==null?void 0:h.historySelection)==null?void 0:u.isSelecting)??!1}),s=Ot(T,d=>{var h,u;return((u=(h=d.actions)==null?void 0:h.historySelection)==null?void 0:u.selectedIds)??ww}),n=Ot(T,d=>{var h,u;return((u=(h=d.actions)==null?void 0:h.history)==null?void 0:u.entries)??vw}),o=p.useCallback(()=>{T.getState().toggleHistorySelectionMode()},[]),r=p.useCallback(d=>{T.getState().toggleHistoryItemSelection(d)},[n,s]),a=p.useCallback(d=>s.includes(d),[s]),i=p.useCallback(()=>{T.getState().clearHistorySelection()},[]),c=p.useCallback(()=>{const d=new Map;n.forEach(u=>{d.set(u.executorId,u)});const h=[];for(const u of s){const f=d.get(u);if(!f)continue;const m=bw(f.source);if(!m||!f.actionId)continue;const y={facadeKey:m,actionId:f.actionId,params:f.params,label:f.label};h.push({id:Ve(8),action:y,delayMs:0})}return h},[s,n]),l=p.useMemo(()=>s.length,[s]);return{isSelecting:e,selectedIds:s,toggleSelectionMode:o,toggleItemSelection:r,isSelected:a,clearSelection:i,getSelectedAsSteps:c,selectionCount:l}}const Fd=({initialTab:e="history",onTabChange:s})=>{const{history:n,executeAction:o,hasExecutor:r,clearHistory:a}=Vr(),[i,c]=p.useState(e),{isRecording:l,capturedSteps:d,startRecording:h,stopRecording:u,cancelRecording:f}=yw(),{isSelecting:m,toggleSelectionMode:y,toggleItemSelection:g,isSelected:x,clearSelection:w,getSelectedAsSteps:v,selectionCount:N}=Nw(),{createPreset:b}=Gr(),[A,R]=p.useState(!1),[k,S]=p.useState(""),[E,C]=p.useState([]),[I,O]=p.useState(void 0),H=p.useCallback(D=>{const V=D;c(V),s==null||s(V)},[s]),L=D=>new Date(D).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),W=D=>D.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(V=>V.charAt(0).toUpperCase()+V.slice(1)).join(" "),P=p.useCallback(D=>{o(D)},[o]),j=p.useCallback(()=>{h()},[h]),M=p.useCallback(D=>{const V=u();V.length>0&&(C(V),S(`Preset ${new Date().toLocaleTimeString()}`),O(D),R(!0))},[u]),B=p.useCallback(()=>{y(),c("history")},[y]),U=p.useCallback(()=>{const D=v();D.length>0&&(C(D),S(`Preset ${new Date().toLocaleTimeString()}`),R(!0),w())},[v,w]),z=p.useCallback(()=>{k.trim()&&E.length>0&&(b(k.trim(),E),R(!1),S(""),C([]),c("presets"))},[k,E,b]),_=p.useCallback(()=>{R(!1),S(""),C([])},[]),G=(D,V)=>{const J=V===0,ie=r(D.executorId,D.actionId),Se=x(D.executorId);return t.jsxs("div",{className:Ie("group flex items-center gap-2 px-3 py-2 text-sm","border-b border-border/50 last:border-b-0",J&&"bg-primary/5",!ie&&"opacity-50",Se&&"bg-primary/10"),"data-test":"action-history-item",children:[m?t.jsx(Xe,{checked:Se,onCheckedChange:()=>g(D.executorId),className:"h-4 w-4","data-test":"action-history-select"}):t.jsx("div",{className:Ie("flex-shrink-0 w-5 h-5 rounded text-[10px] font-medium flex items-center justify-center",J?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:V+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:Ie("font-medium truncate",J&&"text-primary"),"data-test":"action-history-item-label",children:D.label}),J&&!m&&t.jsx("span",{className:"text-[9px] px-1 py-0.5 rounded bg-primary/10 text-primary font-medium",children:"Latest"})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[t.jsx("span",{"data-test":"action-history-item-source",children:W(D.source)}),t.jsx("span",{children:"•"}),t.jsx("span",{"data-test":"action-history-item-time",children:L(D.timestamp)})]})]}),!m&&(ie?t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 hover:opacity-100 transition-opacity",onClick:()=>P(D),title:"Execute this action","data-test":"action-history-execute",children:t.jsx(ft,{className:"h-3 w-3"})}):t.jsx("div",{className:"h-6 w-6 flex items-center justify-center text-muted-foreground/50",children:t.jsx(vs,{className:"h-3 w-3"})}))]},`${D.executorId}-${V}`)},F=t.jsxs("div",{className:"flex flex-col h-full","data-test":"action-history-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"action-history-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:m?t.jsxs(t.Fragment,{children:[t.jsx(Hr,{className:"h-3.5 w-3.5 text-primary"}),t.jsxs("span",{className:"text-xs font-medium text-primary",children:[N," selected"]})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(Ca,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",d.length,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(vs,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[n.length," action",n.length!==1?"s":""]})]})}),t.jsx("div",{className:"flex items-center gap-1","data-test":"action-history-header-actions",children:m?t.jsxs(t.Fragment,{children:[t.jsx(se,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:U,disabled:N===0,"data-test":"action-history-save-selection",children:"Save Preset"}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:w,"data-test":"action-history-cancel-selection",children:"Cancel"})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(se,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:D=>M({x:D.clientX,y:D.clientY}),"data-test":"action-history-stop-recording",children:"Stop"}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:f,"data-test":"action-history-cancel-recording",children:"Cancel"})]}):t.jsx(t.Fragment,{children:n.length>0&&t.jsxs(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-destructive",onClick:a,"data-test":"action-history-clear-button",children:[t.jsx(Nt,{className:"h-3 w-3 mr-1"}),"Clear"]})})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"action-history-list",children:n.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(ja,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No actions yet"}),t.jsx("span",{className:"text-xs text-center",children:"Actions you perform will appear here"})]}):t.jsx("div",{"data-test":"action-history-items",children:n.map((D,V)=>G(D,V))})}),n.length>0&&!m&&!l&&t.jsxs("div",{className:"px-3 py-2 border-t bg-muted/30 text-[10px] text-muted-foreground","data-test":"action-history-footer",children:["Click ",t.jsx(ft,{className:"h-2.5 w-2.5 inline mx-0.5"})," to repeat an action"]})]});return t.jsxs(t.Fragment,{children:[t.jsxs(Lu,{value:i,onValueChange:H,className:"flex flex-col h-full",children:[t.jsxs(Wu,{className:"grid w-full grid-cols-2 h-8","data-test":"repeat-action-tabs",children:[t.jsxs(ii,{value:"history",className:"text-xs","data-test":"tab-history",children:[t.jsx(vs,{className:"h-3 w-3 mr-1"}),"History"]}),t.jsxs(ii,{value:"presets",className:"text-xs","data-test":"tab-presets",children:[t.jsx(Bs,{className:"h-3 w-3 mr-1"}),"Presets"]})]}),t.jsx(ci,{value:"history",className:"flex-1 mt-0 overflow-hidden",children:F}),t.jsx(ci,{value:"presets",className:"flex-1 mt-0 overflow-hidden",children:t.jsx(mw,{onStartRecording:j,onStartSelection:B,isRecording:l,capturedStepsCount:d.length,onStopRecording:M,onCancelRecording:f})})]}),t.jsx(et,{isVisible:A,onClose:_,title:"Save as Preset",initialSize:{width:320,height:200},triggerPosition:I,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-4 flex flex-col gap-3","data-test":"save-preset-popover-content",children:[t.jsxs("div",{children:[t.jsx(Fe,{htmlFor:"new-preset-name",className:"text-sm",children:"Preset Name"}),t.jsx(ze,{id:"new-preset-name",value:k,onChange:D=>S(D.target.value),placeholder:"Enter preset name",className:"mt-2",autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&z()},"data-test":"save-preset-name-input"}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[E.length," step",E.length!==1?"s":""," will be saved"]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(se,{variant:"outline",size:"sm",onClick:_,"data-test":"save-preset-cancel",children:"Cancel"}),t.jsx(se,{size:"sm",onClick:z,disabled:!k.trim(),"data-test":"save-preset-confirm",children:"Save Preset"})]})]})})]})},Bd=()=>{const[e,s]=p.useState(!1),n=pt.getAllActions().map(({source:o,actions:r})=>({facade:o,actions:r}));return t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:o=>{o.stopPropagation(),s(!0)},onMouseDown:o=>o.stopPropagation(),title:"Debug: Show all available actions","data-test":"action-history-debug-button",children:t.jsx(wa,{className:"h-3.5 w-3.5"})}),t.jsx(et,{isVisible:e,onClose:()=>s(!1),title:"Available Actions (Debug)",initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3 overflow-y-auto h-full","data-test":"debug-actions-panel",children:n.map(({facade:o,actions:r})=>t.jsxs("div",{className:"mb-4","data-test":"debug-facade-section",children:[t.jsxs("h4",{className:"text-sm font-semibold mb-2 text-primary",children:[o," Actions"]}),t.jsx("ol",{className:"list-decimal list-inside space-y-1 text-xs",children:r.map(a=>t.jsxs("li",{className:"ml-2","data-test":"debug-action-item",children:[t.jsx("span",{className:"font-medium",children:a.label}),t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",a.id,")"]}),a.subActions&&a.subActions.length>0&&t.jsx("ol",{className:"list-[lower-alpha] list-inside ml-4 mt-1 space-y-0.5",children:a.subActions.map(i=>t.jsxs("li",{className:"text-muted-foreground","data-test":"debug-subaction-item",children:[t.jsx("span",{children:i.title}),t.jsxs("span",{className:"ml-1 opacity-60",children:["(",i.id,")"]})]},i.id))})]},a.id))})]},o))})})]})},Sw=({className:e})=>{const{history:s,lastAction:n,executeLastAction:o,executeAction:r,hasExecutor:a}=Vr(),{presets:i,executePreset:c,favoriteIds:l}=Gr(),[d,h]=p.useState(!1),[u,f]=p.useState(),m=p.useRef(null),y=p.useCallback(()=>{if(m.current){const E=m.current.getBoundingClientRect();f({x:E.left,y:E.bottom+4})}h(!0)},[]),g=p.useMemo(()=>i.filter(E=>l.includes(E.id)),[i,l]),x=p.useCallback(E=>E.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(C=>C.charAt(0).toUpperCase()+C.slice(1)).join(" "),[]),w=p.useCallback(E=>new Date(E).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[]),v=p.useCallback(E=>{r(E)},[r]),N=p.useCallback((E,C,I)=>{c(E),I(C,()=>c(E))},[c]),b=p.useCallback(()=>{n&&a(n.executorId)&&o()},[n,a,o]),A=p.useCallback(E=>{const C=i.find(I=>I.name===E);return C?()=>{c(C.id)}:null},[i,c]),R=p.useCallback((E,C)=>{const I=C===0,O=a(E.executorId);return t.jsxs("div",{className:Ie("group flex items-center gap-2 px-2 py-1.5 text-xs rounded-sm","hover:bg-accent cursor-pointer transition-colors",I&&"bg-primary/5",!O&&"opacity-50 cursor-not-allowed"),onClick:()=>O&&v(E),"data-test":"history-item",children:[t.jsx("div",{className:Ie("flex-shrink-0 w-4 h-4 rounded text-[9px] font-medium flex items-center justify-center",I?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:C+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:Ie("font-medium truncate text-[11px]",I&&"text-primary"),children:E.label}),t.jsxs("div",{className:"text-[9px] text-muted-foreground truncate",children:[x(E.source)," • ",w(E.timestamp)]})]}),O&&t.jsx(ft,{className:"h-2.5 w-2.5 opacity-0 group-hover:opacity-100 transition-opacity text-primary"})]},`${E.executorId}-${C}`)},[a,v,x,w]),k=p.useMemo(()=>[{header:"Recent Actions",width:"200px",actions:[{label:"History",onClick:()=>{},customRender:({registerRepeatAction:E})=>t.jsx("div",{className:"flex flex-col","data-test":"history-column",children:t.jsx("div",{className:"max-h-[200px] overflow-y-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},"data-test":"history-list",children:s.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-muted-foreground",children:[t.jsx(vs,{className:"h-6 w-6 opacity-30 mb-2"}),t.jsx("span",{className:"text-[10px]",children:"No actions yet"})]}):s.map((C,I)=>t.jsx("div",{onClick:()=>{a(C.executorId)&&(v(C),E(C.label,()=>r(C)))},children:R(C,I)},`${C.executorId}-${I}`))})})}]},{header:"Presets",width:"180px",actions:[{label:"Presets",onClick:()=>{},customRender:({registerRepeatAction:E,closeDropdown:C})=>t.jsx(Xy,{presetsButtonRef:m,onOpenPresetsPopover:y,closeDropdown:C,favoritePresets:g,onExecutePreset:(I,O)=>N(I,O,E),dataTestPrefix:"sequence"})}]}],[s,g,a,v,N,y,r,R]),S=n?`Repeat: ${n.label}`:"Actions & Presets";return t.jsxs(t.Fragment,{children:[t.jsx(rt,{mainAction:{icon:t.jsx(tp,{className:"h-4 w-4"}),onClick:b,label:S},dropdownColumns:k,variant:"outline",size:"compact",persistenceKey:"canvas-actions-presets",restoreRepeatAction:A,className:e,"data-test":"canvas-actions-presets-button"}),t.jsx(et,{isVisible:d,onClose:()=>h(!1),title:"Actions & Presets",initialSize:{width:300,height:380},triggerPosition:u,resizable:!0,headerActions:t.jsx(Bd,{}),children:t.jsx(Fd,{initialTab:"presets"})})]})},Cw=[],uc=[],zd=()=>{const e=$(l=>l.arrow.update),s=$(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedNodes)??Cw}),n=$(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??uc}),o=$(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.arrows)??uc}),r=p.useMemo(()=>{if(n.length>0){const l=n[0].type??Q.arrows.type;return n.every(h=>(h.type??Q.arrows.type)===l)?l:null}if(s.length>0){const l=new Set(s.map(f=>f.id)),d=o.filter(f=>f.startNodeId&&l.has(f.startNodeId)||f.endNodeId&&l.has(f.endNodeId));if(d.length===0)return Q.arrows.type;const h=d[0].type??Q.arrows.type;return d.every(f=>(f.type??Q.arrows.type)===h)?h:null}return Q.arrows.type},[n,s,o]),a=p.useCallback(l=>{const h=T.getState().projectCanvas.getActive();if(!h)return;const u=h.coreState.arrows??[],f=h.coreState.selectedArrows??[],m=h.coreState.selectedNodes??[];let y=u;if(f.length>0)y=f;else if(m.length>0){const g=new Set(m.map(x=>x.id));y=u.filter(x=>x.startNodeId&&g.has(x.startNodeId)||x.endNodeId&&g.has(x.endNodeId))}y.forEach(g=>{e(g.id,{type:l})})},[e]),i=[{label:"Straight",icon:t.jsx(Sa,{className:"h-2.5 w-2.5"}),onClick:()=>a("Straight"),selected:r==="Straight"},{label:"Quadratic",icon:t.jsx(sp,{className:"h-2.5 w-2.5"}),onClick:()=>a("Quadratic"),selected:r==="Quadratic"},{label:"Cubic",icon:t.jsx(np,{className:"h-2.5 w-2.5"}),onClick:()=>a("Cubic"),selected:r==="Cubic"},{label:"Step",icon:t.jsx(op,{className:"h-2.5 w-2.5"}),onClick:()=>a("Step"),selected:r==="Step"},{label:"Orthogonal",icon:t.jsx(Hs,{className:"h-2.5 w-2.5"}),onClick:()=>a("Orthogonal"),selected:r==="Orthogonal"},{label:"Tree: Cubic",icon:t.jsx(Lr,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeCubic"),selected:r==="TreeCubic"},{label:"Tree: L-Step",icon:t.jsx(ap,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeLStep"),selected:r==="TreeLStep"},{label:"Tree: Z-Shape",icon:t.jsx(rp,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeZShape"),selected:r==="TreeZShape"}],c=i[2];return t.jsx(rt,{mainAction:c,dropdownActions:i,variant:"outline",size:"compact",persistenceKey:"canvas-arrow-type","data-test":"canvas-arrow-type-button"})};class jw{constructor(s){qe(this,"namespace","canvas.grouping");this.hooks=s}getActions(){return[{id:"group",label:"Group nodes",category:"Grouping",icon:t.jsx($l,{className:"h-3 w-3"})},{id:"ungroup",label:"Ungroup nodes",category:"Grouping",icon:t.jsx(Fr,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"group":this.hooks.group();break;case"ungroup":this.hooks.ungroup();break;default:console.warn(`GroupingFacade: Unknown action "${s}"`)}}}function kw(){const e=p.useCallback(()=>{T.getState().group.createFromSelected()},[]),s=p.useCallback(()=>{const r=T.getState(),a=r.projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],c=new Set;i.forEach(l=>{l.type===fe.GROUP?c.add(l.id):l.groupId&&c.add(l.groupId)}),c.forEach(l=>{r.group.ungroup(l)})},[]),n=p.useMemo(()=>({group:e,ungroup:s}),[e,s]),o=p.useMemo(()=>new jw(n),[n]);return p.useEffect(()=>(pt.register("grouping",{name:"Grouping",getActions:()=>o.getActions()}),at.register("grouping",o),()=>{pt.unregister("grouping"),at.unregister("grouping")}),[o]),o}const Iw=e=>{const{className:s,...n}=e,o=kw();$(y=>{var g,x;return((x=(g=y.projectCanvas.getActive())==null?void 0:g.coreState.selectedNodes)==null?void 0:x.length)??0});const a=T.getState().projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],l=i.filter(y=>y.type===fe.GROUP).length>0,d=i.filter(y=>y.type!==fe.GROUP),h=d.some(y=>y.groupId),u=d.some(y=>!y.groupId),f=l||h&&!u&&d.length>0,m=d.length>=2&&u;return!f&&!m?null:t.jsx(Nn,{id:"ToolbarGroupButton",className:s,type:"button",onClick:()=>o.execute(f?"ungroup":"group"),title:f?"Ungroup (remove from group)":"Group selected nodes (Ctrl+G)","data-test":f?"toolbar-ungroup-button":"toolbar-group-button",...n,children:f?t.jsx(Fr,{className:"h-2.5 w-2.5"}):t.jsx($l,{className:"h-2.5 w-2.5"})})},Aw=e=>{const{className:s}=e,{handleAlignmentChange:n,currentAlignment:o}=jx();return t.jsxs("div",{className:Me("p-0.5 gap-0.5","bg-primary-foreground shadow","flex items-center flex-wrap","pointer-events-auto",s),"data-test":"canvas-node-configurations-toolbar",children:[t.jsx(kd,{}),t.jsx(by,{}),t.jsx(Ay,{textAlignValue:o,onTextAlignmentChange:n}),t.jsx(wy,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(ey,{}),t.jsx(vy,{}),t.jsx(ay,{}),t.jsx(ly,{}),t.jsx(py,{}),t.jsx(_y,{}),t.jsx(Sw,{}),t.jsx(xy,{}),t.jsx(my,{}),t.jsx(zd,{}),t.jsx(Iw,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(dy,{})]})},$d=({children:e,className:s,dataTest:n,dataAttributes:o={}})=>{const r=Q.nodeUI.idleOpacity;return t.jsx("div",{className:Me("relative","bg-primary-foreground shadow rounded flex items-center pointer-events-auto","hover:opacity-100 transition-opacity duration-200",s),style:{zIndex:We.nodeQuickPanel,opacity:r},onMouseEnter:a=>{a.currentTarget.style.opacity="1"},onMouseLeave:a=>{a.currentTarget.style.opacity=String(r)},"data-test":n,...Object.fromEntries(Object.entries(o).map(([a,i])=>[`data-${a}`,i])),children:e})},Tw=({node:e})=>t.jsx($d,{className:"space-x-2",dataTest:"node-quick-panel-container",dataAttributes:{"node-id":e.id,"node-type":e.type},children:t.jsx(Aw,{})}),Ew=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??js;return s.length===0?null:s.reduce((r,a)=>a.y<r.y||a.y===r.y&&a.x<r.x?a:r,s[0]).id},_d=e=>e.length===0?null:e.reduce((s,n)=>n.y<s.y||n.y===s.y&&n.x<s.x?n:s,e[0]),Rw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??js,n=_d(s);return(n==null?void 0:n.x)??null},Mw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??js,n=_d(s);return(n==null?void 0:n.y)??null},Pw=e=>{var s,n;return((n=(s=e.projectCanvas.getActive())==null?void 0:s.coreState.selectedNodes)==null?void 0:n.length)??0},Dw=He.memo(({node:e,isOpen:s,children:n})=>{const[o,r]=p.useState({top:0,left:0}),a=p.useRef(null),i=$(Pw),c=$(Ew),l=$(Rw),d=$(Mw),u=$(m=>m.uiState.mode)===ee.DRAW_ARROW,f=i>0&&c&&l!==null&&d!==null?{...e,id:c}:e;return p.useEffect(()=>{if(!s)return;const m=()=>{var L,W;const g=f,x=document.getElementById(`NodeContainerV2-${g.id}`);if(!x)return;const w=x.getBoundingClientRect(),v=((L=a.current)==null?void 0:L.offsetHeight)||250,N=((W=a.current)==null?void 0:W.offsetWidth)||350,b=window.innerWidth,A=window.innerHeight,R=20;let k=w.left+w.width/2-N/2;const S=Q.nodeUI.quickPanelGap,E=w.top-v-S,C=w.bottom+S,I=E>=R,O=C+v<=A-R;let H;!I&&O?H=C:I?H=E:O?H=C:H=R,k<R?k=R:k+N>b-R&&(k=b-N-R),r({top:H,left:k})};m();const y=setTimeout(m,100);return window.addEventListener("scroll",m,!0),window.addEventListener("resize",m),()=>{clearTimeout(y),window.removeEventListener("scroll",m,!0),window.removeEventListener("resize",m)}},[s,c,l,d]),t.jsxs(t.Fragment,{children:[n,s&&!u&&e.type!==fe.DRAWING&&Cs.createPortal(t.jsx("div",{ref:a,className:"fixed pointer-events-auto",style:{top:`${o.top}px`,left:`${o.left}px`,zIndex:We.popover,maxWidth:"90vw"},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),children:t.jsx(Tw,{node:e})}),document.body)]})}),Ow=[{position:"top",cursor:"cursor-crosshair",classes:"top-0 left-1/2 -translate-x-1/2"},{position:"bottom",cursor:"cursor-crosshair",classes:"bottom-0 left-1/2 -translate-x-1/2"},{position:"left",cursor:"cursor-crosshair",classes:"left-0 top-1/2 -translate-y-1/2"},{position:"right",cursor:"cursor-crosshair",classes:"right-0 top-1/2 -translate-y-1/2"}],xs=8,To=Q.nodeOptions.resizeBorderWidth,Je={corner:{width:xs,height:xs},edge:{horizontal:{height:To,width:`calc(100% - ${xs*2}px)`},vertical:{width:To,height:`calc(100% - ${xs*2}px)`}},position:{cornerTop:`-${xs}px`,cornerLeft:`-${xs}px`,cornerBottom:"100%",cornerRight:"100%",edgeTop:`-${To}px`,edgeLeft:`-${To}px`,topEdge:`${xs}px`,leftEdge:`${xs}px`},edgePosition:{bottom:"100%",left:"100%"}},Lw=[{position:"top-left",cursor:"cursor-nwse-resize",classes:"z-10",style:{...Je.corner,top:Je.position.cornerTop,left:Je.position.cornerLeft}},{position:"top-right",cursor:"cursor-nesw-resize",classes:"z-10",style:{...Je.corner,top:Je.position.cornerTop,left:Je.position.cornerRight}},{position:"bottom-left",cursor:"cursor-nesw-resize",classes:"z-10",style:{...Je.corner,top:Je.position.cornerBottom,left:Je.position.cornerLeft}},{position:"bottom-right",cursor:"cursor-nwse-resize",classes:"z-10",style:{...Je.corner,top:Je.position.cornerBottom,left:Je.position.cornerRight}},{position:"top",cursor:"cursor-ns-resize",classes:"",style:{...Je.edge.horizontal,top:Je.position.edgeTop,left:Je.position.leftEdge}},{position:"bottom",cursor:"cursor-ns-resize",classes:"",style:{...Je.edge.horizontal,top:Je.edgePosition.bottom,left:Je.position.leftEdge}},{position:"left",cursor:"cursor-ew-resize",classes:"",style:{...Je.edge.vertical,top:Je.position.topEdge,left:Je.position.edgeLeft}},{position:"right",cursor:"cursor-ew-resize",classes:"",style:{...Je.edge.vertical,top:Je.position.topEdge,left:Je.edgePosition.left}}],Ww=e=>{const s=ms(e,"top-left"),n=ms(e,"top-right"),o=ms(e,"bottom-left"),r=ms(e,"bottom-right"),a=ms(e,"top"),i=ms(e,"bottom"),c=ms(e,"left"),l=ms(e,"right");return{"top-left":s,"top-right":n,"bottom-left":o,"bottom-right":r,top:a,bottom:i,left:c,right:l}},{HANDLE_BG_COLOR:Hw,HANDLE_BORDER_COLOR:Fw}=ke,yr=8,wr=20,Gs=(wr-yr)/2,Bw=({node:e,isSelected:s,mode:n})=>{const o=s&&n===ee.SELECT,r=Ww(e),a=$(u=>u.uiState.nodeHoldToResize),i=(a==null?void 0:a.nodeId)===e.id,c=i?a.edge:null,l=i&&a.isReady,d=i&&a.isHolding,h=Q.nodeUI.resizeHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:Lw.map(({position:u,cursor:f,classes:m,style:y})=>{const g=r[u],x=!["top","right","bottom","left"].includes(u),w=c===u,v=w&&l,N=w&&d;return x?t.jsx("div",{"data-test":"resize-handle",id:`resize-handle-${e.id}-${u}`,className:Me("absolute transition-opacity duration-200",m,f),style:{width:wr,height:wr,top:typeof(y==null?void 0:y.top)=="string"?`calc(${y.top} - ${Gs}px)`:(y==null?void 0:y.top)-Gs,left:typeof(y==null?void 0:y.left)=="string"?`calc(${y.left} - ${Gs}px)`:(y==null?void 0:y.left)-Gs,touchAction:"none",zIndex:We.canvasResizeHandles,opacity:w?1:h},onMouseEnter:b=>{b.currentTarget.style.opacity="1"},onMouseLeave:b=>{w||(b.currentTarget.style.opacity=String(h))},onPointerDown:b=>{b.stopPropagation(),g(b)},children:t.jsx("div",{className:Me("absolute border transition-all duration-150",v?"bg-emerald-500 border-emerald-500 scale-125":N?"bg-amber-500 border-amber-500":Me(Hw,Fw)),style:{width:yr,height:yr,top:Gs,left:Gs,pointerEvents:"none"}})},u):t.jsx("div",{"data-test":"resize-handle",id:`resize-handle-${e.id}-${u}`,className:Me("absolute transition-all duration-150",v?"bg-emerald-500/30":N?"bg-amber-500/20":"hover:bg-primary/5",m,f),style:{...y,touchAction:"none",zIndex:We.canvasResizeHandles},onPointerDown:b=>{b.stopPropagation(),g(b)}},u)})}):null},zw=e=>{const s=jo(e,"top"),n=jo(e,"bottom"),o=jo(e,"left"),r=jo(e,"right");return p.useMemo(()=>({top:s,bottom:n,left:o,right:r}),[s,n,o,r])},Eo=-10,$w=({node:e,isSelected:s,mode:n})=>{const o=s&&n===ee.SELECT,r=zw(e),a=Q.nodeUI.quickArrowHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:Ow.map(({position:i,cursor:c,classes:l})=>{const d=r[i];return t.jsx("div",{"data-test":"quick-arrow-handle",id:`arrow-handle-${e.id}-${i}`,className:Me("absolute border rounded-full z-10","bg-blue-500","border-blue-700",l.replace(/-translate-\w+-1\/2/g,"").trim(),c,"pointer-events-auto","transition-opacity duration-200"),style:{width:`${fs}px`,height:`${fs}px`,top:l.includes("top-0")?`${Eo-fs}px`:l.includes("bottom-0")?`calc(100% + ${fs-Eo}px)`:`calc(50% - ${fs/2}px)`,left:l.includes("left-0")?`${Eo-fs}px`:l.includes("right-0")?`calc(100% + ${fs-Eo}px)`:`calc(50% - ${fs/2}px)`,opacity:a},onMouseEnter:h=>{h.currentTarget.style.opacity="1"},onMouseLeave:h=>{h.currentTarget.style.opacity=String(a)},onMouseDown:h=>{h.stopPropagation(),d(h)}},`arrow-${i}`)})}):null},_w=e=>{const{node:s,mode:n,isPopoverOpen:o,setIsPopoverOpen:r}=e,a=om(s),c=T.getState().setSelectedNodes,l=p.useRef({x:NaN,y:NaN});return{handleMouseDown:p.useCallback(h=>{var C;const u={x:h.clientX,y:h.clientY};l.current=u;const f=h.target;if(n===ee.MOVE)return;const y=(C=T.getState().projectCanvas.getActive())==null?void 0:C.coreState.selectedNodes,g=y==null?void 0:y.some(I=>I.id===s.id),x=g&&(y==null?void 0:y.length)===1,w=f.closest(`[id^="resize-handle-${s.id}-"]`),v=f.closest(`[id^="arrow-handle-${s.id}-"]`),N=f.closest("[data-drag-handle]"),R=(f.tagName==="TEXTAREA"||f.closest("textarea")||f.closest("[contenteditable]")||f.closest("[data-node-textarea]")||f.closest(".markdown-textarea")||f.closest("[data-text-node-click-overlay]")||f.isContentEditable||f.closest("[data-text-position-container]"))&&!s.isEditing&&x,k=f.closest(".audio-button-wrapper")||f.closest(".voice-input-button")||f.closest(".nav-button")||f.closest(".chunk-counter"),S=f.closest('[data-test="group-header"] button'),E=f.closest(".node-actions-sidebar button");if(R){const I=T.getState(),O=h.clientX,H=h.clientY;r(!1);const L=document.querySelector(`#NodeContainerV2-${s.id} .markdown-textarea`);if(L){L.contentEditable="true",L.focus({preventScroll:!0});const W=document.querySelector(`#NodeContainerV2-${s.id} [data-text-node-click-overlay]`);W&&(W.style.display="none")}I.updateNode(s.id,{isEditing:!0}),I.setNodeToFocusId(s.id),Nx(H)&&vx({nodeId:s.id,nodeY:s.y}),requestAnimationFrame(()=>{try{let W=null;if(document.caretRangeFromPoint)W=document.caretRangeFromPoint(O,H);else if(document.caretPositionFromPoint){const P=document.caretPositionFromPoint(O,H);P&&(W=document.createRange(),W.setStart(P.offsetNode,P.offset),W.collapse(!0))}if(W){const P=window.getSelection();P&&(P.removeAllRanges(),P.addRange(W))}}catch{}});return}if(w||v||N||k||S||E){r(!1);return}g||r(!1),!s.isEditing&&!R&&a(h)},[s,c,a,n,o,r]),initialClickPoint:l}};function ma({tags:e,onAddTag:s,onRemoveTag:n,quickTags:o=["left","right","todo","important"],canvasTags:r=[],className:a}){const[i,c]=p.useState(""),l=r.filter(h=>{const u=!i.trim()||h.toLowerCase().includes(i.toLowerCase()),f=!e.includes(h);return u&&f}),d=()=>{const h=i.trim();h&&(s(h),c(""))};return t.jsxs("div",{className:Ie("tag-management-ui space-y-3",a),"data-test":"tag-management-ui-container",children:[e.length>0&&t.jsxs("div",{className:"current-tags space-y-2","data-test":"tag-management-current-tags-section",children:[t.jsx("div",{className:"tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-current-tags-label",children:"Current Tags"}),t.jsx("div",{className:"tags-list flex flex-wrap gap-1","data-test":"tag-management-current-tags-list",children:e.map(h=>t.jsxs(lt,{variant:"secondary",className:"tag-badge text-xs flex items-center gap-1","data-test":"tag-management-tag",children:[h,t.jsx("button",{onClick:()=>n(h),className:"tag-remove-button ml-1 hover:text-destructive",title:"Remove tag","data-test":"tag-management-remove-tag-button",children:t.jsx(Ke,{className:"h-3 w-3"})})]},h))})]}),t.jsxs("div",{className:"add-tag-section space-y-2","data-test":"tag-management-add-tag-section",children:[t.jsx("div",{className:"add-tag-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-add-tag-label",children:"Add Tag"}),t.jsxs("div",{className:"add-tag-input-group flex gap-2","data-test":"tag-management-add-tag-input-group",children:[t.jsx(ze,{placeholder:"Enter tag name...",value:i,onChange:h=>c(h.target.value),onKeyDown:h=>{h.key==="Enter"&&i.trim()&&(h.preventDefault(),d())},className:"tag-input h-8 text-sm",autoFocus:!0,"data-test":"tag-management-tag-input"}),t.jsx(se,{variant:"default",size:"sm",className:"add-tag-button h-8",onClick:d,disabled:!i.trim(),"data-test":"tag-management-add-tag-button",children:t.jsx(Tt,{className:"h-4 w-4"})})]})]}),l.length>0&&t.jsxs("div",{className:"canvas-tags-section space-y-2","data-test":"tag-management-canvas-tags-section",children:[t.jsx("div",{className:"canvas-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-canvas-tags-label",children:"Tags in Canvas"}),t.jsx("div",{className:"canvas-tags-list flex flex-wrap gap-1 max-h-14 overflow-y-auto","data-test":"tag-management-canvas-tags-list",children:l.map(h=>t.jsx(lt,{variant:"outline",className:"canvas-tag cursor-pointer hover:opacity-80 hover:bg-accent",onClick:()=>s(h),"data-test":"tag-management-canvas-tag",children:h},h))})]}),o.length>0&&t.jsxs("div",{className:"quick-tags-section space-y-2","data-test":"tag-management-quick-tags-section",children:[t.jsx("div",{className:"quick-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-quick-tags-label",children:"Quick Add"}),t.jsx("div",{className:"quick-tags-list flex flex-wrap gap-1","data-test":"tag-management-quick-tags-list",children:o.map(h=>{const u=e.includes(h);return t.jsx(lt,{variant:u?"default":"outline",className:Ie("quick-tag cursor-pointer hover:opacity-80",u&&"opacity-50 cursor-not-allowed"),onClick:()=>{u||s(h)},"data-test":"tag-management-quick-tag",children:h},h)})})]})]})}const Uw=[];function Vw({nodeId:e,tags:s,className:n}){const[o,r]=p.useState(!1),a=$(u=>{var f;return((f=u.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??Uw}),i=Array.isArray(s)?s:[],c=p.useMemo(()=>i.map(u=>u.title),[i]),l=p.useMemo(()=>{const u=new Set;for(const f of a)if(Array.isArray(f.tags))for(const m of f.tags)u.add(m.title);return Array.from(u).sort()},[a]),d=p.useCallback(u=>{const f=T.getState(),m={id:Math.random().toString(36).slice(2,10),title:u};f.addTagToNode(e,m)},[e]),h=p.useCallback(u=>{const f=T.getState(),m=i.find(y=>y.title===u);m&&f.removeTagFromNode(e,m.id)},[e,i]);return t.jsxs(St,{open:o,onOpenChange:r,"data-test":"tag-selector-popover",children:[t.jsx(Ct,{asChild:!0,children:t.jsx(Nn,{className:n,onClick:u=>{u.stopPropagation()},title:"Manage tags",variant:"ghost","data-test":"tag-selector-trigger-button",children:t.jsx(uo,{})})}),t.jsx(jt,{className:"tag-selector-popover w-64 p-3",align:"start","data-test":"tag-selector-popover-content",children:t.jsx(ma,{tags:c,onAddTag:d,onRemoveTag:h,canvasTags:l})})]})}function Gw({node:e,className:s}){const n=o=>{var d;o.stopPropagation();const r=T.getState(),a=(d=r.projectCanvas.getActive())==null?void 0:d.viewState,i=r.updateNode;if(!a)return;const{scale:c,offset:l}=a;if(e.isPinned){const h=(e.x-l.x)/c,u=(e.y-l.y)/c;i(e.id,{isPinned:!1,x:h,y:u})}else{const h=e.x*c+l.x,u=e.y*c+l.y;i(e.id,{isPinned:!0,x:h,y:u})}};return t.jsx(Nn,{className:s,onClick:n,title:e.isPinned?"Unpin from viewport":"Pin to viewport",variant:"ghost",children:e.isPinned?t.jsx(_l,{className:"h-4 w-4 text-blue-500"}):t.jsx(Ul,{className:"h-4 w-4"})})}const ks=p.forwardRef(({tooltip:e,children:s,...n},o)=>t.jsx(es,{children:t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx(se,{ref:o,...n,children:s})}),t.jsx(Vt,{children:typeof e=="string"?t.jsx("p",{children:e}):e})]})}));ks.displayName="ButtonWithTooltip";const Ud=p.createContext(null),Yw=({children:e})=>{const[s,n]=p.useState(null),o=p.useRef(null),r=p.useCallback(c=>{n(c)},[s]),a=p.useCallback(c=>{n(l=>l===c?null:l)},[s]),i=p.useCallback(c=>s===c,[s]);return p.useEffect(()=>{if(!s)return;const c=l=>{var h;const d=l.target;(h=o.current)!=null&&h.contains(d)||d.closest('[data-test^="draggable-popover"]')||n(null)};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[s]),t.jsx(Ud.Provider,{value:{activePopoverId:s,openPopover:r,closePopover:a,isPopoverOpen:i},children:t.jsx("div",{ref:o,children:e})})},Xr=e=>{const s=p.useContext(Ud),[n,o]=p.useState(!1);if(!s)return{isOpen:n,open:()=>o(!0),close:()=>o(!1),toggle:()=>o(c=>!c)};const{isPopoverOpen:r,openPopover:a,closePopover:i}=s;return{isOpen:r(e),open:()=>a(e),close:()=>i(e),toggle:()=>{r(e)?i(e):a(e)}}},Sn=({popoverId:e,icon:s,tooltip:n,popoverContent:o,popoverTitle:r,leftOffset:a=180,initialSize:i={width:320,height:400},resizable:c=!0,headerActions:l,buttonVariant:d="secondary",buttonSize:h="sm",dataTest:u})=>{const f=p.useRef(null),[m,y]=p.useState(null),{isOpen:g,open:x,close:w}=Xr(e),v=()=>{if(g){w();return}if(f.current){const N=f.current.getBoundingClientRect(),{width:b,height:A}=i,R=N.left+N.width/2,k=N.top+N.height/2;y({x:R-b/2+a,y:k-A/2})}x()};return t.jsxs(t.Fragment,{children:[t.jsx(ks,{ref:f,variant:d,size:h,tooltip:n,onClick:v,"data-test":u,children:t.jsx(s,{className:"h-4 w-4"})}),t.jsx(et,{isVisible:g,onClose:w,title:r,triggerPosition:m??void 0,initialSize:i,resizable:c,shouldCloseManually:!0,headerActions:l,children:o})]})};function Xw(e){const n=Date.now()-e,o=Math.floor(n/1e3),r=Math.floor(o/60),a=Math.floor(r/60);return o<60?"just now":r<60?`${r} min ago`:a<24?`${a} hour${a>1?"s":""} ago`:"over a day ago"}const Kw=[],qw=({node:e})=>{var x,w,v,N,b,A,R,k;const s=$(S=>S.uiState.arrangeSnapshot),n=$(S=>S.revertArrangeSnapshot),o=$(S=>{var E;return((E=S.projectCanvas.getActive())==null?void 0:E.coreState.nodes)??Kw}),r=e.data,a=r==null?void 0:r.automation,i=p.useMemo(()=>{const S=new Set;for(const E of o)if(Array.isArray(E.tags))for(const C of E.tags)S.add(C.title);return Array.from(S).sort()},[o]),c=p.useMemo(()=>{if(!s)return null;const S=Object.keys(s.nodePositions).length,E=Xw(s.timestamp);return{nodeCount:S,relativeTime:E}},[s]),l=()=>{n()},d=p.useCallback(S=>{const E=e.data??{childNodeIds:[]},C={...E.automation,...S};T.getState().updateNode(e.id,{data:{...E,automation:C}})},[e.id,e.data]),h=p.useCallback(S=>{var E;d({onEnter:{enabled:S,tags:((E=a==null?void 0:a.onEnter)==null?void 0:E.tags)??[]}})},[d,(x=a==null?void 0:a.onEnter)==null?void 0:x.tags]),u=p.useCallback(S=>{var C,I;const E=((C=a==null?void 0:a.onEnter)==null?void 0:C.tags)??[];E.includes(S)||d({onEnter:{enabled:((I=a==null?void 0:a.onEnter)==null?void 0:I.enabled)??!0,tags:[...E,S]}})},[d,a==null?void 0:a.onEnter]),f=p.useCallback(S=>{var C,I;const E=((C=a==null?void 0:a.onEnter)==null?void 0:C.tags)??[];d({onEnter:{enabled:((I=a==null?void 0:a.onEnter)==null?void 0:I.enabled)??!1,tags:E.filter(O=>O!==S)}})},[d,a==null?void 0:a.onEnter]),m=p.useCallback(S=>{var E;d({onLeave:{enabled:S,tags:((E=a==null?void 0:a.onLeave)==null?void 0:E.tags)??[]}})},[d,(w=a==null?void 0:a.onLeave)==null?void 0:w.tags]),y=p.useCallback(S=>{var C,I;const E=((C=a==null?void 0:a.onLeave)==null?void 0:C.tags)??[];E.includes(S)||d({onLeave:{enabled:((I=a==null?void 0:a.onLeave)==null?void 0:I.enabled)??!0,tags:[...E,S]}})},[d,a==null?void 0:a.onLeave]),g=p.useCallback(S=>{var C,I;const E=((C=a==null?void 0:a.onLeave)==null?void 0:C.tags)??[];d({onLeave:{enabled:((I=a==null?void 0:a.onLeave)==null?void 0:I.enabled)??!1,tags:E.filter(O=>O!==S)}})},[d,a==null?void 0:a.onLeave]);return t.jsx(Sn,{popoverId:`action-settings-${e.id}`,icon:go,tooltip:"Group Settings",popoverTitle:"Group Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"group-settings-content",children:[t.jsxs("div",{"data-test":"group-settings-automation-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-3",children:"Automation"}),t.jsxs("div",{className:"space-y-2 mb-4","data-test":"group-settings-on-enter",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(Fe,{htmlFor:"on-enter-switch",className:"text-sm",children:"Add tags when node enters"}),t.jsx(qo,{id:"on-enter-switch",checked:((v=a==null?void 0:a.onEnter)==null?void 0:v.enabled)??!1,onCheckedChange:h,"data-test":"group-settings-on-enter-switch"})]}),((N=a==null?void 0:a.onEnter)==null?void 0:N.enabled)&&t.jsx(ma,{tags:((b=a==null?void 0:a.onEnter)==null?void 0:b.tags)??[],onAddTag:u,onRemoveTag:f,canvasTags:i,quickTags:[],className:"mt-2"})]}),t.jsxs("div",{className:"space-y-2","data-test":"group-settings-on-leave",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(Fe,{htmlFor:"on-leave-switch",className:"text-sm",children:"Remove tags when node leaves"}),t.jsx(qo,{id:"on-leave-switch",checked:((A=a==null?void 0:a.onLeave)==null?void 0:A.enabled)??!1,onCheckedChange:m,"data-test":"group-settings-on-leave-switch"})]}),((R=a==null?void 0:a.onLeave)==null?void 0:R.enabled)&&t.jsx(ma,{tags:((k=a==null?void 0:a.onLeave)==null?void 0:k.tags)??[],onAddTag:y,onRemoveTag:g,canvasTags:i,quickTags:[],className:"mt-2"})]})]}),t.jsx("div",{className:"border-t border-border"}),t.jsxs("div",{"data-test":"group-settings-arrangement-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Arrangement"}),c?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-xs text-muted-foreground",children:[c.nodeCount," node",c.nodeCount!==1?"s":""," • ",c.relativeTime]}),t.jsxs(se,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:l,"data-test":"group-settings-revert-button",children:[t.jsx(ba,{className:"h-4 w-4 mr-2"}),"Revert to Initial Positions"]})]}):t.jsx("div",{className:"text-xs text-muted-foreground italic",children:"No arrangement to revert"})]})]}),initialSize:{width:320,height:400},buttonVariant:"ghost",buttonSize:"icon",dataTest:"group-settings-button"})},Zw=({node:e})=>{const s=e.data,n=(s==null?void 0:s.vocabType)??tt.DICTIONARY,o=p.useCallback(i=>{const c=i,l=e.data??{vocabType:tt.DICTIONARY,term:"",definition:""};T.getState().updateNode(e.id,{data:{...l,vocabType:c}})},[e.id,e.data]),r=p.useCallback(()=>{const i=e.data??{vocabType:tt.VOCABULARY,term:"",definition:""};T.getState().updateNode(e.id,{data:{...i,sourceWord:i.translationWord||"",translationWord:i.sourceWord||""}})},[e.id,e.data]),a=n===tt.VOCABULARY;return t.jsx(Sn,{popoverId:`vocab-settings-${e.id}`,icon:go,tooltip:"Vocabulary Settings",popoverTitle:"Vocabulary Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"vocab-settings-content",children:[t.jsxs("div",{"data-test":"vocab-settings-type-section",children:[t.jsx(Fe,{htmlFor:"vocab-type-select",className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Vocabulary Type"}),t.jsxs(yt,{value:n,onValueChange:o,children:[t.jsx(wt,{id:"vocab-type-select","data-test":"vocab-type-select",className:"w-full",children:t.jsx(vt,{})}),t.jsxs(bt,{children:[t.jsx(Qe,{value:tt.DICTIONARY,children:"Dictionary"}),t.jsx(Qe,{value:tt.FLASHCARD,children:"Flashcard"}),t.jsx(Qe,{value:tt.WORD_LIST,children:"Word List"}),t.jsx(Qe,{value:tt.ETYMOLOGY,children:"Etymology"}),t.jsx(Qe,{value:tt.VOCABULARY,children:"Vocabulary"})]})]})]}),a&&t.jsx("div",{"data-test":"vocab-settings-swap-section",children:t.jsxs(se,{variant:"outline",size:"sm",className:"w-full",onClick:r,"data-test":"vocab-swap-words-button",children:[t.jsx(Ds,{className:"h-4 w-4 mr-2"}),"Swap Words"]})})]}),initialSize:{width:280,height:a?180:120},buttonVariant:"ghost",buttonSize:"icon",dataTest:"vocab-settings-button"})},Jw={template:"TEMPLATES",bug:"BUG INVESTIGATIONS",experiment:"EXPERIMENTS",archive:"ARCHIVED"},hc={all:"All Categories",template:"Templates",bug:"Bug Investigations",experiment:"Experiments",archive:"Archived"},Qw={template:"bg-purple-500/20 text-purple-700 dark:text-purple-300 border-purple-500/30",bug:"bg-red-500/20 text-red-700 dark:text-red-300 border-red-500/30",experiment:"bg-blue-500/20 text-blue-700 dark:text-blue-300 border-blue-500/30",archive:"bg-gray-500/20 text-gray-700 dark:text-gray-300 border-gray-500/30"},ev={template:Vl,bug:wa,experiment:lp,archive:cp},pc=2,gc=["template","bug","experiment","archive"];function tv(e){const s={template:[],bug:[],experiment:[],archive:[]},n=[];for(const o of e)o.category&&o.category in s?s[o.category].push(o):n.push(o);return{categorized:s,uncategorized:n}}function fc({fork:e}){var r,a;const s=((r=e.tags)==null?void 0:r.slice(0,pc))??[],n=(((a=e.tags)==null?void 0:a.length)??0)-pc,o=e.category?ev[e.category]:null;return t.jsxs("div",{className:"flex flex-col items-start gap-0.5","data-test":"fork-option-content",children:[t.jsxs("div",{className:"flex items-center gap-1.5 w-full",children:[o&&t.jsx(o,{size:12,className:"flex-shrink-0 text-muted-foreground","data-test":"fork-option-category-icon"}),t.jsx("span",{className:"font-medium truncate","data-test":"fork-option-name",children:e.sessionName??e.description??`Fork ${e.sessionId.slice(0,8)}`}),e.category&&t.jsx(lt,{variant:"outline",className:Ie("text-[9px] px-1 py-0 h-3.5 ml-auto flex-shrink-0",Qw[e.category]),"data-test":"fork-option-category-badge",children:e.category})]}),t.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[t.jsxs("span",{"data-test":"fork-option-message-count",children:[e.messageCount??0," messages"]}),s.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"mx-0.5",children:"|"}),s.map(i=>t.jsx(lt,{variant:"secondary",className:"text-[9px] px-1 py-0 h-3.5 bg-secondary/50","data-test":"fork-option-tag",children:i},i)),n>0&&t.jsxs("span",{className:"text-[9px]","data-test":"fork-option-tags-overflow",children:["+",n]})]})]})]})}function sv({value:e,onChange:s,showLabel:n=!0,label:o="Fork From",placeholder:r="No fork (new session)",className:a="",disabled:i=!1,filterByCategory:c,filterByTag:l,showFilters:d=!1}){const[h,u]=p.useState("all"),[f,m]=p.useState(""),y=c??(h!=="all"?h:void 0),g=l??(f.trim()||void 0),{forks:x,loading:w,loadForks:v}=Hu({loadOnMount:!0,filterByCategory:y,filterByTag:g});p.useEffect(()=>{v(1)},[y,g]);const N=p.useMemo(()=>tv(x),[x]),b=p.useMemo(()=>gc.some(k=>N.categorized[k].length>0)||N.uncategorized.length>0,[N]),A=k=>{s==null||s(k==="none"?null:k)},R=k=>{u(k)};return t.jsxs("div",{className:"fork-session-selector space-y-2","data-test":"fork-session-selector",children:[n&&t.jsxs(Fe,{className:"flex items-center gap-1","data-test":"fork-session-selector-label",children:[t.jsx(ip,{className:"h-3 w-3"}),o]}),d&&t.jsxs("div",{className:"flex items-center gap-2","data-test":"fork-session-selector-filters",children:[t.jsxs(yt,{value:h,onValueChange:R,disabled:i,children:[t.jsx(wt,{className:"h-8 text-xs w-[140px]","data-test":"fork-filter-category-trigger",children:t.jsx(vt,{placeholder:"Category"})}),t.jsx(bt,{"data-test":"fork-filter-category-options",style:{zIndex:We.draggablePopoverDropdown},children:Object.keys(hc).map(k=>t.jsx(Qe,{value:k,"data-test":`fork-filter-category-${k}`,children:hc[k]},k))})]}),t.jsxs("div",{className:"relative flex-1",children:[t.jsx(Ss,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3 w-3 text-muted-foreground","data-test":"fork-filter-tag-icon"}),t.jsx(ze,{type:"text",placeholder:"Filter by tag...",value:f,onChange:k=>m(k.target.value),className:"h-8 text-xs pl-7",disabled:i,"data-test":"fork-filter-tag-input"})]})]}),t.jsxs(yt,{value:e??"none",onValueChange:A,disabled:i,children:[t.jsx(wt,{className:`fork-selector ${a}`,"data-test":"fork-session-selector-trigger",children:t.jsx(vt,{placeholder:r})}),t.jsxs(bt,{"data-test":"fork-session-selector-options",style:{zIndex:We.draggablePopoverDropdown},className:"max-h-[300px]",children:[t.jsx(Qe,{value:"none","data-test":"fork-option-none",children:t.jsx("span",{className:"text-muted-foreground",children:r})}),w?t.jsx(Qe,{value:"loading",disabled:!0,"data-test":"fork-option-loading",children:"Loading forks..."}):b?t.jsxs(t.Fragment,{children:[gc.map(k=>{const S=N.categorized[k];return S.length===0?null:t.jsxs(li,{"data-test":`fork-group-${k}`,children:[t.jsx(di,{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider","data-test":`fork-group-label-${k}`,children:Jw[k]}),S.map(E=>t.jsx(Qe,{value:E.sessionId,"data-test":"fork-option-item",children:t.jsx(fc,{fork:E})},E.id))]},k)}),N.uncategorized.length>0&&t.jsxs(li,{"data-test":"fork-group-uncategorized",children:[t.jsx(di,{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider","data-test":"fork-group-label-uncategorized",children:"OTHER"}),N.uncategorized.map(k=>t.jsx(Qe,{value:k.sessionId,"data-test":"fork-option-item",children:t.jsx(fc,{fork:k})},k.id))]})]}):t.jsx(Qe,{value:"empty",disabled:!0,"data-test":"fork-option-empty",children:"No forks available"})]})]})]})}const nv=[{value:"low",label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"medium",label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"high",label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:"urgent",label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],ov=[{value:"freezer",label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:"backlog",label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"selected",label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:"doing",label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"done",label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:"archive",label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],av=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.data)==null?void 0:o.projects)??[]},rv=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.ui)==null?void 0:o.loadingProjects)??!1};function iv({status:e="backlog",priority:s="medium",category:n="",dueDate:o="",claudeProject:r,forkSessionId:a,sessionIds:i=[],tags:c=[],onStatusChange:l,onPriorityChange:d,onCategoryChange:h,onDueDateChange:u,onClaudeProjectChange:f,onForkSessionIdChange:m,onSessionIdsChange:y,onTagsChange:g,showForkSelector:x=!1,showSessionSelector:w=!1,showTags:v=!0,compact:N=!1}){const b=Yo(av),A=Yo(rv),R=p.useMemo(()=>b.map(I=>({value:I.path,label:I.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[b]),k=p.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...R],[R]),S=p.useCallback(I=>{const O=I.trim();O&&!c.includes(O)&&(g==null||g([...c,O]))},[c,g]),E=p.useCallback(I=>{g==null||g(c.filter(O=>O!==I))},[c,g]),C=p.useCallback(I=>{const O=Array.isArray(I)?I:[I];y==null||y(O)},[y]);return t.jsxs("div",{className:`todo-metadata-form space-y-4 ${N?"text-sm":""}`,"data-test":"todo-metadata-form",children:[t.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-metadata-status-selector",children:[t.jsx(Fe,{"data-test":"todo-metadata-status-label",children:"Status"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(Fu,{value:e,options:ov,onChange:I=>l==null?void 0:l(I),placeholder:"Search status...","data-test":"todo-metadata-status-select"})})]}),t.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-metadata-priority-selector",children:[t.jsx(Fe,{"data-test":"todo-metadata-priority-label",children:"Priority"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(ui,{value:s,options:nv,onChange:I=>d==null?void 0:d(I),placeholder:"Search priorities...",contentStyle:{zIndex:We.draggablePopoverDropdown},"data-test":"todo-metadata-priority-badge"})})]}),t.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-metadata-category-selector",children:[t.jsx(Fe,{"data-test":"todo-metadata-category-label",children:"Category"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(Bu,{value:n||"personal",onChange:I=>h==null?void 0:h(I),placeholder:"Search categories...","data-test":"todo-metadata-category-select"})})]}),!A&&k.length>1&&t.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-metadata-project-selector",children:[t.jsx(Fe,{"data-test":"todo-metadata-project-label",children:"Claude Project"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(ui,{value:r??"__no_project__",options:k,onChange:I=>f==null?void 0:f(I),placeholder:"Search projects...",contentStyle:{zIndex:We.draggablePopoverDropdown},"data-test":"todo-metadata-project-badge"})})]}),x&&t.jsx(sv,{value:a,onChange:m,showLabel:!0,className:"w-full"}),w&&t.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-metadata-session-selector",children:[t.jsx(Fe,{"data-test":"todo-metadata-session-selector-label",children:"Claude Sessions"}),t.jsx(zu,{value:i,onChange:C,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-metadata-session-select"})]}),v&&t.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-metadata-tags-selector",children:[t.jsx(Fe,{"data-test":"todo-metadata-tags-label",children:"Tags"}),t.jsx(cv,{tags:c,onAddTag:S,onRemoveTag:E})]}),t.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-metadata-due-date-field",children:[t.jsx(Fe,{htmlFor:"dueDate","data-test":"todo-metadata-due-date-label",children:"Due Date"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(dp,{className:"w-4 h-4 text-gray-400"}),t.jsx(ze,{id:"dueDate",type:"date",value:o,onChange:I=>u==null?void 0:u(I.target.value),"data-test":"todo-metadata-due-date-input"})]})]})]})}function cv({tags:e,onAddTag:s,onRemoveTag:n}){const o=p.useCallback(a=>{if(a.key==="Enter"){a.preventDefault();const i=a.currentTarget;s(i.value),i.value=""}},[s]),r=p.useCallback(()=>{const a=document.querySelector('[data-test="todo-metadata-tag-input"]');a&&(s(a.value),a.value="")},[s]);return t.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-metadata-tags-container",children:[t.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-metadata-tags-list",children:e.map(a=>t.jsxs(lt,{variant:"outline",className:"tag-badge gap-1","data-test":"todo-metadata-tag",children:[a,t.jsx("button",{onClick:()=>n(a),className:"tag-remove ml-1 hover:text-red-500","data-test":"todo-metadata-tag-remove",children:t.jsx(Ke,{className:"w-3 h-3"})})]},a))}),t.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-metadata-tag-input-container",children:[t.jsx(ze,{onKeyDown:o,placeholder:"Add a tag...","data-test":"todo-metadata-tag-input"}),t.jsx(se,{onClick:r,size:"sm",className:"tag-add-button","data-test":"todo-metadata-tag-add-button",children:t.jsx(Tt,{className:"w-4 h-4"})})]})]})}const lv=({node:e})=>{const[s,n]=p.useState(!1),o=p.useRef(null),r=e.data,a=r==null?void 0:r.todo,i=p.useCallback(()=>{if(!o.current)return{x:100,y:100};const x=o.current.getBoundingClientRect();return{x:x.right+8,y:x.top}},[]),c=p.useCallback(x=>{const w=e.data??{},v=w.todo??{};T.getState().updateNode(e.id,{data:{...w,todo:{...v,...x}}})},[e.id,e.data]),l=p.useCallback(x=>{c({status:x})},[c]),d=p.useCallback(x=>{c({priority:x})},[c]),h=p.useCallback(x=>{c({category:x})},[c]),u=p.useCallback(x=>{c({dueDate:x||void 0})},[c]),f=p.useCallback(x=>{c({claudeProjectPath:x==="__no_project__"?void 0:x})},[c]),m=p.useCallback(x=>{c({sessionIds:x})},[c]),y=p.useCallback(x=>{c({forkSessionId:x??void 0})},[c]),g=a&&(a.status||a.priority||a.category||a.dueDate||a.claudeProjectPath||a.forkSessionId||a.sessionIds&&a.sessionIds.length>0);return t.jsxs(t.Fragment,{children:[t.jsx(se,{ref:o,variant:"ghost",size:"icon",className:`todo-metadata-button h-8 w-8 ${g?"text-blue-500":"text-muted-foreground"}`,onClick:()=>n(!0),title:"Todo Metadata","data-test":"node-todo-metadata-button",children:t.jsx(up,{className:"h-4 w-4"})}),t.jsx(et,{isVisible:s,onClose:()=>n(!1),title:"Todo Metadata",triggerPosition:i(),initialSize:{width:300,height:450},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx($u,{variant:"ghost",size:"icon",buttonTitle:"Create Claude Session",projectPath:a==null?void 0:a.claudeProjectPath,initialForkSessionId:a==null?void 0:a.forkSessionId,initialMessage:typeof e.content=="string"?e.content:"",useModal:!0}),children:t.jsx("div",{className:"p-4",children:t.jsx(iv,{status:a==null?void 0:a.status,priority:a==null?void 0:a.priority,category:a==null?void 0:a.category,dueDate:a==null?void 0:a.dueDate,claudeProject:a==null?void 0:a.claudeProjectPath,forkSessionId:a==null?void 0:a.forkSessionId,sessionIds:a==null?void 0:a.sessionIds,onStatusChange:l,onPriorityChange:d,onCategoryChange:h,onDueDateChange:u,onClaudeProjectChange:f,onForkSessionIdChange:y,onSessionIdsChange:m,showForkSelector:!0,showSessionSelector:!0,showTags:!1,compact:!0})})})]})},dv=({node:e})=>{const s=e.type===fe.GROUP,n=e.type===fe.VOCABULARY,o=Q.nodeUI.idleOpacity;return t.jsxs("div",{className:Me("node-actions-sidebar absolute","gap-1","items-center","hover:opacity-100 transition-opacity duration-200"),style:{left:-50,opacity:o},onMouseEnter:r=>{r.currentTarget.style.opacity="1"},onMouseLeave:r=>{r.currentTarget.style.opacity=String(o)},"data-test":"node-container-extra",children:[t.jsx("div",{className:"pin-button-wrapper",children:t.jsx(Gw,{node:e})}),t.jsx("div",{className:"text-editor-button-wrapper",children:e.subContent?t.jsx(kd,{className:"my-2"}):null}),t.jsx("div",{className:"tag-selector-wrapper",children:t.jsx(Vw,{nodeId:e.id,tags:e.tags})}),t.jsx("div",{className:"todo-metadata-wrapper",children:t.jsx(lv,{node:e})}),s&&t.jsx("div",{className:"group-settings-button-wrapper","data-test":"group-settings-wrapper",children:t.jsx(qw,{node:e})}),n&&t.jsx("div",{className:"vocab-settings-button-wrapper","data-test":"vocab-settings-wrapper",children:t.jsx(Zw,{node:e})})]})},uv={columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},hv=({node:e})=>{const{updateNode:s}=T.getState(),n=$(A=>{var R,k;return((R=A.uiState.tableDropTarget)==null?void 0:R.tableId)===e.id?((k=A.uiState.tableDropTarget)==null?void 0:k.columnKey)??null:null}),o=$(A=>{var R,k;return((R=A.uiState.tableDropTarget)==null?void 0:R.tableId)===e.id?((k=A.uiState.tableDropTarget)==null?void 0:k.rowIndex)??null:null}),[r,a]=p.useState(!1),i=p.useRef(null);p.useEffect(()=>{e.isEditing!==void 0&&e.isEditing!==r&&a(e.isEditing)},[e.isEditing]),p.useEffect(()=>{if(!r)return;const A=R=>{const k=R.target,S=i.current;S&&k.closest('[data-test="table-node-container"]')===S&&(R.stopPropagation(),R.preventDefault(),S.scrollTop+=R.deltaY,S.scrollLeft+=R.deltaX)};return document.addEventListener("wheel",A,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",A,{capture:!0})}},[r,e.id]);const c=e.data,l=c!=null&&c.rows&&(c!=null&&c.columns)?c:uv,d=p.useCallback((A,R)=>{const k=l.columns.map(S=>S.key===A?{...S,header:R}:S);s(e.id,{data:{...l,columns:k}})},[e.id,l,s]),h=p.useCallback(A=>{const R=l.rows.filter(k=>k.id!==A);s(e.id,{data:{...l,rows:R}})},[e.id,l,s]),u=p.useMemo(()=>{const A=l.columns.map(R=>eg(R.key,R.header,{width:R.width}));return A.push({id:"actions",header:()=>t.jsx("div",{"data-test":"actions-header"}),size:40,cell:({row:R})=>r?t.jsx(se,{"data-test":"delete-row-button",variant:"ghost",size:"sm",onClick:()=>h(R.original.id),className:"h-6 w-6 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",children:t.jsx(Nt,{className:"h-3 w-3"})}):null}),A},[l.columns,r,h]),f=p.useCallback((A,R,k)=>{const S=l.rows.map((E,C)=>C===A?{...E,[R]:k}:E);s(e.id,{data:{...l,rows:S}})},[e.id,l,s]),m=p.useCallback(()=>{const A={id:`row-${Date.now()}`};l.columns.forEach(R=>{A[R.key]=""}),s(e.id,{data:{...l,rows:[...l.rows,A]}})},[e.id,l,s]),y=p.useCallback(A=>{const R={id:`row-${Date.now()}`};l.columns.forEach(S=>{R[S.key]=""});const k=[...l.rows.slice(0,A),R,...l.rows.slice(A)];s(e.id,{data:{...l,rows:k}})},[e.id,l,s]),g=p.useCallback((A,R)=>{const k=[...l.rows],[S]=k.splice(A,1);k.splice(R,0,S),s(e.id,{data:{...l,rows:k}})},[e.id,l,s]),x=p.useCallback(A=>{s(e.id,{data:{...l,columnOrder:A}})},[e.id,l,s]),w=p.useCallback(()=>{const A=!r;a(A),s(e.id,{isEditing:A})},[r,e.id,s]),v=p.useCallback(()=>{r||(a(!0),s(e.id,{isEditing:!0}))},[r,e.id,s]),N=p.useCallback(A=>{r&&(A.stopPropagation(),A.nativeEvent.stopPropagation(),A.nativeEvent.stopImmediatePropagation())},[r,e.id]),b=p.useCallback(()=>{const A=i.current;if(!A)return;const R=document.querySelector("[data-canvas-container]"),k=R==null?void 0:R.getBoundingClientRect();ul(async()=>{const{canvasStoreV2:S}=await import("./index-eHP58yiE.js").then(E=>E.dm);return{canvasStoreV2:S}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({canvasStoreV2:S})=>{const E=S.getState().projectCanvas.getActive(),C=(E==null?void 0:E.viewState.scale)??1,I=(E==null?void 0:E.viewState.offset)??{x:0,y:0},O=W=>{if(!k)return null;const P=W.x-k.left,j=W.y-k.top;return{x:Math.round((P-I.x)/C),y:Math.round((j-I.y)/C),w:Math.round(W.width/C),h:Math.round(W.height/C)}};A.getBoundingClientRect();const H=A.querySelector("thead tr");H==null||H.getBoundingClientRect();const L=A.querySelectorAll("tbody tr");Array.from(L).map((W,P)=>({index:P,canvas:O(W.getBoundingClientRect())}))})},[e.id,e.x,e.y]);return t.jsx("div",{ref:i,"data-test":"table-node-container",style:{width:"100%",height:"100%",overflow:r?"auto":"hidden"},onDoubleClick:v,onWheel:N,onClick:b,children:t.jsx(tg,{data:l.rows,columns:u,isEditing:r,onDataUpdate:f,onHeaderUpdate:d,onAddNewRow:r?m:void 0,onInsertRow:r?y:void 0,enableColumnReorder:r,onColumnOrderChange:x,enableRowReorder:r,onRowOrderChange:g,highlightColumnKey:n,highlightRowIndex:o,topRight:t.jsxs("div",{className:"flex items-center gap-1","data-test":"table-header-actions",children:[t.jsx(se,{"data-test":"table-edit-toggle",onClick:w,size:"sm",variant:"outline",className:"h-6 text-xs",children:r?"Done":"Edit"}),t.jsx(ya,{storageKey:"table-node-drop-config",initialConfig:{dropBehavior:Q.canvasTable.dropBehavior},children:(A,R,k)=>t.jsx(k,{size:"smIconCompact",variant:"ghost",title:"Table Drop Settings",contentClassName:"w-48",children:t.jsxs("div",{className:"space-y-3","data-test":"table-drop-config",children:[t.jsx("div",{className:"text-sm font-medium","data-test":"config-title",children:"On node drop"}),t.jsxs(_u,{value:A.dropBehavior,onValueChange:S=>R({dropBehavior:S}),"data-test":"drop-behavior-radio",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(hi,{value:"copy",id:"copy","data-test":"radio-copy"}),t.jsx(Fe,{htmlFor:"copy",className:"text-sm cursor-pointer","data-test":"label-copy",children:"Copy nodes"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(hi,{value:"delete",id:"delete","data-test":"radio-delete"}),t.jsx(Fe,{htmlFor:"delete",className:"text-sm cursor-pointer","data-test":"label-delete",children:"Delete nodes"})]})]})]})})})]})})})},pv=({node:e,preventEdit:s})=>{var I;const n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(e.title||""),[l,d]=p.useState(e.content||""),{onEditStart:h,onEditEnd:u}=wn(e.id,"title"),{onEditStart:f,onEditEnd:m}=wn(e.id,"content"),y=T.getState(),g=y.updateNode,x=y.setMode,w=y.uiState.nodeToFocusId,v=(I=y.projectCanvas.getActive())==null?void 0:I.coreState,N=(v==null?void 0:v.selectedNodes)??[],b=N.some(O=>O.id===e.id),A=b&&w===e.id,R=O=>{c(O.target.value)},k=O=>{d(O.target.value)},S=p.useCallback(()=>{var O;g(e.id,{title:i,content:l,isEditing:!1}),u(i),m(l),a(!1),(O=window.getSelection())==null||O.removeAllRanges()},[e.id,g,i,l,u,m]),E=p.useCallback(()=>{b&&N.length<=1&&!s&&(r||(h(e.title||""),f(e.content||"")),a(!0),g(e.id,{isEditing:!0}))},[b,N.length,s,g,e.id,r,e.title,e.content,h,f]),C=p.useCallback(O=>{var H,L;if(O.key==="Escape"){S(),T.getState().uiState.mode!==ee.VIM&&x(ee.SELECT),(H=n.current)==null||H.blur(),(L=o.current)==null||L.blur();return}},[S,x]);return p.useEffect(()=>{A&&r&&n.current&&n.current.focus()},[A,r]),p.useEffect(()=>{c(e.title||""),d(e.content||"")},[e.title,e.content]),t.jsxs("div",{className:"w-full h-full flex flex-col",children:[t.jsx("div",{className:"title-section border-b",children:t.jsx("input",{ref:n,type:"text",value:i,onChange:R,onBlur:S,onMouseDown:E,onKeyDown:C,placeholder:"Title...",className:Me("w-full px-2 py-1","text-sm font-semibold","border-none focus:outline-none","bg-transparent",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})}),t.jsx("div",{className:"content-section flex-1",children:t.jsx("textarea",{ref:o,value:l,onChange:k,onBlur:S,onMouseDown:E,onKeyDown:C,placeholder:"Content...",className:Me("w-full h-full","px-2 py-1","text-sm","border-none focus:outline-none","bg-transparent","resize-none","overflow-hidden",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})})]})},gv=({node:e,isSingleNodeSelected:s,isCollapsed:n=!1})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(e.title||""),c=p.useRef(null),l=p.useRef(e.title||""),{onEditStart:d,onEditEnd:h}=wn(e.id,"title");p.useEffect(()=>{i(e.title||""),l.current=e.title||""},[e.title]),p.useEffect(()=>{l.current=a},[a]),p.useEffect(()=>{o&&c.current&&(c.current.focus(),c.current.select())},[o]),p.useEffect(()=>{if(s)return()=>{const b=l.current.trim();b!==e.title&&T.getState().updateNodeTitle(e.id,b)}},[s,e.id,e.title]);const u=p.useCallback(()=>{const b=a.trim();b!==e.title&&T.getState().updateNodeTitle(e.id,b),h(b),r(!1)},[e.id,a,e.title,h]),f=p.useCallback(b=>{b.key==="Enter"?(b.preventDefault(),u()):b.key==="Escape"&&(b.preventDefault(),i(e.title||""),r(!1))},[u,e.title]),m=()=>{if(e.title)return e.title;if(typeof e.content=="string"){const b=e.content.split(`
`)[0];return b.length>50?b.substring(0,50)+"...":b}return"(empty)"},y=p.useMemo(()=>e.title?Ni(e.title):"",[e.title]),g=p.useMemo(()=>{const b=m();return Ni(b)},[e.title,e.content]),x=$(b=>{var k;const R=(((k=b.projectCanvas.getActive())==null?void 0:k.coreState.nodes)??[]).find(S=>S.id===e.id);return(R==null?void 0:R.isCollapsed)??!1}),w=p.useCallback(b=>{b.stopPropagation(),b.preventDefault(),T.getState().updateNode(e.id,{isCollapsed:!x})},[e.id,x]),v=Q.nodeUI.idleOpacity,N=t.jsx(se,{title:x?"Expand node":"Collapse node",variant:"ghost",size:"icon",onClick:w,className:"absolute h-6 w-6 flex-shrink-0 transition-opacity duration-200",style:{left:-43,opacity:v},onMouseEnter:b=>{b.currentTarget.style.opacity="1"},onMouseLeave:b=>{b.currentTarget.style.opacity=String(v)},"data-test":"node-title-collapse-button",children:x?t.jsx(ss,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(Pt,{className:"h-3.5 w-3.5"})});return n?t.jsxs("div",{className:"markdown-textarea absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-collapsed",children:[N,t.jsx("div",{className:"px-2 py-0.5 bg-background/90 truncate border border-dashed border-muted-foreground rounded [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:g}})]}):!e.title&&!s?null:t.jsxs("div",{className:"absolute flex gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-container",children:[s&&N,s?t.jsx("input",{ref:c,type:"text",value:a,onChange:b=>i(b.target.value),onBlur:u,onKeyDown:f,placeholder:"Add title...",className:"relative left-0 text-xs px-2 py-0.5 bg-background/90 w-full",onClick:b=>{b.stopPropagation(),o||d(e.title||""),r(!0)}}):e.title?t.jsx("div",{className:"text-xs px-2 py-0.5 bg-background/90 truncate [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:y}}):null]})};function fv(e,s){return e.node.title===s.node.title&&e.node.width===s.node.width&&e.node.content===s.node.content&&e.isSingleNodeSelected===s.isSingleNodeSelected&&e.isCollapsed===s.isCollapsed}const mv=He.memo(gv,fv),xv=(e,s)=>p.useMemo(()=>{if(s.length!==1)return-1;const n=s[0].id;return e.findIndex(o=>o.id===n)},[e,s]),yv={[fe.RECT]:t.jsx(Jt,{className:"w-4 h-4"}),[fe.TEXT]:t.jsx(hp,{className:"w-4 h-4"})},Ra=e=>yv[e]??null,wv=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{const[r,a]=p.useState(!1),[i,c]=p.useState(null),[l,d]=p.useState(!1),h=p.useRef(null),u=p.useCallback(g=>{const w=(l?e:s).map(v=>{const N=Array.isArray(v.tags)?v.tags:[];if(N.some(R=>R.title===g))return v;const A={id:Math.random().toString(36).slice(2,10),title:g};return{...v,tags:[...N,A]}});n(w),o()},[l,e,s,n,o]),f=p.useCallback(g=>{const w=(l?e:s).map(v=>{const N=Array.isArray(v.tags)?v.tags:[];return N.some(A=>A.title===g)?{...v,tags:N.filter(A=>A.title!==g)}:v});n(w),o()},[l,e,s,n,o]),m=He.useMemo(()=>{const g=l?e:s,x=new Set;return g.forEach(w=>{(Array.isArray(w.tags)?w.tags:[]).forEach(N=>x.add(N.title))}),Array.from(x).sort()},[l,e,s]),y=He.useMemo(()=>{const g=new Set;return e.forEach(x=>{(Array.isArray(x.tags)?x.tags:[]).forEach(v=>g.add(v.title))}),Array.from(g).sort()},[e]);return t.jsxs(t.Fragment,{children:[t.jsx(ks,{ref:h,onMouseDown:g=>g.stopPropagation(),onClick:g=>{if(g.stopPropagation(),h.current){const x=h.current.getBoundingClientRect();c({x:x.left,y:x.bottom+4})}a(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Tag nodes","data-test":"nodes-info-tag-button",children:t.jsx(uo,{})}),t.jsx(et,{isVisible:r,onClose:()=>a(!1),title:"Tag Nodes",triggerPosition:i??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"apply-to-section space-y-2 pb-2 border-b",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:g=>d(g.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"tag-apply-to-all-checkbox"}),t.jsx("span",{children:"Apply to all nodes"})]}),t.jsx("div",{className:"text-xs text-muted-foreground ml-6",children:l?`Will apply to all ${e.length} nodes`:`Will apply to ${s.length} selected node${s.length!==1?"s":""}`})]}),t.jsx(ma,{tags:m,onAddTag:u,onRemoveTag:f,canvasTags:y})]})})]})},vv={content:!0,title:!1,id:!1,type:!1,tags:!1},Rn=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const h=n?l:l.toLowerCase();let u=0,f=h.indexOf(a,u);for(;f!==-1;){const m=Math.max(0,f-40),y=Math.min(l.length,f+a.length+40);let g=l.substring(m,y);m>0&&(g="..."+g),y<l.length&&(g=g+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:g,startIndex:f,field:o}),u=f+1,f=h.indexOf(a,u)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const h=Math.max(0,d-40),u=Math.min(e.length,d+a.length+40);let f=e.substring(h,u);h>0&&(f="..."+f),u<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},bv=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...Rn(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...Rn(e.title,s,n,"title")),o.id&&e.id&&r.push(...Rn(e.id,s,n,"id")),o.type&&e.type&&r.push(...Rn(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...Rn(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},Nv=e=>{const{node:s,matches:n}=e,o=Ra(s.type),r=s.id.substring(0,6),a=typeof s.content=="string"?s.content:"",i=s.title?`${s.title.substring(0,30)}${s.title.length>30?"...":""}`:a?`${a.substring(0,30)}${a.length>30?"...":""}`:"(No Content)",c=s.title&&a?`${a.substring(0,50)}${a.length>50?"...":""}`:null;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[o&&t.jsx("span",{className:"flex-shrink-0",children:o}),t.jsx("span",{className:"truncate",children:i}),s.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(lt,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[n.length," ",n.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:r})]}),c&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:c})]})},Sv=(e,s,n,o)=>{const r=n?s:s.toLowerCase(),i=(n?e.context:e.context.toLowerCase()).indexOf(r);if(i===-1)return t.jsxs("div",{className:"text-xs font-mono flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:e.context})]});const c=e.context.substring(0,i),l=e.context.substring(i,i+s.length),d=e.context.substring(i+s.length);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsxs("span",{className:"flex-1",children:[c,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:l}),d]})]})},Cv=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(!1),[r,a]=p.useState(null),[i,c]=p.useState(""),[l,d]=p.useState(!1),[h,u]=p.useState(vv),f=p.useRef(null),[m,y]=p.useState(new Set),[g,x]=p.useState(!1),w=l||h.title||h.id||h.type||h.tags||!h.content,v=p.useMemo(()=>{if(!i.trim())return[];if(!Object.values(h).some(C=>C))return[];const E=[];return e.forEach(C=>{if(m.has(C.id))return;const I=bv(C,i,l,h);I&&E.push(I)}),E},[e,i,l,h,m]),N=p.useMemo(()=>v.reduce((S,E)=>S+E.matches.length,0),[v]),b=p.useCallback(()=>{if(v.length>0){const S=v.map(E=>E.node);s(S)}},[v,s]),A=p.useCallback(S=>{y(E=>new Set(E).add(S))},[]),R=p.useCallback(S=>{const E=S.node;s([E]),T.getState().scrollToNode(E.id)},[s]),k=p.useCallback((S,E)=>{const C=S.node;s([C]);const I=ke.LINE_HEIGHT_FIND,O=E?(E-1)*I:0;yo(C,{highlightYOffset:O})},[s]);return t.jsxs(t.Fragment,{children:[t.jsx(ks,{ref:f,onMouseDown:S=>S.stopPropagation(),onClick:S=>{if(S.stopPropagation(),f.current){const E=f.current.getBoundingClientRect();a({x:E.left,y:E.bottom+4})}o(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Find nodes","data-test":"nodes-info-find-button",children:t.jsx(Ss,{})}),t.jsx(et,{isVisible:n,onClose:()=>{o(!1)},title:"Find Nodes",triggerPosition:r??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-3 space-y-3","data-test":"find-nodes-popover-content",children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"find-nodes-search-section",children:[t.jsx(Ss,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"find-nodes-search-icon"}),t.jsx(ze,{type:"text",placeholder:"Search nodes...",value:i,onChange:S=>c(S.target.value),onKeyDown:S=>{S.key==="Enter"&&i.trim()&&(S.preventDefault(),b())},className:Ie("h-8 text-sm pl-8",i?"pr-16":"pr-10"),autoFocus:!0,"data-test":"find-nodes-search-input"}),i&&t.jsx(se,{variant:"ghost",size:"icon",onClick:()=>c(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"find-nodes-clear-button",children:t.jsx(Ke,{className:"h-3 w-3"})}),w&&t.jsx("div",{className:Ie("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",i?"right-16":"right-11"),"data-test":"find-nodes-filter-indicator"}),t.jsxs(St,{open:g,onOpenChange:x,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"find-nodes-settings-button",children:t.jsx(ka,{className:"h-3.5 w-3.5"})})}),t.jsx(jt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:We.draggablePopoverDropdown},"data-test":"find-nodes-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"find-case-sensitive",checked:l,onCheckedChange:S=>d(!!S),"data-test":"find-nodes-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"find-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"find-node-content",checked:h.content,onCheckedChange:S=>u(E=>({...E,content:!!S})),"data-test":"find-nodes-content-checkbox"}),t.jsx("label",{htmlFor:"find-node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"find-node-title",checked:h.title,onCheckedChange:S=>u(E=>({...E,title:!!S})),"data-test":"find-nodes-title-checkbox"}),t.jsx("label",{htmlFor:"find-node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"find-node-id",checked:h.id,onCheckedChange:S=>u(E=>({...E,id:!!S})),"data-test":"find-nodes-id-checkbox"}),t.jsx("label",{htmlFor:"find-node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"find-node-type",checked:h.type,onCheckedChange:S=>u(E=>({...E,type:!!S})),"data-test":"find-nodes-type-checkbox"}),t.jsx("label",{htmlFor:"find-node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"find-node-tags",checked:h.tags,onCheckedChange:S=>u(E=>({...E,tags:!!S})),"data-test":"find-nodes-tags-checkbox"}),t.jsx("label",{htmlFor:"find-node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]})]})})]})]}),i.trim()&&t.jsx("div",{className:"results-section space-y-2","data-test":"find-nodes-results-section",children:t.jsx("div",{className:"results-info flex items-center justify-between","data-test":"find-nodes-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground","data-test":v.length===0?"find-nodes-no-matches":"find-nodes-match-count",children:v.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found ",t.jsx(lt,{variant:"secondary",className:"mx-1","data-test":"find-nodes-total-matches-badge",children:N}),N===1?"match":"matches"," in"," ",t.jsx(lt,{variant:"secondary",className:"mx-1","data-test":"find-nodes-nodes-count-badge",children:v.length}),v.length===1?"node":"nodes"]})})})}),v.length>0&&t.jsx("div",{className:"nodes-list-section space-y-2 max-h-[400px] overflow-y-auto","data-test":"find-nodes-list-section",children:v.map(S=>t.jsx("div",{className:"node-matches-container border border-border rounded-md overflow-hidden","data-test":"find-nodes-result",children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>A(S.nodeId),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"find-nodes-remove-result-button",children:t.jsx(Ke,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none","data-test":"find-nodes-result-content",children:[t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:()=>R(S),"data-test":"find-nodes-result-header",children:Nv(S)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":"find-nodes-result-matches",children:S.matches.map((E,C)=>t.jsx("div",{onClick:I=>{I.stopPropagation(),k(S,E.lineNumber)},"data-test":"find-nodes-match",children:Sv(E,i,l)},C))})]})]})},S.nodeId))})]})})]})},jv=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{var N;const r=T.getState(),a=r.setNodeUpdateSettings,i=((N=r.uiState)==null?void 0:N.nodeUpdateSettings)??{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},[c,l]=p.useState(!1),[d,h]=p.useState(i.searchHistory[0]??""),[u,f]=p.useState(null),m=He.useRef(null),[y,g]=p.useState(i.deleteInAllNodes),[x,w]=p.useState(i.deleteWholeLine),v=p.useCallback(()=>{if(!d)return;const A=(y?e:s).map(k=>{if(typeof k.content!="string")return k;let S=k.content;x?S=S.split(`
`).filter(H=>!H.includes(d)).join(`
`):S=S.split(d).join("");const E=k.width??ke.DEFAULT_NODE_WIDTH,C=It(S,E,k);return{...k,content:S,height:C}});n(A);const R=[d,...i.searchHistory.filter(k=>k!==d)].slice(0,10);a({deleteInAllNodes:y,deleteWholeLine:x,searchHistory:R}),o(),console.log(`Deleted "${d}" from ${A.length} nodes (wholeLine: ${x})`)},[d,y,x,e,s,n,i.searchHistory,a,o]);return t.jsxs(t.Fragment,{children:[t.jsx(ks,{ref:m,onMouseDown:b=>b.stopPropagation(),onClick:b=>{if(b.stopPropagation(),m.current){const A=m.current.getBoundingClientRect();f({x:A.left,y:A.bottom+4})}l(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Update nodes","data-test":"nodes-info-update-button",children:t.jsx(Fs,{})}),t.jsx(et,{isVisible:c,onClose:()=>l(!1),title:"Update Nodes",triggerPosition:u??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:d,onChange:b=>h(b.target.value),placeholder:"Text to delete...",className:"flex-1 px-2 py-1 text-sm border rounded bg-background","data-test":"update-nodes-search-input"}),t.jsxs("button",{onClick:v,disabled:!d,className:"flex items-center gap-1 px-2 py-1 text-sm rounded bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors","data-test":"update-nodes-delete-button",children:[t.jsx(Nt,{className:"w-3 h-3"}),"Delete"]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:y,onChange:b=>{const A=b.target.checked;g(A),a({deleteInAllNodes:A}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-all-nodes-checkbox"}),t.jsx("span",{children:"Delete in all nodes"})]}),t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:x,onChange:b=>{const A=b.target.checked;w(A),a({deleteWholeLine:A}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-whole-line-checkbox"}),t.jsx("span",{children:"Delete whole line"})]})]}),t.jsx("div",{className:"text-xs text-muted-foreground",children:y?`Will update all ${e.length} nodes`:`Will update ${s.length} selected node${s.length!==1?"s":""}`})]})})]})},kv=e=>{const s=Ra(e.type),n=String(e.content??""),o=n?`${n.substring(0,15)}${n.length>15?"...":""}`:"(No Content)",r=e.id.substring(0,6),a=`[x:${Math.round(e.x)},y:${Math.round(e.y)}]`,i=`[w:${Math.round(e.width??0)},h:${Math.round(e.height??0)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"node-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"node-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"node-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"node-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"node-display-text",children:o}),e.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0","data-test":"node-display-editing-indicator",children:"[E]"})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"node-display-id",children:r})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1","data-test":"node-display-coords",children:[a," ",i]})]})},Vd=e=>{const{className:s,style:n,nodes:o,headerText:r,initiallyExpanded:a}=e,i=T.getState(),c=i.projectCanvas.getActive(),l=o??(c==null?void 0:c.coreState.nodes)??[],d=(c==null?void 0:c.coreState.selectedNodes)??[],h=i.setSelectedNodes,u=i.scrollToNode,f=i.updateNodes,m=i.saveStateToLocalStorage,y=p.useCallback((w,v)=>{const N=w.length>0?w[0]:-1;if(N>=0&&N<l.length){const b=l[N];h([b]),u(b.id)}else h([])},[l,h,u]),g=xv(l,d),x=g!==-1?[g]:[];return t.jsx("div",{"data-ui-panel":"canvas-node-infos","data-test":"canvas-node-infos-container",className:Me("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:w=>w.stopPropagation(),children:t.jsx(Rr,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-node-infos-header",children:r??"Nodes"}),itemList:l.map(kv),onSelectionChange:y,selectedIndices:x,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!a,moreOptions:t.jsxs(t.Fragment,{children:[t.jsx(Cv,{nodes:l,setSelectedNodes:h}),t.jsx(wv,{nodes:l,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:m}),t.jsx(jv,{nodes:l,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:m})]})})})},Iv=({tag:e})=>{const[s,n]=p.useState(!1),o=p.useMemo(()=>{if(!s)return[];const i=T.getState().projectCanvas.getActive();return((i==null?void 0:i.coreState.nodes)??[]).filter(l=>Array.isArray(l.tags)&&l.tags.some(d=>d.title===e.title))},[s,e.title]),r=p.useCallback(a=>{a.stopPropagation()},[]);return t.jsxs(St,{open:s,onOpenChange:n,children:[t.jsx(Ct,{asChild:!0,children:t.jsxs(lt,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-5 bg-background/90 text-muted-foreground font-normal italic cursor-pointer hover:bg-accent","data-test":"node-tag",onClick:r,children:["#",e.title]})}),t.jsx(jt,{className:"p-0 w-auto",align:"end",onPointerDownOutside:a=>a.stopPropagation(),onClick:a=>a.stopPropagation(),children:t.jsx(Vd,{nodes:o,headerText:`#${e.title}`,className:"border-0",initiallyExpanded:!0})})]})},Av=({node:e})=>!e.tags||!Array.isArray(e.tags)||e.tags.length===0?null:t.jsx("div",{className:"absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",right:"0px"},"data-test":"node-tags-container",children:e.tags.map(s=>t.jsx(Iv,{tag:s},s.id))});function Tv(e,s){const n=e.node.tags,o=s.node.tags;if(n===o)return!0;const r=Array.isArray(n),a=Array.isArray(o);return!r&&!a?!0:!r||!a||n.length!==o.length?!1:n.every((i,c)=>{var l,d;return i.id===((l=o[c])==null?void 0:l.id)&&i.title===((d=o[c])==null?void 0:d.title)})}const Ev=He.memo(Av,Tv),Gd=p.createContext(null),Yd=()=>{const e=p.useContext(Gd);if(!e)throw new Error("useWorkflowExecution must be used within a WorkflowExecutionProvider. Make sure CanvasAppV2 wraps its content with the provider.");return e},Rv=({children:e,value:s})=>t.jsx(Gd.Provider,{value:s,children:e}),Xd=({nodeId:e,label:s="Execute Workflow",className:n})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(null),c=Yd(),{executeWorkflow:l}=c,d=u=>{u.stopPropagation()},h=async u=>{u.stopPropagation(),r(!0),i(null);try{await l(!1,e)}catch(f){const m=f instanceof Error?f.message:String(f);i(m)}finally{r(!1)}};return t.jsxs("div",{className:"w-full",children:[t.jsx(se,{"data-test":"workflow-execute-button",onPointerDown:d,onClick:h,disabled:o,className:Ie("w-full bg-primary hover:bg-primary/70 text-primary-foreground","disabled:bg-muted disabled:text-muted-foreground disabled:cursor-not-allowed",n),size:"sm",children:o?t.jsxs(t.Fragment,{children:[t.jsx(xo,{className:"w-4 h-4 animate-spin"}),"Executing..."]}):t.jsxs(t.Fragment,{children:[t.jsx(ft,{className:"w-4 h-4"}),s]})}),a&&t.jsxs("div",{className:"text-xs text-destructive mt-1",children:["Error: ",a]})]})},Mv=({executionState:e,duration:s,className:n})=>{if(!e||e==="idle")return null;const r={pending:{color:"bg-gray-500",textColor:"text-white",icon:null,label:"Pending"},running:{color:"bg-blue-500",textColor:"text-white",icon:t.jsx(xo,{className:"w-3 h-3 animate-spin"}),label:"Running"},success:{color:"bg-green-500",textColor:"text-white",icon:t.jsx(vn,{className:"w-3 h-3"}),label:"Success"},error:{color:"bg-red-500",textColor:"text-white",icon:t.jsx(Ke,{className:"w-3 h-3"}),label:"Error"}}[e];return t.jsxs("div",{"data-test":"workflow-execution-badge",className:Ie("absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium","flex items-center gap-1",r.color,r.textColor,n),children:[r.icon&&t.jsx("span",{"data-test":"workflow-execution-badge-icon",children:r.icon}),t.jsx("span",{"data-test":"workflow-execution-badge-label",children:r.label}),s&&t.jsxs("span",{"data-test":"workflow-execution-badge-duration",className:"ml-1",children:["(",s,"ms)"]})]})};class Ro{static convertOrchestrationNode(s,n){var c;const o=s.data,r=((c=o==null?void 0:o.parameters)==null?void 0:c.rows)||[],a=this.convertRowsToNodes(r),i=[...this.createConnectionsFromRowHierarchy(r),...this.createConnectionsFromArrows(s.id,n)];return{nodes:a,connections:i}}static convertRowsToNodes(s){const n=[];for(const o of s){const r={id:o.id,type:o.stepType||"unknown",parameters:{label:o.label,order:o.order,...o.config||{}},inputHandles:this.createHandlesForStepType(o.stepType,"input",o.id),outputHandles:this.createHandlesForStepType(o.stepType,"output",o.id)};if(n.push(r),o.children&&o.children.length>0){const a=this.convertRowsToNodes(o.children);n.push(...a)}}return n}static createHandlesForStepType(s,n,o){const r=["source","transform","nodeUpdate","condition","if"],a=["source","transform","nodeUpdate","condition","if","loop"];return n==="input"&&r.includes(s)?[{id:`input_${o}`,name:"Input",type:"input",dataType:"any"}]:n==="output"&&a.includes(s)?[{id:`output_${o}`,name:"Output",type:"output",dataType:"any"}]:[]}static createConnectionsFromRowHierarchy(s,n){const o=[];for(const r of s)if(n&&o.push({id:`conn_${n}_to_${r.id}`,sourceNodeId:n,sourceHandleId:`output_${n}`,targetNodeId:r.id,targetHandleId:`input_${r.id}`}),r.children&&r.children.length>0){const a=this.createConnectionsFromRowHierarchy(r.children,r.id);o.push(...a)}return o}static createConnectionsFromArrows(s,n){const o=[],r=n.filter(a=>a.endNodeId===s&&a.endRowId);for(const a of r){const i={id:a.id,sourceNodeId:a.startNodeId||"",sourceHandleId:a.startRowId||`output_${a.startNodeId}`,targetNodeId:a.endRowId||"",targetHandleId:a.endRowId||`input_${a.endRowId}`};o.push(i)}return o}static getWorkflowName(s){return s.title||"Untitled Workflow"}static getWorkflowDescription(s){var r,a;const n=s.data,o=((a=(r=n==null?void 0:n.parameters)==null?void 0:r.rows)==null?void 0:a.length)||0;return`Workflow with ${o} step${o!==1?"s":""}`}}class Pv{constructor(s=[]){qe(this,"crudService");this.crudService=new wl(s)}create(s){const n=new Date().toISOString(),o=this.crudService.create({name:s.name,description:s.description,tags:s.tags||[],nodes:s.nodes||[],connections:s.connections||[],version:1,createdAt:n,updatedAt:n});if(!o)throw new Error("Failed to create workflow definition");return o}getAll(){return this.crudService.readAll()}getById(s){return this.crudService.readById(s)}update(s,n){const o=this.crudService.readById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt,updatedAt:new Date().toISOString(),version:(o.version||1)+1};return this.crudService.update(r),r}delete(s){this.crudService.delete(s)}findByTag(s){return this.crudService.readAll().filter(n=>{var o;return(o=n.tags)==null?void 0:o.includes(s)})}findByName(s){const n=s.toLowerCase();return this.crudService.readAll().filter(o=>o.name.toLowerCase().includes(n))}count(){return this.crudService.count()}clear(){this.crudService.clear()}updateNodes(s,n){return this.update(s,{nodes:n})}updateConnections(s,n){return this.update(s,{connections:n})}addNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.nodes,n];return this.updateNodes(s,r)}removeNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.nodes.filter(i=>i.id!==n),a=o.connections.filter(i=>i.sourceNodeId!==n&&i.targetNodeId!==n);return this.update(s,{nodes:r,connections:a})}addConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.connections,n];return this.updateConnections(s,r)}removeConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.connections.filter(a=>a.id!==n);return this.updateConnections(s,r)}duplicate(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);return this.create({name:n,description:o.description,tags:o.tags?[...o.tags]:void 0,nodes:o.nodes.map(r=>({...r})),connections:o.connections.map(r=>({...r}))})}}class vr{constructor(s=[],n=[]){qe(this,"definitionService");qe(this,"instanceService");qe(this,"executionFacade");this.definitionService=new Pv(s),this.instanceService=new wl(n),this.executionFacade=new fn}createDefinition(s){return this.definitionService.create(s)}getAllDefinitions(){return this.definitionService.getAll()}getDefinitionById(s){return this.definitionService.getById(s)}updateDefinition(s,n){return this.definitionService.update(s,n)}deleteDefinition(s){this.instanceService.filterByKey("definitionId",s).forEach(o=>this.instanceService.delete(o.id)),this.definitionService.delete(s)}findDefinitionsByTag(s){return this.definitionService.findByTag(s)}findDefinitionsByName(s){return this.definitionService.findByName(s)}duplicateDefinition(s,n){return this.definitionService.duplicate(s,n)}createInstance(s,n){const o=this.definitionService.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=new Date().toISOString(),a=this.instanceService.create({definitionId:s,name:n||o.name,status:"idle",createdAt:r,executionHistory:[]});if(!a)throw new Error("Failed to create workflow instance");return a}getAllInstances(){return this.instanceService.readAll()}getInstanceById(s){return this.instanceService.readById(s)}getInstancesByDefinitionId(s){return this.instanceService.filterByKey("definitionId",s)}updateInstance(s,n){const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt};this.instanceService.update(r)}deleteInstance(s){this.instanceService.delete(s)}async executeInstance(s,n={}){var a;const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r=this.definitionService.getById(o.definitionId);if(!r)throw new Error(`Workflow definition not found: ${o.definitionId}`);this.updateInstance(s,{status:"running"});try{const i=this.convertWorkflowNodesToCanvas(r.nodes),c=this.convertWorkflowConnectionsToCanvas(r.connections);this.executionFacade.loadWorkflow(i,c);const l=await this.executionFacade.executeWorkflow(n.triggerNodeId||((a=i[0])==null?void 0:a.id)||""),d=l.executionId?await this.executionFacade.getExecution(l.executionId):null;if(d){const u=[...o.executionHistory,d];this.updateInstance(s,{status:l.success?"completed":"failed",lastExecutedAt:new Date().toISOString(),executionHistory:u})}return{success:l.success,executionId:l.executionId||"",instanceId:s,definitionId:o.definitionId,duration:l.duration||0,executedNodeCount:l.executedNodeCount||0,errors:l.errors||[],nodeUpdates:l.nodeUpdates}}catch(i){throw this.updateInstance(s,{status:"failed"}),i}}getExecutionHistory(s){const n=this.instanceService.readById(s);if(!n)throw new Error(`Workflow instance not found: ${s}`);return n.executionHistory}clearExecutionHistory(s){this.updateInstance(s,{executionHistory:[]})}convertWorkflowNodesToCanvas(s){return s.map(n=>({id:n.id,x:0,y:0,type:"workflow",data:{nodeType:n.type,parameters:n.parameters,inputHandles:n.inputHandles,outputHandles:n.outputHandles},width:200,height:100}))}convertWorkflowConnectionsToCanvas(s){return s.map(n=>({id:n.id,startNodeId:n.sourceNodeId,endNodeId:n.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0},startRowId:n.sourceHandleId,endRowId:n.targetHandleId}))}getStats(){const s=this.instanceService.readAll(),n=s.reduce((o,r)=>(o[r.status]=(o[r.status]||0)+1,o),{});return{totalDefinitions:this.definitionService.count(),totalInstances:s.length,instancesByStatus:n}}clearAll(){this.definitionService.clear(),this.instanceService.clear()}}class br{constructor(s,n){qe(this,"workflowManager");this.getCanvasState=n,this.workflowManager=s||new vr}saveWorkflow(s){const{nodeId:n,name:o,description:r,tags:a}=s,{node:i,arrows:c}=this.getNodeAndArrows(n),{nodes:l,connections:d}=Ro.convertOrchestrationNode(i,c),h=o||Ro.getWorkflowName(i),u=r||Ro.getWorkflowDescription(i),m=this.workflowManager.getAllDefinitions().find(y=>y.name===h);return m?this.workflowManager.updateDefinition(m.id,{nodes:l,connections:d,description:u,tags:a||m.tags}):this.workflowManager.createDefinition({name:h,description:u,tags:a||[],nodes:l,connections:d})}loadWorkflow(s){const{definitionId:n,position:o={x:100,y:100},existingNodeId:r}=s,a=this.workflowManager.getDefinitionById(n);if(!a)throw new Error(`Workflow definition not found: ${n}`);const i=this.convertWorkflowNodesToRows(a.nodes,a.connections);return{id:r||`workflow-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:a.name,content:a.description||"",x:o.x,y:o.y,width:400,height:600,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:i},inputHandles:this.createInputHandlesFromRows(i),outputHandles:[]}}}validateWorkflow(s){var r;const n=[],o=[];try{const{node:a,arrows:i}=this.getNodeAndArrows(s),c=a.data,l=((r=c==null?void 0:c.parameters)==null?void 0:r.rows)||[];l.length===0&&n.push("Workflow must have at least one step");const d=l.filter(m=>!m.stepType||m.stepType==="empty");d.length>0&&o.push(`${d.length} step(s) have no type configured`);const h=new Set(i.filter(m=>m.endNodeId===s&&m.endRowId).map(m=>m.endRowId)),f=l.filter(m=>m.stepType==="source").filter(m=>!h.has(m.id));return f.length>0&&o.push(`${f.length} source step(s) have no input connections`),{valid:n.length===0,errors:n,warnings:o}}catch(a){return{valid:!1,errors:[`Validation failed: ${String(a)}`],warnings:o}}}canSave(s){const n=this.validateWorkflow(s);return{valid:n.valid,errors:n.errors}}previewDefinition(s){const{node:n,arrows:o}=this.getNodeAndArrows(s),{nodes:r,connections:a}=Ro.convertOrchestrationNode(n,o);return{nodes:r,connections:a,nodeCount:r.length,connectionCount:a.length}}addRow(s){var f;const{nodeId:n,stepType:o,label:r,parentRowId:a,config:i}=s,{node:c}=this.getNodeAndArrows(n),l=c.data,d=((f=l==null?void 0:l.parameters)==null?void 0:f.rows)||[],h=d.length+1,u={id:Ve(),label:r||`Step ${h}`,order:h,stepType:o,config:i||{}};if(a){const m=this.addRowToParent(d,a,u);this.updateNodeRows(n,m)}else{const m=[...d,u];this.updateNodeRows(n,m)}return u}updateRow(s){var d;const{nodeId:n,rowId:o,updates:r}=s,{node:a}=this.getNodeAndArrows(n),i=a.data,c=((d=i==null?void 0:i.parameters)==null?void 0:d.rows)||[],l=this.updateRowRecursive(c,o,r);this.updateNodeRows(n,l)}deleteRow(s){var l;const{nodeId:n,rowId:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((l=a==null?void 0:a.parameters)==null?void 0:l.rows)||[],c=this.deleteRowRecursive(i,o);this.updateNodeRows(n,c)}reorderRows(s){var d;const{nodeId:n,rowOrders:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((d=a==null?void 0:a.parameters)==null?void 0:d.rows)||[],c=new Map(o.map(h=>[h.rowId,h.order])),l=this.updateRowOrders(i,c);this.updateNodeRows(n,l)}getTemplates(){return[{id:"simple-transform",name:"Simple Transform",description:"Data input → transformation → output"},{id:"conditional-flow",name:"Conditional Flow",description:"Data input → condition check → branching logic"},{id:"loop-process",name:"Loop Processing",description:"Data input → loop over items → process each"}]}createFromTemplate(s){const{templateId:n,name:o}=s,a={"simple-transform":{name:o||"Simple Transform Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"transform-1",type:"transform",parameters:{label:"Transform Data"},inputHandles:[{id:"input_transform-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_transform-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"transform-1",targetHandleId:"input_transform-1"}]},"conditional-flow":{name:o||"Conditional Flow Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"condition-1",type:"if",parameters:{label:"Check Condition"},inputHandles:[{id:"input_condition-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_condition-1_true",name:"True",type:"output",dataType:"any"},{id:"output_condition-1_false",name:"False",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"condition-1",targetHandleId:"input_condition-1"}]},"loop-process":{name:o||"Loop Processing Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"loop-1",type:"loop",parameters:{label:"Process Each Item"},inputHandles:[{id:"input_loop-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_loop-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"loop-1",targetHandleId:"input_loop-1"}]}}[n];if(!a)throw new Error(`Template not found: ${n}`);return this.workflowManager.createDefinition({name:a.name,description:`Created from ${n} template`,tags:["template",n],nodes:a.nodes,connections:a.connections})}exportWorkflow(s){const n=this.workflowManager.getDefinitionById(s);if(!n)throw new Error(`Workflow definition not found: ${s}`);return JSON.stringify(n,null,2)}exportWorkflows(s){const n=s.map(o=>this.workflowManager.getDefinitionById(o)).filter(o=>o!==void 0);return JSON.stringify(n,null,2)}exportAllWorkflows(){const s=this.workflowManager.getAllDefinitions();return JSON.stringify(s,null,2)}importWorkflow(s){try{const n=JSON.parse(s);if(!n.name||!Array.isArray(n.nodes)||!Array.isArray(n.connections))throw new Error("Invalid workflow format: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:n.name,description:n.description,tags:n.tags||[],nodes:n.nodes,connections:n.connections})}catch(n){throw new Error(`Failed to import workflow: ${n instanceof Error?n.message:String(n)}`)}}importWorkflows(s){try{const n=JSON.parse(s);if(!Array.isArray(n))throw new Error("Invalid format: expected array of workflows");return n.map(o=>{if(!o.name||!Array.isArray(o.nodes)||!Array.isArray(o.connections))throw new Error("Invalid workflow format in array: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:o.name,description:o.description,tags:o.tags||[],nodes:o.nodes,connections:o.connections})})}catch(n){throw new Error(`Failed to import workflows: ${n instanceof Error?n.message:String(n)}`)}}downloadWorkflow(s){const n=this.exportWorkflow(s),o=this.workflowManager.getDefinitionById(s);if(!o)return;const r=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`${o.name.replace(/[^a-z0-9]/gi,"_")}.workflow.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}downloadWorkflows(s){const n=this.exportWorkflows(s),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download=`workflows_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}bulkDeleteDefinitions(s){s.forEach(n=>{this.workflowManager.deleteDefinition(n)})}bulkDuplicateDefinitions(s){return s.map((n,o)=>{const r=this.workflowManager.getDefinitionById(n);if(!r)throw new Error(`Definition not found: ${n}`);return this.workflowManager.duplicateDefinition(n,`${r.name} (Copy ${o+1})`)})}bulkAddTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const a=r.tags||[],i=[...new Set([...a,...n])];this.workflowManager.updateDefinition(o,{tags:i})})}bulkRemoveTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const i=(r.tags||[]).filter(c=>!n.includes(c));this.workflowManager.updateDefinition(o,{tags:i})})}getBulkStats(s){const n=s.map(i=>this.workflowManager.getDefinitionById(i)).filter(i=>i!==void 0),o=new Set;let r=0,a=0;return n.forEach(i=>{r+=i.nodes.length,a+=i.connections.length,(i.tags||[]).forEach(c=>o.add(c))}),{count:n.length,totalNodes:r,totalConnections:a,tags:Array.from(o)}}getNodeAndArrows(s){if(!this.getCanvasState)throw new Error("Canvas state getter not provided");const{nodes:n,arrows:o}=this.getCanvasState(),r=n.find(a=>a.id===s);if(!r)throw new Error(`Node not found: ${s}`);return{node:r,arrows:o}}convertWorkflowNodesToRows(s,n){const o=new Map;for(const c of n)if(c.sourceHandleId.startsWith("output_")&&c.targetHandleId.startsWith("input_")){const l=c.sourceNodeId,d=c.targetNodeId;o.has(l)||o.set(l,[]),o.get(l).push(d)}const r=new Set,a=(c,l)=>{r.add(c.id);const h=(o.get(c.id)||[]).filter(u=>!r.has(u)).map((u,f)=>{const m=s.find(y=>y.id===u);return m?a(m,f+1):null}).filter(Boolean);return{id:c.id,label:c.parameters.label||`Step ${l}`,order:l,stepType:c.type,config:c.parameters,children:h.length>0?h:void 0}};return s.filter(c=>!n.some(l=>l.targetNodeId===c.id)).map((c,l)=>a(c,l+1))}createInputHandlesFromRows(s){const n=[],o=r=>{r.stepType==="source"&&n.push({id:`input_${r.id}`,name:r.label,type:"input",dataType:"any"}),r.children&&r.children.forEach(a=>o(a))};return s.forEach(o),n}updateNodeRows(s,n){if(!this.getCanvasState)throw new Error("Cannot update rows without canvas state");const o=this.createInputHandlesFromRows(n);return{rows:n,inputHandles:o}}addRowToParent(s,n,o){return s.map(r=>{if(r.id===n){const a=r.children||[];return{...r,children:[...a,o]}}return r.children?{...r,children:this.addRowToParent(r.children,n,o)}:r})}updateRowRecursive(s,n,o){return s.map(r=>r.id===n?{...r,...o}:r.children?{...r,children:this.updateRowRecursive(r.children,n,o)}:r)}deleteRowRecursive(s,n){return s.filter(o=>o.id!==n).map(o=>o.children?{...o,children:this.deleteRowRecursive(o.children,n)}:o)}updateRowOrders(s,n){return s.map(o=>{const r=n.get(o.id),a=r!==void 0?{...o,order:r}:o;return a.children?{...a,children:this.updateRowOrders(a.children,n)}:a}).sort((o,r)=>o.order-r.order)}}const Kd="workflow-manager-storage",qd=()=>{try{const e=localStorage.getItem(Kd);if(e)return JSON.parse(e)}catch(e){console.error("[WorkflowManager] Failed to load from localStorage:",e)}return null},Dv=e=>{try{const s=JSON.stringify(e);localStorage.setItem(Kd,s)}catch(s){console.error("[WorkflowManager] Failed to save to localStorage:",s)}},dn=qd(),mc=(dn==null?void 0:dn.definitions)||[],xc=(dn==null?void 0:dn.instances)||[],Ts=dl((e,s)=>{const n=new vr(mc,xc);return{definitions:mc,instances:xc,facade:n,selectedDefinitionId:null,selectedInstanceId:null,isExecuting:!1,lastExecutionResult:null,createDefinition:o=>{const r=n.createDefinition(o),a=n.getAllDefinitions();return e({definitions:a}),s().saveToStorage(),r},updateDefinition:(o,r)=>{const a=n.updateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},deleteDefinition:o=>{n.deleteDefinition(o);const r=n.getAllDefinitions(),a=n.getAllInstances();e({definitions:r,instances:a,selectedDefinitionId:s().selectedDefinitionId===o?null:s().selectedDefinitionId}),s().saveToStorage()},duplicateDefinition:(o,r)=>{const a=n.duplicateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},findDefinitionsByTag:o=>n.findDefinitionsByTag(o),findDefinitionsByName:o=>n.findDefinitionsByName(o),createInstance:(o,r)=>{const a=n.createInstance(o,r),i=n.getAllInstances();return e({instances:i}),s().saveToStorage(),a},updateInstance:(o,r)=>{n.updateInstance(o,r);const a=n.getAllInstances();e({instances:a}),s().saveToStorage()},deleteInstance:o=>{n.deleteInstance(o);const r=n.getAllInstances();e({instances:r,selectedInstanceId:s().selectedInstanceId===o?null:s().selectedInstanceId}),s().saveToStorage()},getInstancesByDefinitionId:o=>n.getInstancesByDefinitionId(o),executeInstance:async(o,r)=>{e({isExecuting:!0});try{const a=await n.executeInstance(o,r),i=n.getAllInstances();return e({instances:i,isExecuting:!1,lastExecutionResult:a}),s().saveToStorage(),a}catch(a){throw e({isExecuting:!1}),a}},selectDefinition:o=>{e({selectedDefinitionId:o})},selectInstance:o=>{e({selectedInstanceId:o})},getStats:()=>n.getStats(),clearAll:()=>{n.clearAll(),e({definitions:[],instances:[],selectedDefinitionId:null,selectedInstanceId:null,lastExecutionResult:null}),s().saveToStorage()},loadFromStorage:()=>{const o=qd();if(o){const r=new vr(o.definitions,o.instances);e({definitions:o.definitions,instances:o.instances,facade:r})}},saveToStorage:()=>{Dv({definitions:s().definitions,instances:s().instances})}}}),Ov=({node:e,nodes:s,arrows:n,updateNode:o})=>{var d;const r=e.data,a=((d=r==null?void 0:r.parameters)==null?void 0:d.rows)||[],i=Ts.getState().definitions,c=()=>{try{const u=new br(Ts.getState().facade,()=>({nodes:s,arrows:n})).previewDefinition(e.id),f=typeof e.title=="string"?e.title:`Workflow ${e.id}`,m=typeof e.content=="string"?e.content:"",g=Ts.getState().definitions.find(w=>w.name===f);let x;g?x=Ts.getState().updateDefinition(g.id,{nodes:u.nodes,connections:u.connections,description:m}):x=Ts.getState().createDefinition({name:f,description:m,tags:[],nodes:u.nodes,connections:u.connections}),Ee.success("Workflow saved",{description:`"${x.name}" saved successfully (v${x.version})`})}catch(h){Ee.error("Failed to save workflow",{description:h instanceof Error?h.message:String(h)})}},l=h=>{if(!h){Ee.error("No workflow selected",{description:"Please select a workflow to load"});return}try{const f=new br(Ts.getState().facade,()=>({nodes:s,arrows:n})).loadWorkflow({definitionId:h,existingNodeId:e.id});o(e.id,{title:f.title,content:f.content,data:f.data}),Ee.success("Workflow loaded",{description:`"${f.title}" loaded successfully`})}catch(u){Ee.error("Failed to load workflow",{description:u instanceof Error?u.message:String(u)})}};return t.jsx(ya,{storageKey:`workflow-more-options-${e.id}`,initialConfig:{autoSaveEnabled:!1,selectedDefinitionId:""},children:(h,u,f)=>(p.useEffect(()=>{if(!h.autoSaveEnabled||a.length===0)return;const m=setTimeout(()=>{c()},3e3);return()=>clearTimeout(m)},[a,h.autoSaveEnabled]),t.jsx(f,{icon:t.jsx(Gl,{className:"h-4 w-4"}),variant:"ghost",size:"icon",buttonClassName:"workflow-more-options-button",contentClassName:"w-80",title:"Workflow Options",children:t.jsxs("div",{className:"workflow-options-panel space-y-4",children:[t.jsxs("div",{className:"save-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Save Workflow"}),t.jsxs("button",{"data-test":"workflow-save-to-manager-button",onClick:m=>{m.stopPropagation(),c()},className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:[t.jsx(hs,{className:"h-4 w-4"}),"Save to Workflow Manager"]})]}),t.jsxs("div",{className:"load-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Load Workflow"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Select a workflow to load into this node"}),t.jsxs(yt,{"data-test":"workflow-load-select",value:h.selectedDefinitionId,onValueChange:m=>{u({...h,selectedDefinitionId:m})},children:[t.jsx(wt,{"data-test":"workflow-load-select-trigger",children:t.jsx(vt,{placeholder:"Select workflow..."})}),t.jsx(bt,{children:i.length===0?t.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No saved workflows found"}):i.map(m=>t.jsxs(Qe,{value:m.id,children:[m.name," (v",m.version,")"]},m.id))})]}),t.jsxs("button",{"data-test":"workflow-load-confirm-button",onClick:m=>{m.stopPropagation(),l(h.selectedDefinitionId),u({...h,selectedDefinitionId:""})},disabled:!h.selectedDefinitionId,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm border rounded hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[t.jsx(pp,{className:"h-4 w-4"}),"Load"]})]}),t.jsx("div",{className:"auto-save-section space-y-2 pt-2 border-t",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"space-y-0.5",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Auto-Save"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically save after changes (3s delay)"})]}),t.jsx("button",{"data-test":"workflow-auto-save-toggle",onClick:m=>{m.stopPropagation();const y=!h.autoSaveEnabled;u({...h,autoSaveEnabled:y}),Ee.info(y?"Auto-save enabled":"Auto-save disabled",{description:y?"Workflow will save automatically after changes":"Manual save required"})},className:`w-10 h-10 flex items-center justify-center rounded transition-colors border ${h.autoSaveEnabled?"bg-primary text-primary-foreground border-primary":"hover:bg-accent border-border"}`,title:h.autoSaveEnabled?"Disable auto-save":"Enable auto-save",children:t.jsx(vs,{className:"h-4 w-4"})})]})})]})}))})},Lv=({node:e,nodes:s,arrows:n,showTextConfig:o,rows:r,updateNode:a,onToggleTextConfig:i,onSetJsonConfigText:c,onSetJsonError:l})=>{const d=e.data,{executeWorkflow:h,showDryRunResults:u}=Yd(),f=y=>{if(y.stopPropagation(),!o){const g={nodeId:e.id,nodeType:d==null?void 0:d.nodeType,rows:r,connections:n.filter(x=>x.endNodeId===e.id||x.startNodeId===e.id)};c(JSON.stringify(g,null,2)),l(null)}i()},m=async y=>{y.stopPropagation();const g=await h(!0,e.id);u(g)};return t.jsxs("div",{className:"workflow-header font-semibold mb-2 text-sm border-b pb-1 flex justify-between items-center",children:[t.jsx("span",{children:o?"JSON Config":"Orchestration Rows"}),(d==null?void 0:d.showExecuteButton)&&t.jsxs("div",{className:"execute-button-container flex items-center gap-1.5",children:[t.jsx(se,{"data-test":"workflow-toggle-json-button",onClick:f,variant:o?"default":"outline",size:"icon",className:"h-8 w-8",title:o?"View visual steps":"View workflow as JSON",children:o?t.jsx(us,{className:"h-4 w-4"}):t.jsx(Ia,{className:"h-4 w-4"})}),t.jsx(se,{"data-test":"workflow-dry-run-button",onClick:m,variant:"outline",size:"icon",className:"h-8 w-8",title:"Dry Run (preview changes without applying)",children:t.jsx(Ss,{className:"h-4 w-4"})}),t.jsx(Xd,{nodeId:e.id,label:"",className:"h-8 w-8"}),t.jsx(Ov,{node:e,nodes:s,arrows:n,updateNode:a})]})]})},Wv=({node:e,jsonConfigText:s,jsonError:n,onJsonConfigTextChange:o,onJsonErrorChange:r,onClose:a,updateNode:i})=>{const c=e.data,l=f=>{f.stopPropagation();try{const m=JSON.parse(s);if(!m.rows||!Array.isArray(m.rows)){r('Invalid JSON: "rows" must be an array');return}i(e.id,{data:{...c,parameters:{...c.parameters,rows:m.rows}}}),r(null),a()}catch(m){r(`Invalid JSON: ${m.message}`)}},d=f=>{f.stopPropagation(),navigator.clipboard.writeText(s)},h=f=>{o(f.target.value),r(null)},u=f=>{f.preventDefault(),f.stopPropagation();const m=f.currentTarget,y=m.scrollTop<m.scrollHeight-m.clientHeight,g=m.scrollTop>0,x=f.deltaY>0;(x&&y||!x&&g)&&(m.scrollTop+=f.deltaY)};return t.jsxs("div",{className:"workflow-json-wrapper h-full w-full flex flex-col gap-1",onWheel:f=>{f.stopPropagation()},children:[t.jsx("div",{className:"workflow-textarea-parent flex-1 w-full min-h-0",onWheel:f=>{f.stopPropagation()},children:t.jsx("textarea",{value:s,onChange:h,onClick:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onWheel:u,className:"workflow-textarea w-full h-full text-[10px] font-mono bg-background border-0 p-1 resize-none focus:outline-none overflow-auto",spellCheck:!1})}),n&&t.jsx("div",{className:"text-[10px] text-destructive bg-destructive/10 border-t border-destructive/20 px-1 py-1",children:n}),t.jsxs("div",{className:"flex gap-1 border-t pt-1",children:[t.jsx("button",{"data-test":"workflow-json-save-button",onClick:l,className:"flex-1 px-2 py-1 text-[10px] bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:"Save"}),t.jsx("button",{"data-test":"workflow-json-copy-button",onClick:d,className:"px-2 py-1 text-[10px] border border-border rounded hover:bg-accent transition-colors",children:"Copy"})]})]})},Hv=({node:e,rows:s,rowElementsRef:n,connectorOffsetLeft:o,stepTypesWithConnectors:r})=>t.jsx("div",{"data-test":"workflow-connector-layer-container",className:"workflow-connector-layer absolute top-0 bottom-0 pointer-events-none",style:{left:`${o}px`},children:s.map(a=>{if(!r.includes(a.stepType))return null;const i=a.id.replace("row_",""),c=a.label||`Step ${i}`,l=n.current.get(a.id);if(!l)return null;const d=l.getBoundingClientRect(),h=l.closest(".bg-background.border.p-3");if(!h)return null;const u=h.getBoundingClientRect(),f=d.top+d.height/2-u.top;return t.jsx("div",{"data-test":"workflow-connector","data-row-connector":a.id,"data-node-id":e.id,className:"absolute w-3 h-3 rounded-full border-2 border bg-background cursor-crosshair hover:bg-accent transition-colors pointer-events-auto",style:{left:"0",top:`${f}px`,transform:"translateY(-50%)"},title:`Connect to ${c}`,onClick:m=>{m.stopPropagation()}},`connector-${a.id}`)})}),Fv=({node:e,rows:s,updateNode:n})=>{const o=e.data,[r,a]=p.useState(null),[i,c]=p.useState(!1),[l,d]=p.useState(!1),[h,u]=p.useState(!1),[f,m]=p.useState(null),[y,g]=p.useState(null),x=(E,C)=>{for(const I of E){if(I.id===C)return I;if(I.children){const O=x(I.children,C);if(O)return O}}return null},w=(E,C,I)=>E.map(O=>O.id===C?{...O,...I}:O.children?{...O,children:w(O.children,C,I)}:O),v=(E,C)=>E.filter(I=>I.id!==C).map(I=>I.children?{...I,children:v(I.children,C)}:I);return{selectedRowId:r,setSelectedRowId:a,configPopoverOpen:i,setConfigPopoverOpen:c,showNodeUpdateConfig:l,setShowNodeUpdateConfig:d,showIfStepConfig:h,setShowIfStepConfig:u,popoverPosition:f,popoverSize:y,handleAddRow:()=>{const E=s.length+1,C={id:Ve(),label:`Step ${E}`,order:E,stepType:"empty"},I=[...s,C];I.sort((L,W)=>L.order-W.order);const H=I.filter(L=>Jn.includes(L.stepType)).map(L=>({id:`input_${L.id}`,name:L.label,type:"input",dataType:"any"}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:I},inputHandles:H}})},handleRowClick:(E,C,I)=>{const O=x(s,E);a(E);const H=window.innerWidth,L=window.innerHeight,W=C.clientX,P=C.clientY,M=W<H/2?W+100:W-100;m({x:M,y:P});const B=Math.min(450,Math.floor(L*.6));if(g({width:500,height:B}),I==="badge")c(!0);else if(I==="gear"){const z=O==null?void 0:O.stepType;z==="nodeUpdate"?d(!0):z==="if"&&u(!0)}},handleConfigureRow:(E,C)=>{const I=w(s,E,{stepType:C});n(e.id,{data:{...o,parameters:{...o.parameters,rows:I}}}),a(null)},handleDeleteRow:E=>{const C=v(s,E),O=C.filter(H=>Jn.includes(H.stepType)).map((H,L)=>({id:H.id,position:"left",offsetY:96+L*32}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:C},inputHandles:O}})},handleSaveNodeUpdateConfig:E=>{if(!r)return;const C=w(s,r,{stepType:"nodeUpdate",config:E});n(e.id,{data:{...o,parameters:{...o.parameters,rows:C}}}),d(!1),a(null)},handleSaveIfStepConfig:E=>{if(!r)return;const C=w(s,r,{stepType:"if",config:E});n(e.id,{data:{...o,parameters:{...o.parameters,rows:C}}}),u(!1),a(null)},findRowRecursive:x}},yc=({node:e})=>{var k,S,E;const s=e.data,n=((k=s==null?void 0:s.parameters)==null?void 0:k.rows)||[],[o,r]=p.useState(!1),[a,i]=p.useState(""),[c,l]=p.useState(null);p.useEffect(()=>{if(!o)return;const C=I=>{var H;const O=I.target;if(O.closest(".workflow-json-wrapper")){const L=(H=O.closest(".workflow-json-wrapper"))==null?void 0:H.querySelector("textarea");if(L){I.stopPropagation(),I.preventDefault();const W=L.scrollTop<L.scrollHeight-L.clientHeight,P=L.scrollTop>0,j=I.deltaY>0;(j&&W||!j&&P)&&(L.scrollTop+=I.deltaY)}}};return document.addEventListener("wheel",C,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",C,{capture:!0})}},[o]);const[d,h]=p.useState(()=>new Set(n.filter(C=>C.children&&C.children.length>0).map(C=>C.id))),u=p.useRef(null),f=p.useRef(new Map),[m,y]=p.useState(null),g=$(C=>{var I;return((I=C.projectCanvas.getActive())==null?void 0:I.coreState.arrows)??[]}),x=$(C=>{var I;return((I=C.projectCanvas.getActive())==null?void 0:I.coreState.nodes)??[]}),v=$(C=>{var I;return((I=C.projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes)??[]}).some(C=>C.id===e.id),{updateNode:N}=T.getState(),b=Fv({node:e,rows:n,updateNode:N}),A=g.filter(C=>C.endNodeId===e.id&&C.endRowId);p.useEffect(()=>{let C=[...n],I=!1;const O=new Set;A.forEach(L=>{L.endRowId&&O.add(L.endRowId)});const H=C.length;if(C=C.filter(L=>{const W=L.stepType&&L.stepType!=="empty";return O.has(L.id)||W}),C.length!==H&&(I=!0),I){C.sort((P,j)=>P.order-j.order);const W=C.filter(P=>Jn.includes(P.stepType)).map(P=>({id:`input_${P.id}`,name:P.label,type:"input",dataType:"any"}));N(e.id,{data:{...s,parameters:{...s.parameters,rows:C},inputHandles:W}})}},[A.length,e.id,N]),p.useEffect(()=>(u.current=new sg({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:()=>!0,onDragMove:({sortIndex:C})=>{C!==null&&y(C)},onDrop:({item:C,sortIndex:I})=>{if(I==null)return;const O=C.data.rowId,H=[...n],L=H.findIndex(M=>M.id===O);if(L===-1)return;const[W]=H.splice(L,1);H.splice(I,0,W),H.forEach((M,B)=>{M.order=B+1});const j=H.filter(M=>Jn.includes(M.stepType)).map((M,B)=>({id:M.id,position:"left",offsetY:96+B*32}));N(e.id,{data:{...s,parameters:{...s.parameters,rows:H},inputHandles:j}})},onDragEnd:()=>{y(null)}}),()=>{var C;(C=u.current)==null||C.destroy(),f.current.clear()}),[e.id]),p.useEffect(()=>{if(!u.current)return;const C=document.querySelector(`[data-workflow-rows="${e.id}"]`);C&&!C.dataset.dropZoneRegistered&&(u.current.registerDropZone(`workflow-rows-${e.id}`,C,void 0,{nodeId:e.id}),C.dataset.dropZoneRegistered="true"),n.forEach(O=>{const H=document.querySelector(`[data-drag-handle="${O.id}"]`);H&&!H.dataset.dndRegistered&&(u.current.registerDraggable(O.id,H,{rowId:O.id}),H.dataset.dndRegistered="true")});const I=new Set(n.map(O=>O.id));f.current.forEach((O,H)=>{I.has(H)||(u.current.unregisterDraggable(H),f.current.delete(H))})},[n,e.id]);const R=C=>{const O=C.target.closest("[data-drag-handle]"),H=document.querySelector(`[data-node-id="${e.id}"]`);H==null||H.getBoundingClientRect(),n.map(L=>{const W=document.querySelector(`[data-workflow-row="${e.id}:${L.id}"]`);if(W){const P=W.getBoundingClientRect();return{rowId:L.id,screenY:P.top+P.height/2,top:P.top,bottom:P.bottom,height:P.height}}return{rowId:L.id,error:"element not found"}}),v&&!O&&C.stopPropagation()};return t.jsxs("div",{"data-test":"workflow-orchestration-node",className:"workflow-node-container bg-background border p-3 w-full h-full flex flex-col relative overflow-visible",onPointerDown:R,children:[t.jsx(Hv,{node:e,rows:n,rowElementsRef:f,connectorOffsetLeft:qp,stepTypesWithConnectors:Jn}),t.jsx(Lv,{node:e,nodes:x,arrows:g,showTextConfig:o,rows:n,updateNode:N,onToggleTextConfig:()=>r(!o),onSetJsonConfigText:i,onSetJsonError:l}),t.jsx("div",{"data-test":"workflow-content-area",className:"workflow-content-area flex-1 w-full text-xs overflow-y-auto relative","data-workflow-rows":e.id,onWheel:C=>{o&&C.stopPropagation()},children:o?t.jsx(Wv,{node:e,jsonConfigText:a,jsonError:c,onJsonConfigTextChange:i,onJsonErrorChange:l,onClose:()=>r(!1),updateNode:N}):t.jsx(ng,{data:n,defaultExpandedIds:d,onReorder:C=>{const I=(W,P=1)=>W.map((j,M)=>{const B=P+M;return{...j,order:B,children:j.children?I(j.children,B*10):j.children}}),O=I(C),H=new Set(O.filter(W=>W.children&&W.children.length>0).map(W=>W.id)),L=new Set(d);H.forEach(W=>{d.has(W)||L.add(W)}),h(L),N(e.id,{data:{...s,parameters:{...s.parameters,rows:O}}})},renderCustomContent:C=>t.jsx(Zp,{row:C,node:e,nodes:x,incomingArrows:A,selectedRowId:b.selectedRowId,configPopoverOpen:b.configPopoverOpen,rowElementsRef:f,onRowClick:b.handleRowClick,onConfigureRow:b.handleConfigureRow,onDeleteRow:b.handleDeleteRow,onSelectedRowIdChange:b.setSelectedRowId})})}),t.jsx("button",{"data-test":"workflow-add-row-button",onClick:b.handleAddRow,className:"mt-2 w-full py-1 text-xs border bg-background hover:bg-accent rounded",children:"+ Add Row"}),b.showNodeUpdateConfig&&b.selectedRowId&&t.jsx(Jp,{isVisible:b.showNodeUpdateConfig,onClose:()=>{b.setShowNodeUpdateConfig(!1),b.setSelectedRowId(null)},allNodes:x,currentConfig:(S=b.findRowRecursive(n,b.selectedRowId))==null?void 0:S.config,onSave:b.handleSaveNodeUpdateConfig,initialPosition:b.popoverPosition||void 0,initialSize:b.popoverSize||void 0}),b.showIfStepConfig&&b.selectedRowId&&t.jsx(Qp,{isVisible:b.showIfStepConfig,onClose:()=>{b.setShowIfStepConfig(!1),b.setSelectedRowId(null)},currentConfig:(E=b.findRowRecursive(n,b.selectedRowId))==null?void 0:E.config,onSave:b.handleSaveIfStepConfig,initialPosition:b.popoverPosition||void 0,initialSize:b.popoverSize||void 0})]})},Bv="type here...",zv=({node:e,preventEdit:s})=>{var E;const n=p.useRef(null),[o,r]=p.useState(s),[a,i]=p.useState(e.content||""),c=e.data,l=(c==null?void 0:c.displayFormat)||"raw",{updateNodeContent:d,updateNode:h,setMode:u}=T.getState(),f=$(C=>C.uiState.nodeToFocusId);$(C=>{var I;return((I=C.uiState.dragInfo)==null?void 0:I.draggedNodeId)===e.id});const m=$(C=>{var I,O;return((O=(I=C.projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes)==null?void 0:O.some(H=>H.id===e.id))??!1}),y=m&&f===e.id,g=$(C=>{var I,O;return((O=(I=C.projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes)==null?void 0:O.length)??0}),{fitNodeDimensions:x}=bn(),w=p.useMemo(()=>{if(l==="json")try{const C=JSON.parse(a);return JSON.stringify(C,null,2)}catch{return a}return a},[a,l]),v=C=>{i(C.target.value)},N=p.useCallback(C=>{C.preventDefault();const I=C.clipboardData.getData("text"),O=n.current;if(!O)return;const H=O.selectionStart,L=O.selectionEnd,W=O.value,P=W.substring(0,H)+I+W.substring(L);O.value=P;const j=H+I.length;O.setSelectionRange(j,j),i(P),d(e.id,P)},[e.id,d]),b=p.useCallback(C=>{r(C),h(e.id,{isEditing:C})},[h,e.id]),A=p.useCallback(()=>{var C;d(e.id,a),b(!1),h(e.id,{isEditing:!1}),(C=window.getSelection())==null||C.removeAllRanges()},[e.id,d,a,h]),R=p.useCallback(C=>{if(C.shiftKey){!o&&m&&g<=1&&(b(!0),setTimeout(()=>{var O;return(O=n.current)==null?void 0:O.focus()},0));return}const I=m&&g<=1;I&&b(I)},[o,m,g]),k=p.useCallback(C=>{var B,U,z,_;if(C.key==="Escape"){A(),b(!1),T.getState().uiState.mode!==ee.VIM&&u(ee.SELECT),(B=n.current)==null||B.blur();return}if(C.key==="Enter"&&C.ctrlKey){const G=((U=n.current)==null?void 0:U.value)||"";d(e.id,G);return}const I=((z=n.current)==null?void 0:z.value)??"",O=j(I),H=P(),L=M(I,C.key==="Enter",H),W=(_=e.options)!=null&&_.lockSize?e.width:O;h(e.id,{width:W,height:L,isEditing:!0});function P(){const G=n.current;if(G){const D=window.getComputedStyle(G).lineHeight;if(D&&D!=="normal"){const V=parseFloat(D);if(!isNaN(V))return V}}return ke.LINE_HEIGHT}function j(G,F=ke.DEFAULT_NODE_WIDTH,D=Ns.textNodeXPadding){const ie=G.split(/\n/).map(Z=>Xo(Z)).reduce((Z,ge)=>Math.max(Z,ge),0)+D,Se=Math.max(ie,F);return Math.max(Se,e.width??0)}function M(G,F=!1,D=ke.LINE_HEIGHT){let J=G.split(/\n/).length,ie=ke.DEFAULT_NODE_HEIGHT;return J===1&&!F?(ie=Math.max(ie,e.height??0),ie):(F&&(J+=1),ie+=(J-1)*D,ie=Math.max(ie,e.height??0),ie)}},[A,d,h,e.id,e.width]);p.useEffect(()=>{f||b(!1)},[f]),p.useEffect(()=>{y&&(b(!0),i(e.content||""),window.setTimeout(()=>{const C=n.current;C&&(C.focus(),C.selectionStart=C.selectionEnd=C.value.length)},0))},[y,e.content]),p.useEffect(()=>{i(e.content||"")},[e.content]);const S=p.useCallback(()=>{const C=l==="raw"?"json":"raw";h(e.id,{data:{...c,displayFormat:C}})},[l,e.id,c,h]);return t.jsxs("div",{className:"relative w-full h-full",children:[m&&t.jsx("button",{onClick:S,className:"absolute -top-7 right-0 z-50 px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",title:`Switch to ${l==="raw"?"JSON":"raw"} format`,children:l==="raw"?"Raw":"JSON"}),t.jsx("textarea",{spellCheck:!1,ref:n,id:`WorkflowSourceNode-${e.id}`,value:o?a:w,onChange:v,onPaste:N,onBlur:A,onKeyDown:k,onMouseDown:R,placeholder:Bv,"data-is-editing":s?!1:o,className:Me("relative z-10","m-0 p-1 w-full h-full","resize-none","overflow-hidden","border","font-mono",e.className,{"pointer-events-none":s,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!a&&!o}),style:{textAlign:(E=e.styles)==null?void 0:E.textAlign,fontSize:l==="json"?`${ke.FONT_SIZE_XXS}px`:Q.text.fontSize,lineHeight:l==="json"?"1.4":"1.5"},readOnly:!o})]})},wc=He.memo(zv),kt=e=>Ot(Ts,e),$v=({node:e,preventEdit:s})=>{const{updateNode:n}=T.getState(),o=$(w=>{var v,N;return((N=(v=w.projectCanvas.getActive())==null?void 0:v.coreState.selectedNodes)==null?void 0:N.some(b=>b.id===e.id))??!1}),r=kt(w=>w.definitions),a=kt(w=>w.createInstance),i=kt(w=>w.executeInstance),c=kt(w=>w.isExecuting),l=e.data||{},{definitionId:d,instanceId:h,lastExecutionStatus:u="idle"}=l,f=p.useMemo(()=>r.find(w=>w.id===d),[r,d]),m=p.useCallback(w=>{const v=a(w,`${(f==null?void 0:f.name)||"Workflow"} Instance`);n(e.id,{data:{...l,definitionId:w,instanceId:v.id,lastExecutionStatus:"idle"},title:(f==null?void 0:f.name)||"Workflow"})},[e.id,l,n,a,f]),y=p.useCallback(async()=>{if(!h){console.warn("No instance selected");return}try{n(e.id,{data:{...l,lastExecutionStatus:"running"}});const w=await i(h);n(e.id,{data:{...l,lastExecutionStatus:w.success?"completed":"failed"}})}catch{n(e.id,{data:{...l,lastExecutionStatus:"failed"}})}},[h,l,e.id,n,i]),g=p.useMemo(()=>{switch(u){case"running":return t.jsx(xo,{className:"h-4 w-4 animate-spin text-blue-500"});case"completed":return t.jsx(fp,{className:"h-4 w-4 text-green-500"});case"failed":return t.jsx(gp,{className:"h-4 w-4 text-red-500"});default:return t.jsx(Hs,{className:"h-4 w-4 text-gray-400"})}},[u]),x=p.useMemo(()=>{switch(u){case"running":return"border-blue-500";case"completed":return"border-green-500";case"failed":return"border-red-500";default:return"border-border"}},[u]);return t.jsxs("div",{className:Me("workflow-definition-node w-full h-full p-3 bg-background border-2 rounded flex flex-col gap-2",x,{"ring-2 ring-primary":o}),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Hs,{className:"h-5 w-5 text-primary"}),t.jsx("span",{className:"text-sm font-semibold",children:"Workflow"})]}),g]}),t.jsxs(yt,{value:d||"",onValueChange:m,disabled:s,children:[t.jsx(wt,{className:"w-full h-8 text-xs",children:t.jsx(vt,{placeholder:"Select workflow..."})}),t.jsx(bt,{children:r.length===0?t.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"No workflows available"}):r.map(w=>t.jsx(Qe,{value:w.id,className:"text-xs",children:w.name},w.id))})]}),d&&t.jsx("div",{className:"flex gap-1",children:t.jsxs(se,{size:"sm",variant:"default",className:"flex-1 h-7 text-xs",onClick:y,disabled:!d||c||s,children:[t.jsx(ft,{className:"h-3 w-3 mr-1"}),"Execute"]})}),f&&o&&t.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[t.jsxs("div",{children:["Nodes: ",f.nodes.length]}),t.jsxs("div",{children:["Connections: ",f.connections.length]}),f.tags&&f.tags.length>0&&t.jsx("div",{className:"flex gap-1 flex-wrap",children:f.tags.map(w=>t.jsx("span",{className:"px-1 py-0.5 bg-primary/10 text-primary rounded text-[10px]",children:w},w))})]})]})},_v=He.memo($v),Uv=({node:e})=>{const{updateNode:s}=T.getState(),n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),i=p.useRef(null),c=$(C=>{var O;const I=C.projectCanvas.getActive();return((O=I==null?void 0:I.coreState.selectedNodes)==null?void 0:O.some(H=>H.id===e.id))??!1}),l=$(C=>{var O;const I=C.projectCanvas.getActive();return((O=I==null?void 0:I.coreState.nodes)==null?void 0:O.length)??0}),d=e.data||{},[h,u]=p.useState(d.image||null),{result:f,isProcessing:m,error:y,processBlob:g,cancel:x,reset:w}=og();p.useEffect(()=>{o.current&&c&&o.current.focus()},[c]),p.useEffect(()=>{if(!c)return;const C=async I=>{var H;I.preventDefault(),I.stopPropagation();const O=(H=I.clipboardData)==null?void 0:H.items;if(O){for(const L of O)if(L.type.startsWith("image/")){const W=L.getAsFile();if(W){const P=new FileReader;P.onload=()=>{const j=P.result;u(j),w(),s(e.id,{data:{...d,image:j}})},P.readAsDataURL(W)}break}}};return document.addEventListener("paste",C),()=>{document.removeEventListener("paste",C)}},[c,e.id,d,s,w]),p.useEffect(()=>{if(!f)return;const C=f.timestamp.toISOString();if(i.current===C)return;const I=f.extractedText||"[No text detected in image]",O={image:h||void 0,extractedText:f.extractedText,detectedLanguage:f.detectedLanguage,confidence:f.confidence,processingTime:f.processingTime,timestamp:f.timestamp.toISOString()};s(e.id,{data:O,content:f.extractedText});const H=Ye.buildTextNodeV2({content:I});Aa(H,e,"right",{shouldFocus:!1}),i.current=C},[f,h,e.id,e,s,l]);const v=p.useCallback(async C=>{var O;const I=(O=C.target.files)==null?void 0:O[0];if(I&&I.type.startsWith("image/")){const H=new FileReader;H.onload=()=>{const L=H.result;u(L),w(),s(e.id,{data:{...d,image:L}})},H.readAsDataURL(I)}},[w,e.id,d,s]),N=p.useCallback(async()=>{if(!h)return;const I=await(await fetch(h)).blob();await g(I)},[h,g]),b=p.useCallback(async()=>{if(!h)return;const I=await(await fetch(h)).blob();await g(I,{downscale:!0,downscaleFactor:.5})},[h,g]),A=p.useCallback(()=>{x()},[x]),R=p.useCallback(()=>{u(null),w(),n.current&&(n.current.value=""),s(e.id,{data:{},content:""})},[w,e.id,s]),k=p.useCallback(async()=>{const C=(f==null?void 0:f.extractedText)||d.extractedText;if(C)try{await navigator.clipboard.writeText(C),a(!0),setTimeout(()=>a(!1),2e3)}catch(I){console.error("Failed to copy:",I)}},[f,d]),S=p.useCallback(C=>{var O;C.preventDefault(),C.stopPropagation();const I=(O=C.clipboardData)==null?void 0:O.items;if(I){for(const H of I)if(H.type.startsWith("image/")){const L=H.getAsFile();if(L){const W=new FileReader;W.onload=()=>{const P=W.result;u(P),w(),s(e.id,{data:{...d,image:P}})},W.readAsDataURL(L)}break}}},[e.id,d,w,s]),E=f||(d.extractedText?{extractedText:d.extractedText,detectedLanguage:d.detectedLanguage,confidence:d.confidence,processingTime:d.processingTime}:null);return t.jsxs("div",{className:"canvas-ocr-node w-full h-full p-4 flex flex-col gap-3 overflow-auto",children:[t.jsxs("div",{className:"ocr-header flex items-center justify-between pb-2 border-b border-border",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Fo,{className:"h-4 w-4 text-primary"}),t.jsx("h3",{className:"text-sm font-semibold",children:"OCR Node"})]}),h&&t.jsx(se,{"data-test":"ocr-clear-button",variant:"ghost",size:"sm",onClick:R,className:"h-6 px-2",children:t.jsx(Ke,{className:"h-3 w-3"})})]}),t.jsx("div",{ref:o,className:"image-input-area border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onPaste:S,tabIndex:0,role:"button","aria-label":"Paste image area",children:h?t.jsxs("div",{className:"image-preview-container space-y-2",children:[t.jsx("img",{src:h,alt:"OCR preview",className:"image-preview max-w-full max-h-32 mx-auto rounded-lg shadow-sm"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for OCR"})]}):t.jsxs("div",{className:"empty-state space-y-2",children:[t.jsx(ho,{className:"w-6 h-6 mx-auto text-muted-foreground"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Paste image (Ctrl+V) or upload"})]})}),t.jsxs("div",{className:"upload-controls",children:[t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:v,className:"hidden"}),t.jsxs(se,{"data-test":"ocr-upload-button",variant:"outline",size:"sm",onClick:()=>{var C;return(C=n.current)==null?void 0:C.click()},className:"w-full",children:[t.jsx(ho,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]}),y&&!m&&t.jsxs(ag,{variant:"destructive",children:[t.jsx(Zo,{className:"h-4 w-4"}),t.jsx(rg,{className:"text-xs",children:y})]}),t.jsx("div",{className:"ocr-controls flex flex-col gap-2",children:m?t.jsxs(se,{"data-test":"ocr-cancel-button",variant:"destructive",onClick:A,className:"w-full",size:"sm",children:[t.jsx(xo,{className:"w-3 h-3 mr-2 animate-spin"}),"Cancel"]}):t.jsxs(t.Fragment,{children:[t.jsxs(se,{"data-test":"ocr-extract-button",onClick:N,disabled:!h,className:"w-full",size:"sm",children:[t.jsx(Fo,{className:"w-3 h-3 mr-2"}),"Extract Text"]}),t.jsxs(se,{"data-test":"ocr-extract-downscale-button",onClick:b,disabled:!h,variant:"outline",className:"w-full",size:"sm",children:[t.jsx(Fo,{className:"w-3 h-3 mr-2"}),"Downscale and Extract"]})]})}),E&&t.jsxs("div",{className:"ocr-results space-y-2 flex-1 flex flex-col",children:[t.jsxs("div",{className:"results-header flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[t.jsx(Jo,{className:"w-3 h-3 text-green-600"}),t.jsx("span",{children:"Extracted"})]}),t.jsx(se,{"data-test":"ocr-copy-result-button",variant:"ghost",size:"sm",onClick:k,className:"h-6 px-2",children:r?t.jsxs(t.Fragment,{children:[t.jsx(Jo,{className:"w-3 h-3 mr-1 text-green-600"}),t.jsx("span",{className:"text-xs",children:"Copied!"})]}):t.jsxs(t.Fragment,{children:[t.jsx(Bt,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"text-xs",children:"Copy"})]})})]}),(E.detectedLanguage||E.confidence||E.processingTime)&&t.jsxs("div",{className:"results-metadata text-xs text-muted-foreground space-y-1",children:[E.detectedLanguage&&t.jsxs("div",{children:["Language: ",E.detectedLanguage]}),E.confidence&&t.jsxs("div",{children:["Confidence: ",E.confidence]}),E.processingTime&&t.jsxs("div",{children:["Time: ",E.processingTime,"ms"]})]}),t.jsx("div",{className:"results-text flex-1 p-3 bg-muted rounded-lg font-mono text-xs whitespace-pre-wrap break-words overflow-y-auto",children:E.extractedText})]})]})},Vv=He.memo(Uv),tr=1/3;function sr(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}const Gv=({node:e})=>{const{updateNode:s}=T.getState(),n=p.useRef(null),o=p.useRef(null),r=$(h=>{var f;const u=h.projectCanvas.getActive();return((f=u==null?void 0:u.coreState.selectedNodes)==null?void 0:f.some(m=>m.id===e.id))??!1}),a=e.data||{},[i,c]=p.useState(a.image||null);p.useEffect(()=>{o.current&&r&&o.current.focus()},[r]),p.useEffect(()=>{if(!r)return;const h=async u=>{var m;u.preventDefault(),u.stopPropagation();const f=(m=u.clipboardData)==null?void 0:m.items;if(f){for(const y of f)if(y.type.startsWith("image/")){const g=y.getAsFile();if(g){Math.round(g.size/1024);const x=new FileReader;x.onload=async()=>{let w=x.result,v;{const b=await sr(w,tr);w=b.dataUrl,v=b.size}c(w);const N=Math.round(w.length*3/4/1024);s(e.id,{data:{...a,imageSize:v,fileSizeKB:N,image:w}})},x.readAsDataURL(g)}break}}};return document.addEventListener("paste",h),()=>{document.removeEventListener("paste",h)}},[r,e.id,a,s]);const l=p.useCallback(async h=>{var f;const u=(f=h.target.files)==null?void 0:f[0];if(u&&u.type.startsWith("image/")){Math.round(u.size/1024);const m=new FileReader;m.onload=async()=>{let y=m.result,g;{const w=await sr(y,tr);y=w.dataUrl,g=w.size}c(y);const x=Math.round(y.length*3/4/1024);s(e.id,{data:{...a,imageSize:g,fileSizeKB:x,image:y}})},m.readAsDataURL(u)}},[e.id,a,s]),d=p.useCallback(h=>{var f;h.preventDefault(),h.stopPropagation();const u=(f=h.clipboardData)==null?void 0:f.items;if(u){for(const m of u)if(m.type.startsWith("image/")){const y=m.getAsFile();if(y){Math.round(y.size/1024);const g=new FileReader;g.onload=async()=>{let x=g.result,w;{const N=await sr(x,tr);x=N.dataUrl,w=N.size}c(x);const v=Math.round(x.length*3/4/1024);s(e.id,{data:{...a,imageSize:w,fileSizeKB:v,image:x}})},g.readAsDataURL(y)}break}}},[e.id,a,s]);return t.jsx("div",{ref:o,className:"canvas-image-node w-full h-full overflow-hidden",onPaste:d,tabIndex:0,role:"button","aria-label":"Paste image area","data-test":"canvas-image-node",children:i?t.jsx("img",{src:i,alt:"Image",className:"w-full h-full object-contain pointer-events-none select-none",draggable:!1,"data-test":"image-preview"}):t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center gap-3 border-2 border-dashed rounded-lg hover:border-primary transition-colors","data-test":"image-empty-state",children:[t.jsx(ho,{className:"w-8 h-8 text-muted-foreground"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Paste image (Ctrl+V) or upload"}),t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:l,className:"hidden","data-test":"image-file-input"}),t.jsxs(se,{"data-test":"image-upload-button",variant:"outline",size:"sm",onClick:()=>{var h;return(h=n.current)==null?void 0:h.click()},children:[t.jsx(ho,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]})})},Yv=He.memo(Gv),Zd=({node:e})=>{var L;const s=T.getState().updateNode,n=T.getState().deleteNodeById,o=T.getState().setSelectedNodes,a=$(W=>W.uiState.activeGroupId)===e.id,c=$(W=>W.uiState.hoveredDropTargetGroupId)===e.id,l=e.data,d=(l==null?void 0:l.childNodeIds)??[],h=e.isCollapsed??!1,u=lw(e),[f,m]=p.useState(!1),[y,g]=p.useState(!1),[x,w]=p.useState(!1),[v,N]=p.useState(null),b=p.useCallback(W=>{W.stopPropagation(),s(e.id,{isCollapsed:!h})},[e.id,h,s]),A=p.useCallback(W=>{W.stopPropagation();const P=T.getState(),j=P.projectCanvas.getActive();if(!j)return;const B=j.coreState.nodes.filter(U=>d.includes(U.id));B.forEach(U=>{P.updateNode(U.id,{groupId:void 0})}),o(B),n(e.id)},[e.id,d,n,o]),R=p.useCallback(W=>{W.stopPropagation(),W.preventDefault();const P=T.getState(),j=P.projectCanvas.getActive();if(!j)return;const B=j.coreState.nodes.filter(U=>d.includes(U.id));B.length!==0&&(P.setSelectedNodes(B),P.arrow.setSelected([]))},[d]),k=p.useCallback(async W=>{if(W.stopPropagation(),!f){m(!0);try{const P=T.getState(),j=P.projectCanvas.getActive();if(!j)return;const M=j.coreState.nodes,B=j.coreState.arrows,U=j.coreState.selectedNodes,z=await pw(e,M,B,U);z.success?z.nodeUpdates.forEach(({nodeId:_,updates:G})=>{P.updateNode(_,G)}):console.error("Workflow execution failed:",z.error)}catch(P){console.error("Error executing workflow:",P)}finally{m(!1)}}},[e,f]),S=p.useCallback(W=>{if(W.stopPropagation(),!y){g(!0);try{const P=T.getState(),j=P.projectCanvas.getActive();if(!j)return;const B=P.getVisualWorkflowPresets().find(ie=>{var Se;return((Se=ie.sourceLocation)==null?void 0:Se.groupNodeId)===e.id});if(B){Ee.info(`Workflow "${B.name}" already saved`,{description:"This workflow group is already in presets",duration:3e3});return}const U=j.coreState.nodes,z=j.coreState.arrows,_=xr(e,U,z);if(_.length===0){Ee.warning("No workflow steps found",{description:"Add workflow step nodes to save this workflow",duration:3e3});return}const G=_.map(ie=>({id:ie.nodeId,stepType:ie.stepType,config:ie.config,label:ie.label})),F=e.title||"Untitled Workflow",{path:D}=Js(P);if(!D.projectId||!D.workspaceId||!D.canvasId)throw new Error("Could not determine canvas location for workflow preset");const V={projectId:D.projectId,workspaceId:D.workspaceId,canvasId:D.canvasId,groupNodeId:e.id},J=P.createVisualWorkflowPreset(F,G,V);Ee.success(`Workflow saved: ${F}`,{description:`${G.length} step${G.length!==1?"s":""} saved to presets`,duration:3e3}),console.log(`Workflow saved as preset: ${F} (${J})`)}catch(P){console.error("Error saving workflow:",P),Ee.error("Failed to save workflow",{description:P instanceof Error?P.message:"Unknown error",duration:4e3})}finally{g(!1)}}},[e,y]),E=p.useCallback(W=>{W.stopPropagation();const j=T.getState().projectCanvas.getActive();if(!j)return;const M=j.coreState.nodes,B=j.coreState.arrows,z=xr(e,M,B).map(G=>({id:G.nodeId,stepType:G.stepType,config:G.config,label:G.label})),_={name:e.title||"Untitled Workflow",groupNodeId:e.id,stepCount:z.length,stepTypes:[...new Set(z.map(G=>G.stepType))],steps:z};N(_),w(!0)},[e]),C=(L=l==null?void 0:l.styles)==null?void 0:L.backgroundColor,I=!C,O={};C&&(O.backgroundColor=`color-mix(in srgb, ${C} 20%, transparent)`),!a&&!c&&(O.border="1px solid hsl(var(--muted-foreground) / 0.3)"),c&&(O.border="2px dashed hsl(var(--primary))",O.boxShadow="0 0 0 4px hsl(var(--primary) / 0.2)");const H=C?`color-mix(in srgb, ${C} 60%, transparent)`:void 0;return t.jsxs("div",{className:Me("w-full h-full rounded-lg","flex flex-col","pointer-events-none",I&&"bg-background",a&&"ring-2 ring-dashed ring-primary/50"),style:O,"data-test":"group-node-content",children:[t.jsxs("div",{className:Me("flex items-center gap-1 px-2 py-1","border-b border-border/50","select-none",!a&&"pointer-events-auto",!H&&"bg-muted/70"),style:H?{backgroundColor:H}:void 0,"data-test":"group-header",children:[t.jsx("button",{className:"p-0.5 rounded hover:bg-muted transition-colors",onPointerDown:W=>{W.stopPropagation()},onClick:b,title:h?"Expand group":"Collapse group","data-test":"group-collapse-toggle",children:h?t.jsx(ss,{className:"h-4 w-4 text-muted-foreground"}):t.jsx(Pt,{className:"h-4 w-4 text-muted-foreground"})}),t.jsx("span",{className:"flex-1 text-sm font-medium text-foreground truncate",title:e.title||"Group","data-test":"group-name",children:e.title||"Group"}),u&&t.jsxs("div",{className:"flex items-center gap-0.5 border-r border-border/50 pr-1 mr-1","data-test":"group-workflow-actions",children:[t.jsx("button",{className:Me("p-0.5 rounded transition-colors",f?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:W=>W.stopPropagation(),onClick:k,disabled:f,title:f?"Executing workflow...":"Execute workflow","data-test":"group-execute-workflow-button",children:t.jsx(ft,{className:Me("h-4 w-4",f?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:Me("p-0.5 rounded transition-colors",y?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:W=>W.stopPropagation(),onClick:S,disabled:y,title:y?"Saving workflow...":"Save workflow to presets","data-test":"group-save-workflow-button",children:t.jsx(hs,{className:Me("h-4 w-4",y?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:W=>W.stopPropagation(),onClick:E,title:"View workflow JSON","data-test":"group-json-viewer-button",children:t.jsx(Ia,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})]}),t.jsxs("div",{className:"flex items-center gap-0.5","data-test":"group-node-actions",children:[t.jsx("span",{className:"text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded",title:`${d.length} nodes in group`,"data-test":"group-child-count",children:d.length}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:R,title:"Select all nodes in group","data-test":"group-select-all-button",children:t.jsx(Hr,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:W=>{W.stopPropagation()},onClick:A,title:"Ungroup","data-test":"group-ungroup-button",children:t.jsx(Fr,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]})]}),!h&&t.jsx("div",{className:"flex-1 min-h-[20px] pointer-events-none","data-test":"group-body"}),a&&t.jsxs("div",{className:"flex items-center justify-center gap-1 px-2 py-1 border-t border-primary/30 bg-primary/5","data-test":"group-edit-mode-footer",children:[t.jsx(Fs,{className:"h-3 w-3 text-primary"}),t.jsx("span",{className:"text-xs text-primary font-medium",children:"Editing - click outside to exit"})]}),t.jsx(et,{isVisible:x,onClose:()=>w(!1),title:`Workflow: ${e.title||"Untitled"}`,initialSize:{width:1200,height:1e3},triggerPosition:{x:(typeof window<"u"?window.innerWidth:1920)/2-600,y:(typeof window<"u"?window.innerHeight:1080)/2-500},resizable:!0,"data-test":"workflow-json-viewer-popover",children:v&&t.jsx("div",{className:"h-full overflow-auto","data-test":"workflow-json-content",children:t.jsx(Jl,{data:v,onDataChange:()=>{}})})})]})};Zd.displayName="GroupNodeV2";function Yn(e){if(navigator.clipboard){navigator.clipboard.writeText(e).catch(()=>{vc(e)});return}vc(e)}function vc(e){const s=document.createElement("textarea");s.value=e,s.style.position="fixed",s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)",s.style.width="1px",s.style.height="1px",s.style.padding="0",s.style.border="none",s.style.outline="none",s.style.boxShadow="none",s.style.background="transparent",s.setAttribute("readonly",""),document.body.appendChild(s);const n=document.createRange();n.selectNodeContents(s);const o=window.getSelection();o&&(o.removeAllRanges(),o.addRange(n)),s.setSelectionRange(0,e.length),document.execCommand("copy"),document.body.removeChild(s)}function Xn(e,s){if(!e)return;const n=document.createElement("div");n.style.position="fixed",n.style.inset="0",n.style.backgroundColor="rgba(0, 0, 0, 0.5)",n.style.zIndex="9999",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.padding="20px";const o=document.createElement("div");o.style.position="relative",o.style.width="90%",o.style.maxWidth="600px",o.style.backgroundColor="hsl(var(--popover))",o.style.color="hsl(var(--popover-foreground))",o.style.borderRadius="8px",o.style.padding="16px",o.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)";const r=document.createElement("textarea");r.value=e,r.style.width="100%",r.style.minHeight="200px",r.style.padding="12px",r.style.fontSize="14px",r.style.fontFamily="inherit",r.style.border="1px solid hsl(var(--border))",r.style.borderRadius="4px",r.style.marginBottom="12px",r.style.backgroundColor="hsl(var(--muted))",r.style.color="hsl(var(--foreground))",r.readOnly=!0;const a=document.createElement("button");a.textContent="Copy Text",a.style.width="100%",a.style.padding="12px",a.style.fontSize="16px",a.style.fontWeight="600",a.style.backgroundColor="hsl(var(--primary))",a.style.color="hsl(var(--primary-foreground))",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer",a.style.marginBottom="8px";const i=document.createElement("button");i.textContent="Close",i.style.width="100%",i.style.padding="12px",i.style.fontSize="16px",i.style.backgroundColor="hsl(var(--secondary))",i.style.color="hsl(var(--secondary-foreground))",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",o.appendChild(r),o.appendChild(a),o.appendChild(i),n.appendChild(o),document.body.appendChild(n);const c=()=>{document.body.removeChild(n),s==null||s()};a.addEventListener("click",()=>{r.focus(),r.select(),r.setSelectionRange(0,r.value.length);try{const l=document.execCommand("copy");r.setSelectionRange(0,0),r.blur(),l?(c(),Ee.success("Copied to clipboard!")):Ee.error("Copy failed. Please long-press the text to copy manually.")}catch{r.setSelectionRange(0,0),r.blur(),Ee.error("Please long-press the text to copy manually.")}}),i.addEventListener("click",c),n.addEventListener("click",l=>{l.target===n&&c()})}const Xv={paragraph:/\n\n+/,line:/\n/,comma:/,/,period:/\./,whitespace:/\s+/};function Kv(e,s){if(!e)return[];const n=Xv[s];return e.split(n).map(o=>o.trim()).filter(Boolean)}const Jd=600,qv=`messageLift ${Jd}ms ease-in-out forwards`,Zv=`contextMenuExpand ${Jd}ms ease-in-out forwards`,rs=8,Jv=192,Qv=300,eb=({isOpen:e,onClose:s,position:n,children:o,"data-test":r,anchorBottomRight:a=!1,onMenuHeightMeasured:i,alignRightEdge:c,alignLeftEdge:l,overrideTopPosition:d,expandDownward:h=!0,ignoreClickRefs:u=[]})=>{const f=p.useRef(null),m=nb(n,f,e,a,i,c,l,d),[y,g]=p.useState(!1);if(p.useEffect(()=>{if(!e){g(!1);return}let v=null;const N=()=>{v=setTimeout(()=>g(!0),150)};return document.addEventListener("pointerup",N,{once:!0}),()=>{document.removeEventListener("pointerup",N),v&&clearTimeout(v)}},[e]),p.useEffect(()=>{if(!e)return;const v=N=>{N.key==="Escape"&&(N.stopPropagation(),s())};return document.addEventListener("keydown",v,!0),()=>document.removeEventListener("keydown",v,!0)},[e,s]),p.useEffect(()=>{if(!e)return;const v=b=>{const A=b.target;if(!(f.current&&f.current.contains(A))){for(const R of u)if(R.current&&R.current.contains(A))return;s()}},N=setTimeout(()=>{document.addEventListener("pointerdown",v,!0)},0);return()=>{clearTimeout(N),document.removeEventListener("pointerdown",v,!0)}},[e,s,u]),!e)return null;const x=m!==null,w=h?"top center":"bottom center";return Cs.createPortal(t.jsx("div",{ref:f,role:"menu",className:Ie("w-48 rounded-md border bg-popover p-1 text-popover-foreground shadow-md",x&&"animate-in fade-in-0"),style:{position:"fixed",left:x?m.x:-9999,top:x?m.y:-9999,zIndex:We.contextMenu,visibility:x?"visible":"hidden",pointerEvents:y?"auto":"none",transformOrigin:w,animation:x?Zv:"none"},"data-test":r,children:Kr(o,s)}),document.body)},is=({onClick:e,children:s,className:n,disabled:o=!1,"data-test":r,preventClose:a=!1,onClose:i})=>t.jsx("button",{role:"menuitem",disabled:o,onClick:()=>{o||(e(),a||i==null||i())},className:Ie("relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none","hover:bg-accent hover:text-accent-foreground","focus:bg-accent focus:text-accent-foreground",o&&"pointer-events-none opacity-50",n),"data-test":r,children:s}),tb=()=>t.jsx("div",{className:"-mx-1 my-1 h-px bg-muted","data-test":"context-menu-separator"}),sb=({trigger:e,children:s,"data-test":n,onClose:o})=>{const[r,a]=p.useState(!1);return t.jsxs("div",{className:"relative","data-test":n,children:[t.jsx("button",{role:"menuitem",onClick:()=>a(!r),className:"relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground",children:e}),r&&t.jsx("div",{className:"ml-2 border-l border-muted pl-1",children:Kr(s,o)})]})},bc=({onClick:e,children:s,subItems:n,className:o,disabled:r=!1,"data-test":a,onClose:i})=>{const[c,l]=p.useState(!1),d=p.useRef(null),[h,u]=p.useState(0);return p.useEffect(()=>{c&&d.current&&u(d.current.scrollHeight)},[c]),t.jsxs("div",{className:"relative","data-test":a,children:[t.jsxs("div",{className:Ie("flex items-center w-full",r&&"pointer-events-none opacity-50"),children:[t.jsx("button",{role:"menuitem",disabled:r,onClick:()=>{r||(e(),i==null||i())},className:Ie("flex-[4] flex cursor-default select-none items-center rounded-sm rounded-r-none px-2 py-1.5 text-sm outline-none","hover:bg-accent hover:text-accent-foreground","focus:bg-accent focus:text-accent-foreground",o),"data-test":a?`${a}-action`:void 0,children:s}),t.jsx("div",{className:"w-1"}),t.jsx("button",{role:"menuitem",disabled:r,onClick:()=>l(!c),className:Ie("flex-[1] flex cursor-default select-none items-center justify-center rounded-sm rounded-l-none px-1 py-1.5 text-sm outline-none"),style:{backgroundColor:c?"hsl(var(--accent))":"transparent",color:c?"hsl(var(--accent-foreground))":"inherit",transition:"background-color 300ms ease, color 300ms ease"},"data-test":a?`${a}-expand`:void 0,children:t.jsx(ss,{className:"h-4 w-4",style:{transition:"transform 400ms ease",transform:c?"rotate(90deg)":"rotate(0deg)"}})})]}),t.jsx("div",{style:{maxHeight:c?h:0,transition:"max-height 400ms ease",overflow:"hidden"},children:t.jsx("div",{ref:d,className:"ml-2 border-l border-muted pl-1",children:Kr(n,i)})})]})};function Kr(e,s){return s?p.Children.map(e,n=>p.isValidElement(n)&&typeof n.type!="string"?p.cloneElement(n,{onClose:s}):n):e}function nb(e,s,n,o=!1,r,a,i,c){const[l,d]=p.useState(null);return p.useEffect(()=>{if(!n){d(null);return}const h=requestAnimationFrame(()=>{var g,x;const u=window.innerWidth,f=window.innerHeight,m=((g=s.current)==null?void 0:g.offsetWidth)??Jv,y=((x=s.current)==null?void 0:x.offsetHeight)??Qv;if(r==null||r(y),o){let w;i!==void 0?w=i:a!==void 0?w=a-m:w=u-m-rs;const v=c!==void 0?c:f-y-rs;d({x:Math.max(rs,Math.min(w,u-m-rs)),y:Math.max(rs,v)})}else d({x:Math.max(rs,Math.min(e.x,u-m-rs)),y:Math.max(rs,Math.min(e.y,f-y-rs))})});return()=>cancelAnimationFrame(h)},[n,e.x,e.y,o,r,a,i,c]),l}function ob({node:e,onCopy:s,onCopyWithNewLines:n,onCopyNumbered:o,onCopyList:r,onDelete:a,onSplitByParagraph:i,onSplitByLine:c,onSelect:l,onAddNotes:d,onEdit:h,onEditUndo:u,hasEditHistory:f,onClose:m}){return t.jsxs(t.Fragment,{children:[t.jsxs(bc,{onClick:s,onClose:m,"data-test":"chat-message-copy-item",subItems:t.jsxs(t.Fragment,{children:[t.jsxs(is,{onClick:n,onClose:m,"data-test":"chat-message-copy-newlines",children:[t.jsx(Yl,{className:"mr-2 h-4 w-4"}),"With new lines"]}),t.jsxs(is,{onClick:o,onClose:m,"data-test":"chat-message-copy-numbered",children:[t.jsx(Bs,{className:"mr-2 h-4 w-4"}),"Numbered"]}),t.jsxs(is,{onClick:r,onClose:m,"data-test":"chat-message-copy-list",children:[t.jsx(fo,{className:"mr-2 h-4 w-4"}),"List"]})]}),children:[t.jsx(Bt,{className:"mr-2 h-4 w-4"}),"Copy"]}),t.jsxs(bc,{onClick:h,onClose:m,"data-test":"chat-message-edit-item",subItems:t.jsxs(is,{onClick:u,onClose:m,disabled:!f,"data-test":"chat-message-edit-undo",children:[t.jsx(ba,{className:"mr-2 h-4 w-4"}),"Undo last edit"]}),children:[t.jsx(Fs,{className:"mr-2 h-4 w-4"}),"Edit"]}),t.jsxs(sb,{"data-test":"chat-message-split-container",onClose:m,trigger:t.jsxs(t.Fragment,{children:[t.jsx(mp,{className:"mr-2 h-4 w-4"}),"Split message",t.jsx(ss,{className:"ml-auto h-4 w-4"})]}),children:[t.jsxs(is,{onClick:i,onClose:m,"data-test":"chat-message-split-paragraph",children:[t.jsx(El,{className:"mr-2 h-4 w-4"}),"By paragraph"]}),t.jsxs(is,{onClick:c,onClose:m,"data-test":"chat-message-split-line",children:[t.jsx(Na,{className:"mr-2 h-4 w-4"}),"By line"]})]}),t.jsxs(is,{onClick:l,onClose:m,"data-test":"chat-message-select-item",children:[t.jsx(Jo,{className:"mr-2 h-4 w-4"}),"Select"]}),t.jsxs(is,{onClick:d,onClose:m,"data-test":"chat-message-add-notes-item",children:[t.jsx(xp,{className:"mr-2 h-4 w-4"}),"Add notes"]}),t.jsx(tb,{}),t.jsxs(is,{onClick:a,onClose:m,className:"text-destructive focus:text-destructive","data-test":"chat-message-delete-item",children:[t.jsx(Nt,{className:"mr-2 h-4 w-4"}),"Delete"]})]})}const ab=({content:e,className:s,style:n})=>t.jsx("div",{className:s,style:{whiteSpace:"pre-wrap",wordBreak:"break-word",...n},"data-test":"chat-message-content",children:e});var Yt=(e=>(e.DEFAULT="default",e.CLAUDE="claude",e))(Yt||{});const rb={default:"",claude:"Claude"},ib="adding note...",Ys=new Map,cb=20,Nr={push(e,s){const n=Ys.get(e)??[];n.push({previousContent:s,timestamp:Date.now()}),n.length>cb&&n.shift(),Ys.set(e,n)},pop(e){const s=Ys.get(e);if(!(s!=null&&s.length))return null;const n=s.pop();return s.length===0&&Ys.delete(e),n.previousContent},hasHistory(e){var s;return(((s=Ys.get(e))==null?void 0:s.length)??0)>0},clear(e){Ys.delete(e)}},lb=500,Nc=150,db=10,ub=8;let Sr=!1,Qd=0;const hb=({node:e,chatNodeId:s,children:n,className:o,style:r,isSelectMode:a=!1,isSelected:i=!1,onToggleSelect:c,onEnterSelectMode:l,isIncoming:d=!1,contentFontSize:h,canvasScale:u=1})=>{const f=ps(),m=typeof window<"u"&&window.location.protocol==="http:",[y,g]=p.useState(0),[x,w]=p.useState(!1),[v,N]=p.useState({x:0,y:0}),[b,A]=p.useState(!1),[R,k]=p.useState(0),[S,E]=p.useState(void 0),[C,I]=p.useState(null),[O,H]=p.useState(0),[L,W]=p.useState(null),P=p.useRef(null),j=p.useRef(null),M=p.useRef(null),B=p.useRef(null),U=p.useRef(null),z=p.useRef(null),_=p.useRef(null),G=p.useRef(!1);p.useEffect(()=>()=>{j.current&&cancelAnimationFrame(j.current),M.current&&clearTimeout(M.current)},[]);const F=p.useCallback(()=>{P.current=null,G.current=!1,z.current=null,j.current&&(cancelAnimationFrame(j.current),j.current=null),M.current&&(clearTimeout(M.current),M.current=null),g(0),A(!1)},[]),D=(pe,Ne=0,Te=0,Re=0)=>{const De=pe.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);if(!De)return pe;const $e=parseInt(De[1]),Ue=parseInt(De[2]),_e=parseInt(De[3]),Be=De[4]?parseFloat(De[4]):1,Ze=Math.round($e*Be+Ne*(1-Be)),Le=Math.round(Ue*Be+Te*(1-Be)),mt=Math.round(_e*Be+Re*(1-Be));return`rgb(${Ze}, ${Le}, ${mt})`},V=pe=>{let Ne=pe;for(;Ne;){const Te=window.getComputedStyle(Ne).backgroundColor,Re=Te.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);if(Re&&(Re[4]?parseFloat(Re[4]):1)>0)return Te;Ne=Ne.parentElement}return"rgb(24, 24, 27)"},J=p.useCallback(()=>{if(_.current){if(B.current&&f){const pe=window.getComputedStyle(B.current),Te=V(B.current.parentElement).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/),Re=Te?parseInt(Te[1]):24,De=Te?parseInt(Te[2]):24,$e=Te?parseInt(Te[3]):27,Ue=D(pe.backgroundColor,Re,De,$e),_e=B.current.querySelector('textarea, [class*="markdown"]'),Be=_e?window.getComputedStyle(_e):null,Ze=(Be==null?void 0:Be.fontSize)??pe.fontSize,Le=(Be==null?void 0:Be.lineHeight)??pe.lineHeight,mt=B.current.getBoundingClientRect(),Gt=parseFloat(pe.height),gs=Gt>0?mt.height/Gt:u;W({backgroundColor:Ue,color:pe.color,fontSize:Ze,lineHeight:Le,padding:pe.padding,width:pe.width,height:pe.height,scale:gs}),I(mt)}Sr=!0,Qd=Date.now(),N(_.current),w(!0),H(pe=>(pe+1)%5),F()}},[f,u,d,h,r==null?void 0:r.padding,F]),ie=p.useCallback(pe=>{if(!B.current||!f)return;const Ne=B.current.getBoundingClientRect(),Te=window.innerHeight,Re=Te-pe-ub,De=6;I(Ne);const $e=Ne.bottom>Re-De;if(Us.info("Menu","scenario_detection",{scenario:$e?1:2,messageBottom:Ne.bottom,defaultMenuTop:Re,gap:De,threshold:Re-De,viewportHeight:Te,menuHeight:pe},"menu-pos"),$e){const Ue=Re-De,_e=Ne.bottom-Ue;Us.info("Menu","scenario1_lift",{targetMessageBottom:Ue,liftAmount:_e,liftOffset:-_e},"menu-pos"),requestAnimationFrame(()=>{k(-_e),E(void 0)}),setTimeout(()=>{const Be=document.querySelector('[data-test="chat-message-lifted-clone"]'),Ze=document.querySelector('[data-test="chat-message-context-menu"]');if(Be&&Ze){const Le=Be.getBoundingClientRect(),mt=Ze.getBoundingClientRect();Us.info("Menu","scenario1_after_500ms",{cloneBottom:Le.bottom,menuTop:mt.top,actualGap:mt.top-Le.bottom,expectedGap:De,cloneRect:{top:Le.top,bottom:Le.bottom,height:Le.height},menuRect:{top:mt.top,bottom:mt.bottom,height:mt.height}},"menu-pos")}},500)}else{const Ue=Ne.bottom+De;Us.info("Menu","scenario2_menu_move",{menuTopPosition:Ue,messageBottom:Ne.bottom},"menu-pos"),requestAnimationFrame(()=>{k(0),E(Ue)}),setTimeout(()=>{const _e=document.querySelector('[data-test="chat-message-lifted-clone"]'),Be=document.querySelector('[data-test="chat-message-context-menu"]');if(_e&&Be){const Ze=_e.getBoundingClientRect(),Le=Be.getBoundingClientRect();Us.info("Menu","scenario2_after_500ms",{cloneBottom:Ze.bottom,menuTop:Le.top,actualGap:Le.top-Ze.bottom,expectedGap:De,cloneRect:{top:Ze.top,bottom:Ze.bottom,height:Ze.height},menuRect:{top:Le.top,bottom:Le.bottom,height:Le.height}},"menu-pos")}},500)}},[f]),Se=p.useCallback(()=>{Sr=!1,w(!1),k(0),I(null),W(null),E(void 0)},[]),me=p.useCallback(()=>{P.current=Date.now(),G.current=!0,M.current=setTimeout(()=>{G.current&&A(!0)},Nc);const pe=()=>{if(!P.current||!G.current)return;const Ne=Date.now()-P.current,Te=Math.max(0,Ne-Nc),Re=Math.min(Te/lb,1);g(Re),Re<1?j.current=requestAnimationFrame(pe):J()};j.current=requestAnimationFrame(pe)},[J]),Z=p.useCallback(pe=>{if(pe.stopPropagation(),B.current){const Te=window.getComputedStyle(B.current),Re=B.current.getBoundingClientRect(),De=B.current.querySelector('textarea, [class*="markdown"]'),$e=De?window.getComputedStyle(De):null,Ue=Re.height/parseFloat(Te.height);Us.info("Clone","1_tap_original_styles",{wrapper:{fontSize:Te.fontSize,lineHeight:Te.lineHeight,padding:Te.padding,width:Te.width,height:Te.height},textEl:$e?{fontSize:$e.fontSize,lineHeight:$e.lineHeight}:null,rect:{width:Re.width,height:Re.height},calculatedScale:Ue,canvasScaleProp:u},"clone")}const Ne={x:pe.clientX,y:pe.clientY};z.current=Ne,_.current=Ne,me()},[me]),ge=p.useCallback(pe=>{if(!G.current||!z.current)return;const Ne=pe.clientX-z.current.x,Te=pe.clientY-z.current.y;Math.sqrt(Ne*Ne+Te*Te)>db?F():_.current={x:pe.clientX,y:pe.clientY}},[F]),we=p.useCallback(()=>{F()},[F]),te=p.useCallback(()=>{F()},[F]),X=p.useCallback(()=>{F()},[F]),K=p.useCallback(()=>typeof e.content=="string"?e.content:"",[e.content]),ne=p.useCallback(pe=>{f&&m?Xn(pe,Se):Yn(pe)},[f,m,Se]),ce=p.useCallback(()=>{ne(K())},[K,ne]),de=p.useCallback(()=>{const pe=K().split(`
`).filter(Ne=>Ne.trim());ne(pe.join(`

`))},[K,ne]),q=p.useCallback(()=>{const pe=K().split(`
`).filter(Ne=>Ne.trim());ne(pe.map((Ne,Te)=>`${Te+1}. ${Ne}`).join(`
`))},[K,ne]),he=p.useCallback(()=>{const pe=K().split(`
`).filter(Ne=>Ne.trim());ne(pe.map(Ne=>`- ${Ne}`).join(`
`))},[K,ne]),be=p.useCallback(()=>{const pe=T.getState(),Ne=pe.getNodeById(s);if(Ne!=null&&Ne.data){const Te=Ne.data,Re=(Te.childNodeIds??[]).filter(De=>De!==e.id);pe.updateNode(s,{data:{...Te,childNodeIds:Re}})}pe.deleteNodeById(e.id)},[e.id,s]),ue=p.useCallback(pe=>{const Ne=typeof e.content=="string"?e.content:"",Te=Kv(Ne,pe);if(Te.length<=1)return;const Re=T.getState(),De=Re.getNodeById(s);if(!(De!=null&&De.data))return;const $e=De.data,Ue=$e.childNodeIds??[],_e=Ue.indexOf(e.id);if(_e===-1)return;const Be=Te.map(Le=>Ye.buildTextNodeV2({content:Le,x:e.x,y:e.y}));Be.forEach(Le=>Re.addNode(Le));const Ze=[...Ue.slice(0,_e),...Be.map(Le=>Le.id),...Ue.slice(_e+1)];Re.updateNode(s,{data:{...$e,childNodeIds:Ze}}),Re.deleteNodeById(e.id)},[e,s]),le=p.useCallback(()=>{ue("paragraph")},[ue]),ye=p.useCallback(()=>{ue("line")},[ue]),xe=p.useCallback(()=>{l==null||l()},[l]),je=p.useCallback(()=>{const pe=T.getState(),Ne=pe.getNodeById(s);if(!(Ne!=null&&Ne.data))return;const Te=Ne.data;pe.updateNode(s,{data:{...Te,editingNodeId:e.id}}),pe.setActiveChatNodeId(s,!0);const Re=document.querySelector('[data-test="canvas-chat-input-textarea-container"] textarea');if(Re){const De=typeof e.content=="string"?e.content:"";window.dispatchEvent(new CustomEvent("chat-edit-prefill",{detail:{content:De,nodeId:e.id}})),Re.focus()}},[s,e.id,e.content]),Oe=p.useCallback(()=>{const pe=Nr.pop(e.id);pe!==null&&T.getState().updateNode(e.id,{content:pe})},[e.id]),oe=Nr.hasHistory(e.id),ae=p.useCallback(()=>{const pe=T.getState(),Ne=pe.getNodeById(s);if(!(Ne!=null&&Ne.data))return;const Te=Ne.data,Re=Te.childNodeIds??[],De=Re.indexOf(e.id);if(De===-1)return;const $e=Ye.buildTextNodeV2({content:ib,x:Ne.x,y:Ne.y,data:{isIncoming:!0,isTemp:!0,replyToNodeId:e.id}});pe.addNode($e,void 0,{dontSelect:!0});const Ue=[...Re.slice(0,De+1),$e.id,...Re.slice(De+1)];pe.updateNode(s,{data:{...Te,childNodeIds:Ue,pendingNoteNodeId:$e.id}}),pe.setActiveChatNodeId(s,!0);const _e=document.querySelector('[data-test="canvas-chat-input-textarea-container"] textarea');_e==null||_e.focus()},[s,e.id]),Y=(pe=>1-Math.pow(1-pe,2))(y);C&&C.top+R;const re=(C==null?void 0:C.left)??0,ve=(()=>{if(!C||!L)return;const Ne=L.scale+.1,De=(parseFloat(L.width)+-40)*Ne;return re+De})(),Ae=x&&f&&Cs.createPortal(t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 backdrop-blur-sm bg-black/20 transition-opacity duration-200",style:{zIndex:99},onClick:Se,"data-test":"chat-message-blur-backdrop"}),C&&L&&(()=>{const Te=L.scale+.1,Re=parseFloat(L.width),De=parseFloat(L.height),$e=-Re*.12,Ue=-10,_e=Re+$e,Be=De+Ue,Ze=R/Te;return t.jsx("div",{ref:U,className:"fixed shadow-lg rounded-lg",style:{top:`${C.top}px`,left:`${re}px`,width:`${_e}px`,height:`${Be}px`,padding:L.padding,backgroundColor:L.backgroundColor,color:L.color,"--lift-scale":Te,"--lift-offset":`${Ze}px`,transformOrigin:"top left",animation:qv,zIndex:100},"data-test":"chat-message-lifted-clone",onPointerDown:Le=>Le.stopPropagation(),onPointerUp:Le=>Le.stopPropagation(),onPointerMove:Le=>Le.stopPropagation(),onClick:Le=>Le.stopPropagation(),onTouchStart:Le=>Le.stopPropagation(),onTouchEnd:Le=>Le.stopPropagation(),onTouchMove:Le=>Le.stopPropagation(),children:t.jsx(ab,{content:typeof e.content=="string"?e.content:"",style:{fontSize:L.fontSize,lineHeight:L.lineHeight}})})})()]}),document.body);return t.jsxs(t.Fragment,{children:[Ae,t.jsxs("div",{ref:B,className:Me(o,"relative",x&&f&&C&&"invisible"),style:r,onPointerDown:a?void 0:Z,onPointerMove:a?void 0:ge,onPointerUp:a?void 0:we,onPointerLeave:a?void 0:te,onPointerCancel:a?void 0:X,onContextMenu:pe=>pe.preventDefault(),"data-test":"chat-message",children:[a&&t.jsx("div",{className:"absolute inset-0 z-10","data-test":"chat-message-select-overlay"}),n,b&&Y>0&&(()=>{const pe=d?"hsl(var(--background))":"hsl(var(--primary))";return t.jsx("div",{className:"absolute inset-0 pointer-events-none rounded-lg",style:{background:`
                  conic-gradient(
                    from 270deg at 50% 50%,
                    transparent 0deg,
                    transparent ${90-Y*90}deg,
                    ${pe} ${90-Y*90}deg,
                    ${pe} 90deg,
                    transparent 90deg
                  ),
                  conic-gradient(
                    from 180deg at 50% 50%,
                    ${pe} 0deg,
                    ${pe} ${Y*90}deg,
                    transparent ${Y*90}deg
                  ),
                  conic-gradient(
                    from 0deg at 50% 50%,
                    ${pe} 0deg,
                    ${pe} ${Y*90}deg,
                    transparent ${Y*90}deg
                  ),
                  conic-gradient(
                    from 90deg at 50% 50%,
                    transparent 0deg,
                    transparent ${90-Y*90}deg,
                    ${pe} ${90-Y*90}deg,
                    ${pe} 90deg,
                    transparent 90deg
                  )
                `,mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",WebkitMaskComposite:"xor",padding:"2px"}})})()]}),t.jsx(eb,{isOpen:x,onClose:Se,position:v,anchorBottomRight:f,onMenuHeightMeasured:ie,alignRightEdge:f&&!d&&ve?ve:void 0,alignLeftEdge:f&&d&&C?C.left:void 0,overrideTopPosition:S,expandDownward:S!==void 0,ignoreClickRefs:[U],"data-test":"chat-message-context-menu",children:t.jsx(ob,{node:e,onCopy:ce,onCopyWithNewLines:de,onCopyNumbered:q,onCopyList:he,onDelete:be,onSplitByParagraph:le,onSplitByLine:ye,onSelect:xe,onAddNotes:ae,onEdit:je,onEditUndo:Oe,hasEditHistory:oe})})]})};let Xs=null;const Cr=({node:e})=>{const s=p.useRef(null),n=p.useRef(null),o=p.useRef(0),r=ps(),a=p.useRef(0),i=p.useRef(null),c=p.useRef(null),l=500,d=10,h=p.useCallback((Y,re)=>{var Ae;const ve=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,clientX:Y,clientY:re});(Ae=n.current)==null||Ae.dispatchEvent(ve)},[]),u=$(Y=>{var re;return((re=Y.projectCanvas.getActive())==null?void 0:re.viewState.scale)??1}),f=$(Y=>{var re;return((re=Y.projectCanvas.getActive())==null?void 0:re.coreState.nodes)??[]}),y=$(Y=>Y.uiState.activeChatNodeId)===e.id,g=$(Y=>Y.uiState.chatNodeHoldToDrag);(g==null?void 0:g.nodeId)===e.id&&(g==null||g.isHolding),(g==null?void 0:g.nodeId)===e.id&&(g==null||g.isReady);const x=e.data,w=(x==null?void 0:x.childNodeIds)??[],v=(x==null?void 0:x.viewMode)??"chat",N=p.useRef(null),b=p.useRef(null),A=p.useRef(v),R=p.useRef(Date.now()+Q.claudeChat.alignScrollDuration+100),[k,S]=p.useState(!1),[E,C]=p.useState(!1),[I,O]=p.useState(!1),[H,L]=p.useState(!1),[W,P]=p.useState(!1),[j,M]=p.useState(new Set),[B,U]=p.useState(!1),z=p.useRef(null),_=p.useRef(null),G=p.useRef(null);p.useEffect(()=>{v==="chat"&&A.current!=="chat"&&(R.current=Date.now()+Q.claudeChat.alignScrollDuration+100),A.current=v},[v]),p.useEffect(()=>{v==="chat"&&(N.current===null&&(N.current=u),b.current===null&&(b.current={x:e.x,y:e.y}))},[v,u,e.x,e.y]),p.useEffect(()=>{if(v!=="chat")return;if(Date.now()<R.current){N.current=u,b.current={x:e.x,y:e.y};return}const Y=N.current!==null&&Math.abs(u-N.current)>.01,re=b.current!==null&&(Math.abs(e.x-b.current.x)>1||Math.abs(e.y-b.current.y)>1);(Y||re)&&(T.getState().updateNode(e.id,{data:{...x,viewMode:"canvas"}}),N.current=null,b.current=null)},[v,u,e.x,e.y,e.id,x]);const F=p.useMemo(()=>w.map(Y=>f.find(re=>re.id===Y)).filter(Y=>Y!==void 0),[w,f]),D=p.useMemo(()=>{const Y=(e.width??400)-32,re=Y*.85,ve=Q.chatNode.messagePadding,Ae={};for(const pe of F){const Ne=typeof pe.content=="string"?pe.content:"",Te=pe.width&&pe.width!==100?pe.width:Math.min(re,Y),Re=Uu(Ne,Te,pe);Ae[pe.id]=Re+ve*2}return Ae},[F,e.width]);p.useEffect(()=>{const Y=F.length;if(Y>o.current&&s.current){const re=s.current;requestAnimationFrame(()=>{re.scrollTop=re.scrollHeight})}o.current=Y},[F.length]),p.useEffect(()=>{const Y=s.current;if(!Y)return;const re=ve=>{ve.stopPropagation()};return Y.addEventListener("wheel",re,{capture:!0}),()=>Y.removeEventListener("wheel",re,{capture:!0})},[]);const V=r&&v==="chat";p.useEffect(()=>{!r||v!=="chat"||n.current},[r,v,e.id,e.width,e.height]),p.useEffect(()=>{const Y=s.current;if(!Y)return;const re=()=>{const ve=Y.scrollHeight>Y.clientHeight;if(C(ve),ve){const Ae=Y.scrollTop,pe=Y.scrollHeight-Y.clientHeight,Ne=5,Te=Ae>=-Ne,Re=Ae<=-(pe-Ne);S(Re),O(!Re&&ve),L(!Te&&ve)}else S(!1),O(!1),L(!1)};return re(),Y.addEventListener("scroll",re),()=>Y.removeEventListener("scroll",re)},[F.length]);const J=p.useCallback(()=>{const Y=T.getState(),re=Ye.buildTextNodeV2({content:"",x:e.x,y:e.y});Y.addNode(re);const ve=e.data||{childNodeIds:[]};Y.updateNode(e.id,{data:{...ve,childNodeIds:[...ve.childNodeIds,re.id]}}),Y.setSelectedNodes([re]),Y.setNodeToFocusId(re.id)},[e.id,e.x,e.y,e.data]),ie=p.useCallback(()=>{T.getState().deleteNodeById(e.id)},[e.id]),Se=p.useCallback(Y=>{Y.stopPropagation(),T.getState().setActiveChatNodeId(e.id,!0);const re=document.querySelector('[data-test="canvas-chat-input-textarea-container"] textarea');re==null||re.focus()},[e.id]),me=p.useRef(0),Z=300,ge=p.useCallback(()=>{y?T.getState().setActiveChatNodeId(null,!0):T.getState().setActiveChatNodeId(e.id,!0)},[y,e.id]),we=p.useCallback(Y=>{P(!0),M(new Set([Y]))},[]),te=p.useCallback(Y=>{M(re=>{const ve=new Set(re);return ve.has(Y)?ve.delete(Y):ve.add(Y),ve})},[]),X=p.useCallback(()=>{P(!1),M(new Set)},[]),K=p.useCallback((Y,re)=>{const ve=document.elementFromPoint(Y,re);if(!ve)return null;const Ae=ve.closest("[data-message-id]");return Ae?Ae.getAttribute("data-message-id"):null},[]),ne=p.useCallback(Y=>{const re=G.current;re&&M(ve=>{if(re==="select"){if(ve.has(Y))return ve;const Ae=new Set(ve);return Ae.add(Y),Ae}else{if(!ve.has(Y))return ve;const Ae=new Set(ve);return Ae.delete(Y),Ae}})},[]),ce=p.useCallback((Y,re)=>{if(!W)return;document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",bubbles:!0})),z.current={x:Y,y:re};const ve=K(Y,re);_.current=ve,ve?G.current=j.has(ve)?"unselect":"select":G.current=null},[W,K,j]),de=p.useCallback((Y,re)=>{if(!W||!z.current)return;const ve=Y-z.current.x,Ae=re-z.current.y;if(Math.sqrt(ve*ve+Ae*Ae)>5&&U(!0),B){const Ne=K(Y,re);Ne&&ne(Ne)}},[W,B,K,ne]),q=p.useCallback(()=>{!B&&_.current&&te(_.current),z.current=null,_.current=null,G.current=null,U(!1)},[B,te]),he=p.useCallback(Y=>{Y.button===0&&ce(Y.clientX,Y.clientY)},[ce]),be=p.useCallback(Y=>{de(Y.clientX,Y.clientY)},[de]),ue=p.useCallback(Y=>{if(Y.touches.length===1){const re=Y.touches[0];ce(re.clientX,re.clientY)}},[ce]),le=p.useCallback(Y=>{if(Y.touches.length===1){const re=Y.touches[0];de(re.clientX,re.clientY),B&&Y.preventDefault()}},[de,B]),ye=p.useCallback(Y=>{Y.stopPropagation(),ge()},[ge]),xe=p.useCallback(Y=>{const re=Date.now();re-me.current<Z?(Y.stopPropagation(),ge(),me.current=0):me.current=re},[ge]),{zoomFontSize:je}=Q.chatNode,Oe=u>=je.minScale&&u<=je.maxScale,oe=Q.chatInput.mobile.nodeFontSize,ae=Oe?je.fontSize:r?parseInt(oe):16,Ce=p.useMemo(()=>({inChat:!0,containerWidth:(e.width??400)-32,chatNodeId:e.id,onSendMessage:J}),[e.id,J,e.width]);return t.jsxs("div",{ref:n,className:Me("w-full h-full","flex flex-col","bg-background","transition-all duration-200","overflow-hidden",V?"":"border border-border shadow-lg",!V&&(y?"outline outline-4 outline-primary":"outline outline-2 outline-primary/30")),style:{},onDoubleClick:ye,onTouchStart:Y=>{if(r){const re=Y.touches[0],ve=Y.target,Ae=ve.closest('[data-test="chat-message-row"]')!==null,pe=ve.closest('[role="menu"]')!==null;a.current=Date.now(),i.current={x:re.clientX,y:re.clientY},!Ae&&!pe&&(c.current=setTimeout(()=>{i.current&&h(i.current.x,i.current.y)},l))}},onTouchMove:Y=>{if(r&&i.current){const re=Y.touches[0],ve=re.clientX-i.current.x,Ae=re.clientY-i.current.y;Math.sqrt(ve*ve+Ae*Ae)>d&&(c.current&&(clearTimeout(c.current),c.current=null),i.current=null)}},onTouchEnd:Y=>{r&&c.current&&(clearTimeout(c.current),c.current=null),xe(Y)},"data-test":"chat-node-content",children:[t.jsxs("div",{className:Me("flex items-center gap-2 px-3 py-2","border-b border-border/50","bg-muted/50","select-none","flex-shrink-0"),"data-test":"chat-header",children:[t.jsx(Mr,{className:"h-5 w-5 text-muted-foreground"}),t.jsx("span",{className:"flex-1 text-base font-medium text-foreground truncate",title:e.title||"Chat","data-test":"chat-name",children:e.title||"Chat"}),t.jsx("span",{className:"text-sm text-muted-foreground bg-muted px-2 py-0.5 rounded",title:`${F.length} messages`,"data-test":"chat-message-count",children:F.length}),W&&t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"text-sm text-primary font-medium bg-primary/10 px-2 py-0.5 rounded","data-test":"chat-selected-count",children:[j.size," selected"]}),t.jsx("button",{className:"p-1.5 rounded hover:bg-muted transition-colors",onPointerDown:Y=>Y.stopPropagation(),onClick:X,title:"Exit select mode","data-test":"chat-exit-select-button",children:t.jsx(Ke,{className:"h-4 w-4 text-muted-foreground"})})]}),t.jsx("button",{className:Me("p-1.5 rounded transition-colors",y?"bg-primary/20 text-primary":"hover:bg-primary/10 text-muted-foreground hover:text-primary"),onPointerDown:Y=>Y.stopPropagation(),onClick:Y=>{Y.stopPropagation(),y?T.getState().setActiveChatNodeId(null,!0):T.getState().setActiveChatNodeId(e.id,!0)},title:y?"Active chat target":"Set as active chat target","data-test":"chat-pin-active-button",children:t.jsx(yp,{className:"h-5 w-5"})}),t.jsx("button",{className:"p-1.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:Y=>Y.stopPropagation(),onClick:Se,title:"Focus chat input","data-test":"chat-focus-input-button",children:t.jsx(wp,{className:"h-5 w-5 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-1.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:Y=>Y.stopPropagation(),onClick:ie,title:"Close chat","data-test":"chat-close-button",children:t.jsx(Ke,{className:"h-5 w-5 text-muted-foreground hover:text-destructive"})})]}),t.jsxs("div",{className:"flex-1 relative overflow-hidden",children:[I&&t.jsx("div",{className:"absolute top-0 left-0 right-0 h-8 pointer-events-none",style:{zIndex:20,background:"linear-gradient(to bottom, hsl(var(--background)) 0%, transparent 100%)"},"data-test":"chat-scroll-shadow-top"}),H&&t.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-8 pointer-events-none",style:{zIndex:20,background:"linear-gradient(to top, hsl(var(--background)) 0%, transparent 100%)"},"data-test":"chat-scroll-shadow-bottom"}),t.jsxs("div",{ref:s,className:Me("h-full overflow-y-auto overflow-x-hidden","flex flex-col-reverse items-end","pb-3",W&&"select-none"),style:{gap:`${Q.chatNode.messageGap*(r?2:1)}px`,touchAction:W?"none":"pan-y",paddingLeft:Q.chatNode.fullwidth.contentPadding,paddingRight:Q.chatNode.fullwidth.contentPadding,paddingTop:V?48:12},onPointerDown:W?he:void 0,onPointerMove:W?be:void 0,onPointerUp:W?q:void 0,onPointerLeave:W?q:void 0,onPointerCancel:W?q:void 0,onTouchStart:W?ue:void 0,onTouchMove:W?le:void 0,onTouchEnd:W?q:void 0,onTouchCancel:W?q:void 0,"data-test":"chat-scroll-container",children:[t.jsx(Sd.Provider,{value:Ce,children:F.length===0?t.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-base w-full","data-test":"chat-empty-state",children:"No messages yet. Click + to add one."}):u<Wn?(Xs===null&&(Xs=e.id),Xs===e.id&&F.length>0,[...F].reverse().map(Y=>{const re=Y.data,ve=(re==null?void 0:re.isIncoming)??!1,Ae=D[Y.id]??Y.height??30,pe=Y.width&&Y.width!==100?Y.width:((e.width??400)-32)*.85;return t.jsx("div",{className:Me("flex w-full",ve?"justify-start":"justify-end"),"data-test":"chat-message-simplified-row",children:t.jsx("div",{className:Me("rounded",ve?"bg-foreground/85 dark:bg-foreground/20":"bg-primary"),style:{width:pe,height:Ae},"data-test":"chat-message-simplified"})},Y.id)})):(Xs===null&&(Xs=e.id),Xs===e.id&&F.length>0,[...F].reverse().map(Y=>{const re={...Y,styles:{...Y.styles,fontSize:`${ae}px`}},ve=Q.chatInput.mobile.fontConfig,Ae=j.has(Y.id),pe=Y.data,Ne=(pe==null?void 0:pe.isIncoming)??!1,Te=(pe==null?void 0:pe.isTemp)??!1;return t.jsxs("div",{className:"flex items-start w-full","data-message-id":Y.id,"data-test":"chat-message-row",children:[t.jsx("div",{className:"flex-shrink-0 flex items-start justify-center pt-1",style:{width:W?32:0},"data-test":"chat-message-checkbox-column",children:W&&t.jsx("div",{className:Me("w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors",Ae?"bg-primary border-primary text-primary-foreground":"border-muted-foreground/50 hover:border-primary"),onClick:()=>te(Y.id),"data-test":"chat-message-select-checkbox",children:Ae&&t.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",children:t.jsx("polyline",{points:"20 6 9 17 4 12"})})})}),t.jsx("div",{className:Me("flex-1 flex min-w-0",Ne?"justify-start":"justify-end"),children:t.jsx(hb,{node:Y,chatNodeId:e.id,className:Me("relative rounded-lg",Ne?"bg-foreground/85 text-background dark:bg-foreground/20 dark:text-foreground":"bg-muted/60 dark:bg-muted/30",Te&&"italic opacity-60"),style:{width:"auto",minWidth:50,maxWidth:"85%",padding:`${Q.chatNode.messagePadding}px`,fontSize:ve.cssFontSize,lineHeight:ve.cssLineHeight},isSelectMode:W,isSelected:Ae,onToggleSelect:()=>te(Y.id),onEnterSelectMode:()=>we(Y.id),isIncoming:Ne,contentFontSize:`${ae}px`,canvasScale:u,children:t.jsx(jd,{node:re})})})]},Y.id)}))}),E&&F.length>0&&t.jsx("div",{className:Me("w-full text-center text-xs text-muted-foreground/60 py-2 mb-4","transition-opacity duration-200",k?"opacity-100":"opacity-0"),"data-test":"chat-at-top-indicator",children:"Beginning of conversation"})]})]})]})};Cr.displayName="ChatNodeV2";const Sc=[{type:"if",label:"If Condition",icon:"🔀",description:"Conditional logic based on field values"},{type:"toolbarAction",label:"Toolbar Action",icon:"⚡",description:"Execute canvas toolbar actions"},{type:"tagUpdate",label:"Tag Update",icon:"🏷️",description:"Add, remove, or set node tags"},{type:"loop",label:"Loop",icon:"🔄",description:"Iterate over nodes or data"},{type:"source",label:"Source",icon:"📥",description:"Define data source for workflow"}],pb=[{value:"selection.count",label:"Selection Count",description:"Number of selected nodes"},{value:"node.title",label:"Node Title",description:"Title of the node"},{value:"node.content",label:"Node Content",description:"Content of the node"},{value:"node.tags",label:"Node Tags",description:"Tags array of the node"},{value:"loop.index",label:"Loop Index",description:"Current loop iteration (1-based)"},{value:"loop.current",label:"Loop Current",description:"Current loop value"},{value:"loop.total",label:"Loop Total",description:"Total loop iterations"}],gb=[{value:"==",label:"Equals",symbol:"=="},{value:"!=",label:"Not Equals",symbol:"!="},{value:">",label:"Greater Than",symbol:">"},{value:">=",label:"Greater or Equal",symbol:">="},{value:"<",label:"Less Than",symbol:"<"},{value:"<=",label:"Less or Equal",symbol:"<="},{value:"contains",label:"Contains",symbol:"contains"},{value:"matches",label:"Matches (regex)",symbol:"matches"}],Cc=[{value:"addTags",label:"Add Tags"},{value:"removeTags",label:"Remove Tags"},{value:"setTags",label:"Set Tags"},{value:"updateTitle",label:"Update Title"},{value:"updateContent",label:"Update Content"},{value:"setStyle",label:"Set Background"},{value:"toolbarAction",label:"Run Toolbar Action"}],fb=({config:e,onChange:s})=>{const n=u=>{s({...e,condition:{...e.condition,field:u}})},o=u=>{s({...e,condition:{...e.condition,operator:u}})},r=u=>{s({...e,condition:{...e.condition,value:u}})},a=u=>{s({...e,then:{type:u,value:u==="addTags"||u==="removeTags"||u==="setTags"?[]:""}})},i=u=>{const f=e.then.type,m=f==="addTags"||f==="removeTags"||f==="setTags"?u.split(",").map(y=>y.trim()).filter(Boolean):u;s({...e,then:{...e.then,value:m}})},c=u=>{s({...e,else:{type:u,value:u==="addTags"||u==="removeTags"||u==="setTags"?[]:""}})},l=u=>{if(!e.else)return;const f=e.else.type,m=f==="addTags"||f==="removeTags"||f==="setTags"?u.split(",").map(y=>y.trim()).filter(Boolean):u;s({...e,else:{...e.else,value:m}})},d=u=>Array.isArray(u.value)?u.value.join(", "):String(u.value||""),h=u=>u==="addTags"||u==="removeTags"||u==="setTags"?"tag1, tag2":"value";return t.jsxs("div",{"data-test":"if-condition-config",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"if-condition-section",className:"space-y-1 p-1.5 bg-muted/30 rounded border border-border",children:[t.jsx("span",{"data-test":"if-condition-section-label",className:"text-[10px] font-semibold text-muted-foreground uppercase",children:"If"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(yt,{value:e.condition.field,onValueChange:u=>n(u),children:[t.jsx(wt,{"data-test":"if-condition-field-trigger",className:"h-6 text-[11px] flex-1",onClick:u=>u.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"if-condition-field-content",children:pb.map(u=>t.jsx(Qe,{value:u.value,className:"text-xs",children:u.label},u.value))})]}),t.jsxs(yt,{value:e.condition.operator,onValueChange:u=>o(u),children:[t.jsx(wt,{"data-test":"if-condition-operator-trigger",className:"h-6 text-[11px] w-16",onClick:u=>u.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"if-condition-operator-content",children:gb.map(u=>t.jsx(Qe,{value:u.value,className:"text-xs",children:u.symbol},u.value))})]}),t.jsx(ze,{"data-test":"if-condition-value-input",value:e.condition.value,onChange:u=>r(u.target.value),onClick:u=>u.stopPropagation(),placeholder:"value",className:"h-6 text-[11px] w-16"})]})]}),t.jsxs("div",{"data-test":"if-then-section",className:"space-y-1 p-1.5 bg-green-500/10 rounded border border-green-500/30",children:[t.jsx("span",{"data-test":"if-then-section-label",className:"text-[10px] font-semibold text-green-700 dark:text-green-400 uppercase",children:"Then"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(yt,{value:e.then.type,onValueChange:u=>a(u),children:[t.jsx(wt,{"data-test":"if-then-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:u=>u.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"if-then-action-type-content",children:Cc.map(u=>t.jsx(Qe,{value:u.value,className:"text-xs",children:u.label},u.value))})]}),t.jsx(ze,{"data-test":"if-then-action-value-input",value:d(e.then),onChange:u=>i(u.target.value),onClick:u=>u.stopPropagation(),placeholder:h(e.then.type),className:"h-6 text-[11px] flex-1"})]})]}),t.jsxs("div",{"data-test":"if-else-section",className:"space-y-1 p-1.5 bg-orange-500/10 rounded border border-orange-500/30",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{"data-test":"if-else-section-label",className:"text-[10px] font-semibold text-orange-700 dark:text-orange-400 uppercase",children:"Else"}),e.else&&t.jsx("button",{"data-test":"if-else-remove-button",onClick:u=>{u.stopPropagation(),s({...e,else:void 0})},className:"text-[10px] text-muted-foreground hover:text-destructive",children:"✕"})]}),e.else?t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(yt,{value:e.else.type,onValueChange:u=>c(u),children:[t.jsx(wt,{"data-test":"if-else-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:u=>u.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"if-else-action-type-content",children:Cc.map(u=>t.jsx(Qe,{value:u.value,className:"text-xs",children:u.label},u.value))})]}),t.jsx(ze,{"data-test":"if-else-action-value-input",value:d(e.else),onChange:u=>l(u.target.value),onClick:u=>u.stopPropagation(),placeholder:h(e.else.type),className:"h-6 text-[11px] flex-1"})]}):t.jsx("button",{"data-test":"if-else-add-button",onClick:u=>{u.stopPropagation(),s({...e,else:{type:"addTags",value:[]}})},className:"text-[10px] text-primary hover:underline",children:"+ Add else"})]})]})},mb=[{value:"split",label:"Split"},{value:"arrange",label:"Arrange"},{value:"align",label:"Align"},{value:"group",label:"Group"},{value:"collapse",label:"Collapse"}],jc={split:[{value:"byWhitespace",label:"By Whitespace"},{value:"byLine",label:"By Line"},{value:"byParagraph",label:"By Paragraph"},{value:"byComma",label:"By Comma"},{value:"byPeriod",label:"By Period"},{value:"byRegex",label:"By Regex"}],arrange:[{value:"horizontal:top",label:"Horizontal (Top)"},{value:"horizontal:bottom",label:"Horizontal (Bottom)"},{value:"vertical:left",label:"Vertical (Left)"},{value:"vertical:right",label:"Vertical (Right)"},{value:"grid",label:"Grid"},{value:"masonry",label:"Masonry"}],align:[{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"},{value:"top",label:"Top"},{value:"middle",label:"Middle"},{value:"bottom",label:"Bottom"}],group:[{value:"create",label:"Create Group"},{value:"ungroup",label:"Ungroup"}],collapse:[{value:"collapse",label:"Collapse"},{value:"expand",label:"Expand"}]},xb=({config:e,onChange:s})=>{var l,d,h,u;const n=f=>{var y;const m=((y=jc[f][0])==null?void 0:y.value)||"";s({facadeKey:f,actionId:m,params:{}})},o=f=>{s({...e,actionId:f})},r=(f,m)=>{s({...e,params:{...e.params,[f]:m}})},a=e.facadeKey==="split",i=e.facadeKey==="arrange",c=e.facadeKey==="arrange"&&e.actionId==="grid";return t.jsxs("div",{"data-test":"toolbar-action-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"toolbar-action-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:"Execute canvas toolbar actions on selected nodes"}),t.jsxs("div",{"data-test":"toolbar-action-category",children:[t.jsx("label",{"data-test":"toolbar-action-category-label",className:"text-xs font-medium",children:"Category"}),t.jsxs(yt,{value:e.facadeKey,onValueChange:f=>n(f),children:[t.jsx(wt,{"data-test":"toolbar-action-category-trigger",className:"h-7 text-xs mt-1",onClick:f=>f.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"toolbar-action-category-content",children:mb.map(f=>t.jsx(Qe,{value:f.value,"data-test":"toolbar-action-category-option",className:"text-xs",children:f.label},f.value))})]})]}),t.jsxs("div",{"data-test":"toolbar-action-action",children:[t.jsx("label",{"data-test":"toolbar-action-action-label",className:"text-xs font-medium",children:"Action"}),t.jsxs(yt,{value:e.actionId,onValueChange:o,children:[t.jsx(wt,{"data-test":"toolbar-action-action-trigger",className:"h-7 text-xs mt-1",onClick:f=>f.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"toolbar-action-action-content",children:jc[e.facadeKey].map(f=>t.jsx(Qe,{value:f.value,"data-test":"toolbar-action-action-option",className:"text-xs",children:f.label},f.value))})]})]}),(a||i)&&t.jsxs("div",{"data-test":"toolbar-action-options",className:"space-y-2 p-2 bg-muted/30 rounded border border-border",children:[t.jsx("label",{"data-test":"toolbar-action-options-label",className:"text-xs font-semibold",children:"Options"}),a&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{"data-test":"toolbar-action-keep-arrows",className:"flex items-center gap-2",children:[t.jsx(Xe,{"data-test":"toolbar-action-keep-arrows-checkbox",checked:((l=e.params)==null?void 0:l.keepArrows)||!1,onCheckedChange:f=>r("keepArrows",f),onClick:f=>f.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-arrows-label",className:"text-xs",children:"Keep Arrows"})]}),t.jsxs("div",{"data-test":"toolbar-action-keep-match",className:"flex items-center gap-2",children:[t.jsx(Xe,{"data-test":"toolbar-action-keep-match-checkbox",checked:((d=e.params)==null?void 0:d.keepMatch)||!1,onCheckedChange:f=>r("keepMatch",f),onClick:f=>f.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-match-label",className:"text-xs",children:"Keep Match"})]})]}),t.jsxs("div",{"data-test":"toolbar-action-gap",children:[t.jsx("label",{"data-test":"toolbar-action-gap-label",className:"text-xs text-muted-foreground",children:"Gap"}),t.jsx(ze,{"data-test":"toolbar-action-gap-input",type:"number",value:((h=e.params)==null?void 0:h.gap)||20,onChange:f=>r("gap",parseInt(f.target.value,10)),onClick:f=>f.stopPropagation(),className:"h-7 text-xs mt-1",min:0})]}),c&&t.jsxs("div",{"data-test":"toolbar-action-columns",children:[t.jsx("label",{"data-test":"toolbar-action-columns-label",className:"text-xs text-muted-foreground",children:"Columns"}),t.jsx(ze,{"data-test":"toolbar-action-columns-input",type:"number",value:((u=e.params)==null?void 0:u.columns)||3,onChange:f=>r("columns",parseInt(f.target.value,10)),onClick:f=>f.stopPropagation(),className:"h-7 text-xs mt-1",min:1})]})]})]})},kc=[{value:"add",label:"Add Tags",description:"Add tags to existing tags"},{value:"remove",label:"Remove Tags",description:"Remove specific tags"},{value:"set",label:"Set Tags",description:"Replace all tags with new ones"},{value:"clear",label:"Clear All Tags",description:"Remove all tags from nodes"}],yb=({config:e,onChange:s})=>{var h;const[n,o]=p.useState(""),r=u=>{s({...e,mode:u})},a=()=>{const u=n.trim();u&&(e.tags.includes(u)||s({...e,tags:[...e.tags,u]}),o(""))},i=u=>{s({...e,tags:e.tags.filter(f=>f!==u)})},c=u=>{u.key==="Enter"&&(u.preventDefault(),u.stopPropagation(),a())},l=u=>{s({...e,useTemplate:u})},d=((h=kc.find(u=>u.value===e.mode))==null?void 0:h.description)||"";return t.jsxs("div",{"data-test":"tag-update-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"tag-update-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:d}),t.jsxs("div",{"data-test":"tag-update-mode",children:[t.jsx("label",{"data-test":"tag-update-mode-label",className:"text-xs font-medium",children:"Mode"}),t.jsxs(yt,{value:e.mode,onValueChange:u=>r(u),children:[t.jsx(wt,{"data-test":"tag-update-mode-trigger",className:"h-7 text-xs mt-1",onClick:u=>u.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"tag-update-mode-content",children:kc.map(u=>t.jsx(Qe,{value:u.value,"data-test":"tag-update-mode-option",className:"text-xs",children:u.label},u.value))})]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-tags",className:"space-y-2",children:[t.jsx("label",{"data-test":"tag-update-tags-label",className:"text-xs font-medium",children:"Tags"}),e.tags.length>0&&t.jsx("div",{"data-test":"tag-update-tags-chips",className:"flex flex-wrap gap-1 p-2 bg-muted/30 rounded border border-border",children:e.tags.map((u,f)=>t.jsxs("div",{"data-test":"tag-update-tag-chip",className:"flex items-center gap-1 px-2 py-0.5 bg-primary/10 text-primary rounded-full text-xs",children:[t.jsx("span",{"data-test":"tag-update-tag-text",children:u}),t.jsx("button",{"data-test":"tag-update-tag-remove",onClick:m=>{m.stopPropagation(),i(u)},className:"hover:text-destructive",children:t.jsx(Ke,{size:12})})]},`${u}-${f}`))}),t.jsx(ze,{"data-test":"tag-update-tags-input",value:n,onChange:u=>o(u.target.value),onKeyDown:c,onClick:u=>u.stopPropagation(),placeholder:"Type tag and press Enter...",className:"h-7 text-xs"}),t.jsxs("p",{"data-test":"tag-update-tags-hint",className:"text-xs text-muted-foreground",children:["Press Enter to add tag. Supports templates like ","{","{","loop.current","}","."]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-template",className:"flex items-center gap-2 p-2 bg-muted/30 rounded",children:[t.jsx(Xe,{"data-test":"tag-update-template-checkbox",checked:e.useTemplate||!1,onCheckedChange:l,onClick:u=>u.stopPropagation()}),t.jsxs("label",{"data-test":"tag-update-template-label",className:"text-xs",children:["Use template variables (e.g., ","{","{","loop.current","}",")"]})]}),e.useTemplate&&t.jsxs("div",{"data-test":"tag-update-template-help",className:"text-xs text-muted-foreground bg-blue-500/10 p-2 rounded border border-blue-500/30",children:[t.jsx("strong",{children:"Available variables:"}),t.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-0.5",children:[t.jsxs("li",{children:["{","{","loop.current","}"," - Current item in loop"]}),t.jsxs("li",{children:["{","{","loop.index","}"," - Loop index (1-based)"]}),t.jsxs("li",{children:["{","{","loop.total","}"," - Total iterations"]})]})]})]})},Ic=[{value:"connectedNode",label:"Connected Node",description:"Iterate over data from incoming arrow connection"},{value:"selectedNodes",label:"Selected Nodes",description:"Iterate over currently selected nodes on canvas"},{value:"allNodes",label:"All Canvas Nodes",description:"Iterate over all nodes on the canvas"}],wb=({config:e,onChange:s})=>{var r;const n=a=>{s({...e,source:a})},o=((r=Ic.find(a=>a.value===e.source))==null?void 0:r.description)||"";return t.jsxs("div",{"data-test":"loop-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"loop-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:o}),t.jsxs("div",{"data-test":"loop-config-source",children:[t.jsx("label",{"data-test":"loop-config-source-label",className:"text-xs font-medium",children:"Data Source"}),t.jsxs(yt,{value:e.source,onValueChange:a=>n(a),children:[t.jsx(wt,{"data-test":"loop-config-source-trigger",className:"h-7 text-xs mt-1",onClick:a=>a.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"loop-config-source-content",children:Ic.map(a=>t.jsx(Qe,{value:a.value,"data-test":"loop-config-source-option",className:"text-xs",children:a.label},a.value))})]})]}),t.jsxs("div",{"data-test":"loop-config-variables",className:"p-2 bg-blue-500/10 rounded border border-blue-500/30 space-y-2",children:[t.jsx("label",{"data-test":"loop-config-variables-label",className:"text-xs font-semibold text-blue-700 dark:text-blue-300",children:"Available Variables"}),t.jsxs("div",{"data-test":"loop-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"loop-config-variable-current",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.current","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current item being processed"})]}),t.jsxs("div",{"data-test":"loop-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.index","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current iteration (1-based)"})]}),t.jsxs("div",{"data-test":"loop-config-variable-total",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.total","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Total number of iterations"})]})]}),t.jsxs("div",{"data-test":"loop-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-blue-500/30",children:[t.jsx("strong",{children:"Example:"})," Use"," ",t.jsxs("code",{className:"px-1 bg-blue-500/20 rounded",children:["{","{","loop.current","}"]})," ","in subsequent steps to reference the current item."]})]}),t.jsxs("div",{"data-test":"loop-config-tips",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Tip:"})," Steps connected after this loop will execute once per item. Use loop variables in those steps to access iteration data."]})]})},Ac=[{value:"connectedNode",label:"Connected Node",description:"Read data from incoming arrow connection"},{value:"inline",label:"Inline Data",description:"Define data directly in this node"}],vb=({config:e,onChange:s})=>{var c;const n=l=>{s({...e,dataFrom:l,inlineData:l==="inline"?e.inlineData||"{}":void 0})},o=l=>{s({...e,inlineData:l})};let r=null,a=null;if(e.dataFrom==="inline"&&e.inlineData)try{r=JSON.parse(e.inlineData)}catch(l){a=l.message}const i=((c=Ac.find(l=>l.value===e.dataFrom))==null?void 0:c.description)||"";return t.jsxs("div",{"data-test":"source-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"source-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:i}),t.jsxs("div",{"data-test":"source-config-data-from",children:[t.jsx("label",{"data-test":"source-config-data-from-label",className:"text-xs font-medium",children:"Data From"}),t.jsxs(yt,{value:e.dataFrom,onValueChange:l=>n(l),children:[t.jsx(wt,{"data-test":"source-config-data-from-trigger",className:"h-7 text-xs mt-1",onClick:l=>l.stopPropagation(),children:t.jsx(vt,{})}),t.jsx(bt,{"data-test":"source-config-data-from-content",children:Ac.map(l=>t.jsx(Qe,{value:l.value,"data-test":"source-config-data-from-option",className:"text-xs",children:l.label},l.value))})]})]}),e.dataFrom==="inline"&&t.jsxs("div",{"data-test":"source-config-inline-data",className:"space-y-2",children:[t.jsx("label",{"data-test":"source-config-inline-data-label",className:"text-xs font-medium",children:"Inline Data (JSON)"}),t.jsx("textarea",{"data-test":"source-config-inline-data-textarea",value:e.inlineData||"",onChange:l=>o(l.target.value),onClick:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),placeholder:'{"key": "value"}',className:"w-full h-24 text-xs font-mono border border-border rounded px-2 py-1 bg-background resize-none"}),a&&t.jsxs("div",{"data-test":"source-config-parse-error",className:"text-xs text-destructive bg-destructive/10 p-2 rounded border border-destructive/30",children:[t.jsx("strong",{children:"Invalid JSON:"})," ",a]}),!a&&r&&t.jsxs("div",{"data-test":"source-config-preview",className:"space-y-1",children:[t.jsx("label",{"data-test":"source-config-preview-label",className:"text-xs font-medium text-muted-foreground",children:"Preview"}),t.jsx("div",{"data-test":"source-config-preview-content",className:"text-xs font-mono bg-muted/30 p-2 rounded border border-border max-h-32 overflow-auto",children:t.jsx("pre",{children:JSON.stringify(r,null,2)})})]})]}),t.jsxs("div",{"data-test":"source-config-variables",className:"p-2 bg-green-500/10 rounded border border-green-500/30 space-y-2",children:[t.jsx("label",{"data-test":"source-config-variables-label",className:"text-xs font-semibold text-green-700 dark:text-green-300",children:"Access Data"}),t.jsxs("div",{"data-test":"source-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"source-config-variable-key",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.key","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access object property by key"})]}),t.jsxs("div",{"data-test":"source-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source[0]","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access array element by index"})]}),t.jsxs("div",{"data-test":"source-config-variable-nested",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.user.name","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access nested properties"})]})]}),t.jsxs("div",{"data-test":"source-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-green-500/30",children:[t.jsx("strong",{children:"Example:"})," If source data is"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{",'"',"users",'"',": [",'"',"name",'"',": ",'"',"Alice",'"',"}","}"," "]}),", use"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{","{","source.users[0].name","}"]})," ","to get ",'"',"Alice",'"',"."]})]}),e.dataFrom==="connectedNode"&&t.jsxs("div",{"data-test":"source-config-connected-info",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Note:"})," Connect an arrow from another node to provide data. The connected node's content or output will be available via ",t.jsx("code",{children:"{{source}}"})," variables."]})]})},bb=({nodeId:e,data:s,onDataChange:n})=>{var l;const[o,r]=p.useState(s.stepType),a=d=>{r(d);let h;switch(d){case"if":h={condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}};break;case"toolbarAction":h={facadeKey:"split",actionId:"byWhitespace",params:{}};break;case"tagUpdate":h={mode:"add",tags:[]};break;case"loop":h={source:"connectedNode"};break;case"source":h={dataFrom:"connectedNode"};break;default:h={}}n({stepType:d,config:h})},i=d=>{o&&n({stepType:o,config:d})},c=o?((l=Sc.find(d=>d.type===o))==null?void 0:l.icon)||"⚡":"❓";return t.jsxs("div",{"data-test":"workflow-step-node",className:"flex flex-col gap-1 p-1.5 bg-background border border-border rounded-md min-w-[240px]",onMouseDown:d=>d.stopPropagation(),onClick:d=>d.stopPropagation(),children:[t.jsxs("div",{"data-test":"workflow-step-header",className:"flex items-center gap-1.5",children:[t.jsx("span",{"data-test":"workflow-step-icon",className:"text-sm",children:c}),t.jsxs(yt,{value:o??"",onValueChange:d=>a(d),children:[t.jsx(wt,{"data-test":"workflow-step-type-trigger",className:"h-6 text-[11px] flex-1",onClick:d=>d.stopPropagation(),children:t.jsx(vt,{placeholder:"Select step type..."})}),t.jsx(bt,{"data-test":"workflow-step-type-content",children:Sc.map(d=>t.jsx(Qe,{value:d.type,"data-test":"workflow-step-type-option",className:"text-xs",children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{children:d.icon}),t.jsx("span",{children:d.label})]})},d.type))})]})]}),o?t.jsxs("div",{"data-test":"workflow-step-config-panel",children:[o==="if"&&t.jsx(fb,{config:s.config,onChange:d=>i(d)}),o==="toolbarAction"&&t.jsx(xb,{config:s.config,onChange:d=>i(d)}),o==="tagUpdate"&&t.jsx(yb,{config:s.config,onChange:d=>i(d)}),o==="loop"&&t.jsx(wb,{config:s.config,onChange:d=>i(d)}),o==="source"&&t.jsx(vb,{config:s.config,onChange:d=>i(d)})]}):t.jsx("div",{"data-test":"workflow-step-placeholder",className:"text-[10px] text-muted-foreground text-center py-2",children:"Select a step type to configure"})]})},Nb=({node:e})=>{const o=e.data||{stepType:"if",config:{condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}}},r=p.useCallback(a=>{T.getState().updateNode(e.id,{data:a})},[e.id]);return t.jsx("div",{"data-test":"canvas-workflow-step-node",className:"w-full h-full",children:t.jsx(bb,{nodeId:e.id,data:o,onDataChange:r})})};function eu({nodeId:e,preventEdit:s=!1,onEditStart:n,onEditEnd:o,inputRefs:r,clearSelectionOnBlur:a=!1}){const[i,c]=p.useState(!1),l=$(v=>v.uiState.nodeToFocusId),d=$(v=>{var N,b;return((b=(N=v.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)==null?void 0:b.some(A=>A.id===e))??!1}),h=$(v=>{var N,b;return((b=(N=v.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)==null?void 0:b.length)??0}),u=d&&l===e,{updateNode:f,setMode:m}=T.getState(),y=p.useCallback(v=>{c(v),f(e,{isEditing:v})},[e,f]),g=p.useCallback(v=>{var N;if(!document.querySelector("[data-radix-popper-content-wrapper]")){if(r&&r.length>0&&(v!=null&&v.relatedTarget)){const b=v.relatedTarget;if(r.some(R=>R.current===b))return}o==null||o(),y(!1),a&&(T.getState().setNodeToFocusId(null),T.getState().setSelectedNodes([])),(N=window.getSelection())==null||N.removeAllRanges()}},[o,y,r,a]),x=p.useCallback(()=>{d&&h<=1&&!s&&(i||n==null||n(),y(!0))},[d,h,s,i,n,y]),w=p.useCallback(v=>{v.key==="Escape"&&(g(),T.getState().uiState.mode!==ee.VIM&&m(ee.SELECT))},[g,m]);return p.useEffect(()=>{l||y(!1)},[l,y]),p.useEffect(()=>{!d&&i&&y(!1)},[d,i,y]),p.useEffect(()=>{if(!u||s)return;!i&&(n==null||n()),y(!0)},[u,s,i,n,y]),p.useEffect(()=>{if(!r||r.length===0)return;const v=[];return r.forEach(N=>{if(N.current){const b=A=>g(A);N.current.addEventListener("blur",b),v.push({el:N.current,handler:b})}}),()=>{v.forEach(({el:N,handler:b})=>{N.removeEventListener("blur",b)})}},[g,r]),{isEditing:i,shouldFocus:u,isSelected:d,selectedNodesCount:h,handleMouseDown:x,handleBlur:g,handleKeyDown:w,setIsEditing:y}}const Sb=({nodeId:e,nodeData:s,preventEdit:n})=>{const o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),[i,c]=p.useState(s.sourceWord||""),[l,d]=p.useState(s.translationWord||""),[h,u]=p.useState(null),{isEditing:f,isSelected:m,selectedNodesCount:y,handleKeyDown:g}=eu({nodeId:e,preventEdit:n,inputRefs:[r,a],clearSelectionOnBlur:!0,onEditEnd:()=>{x({sourceWord:i,translationWord:l})}});p.useEffect(()=>{c(s.sourceWord||""),d(s.translationWord||"")},[s.sourceWord,s.translationWord]),p.useEffect(()=>{requestAnimationFrame(()=>{var O,H;const E=((O=T.getState().projectCanvas.getActive())==null?void 0:O.viewState.scale)??1,I=(((H=o.current)==null?void 0:H.getBoundingClientRect().height)??0)/E;I>0&&T.getState().updateNode(e,{height:I})})},[e,i,l]);const x=p.useCallback(S=>{const E=s;T.getState().updateNode(e,{data:{...E,...S}})},[e,s]),w=S=>{c(S.target.value)},v=S=>{d(S.target.value)},N=S=>{const C=T.getState().getNodeById(S);return C&&typeof C.content=="string"?C.content.trim():""},b=p.useCallback(S=>{S.preventDefault(),u(null);const E=S.dataTransfer.getData("application/json");if(E)try{const C=JSON.parse(E);if(C.nodeIds&&Array.isArray(C.nodeIds)&&C.nodeIds.length>=1){const I=C.nodeIds.map(O=>{const H=T.getState().getNodeById(O);return H?{id:O,x:H.x,y:H.y,content:N(O)}:null}).filter(Boolean);if(I.length>=2){I.sort((L,W)=>L.x+L.y-(W.x+W.y));const O=I[0].content,H=I[I.length-1].content;c(O),d(H),x({sourceWord:O,translationWord:H})}else if(I.length===1){const O=I[0].content;i?(d(O),x({translationWord:O})):(c(O),x({sourceWord:O}))}}else if(C.nodeId){const I=N(C.nodeId);c(I),x({sourceWord:I})}}catch(C){console.error("Failed to parse drop data:",C)}},[i,x]),A=p.useCallback(S=>{S.preventDefault(),u(null);const E=S.dataTransfer.getData("application/json");if(E)try{const C=JSON.parse(E);if(C.nodeIds&&Array.isArray(C.nodeIds)&&C.nodeIds.length>=1){const I=C.nodeIds.map(O=>{const H=T.getState().getNodeById(O);return H?{id:O,x:H.x,y:H.y,content:N(O)}:null}).filter(Boolean);if(I.length>=2){I.sort((L,W)=>L.x+L.y-(W.x+W.y));const O=I[0].content,H=I[I.length-1].content;c(O),d(H),x({sourceWord:O,translationWord:H})}else if(I.length===1){const O=I[0].content;l?(c(O),x({sourceWord:O})):(d(O),x({translationWord:O}))}}else if(C.nodeId){const I=N(C.nodeId);d(I),x({translationWord:I})}}catch(C){console.error("Failed to parse drop data:",C)}},[l,x]),R=(S,E)=>{S.preventDefault(),u(E)},k=()=>{u(null)};return t.jsxs("div",{ref:o,className:"w-full flex flex-col","data-text-position-container":"true","data-test":"vocab-vocabulary-view",children:[t.jsx("div",{className:Me("flex items-center justify-center transition-colors rounded-t-md",h==="source"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:b,onDragOver:S=>R(S,"source"),onDragLeave:k,"data-test":"vocab-source-drop-zone",children:t.jsx(ze,{ref:r,type:"text",value:i,onChange:w,onKeyDown:g,placeholder:"Source word...","data-test":"vocab-source-input",className:Me("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!f&&!m||y>1||n,"cursor-text":f,"cursor-default":!f}),readOnly:!f})}),t.jsx("div",{className:"py-1","data-test":"vocab-divider",children:t.jsx("div",{className:"border-t border-border"})}),t.jsx("div",{className:Me("flex items-center justify-center transition-colors rounded-b-md",h==="translation"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:A,onDragOver:S=>R(S,"translation"),onDragLeave:k,"data-test":"vocab-translation-drop-zone",children:t.jsx(ze,{ref:a,type:"text",value:l,onChange:v,onKeyDown:g,placeholder:"Translation...","data-test":"vocab-translation-input",className:Me("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!f&&!m||y>1||n,"cursor-text":f,"cursor-default":!f}),readOnly:!f})})]})},Cb={noun:"bg-blue-100 text-blue-800",verb:"bg-green-100 text-green-800",adjective:"bg-purple-100 text-purple-800",adverb:"bg-orange-100 text-orange-800",pronoun:"bg-pink-100 text-pink-800",preposition:"bg-indigo-100 text-indigo-800",conjunction:"bg-yellow-100 text-yellow-800",interjection:"bg-red-100 text-red-800"},jb=({node:e,preventEdit:s})=>{var Z,ge;const n=p.useRef(null),o=p.useRef(null),r=e.data||{vocabType:tt.DICTIONARY,term:"",definition:""},i=$(we=>we.uiState.hoveredDropTargetVocabNodeId)===e.id,[c,l]=p.useState(r.vocabType||tt.DICTIONARY),[d,h]=p.useState(r.term||""),[u,f]=p.useState(r.pronunciation||""),[m,y]=p.useState(r.partOfSpeech||""),[g,x]=p.useState(r.definition||""),[w,v]=p.useState(r.flashcardBack||""),[N,b]=p.useState((r.wordListItems||[]).join(`
`)),[A,R]=p.useState(r.isFlipped||!1),[k,S]=p.useState(r.expandedSections||["definition"]),{onEditStart:E,onEditEnd:C}=wn(e.id,"title"),{onEditStart:I,onEditEnd:O}=wn(e.id,"content"),H=T.getState().updateNode,{isEditing:L,shouldFocus:W,handleMouseDown:P,handleBlur:j,handleKeyDown:M}=eu({nodeId:e.id,preventEdit:s,onEditStart:()=>{E(d),I(g)},onEditEnd:()=>{const we=N.split(`
`).map(te=>te.trim()).filter(te=>te.length>0);H(e.id,{data:{...r,vocabType:c,term:d,pronunciation:u,partOfSpeech:m,definition:g,flashcardBack:w,wordListItems:we,isFlipped:A,expandedSections:k},title:d,content:g}),C(d),O(g)}});p.useEffect(()=>{h(r.term||""),f(r.pronunciation||""),y(r.partOfSpeech||""),x(r.definition||""),v(r.flashcardBack||""),b((r.wordListItems||[]).join(`
`)),R(r.isFlipped||!1),l(r.vocabType||tt.DICTIONARY),S(r.expandedSections||["definition"])},[r]),p.useEffect(()=>{W&&L&&n.current&&n.current.focus()},[W,L]);const B=p.useCallback(()=>{j()},[j]),U=p.useCallback(we=>{var te,X;M(we),we.key==="Escape"&&((te=n.current)==null||te.blur(),(X=o.current)==null||X.blur())},[M]),z=we=>{S(te=>te.includes(we)?te.filter(X=>X!==we):[...te,we])},_=r.examples&&r.examples.length>0,G=(Z=r.relatedWords)==null?void 0:Z.some(we=>we.type==="synonym"),F=(ge=r.relatedWords)==null?void 0:ge.some(we=>we.type==="antonym"),D=r.etymology&&(r.etymology.origin||r.etymology.language),V=()=>{var we,te,X,K,ne,ce,de,q,he;return t.jsxs("div",{className:"w-full h-full flex flex-col overflow-auto",children:[t.jsx("div",{className:"border-b pb-3 mb-3",children:t.jsx(ze,{ref:n,type:"text",value:d,onChange:be=>h(be.target.value),onBlur:B,onMouseDown:P,onKeyDown:U,placeholder:"Term...","data-test":"vocab-term-input",className:Me("text-lg font-semibold",{"pointer-events-none":s,"cursor-text":L,"cursor-default":!L}),readOnly:!L})}),(u||m)&&t.jsxs("div",{className:"flex gap-2 mb-3 flex-wrap",children:[u&&t.jsxs(lt,{"data-test":"vocab-pronunciation-badge",variant:"secondary",className:"text-xs",children:["/",u,"/"]}),m&&t.jsx(lt,{"data-test":"vocab-pos-badge",className:Me("text-xs",Cb[m]||"bg-gray-100 text-gray-800"),children:m})]}),t.jsxs(Es,{open:k.includes("definition"),onOpenChange:()=>z("definition"),className:"mb-2 border rounded",children:[t.jsxs(Rs,{"data-test":"vocab-definition-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Pt,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Definition"})]}),t.jsx(Ms,{className:"border-t",children:t.jsx(Er,{ref:o,value:g,onChange:be=>x(be.target.value),onBlur:B,onMouseDown:P,onKeyDown:U,placeholder:"Enter definition...","data-test":"vocab-definition-textarea",className:Me("min-h-20 resize-none border-none focus:outline-none bg-transparent text-sm p-3",{"pointer-events-none":s,"cursor-text":L,"cursor-default":!L}),readOnly:!L})})]}),_&&t.jsxs(Es,{open:k.includes("examples"),onOpenChange:()=>z("examples"),className:"mb-2 border rounded",children:[t.jsxs(Rs,{"data-test":"vocab-examples-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Pt,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Examples (",((we=r.examples)==null?void 0:we.length)||0,")"]})]}),t.jsx(Ms,{className:"border-t p-3 space-y-2",children:(te=r.examples)==null?void 0:te.map(be=>t.jsxs("div",{"data-test":"vocab-example-item",className:"text-sm p-2 bg-muted rounded",children:[t.jsx("p",{className:"italic",children:be.text}),be.translation&&t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:be.translation})]},be.id))})]}),(G||F)&&t.jsxs(Es,{open:k.includes("related"),onOpenChange:()=>z("related"),className:"mb-2 border rounded",children:[t.jsxs(Rs,{"data-test":"vocab-related-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Pt,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Related Words",G&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Synonyms (",((X=r.relatedWords)==null?void 0:X.filter(be=>be.type==="synonym").length)||0,")"]}),F&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Antonyms (",((K=r.relatedWords)==null?void 0:K.filter(be=>be.type==="antonym").length)||0,")"]})]})]}),t.jsx(Ms,{className:"border-t p-3 space-y-2",children:(ne=r.relatedWords)==null?void 0:ne.map(be=>t.jsxs("div",{"data-test":"vocab-related-word",className:"flex items-center gap-2",children:[t.jsx(lt,{variant:"outline",className:"text-xs",children:be.type}),t.jsx("span",{className:"text-sm",children:be.word})]},be.id))})]}),D&&t.jsxs(Es,{open:k.includes("etymology"),onOpenChange:()=>z("etymology"),className:"mb-2 border rounded",children:[t.jsxs(Rs,{"data-test":"vocab-etymology-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Pt,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Etymology"})]}),t.jsx(Ms,{className:"border-t p-3 space-y-2",children:t.jsxs("div",{"data-test":"vocab-etymology-content",className:"text-sm space-y-2",children:[((ce=r.etymology)==null?void 0:ce.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((de=r.etymology)==null?void 0:de.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((q=r.etymology)==null?void 0:q.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((he=r.etymology)==null?void 0:he.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})})]})]})},J=()=>t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-4",children:[t.jsx("div",{"data-test":"vocab-flashcard-container",className:"relative w-full flex-1 flex items-center justify-center cursor-pointer",onClick:()=>R(!A),style:{perspective:"1000px"},children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center rounded-lg border-2 border-primary bg-card shadow-lg transition-transform",style:{transformStyle:"preserve-3d",transform:A?"rotateY(180deg)":"rotateY(0deg)",transitionDuration:"0.6s"},children:[t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden"},children:t.jsxs("div",{"data-test":"vocab-flashcard-front",className:"text-center",children:[u&&t.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["/",u,"/"]}),t.jsx("p",{className:"text-3xl font-bold",children:d}),m&&t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:m})]})}),t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden",transform:"rotateY(180deg)"},children:t.jsx("div",{"data-test":"vocab-flashcard-back",className:"text-center",children:t.jsx("p",{className:"text-lg",children:w||g})})})]})}),t.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"Click to flip"})]}),ie=()=>t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-wordlist-container",className:"grid grid-cols-2 gap-2 flex-1",children:(r.wordListItems||[]).map((we,te)=>t.jsx("div",{"data-test":"vocab-wordlist-item",className:"p-3 bg-muted rounded-lg border border-border hover:border-primary transition-colors",children:t.jsx("p",{className:"text-sm font-medium",children:we})},te))})}),Se=()=>{var we,te,X,K;return t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-etymology-view",className:"space-y-4",children:t.jsxs("div",{className:"p-4 bg-muted rounded-lg border border-border",children:[t.jsxs("h3",{className:"font-semibold text-sm flex items-center gap-2 mb-3",children:[t.jsx(vp,{className:"h-4 w-4"}),'Etymology of "',d,'"']}),t.jsxs("div",{className:"space-y-2 text-sm",children:[((we=r.etymology)==null?void 0:we.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((te=r.etymology)==null?void 0:te.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((X=r.etymology)==null?void 0:X.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((K=r.etymology)==null?void 0:K.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})]})})})},me=i?{border:"2px dashed hsl(var(--primary))",boxShadow:"0 0 0 4px hsl(var(--primary) / 0.2)"}:{};return t.jsxs("div",{className:Me("w-full h-full rounded-lg transition-all",i&&"ring-2 ring-primary/50"),style:me,"data-test":"vocabulary-node-content",children:[c===tt.DICTIONARY&&V(),c===tt.FLASHCARD&&J(),c===tt.WORD_LIST&&ie(),c===tt.ETYMOLOGY&&Se(),c===tt.VOCABULARY&&t.jsx(Sb,{nodeId:e.id,nodeData:r,preventEdit:s})]})},tu=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},kb=({element:e,index:s})=>{const{type:n,stroke:o,shape:r,style:a}=e,i=tu(a),c=a.opacity??1;if(n==="freehand"&&o){const l=c<1;return t.jsx("path",{"data-test":"draw-freehand-path",d:o.smoothedPath,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:"none",strokeLinecap:l?"butt":"round",strokeLinejoin:l?"bevel":"round"},s)}if(n==="shape"&&r){const l=ot.generateShapeSVGPath(r);return t.jsx("path",{"data-test":"draw-shape-path",d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:a.fillColor||"none",fillOpacity:a.fillColor?c:void 0,strokeLinecap:"round",strokeLinejoin:"round"},s)}return null},Ib=p.memo(kb),Ab=({drawData:e})=>{if(e.elements&&e.elements.length>0)return t.jsx(t.Fragment,{children:e.elements.map((c,l)=>t.jsx(Ib,{element:c,index:l},l))});const{drawType:s,stroke:n,shape:o,style:r}=e;if(!r)return null;const a=tu(r),i=r.opacity??1;if(s==="freehand"&&n)return t.jsx("path",{"data-test":"draw-freehand-path",d:n.smoothedPath,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:"none",strokeLinecap:"round",strokeLinejoin:"round"});if(s==="shape"&&o){const c=ot.generateShapeSVGPath(o);return t.jsx("path",{"data-test":"draw-shape-path",d:c,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:r.fillColor||"none",fillOpacity:r.fillColor?i:void 0,strokeLinecap:"round",strokeLinejoin:"round"})}return null},Tb=p.memo(Ab),Tc=new Set(["circle","square"]),Eb=e=>{var n;const s=e.elements??[];return s.length===0?(n=e.shape)!=null&&n.shapeType?Tc.has(e.shape.shapeType):!1:s.every(o=>{var r;return o.type==="shape"&&((r=o.shape)==null?void 0:r.shapeType)&&Tc.has(o.shape.shapeType)})},Rb=({node:e})=>{const s=e.data;if(!s)return null;const n=s.intrinsicWidth??e.width??100,o=s.intrinsicHeight??e.height??100,r=Eb(s);return t.jsx("svg",{"data-test":"draw-node-svg",viewBox:`0 0 ${n} ${o}`,preserveAspectRatio:r?"xMidYMid meet":"none",style:{width:e.width?`${e.width}px`:"100%",height:e.height?`${e.height}px`:"100%",overflow:"visible"},children:t.jsx(Tb,{drawData:s})})},Mb=p.memo(Rb);function Pb({node:e,isSelected:s,scale:n}){const r=(typeof e.content=="string"?e.content:"").split(`

`).filter(h=>h.trim().length>0),a=e.width??ke.DEFAULT_NODE_WIDTH;e.height??ke.DEFAULT_NODE_HEIGHT;const c=document.createElement("canvas").getContext("2d"),l=[];if(c){c.font=getComputedStyle(document.body).font;for(const h of r){const u=h.split(`
`);let f=0;for(const g of u){if(g.trim()===""){f++;continue}const x=g.split(" ");let w="",v=1;for(let N=0;N<x.length;N++){const b=x[N],A=w+(w?" ":"")+b;c.measureText(A).width>a&&w!==""?(v++,w=b):w=A}f+=v}const m=h.length;let y;m<100?y=40+m/100*20:m<300?y=60+(m-100)/200*25:y=Math.min(95,85+(m-300)/500*10),l.push({lines:f,widthPercent:Math.round(y),charCount:m})}}return{jsx:t.jsx("div",{className:"w-full h-full flex flex-col gap-2 p-2",children:l.map((h,u)=>t.jsx("div",{className:"rounded flex flex-col gap-[2px]",style:{height:`${h.lines*ke.LINE_HEIGHT}px`,width:`${h.widthPercent}%`,backgroundColor:"transparent"},children:Array.from({length:h.lines}).map((f,m)=>t.jsx("div",{className:"rounded",style:{height:`${ke.LINE_HEIGHT-4}px`,width:"100%",backgroundColor:s?"#93c5fd":"hsl(var(--foreground))"}},m))},u))}),blockMetrics:l}}const{DEFAULT_NODE_WIDTH:Db,DEFAULT_NODE_HEIGHT:Ob}=ke,Lb=({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o=!1})=>{var G;const[r,a]=p.useState(!1),i=ps(),c=p.useRef(0),l=p.useRef(null),d=p.useRef(null),h=p.useRef(null),u=p.useRef(null),[f,m]=p.useState(0),y=500,g=10,x=$(F=>F.uiState.mode),w=$(F=>!!F.uiState.dragInfo),v=$(F=>!!F.uiState.resizingNode),N=$(F=>F.uiState.activeGroupId),b=$(F=>!!F.uiState.nodeContextMenu),R=e.type===fe.GROUP&&N===e.id,k=()=>{var ie,Se;const F=(ie=T.getState().projectCanvas.getActive())==null?void 0:ie.coreState.selectedNodes,D=(F==null?void 0:F.some(me=>me.id===e.id))??!1,V=F&&F.length>0?((Se=F[F.length-1])==null?void 0:Se.id)===e.id:!1,J=(F==null?void 0:F.length)??0;return{isNodeAlreadySelected:D,isLastSelectedNode:V,selectedNodeIdsLength:J}},{isNodeAlreadySelected:S,isLastSelectedNode:E,selectedNodeIdsLength:C}=k(),I=((G=T.getState().projectCanvas.getActive())==null?void 0:G.viewState.scale)??1,H=s&&(n??C)===1,L=p.useCallback((F,D)=>{var J;const V=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,clientX:F,clientY:D});u.current&&(cancelAnimationFrame(u.current),u.current=null),m(0),(J=h.current)==null||J.dispatchEvent(V)},[]),{handleMouseDown:W,initialClickPoint:P}=_w({node:e,mode:x,isPopoverOpen:r,setIsPopoverOpen:a}),j=p.useCallback(F=>{var ie;const D=Date.now()-Qd,V=!!F.nativeEvent.__chatMessageContextMenu;if(Sr||V||D<500){F.stopPropagation(),F.preventDefault();return}F.preventDefault(),F.stopPropagation(),(((ie=T.getState().projectCanvas.getActive())==null?void 0:ie.coreState.selectedNodes)??[]).length===0&&T.getState().setSelectedNodes([e]),T.getState().setNodeContextMenu({nodeId:e.id,position:{x:F.clientX,y:F.clientY}})},[e]),M=p.useCallback(F=>{const D={x:F.clientX,y:F.clientY};if(!Vu(P.current,D))return;if(!!T.getState().uiState.nodeContextMenu)return!1;const ie=!e.isEditing&&E;return a(ie),ie},[e,H,S,E,C,r]);p.useEffect(()=>{if(!S){a(!1);return}if(e.isEditing){a(!1);return}w||v||b||(E?a(!0):S&&!E&&a(!1))},[C,e.isEditing,S,H,E,e.id,w,v]),p.useEffect(()=>{(w||v)&&a(!1)},[w,v]);const B=()=>{if(o){if(e.type===fe.CHAT)return t.jsx(Cr,{node:e});if(e.type===fe.TEXT){const{jsx:J}=Pb({node:e,isSelected:s,scale:I});return J}return null}const F=e.data,D=(F==null?void 0:F.nodeType)==="workflowOrchestration",V=(F==null?void 0:F.nodeType)==="workflowSource";if(D)return t.jsx(yc,{node:e});if(V)return t.jsx(wc,{node:e,preventEdit:!S});switch(e.type){case fe.RECT:return t.jsx(ax,{node:e});case fe.TEXT:return t.jsx(jd,{node:e});case fe.TABLE:return t.jsx(hv,{node:e});case fe.TEXTCARD:return t.jsx(pv,{node:e});case fe.WORKFLOW_ORCHESTRATION:return t.jsx(yc,{node:e});case fe.WORKFLOW_SOURCE:return t.jsx(wc,{node:e,preventEdit:!S});case fe.WORKFLOW_DEFINITION:return t.jsx(_v,{node:e,preventEdit:!S});case fe.OCR:return t.jsx(Vv,{node:e});case fe.IMAGE:return t.jsx(Yv,{node:e});case fe.GROUP:return t.jsx(Zd,{node:e});case fe.CHAT:return t.jsx(Cr,{node:e});case fe.VOCABULARY:return t.jsx(jb,{node:e});case fe.WORKFLOW_STEP:return t.jsx(Nb,{node:e});case fe.DRAWING:return t.jsx(Mb,{node:e});default:return t.jsx("div",{children:"Unknown Node Type"})}},U=Q.getSelectionRingClass(s),z=e.styles,_=p.useMemo(()=>!i||f===0?0:1+(V=>1-Math.pow(1-V,2))(f)*3,[i,f]);return t.jsx(Dw,{node:e,isOpen:r,children:t.jsxs("div",{ref:h,id:`NodeContainerV2-${e.id}`,"data-test":"node-container-v2",className:Me("node-container-main","absolute group",x===ee.DRAW?"cursor-crosshair":"cursor-grab","select-none","rounded","overflow-visible",s&&U),style:{..._>0&&{"--tw-ring-offset-width":"1px","--tw-ring-width":`${_}px`,"--tw-ring-color":s?"hsl(var(--ring))":"hsl(var(--primary))",boxShadow:"var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)","--tw-ring-offset-shadow":"var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color)","--tw-ring-shadow":`var(--tw-ring-inset) 0 0 0 calc(${_}px + var(--tw-ring-offset-width)) var(--tw-ring-color)`},transform:(()=>{const F=Qt.get(e.id),D=F?e.x+F.dx:e.x,V=F?e.y+F.dy:e.y;return`translate(${D}px, ${V}px)`})(),transition:w||v||x===ee.DRAW?"none":`transform ${Q.animation.durationMs}ms ${Q.animation.easing}`,width:e.isCollapsed?"auto":`${e.width??Db}px`,height:e.isCollapsed?"0px":`${e.height??Ob}px`,minWidth:e.isCollapsed?"100px":void 0,transformOrigin:"0 0",border:e.isCollapsed?"none":z==null?void 0:z.border,borderWidth:e.isCollapsed||z==null?void 0:z.borderWidth,borderColor:e.isCollapsed||z==null?void 0:z.borderColor,borderStyle:e.isCollapsed?void 0:z!=null&&z.borderWidth?(z==null?void 0:z.borderStyle)||"solid":z==null?void 0:z.borderStyle,willChange:"transform",backfaceVisibility:"hidden",pointerEvents:R?"none":"auto",contain:"layout style paint"},onPointerDown:F=>{F.target.closest('[role="menu"]')||R||W(F)},onPointerUp:R?void 0:M,onTouchStart:F=>{if(i&&!R){const D=F.touches[0],V=F.target,J=V.closest('[data-test="chat-message-row"]')!==null,ie=V.closest('[role="menu"]')!==null;if(J||ie)return;c.current=Date.now(),l.current={x:D.clientX,y:D.clientY};const Se=Date.now(),me=()=>{const Z=Date.now()-Se,ge=Math.min(Z/y,1);m(ge),ge<1&&l.current&&(u.current=requestAnimationFrame(me))};u.current=requestAnimationFrame(me),d.current=setTimeout(()=>{l.current&&L(l.current.x,l.current.y)},y)}},onTouchMove:F=>{if(i&&l.current){const D=F.touches[0],V=D.clientX-l.current.x,J=D.clientY-l.current.y;Math.sqrt(V*V+J*J)>g&&(d.current&&(clearTimeout(d.current),d.current=null),u.current&&(cancelAnimationFrame(u.current),u.current=null),m(0),l.current=null)}},onTouchEnd:()=>{i&&(d.current&&(clearTimeout(d.current),d.current=null),u.current&&(cancelAnimationFrame(u.current),u.current=null),m(0))},onContextMenu:j,"data-node-id":e.id,children:[t.jsx(mv,{node:e,isSingleNodeSelected:H,isCollapsed:e.isCollapsed}),!e.isCollapsed&&t.jsx(Ev,{node:e}),e.isPinned&&t.jsx("div",{className:"pin-indicator-border absolute pointer-events-none rounded border-[3px] border-primary",style:{top:"-6px",left:"-6px",right:"-6px",bottom:"-6px",zIndex:1e3}}),(()=>{var ie;const F=e.data,D=F==null?void 0:F.nodeType,V=F==null?void 0:F.executionState,J=(ie=F==null?void 0:F.executionData)==null?void 0:ie.duration;return D&&V?t.jsx(Mv,{executionState:V,duration:J}):null})(),H&&t.jsx(dv,{node:e}),!e.isCollapsed&&t.jsxs("div",{id:`node-content-${e.id}`,className:"node-content relative w-full h-full overflow-visible flex","data-test":"node-content",children:[B(),(()=>{var J;const F=e.data,D=(F==null?void 0:F.nodeType)==="manualTrigger",V=(J=F==null?void 0:F.parameters)==null?void 0:J.label;return D?t.jsx("div",{className:"manual-trigger-button-container absolute bottom-2 left-2 right-2 px-2",children:t.jsx(Xd,{nodeId:e.id,label:V})}):null})()]}),!e.isCollapsed&&t.jsxs(t.Fragment,{children:[t.jsx(Bw,{node:e,isSelected:H,mode:x}),t.jsx($w,{node:e,isSelected:H,mode:x})]})]})})};function Wb(e,s){if(e.node===s.node&&e.isSelected===s.isSelected&&e.selectedNodesCount===s.selectedNodesCount&&e.useSimplifiedRendering===s.useSimplifiedRendering)return!0;if(s.node.type===fe.GROUP){const C=[];e.node!==s.node&&C.push("node ref"),e.node.x!==s.node.x&&C.push(`x: ${e.node.x} -> ${s.node.x}`),e.node.y!==s.node.y&&C.push(`y: ${e.node.y} -> ${s.node.y}`),e.isSelected!==s.isSelected&&C.push("isSelected"),e.selectedNodesCount!==s.selectedNodesCount&&C.push(`selectedNodesCount: ${e.selectedNodesCount} -> ${s.selectedNodesCount}`)}const n=e.node.x===s.node.x,o=e.node.y===s.node.y,r=n&&o,a=e.node.width===s.node.width,i=e.node.height===s.node.height,c=a&&i,l=e.isSelected===s.isSelected,d=e.node.content===s.node.content,h=e.node.title===s.node.title,u=e.node.type===s.node.type,f=e.node.isEditing===s.node.isEditing,m=e.node.styles===s.node.styles,y=e.node.tags,g=s.node.tags,x=Array.isArray(y),w=Array.isArray(g),v=y===g||!x&&!w||x&&w&&y.length===g.length&&y.every((C,I)=>C===g[I]),N=e.node.isPinned===s.node.isPinned,b=e.node.isCollapsed===s.node.isCollapsed,A=e.node.data===s.node.data,R=e.node.options===s.node.options,k=e.selectedNodesCount===s.selectedNodesCount,S=e.useSimplifiedRendering===s.useSimplifiedRendering;return!!(r&&c&&l&&d&&h&&u&&f&&m&&v&&N&&b&&A&&R&&k&&S)}const xa=He.memo(({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o})=>t.jsx(Lb,{node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o}),Wb),Hb=e=>{const{className:s,style:n}=e,o=$(y=>y.uiState.mode),r=$(y=>y.uiState.zoomSubMode),a=$(y=>y.uiState.writeSubMode),i=$(y=>y.uiState.messageSubMode),c=$(y=>y.uiState.drawSubMode),l=$(y=>y.uiState.activeGlobalOverlay),[d,h]=p.useState(null);p.useEffect(()=>{if(o!==ee.VIM){h(null);return}const y=()=>{const x=window.__vimContainer;if(!x)return null;try{const w=x.get(Cl),v=w==null?void 0:w.getVimCore(Kt.canvasVim),N=v==null?void 0:v.getVimState();return(N==null?void 0:N.mode)??null}catch{return null}};h(y());const g=setInterval(()=>{h(y())},100);return()=>clearInterval(g)},[o]);let u=o;o===ee.ZOOM&&r==="zoom:lock"?u="zoom:lock":o===ee.WRITE&&a===un.AUDIO?u="write:audio":o===ee.MESSAGE&&i===nn.AUTOFOCUS?u="message:autofocus":o===ee.DRAW?u=`draw: ${ot.getSubModeLabel(c??Pe.FREEHAND)}`:o===ee.VIM&&d&&(u=`vim: ${d.charAt(0)+d.slice(1).toLowerCase()}`);const m=(y=>!y||y===Ps.NONE?null:y.charAt(0).toUpperCase()+y.slice(1))(l);return t.jsxs("div",{className:`text-xs p-1 bg-background/50 rounded pointer-events-auto ${s}`,style:{...n},"data-test":"canvas-mode-info",children:[t.jsxs("div",{"data-test":"canvas-mode-info-mode",children:["Mode: ",u||"N/A"]}),m&&t.jsxs("div",{"data-test":"canvas-mode-info-overlay",className:"text-primary",children:["Overlay: ",m]})]})},Fb=e=>{const{className:s,style:n}=e,[o,r]=p.useState(1),[a,i]=p.useState([]);p.useEffect(()=>{const x=T.subscribe(N=>{const b=N.projectCanvas.getActive();b&&r(b.viewState.scale),i(N.uiState.zoomMarks||[])}),w=T.getState(),v=w.projectCanvas.getActive();return v&&r(v.viewState.scale),i(w.uiState.zoomMarks||[]),x},[]);const c=x=>{const w=x[0],v=T.getState(),N=v.projectCanvas.getActive();if(!N)return;const{scale:b,offset:A}=N.viewState,R=document.getElementById("CanvasAppV2");if(!R)return;const k=R.getBoundingClientRect(),S={x:k.width/2,y:k.height/2},E=Dt(S,b,A),C=S.x-E.x*w,I=S.y-E.y*w,O=isNaN(C)?0:C,H=isNaN(I)?0:I,L=isNaN(w)?1:w;v.setActiveCanvasViewState(W=>({...W,scale:L,offset:{x:O,y:H}}))},{min:l,max:d,marks:h}=Q.zoom,u=Math.round(o*100),f=Array.from(new Set([...h,...a])).sort((x,w)=>x-w),m=()=>{const x=Math.round(o*100)/100;T.getState().addZoomMark(x)},y=x=>{T.getState().removeZoomMark(x)},g=x=>a.includes(x);return t.jsxs("div",{"data-ui-panel":"zoom-slider","data-test":"canvas-zoom-slider",className:`flex flex-col gap-2 p-2 bg-background/50 rounded pointer-events-auto min-w-[200px] ${s}`,style:{...n},children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{children:"Zoom"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"font-mono",children:[u,"%"]}),t.jsx(se,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:m,title:"Save current zoom level","data-test":"canvas-zoom-save-button",children:t.jsx(Tt,{className:"h-3 w-3"})})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(cs,{value:[o],onValueChange:c,min:l,max:d,step:.01,className:"cursor-pointer","data-test":"canvas-zoom-slider"}),t.jsx("div",{className:"relative h-4 mt-1 px-3",children:f.map(x=>{const w=(x-l)/(d-l)*100,v=g(x);return t.jsxs("div",{className:"absolute flex flex-col items-center group",style:{left:`${w}%`,transform:"translateX(-50%)"},children:[t.jsxs("div",{className:"cursor-pointer hover:opacity-70 transition-opacity flex flex-col items-center",onClick:()=>c([x]),title:`Zoom to ${Math.round(x*100)}%`,children:[t.jsx("div",{className:`w-px h-2 ${v?"bg-primary/60":"bg-muted-foreground/40"}`}),t.jsx("span",{className:`text-[10px] mt-0.5 ${v?"text-primary":"text-muted-foreground"}`,children:x===1?"1×":`${x}×`})]}),v&&t.jsx("button",{className:"opacity-0 group-hover:opacity-100 absolute -top-2 right-0 h-3 w-3 rounded-full bg-destructive/80 hover:bg-destructive flex items-center justify-center transition-opacity",onClick:N=>{N.stopPropagation(),y(x)},title:"Remove mark","data-test":"canvas-zoom-remove-mark-button",children:t.jsx(Ke,{className:"h-2 w-2 text-destructive-foreground"})})]},x)})})]})]})},nr=({position:e,onMouseDown:s,onDoubleClick:n,variant:o="end",size:r=4,className:a})=>t.jsx("circle",{"data-test":"arrow-handle",cx:e.x,cy:e.y,r,fill:"hsl(var(--primary))",stroke:"hsl(var(--primary-foreground))",strokeWidth:1,onPointerDown:s,onDoubleClick:n,className:Me("cursor-move",a),style:{pointerEvents:"all",touchAction:"none"}}),Ec=Q.arrows.REVERSE_CURVE,Bb=(e,s)=>{const n=(e.x+s.x)/2,o=(e.y+s.y)/2,r=s.x-e.x,a=s.y-e.y,i=Math.sqrt(r*r+a*a);if(i===0)return{path:`M ${e.x} ${e.y}`,controlPoint:e};const c=-a/i,l=r/i;let d=i*.2;(!Ec&&e.x<s.x||Ec&&e.x>s.x)&&(d=-d);const h=n+c*d,u=o+l*d,f={x:h,y:u};return{path:`M ${e.x} ${e.y} Q ${h} ${u}, ${s.x} ${s.y}`,controlPoint:f}},zb=(e,s,n)=>{let o=s.x-e.x;const r=s.y-e.y,a=Math.sqrt(o*o+r*r),i=Math.max(20,a*.15);if(a===0)return{x:0,y:i};let c=-r,l=o;n||(o=-o),o<0&&(c=-c,l=-l);const d=c/a,h=l/a;return{x:d*i,y:h*i}},Mo=()=>{var s;const e=((s=T.getState().projectCanvas.getActive())==null?void 0:s.coreState.nodes)??[];return Qt.size>0?e.map(n=>{const o=Qt.get(n.id);return o?{...n,x:n.x+o.dx,y:n.y+o.dy}:n}):e},$b=(e,s,n,o,r)=>{Ot(T,x=>{var w,v;return(v=(w=x.preferences)==null?void 0:w.canvasConfig)==null?void 0:v.arrows});const a=e.type??Q.arrows.type,i=Q.arrows.REVERSE_CURVE,c=Q.arrows.CUBIC_HORIZONTAL_BIAS,l=-10,d=a==="TreeCubic"||a==="TreeLStep"||a==="TreeZShape",h=p.useMemo(()=>{const x=Mo(),w=x.find(A=>A.id===e.startNodeId),v=x.find(A=>A.id===e.endNodeId);if(d&&w&&v){const A=ct(w);return na(e.endNodeId,e.endPoint,A,x,l)}if((a==="Cubic"||a==="Orthogonal")&&w&&v){const A=ct(w);return rn(e.endNodeId,e.endPoint,A,x,l,c)}if(a==="Step"&&w&&v){const A=ct(w),R=ct(v),k=R.x-A.x,S=R.y-A.y,C=Math.abs(k)*c>=Math.abs(S)?.001:1e3;return rn(e.endNodeId,e.endPoint,A,x,l,C)}const N=w?gt(e.startNodeId,e.startPoint,e.endPoint,x,e.startRowId):e.startPoint;return v?gt(e.endNodeId,e.endPoint,N,x,e.endRowId):e.endPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,a,c,n,o,r]),u=p.useMemo(()=>{const x=Mo(),w=x.find(b=>b.id===e.startNodeId),v=x.find(b=>b.id===e.endNodeId);if(a==="TreeLStep"&&w)return ld(e.startNodeId,e.startPoint,x);if((a==="TreeCubic"||a==="TreeZShape")&&w&&v){const b=ct(v);return na(e.startNodeId,e.startPoint,b,x,0)}if((a==="Cubic"||a==="Step"||a==="Orthogonal")&&w&&v){const b=ct(v);return rn(e.startNodeId,e.startPoint,b,x,0,c)}const N=v?gt(e.endNodeId,e.endPoint,e.startPoint,x,e.endRowId):e.endPoint;return w?gt(e.startNodeId,e.startPoint,N,x,e.startRowId):e.startPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,a,c,n,o,r]),f=p.useMemo(()=>{const x=(u.x+h.x)/2,w=(u.y+h.y)/2;if(e.controlPointOffset)return{x:x+e.controlPointOffset.x,y:w+e.controlPointOffset.y};{const v=zb(u,h,i),N=h.x-u.x,b=h.y-u.y,A=N>0?x-v.x:x+v.x,R=b<0?w-v.y:w+v.y;return{x:A,y:R}}},[e.controlPointOffset,u,h,s,i]),m=p.useMemo(()=>{if(a!=="Cubic"&&a!=="TreeCubic")return null;const x=Mo(),w=x.find(A=>A.id===e.startNodeId),v=x.find(A=>A.id===e.endNodeId);let N="horizontal",b;if(w&&v){const A=ct(w),R=ct(v),k=R.x-A.x,S=R.y-A.y;a==="TreeCubic"?N="horizontal":N=Math.abs(k)*c>=Math.abs(S)?"horizontal":"vertical",b={dx:k,dy:S}}return Pf(u,h,N,b)},[u,h,a,e.startNodeId,e.endNodeId,c,n,o,r]),{path:y}=p.useMemo(()=>Bb(u,h),[u,h,s]),g=p.useMemo(()=>{if(!(a==="Step"||a==="Orthogonal"||a==="TreeLStep"||a==="TreeZShape"))return null;if(a==="TreeLStep")return[u,{x:u.x,y:h.y},h];if(a==="TreeZShape"){const A=(u.x+h.x)/2;return[u,{x:A,y:u.y},{x:A,y:h.y},h]}const w=Mo(),v=w.find(A=>A.id===e.startNodeId),N=w.find(A=>A.id===e.endNodeId);let b=!0;if(v&&N){const A=ct(v),R=ct(N),k=R.x-A.x,S=R.y-A.y;b=Math.abs(k)*c>=Math.abs(S)}if(a==="Step")return b?[u,{x:h.x,y:u.y},h]:[u,{x:u.x,y:h.y},h];{const A=(u.x+h.x)/2,R=(u.y+h.y)/2;return b?[u,{x:A,y:u.y},{x:A,y:h.y},h]:[u,{x:u.x,y:R},{x:h.x,y:R},h]}},[u,h,a,e.startNodeId,e.endNodeId,c,n,o,r]);return{actualStartPoint:u,actualEndPoint:h,bezierPath:y,controlPoint:f,cubicControlPoints:m,stepPoints:g,arrowType:a}},_b=(e,s,n,o,r)=>{const a=T.getState();a.scrollToArrow;const i=a.uiState.mode,c=a.projectCanvas.getActive(),l=(c==null?void 0:c.viewState.scale)??1,d=(c==null?void 0:c.coreState.nodes)??[],h=a.arrow.setAll,u=a.arrow.setSelected,f=a.setSelectedNodes,[m,y]=p.useState(null),[g,x]=p.useState(null),[w,v]=p.useState(null),N=p.useRef(null),b=p.useCallback((A,R)=>{i!==ee.SELECT||A.button!==0&&A.button!==-1||(A.stopPropagation(),y(R),x({x:A.clientX,y:A.clientY}),v({...e,startPoint:s,endPoint:n,controlPointOffset:o}),N.current=R==="start"?s:R==="end"?n:o,r||(f([]),u([e])))},[i,e,s,n,o,r,u,f]);return p.useEffect(()=>{const A=k=>{var j;if(!m||!g||!w)return;const S=k.clientX-g.x,E=k.clientY-g.y,C=S/l,I=E/l,O=m==="start"?w.startPoint:m==="end"?w.endPoint:w.controlPointOffset;let H={x:O.x+C,y:O.y+I};const L=oa(k.clientX,k.clientY);let W=null,P=null;if(L){W=L.nodeId,P=L.rowId;const M=m==="start"?w.endPoint:m==="end"?w.startPoint:w.controlPointOffset;H=gt(W,H,M,d,P)}else{const M=Go(H,d);if(M&&!(((j=M.data)==null?void 0:j.nodeType)==="workflowOrchestration")){W=M.id;const U=m==="start"?w.endPoint:m==="end"?w.startPoint:w.controlPointOffset;H=gt(W,H,U,d)}}N.current=H,h(M=>M.map(B=>{if(B.id===w.id){const U={...B};if(m==="start")U.startPoint=H,U.startNodeId=W,U.startRowId=P;else if(m==="end")U.endPoint=H,U.endNodeId=W,U.endRowId=P;else if(m==="control"){const z=B.startNodeId?gt(B.startNodeId,B.startPoint,B.endPoint,d,B.startRowId):B.startPoint,_=B.endNodeId?gt(B.endNodeId,B.endPoint,B.startPoint,d,B.endRowId):B.endPoint,G=(z.x+_.x)/2,F=(z.y+_.y)/2,D={x:H.x-G,y:H.y-F};U.controlPointOffset=D}return U}return B}))},R=k=>{var E;if(!m||!w)return;const S=N.current;if(S){const C=oa(k.clientX,k.clientY);let I=null,O=null;const H=m==="start"?w.endPoint:m==="end"?w.startPoint:w.controlPointOffset;let L;if(C)I=C.nodeId,O=C.rowId,L=gt(I,S,H,d,O);else{const W=Go(S,d);W?((E=W.data)==null?void 0:E.nodeType)==="workflowOrchestration"?L=S:(I=W.id,L=gt(I,S,H,d)):L=S}h(W=>W.map(P=>{if(P.id===w.id){const j={...P};return m==="start"?(j.startPoint=L,j.startNodeId=I,j.startRowId=O):m==="end"&&(j.endPoint=L,j.endNodeId=I,j.endRowId=O),j}return P}))}y(null),x(null),v(null),N.current=null};return m&&(window.addEventListener("pointermove",A),window.addEventListener("pointerup",R)),()=>{window.removeEventListener("pointermove",A),window.removeEventListener("pointerup",R)}},[m,g,w,l,h,d]),{handleMouseDownOnHandle:b}},Ub=(e,s,n)=>`M ${e.x} ${e.y} Q ${s.x} ${s.y} ${n.x} ${n.y}`,Vb=(e,s,n,o)=>`M ${e.x} ${e.y} C ${s.x} ${s.y} ${n.x} ${n.y} ${o.x} ${o.y}`,Gb=e=>{if(e.length<2)return"";const[s,...n]=e;return`M ${s.x} ${s.y} `+n.map(o=>`L ${o.x} ${o.y}`).join(" ")},jr=({startPoint:e,endPoint:s,controlPoint:n,cubicControlPoints:o,stepPoints:r,useCurvedArrows:a,stroke:i,strokeWidth:c,markerEndId:l,strokeDasharray:d,isHitbox:h=!1,onPointerDown:u})=>{const f={stroke:i,strokeWidth:c,fill:"none",strokeDasharray:d,markerEnd:!h&&l?`url(#${l})`:void 0,onPointerDown:u,style:{pointerEvents:"auto"}};if(r&&r.length>=2){const m=Gb(r);return t.jsx("path",{d:m,...f})}if(a&&o&&o.length===2){const[m,y]=o,g=Vb(e,m,y,s);return t.jsx("path",{d:g,...f})}if(a&&n){const m=Ub(e,n,s);return t.jsx("path",{d:m,...f})}return t.jsx("line",{x1:e.x,y1:e.y,x2:s.x,y2:s.y,...f})},Yb=({isSelected:e,label:s,labelPosition:n,labelInput:o,setLabelInput:r,onLabelChange:a,onLabelBlur:i,onLabelKeyDown:c})=>{const l=ke.FONT_SIZE_XXS,d=6,h=4,u=l*.6,m=s.length*u+2*d,y=l+2*h;return e?t.jsx("foreignObject",{x:n.x-50,y:n.y-15,width:"100",height:"30",style:{pointerEvents:"auto"},children:t.jsx(ze,{"data-test":"arrow-label-input",type:"text",value:o,onChange:a,onBlur:i,onKeyDown:c,onMouseDown:g=>g.stopPropagation(),placeholder:"Label",className:"w-full h-full text-[12px]! text-center p-0.5 bg-background border border-border rounded-sm focus:ring-1 focus:ring-ring focus:outline-none"})}):s?t.jsxs(t.Fragment,{children:[t.jsx("rect",{x:n.x-m/2,y:n.y-y/2,width:m,height:y,fill:"hsl(var(--background))",rx:"3",ry:"3",style:{pointerEvents:"none"}}),t.jsx("text",{x:n.x,y:n.y,fill:"hsl(var(--foreground))",fontSize:l,textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:s})]}):null},Xb=({markerId:e,strokeColor:s,markerOrientation:n})=>t.jsx("defs",{children:t.jsx("marker",{id:e,markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:n,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:s})})}),Kb=({arrow:e})=>{const s=$(z=>{var _,G;return((G=(_=z.projectCanvas.getActive())==null?void 0:_.coreState.selectedArrows)==null?void 0:G.some(F=>F.id===e.id))??!1}),n=$(z=>z.uiState.mode),{setSelectedNodes:o}=T.getState(),{setSelected:r,update:a}=T.getState().arrow;$(z=>{var _,G;return(G=(_=z.preferences)==null?void 0:_.canvasConfig)==null?void 0:G.arrows});const i=$(z=>{var G,F;const _=(F=(G=z.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:F.find(D=>D.id===e.startNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),c=$(z=>{var G,F;const _=(F=(G=z.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:F.find(D=>D.id===e.endNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),l=$(z=>z.uiState.dragVersion??0),{actualStartPoint:d,actualEndPoint:h,controlPoint:u,cubicControlPoints:f,stepPoints:m,arrowType:y}=$b(e,!0,i,c,l),g=y!=="Straight",{handleMouseDownOnHandle:x}=_b(e,d,h,u,s),w=z=>{var F;if(n!==ee.SELECT||z.button!==0&&z.button!==-1)return;z.stopPropagation();const _=((F=T.getState().projectCanvas.getActive())==null?void 0:F.coreState.selectedArrows)??[];if(z.ctrlKey||z.metaKey){r(s?_.filter(D=>D.id!==e.id):[..._,e]);return}if(z.shiftKey){s||r([..._,e]);return}o([]),r([e])},v=z=>{z.stopPropagation(),a(e.id,{controlPointOffset:null})},[N,b]=p.useState(e.label||""),A=p.useRef(null);p.useEffect(()=>{s&&A.current===null?A.current=e.label||"":s||(A.current=null)},[s,e.label]),p.useEffect(()=>{b(e.label||"")},[e.label]);const R=z=>{b(z.target.value),a(e.id,{label:z.target.value})},k=()=>{e.label!==N&&a(e.id,{label:N});const z=A.current;z!==null&&z!==N&&T.getState().undo.commit({type:"arrow:update",arrowId:e.id,from:{label:z},to:{label:N}})},S=z=>{z.key==="Enter"&&z.currentTarget.blur(),z.stopPropagation()},E=0,C=p.useMemo(()=>{if(g&&u){const z=(d.x+h.x)/2,_=(d.y+h.y)/2;return{x:z-(u.x-z),y:_-(u.y-_)+E}}return{x:(d.x+h.x)/2,y:(d.y+h.y)/2+E}},[d,h,u,g]),I=e.strokeColor??Q.arrows.styles.line,O=s&&!e.strokeColor?Q.arrows.styles.lineSelected:I,H=e.strokeWidth??1,L=s?H+.5:H,P=(z=>{switch(z){case"dashed":return"8,4";case"dotted":return"2,4";default:return}})(e.strokeStyle),j=s&&n===ee.SELECT,M=g?"auto-start-reverse":"auto",B=`arrowhead-${e.id}`,U=e.strokeColor??O;return t.jsxs("g",{"data-arrow-id":e.id,style:{cursor:n===ee.SELECT?"pointer":"default"},children:[t.jsx(Xb,{markerId:B,strokeColor:U,markerOrientation:M}),t.jsx(jr,{startPoint:d,endPoint:h,controlPoint:u,cubicControlPoints:f,stepPoints:m,useCurvedArrows:g,stroke:O,strokeWidth:L,strokeDasharray:P,markerEndId:B}),t.jsx(jr,{startPoint:d,endPoint:h,controlPoint:u,cubicControlPoints:f,stepPoints:m,useCurvedArrows:g,stroke:"transparent",strokeWidth:15,isHitbox:!0,onPointerDown:w}),j&&t.jsxs(t.Fragment,{children:[t.jsx(nr,{position:d,onMouseDown:z=>x(z,"start")}),t.jsx(nr,{position:h,onMouseDown:z=>x(z,"end")}),g&&u&&t.jsx(nr,{position:u,onMouseDown:z=>x(z,"control"),onDoubleClick:v,variant:"control"})]}),t.jsx(Yb,{isSelected:s,label:e.label||"",labelPosition:C,labelInput:N,setLabelInput:b,onLabelChange:R,onLabelBlur:k,onLabelKeyDown:S})]})};function qb(e,s){const n=e.arrow,o=s.arrow,r=n.startPoint.x===o.startPoint.x&&n.startPoint.y===o.startPoint.y,a=n.endPoint.x===o.endPoint.x&&n.endPoint.y===o.endPoint.y,i=n.label===o.label,c=n.type===o.type,l=n.controlPointOffset==null&&o.controlPointOffset==null||n.controlPointOffset!=null&&o.controlPointOffset!=null&&n.controlPointOffset.x===o.controlPointOffset.x&&n.controlPointOffset.y===o.controlPointOffset.y,d=n.strokeColor===o.strokeColor,h=n.strokeWidth===o.strokeWidth,u=n.strokeStyle===o.strokeStyle;return r&&a&&i&&c&&l&&d&&h&&u}const su=He.memo(Kb,qb),Zb=[{value:"solid",label:"Solid",dashArray:"none"},{value:"dashed",label:"Dashed",dashArray:"8,4"},{value:"dotted",label:"Dotted",dashArray:"2,4"}],Jb=({currentColor:e,currentWidth:s,currentStyle:n,onColorSelect:o,onWidthChange:r,onStyleChange:a})=>{const[i,c]=p.useState(e),[l,d]=p.useState(s),[h,u]=p.useState(n);p.useEffect(()=>{c(e)},[e]),p.useEffect(()=>{d(s)},[s]),p.useEffect(()=>{u(n)},[n]);const f=g=>{c(g),o(g)},m=g=>{const x=parseFloat(g.target.value);!isNaN(x)&&x>=.5&&x<=10&&(d(x),r(x))},y=g=>{u(g),a(g)};return t.jsxs("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"arrow-style-picker-content",children:[t.jsxs("div",{"data-test":"arrow-style-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:Ta.filter(g=>g.value!=="transparent").map(g=>t.jsx("button",{type:"button",title:g.name,onClick:()=>f(g.value),className:Ie("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",g.twClass,g.value===i?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",g.value==="#ffffff"&&"border-neutral-300"),style:g.value.startsWith("hsl(")?{backgroundColor:g.value}:{},"aria-label":`Select color ${g.name}`,"data-test":"arrow-color-option"},g.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?Ea(i):i.startsWith("#")?i:"#000000",onChange:g=>f(g.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"arrow-color-custom-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-width-section",children:[t.jsxs("label",{htmlFor:"arrow-stroke-width-input",className:"block text-xs text-muted-foreground font-medium mb-1",children:["Stroke Width: ",l,"px"]}),t.jsx("input",{type:"range",id:"arrow-stroke-width-input",value:l,onChange:m,min:"0.5",max:"10",step:"0.5",className:"w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer","data-test":"arrow-stroke-width-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-style-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Style"}),t.jsx("div",{className:"flex gap-2",children:Zb.map(g=>t.jsx("button",{type:"button",onClick:()=>y(g.value),className:Ie("flex-1 px-2 py-1.5 rounded border text-xs",h===g.value?"border-primary bg-primary/10":"border-muted hover:border-muted-foreground"),title:g.label,"data-test":"arrow-style-option",children:t.jsx("svg",{width:"100%",height:"12",viewBox:"0 0 40 12",className:"stroke-current",children:t.jsx("line",{x1:"2",y1:"6",x2:"38",y2:"6",strokeWidth:"2",strokeDasharray:g.dashArray,fill:"none"})})},g.value))})]})]})},Qb=[],eN=({className:e})=>{const[s,n]=p.useState(!1),o=$(A=>{var R;return((R=A.projectCanvas.getActive())==null?void 0:R.coreState.selectedArrows)??Qb}),r=$(A=>A.arrow.update),a=o.length>0?o[0]:null,[i,c]=p.useState((a==null?void 0:a.strokeColor)??"hsl(var(--muted-light))"),[l,d]=p.useState((a==null?void 0:a.strokeWidth)??1),[h,u]=p.useState((a==null?void 0:a.strokeStyle)??"solid"),f=T.getState().getLastUsedArrowStyle();p.useEffect(()=>{a?(c(a.strokeColor??"hsl(var(--muted-light))"),d(a.strokeWidth??1),u(a.strokeStyle??"solid")):(c("hsl(var(--muted-light))"),d(1),u("solid"))},[a]);const m=(A,R,k)=>{o.forEach(S=>{r(S.id,{strokeColor:A,strokeWidth:R,strokeStyle:k})})},y=()=>{m(f.lastUsedColor,f.lastUsedWidth,f.lastUsedStyle)},g=A=>{m(A,l,h),c(A),T.getState().setLastUsedArrowStyle(A,l,h),T.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},x=A=>{m(i,A,h),d(A),T.getState().setLastUsedArrowStyle(i,A,h),T.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},w=A=>{m(i,l,A),u(A),T.getState().setLastUsedArrowStyle(i,l,A),T.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},v=()=>{c("hsl(var(--muted-light))"),d(1),u("solid"),m(void 0,void 0,void 0)},N=[{label:"Apply last used style",icon:t.jsx("span",{style:{color:f.lastUsedColor,display:"inline-flex"},children:t.jsx(yi,{className:"h-2.5 w-2.5"})}),onClick:y,disabled:o.length===0},{label:"Set Arrow Style",icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(Fl,{className:"h-2.5 w-2.5"})}),onClick:()=>{n(!0)},disabled:o.length===0},{label:"Reset Style",icon:t.jsx(mo,{className:"h-2.5 w-2.5"}),onClick:v,disabled:o.length===0}],b={...N[0],icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(yi,{className:"h-2.5 w-2.5"})})};return t.jsxs(St,{open:s,onOpenChange:n,children:[t.jsx(Ct,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"arrow-style-picker-button",children:t.jsx(rt,{mainAction:b,dropdownActions:N,variant:"outline",size:"compact",persistenceKey:"arrow-style-picker",className:e})})}),t.jsx(jt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:A=>A.preventDefault(),"data-test":"arrow-style-picker-popover",children:t.jsx(Jb,{currentColor:i,currentWidth:l,currentStyle:h,onColorSelect:g,onWidthChange:x,onStyleChange:w})})]})},Rc=[],tN=[],sN=()=>{const e=$(d=>d.setSelectedNodes),s=$(d=>{var h;return((h=d.projectCanvas.getActive())==null?void 0:h.coreState.selectedNodes)??Rc}),n=$(d=>{var h;return((h=d.projectCanvas.getActive())==null?void 0:h.coreState.selectedArrows)??tN});$(d=>{var h;return((h=d.projectCanvas.getActive())==null?void 0:h.coreState.nodes)??Rc});const o=s.length>0,r=p.useMemo(()=>{const d=new Set;return n.forEach(h=>{h.startNodeId&&d.add(h.startNodeId),h.endNodeId&&d.add(h.endNodeId)}),d},[n]),a=p.useCallback(()=>{const h=T.getState().projectCanvas.getActive();if(!h)return;const u=h.coreState.selectedArrows??[],f=h.coreState.nodes??[],m=new Set;u.forEach(g=>{g.startNodeId&&m.add(g.startNodeId),g.endNodeId&&m.add(g.endNodeId)});const y=f.filter(g=>m.has(g.id));e(y)},[e]),i=p.useCallback(()=>{e([])},[e]),c=[{label:"Select connected nodes",icon:t.jsx(wi,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0},{label:"Deselect all nodes",icon:t.jsx(Ke,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!o}],l=o?{label:"Deselect all nodes",icon:t.jsx(Ke,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!1}:{label:"Select connected nodes",icon:t.jsx(wi,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0};return t.jsx(rt,{mainAction:l,dropdownActions:c,variant:"outline",size:"compact",persistenceKey:"arrow-connected-nodes","data-test":"arrow-connected-nodes-button"})},nN=({arrows:e})=>{const s=p.useCallback(()=>{T.getState().deleteSelectedArrows()},[]);return t.jsxs("div",{className:Me("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:We.nodeQuickPanel},"data-test":"arrow-quick-panel-container","data-arrow-ids":e.map(n=>n.id).join(","),children:[t.jsx(eN,{}),t.jsx(zd,{}),t.jsx(sN,{}),t.jsx(se,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:s,title:"Delete selected arrows","data-test":"arrow-delete-button",children:t.jsx(Nt,{className:"h-3.5 w-3.5"})})]})},Po=30,oN=[],aN=()=>{var d;const[e,s]=p.useState({top:0,left:0}),n=p.useRef(null),o=$(h=>{var u,f;return(((f=(u=h.projectCanvas.getActive())==null?void 0:u.coreState.selectedArrows)==null?void 0:f.length)??0)>0}),r=$(h=>h.uiState.mode),a=$(h=>{var u;return(u=h.projectCanvas.getActive())==null?void 0:u.viewState}),i=o,c=r===ee.DRAW_ARROW;if(p.useEffect(()=>{if(!i||!a)return;const h=()=>{var H,L,W,P;const f=((H=T.getState().projectCanvas.getActive())==null?void 0:H.coreState.selectedArrows)??[],m=((L=T.getState().projectCanvas.getActive())==null?void 0:L.coreState.nodes)??[];if(f.length===0)return;let y=0,g=0,x=0,w=0,v=0;if(f.forEach(j=>{const M=document.querySelector(`[data-arrow-id="${j.id}"]`);if(!M)return;const B=M.getBoundingClientRect(),U=B.left+B.width/2,z=B.top+B.height/2,{actualStartPoint:_,actualEndPoint:G}=dd(j,m),F=G.x-_.x,D=G.y-_.y;y+=U,g+=z,x+=F,w+=D,v++}),v===0)return;const N=y/v,b=g/v,A=Math.abs(w)>Math.abs(x),R=((W=n.current)==null?void 0:W.offsetHeight)||40,k=((P=n.current)==null?void 0:P.offsetWidth)||100,S=window.innerWidth,E=window.innerHeight,C=20;let I,O;if(A){const j=N-k-Po,M=N+Po,B=j>=C,U=M+k<=S-C;O=B?j:U?M:C,I=b-R/2}else{const j=b-R-Po,M=b+Po,B=j>=C,U=M+R<=E-C;I=B?j:U?M:C,O=N-k/2}I=Math.max(C,Math.min(I,E-R-C)),O=Math.max(C,Math.min(O,S-k-C)),s({top:I,left:O})};h();const u=setTimeout(h,100);return window.addEventListener("scroll",h,!0),window.addEventListener("resize",h),()=>{clearTimeout(u),window.removeEventListener("scroll",h,!0),window.removeEventListener("resize",h)}},[i,a]),!i||c)return null;const l=((d=T.getState().projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??oN;return Cs.createPortal(t.jsx("div",{ref:n,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:We.quickPanelPortal},onPointerDown:h=>h.stopPropagation(),onTouchStart:h=>h.stopPropagation(),onWheel:h=>h.stopPropagation(),"data-test":"arrow-quick-panel-portal",children:t.jsx(nN,{arrows:l})}),document.body)},rN=({currentColor:e,onColorSelect:s})=>{const[n,o]=p.useState(e);p.useEffect(()=>{o(e)},[e]);const r=a=>{o(a),s(a)};return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"group-background-picker-content",children:t.jsxs("div",{"data-test":"group-background-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Background Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:Ta.map(a=>t.jsx("button",{type:"button",title:a.name,onClick:()=>r(a.value),className:Ie("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",a.twClass,a.value===n?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",a.value==="#ffffff"&&"border-neutral-300",a.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:a.value.startsWith("hsl(")?{backgroundColor:a.value}:{},"aria-label":`Select color ${a.name}`,"data-test":"group-background-color-option"},a.value))}),t.jsx("input",{type:"color",value:n.startsWith("hsl")?Ea(n):n.startsWith("#")?n:"#000000",onChange:a=>r(a.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"group-background-color-custom-input"})]})})},Mn="hsl(var(--background))",Mc=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),iN=({groups:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=T.getState().updateNode,a=e,i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.styles)==null?void 0:v.backgroundColor)??Mn),[h,u]=p.useState(Mn);p.useEffect(()=>{var N;d(c?((N=c.styles)==null?void 0:N.backgroundColor)??Mn:Mn)},[c]);const f=N=>{a.forEach(b=>{const A=b.data,R={...A,childNodeIds:(A==null?void 0:A.childNodeIds)??[],styles:{...A==null?void 0:A.styles,backgroundColor:N}};r(b.id,{data:R})})},m=()=>{f(h)},y=N=>{f(N),d(N),u(N),T.getState().setSegmentedButtonAction("group-background-picker","Apply last used style")},g=()=>{d(Mn),f(void 0)},x=[{label:"Apply last used style",icon:t.jsx(Mc,{color:h}),onClick:m,disabled:a.length===0},{label:"Set Background Color",icon:t.jsx(Mc,{color:l}),onClick:()=>{o(!0)},disabled:a.length===0},{label:"Reset Style",icon:t.jsx(mo,{className:"h-2.5 w-2.5"}),onClick:g,disabled:a.length===0}],w={...x[0]};return t.jsxs(St,{open:n,onOpenChange:o,children:[t.jsx(Ct,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"group-background-picker-button",children:t.jsx(rt,{mainAction:w,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"group-background-picker",className:s})})}),t.jsx(jt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"group-background-picker-popover",children:t.jsx(rN,{currentColor:l,onColorSelect:y})})]})},cN=({groups:e})=>t.jsx("div",{className:Me("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:We.nodeQuickPanel},"data-test":"group-quick-panel-container","data-group-ids":e.map(s=>s.id).join(","),children:t.jsx(iN,{groups:e})}),Pc=10,lN=100,dN=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(ee.SELECT),l=p.useRef(null),d=p.useRef(""),h=p.useRef(!1),u=p.useRef(ee.SELECT);p.useEffect(()=>{const g=()=>{var k;const w=T.getState(),v=(k=w.projectCanvas.getActive())==null?void 0:k.coreState.selectedNodes,N=!!w.uiState.dragInfo,b=w.uiState.mode;if(N!==h.current&&(h.current=N,a(N)),b!==u.current&&(u.current=b??ee.SELECT,c(b??ee.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let A="";const R=[];for(const S of v)S.type===fe.GROUP&&(A+=(A?",":"")+S.id,R.push(S));A!==d.current&&(d.current=A,o(R))};g();const x=setInterval(g,lN);return()=>clearInterval(x)},[]);const f=n.length>=1&&!r,m=i===ee.DRAW_ARROW,y=He.useMemo(()=>n.map(g=>g.id),[n]);return p.useEffect(()=>{if(!f||y.length===0)return;const g=()=>{var H,L;let w=0,v=0,N=0;if(y.forEach(W=>{const P=document.querySelector(`[data-node-id="${W}"]`);if(!P)return;const j=P.getBoundingClientRect(),M=j.left+j.width/2,B=j.top;w+=M,v+=B,N++}),N===0)return;const b=w/N,A=v/N,R=((H=l.current)==null?void 0:H.offsetHeight)||40,k=((L=l.current)==null?void 0:L.offsetWidth)||100,S=window.innerWidth,E=window.innerHeight,C=20;let I=A-R-Pc,O=b-k/2;if(I<C){let W=0;y.forEach(P=>{const j=document.querySelector(`[data-node-id="${P}"]`);if(j){const M=j.getBoundingClientRect();W=Math.max(W,M.bottom)}}),I=W+Pc}I=Math.max(C,Math.min(I,E-R-C)),O=Math.max(C,Math.min(O,S-k-C)),s({top:I,left:O})};g();const x=setTimeout(g,100);return()=>{clearTimeout(x)}},[f,y]),!f||y.length===0||m?null:Cs.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:We.popover},onPointerDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),onWheel:g=>g.stopPropagation(),"data-test":"group-quick-panel-portal",children:t.jsx(cN,{groups:n})}),document.body)},uN=He.memo(dN),qr=({label:e,currentColor:s,onColorSelect:n})=>{const[o,r]=p.useState(s);p.useEffect(()=>{r(s)},[s]);const a=c=>{r(c),n(c)},i=s==="currentColor"?"hsl(var(--foreground))":s;return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"draw-color-picker-content",children:t.jsxs("div",{"data-test":"draw-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:e}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:Ta.map(c=>t.jsx("button",{type:"button",title:c.name,onClick:()=>a(c.value),className:Ie("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",c.twClass,c.value===o?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",c.value==="#ffffff"&&"border-neutral-300",c.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:c.value.startsWith("hsl(")?{backgroundColor:c.value}:{},"aria-label":`Select color ${c.name}`,"data-test":"draw-color-option"},c.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?Ea(i):i.startsWith("#")?i:"#000000",onChange:c=>a(c.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"draw-color-custom-input"})]})})},Qs="currentColor";let Dc=Qs;const Oc=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-color-swatch-icon",children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e==="currentColor"?"hsl(var(--foreground))":e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),hN=({drawings:e,className:s})=>{var w;const[n,o]=p.useState(!1),r=T.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((w=i==null?void 0:i.style)==null?void 0:w.strokeColor)??Qs),[d,h]=p.useState(Dc);p.useEffect(()=>{var v;l(i?((v=i.style)==null?void 0:v.strokeColor)??Qs:Qs)},[i]);const u=v=>{e.forEach(N=>{const b=N.data;if(!b)return;if(b.elements&&b.elements.length>0){const R=b.elements.map(k=>({...k,style:{...k.style,strokeColor:v}}));r(N.id,{data:{...b,elements:R}});return}const A={...b,drawType:(b==null?void 0:b.drawType)??"freehand",style:{...Ft,...b==null?void 0:b.style,strokeColor:v}};r(N.id,{data:A})})},f=()=>{u(d)},m=v=>{u(v),l(v),h(v),Dc=v,T.getState().setSegmentedButtonAction("draw-stroke-color","Apply last used color")},y=()=>{l(Qs),u(Qs)},g=[{label:"Apply last used color",icon:t.jsx(Oc,{color:d}),onClick:f,disabled:e.length===0},{label:"Set Stroke Color",icon:t.jsx(Oc,{color:c}),onClick:()=>o(!0),disabled:e.length===0},{label:"Reset Color",icon:t.jsx(mo,{className:"h-2.5 w-2.5"}),onClick:y,disabled:e.length===0}],x={...g[0]};return t.jsxs(St,{open:n,onOpenChange:o,children:[t.jsx(Ct,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-color-button",children:t.jsx(rt,{mainAction:x,dropdownActions:g,variant:"outline",size:"compact",persistenceKey:"draw-stroke-color",className:s})})}),t.jsx(jt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:v=>v.preventDefault(),"data-test":"draw-stroke-color-popover",children:t.jsx(qr,{label:"Stroke Color",currentColor:c,onColorSelect:m})})]})},pN=[1,2,3,4,5,6,8,10];let Lc=Ft.strokeWidth;const gN=({width:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-width-icon",children:t.jsx("span",{style:{width:"12px",height:`${Math.min(e,6)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})}),fN=({drawings:e,className:s})=>{var x;const[n,o]=p.useState(!1),r=T.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((x=i==null?void 0:i.style)==null?void 0:x.strokeWidth)??Ft.strokeWidth),[d,h]=p.useState(Lc);p.useEffect(()=>{var w;l(i?((w=i.style)==null?void 0:w.strokeWidth)??Ft.strokeWidth:Ft.strokeWidth)},[i]);const u=w=>{e.forEach(v=>{const N=v.data;if(!N)return;if(N.elements&&N.elements.length>0){const A=N.elements.map(R=>({...R,style:{...R.style,strokeWidth:w}}));r(v.id,{data:{...N,elements:A}});return}const b={...N,drawType:(N==null?void 0:N.drawType)??"freehand",style:{...Ft,...N==null?void 0:N.style,strokeWidth:w}};r(v.id,{data:b})})},f=()=>{u(d)},m=w=>{u(w),l(w),h(w),Lc=w,o(!1),T.getState().setSegmentedButtonAction("draw-stroke-width","Apply last used width")},y=[{label:"Apply last used width",icon:t.jsx(gN,{width:d}),onClick:f,disabled:e.length===0},{label:"Set Stroke Width",icon:t.jsx(Sa,{className:"h-2.5 w-2.5"}),onClick:()=>o(!0),disabled:e.length===0}],g={...y[0]};return t.jsxs(St,{open:n,onOpenChange:o,children:[t.jsx(Ct,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-width-button",children:t.jsx(rt,{mainAction:g,dropdownActions:y,variant:"outline",size:"compact",persistenceKey:"draw-stroke-width",className:s})})}),t.jsx(jt,{className:"w-auto p-3",sideOffset:5,onCloseAutoFocus:w=>w.preventDefault(),"data-test":"draw-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1",children:pN.map(w=>t.jsx("button",{type:"button",title:`${w}px`,onClick:()=>m(w),className:`w-8 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${c===w?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-stroke-width-option",children:t.jsx("span",{style:{width:"16px",height:`${Math.min(w,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})},w))}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Current: ",c,"px"]})]})})]})},mN=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}];let Wc=Ft.strokeStyle;const Hc=({style:e,className:s})=>{const n=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-style-icon",children:t.jsx("svg",{width:"14",height:"6",viewBox:"0 0 14 6",children:t.jsx("line",{x1:"0",y1:"3",x2:"14",y2:"3",stroke:"currentColor",strokeWidth:"2",strokeDasharray:n,strokeLinecap:"round"})})})},xN=({drawings:e,className:s})=>{var m;const n=T.getState().updateNode,o=e.length>0?e[0]:null,r=o==null?void 0:o.data,[a,i]=p.useState(((m=r==null?void 0:r.style)==null?void 0:m.strokeStyle)??Ft.strokeStyle),[c,l]=p.useState(Wc);p.useEffect(()=>{var y;i(r?((y=r.style)==null?void 0:y.strokeStyle)??Ft.strokeStyle:Ft.strokeStyle)},[r]);const d=y=>{e.forEach(g=>{const x=g.data;if(!x)return;if(x.elements&&x.elements.length>0){const v=x.elements.map(N=>({...N,style:{...N.style,strokeStyle:y}}));n(g.id,{data:{...x,elements:v}});return}const w={...x,drawType:(x==null?void 0:x.drawType)??"freehand",style:{...Ft,...x==null?void 0:x.style,strokeStyle:y}};n(g.id,{data:w})}),i(y),l(y),Wc=y},h=()=>{d(c)},u=[{label:"Apply last used style",icon:t.jsx(Hc,{style:c}),onClick:h,disabled:e.length===0},...mN.map(y=>({label:y.label,icon:t.jsx(Hc,{style:y.value}),onClick:()=>{d(y.value),T.getState().setSegmentedButtonAction("draw-stroke-style",y.label)},disabled:e.length===0,selected:a===y.value}))],f={...u[0]};return t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-style-button",children:t.jsx(rt,{mainAction:f,dropdownActions:u,variant:"outline",size:"compact",persistenceKey:"draw-stroke-style",className:s})})},en="transparent";let Fc=en;const Bc=({color:e,className:s})=>{const n=e&&e!=="transparent"?e:void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"fill-color-swatch-icon",children:n?t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:n,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}}):t.jsx(Ca,{className:"h-2.5 w-2.5"})})},yN=({drawings:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=T.getState().updateNode,a=e.filter(N=>{const b=N.data;return b?b.elements&&b.elements.length>0?b.elements.some(A=>A.type==="shape"):b.drawType==="shape":!1}),i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.style)==null?void 0:v.fillColor)??en),[h,u]=p.useState(Fc);p.useEffect(()=>{var N;d(c?((N=c.style)==null?void 0:N.fillColor)??en:en)},[c]);const f=N=>{const b=N===en?void 0:N;a.forEach(A=>{const R=A.data;if(!R)return;if(R.elements&&R.elements.length>0){const S=R.elements.map(E=>E.type==="shape"?{...E,style:{...E.style,fillColor:b}}:E);r(A.id,{data:{...R,elements:S}});return}const k={...R,drawType:(R==null?void 0:R.drawType)??"shape",style:{...Ft,...R==null?void 0:R.style,fillColor:b}};r(A.id,{data:k})})},m=()=>{f(h)},y=N=>{f(N),d(N),u(N),Fc=N,T.getState().setSegmentedButtonAction("draw-fill-color","Apply last used fill")},g=()=>{d(en),f(void 0)},x=[{label:"Apply last used fill",icon:t.jsx(Bc,{color:h}),onClick:m,disabled:a.length===0},{label:"Set Fill Color",icon:t.jsx(Bc,{color:l}),onClick:()=>o(!0),disabled:a.length===0},{label:"Remove Fill",icon:t.jsx(mo,{className:"h-2.5 w-2.5"}),onClick:g,disabled:a.length===0}],w={...x[0]};return a.length===0?null:t.jsxs(St,{open:n,onOpenChange:o,children:[t.jsx(Ct,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-fill-color-button",children:t.jsx(rt,{mainAction:w,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"draw-fill-color",className:s})})}),t.jsx(jt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"draw-fill-color-popover",children:t.jsx(qr,{label:"Fill Color",currentColor:l,onColorSelect:y})})]})},wN=({drawings:e,className:s})=>{const n=()=>{const r=T.getState().setSelectedNodes,a=T.getState().duplicateNodes;r(e),a()},o=e.length===0;return t.jsx(es,{delayDuration:300,children:t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-duplicate-tooltip-wrapper",children:t.jsx(se,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-duplicate-button",children:t.jsx(Bt,{className:"h-3.5 w-3.5"})})})}),t.jsx(Vt,{children:t.jsxs("p",{children:["Duplicate ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},vN=({drawings:e,className:s})=>{const n=()=>{const r=T.getState().deleteNodeById;e.forEach(a=>{r(a.id)})},o=e.length===0;return t.jsx(es,{delayDuration:300,children:t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-delete-tooltip-wrapper",children:t.jsx(se,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-delete-button",children:t.jsx(Nt,{className:"h-3.5 w-3.5"})})})}),t.jsx(Vt,{children:t.jsxs("p",{children:["Delete ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},qt=[100,90,80,70,60,50,40,30,20,10],nu=e=>(e==null?void 0:e._compressionLevel)??100,bN=e=>{const s=qt.indexOf(e);if(s===-1||s>=qt.length-1){for(let n=0;n<qt.length;n++)if(qt[n]<e)return qt[n];return qt[qt.length-1]}return qt[s+1]},NN=({drawings:e})=>{var r;const s=nu((r=e[0])==null?void 0:r.data),n=s>qt[qt.length-1],o=()=>{for(const a of e){const i=a.data;if(!i)continue;const c=i._original??{...i,_original:void 0,_compressionLevel:void 0},l=bN(s),d=td(c,l);T.getState().updateNode(a.id,{data:{...d,_original:c,_compressionLevel:l}})}};return t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-compress-button",children:t.jsx(Qo,{className:"h-4 w-4"})})}),t.jsx(Vt,{children:t.jsx("p",{children:"Compress drawing (reduce quality)"})})]})},SN=({drawings:e})=>{var r;const s=(r=e[0])==null?void 0:r.data,n=!!(s!=null&&s._original),o=()=>{for(const a of e){const i=a.data;if(!(i!=null&&i._original))continue;const{_original:c,_compressionLevel:l,...d}=i._original;T.getState().updateNode(a.id,{data:d})}};return t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-restore-button",children:t.jsx(no,{className:"h-4 w-4"})})}),t.jsx(Vt,{children:t.jsx("p",{children:"Restore original quality"})})]})},CN=({drawings:e})=>{var n;const s=nu((n=e[0])==null?void 0:n.data);return t.jsxs("span",{className:Me("text-xs px-1 tabular-nums",s===100?"text-muted-foreground":"text-orange-500 font-medium"),"data-test":"draw-compression-level",title:"Current compression level (% of original quality)",children:[s,"%"]})},jN=e=>{if(!e)return 0;if(e._original)return JSON.stringify(e._original).length;const{_original:s,_compressionLevel:n,...o}=e;return JSON.stringify(o).length},kN=e=>{if(!e)return 0;const{_original:s,...n}=e;return JSON.stringify(n).length},zc=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`;let $c=[],Pn=[];const IN=({drawings:e})=>{e.map(i=>i.id).join(",");const s=p.useSyncExternalStore(T.subscribe,()=>{var u;const i=(u=T.getState().projectCanvas.getActive())==null?void 0:u.coreState.nodes;if(!i)return Pn;const c=e.map(f=>f.id),l=i.filter(f=>c.includes(f.id)),d=c.join(","),h=l.some((f,m)=>{const y=Pn[m];return!y||y.id!==f.id||y.data!==f.data})||l.length!==Pn.length;return(d!==$c.join(",")||h)&&($c=c,Pn=l),Pn}),n=s.length>0?s:e,{currentSize:o,originalSize:r}=p.useMemo(()=>{let i=0,c=0;for(const l of n)l.data&&(i+=kN(l.data),c+=jN(l.data));return{currentSize:i,originalSize:c}},[n]),a=o<r;return t.jsxs($d,{className:"gap-0.5 p-0.5",dataTest:"draw-quick-panel-container",dataAttributes:{"drawing-ids":e.map(i=>i.id).join(",")},children:[t.jsx(hN,{drawings:e}),t.jsx(fN,{drawings:e}),t.jsx(xN,{drawings:e}),t.jsx(yN,{drawings:e}),t.jsx(pi,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(wN,{drawings:e}),t.jsx(vN,{drawings:e}),t.jsx(pi,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(NN,{drawings:n}),t.jsx(SN,{drawings:n}),t.jsx(CN,{drawings:n}),t.jsxs("span",{className:Me("text-xs px-1.5 ml-1 tabular-nums",o>500*1024?"text-red-500 font-medium":"text-muted-foreground"),"data-test":"draw-size-indicator",title:`Current: ${o.toLocaleString()} bytes${a?` | Original: ${r.toLocaleString()} bytes`:""}`,children:[zc(o),a&&t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",zc(r),")"]})]})]})},AN=100,TN=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(ee.SELECT),l=p.useRef(null),d=p.useRef(""),h=p.useRef(!1),u=p.useRef(ee.SELECT);p.useEffect(()=>{const g=()=>{var k;const w=T.getState(),v=(k=w.projectCanvas.getActive())==null?void 0:k.coreState.selectedNodes,N=!!w.uiState.dragInfo,b=w.uiState.mode;if(N!==h.current&&(h.current=N,a(N)),b!==u.current&&(u.current=b??ee.SELECT,c(b??ee.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let A="";const R=[];for(const S of v)S.type===fe.DRAWING&&(A+=(A?",":"")+S.id,R.push(S));A!==d.current&&(d.current=A,o(R))};g();const x=setInterval(g,AN);return()=>clearInterval(x)},[]);const f=n.length>=1&&!r,m=i===ee.DRAW_ARROW,y=He.useMemo(()=>n.map(g=>g.id),[n]);return p.useEffect(()=>{if(!f||y.length===0)return;const g=()=>{var L,W;let w=0,v=0,N=0;if(y.forEach(P=>{const j=document.querySelector(`[data-node-id="${P}"]`);if(!j)return;const M=j.getBoundingClientRect(),B=M.left+M.width/2,U=M.top;w+=B,v+=U,N++}),N===0)return;const b=w/N,A=v/N,R=((L=l.current)==null?void 0:L.offsetHeight)||40,k=((W=l.current)==null?void 0:W.offsetWidth)||100,S=window.innerWidth,E=window.innerHeight,C=20,I=Q.nodeUI.quickPanelGap;let O=A-R-I,H=b-k/2;if(O<C){let P=0;y.forEach(j=>{const M=document.querySelector(`[data-node-id="${j}"]`);if(M){const B=M.getBoundingClientRect();P=Math.max(P,B.bottom)}}),O=P+I}O=Math.max(C,Math.min(O,E-R-C)),H=Math.max(C,Math.min(H,S-k-C)),s({top:O,left:H})};g();const x=setTimeout(g,100);return()=>{clearTimeout(x)}},[f,y]),!f||y.length===0||m?null:Cs.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:We.popover},onPointerDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),onWheel:g=>g.stopPropagation(),"data-test":"draw-quick-panel-portal",children:t.jsx(IN,{drawings:n})}),document.body)},EN=He.memo(TN),RN=e=>{const s=t.jsx(ts,{className:"h-3 w-3"}),n=e.startNodeId?`Node ${e.startNodeId.substring(0,4)}`:`(${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)})`,o=e.endNodeId?`Node ${e.endNodeId.substring(0,4)}`:`(${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)})`,r=`${n} -> ${o}`,a=e.id.substring(0,6),i=`S: [${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)}]`,c=`E: [${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"arrow-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"arrow-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"arrow-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"arrow-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"arrow-display-text",children:r})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"arrow-display-id",children:a})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full flex justify-between pr-1","data-test":"arrow-display-coords",children:[t.jsx("span",{"data-test":"arrow-display-start-coords",children:i}),t.jsx("span",{"data-test":"arrow-display-end-coords",children:c})]})]})},MN=(e,s)=>s.length!==1?-1:e.findIndex(n=>n.id===s[0].id),PN=e=>{const{className:s,style:n}=e,o=T.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.arrows)??[],i=(r==null?void 0:r.coreState.selectedArrows)??[],c=o.arrow.setSelected,l=o.scrollToArrow,d=p.useCallback((f,m)=>{const y=f.length>0?f[0]:-1;if(y>=0&&y<a.length){const g=a[y];c([g]),l(g),console.log("Selected arrow from list:",g.id)}else c([])},[a,c]),h=MN(a,i),u=h!==-1?[h]:[];return t.jsx("div",{"data-test":"canvas-arrow-infos-container",className:Me("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:f=>f.stopPropagation(),children:t.jsx(Rr,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-arrow-infos-header",children:"Arrows"}),itemList:a.map(RN),onSelectionChange:d,selectedIndices:u,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0})})},DN=()=>{const e=$(i=>i.uiState.temporaryArrow),s=$(i=>{var c;return((c=i.uiState)==null?void 0:c.useCurvedArrows)??!1}),{startPoint:n,endPoint:o}=e??{};if(!n||!o)return null;const r=s?"auto-start-reverse":"auto",a="temporary-arrowhead";return t.jsxs("g",{children:[t.jsx("defs",{children:t.jsx("marker",{id:a,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:r,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"grey"})})}),t.jsx(jr,{startPoint:n,endPoint:o,useCurvedArrows:s,stroke:"grey",strokeWidth:1,strokeDasharray:"4 2",markerEndId:a})]})},_c=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},ON=()=>{const e=$(i=>i.uiState.temporaryDrawing??null);if(!e)return null;const{subMode:s,points:n,startPoint:o,endPoint:r,style:a}=e;if(s===Pe.FREEHAND&&n.length>0){const i=ot.smoothToSVGPath(n),c=_c(a),l=a.opacity??1,d=l<1;return t.jsx("g",{"data-test":"temporary-drawing-freehand",children:t.jsx("path",{d:i,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:c,strokeOpacity:l,fill:"none",strokeLinecap:d?"butt":"round",strokeLinejoin:d?"bevel":"round"})})}if(o&&r){const c={[Pe.RECTANGLE]:"rectangle",[Pe.SQUARE]:"square",[Pe.CIRCLE]:"circle",[Pe.ELLIPSE]:"ellipse",[Pe.LINE]:"line",[Pe.ARROW]:"arrow",[Pe.FREEHAND]:"line"}[s],l=ot.generateShapeSVGPath({shapeType:c,startPoint:o,endPoint:r}),d=_c(a),h=a.opacity??1;return t.jsx("g",{"data-test":"temporary-drawing-shape",children:t.jsx("path",{d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:d,strokeOpacity:h,fill:a.fillColor?`${a.fillColor}40`:"none",strokeLinecap:"round",strokeLinejoin:"round"})})}return null},LN=30,WN=()=>{const[e,s]=p.useState(0),n=p.useRef(0),o=p.useRef(performance.now());return p.useEffect(()=>{let r=!0;function a(){n.current+=1;const i=performance.now();if(i-o.current>=1e3){const c=n.current;s(c),n.current=0,o.current=i}r&&requestAnimationFrame(a)}return requestAnimationFrame(a),()=>{r=!1}},[]),t.jsxs("div",{className:"text-xs pl-1",style:{color:e<LN?"red":"inherit"},children:["FPS: ",e]})},Dn=1e3,On=500,HN=({scale:e,offset:s})=>{const n=$(I=>I.uiState.mode),[o,r]=p.useState(null),[a,i]=p.useState(null),c=$(I=>{var O;return((O=I.projectCanvas.getActive())==null?void 0:O.coreState.nodes)??js}),l=$(I=>I.setSelectedNodes),d=window.innerWidth,h=window.innerHeight,u=-s.x/e,f=-s.y/e,m=u+d/e,y=f+h/e,g=Math.floor(u/Dn)*Dn,x=Math.ceil(m/Dn)*Dn,w=Math.floor(f/On)*On,v=Math.ceil(y/On)*On,N=[];for(let I=g;I<=x;I+=Dn)N.push(I);const b=[];for(let I=w;I<=v;I+=On)b.push(I);const A=p.useCallback(I=>{const H=I.currentTarget.getBoundingClientRect(),L=I.clientX-H.left,W=I.clientY-H.top,P=(L-s.x)/e,j=(W-s.y)/e,M=L,B=H.width-L,U=W,z=H.height-W,_=50,G=M<_||B<_,F=U<_||z<_;r({canvasX:P,canvasY:j,showVertical:F,showHorizontal:G})},[e,s]),R=p.useCallback(()=>{r(null),i(null)},[]),k=p.useCallback(I=>{if(o&&(o.showVertical||o.showHorizontal)){I.stopPropagation(),I.preventDefault();const O=o.showVertical?"vertical":"horizontal";i({isDragging:!0,startX:o.canvasX,startY:o.canvasY,currentX:o.canvasX,currentY:o.canvasY,dragType:O})}},[o]),S=p.useCallback(I=>{if(!a||!a.isDragging)return;I.stopPropagation(),I.preventDefault();const O=Math.min(a.startX,a.currentX),H=Math.max(a.startX,a.currentX),L=Math.min(a.startY,a.currentY),W=Math.max(a.startY,a.currentY),P=c.filter(j=>{const M=j.width??200,B=j.height??100,U=j.x+M,z=j.y+B;return a.dragType==="vertical"?j.x<=H&&U>=O:j.y<=W&&z>=L});P.length>0&&l(P),i(null)},[a,c,l]),E=A,C=p.useCallback(I=>{if(E(I),a!=null&&a.isDragging){I.stopPropagation(),I.preventDefault();const H=I.currentTarget.getBoundingClientRect(),L=I.clientX-H.left,W=I.clientY-H.top,P=(L-s.x)/e,j=(W-s.y)/e;i({...a,currentX:P,currentY:j})}},[E,a,s,e]);return n!==ee.GRID?null:t.jsx("svg",{"data-grid-svg":"true","data-grid-active":o!=null&&o.showVertical||o!=null&&o.showHorizontal?"true":"false",className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{zIndex:o!=null&&o.showVertical||o!=null&&o.showHorizontal?999:0,pointerEvents:"auto",touchAction:"none",cursor:o?a!=null&&a.isDragging?"grabbing":"grab":"default"},onPointerMove:C,onPointerLeave:R,onPointerDown:k,onPointerUp:S,children:t.jsxs("g",{transform:`translate(${s.x}, ${s.y}) scale(${e})`,children:[N.map(I=>t.jsx("line",{x1:I,y1:f,x2:I,y2:y,stroke:I===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:I===0?2/e:1/e,style:{pointerEvents:"none"}},`v-${I}`)),b.map(I=>t.jsx("line",{x1:u,y1:I,x2:m,y2:I,stroke:I===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:I===0?2/e:1/e,style:{pointerEvents:"none"}},`h-${I}`)),o&&o.showVertical&&t.jsx("line",{x1:o.canvasX,y1:f,x2:o.canvasX,y2:y,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-vertical"),o&&o.showHorizontal&&t.jsx("line",{x1:u,y1:o.canvasY,x2:m,y2:o.canvasY,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-horizontal"),a&&a.isDragging&&(()=>{const I=Math.min(a.startX,a.currentX),O=Math.max(a.startX,a.currentX),H=Math.min(a.startY,a.currentY),L=Math.max(a.startY,a.currentY);return a.dragType==="vertical"?t.jsx("rect",{x:I,y:f,width:O-I,height:y-f,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range"):t.jsx("rect",{x:u,y:H,width:m-u,height:L-H,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range")})(),N.map(I=>t.jsx("text",{x:I,y:f+20/e,fill:"rgba(100, 116, 139, 0.6)",fontSize:ke.FONT_SIZE_XXS/e,textAnchor:"middle",style:{pointerEvents:"none"},children:I},`label-v-${I}`)),b.map(I=>t.jsx("text",{x:u+20/e,y:I,fill:"rgba(100, 116, 139, 0.6)",fontSize:ke.FONT_SIZE_XXS/e,textAnchor:"start",dominantBaseline:"middle",style:{pointerEvents:"none"},children:I},`label-h-${I}`)),o&&(o.showVertical||o.showHorizontal)&&(()=>{let I=c,O="",H=o.canvasX,L=o.canvasY-30/e;if(a!=null&&a.isDragging){const W=Math.min(a.startX,a.currentX),P=Math.max(a.startX,a.currentX),j=Math.min(a.startY,a.currentY),M=Math.max(a.startY,a.currentY);I=c.filter(B=>{const U=B.width??200,z=B.height??100,_=B.x+U,G=B.y+z;return a.dragType==="vertical"?B.x<=P&&_>=W:B.y<=M&&G>=j}),O=`Release to select ${I.length} node${I.length!==1?"s":""}`,H=(W+P)/2,L=a.dragType==="vertical"?f+30/e:(j+M)/2}else o.showVertical&&(I=I.filter(W=>{const P=W.width??200,j=W.x+P;return W.x<=o.canvasX&&j>=o.canvasX})),o.showHorizontal&&(I=I.filter(W=>{const P=W.height??100,j=W.y+P;return W.y<=o.canvasY&&j>=o.canvasY})),O=`Click/drag to select ${I.length} node${I.length!==1?"s":""}`;return t.jsxs("g",{children:[t.jsx("rect",{x:H-70/e,y:L-12/e,width:140/e,height:24/e,fill:"rgba(0, 0, 0, 0.9)",rx:4/e,style:{pointerEvents:"none"}}),t.jsx("text",{x:H,y:L,fill:"white",fontSize:ke.FONT_SIZE_XXS/e,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:O})]},"tooltip")})()]})})},ou={projectScope:{projects:!0,workspaces:!0,canvases:!0},nodeFields:{content:!1,title:!1,id:!1,type:!1,tags:!1}},au=e=>Object.values(e.nodeFields).some(s=>s),FN=e=>{const s=!e.projectScope.projects||!e.projectScope.workspaces||!e.projectScope.canvases,n=au(e);return s||n},BN=({searchQuery:e,onSearchQueryChange:s,searchFilters:n,onSearchFiltersChange:o})=>{const[r,a]=p.useState(!1);return t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"projects-search-section",children:[t.jsx(Ss,{className:"search-icon absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"projects-search-icon"}),t.jsx(ze,{type:"text",placeholder:"Search...",value:e,onChange:i=>s(i.target.value),className:Ie("search-input h-7 text-sm pl-8",e?"pr-14":"pr-8"),"data-test":"projects-search-input"}),e&&t.jsx(se,{variant:"ghost",size:"icon",onClick:()=>s(""),className:"clear-button absolute right-8 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"projects-search-clear-button",children:t.jsx(Ke,{className:"h-3 w-3"})}),FN(n)&&t.jsx("div",{className:Ie("filter-indicator absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",e?"right-14":"right-9"),"data-test":"projects-search-filter-indicator"}),t.jsxs(St,{open:r,onOpenChange:a,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0","aria-label":r?"Collapse advanced search":"Expand advanced search","data-test":"projects-search-expand-button",children:t.jsx(ka,{className:"h-3 w-3"})})}),t.jsxs(jt,{align:"start",side:"bottom",className:"advanced-search-panel w-72",style:{zIndex:We.draggablePopoverDropdown},"data-test":"projects-advanced-search-panel",children:[t.jsxs("div",{className:"panel-header flex items-center justify-between pb-2 border-b","data-test":"projects-panel-header",children:[t.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),t.jsx(se,{variant:"ghost",size:"sm",onClick:()=>o(ou),className:"h-6 text-xs px-2","data-test":"projects-clear-filters-button",children:"Clear All"})]}),t.jsxs("div",{className:"project-scope-section space-y-2 mt-3","data-test":"projects-scope-section",children:[t.jsx(Fe,{className:"text-sm font-medium",children:"Project"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in names of:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"scope-projects",checked:n.projectScope.projects,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,projects:!!i}}),"data-test":"projects-scope-projects-checkbox"}),t.jsx("label",{htmlFor:"scope-projects",className:"text-sm cursor-pointer",children:"Projects"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"scope-workspaces",checked:n.projectScope.workspaces,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,workspaces:!!i}}),"data-test":"projects-scope-workspaces-checkbox"}),t.jsx("label",{htmlFor:"scope-workspaces",className:"text-sm cursor-pointer",children:"Workspaces"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"scope-canvases",checked:n.projectScope.canvases,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,canvases:!!i}}),"data-test":"projects-scope-canvases-checkbox"}),t.jsx("label",{htmlFor:"scope-canvases",className:"text-sm cursor-pointer",children:"Canvases"})]})]})]}),t.jsxs("div",{className:"node-fields-section space-y-2 mt-4","data-test":"projects-node-fields-section",children:[t.jsx(Fe,{className:"text-sm font-medium",children:"Node Content"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"node-content",checked:n.nodeFields.content,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,content:!!i}}),"data-test":"projects-node-content-checkbox"}),t.jsx("label",{htmlFor:"node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"node-title",checked:n.nodeFields.title,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,title:!!i}}),"data-test":"projects-node-title-checkbox"}),t.jsx("label",{htmlFor:"node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"node-id",checked:n.nodeFields.id,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,id:!!i}}),"data-test":"projects-node-id-checkbox"}),t.jsx("label",{htmlFor:"node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"node-type",checked:n.nodeFields.type,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,type:!!i}}),"data-test":"projects-node-type-checkbox"}),t.jsx("label",{htmlFor:"node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(Xe,{id:"node-tags",checked:n.nodeFields.tags,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,tags:!!i}}),"data-test":"projects-node-tags-checkbox"}),t.jsx("label",{htmlFor:"node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]}),t.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 mt-4 border-t","data-test":"projects-panel-footer",children:[t.jsx(se,{onClick:()=>a(!1),className:"flex-1",size:"sm","data-test":"projects-apply-search-button",children:"Apply"}),t.jsx(se,{onClick:()=>a(!1),variant:"outline",size:"sm","data-test":"projects-cancel-button",children:"Cancel"})]})]})]})]})},zN=()=>{const e=$(a=>{var i,c;return(c=(i=a.preferences)==null?void 0:i.projectsManagerSearch)==null?void 0:c.filters}),[s,n]=p.useState(""),[o,r]=p.useState(e??ou);return p.useEffect(()=>{T.setState(a=>({...a,preferences:{...a.preferences,projectsManagerSearch:{filters:o}}}))},[o]),{searchQuery:s,setSearchQuery:n,searchFilters:o,setSearchFilters:r}},$N=180,_N=[],ru=e=>{const{onCanvasSelected:s,excludeCanvasId:n,selectionModeTitle:o,isOpen:r,onClose:a,popoverPosition:i}=e,c=!!s,l=$(te=>{var X;return((X=te.state)==null?void 0:X.projects)??{}}),d=$(te=>{var X;return((X=te.state)==null?void 0:X.activeProjectId)??""}),h=$(te=>te.project),u=$(te=>te.workspace),f=$(te=>te.projectCanvas),m=$(te=>te.exportSingleCanvas),y=$(te=>te.exportSingleWorkspace),g=$(te=>te.exportSingleProject),{searchQuery:x,setSearchQuery:w,searchFilters:v,setSearchFilters:N}=zN(),b=$(te=>{var X;return((X=te.preferences)==null?void 0:X.recentCanvases)??_N}),[A,R]=p.useState("projects"),k=p.useMemo(()=>d?l[d]??null:null,[l,d]),S=p.useMemo(()=>k!=null&&k.activeWorkspaceId?k.workspaces[k.activeWorkspaceId]??null:null,[k]),[E,C]=p.useState(""),[I,O]=p.useState(null),[H,L]=p.useState(null),W=p.useRef(null),P=Xr("projects-manager"),j=r!==void 0,M=j?r:P.isOpen,B=j?te=>{!te&&a&&a()}:te=>{te?P.open():P.close()},U=j?i:H,z=p.useMemo(()=>{const te=x.toLowerCase().trim(),X=te.length>0,K=au(v),ne=de=>de?de.toLowerCase().includes(te):!1,ce=de=>{if(!X||!K)return!1;const{nodeFields:q}=v,he=typeof de.content=="string"?de.content:"";return!!(q.content&&ne(he)||q.title&&ne(de.title)||q.id&&ne(de.id)||q.type&&ne(de.type)||q.tags&&Array.isArray(de.tags)&&de.tags.some(ue=>{const le=typeof ue=="string"?ue:(ue==null?void 0:ue.value)||(ue==null?void 0:ue.label)||"";return ne(le)}))};return Object.values(l).sort((de,q)=>(de.sortOrder??0)-(q.sortOrder??0)).map(de=>{if(X&&de.hideFromSearch)return null;const q=X&&v.projectScope.projects&&ne(de.name),he=Object.values(de.workspaces).sort((ue,le)=>(ue.sortOrder??0)-(le.sortOrder??0)).map(ue=>{if(X&&ue.hideFromSearch)return null;const le=X&&v.projectScope.workspaces&&ne(ue.name),ye=Object.values(ue.canvases).sort((je,Oe)=>(je.sortOrder??0)-(Oe.sortOrder??0)).map(je=>{var Ce;if(n&&je.id===n||X&&je.hideFromSearch)return null;const Oe=X&&v.projectScope.canvases&&ne(je.name);let oe=[];X&&K&&((Ce=je.coreState)!=null&&Ce.nodes)&&(oe=je.coreState.nodes.filter(ce).map(Y=>{const re=typeof Y.content=="string"?Y.content:"",ve=Y.title||re.substring(0,40)||Y.id,Ae=ve.length>40?ve.substring(0,40)+"...":ve;return{id:`node-${Y.id}`,label:Ae,data:{type:"node",id:Y.id,name:Ae,isActive:!1,projectId:de.id,workspaceId:ue.id,canvasId:je.id,nodeType:Y.type}}}));const ae=oe.length>0;return!X||Oe||ae?{id:je.id,label:je.name,data:{type:"canvas",id:je.id,name:je.name,isActive:je.id===ue.activeCanvasId,projectId:de.id,workspaceId:ue.id},children:oe.length>0?oe:void 0}:null}).filter(Boolean),xe=ye.length>0;return!X||le||xe?{id:ue.id,label:ue.name,data:{type:"workspace",id:ue.id,name:ue.name,isActive:ue.id===de.activeWorkspaceId,projectId:de.id},children:ye}:null}).filter(Boolean),be=he.length>0;return!X||q||be?{id:de.id,label:de.name,data:{type:"project",id:de.id,name:de.name,isActive:de.id===d},children:he}:null}).filter(Boolean)},[l,d,x,v,n]),_=p.useMemo(()=>{const te=new Set;if(d&&te.add(d),k!=null&&k.activeWorkspaceId&&te.add(k.activeWorkspaceId),x.trim()){const X=K=>{for(const ne of K)te.add(ne.id),ne.children&&X(ne.children)};X(z)}return te},[d,k,x,z]),G=te=>{const X=E.trim()||`New ${te}`;te==="project"?h.create(X):te==="workspace"?u.create(X):te==="canvas"&&f.create(X),C(""),O(null)},F=te=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5","data-test":"projects-add-input-container",children:[t.jsx(ze,{"data-test":"projects-new-input",type:"text",placeholder:`New ${te} name...`,value:E,onChange:X=>C(X.target.value),onKeyDown:X=>X.key==="Enter"&&G(te),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(se,{"data-test":"projects-save-button",variant:"ghost",size:"sm",onClick:()=>G(te),children:t.jsx(hs,{className:"h-3 w-3"})}),t.jsx(se,{"data-test":"projects-cancel-button",variant:"ghost",size:"sm",onClick:()=>{O(null),C("")},children:t.jsx(Ke,{className:"h-3 w-3"})})]}),D=te=>{var K;const X=(K=te.data)==null?void 0:K.type;if(X==="canvas"){if(c&&s){const{id:ne,workspaceId:ce,projectId:de,name:q}=te.data||{};ne&&ce&&de&&s({canvasId:ne,workspaceId:ce,projectId:de,canvasName:q||""});return}f.switch(te.id)}else if(X==="node"){const{canvasId:ne,id:ce}=te.data||{};ne&&ce&&(f.switch(ne),setTimeout(()=>{const de=T.getState().getNodeById(ce);de&&(T.getState().setSelectedNodes([de]),T.getState().scrollToNode(ce,300))},100))}},V=te=>{if(c&&s){if(n&&te.canvasId===n)return;s({canvasId:te.canvasId,workspaceId:te.workspaceId,projectId:te.projectId,canvasName:te.canvasName});return}f.switch(te.canvasId),R("projects")},J=(te,X)=>{te.stopPropagation(),f.removeRecentCanvas(X)},ie=(te,X)=>{const K=ce=>{var de;for(const q of ce){if(q.id===te)return(de=q.data)==null?void 0:de.type;if(q.children){const he=K(q.children);if(he)return he}}return null},ne=K(z);ne==="project"?h.updateMetadata(te,{name:X}):ne==="workspace"?u.updateMetadata(te,{name:X}):ne==="canvas"&&f.updateMetadata(te,{name:X})},Se=te=>{const X=ne=>{var ce;for(const de of ne){if(de.id===te)return(ce=de.data)==null?void 0:ce.type;if(de.children){const q=X(de.children);if(q)return q}}return null},K=X(z);K==="project"?h.delete(te):K==="workspace"?u.delete(te):K==="canvas"&&f.delete(te)},me=te=>{var K;return`Are you sure you want to delete this ${((K=te.data)==null?void 0:K.type)??"item"}: "${te.label}"?`},Z=te=>{const X=T.getState().setState;X(Gu(K=>{if(!K)return;const ne=Date.now();te.forEach((ce,de)=>{var ue;const q=K.projects[ce.id];if(!q)return;q.sortOrder=de,q.lastModified=ne;const he=new Set,be=new Map;(ue=ce.children)==null||ue.forEach((le,ye)=>{var je;let xe=q.workspaces[le.id];if(xe)xe.sortOrder=ye,xe.lastModified=ne,he.add(le.id);else{let Oe=null,oe=null;for(const[ae,Ce]of Object.entries(K.projects))if(ae!==ce.id&&Ce.workspaces[le.id]){Oe=Ce.workspaces[le.id],oe=ae;break}if(Oe&&oe){if(delete K.projects[oe].workspaces[le.id],K.projects[oe].lastModified=ne,K.projects[oe].activeWorkspaceId===le.id){const ae=Object.keys(K.projects[oe].workspaces);K.projects[oe].activeWorkspaceId=ae[0]||""}q.workspaces[le.id]=Oe,Oe.sortOrder=ye,Oe.lastModified=ne,he.add(le.id),xe=Oe}}if(xe){const Oe=new Set;be.set(le.id,Oe),(je=le.children)==null||je.forEach((oe,ae)=>{const Ce=xe.canvases[oe.id];if(Ce)Ce.sortOrder=ae,Ce.lastModified=ne,Oe.add(oe.id);else{let Y=null,re=null;for(const[ve,Ae]of Object.entries(q.workspaces))if(Ae.canvases[oe.id]){Y=Ae.canvases[oe.id],re=ve;break}if(Y)re&&re!==le.id&&(delete q.workspaces[re].canvases[oe.id],q.workspaces[re].lastModified=ne);else for(const[ve,Ae]of Object.entries(K.projects))if(ve!==ce.id){for(const[pe,Ne]of Object.entries(Ae.workspaces))if(Ne.canvases[oe.id]){Y=Ne.canvases[oe.id],re=pe,delete Ne.canvases[oe.id],Ne.lastModified=ne,Ae.lastModified=ne;break}if(Y)break}Y&&(xe.canvases[oe.id]=Y,Y.sortOrder=ae,Y.lastModified=ne,Oe.add(oe.id))}})}})})}))},ge=te=>{var K,ne,ce,de,q,he,be;const X=(K=te.data)==null?void 0:K.type;if(X==="project"){const ue=(ne=te.data)==null?void 0:ne.id,le=ue?l[ue]:null,ye=(le==null?void 0:le.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:ye?"Include in search":"Hide from search",icon:ye?t.jsx(us,{className:"h-4 w-4 mr-2"}):t.jsx(Os,{className:"h-4 w-4 mr-2"}),onClick:xe=>{const{id:je}=xe.data||{};je&&h.updateMetadata(je,{hideFromSearch:!ye})}},{id:"export",label:"Export",icon:t.jsx(zo,{className:"h-4 w-4 mr-2"}),onClick:xe=>{const{id:je}=xe.data||{};je&&g({projectId:je})}}]}if(X==="workspace"){const ue=(ce=te.data)==null?void 0:ce.id,le=(de=te.data)==null?void 0:de.projectId,ye=le?l[le]:null,xe=ye&&ue?ye.workspaces[ue]:null,je=(xe==null?void 0:xe.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:je?"Include in search":"Hide from search",icon:je?t.jsx(us,{className:"h-4 w-4 mr-2"}):t.jsx(Os,{className:"h-4 w-4 mr-2"}),onClick:Oe=>{const{id:oe}=Oe.data||{};oe&&u.updateMetadata(oe,{hideFromSearch:!je})}},{id:"export",label:"Export",icon:t.jsx(zo,{className:"h-4 w-4 mr-2"}),onClick:Oe=>{const{projectId:oe,id:ae}=Oe.data||{};oe&&ae&&y({projectId:oe,workspaceId:ae})}}]}if(X==="canvas"){const ue=(q=te.data)==null?void 0:q.id,le=(he=te.data)==null?void 0:he.projectId,ye=(be=te.data)==null?void 0:be.workspaceId,xe=le?l[le]:null,je=xe&&ye?xe.workspaces[ye]:null,Oe=je&&ue?je.canvases[ue]:null,oe=(Oe==null?void 0:Oe.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:oe?"Include in search":"Hide from search",icon:oe?t.jsx(us,{className:"h-4 w-4 mr-2"}):t.jsx(Os,{className:"h-4 w-4 mr-2"}),onClick:ae=>{const{id:Ce}=ae.data||{};Ce&&f.updateMetadata(Ce,{hideFromSearch:!oe})}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Bt,{className:"h-4 w-4 mr-2"}),onClick:ae=>{const{projectId:Ce,workspaceId:Y,id:re}=ae.data||{};Ce&&Y&&re&&f.duplicate(re,Ce,Y)}},{id:"export",label:"Export",icon:t.jsx(zo,{className:"h-4 w-4 mr-2"}),onClick:ae=>{const{projectId:Ce,workspaceId:Y,id:re}=ae.data||{};Ce&&Y&&re&&m({projectId:Ce,workspaceId:Y,canvasId:re})}}]}return null},we=()=>{if(M){B(!1),O(null),C("");return}if(W.current){const te=W.current.getBoundingClientRect(),X=320,K=400,ne=te.left+te.width/2,ce=te.top+te.height/2;L({x:ne-X/2+$N,y:ce-K/2})}B(!0)};return t.jsxs(t.Fragment,{children:[!j&&t.jsx(ks,{ref:W,variant:"secondary",size:"sm",tooltip:"Manage projects",onClick:we,className:"canvas-projects-manager-button","data-test":"canvas-projects-manager-button",children:t.jsx(bp,{className:"h-4 w-4"})}),t.jsx(et,{isVisible:M,onClose:()=>{B(!1),O(null),C(""),R("projects")},title:c?o??"Select Canvas":A==="recent"?"Recent Canvases":"Projects",resizable:!0,initialSize:{width:320,height:400},triggerPosition:U??void 0,shouldCloseManually:!0,headerActions:A==="recent"?t.jsx(se,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>R("projects"),title:"Back to Projects","data-test":"projects-back-button",children:t.jsx(pn,{className:"h-3.5 w-3.5"})}):t.jsx(se,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>R("recent"),title:"Recent Canvases","data-test":"projects-recent-button",children:t.jsx(vs,{className:"h-3.5 w-3.5"})}),children:t.jsx("div",{className:"manager-content flex flex-col space-y-2 p-2 h-full overflow-hidden","data-test":"projects-manager-content",children:A==="projects"?t.jsxs(t.Fragment,{children:[t.jsx(BN,{searchQuery:x,onSearchQueryChange:w,searchFilters:v,onSearchFiltersChange:N}),t.jsx(hn,{className:"tree-scroll-area flex-1 min-h-0","data-test":"projects-tree-scroll-area",children:t.jsx("div",{className:"tree-container space-y-1 pr-2","data-test":"projects-tree-container",children:t.jsx(gn,{data:z,onItemClick:D,onUpdate:c?void 0:ie,onDelete:c?void 0:Se,onReorder:c?void 0:Z,defaultExpandedIds:_,selectedId:(S==null?void 0:S.activeCanvasId)??null,deleteConfirmMessage:c?void 0:me,enableEdit:!c,enableDelete:!c,enableDrag:!c,moreOptionsItems:c?void 0:ge,dropdownZIndex:We.draggablePopoverDropdown})})}),!c&&(I?F(I):t.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t","data-test":"projects-add-buttons-row",children:[t.jsxs(se,{"data-test":"projects-add-project-button",variant:"outline",size:"sm",className:"add-project-button flex-1",onClick:()=>O("project"),title:"Add Project",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"})," Pr"]}),k&&t.jsxs(se,{"data-test":"projects-add-workspace-button",variant:"outline",size:"sm",className:"add-workspace-button flex-1",onClick:()=>O("workspace"),title:"Add Workspace",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"})," Wo"]}),S&&t.jsxs(se,{"data-test":"projects-add-canvas-button",variant:"outline",size:"sm",className:"add-canvas-button flex-1",onClick:()=>O("canvas"),title:"Add Canvas",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"})," Ca"]})]}))]}):t.jsx(hn,{className:"recent-canvases-scroll flex-1 min-h-0","data-test":"projects-recent-scroll-area",children:t.jsx("div",{className:"recent-canvases-list space-y-1 pr-2","data-test":"recent-canvases-list",children:(()=>{const te=n?b.filter(X=>X.canvasId!==n):b;return te.length===0?t.jsx("div",{className:"empty-state text-center text-muted-foreground text-sm py-8","data-test":"recent-canvases-empty",children:"No recently visited canvases"}):te.map(X=>t.jsxs("div",{className:"recent-canvas-item group flex items-center w-full text-left px-2 py-1.5 rounded hover:bg-accent transition-colors cursor-pointer",onClick:()=>V(X),"data-test":"recent-canvas-item",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"canvas-name text-sm font-medium truncate","data-test":"recent-canvas-name",children:X.canvasName}),t.jsxs("div",{className:"canvas-path text-xs text-muted-foreground truncate","data-test":"recent-canvas-path",children:[X.projectName," / ",X.workspaceName]})]}),!c&&t.jsx(se,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",onClick:K=>J(K,X.canvasId),title:"Remove from recent","data-test":"recent-canvas-delete",children:t.jsx(Ke,{className:"h-3.5 w-3.5"})})]},`${X.projectId}-${X.workspaceId}-${X.canvasId}`))})()})})})})]})};function iu({node:e,onItemClick:s,onUpdate:n,onDelete:o,level:r=0,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:h,moreOptionsItems:u,dropdownZIndex:f}){var W;const[m,y]=p.useState((a==null?void 0:a.has(e.id))??!1),[g,x]=p.useState(!1),[w,v]=p.useState(e.label),N=e.children&&e.children.length>0,b=i===e.id,A=p.useRef(null),R=p.useRef(e.label);p.useEffect(()=>{e.label!==R.current&&(R.current=e.label,g||v(e.label))},[e.label,g]),p.useEffect(()=>{b&&A.current&&A.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[b]);const k=P=>{P.stopPropagation(),g||(N&&y(!m),s==null||s(e))},S=()=>{w.trim()&&w!==e.label&&(n==null||n(e.id,w.trim())),x(!1)},E=()=>{v(e.label),x(!1)},C=P=>{P.stopPropagation();const j=(d==null?void 0:d(e))??`Are you sure you want to delete "${e.label}"?`;window.confirm(j)&&(o==null||o(e.id))},I={paddingLeft:`${r*1.5}rem`},O=N?t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:m?t.jsx(Pt,{className:"h-4 w-4"}):t.jsx(ss,{className:"h-4 w-4"})}):t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),H=t.jsxs("div",{ref:A,className:Ie("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",b&&"bg-primary/10 border border-primary"),style:I,onClick:k,children:[O,e.icon&&t.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:e.icon}),g?t.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[t.jsx(ze,{type:"text",value:w,onChange:P=>v(P.target.value),onKeyDown:P=>{P.key==="Enter"&&S(),P.key==="Escape"&&E()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:P=>P.stopPropagation()}),t.jsx(se,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),S()},className:"h-6 w-6 p-0",children:t.jsx(hs,{className:"h-3 w-3"})}),t.jsx(se,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),E()},className:"h-6 w-6 p-0",children:t.jsx(Ke,{className:"h-3 w-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"tree-item-label flex-grow truncate",title:e.label,children:e.label}),t.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[c&&n&&t.jsx(se,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),x(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:t.jsx(Xl,{className:"h-3 w-3"})}),(()=>{const P=u==null?void 0:u(e);return P&&P.length>0?t.jsxs(to,{children:[t.jsx(Ko,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"sm",onClick:j=>j.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:t.jsx(Gl,{className:"h-3 w-3"})})}),t.jsxs(so,{align:"end",style:f?{zIndex:f}:void 0,"data-test":"tree-item-more-options-content",children:[P.map(j=>j.subItems?t.jsxs(Hn,{children:[t.jsxs(Fn,{className:j.className,"data-test":"tree-item-menu-trigger",children:[j.icon,j.label]}),t.jsx(Bn,{children:j.subItems.map(M=>t.jsxs(nt,{onClick:B=>{B.stopPropagation(),M.onClick(e)},className:M.className,"data-test":"tree-item-menu-subitem",children:[M.icon,M.label]},M.id))})]},j.id):t.jsxs(nt,{onClick:M=>{var B;M.stopPropagation(),(B=j.onClick)==null||B.call(j,e)},className:j.className,"data-test":"tree-item-menu-item",children:[j.icon,j.label]},j.id)),l&&o&&t.jsxs(nt,{onClick:j=>{j.stopPropagation(),C(j)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[t.jsx(Nt,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):l&&o?t.jsx(se,{variant:"ghost",size:"sm",onClick:C,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:t.jsx(Nt,{className:"h-3 w-3"})}):null})()]})]})]}),L=h?h(e,b,!!N,H):H;return N?t.jsxs(Es,{open:m,onOpenChange:y,children:[t.jsx(Rs,{asChild:!0,children:t.jsx("div",{children:L})}),t.jsx(Ms,{children:t.jsx("div",{className:"tree-item-children",children:(W=e.children)==null?void 0:W.map(P=>t.jsx(iu,{node:P,onItemClick:s,onUpdate:n,onDelete:o,level:r+1,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:h,moreOptionsItems:u,dropdownZIndex:f},P.id))})})]}):t.jsx(t.Fragment,{children:L})}function UN({data:e,onItemClick:s,onUpdate:n,onDelete:o,className:r,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:h,moreOptionsItems:u,dropdownZIndex:f}){return t.jsx("div",{className:Ie("crud-tree-root",r),children:e.map(m=>t.jsx(iu,{node:m,onItemClick:s,onUpdate:n,onDelete:o,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:h,moreOptionsItems:u,dropdownZIndex:f},m.id))})}const VN=180,GN=()=>{const e=kt(Z=>Z.definitions),s=kt(Z=>Z.instances),n=kt(Z=>Z.selectedDefinitionId),o=kt(Z=>Z.createDefinition),r=kt(Z=>Z.updateDefinition),a=kt(Z=>Z.deleteDefinition);kt(Z=>Z.duplicateDefinition);const i=kt(Z=>Z.createInstance),c=kt(Z=>Z.deleteInstance),l=kt(Z=>Z.selectDefinition),d=$(Z=>{var ge;return((ge=Z.projectCanvas.getActive())==null?void 0:ge.coreState.nodes)??js}),h=$(Z=>{var ge;return((ge=Z.state)==null?void 0:ge.projects)??{}}),[u,f]=p.useState(""),[m,y]=p.useState(null),[g,x]=p.useState(null),[w,v]=p.useState(new Set),N=p.useRef(null),b=p.useRef(null),{isOpen:A,open:R,close:k}=Xr("workflow-manager"),S=kt(Z=>Z.facade),E=p.useMemo(()=>new br(S),[S]),C=p.useMemo(()=>{const Z=h["workflow-templates-project"],ge=[];Z&&Object.values(Z.workspaces).forEach(ce=>{Object.values(ce.canvases).forEach(de=>{de.coreState.nodes.filter(he=>{var be;return((be=he.data)==null?void 0:be.nodeType)==="workflowOrchestration"}).forEach(he=>{var xe,je;const be=he.data,ue=((je=(xe=be==null?void 0:be.parameters)==null?void 0:xe.rows)==null?void 0:je.length)||0,le=typeof he.title=="string"?he.title:"",ye=typeof he.content=="string"?he.content:"";ge.push({id:`preset-${he.id}`,label:le||ye||`Preset (${ue} steps)`,data:{type:"preset-workflow",id:he.id,nodeId:he.id,rowCount:ue,canvasId:de.id,canvasName:de.name}})})})});const we=new Set(ge.map(ce=>{var de;return(de=ce.data)==null?void 0:de.nodeId})),X=d.filter(ce=>{var de;return((de=ce.data)==null?void 0:de.nodeType)==="workflowOrchestration"&&!we.has(ce.id)}).map(ce=>{var ue,le;const de=ce.data,q=((le=(ue=de==null?void 0:de.parameters)==null?void 0:ue.rows)==null?void 0:le.length)||0,he=typeof ce.title=="string"?ce.title:"",be=typeof ce.content=="string"?ce.content:"";return{id:ce.id,label:he||be||`Workflow (${q} steps)`,data:{type:"canvas-workflow",id:ce.id,nodeId:ce.id,rowCount:q}}}),K=e.map(ce=>{const de=s.filter(q=>q.definitionId===ce.id);return{id:ce.id,label:ce.name,data:{type:"definition",id:ce.id,name:ce.name,isActive:ce.id===n,description:ce.description,tags:ce.tags},children:de.map(q=>({id:q.id,label:q.name,data:{type:"instance",id:q.id,name:q.name,status:q.status,definitionId:q.definitionId}}))}}),ne=[];return ge.length>0&&ne.push({id:"section-presets",label:`📚 Workflow Presets (${ge.length})`,data:{type:"section",section:"presets"},children:ge}),X.length>0&&ne.push({id:"section-canvas",label:`🎨 Current Canvas (${X.length})`,data:{type:"section",section:"canvas"},children:X}),K.length>0&&ne.push({id:"section-saved",label:`💾 Saved Workflows (${K.length})`,data:{type:"section",section:"saved"},children:K}),ne},[d,e,s,n,h]),I=p.useMemo(()=>{const Z=new Set;return Z.add("section-presets"),Z.add("section-canvas"),Z.add("section-saved"),n&&Z.add(n),Z},[n]),O=Z=>{const ge=u.trim()||`New ${Z}`;Z==="definition"?o({name:ge}):Z==="instance"&&n&&i(n,ge),f(""),y(null)},H=Z=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[t.jsx(ze,{"data-test":"workflow-new-input",type:"text",placeholder:`New ${Z} name...`,value:u,onChange:ge=>f(ge.target.value),onKeyDown:ge=>ge.key==="Enter"&&O(Z),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(se,{"data-test":"workflow-save-button",variant:"ghost",size:"sm",onClick:()=>O(Z),children:t.jsx(hs,{className:"h-3 w-3"})}),t.jsx(se,{"data-test":"workflow-cancel-button",variant:"ghost",size:"sm",onClick:()=>{y(null),f("")},children:t.jsx(Ke,{className:"h-3 w-3"})})]}),L=Z=>{var we;((we=Z.data)==null?void 0:we.type)==="definition"&&l(Z.id)},W=(Z,ge)=>{const we=X=>{var K;for(const ne of X){if(ne.id===Z)return(K=ne.data)==null?void 0:K.type;if(ne.children){const ce=we(ne.children);if(ce)return ce}}return null},te=we(C);te==="section"||te==="preset-workflow"||(te==="canvas-workflow"?T.getState().updateNode(Z,{title:ge}):te==="definition"?r(Z,{name:ge}):te==="instance"&&console.warn("Instance rename not yet implemented"))},P=Z=>{const ge=te=>{var X;for(const K of te){if(K.id===Z)return(X=K.data)==null?void 0:X.type;if(K.children){const ne=ge(K.children);if(ne)return ne}}return null},we=ge(C);we==="section"||we==="preset-workflow"||we==="canvas-workflow"||(we==="definition"?a(Z):we==="instance"&&c(Z))},j=Z=>{var we;return`Are you sure you want to delete this ${((we=Z.data)==null?void 0:we.type)??"item"}: "${Z.label}"?`},M=()=>{if(A){k(),y(null),f("");return}if(N.current){const Z=N.current.getBoundingClientRect(),ge=320,we=400,te=Z.left+Z.width/2,X=Z.top+Z.height/2;x({x:te-ge/2+VN,y:X-we/2})}R()},B=()=>{if(w.size===0){Ee.error("No workflows selected");return}try{const Z=Array.from(w);E.downloadWorkflows(Z),Ee.success(`Exported ${w.size} workflow(s)`,{description:"Workflows downloaded as JSON file"})}catch(Z){Ee.error("Export failed",{description:Z instanceof Error?Z.message:"Unknown error"})}},U=()=>{try{const Z=E.exportAllWorkflows(),ge=new Blob([Z],{type:"application/json"}),we=URL.createObjectURL(ge),te=document.createElement("a");te.href=we,te.download=`all-workflows-${Date.now()}.json`,te.click(),URL.revokeObjectURL(we),Ee.success("Exported all workflows",{description:`${e.length} workflow(s) downloaded`})}catch(Z){Ee.error("Export failed",{description:Z instanceof Error?Z.message:"Unknown error"})}},z=()=>{var Z;(Z=b.current)==null||Z.click()},_=Z=>{var te;const ge=(te=Z.target.files)==null?void 0:te[0];if(!ge)return;const we=new FileReader;we.onload=X=>{var K;try{const ne=(K=X.target)==null?void 0:K.result,ce=E.importWorkflows(ne);Ee.success(`Imported ${ce.length} workflow(s)`,{description:"Workflows added to manager"})}catch(ne){Ee.error("Import failed",{description:ne instanceof Error?ne.message:"Invalid JSON"})}},we.readAsText(ge),Z.target.value=""},G=Z=>{const ge=new Set(w);ge.has(Z)?ge.delete(Z):ge.add(Z),v(ge)},F=()=>{w.size===e.length?v(new Set):v(new Set(e.map(Z=>Z.id)))},D=()=>{if(w.size!==0&&window.confirm(`Are you sure you want to delete ${w.size} workflow(s)?`))try{E.bulkDeleteDefinitions(Array.from(w)),v(new Set),Ee.success(`Deleted ${w.size} workflow(s)`)}catch(Z){Ee.error("Bulk delete failed",{description:Z instanceof Error?Z.message:"Unknown error"})}},V=()=>{if(w.size!==0)try{const Z=E.bulkDuplicateDefinitions(Array.from(w));v(new Set),Ee.success(`Duplicated ${Z.length} workflow(s)`,{description:'New workflows created with " (copy)" suffix'})}catch(Z){Ee.error("Bulk duplicate failed",{description:Z instanceof Error?Z.message:"Unknown error"})}},J=()=>{if(w.size===0)return;const Z=window.prompt("Enter tags (comma-separated):");if(!Z)return;const ge=Z.split(",").map(we=>we.trim()).filter(Boolean);if(ge.length===0){Ee.error("No valid tags provided");return}try{E.bulkAddTags(Array.from(w),ge),Ee.success(`Added tags to ${w.size} workflow(s)`,{description:`Tags: ${ge.join(", ")}`})}catch(we){Ee.error("Bulk add tags failed",{description:we instanceof Error?we.message:"Unknown error"})}},ie=()=>{if(w.size===0)return;const Z=window.prompt("Enter tags to remove (comma-separated):");if(!Z)return;const ge=Z.split(",").map(we=>we.trim()).filter(Boolean);if(ge.length===0){Ee.error("No valid tags provided");return}try{E.bulkRemoveTags(Array.from(w),ge),Ee.success(`Removed tags from ${w.size} workflow(s)`,{description:`Tags: ${ge.join(", ")}`})}catch(we){Ee.error("Bulk remove tags failed",{description:we instanceof Error?we.message:"Unknown error"})}},Se=()=>{if(w.size!==0)try{const Z=E.getBulkStats(Array.from(w));Ee.info("Bulk Statistics",{description:`Workflows: ${Z.count} | Nodes: ${Z.totalNodes} | Connections: ${Z.totalConnections} | Tags: ${Z.tags.length}`})}catch(Z){Ee.error("Failed to get statistics",{description:Z instanceof Error?Z.message:"Unknown error"})}},me=w.size===e.length&&e.length>0;return w.size>0&&w.size<e.length,t.jsxs(t.Fragment,{children:[t.jsx(ks,{ref:N,variant:"secondary",size:"sm",tooltip:"Manage workflows",onClick:M,className:"workflow-manager-button","data-test":"workflow-manager-button",children:t.jsx(Hs,{className:"h-4 w-4"})}),t.jsx(et,{isVisible:A,onClose:()=>{k(),y(null),f("")},title:"Workflow Manager",resizable:!0,initialSize:{width:420,height:450},triggerPosition:g??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col space-y-2 p-2 flex-1 h-full overflow-scroll","data-test":"manager-content ",children:[t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b","data-test":"toolbar-row",children:[t.jsxs(to,{children:[t.jsx(Ko,{asChild:!0,children:t.jsxs(se,{"data-test":"workflow-export-dropdown",variant:"outline",size:"sm",className:"flex-1",children:[t.jsx(zo,{className:"h-3 w-3 mr-1"}),"Export",t.jsx(Pt,{className:"h-3 w-3 ml-1"})]})}),t.jsxs(so,{style:{zIndex:We.skipLink},children:[t.jsxs(nt,{"data-test":"workflow-export-selected",onClick:B,children:["Export Selected (",w.size,")"]}),t.jsxs(nt,{"data-test":"workflow-export-all",onClick:U,children:["Export All (",e.length,")"]})]})]}),t.jsxs(se,{"data-test":"workflow-import-button",variant:"outline",size:"sm",className:"flex-1",onClick:z,title:"Import workflows from JSON",children:[t.jsx(ho,{className:"h-3 w-3 mr-1"}),"Import"]}),t.jsx("input",{"data-test":"workflow-import-file-input",ref:b,type:"file",accept:".json",onChange:_,className:"hidden"})]}),w.size>0&&t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b bg-primary/5 p-1.5 rounded","data-test":"bulk-toolbar",children:[t.jsxs("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:[w.size," selected"]}),t.jsxs(to,{children:[t.jsx(Ko,{asChild:!0,children:t.jsxs(se,{"data-test":"workflow-bulk-actions-dropdown",variant:"ghost",size:"sm",className:"flex-1",children:[t.jsx(Pt,{className:"h-3 w-3 mr-1"}),"Bulk Actions"]})}),t.jsxs(so,{style:{zIndex:We.skipLink},children:[t.jsx(Yu,{children:"Bulk Operations"}),t.jsx(on,{}),t.jsxs(nt,{"data-test":"workflow-bulk-duplicate",onClick:V,children:[t.jsx(Bt,{className:"h-3 w-3 mr-2"}),"Duplicate"]}),t.jsxs(nt,{"data-test":"workflow-bulk-delete",onClick:D,children:[t.jsx(Nt,{className:"h-3 w-3 mr-2"}),"Delete"]}),t.jsx(on,{}),t.jsxs(nt,{"data-test":"workflow-bulk-add-tags",onClick:J,children:[t.jsx(uo,{className:"h-3 w-3 mr-2"}),"Add Tags"]}),t.jsxs(nt,{"data-test":"workflow-bulk-remove-tags",onClick:ie,children:[t.jsx(uo,{className:"h-3 w-3 mr-2"}),"Remove Tags"]}),t.jsx(on,{}),t.jsxs(nt,{"data-test":"workflow-bulk-stats",onClick:Se,children:[t.jsx(Np,{className:"h-3 w-3 mr-2"}),"Show Statistics"]})]})]})]}),e.length>0&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1","data-test":"select-all-row",children:[t.jsx(Xe,{"data-test":"workflow-select-all-checkbox",checked:me,onCheckedChange:F,className:"h-4 w-4","aria-label":"Select all workflows"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:me?"Deselect All":"Select All"})]}),t.jsx(hn,{className:"tree-scroll-area flex-1",children:t.jsx("div",{className:"space-y-1 pr-2","data-test":"tree-container",children:t.jsx(UN,{data:C,onItemClick:L,onUpdate:W,onDelete:P,defaultExpandedIds:I,selectedId:n,deleteConfirmMessage:j,dropdownZIndex:We.skipLink,moreOptionsItems:Z=>{var ge,we,te;if(((ge=Z.data)==null?void 0:ge.type)==="canvas-workflow")return[{id:"save",label:"Save Workflow",icon:t.jsx(hs,{className:"h-4 w-4 mr-2"}),onClick:X=>{try{const K=E.saveWorkflow({nodeId:X.data.nodeId});Ee.success("Workflow saved",{description:`"${K.name}" saved as version ${K.version}`})}catch(K){Ee.error("Failed to save workflow",{description:K instanceof Error?K.message:"Unknown error"})}}}];if(((we=Z.data)==null?void 0:we.type)==="preset-workflow"){const X=async(K,ne)=>{var ce,de,q,he,be,ue;try{const le=h["workflow-templates-project"];if(!le)throw new Error("Workflow Templates project not found");let ye=null,xe=[];if(Object.values(le.workspaces).forEach(pe=>{Object.values(pe.canvases).forEach(Ne=>{const Te=Ne.coreState.nodes.find(Re=>Re.id===K.data.nodeId);Te&&(ye=JSON.parse(JSON.stringify(Te)),xe=Ne.coreState.arrows||[])})}),!ye)throw new Error("Preset workflow not found");(de=(ce=ye.data)==null?void 0:ce.parameters)!=null&&de.rows&&ye.data.parameters.rows.forEach(pe=>{pe.children&&pe.children.forEach(Ne=>{var Te;Ne.stepType==="nodeUpdate"&&((Te=Ne.config)!=null&&Te.simpleFieldUpdates)&&Ne.config.simpleFieldUpdates.forEach(Re=>{const De=Re.field;Re.field=ne,Re.template&&(Re.template=Re.template.replace(new RegExp(`loop\\.current\\.${De}`,"g"),`loop.current.${ne}`))})})});const je=T.getState(),Oe=((q=je.projectCanvas.getActive())==null?void 0:q.coreState.nodes)||[],oe=((he=je.projectCanvas.getActive())==null?void 0:he.coreState.selectedNodes)||[],ae=((be=je.projectCanvas.getActive())==null?void 0:be.coreState.arrows)||[],Ce=oe.length>0?oe:Oe,Y=new fn,re=[...Ce,ye],ve=[...ae,...xe];Y.loadWorkflow(re,ve);const Ae=await Y.executeWorkflow(ye.id);if(Ae.success){if(Ae.nodeUpdates&&Ae.nodeUpdates.length>0){const Ne=Ae.nodeUpdates.map(({nodeId:Te,updates:Re})=>({id:Te,...Re}));je.updateNodes(Ne)}const pe=oe.length>0?"selected":"all";Ee.success("Workflow applied",{description:`Applied "${ye.title||"workflow"}" to ${ne} of ${((ue=Ae.nodeUpdates)==null?void 0:ue.length)||0} ${pe} nodes`})}else Ee.error("Workflow execution failed",{description:Ae.errors.map(pe=>pe.message).join(", ")||"Unknown error"})}catch(le){Ee.error("Failed to apply workflow",{description:le instanceof Error?le.message:"Unknown error"})}};return[{id:"apply",label:"Apply Workflow",icon:t.jsx(ft,{className:"h-4 w-4 mr-2"}),subItems:Xu.map(K=>({id:K,label:Ku[K],onClick:async ne=>X(ne,K)}))},{id:"copy",label:"Copy to Canvas",icon:t.jsx(Bt,{className:"h-4 w-4 mr-2"}),onClick:K=>{try{const ne=h["workflow-templates-project"];if(!ne)throw new Error("Workflow Templates project not found");let ce=null;if(Object.values(ne.workspaces).forEach(he=>{Object.values(he.canvases).forEach(be=>{const ue=be.coreState.nodes.find(le=>le.id===K.data.nodeId);ue&&(ce=ue)})}),!ce)throw new Error("Preset workflow not found");const de=T.getState(),q={...ce,id:`copied-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,x:150,y:150};de.addNode(q),Ee.success("Preset copied",{description:"Workflow preset copied to current canvas"})}catch(ne){Ee.error("Failed to copy preset",{description:ne instanceof Error?ne.message:"Unknown error"})}}}]}return((te=Z.data)==null?void 0:te.type)==="definition"?[{id:"apply",label:"Apply Workflow",icon:t.jsx(ft,{className:"h-4 w-4 mr-2"}),onClick:async X=>{var K,ne,ce,de,q;try{const he=e.find(ae=>ae.id===X.id);if(!he)throw new Error("Workflow definition not found");const be=T.getState(),ue=((K=be.projectCanvas.getActive())==null?void 0:K.coreState.nodes)||[],le=((ne=be.projectCanvas.getActive())==null?void 0:ne.coreState.selectedNodes)||[],ye=le.length>0?le:ue;if(ye.length===0){Ee.error("No nodes to apply workflow to");return}const xe=new fn,je=((ce=he.nodes)==null?void 0:ce.map((ae,Ce)=>{var Y,re;return{id:ae.id,label:((Y=ae.parameters)==null?void 0:Y.label)||`Step ${Ce+1}`,order:((re=ae.parameters)==null?void 0:re.order)||Ce+1,stepType:ae.type,config:ae.parameters||{}}}))||[],Oe={id:`temp-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:he.name,content:"",x:0,y:0,width:400,height:300,data:{nodeType:"workflowOrchestration",parameters:{rows:je}}};xe.loadWorkflow([...ye,Oe],[]);const oe=await xe.executeWorkflow(Oe.id);if(oe.success){if(oe.nodeUpdates&&oe.nodeUpdates.length>0)for(const{nodeId:ae,updates:Ce}of oe.nodeUpdates)be.updateNode(ae,Ce);Ee.success("Workflow applied",{description:`Applied "${he.name}" to ${((de=oe.nodeUpdates)==null?void 0:de.length)||0} nodes`})}else Ee.error("Workflow execution failed",{description:((q=oe.errors)==null?void 0:q.map(ae=>ae.message).join(", "))||"Unknown error"})}catch(he){Ee.error("Failed to apply workflow",{description:he instanceof Error?he.message:"Unknown error"})}}},{id:"load",label:"Load to Canvas",icon:t.jsx(Sp,{className:"h-4 w-4 mr-2"}),onClick:X=>{try{E.loadWorkflow({definitionId:X.id,position:{x:100,y:100}}),Ee.success("Workflow loaded",{description:"Loaded workflow to canvas at position (100, 100)"})}catch(K){Ee.error("Failed to load workflow",{description:K instanceof Error?K.message:"Unknown error"})}}}]:null},renderNode:(Z,ge,we,te)=>{var X,K;return((X=Z.data)==null?void 0:X.type)==="section"?t.jsx("div",{className:"flex items-center gap-2 w-full",children:t.jsx("div",{className:"flex-1 font-semibold",children:te})}):((K=Z.data)==null?void 0:K.type)==="definition"?t.jsxs("div",{className:"flex items-center gap-2 w-full",children:[t.jsx(Xe,{"data-test":"workflow-definition-checkbox",checked:w.has(Z.id),onCheckedChange:()=>G(Z.id),className:"h-4 w-4 flex-shrink-0",onClick:ne=>ne.stopPropagation()}),t.jsx("div",{className:"flex-1",children:te})]}):te}})})}),m?H(m):t.jsxs("div",{className:"flex items-center gap-1 pt-2 border-t","data-test":"add-buttons-row",children:[t.jsxs(se,{"data-test":"workflow-add-definition-button",variant:"outline",size:"sm",className:"add-definition-button flex-1",onClick:()=>y("definition"),title:"Add Workflow Definition",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"})," Workflow"]}),n&&t.jsxs(se,{"data-test":"workflow-add-instance-button",variant:"outline",size:"sm",className:"add-instance-button flex-1",onClick:()=>y("instance"),title:"Add Workflow Instance",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"})," Instance"]})]})]})})]})},Ma=e=>{const{className:s,style:n,children:o,position:r="left"}=e;return t.jsx("div",{className:Me("p-2 bg-background border shadow flex flex-col items-center space-y-2 pointer-events-auto rounded",s),style:{...n},onMouseDown:a=>a.stopPropagation(),onPointerDown:a=>a.stopPropagation(),"data-test":"canvas-vertical-toolbar","data-prevent-canvas-click":!0,children:o})},YN=({extension:e})=>{const s=$(i=>{var c,l;return((l=(c=i.extensions)==null?void 0:c.settings)==null?void 0:l[e.id])??e.defaultSettings}),n=i=>{var l,d;(d=(l=T.getState().ext)==null?void 0:l.setSettings)==null||d.call(l,e.id,i)},o=i=>typeof i=="boolean"?i:typeof i=="function"?i(s):!1,r=async i=>{try{await i(s)}catch(c){console.error(`Error executing extension action for ${e.id}:`,c)}},a=t.jsxs("div",{className:"flex flex-col h-full","data-test":"extension-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-y-auto border-b border-border p-3","data-test":"extension-settings-container",children:He.createElement(e.settingsComponent,{settings:s,onSettingsChange:n})}),Object.entries(e.actions).length>0&&t.jsx("div",{className:"flex flex-col gap-2 p-3","data-test":"extension-actions-container",children:Object.entries(e.actions).map(([i,c])=>{const l=o(c.disabled),d=c.icon;return t.jsxs("button",{onClick:()=>r(c.execute),disabled:l,className:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow-xs hover:bg-primary/90 h-8 px-3 py-1.5",title:c.label,"data-test":"extension-action-button",children:[d&&t.jsx(d,{className:"h-4 w-4"}),t.jsx("span",{children:c.label})]},i)})})]});return t.jsx(Sn,{popoverId:`extension-${e.id}`,icon:e.icon,tooltip:e.description||e.name,popoverTitle:e.name,popoverContent:a,leftOffset:120,dataTest:"extension-button"})},XN=({settings:e,onSettingsChange:s})=>{p.useEffect(()=>{kr("1_settings_load",e)},[e]);const n=p.useCallback((o,r)=>{s({...e,[o]:r})},[e,s]);return t.jsxs("div",{className:"flex flex-col gap-4 p-2","data-test":"journal-settings",children:[t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-project-field",children:[t.jsx(Fe,{htmlFor:"journal-project",className:"text-xs text-muted-foreground",children:"Project Name"}),t.jsx(ze,{id:"journal-project",value:e.projectName,onChange:o=>n("projectName",o.target.value),placeholder:"Journal",className:"h-8 text-sm","data-test":"journal-settings-project-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-workspace-field",children:[t.jsx(Fe,{htmlFor:"journal-workspace",className:"text-xs text-muted-foreground",children:"Workspace Name"}),t.jsx(ze,{id:"journal-workspace",value:e.workspaceName,onChange:o=>n("workspaceName",o.target.value),placeholder:Zr(),className:"h-8 text-sm","data-test":"journal-settings-workspace-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-canvas-field",children:[t.jsx(Fe,{htmlFor:"journal-canvas",className:"text-xs text-muted-foreground",children:"Canvas Name"}),t.jsx(ze,{id:"journal-canvas",value:e.canvasName,onChange:o=>n("canvasName",o.target.value),placeholder:Jr(),className:"h-8 text-sm","data-test":"journal-settings-canvas-input"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 py-1","data-test":"journal-settings-autocreate-field",children:[t.jsx(Fe,{htmlFor:"journal-autocreate",className:"text-xs text-muted-foreground",children:"Create if missing"}),t.jsx(qo,{id:"journal-autocreate",checked:e.autoCreateIfMissing,onCheckedChange:o=>n("autoCreateIfMissing",o),"data-test":"journal-settings-autocreate-switch"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-template-field",children:[t.jsx(Fe,{htmlFor:"journal-template",className:"text-xs text-muted-foreground",children:"Note Template (optional)"}),t.jsx(Er,{id:"journal-template",value:e.noteTemplate??"",onChange:o=>n("noteTemplate",o.target.value),placeholder:"Enter default note content...",className:"min-h-[60px] resize-none text-sm","data-test":"journal-settings-template-input"}),t.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Text to include after the timestamp header"})]})]})};function Zr(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0");return`${s}-${n}`}function Jr(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${o}`}const KN={projectName:"Journal",workspaceName:Zr(),canvasName:Jr(),autoCreateIfMissing:!0,noteTemplate:""};function kr(e,s){var a;const o=((a=T.getState().state)==null?void 0:a.projects)??{};Object.keys(o).find(i=>o[i].name===s.projectName)}function qN(){const e=new Date,s={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0};return e.toLocaleString(void 0,s)}function ZN(e){var u,f,m,y;const s=T.getState(),n=((u=s.state)==null?void 0:u.projects)??{},o=e.workspaceName||Zr(),r=e.canvasName||Jr();let a=Object.keys(n).find(g=>n[g].name===e.projectName),i=!1;if(!a&&e.autoCreateIfMissing){if(a=s.project.create(e.projectName),!a)return null;i=!0}if(!a)return null;const c=(f=T.getState().state)==null?void 0:f.projects[a];if(!c)return null;let l=Object.keys(c.workspaces).find(g=>c.workspaces[g].name===o);if(!l&&i&&e.autoCreateIfMissing){const g=Object.keys(c.workspaces).find(x=>c.workspaces[x].name==="Default Workspace");g&&(s.workspace.updateMetadata(g,{name:o}),l=g)}if(!l&&e.autoCreateIfMissing&&(s.project.switch(a),l=s.workspace.create(o)??void 0,!l)||!l)return null;const d=(y=(m=T.getState().state)==null?void 0:m.projects[a])==null?void 0:y.workspaces[l];if(!d)return null;let h=Object.keys(d.canvases).find(g=>d.canvases[g].name===r);if(!h&&i&&e.autoCreateIfMissing){const g=Object.keys(d.canvases).find(x=>d.canvases[x].name==="Default Canvas");g&&(s.projectCanvas.updateMetadata(g,{name:r}),h=g)}return!h&&e.autoCreateIfMissing&&(s.project.switch(a),s.workspace.switch(l),h=s.projectCanvas.create(r)??void 0,!h)?null:h??null}function JN(e){kr("2_create_note_before",e);const s=T.getState(),n=ZN(e);if(!n){console.error("[JournalExtension] Could not find or create target canvas");return}s.projectCanvas.switch(n);const r=`## ${qN()}`,a=e.noteTemplate?`${r}

${e.noteTemplate}`:r,i=`journal-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,c={id:i,type:fe.TEXT,x:100,y:100,width:300,height:150,content:"",isSelected:!0,isEditing:!0};s.addNode(c,a,{dontOverlap:!0}),s.setNodeToFocusId(i),kr("2_create_note_after",e)}const QN={id:"journal",name:"Journal",icon:va,description:"Create timestamped notes in a dedicated canvas",settingsComponent:XN,defaultSettings:KN,version:"1.0.0",actions:{createNote:{label:"Create Note",execute:JN}}},Ln=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const h=n?l:l.toLowerCase();let u=0,f=h.indexOf(a,u);for(;f!==-1;){const m=Math.max(0,f-40),y=Math.min(l.length,f+a.length+40);let g=l.substring(m,y);m>0&&(g="..."+g),y<l.length&&(g=g+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:g,startIndex:f,field:o}),u=f+1,f=h.indexOf(a,u)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const h=Math.max(0,d-40),u=Math.min(e.length,d+a.length+40);let f=e.substring(h,u);h>0&&(f="..."+f),u<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},eS=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...Ln(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...Ln(e.title,s,n,"title")),o.id&&e.id&&r.push(...Ln(e.id,s,n,"id")),o.type&&e.type&&r.push(...Ln(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...Ln(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},tS=(e,s,n=new Set)=>{if(!s.query.trim())return[];if(!Object.values(s.nodeFields).some(a=>a))return[];const r=[];for(const a of e){if(n.has(a.id))continue;const i=eS(a,s.query,s.caseSensitive,s.nodeFields);i&&r.push(i)}return r},sS=e=>e.reduce((s,n)=>s+n.matches.length,0),nS=(e,s,n)=>{const o=n?s:s.toLowerCase(),a=(n?e:e.toLowerCase()).indexOf(o);return a===-1?null:{before:e.substring(0,a),matched:e.substring(a,a+s.length),after:e.substring(a+s.length)}},oS=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(""),[r,a]=p.useState(!1),[i,c]=p.useState(Zy),[l,d]=p.useState(new Set),[h,u]=p.useState(!1),f=p.useMemo(()=>({query:n,caseSensitive:r,nodeFields:i}),[n,r,i]),m=p.useMemo(()=>tS(e,f,l),[e,f,l]),y=p.useMemo(()=>sS(m),[m]),g=p.useCallback(b=>{d(A=>new Set(A).add(b))},[]),x=p.useCallback(()=>{d(new Set)},[]),w=p.useCallback(()=>{if(m.length>0){const b=m.map(A=>A.node);s(b)}},[m,s]),v=p.useCallback(b=>{const A=b.node;s([A]),T.getState().scrollToNode(A.id)},[s]),N=p.useCallback((b,A)=>{const R=b.node;s([R]);const k=ke.LINE_HEIGHT_FIND,S=A?(A-1)*k:0;yo(R,{highlightYOffset:S})},[s]);return{searchConfig:f,nodesWithMatches:m,totalMatchCount:y,excludedNodeIds:l,showSettings:h,setQuery:o,setCaseSensitive:a,setNodeFields:c,setShowSettings:u,removeNodeFromResults:g,clearExcludedNodes:x,handleSelectAllMatches:w,handleNodeClick:v,handleMatchClick:N}},Do=20,Uc=40,Vc=200,Gc=100;function Yc(e){if(e.length===0)return{x:0,y:0,width:Vc,height:Gc};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e){const i=a.width??Vc,c=a.height??Gc;s=Math.min(s,a.x),n=Math.min(n,a.y),o=Math.max(o,a.x+i),r=Math.max(r,a.y+c)}return{x:s-Do,y:n-Do-Uc,width:o-s+Do*2,height:r-n+Do*2+Uc}}const aS=({nodes:e})=>{const[s,n]=p.useState(null),[o,r]=p.useState([]),[a,i]=p.useState("horizontal"),[c,l]=p.useState(null),d=p.useMemo(()=>tw(e),[e]),h=p.useMemo(()=>rw(e,d),[e,d]),u=p.useMemo(()=>({mode:s,selectedTagIds:o,sliceArrangement:a}),[s,o,a]),f=p.useCallback(x=>{r(w=>w.includes(x)?w.filter(v=>v!==x):[...w,x])},[]),m=p.useCallback(x=>{const w=T.getState(),v=Od(e,x);if(v.length<2)return;c&&w.viewLayer.delete(c);const N=`(Unsaved) Group: ${x}`,b=w.viewLayer.create(N,{tagTitles:[x],arrangementStyle:"group"});if(!b)return;l(b);const A=Yc(v),R={id:Ve(10),name:x,x:A.x,y:A.y,width:A.width,height:A.height,childNodeIds:v.map(k=>k.id)};w.viewLayer.addGroupNode(b,R),n("group"),r([x])},[e,c]),y=p.useCallback(()=>{if(o.length===0)return;const x=T.getState(),w=aw(e,o,a);if(w.updates.length===0)return;e.map(k=>({id:k.id.slice(0,6),content:typeof k.content=="string"?k.content.slice(0,20):k.type,x:k.x,y:k.y,w:k.width,h:k.height,type:k.type,groupId:k.groupId})),c&&x.viewLayer.delete(c);const v=`(Unsaved) Slice: ${o.join(", ")}`,N=x.viewLayer.create(v,{tagTitles:o,arrangementStyle:"slice",sliceArrangement:a});if(!N)return;l(N),x.viewLayer.updateNodePositions(w.updates.map(k=>({id:k.id,x:k.x,y:k.y})));const b=[];w.lanes.forEach(k=>{if(k.nodeIds.length<2)return;const E=e.filter(O=>k.nodeIds.includes(O.id)).map(O=>{const H=w.updates.find(L=>L.id===O.id);return H?{...O,x:H.x,y:H.y}:O}),C=Yc(E),I={id:Ve(10),name:k.tagTitle,x:C.x,y:C.y,width:C.width,height:C.height,childNodeIds:k.nodeIds};x.viewLayer.addGroupNode(N,I),b.push({tagTitle:k.tagTitle,nodeIds:k.nodeIds})});const R=T.getState().viewLayer.getNodesWithEffectivePositions();R.map(k=>({id:k.id.slice(0,6),content:typeof k.content=="string"?k.content.slice(0,20):k.type,x:k.x,y:k.y,w:k.width,h:k.height,type:k.type,groupId:k.groupId})),R.filter(k=>k.type===fe.GROUP).map(k=>{var S;return{id:k.id.slice(0,6),content:k.content,x:k.x,y:k.y,w:k.width,h:k.height,childNodeIds:(S=k.data)==null?void 0:S.childNodeIds}}),n("slice")},[e,o,a,c]),g=p.useCallback(()=>{const x=T.getState();c&&(x.viewLayer.delete(c),l(null)),x.viewLayer.setActive(null),n(null),r([])},[c]);return{availableTags:d,nodesCountPerTag:h,config:u,canReset:s!==null,setMode:n,setSelectedTagIds:r,toggleTagSelection:f,setSliceArrangement:i,handleGroup:m,handleSlice:y,handleReset:g}},rS=({nodesWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemoveNode:a})=>t.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto","data-test":"search-results-list",children:e.map(i=>t.jsx(iS,{nodeWithMatches:i,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a},i.nodeId))}),iS=({nodeWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a})=>{const{node:i,matches:c,nodeId:l}=e;return t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"search-result",children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>a(l),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"search-result-remove",children:t.jsx(Ke,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none",children:[t.jsx(cS,{nodeWithMatches:e,onClick:()=>o(e)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":"search-result-matches",children:c.map((d,h)=>t.jsx(lS,{match:d,query:s,caseSensitive:n,onClick:()=>r(e,d.lineNumber),dataTest:"search-match"},h))})]})]})})},cS=({nodeWithMatches:e,onClick:s})=>{const{node:n,matches:o}=e,r=Ra(n.type),a=n.id.substring(0,6),i=typeof n.content=="string"?n.content:"",c=n.title?`${n.title.substring(0,30)}${n.title.length>30?"...":""}`:i?`${i.substring(0,30)}${i.length>30?"...":""}`:"(No Content)",l=n.title&&i?`${i.substring(0,50)}${i.length>50?"...":""}`:null;return t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:s,"data-test":"search-result-header",children:t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[r&&t.jsx("span",{className:"flex-shrink-0",children:r}),t.jsx("span",{className:"truncate",children:c}),n.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(lt,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[o.length," ",o.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:a})]}),l&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:l})]})})},lS=({match:e,query:s,caseSensitive:n,onClick:o,dataTest:r})=>{const a=nS(e.context,s,n);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",onClick:o,"data-test":r,children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:a?t.jsxs(t.Fragment,{children:[a.before,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:a.matched}),a.after]}):e.context})]})},dS=({searchConfig:e,nodesWithMatches:s,totalMatchCount:n,showSettings:o,onQueryChange:r,onCaseSensitiveChange:a,onNodeFieldsChange:i,onShowSettingsChange:c,onNodeClick:l,onMatchClick:d,onRemoveNode:h,onSelectAllMatches:u})=>{const{query:f,caseSensitive:m,nodeFields:y}=e,g=m||y.title||y.id||y.type||y.tags||!y.content,x=(w,v)=>{i({...y,[w]:v})};return t.jsxs("div",{className:"space-y-3","data-test":"filter-search-section",children:[t.jsxs("div",{className:"relative flex items-center gap-1","data-test":"filter-search-input-container",children:[t.jsx(Ss,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"filter-search-icon"}),t.jsx(ze,{type:"text",placeholder:"Search nodes...",value:f,onChange:w=>r(w.target.value),onKeyDown:w=>{w.key==="Enter"&&f.trim()&&(w.preventDefault(),u())},className:Ie("h-8 text-sm pl-8",f?"pr-16":"pr-10"),autoFocus:!0,"data-test":"filter-search-input"}),f&&t.jsx(se,{variant:"ghost",size:"icon",onClick:()=>r(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"filter-search-clear-button",children:t.jsx(Ke,{className:"h-3 w-3"})}),g&&t.jsx("div",{className:Ie("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",f?"right-16":"right-11"),"data-test":"filter-search-filter-indicator"}),t.jsx(uS,{showSettings:o,onShowSettingsChange:c,caseSensitive:m,onCaseSensitiveChange:a,nodeFields:y,onFieldChange:x})]}),f.trim()&&t.jsx(hS,{nodesWithMatches:s,totalMatchCount:n}),s.length>0&&t.jsx(rS,{nodesWithMatches:s,query:f,caseSensitive:m,onNodeClick:l,onMatchClick:d,onRemoveNode:h})]})},uS=({showSettings:e,onShowSettingsChange:s,caseSensitive:n,onCaseSensitiveChange:o,nodeFields:r,onFieldChange:a})=>t.jsxs(St,{open:e,onOpenChange:s,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"filter-search-settings-button",children:t.jsx(ka,{className:"h-3.5 w-3.5"})})}),t.jsx(jt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:We.draggablePopoverDropdown},"data-test":"filter-search-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(Ks,{id:"filter-case-sensitive",label:"Case sensitive",checked:n,onChange:o,dataTest:"filter-case-sensitive-checkbox"}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx(Ks,{id:"filter-content",label:"Content",checked:r.content,onChange:i=>a("content",i),dataTest:"filter-content-checkbox"}),t.jsx(Ks,{id:"filter-title",label:"Title",checked:r.title,onChange:i=>a("title",i),dataTest:"filter-title-checkbox"}),t.jsx(Ks,{id:"filter-id",label:"ID",checked:r.id,onChange:i=>a("id",i),dataTest:"filter-id-checkbox"}),t.jsx(Ks,{id:"filter-type",label:"Type",checked:r.type,onChange:i=>a("type",i),dataTest:"filter-type-checkbox"}),t.jsx(Ks,{id:"filter-tags",label:"Tags",checked:r.tags,onChange:i=>a("tags",i),dataTest:"filter-tags-checkbox"})]})]})]})})]}),Ks=({id:e,label:s,checked:n,onChange:o,dataTest:r})=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:e,checked:n,onCheckedChange:a=>o(!!a),"data-test":r}),t.jsx("label",{htmlFor:e,className:"text-sm cursor-pointer",children:s})]}),hS=({nodesWithMatches:e,totalMatchCount:s})=>t.jsx("div",{className:"flex items-center justify-between","data-test":"filter-search-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground",children:e.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found"," ",t.jsx(lt,{variant:"secondary",className:"mx-1",children:s}),s===1?"match":"matches"," in"," ",t.jsx(lt,{variant:"secondary",className:"mx-1",children:e.length}),e.length===1?"node":"nodes"]})})}),pS=({availableTags:e,nodesCountPerTag:s,selectedTagIds:n,showToggle:o,onToggleTag:r,onSetSelectedTags:a})=>{const i=n.length===e.length&&e.length>0;return t.jsxs("div",{className:"space-y-2","data-test":"tags-list-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Available Tags:"}),o&&t.jsx(se,{variant:"ghost",size:"icon",onClick:()=>{a(i?[]:e.map(c=>c.title))},className:"h-5 w-5",title:i?"Unselect all":"Select all","data-test":"tag-toggle-all-button",children:i?t.jsx(Hr,{className:"h-3 w-3"}):t.jsx(Kl,{className:"h-3 w-3"})})]}),t.jsx("div",{className:"flex flex-wrap gap-1.5","data-test":"tags-list",children:e.map(c=>{const l=s.get(c.title)??0,d=n.includes(c.title);return t.jsxs(lt,{variant:d?"default":"secondary",className:Ie("text-xs transition-colors cursor-pointer hover:bg-primary/80"),onClick:()=>r(c.title),"data-test":"tag-badge",children:[c.title,t.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",l,")"]})]},c.id)})})]})},gS=({availableTags:e,nodesCountPerTag:s,config:n,canReset:o,onModeChange:r,onToggleTag:a,onSetSelectedTags:i,onArrangementChange:c,onGroup:l,onSlice:d,onReset:h})=>{const{mode:u,selectedTagIds:f,sliceArrangement:m}=n;return e.length===0?t.jsx("div",{className:"text-xs text-muted-foreground py-2","data-test":"tag-organize-no-tags",children:"No tags found. Add tags to nodes to organize them."}):t.jsxs("div",{className:"space-y-3","data-test":"tag-organize-section",children:[t.jsxs("div",{className:"flex items-center gap-2","data-test":"tag-organize-actions",children:[t.jsx(Xc,{mode:"group",currentMode:u,icon:t.jsx(lo,{className:"h-3.5 w-3.5"}),label:"Group",onClick:()=>r(u==="group"?null:"group")}),t.jsx(Xc,{mode:"slice",currentMode:u,icon:t.jsx(_s,{className:"h-3.5 w-3.5"}),label:"Slice",onClick:()=>r(u==="slice"?null:"slice")}),o&&t.jsxs(se,{variant:"ghost",size:"sm",onClick:h,className:"h-7 text-xs","data-test":"tag-organize-reset-button",children:[t.jsx(ja,{className:"h-3.5 w-3.5 mr-1"}),"Reset"]})]}),u&&t.jsx("div",{className:"text-xs text-muted-foreground","data-test":"tag-organize-mode-description",children:u==="group"?"Select tags, then click Apply to create groups.":"Select tags, then click Apply to create swimlanes."}),u==="slice"&&t.jsxs("div",{className:"space-y-1.5","data-test":"slice-arrangement-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lane Layout:"}),t.jsxs("div",{className:"flex gap-1","data-test":"slice-arrangement-buttons",children:[t.jsx(Oo,{arrangement:"horizontal",currentArrangement:m,icon:t.jsx(Ds,{className:"h-3.5 w-3.5"}),onClick:()=>c("horizontal")}),t.jsx(Oo,{arrangement:"vertical",currentArrangement:m,icon:t.jsx(Bo,{className:"h-3.5 w-3.5"}),onClick:()=>c("vertical")}),t.jsx(Oo,{arrangement:"grid",currentArrangement:m,icon:t.jsx(lo,{className:"h-3.5 w-3.5"}),onClick:()=>c("grid")}),t.jsx(Oo,{arrangement:"masonry",currentArrangement:m,icon:t.jsx(zl,{className:"h-3.5 w-3.5"}),onClick:()=>c("masonry")})]})]}),t.jsx(pS,{availableTags:e,nodesCountPerTag:s,selectedTagIds:f,showToggle:u!==null,onToggleTag:a,onSetSelectedTags:i}),u==="group"&&f.length>0&&t.jsxs(se,{variant:"default",size:"sm",onClick:()=>{f.forEach(y=>l(y))},className:"w-full h-8","data-test":"tag-organize-apply-group-button",children:["Apply Groups (",f.length," tags)"]}),u==="slice"&&f.length>0&&t.jsxs(se,{variant:"default",size:"sm",onClick:d,className:"w-full h-8","data-test":"tag-organize-apply-slice-button",children:["Apply Swimlanes (",f.length," tags)"]})]})},Xc=({mode:e,currentMode:s,icon:n,label:o,onClick:r})=>{const a=s===e;return t.jsxs(se,{variant:a?"default":"outline",size:"sm",onClick:r,className:"h-7 text-xs","data-test":"tag-organize-mode-button",children:[n,t.jsx("span",{className:"ml-1",children:o})]})},Oo=({arrangement:e,currentArrangement:s,icon:n,onClick:o})=>{const r=s===e;return t.jsx(se,{variant:r?"default":"outline",size:"icon",onClick:o,className:"h-7 w-7",title:Jy[e],"data-test":"slice-arrangement-button",children:n})},fS=[],mS=()=>{const e=$(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.coreState.nodes)??fS}),s=$(o=>{var a;const r=o.projectCanvas.getActive();return r!=null&&r.activeViewLayerId?((a=r.viewLayers)==null?void 0:a.find(i=>i.id===r.activeViewLayerId))??null:null});return p.useMemo(()=>{if(!s)return e;const o=new Map(s.nodePositions.map(i=>[i.nodeId,i])),r=e.map(i=>{const c=o.get(i.id);return c?{...i,x:c.x,y:c.y}:i}),a=s.groupNodes.map(i=>({id:i.id,type:fe.GROUP,x:i.x,y:i.y,width:i.width,height:i.height,content:i.name,data:{childNodeIds:i.childNodeIds}}));return[...r,...a]},[e,s])},xS=()=>$(s=>{var n;return((n=s.projectCanvas.getActive())==null?void 0:n.activeViewLayerId)??null})!==null,yS=[],wS=()=>{const e=$(m=>{var y;return((y=m.projectCanvas.getActive())==null?void 0:y.viewLayers)??yS}),s=$(m=>{var y;return((y=m.projectCanvas.getActive())==null?void 0:y.activeViewLayerId)??null}),n=$(m=>m.viewLayer),o=p.useMemo(()=>[...e].sort((m,y)=>new Date(y.createdAt).getTime()-new Date(m.createdAt).getTime()),[e]),r=p.useMemo(()=>o.map(m=>({id:m.id,label:m.name,icon:t.jsx(lo,{className:"h-3 w-3 text-muted-foreground"}),data:{type:"view-layer",...m}})),[o]),a=p.useCallback(m=>{n.setActive(m.id)},[n]),i=p.useCallback(()=>{n.setActive(null)},[n]),c=p.useCallback((m,y)=>{n.rename(m,y)},[n]),l=p.useCallback(m=>{n.delete(m)},[n]),d=p.useCallback(m=>`Delete view "${m.label}"? This cannot be undone.`,[]),h=p.useCallback(m=>[{id:"duplicate",label:"Duplicate",icon:t.jsx(Bt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(m.id)}}],[n]),u=p.useCallback(()=>{const m=s?e.find(x=>x.id===s):null,y=m==null?void 0:m.name.startsWith("(Unsaved) ");let g;y&&m?g=m.name.replace("(Unsaved) ",""):g=`View ${e.filter(w=>!w.name.startsWith("(Unsaved)")).length+1}`,y&&s?n.rename(s,g):n.create(g)},[e,n,s]),f=s===null;return t.jsxs("div",{className:"view-layer-manager flex flex-col h-full w-full overflow-hidden","data-test":"view-layer-manager",children:[t.jsxs("div",{className:"view-list flex-1 min-h-0 w-full overflow-y-auto overflow-x-hidden p-2","data-test":"view-list-scroll-area",children:[t.jsxs("div",{className:Ie("flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",f&&"bg-primary/10 border border-primary"),onClick:i,"data-test":"base-view-item",children:[t.jsx("div",{className:"w-4 h-4 mr-2 flex-shrink-0"}),t.jsx(Cp,{className:"h-3 w-3 text-muted-foreground mr-2 flex-shrink-0"}),t.jsx("span",{className:"text-sm truncate flex-grow",children:"Base View"})]}),r.length>0&&t.jsx("div",{className:"mt-1","data-test":"saved-views-list",children:t.jsx(gn,{data:r,onItemClick:a,onUpdate:c,onDelete:l,selectedId:s,deleteConfirmMessage:d,enableEdit:!0,enableDelete:!0,enableDrag:!1,moreOptionsItems:h,dropdownZIndex:We.draggablePopoverDropdown})})]}),t.jsx("div",{className:"border-t p-2","data-test":"view-actions",children:t.jsxs(se,{variant:"outline",size:"sm",className:"w-full",onClick:u,"data-test":"view-save-button",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"}),"Save Current View"]})})]})},vS=[],bS=()=>{const e=$(p.useCallback(m=>{var y;return((y=m.projectCanvas.getActive())==null?void 0:y.coreState.nodes)??vS},[])),s=$(m=>m.setSelectedNodes),n=xS(),[o,r]=p.useState(!1),[a,i]=p.useState(null),c=p.useRef(null),l=oS({nodes:e,setSelectedNodes:s}),d=aS({nodes:e}),h=m=>{if(m.stopPropagation(),o){r(!1);return}if(c.current){const y=c.current.getBoundingClientRect();i({x:y.left-280-16,y:y.top})}r(!0)},u=t.jsx("button",{ref:c,onClick:h,onMouseDown:m=>m.stopPropagation(),className:Ie("p-1 rounded hover:bg-accent transition-colors",n&&"text-blue-500 bg-blue-500/10"),title:"Manage Views","data-test":"canvas-filter-views-button",children:t.jsx(lo,{className:"h-3.5 w-3.5"})}),f=t.jsxs("div",{className:"flex flex-col h-full","data-test":"canvas-filter-popover-content",children:[t.jsx("div",{className:"border-b border-border p-3","data-test":"canvas-filter-search-container",children:t.jsx(dS,{searchConfig:l.searchConfig,nodesWithMatches:l.nodesWithMatches,totalMatchCount:l.totalMatchCount,showSettings:l.showSettings,onQueryChange:l.setQuery,onCaseSensitiveChange:l.setCaseSensitive,onNodeFieldsChange:l.setNodeFields,onShowSettingsChange:l.setShowSettings,onNodeClick:l.handleNodeClick,onMatchClick:l.handleMatchClick,onRemoveNode:l.removeNodeFromResults,onSelectAllMatches:l.handleSelectAllMatches})}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3","data-test":"canvas-filter-organize-container",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Organize by Tags"}),n&&t.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded","data-test":"view-layer-active-badge",children:[t.jsx(_s,{className:"h-3 w-3"}),"View Active"]})]}),t.jsx(gS,{availableTags:d.availableTags,nodesCountPerTag:d.nodesCountPerTag,config:d.config,canReset:d.canReset,onModeChange:d.setMode,onToggleTag:d.toggleTagSelection,onSetSelectedTags:d.setSelectedTagIds,onArrangementChange:d.setSliceArrangement,onGroup:d.handleGroup,onSlice:d.handleSlice,onReset:d.handleReset})]})]});return t.jsxs(t.Fragment,{children:[t.jsx(Sn,{popoverId:"canvas-filter",icon:jp,tooltip:"Filter & Organize",popoverTitle:"Filter & Organize",popoverContent:f,leftOffset:120,initialSize:{width:360,height:500},dataTest:"canvas-filter-button",headerActions:u}),t.jsx(et,{isVisible:o,onClose:()=>r(!1),title:"Views",resizable:!0,initialSize:{width:280,height:350},triggerPosition:a??void 0,children:t.jsx(wS,{})})]})},NS=e=>{const{className:s,style:n}=e;return t.jsx(Yw,{children:t.jsxs(Ma,{className:s,style:n,position:"left",children:[t.jsx(ru,{}),t.jsx(GN,{}),t.jsx(bS,{}),t.jsx(YN,{extension:QN})]})})},SS=()=>{const e=$(i=>i.uiState.mode),s=$(i=>i.uiState.selectFromDrawMode),{setMode:n,setUiState:o}=T.getState(),r=e===ee.SELECT&&s,a=()=>{r?(o(i=>({...i,selectFromDrawMode:!1})),T.getState().setSelectedNodes([]),T.getState().arrow.setSelected([]),n(ee.DRAW)):(o(i=>({...i,selectFromDrawMode:!0})),n(ee.SELECT))};return t.jsx(se,{variant:r?"default":"outline",size:"icon",onPointerUp:a,title:r?"Back to Draw Mode":"Select Mode (select/drag nodes)","data-test":"draw-mode-select-button",children:t.jsx(kl,{className:"h-4 w-4"})})},Pa=()=>"right",CS=()=>{const[e,s]=p.useState(!1),n=$(u=>u.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=T.getState(),a=(n==null?void 0:n.strokeColor)??"currentColor",i=a==="currentColor"?"hsl(var(--foreground))":a,c=(n==null?void 0:n.opacity)??1,l=c<1,d=u=>{o({strokeColor:u}),r(l?f=>({...f,markerStrokeColor:u}):f=>({...f,penStrokeColor:u}))},h=u=>{o({opacity:u[0]})};return t.jsxs(St,{open:e,onOpenChange:s,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"outline",size:"icon",title:`Stroke Color (${Math.round(c*100)}% opacity)`,"data-test":"draw-mode-stroke-color-button",children:t.jsx("span",{style:{width:"16px",height:"16px",borderRadius:"3px",backgroundColor:i,opacity:c,border:"1px solid hsl(var(--border))"}})})}),t.jsx(jt,{className:"w-auto p-0",side:Pa(),sideOffset:8,onCloseAutoFocus:u=>u.preventDefault(),"data-test":"draw-mode-stroke-color-popover",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(qr,{label:"Stroke Color",currentColor:a,onColorSelect:d}),t.jsxs("div",{className:"px-3 pb-3 space-y-2","data-test":"draw-mode-opacity-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(c*100),"%"]})]}),t.jsx(cs,{value:[c],min:.1,max:1,step:.05,onValueChange:h,className:"w-full","data-test":"draw-mode-opacity-slider"})]})]})})]})},jS=[1,2,3,4,5,6,8,10,12,16,20,28,40,60],kS=()=>{const[e,s]=p.useState(!1),n=$(l=>l.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=T.getState(),a=(n==null?void 0:n.strokeWidth)??ar,i=((n==null?void 0:n.opacity)??1)<1,c=l=>{o({strokeWidth:l}),r(i?d=>({...d,markerStrokeWidth:l}):d=>({...d,penStrokeWidth:l})),s(!1)};return t.jsxs(St,{open:e,onOpenChange:s,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"outline",size:"icon",title:`Stroke Width: ${a}px`,"data-test":"draw-mode-stroke-width-button",children:t.jsxs("div",{className:"flex flex-col gap-[2px] items-center",children:[t.jsx("span",{style:{width:"14px",height:"1px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"2px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"4px",backgroundColor:"currentColor",borderRadius:"1px"}})]})})}),t.jsx(jt,{className:"w-auto p-3",side:Pa(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1 flex-wrap max-w-[200px]",children:jS.map(l=>t.jsxs("button",{type:"button",title:`${l}px`,onClick:()=>c(l),className:`w-10 h-8 flex items-center justify-center gap-1 rounded border cursor-pointer hover:bg-accent ${a===l?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-stroke-width-button",children:[t.jsx("span",{style:{width:"12px",height:`${Math.min(l,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}}),t.jsx("span",{className:"text-[10px] text-muted-foreground",children:l})]},l))})]})})]})},IS=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}],Kc=({style:e})=>{const s=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("svg",{width:"16",height:"8",viewBox:"0 0 16 8",children:t.jsx("line",{x1:"0",y1:"4",x2:"16",y2:"4",stroke:"currentColor",strokeWidth:"2",strokeDasharray:s,strokeLinecap:"round"})})},AS=()=>{const[e,s]=p.useState(!1),n=$(c=>c.uiState.drawStyle),{setDrawStyle:o}=T.getState(),r=(n==null?void 0:n.strokeStyle)??"solid",a=c=>{o({strokeStyle:c}),s(!1)},i=c=>{s(c)};return t.jsxs(St,{open:e,onOpenChange:i,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"outline",size:"icon",title:`Stroke Style: ${r}`,"data-test":"draw-mode-stroke-style-button",onPointerDown:c=>{c.stopPropagation()},onPointerUp:c=>{c.stopPropagation()},children:t.jsx(Kc,{style:r})})}),t.jsx(jt,{className:"w-auto p-3",side:Pa(),sideOffset:8,onCloseAutoFocus:c=>c.preventDefault(),"data-test":"draw-mode-stroke-style-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-style-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Style"}),t.jsx("div",{className:"flex gap-1",children:IS.map(c=>t.jsx("button",{type:"button",title:c.label,onClick:()=>a(c.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${r===c.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-stroke-style-option",children:t.jsx(Kc,{style:c.value})},c.value))})]})})]})},TS=()=>t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:t.jsx("ellipse",{cx:"8",cy:"8",rx:"7",ry:"4"})}),qc=[{value:Pe.SQUARE,label:"Square",icon:t.jsx(Kl,{className:"h-4 w-4"})},{value:Pe.RECTANGLE,label:"Rectangle",icon:t.jsx(Jt,{className:"h-4 w-4"})},{value:Pe.CIRCLE,label:"Circle",icon:t.jsx(Ca,{className:"h-4 w-4"})},{value:Pe.ELLIPSE,label:"Ellipse",icon:t.jsx(TS,{})},{value:Pe.ARROW,label:"Arrow",icon:t.jsx(Tp,{className:"h-4 w-4"})}],ES=()=>{const[e,s]=p.useState(!1),n=$(l=>l.uiState.drawSubMode),{setDrawSubMode:o,setDrawStyle:r}=T.getState(),a=n&&[Pe.SQUARE,Pe.RECTANGLE,Pe.CIRCLE,Pe.ELLIPSE,Pe.ARROW].includes(n),i=qc.find(l=>l.value===n),c=l=>{o(l),r({opacity:1}),s(!1)};return t.jsxs(St,{open:e,onOpenChange:s,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:a?"default":"outline",size:"icon",title:i?`Shape: ${i.label}`:"Shapes","data-test":"draw-mode-shape-button",children:a&&i?i.icon:t.jsx(Ap,{className:"h-4 w-4"})})}),t.jsx(jt,{className:"w-auto p-3",side:Pa(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-shape-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-shape-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Shapes"}),t.jsx("div",{className:"flex gap-1",children:qc.map(l=>t.jsx("button",{type:"button",title:l.label,onClick:()=>c(l.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${n===l.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-shape-button",children:l.icon},l.value))}),t.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Click to switch to shape mode. Drag to draw."})]})})]})},RS=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=$(R=>R.uiState.drawStyle),i=$(R=>R.uiState.penStrokeWidth)??ar,c=$(R=>R.uiState.markerStrokeWidth)??qu,l=$(R=>R.uiState.penStrokeColor)??"currentColor",d=$(R=>R.uiState.markerStrokeColor)??Q.drawing.markerColor,h=$(R=>R.uiState.drawAxisLock)??"none",{setDrawStyle:u,setDrawAxisLock:f,setUiState:m,setDrawSubMode:y}=T.getState(),g=((a==null?void 0:a.opacity)??1)<1,x=(a==null?void 0:a.strokeWidth)??ar,w=(a==null?void 0:a.strokeColor)??"currentColor",v=()=>{g?(m(R=>({...R,markerStrokeWidth:x,markerStrokeColor:w})),u({opacity:1,strokeWidth:i,strokeColor:l})):(m(R=>({...R,penStrokeWidth:x,penStrokeColor:w})),u({opacity:Q.drawing.markerOpacity,strokeWidth:c,strokeColor:d}),y(Pe.FREEHAND))},N=R=>{if(R.stopPropagation(),e){s(!1);return}if(r.current){const k=r.current.getBoundingClientRect();o({x:k.right+8,y:k.top})}s(!0)},b=R=>{f(R?"horizontal":"none")},A=R=>{f(R?"vertical":"none")};return t.jsxs("div",{ref:r,className:"relative inline-flex group","data-test":"draw-mode-marker-container",children:[t.jsx(se,{variant:g?"default":"outline",size:"icon",onPointerUp:v,title:g?"Marker Mode (On)":"Marker Mode (Off)","data-test":"draw-mode-marker-toggle",children:t.jsx(Al,{className:"h-4 w-4"})}),t.jsxs("div",{className:Ie("absolute right-0 top-0 bottom-0 translate-x-full","flex items-stretch","opacity-0 group-hover:opacity-100 transition-opacity duration-150","pointer-events-none group-hover:pointer-events-auto"),"data-test":"draw-mode-marker-caret-trigger",children:[t.jsx("div",{className:"w-[3px] bg-foreground/10"}),t.jsx("button",{type:"button",onClick:N,className:Ie("flex items-center justify-center","px-1 rounded-r-md","bg-foreground/5 hover:bg-foreground/10","transition-colors duration-150","cursor-pointer"),"aria-label":"Drawing options",title:"Drawing options","data-test":"draw-mode-marker-caret-button",children:t.jsx(ss,{className:"h-3 w-3 text-foreground/60"})})]}),t.jsx(et,{isVisible:e,onClose:()=>s(!1),title:"Drawing Options",initialPosition:n??{x:100,y:100},showPinButton:!1,showInspectorButton:!1,children:t.jsx("div",{className:"p-3 space-y-4","data-test":"draw-mode-options-popover-content",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Axis Lock"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lock drawing to a straight line"}),t.jsxs("div",{className:"space-y-2 mt-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"lock-horizontal",checked:h==="horizontal",onCheckedChange:b,"data-test":"draw-mode-lock-horizontal-checkbox"}),t.jsx(Fe,{htmlFor:"lock-horizontal",className:"text-sm font-normal cursor-pointer",children:"Lock Horizontal (constant Y)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"lock-vertical",checked:h==="vertical",onCheckedChange:A,"data-test":"draw-mode-lock-vertical-checkbox"}),t.jsx(Fe,{htmlFor:"lock-vertical",className:"text-sm font-normal cursor-pointer",children:"Lock Vertical (constant X)"})]})]})]})})})]})},MS=e=>{const{className:s}=e,{setMode:n,undo:o}=T.getState(),r=$(h=>h.undo.canUndo()),a=$(h=>h.undo.canRedo()),i=()=>{T.getState().setUiState(h=>({...h,selectFromDrawMode:!1})),n(ee.SELECT)},c=()=>{o.undo()},l=()=>{o.redo()};return t.jsxs(Ma,{position:"left",className:s,children:[t.jsx(se,{variant:"outline",size:"icon",onPointerUp:i,title:"Exit Draw Mode (Esc)","data-test":"draw-mode-exit-button",children:t.jsx(Ke,{className:"h-5 w-5"})}),t.jsx(SS,{}),t.jsx(CS,{}),t.jsx(kS,{}),t.jsx(AS,{}),t.jsx(ES,{}),t.jsx(RS,{}),t.jsx(po,{expandContent:t.jsx(da,{onSelect:h=>o.jumpTo(h)}),expandTitle:"History",onClick:c,onHoldRepeat:c,holdRepeatInterval:Q.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!r,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"draw-mode-undo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(ha,{}),t.jsx(pa,{}),t.jsx(ua,{})]}),children:t.jsx(kp,{className:"h-5 w-5"})}),t.jsx(po,{expandContent:t.jsx(da,{onSelect:h=>o.jumpTo(h)}),expandTitle:"History",onClick:l,onHoldRepeat:l,holdRepeatInterval:Q.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!a,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"draw-mode-redo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(ha,{}),t.jsx(pa,{}),t.jsx(ua,{})]}),children:t.jsx(Ip,{className:"h-5 w-5"})})]})},PS=He.memo(MS),Zc="paper-texture-live-config",DS="paper-texture-saved-presets";function OS({onTextureChange:e}){return t.jsx(Sn,{popoverId:"paper-texture-config",icon:Ep,tooltip:"Paper Texture Live Preview",popoverTitle:"Paper Texture",initialSize:{width:320,height:420},leftOffset:120,buttonVariant:"ghost",buttonSize:"icon",dataTest:"paper-texture-config-button",popoverContent:t.jsx(LS,{onTextureChange:e})})}function LS({onTextureChange:e}){const[s,n]=p.useState(()=>{try{const a=localStorage.getItem(Zc);if(a)return JSON.parse(a)}catch{}return{params:vl.medium,activePreset:"medium"}}),[o,r]=p.useState(()=>{var i,c,l;const a=(l=(c=(i=T.getState().preferences)==null?void 0:i.canvasConfig)==null?void 0:c.background)==null?void 0:l.savedPresets;if(a&&a.length>0)return a;try{const d=localStorage.getItem(DS);if(d){const h=JSON.parse(d);return h.length>0&&T.setState(u=>{var f,m,y;return{...u,preferences:{...u.preferences,canvasConfig:{...(f=u.preferences)==null?void 0:f.canvasConfig,background:{...(y=(m=u.preferences)==null?void 0:m.canvasConfig)==null?void 0:y.background,savedPresets:h}}}}}),h}}catch{}return Q.background.savedPresets});return p.useEffect(()=>{localStorage.setItem(Zc,JSON.stringify(s))},[s]),p.useEffect(()=>{T.setState(a=>{var i,c,l;return{...a,preferences:{...a.preferences,canvasConfig:{...(i=a.preferences)==null?void 0:i.canvasConfig,background:{...(l=(c=a.preferences)==null?void 0:c.canvasConfig)==null?void 0:l.background,savedPresets:o}}}}}),Q.background.savedPresets=o},[o]),t.jsx(WS,{config:s,setConfig:n,savedPresets:o,setSavedPresets:r,onTextureChange:e})}function WS({config:e,setConfig:s,savedPresets:n,setSavedPresets:o,onTextureChange:r}){const{params:a,activePreset:i}=e,[c,l]=p.useState(null),[d,h]=p.useState(""),{theme:u}=bl(),f=p.useMemo(()=>u==="dark"?!0:u==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[u]),m=100-a.bgLightness;p.useEffect(()=>{T.setState(k=>{var S;return{...k,preferences:{...k.preferences,canvasConfig:{...(S=k.preferences)==null?void 0:S.canvasConfig,background:{paperTexture:typeof i=="string"&&!Ho.includes(i)?"custom":i,customParams:a}}}}}),Q.background.paperTexture=typeof i=="string"&&!Ho.includes(i)?"custom":i,Q.background.customParams=a},[a,i]);const y=(k,S)=>{s(E=>({...E,params:{...E.params,[k]:S},activePreset:"custom"}))},g=k=>{k!=="custom"&&(s({params:vl[k],activePreset:k}),r==null||r(k))},x=k=>{s({params:k.params,activePreset:k.id})},w=()=>{g("none")},v=()=>{const k={id:`preset-${Date.now()}`,name:`Preset ${n.length+1}`,params:{...a}};o(S=>[...S,k]),s(S=>({...S,activePreset:k.id}))},N=k=>{o(S=>S.filter(E=>E.id!==k)),i===k&&g("none")},b=k=>{l(k.id),h(k.name)},A=()=>{c&&d.trim()&&o(k=>k.map(S=>S.id===c?{...S,name:d.trim()}:S)),l(null),h("")},R=()=>{l(null),h("")};return t.jsxs("div",{className:"texture-config space-y-4 p-4","data-test":"texture-config",children:[t.jsxs("div",{className:"presets","data-test":"texture-presets",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx(Fe,{className:"text-xs text-muted-foreground uppercase",children:"Presets"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:v,"data-test":"save-preset",children:[t.jsx(hs,{className:"w-3 h-3 mr-1"}),"Save"]}),t.jsxs(se,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:w,"data-test":"reset-texture",children:[t.jsx(ja,{className:"w-3 h-3 mr-1"}),"Reset"]})]})]}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:Ho.filter(k=>k!=="custom").map(k=>t.jsx(se,{variant:i===k?"default":"outline",size:"sm",className:"h-7 text-xs",onClick:()=>g(k),"data-test":"paper-texture-preset-button",children:Nl[k]},k))})]}),n.length>0&&t.jsxs("div",{className:"saved-presets","data-test":"saved-presets",children:[t.jsx(Fe,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Saved"}),t.jsx("div",{className:"space-y-1",children:n.map(k=>t.jsx("div",{className:"flex items-center gap-1","data-test":"paper-texture-saved-preset",children:c===k.id?t.jsxs(t.Fragment,{children:[t.jsx(ze,{value:d,onChange:S=>h(S.target.value),className:"h-7 text-xs flex-1",onKeyDown:S=>{S.key==="Enter"&&A(),S.key==="Escape"&&R()},autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:A,"data-test":"save-preset-name",children:t.jsx(vn,{className:"w-3 h-3"})}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:R,"data-test":"cancel-edit",children:t.jsx(Ke,{className:"w-3 h-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(se,{variant:i===k.id?"default":"outline",size:"sm",className:"h-7 text-xs flex-1 justify-start",onClick:()=>x(k),"data-test":"load-saved-preset",children:k.name}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>b(k),"data-test":"edit-preset",children:t.jsx(Xl,{className:"w-3 h-3"})}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:()=>N(k.id),"data-test":"delete-preset",children:t.jsx(Nt,{className:"w-3 h-3"})})]})},k.id))})]}),t.jsxs("div",{className:"controls space-y-3","data-test":"texture-controls",children:[t.jsx(Fe,{className:"text-xs text-muted-foreground uppercase",children:"Texture"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-frequency",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Fe,{className:"text-xs",children:"Frequency"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.baseFrequency.toFixed(2)})]}),t.jsx(cs,{value:[a.baseFrequency],onValueChange:([k])=>y("baseFrequency",k),min:.1,max:2,step:.05})]}),t.jsxs("div",{className:"control-group","data-test":"control-octaves",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Fe,{className:"text-xs",children:"Octaves"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.numOctaves})]}),t.jsx(cs,{value:[a.numOctaves],onValueChange:([k])=>y("numOctaves",k),min:1,max:6,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-opacity",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Fe,{className:"text-xs",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[(a.opacity*100).toFixed(0),"%"]})]}),t.jsx(cs,{value:[a.opacity],onValueChange:([k])=>y("opacity",k),min:0,max:.8,step:.05})]})]})]}),t.jsxs("div",{className:"bg-controls space-y-3","data-test":"bg-controls",children:[t.jsx(Fe,{className:"text-xs text-muted-foreground uppercase",children:"Background"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-hue",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Fe,{className:"text-xs",children:"Hue"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgHue,"°"]})]}),t.jsx(cs,{value:[a.bgHue],onValueChange:([k])=>y("bgHue",k),min:0,max:360,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-saturation",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Fe,{className:"text-xs",children:"Saturation"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgSaturation,"%"]})]}),t.jsx(cs,{value:[a.bgSaturation],onValueChange:([k])=>y("bgSaturation",k),min:0,max:100,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-lightness",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Fe,{className:"text-xs",children:"Lightness"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgLightness,"%"]})]}),t.jsx(cs,{value:[a.bgLightness],onValueChange:([k])=>y("bgLightness",k),min:0,max:100,step:1})]})]})]}),t.jsxs("div",{className:"preview","data-test":"texture-preview",children:[t.jsx(Fe,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Preview"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{className:"relative","data-test":"preview-light",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(Rp,{className:`w-3 h-3 ${f?"text-muted-foreground":"text-primary"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${f?"":"ring-2 ring-primary"}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${a.bgLightness}%)`},"data-test":"preview-swatch-light",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-light"})})]}),t.jsxs("div",{className:"relative","data-test":"preview-dark",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(Mp,{className:`w-3 h-3 ${f?"text-primary":"text-muted-foreground"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${f?"ring-2 ring-primary":""}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${m}%)`},"data-test":"preview-swatch-dark",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-dark"})})]})]})]})]})}function Jc({title:e,action:s,isOpen:n}){return t.jsxs("div",{"data-test":"settings-section-header",className:"border-b pb-1 mb-3 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Pt,{className:Ie("h-3 w-3 text-muted-foreground transition-transform",!n&&"-rotate-90")}),t.jsx("h3",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:e})]}),s]})}function HS(){var k;const[e,s]=p.useState(""),[n,o]=p.useState(new Set),r=S=>{o(E=>{const C=new Set(E);return C.has(S)?C.delete(S):C.add(S),C})},a=$(S=>{var E,C;return((C=(E=S.preferences)==null?void 0:E.arrangeButton)==null?void 0:C.nodeGap)??ke.ARRANGE_NODE_GAP}),i=$(S=>{var E,C;return((C=(E=S.preferences)==null?void 0:E.arrangeButton)==null?void 0:C.gridColumns)??ke.ARRANGE_GRID_COLUMNS}),c=$(S=>S.getArrangeGridRows()),l=$(S=>S.setArrangeNodeGap),d=$(S=>S.setArrangeGridColumns),h=$(S=>S.setArrangeGridRows),u=async S=>{Q.persistState=!!S.persistState,Q.autosave=!!S.autosave,Q.hideOverlay=!!S.hideOverlay,Q.hideToolbar=!!S.hideToolbar,Q.background.paperTexture=S.backgroundPaperTexture,Q.arrows.type=S.arrowType,Q.arrows.REVERSE_CURVE=!!S.arrowReverseCurve,Q.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=Number(S.arrowSShapeFactor),Q.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=!!S.arrowSShapeReversed,Q.arrows.CUBIC_HORIZONTAL_BIAS=Number(S.arrowHorizontalBias),Q.arrows.reverseArrowOnMultipleConnect=!!S.arrowReverseOnMultipleConnect,Q.highlightAndCreate.createConnectingArrow=!!S.highlightCreateArrow,Q.highlightAndCreate.createHighlight=!!S.highlightCreateHighlight,Q.nodeOptions.maxNodeWidth=Number(S.nodeMaxWidth),Q.nodeOptions.resizeBorderWidth=Number(S.nodeResizeBorderWidth),Q.zoom.min=Number(S.zoomMin),Q.zoom.max=Number(S.zoomMax),Q.zoom.intensity=Number(S.zoomIntensity),Q.history.historyLimit=Number(S.historyLimit),Q.history.tabletHistoryLimit=Number(S.tabletHistoryLimit),Q.history.archiveLimit=Number(S.archiveLimit),Q.history.tabletArchiveLimit=Number(S.tabletArchiveLimit),Q.holdToSelect.holdDurationMs=Number(S.holdDurationMs),Q.holdToSelect.movementThresholdPx=Number(S.holdMovementThresholdPx),Q.holdToSelect.indicatorDelayMs=Number(S.holdIndicatorDelayMs),Q.holdToSelect.indicatorTopOffset=Number(S.holdIndicatorTopOffset),Q.holdToSelect.indicatorBottomOffset=Number(S.holdIndicatorBottomOffset),T.setState(E=>{var C,I,O;return{...E,preferences:{...E.preferences,splitNodeGap:Number(S.splitNodeGap),canvasConfig:{...(C=E.preferences)==null?void 0:C.canvasConfig,persistState:!!S.persistState,autosave:!!S.autosave,hideOverlay:!!S.hideOverlay,hideToolbar:!!S.hideToolbar,background:{...(O=(I=E.preferences)==null?void 0:I.canvasConfig)==null?void 0:O.background,paperTexture:S.backgroundPaperTexture},arrows:{type:S.arrowType,REVERSE_CURVE:!!S.arrowReverseCurve,CUBIC_ARROW_S_SHAPE_FACTOR:Number(S.arrowSShapeFactor),CUBIC_ARROW_S_SHAPE_REVERSED:!!S.arrowSShapeReversed,CUBIC_HORIZONTAL_BIAS:Number(S.arrowHorizontalBias),reverseArrowOnMultipleConnect:!!S.arrowReverseOnMultipleConnect},nodeOptions:{maxNodeWidth:Number(S.nodeMaxWidth),resizeBorderWidth:Number(S.nodeResizeBorderWidth)},zoom:{min:Number(S.zoomMin),max:Number(S.zoomMax),intensity:Number(S.zoomIntensity)}}},uiState:{...E.uiState,isOverlayVisible:!S.hideOverlay,toolbar:{...E.uiState.toolbar,isVisible:!S.hideToolbar}}}}),Ee.success("Settings saved!",{description:"Canvas configuration has been updated.",duration:3e3})},f=[{title:"Persistence",fields:[{name:"persistState",label:"Persist State",type:"checkbox"},{name:"autosave",label:"Autosave",type:"checkbox"}]},{title:"UI",fields:[{name:"hideOverlay",label:"Hide Overlay",type:"checkbox"},{name:"hideToolbar",label:"Hide Toolbar",type:"checkbox"}]},{title:"Background",fields:[{name:"backgroundPaperTexture",label:"Paper Texture",type:"select",options:Ho.map(S=>({value:S,label:Nl[S]}))}]},{title:"Highlight & Create ($)",fields:[{name:"highlightCreateArrow",label:"Create Connecting Arrow",type:"checkbox"},{name:"highlightCreateHighlight",label:"Create Highlight",type:"checkbox"}]},{title:"Arrows",fields:[{name:"arrowType",label:"Type",type:"select",options:Zu.map(S=>({value:S,label:Ju[S]}))},{name:"arrowSShapeFactor",label:"S-Shape Factor",type:"number",placeholder:"0-2",step:.1},{name:"arrowHorizontalBias",label:"Horizontal Bias",type:"number",placeholder:"0=auto, 1=none",step:.1},{name:"arrowReverseCurve",label:"Reverse Curve",type:"checkbox"},{name:"arrowSShapeReversed",label:"S-Shape Reversed",type:"checkbox"},{name:"arrowReverseOnMultipleConnect",label:"Reverse on Multiple Connect",type:"checkbox"}]},{title:"Nodes",fields:[{name:"nodeMaxWidth",label:"Max Width (px)",type:"number",placeholder:"100-2000"},{name:"nodeResizeBorderWidth",label:"Resize Border Width (px)",type:"number",placeholder:"1-50"},{name:"splitNodeGap",label:"Split Node Gap (px)",type:"number",placeholder:"0-100"}]},{title:"Zoom",fields:[{name:"zoomMin",label:"Min",type:"number",placeholder:"0.01-1"},{name:"zoomMax",label:"Max",type:"number",placeholder:"1-10"},{name:"zoomIntensity",label:"Intensity",type:"number",placeholder:"0.01-1"}]},{title:"Hold-to-Select (Phone)",fields:[{name:"holdDurationMs",label:"Hold Duration (ms)",type:"number",placeholder:"500-3000"},{name:"holdMovementThresholdPx",label:"Movement Threshold (px)",type:"number",placeholder:"5-50"},{name:"holdIndicatorDelayMs",label:"Indicator Delay (ms)",type:"number",placeholder:"0-500"},{name:"holdIndicatorTopOffset",label:"Indicator Top Offset (px)",type:"number",placeholder:"0-100"},{name:"holdIndicatorBottomOffset",label:"Indicator Bottom Offset (px)",type:"number",placeholder:"0-150"}]}],[m,y]=p.useState(!1);p.useEffect(()=>{const S=()=>y(window.innerWidth<1280);return S(),window.addEventListener("resize",S),()=>window.removeEventListener("resize",S)},[]);const g={title:"History",fields:m?[{name:"tabletHistoryLimit",label:"In-Memory Limit",type:"number",placeholder:"10-200"},{name:"tabletArchiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-1000"}]:[{name:"historyLimit",label:"In-Memory Limit",type:"number",placeholder:"10-500"},{name:"archiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-2000"}]},x=[...f,g],w=p.useMemo(()=>{const S=x.map(E=>E.title);return S.push("Arrange"),S},[x]),v=()=>o(new Set(w)),N=()=>o(new Set),b=p.useMemo(()=>{if(!e.trim())return x;const S=e.toLowerCase();return x.filter(E=>E.title.toLowerCase().includes(S))},[x,e]),A=p.useMemo(()=>e.trim()?"arrange".includes(e.toLowerCase()):!0,[e]),R={persistState:Q.persistState,autosave:Q.autosave,hideOverlay:Q.hideOverlay,hideToolbar:Q.hideToolbar,backgroundPaperTexture:Q.background.paperTexture,highlightCreateArrow:Q.highlightAndCreate.createConnectingArrow,highlightCreateHighlight:Q.highlightAndCreate.createHighlight,arrowType:Q.arrows.type,arrowReverseCurve:Q.arrows.REVERSE_CURVE,arrowSShapeFactor:Q.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,arrowSShapeReversed:Q.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,arrowHorizontalBias:Q.arrows.CUBIC_HORIZONTAL_BIAS,arrowReverseOnMultipleConnect:Q.arrows.reverseArrowOnMultipleConnect,nodeMaxWidth:Q.nodeOptions.maxNodeWidth,nodeResizeBorderWidth:Q.nodeOptions.resizeBorderWidth,splitNodeGap:((k=T.getState().preferences)==null?void 0:k.splitNodeGap)??ke.NEW_NODE_SEGMENT_SPACING,zoomMin:Q.zoom.min,zoomMax:Q.zoom.max,zoomIntensity:Q.zoom.intensity,historyLimit:Q.history.historyLimit,tabletHistoryLimit:Q.history.tabletHistoryLimit,archiveLimit:Q.history.archiveLimit,tabletArchiveLimit:Q.history.tabletArchiveLimit,holdDurationMs:Q.holdToSelect.holdDurationMs,holdMovementThresholdPx:Q.holdToSelect.movementThresholdPx,holdIndicatorDelayMs:Q.holdToSelect.indicatorDelayMs,holdIndicatorTopOffset:Q.holdToSelect.indicatorTopOffset,holdIndicatorBottomOffset:Q.holdToSelect.indicatorBottomOffset};return t.jsxs(hn,{className:"h-full",children:[t.jsx("div",{className:"sticky top-0 z-10 bg-background p-3 pb-2 border-b","data-test":"settings-search-header",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(Ss,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),t.jsx(ze,{type:"text",placeholder:"Search settings...",value:e,onChange:S=>s(S.target.value),className:"h-7 pl-7 text-xs","data-test":"settings-search-input"})]}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:N,title:"Expand all sections","data-test":"settings-expand-all-button",children:t.jsx(Pp,{className:"h-4 w-4"})}),t.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:v,title:"Collapse all sections","data-test":"settings-collapse-all-button",children:t.jsx(Dp,{className:"h-4 w-4"})})]})}),t.jsxs(ig,{onSubmit:u,defaultValues:R,className:"p-3 space-y-4",formId:"canvas-settings-form",children:[b.map(S=>{const E=!n.has(S.title);return t.jsxs(Es,{open:E,onOpenChange:()=>r(S.title),"data-test":"settings-section-collapsible",children:[t.jsx(Rs,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:C=>{C.altKey&&(C.preventDefault(),v())},children:t.jsx(Jc,{title:S.title,action:S.title==="Background"?t.jsx(OS,{}):void 0,isOpen:E})})}),t.jsx(Ms,{children:t.jsx(cg,{fields:S.fields,layout:"two-column",className:"space-y-2",labelClassName:"text-xs"})})]},S.title)}),A&&t.jsxs(Es,{open:!n.has("Arrange"),onOpenChange:()=>r("Arrange"),"data-test":"settings-section-arrange",children:[t.jsx(Rs,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:S=>{S.altKey&&(S.preventDefault(),v())},children:t.jsx(Jc,{title:"Arrange",isOpen:!n.has("Arrange")})})}),t.jsx(Ms,{children:t.jsx(Ur,{nodeGap:a,gridColumns:i,gridRows:c,onNodeGapChange:l,onGridColumnsChange:d,onGridRowsChange:h,showRows:!0})})]})]})]})}const FS=()=>{const e=T.getState(),s=e.exportCanvasData,n=e.importCanvasData,o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(!1),[l,d]=p.useState(null),h=()=>{var f;(f=o.current)==null||f.click()},u=f=>{var g;const m=(g=f.target.files)==null?void 0:g[0];if(!m)return;a(!0),d(null);const y=new FileReader;y.onload=x=>{var v;const w=(v=x.target)==null?void 0:v.result;if(typeof w=="string"){const N=n(w,{replace:i});d(N),N.projectsImported>0&&Ee.success(`Successfully imported ${N.projectsImported} project${N.projectsImported>1?"s":""}`),N.projectsSkipped>0&&Ee.warning(`Skipped ${N.projectsSkipped} project${N.projectsSkipped>1?"s":""} (already exist)`),N.projectsImported===0&&N.projectsSkipped===0&&Ee.error("No projects found in the import file")}else console.error("Failed to read file content."),Ee.error("Failed to read file content");a(!1),o.current&&(o.current.value="")},y.onerror=x=>{console.error("Error reading file:",x),Ee.error("Error reading file"),a(!1),o.current&&(o.current.value="")},y.readAsText(m)};return t.jsxs("div",{className:"space-y-4","data-test":"data-io-panel",children:[t.jsxs("div",{"data-test":"data-export-section",children:[t.jsx(Fe,{className:"text-sm font-medium",children:"Export"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download all canvas projects as JSON"}),t.jsxs(se,{variant:"outline",size:"sm",onClick:s,className:"w-full","data-test":"canvas-export-button",children:[t.jsx(Op,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),t.jsxs("div",{"data-test":"data-import-section",children:[t.jsx(Fe,{className:"text-sm font-medium",children:"Import"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import canvas projects from a JSON file"}),t.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"canvas-replace-mode-control",children:[t.jsxs("div",{children:[t.jsx(Fe,{htmlFor:"canvas-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),t.jsx(qo,{id:"canvas-replace-mode",checked:i,onCheckedChange:c,disabled:r,"data-test":"canvas-replace-mode-switch"})]}),t.jsxs(se,{variant:"outline",size:"sm",onClick:h,disabled:r,className:"w-full","data-test":"canvas-import-select-file-button",children:[t.jsx(Lp,{className:"h-4 w-4 mr-2"}),r?"Importing...":"Select File"]}),t.jsx("input",{type:"file",ref:o,accept:".json",style:{display:"none"},onChange:u,"data-test":"canvas-import-file-input"})]}),l&&t.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"canvas-import-result",children:[l.projectsImported>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"canvas-imported-count",children:[t.jsx(Jo,{className:"h-3 w-3"}),t.jsxs("span",{children:["Imported: ",l.projectsImported]})]}),l.projectsSkipped>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-yellow-600","data-test":"canvas-skipped-count",children:[t.jsx(Zo,{className:"h-3 w-3"}),t.jsxs("span",{children:["Skipped: ",l.projectsSkipped]})]}),l.projectsImported===0&&l.projectsSkipped===0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"canvas-no-projects",children:[t.jsx(Zo,{className:"h-3 w-3"}),t.jsx("span",{children:"No projects found"})]})]})]})},BS=()=>t.jsx(ya,{storageKey:"canvas-data-io",title:"Data Import/Export",icon:t.jsx(jl,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end",children:t.jsx(FS,{})}),or=Object.values(sh).map(e=>({value:e,label:nh[e]})),zS=()=>{const[e,s]=p.useState(()=>{var i;return((i=jn.getState().ui)==null?void 0:i.keyboardLanguage)??Tr}),[n,o]=p.useState(()=>{var c;const i=(c=jn.getState().ui)==null?void 0:c.enabledKeyboardLanguages;return Array.isArray(i)&&i.length>0?i:Qu}),r=()=>{var h;if(n.length<=1)return;const i=n.indexOf(e),c=i===-1?0:(i+1)%n.length,l=n[c];s(l),jn.update("ui",{keyboardLanguage:l});const d=((h=or.find(u=>u.value===l))==null?void 0:h.label)??l;Ee(`${th[l]} Keyboard: ${d}`,{duration:1500})},a=(i,c)=>{let l;if(c)l=or.map(d=>d.value).filter(d=>n.includes(d)||d===i);else{if(n.length<=1)return;l=n.filter(d=>d!==i)}if(o(l),jn.update("ui",{enabledKeyboardLanguages:l}),!l.includes(e)){const d=l[0];s(d),jn.update("ui",{keyboardLanguage:d})}};return t.jsx(eh,{label:t.jsx(Wp,{className:"h-5 w-5"}),onAction:r,variant:"outline",size:"icon",tooltipText:`${Oa[e]} - Click to cycle, hold for settings`,popoverContent:t.jsxs("div",{className:"space-y-3 p-1","data-test":"keyboard-language-panel",children:[t.jsx(Fe,{className:"text-sm font-medium",children:"Languages to cycle"}),t.jsx("div",{className:"space-y-2",children:or.map(i=>{const c=n.includes(i.value),l=n.length===1&&c;return t.jsxs("div",{className:"flex items-center space-x-2","data-test":"keyboard-language-option",children:[t.jsx(Xe,{id:`lang-${i.value}`,checked:c,onCheckedChange:d=>a(i.value,!!d),disabled:l}),t.jsx(Fe,{htmlFor:`lang-${i.value}`,className:`cursor-pointer ${l?"opacity-50":""}`,children:i.label})]},i.value)})}),t.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t","data-test":"current-language-indicator",children:["Current: ",t.jsx("span",{className:"font-medium",children:Oa[e]}),n.length>1&&t.jsxs("span",{className:"ml-1",children:["(cycling ",n.map(i=>Oa[i]).join(" → "),")"]})]})]})})},$S=[],_S=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState("move"),[r,a]=p.useState(null),i=p.useRef(null),c=$(x=>{var w;return((w=x.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??$S}),l=$(x=>{var w;return(w=x.projectCanvas.getActive())==null?void 0:w.id}),d=$(x=>x.copyNodesToCanvas),h=$(x=>x.moveNodesToCanvas),u=c.length===0,f=()=>{if(!u){if(i.current){const x=i.current.getBoundingClientRect();a({x:x.left-320-16,y:Math.max(16,x.top+x.height/2-400/2)})}s(!0)}},m=x=>{const w=c.map(N=>N.id),v={nodeIds:w,targetCanvasId:x.canvasId,targetWorkspaceId:x.workspaceId,targetProjectId:x.projectId};n==="copy"?(d(v),Ee.success(`Copied ${w.length} node${w.length>1?"s":""} to "${x.canvasName}"`)):(h(v),Ee.success(`Moved ${w.length} node${w.length>1?"s":""} to "${x.canvasName}"`)),s(!1)},y=()=>{s(!1)},g=t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-move-nodes-title",children:[t.jsx(se,{variant:n==="move"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("move"),"data-test":"canvas-move-nodes-move-option",children:"Move"}),t.jsx(se,{variant:n==="copy"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("copy"),"data-test":"canvas-move-nodes-copy-option",children:"Copy"}),t.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:[c.length," node",c.length!==1?"s":""]})]});return t.jsxs(t.Fragment,{children:[t.jsx(es,{delayDuration:300,children:t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx(se,{ref:i,variant:"outline",size:"icon",disabled:u,onClick:f,"data-test":"canvas-move-nodes-button",title:"Move/copy nodes",children:t.jsx(Hp,{className:"h-5 w-5"})})}),t.jsx(Vt,{children:t.jsx("p",{children:u?"Select nodes to move/copy":"Move/copy nodes to canvas"})})]})}),t.jsx(ru,{onCanvasSelected:m,excludeCanvasId:l,selectionModeTitle:g,isOpen:e,onClose:y,popoverPosition:r})]})};class US{constructor(s){qe(this,"namespace","canvas.collapse");this.hooks=s}getActions(){return[{id:"collapse:all",label:"Collapse all nodes",category:"Collapse",icon:t.jsx(Qo,{className:"h-3 w-3"})},{id:"expand:all",label:"Expand all nodes",category:"Collapse",icon:t.jsx(no,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"collapse:all":this.hooks.collapseAll();break;case"expand:all":this.hooks.expandAll();break;default:console.warn(`CollapseFacade: Unknown action "${s}"`)}}}function VS(){const e=p.useCallback(()=>{const r=T.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed||r.updateNode(c.id,{isCollapsed:!0})})},[]),s=p.useCallback(()=>{const r=T.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed&&r.updateNode(c.id,{isCollapsed:!1})})},[]),n=p.useMemo(()=>({collapseAll:e,expandAll:s}),[e,s]),o=p.useMemo(()=>new US(n),[n]);return p.useEffect(()=>(pt.register("collapse",{name:"Collapse",getActions:()=>o.getActions()}),at.register("collapse",o),()=>{pt.unregister("collapse"),at.unregister("collapse")}),[o]),o}const GS=[],YS=10,XS={content:!0,title:!0,id:!1,type:!1,tags:!1},KS=e=>{if(e.title)return e.title;if(typeof e.content=="string"){const s=e.content.split(`
`)[0];return s.length>50?s.substring(0,50)+"...":s||"(empty)"}return"(empty)"},qS=(e,s,n,o)=>{if(!s.trim())return!0;const r=n?s:s.toLowerCase(),a=i=>i?(n?i:i.toLowerCase()).includes(r):!1;if(o.content&&typeof e.content=="string"&&a(e.content)||o.title&&a(e.title)||o.id&&a(e.id)||o.type&&a(e.type))return!0;if(o.tags&&e.tags&&e.tags.length>0){const i=e.tags.map(c=>typeof c=="string"?c:c.title).join(", ");if(a(i))return!0}return!1},ZS=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),[r,a]=p.useState(""),[i,c]=p.useState(!1),[l,d]=p.useState(XS),[h,u]=p.useState(!1),[f,m]=p.useState([]),[y,g]=p.useState("nodes"),x=p.useRef(null),w=VS(),v=$(j=>{var M;return((M=j.projectCanvas.getActive())==null?void 0:M.coreState.nodes)??GS}),N=i||l.id||l.type||l.tags||!l.content||!l.title,b=p.useMemo(()=>r.trim()?Object.values(l).some(M=>M)?v.filter(M=>qS(M,r,i,l)):[]:v,[v,r,i,l]),A=p.useMemo(()=>v.filter(j=>j.isCollapsed).length,[v]),R=p.useMemo(()=>v.filter(j=>!j.isCollapsed).length,[v]),k=p.useMemo(()=>f.map(j=>v.find(M=>M.id===j)).filter(j=>j!==void 0).slice(0,5),[f,v]),S=()=>{if(x.current){const j=x.current.getBoundingClientRect();o({x:j.left-360-16,y:Math.max(16,j.top+j.height/2-450/2)})}s(!0)},E=()=>{s(!1),g("nodes")},C=p.useCallback(j=>{m(M=>{const B=M.filter(U=>U!==j);return[j,...B].slice(0,YS)})},[]),I=p.useCallback(j=>{const M=T.getState(),B=v.find(U=>U.id===j);B&&(M.updateNode(j,{isCollapsed:!B.isCollapsed}),C(j))},[v,C]),O=p.useCallback(()=>{if(r.trim()){const j=T.getState();b.forEach(M=>{M.isCollapsed||(j.updateNode(M.id,{isCollapsed:!0}),C(M.id))})}else w.execute("collapse:all")},[b,r,C,w]),H=p.useCallback(()=>{if(r.trim()){const j=T.getState();b.forEach(M=>{M.isCollapsed&&(j.updateNode(M.id,{isCollapsed:!1}),C(M.id))})}else w.execute("expand:all")},[b,r,C,w]),L=p.useCallback(j=>{yo(j)},[]),W=y==="recent"?"Recent":t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-collapse-title",children:[t.jsxs(se,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:O,"data-test":"canvas-collapse-all-button",children:[t.jsx(Qo,{className:"h-3 w-3 mr-1"}),"Collapse ",r.trim()?`(${b.length})`:"All"]}),t.jsxs(se,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:H,"data-test":"canvas-expand-all-button",children:[t.jsx(no,{className:"h-3 w-3 mr-1"}),"Expand ",r.trim()?`(${b.length})`:"All"]})]}),P=y==="recent"?t.jsx(se,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>g("nodes"),title:"Back to Nodes","data-test":"canvas-collapse-back-button",children:t.jsx(pn,{className:"h-3.5 w-3.5"})}):t.jsx(se,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>g("recent"),title:"Recent Collapse/Expand History","data-test":"canvas-collapse-recent-button",children:t.jsx(vs,{className:"h-3.5 w-3.5"})});return t.jsxs(t.Fragment,{children:[t.jsx(es,{delayDuration:300,children:t.jsxs(_t,{children:[t.jsx(Ut,{asChild:!0,children:t.jsx(se,{ref:x,variant:"outline",size:"icon",onClick:S,"data-test":"canvas-collapse-button",title:"Collapse/expand nodes",children:t.jsx(Qo,{className:"h-5 w-5"})})}),t.jsx(Vt,{children:t.jsxs("p",{children:["Collapse/expand nodes (",A," collapsed, ",R," expanded)"]})})]})}),t.jsx(et,{isVisible:e,onClose:E,title:W,triggerPosition:n??void 0,shouldCloseManually:!0,resizable:!0,initialSize:{width:360,height:450},headerActions:P,children:t.jsx("div",{className:"p-3 space-y-3","data-test":"canvas-collapse-popover-content",children:y==="nodes"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"canvas-collapse-search-section",children:[t.jsx(Ss,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"canvas-collapse-search-icon"}),t.jsx(ze,{type:"text",placeholder:"Search nodes...",value:r,onChange:j=>a(j.target.value),className:Ie("h-8 text-sm pl-8",r?"pr-16":"pr-10"),autoFocus:!0,"data-test":"canvas-collapse-search-input"}),r&&t.jsx(se,{variant:"ghost",size:"icon",onClick:()=>a(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"canvas-collapse-clear-button",children:t.jsx(Ke,{className:"h-3 w-3"})}),N&&t.jsx("div",{className:Ie("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",r?"right-16":"right-11"),"data-test":"canvas-collapse-filter-indicator"}),t.jsxs(St,{open:h,onOpenChange:u,children:[t.jsx(Ct,{asChild:!0,children:t.jsx(se,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"canvas-collapse-settings-button",children:t.jsx(ka,{className:"h-3.5 w-3.5"})})}),t.jsx(jt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:We.draggablePopoverDropdown},"data-test":"canvas-collapse-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:"collapse-case-sensitive",checked:i,onCheckedChange:j=>c(!!j),"data-test":"canvas-collapse-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"collapse-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsx("div",{className:"space-y-1.5",children:Object.entries({content:"Content",title:"Title",id:"ID",type:"Type",tags:"Tags"}).map(([j,M])=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Xe,{id:`collapse-node-${j}`,checked:l[j],onCheckedChange:B=>d(U=>({...U,[j]:!!B})),"data-test":"canvas-collapse-field-checkbox"}),t.jsx("label",{htmlFor:`collapse-node-${j}`,className:"text-sm cursor-pointer",children:M})]},j))})]})]})})]})]}),t.jsxs("div",{className:"stats-section flex items-center gap-2 text-xs text-muted-foreground","data-test":"canvas-collapse-stats",children:[t.jsxs(lt,{variant:"secondary","data-test":"canvas-collapse-collapsed-count",children:[A," collapsed"]}),t.jsxs(lt,{variant:"outline","data-test":"canvas-collapse-expanded-count",children:[R," expanded"]}),r.trim()&&t.jsxs("span",{"data-test":"canvas-collapse-filtered-count",children:["(",b.length," matching)"]})]}),t.jsxs("div",{className:"nodes-list-section space-y-1","data-test":"canvas-collapse-nodes-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:r.trim()?`Results (${b.length})`:`All Nodes (${v.length})`}),t.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1","data-test":"canvas-collapse-nodes-list",children:[b.map(j=>t.jsx(Qc,{node:j,onToggle:()=>I(j.id),onClick:()=>L(j)},j.id)),b.length===0&&r.trim()&&t.jsx("p",{className:"text-xs text-muted-foreground py-2 text-center","data-test":"canvas-collapse-no-results",children:"No nodes found"})]})]})]}):t.jsx("div",{className:"recent-view-section space-y-1","data-test":"canvas-collapse-recent-view",children:k.length>0?t.jsx("div",{className:"max-h-[350px] overflow-y-auto space-y-1","data-test":"canvas-collapse-recent-list",children:k.map(j=>t.jsx(Qc,{node:j,onToggle:()=>I(j.id),onClick:()=>L(j)},j.id))}):t.jsx("p",{className:"text-xs text-muted-foreground py-8 text-center","data-test":"canvas-collapse-recent-empty",children:"No recent collapse/expand history"})})})})]})},Qc=({node:e,onToggle:s,onClick:n})=>{const o=Ra(e.type),r=KS(e),a=e.id.substring(0,6);return t.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded hover:bg-accent/50 group","data-test":"canvas-collapse-node-item",children:[t.jsx(se,{variant:"ghost",size:"icon",className:"h-4 w-4 flex-shrink-0",onClick:i=>{i.stopPropagation(),s()},title:e.isCollapsed?"Expand":"Collapse","data-test":"canvas-collapse-toggle-button",children:e.isCollapsed?t.jsx(ss,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(Pt,{className:"h-3.5 w-3.5"})}),t.jsxs("div",{className:"flex-1 flex items-center gap-1.5 cursor-pointer min-w-0",onClick:n,"data-test":"canvas-collapse-node-info",children:[o&&t.jsx("span",{className:"flex-shrink-0 text-muted-foreground",children:o}),t.jsx("span",{className:"text-xs truncate flex-1",children:r}),t.jsx("span",{className:"text-[10px] text-muted-foreground flex-shrink-0",children:a})]}),e.isCollapsed&&t.jsx(lt,{variant:"secondary",className:"text-[9px] px-1 py-0 h-4","data-test":"canvas-collapse-badge",children:"collapsed"})]})},el=[],JS=[],QS=({isVisible:e,onClose:s})=>{const n=$(m=>{var y;return((y=m.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??el}),o=$(m=>{var y;return((y=m.projectCanvas.getActive())==null?void 0:y.coreState.nodes)??el}),r=$(m=>{var y;return((y=m.projectCanvas.getActive())==null?void 0:y.coreState.arrows)??JS});$(m=>{var y;return(y=m.preferences)==null?void 0:y.canvasConfig});const a=$(m=>m.updateNode),i=n.length>0,c=p.useMemo(()=>i?ad(r,n):r,[i,n,r]),l=p.useCallback(m=>rd({includeConfig:m}),[]),d=p.useMemo(()=>{const m=Math.round(window.innerWidth*.85),y=Math.round(window.innerHeight*.85),g=Math.round((window.innerWidth-m)/2),x=Math.round((window.innerHeight-y)/2);return{initialSize:{width:m,height:y},triggerPosition:{x:g,y:x}}},[]),h=p.useCallback(m=>{const y=Array.isArray(m)?m:m.nodes;Array.isArray(y)&&y.forEach(g=>{g&&g.id&&a(g.id,g)})},[a]),u=c.length,f=i?`Selected Nodes (${n.length})${u>0?` + Arrows (${u})`:""}`:`All Canvas (${o.length} nodes, ${r.length} arrows)`;return t.jsx(ya,{storageKey:"json-viewer-config",initialConfig:{includeCanvasConfig:!1},children:(m,y,g)=>{const x=l(m.includeCanvasConfig),w={nodes:[]},v=()=>{x&&id(x)};return t.jsx(et,{isVisible:e,onClose:s,title:f,resizable:!0,initialSize:d.initialSize,shouldCloseManually:!0,triggerPosition:d.triggerPosition,headerActions:t.jsxs("div",{className:"flex items-center gap-1","data-test":"json-viewer-header-actions",children:[t.jsx(g,{title:"JSON Viewer Settings",contentClassName:"w-64",contentStyle:{zIndex:We.draggablePopoverDropdown},children:t.jsxs("div",{className:"flex items-center space-x-2","data-test":"include-canvas-config-option",children:[t.jsx(Xe,{id:"includeCanvasConfig",checked:m.includeCanvasConfig,onCheckedChange:N=>y(b=>({...b,includeCanvasConfig:!!N})),"data-test":"include-canvas-config-checkbox"}),t.jsx(Fe,{htmlFor:"includeCanvasConfig",className:"text-xs cursor-pointer",children:"Include Canvas configuration"})]})}),t.jsx("button",{type:"button",className:"p-1 rounded hover:bg-accent transition-colors",onClick:N=>{N.stopPropagation(),v()},onMouseDown:N=>N.stopPropagation(),"aria-label":"Copy JSON",title:"Copy","data-test":"json-viewer-copy-button",children:t.jsx(Bt,{size:14})})]}),children:t.jsx(Jl,{data:x??w,onDataChange:h})})}})},e0=()=>{const[e,s]=p.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsx(se,{variant:"outline",size:"icon",onClick:()=>s(!0),"data-test":"canvas-json-viewer-button",title:"View JSON Data",children:t.jsx(Ia,{className:"h-5 w-5"})}),t.jsx(QS,{isVisible:e,onClose:()=>s(!1)})]})},t0=[],s0=()=>{const e=$(g=>{var x;return((x=g.projectCanvas.getActive())==null?void 0:x.coreState.layers)??t0}),s=$(g=>{var x;return((x=g.projectCanvas.getActive())==null?void 0:x.coreState.activeLayerId)??null}),n=$(g=>g.layer),o=p.useMemo(()=>e.length===0?[Sl()]:[...e].sort((g,x)=>x.order-g.order),[e]),r=p.useCallback((g,x,w)=>{g.stopPropagation(),n.setVisibility(x,!w)},[n]),a=p.useMemo(()=>o.map(g=>({id:g.id,label:g.name,icon:g.isLocked?t.jsx(ea,{className:"h-3 w-3 text-muted-foreground"}):t.jsx("button",{onClick:x=>r(x,g.id,g.isVisible),className:"hover:text-foreground transition-colors","data-test":"layer-visibility-toggle",title:g.isVisible?"Hide layer":"Show layer",children:g.isVisible?t.jsx(us,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"}):t.jsx(Os,{className:"h-3 w-3 text-muted-foreground/50 hover:text-foreground"})}),data:{type:"layer",...g}})),[o,r]),i=g=>{n.setActive(g.id)},c=(g,x)=>{n.rename(g,x)},l=g=>{n.delete(g)},d=g=>{const x=g.length;g.forEach((w,v)=>{const N=x-1-v;n.reorder(w.id,N)})},h=g=>`Delete layer "${g.label}"? Nodes will be moved to the layer below.`,u=g=>{const x=g.data;return x?[{id:"toggle-visibility",label:x.isVisible?"Hide Layer":"Show Layer",icon:x.isVisible?t.jsx(Os,{className:"h-4 w-4 mr-2"}):t.jsx(us,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setVisibility(x.id,!x.isVisible)}},{id:"toggle-lock",label:x.isLocked?"Unlock Layer":"Lock Layer",icon:x.isLocked?t.jsx(ql,{className:"h-4 w-4 mr-2"}):t.jsx(ea,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setLocked(x.id,!x.isLocked)}},{id:"duplicate",label:"Duplicate Layer",icon:t.jsx(Bt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(x.id)}},{id:"merge-down",label:"Merge Down",icon:t.jsx(Bp,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.mergeDown(x.id)}}]:null},f=()=>{n.create()},m=p.useCallback((g,x)=>{n.setOpacity(g,x)},[n]),y=p.useCallback((g,x,w,v)=>{const N=g.data;return N?t.jsxs("div",{"data-test":"layer-item-with-opacity",children:[v,t.jsxs("div",{className:"flex items-center gap-1 px-2 py-0 mt-1 ml-8 opacity-50 hover:opacity-100 transition-opacity","data-test":"layer-opacity-row",children:[t.jsx(Fp,{className:"h-2 w-2 text-muted-foreground/60 flex-shrink-0"}),t.jsx(cs,{value:[N.opacity],onValueChange:([b])=>m(g.id,b),min:0,max:100,step:1,className:"flex-1 [&>span:first-child]:h-0.5 [&>span:first-child>span]:bg-muted-foreground/40 [&_[role=slider]]:h-2 [&_[role=slider]]:w-2","data-test":"layer-opacity-slider"}),t.jsxs("span",{className:"text-[9px] text-muted-foreground/60 w-6 text-right","data-test":"layer-opacity-value",children:[N.opacity,"%"]})]})]}):v},[m]);return t.jsxs("div",{className:"layer-manager flex flex-col h-full","data-test":"canvas-layer-manager",children:[t.jsx(hn,{className:"layer-list flex-1 min-h-0","data-test":"layer-list-scroll-area",children:t.jsx("div",{className:"layer-tree-container p-2","data-test":"layer-tree-container",children:t.jsx(gn,{data:a,onItemClick:i,onUpdate:c,onDelete:e.length>1?l:void 0,onReorder:d,selectedId:s,deleteConfirmMessage:h,enableEdit:!0,enableDelete:e.length>1,enableDrag:!0,moreOptionsItems:u,dropdownZIndex:We.draggablePopoverDropdown,renderNode:y})})}),t.jsx("div",{className:"layer-actions border-t p-2","data-test":"layer-actions",children:t.jsxs(se,{variant:"outline",size:"sm",className:"w-full",onClick:f,"data-test":"layer-add-button",children:[t.jsx(Tt,{className:"h-3 w-3 mr-1"}),"Add Layer"]})})]})},n0=180,o0=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=()=>{if(e){s(!1);return}if(r.current){const i=r.current.getBoundingClientRect(),c=280,l=350,d=i.left+i.width/2,h=i.top+i.height/2;o({x:d-c/2-n0,y:h-l/2})}s(!0)};return t.jsxs(t.Fragment,{children:[t.jsx(ks,{ref:r,variant:"secondary",size:"sm",tooltip:"Manage layers",onClick:a,className:"canvas-layer-button","data-test":"canvas-layer-button",children:t.jsx(_s,{className:"h-4 w-4"})}),t.jsx(et,{isVisible:e,onClose:()=>s(!1),title:"Layers",resizable:!0,initialSize:{width:280,height:350},triggerPosition:n??void 0,children:t.jsx(s0,{})})]})},a0=({onSessionSelect:e})=>{const{sessions:s,loadingSessions:n,sessionsError:o,pagination:r,currentPage:a,searchSessions:i,refreshSessions:c,handlePageChange:l,handleLoadMore:d}=oh({loadOnMount:!1,subscribeToSSE:!1}),[h,u]=p.useState(null),[f,m]=p.useState(!1),{messages:y,sessionDetails:g,metadata:x,loading:w,pagination:v,loadOlderMessages:N,searchMessages:b,refreshSession:A,addOptimisticMessage:R,removeOptimisticMessage:k}=ah(h,{loadOnMount:!0,subscribeToSSE:!0}),S=400,E=-240,C=p.useMemo(()=>{const P=Math.round(window.innerWidth*.6),j=Math.round(window.innerHeight*.8),U=window.innerWidth-30+E-P,z=Math.round((window.innerHeight-j)/2);return{size:{width:P,height:j},position:{x:U,y:z}}},[E]),I=P=>{u(P),m(!0),e==null||e(P)},O=()=>{m(!1)},H=async(P,j)=>{try{const M=await rr.searchMessages(P,j);console.log("Message search results:",M)}catch(M){console.error("Message search failed:",M)}},L=async(P,j)=>{await b(P,j)},W=t.jsx(lg,{sessions:s,loading:n,error:o,onSessionSelect:I,selectedSessionId:h,onRefresh:c,pagination:r,currentPage:a,onPageChange:l,onLoadMore:d,onSearch:i,onMessageSearch:H});return t.jsxs(t.Fragment,{children:[t.jsx(Sn,{popoverId:"claude-sessions",icon:zp,tooltip:"Claude Sessions",popoverTitle:"Claude Sessions",popoverContent:W,initialSize:{width:S,height:600},leftOffset:E,resizable:!0,dataTest:"canvas-claude-session-button"}),t.jsx(et,{isVisible:f,onClose:O,title:(g==null?void 0:g.customName)??(g==null?void 0:g.name)??"Chat",shouldCloseManually:!0,resizable:!0,initialSize:C.size,initialPosition:C.position,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"claude-chat-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-auto","data-test":"claude-chat-messages-area",children:t.jsx(rh,{messages:y,sessionDetails:g,metadata:x,loading:w,pagination:v,onLoadOlder:N,onSearch:L,onNameUpdated:A})}),h&&t.jsx("div",{className:"border-t p-2","data-test":"claude-chat-input-area",children:t.jsx(ih,{sessionId:h,onSendSuccess:()=>{A()},onAddOptimisticMessage:R,onRemoveOptimisticMessage:k})})]})})]})},r0=e=>{const{className:s}=e,{history:n,lastAction:o,executeLastAction:r,hasExecutor:a}=Vr(),i=o&&a(o.executorId,o.actionId),c=p.useCallback(()=>{i&&r()},[i,r]),l=n.length>0;return t.jsx(po,{expandTitle:"Actions & Presets",expandContent:t.jsx(Fd,{}),onClick:c,disabled:!l,variant:"outline",size:"icon",className:s,popoverSize:{width:300,height:380},title:o?`Repeat: ${o.label}`:"No action to repeat",dataTest:"canvas-repeat-action-button",headerActions:t.jsx(Bd,{}),children:t.jsx(ja,{className:"h-5 w-5"})})},tl=380,sl=360,nl=e=>{const{className:s}=e,[n,o]=p.useState(!1),[r,a]=p.useState(void 0),i=$(d=>d.setActiveGlobalOverlay),c=()=>{i(Ps.STUDY)},l=d=>{const h=d.currentTarget.getBoundingClientRect();a({x:h.left-sl-16,y:(window.innerHeight-tl)/2}),o(!0)};return t.jsxs(t.Fragment,{children:[t.jsxs(Ma,{position:"right",className:s,children:[t.jsx(zS,{}),t.jsx(e0,{}),t.jsx(_S,{}),t.jsx(ZS,{}),t.jsx(o0,{}),t.jsx(a0,{}),t.jsx(BS,{}),t.jsx(r0,{}),t.jsx(se,{variant:"outline",size:"icon",onClick:c,title:"Enter Study Mode","data-test":"mobile-right-toolbar-study-mode",children:t.jsx($p,{className:"h-5 w-5"})}),t.jsx(se,{variant:"outline",size:"icon",onClick:l,"data-test":"mobile-right-toolbar-settings",title:"Settings",children:t.jsx(go,{className:"h-5 w-5"})})]}),t.jsx(et,{isVisible:n,onClose:()=>o(!1),title:"Canvas Settings",resizable:!0,initialSize:{width:sl,height:tl},shouldCloseManually:!0,triggerPosition:r,headerActions:t.jsx("button",{type:"submit",form:"canvas-settings-form",className:"p-1 rounded hover:bg-accent transition-colors",onClick:d=>d.stopPropagation(),onMouseDown:d=>d.stopPropagation(),"aria-label":"Save settings",title:"Save","data-test":"canvas-settings-save-button",children:t.jsx(hs,{size:14})}),children:t.jsx(HS,{})})]})},i0=e=>{const{className:s}=e,n=$(c=>c.setActiveGlobalOverlay),o=()=>{n(Ps.NONE)},r=()=>{console.log("Previous card")},a=()=>{console.log("Next card")},i=()=>{console.log("Flip card")};return t.jsxs(Ma,{position:"right",className:s,children:[t.jsx(se,{variant:"outline",size:"icon",onClick:o,title:"Exit Study Mode","data-test":"study-mode-exit-button",children:t.jsx(Ke,{className:"h-5 w-5"})}),t.jsx(se,{variant:"outline",size:"icon",onClick:r,title:"Previous Card","data-test":"study-mode-prev-button",children:t.jsx(Zl,{className:"h-5 w-5"})}),t.jsx(se,{variant:"outline",size:"icon",onClick:a,title:"Next Card","data-test":"study-mode-next-button",children:t.jsx(ss,{className:"h-5 w-5"})}),t.jsx(se,{variant:"outline",size:"icon",onClick:i,title:"Flip Card","data-test":"study-mode-flip-button",children:t.jsx(_p,{className:"h-5 w-5"})})]})},c0=()=>{switch($(s=>s.uiState.activeGlobalOverlay)){case Ps.STUDY:return{right:t.jsx(i0,{})};case Ps.PAIRING:return{right:t.jsx(nl,{})};case Ps.NONE:default:return{right:t.jsx(nl,{})}}},l0=5,ol=[];function d0({items:e,onSelect:s,placeholder:n="Search...",getGroup:o,storageKey:r,maxRecentItems:a=l0,enablePinning:i=!1,openShortcut:c,repeatLastShortcut:l,renderItem:d,renderEmpty:h,open:u,onOpenChange:f}){const[m,y]=p.useState(!1),g=u!==void 0,x=g?u:m,w=p.useCallback(F=>{g||y(F),f==null||f(F)},[g,f]),[v,N]=p.useState(""),[b,A]=p.useState(""),R=`${r}-recently-used`,k=`${r}-search-options`,[S,E]=p.useState(()=>{try{const F=localStorage.getItem(R);return F?JSON.parse(F):[]}catch{return[]}}),[C,I]=p.useState(()=>{try{const F=localStorage.getItem(k);return F?JSON.parse(F):{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}catch{return{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}}),O=p.useCallback(F=>{I(F);try{localStorage.setItem(k,JSON.stringify(F))}catch{}},[k]),H=$(p.useCallback(F=>{var D,V;return i?((V=(D=F.preferences)==null?void 0:D.pinnedPaletteItems)==null?void 0:V[r])??ol:ol},[i,r])),L=p.useMemo(()=>i?H.map(F=>e.find(D=>D.id===F)).filter(F=>F!==void 0):[],[i,H,e]),W=p.useCallback(F=>i?H.includes(F):!1,[i,H]),P=p.useCallback((F,D)=>{D&&(D.stopPropagation(),D.preventDefault()),i&&T.getState().togglePinPaletteItem(r,F)},[i,r]),j=p.useMemo(()=>ch(C),[C]),{navigateResults:M}=lh(v,N),B=p.useMemo(()=>{const F={};return e.forEach(D=>{const V=o?o(D):D.group??"General";F[V]||(F[V]=[]),F[V].push(D)}),F},[e,o]),U=p.useMemo(()=>S.filter(F=>!H.includes(F)).map(F=>e.find(D=>D.id===F)).filter(F=>F!==void 0),[S,e,H]),z=p.useCallback(F=>{w(!1),A(""),s(F),E(D=>{const V=D.filter(ie=>ie!==F.id),J=[F.id,...V].slice(0,a);try{localStorage.setItem(R,JSON.stringify(J))}catch{}return J})},[w,s,a,R]);p.useEffect(()=>{const F=[];if(c){const D=gi.register({key:c.key,ctrlKey:c.ctrl,altKey:c.alt,metaKey:c.meta,preventDefault:!0,callback:()=>w(!x)});F.push(D)}if(l&&S.length>0){const D=gi.register({key:l.key,ctrlKey:l.ctrl,altKey:l.alt,metaKey:l.meta,preventDefault:!0,callback:()=>{const V=S[0],J=e.find(ie=>ie.id===V);J&&s(J)}});F.push(D)}return()=>{F.forEach(D=>D())}},[c,l,x,w,S,e,s]),p.useEffect(()=>{if(!x)return;const F=D=>{if(i&&D.key==="Enter"&&D.ctrlKey){D.preventDefault(),D.stopPropagation();const Se=v.split("-");let me;Se[0]==="recent"||Se[0]==="pinned"?me=Se[1]:me=Se[0],me&&P(me);return}if(D.key!=="ArrowUp"&&D.key!=="ArrowDown")return;const V=Array.from(document.querySelectorAll("[cmdk-item]")).filter(Se=>Se.getAttribute("data-disabled")!=="true");if(V.length===0)return;const J=V.map(Se=>Se.getAttribute("data-value")||""),ie=J.indexOf(v);D.key==="ArrowUp"&&ie<=0?(D.preventDefault(),D.stopPropagation(),N(J[V.length-1])):D.key==="ArrowDown"&&ie>=V.length-1&&(D.preventDefault(),D.stopPropagation(),N(J[0]))};return document.addEventListener("keydown",F,{capture:!0}),()=>document.removeEventListener("keydown",F,{capture:!0})},[x,v,i,P]);const _=F=>t.jsxs("div",{className:"flex justify-between items-center w-full","data-test":"command-palette-item-content",children:[t.jsxs("div",{className:"flex flex-col","data-test":"command-palette-item-text",children:[t.jsx("span",{"data-test":"command-palette-item-label",children:F.label}),F.description&&t.jsx("span",{className:"text-xs text-muted-foreground","data-test":"command-palette-item-description",children:F.description})]}),F.shortcut&&t.jsx("kbd",{className:"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground","data-test":"command-palette-item-shortcut",children:F.shortcut})]}),G=F=>{const D=W(F.id),V=d?d(F):_(F);return i?t.jsxs("div",{className:"flex items-center w-full group","data-test":"command-palette-item-wrapper",children:[t.jsx("div",{className:"flex-1 min-w-0",children:V}),t.jsx(se,{type:"button",variant:"ghost",size:"smIcon",onClick:J=>P(F.id,J),className:`shrink-0 ${D?"opacity-100":"opacity-0 group-hover:opacity-100"}`,title:D?"Unpin (Ctrl+Enter)":"Pin (Ctrl+Enter)","data-test":"command-palette-pin-button",children:D?t.jsx(Ul,{className:"text-muted-foreground","data-test":"command-palette-pin-icon-off"}):t.jsx(_l,{className:"text-muted-foreground","data-test":"command-palette-pin-icon"})})]}):V};return t.jsxs(dh,{open:x,onOpenChange:w,value:v,onValueChange:N,filter:j,"data-test":"command-palette-dialog",children:[t.jsx(uh,{placeholder:n,initialOptions:C,onSearchOptionsChange:O,onSearchChange:A,onNavigate:M}),t.jsxs(hh,{"data-test":"command-palette-list",children:[t.jsx(ph,{"data-test":"command-palette-empty",children:h?h():"No results found."}),i&&L.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(La,{heading:"Pinned","data-test":"command-palette-group-pinned",children:L.map(F=>t.jsx(Wa,{value:`pinned-${F.id}-${F.label}`,onSelect:()=>z(F),"data-test":"command-palette-item-pinned",children:G(F)},`pinned-${F.id}`))}),t.jsx(Ha,{"data-test":"command-palette-separator-pinned"})]}),U.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(La,{heading:"Recently Used","data-test":"command-palette-group-recent",children:U.map(F=>t.jsx(Wa,{value:`recent-${F.id}-${F.label}`,onSelect:()=>z(F),"data-test":"command-palette-item-recent",children:G(F)},`recent-${F.id}`))}),t.jsx(Ha,{"data-test":"command-palette-separator-recent"})]}),Object.entries(B).map(([F,D],V)=>t.jsxs("div",{"data-test":"command-palette-group-container",children:[V>0&&t.jsx(Ha,{"data-test":"command-palette-separator"}),t.jsx(La,{heading:F,"data-test":"command-palette-group",children:D.map(J=>t.jsx(Wa,{value:`${J.id}-${J.label}-${J.description||""}`,onSelect:()=>z(J),"data-test":"command-palette-item",children:G(J)},J.id))})]},F))]})]})}const u0=({open:e,onOpenChange:s})=>{const n=$(l=>{var d;return((d=l.state)==null?void 0:d.projects)??{}}),o=$(l=>{var d;return(d=l.state)==null?void 0:d.activeProjectId}),r=p.useMemo(()=>{const l=[];for(const[d,h]of Object.entries(n))for(const[u,f]of Object.entries(h.workspaces))for(const[m,y]of Object.entries(f.canvases))y.hideFromSearch||l.push({id:m,label:y.name,description:`${h.name} / ${f.name}`,projectId:d,workspaceId:u,canvasId:m,projectName:h.name,workspaceName:f.name});return l.sort((d,h)=>{if(d.projectId===o&&h.projectId!==o)return-1;if(h.projectId===o&&d.projectId!==o)return 1;const u=d.projectName.localeCompare(h.projectName);if(u!==0)return u;const f=d.workspaceName.localeCompare(h.workspaceName);return f!==0?f:d.label.localeCompare(h.label)}),l},[n,o]),a=p.useCallback(l=>{T.getState().projectCanvas.switch(l.canvasId)},[]),i=p.useCallback(l=>t.jsxs("div",{className:"flex items-center gap-1.5 w-full min-w-0","data-test":"canvas-picker-item",children:[t.jsx(_s,{className:"!h-3 !w-3 text-muted-foreground shrink-0"}),t.jsx("span",{className:"shrink-0 font-medium","data-test":"canvas-picker-item-label",children:l.label}),t.jsxs("span",{className:"text-xs text-muted-foreground truncate",title:`${l.projectName} / ${l.workspaceName} / ${l.label}`,"data-test":"canvas-picker-item-path",children:[l.projectName," / ",l.workspaceName," / ",l.label]})]}),[]),c=p.useCallback(()=>t.jsxs("div",{className:"text-center py-4","data-test":"canvas-picker-empty",children:[t.jsx("p",{className:"text-muted-foreground",children:"No canvases found."}),t.jsx("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Create a canvas to get started."})]}),[]);return t.jsx(d0,{items:r,onSelect:a,placeholder:"Search canvases...",storageKey:"canvas-picker-palette",maxRecentItems:10,enablePinning:!0,openShortcut:{key:"p",ctrl:!0},renderItem:i,renderEmpty:c,open:e,onOpenChange:s,"data-test":"canvas-picker-palette"})};function al(e,s){const{selected:n}=s;if(e==="selected")return n.map(o=>o.content??"").filter(o=>String(o).trim()).join(`
`);if(e.startsWith("selected[")){const o=bi(e,{selected:n});return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}if(e.startsWith("selected.")){const o=e.slice(9);return n.map(r=>{const a={node:r},i=bi(`node.${o}`,a);return i==null?"":typeof i=="object"?JSON.stringify(i):String(i)}).filter(r=>String(r).trim()).join(`
`)}return""}function h0({formulas:e,inputRef:s,onFormulaExecute:n,getSelectedNodes:o,fieldCompletions:r=[]}){const[a,i]=p.useState(!1),[c,l]=p.useState(""),[d,h]=p.useState(0),[u,f]=p.useState(null),[m,y]=p.useState({top:0,left:0}),[g,x]=p.useState("formula"),[w,v]=p.useState(null),N=p.useMemo(()=>{if(g==="field"){const C=c.toLowerCase();return r.filter(I=>!C||I.field.toLowerCase().startsWith(C)||I.name.toLowerCase().includes(C)).map(I=>({id:I.id,name:I.name,trigger:I.field,description:I.description}))}if(!c)return e;const E=c.toLowerCase();return e.filter(C=>C.trigger.toLowerCase().startsWith(E)||C.name.toLowerCase().includes(E))},[e,r,c,g]);p.useMemo(()=>{h(0)},[N.length]);const b=p.useCallback(()=>{i(!1),l(""),f(null),h(0),x("formula"),v(null)},[]),A=p.useCallback(E=>{const C=hg(E);if(C){const I=E.getBoundingClientRect(),O=window.getComputedStyle(E),H=parseInt(O.lineHeight||O.fontSize)||20;y({top:I.top+C.top-H-Q.slashCommand.menuGapAboveInput,left:I.left+C.left})}},[]),R=p.useCallback(E=>{var z,_,G,F,D,V;const C=s.current;if(!C||u===null)return;const I=C.selectionStart??0,O=C.value,H={query:c,fullText:O,cursorPosition:I,equalPosition:u};if(g==="field"&&w){const J=`${w}.${E.trigger}`;let ie;if(o){const X=o();ie=al(J,{selected:X})}else ie="";const Se=ie??"",me=O.substring(0,u),Z=O.substring(I),ge=me+Se+Z,we=((z=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:z.set)||((_=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:_.set);we&&(we.call(C,ge),C.dispatchEvent(new Event("input",{bubbles:!0})));const te=u+Se.length;C.setSelectionRange(te,te),n==null||n({...E,trigger:J},ie),b();return}if(E.insertTrigger){const J=`=${E.trigger}`,ie=O.substring(0,u),Se=O.substring(I),me=ie+J+Se,Z=((G=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:G.set)||((F=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:F.set);Z&&(Z.call(C,me),C.dispatchEvent(new Event("input",{bubbles:!0})));const ge=u+J.length;C.setSelectionRange(ge,ge),b();return}let L;if(E.onSelect)L=E.onSelect(H);else if(o){const J=o();L=al(E.trigger,{selected:J})}else L="";const W=L??"",P=O.substring(0,u),j=O.substring(I),M=P+W+j,B=((D=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:D.set)||((V=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:V.set);B&&(B.call(C,M),C.dispatchEvent(new Event("input",{bubbles:!0})));const U=u+W.length;C.setSelectionRange(U,U),n==null||n(E,L),b()},[s,u,c,g,w,n,o,b]),k=p.useCallback(E=>{const C=E.currentTarget,I=C.selectionStart??0,O=C.value;if(E.key==="="&&!a){const H=I>0?O[I-1]:"";(I===0||/\s/.test(H))&&(A(C),f(I),i(!0),l(""),h(0),x("formula"),v(null));return}if(E.key==="."&&!a&&r.length>0){let H=-1;for(let L=I-1;L>=0;L--){if(O[L]==="="){const W=L>0?O[L-1]:"";if(L===0||/\s/.test(W)){H=L;break}}if(/\s/.test(O[L]))break}if(H>=0){const L=O.substring(H+1,I);e.find(P=>P.insertTrigger&&P.trigger===L)&&(A(C),f(H),i(!0),l(""),h(0),x("field"),v(L))}return}a&&(E.key==="ArrowDown"?(E.preventDefault(),h(H=>H<N.length-1?H+1:0)):E.key==="ArrowUp"?(E.preventDefault(),h(H=>H>0?H-1:N.length-1)):E.key==="Enter"||E.key==="Tab"?N.length>0&&(E.preventDefault(),R(N[d])):E.key==="Escape"&&(E.preventDefault(),b()))},[a,N,d,R,b,A,e,r.length]),S=p.useCallback(E=>{if(!a||u===null)return;if(u>=E.length||E[u]!=="="){b();return}const C=s.current,I=(C==null?void 0:C.selectionStart)??E.length;if(g==="field"){const O=u+1+((w==null?void 0:w.length)??0);if(I<=O||E[O]!=="."){b();return}const H=E.substring(O+1,I);if(H.includes(" ")){b();return}l(H)}else{const O=E.substring(u+1,I);if(O.includes(" ")){b();return}l(O)}},[a,u,g,w,s,b]);return{isOpen:a,query:c,filteredFormulas:N,selectedIndex:d,handleKeyDown:k,handleChange:S,selectFormula:R,close:b,menuPosition:m,isFieldMode:g==="field"}}const cu=({formulas:e,selectedIndex:s,position:n,onSelect:o,onClose:r,triggerPrefix:a="="})=>{const i=p.useRef(null),c=p.useRef(null);p.useEffect(()=>{var d;(d=c.current)==null||d.scrollIntoView({block:"nearest"})},[s]),p.useEffect(()=>{const d=h=>{i.current&&!i.current.contains(h.target)&&r()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[r]);const l=t.jsx("div",{ref:i,"data-test":"formula-menu",className:Ie("fixed min-w-[200px] max-w-[300px]","rounded-md border bg-popover p-1 shadow-md",e.length>0&&"max-h-[200px] overflow-y-auto"),style:{top:n.top,left:n.left,zIndex:We.slashCommandMenu,transform:"translateY(-100%)"},children:e.length===0?t.jsx("div",{"data-test":"formula-menu-empty",className:"py-2 px-2 text-sm text-muted-foreground text-center",children:"No formulas found"}):e.map((d,h)=>t.jsxs("div",{ref:h===s?c:void 0,"data-test":"formula-item",className:Ie("flex items-center gap-2 rounded-sm px-2 py-1.5 text-sm cursor-pointer","select-none outline-none",h===s?"bg-accent text-accent-foreground":"hover:bg-accent/50"),onClick:()=>o(d),children:[d.icon&&t.jsx("span",{"data-test":"formula-icon",className:"flex-shrink-0 w-4 h-4",children:d.icon}),t.jsxs("div",{"data-test":"formula-content",className:"flex flex-col flex-1 min-w-0",children:[t.jsxs("span",{"data-test":"formula-name",className:"font-medium truncate",children:[a,d.trigger]}),d.description&&t.jsx("span",{"data-test":"formula-description",className:"text-xs text-muted-foreground truncate",children:d.description})]})]},d.id))});return Cs.createPortal(l,document.body)};cu.displayName="FormulaMenu";const p0=[{id:"selected",name:"Selected Nodes",trigger:"selected",description:"Access selected nodes",insertTrigger:!0}],g0=[{id:"content",name:"content",field:"content",description:"Node content text"},{id:"title",name:"title",field:"title",description:"Node title"},{id:"id",name:"id",field:"id",description:"Node ID"}];function f0({content:e,srcLang:s,toLang:n}){return`Translate the following text from ${s} to ${n}: \`${e}\``}const rl={ENGLISH:"English",VIETNAMESE:"Vietnamese"},m0=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??Tr},x0=({onSend:e,placeholder:s="Type a message...",disabled:n=!1})=>{const[o,r]=p.useState(""),[a,i]=p.useState(Yt.DEFAULT),[c,l]=p.useState(null),[d,h]=p.useState(!1),[u,f]=p.useState(!0),[m,y]=p.useState(!1),[g,x]=p.useState(!1),[w,v]=p.useState(null),N=p.useRef(null),b=p.useRef(null),A=p.useRef(null),R=p.useRef(null),k=$(oe=>{var ae;return((ae=oe.uiState)==null?void 0:ae.isOverlayVisible)??!0}),S=$(oe=>oe.toggleOverlayVisibility),E=$(Ge.selectSelectedNodes),C=$(oe=>{var ae;return((ae=oe.uiState)==null?void 0:ae.dragInfo)!==null}),I=$(oe=>{var ae;return(ae=oe.uiState)==null?void 0:ae.messageSubMode}),O=Yo(m0),H=$(oe=>oe.uiState.activeChatNodeId),[L,W]=p.useState(()=>typeof window<"u"?window.innerWidth<Ls:!1),[P,j]=p.useState(()=>typeof window<"u"?window.innerWidth<Q.chatInput.tabletBreakpoint:!1);p.useEffect(()=>{const oe=()=>{W(window.innerWidth<Ls),j(window.innerWidth<Q.chatInput.tabletBreakpoint)};return window.addEventListener("resize",oe),()=>window.removeEventListener("resize",oe)},[]),p.useEffect(()=>{if(E.length===1){const ae=E[0].data;if(ae!=null&&ae.sessionId){i(Yt.CLAUDE),l(ae.sessionId);const Ce=ae.role!=="assistant";f(Ce);return}}else R.current=null},[E,C]),p.useEffect(()=>{var oe;b.current=((oe=N.current)==null?void 0:oe.getTextArea())??null}),p.useEffect(()=>{if(I!==nn.AUTOFOCUS)return;const oe=()=>{var ae,Ce;(Ce=(ae=N.current)==null?void 0:ae.getTextArea())==null||Ce.focus()};return window.addEventListener("focus",oe),()=>window.removeEventListener("focus",oe)},[I]),p.useEffect(()=>{const oe=ae=>{const Ce=ae.detail;(Ce==null?void 0:Ce.content)!=null&&(r(Ce.content),requestAnimationFrame(()=>{var re;const Y=(re=N.current)==null?void 0:re.getTextArea();if(Y){Y.style.height="auto";const ve=P?Q.chatInput.maxRows*24+16:200;Y.style.height=`${Math.min(Y.scrollHeight,ve)}px`}}))};return window.addEventListener("chat-edit-prefill",oe),()=>window.removeEventListener("chat-edit-prefill",oe)},[P]);const M=p.useCallback(()=>{var gs;if(!H||!L)return;const oe=T.getState(),ae=oe.getNodeById(H);if(!ae||ae.type!==fe.CHAT||!((gs=oe.projectCanvas.getActive())==null?void 0:gs.viewState))return;const Y=A.current;if(!Y)return;const re=document.querySelector("[data-canvas-container]"),ve=(re==null?void 0:re.getBoundingClientRect().top)??0,Ae=(re==null?void 0:re.getBoundingClientRect().left)??0,Ne=Y.getBoundingClientRect().top,Te=window.innerWidth,Re=oe.getNodeById(ae.id),De=(Re==null?void 0:Re.data)??{},$e=ae.width??0,Ue=ae.height??0;ae.y+Ue;const _e=ae.x+$e,Be=Ne-ve;Ue>Be&&Be>0&&oe.updateNode(ae.id,{height:Be});const Ze=Math.min(Ue,Be),Le=ae.y+Ze,mt=Ne-ve-Le,Gt=Te-Ae-_e;oe.setActiveCanvasViewState(vo=>({...vo,targetView:{targetOffset:{x:Gt,y:mt},targetScale:1,animationStartTime:0,animationDuration:Q.claudeChat.alignScrollDuration}})),oe.updateNode(ae.id,{data:{...De,viewMode:"chat"}})},[H,L]),B=p.useCallback(()=>{M()},[M]),U=p.useCallback(()=>{var oe;return((oe=T.getState().projectCanvas.getActive())==null?void 0:oe.coreState.selectedNodes)??[]},[]),z=p.useMemo(()=>[{id:"claude",name:"Claude",trigger:"claude",description:"Send to Claude AI",onSelect:()=>(i(Yt.CLAUDE),"")},{id:"claude-project-select",name:"Claude Project Select",trigger:"claude project select",description:"Select Claude project for next message",onSelect:()=>(y(!0),i(Yt.CLAUDE),"")},{id:"translate-selected",name:"Translate Selected",trigger:"translate selected",description:"Translate selected node content",onSelect:()=>{var Y;const ae=((Y=U()[0])==null?void 0:Y.content)??"";return ae?f0({content:ae,srcLang:rl.ENGLISH,toLang:rl.VIETNAMESE}):(Ee.warning("No content selected",{description:"Select a node with content first"}),"")}}],[c,m,w,U]),{isOpen:_,filteredCommands:G,selectedIndex:F,handleKeyDown:D,handleChange:V,selectCommand:J,close:ie,menuPosition:Se}=dg({commands:z,inputRef:b}),{isOpen:me,filteredFormulas:Z,selectedIndex:ge,handleKeyDown:we,handleChange:te,selectFormula:X,close:K,menuPosition:ne,isFieldMode:ce}=h0({formulas:p0,inputRef:b,getSelectedNodes:U,fieldCompletions:g0}),de=p.useCallback(oe=>{const ae=oe.target.value;r(ae),V(ae),te(ae);const Ce=P?Q.chatInput.maxRows*24+16:200,Y=oe.target,re=Y.offsetHeight;Y.style.height="auto";const ve=Math.min(Y.scrollHeight,Ce);if(Y.style.height=`${ve}px`,L&&re!==ve){const Ae=A.current,pe=document.querySelector("[data-canvas-container]"),Ne=(pe==null?void 0:pe.getBoundingClientRect().top)??0,Re=((Ae==null?void 0:Ae.getBoundingClientRect().top)??0)-Ne;if(H){const De=T.getState(),$e=De.getNodeById(H);if($e&&$e.type===fe.CHAT){const Ue=$e.height??0,_e=Re;Math.abs(Ue-_e)>1&&De.updateNode($e.id,{height:_e})}}}},[V,te,P,L,H]),q=p.useCallback(()=>{var si,ni;const oe=T.getState();if(H){const ns=oe.getNodeById(H);if(ns&&ns.type===fe.CHAT)return ns}const ae=A.current;if(!ae)return null;const Ce=(si=oe.projectCanvas.getActive())==null?void 0:si.viewState;if(!Ce)return null;const{scale:Y,offset:re}=Ce,ve=ae.getBoundingClientRect(),{viewMode:Ae,windowed:pe,desktopWidth:Ne,desktopHeight:Te}=Q.chatNode,Re=((ni=window.visualViewport)==null?void 0:ni.width)??window.innerWidth,De=document.querySelector("[data-canvas-container]"),$e=(De==null?void 0:De.getBoundingClientRect().top)??0,Ue=ve.top,_e=document.querySelector('[data-test="canvas-chat-input-textarea-container"]'),Be=_e==null?void 0:_e.getBoundingClientRect();let Ze,Le;if(L&&Ae==="fullwidth")Ze=Re,Le=$e;else{const ns=L?pe.mobileViewportGap:pe.desktopViewportGap;Ze=L?Re-ns*2:Math.min((Be==null?void 0:Be.width)??ve.width,Ne),L||((Be==null?void 0:Be.right)??ve.right)-Ze,Le=$e+ns}const mt=L?Ue-Le:Te,Gt=Ze,gs=mt,vo=(De==null?void 0:De.getBoundingClientRect().left)??0,Qr=L?Re:(Be==null?void 0:Be.right)??Re,ei=(Qr-vo-re.x)/Y-Gt,ti=(Ue-$e-re.y)/Y-gs,Da={id:Ve(),type:fe.CHAT,x:ei,y:ti,width:Gt,height:gs,title:"Chat",data:{childNodeIds:[],maxHeight:Q.chatNode.defaultMaxHeight,viewMode:"chat"}};oe.addNode(Da,void 0,{dontSelect:!0}),oe.setActiveChatNodeId(Da.id,!1);const vu=ti+gs,bu=ei+Gt,Nu=Qr-vo-bu,Su=Ue-$e-vu;return oe.setActiveCanvasViewState(ns=>({...ns,targetView:{targetOffset:{x:Nu,y:Su},targetScale:1,animationStartTime:0,animationDuration:Q.claudeChat.alignScrollDuration}})),Da},[H,L]),he=p.useCallback((oe,ae)=>{var Gt;const Ce=q();if(!Ce)return null;const Y=T.getState(),re=L?Q.chatInput.mobile.nodeFontSize:void 0,ve=Ce.data,Ae=(Ce.width??400)-16,Ne=bs(oe)+16,Te=Math.min(Ne,Ae),De=gh(oe,{containerWidth:Te,fontSize:re,skipPaddingSubtraction:!0})+ke.NODE_Y_PADDING,$e={id:Ve(),type:fe.TEXT,x:Ce.x,y:Ce.y,width:Te,height:De,content:oe,...ae&&{data:ae},...re&&{styles:{fontSize:re}}};Y.addNode($e,void 0,{dontSelect:!0}),Y.updateNode(Ce.id,{data:{...ve,childNodeIds:[...ve.childNodeIds||[],$e.id]}});const Ue=40,_e=16,Le=((((Gt=ve.childNodeIds)==null?void 0:Gt.length)??0)+1)*(De+8),mt=Math.min(Ue+_e+Le,Q.chatNode.defaultMaxHeight);return mt>(Ce.height??0)&&Y.updateNode(Ce.id,{height:mt}),$e},[q,L]),be=p.useCallback(oe=>{var Ae;if(!H)return!1;const ae=T.getState(),Ce=ae.getNodeById(H);if(!(Ce!=null&&Ce.data))return!1;const Y=Ce.data,re=Y.pendingNoteNodeId;if(!re)return!1;const ve=ae.getNodeById(re);if(!ve)return ae.updateNode(H,{data:{...Y,pendingNoteNodeId:void 0}}),!1;if(oe){const pe=ve.data??{};ae.updateNode(re,{content:oe,data:{...pe,isTemp:!1}})}else{const pe=(Y.childNodeIds??[]).filter(Ne=>Ne!==re);return ae.updateNode(H,{data:{...Y,childNodeIds:pe,pendingNoteNodeId:void 0}}),ae.deleteNodeById(re),!0}return ae.updateNode(H,{data:{...(Ae=ae.getNodeById(H))==null?void 0:Ae.data,pendingNoteNodeId:void 0}}),!0},[H]),ue=p.useCallback(oe=>{var Ae;if(!H)return!1;const ae=T.getState(),Ce=ae.getNodeById(H);if(!(Ce!=null&&Ce.data))return!1;const Y=Ce.data,re=Y.editingNodeId;if(!re)return!1;const ve=ae.getNodeById(re);if(!ve)return ae.updateNode(H,{data:{...Y,editingNodeId:void 0}}),!1;if(oe&&oe!==ve.content){const pe=typeof ve.content=="string"?ve.content:"";Nr.push(re,pe),ae.updateNode(re,{content:oe})}return ae.updateNode(H,{data:{...(Ae=ae.getNodeById(H))==null?void 0:Ae.data,editingNodeId:void 0}}),!0},[H]),le=p.useCallback(()=>{setTimeout(()=>{o.trim()||be(null),ue(null)},200)},[o,be,ue]),ye=p.useCallback(async()=>{var Ce;const oe=o.trim();if(!oe)return;const ae=(Ce=N.current)==null?void 0:Ce.getTextArea();if(a===Yt.CLAUDE){h(!0),r(""),ae&&(ae.style.height="auto"),requestAnimationFrame(async()=>{try{let Y=c;if(!Y){const ve=await rr.createSession();if(!ve.success||!ve.sessionId)throw new Error(ve.error??"Failed to create Claude session");Y=ve.sessionId,l(Y)}he(oe,{sessionId:Y,role:"user"});const re=await rr.sendMessage({sessionId:Y,message:oe});if(!re.success)throw new Error(re.error??"Failed to send message to Claude");he(re.response,{sessionId:Y,role:"assistant"}),e==null||e(oe),ae==null||ae.focus()}catch(Y){const re=Y instanceof Error?Y.message:"Unknown error";Ee.error("Claude API error",{description:re}),c&&he(`Error: ${re}`,{sessionId:c,role:"error"})}finally{h(!1)}});return}r(""),i(Yt.DEFAULT),ae&&(ae.style.height="auto"),requestAnimationFrame(()=>{ue(oe)||be(oe)||he(oe),e==null||e(oe),ae==null||ae.focus()})},[o,e,a,c,he,be,ue]),xe=p.useCallback(()=>{if(a===Yt.CLAUDE){const oe=(w==null?void 0:w.split("/").pop())??"",ae=c?Si(c,3,3):"new";return oe?`[${oe}] ${ae}`:c?Si(c,3,3):"Claude"}return rb[a]},[a,c,w]),je=p.useCallback(oe=>{if(D(oe),we(oe),!(_&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(oe.key))&&!(me&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(oe.key))&&oe.key==="Enter"&&!_&&!me){if(P)return;oe.shiftKey||(oe.preventDefault(),ye())}},[ye,D,we,_,me,P]),Oe=P?Q.chatInput.maxRows*24+16:200;return t.jsxs("div",{ref:A,className:"w-screen md:w-[50vw] pr-2",style:{zIndex:We.canvasChatInput},"data-test":"canvas-chat-input-container","data-ui-panel":"true",children:[_&&t.jsx(ug,{commands:G,selectedIndex:F,position:Se,onSelect:J,onClose:ie}),me&&t.jsx(cu,{formulas:Z,selectedIndex:ge,position:ne,onSelect:X,onClose:K,triggerPrefix:ce?".":"="}),m&&t.jsxs("div",{"data-test":"chat-input-project-selector",className:"absolute bottom-full mb-2 left-0 right-0 bg-background border rounded-lg shadow-lg p-3",style:{zIndex:We.canvasChatInput+1},children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-sm font-medium",children:"Select Claude Project"}),t.jsx("button",{"data-test":"chat-input-project-selector-close",onClick:()=>y(!1),className:"p-1 hover:bg-muted rounded",children:t.jsx(Ke,{className:"h-4 w-4"})})]}),t.jsx(fh,{variant:"select",onChange:oe=>{v(typeof oe=="string"?oe:null),setTimeout(()=>{var Ce,Y;l(null),i(Yt.CLAUDE),y(!1),(Y=(Ce=N.current)==null?void 0:Ce.getTextArea())==null||Y.focus()},0)}})]}),a!==Yt.DEFAULT&&t.jsxs("div",{"data-test":"chat-input-mode-indicator",className:"absolute -top-7 left-2 flex items-center gap-1 px-2 pl-2 py-1 bg-primary text-primary-foreground text-xs font-medium rounded-t-md",children:[t.jsx("span",{"data-test":"chat-input-mode-label",children:xe()}),t.jsx("button",{"data-test":"chat-input-mode-clear",onClick:()=>{i(Yt.DEFAULT),l(null)},className:"p-0.5 hover:bg-primary-foreground/20 rounded",title:"Clear mode",children:t.jsx(Ke,{className:"h-3 w-3"})})]}),t.jsxs("div",{className:"flex items-center pb-1","data-test":"canvas-chat-input-wrapper",children:[t.jsxs("div",{className:"relative",children:[t.jsx(se,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 h-10 w-10 bg-background rounded-lg",title:"More actions","data-test":"canvas-chat-input-plus-button",onClick:()=>x(!g),children:t.jsx(Tt,{className:"h-5 w-5"})}),g&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0",style:{zIndex:We.popover-1},onClick:()=>x(!1),"data-test":"canvas-chat-input-plus-menu-backdrop"}),t.jsx("div",{className:"absolute bottom-full left-0 mb-2 w-auto p-1 rounded-md border bg-popover text-popover-foreground shadow-md",style:{zIndex:We.popover},"data-test":"canvas-chat-input-plus-menu",children:t.jsx(se,{type:"button",variant:"ghost",size:"sm",className:"w-full justify-start gap-2 whitespace-nowrap",onClick:()=>{S(),x(!1)},"data-test":"canvas-chat-input-toggle-overlay",children:k?t.jsxs(t.Fragment,{children:[t.jsx(Os,{className:"h-4 w-4"}),t.jsx("span",{children:"Hide Overlay"})]}):t.jsxs(t.Fragment,{children:[t.jsx(us,{className:"h-4 w-4"}),t.jsx("span",{children:"Show Overlay"})]})})})]})]}),t.jsx("div",{className:"flex-1 min-w-0 bg-background border rounded-lg shadow-lg","data-test":"canvas-chat-input-textarea-container",children:t.jsx(pl,{ref:N,value:o,onChange:de,onKeyDown:je,onFocus:B,onBlur:le,placeholder:s,className:"min-h-[40px] resize-none border-0 focus-visible:ring-0 focus-visible:ring-offset-0",style:{maxHeight:`${Oe}px`,fontSize:L?Q.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:L?Q.chatInput.mobile.fontConfig.cssLineHeight:void 0},rows:1,showFilePicker:!0,showCopyButton:!1,showAudioButton:!L,showConfigButton:!1,audioButtonVariant:"muted",useMarkdown:!1,readOnly:n||d,keyboard:O})}),t.jsx(se,{type:"button",size:"icon",onClick:ye,disabled:n||!o.trim()||d,className:"flex-shrink-0 h-10 w-10 ml-2","data-test":"canvas-chat-input-send-button",children:d?t.jsx(xo,{className:"h-4 w-4 animate-spin","data-test":"canvas-chat-input-loading"}):t.jsx(Up,{className:"h-4 w-4"})})]})]})},y0=[],w0=()=>{const e=$(u=>u.uiState.switchLayerDialog),s=$(u=>{var f;return((f=u.projectCanvas.getActive())==null?void 0:f.coreState.layers)??y0}),n=$(u=>{var f;return((f=u.projectCanvas.getActive())==null?void 0:f.coreState.activeLayerId)??At}),o=(e==null?void 0:e.isOpen)??!1,r=(e==null?void 0:e.targetLayerId)??At,a=s.find(u=>u.id===r),i=(a==null?void 0:a.name)??(r===At?"Default Layer":"Unknown Layer"),c=s.find(u=>u.id===n),l=(c==null?void 0:c.name)??(n===At?"Default Layer":"Unknown Layer"),d=()=>{T.getState().setUiState(u=>({...u,switchLayerDialog:null}))},h=()=>{T.getState().layer.setActive(r),d()};return t.jsx(gl,{open:o,onOpenChange:u=>!u&&d(),children:t.jsxs(fl,{"data-test":"switch-layer-dialog",children:[t.jsxs(ml,{children:[t.jsx(xl,{"data-test":"switch-layer-dialog-title",children:"Node on Different Layer"}),t.jsxs(mh,{"data-test":"switch-layer-dialog-description",children:['You are currently on the "',l,'" layer. The node you clicked is on the "',i,'" layer. Would you like to switch to that layer?']})]}),t.jsxs(xh,{"data-test":"switch-layer-dialog-footer",children:[t.jsx(se,{variant:"outline",onClick:d,"data-test":"switch-layer-dialog-cancel",children:"Cancel"}),t.jsx(se,{onClick:h,"data-test":"switch-layer-dialog-confirm",children:"Switch Layer"})]})]})})},v0=[],lu="turn-to-vocabulary-shared",b0=192,N0=400,Lo=8;function il(e,s){const n=Xo(e),o=Xo(s),a=Math.max(n,o)+40;return Math.max(a,ke.VOCAB_NODE_MIN_WIDTH)}function du(){var o;const e=T.getState(),n=(((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??[]).filter(r=>r.type===fe.TEXT).sort((r,a)=>r.x+r.y-(a.x+a.y));if(n.length!==0)if(n.length===1){const a=(typeof n[0].content=="string"?n[0].content:"").trim(),i={vocabType:tt.VOCABULARY,term:"",definition:"",sourceWord:a,translationWord:""};e.updateNode(n[0].id,{type:fe.VOCABULARY,data:i,content:"",width:il(a,"")})}else{const r=n[0],a=n[n.length-1],i=typeof r.content=="string"?r.content:"",c=typeof a.content=="string"?a.content:"",l=i.trim(),d=c.trim(),h={vocabType:tt.VOCABULARY,term:"",definition:"",sourceWord:l,translationWord:d};e.updateNode(r.id,{type:fe.VOCABULARY,data:h,content:"",width:il(l,d)});for(let f=1;f<n.length;f++)e.deleteNodeById(n[f].id);const u=e.getNodeById(r.id);u&&e.setSelectedNodes([u])}}dt(lu,()=>{du()});function S0(){var E;const e=$(C=>C.uiState.nodeContextMenu),s=$(C=>{var I;return((I=C.projectCanvas.getActive())==null?void 0:I.coreState.nodes)??[]}),n=$(p.useCallback(C=>{var I;return((I=C.projectCanvas.getActive())==null?void 0:I.coreState.layers)??v0},[])),o=ps(),r=typeof window<"u"&&window.location.protocol==="http:",a=p.useMemo(()=>e!=null&&e.nodeId?s.find(C=>C.id===e.nodeId)??null:null,[e==null?void 0:e.nodeId,s]),i=!!e&&!!a,c=p.useMemo(()=>{if(!e)return{x:0,y:0};const C=typeof window<"u"?window.innerWidth:1e3,I=typeof window<"u"?window.innerHeight:800,O=C-b0-Lo,H=Math.min(e.position.x,O),L=I-N0-Lo,W=Math.min(e.position.y,L);return{x:Math.max(Lo,H),y:Math.max(Lo,W)}},[e]),l=p.useCallback(C=>{C||T.getState().setNodeContextMenu(null)},[]),d=p.useCallback(C=>{a&&T.getState().updateNode(a.id,{options:{...a.options,lockSize:C}})},[a]),h=(a==null?void 0:a.layerId)??At,u=n.filter(C=>C.id!==h),f=u.length>0,m=(a==null?void 0:a.type)===fe.TEXT,y=((E=a==null?void 0:a.options)==null?void 0:E.lockSize)??!1,g=C=>{var H;const O=(((H=T.getState().projectCanvas.getActive())==null?void 0:H.coreState.selectedNodes)??[]).map(L=>L.id);T.getState().layer.moveNodesToLayer(O,C)},x=()=>{T.getState().deleteSelectedNodes(),T.getState().setSegmentedButtonAction("node-context-menu","Delete",()=>()=>T.getState().deleteSelectedNodes())},w=()=>{cd()},v=()=>{T.getState().duplicateNodes()},N=p.useCallback(()=>{var L,W;const C=T.getState(),I=((L=C.projectCanvas.getActive())==null?void 0:L.coreState.selectedNodes)??[],O=((W=C.projectCanvas.getActive())==null?void 0:W.coreState.nodes)??[],H=[];for(const P of I)if(P.type===fe.CHAT){const j=P.data,B=((j==null?void 0:j.childNodeIds)??[]).map(U=>O.find(z=>z.id===U)).filter(U=>U!==void 0).map(U=>typeof U.content=="string"?U.content:"").filter(U=>U.length>0);H.push(...B)}else typeof P.content=="string"&&P.content.length>0&&H.push(P.content);return H},[]),b=p.useCallback(()=>{const I=N().join(`
`);o&&r?Xn(I,()=>l(!1)):Yn(I)},[N,o,r,l]),A=p.useCallback(()=>{const I=N().join(`

`);o&&r?Xn(I,()=>l(!1)):Yn(I)},[N,o,r,l]),R=p.useCallback(()=>{const O=N().flatMap(H=>H.split(`
`).filter(L=>L.trim())).map((H,L)=>`${L+1}. ${H}`).join(`
`);o&&r?Xn(O,()=>l(!1)):Yn(O)},[N,o,r,l]),k=p.useCallback(()=>{const O=N().flatMap(H=>H.split(`
`).filter(L=>L.trim())).map(H=>`- ${H}`).join(`
`);o&&r?Xn(O,()=>l(!1)):Yn(O)},[N,o,r,l]),S=()=>{du(),T.getState().setSegmentedButtonAction("node-context-menu","Turn to Vocabulary",void 0,{actionId:lu})};return!a||!e?null:t.jsxs(to,{open:i,onOpenChange:l,children:[t.jsx("div",{"data-test":"shared-context-menu-trigger",style:{position:"fixed",left:c.x,top:c.y,width:1,height:1,pointerEvents:"none"}}),t.jsxs(so,{className:"w-48","data-test":"node-context-menu",style:{position:"fixed",left:c.x,top:c.y},children:[t.jsx(nt,{onSelect:()=>d(!y),"data-test":"lock-size-item",children:y?t.jsxs(t.Fragment,{children:[t.jsx(ql,{className:"mr-2 h-4 w-4"}),"Unlock Size"]}):t.jsxs(t.Fragment,{children:[t.jsx(ea,{className:"mr-2 h-4 w-4"}),"Lock Size"]})}),t.jsx(on,{}),t.jsxs(nt,{onSelect:w,"data-test":"copy-item",children:[t.jsx(Bt,{className:"mr-2 h-4 w-4"}),"Copy"]}),t.jsxs(nt,{onSelect:v,"data-test":"duplicate-item",children:[t.jsx(Vp,{className:"mr-2 h-4 w-4"}),"Duplicate"]}),t.jsxs(Hn,{children:[t.jsxs("div",{className:"relative flex items-center h-8 gap-1 px-1","data-test":"copy-content-split",children:[t.jsxs("div",{onClick:()=>{b(),l(!1)},className:"flex items-center flex-1 h-full px-2 cursor-default text-sm hover:bg-accent rounded-sm","data-test":"copy-content-item",children:[t.jsx(Vl,{className:"mr-2 h-4 w-4"}),"Copy content"]}),t.jsx(Fn,{className:"h-full w-6 flex items-center justify-center p-0 hover:bg-accent rounded-sm [&>svg:last-child]:hidden","data-test":"copy-content-expand",children:t.jsx(ss,{className:"h-4 w-4"})})]}),t.jsxs(Bn,{"data-test":"copy-content-submenu",children:[t.jsxs(nt,{onSelect:A,"data-test":"copy-content-newlines",children:[t.jsx(Yl,{className:"mr-2 h-4 w-4"}),"With new lines"]}),t.jsxs(nt,{onSelect:R,"data-test":"copy-content-numbered",children:[t.jsx(Bs,{className:"mr-2 h-4 w-4"}),"Numbered"]}),t.jsxs(nt,{onSelect:k,"data-test":"copy-content-list",children:[t.jsx(fo,{className:"mr-2 h-4 w-4"}),"List"]})]})]}),f&&t.jsxs(Hn,{children:[t.jsxs(Fn,{"data-test":"move-to-trigger",children:[t.jsx(ts,{className:"mr-2 h-4 w-4"}),"Move to"]}),t.jsx(Bn,{"data-test":"move-to-submenu",children:t.jsxs(Hn,{children:[t.jsxs(Fn,{"data-test":"move-to-layer-trigger",children:[t.jsx(_s,{className:"mr-2 h-4 w-4"}),"Layer"]}),t.jsx(Bn,{"data-test":"move-to-layer-submenu",children:u.map(C=>t.jsxs(nt,{onSelect:()=>g(C.id),disabled:C.isLocked,"data-test":"move-to-layer-option",children:[C.isLocked&&t.jsx(ea,{className:"mr-2 h-4 w-4"}),C.name]},C.id))})]})})]}),m&&t.jsxs(t.Fragment,{children:[t.jsx(on,{}),t.jsxs(Hn,{children:[t.jsxs(Fn,{"data-test":"turn-to-trigger",children:[t.jsx(Wr,{className:"mr-2 h-4 w-4"}),"Turn to"]}),t.jsx(Bn,{"data-test":"turn-to-submenu",children:t.jsxs(nt,{onSelect:S,"data-test":"turn-to-vocabulary-item",children:[t.jsx(va,{className:"mr-2 h-4 w-4"}),"Vocabulary"]})})]})]}),t.jsx(on,{}),t.jsxs(nt,{onSelect:x,className:"text-destructive focus:text-destructive","data-test":"delete-item",children:[t.jsx(Nt,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})}const C0=2e3,j0=[],cl=[],Cn={offset:{x:0,y:0},scale:1,targetView:null},k0=He.memo(({node:e,isSelected:s})=>{const a=(typeof e.content=="string"?e.content:"").split(`
`).filter(y=>y.trim().length>0),i=e.width??200,c=e.height??100,l=Math.max(a.length,1),d=Math.min(20,c/l),h=8,u="hsl(var(--muted))",f=s?"2px solid #2563eb":"1px solid hsl(var(--border))",m="hsl(var(--foreground))";return t.jsx("div",{style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${i}px`,height:`${c}px`,backgroundColor:u,border:f,borderRadius:"4px",padding:`${h}px`,display:"flex",flexDirection:"column",gap:`${Math.min(4,d*.2)}px`,overflow:"hidden",willChange:"transform",backfaceVisibility:"hidden"},children:a.slice(0,Math.floor(c/d)).map((y,g)=>{const x=y.length,w=Math.max(...a.map(N=>N.length),1),v=Math.max(20,x/w*90);return t.jsx("div",{style:{height:`${Math.max(2,d-4)}px`,width:`${v}%`,backgroundColor:s?"#93c5fd":m,borderRadius:"2px"}},g)})})});k0.displayName="SimplifiedNode";const uu=He.memo(({nodes:e,selectedNodeIds:s,selectedNodesCount:n,scale:o,offset:r})=>{const a=o<Wn,i=p.useMemo(()=>{if(o>=Wn)return e;const c=window.innerWidth,l=window.innerHeight,d=-r.x/o,h=-r.y/o,u=d+c/o,f=h+l/o,m=500/o;return e.filter(g=>{const x=g.x+(g.width??200),w=g.y+(g.height??100);return g.x<u+m&&x>d-m&&g.y<f+m&&w>h-m})},[e,o,r]);return a?t.jsx(t.Fragment,{children:i.map(c=>t.jsx(xa,{node:c,isSelected:s.has(c.id),selectedNodesCount:n,useSimplifiedRendering:!0},c.id))}):t.jsx(t.Fragment,{children:e.map(c=>t.jsx(xa,{node:c,isSelected:s.has(c.id),selectedNodesCount:n},c.id))})},(e,s)=>{const n=e.scale<Wn,o=s.scale<Wn;return!(n!==o||o&&(e.scale!==s.scale||e.offset.x!==s.offset.x||e.offset.y!==s.offset.y)||e.nodes!==s.nodes||e.selectedNodeIds!==s.selectedNodeIds||e.selectedNodesCount!==s.selectedNodesCount)});uu.displayName="CanvasNodesRenderer";const I0=[],hu=He.memo(({groupNodes:e,selectedNodeIds:s})=>{const n=$(a=>{var i;return((i=a.projectCanvas.getActive())==null?void 0:i.viewState)??Cn}),{scale:o,offset:r}=n;return e.length===0?null:t.jsx("div",{className:"absolute top-0 left-0 origin-top-left","data-test":"canvas-groups-layer",style:{transform:`translate3d(${r.x}px, ${r.y}px, 0) scale(${o})`,zIndex:We.canvasGroups,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:t.jsx("div",{style:{pointerEvents:"auto"},children:e.map(a=>t.jsx(xa,{node:a,isSelected:s.has(a.id),selectedNodesCount:s.size},a.id))})})});hu.displayName="CanvasGroupsLayer";const pu=He.memo(({nodes:e,selectedNodeIds:s,layers:n})=>{const o=$(g=>{var x;return((x=g.projectCanvas.getActive())==null?void 0:x.viewState)??Cn}),{scale:r,offset:a}=o,i=p.useRef(0),c=p.useRef(r),l=p.useRef(!1),d=p.useRef(null),h=p.useRef(new Map),u=p.useMemo(()=>e.filter(g=>!g.isPinned),[e]),f=p.useMemo(()=>e.filter(g=>g.isPinned),[e]),m=p.useMemo(()=>n.length===0?[Sl()]:[...n].sort((g,x)=>g.order-x.order),[n]),y=p.useMemo(()=>{const g=new Map;return m.forEach(x=>{g.set(x.id,[])}),g.has(At)||g.set(At,[]),u.forEach(x=>{const w=x.layerId??At,v=g.get(w);if(v)v.push(x);else{const N=g.get(At);N&&N.push(x)}}),g},[u,m]);return p.useEffect(()=>{i.current+=1,c.current!==r&&(l.current||(l.current=!0,h.current.forEach(x=>{x&&(x.style.willChange="transform, contents")})),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{l.current=!1,h.current.forEach(x=>{x&&(x.style.willChange="")})},200)),c.current=r},[r,e.length]),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"absolute top-0 left-0 origin-top-left",style:{transform:`translate3d(${a.x}px, ${a.y}px, 0) scale(${r})`,zIndex:We.canvasNodes,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:[t.jsx(M0,{scale:r,offset:a}),m.map((g,x)=>{const w=y.get(g.id)??[];return g.isVisible?t.jsx("div",{ref:v=>{h.current.set(g.id,v)},"data-layer-id":g.id,"data-layer-name":g.name,"data-test":"canvas-layer-container",style:{zIndex:x,opacity:g.opacity/100,pointerEvents:g.isLocked?"none":"auto"},children:t.jsx(uu,{nodes:w,selectedNodeIds:s,selectedNodesCount:s.size,scale:r,offset:a})},g.id):null})]}),f.length>0&&t.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:We.canvasNodes+1},children:t.jsx("div",{style:{pointerEvents:"auto"},children:f.map(g=>t.jsx(xa,{node:g,isSelected:s.has(g.id),selectedNodesCount:s.size},g.id))})})]})});pu.displayName="CanvasTransformLayer";const A0=({arrows:e,selectedArrows:s})=>{const n=$(c=>{var l;return((l=c.projectCanvas.getActive())==null?void 0:l.viewState)??Cn}),{scale:o,offset:r}=n,a=c=>!s.some(d=>d.id===c.id)||s.length>1,i=e.filter(a);return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:We.canvasArrows,willChange:"transform"},children:t.jsxs("g",{transform:`translate(${r.x}, ${r.y}) scale(${o})`,style:{touchAction:"none"},children:[i.map(c=>t.jsx(su,{arrow:c},c.id)),t.jsx(DN,{})]})})},T0=He.memo(A0,(e,s)=>e.arrows.length!==s.arrows.length||e.selectedArrows.length!==s.selectedArrows.length?!1:e.arrows===s.arrows&&e.selectedArrows===s.selectedArrows),E0=({selectedArrows:e})=>{const s=$(r=>{var a;return((a=r.projectCanvas.getActive())==null?void 0:a.viewState)??Cn}),{scale:n,offset:o}=s;return e.length!==1?null:t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:We.canvasNodes+1,willChange:"transform"},children:t.jsx("g",{transform:`translate(${o.x}, ${o.y}) scale(${n})`,style:{touchAction:"none"},children:t.jsx(su,{arrow:e[0]},e[0].id)})})},R0=He.memo(E0,(e,s)=>e.selectedArrows.length!==s.selectedArrows.length?!1:e.selectedArrows===s.selectedArrows),gu=He.memo(()=>{const e=$(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??Cn}),{scale:s,offset:n}=e;return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:We.canvasNodes+2,willChange:"transform"},"data-test":"temporary-drawing-layer",children:t.jsx("g",{transform:`translate(${n.x}, ${n.y}) scale(${s})`,style:{touchAction:"none"},children:t.jsx(ON,{})})})});gu.displayName="CanvasTemporaryDrawingLayer";const fu=He.memo(()=>{const e=$(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??Cn}),{scale:s,offset:n}=e;return t.jsx(HN,{scale:s,offset:n})});fu.displayName="CanvasGridLayer";const M0=({scale:e,offset:s,x:n=0,y:o=0})=>t.jsx("div",{style:{position:"absolute",left:n*e,top:o*e,width:12,height:12,background:"darkred",borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 2px #0008",cursor:"pointer",zIndex:10,transform:"translate(-50%, -50%)",userSelect:"none"},title:`Canvas origin (${n.toFixed(1)}, ${o.toFixed(1)})`}),P0=()=>{performance.now();const e=z=>{},s=$(z=>z.uiState.isOverlayVisible??!0);$(z=>z.uiState.addNodeType);const n=$(z=>z.uiState.mode),o=$(z=>z.uiState.isPanning),r=$(z=>z.uiState.selectFromDrawMode),a=$(z=>{var _,G,F;return((F=(G=(_=z.preferences)==null?void 0:_.canvasConfig)==null?void 0:G.background)==null?void 0:F.paperTexture)??Q.background.paperTexture}),i=$(z=>{var _,G,F;return((F=(G=(_=z.preferences)==null?void 0:_.canvasConfig)==null?void 0:G.background)==null?void 0:F.customParams)??Q.background.customParams}),{theme:c}=bl(),l=He.useMemo(()=>c==="dark"?!0:c==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[c]),d=a!=="custom"&&yh[a]||"",h=He.useMemo(()=>{if(!i||i.opacity===0)return{};const z=l?100-i.bgLightness:i.bgLightness;return{backgroundColor:`hsl(${i.bgHue} ${i.bgSaturation}% ${z}%)`,position:"relative"}},[i,l]),u=He.useMemo(()=>!i||i.opacity===0?null:{position:"absolute",inset:0,opacity:i.opacity,pointerEvents:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${i.baseFrequency}' numOctaves='${i.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`,zIndex:0},[i]),f=p.useRef(0),m=p.useRef(performance.now());p.useEffect(()=>{f.current+=1;const z=performance.now();z-m.current>=2e3&&(f.current=0,m.current=z)});const[y,g]=p.useState(()=>typeof window<"u"?window.innerWidth<Ls:!1);p.useEffect(()=>{const z=()=>g(window.innerWidth<Ls);return window.addEventListener("resize",z),()=>window.removeEventListener("resize",z)},[]);const x=$(z=>z.toggleOverlayVisibility),w=mS();e(`nodes:${w.length}`);const v=$(z=>{var _;return((_=z.projectCanvas.getActive())==null?void 0:_.coreState.selectedNodes)??j0});e(`selectedNodes:${v.length}`);const N=$(z=>{var _;return((_=z.projectCanvas.getActive())==null?void 0:_.coreState.arrows)??cl});e(`arrows:${N.length}`);const b=$(z=>{var _;return((_=z.projectCanvas.getActive())==null?void 0:_.coreState.selectedArrows)??cl});e(`selectedArrows:${b.length}`);const A=$(z=>{var _;return((_=z.projectCanvas.getActive())==null?void 0:_.coreState.layers)??I0}),R=$(z=>z.saveStateToLocalStorage),k=c0(),S=$(z=>z.uiState.activeGlobalOverlay),E=S&&S!==Ps.NONE;p.useEffect(()=>{Q.autosave&&setInterval(()=>{typeof R=="function"&&R()},C0)},[]);const C=p.useMemo(()=>new Set(v.map(z=>z.id)),[v]),I=p.useMemo(()=>{const z=new Set;return w.forEach(_=>{if(_.type===fe.GROUP&&_.isCollapsed){const G=_.data;G!=null&&G.childNodeIds&&G.childNodeIds.forEach(F=>z.add(F))}if(_.type===fe.CHAT){const G=_.data;G!=null&&G.childNodeIds&&G.childNodeIds.forEach(F=>z.add(F))}}),z},[w]),O=p.useMemo(()=>{const z=Xf(w,N);return I.forEach(_=>z.add(_)),z},[w,N,I]),{visibleGroupNodes:H,visibleNonGroupNodes:L}=p.useMemo(()=>{const z=w.filter(F=>!O.has(F.id)),_=[],G=[];return z.forEach(F=>{F.type===fe.GROUP?_.push(F):G.push(F)}),{visibleGroupNodes:_,visibleNonGroupNodes:G}},[w,O]),W=p.useMemo(()=>N.filter(z=>{const _=z.startNodeId!==null&&O.has(z.startNodeId),G=z.endNodeId!==null&&O.has(z.endNodeId);return!_&&!G}),[N,O]),P=p.useMemo(()=>b.filter(z=>{const _=z.startNodeId!==null&&O.has(z.startNodeId),G=z.endNodeId!==null&&O.has(z.endNodeId);return!_&&!G}),[b,O]),j=t.jsx(se,{variant:"outline",size:"icon",onClick:x,className:"h-7 w-7","data-prevent-canvas-click":!0,title:s?"Hide Overlay":"Show Overlay","data-test":"canvas-toggle-overlay-button",children:s?t.jsx(Os,{className:"h-4 w-4"}):t.jsx(us,{className:"h-4 w-4"})}),M=t.jsx("div",{className:"flex items-center space-x-2",children:j}),B=n===ee.DRAW||n===ee.SELECT&&r,U=p.useMemo(()=>n===ee.MOVE?o?"grabbing":"grab":n===ee.DRAW?"crosshair":"default",[n,o]);return t.jsxs("div",{className:Me("relative w-full h-full select-none",E&&"ring-2 ring-primary ring-inset",d),"data-canvas-content":!0,"data-global-overlay":S,style:{cursor:U,...h},children:[u&&t.jsx("div",{style:u,"data-test":"custom-texture-overlay"}),t.jsx(fu,{}),t.jsx(hu,{groupNodes:H,selectedNodeIds:C}),t.jsx(T0,{arrows:W,selectedArrows:P}),t.jsx(pu,{nodes:L,selectedNodeIds:C,layers:A}),t.jsx(R0,{selectedArrows:P}),t.jsx(gu,{}),t.jsx(wd,{}),t.jsx(aN,{}),t.jsx(uN,{}),t.jsx(EN,{}),t.jsx(ox,{}),t.jsx(Fm,{isContentVisible:s,topLeft:t.jsx(t.Fragment,{children:t.jsxs(t.Fragment,{children:[t.jsx(WN,{}),t.jsx(Fb,{}),t.jsx(zm,{})]})}),topRight:t.jsxs(t.Fragment,{children:[t.jsx(Vd,{}),t.jsx(PN,{})]}),bottomRight:s&&t.jsx("div",{className:"flex flex-col gap-2",children:t.jsx(Hb,{})}),bottom:t.jsx(tx,{}),alwaysVisibleBottomLeft:!y&&t.jsx("div",{className:"flex flex-col gap-2",children:M}),left:B?void 0:t.jsx(NS,{}),right:B?void 0:k.right,footer:t.jsx(x0,{})}),B&&t.jsx("div",{className:"absolute top-1/2 transform -translate-y-1/2 pointer-events-auto z-50 left-2","data-prevent-canvas-click":!0,"data-test":"draw-mode-toolbar-container",children:t.jsx(PS,{})}),t.jsx(u0,{}),t.jsx(w0,{}),t.jsx(S0,{})]})},D0=({sourceNode:e,allNodes:s,onNodeSelect:n,onClose:o,isVisible:r})=>{const[a,i]=p.useState(""),c=p.useMemo(()=>{const u=(e.highlights||[]).map(f=>f.linkedNodeId).filter(f=>f!==void 0);return s.filter(f=>u.includes(f.id))},[e.highlights,s]),l=p.useMemo(()=>{if(!a)return c;const h=a.toLowerCase();return c.filter(u=>(typeof u.content=="string"?u.content:"").toLowerCase().includes(h))},[c,a]),d=p.useMemo(()=>l.map(h=>{const u=typeof h.content=="string"?h.content:"[Complex content]",f=u.length>50?u.substring(0,50)+"...":u;return t.jsx("div",{className:"text-sm",children:f},h.id)}),[l]);return t.jsxs(et,{isVisible:r,onClose:o,title:`Linked Nodes (${c.length})`,initialPosition:"center","data-test":"linked-nodes-popover",children:[t.jsx("div",{className:"search-field px-3 py-2 border-b border-border",children:t.jsx("input",{type:"text",className:"w-full px-2 py-1 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:"Search linked nodes...",value:a,onChange:h=>i(h.target.value)})}),t.jsx("div",{className:"linked-nodes-list overflow-hidden",children:d.length>0?t.jsx(Rr,{itemList:d,maxHeight:"200px",itemStyles:"border border-border",onSelectionChange:h=>{if(h.length>0){const u=l[h[0]];u&&(n(u),o())}}}):t.jsx("div",{className:"empty-state px-3 py-4 text-sm text-muted-foreground text-center",children:a?"No matching nodes found":"No linked nodes yet"})})]})},ll=({node:e,isChanged:s})=>{const n=e.title||e.id,o=typeof e.content=="string"?e.content:"";return t.jsxs("div",{className:`absolute border-2 ${s?"border-green-500 ring-2 ring-green-500/30":"border-black"} bg-white rounded p-1`,style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:`${ke.FONT_SIZE_MINI}px`},children:[t.jsx("div",{className:"font-semibold text-[10px] truncate",children:n}),t.jsx("div",{className:"text-[8px] text-muted-foreground truncate",children:o.substring(0,50)})]})},O0=({isVisible:e,changes:s,previewNodes:n,currentNodes:o,arrows:r,executionResult:a,onApply:i,onCancel:c})=>{const l=s.length>0,[d,h]=p.useState("canvas"),u=new Set(s.map(m=>m.nodeId)),f=p.useMemo(()=>{if(!a)return null;const m={workflow:{success:a.success,duration:`${a.duration}ms`,executedNodes:a.executedNodeCount,errors:a.errors.length},steps:[],changes:{totalNodes:s.length,updates:s.map(y=>({nodeId:y.nodeId,before:y.before,after:y.after}))}};return a.nodeStates&&a.nodeStates.forEach((y,g)=>{var x;(x=y.executionData)!=null&&x.steps&&y.executionData.steps.forEach(w=>{var N,b,A,R;const v={type:w.stepType,label:w.label,order:w.order};w.stepType==="source"?v.sourceData=y.executionData.sourceData:w.stepType==="loop"?v.items=((N=y.executionData.sourceData)==null?void 0:N.length)||0:w.stepType==="if"?(v.config=w.config,v.conditionResult=w.conditionResult,v.checkedNodes=((b=w.checkedNodes)==null?void 0:b.length)||0,v.matchedNodes=((A=w.checkedNodes)==null?void 0:A.filter(k=>k.matches).map(k=>k.nodeId))||[]):w.stepType==="nodeUpdate"&&(v.targets=((R=y.executionData.nodeUpdates)==null?void 0:R.length)||0),m.steps.push(v)})}),m},[a,s]);return t.jsx(et,{isVisible:e,onClose:c,title:"Workflow Dry Run Results",shouldCloseManually:!0,resizable:!0,initialSize:{width:1200,height:700},children:t.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[t.jsxs("div",{className:"p-4 bg-muted border-b border-border flex items-center justify-between",children:[t.jsx("div",{className:"text-sm",children:l?t.jsxs(t.Fragment,{children:[t.jsx("strong",{children:s.length})," node",s.length!==1?"s":""," will be updated"]}):t.jsx("span",{className:"text-muted-foreground",children:"No changes to apply"})}),l&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{"data-test":"dry-run-view-canvas-button",onClick:()=>h("canvas"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="canvas"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(us,{size:14}),"Canvas Preview"]}),t.jsxs("button",{"data-test":"dry-run-view-list-button",onClick:()=>h("list"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="list"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(fo,{size:14}),"Details"]}),t.jsxs("button",{"data-test":"dry-run-view-json-button",onClick:()=>h("json"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="json"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(Ia,{size:14}),"JSON"]})]})]}),t.jsx("div",{className:"flex-1 overflow-hidden",children:l?d==="json"?t.jsx("div",{className:"h-full overflow-auto p-4 bg-gray-50","data-test":"dry-run-json-view",children:t.jsx("pre",{className:"text-xs font-mono bg-background border border-border rounded p-4 whitespace-pre-wrap break-words",children:JSON.stringify(f,null,2)})}):d==="canvas"?t.jsxs("div",{className:"h-full flex gap-2 p-2",children:[t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-muted px-2 py-1 text-xs font-semibold border-b border-border",children:"Current State"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:o.map(m=>t.jsx(ll,{node:m,isChanged:u.has(m.id)},m.id))})]}),t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-green-500/10 px-2 py-1 text-xs font-semibold border-b border-green-500/30 text-green-700 dark:text-green-400",children:"Preview (After Apply)"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:n.map(m=>t.jsx(ll,{node:m,isChanged:u.has(m.id)},m.id))})]})]}):t.jsx("div",{className:"h-full overflow-y-auto p-4 space-y-4",children:s.map((m,y)=>t.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-2 bg-background",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:m.nodeId}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",y+1]})]}),m.before.title!==m.after.title&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Title"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:m.before.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(ts,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:m.after.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),m.before.content!==m.after.content&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Content"}),t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20 font-mono max-h-24 overflow-y-auto",children:m.before.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:m.before.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(ts,{size:16,className:"text-muted-foreground flex-shrink-0 mt-1"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20 font-mono max-h-24 overflow-y-auto",children:m.after.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:m.after.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),(()=>{const g=Array.isArray(m.before.tags)?m.before.tags:[],x=Array.isArray(m.after.tags)?m.after.tags:[],w=g.map(b=>b.title).sort().join(", "),v=x.map(b=>b.title).sort().join(", ");return w!==v?t.jsxs("div",{className:"space-y-1","data-test":"dry-run-tags-change",children:[t.jsxs("div",{className:"text-xs font-semibold text-muted-foreground flex items-center gap-1",children:[t.jsx(uo,{size:12}),"Tags"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:g.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:g.map(b=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-destructive/20 rounded text-xs",children:["#",b.title]},b.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})}),t.jsx(ts,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:x.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(b=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-xs",children:["#",b.title]},b.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})})]})]}):null})()]},m.nodeId))}):t.jsx("div",{className:"text-center text-muted-foreground py-8",children:"The workflow executed successfully but made no changes to the canvas nodes."})}),t.jsxs("div",{className:"p-4 border-t border-border flex items-center justify-end gap-2",children:[t.jsxs("button",{"data-test":"dry-run-cancel-button",onClick:c,className:"px-4 py-2 text-sm border border-border rounded hover:bg-accent transition-colors flex items-center gap-2",children:[t.jsx(Ke,{size:16}),"Cancel"]}),l&&t.jsxs("button",{"data-test":"dry-run-apply-button",onClick:i,className:"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors flex items-center gap-2",children:[t.jsx(vn,{size:16}),"Apply Changes"]})]})]})})},mu=He.memo(({canvasId:e,canvasName:s,projectName:n,workspaceName:o,isActive:r,isDragging:a,holdProgress:i=0,isReorderMode:c=!1,isReorderTarget:l=!1,onClose:d,onClick:h,onAuxClick:u,dragRef:f})=>{const m=`${n} / ${o} / ${s}`,g=(x=>1-Math.pow(1-x,2))(i);return t.jsxs("div",{ref:f,"data-test":`canvas-tab-${e}`,className:Ie("group relative flex items-center gap-1 px-3 py-1.5 text-sm","border-r border-border","cursor-pointer select-none","min-w-[100px]","transition-colors duration-150",r?"bg-background text-foreground border-b-2 border-b-primary":"bg-muted/50 text-muted-foreground hover:bg-accent hover:text-accent-foreground"),style:{maxWidth:Q.tabBar.maxTabWidth,opacity:a?Q.tabBar.dragSourceOpacity:c&&!l?.5:void 0},onClick:h,onAuxClick:u,title:m,children:[g>0&&t.jsx("div",{className:"absolute bottom-0 left-0 h-0.5 bg-primary",style:{width:`${g*100}%`,transition:g===0?"none":void 0},"data-test":"tab-hold-progress"}),t.jsx("span",{"data-test":"canvas-tab-title",className:"truncate flex-1",children:s}),t.jsx("button",{"data-test":"canvas-tab-close",className:Ie("ml-1 p-0.5 rounded-sm","opacity-0 group-hover:opacity-100","hover:bg-destructive/20 hover:text-destructive","transition-opacity duration-150",r&&"opacity-60",c&&"invisible"),onClick:x=>{x.stopPropagation(),c||d(x)},title:"Close tab",disabled:c,children:t.jsx(Ke,{className:"h-3 w-3"})})]})});mu.displayName="CanvasTab";const L0=js,Ir="canvas-tab-bar-zone",xu=He.memo(({tab:e,isActive:s,isDragging:n,holdProgress:o,isReorderMode:r,isReorderTarget:a,canMoveLeft:i,canMoveRight:c,manager:l,onClose:d,onClick:h,onAuxClick:u,onMoveLeft:f,onMoveRight:m})=>{const y=fg(l,e.canvasId,{canvasId:e.canvasId,dropZoneId:Ir});return t.jsxs("div",{className:"relative",children:[t.jsx(mu,{canvasId:e.canvasId,canvasName:e.canvasName,projectName:e.projectName,workspaceName:e.workspaceName,isActive:s,isDragging:n,holdProgress:o,isReorderMode:r,isReorderTarget:a,onClose:g=>{g.stopPropagation(),d(e.canvasId)},onClick:()=>h(e.canvasId),onAuxClick:g=>{g.button===1&&(g.preventDefault(),u(e.canvasId))},dragRef:y}),r&&a&&i&&t.jsx("button",{className:"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full flex items-center justify-center w-6 h-6 rounded-sm bg-background/80 backdrop-blur-[2px] text-primary hover:bg-background/90 z-50",onClick:g=>{g.stopPropagation(),f()},"data-test":"tab-move-left",children:t.jsx(Zl,{className:"h-4 w-4"})}),r&&a&&c&&t.jsx("button",{className:"absolute right-0 top-1/2 -translate-y-1/2 translate-x-full flex items-center justify-center w-6 h-6 rounded-sm bg-background/80 backdrop-blur-[2px] text-primary hover:bg-background/90 z-50",onClick:g=>{g.stopPropagation(),m()},"data-test":"tab-move-right",children:t.jsx(ss,{className:"h-4 w-4"})})]})});xu.displayName="DraggableTab";const yu=He.memo(()=>{const e=p.useRef(null),s=$(L=>{var W;return((W=L.preferences)==null?void 0:W.openTabs)??L0}),n=$(L=>{var W;return((W=L.projectCanvas.getActive())==null?void 0:W.id)??null}),o=$(L=>{var W;return((W=L.state)==null?void 0:W.activeProjectId)??null}),r=$(L=>{var P,j,M;const W=(P=L.state)==null?void 0:P.activeProjectId;return W?((M=(j=L.state)==null?void 0:j.projects[W])==null?void 0:M.activeWorkspaceId)??null:null}),a=p.useMemo(()=>{var W;const L=((W=T.getState().state)==null?void 0:W.projects)??{};return s.map(P=>{const j=L[P.projectId],M=j==null?void 0:j.workspaces[P.workspaceId],B=M==null?void 0:M.canvases[P.canvasId];return{canvasId:P.canvasId,canvasName:(B==null?void 0:B.name)??"Unknown",projectId:P.projectId,projectName:(j==null?void 0:j.name)??"Unknown",workspaceId:P.workspaceId,workspaceName:(M==null?void 0:M.name)??"Unknown",exists:!!B}}).filter(P=>P.exists)},[s]),i=p.useRef({switchCanvas:T.getState().projectCanvas.switch,closeTab:T.getState().closeTab,reorderTabs:T.getState().reorderTabs,createCanvas:T.getState().projectCanvas.create,openTab:T.getState().openTab});p.useEffect(()=>{if(!n||!o||!r)return;s.some(W=>W.canvasId===n)||i.current.openTab(n,o,r)},[n,o,r,s]);const[c,l]=p.useState(null),[d,h]=p.useState(null),[u,f]=p.useState({}),[m,y]=p.useState({active:!1,canvasId:null,originalOrder:[]}),g=p.useRef(a);g.current=a;const x=p.useMemo(()=>({onDragStart:L=>{var P;const W=((P=L.item.data)==null?void 0:P.canvasId)??null;h(W),f({})},onDragMove:L=>{l(L.sortIndex)},onDrop:L=>{var z;const W=(z=L.item.data)==null?void 0:z.canvasId,P=L.sortIndex??0;if(!W)return;const j=g.current.map(_=>_.canvasId),M=j.indexOf(W);if(M===-1)return;const B=[...j];B.splice(M,1);const U=M<P?P-1:P;B.splice(U,0,W),i.current.reorderTabs(B)},onDragEnd:()=>{l(null),h(null),f({})},onHoldProgress:(L,W)=>{f(P=>{if(W===0){const{[L]:j,...M}=P;return M}return{...P,[L]:W}}),W===1&&(y({active:!0,canvasId:L,originalOrder:g.current.map(P=>P.canvasId)}),f({}))}}),[]),{manager:w}=pg({snap:{enabled:!1,threshold:10},sort:{enabled:!0,orientation:"horizontal",threshold:.5},dragThreshold:5,touchHoldDelay:Q.tabBar.holdDelay,holdIndicatorDelay:Q.tabBar.holdIndicatorDelay},x),v=gg(w,Ir),N=p.useCallback(L=>{e&&(e.current=L),v(L)},[v,e]),b=p.useCallback(L=>{i.current.switchCanvas(L)},[]),A=p.useCallback(L=>{i.current.closeTab(L)},[]),R=p.useCallback(L=>{i.current.closeTab(L)},[]),k=p.useCallback(()=>{const L=i.current.createCanvas("New Canvas");L&&i.current.switchCanvas(L)},[]),S=p.useCallback(()=>{T.getState().setUiState(L=>({...L,floatingHeaderExpanded:!L.floatingHeaderExpanded}))},[]),E=p.useCallback(L=>{e.current&&requestAnimationFrame(()=>{var P;const W=(P=e.current)==null?void 0:P.querySelector(`[data-test="canvas-tab-${L}"]`);W&&W.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})})},[]),C=p.useCallback(()=>{if(!m.canvasId)return;const L=a.map(j=>j.canvasId),W=L.indexOf(m.canvasId);if(W<=0)return;const P=[...L];[P[W-1],P[W]]=[P[W],P[W-1]],i.current.reorderTabs(P),E(m.canvasId)},[m.canvasId,a,E]),I=p.useCallback(()=>{if(!m.canvasId)return;const L=a.map(j=>j.canvasId),W=L.indexOf(m.canvasId);if(W>=L.length-1)return;const P=[...L];[P[W],P[W+1]]=[P[W+1],P[W]],i.current.reorderTabs(P),E(m.canvasId)},[m.canvasId,a,E]),O=p.useCallback(()=>{y({active:!1,canvasId:null,originalOrder:[]})},[]),H=p.useCallback(()=>{m.originalOrder.length>0&&i.current.reorderTabs(m.originalOrder),y({active:!1,canvasId:null,originalOrder:[]})},[m.originalOrder]);return p.useEffect(()=>{if(!n||!e.current)return;const L=e.current.querySelector(`[data-test="canvas-tab-${n}"]`);L&&L.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},[n]),a.length===0?t.jsxs("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border px-1",children:[t.jsx("div",{className:"flex-1"}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:Ie("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:k,title:"New canvas",children:t.jsx(Tt,{className:"h-4 w-4"})}),t.jsx("button",{"data-test":"floating-header-toggle-button",className:Ie("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onPointerDown:S,title:"Toggle header",children:t.jsx(Pt,{className:"h-4 w-4"})})]}):t.jsxs("div",{"data-test":"canvas-tab-bar",className:"relative flex items-center h-9 bg-muted/30 border-b border-border",children:[m.active&&t.jsxs("div",{className:"absolute left-1/2 -translate-x-1/2 top-full mt-1 flex gap-2 z-50",children:[t.jsx("button",{className:"flex items-center justify-center w-8 h-8 rounded-full text-destructive hover:bg-destructive/10",onClick:H,"data-test":"reorder-cancel",children:t.jsx(Ke,{className:"h-5 w-5"})}),t.jsx("button",{className:"flex items-center justify-center w-8 h-8 rounded-full text-primary hover:bg-primary/10",onClick:O,"data-test":"reorder-confirm",children:t.jsx(vn,{className:"h-5 w-5"})})]}),t.jsx("div",{ref:N,"data-drop-zone":Ir,className:"flex-1 flex items-center overflow-x-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},children:a.map((L,W)=>{const P=c===W&&d!==L.canvasId,j=c===W+1&&W===a.length-1&&d!==L.canvasId;return t.jsxs(He.Fragment,{children:[P&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:Q.tabBar.dropIndicator.width,opacity:Q.tabBar.dropIndicator.opacity}}),t.jsx(xu,{tab:L,isActive:L.canvasId===n,isDragging:L.canvasId===d,holdProgress:u[L.canvasId]??0,isReorderMode:m.active,isReorderTarget:m.canvasId===L.canvasId,canMoveLeft:W>0,canMoveRight:W<a.length-1,manager:w,onClose:A,onClick:b,onAuxClick:R,onMoveLeft:C,onMoveRight:I}),j&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:Q.tabBar.dropIndicator.width,opacity:Q.tabBar.dropIndicator.opacity}})]},L.canvasId)})}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:Ie("flex items-center justify-center","h-7 w-7 mx-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:k,title:"New canvas",children:t.jsx(Tt,{className:"h-4 w-4"})}),t.jsx("button",{"data-test":"floating-header-toggle-button",className:Ie("flex items-center justify-center","h-7 w-7 mr-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onPointerDown:S,title:"Toggle header",children:t.jsx(Pt,{className:"h-4 w-4"})})]})});yu.displayName="CanvasTabBar";function W0({open:e,onOpenChange:s}){const n=$(p.useCallback(g=>{var x,w;return((w=(x=g.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:w.current)??null},[])),o=$(p.useCallback(g=>{var x,w;return((w=(x=g.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:w.root)??null},[])),r=$(p.useCallback(g=>{var w,v;const x=(v=(w=g.projectCanvas.getActive())==null?void 0:w.undoTree)==null?void 0:v.nodes;return x?Object.keys(x).length:0},[])),{allNodes:a,currentNode:i,canUndo:c,canRedo:l,treeData:d}=p.useMemo(()=>{const g=T.getState();return{allNodes:g.undo.getAllNodes(),currentNode:g.undo.getCurrent(),canUndo:g.undo.canUndo(),canRedo:g.undo.canRedo(),treeData:g.undo.getTreeData()}},[n,o,r]),h=p.useCallback(()=>{T.getState().undo.undo()},[]),u=p.useCallback(()=>{T.getState().undo.redo()},[]),f=p.useCallback(g=>{T.getState().undo.jumpTo(g)},[]),m=p.useCallback(()=>{T.getState().undo.clear()},[]),y=p.useMemo(()=>{if(!d||a.length===0)return null;const g=d.root;return g?H0(a,g,(i==null?void 0:i.id)??null):null},[a,d,i]);return t.jsx(wh,{open:e,onOpenChange:s,children:t.jsxs(vh,{side:"right",className:"w-80 sm:w-96","data-test":"undo-tree-explorer",children:[t.jsx(bh,{children:t.jsxs(Nh,{className:"flex items-center gap-2",children:[t.jsx(Lr,{className:"h-5 w-5"}),"Undo History"]})}),t.jsxs("div",{className:"mt-4 space-y-4","data-test":"undo-tree-controls",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(se,{variant:"outline",size:"sm",onClick:h,disabled:!c,"data-test":"undo-button",children:[t.jsx(ba,{className:"h-4 w-4 mr-1"}),"Undo"]}),t.jsxs(se,{variant:"outline",size:"sm",onClick:u,disabled:!l,"data-test":"redo-button",children:[t.jsx(Il,{className:"h-4 w-4 mr-1"}),"Redo"]}),t.jsx(se,{variant:"ghost",size:"sm",onClick:m,disabled:a.length===0,className:"ml-auto text-muted-foreground hover:text-destructive","data-test":"clear-history-button",children:t.jsx(Nt,{className:"h-4 w-4"})})]}),t.jsxs("div",{className:"text-sm text-muted-foreground","data-test":"history-stats",children:[a.length," operations in history"]}),t.jsx(hn,{className:"h-[calc(100vh-200px)]","data-test":"undo-tree-scroll",children:y?t.jsx("div",{className:"pr-4","data-test":"undo-tree-content",children:y.map((g,x)=>t.jsx(F0,{item:g,isCurrent:g.node.id===(i==null?void 0:i.id),onJump:f,isLast:x===y.length-1},g.node.id))}):t.jsxs("div",{className:"text-center text-muted-foreground py-8","data-test":"empty-history",children:["No undo history yet.",t.jsx("br",{}),t.jsx("span",{className:"text-xs",children:"Drag nodes or resize them to start recording."})]})})]})]})})}function H0(e,s,n){const o=new Map(e.map(i=>[i.id,i])),r=[];function a(i,c,l,d,h){const u=o.get(i);u&&(r.push({node:u,depth:c,hasSiblings:h,isLastChild:d,branchIndex:l}),u.children.forEach((f,m)=>{a(f,c+1,m,m===u.children.length-1,u.children.length>1)}))}return a(s,0,0,!0,!1),r}function F0({item:e,isCurrent:s,onJump:n,isLast:o}){const{node:r,depth:a,hasSiblings:i,branchIndex:c}=e,l=p.useMemo(()=>new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[r.timestamp]);return t.jsxs("div",{className:"relative",style:{marginLeft:a*16},"data-test":"undo-tree-node",children:[a>0&&t.jsx("div",{className:Ie("absolute left-[-12px] top-0 h-full w-px bg-border",o&&"h-3")}),a>0&&t.jsx("div",{className:"absolute left-[-12px] top-3 w-3 h-px bg-border"}),i&&c>0&&t.jsx("div",{className:"absolute left-[-14px] top-2 w-2 h-2 rounded-full bg-muted-foreground/50",title:`Branch ${c+1}`}),t.jsx("button",{onClick:()=>n(r.id),className:Ie("w-full text-left px-2 py-1.5 rounded-md text-sm transition-colors","hover:bg-accent hover:text-accent-foreground",s&&"bg-primary/10 border border-primary/30 font-medium"),"data-test":"undo-tree-jump-button",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:Ie("w-2 h-2 rounded-full flex-shrink-0",s?"bg-primary":"bg-muted-foreground/30")}),t.jsx("span",{className:"truncate flex-1",children:r.label??r.operation.type}),t.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[t.jsx(vs,{className:"h-3 w-3"}),l]})]})})]})}const B0=()=>{const e=$(l=>l.uiState.holdSelectProgress),[s,n]=p.useState(0),[o,r]=p.useState(null);if(p.useEffect(()=>{const l=document.querySelector('[data-test="canvas-tab-bar"]'),d=document.querySelector('[data-test="canvas-chat-input-container"]');if(l&&d){const h=l.getBoundingClientRect(),u=d.getBoundingClientRect();r({top:h.bottom,bottom:window.innerHeight-u.top})}else r({top:Q.holdToSelect.indicatorTopOffset,bottom:Q.holdToSelect.indicatorBottomOffset})},[e]),p.useEffect(()=>{if(!e){n(0);return}let l;const d=Date.now(),h=e.durationMs,u=()=>{const f=Date.now()-d,m=Math.min(f/h,1);n(m),m<1&&e&&(l=requestAnimationFrame(u))};return l=requestAnimationFrame(u),()=>{l&&cancelAnimationFrame(l)}},[e]),!e||!o)return null;const i=e.touchX<window.innerWidth/2?"right":"left",c=s*100;return t.jsx("div",{className:Me("fixed w-0.5 z-50 pointer-events-none",i==="left"?"left-1":"right-1"),style:{top:`${o.top}px`,bottom:`${o.bottom}px`},"data-test":"hold-progress-indicator",children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center",children:[t.jsx("div",{className:"absolute w-full bg-primary rounded-full",style:{height:`${c}%`,top:`${50-c/2}%`},"data-test":"hold-progress-line"}),t.jsx("div",{className:"absolute bg-primary/30 rounded-full blur-sm",style:{height:`${c}%`,top:`${50-c/2}%`,width:"2px"},"data-test":"hold-progress-glow"}),t.jsx("div",{className:Me("absolute w-0.5 h-0.5 rounded-full bg-primary shadow-lg transition-transform duration-150",s>0?"scale-100":"scale-0"),style:{top:"50%",transform:`translateY(-50%) scale(${s>0?1:0})`},"data-test":"hold-progress-dot"})]})})},Wo=50,z0=()=>{var i;const e=$(c=>c.uiState.nodeHoldToResize),s=(i=e==null?void 0:e.edge)==null?void 0:i.includes("-");if(!e||!s||e.touchX===void 0||e.touchY===void 0)return null;const{touchX:n,touchY:o,isHolding:r,isReady:a}=e;return t.jsx("div",{className:Me("fixed rounded-full pointer-events-none","transition-all duration-150",a?"bg-emerald-500/30 shadow-[0_0_20px_10px_rgba(16,185,129,0.4)]":r?"bg-amber-500/20 shadow-[0_0_15px_8px_rgba(245,158,11,0.3)]":"bg-primary/10"),style:{width:Wo,height:Wo,left:n-Wo/2,top:o-Wo/2,zIndex:9999},"data-test":"resize-hold-indicator"})},$0=e=>[...e].sort((s,n)=>{const o=s.x-n.x;return Math.abs(o)>10?o:s.y-n.y}),_0=e=>e.length>0&&e.every(s=>s.type===fe.CHAT),U0=e=>{var m;if(e.length<2)return;const s=T.getState(),n=((m=s.projectCanvas.getActive())==null?void 0:m.coreState.nodes)??[],o=$0(e),r=o[0],a=o.slice(1),i=r.data;if(!(i!=null&&i.childNodeIds))return;const c=[],l=i.childNodeIds,d=a.map(y=>{const g=y.data;return(g==null?void 0:g.childNodeIds)??[]}),h=Math.max(l.length,...d.map(y=>y.length)),u=[],f=[];for(let y=0;y<h;y++){if(y<l.length){const g=l[y];u.push(g);const x=n.find(N=>N.id===g),w=x==null?void 0:x.data,v={...w,isIncoming:!1};f.push({id:g,data:v}),x&&c.push({type:"node:update",nodeId:g,from:{data:w},to:{data:v}})}for(const g of d)if(y<g.length){const x=g[y];u.push(x);const w=n.find(b=>b.id===x),v=w==null?void 0:w.data,N={...v,isIncoming:!0};f.push({id:x,data:N}),w&&c.push({type:"node:update",nodeId:x,from:{data:v},to:{data:N}})}}c.push({type:"node:update",nodeId:r.id,from:{data:i},to:{data:{...i,childNodeIds:u}}}),s.updateNode(r.id,{data:{...i,childNodeIds:u}}),s.updateNodes(f);for(const y of a){const g=y.data;c.push({type:"node:delete",node:{...y},connectedArrows:[]}),g&&s.updateNode(y.id,{data:{...g,childNodeIds:[]}}),s.deleteNodeById(y.id)}s.undo.commit({type:"batch",label:`Zip merge ${e.length} chat nodes`,operations:c})},wu=()=>{const e=ps(),[s,n]=p.useState(!1),[o,r]=p.useState([]);p.useEffect(()=>{if(!e)return;const h=f=>{f.selectedNodes&&f.selectedNodes.length>0&&(r(f.selectedNodes),n(!0))},u=ud.subscribe(lr.SELECTION_BOX_END,h);return()=>{u()}},[e]);const a=()=>{n(!1),r([])},i=p.useMemo(()=>_0(o),[o]),c=p.useMemo(()=>t.jsx("div",{className:"space-y-4",children:t.jsx("div",{className:"rounded-xl bg-muted/50 dark:bg-muted/30 overflow-hidden",children:t.jsxs("button",{className:"w-full flex items-center justify-between px-4 py-3 hover:bg-muted/80 dark:hover:bg-muted/50 text-left",onClick:()=>{U0(o),a()},"data-test":"marquee-action-zip",children:[t.jsx("span",{className:"font-medium",children:"Zip"}),t.jsx(_s,{className:"w-5 h-5 text-muted-foreground"})]})})}),[o]),l=p.useMemo(()=>{const h=[];return i&&o.length>=2&&h.push({id:"merge-block",items:[{id:"merge",label:"Merge",subView:{header:"Merge",content:c}}]}),h},[i,o.length,c]),d=`${o.length} node${o.length!==1?"s":""} selected`;return!e||l.length===0?null:t.jsx(mg,{isOpen:s,onOpenChange:n,header:d,blocks:l})};wu.displayName="MarqueeSelectionSheet";const vC=({width:e,height:s,className:n,style:o})=>{var N;const r=p.useRef(null),a="cursor-default",i=$(b=>b.uiState.isHoldSelectActive??!1),c=p.useRef(T.getState().setCanvasDimensions),l=p.useRef(async(b=!1,A)=>{var L,W;const R=T.getState(),k=((L=R.projectCanvas.getActive())==null?void 0:L.coreState.nodes)??[],S=((W=R.projectCanvas.getActive())==null?void 0:W.coreState.arrows)??[];let E=A;if(!E){const P=k.find(j=>{var M;return((M=j.data)==null?void 0:M.nodeType)==="workflowOrchestration"});E=(P==null?void 0:P.id)||"wf-orchestration-001"}const C=new fn;C.loadWorkflow(k,S);const I=await C.executeWorkflow(E),O=[],H=b?k.map(P=>({...P})):[];return I.nodeStates&&(I.nodeUpdates&&I.nodeUpdates.length>0&&I.nodeUpdates.forEach(P=>{const j=k.find(M=>M.id===P.nodeId);if(j){const M=Array.isArray(j.tags)?j.tags:[],B=P.updates.tags!==void 0?Array.isArray(P.updates.tags)?P.updates.tags:[]:M;if(O.push({nodeId:P.nodeId,before:{title:j.title,content:typeof j.content=="string"?j.content:void 0,tags:M},after:{title:P.updates.title!==void 0?P.updates.title:j.title,content:P.updates.content!==void 0?P.updates.content:typeof j.content=="string"?j.content:void 0,tags:B}}),b){const U=H.find(z=>z.id===P.nodeId);U&&(P.updates.title!==void 0&&(U.title=P.updates.title),P.updates.content!==void 0&&(U.content=P.updates.content),P.updates.tags!==void 0&&(U.tags=P.updates.tags))}}b||R.updateNode(P.nodeId,P.updates)}),I.nodeStates.forEach((P,j)=>{var D,V,J;const M=k.find(ie=>ie.id===j);if(!M)return;const B=(D=M.data)==null?void 0:D.nodeType,U=M.type,G=B==="workflowSource"||U==="WORKFLOW_SOURCE"||(B==="workflowOrchestration"||U==="WORKFLOW_ORCHESTRATION");let F=((V=P.executionData)==null?void 0:V.formattedOutput)||((J=P.executionData)==null?void 0:J.output)||M.content;if(F!=null&&typeof F=="object"&&(F=JSON.stringify(F,null,2)),!b){const ie={content:G?M.content:F,data:{...M.data||{},executionState:P.executionState}};R.updateNode(j,ie)}})),{...I,success:I.success,errors:I.errors||[],changes:O,previewNodes:H,currentNodes:k,arrows:S}}),[d,h]=p.useState({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null}),[u,f]=p.useState({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]});p.useEffect(()=>{const b=r.current;if(!b)return;c.current(b.offsetWidth,b.offsetHeight);const A=new ResizeObserver(R=>{for(const k of R){const{width:S,height:E}=k.contentRect;c.current(S,E)}});return A.observe(b),()=>{A.disconnect()}},[]),p.useEffect(()=>{var b;(b=r.current)==null||b.focus()},[]);const m=p.useMemo(()=>({executeWorkflow:(b,A)=>l.current(b,A),showDryRunResults:b=>{f({isVisible:!0,changes:b.changes||[],previewNodes:b.previewNodes||[],currentNodes:b.currentNodes||[],arrows:b.arrows||[],executionResult:b})},showLinkedNodesPopover:(b,A)=>{h({isVisible:!0,sourceNode:b,newlyCreatedNodeId:A||null})}}),[]),y=b=>{const{newlyCreatedNodeId:A}=d;if(A){const R=T.getState(),k=R.getNodeById(A);if(k&&typeof k.content=="string"){const E=(typeof b.content=="string"?b.content:"")+`

`+k.content;R.updateNode(b.id,{content:E}),R.deleteNodeById(A)}}},g=()=>{h({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null})},x=((N=T.getState().projectCanvas.getActive())==null?void 0:N.coreState.nodes)??[],w=$(b=>b.uiState.undoTreeExplorerOpen??!1),v=p.useCallback(b=>{T.getState().setUiState(A=>({...A,undoTreeExplorerOpen:b}))},[]);return t.jsx(Rv,{value:m,children:t.jsx(bg,{value:r,children:t.jsxs("div",{className:"flex flex-col",style:{width:e,height:s},children:[t.jsx(yu,{}),t.jsxs("div",{ref:r,id:"CanvasAppV2","data-canvas-container":!0,className:Me("relative","overflow-hidden","focus:outline-none","flex-1",a,n,i&&"ring-2 ring-inset ring-primary/50 bg-primary/5"),style:{touchAction:"none",...o},tabIndex:0,children:[t.jsx(Hm,{}),t.jsx(P0,{}),t.jsx(B0,{}),t.jsx(z0,{}),d.sourceNode&&t.jsx(D0,{sourceNode:d.sourceNode,allNodes:x,onNodeSelect:y,onClose:g,isVisible:d.isVisible}),t.jsx(O0,{isVisible:u.isVisible,changes:u.changes,previewNodes:u.previewNodes,currentNodes:u.currentNodes,arrows:u.arrows,executionResult:u.executionResult,onApply:async()=>{f({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]}),await l.current(!1)},onCancel:()=>{f({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]})}}),t.jsx(W0,{open:w,onOpenChange:v}),t.jsx(wu,{})]})]})})})};export{vC as C,js as E,wC as a,td as c,yg as s,$ as u};
