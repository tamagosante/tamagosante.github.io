const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePage-DsSf9zYb.js","assets/react-vendor-Byz07MLO.js","assets/icons-Ce2OFwrV.js","assets/recordingStorage-XzvoUejy.js","assets/utils-CsrmMPoT.js","assets/radix-ui-CdiC0DQF.js","assets/ui-utils-BxIQ3qGg.js","assets/Chat-BauGCyKu.js","assets/format-utils-CaqrGWxs.js","assets/InputWithAudio-CIk4puaN.js","assets/TTSApiClient-BzDHnur1.js","assets/systemPromptService-CiGRUnu2.js","assets/Settings-CwFLGYkJ.js","assets/Demo-896QXHuf.js","assets/Breadcrumbs-BmC_qs_6.js","assets/JsonViewerApp-BHZpouoC.js","assets/Content-ClxbLUkr.js","assets/TablePage-BtvJNRoR.js","assets/data-table-BcaOzJVU.js","assets/table-iyitXjRb.js","assets/VocabularyPage-p-6vlUtj.js","assets/definitionHelper-Dgu1Fu0f.js","assets/useVietnameseTyping-BPfr3i6U.js","assets/TextareaPopoverAtCursor-BhwkV6wH.js","assets/cursorPosition-otMhJ5rZ.js","assets/LiveTranscriptionPage-DqE8BJmB.js","assets/AudioPanelDemo-CX9_-cr7.js","assets/ClaudePage-BtaFXdyf.js","assets/SessionSidebar-DZrJ4Dp-.js","assets/tree-DcQ_KECY.js","assets/useSessionKeyboardNavigation-lTEDYtsm.js","assets/SessionDetailsPage-BcdTr3tl.js","assets/ForksPage-C7TM7v4a.js","assets/KanbanPage-QbCbEZLB.js","assets/DemoLayout-CoVvzlAo.js","assets/react-hooks-CNdHs55p.js","assets/DragDropManager-CacIWg_Z.js","assets/SFSService-CwcglacT.js","assets/KanbanDataPage-D8LHwEnc.js","assets/index-BOJcApFM.js","assets/GlobalStatePage-BG2Uu5OZ.js","assets/GamePage-BE_KYfxZ.js","assets/NewHomeApp-DV8esl5-.js","assets/CanvasAppV2-DVcrh1xW.js","assets/VimInputHandlerV2-CkxNomCQ.js","assets/logging-O1kyNMYs.js","assets/string-4WCj7OpV.js","assets/clipboardHtmlToMarkdown-BNZmEbgs.js","assets/VimInputHandlerV2-BfpIuMTm.css","assets/UiButtonWithExpandOption-B7V__5JV.js","assets/DraggableCrudTree-DERsg6bO.js","assets/treeHelpers-DUv_6quS.js","assets/globalFacadeRegistry-BlelMPVg.js","assets/WorkflowRowItem-ZekMpZ5R.js","assets/UiDataTable-CjbthiFV.js","assets/markdownToHtml-C-4HvgxL.js","assets/DraggableTree-Ccu8jD7S.js","assets/useOcr-DpY88bL9.js","assets/alert-DO2xCAYp.js","assets/context-menu-DLQswWDd.js","assets/easy-form-DbOekutc.js","assets/forms-B7OAPNGv.js","assets/form-BCVeNYNh.js","assets/SlashCommandMenu-CxSbmk5Q.js","assets/MobileLogViewer-B3JD0kxm.js","assets/userStoreLocalStorage-D-7v21rP.js","assets/userCanvasStateStorage-BQhrJ7tu.js","assets/SttPage-0uJFXoaV.js"])))=>i.map(i=>d[i]);
var su=Object.defineProperty;var nu=(s,e,t)=>e in s?su(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var Z=(s,e,t)=>nu(s,typeof e!="symbol"?e+"":e,t);import{r as h,j as a,e as ru,f as lo,d as yi,k as Na,b as au,R as ou,l as iu,B as cu}from"./react-vendor-Byz07MLO.js";import{B as lu,m as uo,d as du,t as ke,_ as mt,z as uu,T as pu}from"./utils-CsrmMPoT.js";import{p as Rs,t as Si,O as tr,d as ka,C as cn,s as Ea,v as sr,D as nr,R as ji,w as hu,x as Ci,y as fu,z as mu,A as gu,B as xu,E as vu,F as bu,H as wu,J as yu,K as Su,M as ju,N as Ni,Q as ki,U as Ei,V as Cu,W as Nu,X as ku,Y as Eu,Z as Ii,$ as Iu,a0 as Tu,a1 as Ti,a2 as Au,a3 as Ai,a4 as Pu,a5 as Ru,a6 as Pi,a7 as Ri,a8 as Di,a9 as _i,aa as Oi,ab as Du,ac as _u,ad as Ou,ae as Lu,af as Li,ag as Mi,ah as Fi,ai as $i,aj as Ui,ak as Bi,al as Mu,am as Wi,an as zi,ao as Hi,ap as Gi,aq as Fu,ar as $u,as as Uu,at as qi,au as Bu,av as Wu,aw as Vi,ax as zu,ay as Hu,az as Ki,aA as Ji,aB as Yi,aC as Xi,aD as Qi,aE as Gu}from"./radix-ui-CdiC0DQF.js";import{t as qu,a as qs,c as ln}from"./ui-utils-BxIQ3qGg.js";import{X as ht,bN as Vu,bO as po,bP as Ku,y as Vt,M as Lr,G as ts,bw as Ju,bp as Yu,N as rr,bQ as Zi,bR as Xu,bb as ec,aJ as Qu,bu as Mr,b as Zu,bS as Fr,bT as $r,bU as Ur,az as Br,h as Wr,ad as zr,V as Ds,O as $t,a2 as Ks,F as Js,bj as ep,bk as tp,bV as sp,bW as np,ai as rp,ab as tc,ae as ap,bm as op,bX as ip,D as Ia,T as Et,bY as cp,a as sc,a1 as Ta,aL as Aa,bZ as Pa,g as wt,C as ct,f as ar,$ as lp,S as Nn,q as nc,bt as dp,ap as up,b0 as br,c as kn,l as On,W as Ys,a3 as or,b_ as rc,bA as pp,b7 as hp,ao as ac,d as ir,P as fp,aa as Xs,b$ as mp,c0 as gp,e as Ra,K as xp,w as Fs,E as Hr,i as ho,bl as Ln,aU as Gr,c1 as vp,as as Qs,c2 as bp,bg as wp,a5 as yp,a$ as qr,c3 as Sp,aZ as jp,c4 as Cp,aF as fo,aG as mo,j as go,bB as xo,c5 as Np,c6 as kp,ar as oc,Y as Ep}from"./icons-Ce2OFwrV.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const ps=class ps{constructor(){Z(this,"logs",[]);Z(this,"counter",0);Z(this,"maxLogs",100);Z(this,"listeners",[]);Z(this,"isCollecting",!1);Z(this,"collectedLogs",[]);Z(this,"originalConsole",{log:console.log,warn:console.warn,error:console.error,debug:console.debug})}static getInstance(){return ps.instance||(ps.instance=new ps),ps.instance}log(e,t="info",n){const r=new Date().toLocaleTimeString(),o={id:`log-${this.counter++}`,timestamp:r,message:e,level:t,service:n},i=t==="error"?console.error:t==="warning"?console.warn:t==="debug"?console.debug:console.log,c=n?`[${n}] `:"",l=`[${r}] ${c}${e}`;i(l),this.isCollecting&&this.collectedLogs.push(l),this.logs=[o,...this.logs.slice(0,this.maxLogs-1)],this.notifyListeners()}info(e,t){this.log(e,"info",t)}error(e,t){this.log(e,"error",t)}warning(e,t){this.log(e,"warning",t)}debug(e,t){this.log(e,"debug",t)}getLogs(){return this.logs}clear(){this.logs=[],this.notifyListeners()}export(){return this.logs.slice().reverse().map(e=>{const t=e.service?`[${e.service}] `:"";return`[${e.timestamp}] ${e.level.toUpperCase()}: ${t}${e.message}`}).join(`
`)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}collectLogs(e=!0){this.isCollecting=!0,this.collectedLogs=[],e&&typeof window<"u"&&this.interceptConsole(),console.log("ðŸ“ Log collection started. Call window.printCollectedLogs() to retrieve.")}interceptConsole(){const e=this;console.log=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(n),e.originalConsole.log.apply(console,t)},console.warn=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`WARN: ${n}`),e.originalConsole.warn.apply(console,t)},console.error=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`ERROR: ${n}`),e.originalConsole.error.apply(console,t)},console.debug=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`DEBUG: ${n}`),e.originalConsole.debug.apply(console,t)}}restoreConsole(){console.log=this.originalConsole.log,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,console.debug=this.originalConsole.debug}stopCollecting(){this.isCollecting=!1,this.restoreConsole();const e=this.collectedLogs.join(`
`);return console.log("ðŸ›‘ Log collection stopped."),e}getCollectedLogs(){return this.collectedLogs.join(`
`)}clearCollectedLogs(){this.collectedLogs=[]}};Z(ps,"instance");let Vr=ps;const Re=Vr.getInstance();typeof window<"u"&&(window.getCollectedLogs=()=>Re.getCollectedLogs(),window.printCollectedLogs=()=>{const s=Re.getCollectedLogs();return console.log(`ðŸ“‹ Collected logs:
`+s),s},window.startCollectingLogs=()=>Re.collectLogs(),window.stopCollectingLogs=()=>Re.stopCollecting(),window.clearCollectedLogs=()=>Re.clearCollectedLogs());const ic=()=>{const[s,e]=h.useState(()=>Re.getLogs());h.useEffect(()=>Re.subscribe(r=>{e(r)}),[]);const t=h.useRef();return t.current||(t.current={log:(n,r,o)=>Re.log(n,r,o),info:(n,r)=>Re.info(n,r),error:(n,r)=>Re.error(n,r),warning:(n,r)=>Re.warning(n,r),debug:(n,r)=>Re.debug(n,r),clear:()=>Re.clear(),export:()=>Re.export()}),{logs:s,actions:t.current}};class Ip{constructor(e="http://localhost:3333"){Z(this,"baseUrl");Z(this,"eventSource",null);this.baseUrl=e}async getProjects(e){const t=new URLSearchParams;(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const n=`${this.baseUrl}/claude/projects${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch projects: ${r.statusText}`);return await r.json()}catch(r){throw console.error("[ClaudeAPI.getProjects] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,timestamp:new Date().toISOString()}),r}}async getProjectDetails(e){const t=`${this.baseUrl}/claude/projects/${encodeURIComponent(e)}`,n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch project details: ${n.statusText}`);return n.json()}async getSessions(e){const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.excludeAgents&&t.append("excludeAgents","true");const n=`${this.baseUrl}/claude/sessions-v2${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch sessions: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getSessions] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,errorStack:r instanceof Error?r.stack:void 0,timestamp:new Date().toISOString()}),r}}async searchSessions(e,t){const n=new URLSearchParams;e&&(t!=null&&t.messageTypes&&t.messageTypes.length>0?n.append("messageContent",e):n.append("q",e)),t!=null&&t.fields&&t.fields.length>0&&!(t!=null&&t.messageTypes&&t.messageTypes.length>0)&&n.append("fields",t.fields.join(",")),(t==null?void 0:t.isActive)!==void 0&&n.append("isActive",t.isActive.toString()),(t==null?void 0:t.minMessages)!==void 0&&n.append("minMessages",t.minMessages.toString()),(t==null?void 0:t.maxMessages)!==void 0&&n.append("maxMessages",t.maxMessages.toString()),t!=null&&t.modifiedAfter&&n.append("modifiedAfter",t.modifiedAfter),t!=null&&t.modifiedBefore&&n.append("modifiedBefore",t.modifiedBefore),t!=null&&t.messageTypes&&t.messageTypes.length>0&&n.append("messageTypes",t.messageTypes.join(",")),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/sessions/search${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to search sessions: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.searchSessions] Fetch error:",{url:r,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,errorStack:o instanceof Error?o.stack:void 0,timestamp:new Date().toISOString()}),o}}async searchSessionMessages(e,t,n){const r=new URLSearchParams;t&&r.append("content",t),n!=null&&n.messageType&&n.messageType.length>0?r.append("messageType",n.messageType.join(",")):n!=null&&n.role&&r.append("role",n.role),n!=null&&n.after&&r.append("after",n.after),n!=null&&n.before&&r.append("before",n.before),n!=null&&n.sortOrder&&r.append("sortOrder",n.sortOrder),(n==null?void 0:n.page)!==void 0&&r.append("page",n.page.toString()),(n==null?void 0:n.pageSize)!==void 0&&r.append("pageSize",n.pageSize.toString());const o=`${this.baseUrl}/claude/sessions/${e}/search${r.toString()?`?${r.toString()}`:""}`,i=await fetch(o);if(!i.ok)throw new Error(`Failed to search session messages: ${i.statusText}`);return i.json()}async searchMessages(e,t){const n=new URLSearchParams;e&&n.append("q",e),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageTypes",t.messageType.join(",")),t!=null&&t.after&&n.append("after",t.after),t!=null&&t.before&&n.append("before",t.before),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/messages/search${n.toString()?`?${n.toString()}`:""}`,o=await fetch(r);if(!o.ok)throw new Error(`Failed to search messages: ${o.statusText}`);return o.json()}async getSessionDetails(e,t){const n=new URLSearchParams;(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageType",t.messageType.join(","));const r=`${this.baseUrl}/claude/sessions-v2/${e}${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch session details: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionDetails] Fetch error:",{url:r,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,timestamp:new Date().toISOString()}),o}}async sendMessage(e){const t=await fetch(`${this.baseUrl}/claude/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to send message: ${t.statusText}`);return t.json()}async createSession(e={}){const t=await fetch(`${this.baseUrl}/claude/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to create session: ${t.statusText}`);return t.json()}async updateSessionName(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customName:t})});if(!n.ok)throw new Error(`Failed to update session name: ${n.statusText}`);return n.json()}async updateSessionStatus(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Failed to update session status: ${n.statusText}`);return n.json()}async forkSession(e,t){const n=`${this.baseUrl}/claude/sessions/${e}/fork`;try{const r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to create fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.forkSession] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForks(e){const t=new URLSearchParams;e!=null&&e.parentSessionId&&t.append("parentSessionId",e.parentSessionId),e!=null&&e.sessionId&&t.append("sessionId",e.sessionId),(e==null?void 0:e.favoritesOnly)!==void 0&&t.append("favoritesOnly",e.favoritesOnly.toString()),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.sortBy&&t.append("sortBy",e.sortBy),e!=null&&e.sortOrder&&t.append("sortOrder",e.sortOrder);const n=`${this.baseUrl}/claude/forks${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch forks: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getForks] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForkDetails(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch fork details: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getForkDetails] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async updateFork(e,t){const n=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const r=await fetch(n,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to update fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.updateFork] Fetch error:",{url:n,forkId:e,updates:t,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async deleteFork(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t,{method:"DELETE"});if(!n.ok)throw new Error(`Failed to delete fork: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.deleteFork] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async getSessionForks(e,t){const n=new URLSearchParams;(t==null?void 0:t.favoritesOnly)!==void 0&&n.append("favoritesOnly",t.favoritesOnly.toString()),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder);const r=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/forks${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch session forks: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionForks] Fetch error:",{url:r,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()}),o}}async getForkTree(e,t){const n=new URLSearchParams;t!=null&&t.includeMessages&&n.append("includeMessages","true"),t!=null&&t.messageTypes&&n.append("messageTypes",t.messageTypes),(t==null?void 0:t.messageLimit)!==void 0&&n.append("messageLimit",t.messageLimit.toString());const r=n.toString(),o=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/fork-tree${r?`?${r}`:""}`;try{const i=await fetch(o);if(!i.ok)throw new Error(`Failed to fetch fork tree: ${i.statusText}`);return i.json()}catch(i){throw console.error("[ClaudeAPI.getForkTree] Fetch error:",{url:o,sessionId:e,options:t,error:i,errorMessage:i instanceof Error?i.message:"Unknown error",timestamp:new Date().toISOString()}),i}}subscribeToSessionChanges(e,t){const n=`${this.baseUrl}/claude/sessions/events`;return this.eventSource=new EventSource(n),this.eventSource.onopen=()=>{var r;console.log("[ClaudeAPI.subscribeToSessionChanges] SSE connection opened:",{url:n,readyState:(r=this.eventSource)==null?void 0:r.readyState,timestamp:new Date().toISOString()})},this.eventSource.onmessage=r=>{try{const o=JSON.parse(r.data);o.type!=="connected"&&e(o)}catch(o){console.error("[ClaudeAPI.subscribeToSessionChanges] Failed to parse SSE event:",{error:o,eventData:r.data,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=r=>{var o,i,c,l;console.error("[ClaudeAPI.subscribeToSessionChanges] SSE connection error:",{error:r,readyState:(o=this.eventSource)==null?void 0:o.readyState,readyStateText:((i=this.eventSource)==null?void 0:i.readyState)===0?"CONNECTING":((c=this.eventSource)==null?void 0:c.readyState)===1?"OPEN":((l=this.eventSource)==null?void 0:l.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),t&&t(r)},()=>{var r;(r=this.eventSource)==null||r.close(),this.eventSource=null}}}const Ye=new Ip;class Tp{constructor(e="http://localhost:3333"){Z(this,"eventSource",null);Z(this,"eventHandlers",new Set);Z(this,"errorHandlers",new Set);Z(this,"baseUrl");Z(this,"reconnectAttempts",0);Z(this,"maxReconnectAttempts",5);Z(this,"reconnectDelay",1e3);this.baseUrl=e}subscribe(e,t){return this.eventHandlers.add(e),t&&this.errorHandlers.add(t),this.eventHandlers.size===1&&!this.eventSource&&this.connect(),()=>{this.eventHandlers.delete(e),t&&this.errorHandlers.delete(t),this.eventHandlers.size===0&&this.disconnect()}}connect(){const e=`${this.baseUrl}/claude/sessions/events`;this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.reconnectAttempts=0},this.eventSource.onmessage=t=>{try{const n=JSON.parse(t.data);if(n.type==="connected")return;this.eventHandlers.forEach(r=>{try{r(n)}catch(o){console.error("[ClaudeSSEManager] Error in event handler:",{error:o,eventType:n.type,timestamp:new Date().toISOString()})}})}catch(n){console.error("[ClaudeSSEManager] Failed to parse SSE event:",{error:n,eventData:t.data,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=t=>{var n,r,o,i;if(console.error("[ClaudeSSEManager] SSE connection error:",{error:t,readyState:(n=this.eventSource)==null?void 0:n.readyState,readyStateText:((r=this.eventSource)==null?void 0:r.readyState)===0?"CONNECTING":((o=this.eventSource)==null?void 0:o.readyState)===1?"OPEN":((i=this.eventSource)==null?void 0:i.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),this.errorHandlers.forEach(c=>{try{c(t)}catch(l){console.error("[ClaudeSSEManager] Error in error handler:",l)}}),this.eventHandlers.size>0&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const c=this.reconnectDelay*this.reconnectAttempts;setTimeout(()=>{this.eventHandlers.size>0&&(this.disconnect(),this.connect())},c)}}}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null,this.reconnectAttempts=0)}getConnectionState(){var e;return((e=this.eventSource)==null?void 0:e.readyState)??null}getSubscriberCount(){return this.eventHandlers.size}}const Ap=new Tp;function Da(s,e,t=!0){const n=h.useRef(s),r=h.useRef(e);h.useEffect(()=>{n.current=s},[s]),h.useEffect(()=>{r.current=e},[e]);const o=h.useCallback(l=>{n.current(l)},[]),i=h.useCallback(l=>{var d;(d=r.current)==null||d.call(r,l)},[]),c=h.useRef(!!e);h.useEffect(()=>{c.current=!!e},[e]),h.useEffect(()=>{if(!t)return;const l=Ap.subscribe(o,c.current?i:void 0);return()=>{l()}},[t,o,i])}function cc(s,e){const t={...s};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n],o=t[n];r&&typeof r=="object"&&!Array.isArray(r)&&o&&typeof o=="object"&&!Array.isArray(o)?t[n]=cc(o,r):t[n]=r}return t}class Pp{constructor(e={}){Z(this,"STORAGE_KEY","global-store");Z(this,"state$");const t=this.loadFromStorage();this.state$=new lu({...e,...t})}getState(){return this.state$.value}getState$(){return this.state$.asObservable()}get(e){return this.state$.value[e]}select(e){return this.state$.pipe(uo(t=>t[e]),du())}selectSlice(e){return this.state$.pipe(uo(e))}setState(e){this.state$.next(e),this.saveToStorage()}updateState(e){const t={...this.state$.value,...e};this.state$.next(t),this.saveToStorage()}set(e,t){this.updateState({[e]:t})}update(e,t){const n=this.state$.value[e],r=typeof n=="object"&&n!==null&&typeof t=="object"&&t!==null?cc(n,t):t;this.set(e,r)}remove(e){const t={...this.state$.value};delete t[e],this.state$.next(t),this.saveToStorage()}reset(){this.state$.next({}),this.clearStorage()}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load global store from localStorage:",e),{}}}saveToStorage(){try{const e=this.getStateToPersist(this.state$.value);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save global store to localStorage:",e)}}getStateToPersist(e){var n,r;const t={...e};if(t.ui&&(t.ui={...t.ui,directoryMaps:void 0}),(n=t.app)!=null&&n.claude){const o=t.app.claude;t.app={...t.app,claude:{...o,data:void 0,forks:void 0,ui:o.ui?{...o.ui,isInitialized:void 0,loadingSessions:void 0,sessionsError:void 0,projectsInitialized:void 0,loadingProjects:void 0,projectsError:void 0,activity:void 0}:void 0}}}if((r=t.app)!=null&&r.kanban){const o=t.app.kanban;t.app={...t.app,kanban:{...o,loading:void 0,error:void 0}}}return t}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear global store from localStorage:",e)}}export(){return JSON.stringify(this.state$.value,null,2)}import(e){try{const t=JSON.parse(e);return this.setState(t),!0}catch(t){return console.error("Failed to import global store data:",t),!1}}}const ie=new Pp;function Le(s){const[e,t]=h.useState(()=>s(ie.getState()));return h.useEffect(()=>{const n=ie.selectSlice(s).subscribe(t);return()=>n.unsubscribe()},[s]),e}function _a(){return{get:ie.get.bind(ie),set:ie.set.bind(ie),update:ie.update.bind(ie),updateState:ie.updateState.bind(ie),remove:ie.remove.bind(ie),reset:ie.reset.bind(ie),getState:ie.getState.bind(ie)}}const Rp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},Dp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1},_p=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.sessionsError)??null},Op=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.pagination)??null},Lp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.currentPage)??1},Mp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.isInitialized)??!1},Fp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.excludeAgents)??!1};function $p(s={}){const{loadOnMount:e=!0,subscribeToSSE:t=!0}=s,{update:n,getState:r}=_a(),o=h.useRef(!1),i=Le(Rp),c=Le(Dp),l=Le(_p),d=Le(Op),p=Le(Lp),u=Le(Mp),f=Le(Fp),m=async(S=1,C=!1)=>{var N,A,k,E,R,M;try{const L=(N=r().app)==null?void 0:N.claude;n("app",{claude:{ui:{...L==null?void 0:L.ui,loadingSessions:!0,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1}}});const T=((A=L==null?void 0:L.ui)==null?void 0:A.excludeAgents)??!1,W=await Ye.getSessions({page:S,pageSize:20,excludeAgents:T}),z=[...W.sessions].sort((ee,I)=>new Date(I.lastModified).getTime()-new Date(ee.lastModified).getTime()),te=((k=L==null?void 0:L.data)==null?void 0:k.sessions)??[],O=C?[...te,...z]:z;n("app",{claude:{data:{sessions:O,pagination:W.pagination||null},ui:{loadingSessions:!1,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}})}catch(L){console.error("[SessionLoader] API request failed:",{error:L,errorMessage:L instanceof Error?L.message:"Unknown error",page:S,append:C,timestamp:new Date().toISOString()}),Re.error(`Session load failed: ${L instanceof Error?L.message:"Unknown error"}`,"SessionLoader"),n("app",{claude:{data:{sessions:C?((M=(R=(E=r().app)==null?void 0:E.claude)==null?void 0:R.data)==null?void 0:M.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:L instanceof Error?L.message:"Failed to load sessions",currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}}),Re.error("Store updated with error state","SessionLoader")}},g=async(S,C,N=!1)=>{var A,k,E,R,M;try{const L=(A=r().app)==null?void 0:A.claude;n("app",{claude:{ui:{...L==null?void 0:L.ui,loadingSessions:!0,sessionsError:null,searchQuery:S,searchFilters:C,isSearchActive:!0}}});const T=await Ye.searchSessions(S,C),W=((k=L==null?void 0:L.data)==null?void 0:k.sessions)??[],z=N?[...W,...T.results]:T.results;n("app",{claude:{data:{sessions:z,pagination:T.pagination},ui:{loadingSessions:!1,sessionsError:null,currentPage:T.pagination.page,searchQuery:S,searchFilters:C,isSearchActive:!0}}})}catch(L){console.error("[SessionLoader] API request failed:",{error:L,errorMessage:L instanceof Error?L.message:"Unknown error",query:S,filters:C,append:N,timestamp:new Date().toISOString()}),n("app",{claude:{data:{sessions:N?((M=(R=(E=r().app)==null?void 0:E.claude)==null?void 0:R.data)==null?void 0:M.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:L instanceof Error?L.message:"Failed to search sessions",currentPage:1,searchQuery:S,searchFilters:C,isSearchActive:!0}}})}},x=(S,C)=>{var R,M,L;const N=((L=(M=(R=r().app)==null?void 0:R.claude)==null?void 0:M.data)==null?void 0:L.sessions)??[],A=N.findIndex(T=>T.id===S);if(A===-1)return;const k=[...N];k[A]={...k[A],...C};const E=k.sort((T,W)=>new Date(W.lastModified).getTime()-new Date(T.lastModified).getTime());n("app",{claude:{data:{sessions:E},ui:{loadingSessions:!1,sessionsError:null}}})},b=S=>{var A,k,E;const N=(((E=(k=(A=r().app)==null?void 0:A.claude)==null?void 0:k.data)==null?void 0:E.sessions)??[]).filter(R=>R.id!==S);n("app",{claude:{data:{sessions:N},ui:{loadingSessions:!1,sessionsError:null}}})},v=S=>{var N,A;const C=(A=(N=r().app)==null?void 0:N.claude)==null?void 0:A.ui;if(C!=null&&C.isSearchActive&&(C==null?void 0:C.searchQuery)!==void 0){const k={...C.searchFilters,page:S};g(C.searchQuery,k)}else m(S)},w=()=>{var S,C;if(d&&p<d.totalPages){const N=(C=(S=r().app)==null?void 0:S.claude)==null?void 0:C.ui;if(N!=null&&N.isSearchActive&&(N==null?void 0:N.searchQuery)!==void 0){const A={...N.searchFilters,page:p+1};g(N.searchQuery,A,!0)}else m(p+1,!0)}},y=()=>{m(1)},j=()=>{var N,A;const S=(N=r().app)==null?void 0:N.claude,C=!((A=S==null?void 0:S.ui)!=null&&A.excludeAgents);n("app",{claude:{ui:{...S==null?void 0:S.ui,excludeAgents:C}}}),m(1)};return h.useEffect(()=>{e&&(u||o.current||(o.current=!0,m(1)))},[u]),Da(S=>{S.type==="created"&&m(p),S.type==="modified"&&S.sessionId&&(async()=>{try{const C=await Ye.getSessionDetails(S.sessionId);x(S.sessionId,{name:C.name,lastModified:C.metadata.lastModified,messageCount:C.metadata.messageCount})}catch(C){console.error("[SSE] Failed to fetch modified session:",{sessionId:S.sessionId,error:C,timestamp:new Date().toISOString()})}})(),S.type==="batch-modified"&&S.sessionIds&&m(p),S.type==="deleted"&&S.sessionId&&b(S.sessionId),S.type==="session-input-received"&&S.sessionId&&(async()=>{var C,N,A;try{const k=await Ye.getSessionDetails(S.sessionId),E=(N=(C=k.messages)==null?void 0:C[k.messages.length-1])==null?void 0:N.content,R=typeof E=="string"?E:Array.isArray(E)?(A=E.find(M=>typeof M=="object"&&M!==null&&"type"in M&&M.type==="text"))==null?void 0:A.text:E==null?void 0:E.text;x(S.sessionId,{name:k.name,lastModified:k.metadata.lastModified,messageCount:k.metadata.messageCount,latestMessage:R})}catch(k){console.error("[SSE] Failed to fetch session after input received:",{sessionId:S.sessionId,error:k,timestamp:new Date().toISOString()})}})()},S=>{console.error("[SSE] Connection error:",{error:S,errorMessage:S instanceof Error?S.message:"Unknown error",timestamp:new Date().toISOString()})},t),{sessions:i,loadingSessions:c,sessionsError:l,pagination:d,currentPage:p,isInitialized:u,excludeAgents:f,loadSessions:m,searchSessions:g,refreshSessions:y,handlePageChange:v,handleLoadMore:w,toggleExcludeAgents:j}}const Up=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},Bp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},Wp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},zp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsInitialized)??!1};function Hp(s={}){const{loadOnMount:e=!0}=s,{update:t,getState:n}=_a(),r=h.useRef(!1),o=Le(Up),i=Le(Bp),c=Le(Wp),l=Le(zp),d=async()=>{var u,f,m;try{const g=n(),x=(u=g.app)==null?void 0:u.claude;t("app",{...g.app,claude:{...x,data:{...x==null?void 0:x.data},ui:{...x==null?void 0:x.ui,loadingProjects:!0,projectsError:null}}});const b=await Ye.getProjects({pageSize:100}),v=n(),w=(f=v.app)==null?void 0:f.claude;t("app",{...v.app,claude:{...w,data:{...w==null?void 0:w.data,projects:b.projects},ui:{...w==null?void 0:w.ui,loadingProjects:!1,projectsError:null,projectsInitialized:!0}}})}catch(g){console.error("[ProjectsLoader] API request failed:",{error:g,errorMessage:g instanceof Error?g.message:"Unknown error",timestamp:new Date().toISOString()}),Re.error(`Projects load failed: ${g instanceof Error?g.message:"Unknown error"}`,"ProjectsLoader");const x=n(),b=(m=x.app)==null?void 0:m.claude;t("app",{...x.app,claude:{...b,data:{...b==null?void 0:b.data,projects:[]},ui:{...b==null?void 0:b.ui,loadingProjects:!1,projectsError:g instanceof Error?g.message:"Failed to load projects",projectsInitialized:!0}}}),Re.error("Store updated with error state","ProjectsLoader")}},p=()=>{d()};return h.useEffect(()=>{e&&(l||r.current||(r.current=!0,d()))},[l,e]),{projects:o,loadingProjects:i,projectsError:c,projectsInitialized:l,loadProjects:d,refreshProjects:p}}function Gp(){const[s,e]=h.useState(new Set),t=h.useCallback(n=>n?s.has(n):!1,[s]);return Da(n=>{var o,i,c,l,d,p,u,f,m,g,x,b,v,w,y;if(n.type==="batch-modified")return;const r=n.sessionId;if(r){if(n.type==="session-started"&&e(j=>{const S=new Set(j);return S.add(r),S}),n.type==="session-ended"&&e(j=>{const S=new Set(j);return S.delete(r),S}),n.type==="session-opened"){const j=((c=(i=(o=ie.get("app"))==null?void 0:o.claude)==null?void 0:i.ui)==null?void 0:c.activity)??{},S={...j,[r]:{...j[r],isOpened:!0}};ie.update("app",{claude:{ui:{activity:S}}}),e(C=>{const N=new Set(C);return N.add(r),N})}if(n.type==="session-closed"){const j=((p=(d=(l=ie.get("app"))==null?void 0:l.claude)==null?void 0:d.ui)==null?void 0:p.activity)??{},S=((u=j[r])==null?void 0:u.isOpened)===!0||((f=j[r])==null?void 0:f.isProcessing)===!0,C={...j,[r]:{...j[r],isOpened:!!S,isProcessing:!1}};ie.update("app",{claude:{ui:{activity:C}}}),S||e(N=>{const A=new Set(N);return A.delete(r),A}),console.log("[useSessionRunningStatus] Session closed, keeping as opened:",S)}if(n.type==="session-processing-started"){const j=((x=(g=(m=ie.get("app"))==null?void 0:m.claude)==null?void 0:g.ui)==null?void 0:x.activity)??{},S={...j,[r]:{...j[r],isProcessing:!0,isOpened:!0}};ie.update("app",{claude:{ui:{activity:S}}}),e(C=>{const N=new Set(C);return N.add(r),N})}if(n.type==="session-processing-stopped"){const j=((w=(v=(b=ie.get("app"))==null?void 0:b.claude)==null?void 0:v.ui)==null?void 0:w.activity)??{},S={...j,[r]:{...j[r],isProcessing:!1}};ie.update("app",{claude:{ui:{activity:S}}}),(((y=S[r])==null?void 0:y.isOpened)??!1)||e(N=>{const A=new Set(N);return A.delete(r),A})}}},n=>{console.error("[useSessionRunningStatus] SSE connection error:",n)}),{isSessionRunning:t,runningSessions:s}}const wr=768,yr=500;function bs(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=window.matchMedia(`(max-width: ${wr-1}px)`),n=()=>{e(window.innerWidth<wr)};return t.addEventListener("change",n),e(window.innerWidth<wr),()=>t.removeEventListener("change",n)},[]),!!s}function Jj(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=()=>{const r=window.innerWidth<yr,o=window.innerHeight<yr&&window.innerWidth<window.innerHeight*2;e(r||o)},n=window.matchMedia(`(max-width: ${yr-1}px)`);return n.addEventListener("change",t),window.addEventListener("orientationchange",t),t(),()=>{n.removeEventListener("change",t),window.removeEventListener("orientationchange",t)}},[]),!!s}function U(...s){return qu(qs(s))}const qp={default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},Vp=ln("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive cursor-pointer",{variants:{variant:qp,size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",compact:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-1.2",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",smIcon:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 [&_svg:not([class*='size-'])]:size-3",smIconCompact:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",sic:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),ue=h.forwardRef(({className:s,variant:e,size:t,asChild:n=!1,...r},o)=>{const i=n?Rs:"button";return a.jsx(i,{"data-slot":"button",className:U(Vp({variant:e,size:t,className:s})),ref:o,...r})});ue.displayName="Button";const We=h.forwardRef(({className:s,type:e,...t},n)=>a.jsx("input",{type:e,className:U("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:n,...t}));We.displayName="Input";const lc=h.forwardRef(({className:s,orientation:e="horizontal",decorative:t=!0,...n},r)=>a.jsx(Si,{ref:r,decorative:t,orientation:e,className:U("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...n}));lc.displayName=Si.displayName;const Kp=ji,Jp=ka,dc=h.forwardRef(({className:s,...e},t)=>a.jsx(tr,{className:U("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...e,ref:t}));dc.displayName=tr.displayName;const Yp=ln("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),uc=h.forwardRef(({side:s="right",className:e,children:t,...n},r)=>a.jsxs(Jp,{children:[a.jsx(dc,{}),a.jsxs(cn,{ref:r,className:U(Yp({side:s}),e),...n,children:[a.jsxs(Ea,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[a.jsx(ht,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]}),t]})]}));uc.displayName=cn.displayName;const pc=({className:s,...e})=>a.jsx("div",{className:U("flex flex-col space-y-2 text-center sm:text-left",s),...e});pc.displayName="SheetHeader";const hc=h.forwardRef(({className:s,...e},t)=>a.jsx(sr,{ref:t,className:U("text-lg font-semibold text-foreground",s),...e}));hc.displayName=sr.displayName;const fc=h.forwardRef(({className:s,...e},t)=>a.jsx(nr,{ref:t,className:U("text-sm text-muted-foreground",s),...e}));fc.displayName=nr.displayName;function vo({className:s,...e}){return a.jsx("div",{className:U("animate-pulse rounded-md bg-primary/10",s),...e})}const Fe={xs:"w-3 h-3",sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},Yj={deleteButton:"text-red-600 hover:text-red-700 hover:bg-red-50"},Xj={input:"bg-green-500",process:"bg-blue-500",output:"bg-red-500",text:"bg-blue-500",select:"bg-purple-500",audio:"bg-green-500",default:"bg-gray-500"},Qj={base:"absolute w-4 h-4 bg-background rounded-full border-2 border-border transform -translate-y-1/2 cursor-crosshair z-10",input:"node-handle node-handle-input -left-2 top-1/2",output:"node-handle node-handle-output -right-2 top-1/2",hover:"hover:border-blue-400 hover:bg-accent",active:"border-blue-400 bg-accent"},Xp={input:"w-full p-2 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background",textarea:"w-full p-3 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring resize-y bg-background",label:"text-xs font-medium text-foreground block mb-1",error:"text-destructive text-xs mt-1"},Zj=.2,tt={popover:1500,skipLink:1600,tooltip:1800,backdrop:1550,draggablePopover:1560,slashCommandMenu:1565,draggablePopoverDropdown:1570,canvasGroups:1,canvasArrows:5,canvasNodes:10,canvasResizeHandles:15,nodeTextarea:10,nodeAudioButton:20,nodeQuickPanel:40,canvasChatInput:50,canvasOverlay:55,quickPanelPortal:1020,toolbarDropdown:1510,commandPalette:1750},ss=fu,ns=mu,rs=gu,Kt=h.forwardRef(({className:s,sideOffset:e=4,style:t,...n},r)=>a.jsx(hu,{children:a.jsx(Ci,{ref:r,sideOffset:e,className:U("overflow-hidden rounded-md border bg-card px-3 py-1.5 text-xs text-card-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",s),style:{zIndex:tt.tooltip,...t},...n})}));Kt.displayName=Ci.displayName;class Qp{constructor(){Z(this,"STORAGE_KEY","ui-store")}getStore(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to parse UI store from localStorage:",e),{}}}setStore(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save UI store to localStorage:",t)}}get(e){return this.getStore()[e]}set(e,t){const n=this.getStore();n[e]=t,this.setStore(n)}update(e,t){const n=this.getStore(),r=n[e]||{};n[e]={...r,...t},this.setStore(n)}remove(e){const t=this.getStore();delete t[e],this.setStore(t)}clear(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear UI store:",e)}}getAllData(){return this.getStore()}export(){return JSON.stringify(this.getStore(),null,2)}import(e){try{const t=JSON.parse(e);return this.setStore(t),!0}catch(t){return console.error("Failed to import UI store data:",t),!1}}}const Kr=new Qp,Zp="16rem",eh="18rem",th="3rem",sh="b",mc=h.createContext(null);function _s(){const s=h.useContext(mc);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const gc=h.forwardRef(({defaultOpen:s=!0,open:e,onOpenChange:t,className:n,style:r,children:o,...i},c)=>{const l=bs(),[d,p]=h.useState(!1),[u,f]=h.useState(()=>{const w=Kr.get("sidebar");return(w==null?void 0:w.isOpen)??s}),m=e??u,g=h.useCallback(w=>{const y=typeof w=="function"?w(m):w;t?t(y):f(y),Kr.update("sidebar",{isOpen:y})},[t,m]),x=h.useCallback(()=>l?p(w=>!w):g(w=>!w),[l,g,p]);h.useEffect(()=>{const w=y=>{y.key===sh&&(y.metaKey||y.ctrlKey)&&(y.preventDefault(),x())};return window.addEventListener("keydown",w),()=>window.removeEventListener("keydown",w)},[x]);const b=m?"expanded":"collapsed",v=h.useMemo(()=>({state:b,open:m,setOpen:g,isMobile:l,openMobile:d,setOpenMobile:p,toggleSidebar:x}),[b,m,g,l,d,p,x]);return a.jsx(mc.Provider,{value:v,children:a.jsx(ss,{delayDuration:0,children:a.jsx("div",{style:{"--sidebar-width":Zp,"--sidebar-width-icon":th,...r},className:U("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",n),ref:c,...i,children:o})})})});gc.displayName="SidebarProvider";const xc=h.forwardRef(({side:s="left",variant:e="sidebar",collapsible:t="offcanvas",className:n,children:r,...o},i)=>{h.useEffect(()=>{Kr.update("sidebar",{side:s,variant:e})},[s,e]);const{isMobile:c,state:l,openMobile:d,setOpenMobile:p,toggleSidebar:u}=_s();return t==="none"?a.jsx("div",{className:U("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",n),ref:i,...o,children:r}):c?a.jsx(Kp,{open:d,onOpenChange:p,...o,children:a.jsxs(uc,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":eh},side:s,children:[a.jsxs(pc,{className:"sr-only",children:[a.jsx(hc,{children:"Sidebar"}),a.jsx(fc,{children:"Displays the mobile sidebar."})]}),a.jsx("div",{className:"flex h-full w-full flex-col",children:r})]})}):a.jsxs("div",{ref:i,className:"group peer hidden text-sidebar-foreground md:block","data-state":l,"data-collapsible":l==="collapsed"?t:"","data-variant":e,"data-side":s,children:[a.jsx("div",{className:U("relative bg-transparent transition-[width] duration-200 ease-linear",e==="floating"?"w-0":"w-[--sidebar-width]","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",e==="floating"||e==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),l==="expanded"&&t==="offcanvas"&&a.jsx("div",{className:"fixed inset-0 z-[55] bg-black/50",onClick:u}),a.jsx("div",{className:U("fixed inset-y-0 z-[60] hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",e==="floating"||e==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",n),...o,children:a.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:r})})]})});xc.displayName="Sidebar";const Jr=h.forwardRef(({className:s,onClick:e,...t},n)=>{const{toggleSidebar:r}=_s();return a.jsxs(ue,{ref:n,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:U("h-7 w-7",s),onClick:o=>{e==null||e(o),r()},...t,children:[a.jsx(Vu,{}),a.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});Jr.displayName="SidebarTrigger";const nh=h.forwardRef(({className:s,...e},t)=>{const{toggleSidebar:n}=_s();return a.jsx("button",{ref:t,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:n,title:"Toggle Sidebar",className:U("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...e})});nh.displayName="SidebarRail";const vc=h.forwardRef(({className:s,...e},t)=>a.jsx("main",{ref:t,className:U("relative flex w-full flex-1 flex-col bg-background","md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow","peer-data-[collapsible=offcanvas]:ml-0 peer-data-[collapsible=offcanvas]:mr-0","peer-data-[variant=floating]:ml-0 peer-data-[variant=floating]:mr-0",s),...e}));vc.displayName="SidebarInset";const rh=h.forwardRef(({className:s,...e},t)=>a.jsx(We,{ref:t,"data-sidebar":"input",className:U("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...e}));rh.displayName="SidebarInput";const bc=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"header",className:U("flex flex-col gap-2 p-2",s),...e}));bc.displayName="SidebarHeader";const ah=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"footer",className:U("flex flex-col gap-2 p-2",s),...e}));ah.displayName="SidebarFooter";const oh=h.forwardRef(({className:s,...e},t)=>a.jsx(lc,{ref:t,"data-sidebar":"separator",className:U("mx-2 w-auto bg-sidebar-border",s),...e}));oh.displayName="SidebarSeparator";const wc=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"content",className:U("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...e}));wc.displayName="SidebarContent";const ih=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"group",className:U("relative flex w-full min-w-0 flex-col p-2",s),...e}));ih.displayName="SidebarGroup";const ch=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?Rs:"div";return a.jsx(r,{ref:n,"data-sidebar":"group-label",className:U("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...t})});ch.displayName="SidebarGroupLabel";const lh=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?Rs:"button";return a.jsx(r,{ref:n,"data-sidebar":"group-action",className:U("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...t})});lh.displayName="SidebarGroupAction";const dh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"group-content",className:U("w-full text-sm",s),...e}));dh.displayName="SidebarGroupContent";const yc=h.forwardRef(({className:s,...e},t)=>a.jsx("ul",{ref:t,"data-sidebar":"menu",className:U("flex w-full min-w-0 flex-col gap-1",s),...e}));yc.displayName="SidebarMenu";const Ws=h.forwardRef(({className:s,...e},t)=>a.jsx("li",{ref:t,"data-sidebar":"menu-item",className:U("group/menu-item relative",s),...e}));Ws.displayName="SidebarMenuItem";const uh=ln("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),zs=h.forwardRef(({asChild:s=!1,isActive:e=!1,variant:t="default",size:n="default",tooltip:r,className:o,...i},c)=>{const l=s?Rs:"button",{isMobile:d,state:p}=_s(),u=a.jsx(l,{ref:c,"data-sidebar":"menu-button","data-size":n,"data-active":e,className:U(uh({variant:t,size:n}),o),...i});return r?(typeof r=="string"&&(r={children:r}),a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:u}),a.jsx(Kt,{side:"right",align:"center",hidden:p!=="collapsed"||d,...r})]})):u});zs.displayName="SidebarMenuButton";const ph=h.forwardRef(({className:s,asChild:e=!1,showOnHover:t=!1,...n},r)=>{const o=e?Rs:"button";return a.jsx(o,{ref:r,"data-sidebar":"menu-action",className:U("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",t&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...n})});ph.displayName="SidebarMenuAction";const hh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"menu-badge",className:U("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...e}));hh.displayName="SidebarMenuBadge";const fh=h.forwardRef(({className:s,showIcon:e=!1,...t},n)=>{const r=h.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return a.jsxs("div",{ref:n,"data-sidebar":"menu-skeleton",className:U("flex h-8 items-center gap-2 rounded-md px-2",s),...t,children:[e&&a.jsx(vo,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),a.jsx(vo,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":r}})]})});fh.displayName="SidebarMenuSkeleton";const Yr=h.forwardRef(({className:s,...e},t)=>a.jsx("ul",{ref:t,"data-sidebar":"menu-sub",className:U("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...e}));Yr.displayName="SidebarMenuSub";const En=h.forwardRef(({...s},e)=>a.jsx("li",{ref:e,...s}));En.displayName="SidebarMenuSubItem";const In=h.forwardRef(({asChild:s=!1,size:e="md",isActive:t,className:n,...r},o)=>{const i=s?Rs:"a";return a.jsx(i,{ref:o,"data-sidebar":"menu-sub-button","data-size":e,"data-active":t,className:U("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",e==="sm"&&"text-xs",e==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",n),...r})});In.displayName="SidebarMenuSubButton";const mh="audio-chunks-db",gh=1,St="chunks",Qe="metadata";class xh{constructor(){Z(this,"dbPromise");Z(this,"initializationPromise");this.dbPromise=this.initDB(),this.initializationPromise=this.waitForDB()}async waitForDB(){await this.dbPromise}async waitForInitialization(){await this.initializationPromise}async initDB(){return new Promise((e,t)=>{const n=indexedDB.open(mh,gh);n.onupgradeneeded=r=>{const o=r.target.result;if(o.objectStoreNames.contains(St)||o.createObjectStore(St),!o.objectStoreNames.contains(Qe)){const i=o.createObjectStore(Qe);i.createIndex("sessionName","sessionName",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1}),i.createIndex("chunkNumber","chunkNumber",{unique:!1})}},n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{t(new Error(`IndexedDB error: ${r.target.error}`))}})}async saveChunk(e,t){var n;if(await this.waitForInitialization(),!e.blob)throw new Error("Cannot save chunk without blob data");try{const o=(await this.dbPromise).transaction([Qe,St],"readwrite"),i=o.objectStore(Qe),c=o.objectStore(St),l={id:e.id,chunkNumber:e.chunkNumber,startTime:e.startTime.toISOString(),endTime:(n=e.endTime)==null?void 0:n.toISOString(),duration:e.duration,size:e.size??e.blob.size,name:e.name,sessionName:t,transcription:e.transcription,transcriptionStatus:e.transcriptionStatus,transcriptionError:e.transcriptionError,createdAt:new Date().toISOString(),mimeType:e.blob.type};i.put(l,e.id),c.put(e.blob,e.id),await new Promise((d,p)=>{o.oncomplete=()=>d(),o.onerror=()=>p(new Error(`Transaction failed: ${o.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to save chunk:",r),r}}async loadChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Qe,St],"readonly"),r=n.objectStore(Qe),o=n.objectStore(St),c=r.index("sessionName").getAll(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to load metadata: ${c.error}`))});if(l.length===0)return[];const d=[];for(const p of l)try{const u=o.get(p.id),f=await new Promise((m,g)=>{u.onsuccess=()=>m(u.result),u.onerror=()=>g(new Error(`Failed to load blob: ${u.error}`))});if(f){const m={id:p.id,chunkNumber:p.chunkNumber,startTime:new Date(p.startTime),endTime:p.endTime?new Date(p.endTime):void 0,duration:p.duration,blob:f,size:p.size,name:p.name,transcription:p.transcription,transcriptionStatus:p.transcriptionStatus,transcriptionError:p.transcriptionError};d.push(m)}}catch(u){console.warn(`ðŸŽ¤ðŸ“¦ðŸ’¾ âš ï¸ Failed to load chunk ${p.id}:`,u)}return d.sort((p,u)=>p.chunkNumber-u.chunkNumber),d}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to load chunks:",t),t}}async updateChunkTranscription(e,t){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Qe],"readwrite"),o=r.objectStore(Qe),i=o.get(e),c=await new Promise((d,p)=>{i.onsuccess=()=>d(i.result),i.onerror=()=>p(new Error(`Failed to get metadata: ${i.error}`))});if(!c)throw new Error(`Chunk not found: ${e}`);const l={...c,transcription:t,transcriptionStatus:"completed"};o.put(l,e),await new Promise((d,p)=>{r.oncomplete=()=>d(),r.onerror=()=>p(new Error(`Transaction failed: ${r.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription:",n),n}}async updateChunkTranscriptionStatus(e,t,n){await this.waitForInitialization();try{const o=(await this.dbPromise).transaction([Qe],"readwrite"),i=o.objectStore(Qe),c=i.get(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to get metadata: ${c.error}`))});if(!l)throw new Error(`Chunk not found: ${e}`);const d={...l,transcriptionStatus:t,transcriptionError:n};i.put(d,e),await new Promise((p,u)=>{o.oncomplete=()=>p(),o.onerror=()=>u(new Error(`Transaction failed: ${o.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription status:",r),r}}async deleteChunk(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Qe,St],"readwrite"),r=n.objectStore(Qe),o=n.objectStore(St);r.delete(e),o.delete(e),await new Promise((i,c)=>{n.oncomplete=()=>i(),n.onerror=()=>c(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunk:",t),t}}async deleteChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Qe,St],"readwrite"),r=n.objectStore(Qe),o=n.objectStore(St),c=r.index("sessionName").getAll(e),l=await new Promise((d,p)=>{c.onsuccess=()=>d(c.result),c.onerror=()=>p(new Error(`Failed to load metadata: ${c.error}`))});for(const d of l)r.delete(d.id),o.delete(d.id);await new Promise((d,p)=>{n.oncomplete=()=>d(),n.onerror=()=>p(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunks by session:",t),t}}async getAllSessions(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Qe],"readonly").objectStore(Qe).getAll(),o=await new Promise((c,l)=>{r.onsuccess=()=>c(r.result),r.onerror=()=>l(new Error(`Failed to load all metadata: ${r.error}`))});return[...new Set(o.map(c=>c.sessionName))].sort()}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get all sessions:",e),e}}async getStorageStats(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Qe],"readonly").objectStore(Qe).getAll(),o=await new Promise((l,d)=>{r.onsuccess=()=>l(r.result),r.onerror=()=>d(new Error(`Failed to load all metadata: ${r.error}`))}),i=o.reduce((l,d)=>l+d.size,0),c=new Set(o.map(l=>l.sessionName)).size;return{totalChunks:o.length,totalSize:i,sessionCount:c}}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get storage stats:",e),e}}async clearAllData(){await this.waitForInitialization();try{const t=(await this.dbPromise).transaction([Qe,St],"readwrite"),n=t.objectStore(Qe),r=t.objectStore(St);n.clear(),r.clear(),await new Promise((o,i)=>{t.oncomplete=()=>o(),t.onerror=()=>i(new Error(`Transaction failed: ${t.error}`))})}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to clear all data:",e),e}}}const bt=new xh,Sr="vocabulary-lists",Bt="default";class vh{getAllLists(){try{const e=localStorage.getItem(Sr);return e?JSON.parse(e).map(n=>({...n,createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt)})):[this.createDefaultList()]}catch(e){return console.error("Failed to load vocabulary lists:",e),[this.createDefaultList()]}}getListById(e){return this.getAllLists().find(n=>n.id===e)??null}createList(e){const t=this.getAllLists(),n={id:`list-${Date.now()}`,name:e,createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}updateList(e,t){const n=this.getAllLists(),r=n.findIndex(o=>o.id===e);return r===-1?null:(n[r]={...n[r],...t,updatedAt:new Date},this.saveLists(n),n[r])}async deleteList(e){const t=this.getAllLists();if(t.length<=1)return console.warn("Cannot delete the last vocabulary list"),!1;if(e===Bt){const r=t.find(o=>o.id===Bt);if(r&&r.entryCount>0&&t.length===1)return console.warn("Cannot delete default list with data when it's the only list"),!1}const n=t.filter(r=>r.id!==e);return this.saveLists(n),localStorage.removeItem(`vocabulary-entries-${e}`),await bt.deleteChunksBySession(`vocabulary-session-${e}`),!0}getDefaultListId(){return this.getAllLists().find(n=>n.id===Bt)||this.createDefaultList(),Bt}updateEntryCount(e,t){this.updateList(e,{entryCount:t})}migrateOldData(){const e="vocabulary-entries",t=localStorage.getItem(e);if(!t)return!1;try{this.getAllLists().find(c=>c.id===Bt)??(r=this.createDefaultList());const o=`vocabulary-entries-${Bt}`;if(!localStorage.getItem(o)){localStorage.setItem(o,t);const c=JSON.parse(t);return this.updateEntryCount(Bt,c.length),localStorage.removeItem(e),console.log("Migrated old vocabulary data to default list"),!0}return localStorage.removeItem(e),!1}catch(n){return console.error("Failed to migrate vocabulary data:",n),!1}}createDefaultList(){const e=localStorage.getItem(Sr);let t=[];if(e)try{t=JSON.parse(e).map(i=>({...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}));const o=t.find(i=>i.id===Bt);if(o)return o}catch(r){console.error("Error parsing stored lists:",r),t=[]}const n={id:Bt,name:"Default",createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}saveLists(e){localStorage.setItem(Sr,JSON.stringify(e))}}const jr=new vh,bo=xu,wo=bu,yo=vu,bh="modulepreload",wh=function(s){return"/"+s},So={},qe=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let i=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=i(t.map(d=>{if(d=wh(d),d in So)return;So[d]=!0;const p=d.endsWith(".css"),u=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":bh,p||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),p)return new Promise((m,g)=>{f.addEventListener("load",m),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})},Cr=h.lazy(()=>qe(()=>import("./HomePage-DsSf9zYb.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>({default:s.HomePage}))),yh=h.lazy(()=>qe(()=>import("./Chat-BauGCyKu.js"),__vite__mapDeps([7,1,8,9,2,10,4,5,11,6])).then(s=>({default:s.Chat}))),Sh=h.lazy(()=>qe(()=>import("./Settings-CwFLGYkJ.js"),__vite__mapDeps([12,1,8,2,4,5,6])).then(s=>({default:s.Settings}))),jo=h.lazy(()=>qe(()=>import("./Demo-896QXHuf.js"),__vite__mapDeps([13,1,14,5,2,15,4,6])).then(s=>({default:s.Demo}))),Co=h.lazy(()=>qe(()=>import("./Content-ClxbLUkr.js"),__vite__mapDeps([16,1,8,2,4,5,6])).then(s=>({default:s.Content}))),jh=h.lazy(()=>qe(()=>import("./TablePage-BtvJNRoR.js"),__vite__mapDeps([17,1,18,19,4,5,6,2])).then(s=>({default:s.TablePage}))),No=h.lazy(()=>qe(()=>import("./VocabularyPage-p-6vlUtj.js"),__vite__mapDeps([20,1,18,19,21,22,23,24,2,4,5,6])).then(s=>({default:s.VocabularyPage}))),Ch=h.lazy(()=>qe(()=>import("./LiveTranscriptionPage-DqE8BJmB.js"),__vite__mapDeps([25,1,2,4,5,6])).then(s=>({default:s.LiveTranscriptionPage}))),Nh=h.lazy(()=>qe(()=>import("./AudioPanelDemo-CX9_-cr7.js"),__vite__mapDeps([26,1,4,5,6,2])).then(s=>({default:s.AudioPanelDemo}))),kh=h.lazy(()=>qe(()=>import("./ClaudePage-BtaFXdyf.js"),__vite__mapDeps([27,1,28,29,2,4,5,6,30])).then(s=>({default:s.ClaudePage}))),Eh=h.lazy(()=>qe(()=>import("./SessionDetailsPage-BcdTr3tl.js"),__vite__mapDeps([31,1,4,5,28,29,2,6,30])).then(s=>({default:s.SessionDetailsPage}))),Ih=h.lazy(()=>qe(()=>import("./ForksPage-C7TM7v4a.js"),__vite__mapDeps([32,1,4,5,2,29,6])).then(s=>({default:s.ForksPage}))),Nr=h.lazy(()=>qe(()=>import("./KanbanPage-QbCbEZLB.js"),__vite__mapDeps([33,1,34,14,5,2,35,36,4,37,6])).then(s=>({default:s.KanbanPage}))),Th=h.lazy(()=>qe(()=>import("./KanbanDataPage-D8LHwEnc.js"),__vite__mapDeps([38,1,15,14,5,2,4,6])).then(s=>({default:s.KanbanDataPage}))),Ah=h.lazy(()=>qe(()=>import("./index-BOJcApFM.js"),__vite__mapDeps([39,1,2,4,5,6])).then(s=>({default:s.ActionTodoPage}))),Ph=h.lazy(()=>qe(()=>import("./GlobalStatePage-BG2Uu5OZ.js"),__vite__mapDeps([40,1,15,4,5,2,6])).then(s=>({default:s.GlobalStatePage}))),Rh=h.lazy(()=>qe(()=>import("./GamePage-BE_KYfxZ.js"),__vite__mapDeps([41,1,2,4,5,6])).then(s=>({default:s.GamePage}))),Dh=h.lazy(()=>qe(()=>import("./NewHomeApp-DV8esl5-.js"),__vite__mapDeps([42,1,6,4,5,2,43,44,45,46,47,48,49,23,24,21,50,36,51,52,53,54,35,55,56,57,58,15,59,60,61,62,28,29,63,64,65,66])).then(s=>({default:s.NewHomeApp}))),_h=h.lazy(()=>qe(()=>import("./SttPage-0uJFXoaV.js"),__vite__mapDeps([67,1,4,5,6,2])).then(s=>({default:s.SttPage})));function Oh(){return a.jsx("div",{className:"page-loader flex items-center justify-center h-full",children:a.jsx("div",{className:"page-loader-spinner animate-pulse text-muted-foreground",children:"Loading..."})})}const Mn=[{path:"/",element:Cr,title:"Watcher",icon:po,label:"Home",showInSidebar:!0},{path:"/new-home",element:Dh,title:"New Home",icon:po,label:"New Home",showInSidebar:!0},{path:"/chat",element:yh,title:"Chat with Ollama",icon:Ku,label:"Chat",showInSidebar:!0},{path:"/settings",element:Sh,title:"Settings",icon:Vt,label:"Settings",showInSidebar:!0},{path:"/claude",element:kh,title:"Claude",icon:Lr,label:"Claude",showInSidebar:!0},{path:"/claude/:sessionId",element:Eh,title:"Claude",showInSidebar:!1},{path:"/claude/forks/:forkId?",element:Ih,title:"Session Forks",icon:ts,label:"Forks",showInSidebar:!1},{path:"/state",element:Ph,title:"Global State",icon:Ju,label:"Global State",showInSidebar:!0},{path:"/game",element:Rh,title:"Multiplayer Games",icon:Yu,label:"Games",showInSidebar:!0},{path:"/stt",element:_h,title:"Speech to Text",icon:rr,label:"STT",showInSidebar:!0},{path:"/todo",element:Nr,title:"Todo",icon:Mr,label:"Todo",showInSidebar:!0,group:"collapsible",children:[{path:"/todo",element:Nr,title:"Todo",icon:Zi,label:"Overview",showInSidebar:!0},{path:"/todo/kanban",element:Nr,title:"Kanban Board",icon:Xu,label:"Kanban Board",showInSidebar:!0},{path:"/todo/kanban/data",element:Th,title:"Kanban Data",icon:ec,label:"Data",showInSidebar:!0},{path:"/todo/action",element:Ah,title:"Action Todo",icon:Qu,label:"Action-Driven",showInSidebar:!0}]},{path:"/content",element:Co,title:"Content",icon:Zu,label:"Content",showInSidebar:!0},{path:"/content/:contentId",element:Co,title:"Content",showInSidebar:!1},{path:"/active-recording",element:Cr,title:"Active Recording",icon:Fr,label:"Active Recording",showInSidebar:!0},{path:"/vocabulary",element:No,title:"Vocabulary",icon:$r,label:"Vocabulary",showInSidebar:!0,group:"collapsible-vocabulary"},{path:"/vocabulary/:listId",element:No,title:"Vocabulary",showInSidebar:!1},{path:"/live-transcription",element:Ch,title:"Live Transcription",icon:Ur,label:"Live Transcription",showInSidebar:!0},{path:"/table",element:jh,title:"Table Demo",icon:Br,label:"Table Demo",showInSidebar:!0},{path:"/demo",element:jo,title:"Demo",icon:Wr,label:"Demo",showInSidebar:!0},{path:"/demo/*",element:jo,title:"Demo",showInSidebar:!1},{path:"/demo/audio-panel",element:Nh,title:"Audio Panel Demo",icon:zr,label:"Audio Panel Demo",showInSidebar:!0},{path:"/realtime",element:Cr,title:"Real-time Audio",showInSidebar:!1}];function Lh(s){const e=Mn.find(t=>t.children&&t.children.find(r=>r.path===s)?!0:t.path===s);if(e){if(e.children){const t=e.children.find(n=>n.path===s);if(t)return t.title}return e.title}for(const t of Mn){if(s.startsWith(t.path.split("/:")[0]))return t.title;if(t.children){for(const n of t.children)if(s.startsWith(n.path.split("/:")[0]))return n.title}}return"Watcher"}function Mh({logger:s,logs:e}){return a.jsx(h.Suspense,{fallback:a.jsx(Oh,{}),children:a.jsx(ru,{children:Mn.map(t=>{const n=t.element,r=a.jsx(n,{logger:s,logs:e});return t.children?t.children.map(o=>{const i=o.element;return a.jsx(lo,{path:o.path,element:a.jsx(i,{logger:s})},o.path)}):a.jsx(lo,{path:t.path,element:r},t.path)})})})}function Fh(){const{open:s,toggleSidebar:e}=_s();return a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h2",{className:"text-lg font-semibold px-2",children:"Menu"}),s&&a.jsx(ue,{variant:"ghost",size:"icon",onClick:e,className:"h-7 w-7",children:a.jsx(Ds,{className:"w-4 h-4"})})]})}function $h(){const s=yi(),e=Na(),{isMobile:t,setOpen:n,setOpenMobile:r}=_s(),{actions:o}=ic(),[i,c]=h.useState([]),[l,d]=h.useState(!1),[p,u]=h.useState(!1);h.useEffect(()=>{const x=jr.getAllLists();c(x)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/vocabulary")&&d(!0)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/todo")&&u(!0)},[e.pathname]);const f=h.useCallback((x,b)=>{x.ctrlKey||x.metaKey||x.button===1||(x.preventDefault(),s(b),t?r(!1):n(!1))},[s,t,n,r]),m=h.useCallback(async()=>{try{o.info("Fetching logs from /logs endpoint...");const b=await(await fetch("/logs")).json();console.log("Logs response:",b),o.info("Logs endpoint response logged to console")}catch(x){o.error(`Failed to fetch logs: ${x}`),console.error("Failed to fetch logs:",x)}t?r(!1):n(!1)},[o,t,n,r]),g=h.useCallback(()=>{const x=prompt("Enter a name for the new vocabulary list:");if(x!=null&&x.trim()){const b=jr.createList(x.trim());c(jr.getAllLists()),s(`/vocabulary/${b.id}`),t?r(!1):n(!1)}},[s,t,n,r]);return a.jsxs(yc,{children:[Mn.filter(x=>x.showInSidebar).map(x=>x.group==="collapsible"&&x.children?a.jsx(bo,{open:p,onOpenChange:u,className:"group/collapsible",children:a.jsxs(Ws,{children:[a.jsx(wo,{asChild:!0,children:a.jsxs(zs,{children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label,a.jsx($t,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),a.jsx(yo,{children:a.jsx(Yr,{children:x.children.filter(b=>b.showInSidebar).map(b=>a.jsx(En,{children:a.jsx(In,{asChild:!0,isActive:e.pathname===b.path,children:a.jsxs("a",{href:b.path,onClick:v=>f(v,b.path),children:[b.icon&&a.jsx(b.icon,{className:"w-4 h-4"}),b.label]})})},b.path))})})]})},x.path):x.group==="collapsible-vocabulary"?a.jsx(bo,{open:l,onOpenChange:d,className:"group/collapsible",children:a.jsxs(Ws,{children:[a.jsx(wo,{asChild:!0,children:a.jsxs(zs,{children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label,a.jsx($t,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),a.jsx(yo,{children:a.jsxs(Yr,{children:[i.map(b=>a.jsx(En,{children:a.jsx(In,{asChild:!0,isActive:e.pathname===`/vocabulary/${b.id}`,children:a.jsxs("a",{href:`/vocabulary/${b.id}`,onClick:v=>f(v,`/vocabulary/${b.id}`),children:[b.name,b.entryCount>0&&a.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:b.entryCount})]})})},b.id)),a.jsx(En,{children:a.jsxs(In,{onClick:g,children:[a.jsx(Ks,{className:"w-4 h-4"}),"Create New List"]})})]})})]})},x.path):a.jsx(Ws,{children:a.jsx(zs,{asChild:!0,isActive:e.pathname===x.path,children:a.jsxs("a",{href:x.path,onClick:b=>f(b,x.path),children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label]})})},x.path)),a.jsx(Ws,{children:a.jsxs(zs,{onClick:m,children:[a.jsx(Js,{className:"w-4 h-4"}),"Logs"]})})]})}function Uh(){return a.jsxs(xc,{variant:"floating",collapsible:"offcanvas",children:[a.jsx(bc,{children:a.jsx(Fh,{})}),a.jsx(wc,{children:a.jsx($h,{})})]})}const Xr=s=>{if(s==null)return s;if(typeof s=="number")return Math.round(s*10)/10;if(Array.isArray(s))return s.map(Xr);if(typeof s=="object"){const e={};for(const[t,n]of Object.entries(s))e[t]=Xr(n);return e}return s};class Oa{constructor(e="http://localhost:3030/client-logs",t=5e3,n=!1){Z(this,"baseUrl");Z(this,"timeout");Z(this,"sessionId");Z(this,"shouldLogToConsole");this.baseUrl=e,this.timeout=t,this.shouldLogToConsole=n,this.sessionId=`todo-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async sendLogs(e,t,n){const r=t?Xr(t):void 0;this.shouldLogToConsole&&console.log(`[${n||"client.log"}] ${e}`,r?JSON.stringify(r,null,2):"");try{const o={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),customLogFile:n,logs:{[e]:[`${e}`]},metadata:r},i=await this.fetchWithTimeout(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw console.error("[ClientLogs] HTTP error:",i.status),new Error(`HTTP ${i.status}`);return await i.json()}catch(o){return console.error("[ClientLogs] Failed to send:",o),null}}sendBeacon(e,t){console.log("[ClientLogs] Sending beacon:",{message:e,metadata:t});try{const n={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),logs:{[e]:[`${e}`]},metadata:t};if(typeof navigator<"u"&&navigator.sendBeacon){const r=this.baseUrl.startsWith("http")?this.baseUrl:`${window.location.origin}${this.baseUrl}`,o=new Blob([JSON.stringify(n)],{type:"application/json"}),i=navigator.sendBeacon(r,o);return i?console.log("[ClientLogs] Beacon accepted"):console.warn("[ClientLogs] Beacon rejected (queue full?)"),i}else return console.log("[ClientLogs] sendBeacon not available, using fetch fallback"),fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),keepalive:!0}).catch(r=>{console.error("[ClientLogs] Fetch fallback failed:",r)}),!0}catch(n){return console.error("[ClientLogs] Failed to send beacon:",n),!1}}async clearLogs(e="client.log",t){if(t&&typeof window<"u"&&!window.location.pathname.includes(t))return!1;try{const n=`${this.baseUrl}?customLogFile=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?(await r.json()).success:(console.error("[ClientLogs] Failed to clear logs:",r.status),!1)}catch(n){return console.error("[ClientLogs] Failed to clear logs:",n),!1}}async clearJsonLogs(e){try{const n=`${this.baseUrl.replace("/client-logs","/client-logs-json")}?filename=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?!0:(console.error("[ClientLogs] Failed to clear JSON logs:",r.status),!1)}catch(t){return console.error("[ClientLogs] Failed to clear JSON logs:",t),!1}}async clearLogsAndAddVersion(e,t,n){const r=await this.clearLogs(e,n);return r&&await this.sendLogs("startup",{v:t},e),r}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}new Oa;const Bh={theme:"system",setTheme:()=>null},Sc=h.createContext(Bh);function Wh({children:s,defaultTheme:e="system",storageKey:t="vite-ui-theme",...n}){const[r,o]=h.useState(()=>localStorage.getItem(t)||e);h.useEffect(()=>{const c=window.document.documentElement;if(c.classList.remove("light","dark"),r==="system"){const l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";c.classList.add(l);return}c.classList.add(r)},[r]);const i={theme:r,setTheme:c=>{localStorage.setItem(t,c),o(c)}};return a.jsx(Sc.Provider,{...n,value:i,children:s})}const zh=()=>{const s=h.useContext(Sc);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s};function Hh(){const{theme:s,setTheme:e}=zh(),t=()=>{e(s==="dark"?"light":"dark")},n=s==="dark"||s==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return a.jsx(ue,{onClick:t,variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","aria-label":n?"Switch to light mode":"Switch to dark mode",children:n?a.jsx(ep,{className:"h-5 w-5"}):a.jsx(tp,{className:"h-5 w-5"})})}const st=wu,ut=yu,Tn=Su,Xe=h.forwardRef(({className:s,align:e="center",sideOffset:t=4,style:n,...r},o)=>a.jsx(ju,{children:a.jsx(Ni,{ref:o,align:e,sideOffset:t,style:{zIndex:tt.popover,...n},className:U("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...r})}));Xe.displayName=Ni.displayName;function Gh(s){return"initialConfig"in s&&typeof s.children=="function"}function dn(s){if(Gh(s)){const{storageKey:m,initialConfig:g,children:x,prefix:b="watcher-"}=s,v=`${b}${m}`,[w,y]=h.useState(()=>{try{const N=localStorage.getItem(v);if(N)return JSON.parse(N)}catch(N){console.error(`Failed to load config from localStorage (${v}):`,N)}return g}),[j,S]=h.useState(!1);h.useEffect(()=>{try{localStorage.setItem(v,JSON.stringify(w))}catch(N){console.error(`Failed to save config to localStorage (${v}):`,N)}},[w,v]);const C=h.useMemo(()=>({buttonLabel:N,icon:A=a.jsx(Vt,{className:"h-4 w-4"}),variant:k="ghost",size:E="icon",buttonClassName:R="",contentClassName:M="",contentStyle:L,align:T="end",side:W="bottom",title:z,children:te})=>a.jsxs(st,{open:j,onOpenChange:S,"data-test":"config-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:k,size:E,className:`config-button ${R}`,title:z||"Configuration","data-test":"config-button",children:N?a.jsxs(a.Fragment,{children:[A,N&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:N})]}):A})}),a.jsxs(Xe,{className:`config-panel ${M}`,style:{zIndex:tt.draggablePopoverDropdown,...L},align:T,side:W,"data-test":"config-panel",onInteractOutside:O=>{O.target.closest(".config-panel")&&O.preventDefault()},onPointerDownOutside:O=>{O.target.closest(".config-panel")&&O.preventDefault()},children:[z&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:z})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:te})]})]}),[j,S]);return a.jsx(a.Fragment,{children:x(w,y,C)})}const{children:e,buttonLabel:t,icon:n=a.jsx(Vt,{className:"h-4 w-4"}),variant:r="ghost",size:o="icon",buttonClassName:i="",contentClassName:c="",align:l="end",side:d="bottom",title:p}=s,[u,f]=h.useState(!1);return a.jsxs(st,{open:u,onOpenChange:f,"data-test":"config-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:r,size:o,className:`config-button ${i}`,title:p||"Configuration","data-test":"config-button",children:t?a.jsxs(a.Fragment,{children:[n,t&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:t})]}):n})}),a.jsxs(Xe,{className:`config-panel ${c}`,style:{zIndex:tt.draggablePopoverDropdown},align:l,side:d,"data-test":"config-panel",onInteractOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},onPointerDownOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},children:[p&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:p})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:e})]})]})}const qh=ln("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),Se=h.forwardRef(({className:s,...e},t)=>a.jsx(ki,{ref:t,className:U(qh(),s),...e}));Se.displayName=ki.displayName;const Ot=h.forwardRef(({className:s,...e},t)=>a.jsx(Ei,{className:U("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",s),...e,ref:t,children:a.jsx(Cu,{className:U("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));Ot.displayName=Ei.displayName;const Vh=()=>{const s=h.useRef(null),[e,t]=h.useState(!1),[n,r]=h.useState(!1),[o,i]=h.useState(null),c=()=>{try{const p=ie.export(),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=`global-state-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(f),ke.success("Global state exported successfully")}catch(p){console.error("Error exporting state:",p),ke.error("Failed to export global state")}},l=()=>{var p;(p=s.current)==null||p.click()},d=p=>{var m;const u=(m=p.target.files)==null?void 0:m[0];if(!u)return;t(!0),i(null);const f=new FileReader;f.onload=g=>{var b;const x=(b=g.target)==null?void 0:b.result;if(typeof x=="string")try{n&&ie.reset(),ie.import(x)?(i({success:!0}),ke.success("Global state imported successfully")):(i({success:!1,error:"Invalid JSON format"}),ke.error("Failed to import: invalid JSON format"))}catch(v){console.error("Error importing state:",v);const w=v instanceof Error?v.message:"Unknown error";i({success:!1,error:w}),ke.error(`Failed to import: ${w}`)}else console.error("Failed to read file content."),ke.error("Failed to read file content"),i({success:!1,error:"Failed to read file"});t(!1),s.current&&(s.current.value="")},f.onerror=g=>{console.error("Error reading file:",g),ke.error("Error reading file"),i({success:!1,error:"Error reading file"}),t(!1),s.current&&(s.current.value="")},f.readAsText(u)};return a.jsxs("div",{className:"space-y-4","data-test":"global-state-io-panel",children:[a.jsxs("div",{"data-test":"global-state-export-section",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Export"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download global state as JSON"}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:c,className:"w-full","data-test":"global-state-export-button",children:[a.jsx(sp,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),a.jsxs("div",{"data-test":"global-state-import-section",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Import"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import global state from a JSON file"}),a.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"global-state-replace-mode-control",children:[a.jsxs("div",{children:[a.jsx(Se,{htmlFor:"global-state-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),a.jsx(Ot,{id:"global-state-replace-mode",checked:n,onCheckedChange:r,disabled:e,"data-test":"global-state-replace-mode-switch"})]}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:l,disabled:e,className:"w-full","data-test":"global-state-import-select-file-button",children:[a.jsx(np,{className:"h-4 w-4 mr-2"}),e?"Importing...":"Select File"]}),a.jsx("input",{type:"file",ref:s,accept:".json",style:{display:"none"},onChange:d,"data-test":"global-state-import-file-input"})]}),o&&a.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"global-state-import-result",children:[o.success&&a.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"global-state-import-success",children:[a.jsx(rp,{className:"h-3 w-3"}),a.jsx("span",{children:"Import successful"})]}),!o.success&&a.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"global-state-import-error",children:[a.jsx(tc,{className:"h-3 w-3"}),a.jsx("span",{children:o.error||"Import failed"})]})]})]})},Kh=()=>a.jsx(dn,{storageKey:"global-state-io",title:"State Import/Export",icon:a.jsx(ec,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end","data-test":"global-state-io-button",children:a.jsx(Vh,{})});new Oa;const Jh={primaryColor:"blue",setPrimaryColor:()=>null},Yh=h.createContext(Jh),Xh=()=>{const s=h.useContext(Yh);if(s===void 0)throw new Error("usePrimaryColor must be used within a PrimaryColorProvider");return s};function Qh({onColorSelect:s,selectedHue:e=217}){const t=h.useRef(null),[n,r]=h.useState(!1),[o,i]=h.useState(e);h.useEffect(()=>{n||i(e)},[e,n]),h.useEffect(()=>{const g=t.current;if(!g)return;const x=g.getContext("2d");if(!x)return;const b=g.width,v=g.height,w=40,y=(v-w)/2,j=`hsl(${o} 70% 90%)`;x.fillStyle=j,x.fillRect(0,0,b,v);for(let C=0;C<b;C+=1){const N=C/b*360;x.fillStyle=`hsl(${N}, 100%, 50%)`,x.fillRect(C,y,1,w)}x.strokeStyle="#ccc",x.lineWidth=2,x.strokeRect(0,y,b,w);const S=o/360*b;x.strokeStyle="#000",x.lineWidth=3,x.beginPath(),x.moveTo(S,y-8),x.lineTo(S,y+w+8),x.stroke(),x.strokeStyle="#fff",x.lineWidth=1,x.beginPath(),x.moveTo(S,y-8),x.lineTo(S,y+w+8),x.stroke()},[o]);const c=g=>{const x=t.current;if(!x)return;const b=x.getBoundingClientRect(),v=g.clientX-b.left,w=Math.round(v/x.width*360),y=Math.max(0,Math.min(360,w));i(y),s(`${y} 70% 60%`)},l=()=>r(!0),d=()=>r(!1),p=g=>{n&&c(g)},u=()=>r(!0),f=()=>r(!1),m=g=>{if(!n)return;const x=t.current;if(!x)return;const b=x.getBoundingClientRect(),v=g.touches[0].clientX-b.left,w=Math.round(v/x.width*360),y=Math.max(0,Math.min(360,w));i(y),s(`${y} 70% 60%`)};return a.jsxs("div",{className:"color-strip-container flex flex-col items-center gap-3",children:[a.jsx("canvas",{ref:t,width:200,height:80,onClick:c,onMouseDown:l,onMouseUp:d,onMouseMove:p,onMouseLeave:()=>r(!1),onTouchStart:u,onTouchEnd:f,onTouchMove:m,className:"color-strip cursor-pointer rounded touch-none"}),a.jsx("div",{className:"color-info text-center",children:a.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hue: ",o,"Â°"]})})]})}const Fn=ji,eC=Nu,Zh=ka,jc=h.forwardRef(({className:s,style:e,...t},n)=>a.jsx(tr,{ref:n,className:U("fixed inset-0 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),style:{zIndex:tt.popover,...e},...t}));jc.displayName=tr.displayName;const $n=h.forwardRef(({className:s,children:e,style:t,...n},r)=>a.jsxs(Zh,{children:[a.jsx(jc,{}),a.jsxs(cn,{ref:r,className:U("fixed left-[50%] top-[50%] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),style:{zIndex:tt.popover,...t},...n,children:[e,a.jsxs(Ea,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ht,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));$n.displayName=cn.displayName;const Un=({className:s,...e})=>a.jsx("div",{className:U("flex flex-col space-y-1.5 text-center sm:text-left",s),...e});Un.displayName="DialogHeader";const ef=({className:s,...e})=>a.jsx("div",{className:U("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...e});ef.displayName="DialogFooter";const Zs=h.forwardRef(({className:s,...e},t)=>a.jsx(sr,{ref:t,className:U("text-lg font-semibold leading-none tracking-tight",s),...e}));Zs.displayName=sr.displayName;const Cc=h.forwardRef(({className:s,...e},t)=>a.jsx(nr,{ref:t,className:U("text-sm text-muted-foreground",s),...e}));Cc.displayName=nr.displayName;const tf=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose","white","black"],sf={slate:"#64748b",gray:"#6b7280",zinc:"#71717a",neutral:"#737373",stone:"#78716c",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e",white:"#ffffff",black:"#000000"},nf={slate:"hsl(215 16% 47%)",gray:"hsl(218 11% 43%)",zinc:"hsl(220 13% 47%)",neutral:"hsl(0 0% 45%)",stone:"hsl(12 6% 44%)",red:"hsl(0 84% 60%)",orange:"hsl(24 97% 61%)",amber:"hsl(45 96% 71%)",yellow:"hsl(54 100% 68%)",lime:"hsl(84 85% 67%)",green:"hsl(142 72% 64%)",emerald:"hsl(160 84% 65%)",teal:"hsl(168 86% 55%)",cyan:"hsl(191 87% 55%)",sky:"hsl(198 93% 60%)",blue:"hsl(217 91% 60%)",indigo:"hsl(226 86% 61%)",violet:"hsl(259 84% 63%)",purple:"hsl(280 85% 64%)",fuchsia:"hsl(289 86% 66%)",pink:"hsl(330 81% 60%)",rose:"hsl(356 84% 61%)",white:"hsl(0 0% 100%)",black:"hsl(0 0% 0%)"};function rf({isOpen:s,onOpenChange:e}){const{primaryColor:t,setPrimaryColor:n}=Xh(),[r,o]=h.useState(217),[i,c]=h.useState(t),l=p=>{c(p),n(p);const u=nf[p],f=parseInt(u.split(" ")[0].replace("hsl(",""));o(f)},d=p=>{const u=parseInt(p.split(" ")[0]);o(u);const f=`${u} 70% 90%`,m=`${u} 70% 85%`,g=`${u} 70% 80%`,x=`${u} 70% 70%`;n(`hsl-${u}`),c(`hsl-${u}`);const b=window.document.documentElement;b.style.setProperty("--background",f),b.style.setProperty("--card",m),b.style.setProperty("--tab",g),b.style.setProperty("--active",x)};return a.jsx(Fn,{open:s,onOpenChange:e,children:a.jsxs($n,{className:"theme-settings-dialog sm:max-w-3xl",children:[a.jsxs(Un,{children:[a.jsx(Zs,{className:"theme-settings-title",children:"Theme Settings"}),a.jsx(Cc,{className:"theme-settings-description",children:"Choose a predefined color or use the color wheel for custom colors"})]}),a.jsxs("div",{className:"predefined-colors-section mb-6",children:[a.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Predefined Colors"}),a.jsx("div",{className:"predefined-colors-grid grid grid-cols-12 gap-2",children:tf.map(p=>a.jsx("button",{type:"button",title:p,onClick:()=>l(p),className:U("color-button w-8 h-8 rounded-full border-2 cursor-pointer transition-all","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","hover:scale-110",i===p?"ring-2 ring-ring ring-offset-2 scale-110":"border-muted",p==="white"&&"border-neutral-300"),style:{backgroundColor:sf[p]},"aria-label":`Select ${p} theme`},p))})]}),a.jsxs("div",{className:"theme-wheel-container flex gap-6 items-start",children:[a.jsxs("div",{className:"flex-shrink-0",children:[a.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Custom Color"}),a.jsx(Qh,{onColorSelect:d,selectedHue:r})]}),a.jsxs("div",{className:"flex-1 space-y-3",children:[a.jsx("div",{className:"theme-preview-title",children:a.jsx("p",{className:"text-sm font-medium text-foreground",children:"Live Preview:"})}),a.jsx("div",{className:"theme-preview-bg p-4 rounded-lg border-2",style:{backgroundColor:`hsl(${r} 70% 90%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-700",children:"Background"})}),a.jsx("div",{className:"theme-preview-card p-4 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 85%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Card"})}),a.jsx("div",{className:"theme-preview-tab p-3 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 80%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Tab"})}),a.jsx("div",{className:"theme-preview-active p-3 rounded-lg border font-semibold",style:{backgroundColor:`hsl(${r} 70% 70%)`},children:a.jsx("p",{className:"text-xs text-gray-900",children:"Active/Selected"})})]})]})]})})}function ko({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx(dn,{title:"Settings",icon:a.jsx(Vt,{className:"h-5 w-5"}),variant:s,size:e,align:"end",storageKey:"app-settings","data-test":"global-config-button",children:a.jsxs("div",{className:"settings-panel space-y-3","data-test":"config-panel",children:[a.jsxs("div",{className:"theme-toggle-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme"}),a.jsx(Hh,{})]}),a.jsxs("div",{className:"theme-settings-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme Colors"}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>n(!0),className:"w-full flex items-center gap-2","data-test":"customize-colors-button",children:[a.jsx(ap,{className:"h-4 w-4"}),"Customize Colors"]})]}),a.jsx("div",{className:"divider my-3 border-t"}),a.jsxs("div",{className:"state-import-export-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Global State"}),a.jsx(Kh,{})]})]})}),a.jsx(rf,{isOpen:t,onOpenChange:n})]})}class af{constructor(){Z(this,"isActive",!1);Z(this,"callbacks",new Set);Z(this,"tooltipOwnerId",null);Z(this,"panelOwnerId",null);Z(this,"clickOwnerId",null)}subscribe(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}getState(){return this.isActive}toggle(){this.isActive=!this.isActive,this.notifySubscribers()}setState(e){this.isActive!==e&&(this.isActive=e,this.notifySubscribers())}activate(){this.setState(!0)}deactivate(){this.setState(!1)}claimTooltip(e){this.tooltipOwnerId=e}releaseTooltip(e){this.tooltipOwnerId===e&&(this.tooltipOwnerId=null)}canRenderTooltip(e){return this.tooltipOwnerId===null?e===null:this.tooltipOwnerId===e}claimPanel(e){this.panelOwnerId=e}releasePanel(e){this.panelOwnerId===e&&(this.panelOwnerId=null)}canRenderPanel(e){return this.panelOwnerId===null?e===null:this.panelOwnerId===e}claimClickHandling(e){this.clickOwnerId=e}releaseClickHandling(e){this.clickOwnerId===e&&(this.clickOwnerId=null)}canHandleClicks(e){return this.clickOwnerId===null?e===null:this.clickOwnerId===e}notifySubscribers(){this.callbacks.forEach(e=>e(this.isActive))}}const xt=new af,os=({isVisible:s,onClose:e,title:t,children:n,className:r,initialPosition:o,triggerPosition:i,shouldCloseManually:c=!1,resizable:l=!1,initialSize:d,onSizeChange:p,onPositionChange:u,headerActions:f,footer:m,portalContainer:g,showPinButton:x=!1,showInspectorButton:b=!1,zIndex:v=tt.draggablePopover,anchorOrigin:w="top-left"})=>{const y=i??(typeof o=="object"?o:void 0),j=h.useMemo(()=>{if(!d)return null;const G=window.innerWidth,oe=window.innerHeight,de=32;return{width:Math.min(d.width,G-de),height:d.height?Math.min(d.height,oe-de):void 0}},[d]),S=h.useMemo(()=>{const G=window.innerWidth,oe=window.innerHeight,de=(j==null?void 0:j.width)??320,pe=(j==null?void 0:j.height)??400;if(!y||o==="center")return{x:Math.max(16,(G-de)/2),y:Math.max(16,(oe-pe)/2)};let fe=y.x,be=y.y;return fe+de>G&&(fe=G-de-16),fe<16&&(fe=16),be+pe>oe&&(be=oe-pe-32),be<16&&(be=16),{x:fe,y:be}},[y,j,o]),[C,N]=h.useState(null),[A,k]=h.useState(j),[E,R]=h.useState(!1),[M,L]=h.useState(!1),[T,W]=h.useState(null),[z,te]=h.useState({x:0,y:0}),[O,ee]=h.useState({x:0,y:0,width:0,height:0,posX:0,posY:0}),[I,_]=h.useState(!1),[F,q]=h.useState(!1),J=h.useRef(null),P=h.useRef(null),B=h.useRef(!1),se=w!=="top-left"&&typeof o=="object",[le,me]=h.useState(!se);h.useEffect(()=>{if(!s||B.current||w==="top-left"){s&&w==="top-left"&&me(!0);return}typeof o=="object"&&requestAnimationFrame(()=>{if(!P.current)return;const G=P.current.getBoundingClientRect();let oe=o.x,de=o.y;(w==="top-right"||w==="bottom-right")&&(oe=o.x-G.width),(w==="bottom-left"||w==="bottom-right")&&(de=o.y-G.height);const pe=16;oe=Math.max(pe,Math.min(oe,window.innerWidth-G.width-pe)),de=Math.max(pe,Math.min(de,window.innerHeight-G.height-pe)),N({x:oe,y:de}),B.current=!0,me(!0)})},[s,o,w]),h.useEffect(()=>{s||(B.current=!1,me(!(w!=="top-left"&&typeof o=="object")))},[s,w,o]);const ae=G=>{const oe=G.target;if(!(oe.tagName==="INPUT"||oe.tagName==="TEXTAREA"||oe.tagName==="SELECT"||oe.tagName==="BUTTON"||oe.closest("button")!==null||oe.closest("input")!==null||oe.closest("textarea")!==null||oe.closest("select")!==null||oe.classList.contains("resize-handle"))&&(G.preventDefault(),P.current)){const pe=P.current.getBoundingClientRect(),fe=pe.left,be=pe.top;N({x:fe,y:be}),R(!0),te({x:G.clientX-fe,y:G.clientY-be})}},H=G=>{const oe=G.target;if(oe.tagName==="INPUT"||oe.tagName==="TEXTAREA"||oe.tagName==="SELECT"||oe.tagName==="BUTTON"||oe.closest("button")!==null||oe.closest("input")!==null||oe.closest("textarea")!==null||oe.closest("select")!==null||oe.classList.contains("resize-handle"))return;const pe=G.touches[0];if(pe&&P.current){const fe=P.current.getBoundingClientRect(),be=fe.left,Pe=fe.top;N({x:be,y:Pe}),R(!0),te({x:pe.clientX-be,y:pe.clientY-Pe})}},X=G=>oe=>{if(oe.stopPropagation(),P.current){const de=P.current.getBoundingClientRect();L(!0),W(G),ee({x:oe.clientX,y:oe.clientY,width:de.width,height:de.height,posX:de.left,posY:de.top})}},ge=G=>oe=>{oe.stopPropagation();const de=oe.touches[0];if(de&&P.current){const pe=P.current.getBoundingClientRect();L(!0),W(G),ee({x:de.clientX,y:de.clientY,width:pe.width,height:pe.height,posX:pe.left,posY:pe.top})}},ce=G=>{G.stopPropagation(),xt.toggle();const oe=xt.getState();ke.success(`Element Inspector ${oe?"activated":"deactivated"}`,{description:oe?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};h.useEffect(()=>{if(c||!s||I||F){J.current&&(clearTimeout(J.current),J.current=null);return}return J.current=setTimeout(()=>{e()},2e3),()=>{J.current&&(clearTimeout(J.current),J.current=null)}},[s,I,F,e,c]),h.useEffect(()=>{s||(q(!1),N(null))},[s]);const Ae=()=>{q(!0)};h.useEffect(()=>{if(!E)return;const G=document.body.style.userSelect;document.body.style.userSelect="none";const oe=fe=>{N({x:fe.clientX-z.x,y:fe.clientY-z.y})},de=fe=>{const be=fe.touches[0];be&&(fe.preventDefault(),N({x:be.clientX-z.x,y:be.clientY-z.y}))},pe=()=>{R(!1),ve(!0),C&&u&&u(C)};return document.addEventListener("mousemove",oe),document.addEventListener("mouseup",pe),document.addEventListener("touchmove",de,{passive:!1}),document.addEventListener("touchend",pe),()=>{document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",pe),document.removeEventListener("touchmove",de),document.removeEventListener("touchend",pe),document.body.style.userSelect=G}},[E,z,C,u]),h.useEffect(()=>{if(!M||!T)return;const G=300,oe=200,de=document.body.style.userSelect;document.body.style.userSelect="none";const pe=(Ee,V)=>{const D=Ee-O.x,Y=V-O.y;let we=O.width,ne=O.height,xe=O.posX,K=O.posY;if(T.includes("e"))we=Math.max(G,O.width+D);else if(T.includes("w")){const he=O.width-D;he>=G?(we=he,xe=O.posX+D):(we=G,xe=O.posX+(O.width-G))}if(T.includes("s"))ne=Math.max(oe,O.height+Y);else if(T.includes("n")){const he=O.height-Y;he>=oe?(ne=he,K=O.posY+Y):(ne=oe,K=O.posY+(O.height-oe))}return{newWidth:we,newHeight:ne,newPosX:xe,newPosY:K}},fe=Ee=>{const{newWidth:V,newHeight:D,newPosX:Y,newPosY:we}=pe(Ee.clientX,Ee.clientY);k({width:V,height:D}),(T.includes("w")||T.includes("n"))&&N({x:Y,y:we})},be=Ee=>{const V=Ee.touches[0];if(!V)return;Ee.preventDefault();const{newWidth:D,newHeight:Y,newPosX:we,newPosY:ne}=pe(V.clientX,V.clientY);k({width:D,height:Y}),(T.includes("w")||T.includes("n"))&&N({x:we,y:ne})},Pe=()=>{L(!1),W(null),A&&A.height&&p&&p({width:A.width,height:A.height}),C&&u&&u(C)};return document.addEventListener("mousemove",fe),document.addEventListener("mouseup",Pe),document.addEventListener("touchmove",be,{passive:!1}),document.addEventListener("touchend",Pe),()=>{document.removeEventListener("mousemove",fe),document.removeEventListener("mouseup",Pe),document.removeEventListener("touchmove",be),document.removeEventListener("touchend",Pe),document.body.style.userSelect=de}},[M,T,O,A,C,p,u]),h.useEffect(()=>{if(!s||c)return;const G=oe=>{oe.key==="Escape"&&e()};return document.addEventListener("keydown",G),()=>{document.removeEventListener("keydown",G)}},[s,e,c]);const[Ce,ve]=h.useState(!1);h.useEffect(()=>{s||ve(!1)},[s]);const $=Ce&&C?C:S;if(!s)return null;const re=a.jsxs("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:tt.backdrop},"data-test":"draggable-popover-wrapper",children:[!c&&a.jsx("div",{className:"backdrop-click-outside fixed inset-0",style:{zIndex:tt.backdrop,pointerEvents:"auto"},onClick:e,"aria-hidden":"true","data-test":"draggable-popover-backdrop"}),a.jsxs("div",{ref:P,className:qs("fixed","w-80 bg-background text-foreground border border-border rounded-lg shadow-lg","flex flex-col",l&&"relative",r),style:{zIndex:v,pointerEvents:"auto",opacity:le?1:0,top:$?`${$.y}px`:"auto",right:"auto",left:$?`${$.x}px`:"auto",bottom:"auto",cursor:M&&T?T==="nw"||T==="se"?"nwse-resize":T==="ne"||T==="sw"?"nesw-resize":T==="n"||T==="s"?"ns-resize":T==="e"||T==="w"?"ew-resize":"default":"default",width:A?`${A.width}px`:void 0,height:A!=null&&A.height?`${A.height}px`:void 0,maxHeight:"calc(100vh - 2rem)"},onMouseEnter:Ae,"data-test":"draggable-popover-container",children:[a.jsxs("div",{className:"header px-3 py-2 border-b border-border flex justify-between items-center cursor-grab active:cursor-grabbing",onMouseDown:ae,onTouchStart:H,"data-test":"draggable-popover-header",children:[a.jsx("h3",{className:"title-text text-sm font-semibold select-none","data-test":"draggable-popover-title",children:t}),a.jsxs("div",{className:"action-buttons flex items-center gap-1","data-test":"draggable-popover-actions",children:[f,b&&a.jsx("button",{className:"inspector-button p-1 rounded hover:bg-accent transition-colors",onClick:ce,onMouseDown:G=>G.stopPropagation(),"aria-label":"Toggle Element Inspector",title:"Toggle Element Inspector","data-test":"draggable-popover-inspector-button",children:a.jsx(op,{size:14})}),x&&a.jsx("button",{className:qs("pin-button p-1 rounded hover:bg-accent transition-colors",I&&"bg-accent text-accent-foreground"),onClick:G=>{G.stopPropagation(),_(!I)},onMouseDown:G=>G.stopPropagation(),"aria-label":I?"Unpin popover":"Pin popover",title:I?"Unpin":"Pin","data-test":"draggable-popover-pin-button",children:a.jsx(ip,{size:14,className:qs(I&&"fill-current")})}),a.jsx("button",{className:"close-button p-1 rounded hover:bg-accent transition-colors",onClick:G=>{G.stopPropagation(),e()},onMouseDown:G=>G.stopPropagation(),"aria-label":"Close popover",title:"Close","data-test":"draggable-popover-close-button",children:a.jsx(ht,{size:14})})]})]}),a.jsx("div",{className:"flex-1 min-h-0 overflow-auto","data-test":"draggable-popover-content",children:n}),m&&a.jsx("div",{className:"flex-shrink-0 border-t border-border","data-test":"draggable-popover-footer",children:m}),l&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"resize-handle absolute top-0 left-0 w-3 h-3 cursor-nwse-resize",onMouseDown:X("nw"),onTouchStart:ge("nw"),"data-test":"draggable-popover-resize-nw"}),a.jsx("div",{className:"resize-handle absolute top-0 right-0 w-3 h-3 cursor-nesw-resize",onMouseDown:X("ne"),onTouchStart:ge("ne"),"data-test":"draggable-popover-resize-ne"}),a.jsx("div",{className:"resize-handle absolute bottom-0 left-0 w-3 h-3 cursor-nesw-resize",onMouseDown:X("sw"),onTouchStart:ge("sw"),"data-test":"draggable-popover-resize-sw"}),a.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-3 h-3 cursor-nwse-resize",onMouseDown:X("se"),onTouchStart:ge("se"),style:{background:"linear-gradient(135deg, transparent 50%, currentColor 50%)",opacity:.3},"data-test":"draggable-popover-resize-se"}),a.jsx("div",{className:"resize-handle absolute top-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:X("n"),onTouchStart:ge("n"),"data-test":"draggable-popover-resize-n"}),a.jsx("div",{className:"resize-handle absolute bottom-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:X("s"),onTouchStart:ge("s"),"data-test":"draggable-popover-resize-s"}),a.jsx("div",{className:"resize-handle absolute left-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:X("w"),onTouchStart:ge("w"),"data-test":"draggable-popover-resize-w"}),a.jsx("div",{className:"resize-handle absolute right-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:X("e"),onTouchStart:ge("e"),"data-test":"draggable-popover-resize-e"})]})]})]});return au.createPortal(re,g??document.body)},Eo=5,of=300,cf=800,Io={indicatorBg:"#dc2626",indicatorText:"#ffffff"},To={background:"rgba(254, 205, 211, 0.5)",border:"#06b6d4"},Qr={success:"#22c55e",hover:"#3b82f6"},Bn={click:{bg:"#dbeafe",text:"#2563eb"},drag:{bg:"#fef3c7",text:"#d97706"},type:{bg:"#dcfce7",text:"#16a34a"}};function Ao(s){const e=s.getAttribute("data-test");if(e)return`[data-test="${e}"]`;const t=s.id;if(t&&!t.match(/^[:\d]|css-/))return`#${t}`;const n=Array.from(s.classList).filter(r=>!r.startsWith("css-")&&!r.match(/^[a-z]+-[\da-f]{6,}/i)).join(".");return n?`.${n}`:s.tagName.toLowerCase()}function lf(s,e,t,n){const r=Math.abs(t-s),o=Math.abs(n-e);return r>Eo||o>Eo}function df({targetRef:s,enabled:e}){const[t,n]=h.useState([]),[r,o]=h.useState(!1),i=h.useRef({isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}),c=h.useRef(null),l=h.useRef(null),d=h.useRef({element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""}),p=h.useCallback(y=>{n(j=>[...j,y])},[]),u=h.useCallback(()=>{const y=d.current;y.element&&(y.element.style.backgroundColor=y.originalBackground,y.element.style.outline=y.originalOutline,y.element.style.outlineOffset=y.originalOutlineOffset,d.current={element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""})},[]),f=h.useCallback(y=>{if(!r)return;const j=y.target;if(!j||j.closest('[data-test="capture-panel-v2"]')){u();return}const S=Ao(j);i.current={isDragging:!1,startX:y.clientX,startY:y.clientY,startTime:Date.now(),selector:S,element:j}},[r,u]),m=h.useCallback(y=>{if(!r)return;const j=i.current;if(!j.element)return;const S=y.clientX,C=y.clientY,N=Date.now()-j.startTime;lf(j.startX,j.startY,S,C)?p({type:"drag",timestamp:j.startTime,data:{startX:j.startX,startY:j.startY,endX:S,endY:C,selector:j.selector,duration:N}}):p({type:"click",timestamp:j.startTime,data:{x:j.startX,y:j.startY,selector:j.selector}}),i.current={isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}},[r,p]),g=h.useCallback(y=>{if(!r)return;const j=y.target;if(!j||!("value"in j))return;const S=Ao(j),C=j.value;c.current&&window.clearTimeout(c.current),l.current={selector:S,value:C},c.current=window.setTimeout(()=>{l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},of)},[r,p]),x=h.useCallback(y=>{if(!r)return;const j=y.target;if(j){if(j.closest('[data-test="capture-panel-v2"]')||j.closest('[data-test="recording-panel"]')){u();return}d.current.element!==j&&(u(),d.current={element:j,originalBackground:j.style.backgroundColor,originalOutline:j.style.outline,originalOutlineOffset:j.style.outlineOffset},j.style.backgroundColor=To.background,j.style.outline=`2px solid ${To.border}`,j.style.outlineOffset="1px")}},[r,u]);h.useEffect(()=>{if(!r)return;const y=document;return y.addEventListener("pointerdown",f),y.addEventListener("pointerup",m),y.addEventListener("pointermove",x),y.addEventListener("input",g,!0),()=>{y.removeEventListener("pointerdown",f),y.removeEventListener("pointerup",m),y.removeEventListener("pointermove",x),y.removeEventListener("input",g,!0),u(),c.current&&window.clearTimeout(c.current)}},[e,r,s,f,m,x,g,u]);const b=h.useCallback(()=>{o(!0)},[]),v=h.useCallback(()=>{o(!1),u(),c.current&&(window.clearTimeout(c.current),c.current=null),l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},[p,u]),w=h.useCallback(()=>{n([])},[]);return{interactions:t,isRecording:r,startRecording:b,stopRecording:v,clearRecording:w}}function Nc(s){try{switch(s.type){case"click":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.click();const n=t.style.outline;t.style.outline=`3px solid ${Qr.success}`,setTimeout(()=>{t.style.outline=n},300)},300),ke.success(`Clicked: ${e.selector}`)):ke.error(`Element not found: ${e.selector}`);break}case"drag":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const n=t.getBoundingClientRect(),r=new PointerEvent("pointerdown",{bubbles:!0,clientX:n.left+(e.startX-n.left),clientY:n.top+(e.startY-n.top)}),o=new PointerEvent("pointerup",{bubbles:!0,clientX:e.endX,clientY:e.endY});t.dispatchEvent(r),setTimeout(()=>{t.dispatchEvent(o)},Math.min(e.duration,500))},300),ke.success(`Dragged: ${e.selector}`)):ke.error(`Element not found: ${e.selector}`);break}case"type":{const e=s.data,t=document.querySelector(e.selector);t&&"value"in t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.focus(),t.value=e.value,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const n=t.style.outline;t.style.outline=`3px solid ${Qr.success}`,setTimeout(()=>{t.style.outline=n},300)},300),ke.success(`Typed into: ${e.selector}`)):ke.error(`Input not found: ${e.selector}`);break}}}catch(e){ke.error(`Replay failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async function uf(s,e){ke.info(`Replaying ${e+1} interaction${e>0?"s":""}...`);for(let t=0;t<=e;t++)Nc(s[t]),t<e&&await new Promise(n=>setTimeout(n,cf))}let cs=null;function pf(s){switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function hf(s){kc();const e=pf(s);try{const t=document.querySelector(e);if(t){const n=t.getBoundingClientRect();n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth||t.scrollIntoView({behavior:"smooth",block:"center"}),cs={element:t,originalOutline:t.style.outline,originalOutlineOffset:t.style.outlineOffset},t.style.outline=`3px solid ${Qr.hover}`,t.style.outlineOffset="2px"}}catch{}}function kc(){cs&&(cs.element.style.outline=cs.originalOutline,cs.element.style.outlineOffset=cs.originalOutlineOffset,cs=null)}function ff(s,e){const t=s-e;return t<1e3?`+${t}ms`:t<6e4?`+${(t/1e3).toFixed(1)}s`:`+${(t/6e4).toFixed(1)}m`}function mf({type:s}){switch(s){case"click":return a.jsx(Pa,{className:"w-3 h-3"});case"drag":return a.jsx(Aa,{className:"w-3 h-3"});case"type":return a.jsx(Ta,{className:"w-3 h-3"})}}function gf({interaction:s}){switch(s.type){case"click":{const e=s.data;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-click-details",children:["at (",e.x,", ",e.y,") â†’ ",a.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}case"drag":{const e=s.data;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-drag-details",children:["(",e.startX,", ",e.startY,") â†’ (",e.endX,", ",e.endY,") [",e.duration,"ms]"]})}case"type":{const e=s.data,t=e.value.length>30?`${e.value.slice(0,30)}...`:e.value;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-type-details",children:['"',t,'" â†’ ',a.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}}}function xf({interactions:s,isRecording:e,onExport:t,onClear:n}){const r=s.length>0?s[0].timestamp:0;return a.jsxs("div",{className:"flex flex-col h-full","data-test":"recording-panel",children:[a.jsxs("div",{className:"flex items-center justify-between p-2 border-b",style:{backgroundColor:"#f9fafb"},"data-test":"recording-panel-header",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium",style:{color:"#6b7280"},children:"Recordings"}),e&&a.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium animate-pulse",style:{backgroundColor:Io.indicatorBg,color:Io.indicatorText},"data-test":"recording-indicator",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-white"}),"REC"]}),a.jsxs("span",{className:"text-xs",style:{color:"#9ca3af"},"data-test":"interaction-count",children:["(",s.length,")"]})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:t,disabled:s.length===0,title:"Export as JSON","data-test":"export-recording-button",children:a.jsx(Ia,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:n,disabled:s.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:a.jsx(Et,{className:"w-3 h-3"})})]})]}),a.jsx("div",{className:"flex-1 overflow-auto p-2","data-test":"recording-timeline",children:s.length===0?a.jsx("div",{className:"flex items-center justify-center h-full text-xs text-gray-400","data-test":"empty-recordings",children:e?"Recording... Click or type to capture interactions":"No recordings yet"}):a.jsx("div",{className:"space-y-1",children:s.map((o,i)=>a.jsxs("div",{className:"flex items-start gap-2 p-1.5 rounded hover:bg-gray-100 cursor-pointer group transition-colors relative",onClick:()=>Nc(o),onMouseEnter:()=>hf(o),onMouseLeave:kc,title:"Click to replay this interaction","data-test":"recorded-interaction",children:[a.jsx("button",{className:"absolute top-1 right-1 w-5 h-5 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-blue-100 hover:bg-blue-200 text-blue-600",onClick:c=>{c.stopPropagation(),uf(s,i)},title:`Replay all ${i+1} interaction${i>0?"s":""} up to here`,"data-test":"replay-up-to-button",children:a.jsx(cp,{className:"w-3 h-3"})}),a.jsxs("div",{className:"flex flex-col items-center",children:[a.jsxs("div",{className:"w-5 h-5 rounded-full flex items-center justify-center relative",style:{backgroundColor:Bn[o.type].bg,color:Bn[o.type].text},"data-test":"interaction-icon",children:[a.jsx("span",{className:"group-hover:hidden",children:a.jsx(mf,{type:o.type})}),a.jsx(sc,{className:"w-3 h-3 hidden group-hover:block"})]}),i<s.length-1&&a.jsx("div",{className:"w-px h-3 bg-gray-200","data-test":"timeline-connector"})]}),a.jsxs("div",{className:"flex-1 min-w-0 pr-6",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium capitalize","data-test":"interaction-type",children:o.type}),a.jsx("span",{className:"text-xs text-gray-400","data-test":"interaction-time",children:ff(o.timestamp,r)}),a.jsx("span",{className:"text-xs text-green-600 opacity-0 group-hover:opacity-100 transition-opacity","data-test":"replay-hint",children:"â–¶ replay"})]}),a.jsx(gf,{interaction:o})]})]},`${o.timestamp}-${i}`))})})]})}const Wt="watcher:recording-sessions";function vf(){const[s,e]=h.useState([]);h.useEffect(()=>{try{const u=localStorage.getItem(Wt);u&&e(JSON.parse(u))}catch(u){console.warn("[SessionStorage] Failed to load from localStorage:",u)}},[]);const t=h.useCallback((u,f,m)=>{const g={id:`session-${Date.now()}`,name:u,description:f,savedAt:Date.now(),interactions:m,sourceUrl:window.location.href};return e(x=>{const b=[...x,g];return localStorage.setItem(Wt,JSON.stringify(b)),b}),ke.success("Session saved!"),g},[]),n=h.useCallback(u=>{const f=localStorage.getItem(Wt);if(!f)return;const g=JSON.parse(f).find(x=>x.id===u);return g&&ke.success("Session loaded!"),g},[]),r=h.useCallback(u=>{e(f=>{const m=f.filter(g=>g.id!==u);return localStorage.setItem(Wt,JSON.stringify(m)),m}),ke.success("Session deleted")},[]),o=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>x.id===u?{...x,...f}:x);return localStorage.setItem(Wt,JSON.stringify(g)),g}),ke.success("Session updated")},[]),i=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(b=>{if(b.id!==u)return b;const v=[...b.interactions];return v[f]=m,{...b,interactions:v}});return localStorage.setItem(Wt,JSON.stringify(x)),x}),ke.success("Interaction updated")},[]),c=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>{if(x.id!==u)return x;const b=x.interactions.filter((v,w)=>w!==f);return{...x,interactions:b}});return localStorage.setItem(Wt,JSON.stringify(g)),g}),ke.success("Interaction deleted")},[]),l=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(b=>{if(b.id!==u)return b;const v=[...b.interactions];return v.splice(f,0,m),{...b,interactions:v}});return localStorage.setItem(Wt,JSON.stringify(x)),x}),ke.success("Interaction inserted")},[]),d=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(b=>{if(b.id!==u)return b;const v=[...b.interactions];return v[f]=m,{...b,interactions:v}});return localStorage.setItem(Wt,JSON.stringify(x)),x}),ke.success("Interaction replaced")},[]),p=h.useCallback(()=>{try{const u=localStorage.getItem(Wt);if(!u)return;const f=JSON.parse(u);return f.length===0?void 0:f[f.length-1]}catch{return}},[]);return{savedSessions:s,saveSession:t,loadSession:n,deleteSession:r,updateSession:o,updateInteraction:i,deleteInteraction:c,insertInteraction:l,replaceInteraction:d,getLastSession:p}}const Ec=h.createContext(null);function Ut({open:s,onOpenChange:e,defaultOpen:t,...n}){const[r,o]=h.useState(t??!1),i=s!==void 0,c=i?s:r,l=h.useCallback(u=>{i||o(u),e==null||e(u)},[i,e]),d=h.useCallback(()=>{l(!c)},[c,l]),p=h.useMemo(()=>({toggle:d,isOpen:c}),[d,c]);return a.jsx(Ec.Provider,{value:p,children:a.jsx(Eu,{open:c,onOpenChange:l,...n})})}const Jt=ku,It=h.forwardRef(({className:s,children:e,onPointerDown:t,hideChevron:n,...r},o)=>{const i=h.useContext(Ec),c=h.useCallback(l=>{if(i!=null&&i.isOpen){l.preventDefault(),i.toggle();return}t==null||t(l)},[i,t]);return a.jsxs(Ii,{ref:o,className:U("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),onPointerDown:c,...r,children:[e,!n&&a.jsx(Iu,{asChild:!0,children:a.jsx(wt,{className:"h-4 w-4 opacity-50"})})]})});It.displayName=Ii.displayName;const Ic=h.forwardRef(({className:s,...e},t)=>a.jsx(Pi,{ref:t,className:U("flex cursor-default items-center justify-center py-1",s),...e,children:a.jsx(ar,{className:"h-4 w-4"})}));Ic.displayName=Pi.displayName;const Tc=h.forwardRef(({className:s,...e},t)=>a.jsx(Ri,{ref:t,className:U("flex cursor-default items-center justify-center py-1",s),...e,children:a.jsx(wt,{className:"h-4 w-4"})}));Tc.displayName=Ri.displayName;const Tt=h.forwardRef(({className:s,children:e,position:t="popper",style:n,container:r,...o},i)=>a.jsx(Tu,{container:r??void 0,children:a.jsxs(Ti,{ref:i,style:{zIndex:tt.tooltip,...n},className:U("relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:t,...o,children:[a.jsx(Ic,{}),a.jsx(Au,{className:U("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),a.jsx(Tc,{})]})}));Tt.displayName=Ti.displayName;const bf=h.forwardRef(({className:s,...e},t)=>a.jsx(Di,{ref:t,className:U("px-2 py-1.5 text-sm font-semibold",s),...e}));bf.displayName=Di.displayName;const Oe=h.forwardRef(({className:s,children:e,...t},n)=>a.jsxs(Ai,{ref:n,className:U("relative flex w-full cursor-default select-none items-start rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[a.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center mt-0.5",children:a.jsx(Pu,{children:a.jsx(ct,{className:"h-4 w-4"})})}),a.jsx(Ru,{className:"flex-1",children:e})]}));Oe.displayName=Ai.displayName;const wf=h.forwardRef(({className:s,...e},t)=>a.jsx(_i,{ref:t,className:U("-mx-1 my-1 h-px bg-muted",s),...e}));wf.displayName=_i.displayName;function yf({onSaveSession:s,onLoadSession:e,onManageSessions:t,disabled:n=!1,portalContainer:r}){const o=i=>{switch(i){case"save":s();break;case"load":e();break;case"manage":t();break}};return a.jsxs(Ut,{value:"",onValueChange:o,children:[a.jsx(It,{className:"h-6 w-6 p-0 border-0 bg-transparent hover:bg-accent rounded",hideChevron:!0,disabled:n,title:"More options","data-test":"recording-more-options-trigger",children:a.jsx(lp,{className:"w-3 h-3"})}),a.jsxs(Tt,{container:r,"data-test":"recording-more-options-content",children:[a.jsx(Oe,{value:"save","data-test":"recording-option-save",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Nn,{className:"w-3 h-3"}),a.jsx("span",{children:"Save Session"})]})}),a.jsx(Oe,{value:"load","data-test":"recording-option-load",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(nc,{className:"w-3 h-3"}),a.jsx("span",{children:"Load Session"})]})}),a.jsx(Oe,{value:"manage","data-test":"recording-option-manage",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(dp,{className:"w-3 h-3"}),a.jsx("span",{children:"Manage Sessions"})]})})]})]})}function Po({interaction:s,onSave:e,onCancel:t,onPickSelector:n}){var k,E,R,M,L,T,W,z,te,O,ee,I,_,F,q;const[r,o]=h.useState((s==null?void 0:s.type)??"click"),[i,c]=h.useState(Sf(s)??""),[l,d]=h.useState(((E=(k=s==null?void 0:s.data)==null?void 0:k.x)==null?void 0:E.toString())??"0"),[p,u]=h.useState(((M=(R=s==null?void 0:s.data)==null?void 0:R.y)==null?void 0:M.toString())??"0"),[f,m]=h.useState(((T=(L=s==null?void 0:s.data)==null?void 0:L.startX)==null?void 0:T.toString())??"0"),[g,x]=h.useState(((z=(W=s==null?void 0:s.data)==null?void 0:W.startY)==null?void 0:z.toString())??"0"),[b,v]=h.useState(((O=(te=s==null?void 0:s.data)==null?void 0:te.endX)==null?void 0:O.toString())??"0"),[w,y]=h.useState(((I=(ee=s==null?void 0:s.data)==null?void 0:ee.endY)==null?void 0:I.toString())??"0"),[j,S]=h.useState(((F=(_=s==null?void 0:s.data)==null?void 0:_.duration)==null?void 0:F.toString())??"100"),[C,N]=h.useState(((q=s==null?void 0:s.data)==null?void 0:q.value)??"");h.useEffect(()=>{s||(c(""),d("0"),u("0"),m("0"),x("0"),v("0"),y("0"),S("100"),N(""))},[r,s]);const A=()=>{const J=(s==null?void 0:s.timestamp)??Date.now();let P;switch(r){case"click":P={x:parseInt(l,10)||0,y:parseInt(p,10)||0,selector:i};break;case"drag":P={startX:parseInt(f,10)||0,startY:parseInt(g,10)||0,endX:parseInt(b,10)||0,endY:parseInt(w,10)||0,selector:i,duration:parseInt(j,10)||100};break;case"type":P={selector:i,value:C};break}e({type:r,timestamp:J,data:P})};return a.jsxs("div",{className:"space-y-3 p-3","data-test":"interaction-editor-form",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Interaction Type"}),a.jsxs(Ut,{value:r,onValueChange:J=>o(J),children:[a.jsx(It,{className:"h-8","data-test":"interaction-type-select",children:a.jsx(Jt,{})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"click",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Pa,{className:"w-3 h-3"}),"Click"]})}),a.jsx(Oe,{value:"drag",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Aa,{className:"w-3 h-3"}),"Drag"]})}),a.jsx(Oe,{value:"type",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ta,{className:"w-3 h-3"}),"Type"]})})]})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"CSS Selector"}),a.jsxs("div",{className:"flex gap-1",children:[a.jsx(We,{value:i,onChange:J=>c(J.target.value),placeholder:'e.g., [data-test="button"]',className:"h-8 text-xs flex-1","data-test":"interaction-selector-input"}),n&&a.jsx(ue,{variant:"outline",size:"sm",className:"h-8 px-2",onClick:n,title:"Pick from page","data-test":"pick-selector-button",children:a.jsx(up,{className:"w-3 h-3"})})]})]}),r==="click"&&a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"X"}),a.jsx(We,{type:"number",value:l,onChange:J=>d(J.target.value),className:"h-8 text-xs","data-test":"click-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Y"}),a.jsx(We,{type:"number",value:p,onChange:J=>u(J.target.value),className:"h-8 text-xs","data-test":"click-y-input"})]})]}),r==="drag"&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Start X"}),a.jsx(We,{type:"number",value:f,onChange:J=>m(J.target.value),className:"h-8 text-xs","data-test":"drag-start-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Start Y"}),a.jsx(We,{type:"number",value:g,onChange:J=>x(J.target.value),className:"h-8 text-xs","data-test":"drag-start-y-input"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"End X"}),a.jsx(We,{type:"number",value:b,onChange:J=>v(J.target.value),className:"h-8 text-xs","data-test":"drag-end-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"End Y"}),a.jsx(We,{type:"number",value:w,onChange:J=>y(J.target.value),className:"h-8 text-xs","data-test":"drag-end-y-input"})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Duration (ms)"}),a.jsx(We,{type:"number",value:j,onChange:J=>S(J.target.value),className:"h-8 text-xs","data-test":"drag-duration-input"})]})]}),r==="type"&&a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Value to type"}),a.jsx(We,{value:C,onChange:J=>N(J.target.value),placeholder:"Text to type...",className:"h-8 text-xs","data-test":"type-value-input"})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx(ue,{variant:"ghost",size:"sm",onClick:t,"data-test":"cancel-edit-button",children:"Cancel"}),a.jsx(ue,{size:"sm",onClick:A,disabled:!i,"data-test":"save-edit-button",children:s?"Update":"Add"})]})]})}function Sf(s){if(s)switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function jf({session:s,onBack:e,onUpdateSession:t,onUpdateInteraction:n,onDeleteInteraction:r,onInsertInteraction:o,onStartInsertRecord:i,onStartReplaceRecord:c}){const[l,d]=h.useState(!1),[p,u]=h.useState(!1),[f,m]=h.useState(s.name),[g,x]=h.useState(s.description),[b,v]=h.useState(null),[w,y]=h.useState(null),j=()=>{f.trim()&&(t({name:f.trim()}),d(!1))},S=()=>{t({description:g.trim()}),u(!1)},C=E=>{b!==null?(n(b,E),v(null)):w!==null&&(o(w,E),y(null))},N=E=>{switch(E){case"click":return a.jsx(Pa,{className:"w-3 h-3"});case"drag":return a.jsx(Aa,{className:"w-3 h-3"});case"type":return a.jsx(Ta,{className:"w-3 h-3"})}},A=E=>{switch(E.type){case"click":{const R=E.data;return`Click at (${R.x}, ${R.y})`}case"drag":return`Drag ${E.data.duration}ms`;case"type":{const R=E.data;return`Type "${R.value.length>20?`${R.value.slice(0,20)}...`:R.value}"`}}},k=E=>{switch(E.type){case"click":return E.data.selector;case"drag":return E.data.selector;case"type":return E.data.selector}};return b!==null?a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-interaction-form",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>v(null),"data-test":"cancel-edit-interaction",children:a.jsx(br,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium",children:["Edit Interaction #",b+1]})]}),a.jsx(Po,{interaction:s.interactions[b],onSave:C,onCancel:()=>v(null)})]}):w!==null?a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-add-form",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>y(null),"data-test":"cancel-add-interaction",children:a.jsx(br,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium",children:["Add Interaction at #",w+1]})]}),a.jsx(Po,{onSave:C,onCancel:()=>y(null)})]}):a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-view",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:e,"data-test":"session-editor-back",children:a.jsx(br,{className:"w-4 h-4"})}),a.jsx("span",{className:"text-sm font-medium",children:"Edit Session"})]}),a.jsxs("div",{className:"flex-1 overflow-auto p-3 space-y-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-gray-500",children:"Name"}),l?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(We,{value:f,onChange:E=>m(E.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:E=>E.key==="Enter"&&j(),"data-test":"session-name-input"}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:j,children:a.jsx(ct,{className:"w-3 h-3 text-green-600"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{d(!1),m(s.name)},children:a.jsx(ht,{className:"w-3 h-3 text-gray-500"})})]}):a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm flex-1","data-test":"session-name-display",children:s.name}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>d(!0),"data-test":"edit-session-name",children:a.jsx(kn,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-gray-500",children:"Description"}),p?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(We,{value:g,onChange:E=>x(E.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:E=>E.key==="Enter"&&S(),"data-test":"session-description-input"}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:S,children:a.jsx(ct,{className:"w-3 h-3 text-green-600"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{u(!1),x(s.description)},children:a.jsx(ht,{className:"w-3 h-3 text-gray-500"})})]}):a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm flex-1 text-gray-600","data-test":"session-description-display",children:s.description||"(no description)"}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>u(!0),"data-test":"edit-session-description",children:a.jsx(kn,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("label",{className:"text-xs text-gray-500",children:["Interactions (",s.interactions.length,")"]})}),a.jsxs("div",{className:"space-y-1","data-test":"session-interactions-list",children:[a.jsx(Ro,{index:0,onAddManual:()=>y(0),onAddRecord:()=>i(0)}),s.interactions.map((E,R)=>a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50 group","data-test":"session-interaction",children:[a.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:Bn[E.type].bg,color:Bn[E.type].text},children:N(E.type)}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"text-xs font-medium",children:A(E)}),a.jsx("code",{className:"text-xs text-gray-400 truncate block",children:k(E)})]}),a.jsxs("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>v(R),title:"Edit","data-test":"edit-interaction-button",children:a.jsx(kn,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>c(R),title:"Replace by recording","data-test":"replace-interaction-button",children:a.jsx(On,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-red-500 hover:text-red-600",onClick:()=>r(R),title:"Delete","data-test":"delete-interaction-button",children:a.jsx(Et,{className:"w-3 h-3"})})]})]}),a.jsx(Ro,{index:R+1,onAddManual:()=>y(R+1),onAddRecord:()=>i(R+1)})]},`${E.timestamp}-${R}`))]})]})]})]})}function Ro({index:s,onAddManual:e,onAddRecord:t}){return a.jsx("div",{className:"flex items-center justify-center py-1 group opacity-0 hover:opacity-100 transition-opacity","data-test":"insert-point",children:a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsxs(ue,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-blue-500 hover:text-blue-600 hover:bg-blue-50",onClick:e,title:"Add manually","data-test":"insert-manual-button",children:[a.jsx(Ks,{className:"w-3 h-3 mr-1"}),"Manual"]}),a.jsxs(ue,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-green-500 hover:text-green-600 hover:bg-green-50",onClick:t,title:"Record new action","data-test":"insert-record-button",children:[a.jsx(Ys,{className:"w-3 h-3 mr-1"}),"Record"]})]})})}function Cf({isOpen:s,savedSessions:e,onLoad:t,onDelete:n,onUpdateSession:r,onUpdateInteraction:o,onDeleteInteraction:i,onInsertInteraction:c,onStartInsertRecord:l,onStartReplaceRecord:d,onClose:p,portalContainer:u}){const[f,m]=h.useState(null);if(!s)return null;const g=f?e.find(v=>v.id===f):null,x=v=>new Date(v).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),b=()=>{m(null)};return g?a.jsx(os,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:500},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:a.jsx(jf,{session:g,onBack:b,onUpdateSession:v=>r(g.id,v),onUpdateInteraction:(v,w)=>o(g.id,v,w),onDeleteInteraction:v=>i(g.id,v),onInsertInteraction:(v,w)=>c(g.id,v,w),onStartInsertRecord:v=>l(g.id,v),onStartReplaceRecord:v=>d(g.id,v)})}):a.jsx(os,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:400},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:a.jsx("div",{className:"p-3 h-full overflow-auto","data-test":"session-manager-body",children:e.length===0?a.jsx("div",{className:"text-sm italic text-center py-8 text-gray-400","data-test":"session-manager-empty",children:"No saved sessions yet"}):a.jsx("div",{className:"space-y-2","data-test":"session-manager-list",children:e.map(v=>a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50","data-test":"session-item",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"text-sm font-medium truncate","data-test":"session-name",children:v.name}),v.description&&a.jsx("div",{className:"text-xs text-gray-500 truncate","data-test":"session-description",children:v.description}),a.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-2",children:[a.jsx("span",{"data-test":"session-date",children:x(v.savedAt)}),a.jsx("span",{children:"Â·"}),a.jsxs("span",{"data-test":"session-interaction-count",children:[v.interactions.length," interaction",v.interactions.length!==1?"s":""]})]})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>t(v.id),title:"Load session","data-test":"session-load",children:a.jsx(nc,{className:"w-4 h-4 text-blue-500"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>m(v.id),title:"Edit session","data-test":"session-edit",children:a.jsx(kn,{className:"w-4 h-4 text-gray-500"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>n(v.id),title:"Delete session","data-test":"session-delete",children:a.jsx(Et,{className:"w-4 h-4 text-red-500"})})]})]},v.id))})})})}function Do({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1),[r,o]=h.useState(!1),[i,c]=h.useState(!1),[l,d]=h.useState(""),[p,u]=h.useState(""),[f,m]=h.useState({type:"none"}),{interactions:g,isRecording:x,startRecording:b,stopRecording:v,clearRecording:w}=df({targetRef:null,enabled:!0}),y=vf();h.useCallback(te=>{f.type==="insert"?(y.insertInteraction(f.sessionId,f.atIndex,te),m({type:"none"}),v(),ke.success("Interaction inserted!")):f.type==="replace"&&(y.replaceInteraction(f.sessionId,f.atIndex,te),m({type:"none"}),v(),ke.success("Interaction replaced!"))},[f,y,v]);const j=h.useCallback(()=>{x?(v(),n(!1),ke.success(`Stopped recording. Captured ${g.length} interactions.`)):(b(),n(!1),ke.info("Recording started. Click, drag, or type to capture."))},[x,g.length,b,v]),S=h.useCallback(()=>{const te={interactions:g,exportedAt:new Date().toISOString(),url:window.location.href},O=new Blob([JSON.stringify(te,null,2)],{type:"application/json"}),ee=URL.createObjectURL(O),I=document.createElement("a");I.href=ee,I.download=`recording-${Date.now()}.json`,I.click(),URL.revokeObjectURL(ee),ke.success("Recording exported!")},[g]),C=h.useCallback(()=>{w(),ke.success("Recording cleared")},[w]),N=h.useCallback(()=>{n(!1)},[]),A=h.useCallback(()=>{n(!0)},[]),k=h.useCallback(()=>{if(g.length===0){ke.error("No interactions to save");return}d(`Session ${new Date().toLocaleString()}`),u(""),c(!0)},[g.length]),E=h.useCallback(()=>{if(!l.trim()){ke.error("Please enter a name");return}y.saveSession(l.trim(),p.trim(),g),c(!1),d(""),u("")},[l,p,g,y]),R=h.useCallback(()=>{const te=y.getLastSession();te?(w(),ke.info(`Would load session: ${te.name}`)):ke.info("No saved sessions. Use 'Manage Sessions' to view all.")},[y,w]),M=h.useCallback(()=>{o(!0)},[]),L=h.useCallback(te=>{const O=y.loadSession(te);O&&(w(),ke.success(`Loaded: ${O.name}`),o(!1))},[y,w]),T=h.useCallback((te,O)=>{m({type:"insert",sessionId:te,atIndex:O}),b(),o(!1),ke.info("Recording... Perform an action to insert it.")},[b]),W=h.useCallback((te,O)=>{m({type:"replace",sessionId:te,atIndex:O}),b(),o(!1),ke.info("Recording... Perform an action to replace.")},[b]),z=a.jsxs(a.Fragment,{children:[a.jsxs(ue,{variant:x?"destructive":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:j,"data-test":"record-toggle-button",children:[a.jsx(Ys,{className:"w-3 h-3 mr-1",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0}),x?"Stop":"Record"]}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:S,disabled:g.length===0,title:"Export as JSON","data-test":"export-recording-button",children:a.jsx(Ia,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:C,disabled:g.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:a.jsx(Et,{className:"w-3 h-3"})}),a.jsx(yf,{onSaveSession:k,onLoadSession:R,onManageSessions:M})]});return a.jsxs(a.Fragment,{children:[a.jsx(ue,{variant:s,size:e,onClick:x?j:A,title:x?"Stop Recording":"Open Recorder","data-test":"global-record-button",className:x?"text-red-500 hover:text-red-400":"",children:a.jsx(Ys,{className:"h-5 w-5",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0})}),x&&a.jsx("div",{className:"fixed inset-0 z-40 pointer-events-none",style:{backgroundColor:"rgba(220, 38, 38, 0.03)"},"data-test":"global-recording-overlay"}),f.type!=="none"&&a.jsxs("div",{className:"fixed top-2 left-1/2 -translate-x-1/2 z-50 bg-blue-500 text-white px-3 py-1 rounded-full text-sm animate-pulse","data-test":"edit-mode-indicator",children:[f.type==="insert"?"Recording to insert...":"Recording to replace...",a.jsx(ue,{variant:"ghost",size:"sm",className:"ml-2 h-5 px-2 text-white hover:text-white hover:bg-blue-600",onClick:()=>{m({type:"none"}),v()},children:"Cancel"})]}),a.jsx(os,{isVisible:t,onClose:N,title:`Recorder ${g.length>0?`(${g.length})`:""}`,shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth-420,y:60},initialSize:{width:400,height:350},showPinButton:!1,headerActions:z,children:a.jsx(xf,{interactions:g,isRecording:x,onExport:S,onClear:C})}),a.jsx(os,{isVisible:i,onClose:()=>c(!1),title:"Save Session",initialPosition:{x:window.innerWidth/2-175,y:150},initialSize:{width:350,height:220},shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,children:a.jsxs("div",{className:"p-4 space-y-3","data-test":"save-session-dialog",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-sm",children:"Name"}),a.jsx(We,{value:l,onChange:te=>d(te.target.value),placeholder:"Session name",autoFocus:!0,"data-test":"save-session-name"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-sm",children:"Description (optional)"}),a.jsx(We,{value:p,onChange:te=>u(te.target.value),placeholder:"Brief description","data-test":"save-session-description"})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx(ue,{variant:"ghost",size:"sm",onClick:()=>c(!1),"data-test":"save-session-cancel",children:"Cancel"}),a.jsxs(ue,{size:"sm",onClick:E,"data-test":"save-session-confirm",children:["Save (",g.length," interactions)"]})]})]})}),a.jsx(Cf,{isOpen:r,savedSessions:y.savedSessions,onLoad:L,onDelete:y.deleteSession,onUpdateSession:y.updateSession,onUpdateInteraction:y.updateInteraction,onDeleteInteraction:y.deleteInteraction,onInsertInteraction:y.insertInteraction,onStartInsertRecord:T,onStartReplaceRecord:W,onClose:()=>o(!1)})]})}const Ct=h.forwardRef(({className:s,...e},t)=>a.jsx(Oi,{ref:t,className:U("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...e,children:a.jsx(Du,{className:U("flex items-center justify-center text-current"),children:a.jsx(ct,{className:"h-4 w-4"})})}));Ct.displayName=Oi.displayName;const Nf=ln("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}}),pt=h.forwardRef(({className:s,variant:e,...t},n)=>a.jsx("div",{ref:n,className:U(Nf({variant:e}),s),...t}));pt.displayName="Badge";function Zr({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1,contentStyle:o}){const[i,c]=h.useState(!1),[l,d]=h.useState(""),p=e.find(m=>m.value===s),u=e.filter(m=>m.label.toLowerCase().includes(l.toLowerCase())),f=m=>{t==null||t(m),c(!1),d("")};return p?a.jsxs(st,{open:i,onOpenChange:c,children:[a.jsx(ut,{asChild:!0,children:a.jsx(pt,{variant:p.variant||"secondary",className:U("cursor-pointer hover:opacity-80 transition-opacity",p.className,r&&"opacity-50 cursor-not-allowed"),onClick:m=>{m.stopPropagation(),r&&m.preventDefault()},children:p.label})}),a.jsx(Xe,{className:"popover-content w-64 p-2",align:"start",style:o,children:a.jsxs("div",{className:"selector-container space-y-2",children:[a.jsx(We,{placeholder:n,value:l,onChange:m=>d(m.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),a.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(m=>a.jsxs(ue,{variant:"ghost",className:U("option-item w-full justify-between h-8 px-2",m.value===s&&"bg-accent"),onClick:()=>f(m.value),children:[a.jsx(pt,{variant:m.variant||"secondary",className:U("text-xs",m.className),children:m.label}),m.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4"})]},m.value))})]})})]}):null}const cr=h.forwardRef(({className:s,...e},t)=>a.jsx(mt,{ref:t,className:U("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...e}));cr.displayName=mt.displayName;const Ac=({children:s,value:e,onValueChange:t,filter:n,shouldFilter:r,...o})=>a.jsx(Fn,{modal:!1,...o,children:a.jsx(ka,{children:a.jsxs(cn,{className:U("overflow-hidden p-0 fixed inset-x-0 top-[10%] mx-auto max-w-2xl w-full","gap-4 border bg-background shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:slide-out-to-top-8 data-[state=open]:slide-in-from-top-8","sm:rounded-lg"),style:{zIndex:tt.commandPalette},"data-test":"command-dialog",children:[a.jsx(Zs,{className:"sr-only",children:"Command Palette"}),a.jsx(cr,{value:e,onValueChange:t,filter:n,shouldFilter:r,className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-1.5 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:s}),a.jsxs(Ea,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ht,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})})}),lr=h.forwardRef(({className:s,...e},t)=>a.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[a.jsx(or,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),a.jsx(mt.Input,{ref:t,className:U("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...e})]}));lr.displayName=mt.Input.displayName;const un=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.List,{ref:t,className:U("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...e}));un.displayName=mt.List.displayName;const pn=h.forwardRef((s,e)=>a.jsx(mt.Empty,{ref:e,className:"py-6 text-center text-sm",...s}));pn.displayName=mt.Empty.displayName;const Ts=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.Group,{ref:t,className:U("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...e}));Ts.displayName=mt.Group.displayName;const ea=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.Separator,{ref:t,className:U("-mx-1 h-px bg-border",s),...e}));ea.displayName=mt.Separator.displayName;const is=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.Item,{ref:t,className:U("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s),...e}));is.displayName=mt.Item.displayName;const Yt="__no_project__",kf=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},Ef=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},If=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},Tf=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath};function Pc({variant:s="badge",className:e,multiSelect:t=!1,value:n,onChange:r}){const[o,i]=h.useState(!1),c=r!==void 0,l=Le(kf),d=Le(Ef),p=Le(If),u=Le(Tf),f=c?n:u,m=t?Array.isArray(f)?f:f?[f]:[]:null,g=h.useCallback(w=>{var S,C,N;const y=l.find(A=>A.id===w||A.path===w),j=(y==null?void 0:y.path)??w;if(c)r(w);else{const A=ie.getState();ie.updateState({app:{...A.app,claude:{...(S=A.app)==null?void 0:S.claude,ui:{...(N=(C=A.app)==null?void 0:C.claude)==null?void 0:N.ui,selectedProjectPath:j}}}})}},[c,r,l]),x=h.useCallback(w=>{if(!t||!m)return;const y=l.find(C=>C.id===w||C.path===w),j=(y==null?void 0:y.path)??w,S=m.includes(j)?m.filter(C=>C!==j):[...m,j];c&&r(S)},[t,m,l,c,r]),b=h.useCallback(()=>{var w,y,j;if(c)r(t?[]:void 0);else{const S=ie.getState();ie.updateState({app:{...S.app,claude:{...(w=S.app)==null?void 0:w.claude,ui:{...(j=(y=S.app)==null?void 0:y.claude)==null?void 0:j.ui,selectedProjectPath:void 0}}}})}},[c,r,t]);if(h.useEffect(()=>{!c&&!d&&l.length>0&&!u&&g(l[0].path)},[c,d,l,u,g]),d)return a.jsx("div",{"data-test":"project-selector-loading",className:e,children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading projects..."})});if(p)return a.jsx("div",{"data-test":"project-selector-error",className:e,children:a.jsx("span",{className:"text-sm text-destructive",children:p})});if(l.length===0)return a.jsx("div",{"data-test":"project-selector-empty",className:e,children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"No projects found"})});const v=t?null:l.find(w=>w.path===f||w.id===f);if(t&&m){const w=l.filter(S=>m.includes(S.path)),y=m.includes(Yt),j=m.length>0;return a.jsxs("div",{"data-test":"project-selector-multi",className:"project-selector-multi-wrapper",children:[a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(ue,{"data-test":"project-selector-trigger",variant:"outline",role:"combobox","aria-expanded":o,className:U("project-selector-trigger w-full justify-between",j&&"h-auto min-h-[40px] py-2"),disabled:d,children:[a.jsx("div",{className:"flex flex-wrap gap-1 flex-1 mr-2",children:j?a.jsxs(a.Fragment,{children:[y&&a.jsxs(pt,{"data-test":"project-badge-none",variant:"secondary",className:"selected-project-badge gap-1",children:["No project",a.jsx(ht,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:S=>{S.stopPropagation(),x(Yt)}})]}),w.map(S=>a.jsxs(pt,{"data-test":"project-badge",variant:"secondary",className:"selected-project-badge gap-1",children:[S.name,a.jsx(ht,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:C=>{C.stopPropagation(),x(S.path)}})]},S.id))]}):a.jsx("span",{className:"text-muted-foreground",children:"Select projects..."})}),a.jsx(rc,{className:"h-4 w-4 shrink-0 opacity-50"})]})}),a.jsx(Xe,{"data-test":"project-selector-content",className:"project-selector-content w-[400px] p-0",style:{zIndex:tt.tooltip},children:a.jsxs(cr,{children:[a.jsx(lr,{"data-test":"project-selector-search",placeholder:"Search projects..."}),a.jsxs(un,{className:"max-h-[300px]",children:[a.jsx(pn,{children:"No projects found."}),a.jsxs(Ts,{children:[a.jsxs(is,{"data-test":"project-selector-item-none",value:Yt,onSelect:()=>x(Yt),className:"project-selector-item cursor-pointer",children:[a.jsx(ct,{className:U("mr-2 h-4 w-4 shrink-0",m.includes(Yt)?"opacity-100":"opacity-0")}),a.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[a.jsx("span",{className:"project-name font-medium",children:"No project"}),a.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})]}),l.map(S=>a.jsxs(is,{"data-test":"project-selector-item",value:S.path,onSelect:()=>x(S.path),className:"project-selector-item cursor-pointer",children:[a.jsx(ct,{className:U("mr-2 h-4 w-4 shrink-0",m.includes(S.path)?"opacity-100":"opacity-0")}),a.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[a.jsx("span",{className:"project-name font-medium",children:S.name}),a.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[S.sessionCount," sessions"]})]})]},S.id))]})]})]})})]}),j&&a.jsxs(ue,{"data-test":"project-selector-clear-all",variant:"outline",size:"sm",onClick:b,className:"clear-all-button w-full mt-2",children:[a.jsx(ht,{className:"h-4 w-4 mr-2"}),"Clear all (",m.length,")"]})]})}if(s==="badge"&&!t){const w=typeof f=="string"?f:void 0,y=[{value:Yt,label:"No project",variant:"secondary"},...l.map(j=>({value:j.path,label:`${j.name} (${j.sessionCount})`,variant:"secondary"}))];return a.jsx(Zr,{"data-test":"project-selector-badge",value:w??l[0].path,options:y,onChange:g,placeholder:"Search projects..."})}if(!t){const w=typeof f=="string"?f:void 0;return a.jsxs("div",{"data-test":"project-selector-select",className:"project-selector-wrapper flex gap-2",children:[a.jsxs(Ut,{value:w??l[0].path,onValueChange:g,children:[a.jsx(It,{"data-test":"project-selector-trigger",className:e,children:a.jsx(Jt,{children:w===Yt?"No project":v?`${v.name} (${v.sessionCount})`:"Select project"})}),a.jsxs(Tt,{children:[a.jsx(Oe,{"data-test":"project-selector-item-none",value:Yt,children:a.jsxs("div",{className:"project-option flex flex-col items-start",children:[a.jsx("span",{className:"project-name font-medium",children:"No project"}),a.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})},Yt),l.map(y=>a.jsx(Oe,{"data-test":"project-selector-item",value:y.path,children:a.jsxs("div",{className:"project-option flex flex-col items-start",children:[a.jsx("span",{className:"project-name font-medium",children:y.name}),a.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[y.sessionCount," sessions"]})]})},y.id))]})]}),w&&a.jsx(ue,{"data-test":"project-selector-clear",variant:"outline",size:"icon",onClick:b,className:"clear-project-button shrink-0",title:"Clear project filter",children:a.jsx(ht,{className:"h-4 w-4"})})]})}return null}const dr=h.forwardRef(({label:s,onAction:e,configOptions:t=[],popoverContent:n,longPressDuration:r=400,showStaticGear:o=!1,showHint:i=!1,enableOnboarding:c=!1,tooltipText:l,ariaLabel:d,variant:p="secondary",size:u="default",disabled:f=!1,className:m,compact:g=!1,buttonClassName:x,...b},v)=>{const[w,y]=h.useState(!1),[j,S]=h.useState(!1),[C,N]=h.useState(!1),[A,k]=h.useState(0),[E,R]=h.useState(c),M=h.useRef(null),L=h.useRef(null),T=h.useRef(0),W=h.useRef(!1),z=h.useRef(!1),te=h.useRef(null),O=h.useRef(null),ee=h.useRef(null),I=h.useCallback(()=>{M.current&&(clearTimeout(M.current),M.current=null),L.current&&(clearInterval(L.current),L.current=null),y(!1),k(0)},[]);h.useEffect(()=>I,[I]),h.useEffect(()=>{f&&(I(),S(!1))},[f,I]),h.useEffect(()=>{if(!j||C)return;const ce=Ae=>{var ve,$;const Ce=Ae.target;(ve=ee.current)!=null&&ve.contains(Ce)||($=O.current)!=null&&$.contains(Ce)||S(!1)};return document.addEventListener("mousedown",ce),()=>{document.removeEventListener("mousedown",ce)}},[j,C]);const _=n!==void 0||t.length>0,F=h.useCallback(ce=>{if(!(f||!_)){if(ce.type==="touchstart"&&ce.preventDefault(),y(!0),S(!1),T.current=Date.now(),W.current=!1,z.current=!0,E&&R(!1),!g){const Ae=100/(r/16);L.current=setInterval(()=>{k(Ce=>{const ve=Ce+Ae;return ve>100?100:ve})},16)}M.current=setTimeout(()=>{g?N(!0):S(!0),k(0),L.current&&(clearInterval(L.current),L.current=null)},r)}},[f,_,r,E,g]),q=h.useCallback(()=>{if(f)return;Date.now()-T.current<r&&!j?(W.current=!0,e()):W.current=!0,I()},[f,r,j,e,I]),J=h.useCallback(()=>{f||(z.current||e(),z.current=!1)},[f,e]),P=h.useCallback(()=>{f||j||I()},[f,j,I]),B=h.useCallback(ce=>{ce.stopPropagation(),N(!0)},[]),se=h.useCallback(ce=>{ce.onClick(),N(!1),S(!1)},[]),le=20,me=2*Math.PI*le,ae=me-A/100*me,H=`${s} (Click) / Configure (Hold)`,X=l??H,ge=a.jsxs(ue,{ref:te,variant:p,size:u,disabled:f,className:U("button-main relative transition-all",w&&"scale-95",!g&&i&&_&&"pr-8",x),onPointerDown:F,onPointerUp:q,onPointerLeave:P,onClick:J,"aria-label":d||(typeof s=="string"?`Button: ${s}. Secondary action: long press for configuration`:"Button with configuration options"),"aria-pressed":w,"aria-expanded":C,"aria-haspopup":"menu",...b,children:[s,!g&&i&&_&&a.jsx(pp,{className:"hint-icon absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 opacity-30"})]});return g?a.jsxs("div",{ref:v,className:U("relative inline-flex items-center",m),children:[a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:ge}),a.jsx(Kt,{children:a.jsx("p",{children:X})})]})}),a.jsxs(st,{open:C,onOpenChange:ce=>{N(ce)},children:[a.jsx(ut,{asChild:!0,children:a.jsx("span",{className:"absolute inset-0 pointer-events-none","aria-hidden":"true"})}),a.jsx(Xe,{align:"end",className:U("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ce,Ae)=>a.jsxs("button",{onClick:()=>se(ce),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ce.icon&&a.jsx("span",{className:"shrink-0",children:ce.icon}),a.jsx("span",{children:ce.label})]},ce.value??Ae))})})]})]}):a.jsxs("div",{ref:v,className:U("relative inline-flex items-center gap-2",m),children:[a.jsx(ss,{children:a.jsxs(ns,{open:E?!0:j?!1:void 0,children:[a.jsx(rs,{asChild:!0,children:a.jsxs("div",{ref:ee,className:"button-container relative inline-block",children:[w&&A>0&&a.jsx("svg",{className:"progress-ring absolute inset-0 pointer-events-none",width:"100%",height:"100%",style:{transform:"rotate(-90deg)"},children:a.jsx("circle",{className:"progress-ring-circle stroke-primary/30",strokeWidth:"3",fill:"transparent",r:le,cx:"50%",cy:"50%",style:{strokeDasharray:me,strokeDashoffset:ae,transition:"stroke-dashoffset 16ms linear"}})}),ge,j&&!o&&a.jsxs(st,{open:C,onOpenChange:ce=>{N(ce),ce||S(!1)},children:[a.jsx(ut,{asChild:!0,children:a.jsx("button",{ref:O,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200","aria-label":"Open configuration",children:a.jsx(Vt,{className:"h-4 w-4"})})}),a.jsx(Xe,{align:"end",className:U("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ce,Ae)=>a.jsxs("button",{onClick:()=>se(ce),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ce.icon&&a.jsx("span",{className:"shrink-0",children:ce.icon}),a.jsx("span",{children:ce.label})]},ce.value??Ae))})})]}),j&&o&&a.jsx("button",{ref:O,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200",onClick:B,onTouchEnd:ce=>{ce.preventDefault(),B(ce)},"aria-label":"Open configuration",children:a.jsx(Vt,{className:"h-4 w-4"})})]})}),a.jsx(Kt,{children:a.jsx("p",{children:E?"Try holding this button for advanced settings":X})})]})}),o&&_&&a.jsxs(st,{open:C,onOpenChange:ce=>{N(ce),ce||S(!1)},children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:"ghost",size:"icon",className:"static-gear h-8 w-8 shrink-0",disabled:f,"aria-label":"Configure",tabIndex:0,children:a.jsx(Vt,{className:"h-4 w-4"})})}),a.jsx(Xe,{align:"end",className:U("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ce,Ae)=>a.jsxs("button",{onClick:()=>se(ce),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ce.icon&&a.jsx("span",{className:"shrink-0",children:ce.icon}),a.jsx("span",{children:ce.label})]},ce.value??Ae))})})]})]})});dr.displayName="ConfigurableButton";const Af="â€‹";function Pf(s){return s.replace(new RegExp(Af,"g"),"")}function _o(s){const e=/^(\s*)/.exec(s);return e?e[1]:""}function ur(s){const e=/^(\s*)(\d+)\.\s*(.*)$/.exec(s);if(e)return{type:"numbered",indent:e[1],number:parseInt(e[2],10),fullMatch:e[0].replace(e[3],""),contentAfterPrefix:e[3]};const t=/^(\s*)-\s*(.*)$/.exec(s);return t?{type:"dash",indent:t[1],fullMatch:t[0].replace(t[2],""),contentAfterPrefix:t[2]}:{type:"none",indent:"",fullMatch:"",contentAfterPrefix:s}}function Rf(s,e,t,n){if(s.trim()==="")return{type:"newline",textToInsert:`
`};const r=ur(s);if(r.type==="none")return{type:"continue",textToInsert:`
`+_o(s)};if(!(r.contentAfterPrefix.trim().length>0)){const l=r.fullMatch.length;if(r.type==="numbered"){const d=Df(t,n,r.indent,r.number??1);return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l,textAfterCursor:d}}return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l}}if(Pf(e.split(`
`)[0]).trim().length>0)return{type:"continue",textToInsert:`
`+_o(s)};if(r.type==="numbered"){const l=(r.number??0)+1,d=`
${r.indent}${l}. `,p=_f(t,n,r.indent,l);return{type:"continue",textToInsert:d,textAfterCursor:p}}return{type:"continue",textToInsert:`
${r.indent}- `}}function Df(s,e,t,n){const o=s.substring(e).split(`
`);let i=!1,c=n-1;const l=[];for(let d=0;d<o.length;d++){const p=o[d],u=ur(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...o.slice(d));break}else if(p.trim()===""&&d<o.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...o.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function _f(s,e,t,n){const o=s.substring(e).split(`
`);let i=!1,c=n;const l=[];for(let d=0;d<o.length;d++){const p=o[d],u=ur(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...o.slice(d));break}else if(p.trim()===""&&d<o.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...o.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function Rc(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=n===-1?s.length:n;return{lineStart:t,lineEnd:r,currentLine:s.substring(t,r),textBeforeLine:s.substring(0,t),textAfterLine:s.substring(r)}}function Dc(s,e){if(e===0)return{type:"default"};const{lineStart:t,currentLine:n}=Rc(s,e),r=e-t,o=ur(n);if(o.type==="none")return{type:"default"};const i=o.fullMatch.length;if(r<=i&&r>0){const c=e-1;return{type:"delete-char",newText:s.substring(0,c)+s.substring(e),newCursorPos:c}}return{type:"default"}}const Of={b:"**",i:"*","`":"`"},Lf={"*":"*",_:"*","`":"`"};function _c(s,e,t){const{lineStart:n,textAfterLine:r}=Rc(s,e),o=s.substring(n,e),i=s.substring(e,s.indexOf(`
`,e)===-1?s.length:s.indexOf(`
`,e)),c=Rf(o,i+r,s,e);if(c.type==="remove-prefix"){const l=c.charsToRemoveBeforeCursor??0,d=e-l;return{selectionStart:d,selectionEnd:e,textToInsert:c.textToInsert,newCursorPosition:d+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}}return c.type==="continue"?{selectionStart:e,selectionEnd:t,textToInsert:c.textToInsert,newCursorPosition:e+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}:{selectionStart:e,selectionEnd:t,textToInsert:`
`,newCursorPosition:e+1}}function Oc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r="  ",o=e+2;return{selectionStart:n,selectionEnd:n,textToInsert:r,newCursorPosition:o}}function Lc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r=s.indexOf(`
`,e),o=r===-1?s.length:r,i=s.substring(n,o);let c=0;for(let d=0;d<Math.min(2,i.length)&&i[d]===" ";d++)c++;if(c===0)return{selectionStart:e,selectionEnd:t,textToInsert:"",newCursorPosition:e};const l=Math.max(n,e-c);return{selectionStart:n,selectionEnd:n+c,textToInsert:"",newCursorPosition:l}}function Oo(s,e,t,n){const r=s.substring(e,t),o=`${n}${r}${n}`;return{selectionStart:e,selectionEnd:t,textToInsert:o,newCursorPosition:e+o.length}}function Mf(s){return Of[s.toLowerCase()]}function Ff(s){return Lf[s]}function $f(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=s.substring(t,n===-1?s.length:n),o=r.trim();if(!o.startsWith("|")||!o.endsWith("|"))return null;const i=o.split("|").slice(1,-1);if(i.length===0||i.every(u=>/^\s*:?-+:?\s*$/.test(u)))return null;const l=r.indexOf("|"),d=e-t;let p=l+1;for(let u=0;u<i.length;u++){const f=i[u],m=p+f.length;if(d>=p&&d<=m){const g=f.trim(),x=f.length-f.trimStart().length,b=d-p;if(g.length===0)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(b===x&&x>0)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(b>0&&b<x)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(b===0)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(x===0&&b>=1&&g.length>=1){const v=s[e],w=g[b],y=b>=g.length;if(w!==void 0&&v===w||y)if(u>0){const S=i[u-1],N=p-1-S.length+S.trimEnd().length;return{newText:s,newCursorPos:t+N}}else return{newText:s,newCursorPos:e}}break}p=m+1}return null}function Uf(s,e){if(s[e-1]!==`
`)return null;const t=s.substring(0,e-1),n=t.lastIndexOf(`
`)+1,o=t.substring(n).trimEnd();if(!o.endsWith("|")||!o.includes("|")||o.split("|").slice(1,-1).every(v=>/^\s*:?-+:?\s*$/.test(v)))return null;const l=s.substring(e),d=l.indexOf(`
`),p=d===-1?l:l.substring(0,d),u=d===-1?"":l.substring(d),f=n+o.lastIndexOf("|");let m=s.substring(0,f);m.match(/\s+$/)&&(m=m.trimEnd());const x=m+p+" |"+u,b=m.length;return{newText:x,newCursorPos:b}}function Bf(s,e,t){if(e!==t||e===0)return null;const n=Uf(s,e);if(n)return{selectionStart:0,selectionEnd:s.length,textToInsert:n.newText,newCursorPosition:n.newCursorPos};const r=$f(s,e);if(r)return{selectionStart:0,selectionEnd:s.length,textToInsert:r.newText,newCursorPosition:r.newCursorPos};const o=Dc(s,e);return o.type==="delete-char"&&o.newText!==void 0?{selectionStart:0,selectionEnd:s.length,textToInsert:o.newText,newCursorPosition:o.newCursorPos??e-1}:{selectionStart:e-1,selectionEnd:e,textToInsert:"",newCursorPosition:e-1}}function Wf(s){return["b","i","`"].includes(s.toLowerCase())}const Mc=h.forwardRef(({value:s,defaultValue:e,onChange:t,placeholder:n,onClick:r,onMouseDown:o,onMouseUp:i,onPaste:c,onKeyDown:l,onKeyUp:d,onBlur:p,rows:u=4,className:f="",readOnly:m=!1,disabled:g=!1,...x},b)=>{const v=w=>{if(l==null||l(w),w.defaultPrevented)return;const y=w.currentTarget,{selectionStart:j,selectionEnd:S}=y,C=y.value;if(w.key==="Enter"){w.preventDefault();const N=_c(C,j,S);if(y.focus(),y.setSelectionRange(N.selectionStart,N.selectionEnd),N.replaceTextAfterCursor!==void 0){const k=C.substring(0,N.selectionStart)+N.textToInsert+N.replaceTextAfterCursor;y.value=k,y.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:y,currentTarget:y})}else if(N.selectionStart!==N.selectionEnd&&N.textToInsert===""){const A=C.substring(0,N.selectionStart)+C.substring(N.selectionEnd);y.value=A,y.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:y,currentTarget:y})}else{if(!document.execCommand("insertText",!1,N.textToInsert)&&t){const k=C.substring(0,N.selectionStart)+N.textToInsert+C.substring(N.selectionEnd);y.value=k,t({target:y,currentTarget:y})}y.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}}if(w.key==="Backspace"){const N=Dc(C,j);if(N.type==="delete-char"&&N.newText!==void 0&&N.newCursorPos!==void 0){w.preventDefault(),y.value=N.newText,y.setSelectionRange(N.newCursorPos,N.newCursorPos),t&&t({target:y,currentTarget:y});return}}if(w.key==="Tab"){w.preventDefault();const N=w.shiftKey?Lc(C,j,S):Oc(C,j);if(y.focus(),y.setSelectionRange(N.selectionStart,N.selectionEnd),!document.execCommand("insertText",!1,N.textToInsert)&&t){const k=C.substring(0,N.selectionStart)+N.textToInsert+C.substring(N.selectionEnd);y.value=k,t({target:y,currentTarget:y})}y.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}};return a.jsx("textarea",{ref:b,value:s,defaultValue:e,onChange:t,onKeyDown:v,autoCorrect:"off",onKeyUp:d,placeholder:n,onClick:r,onMouseDown:o,onMouseUp:i,onPaste:c,onBlur:p,rows:u,className:U(Xp.textarea,f),readOnly:m,disabled:g,"data-test":x["data-test"],...x})});Mc.displayName="RichTextarea";const hn=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:U("rounded-xl border bg-card text-card-foreground shadow",s),...e}));hn.displayName="Card";const La=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:U("flex flex-col space-y-1.5 p-6",s),...e}));La.displayName="CardHeader";const Ma=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:U("font-semibold leading-none tracking-tight",s),...e}));Ma.displayName="CardTitle";const zf=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:U("text-sm text-muted-foreground",s),...e}));zf.displayName="CardDescription";const fn=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:U("p-6 pt-0",s),...e}));fn.displayName="CardContent";const Hf=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:U("flex items-center p-6 pt-0",s),...e}));Hf.displayName="CardFooter";const Gf=_u,qf=Ou,tC=Mu,Vf=h.forwardRef(({className:s,inset:e,children:t,...n},r)=>a.jsxs(Wi,{ref:r,className:U("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",s),...n,children:[t,a.jsx($t,{className:"ml-auto"})]}));Vf.displayName=Wi.displayName;const Kf=h.forwardRef(({className:s,...e},t)=>a.jsx(zi,{ref:t,className:U("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...e}));Kf.displayName=zi.displayName;const Fc=h.forwardRef(({className:s,sideOffset:e=4,...t},n)=>a.jsx(Lu,{children:a.jsx(Li,{ref:n,sideOffset:e,className:U("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...t})}));Fc.displayName=Li.displayName;const $c=h.forwardRef(({className:s,inset:e,...t},n)=>a.jsx(Mi,{ref:n,className:U("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",s),...t}));$c.displayName=Mi.displayName;const Jf=h.forwardRef(({className:s,children:e,checked:t,...n},r)=>a.jsxs(Fi,{ref:r,className:U("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),checked:t,...n,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx($i,{children:a.jsx(ct,{className:"h-4 w-4"})})}),e]}));Jf.displayName=Fi.displayName;const Yf=h.forwardRef(({className:s,children:e,...t},n)=>a.jsxs(Hi,{ref:n,className:U("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx($i,{children:a.jsx(Ys,{className:"h-2 w-2 fill-current"})})}),e]}));Yf.displayName=Hi.displayName;const Xf=h.forwardRef(({className:s,inset:e,...t},n)=>a.jsx(Ui,{ref:n,className:U("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",s),...t}));Xf.displayName=Ui.displayName;const Qf=h.forwardRef(({className:s,...e},t)=>a.jsx(Bi,{ref:t,className:U("-mx-1 my-1 h-px bg-muted",s),...e}));Qf.displayName=Bi.displayName;function Zf({onClick:s,label:e,icon:t,variant:n="default",size:r="sm",compact:o=!1,options:i=[],showDropdown:c=!0,className:l="",disabled:d=!1,contentStyle:p}){const u=c&&i.length>0,f="w-3 h-3",m=o?"w-2 h-2":"w-3 h-3";return a.jsxs("div",{className:U("split-button-group inline-flex",l),"data-test":"split-button-container",children:[a.jsxs(ue,{onClick:s,variant:n,size:r,disabled:d,className:U(o&&"h-5 px-1 min-w-0",u&&"rounded-r-none border-r-0"),"data-test":"split-button-main",children:[t&&a.jsx(t,{className:U(f,e&&"mr-1"),"data-test":"split-button-icon"}),e&&a.jsx("span",{className:o?"text-xs":"",children:e})]}),u&&a.jsxs(Gf,{children:[a.jsx(qf,{asChild:!0,children:a.jsx(ue,{variant:n,size:r,disabled:d,className:U("rounded-l-none",o?"h-5 px-0.5 min-w-0":"px-1"),"data-test":"split-button-dropdown-trigger",children:a.jsx(wt,{className:m,"data-test":"split-button-dropdown-icon"})})}),a.jsx(Fc,{align:"end",style:p,"data-test":"split-button-dropdown-menu",children:i.map((g,x)=>a.jsx($c,{onClick:g.onClick,className:"text-xs","data-test":"split-button-dropdown-option",children:g.label},x))})]})]})}async function Lo(s,e){try{e==null||e.info(`Converting ${s.type} (${s.size} bytes) to WAV`);const t=new(window.AudioContext||window.webkitAudioContext),n=await s.arrayBuffer(),r=await t.decodeAudioData(n);e==null||e.debug(`Decoded: ${r.duration}s, ${r.sampleRate}Hz, ${r.numberOfChannels}ch`);const o=r.numberOfChannels,i=r.sampleRate,c=r.length,l=new Float32Array(c*o);for(let u=0;u<o;u++){const f=r.getChannelData(u);for(let m=0;m<c;m++)l[m*o+u]=f[m]}const d=em(l,i,o),p=new Blob([d],{type:"audio/wav"});if(!p||p.size===0)throw new Error("Failed to create valid WAV blob");return e==null||e.info(`Conversion complete: ${p.size} bytes`),p}catch(t){throw e==null||e.error(`Audio conversion failed: ${t}`),t}}function em(s,e,t){const n=new ArrayBuffer(44+s.length*2),r=new DataView(n),o=(c,l)=>{for(let d=0;d<l.length;d++)r.setUint8(c+d,l.charCodeAt(d))};o(0,"RIFF"),r.setUint32(4,36+s.length*2,!0),o(8,"WAVE"),o(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,e,!0),r.setUint32(28,e*t*2,!0),r.setUint16(32,t*2,!0),r.setUint16(34,16,!0),o(36,"data"),r.setUint32(40,s.length*2,!0);let i=44;return s.forEach(c=>{const l=Math.max(-1,Math.min(1,c));r.setInt16(i,l*32767,!0),i+=2}),n}function tm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map((i,c)=>c===0?i.toLowerCase():i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function sm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function nm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.toLowerCase()).join("_")+t}function sC(s,e){switch(e){case"camel":return tm(s);case"pascal":return sm(s);case"snake":return nm(s);default:return s}}function Mo(s){return s.endsWith("...")?s.slice(0,-3).trim():s}function rm(s){return s.trim().endsWith(".")?s.slice(0,-1).trim():s}let am="transcriptions";const Fo=["ggml-large-v3","ggml-large-v3-q5_0","ggml-large-v3-turbo","ggml-distil-large-v3","distil-large-v3.5"];let om="ggml-distil-large-v3";const Uc={language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:om},im=["CÃ¡c báº¡n","CÃ¡c báº¡n nhá»› Ä‘Äƒng kÃ½ kÃªnh Ä‘á»ƒ á»§ng há»™ kÃªnh cá»§a mÃ¬nh nhÃ©! Háº¹n gáº·p láº¡i cÃ¡c báº¡n trong nhá»¯ng video tiáº¿p theo!","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi, quÃ½ vá»‹","Hi, quÃ½ vá»‹. Xin chÃ o táº¥t cáº£ cÃ¡c báº¡n","HÃ£y subscribe cho kÃªnh","HÃ£y subscribe cho kÃªnh Ghiá»n MÃ¬ GÃµ Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","HÃ£y subscribe cho kÃªnh La La School Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","lalaschool","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Cáº¢M Æ N CÃC Báº N ÄÃƒ THEO DÃ•I VÃ€ ÄÄ‚NG KÃ KÃŠNH NHÃ‰!"];class mn extends Error{constructor(e,t,n,r){super(e),this.code=t,this.statusCode=n,this.detail=r,this.name="PythonTranscribeApiError"}}class cm extends mn{constructor(e){super(e??"Bad Request - invalid file format or missing file","PTApi_BAD_REQUEST",400,e),this.name="PTApiBadRequestError"}}class lm extends mn{constructor(e){super(e??"Payload Too Large - file exceeds size limit","PTApi_PAYLOAD_TOO_LARGE",413,e),this.name="PTApiPayloadTooLargeError"}}class dm extends mn{constructor(e){super(e??"Internal Server Error - transcription service error","PTApi_INTERNAL_SERVER_ERROR",500,e),this.name="PTApiInternalServerError"}}class um extends mn{constructor(e,t){super(t??`HTTP error! status: ${e}`,"PTApi_HTTP_ERROR",e,t),this.name="PTApiHttpError"}}class Bc extends mn{constructor(){super("Transcription contains denied phrases.","PTApi_DENIED_PHRASES"),this.name="PTApiDeniedPhrasesError"}}const pm="PythonTranscribeApiService";class hm{constructor(){Z(this,"baseUrl");this.baseUrl="http://192.168.2.70:9876"}async transcribeAudio(e,t={}){t={...Uc,...t},Re.info(`ðŸ”¤ Transcription request payload: ${JSON.stringify({file:e.name,size:`${(e.size/1024).toFixed(1)}KB`,...t})}`,pm);const n=new FormData;t.language!==void 0&&n.append("language",t.language),t.translate!==void 0&&n.append("translate",t.translate.toString()),t.no_timestamps!==void 0&&n.append("no_timestamps",t.no_timestamps.toString()),t.no_prints!==void 0&&n.append("no_prints",t.no_prints.toString()),t.auto_detect_language!==void 0&&n.append("auto_detect_language",t.auto_detect_language.toString()),t.model!==void 0&&n.append("model",t.model),n.append("file",e);try{const r=await fetch(`${this.baseUrl}/${am}`,{method:"POST",body:n});if(!r.ok){const i=await r.json();switch(r.status){case 400:throw new cm(i.detail);case 413:throw new lm(i.detail);case 500:throw new dm(i.detail);default:throw new um(r.status,i.detail)}}const o=await r.json();if(o.transcription=rm(o.transcription),im.some(i=>o.transcription.toLowerCase().includes(i.toLowerCase())))throw new Bc;return o}catch(r){throw r}}setBaseUrl(e){this.baseUrl=e}}const Wc=new hm,vn={language:"auto",translate:!1,no_timestamps:!0,auto_detect_language:!0,word_level_timestamps:!1,split:!1},Wn={DEFAULT:{silenceThreshold:-20,minSilenceDuration:40,holdTime:100,padding:-60,waveformSamples:1e3},TIGHT:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3},LOOSE:{silenceThreshold:-30,minSilenceDuration:100,holdTime:200,padding:0,waveformSamples:1e3},WORD_STREAMING:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3}};class fm{constructor(e={}){Z(this,"defaultConfig");const t=Wn.DEFAULT;this.defaultConfig={silenceThreshold:e.silenceThreshold??t.silenceThreshold,minSilenceDuration:e.minSilenceDuration??t.minSilenceDuration,holdTime:e.holdTime??t.holdTime,padding:e.padding??t.padding,waveformSamples:e.waveformSamples??t.waveformSamples??1e3}}async analyzeAudio(e,t={}){const n={silenceThreshold:t.silenceThreshold??this.defaultConfig.silenceThreshold,minSilenceDuration:t.minSilenceDuration??this.defaultConfig.minSilenceDuration,holdTime:t.holdTime??this.defaultConfig.holdTime,padding:t.padding??this.defaultConfig.padding,waveformSamples:t.waveformSamples??this.defaultConfig.waveformSamples},r=this._generateWaveform(e,n.waveformSamples),o=this._normalize(r),i=this._toDbfs(o),c=this._detectActiveRegions(i,e.duration,n.silenceThreshold),l=this._mergeCloseRegions(c,n.holdTime),d=this._calculateSilences(l,e.duration*1e3),p=this._filterByDuration(d,n.minSilenceDuration),u=this._applySilencePadding(p,e.duration*1e3,n.padding);return this._getActiveRegions(u,e.duration)}_generateWaveform(e,t){const n=e.numberOfChannels,r=e.length,o=new Float32Array(r);for(let l=0;l<r;l++){let d=0;for(let p=0;p<n;p++)d+=e.getChannelData(p)[l];o[l]=d/n}const i=Math.max(1,Math.floor(r/t)),c=[];for(let l=0;l<t;l++){const d=l*i,p=Math.min(d+i,r);if(d<r&&p>d){let u=0;for(let m=d;m<p;m++)u+=Math.abs(o[m])**2;const f=Math.sqrt(u/(p-d));c.push(f)}else c.push(0)}return c}_normalize(e){const t=e.map(o=>isNaN(o)||!isFinite(o)?0:o),n=Math.max(...t),r=n>0?n:1;return t.map(o=>o/r)}_toDbfs(e){return e.map(n=>20*Math.log10(n+1e-10))}_detectActiveRegions(e,t,n){const r=e.map(l=>l>n),o=[];let i=!1,c=0;for(let l=0;l<r.length;l++)if(r[l]&&!i)c=l,i=!0;else if(!r[l]&&i){const d=l,p=c/e.length*t*1e3,u=d/e.length*t*1e3;o.push([p,u]),i=!1}if(i){const l=t*1e3,d=c/e.length*t*1e3;o.push([d,l])}return o}_mergeCloseRegions(e,t){if(e.length===0)return[];const n=[...e].sort((o,i)=>o[0]-i[0]),r=[n[0]];for(let o=1;o<n.length;o++){const[i,c]=n[o],l=r.length-1,[d,p]=r[l];i-p<=t?r[l]=[d,c]:r.push([i,c])}return r}_calculateSilences(e,t){const n=[];if(e.length===0)return[[0,t]];e[0][0]>0&&n.push([0,e[0][0]]);for(let o=0;o<e.length-1;o++){const i=e[o][1],c=e[o+1][0];c>i&&n.push([i,c])}const r=e[e.length-1][1];return r<t&&n.push([r,t]),n}_filterByDuration(e,t){return e.filter(([n,r])=>r-n>=t)}_applySilencePadding(e,t,n){if(n===0||e.length===0)return e;const r=[];for(let o=0;o<e.length;o++){const[i,c]=e[o];if(i===0){const d=Math.min(t,c+n);d>0&&r.push([0,d])}else if(o===e.length-1&&c===t){const l=Math.max(0,i-n),d=t;d>l&&r.push([l,d])}else{const l=Math.max(0,i-n),d=Math.min(t,c+n);d>l&&r.push([l,d])}}return r}_getActiveRegions(e,t){const n=[];if(e.length===0)return[[0,t]];const r=e.map(([i,c])=>[i/1e3,c/1e3]);r[0][0]>0&&n.push([0,r[0][0]]);for(let i=0;i<r.length-1;i++){const c=r[i][1],l=r[i+1][0];l>c&&n.push([c,l])}const o=r[r.length-1][1];return o<t&&n.push([o,t]),n}}class zc{constructor(e={}){Z(this,"detector");this.detector=new fm(e)}async chunkFile(e){const t=await e.arrayBuffer(),r=await new AudioContext().decodeAudioData(t);return this.chunkAudio(r)}async chunkAudio(e,t){return(await this.detector.analyzeAudio(e,t)).map((o,i)=>{const[c,l]=o,d=this._extractChunk(e,c,l);return{blob:this._audioBufferToWav(d),startTime:c,endTime:l,duration:l-c,index:i+1}})}_extractChunk(e,t,n){const r=e.sampleRate,o=Math.floor(t*r),c=Math.floor(n*r)-o,d=new AudioContext().createBuffer(e.numberOfChannels,c,r);for(let p=0;p<e.numberOfChannels;p++){const u=e.getChannelData(p),f=d.getChannelData(p);for(let m=0;m<c;m++)f[m]=u[o+m]}return d}_audioBufferToWav(e){const t=e.numberOfChannels,n=e.sampleRate,r=1,o=16,i=o/8,c=t*i,l=n*c,d=e.length*c,p=new ArrayBuffer(44+d),u=new DataView(p),f=(x,b)=>{for(let v=0;v<b.length;v++)u.setUint8(x+v,b.charCodeAt(v))};f(0,"RIFF"),u.setUint32(4,36+d,!0),f(8,"WAVE"),f(12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,r,!0),u.setUint16(22,t,!0),u.setUint32(24,n,!0),u.setUint32(28,l,!0),u.setUint16(32,c,!0),u.setUint16(34,o,!0),f(36,"data"),u.setUint32(40,d,!0);const m=[];for(let x=0;x<t;x++)m.push(e.getChannelData(x));let g=44;for(let x=0;x<e.length;x++)for(let b=0;b<t;b++){const v=Math.max(-1,Math.min(1,m[b][x])),w=v<0?v*32768:v*32767;u.setInt16(g,w,!0),g+=2}return new Blob([p],{type:"audio/wav"})}async getActiveRegions(e,t){return this.detector.analyzeAudio(e,t)}}const He="WebSocketTranscriptionService";class mm{constructor(e){Z(this,"ws",null);Z(this,"wsUrl");Z(this,"eventHandlers",{});Z(this,"isConnected",!1);Z(this,"reconnectAttempts",0);Z(this,"maxReconnectAttempts",3);Z(this,"reconnectDelay",1e3);this.wsUrl=e??"ws://192.168.2.70:9876/ws/transcribe"??"ws://localhost:9876/ws/transcribe"}setEventHandlers(e){this.eventHandlers=e}async connect(){return new Promise((e,t)=>{try{Re.info(`Connecting to WebSocket: ${this.wsUrl}`,He),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var n,r;Re.info("WebSocket connection opened",He),this.isConnected=!0,this.reconnectAttempts=0,(r=(n=this.eventHandlers).onConnectionOpen)==null||r.call(n),e()},this.ws.onmessage=n=>{this.handleMessage(n)},this.ws.onerror=n=>{var r,o;Re.error(`WebSocket error: ${n}`,He),(o=(r=this.eventHandlers).onConnectionError)==null||o.call(r,n),t(n)},this.ws.onclose=n=>{var r,o;Re.info(`WebSocket closed: code=${n.code}, reason=${n.reason}`,He),this.isConnected=!1,(o=(r=this.eventHandlers).onConnectionClose)==null||o.call(r,n.code,n.reason),this.reconnectAttempts<this.maxReconnectAttempts&&n.code!==1e3&&(this.reconnectAttempts++,Re.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,He),setTimeout(()=>{this.connect().catch(i=>{Re.error(`Reconnection failed: ${i}`,He)})},this.reconnectDelay))}}catch(n){Re.error(`Failed to create WebSocket connection: ${n}`,He),t(n)}})}handleMessage(e){var t,n,r,o,i,c,l,d,p,u;try{const f=JSON.parse(e.data);switch(f.type){case"progress":Re.info(`Progress: ${f.data.percentage}% - ${f.data.message}`,He),(n=(t=this.eventHandlers).onProgress)==null||n.call(t,f.data);break;case"word":Re.info(`Word: "${f.data.word}" [${f.data.start_time}s - ${f.data.end_time}s]`,He),(o=(r=this.eventHandlers).onWord)==null||o.call(r,f.data);break;case"segment":Re.info(`Segment ${f.data.segment}: "${f.data.transcription}"`,He),(c=(i=this.eventHandlers).onSegment)==null||c.call(i,f.data);break;case"complete":Re.info("Transcription complete",He),(d=(l=this.eventHandlers).onComplete)==null||d.call(l,f.data);break;case"error":Re.error(`Server error: ${f.data.message} (code: ${f.data.code})`,He),(u=(p=this.eventHandlers).onError)==null||u.call(p,f.data);break;default:Re.error(`Unknown message type: ${f.type}`,He)}}catch(f){Re.error(`Failed to parse message: ${f}`,He)}}async sendConfig(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"config",data:e};Re.info(`Sending config: ${JSON.stringify(e)}`,He),this.ws.send(JSON.stringify(t))}async sendAudioChunk(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"audio_chunk",data:{chunk:e}};Re.info(`Sending audio chunk (${e.length} chars)`,He),this.ws.send(JSON.stringify(t))}async sendAudioChunks(e){for(const t of e)await this.sendAudioChunk(t)}async startTranscription(){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const e={type:"start",data:{}};Re.info("Starting transcription",He),this.ws.send(JSON.stringify(e))}async transcribeAudioFile(e,t=vn){this.isConnected||await this.connect(),await this.sendConfig(t);const n=await e.arrayBuffer(),r=new Uint8Array(n);let o="";const i=r.byteLength;for(let l=0;l<i;l++)o+=String.fromCharCode(r[l]);const c=btoa(o);await this.sendAudioChunk(c),await this.startTranscription()}async transcribeAudioBlob(e,t=vn){const n=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFile(n,t)}async transcribeAudioFileWithChunking(e,t={...vn,word_level_timestamps:!0,split:!1},n=Wn.WORD_STREAMING){this.isConnected||await this.connect(),Re.info("Starting client-side silence-based chunking",He);const o=await new zc(n).chunkFile(e);Re.info(`Audio split into ${o.length} chunks (client-side)`,He);for(let i=0;i<o.length;i++){const c=o[i];await this._transcribeChunk(c,i+1,o.length,t)}Re.info("All chunks processed",He)}async _transcribeChunk(e,t,n,r){return new Promise((o,i)=>{Re.info(`Processing chunk ${t}/${n} (${e.startTime.toFixed(2)}s - ${e.endTime.toFixed(2)}s)`,He);const c=this.eventHandlers.onComplete,l=this.eventHandlers.onError;this.eventHandlers.onComplete=d=>{if(this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,c){const p={...d,metadata:{...d.metadata,chunk_index:t,chunk_start_time:e.startTime,chunk_end_time:e.endTime}};c(p)}Re.info(`Chunk ${t}/${n} transcription complete`,He),o()},this.eventHandlers.onError=d=>{this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,l&&l(d),Re.error(`Chunk ${t}/${n} transcription failed: ${d.message}`,He),i(new Error(d.message))},this._sendChunkTranscriptionRequest(e,r).catch(i)})}async _sendChunkTranscriptionRequest(e,t){const n={...t,split:!1};await this.sendConfig(n);const r=await e.blob.arrayBuffer(),o=new Uint8Array(r);let i="";const c=o.byteLength;for(let d=0;d<c;d++)i+=String.fromCharCode(o[d]);const l=btoa(i);await this.sendAudioChunk(l),await this.startTranscription()}async transcribeAudioBlobWithChunking(e,t={...vn,word_level_timestamps:!0,split:!1},n=Wn.WORD_STREAMING){const r=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFileWithChunking(r,t,n)}disconnect(){this.ws&&(Re.info("Disconnecting WebSocket",He),this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}setUrl(e){if(this.isConnected)throw Re.error("Cannot update URL while connected. Disconnect first.",He),new Error("Cannot update URL while connected");this.wsUrl=e,Re.info(`WebSocket URL updated to: ${this.wsUrl}`,He)}setMaxReconnectAttempts(e){this.maxReconnectAttempts=e}setReconnectDelay(e){this.reconnectDelay=e}}const gm=(s={})=>{const{onChunkCreated:e,onChunkUpdated:t,onChunkDeleted:n,onChunksLoaded:r,onError:o,sessionName:i="recording-session",enableAutoPersist:c=!0,enableAutoTranscription:l=!0,minChunkDuration:d=1e3,loadPersistedChunks:p=!0,skipLastSessionChunk:u=!1,transcribeOptions:f,useWebSocket:m=!1,onWordReceived:g,onTranscriptionProgress:x}=s,[b,v]=h.useState(!1),[w,y]=h.useState(!1),[j,S]=h.useState([]),[C,N]=h.useState(0),[A,k]=h.useState(null),E=h.useRef([]);h.useEffect(()=>{E.current=j},[j]);const R=h.useRef(f);h.useEffect(()=>{R.current=f},[f]);const M=h.useRef(null),L=h.useRef(null),T=h.useRef([]),W=h.useRef([]),z=h.useRef(null),te=h.useRef(null),O=h.useRef(null),ee=h.useRef(0),I=h.useRef(!1),_=h.useRef(null),F=h.useRef(null),q=h.useCallback($=>{const re=new Date().toISOString().slice(0,19).replace(/[:]/g,"-");return`${i}-chunk-${$.toString().padStart(3,"0")}-${re}`},[i]),J=h.useCallback(async()=>{if(p)try{const $=await bt.loadChunksBySession(i);if($.length===0)return;S($);const re=Math.max(...$.map(G=>G.chunkNumber),0);N(re),r==null||r($)}catch($){o==null||o(`Failed to load persisted chunks: ${$ instanceof Error?$.message:"Unknown error"}`)}},[i,p,r]);h.useEffect(()=>(m&&!_.current&&(_.current=new mm,_.current.setEventHandlers({onWord:$=>{const re=F.current;re&&(g==null||g($,re))},onProgress:$=>{const re=F.current;re&&(x==null||x($,re))},onComplete:$=>{const re=F.current;if(!re)return;const G=Mo($.transcription);S(oe=>{const de=oe.find(fe=>fe.id===re);if(!de)return oe;const pe={...de,transcription:G,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(pe)),oe.map(fe=>fe.id===re?pe:fe)}),c&&bt.updateChunkTranscription(re,G).catch(()=>{}),F.current=null},onError:$=>{const re=F.current;re&&(S(G=>{const oe=G.find(pe=>pe.id===re);if(!oe)return G;const de={...oe,transcriptionStatus:"failed",transcriptionError:$.message};return queueMicrotask(()=>t==null?void 0:t(de)),G.map(pe=>pe.id===re?de:pe)}),c&&bt.updateChunkTranscriptionStatus(re,"failed",$.message).catch(()=>{})),o==null||o($.message),F.current=null},onConnectionOpen:()=>{},onConnectionClose:()=>{},onConnectionError:()=>{o==null||o("WebSocket connection error")}})),()=>{_.current&&(_.current.disconnect(),_.current=null)}),[m,g,x,t,o,c]);const P=h.useCallback(async($,re,G,oe)=>{const de=oe||R.current,pe=E.current.find(be=>be.id===$);if(!pe||pe.transcriptionStatus==="processing"||pe.transcriptionStatus==="completed"&&pe.transcription)return;const fe={...pe,transcriptionStatus:"processing"};if(S(be=>(queueMicrotask(()=>t==null?void 0:t(fe)),be.map(Pe=>Pe.id===$?fe:Pe))),c)try{await bt.updateChunkTranscriptionStatus($,"processing")}catch{}if(m&&_.current){try{F.current=$,_.current.connected||await _.current.connect(),await _.current.transcribeAudioBlob(re,{language:(de==null?void 0:de.language)||"auto",word_level_timestamps:!0,no_timestamps:(de==null?void 0:de.no_timestamps)??!0,translate:(de==null?void 0:de.translate)??!1,auto_detect_language:(de==null?void 0:de.auto_detect_language)??!0})}catch(be){const Pe=be instanceof Error?be.message:"WebSocket transcription error";if(S(Ee=>{const V=Ee.find(Y=>Y.id===$);if(!V)return Ee;const D={...V,transcriptionStatus:"failed",transcriptionError:Pe};return queueMicrotask(()=>t==null?void 0:t(D)),Ee.map(Y=>Y.id===$?D:Y)}),c)try{await bt.updateChunkTranscriptionStatus($,"failed",Pe)}catch{}o==null||o(`WebSocket transcription failed for ${G}: ${Pe}`),F.current=null}return}try{const be=new File([re],`${G}.wav`,{type:"audio/wav"}),Pe=await Wc.transcribeAudio(be,de),Ee=Mo(Pe.transcription);if(S(V=>{const D=V.find(we=>we.id===$);if(!D)return V;const Y={...D,transcription:Ee,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(Y)),V.map(we=>we.id===$?Y:we)}),c)try{await bt.updateChunkTranscription($,Ee)}catch{}}catch(be){if(be instanceof Bc){if(console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Skipping chunk due to denied phrases:",G),S(Ee=>Ee.filter(V=>V.id!==$)),c)try{await bt.deleteChunk($)}catch(Ee){console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Failed to delete chunk from storage:",Ee)}n==null||n($);return}const Pe=be instanceof Error?be.message:"Unknown transcription error";if(S(Ee=>{const V=Ee.find(Y=>Y.id===$);if(!V)return Ee;const D={...V,transcriptionStatus:"failed",transcriptionError:Pe};return queueMicrotask(()=>t==null?void 0:t(D)),Ee.map(Y=>Y.id===$?D:Y)}),c)try{await bt.updateChunkTranscriptionStatus($,"failed",Pe)}catch{}o==null||o(`Transcription failed for ${G}: ${Pe}`)}},[c,t,m]),B=h.useCallback(async()=>{try{const $=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return L.current=$,!0}catch($){const re=$ instanceof Error?$.message:"Failed to access microphone";return k(re),o==null||o(re),!1}},[o]),se=h.useCallback(async()=>{if(!(!M.current||w))try{const $=ee.current+1,re={id:`segment-${crypto.randomUUID()}`,chunkNumber:$,startTime:new Date,name:q($)};O.current=re,y(!0)}catch($){const re=$ instanceof Error?$.message:"Failed to start segment recording";k(re),o==null||o(re),y(!1)}},[w,q,o]),le=h.useCallback(async()=>{if(!(!M.current||!w||!O.current))try{const $=O.current;O.current=null,y(!1),M.current.requestData(),await new Promise(Pe=>setTimeout(Pe,50));const re=new Date,G=re.getTime()-$.startTime.getTime();if(G<d){W.current=[];return}const oe=M.current.mimeType||"audio/webm",de=[];z.current&&de.push(z.current),de.push(...W.current);const pe=new Blob(de,{type:oe});let fe;try{fe=await Lo(pe)}catch{fe=pe}const be={...$,endTime:re,duration:G,blob:fe,size:fe.size,transcriptionStatus:l?"pending":void 0};if(S(Pe=>[...Pe,be]),E.current=[...E.current,be],ee.current=$.chunkNumber,N($.chunkNumber),W.current=[],c)try{await bt.saveChunk(be,i),e==null||e(be),l&&P(be.id,fe,be.name,R.current).catch(()=>{})}catch(Pe){const Ee=Pe instanceof Error?Pe.message:"Failed to save segment";k(Ee),o==null||o(Ee)}else e==null||e(be),l&&P(be.id,fe,be.name,R.current).catch(()=>{})}catch($){const re=$ instanceof Error?$.message:"Failed to stop segment";k(re),o==null||o(re),y(!1)}},[w,d,c,l,i,e,o,P]),me=h.useCallback(async()=>{if(!await B())return;const re=new Date().toISOString().slice(0,19).replace(/[:]/g,"-"),G={id:`session-${crypto.randomUUID()}`,chunkNumber:0,startTime:new Date,name:`${i}-session-${re}`};te.current=G,T.current=[],W.current=[],ee.current=0,z.current=null,I.current=!1;const de=["audio/webm;codecs=opus","audio/webm;codecs=vorbis","audio/webm","audio/ogg;codecs=opus","audio/mp4;codecs=mp4a.40.2","audio/mp4"].find(fe=>MediaRecorder.isTypeSupported(fe))??"audio/webm",pe=new MediaRecorder(L.current,{mimeType:de});M.current=pe,pe.ondataavailable=fe=>{if(fe.data.size>0){if(!I.current){z.current=fe.data,I.current=!0,T.current.push(fe.data);return}T.current.push(fe.data),W.current.push(fe.data)}},pe.onstop=async()=>{if(!te.current)return;if(u){te.current=null;return}const fe=new Blob(T.current,{type:de}),be=new Date,Pe=be.getTime()-te.current.startTime.getTime();let Ee;try{Ee=await Lo(fe)}catch{Ee=fe}const V={...te.current,endTime:be,duration:Pe,blob:Ee,size:Ee.size,transcriptionStatus:l?"pending":void 0};if(S(D=>[...D,V]),E.current=[...E.current,V],c)try{await bt.saveChunk(V,i),e==null||e(V),l&&P(V.id,Ee,V.name,R.current).catch(()=>{})}catch(D){const Y=D instanceof Error?D.message:"Failed to save session chunk";k(Y),o==null||o(Y)}else e==null||e(V);te.current=null},pe.onerror=()=>{k("Session recording failed"),o==null||o("Session recording failed")},pe.start(100),v(!0),k(null)},[B,i,c,l,u,e,o,P]),ae=h.useCallback(()=>{M.current&&M.current.state!=="inactive"&&M.current.stop(),v(!1),y(!1),L.current&&(L.current.getTracks().forEach($=>{$.stop()}),L.current=null)},[]),H=h.useCallback(()=>{b&&ae(),S([]),N(0),k(null),O.current=null,te.current=null},[b,ae]),X=h.useCallback(()=>{w&&(y(!1),O.current=null,W.current=[])},[w]),ge=h.useCallback(async $=>{if(S(re=>re.filter(G=>G.id!==$)),c)try{await bt.deleteChunk($)}catch(re){o==null||o(`Failed to delete chunk from storage: ${re instanceof Error?re.message:"Unknown error"}`)}},[c]);h.useEffect(()=>{J()},[]),h.useEffect(()=>()=>{L.current&&L.current.getTracks().forEach($=>$.stop())},[]);const ce=h.useCallback(async()=>{if(!(!m||!_.current)){_.current.disconnect(),await new Promise($=>setTimeout($,100));try{await _.current.connect()}catch{o==null||o("Failed to reconnect WebSocket")}}},[m,o]),Ae={isRecording:b,isChunkRecording:w,chunks:j,currentChunkNumber:C,error:A},Ce={startRecording:me,stopRecording:ae,resetRecording:H},ve=h.useCallback(async($,re)=>{if(S(G=>{const oe=G.find(pe=>pe.id===$);if(!oe)return G;const de={...oe,transcription:re,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(de)),G.map(pe=>pe.id===$?de:pe)}),c)try{await bt.updateChunkTranscription($,re)}catch{}},[c,t]);return{state:Ae,actions:Ce,startChunk:se,stopChunk:le,discardCurrentChunk:X,deleteChunk:ge,transcribeChunk:P,updateChunkTranscription:ve,reconnectWebSocket:ce}};function xm({config:s,isRecording:e,isChunkRecording:t,callbacks:n,cumulativeActiveTimeRef:r,peakAudioLevelRef:o}){const i=h.useRef(null),c=h.useRef(!1),l=h.useRef(null),d=h.useRef({vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold}),p=h.useRef({isRecording:e,isChunkRecording:t});h.useEffect(()=>{d.current={vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold},p.current={isRecording:e,isChunkRecording:t}},[s.vadSilenceTimeout,s.vadMaxChunkDuration,s.silenceDetectionConfig.minActiveDuration,s.silenceDetectionConfig.activationThreshold,e,t]);const u=h.useCallback(()=>{i.current=null,c.current=!1,l.current=null,o.current=0},[o]),f=h.useCallback(async()=>{i.current=Date.now(),c.current=!0,l.current=null,o.current=0,await n.startChunk()},[n,o]),m=h.useCallback(async w=>{w?await n.stopChunk():n.discardCurrentChunk(),u()},[n,u]),g=h.useCallback(async()=>{p.current.isChunkRecording?(c.current=!0,l.current=null):await f()},[f]),x=h.useCallback(async()=>{if(!p.current.isChunkRecording||!c.current)return;const w=Date.now();if(l.current===null){l.current=w;return}if(w-l.current>=d.current.vadSilenceTimeout){const C=r.current>=d.current.minActiveDuration,A=o.current>=d.current.activationThreshold;await m(C&&A)}},[m,r,o]),b=h.useCallback(async()=>{if(!p.current.isChunkRecording||!i.current)return;Date.now()-i.current>=d.current.vadMaxChunkDuration&&(await n.stopChunk(),c.current&&!p.current.isChunkRecording?await f():u())},[n,f,u]);return{processVADAudio:h.useCallback((w,y)=>{if(!p.current.isRecording)return;const j=!w,S=j&&y,C=j&&!p.current.isChunkRecording&&!c.current;(S||C)&&g(),w&&x(),b()},[g,x,b]),resetVADState:u}}const Fa={silenceThreshold:.47,minSilenceDuration:0,minActiveDuration:1500,activationThreshold:.67},Vs={enableAutoTranscription:!0,minChunkDuration:500,silenceDetectionConfig:Fa,autoStopOnSilence:!1,autoCreateChunks:!0,autoChunkCreationTime:1e3,skipLastSessionChunk:!0,transcribeOptions:Uc,chunkingMode:"time",vadMaxChunkDuration:1e4,vadSilenceTimeout:1500,useWebSocket:!1},An={default:{id:"custom-1759528805538",name:"Default (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:Fa.activationThreshold},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},eng:{id:"custom-1759528805538",name:"Eng (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},vi:{name:"VN",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},ws:{name:"WS",description:"WebSocket real-time streaming",config:{silenceDetectionConfig:{minActiveDuration:800,activationThreshold:.67},useWebSocket:!0,chunkingMode:"time",autoCreateChunks:!0,autoChunkCreationTime:1e3,minChunkDuration:500,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,model:"ggml-distil-large-v3"}}}},Hc="audio-panel-custom-presets";function Gc(s,e){if(s===e)return!0;if(typeof s!="object"||typeof e!="object"||s===null||e===null)return!1;const t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!n.includes(r)||!Gc(s[r],e[r]))return!1;return!0}function qc(s){const e={};return Object.keys(s).forEach(t=>{Gc(s[t],Vs[t])||(e[t]=s[t])}),e}function zn(s){return{...Vs,...s,silenceDetectionConfig:{...Vs.silenceDetectionConfig,...s.silenceDetectionConfig??{}},transcribeOptions:{...Vs.transcribeOptions,...s.transcribeOptions??{}}}}function gn(){try{const s=localStorage.getItem(Hc);return s?JSON.parse(s).map(t=>({...t,createdAt:new Date(t.createdAt)})):[]}catch(s){return console.error("Failed to load custom presets:",s),[]}}function $a(s){try{localStorage.setItem(Hc,JSON.stringify(s))}catch(e){console.error("Failed to save custom presets:",e)}}function vm(s,e,t){const n=qc(t),r={id:`custom-${Date.now()}`,name:s,description:e,config:n,createdAt:new Date},o=gn();return o.push(r),$a(o),r}function bm(s,e){const t=gn(),n=t.findIndex(i=>i.id===s);if(n===-1)return console.error(`Preset with id ${s} not found`),null;const r=qc(e),o={...t[n],config:r};return t[n]=o,$a(t),o}function wm(s){const t=gn().filter(n=>n.id!==s);$a(t)}function ym(s={}){const e=h.useMemo(()=>({...Fa,...s}),[s]),[t,n]=ou.useState({isSilent:!0,currentLevel:0,silenceThreshold:e.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}),r=h.useCallback(c=>{const l=Math.max(...c),d=Date.now();n(p=>{const u=d-p.lastStateChange,f=l<=p.silenceThreshold;let m=p.isSilent,g=p.silenceDuration,x=p.activeDuration,b=p.lastStateChange;return f?(g+=u,x=0,!p.isSilent&&g>=e.minSilenceDuration&&(m=!0,b=d)):(x+=u,g=0,p.isSilent&&x>=e.minActiveDuration&&(m=!1,b=d)),{isSilent:m,currentLevel:l,silenceThreshold:p.silenceThreshold,silenceDuration:g,activeDuration:x,lastStateChange:b}})},[e.minSilenceDuration,e.minActiveDuration,t.lastStateChange]),o=h.useCallback(c=>{const l=Math.max(0,Math.min(1,c));n(d=>({...d,silenceThreshold:l}))},[]),i=h.useCallback(()=>{n(c=>({isSilent:!0,currentLevel:0,silenceThreshold:c.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}))},[]);return{state:t,processAudioData:r,updateThreshold:o,reset:i}}const _t=h.forwardRef(({className:s,...e},t)=>a.jsxs(Gi,{ref:t,className:U("relative flex w-full touch-none select-none items-center",s),...e,children:[a.jsx(Fu,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:a.jsx($u,{className:"absolute h-full bg-primary"})}),a.jsx(Uu,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));_t.displayName=Gi.displayName;const Sm=({audioData:s,silenceState:e,onThresholdChange:t,hideSilenceControls:n=!1,duration:r=0,className:o=""})=>{const i=h.useCallback(d=>{t==null||t(d[0])},[t]),c=d=>{const p=d/1e3,u=Math.floor(p/60),f=Math.floor(p%60),m=Math.floor(p%1*10);return`${u}:${f.toString().padStart(2,"0")}.${m}`};return a.jsx("div",{className:`silence-detection-visualizer ${o}`,children:a.jsxs("div",{className:"visualization-container relative flex flex-col p-2 bg-muted/50 rounded-lg",style:{height:"64px"},children:[a.jsxs("div",{className:"top-controls flex justify-between items-center gap-2 mb-1 z-20",children:[a.jsx("div",{className:"time-display flex items-center",children:a.jsx("span",{className:"text-[9px] font-medium text-foreground",children:c(r)})}),a.jsxs("div",{className:"right-controls flex items-center gap-2",children:[a.jsxs("div",{className:"status-display flex items-center gap-1",children:[a.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${e.isSilent?"bg-gray-400":"bg-green-500 animate-pulse"}`}),a.jsx("span",{className:"text-[9px] font-medium",children:e.isSilent?"Silent":"Active"}),a.jsx("span",{className:"text-[9px] text-muted-foreground",children:`${(e.currentLevel*100).toFixed(0)}%`})]}),!n&&a.jsxs("div",{className:"threshold-control flex-1 flex items-center gap-1.5",children:[a.jsx("label",{className:"text-[9px] font-medium shrink-0",children:`T: ${(e.silenceThreshold*100).toFixed(0)}%`}),a.jsx(_t,{min:0,max:1,step:.01,value:[e.silenceThreshold],onValueChange:i,className:"flex-1"})]})]})]}),a.jsxs("div",{className:"bars-container relative flex items-end justify-center flex-1",children:[a.jsx("div",{className:"threshold-line absolute left-0 right-0 border-t border-red-500 border-dashed z-10",style:{bottom:`${e.silenceThreshold*100}%`}}),a.jsx("div",{className:"visualization-bars flex items-end justify-center gap-0.5 h-full w-full max-w-2xl relative z-0",children:s.map((d,p)=>{const u=Math.max(d*100,2),f=d>e.silenceThreshold;return a.jsx("div",{className:"visualization-bar flex-1 max-w-2 rounded-t transition-all duration-75 ease-out",style:{height:`${u}%`,backgroundColor:f?`rgba(34, 197, 94, ${.3+d*.7})`:`rgba(156, 163, 175, ${.3+d*.7})`,minHeight:"2px"}},p)})})]})]})})};function Vc({transcribeOptions:s,useWebSocket:e,onTranscribeOptionsChange:t,onUseWebSocketChange:n}){return a.jsxs("div",{className:"transcription-options-section space-y-1 pt-2 border-t border-border",children:[a.jsx("h3",{className:"text-[9px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcription Options"}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"use-websocket",className:"text-[9px] font-semibold",children:"Use WebSocket Transcription"}),a.jsx(Ot,{id:"use-websocket",checked:e,onCheckedChange:n,className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:e?"Real-time streaming with progress updates and word-by-word results":"Standard HTTP API with complete results"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Language"}),a.jsxs(Ut,{value:s.language??"auto",onValueChange:r=>t({...s,language:r}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Jt,{placeholder:"Select language"})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"auto",children:"Auto Detect"}),a.jsx(Oe,{value:"en",children:"English"}),a.jsx(Oe,{value:"vi",children:"Vietnamese"}),a.jsx(Oe,{value:"es",children:"Spanish"}),a.jsx(Oe,{value:"fr",children:"French"}),a.jsx(Oe,{value:"de",children:"German"}),a.jsx(Oe,{value:"pt",children:"Portuguese"}),a.jsx(Oe,{value:"ru",children:"Russian"}),a.jsx(Oe,{value:"ja",children:"Japanese"}),a.jsx(Oe,{value:"zh",children:"Chinese"}),a.jsx(Oe,{value:"ko",children:"Korean"}),a.jsx(Oe,{value:"it",children:"Italian"}),a.jsx(Oe,{value:"nl",children:"Dutch"})]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Transcription language"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Model"}),a.jsxs(Ut,{value:s.model??Fo[0],onValueChange:r=>t({...s,model:r}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Jt,{placeholder:"Select model"})}),a.jsx(Tt,{children:Fo.map(r=>a.jsx(Oe,{value:r,children:r},r))})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Whisper model"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"translate-english",className:"text-[9px] font-semibold",children:"Translate"}),a.jsx(Ot,{id:"translate-english",checked:s.translate??!1,onCheckedChange:r=>t({...s,translate:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Translate to English"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-detect-lang",className:"text-[9px] font-semibold",children:"Auto-Detect"}),a.jsx(Ot,{id:"auto-detect-lang",checked:s.auto_detect_language??!1,onCheckedChange:r=>t({...s,auto_detect_language:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto language detection"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"no-timestamps",className:"text-[9px] font-semibold",children:"No Timestamps"}),a.jsx(Ot,{id:"no-timestamps",checked:s.no_timestamps!==!1,onCheckedChange:r=>t({...s,no_timestamps:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Remove timestamps"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"no-prints",className:"text-[9px] font-semibold",children:"Quiet Mode"}),a.jsx(Ot,{id:"no-prints",checked:s.no_prints!==!1,onCheckedChange:r=>t({...s,no_prints:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Suppress verbose output"})]})]})]})}const bn="audio-panel-selected-preset";function jm({config:s,onConfigChange:e}){const[t,n]=h.useState([]),[r,o]=h.useState(!1),[i,c]=h.useState(""),[l,d]=h.useState(!1),[p,u]=h.useState("");h.useEffect(()=>{const w=gn();n(w);let y=localStorage.getItem(bn);y||(y="default",localStorage.setItem(bn,y)),u(y)},[]);const f=w=>{u(w),localStorage.setItem(bn,w);const y=An[w];if(y){const S=zn(y.config);e(S);return}const j=t.find(S=>S.id===w);if(j){const S=zn(j.config);e(S)}},m=()=>{if(!i.trim()){alert("Please enter a preset name");return}const w=vm(i.trim(),"Custom configuration",s);n([...t,w]),c(""),o(!1)},g=()=>{c(""),o(!1)},x=w=>{const y=bm(w,s);y&&(n(t.map(j=>j.id===w?y:j)),d(!0))},b=w=>{wm(w),n(t.filter(y=>y.id!==w)),p===w&&(u(""),localStorage.removeItem(bn))},v=()=>{const w=An[p];if(w)return w.name;const y=t.find(j=>j.id===p);return(y==null?void 0:y.name)||""};return a.jsxs("div",{className:"config-view space-y-2 text-[10px]",children:[a.jsxs("div",{className:"preset-selector space-y-1",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Configuration Preset"}),!r&&a.jsx(ue,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>o(!0),title:"Save current configuration as preset",children:a.jsx(Nn,{className:"h-3 w-3"})})]}),r?a.jsxs("div",{className:"flex gap-1",children:[a.jsx(We,{placeholder:"Enter preset name...",value:i,onChange:w=>c(w.target.value),onKeyDown:w=>{w.key==="Enter"&&m(),w.key==="Escape"&&g()},className:"h-8 text-[9px] flex-1",autoFocus:!0}),a.jsx(ue,{onClick:m,size:"sm",className:"h-8 px-2",title:"Save preset",children:a.jsx(Nn,{className:"h-3 w-3"})}),a.jsx(ue,{onClick:g,size:"sm",variant:"ghost",className:"h-8 px-2",title:"Cancel",children:"âœ•"})]}):a.jsxs(Ut,{value:p,onValueChange:f,open:l,onOpenChange:d,children:[a.jsx(It,{className:"h-8 text-[9px]",children:a.jsx(Jt,{placeholder:"Select a preset...",children:p&&a.jsx("span",{className:"font-medium",children:v()})})}),a.jsxs(Tt,{children:[Object.entries(An).map(([w,y])=>a.jsxs(Oe,{value:w,children:[a.jsx("span",{className:"font-medium",children:y.name}),a.jsx("span",{className:"text-[8px] text-muted-foreground ml-2",children:y.description})]},w)),t.map(w=>a.jsx(Oe,{value:w.id,children:a.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[a.jsxs("div",{className:"flex flex-col items-start flex-1 min-w-0",children:[a.jsx("span",{className:"font-medium",children:w.name}),a.jsx("span",{className:"text-[8px] text-muted-foreground",children:w.description})]}),a.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[a.jsx(ue,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),x(w.id)},onClick:y=>{y.preventDefault(),y.stopPropagation()},title:"Update preset with current settings",children:a.jsx(Nn,{className:"h-3 w-3 text-blue-500"})}),a.jsx(ue,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),b(w.id)},onClick:y=>{y.preventDefault(),y.stopPropagation()},title:"Delete preset",children:a.jsx(Et,{className:"h-3 w-3 text-red-500"})})]})]})},w.id))]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:r?"Enter a name for the current configuration":"Quick apply preset configurations"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-transcription",className:"text-[9px] font-semibold",children:"Auto-Transcribe"}),a.jsx(Ot,{id:"auto-transcription",checked:s.enableAutoTranscription,onCheckedChange:w=>e({enableAutoTranscription:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-transcribe chunks"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Chunk: ",s.minChunkDuration,"ms"]}),a.jsx(_t,{min:500,max:5e3,step:500,value:[s.minChunkDuration],onValueChange:w=>e({minChunkDuration:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min chunk duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Chunking Mode"}),a.jsxs(Ut,{value:s.chunkingMode,onValueChange:w=>e({chunkingMode:w}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Jt,{})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"time",children:"Time-based"}),a.jsx(Oe,{value:"vad",children:"Voice Activity Detection (VAD)"}),a.jsx(Oe,{value:"silence-based",children:"Silence-based Splitting"})]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:s.chunkingMode==="time"?"Fixed interval chunking for predictable real-time updates":s.chunkingMode==="vad"?"Speech-driven chunking for natural boundaries and better accuracy":"VAD recording with post-processing silence-based splits for precise segmentation"})]}),s.chunkingMode==="time"&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-create-chunks",className:"text-[9px] font-semibold",children:"Auto-Create"}),a.jsx(Ot,{id:"auto-create-chunks",checked:s.autoCreateChunks,onCheckedChange:w=>e({autoCreateChunks:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-create chunks"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Auto-Time: ",s.autoChunkCreationTime,"ms"]}),a.jsx(_t,{min:500,max:5e3,step:500,value:[s.autoChunkCreationTime],onValueChange:w=>e({autoChunkCreationTime:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-creation interval"})]})]}),(s.chunkingMode==="vad"||s.chunkingMode==="silence-based")&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Max Duration: ",s.vadMaxChunkDuration,"ms"]}),a.jsx(_t,{min:3e3,max:3e4,step:1e3,value:[s.vadMaxChunkDuration],onValueChange:w=>e({vadMaxChunkDuration:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Max VAD chunk duration (safety ceiling)"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Silence Timeout: ",s.vadSilenceTimeout,"ms"]}),a.jsx(_t,{min:500,max:5e3,step:100,value:[s.vadSilenceTimeout],onValueChange:w=>e({vadSilenceTimeout:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence duration to end chunk"})]})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"skip-last-chunk",className:"text-[9px] font-semibold",children:"Skip Last Chunk"}),a.jsx(Ot,{id:"skip-last-chunk",checked:s.skipLastSessionChunk,onCheckedChange:w=>e({skipLastSessionChunk:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Skip last session chunk"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-stop-silence",className:"text-[9px] font-semibold",children:"Auto-Stop"}),a.jsx(Ot,{id:"auto-stop-silence",checked:s.autoStopOnSilence,onCheckedChange:w=>e({autoStopOnSilence:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Stop on silence"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Silence: ",Math.round(s.silenceDetectionConfig.silenceThreshold*100),"%"]}),a.jsx(_t,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.silenceThreshold],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,silenceThreshold:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence threshold"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Silent: ",s.silenceDetectionConfig.minSilenceDuration,"ms"]}),a.jsx(_t,{min:100,max:5e3,step:100,value:[s.silenceDetectionConfig.minSilenceDuration],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minSilenceDuration:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min silence duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Active: ",s.silenceDetectionConfig.minActiveDuration,"ms"]}),a.jsx(_t,{min:100,max:3e3,step:100,value:[s.silenceDetectionConfig.minActiveDuration],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minActiveDuration:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min active duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Activation: ",Math.round(s.silenceDetectionConfig.activationThreshold*100),"%"]}),a.jsx(_t,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.activationThreshold],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,activationThreshold:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Peak level threshold (filters body noise)"})]})]}),a.jsx(Vc,{transcribeOptions:s.transcribeOptions,useWebSocket:s.useWebSocket,onTranscribeOptionsChange:w=>e({transcribeOptions:w}),onUseWebSocketChange:w=>e({useWebSocket:w})})]})}function $s({audioBlob:s,isPlaying:e=!0,className:t="",height:n=80,barWidth:r=2,barGap:o=1,barColor:i="#94a3b8",progressColor:c="#3b82f6"}){const l=h.useRef(null),[d,p]=h.useState([]),[u,f]=h.useState(!1),[m,g]=h.useState({width:0,height:0});return h.useEffect(()=>{if(!s)return;let x=!1;return f(!0),(async()=>{try{const v=await s.arrayBuffer(),w=new AudioContext,y=await w.decodeAudioData(v);if(x){await w.close();return}const j=y.getChannelData(0),S=100,C=Math.floor(j.length/S),N=[];for(let R=0;R<S;R++){const M=C*R;let L=0;for(let W=0;W<C;W++){const z=j[M+W];L+=z*z}const T=Math.sqrt(L/C);N.push(T)}const A=Math.max(...N),k=1.5,E=N.map(R=>Math.min(1,R/A*k));x||p(E),await w.close()}catch(v){console.error("Failed to generate waveform:",v)}finally{x||f(!1)}})(),()=>{x=!0}},[s]),h.useEffect(()=>{if(u)return;const x=l.current;if(!x||d.length===0)return;const b=x.getContext("2d");if(!b)return;const v=x.width,w=x.height;if(v===0||w===0)return;const y=r+o,j=Math.min(d.length,Math.floor(v/y));b.clearRect(0,0,v,w);for(let S=0;S<j;S++){const C=Math.floor(S/j*d.length),N=d[C],A=Math.max(3,w*.05),k=w*.95,E=Math.max(A,N*k),R=S*y,M=(w-E)/2;b.fillStyle=e?c:i,b.fillRect(R,M,r,E)}},[d,e,r,o,i,c,m,u]),h.useEffect(()=>{const x=l.current;if(!x)return;const b=()=>{const v=x.parentElement;if(!v)return;const w=v.getBoundingClientRect();w.width>0&&w.height>0&&(x.width!==w.width||x.height!==w.height)&&(x.width=w.width,x.height=w.height,g({width:w.width,height:w.height}))};return b(),d.length>0&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{b()})}),window.addEventListener("resize",b),()=>{window.removeEventListener("resize",b)}},[n,d.length]),u?a.jsx("div",{className:`waveform-loading flex items-center justify-center ${t}`,style:{height:n},children:a.jsx("div",{className:"text-xs text-gray-400",children:"Generating waveform..."})}):a.jsx("div",{className:`waveform-container ${t}`,style:{height:n},children:a.jsx("canvas",{ref:l,className:"waveform-visualizer w-full h-full",style:{display:"block"}})})}function Cm({chunk:s,isPlaying:e,onPlay:t,onPause:n,onDownload:r,onDelete:o,onTranscribe:i,variant:c="default",showTranscribe:l=!1}){const d=c==="error"?"hover:bg-red-100":"hover:bg-slate-200";return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(ue,{size:"sm",variant:"ghost",onClick:e?n:t,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:e?a.jsx(fp,{className:"w-3.5 h-3.5"}):a.jsx(sc,{className:"w-3.5 h-3.5"})}),a.jsx(ue,{size:"sm",variant:"ghost",onClick:r,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:a.jsx(Ia,{className:"w-3.5 h-3.5"})}),l&&i&&a.jsx(ue,{size:"sm",variant:"ghost",onClick:i,className:`h-7 w-7 p-0 text-blue-600 hover:text-blue-700 ${c==="error"?"hover:bg-red-100":"hover:bg-blue-50"}`,disabled:!s.blob||s.transcriptionStatus==="processing",title:"Transcribe audio",children:a.jsx(On,{className:"w-3.5 h-3.5"})}),o&&a.jsx(ue,{size:"sm",variant:"ghost",onClick:o,className:`h-7 w-7 p-0 text-red-600 hover:text-red-700 ${c==="error"?"hover:bg-red-100":"hover:bg-red-50"}`,children:a.jsx(Et,{className:"w-3.5 h-3.5"})})]})}function Nm({duration:s,variant:e="default"}){const t=r=>{const o=r/1e3,i=Math.floor(o),c=Math.floor((o-i)*100);return c>0?`${i}.${c.toString().padStart(2,"0")}s`:`${i}s`},n={completed:"text-xs text-green-600 border-green-600 bg-green-50",processing:"text-xs text-blue-600 border-blue-600 bg-blue-50",failed:"text-xs text-red-600 border-red-600 bg-red-50",pending:"text-xs text-gray-600 border-gray-400 bg-gray-50",default:"text-xs text-gray-600 border-gray-400 bg-gray-50"};return a.jsxs(pt,{variant:"outline",className:n[e],children:[a.jsx(ac,{className:"w-3 h-3 mr-1"}),t(s)]})}const km={completed:{className:"bg-card",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsx("div",{className:"text-sm leading-relaxed font-medium",children:s.transcription})]})},processing:{className:"bg-blue-50 border-blue-200",badgeVariant:"processing",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(ir,{className:"w-4 h-4 text-blue-600 animate-spin"}),a.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Transcribing audio..."})]})]})},failed:{className:"bg-red-50 border-red-200",badgeVariant:"failed",controlsVariant:"error",showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(tc,{className:"w-4 h-4 text-red-600"}),a.jsxs("span",{className:"text-sm font-medium text-red-700",children:["Transcription Failed",s.transcriptionError&&a.jsxs("span",{className:"text-xs font-normal ml-1",children:["(",s.transcriptionError,")"]})]})]})]})},pending:{className:"bg-gray-50 border-gray-200",badgeVariant:"pending",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(ac,{className:"w-4 h-4 text-gray-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"Waiting to transcribe..."})]})]})},none:{className:"bg-gray-50 border-gray-200",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Js,{className:"w-4 h-4 text-gray-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"No transcription available"})]})]})}};function Em({chunk:s,isPlaying:e,showWaveform:t,onPlay:n,onPause:r,onDownload:o,onDelete:i,onTranscribe:c}){const d=s.transcription?"completed":s.transcriptionStatus==="processing"?"processing":s.transcriptionStatus==="failed"?"failed":s.transcriptionStatus==="pending"?"pending":"none",p=km[d];return a.jsx(hn,{className:"chunk-item shadow-sm",children:a.jsx(fn,{className:"p-0",children:a.jsxs("div",{className:`flex flex-col border rounded-md py-2 px-2 gap-2 ${p.className}`,children:[p.renderContent(s,e,t),a.jsxs("div",{className:"flex justify-between items-center",children:[s.duration&&a.jsx(Nm,{duration:s.duration,variant:p.badgeVariant}),a.jsx(Cm,{chunk:s,isPlaying:e,onPlay:n,onPause:r,onDownload:o,onDelete:i,onTranscribe:c,variant:p.controlsVariant,showTranscribe:p.showTranscribe})]})]})})})}function Kc({chunks:s,className:e="",onChunkDelete:t,onChunkTranscribe:n,onTranscribeAll:r,onClearAll:o}){const[i,c]=h.useState(null),[l,d]=h.useState(!1),[p,u]=h.useState({language:"vi",model:"ggml-distil-large-v3",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1}),[f,m]=h.useState(!1),g=h.useRef(null),x=h.useRef(null),b=h.useCallback(k=>{if(!k.blob)return;g.current&&(g.current.pause(),x.current&&URL.revokeObjectURL(x.current));const E=new Audio;g.current=E;const R=URL.createObjectURL(k.blob);x.current=R,E.src=R,E.onplay=()=>{c(k.id)},E.onpause=()=>{c(null)},E.onended=()=>{c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},E.onerror=M=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Audio playback error:",M),c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},E.play().catch(M=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Failed to play audio:",M),c(null)})},[]),v=h.useCallback(()=>{g.current&&g.current.pause()},[]),w=h.useCallback(k=>{if(!k.blob)return;const E=URL.createObjectURL(k.blob),R=document.createElement("a");R.href=E,R.download=`${k.name}.wav`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(E)},[]),y=h.useCallback(async k=>{i===k&&g.current&&(g.current.pause(),c(null)),await(t==null?void 0:t(k))},[i,t]),j=h.useCallback(async k=>{await(n==null?void 0:n(k))},[n]),S=h.useCallback(async()=>{g.current&&(g.current.pause(),c(null)),await(o==null?void 0:o())},[o]),C=h.useCallback(async()=>{await(r==null?void 0:r(p))},[r,p]);h.useEffect(()=>()=>{g.current&&g.current.pause(),x.current&&URL.revokeObjectURL(x.current)},[]);const N=s.reduce((k,E)=>k+(E.duration??0),0),A=s.reduce((k,E)=>k+(E.size??0),0);return a.jsx("div",{className:`chunks-panel flex flex-col h-full ${e}`,children:a.jsxs(hn,{className:"flex-1 flex flex-col rounded-none",children:[a.jsxs(La,{className:"pb-4",children:[a.jsxs(Ma,{className:"flex items-center justify-between",children:[a.jsx("span",{children:"Audio Chunks"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(pt,{variant:"outline",children:s.length}),s.length>0&&r&&a.jsx(dn,{variant:"ghost",size:"sm",buttonClassName:"h-6 w-6 p-0",contentClassName:"w-80",title:"Transcription Options",align:"end",storageKey:"chunks-panel-transcription-options",children:a.jsx("div",{className:"chunk-options-config",children:a.jsx(dr,{label:"Transcribe All",onAction:C,size:"sm",className:"w-full",tooltipText:"Click to transcribe all chunks, or click gear for options",popoverContent:a.jsx(Vc,{transcribeOptions:p,useWebSocket:f,onTranscribeOptionsChange:u,onUseWebSocketChange:m})})})}),s.length>0&&a.jsx(ue,{variant:"ghost",size:"sm",onClick:()=>d(!l),className:`h-6 px-2 text-xs ${l?"bg-blue-50 text-blue-600":"text-gray-600"}`,title:l?"Hide waveforms":"Show waveforms",children:a.jsx(hp,{className:"w-3 h-3"})}),s.length>0&&o&&a.jsx(ue,{variant:"ghost",size:"sm",onClick:S,className:"h-6 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",title:"Clear all chunks",children:a.jsx(Et,{className:"w-3 h-3"})})]})]}),s.length>0&&a.jsxs("div",{className:"stats-summary text-xs text-gray-600 space-y-1",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Total Duration:"}),a.jsxs("span",{children:[Math.floor(N/1e3),"s"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Total Size:"}),a.jsxs("span",{children:[(A/1024).toFixed(1)," KB"]})]})]})]}),a.jsx(fn,{className:"flex-1 overflow-hidden p-4",children:s.length===0?a.jsxs("div",{className:"empty-state flex flex-col items-center justify-center h-full text-center text-gray-500",children:[a.jsx("div",{className:"mb-2",children:"ðŸŽ¤"}),a.jsx("p",{className:"text-sm",children:"No chunks recorded yet"}),a.jsx("p",{className:"text-xs mt-1",children:"Start recording and speak to create chunks"})]}):a.jsx("div",{className:"chunks-list overflow-y-auto h-full space-y-2 pr-2",children:s.slice().reverse().map(k=>a.jsx(Em,{chunk:k,isPlaying:i===k.id,showWaveform:l,onPlay:()=>b(k),onPause:v,onDownload:()=>w(k),onDelete:()=>void y(k.id),onTranscribe:n?()=>void j(k.id):void 0},k.id))})})]})})}const $o="audio-panel-config";function Im({sessionName:s="audio-panel-session",enableAutoPersist:e=!0,loadPersistedChunks:t=!1,initialConfig:n,autoStart:r=!1,startTrigger:o,stopTrigger:i,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onSilenceDetected:p,onClearAndRecord:u,onWordReceived:f,onTranscriptionProgress:m,onRecordingStateChange:g,className:x=""}){var Y,we;const[b,v]=h.useState(Array(32).fill(0)),[w,y]=h.useState(0),S=(()=>{try{const ne=localStorage.getItem($o);if(ne)return JSON.parse(ne)}catch(ne){console.error("Failed to load persisted config:",ne)}return{}})(),[C,N]=h.useState(()=>{let ne={...Vs,...S},xe=localStorage.getItem("audio-panel-selected-preset");if(xe||(xe="default",localStorage.setItem("audio-panel-selected-preset",xe)),xe)try{const K=An[xe];if(K)ne=zn(K.config);else{const je=gn().find(Ie=>Ie.id===xe);je&&(ne=zn(je.config))}}catch(K){console.error("Failed to apply selected preset:",K)}return{...ne,...n}}),A=h.useRef(null),k=h.useRef(null),E=h.useRef(null),R=h.useRef(null),M=h.useRef(!1),L=h.useCallback(ne=>{console.error("ðŸŽ¤ Recorder error:",ne)},[]),T=h.useRef(C.autoStopOnSilence),W=h.useRef(p),z=h.useRef(null),te=h.useRef(null),O=h.useRef(null),ee=h.useRef(!1),I=h.useRef(!0),_=h.useRef(0),F=h.useRef(null),q=h.useRef(0),J=h.useRef(C.chunkingMode);h.useEffect(()=>{T.current=C.autoStopOnSilence},[C.autoStopOnSilence]),h.useEffect(()=>{J.current=C.chunkingMode},[C.chunkingMode]),h.useEffect(()=>{W.current=p},[p]),h.useEffect(()=>{n!=null&&n.transcribeOptions&&N(ne=>({...ne,transcribeOptions:{...ne.transcribeOptions,...n.transcribeOptions}}))},[(Y=n==null?void 0:n.transcribeOptions)==null?void 0:Y.language,(we=n==null?void 0:n.transcribeOptions)==null?void 0:we.model]);const{state:P,actions:B,startChunk:se,stopChunk:le,discardCurrentChunk:me,deleteChunk:ae,transcribeChunk:H,updateChunkTranscription:X,reconnectWebSocket:ge}=gm({sessionName:s,enableAutoPersist:e,enableAutoTranscription:C.chunkingMode==="silence-based"?!1:C.enableAutoTranscription,minChunkDuration:C.minChunkDuration,loadPersistedChunks:t,skipLastSessionChunk:C.skipLastSessionChunk,transcribeOptions:C.transcribeOptions,useWebSocket:C.useWebSocket,onWordReceived:f,onTranscriptionProgress:m,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onError:L}),ce=h.useCallback(ne=>{if(ne.length===0)return"";if(ne.length===1)return ne[0].trim();let xe=ne[0].trim();for(let K=1;K<ne.length;K++){let he=ne[K].trim();if(!he)continue;!/[.!?â€¦]$/.test(xe)&&he.length>0&&(he=he.charAt(0).toLowerCase()+he.slice(1)),xe=`${xe} ${he}`}return xe},[]),Ae=h.useCallback(async ne=>{if(C.chunkingMode==="silence-based"&&ne.blob){console.log(`ðŸŽ¤ Processing chunk for silence-based splitting: ${ne.name} (${ne.blob.size} bytes)`);try{const xe=await ne.blob.arrayBuffer(),he=await new AudioContext().decodeAudioData(xe);console.log(`ðŸŽ¤ AudioBuffer duration: ${he.duration.toFixed(2)}s`);const je=Wn.DEFAULT;console.log("ðŸŽ¤ Using DEFAULT preset:",je);const Te=await new zc(je).chunkAudio(he);if(console.log(`ðŸŽ¤ Silence-based split: ${Te.length} chunks detected`),console.log("ðŸŽ¤ Chunk details:",Te.map((Ne,_e)=>({index:_e+1,startTime:Ne.startTime.toFixed(2)+"s",endTime:Ne.endTime.toFixed(2)+"s",duration:Ne.duration.toFixed(2)+"s",blobSize:Ne.blob.size+" bytes"}))),C.enableAutoTranscription&&Te.length>0){const Ne=[];for(let Me=0;Me<Te.length;Me++){const Be=Te[Me],ze=`${ne.name}-split-${Me+1}`;console.log(`ðŸŽ¤ Transcribing split ${Me+1}/${Te.length}: ${ze} (${Be.duration.toFixed(2)}s)`);try{const lt=new File([Be.blob],`${ze}.wav`,{type:"audio/wav"}),Ke=await Wc.transcribeAudio(lt,C.transcribeOptions);Ne.push(Ke.transcription),console.log(`ðŸŽ¤ Split ${Me+1} transcribed: "${Ke.transcription}"`);const nt=ce(Ne);nt&&(await X(ne.id,nt),console.log(`ðŸŽ¤ Progressive update: "${nt}"`))}catch(lt){console.error(`ðŸŽ¤ Failed to transcribe split ${Me+1}:`,lt),Ne.push(`[Error: ${lt instanceof Error?lt.message:"Unknown error"}]`)}}const _e=ce(Ne);console.log(`ðŸŽ¤ Final transcription (${Te.length} splits): "${_e}"`)}}catch(xe){console.error("ðŸŽ¤ Failed to split chunk by silence:",xe)}}},[C,X,ce]);h.useEffect(()=>{if(C.chunkingMode==="silence-based"&&P.chunks.length>0){const ne=P.chunks[P.chunks.length-1];!ne.transcription&&!ne.transcriptionStatus&&Ae(ne)}},[P.chunks,C.chunkingMode,Ae]);const Ce=ym(C.silenceDetectionConfig),ve=h.useRef(Ce);h.useEffect(()=>{ve.current=Ce},[Ce]);const $=xm({config:C.chunkingMode==="silence-based"?{...C,vadSilenceTimeout:100}:C,isRecording:P.isRecording,isChunkRecording:P.isChunkRecording,callbacks:{startChunk:se,stopChunk:le,discardCurrentChunk:me},cumulativeActiveTimeRef:_,peakAudioLevelRef:q}),re=h.useRef($);h.useEffect(()=>{re.current=$},[$]);const G=h.useCallback(ne=>{var xe;N(K=>{const he={...K,...ne};return ne.silenceDetectionConfig&&(he.silenceDetectionConfig={...K.silenceDetectionConfig,...ne.silenceDetectionConfig}),ne.transcribeOptions&&(he.transcribeOptions={...K.transcribeOptions,...ne.transcribeOptions}),he}),((xe=ne.silenceDetectionConfig)==null?void 0:xe.silenceThreshold)!==void 0&&Ce.updateThreshold(ne.silenceDetectionConfig.silenceThreshold)},[Ce]);h.useEffect(()=>{try{localStorage.setItem($o,JSON.stringify(C))}catch(ne){console.error("Failed to persist config:",ne)}},[C]),h.useEffect(()=>{O.current=se},[se]),h.useEffect(()=>{z.current=le},[le]),h.useEffect(()=>{te.current=me},[me]);const oe=h.useRef(P.isRecording);h.useEffect(()=>{oe.current=P.isRecording},[P.isRecording]),h.useEffect(()=>{ee.current=P.isChunkRecording},[P.isChunkRecording]);const de=h.useCallback(async()=>{try{const ne=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),xe=new AudioContext,K=xe.createAnalyser();K.fftSize=256,K.smoothingTimeConstant=.8,xe.createMediaStreamSource(ne).connect(K),A.current=xe,k.current=K;const je=()=>{var ze,lt;if(!k.current)return;const Ie=k.current.frequencyBinCount,Te=new Uint8Array(Ie);k.current.getByteFrequencyData(Te);const Ne=32,_e=Math.floor(Ie/Ne),Me=[];for(let Ke=0;Ke<Ne;Ke++){let nt=0;for(let vt=0;vt<_e;vt++)nt+=Te[Ke*_e+vt];const gt=nt/_e/255;Me.push(gt)}if(v(Me),ve.current.processAudioData(Me),ee.current){const Ke=ve.current.state.currentLevel;Ke>q.current&&(q.current=Ke)}if(J.current==="vad"||J.current==="silence-based"){const Ke=ve.current.state.isSilent,nt=I.current;re.current.processVADAudio(Ke,nt)}const Be=Date.now();if(ee.current)if(F.current===null)F.current=Be;else{const Ke=Be-F.current;I.current||(_.current+=Ke),F.current=Be}else F.current=null,_.current=0;if(T.current&&P.isChunkRecording){const Ke=ve.current.state.isSilent,nt=M.current;!nt&&!Ke?M.current=!0:nt&&Ke&&((ze=W.current)==null||ze.call(W),(lt=z.current)==null||lt.call(z),M.current=!1)}I.current=ve.current.state.isSilent,E.current=requestAnimationFrame(je)};je()}catch(ne){console.error("ðŸŽ¤ âŒ Failed to setup audio analysis:",ne)}},[]),pe=h.useCallback(()=>{E.current&&(cancelAnimationFrame(E.current),E.current=null),A.current&&(A.current.close(),A.current=null),k.current=null,v(Array(32).fill(0)),ve.current.reset(),re.current.resetVADState(),M.current=!1},[]),fe=h.useCallback(async()=>{if(P.isRecording){if(P.isChunkRecording){const ne=_.current,xe=C.silenceDetectionConfig.minActiveDuration,K=q.current,he=C.silenceDetectionConfig.activationThreshold;ne>=xe&&K>=he?await le():me()}B.stopRecording(),oe.current=!1,pe(),R.current=null}else await B.startRecording(),oe.current=!0,await de(),R.current=Date.now(),C.chunkingMode==="time"&&(await se(),M.current=!1)},[P.isRecording,P.isChunkRecording,B,de,pe,C.chunkingMode,C.silenceDetectionConfig.minActiveDuration,C.silenceDetectionConfig.activationThreshold,se,le,me]);h.useEffect(()=>{if(!P.isRecording)return;const ne=setInterval(()=>{R.current&&y(Date.now()-R.current)},100);return()=>clearInterval(ne)},[P.isRecording]),h.useEffect(()=>()=>{pe()},[pe]);const be=h.useRef(null);h.useEffect(()=>{be.current!==null&&be.current!==P.isRecording&&(g==null||g(P.isRecording)),be.current=P.isRecording},[P.isRecording,g]),h.useEffect(()=>{r&&!P.isRecording&&fe()},[r]),h.useEffect(()=>{o!==void 0&&o>0&&!P.isRecording&&fe()},[o]),h.useEffect(()=>{i!==void 0&&i>0&&P.isRecording&&fe()},[i]);const Pe=h.useCallback(async ne=>{const xe=P.chunks.find(K=>K.id===ne);if(!(xe!=null&&xe.blob)){console.error("ðŸŽ¤ âŒ Cannot transcribe chunk: blob not found",ne);return}await H(ne,xe.blob,xe.name,C.transcribeOptions)},[P.chunks,H,C]),Ee=h.useCallback(async ne=>{await ae(ne),d==null||d(ne)},[ae,d]),V=h.useCallback(async()=>{const ne=P.chunks.map(xe=>xe.id);await Promise.all(ne.map(xe=>Ee(xe)))},[P.chunks,Ee]),D=h.useCallback(async()=>{await V(),u==null||u(),await ge(),P.isRecording||await fe()},[V,u,ge,P.isRecording,fe]);return h.useEffect(()=>{if(!P.isRecording||C.chunkingMode!=="time")return;const ne=setInterval(()=>{var Ie,Te;const xe=_.current,K=C.silenceDetectionConfig.minActiveDuration,he=q.current,je=C.silenceDetectionConfig.activationThreshold;if(xe<K||he<je){(Ie=te.current)==null||Ie.call(te),setTimeout(()=>{var Ne;(Ne=O.current)==null||Ne.call(O),_.current=0,q.current=0},50);return}(Te=z.current)==null||Te.call(z),setTimeout(()=>{var Ne;(Ne=O.current)==null||Ne.call(O),_.current=0,q.current=0},50)},C.autoChunkCreationTime);return()=>{clearInterval(ne)}},[P.isRecording,C.autoChunkCreationTime,C.silenceDetectionConfig.minActiveDuration,C.silenceDetectionConfig.activationThreshold,C.chunkingMode]),a.jsx("div",{className:`audio-panel ${x}`,children:a.jsx(hn,{children:a.jsxs(fn,{className:"p-3 space-y-1",children:[a.jsxs("div",{className:"controls-section flex justify-between items-center gap-1",children:[a.jsx(Zf,{onClick:fe,label:P.isRecording?"Stop":"Record",icon:P.isRecording?Xs:rr,variant:P.isRecording?"destructive":"default",size:"sm",options:[{label:"Clear and Record",onClick:D}],showDropdown:!P.isRecording,className:"recording-toggle-group"}),a.jsxs(st,{children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:"secondary",size:"sm",children:a.jsx(mp,{className:"w-3 h-3"})})}),a.jsx(Xe,{className:"w-80 p-3",align:"end",children:a.jsx(jm,{config:C,onConfigChange:G})})]})]}),a.jsx("div",{className:"visualizer-section",children:a.jsx(Sm,{audioData:b,silenceState:Ce.state,onThresholdChange:Ce.updateThreshold,hideSilenceControls:!0,duration:w})}),(C.chunkingMode==="vad"||C.chunkingMode==="silence-based")&&P.isRecording&&a.jsxs("div",{className:"vad-activity-indicator p-2 bg-slate-50 border border-slate-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("span",{className:"text-[9px] font-semibold text-slate-600",children:"VAD Activity"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-[8px] text-slate-500",children:["Level: ",(Ce.state.currentLevel*100).toFixed(0),"%"]}),a.jsx("div",{className:`px-1.5 py-0.5 rounded text-[8px] font-medium ${Ce.state.isSilent?"bg-gray-100 text-gray-600":"bg-green-100 text-green-700"}`,children:Ce.state.isSilent?"ðŸ”‡ Silent":"ðŸŽ™ï¸ Active"})]})]}),a.jsxs("div",{className:"relative h-2 bg-slate-200 rounded-full overflow-hidden",children:[Ce.state.silenceThreshold>0&&a.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-400 z-10",style:{left:`${Ce.state.silenceThreshold*100}%`},title:`Threshold: ${(Ce.state.silenceThreshold*100).toFixed(0)}%`}),a.jsx("div",{className:`h-full transition-all duration-100 ${Ce.state.isSilent?"bg-gray-400":"bg-green-500"}`,style:{width:`${Ce.state.currentLevel*100}%`}})]}),P.isChunkRecording&&a.jsxs("div",{className:"mt-1 text-[8px] text-blue-600 flex items-center gap-1",children:[a.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-blue-600 rounded-full animate-pulse"}),"Recording chunk..."]})]}),P.error&&a.jsx("div",{className:"error-display p-1.5 bg-red-50 border border-red-200 rounded-lg",children:a.jsx("p",{className:"text-[10px] text-red-600",children:P.error})}),a.jsx(Kc,{chunks:P.chunks,onChunkDelete:Ee,onChunkTranscribe:Pe,onClearAll:V})]})})})}const Uo=s=>{let e;const t=new Set,n=(d,p)=>{const u=typeof d=="function"?d(e):d;if(!Object.is(u,e)){const f=e;e=p??(typeof u!="object"||u===null)?u:Object.assign({},e,u),t.forEach(m=>m(e,f))}},r=()=>e,c={setState:n,getState:r,getInitialState:()=>l,subscribe:d=>(t.add(d),()=>t.delete(d))},l=e=s(n,r,c);return c},Jc=(s=>s?Uo(s):Uo);var Ua=(s=>(s.ADD="add",s.DRAW_ARROW="draw_arrow",s.DRAW="draw",s.SELECT="select",s.MOVE="move",s.ZOOM="zoom",s.WRITE="write",s.GRID="grid",s.VIM="vim",s))(Ua||{}),Pn=(s=>(s.WRITE="write",s.AUDIO="write:audio",s))(Pn||{}),Rn=(s=>(s.DEFAULT="draw_arrow:default",s.STAY="draw_arrow:stay",s))(Rn||{}),Yc=(s=>(s.NONE="none",s.STUDY="study",s.PAIRING="pairing",s))(Yc||{}),Ve=(s=>(s.RECT="RECT",s.TABLE="TABLE",s.TEXT="TEXT",s.ARROW="ARROW",s.TEXTCARD="TEXTCARD",s.WORKFLOW_ORCHESTRATION="WORKFLOW_ORCHESTRATION",s.WORKFLOW_SOURCE="WORKFLOW_SOURCE",s.WORKFLOW_DEFINITION="WORKFLOW_DEFINITION",s.WORKFLOW_STEP="WORKFLOW_STEP",s.OCR="OCR",s.IMAGE="IMAGE",s.GROUP="GROUP",s.CHAT="CHAT",s.VOCABULARY="VOCABULARY",s.DRAWING="DRAWING",s))(Ve||{});const nC=["content","title","x","y","width","height","createdAt","updatedAt","id","type"],rC={content:"Content",title:"Title",x:"X Position",y:"Y Position",width:"Width",height:"Height",createdAt:"Created At",updatedAt:"Updated At",id:"ID",type:"Type"},aC=["title","content"],oC={title:"Title",content:"Content"};let Ue=(s=21)=>crypto.getRandomValues(new Uint8Array(s)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class wn{static loadPreset(e){const t=new Map,n=this.convertStepsToRows(e.steps,t),r=t.get(1)||"row_1";return{id:`wf-preset-${e.id}`,x:0,y:0,width:400,height:300,type:Ve.RECT,title:e.name,content:e.description,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:n},inputHandles:[{id:`input_${r}`,name:"All Nodes",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Result",type:"output",dataType:"any"}]}}}static convertStepsToRows(e,t,n){return e.map(r=>{const o=Ue();t.set(r.order,o);const i={id:o,label:r.label,order:r.order,stepType:r.type};if(r.config){const c=JSON.parse(JSON.stringify(r.config));c.dataSource==="row_1"&&(c.dataSource=t.get(1)||"row_1"),i.config=c}return r.children&&r.children.length>0&&(i.children=this.convertStepsToRows(r.children,t,r.order)),i})}}const Tm=8,Am=0,Pm=-5,iC="__paste-create__",kr=4;function Ht(s){const e=Math.round(s*1.5),t=Math.round(s*.25),n=e+t*2;return{fontSize:s,lineHeight:e,padding:t,baseNodeHeight:n,cssFontSize:`${s}px`,cssLineHeight:`${e}px`,cssPadding:`${t}px`}}const Ze={small:Ht(14),normal:Ht(16),xnormal:Ht(18),large:Ht(20),xlarge:Ht(24),xxlarge:Ht(28),xxxlarge:Ht(32),xxxxlarge:Ht(38),xxxxxlarge:Ht(48)};function Rm(s){if(s===void 0)return Ze.normal;let e;if(typeof s=="number")e=s;else{const t=parseFloat(s);e=isNaN(t)?Ze.normal.fontSize:t}for(const t of Object.values(Ze))if(t.fontSize===e)return t;return Ht(e)}const cC=768,rt={DEFAULT_NODE_WIDTH:120,DEFAULT_NODE_HEIGHT:Ze.normal.baseNodeHeight,VOCAB_NODE_MIN_WIDTH:140,FONT_SIZE_DEFAULT:Ze.normal.fontSize,FONT_SIZE_SMALL:Ze.small.fontSize,FONT_SIZE_XS:13,FONT_SIZE_XXS:12,FONT_SIZE_MINI:10,FONT_SIZE_PRESETS:{small:Ze.small.fontSize,normal:Ze.normal.fontSize,large:Ze.large.fontSize,xlarge:Ze.xlarge.fontSize,xxlarge:Ze.xxlarge.fontSize,xxxlarge:Ze.xxxlarge.fontSize,xxxxlarge:Ze.xxxxlarge.fontSize,xxxxxlarge:Ze.xxxxxlarge.fontSize},TEXT_PADDING:{default:{horizontal:Ze.normal.padding,vertical:Ze.normal.padding},large:{horizontal:Ze.large.padding,vertical:Ze.large.padding}},LINE_HEIGHT:Ze.normal.lineHeight,LINE_HEIGHT_CONFIG:25,LINE_HEIGHT_FIND:20,DEFAULT_PADDING:kr,NODE_X_PADDING:kr*2,NODE_Y_PADDING:kr*2,nodeSpacing:20,NODE_ALIGNMENT_PADDING:16,writeMode:{yRatio:.67},TEXT_MODE_ADJUST_Y:25,NEW_NODE_SEGMENT_SPACING:15,MIN_RESIZE_WIDTH:100,MIN_RESIZE_HEIGHT:100,HANDLE_OFFSET:Tm/2,HANDLE_BG_COLOR:"bg-primary",HANDLE_BORDER_COLOR:"border-primary-foreground",SELECTION_RING_COLOR:"ring-ring",SELECTED_BORDER_COLOR:"border-ring",CUSTOM_CHARACTERS:["?","!"],chatInput:{BOTTOM_VISIBLE:70,BOTTOM_HIDDEN:10,NODE_GAP_TOP:100,NODE_GAP_LEFT:20,NODE_GAP_RIGHT:40,NODE_SCROLL_GAP:20},ARRANGE_NODE_GAP:60,ARRANGE_GRID_COLUMNS:3,PRESET_STEP_DELAY_MS:200},Dm={textNodeXPadding:rt.NODE_X_PADDING*4};function _m(s){const e=Rm(s);return{horizontal:e.padding,vertical:e.padding}}const Om="capitalize",Lm="Capitalize",Mm="Capitalize first letter of text",Fm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Capitalize",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.capitalize()}}"}]}}]}],$m={id:Om,name:Lm,description:Mm,steps:Fm},Um="trim-symbols-light",Bm="Trim Symbols (Light)",Wm="Remove punctuation and special characters from start/end of text",zm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsLight()}}"}]}}]}],Hm={id:Um,name:Bm,description:Wm,steps:zm},Gm="trim-symbols-strict",qm="Trim Symbols (Strict)",Vm="Remove all non-alphanumeric characters from start/end of text",Km=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsStrict()}}"}]}}]}],Jm={id:Gm,name:qm,description:Vm,steps:Km},Ym="add-full-stop",Xm="Add Full Stop",Qm="Add a full stop (.) at the end of text",Zm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Add Full Stop",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title}}."}]}}]}],eg={id:Ym,name:Xm,description:Qm,steps:Zm};function Xc(){const s="workflow-templates-project",e="workflow-templates-workspace",t=wn.loadPreset($m),n=wn.loadPreset(Hm),r=wn.loadPreset(Jm),o=wn.loadPreset(eg),i="canvas-workflow-presets",c={id:i,name:"ðŸŽ¨ Workflow Presets",createdAt:Date.now(),lastModified:Date.now(),coreState:{nodes:[{id:Ue(8),x:50,y:50,type:Ve.TEXT,content:`ðŸŽ¨ Workflow Presets Library

Reusable workflow templates powered by JSON configuration.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How to Use:
1. Copy a preset workflow node below (Ctrl+C / Cmd+C)
2. Paste into your target canvas (Ctrl+V / Cmd+V)
3. Click Execute button on the workflow node
4. Done! All canvas nodes are processed automatically

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Key Features (WF-32):
âœ… Source node is OPTIONAL - workflows iterate through all canvas nodes
âœ… Templates use loop context: {{loop.index}}, {{loop.current.title}}
âœ… Simple mode with field updates or advanced mode with explicit targets

See: _docs/guidelines/canvas/workflow-presets-and-execution.md`,styles:{fontSize:`${rt.FONT_SIZE_SMALL}px`,fontWeight:"bold",textColor:"#1f2937"}},{id:Ue(8),x:50,y:400,type:Ve.TEXT,content:`ðŸ”¤ Capitalize

Capitalize first letter of text.
Template: {{loop.current.title.capitalize()}}

Result: "hello world" â†’ "Hello world"`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...t,x:50,y:550},{id:Ue(8),x:450,y:400,type:Ve.TEXT,content:`âœ‚ï¸ Trim Symbols (Light)

Remove punctuation and special chars from edges.
Template: {{loop.current.title.trimSymbolsLight()}}

Result: "  - hello,  " â†’ "hello"`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...n,x:450,y:550},{id:Ue(8),x:850,y:400,type:Ve.TEXT,content:`ðŸ§¹ Trim Symbols (Strict)

Remove ALL non-alphanumeric from edges.
Template: {{loop.current.title.trimSymbolsStrict()}}

Result: "***hello***" â†’ "hello"`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...r,x:850,y:550},{id:Ue(8),x:1250,y:400,type:Ve.TEXT,content:`ðŸ“ Add Full Stop

Append a full stop (.) to end of text.
Template: {{loop.current.title}}.

Result: "Hello world" â†’ "Hello world."`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...o,x:1250,y:550}],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1,targetView:null}},l={id:e,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),canvases:{[i]:c},activeCanvasId:i};return{id:s,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[e]:l},activeWorkspaceId:e}}const tg=[{id:Ue(8),x:600,y:100,type:Ve.TEXT,content:"Node 2 - Text"}],sg=[{id:"vocab-demo-001",x:100,y:350,width:400,height:320,type:Ve.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"dictionary",term:"CÃ¢u tá»¥c ngá»¯",pronunciation:"/kÉ™ÊŠ tÊŠk Å‹ÊŠ/",partOfSpeech:"noun",definition:"Dieses Sprichwort betont die vietnamesische WertschÃ¤tzung fÃ¼r KreativitÃ¤t, Einfallsreichtum und ProblemlÃ¶sung in schwierigen Situationen",examples:[{id:"ex-001",text:"CÃ¢u tá»¥c ngá»¯ nÃ y nháº¥n máº¡nh sá»± trÃ¢n trá»ng cá»§a ngÆ°á»i Viá»‡t Ä‘á»‘i vá»›i sá»± sÃ¡ng táº¡o, tÃ­nh khÃ©o lÃ©o vÃ  kháº£ nÄƒng giáº£i quyáº¿t váº¥n Ä‘á» trong nhá»¯ng hoÃ n cáº£nh khÃ³ khÄƒn",translation:"This proverb emphasizes Vietnamese appreciation for creativity, resourcefulness and problem-solving in difficult situations"}],relatedWords:[{id:"rw-001",word:"Sprichwort",type:"synonym"},{id:"rw-002",word:"WertschÃ¤tzung",type:"related"}],etymology:{origin:"Vietnamese",language:"Tiáº¿ng Viá»‡t",evolution:"Traditional proverb passed down through generations"},expandedSections:["definition","examples"]}},{id:"vocab-demo-002",x:520,y:350,width:280,height:200,type:Ve.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"flashcard",term:"nháº¥n máº¡nh",pronunciation:"/É²É™n maÉ²/",partOfSpeech:"verb",definition:"betont / emphasize",flashcardBack:"betont (to emphasize, to stress)",isFlipped:!1,expandedSections:[]}},{id:"vocab-demo-003",x:820,y:350,width:320,height:280,type:Ve.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"word_list",term:"Sentence Breakdown",definition:"Vietnamese â†’ German word pairs",wordListItems:["CÃ¢u tá»¥c ngá»¯ â†’ Sprichwort","nÃ y â†’ Dieses","nháº¥n máº¡nh â†’ betont","sá»± trÃ¢n trá»ng â†’ WertschÃ¤tzung","cá»§a â†’ (von)","ngÆ°á»i Viá»‡t â†’ Vietnameses"],expandedSections:[]}}],ng=[...sg],rg=[],ag={nodes:ng,arrows:rg,groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},og={offset:{x:50,y:50},scale:1,targetView:null},ta=Ue(10),ig={id:ta,name:"My First Canvas",createdAt:Date.now(),lastModified:Date.now(),coreState:ag,viewState:og},sa=Ue(10),cg={id:sa,name:"Default Workspace",createdAt:Date.now(),lastModified:Date.now(),canvases:{[ta]:ig},activeCanvasId:ta},na=Ue(10),lg={id:na,name:"My Project",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[sa]:cg},activeWorkspaceId:sa},Ba={version:"3.6.8",dataVersion:"1.1.0",flags:{debug:{logEvents:!1,showDebugOverlay:!0},feature:{}},preferences:{segmentedButtons:{}},uiState:{mode:Ua.SELECT,addNodeType:Ve.TEXT,isPanning:!1,isDrawing:!1,mouseCursor:"cursor-default",selectionBox:null,temporaryArrow:null,nodeToFocusId:null,isOverlayVisible:!1,useCurvedArrows:!1,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},toolbar:{isVisible:!0,toolbarActions:[]},overlay:{},activeGlobalOverlay:Yc.NONE},state:{nodes:tg,projects:{[na]:lg,"workflow-templates-project":Xc()},activeProjectId:na}},Bo={DISABLED:"disabled",SIMPLE:"simple",COMPREHENSIVE:"comprehensive"},lC=["Straight","Quadratic","Cubic","Step","Orthogonal","TreeCubic","TreeLStep","TreeZShape"],dC=["none","subtle","medium","vintage","custom"],uC={none:{baseFrequency:.65,numOctaves:3,opacity:0,bgHue:0,bgSaturation:0,bgLightness:100},subtle:{baseFrequency:.8,numOctaves:3,opacity:.15,bgHue:0,bgSaturation:0,bgLightness:100},medium:{baseFrequency:.65,numOctaves:3,opacity:.3,bgHue:0,bgSaturation:0,bgLightness:100},vintage:{baseFrequency:.5,numOctaves:4,opacity:.4,bgHue:40,bgSaturation:30,bgLightness:96}},pC={none:"None",subtle:"Subtle",medium:"Medium",vintage:"Vintage",custom:"Custom"},hC={none:"",subtle:"paper-texture-subtle",medium:"paper-texture-medium",vintage:"paper-texture-vintage",custom:""},fC={Straight:"Straight",Quadratic:"Quadratic",Cubic:"Cubic",Step:"Step (L-shaped)",Orthogonal:"Orthogonal (Z-shaped)",TreeCubic:"Tree: Cubic",TreeLStep:"Tree: L-Step",TreeZShape:"Tree: Z-Shape"},De=class De{static getSelectionRingClass(e){return e?De._selectionRingClass:""}static getSelectedBorderClass(e){return e?De._selectedBorderClass:""}static getNodePaddingClass(e){return e===Ve.TEXT?"px-2 py-1":"p-2"}static getNodeCursorClass(e,t){return e===Ua.SELECT?t?"cursor-grabbing":"cursor-grab":""}};Z(De,"_debug",{exposeActions:!0}),Z(De,"persistState",!0),Z(De,"autosave",!0),Z(De,"hideToolbar",!1),Z(De,"hideOverlay",!1),Z(De,"background",{paperTexture:"none",customParams:null,savedPresets:[]}),Z(De,"arrows",{styles:{line:"hsl(var(--muted-light))",lineSelected:"hsl(var(--primary))"},type:"Cubic",REVERSE_CURVE:!1,CUBIC_ARROW_S_SHAPE_FACTOR:1,CUBIC_ARROW_S_SHAPE_REVERSED:!1,CUBIC_HORIZONTAL_BIAS:1,CUBIC_CONTROL_DISTANCE_MODE:"scaled-minimum",reverseArrowOnMultipleConnect:!0}),Z(De,"copyMode",{autoDrawArrows:!0}),Z(De,"highlightAndCreate",{createConnectingArrow:!1,createHighlight:!1,addHorizontally:!0}),Z(De,"nodeOptions",{maxNodeWidth:600,resizeBorderWidth:10}),Z(De,"nodeStyles",{textAlign:"left",fontSize:`${rt.FONT_SIZE_DEFAULT}px`,fontWeight:"400",border:"",borderWidth:"",borderStyle:"",borderColor:"",backgroundColor:"",textColor:""}),Z(De,"zoom",{min:.01,max:4,intensity:.1,marks:[.09,.6,1,1.3,2]}),Z(De,"text",{debounceInput:300,fontSize:`${rt.FONT_SIZE_DEFAULT}px`,paddingLeft:4,lineHeight:rt.LINE_HEIGHT_CONFIG}),Z(De,"writeMode",{createAtMousePosition:!0,scrollDuration:3e3,scrollYRatio:.8,scrollVerticalPositionRatio:.75}),Z(De,"paste",{fixedWidth:550,maxWidth:550,adjustSizeOnPaste:!0}),Z(De,"LinterPreset",Bo),Z(De,"lint",{onPastePreset:Bo.SIMPLE}),Z(De,"contentCapture",{pasteWidth:700,nodeGap:80,depthOffset:125}),Z(De,"arrange",{gap:60,gridNodeWidth:550,gridColumns:3,gridRows:3,autoGroupOnArrange:!0,cleanUpGap:14,cleanUpRowThreshold:.5}),Z(De,"animation",{enabled:!0,durationMs:200,easing:"ease-out",splitDelayMs:50}),Z(De,"groups",{autoAddNodesOnExpand:!0}),Z(De,"slice",{laneGap:150,laneHeaderOffset:30,nodeGap:20}),Z(De,"autoScroll",{edgeThreshold:100,edgeThresholdMobile:30,scrollSpeed:15}),Z(De,"keyboardScroll",{animationDuration:300,targetScreenYRatio:.33,minKeyboardHeight:100}),Z(De,"tabBar",{maxTabWidth:150,dragSourceOpacity:.5,dragPreviewOpacity:.2,dropIndicator:{width:2,opacity:.4}}),Z(De,"slashCommand",{menuGapAboveInput:24}),Z(De,"dataTable",{dragHandleWidth:32}),Z(De,"claudeChat",{popoverRightGap:30,alignScrollDuration:500,alignNodeWithChatInput:!1,autoFocusOnWindowFocus:!0}),Z(De,"chatInput",{mobile:{bottomOffset:5,nodeGapRight:20,fontConfig:Ze.xnormal,get nodeFontSize(){return this.fontConfig.cssFontSize}},tabletBreakpoint:1280,maxRows:4}),Z(De,"chatNode",{viewMode:"fullwidth",windowed:{mobileViewportGap:10,desktopViewportGap:20},fullwidth:{contentPadding:20},defaultMaxHeight:600,desktopWidth:500,desktopHeight:400,desktopRightGap:20,messageGap:4,messagePadding:6,scrollSide:"right",scrollAreaWidth:"10vw"}),Z(De,"nodeUI",{idleOpacity:.1,quickPanelGap:30,resizeHandleIdleOpacity:.3,quickArrowHandleIdleOpacity:.3}),Z(De,"canvasTable",{dropBehavior:"delete"}),Z(De,"history",{historyLimit:100,tabletHistoryLimit:30,archiveLimit:500,tabletArchiveLimit:200,tabletBreakpoint:768,holdRepeatIntervalMs:180}),Z(De,"holdToSelect",{holdDurationMs:800,movementThresholdPx:10,indicatorDelayMs:200,indicatorTopOffset:48,indicatorBottomOffset:80}),Z(De,"holdToDrag",{holdDelayMs:400,movementThresholdPx:10,enableChatNodeHighlight:!1}),Z(De,"drawing",{strokeGroupingTimeoutMs:1500,isRightHandMode:!0,markerOpacity:.3,markerColor:"#facc15",smoothingFactor:0,minPointDistance:0,compression:{enabled:!0,level:30}}),Z(De,"_selectionRingClass","ring-1 ring-ring ring-offset-1"),Z(De,"_selectedBorderClass","border-ring");let $e=De;const dg=(s,e,t,n)=>({left:-s.x/e,top:-s.y/e,right:(-s.x+t)/e,bottom:(-s.y+n)/e}),ug=(s,e,t,n,r)=>{const o=s.x+(s.width??100)/2,i=s.y+(s.height??50)/2,c=(r==null?void 0:r.verticalPositionRatio)??.5,l=t/2-o*e,d=n*c-i*e;return{x:l,y:d}},pg=(s,e,t,n=500,r)=>{const{uiState:o,projectCanvas:i,setActiveCanvasViewState:c}=e(),l=i.getActive();if(!l){console.warn("Cannot center view: No active canvas.");return}const d=l.coreState.nodes,p=l.viewState.scale,u=typeof t=="string"?d==null?void 0:d.find(v=>v.id===t):t,f=o==null?void 0:o.canvasWidth,m=o==null?void 0:o.canvasHeight;if(!u){console.warn("Cannot center view: Node dimensions not found.");return}if(!f||!m){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=l.viewState.offset;dg(g,p,f,m);const x=ug(u,p,f,m,r!=null&&r.verticalOnly?{verticalPositionRatio:$e.writeMode.scrollVerticalPositionRatio}:void 0),b=r!=null&&r.verticalOnly?{x:g.x,y:x.y}:x;c(v=>({...v,targetView:{targetOffset:b,targetScale:p,animationStartTime:0,animationDuration:n}}))},hg=(s,e,t)=>({x:Number(((s.x-t.x)/e).toFixed(3)),y:Number(((s.y-t.y)/e).toFixed(3))}),fg=s=>{const{projectCanvas:e}=s(),t=Rl.getState(),n=t==null?void 0:t.mousePosition,r=e.getActive(),o=(r==null?void 0:r.viewState.scale)??1,i=(r==null?void 0:r.viewState.offset)??{x:0,y:0};return!n||!r?null:hg(n,o,i)};var Qc=Symbol.for("immer-nothing"),Wo=Symbol.for("immer-draftable"),yt=Symbol.for("immer-state");function Lt(s,...e){throw new Error(`[Immer] minified error nr: ${s}. Full error at: https://bit.ly/3cXEKWf`)}var en=Object.getPrototypeOf;function As(s){return!!s&&!!s[yt]}function gs(s){var e;return s?Zc(s)||Array.isArray(s)||!!s[Wo]||!!((e=s.constructor)!=null&&e[Wo])||xn(s)||hr(s):!1}var mg=Object.prototype.constructor.toString(),zo=new WeakMap;function Zc(s){if(!s||typeof s!="object")return!1;const e=Object.getPrototypeOf(s);if(e===null||e===Object.prototype)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;if(t===Object)return!0;if(typeof t!="function")return!1;let n=zo.get(t);return n===void 0&&(n=Function.toString.call(t),zo.set(t,n)),n===mg}function Hn(s,e,t=!0){pr(s)===0?(t?Reflect.ownKeys(s):Object.keys(s)).forEach(r=>{e(r,s[r],s)}):s.forEach((n,r)=>e(r,n,s))}function pr(s){const e=s[yt];return e?e.type_:Array.isArray(s)?1:xn(s)?2:hr(s)?3:0}function ra(s,e){return pr(s)===2?s.has(e):Object.prototype.hasOwnProperty.call(s,e)}function el(s,e,t){const n=pr(s);n===2?s.set(e,t):n===3?s.add(t):s[e]=t}function gg(s,e){return s===e?s!==0||1/s===1/e:s!==s&&e!==e}function xn(s){return s instanceof Map}function hr(s){return s instanceof Set}function ls(s){return s.copy_||s.base_}function aa(s,e){if(xn(s))return new Map(s);if(hr(s))return new Set(s);if(Array.isArray(s))return Array.prototype.slice.call(s);const t=Zc(s);if(e===!0||e==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(s);delete n[yt];let r=Reflect.ownKeys(n);for(let o=0;o<r.length;o++){const i=r[o],c=n[i];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(n[i]={configurable:!0,writable:!0,enumerable:c.enumerable,value:s[i]})}return Object.create(en(s),n)}else{const n=en(s);if(n!==null&&t)return{...s};const r=Object.create(n);return Object.assign(r,s)}}function Wa(s,e=!1){return fr(s)||As(s)||!gs(s)||(pr(s)>1&&Object.defineProperties(s,{set:yn,add:yn,clear:yn,delete:yn}),Object.freeze(s),e&&Object.values(s).forEach(t=>Wa(t,!0))),s}function xg(){Lt(2)}var yn={value:xg};function fr(s){return s===null||typeof s!="object"?!0:Object.isFrozen(s)}var vg={};function xs(s){const e=vg[s];return e||Lt(0,s),e}var tn;function tl(){return tn}function bg(s,e){return{drafts_:[],parent_:s,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Ho(s,e){e&&(xs("Patches"),s.patches_=[],s.inversePatches_=[],s.patchListener_=e)}function oa(s){ia(s),s.drafts_.forEach(wg),s.drafts_=null}function ia(s){s===tn&&(tn=s.parent_)}function Go(s){return tn=bg(tn,s)}function wg(s){const e=s[yt];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function qo(s,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return s!==void 0&&s!==t?(t[yt].modified_&&(oa(e),Lt(4)),gs(s)&&(s=Gn(e,s),e.parent_||qn(e,s)),e.patches_&&xs("Patches").generateReplacementPatches_(t[yt].base_,s,e.patches_,e.inversePatches_)):s=Gn(e,t,[]),oa(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),s!==Qc?s:void 0}function Gn(s,e,t){if(fr(e))return e;const n=s.immer_.shouldUseStrictIteration(),r=e[yt];if(!r)return Hn(e,(o,i)=>Vo(s,r,e,o,i,t),n),e;if(r.scope_!==s)return e;if(!r.modified_)return qn(s,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const o=r.copy_;let i=o,c=!1;r.type_===3&&(i=new Set(o),o.clear(),c=!0),Hn(i,(l,d)=>Vo(s,r,o,l,d,t,c),n),qn(s,o,!1),t&&s.patches_&&xs("Patches").generatePatches_(r,t,s.patches_,s.inversePatches_)}return r.copy_}function Vo(s,e,t,n,r,o,i){if(r==null||typeof r!="object"&&!i)return;const c=fr(r);if(!(c&&!i)){if(As(r)){const l=o&&e&&e.type_!==3&&!ra(e.assigned_,n)?o.concat(n):void 0,d=Gn(s,r,l);if(el(t,n,d),As(d))s.canAutoFreeze_=!1;else return}else i&&t.add(r);if(gs(r)&&!c){if(!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||e&&e.base_&&e.base_[n]===r&&c)return;Gn(s,r),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&(xn(t)?t.has(n):Object.prototype.propertyIsEnumerable.call(t,n))&&qn(s,r)}}}function qn(s,e,t=!1){!s.parent_&&s.immer_.autoFreeze_&&s.canAutoFreeze_&&Wa(e,t)}function yg(s,e){const t=Array.isArray(s),n={type_:t?1:0,scope_:e?e.scope_:tl(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:s,draft_:null,copy_:null,revoke_:null,isManual_:!1};let r=n,o=za;t&&(r=[n],o=sn);const{revoke:i,proxy:c}=Proxy.revocable(r,o);return n.draft_=c,n.revoke_=i,c}var za={get(s,e){if(e===yt)return s;const t=ls(s);if(!ra(t,e))return Sg(s,t,e);const n=t[e];return s.finalized_||!gs(n)?n:n===Er(s.base_,e)?(Ir(s),s.copy_[e]=la(n,s)):n},has(s,e){return e in ls(s)},ownKeys(s){return Reflect.ownKeys(ls(s))},set(s,e,t){const n=sl(ls(s),e);if(n!=null&&n.set)return n.set.call(s.draft_,t),!0;if(!s.modified_){const r=Er(ls(s),e),o=r==null?void 0:r[yt];if(o&&o.base_===t)return s.copy_[e]=t,s.assigned_[e]=!1,!0;if(gg(t,r)&&(t!==void 0||ra(s.base_,e)))return!0;Ir(s),ca(s)}return s.copy_[e]===t&&(t!==void 0||e in s.copy_)||Number.isNaN(t)&&Number.isNaN(s.copy_[e])||(s.copy_[e]=t,s.assigned_[e]=!0),!0},deleteProperty(s,e){return Er(s.base_,e)!==void 0||e in s.base_?(s.assigned_[e]=!1,Ir(s),ca(s)):delete s.assigned_[e],s.copy_&&delete s.copy_[e],!0},getOwnPropertyDescriptor(s,e){const t=ls(s),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:s.type_!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty(){Lt(11)},getPrototypeOf(s){return en(s.base_)},setPrototypeOf(){Lt(12)}},sn={};Hn(za,(s,e)=>{sn[s]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});sn.deleteProperty=function(s,e){return sn.set.call(this,s,e,void 0)};sn.set=function(s,e,t){return za.set.call(this,s[0],e,t,s[0])};function Er(s,e){const t=s[yt];return(t?ls(t):s)[e]}function Sg(s,e,t){var r;const n=sl(e,t);return n?"value"in n?n.value:(r=n.get)==null?void 0:r.call(s.draft_):void 0}function sl(s,e){if(!(e in s))return;let t=en(s);for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=en(t)}}function ca(s){s.modified_||(s.modified_=!0,s.parent_&&ca(s.parent_))}function Ir(s){s.copy_||(s.copy_=aa(s.base_,s.scope_.immer_.useStrictShallowCopy_))}var jg=class{constructor(s){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,n)=>{if(typeof e=="function"&&typeof t!="function"){const o=t;t=e;const i=this;return function(l=o,...d){return i.produce(l,p=>t.call(this,p,...d))}}typeof t!="function"&&Lt(6),n!==void 0&&typeof n!="function"&&Lt(7);let r;if(gs(e)){const o=Go(this),i=la(e,void 0);let c=!0;try{r=t(i),c=!1}finally{c?oa(o):ia(o)}return Ho(o,n),qo(r,o)}else if(!e||typeof e!="object"){if(r=t(e),r===void 0&&(r=e),r===Qc&&(r=void 0),this.autoFreeze_&&Wa(r,!0),n){const o=[],i=[];xs("Patches").generateReplacementPatches_(e,r,o,i),n(o,i)}return r}else Lt(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(i,...c)=>this.produceWithPatches(i,l=>e(l,...c));let n,r;return[this.produce(e,t,(i,c)=>{n=i,r=c}),n,r]},typeof(s==null?void 0:s.autoFreeze)=="boolean"&&this.setAutoFreeze(s.autoFreeze),typeof(s==null?void 0:s.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(s.useStrictShallowCopy),typeof(s==null?void 0:s.useStrictIteration)=="boolean"&&this.setUseStrictIteration(s.useStrictIteration)}createDraft(s){gs(s)||Lt(8),As(s)&&(s=Cg(s));const e=Go(this),t=la(s,void 0);return t[yt].isManual_=!0,ia(e),t}finishDraft(s,e){const t=s&&s[yt];(!t||!t.isManual_)&&Lt(9);const{scope_:n}=t;return Ho(n,e),qo(void 0,n)}setAutoFreeze(s){this.autoFreeze_=s}setUseStrictShallowCopy(s){this.useStrictShallowCopy_=s}setUseStrictIteration(s){this.useStrictIteration_=s}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(s,e){let t;for(t=e.length-1;t>=0;t--){const r=e[t];if(r.path.length===0&&r.op==="replace"){s=r.value;break}}t>-1&&(e=e.slice(t+1));const n=xs("Patches").applyPatches_;return As(s)?n(s,e):this.produce(s,r=>n(r,e))}};function la(s,e){const t=xn(s)?xs("MapSet").proxyMap_(s,e):hr(s)?xs("MapSet").proxySet_(s,e):yg(s,e);return(e?e.scope_:tl()).drafts_.push(t),t}function Cg(s){return As(s)||Lt(10,s),nl(s)}function nl(s){if(!gs(s)||fr(s))return s;const e=s[yt];let t,n=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=aa(s,e.scope_.immer_.useStrictShallowCopy_),n=e.scope_.immer_.shouldUseStrictIteration()}else t=aa(s,!0);return Hn(t,(r,o)=>{el(t,r,nl(o))},n),e&&(e.finalized_=!1),t}var Ng=new jg,Q=Ng.produce;const Ha=s=>{var n,r,o;if(!s.state)return null;const e=s.state.activeProjectId?(n=s.state.projects)==null?void 0:n[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?(r=e.workspaces)==null?void 0:r[e.activeWorkspaceId]:null;return t&&t.activeCanvasId?(o=t.canvases)==null?void 0:o[t.activeCanvasId]:null},kg=(s,e)=>s(Q(t=>{t.uiState.temporaryArrow=e})),Eg=(s,e)=>s(Q(t=>{var r,o,i,c,l,d;const n=Ha(t);if(n!=null&&n.coreState){const p=typeof e=="function"?e(n.coreState.arrows):e;n.coreState.arrows=p,n.coreState.selectedArrows.length>0&&(n.coreState.selectedArrows=n.coreState.selectedArrows.map(m=>p.find(x=>x.id===m.id)||m)),n.lastModified=Date.now();const u=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];u&&(u.lastModified=Date.now());const f=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];f&&(f.lastModified=Date.now())}})),Ig=(s,e)=>s(Q(t=>{var r,o,i,c,l,d;const n=Ha(t);if(n!=null&&n.coreState){const p=Array.isArray(e)?e:[],u=new Set(p.map(g=>g.id));n.coreState.selectedArrows=n.coreState.arrows.filter(g=>u.has(g.id)),n.lastModified=Date.now();const f=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];f&&(f.lastModified=Date.now());const m=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];m&&(m.lastModified=Date.now())}})),Tg=(s,e)=>s(Q(t=>{var r,o,i,c,l,d;const n=Ha(t);if(n!=null&&n.coreState){n.coreState.arrows.push(e),n.lastModified=Date.now();const p=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];p&&(p.lastModified=Date.now());const u=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];u&&(u.lastModified=Date.now())}})),Ag=(s,e,t,n)=>{s(Q(r=>{var l,d;const o=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o!=null&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i!=null&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if((d=c==null?void 0:c.coreState)!=null&&d.arrows){const p=c.coreState.arrows.findIndex(u=>u.id===t);if(p!==-1){if(c.coreState.arrows[p]={...c.coreState.arrows[p],...n},c.coreState.selectedArrows){const f=c.coreState.selectedArrows.findIndex(m=>m.id===t);f!==-1&&(c.coreState.selectedArrows[f]={...c.coreState.selectedArrows[f],...n})}const u=Date.now();c.lastModified=u,i&&(i.lastModified=u),o&&(o.lastModified=u)}}}))},Pg=(s,e)=>({setTemporary:t=>kg(s,t),setAll:t=>Eg(s,t),setSelected:t=>Ig(s,t),add:t=>Tg(s,t),update:(t,n)=>Ag(s,e,t,n)});function Rg(s,e=getComputedStyle(document.body).font){if(!s)return 0;const n=document.createElement("canvas").getContext("2d");return n?(n.font=e,n.measureText(s).width):0}const Dg=6;function _g(s,e=getComputedStyle(document.body).font){return s?s.split(/\n|&nbsp;/).map(r=>{const o=al(r),i=il(e,o),c=ol(r);let l=Rg(c,i);return rl(r)&&(l+=Dg),l}).reduce((r,o)=>Math.max(r,o),0):0}function Og(s){const e=s.trimStart();return e.startsWith("### ")?1.2:e.startsWith("## ")?1.35:e.startsWith("# ")?1.5:1}function rl(s){const e=s.trimStart();return!!(e.startsWith("- ")||/^\d+\.\s/.test(e))}function al(s){const e=s.trimStart();return e.startsWith("### ")?1.125:e.startsWith("## ")?1.25:e.startsWith("# ")?1.5:1}function ol(s){const e=s.trimStart(),t=s.length-e.length,n=s.substring(0,t);if(e.startsWith("### "))return n+e.slice(4);if(e.startsWith("## "))return n+e.slice(3);if(e.startsWith("# ")||e.startsWith("> ")||e.startsWith("- "))return n+e.slice(2);const r=e.match(/^(\d+)\.\s/);return r?n+e.slice(r[0].length):s}function il(s,e){if(e===1)return s;const t=s.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/);if(!t)return s;const n=parseFloat(t[1]),r=t[2],o=n*e;return s.replace(t[0],`${o}${r}`)}function Vn(s,e,t=getComputedStyle(document.body).font,n){if(!s)return 0;const o=document.createElement("canvas").getContext("2d");if(!o)return 0;o.font=t;const i=t.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/),l=(i?parseFloat(i[1]):16)*1.5,d=n??l;if(d===0)return console.warn("measureWrappedTextHeight: Could not determine line height. Using fallback."),s.split(`
`).length*16;const p=s.split(`
`);let u=0,f=!1,m=!1,g=!0;for(const b of p){if(b.trim()===""){u+=d,m=!1,g=!1;continue}const v=rl(b);v&&!m&&!g&&(u+=d),m=v,g=!1;const w=Og(b);w>1&&(f=!0);const y=d*w,j=al(b),S=il(t,j);o.font=S;const N=ol(b).split(" ");let A="",k=1;for(let E=0;E<N.length;E++){const R=N[E],M=A+(A?" ":"")+R;o.measureText(M).width>e&&A!==""?(k++,A=R,o.measureText(R).width>e):A=M}u+=k*y}let x=u+(f?Am:0);return x+=Pm,x}function Lg(s,e){if(!s)return 0;const{containerWidth:t,textarea:n,fontSize:r,skipPaddingSubtraction:o=!1}=e,i=n||document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(!i)return Vn(s,t);const c=window.getComputedStyle(i),l=r??`${rt.FONT_SIZE_DEFAULT}px`,d=c.fontFamily,u=`${c.fontWeight} ${l} ${d}`,f=void 0;let m=t;if(!o){const b=_m(l).horizontal*2;m=t-b}return Vn(s,m,u,f)}function Mg(s,e,t){const n=Fg(t);return Lg(s,{containerWidth:e,fontSize:n,skipPaddingSubtraction:!0})+rt.NODE_Y_PADDING}function Fg(s){var e;return(e=s==null?void 0:s.styles)==null?void 0:e.fontSize}const{DEFAULT_NODE_WIDTH:Kn,DEFAULT_NODE_HEIGHT:Jn}=rt,vs=s=>{const e=s.x,t=s.y,n=s.width??Kn,r=s.height??Jn;return{x1:e,y1:t,x2:e+n,y2:t+r}},mC=(s,e,t)=>{const n=t?new Set(t):null;for(let r=e.length-1;r>=0;r--){const o=e[r];if(n&&n.has(o.id))continue;const i=vs(o);if(s.x>=i.x1&&s.x<=i.x2&&s.y>=i.y1&&s.y<=i.y2)return o}return null},Ko=s=>{const e=s.x,t=s.y,n=s.width??Kn,r=s.height??Jn;return{x:e+n/2,y:t+r/2}},gC=(s,e)=>s.x===e.x&&s.y===e.y,$g=()=>{const s=document.querySelector("textarea[data-node-textarea]"),e=document.querySelector(".markdown-textarea[data-node-textarea]"),t=s||e;if(t){const r=window.getComputedStyle(t).lineHeight;if(r&&r!=="normal"){const o=parseFloat(r);if(!isNaN(o))return o}}},Ug=(s,e,t)=>{const n=_g(s)+Dm.textNodeXPadding,r=Mg(s,n,t);return{width:n,height:r}},xC=(s,e)=>{const t=vs(s),n=vs(e);return t.x1>=n.x1&&t.y1>=n.y1&&t.x2<=n.x2&&t.y2<=n.y2},Bg=(s,e)=>{const t=vs(e);return s.filter(n=>{if(n.id===e.id)return!1;const r=vs(n);return!(r.x2<t.x1||r.x1>t.x2||r.y2<t.y1||r.y1>t.y2)})},Wg=(s,e="bottom")=>{if(!s.length)return null;switch(e){case"left":return s.reduce((t,n)=>n.x<t.x?n:t,s[0]);case"right":return s.reduce((t,n)=>n.x+(n.width??Kn)>t.x+(t.width??Kn)?n:t,s[0]);case"top":return s.reduce((t,n)=>n.y<t.y?n:t,s[0]);case"bottom":return s.reduce((t,n)=>n.y+(n.height??Jn)>t.y+(t.height??Jn)?n:t,s[0]);default:return null}},Os=s=>(e,t)=>{s(n=>{if(!n.state)return n;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return n;const c=i.coreState,l=c.nodes.findIndex(g=>g.id===e);if(l===-1)return n;const d=new Date().toISOString(),p={...t,updatedAt:d},u=[...c.nodes];u[l]={...u[l],...p};const m=c.selectedNodes.some(g=>g.id===e)?c.selectedNodes.map(g=>g.id===e?{...g,...p}:g):c.selectedNodes;return window.__nodes=u,window.__selectedNodes=m,{...n,state:{...n.state,projects:{...n.state.projects,[n.state.activeProjectId]:{...r,lastModified:Date.now(),workspaces:{...r.workspaces,[r.activeWorkspaceId]:{...o,lastModified:Date.now(),canvases:{...o.canvases,[o.activeCanvasId]:{...i,coreState:{...c,nodes:u,selectedNodes:m},lastModified:Date.now()}}}}}}}}})},zg=(s,e)=>s(t=>({uiState:{...t.uiState,mode:e}})),Hg=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:e}})),Gg=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:t.uiState.zoomSubMode==="zoom:lock"?"zoom":"zoom:lock"}})),qg=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:e}})),Vg=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:t.uiState.writeSubMode===Pn.AUDIO?Pn.WRITE:Pn.AUDIO}})),Kg=(s,e)=>s(t=>({uiState:{...t.uiState,arrowSubMode:e}})),Jg=s=>s(e=>({uiState:{...e.uiState,arrowSubMode:e.uiState.arrowSubMode===Rn.STAY?Rn.DEFAULT:Rn.STAY}})),Yg=(s,e)=>s(()=>({mousePosition:e})),Xg=(s,e)=>s(t=>({uiState:{...t.uiState,isPanning:e}})),Qg=(s,e)=>s(t=>({uiState:{...t.uiState,isHoldSelectActive:e}})),Zg=(s,e)=>s(t=>({uiState:{...t.uiState,holdSelectProgress:e}})),ex=(s,e)=>s(t=>({uiState:{...t.uiState,selectionBox:e}})),tx=(s,e)=>s(t=>({uiState:{...t.uiState,pendingSelectionStart:e}})),sx=(s,e)=>s(t=>({uiState:{...t.uiState,writeModeStartPosition:e}})),nx=(s,e)=>s(t=>({uiState:{...t.uiState,dragInfo:e}})),rx=(s,e)=>s(t=>({uiState:{...t.uiState,groupDragInfo:e}})),ax=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetGroupId:e}})),ox=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetVocabNodeId:e}})),ix=s=>s(e=>({uiState:{...e.uiState,dragVersion:(e.uiState.dragVersion??0)+1}})),cx=(s,e)=>s(t=>({uiState:{...t.uiState,tableDropTarget:e}})),lx=(s,e)=>s(t=>({uiState:{...t.uiState,resizingNode:e}})),dx=(s,e)=>s(t=>({uiState:{...t.uiState,resizingGroup:e}})),ux=(s,e)=>s(t=>({uiState:{...t.uiState,nodeToFocusId:e}})),px=(s,e)=>{var n;if(!e)return;const t=s().projectCanvas.getActive();return(n=t==null?void 0:t.coreState.nodes)==null?void 0:n.find(r=>r.id===e)},hx=(s,e)=>s(t=>({uiState:{...t.uiState,addNodeType:e}})),fx=(s,e,t=!1)=>s(n=>({uiState:{...n.uiState,activeChatNodeId:e,activeChatNodePinned:t}})),mx=(s,e)=>s(t=>({uiState:{...t.uiState,chatNodeHoldToDrag:e}})),gx=(s,e)=>s(t=>({uiState:{...t.uiState,nodeHoldToResize:e}})),xx=(s,e,t)=>s(n=>({uiState:{...n.uiState,canvasWidth:e,canvasHeight:t}})),vx=(s,e)=>s(t=>({uiState:e(t.uiState)})),bx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{if(n.nodes.length>0&&e.length===0)return console.trace("NOOO should not happend"),n;const r=typeof e=="function"?e(n.nodes):e;return{...n,nodes:r}}),{})),wx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=Array.isArray(e)?e:[],o=new Set(r.map(l=>l.id)),i=n.nodes.map(l=>({...l,isEditing:!1})),c=i.filter(l=>o.has(l.id));return{...n,nodes:i,selectedNodes:c}}),{})),yx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.selectedNodes.filter(i=>i.id!==e),o=n.nodes.map(i=>i.id===e?{...i,isEditing:!1}:i);return{...n,nodes:o,selectedNodes:r}}),{})),Sx=(s,e,t,n={dontOverlap:!1,dontSelect:!1})=>s(r=>(r.setActiveCanvasCoreState(o=>{var b;const i=new Date().toISOString(),c=o.activeLayerId,l=o.layers??[],d=l.find(v=>v.id===c);let p;if(d&&!d.isLocked)p=c??void 0;else if(l.length>0){const v=l.find(w=>!w.isLocked);p=(v==null?void 0:v.id)??((b=l[0])==null?void 0:b.id)}const u={...e,createdAt:e.createdAt??i,updatedAt:i,...p?{layerId:p}:{}};t!==void 0&&(u.content=t);const f=o.nodes;if(n.dontOverlap){const v=Bg(f,e);if(v.length>0){const w=Wg(v,"right");if(w){const y=w.x+(w.width??0);u.x=y+rt.nodeSpacing}}}let m;if(!u.groupId&&u.type!==Ve.GROUP){const v=f.filter(j=>j.type===Ve.GROUP),w=vs(u),y=v.find(j=>{const S=vs(j),C=w.x1+(w.x2-w.x1)/2,N=w.y1+(w.y2-w.y1)/2;return C>=S.x1&&C<=S.x2&&N>=S.y1&&N<=S.y2});y&&(u.groupId=y.id,m=y.id)}let g=[...f,u];m&&(g=g.map(v=>{if(v.id===m){const w=v.data??{},y=w.childNodeIds??[];return{...v,data:{...w,childNodeIds:[...y,u.id]},updatedAt:i}}return v}));const x=n.dontSelect?o.selectedNodes:[u];return{...o,nodes:g,selectedNodes:x,selectedArrows:n.dontSelect?o.selectedArrows:[]}}),{})),jx=(s,e)=>s(t=>({state:e(t.state)})),Cx=s=>(e,t)=>Os(s)(e,{content:t}),Nx=s=>(e,t)=>Os(s)(e,{subContent:t}),kx=s=>(e,t)=>Os(s)(e,{title:t}),Ex=s=>(e,t)=>Os(s)(e,{...t}),Ix=s=>{var t;const e=s().projectCanvas.getActive();return(t=e==null?void 0:e.coreState.nodes)==null?void 0:t.find(n=>n.isEditing)},Tx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.nodes.find(d=>d.id===e),o=new Set([e]);if((r==null?void 0:r.type)===Ve.CHAT){const d=r.data;d!=null&&d.childNodeIds&&d.childNodeIds.forEach(p=>o.add(p))}const i=n.nodes.filter(d=>!o.has(d.id)),c=n.selectedNodes.filter(d=>!o.has(d.id)),l=n.arrows.filter(d=>(d.startNodeId===null||!o.has(d.startNodeId))&&(d.endNodeId===null||!o.has(d.endNodeId)));return{...n,nodes:i,selectedNodes:c,arrows:l}}),t.uiState.nodeToFocusId===e&&s(n=>({uiState:{...n.uiState,nodeToFocusId:null}})),{})),Ax=s=>s(e=>(e.setActiveCanvasCoreState(t=>({...t,nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]})),{})),Px=(s,e)=>s(t=>({flags:e(t.flags)})),Rx=s=>s(Ba),Dx=s=>s(e=>({uiState:{...e.uiState,isOverlayVisible:!e.uiState.isOverlayVisible}})),_x=s=>s(e=>({uiState:{...e.uiState,useCurvedArrows:!e.uiState.useCurvedArrows}})),Ox=(s,e)=>s(t=>({uiState:{...t.uiState,customNodeDropdownOpen:e}})),Lx=(s,e)=>s(t=>({uiState:{...t.uiState,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[],...t.uiState.nodeUpdateSettings||{},...e}}})),Mx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:e.sort((n,r)=>n-r)}})),Fx=(s,e)=>s(t=>{const n=t.uiState.zoomMarks||[];return n.includes(e)?t:{uiState:{...t.uiState,zoomMarks:[...n,e].sort((r,o)=>r-o)}}}),$x=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:(t.uiState.zoomMarks||[]).filter(n=>n!==e)}})),Ux=(s,e)=>s(t=>({uiState:{...t.uiState,activeGlobalOverlay:e}})),Bx=(s,e)=>s(t=>({uiState:{...t.uiState,arrangeSnapshot:e}})),Wx=s=>s(Q(e=>{const t=e.uiState.arrangeSnapshot;if(!t||!e.state)return;const n=e.state.activeProjectId?e.state.projects[e.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(o){for(const[i,c]of Object.entries(t.nodePositions)){const l=o.coreState.nodes.find(d=>d.id===i);l&&(l.x=c.x,l.y=c.y,c.width!==void 0&&(l.width=c.width),c.height!==void 0&&(l.height=c.height),l.updatedAt=new Date().toISOString())}o.coreState.selectedNodes=o.coreState.selectedNodes.map(i=>{const c=t.nodePositions[i.id];return c?{...i,x:c.x,y:c.y,width:c.width??i.width,height:c.height??i.height,updatedAt:new Date().toISOString()}:i}),e.uiState.arrangeSnapshot=null}})),zx=s=>s(e=>({uiState:{...e.uiState,arrangeSnapshot:null}})),Hx=(s,e)=>{s(t=>{if(!t.state)return t;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!o)return t;const i=e(o.viewState);if(i===o.viewState)return t;const c=Date.now();return{...t,state:{...t.state,projects:{...t.state.projects,[t.state.activeProjectId]:{...n,lastModified:c,workspaces:{...n.workspaces,[n.activeWorkspaceId]:{...r,lastModified:c,canvases:{...r.canvases,[r.activeCanvasId]:{...o,viewState:i,lastModified:c}}}}}}}}})},Gx=(s,e)=>s(Q(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;o&&(o.coreState=e(o.coreState),o.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now()))})),qx=s=>{s.forEach(e=>localStorage.removeItem(e)),window.location.reload()},Vx=s=>e=>{s(Q(t=>{var l;if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!((l=o==null?void 0:o.coreState)!=null&&l.nodes))return;const i=new Date().toISOString();let c=null;o.coreState.nodes=o.coreState.nodes.map(d=>{const p=e.find(m=>m.id===d.id);if(!p)return d;let u=!1,f=!1;for(const m in p)if(p[m]!==d[m]){u=!0,(m==="x"||m==="y")&&(f=!0);break}return u&&f&&(c=d.id),u?{...d,...p,updatedAt:i}:d}),c&&(t.uiState.lastUpdatedNodeId=c),o.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now())}),!1)},Kx=s=>(e,t)=>{Os(s)(e,{styles:t})};function Jx(){return Math.random().toString(36).substring(2,9)}let cl=0;function vC(){let s=Date.now().toString(25);return s+=cl++,`${Jx()}-${s}`}function Yx(){let s=Date.now().toString(25);return s+="_"+cl++,s}const Xx=/^c-(\d+_)?(.+)$/;function ll(s){const e=Xx.exec(s),t=Yx();return e?`${e[1]?`c-${parseInt(e[1],10)+1}_`:"c-1_"}${e[2]}`+t:`c-${s}`+t}const Qx=s=>s(e=>(e.setActiveCanvasCoreState(t=>{const r=t.selectedNodes.map(o=>{const i=o.height??rt.DEFAULT_NODE_HEIGHT,c=o.y+i+rt.nodeSpacing,l=ll(o.id);return{...o,id:l,y:c,x:o.x+rt.nodeSpacing}});return{...t,nodes:[...t.nodes,...r],selectedNodes:r}}),{})),Zx=(s,e)=>({getNodeById:t=>t?px(s,t):void 0,setNodes:t=>bx(e,t),setSelectedNodes:t=>wx(e,t),unselectNodeById:t=>yx(e,t),addNode:(t,n,r)=>{var o;if(Sx(e,t,n,r),!(r!=null&&r.skipUndo)){const i=(o=s().projectCanvas.getActive())==null?void 0:o.coreState.nodes.find(c=>c.id===t.id);i&&s().undo.commit({type:"node:create",node:i})}},duplicateNodes:()=>Qx(e),updateNode:(t,n)=>Os(e)(t,n),updateNodes:t=>Vx(e)(t),updateNodeGeometry:(t,n)=>Ex(e)(t,n),updateNodeContent:(t,n)=>Cx(e)(t,n),updateNodeSubContent:(t,n)=>Nx(e)(t,n),updateNodeTitle:(t,n)=>kx(e)(t,n),updateNodeStyles:(t,n)=>Kx(e)(t,n),getEditingNode:()=>Ix(s),setActiveCanvasCoreState:t=>Gx(e,t),setState:t=>jx(e,t)}),ev=(s,e)=>{const t=e().projectCanvas.getActive();if(!t)return;const n=t.coreState.selectedNodes;if(n.length===0)return;const r=new Set(n.map(d=>d.id));for(const d of n)if(d.type===Ve.CHAT){const p=d.data;p!=null&&p.childNodeIds&&p.childNodeIds.forEach(u=>r.add(u))}const o=r,i=t.coreState.nodes.filter(d=>o.has(d.id)),c=t.coreState.arrows.filter(d=>d.startNodeId&&o.has(d.startNodeId)||d.endNodeId&&o.has(d.endNodeId)),l=new Map;for(const d of c){if(d.startNodeId&&o.has(d.startNodeId)){const p=l.get(d.startNodeId)||[];p.push(d),l.set(d.startNodeId,p)}if(d.endNodeId&&o.has(d.endNodeId)){const p=l.get(d.endNodeId)||[];p.includes(d)||p.push(d),l.set(d.endNodeId,p)}}if(s(d=>(d.setActiveCanvasCoreState(p=>{const u=p.nodes.filter(m=>!o.has(m.id)),f=p.arrows.filter(m=>!(m.startNodeId&&o.has(m.startNodeId)||m.endNodeId&&o.has(m.endNodeId)));return{...p,nodes:u,arrows:f,selectedNodes:[]}}),{})),i.length===1)e().undo.commit({type:"node:delete",node:i[0],connectedArrows:l.get(i[0].id)||[]});else if(i.length>1){const d=i.map(p=>({type:"node:delete",node:p,connectedArrows:l.get(p.id)||[]}));e().undo.commit({type:"batch",label:`Delete ${i.length} nodes`,operations:d})}},tv=(s,e)=>{s(t=>{const n=t.projectCanvas.getActive();if(!n)return{};const r=new Set(n.coreState.selectedArrows.map(o=>o.id));return r.size===0?{}:(t.setActiveCanvasCoreState(o=>{const i=o.arrows.filter(c=>!r.has(c.id));return{...o,arrows:i,selectedArrows:[]}}),{})})},sv=(s,e)=>({deleteSelectedNodes:()=>ev(e,s),deleteSelectedArrows:()=>tv(e),deleteNodeById:t=>{const n=s().projectCanvas.getActive(),r=n==null?void 0:n.coreState.nodes.find(i=>i.id===t),o=n==null?void 0:n.coreState.arrows.filter(i=>i.startNodeId===t||i.endNodeId===t);Tx(e,t),r&&s().undo.commit({type:"node:delete",node:r,connectedArrows:o||[]})},deleteAll:()=>Ax(e)});var us=(s=>(s.FREEHAND="draw:freehand",s.RECTANGLE="draw:rectangle",s.SQUARE="draw:square",s.CIRCLE="draw:circle",s.ELLIPSE="draw:ellipse",s.LINE="draw:line",s.ARROW="draw:arrow",s))(us||{});const dl={strokeColor:"currentColor",strokeWidth:2,strokeStyle:"solid",opacity:1},bC=2,wC=20,nv=(s,e)=>s(t=>({uiState:{...t.uiState,drawSubMode:e}})),rv=s=>s(e=>{const t=e.uiState.drawSubMode??us.FREEHAND,n=[us.FREEHAND,us.RECTANGLE,us.CIRCLE,us.LINE],o=(n.indexOf(t)+1)%n.length;return{uiState:{...e.uiState,drawSubMode:n[o]}}}),av=(s,e)=>s(t=>({uiState:{...t.uiState,temporaryDrawing:e}})),ov=(s,e)=>s(t=>({uiState:{...t.uiState,drawStyle:{...t.uiState.drawStyle??dl,...e}}})),iv=s=>s().uiState.drawSubMode??us.FREEHAND,cv=s=>s().uiState.temporaryDrawing??null,lv=s=>s().uiState.drawStyle??dl,dv=(s,e)=>s(t=>({uiState:{...t.uiState,drawAxisLock:e}})),uv=s=>s().uiState.drawAxisLock??"none",pv=(s,e)=>({setMode:t=>zg(e,t),setZoomSubMode:t=>Hg(e,t),toggleZoomSubMode:()=>Gg(e),setWriteSubMode:t=>qg(e,t),toggleWriteSubMode:()=>Vg(e),setArrowSubMode:t=>Kg(e,t),toggleArrowSubMode:()=>Jg(e),setDrawSubMode:t=>nv(e,t),toggleDrawSubMode:()=>rv(e),setTemporaryDrawing:t=>av(e,t),setDrawStyle:t=>ov(e,t),getDrawSubMode:()=>iv(s),getTemporaryDrawing:()=>cv(s),getDrawStyle:()=>lv(s),setDrawAxisLock:t=>dv(e,t),getDrawAxisLock:()=>uv(s),setActiveCanvasViewState:t=>Hx(e,t),setIsPanning:t=>Xg(e,t),setIsHoldSelectActive:t=>Qg(e,t),setHoldSelectProgress:t=>Zg(e,t),setSelectionBox:t=>ex(e,t),setPendingSelectionStart:t=>tx(e,t),setWriteModeStartPosition:t=>sx(e,t),setDragInfo:t=>nx(e,t),setGroupDragInfo:t=>rx(e,t),setHoveredDropTargetGroupId:t=>ax(e,t),setHoveredDropTargetVocabNodeId:t=>ox(e,t),incrementDragVersion:()=>ix(e),setTableDropTarget:t=>cx(e,t),setResizingNode:t=>lx(e,t),setResizingGroup:t=>dx(e,t),setNodeToFocusId:t=>ux(e,t),setAddNodeType:t=>hx(e,t),setCanvasDimensions:(t,n)=>xx(e,t,n),toggleOverlayVisibility:()=>Dx(e),toggleCurvedArrows:()=>_x(e),setCustomNodeDropdownOpen:t=>Ox(e,t),setNodeUpdateSettings:t=>Lx(e,t),setZoomMarks:t=>Mx(e,t),addZoomMark:t=>Fx(e,t),removeZoomMark:t=>$x(e,t),setUiState:t=>vx(e,t),setArrangeSnapshot:t=>Bx(e,t),revertArrangeSnapshot:()=>Wx(e),clearArrangeSnapshot:()=>zx(e),setActiveGlobalOverlay:t=>Ux(e,t),setActiveChatNodeId:(t,n=!1)=>fx(e,t,n),setChatNodeHoldToDrag:t=>mx(e,t),setNodeHoldToResize:t=>gx(e,t)}),da="gz:";async function hv(s){if(!s)return s;const t=new TextEncoder().encode(s),n=new CompressionStream("gzip"),r=n.writable.getWriter();r.write(t),r.close();const o=[],i=n.readable.getReader();for(;;){const{done:u,value:f}=await i.read();if(u)break;o.push(f)}const c=o.reduce((u,f)=>u+f.length,0),l=new Uint8Array(c);let d=0;for(const u of o)l.set(u,d),d+=u.length;const p=Array.from(l,u=>String.fromCharCode(u)).join("");return da+btoa(p)}async function yC(s){if(!s||!s.startsWith(da))return s;const e=s.slice(da.length),t=atob(e),n=Uint8Array.from(t,f=>f.charCodeAt(0)),r=new DecompressionStream("gzip"),o=r.writable.getWriter();o.write(n),o.close();const i=[],c=r.readable.getReader();for(;;){const{done:f,value:m}=await c.read();if(f)break;i.push(m)}const l=i.reduce((f,m)=>f+m.length,0),d=new Uint8Array(l);let p=0;for(const f of i)d.set(f,p),p+=f.length;return new TextDecoder().decode(d)}function Jo(s){return new Blob([s]).size}function Yo(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(2)} MB`}const fv=s=>{if(!(s!=null&&s.projects))return s;const e={};for(const[t,n]of Object.entries(s.projects)){const r={};for(const[o,i]of Object.entries(n.workspaces)){const c={};for(const[l,d]of Object.entries(i.canvases)){const{undoTree:p,...u}=d;c[l]=u}r[o]={...i,canvases:c}}e[t]={...n,workspaces:r}}return{...s,projects:e}},mv=(s,e,t)=>({saveStateToLocalStorage:()=>{const n={version:s().version,dataVersion:s().dataVersion,state:fv(s().state),uiState:s().uiState,flags:s().flags,preferences:s().preferences,extensions:s().extensions,actions:s().actions},{temporaryArrow:r,selectionBox:o,dragInfo:i,resizingNode:c,...l}=n.uiState,d=n.extensions?{registry:n.extensions.registry,settings:n.extensions.settings}:void 0,p={...n,uiState:l,extensions:d},u=JSON.stringify(p);hv(u).then(f=>{const m=Jo(u),g=Jo(f),x=((1-g/m)*100).toFixed(0);localStorage.setItem(e,f),t.log(`Canvas state saved: ${Yo(m)} â†’ ${Yo(g)} (${x}% reduction)`)}).catch(f=>{t.error("Failed to save state to localStorage",f),console.log("Failed to save state to localStorage",f),ke.error("Save failed",{description:f instanceof Error?f.message:"Failed to save canvas",duration:3e3})})}}),gv="workflow-templates-project",xv=(s,e)=>{var n,r;if(e===null)return Xo(s);const t={...s,...e,uiState:{...s.uiState,...e.uiState||{},temporaryArrow:null,selectionBox:null,dragInfo:null,resizingNode:null},state:{projects:((n=e.state)==null?void 0:n.projects)||((r=s.state)==null?void 0:r.projects)||{},...s.state,...e.state||{}},flags:{...s.flags,...e.flags||{}},preferences:{...s.preferences,...e.preferences||{}},extensions:e.extensions?{registry:e.extensions.registry||{},settings:e.extensions.settings||{}}:s.extensions};return Xo(t)},Xo=s=>{var e;return(e=s.state)!=null&&e.projects&&(s.state.projects[gv]=Xc()),s},vv=s=>{const e=s==null?void 0:s.canvasConfig;e&&(e.arrows&&(e.arrows.type&&($e.arrows.type=e.arrows.type),e.arrows.REVERSE_CURVE!==void 0&&($e.arrows.REVERSE_CURVE=e.arrows.REVERSE_CURVE),e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR!==void 0&&($e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR),e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED!==void 0&&($e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED),e.arrows.CUBIC_HORIZONTAL_BIAS!==void 0&&($e.arrows.CUBIC_HORIZONTAL_BIAS=e.arrows.CUBIC_HORIZONTAL_BIAS),e.arrows.reverseArrowOnMultipleConnect!==void 0&&($e.arrows.reverseArrowOnMultipleConnect=e.arrows.reverseArrowOnMultipleConnect)),e.persistState!==void 0&&($e.persistState=e.persistState),e.autosave!==void 0&&($e.autosave=e.autosave),e.hideOverlay!==void 0&&($e.hideOverlay=e.hideOverlay),e.hideToolbar!==void 0&&($e.hideToolbar=e.hideToolbar),e.nodeOptions&&(e.nodeOptions.maxNodeWidth!==void 0&&($e.nodeOptions.maxNodeWidth=e.nodeOptions.maxNodeWidth),e.nodeOptions.resizeBorderWidth!==void 0&&($e.nodeOptions.resizeBorderWidth=e.nodeOptions.resizeBorderWidth)),e.zoom&&(e.zoom.min!==void 0&&($e.zoom.min=e.zoom.min),e.zoom.max!==void 0&&($e.zoom.max=e.zoom.max),e.zoom.intensity!==void 0&&($e.zoom.intensity=e.zoom.intensity)))};function ul(s){const{undoTree:e,...t}=s;return t}function pl(s){const e={};for(const[t,n]of Object.entries(s.canvases))e[t]=ul(n);return{...s,canvases:e}}function hl(s){const e={};for(const[t,n]of Object.entries(s.workspaces))e[t]=pl(n);return{...s,workspaces:e}}const bv=s=>{var m,g,x;const e=s(),t=e.state;if(!t){console.error("Cannot export: State is not available.");return}const n={};for(const[b,v]of Object.entries(t.projects))n[b]=hl(v);const r={...t,projects:n},o=e.preferences,i={splitPresets:o==null?void 0:o.splitPresets,arrangePresets:o==null?void 0:o.arrangePresets,arrangeConfigFavorites:o==null?void 0:o.arrangeConfigFavorites,pinnedPaletteItems:o==null?void 0:o.pinnedPaletteItems,canvasConfig:o==null?void 0:o.canvasConfig,keepArrowsOnSplit:o==null?void 0:o.keepArrowsOnSplit,keepSplitMatch:o==null?void 0:o.keepSplitMatch,splitHorizontally:o==null?void 0:o.splitHorizontally,splitNodeGap:o==null?void 0:o.splitNodeGap,borderButton:o==null?void 0:o.borderButton,arrowStyleButton:o==null?void 0:o.arrowStyleButton,arrangeButton:o==null?void 0:o.arrangeButton,segmentedButtons:o==null?void 0:o.segmentedButtons,projectsManagerSearch:o==null?void 0:o.projectsManagerSearch,recentCanvases:o==null?void 0:o.recentCanvases,goToSymbolSearch:o==null?void 0:o.goToSymbolSearch,openTabs:o==null?void 0:o.openTabs},c={sequencePresets:(m=e.actions)==null?void 0:m.sequencePresets,history:(g=e.actions)==null?void 0:g.history,historySelection:(x=e.actions)==null?void 0:x.historySelection},l={...r,preferences:i,actions:c},d=JSON.stringify(l,null,2),p=new Blob([d],{type:"application/json"}),u=URL.createObjectURL(p),f=document.createElement("a");f.href=u,f.download=`markop-canvas-export-${new Date().toISOString()}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u)},wv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r,canvasId:o}=e,i=t.projects[n];if(!i){console.error(`Cannot export: Project ${n} not found.`);return}const c=i.workspaces[r];if(!c){console.error(`Cannot export: Workspace ${r} not found.`);return}const l=c.canvases[o];if(!l){console.error(`Cannot export: Canvas ${o} not found.`);return}const d=ul(l),p={...c,canvases:{[o]:d},activeCanvasId:o},u={...i,workspaces:{[r]:p},activeWorkspaceId:r},f={projects:{[n]:u},activeProjectId:n},m=JSON.stringify(f,null,2),g=new Blob([m],{type:"application/json"}),x=URL.createObjectURL(g),b=l.name.replace(/[^a-zA-Z0-9-_]/g,"_"),v=document.createElement("a");v.href=x,v.download=`canvas-${b}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(x)},yv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r}=e,o=t.projects[n];if(!o){console.error(`Cannot export: Project ${n} not found.`);return}const i=o.workspaces[r];if(!i){console.error(`Cannot export: Workspace ${r} not found.`);return}const c=pl(i),l={...o,workspaces:{[r]:c},activeWorkspaceId:r},d={projects:{[n]:l},activeProjectId:n},p=JSON.stringify(d,null,2),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=i.name.replace(/[^a-zA-Z0-9-_]/g,"_"),g=document.createElement("a");g.href=f,g.download=`workspace-${m}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(f)},Sv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n}=e,r=t.projects[n];if(!r){console.error(`Cannot export: Project ${n} not found.`);return}const o=hl(r),i={projects:{[n]:o},activeProjectId:n},c=JSON.stringify(i,null,2),l=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(l),p=r.name.replace(/[^a-zA-Z0-9-_]/g,"_"),u=document.createElement("a");u.href=d,u.download=`project-${p}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d)},jv=(s,e,t={})=>{const{replace:n=!1}=t;try{const r=JSON.parse(e);if((!r||typeof r.projects!="object")&&r.projects!==null)throw new Error("Invalid data format: Missing or invalid 'projects' structure.");const o=r.projects??{};let i=0,c=0;if(n){let l=r.activeProjectId;l&&!o[l]?(console.warn("Imported activeProjectId does not exist in the imported projects. Resetting active project."),l=Object.keys(o)[0]??null):!l&&Object.keys(o).length>0&&(l=Object.keys(o)[0]),i=Object.keys(o).length;const d=r.preferences,p=r.actions;s(u=>{var m,g,x,b,v,w,y,j,S,C,N,A,k,E,R,M,L,T,W,z;const f={...u.preferences,splitPresets:(d==null?void 0:d.splitPresets)??((m=u.preferences)==null?void 0:m.splitPresets),arrangePresets:(d==null?void 0:d.arrangePresets)??((g=u.preferences)==null?void 0:g.arrangePresets),arrangeConfigFavorites:(d==null?void 0:d.arrangeConfigFavorites)??((x=u.preferences)==null?void 0:x.arrangeConfigFavorites),pinnedPaletteItems:(d==null?void 0:d.pinnedPaletteItems)??((b=u.preferences)==null?void 0:b.pinnedPaletteItems),canvasConfig:(d==null?void 0:d.canvasConfig)??((v=u.preferences)==null?void 0:v.canvasConfig),keepArrowsOnSplit:(d==null?void 0:d.keepArrowsOnSplit)??((w=u.preferences)==null?void 0:w.keepArrowsOnSplit),keepSplitMatch:(d==null?void 0:d.keepSplitMatch)??((y=u.preferences)==null?void 0:y.keepSplitMatch),splitHorizontally:(d==null?void 0:d.splitHorizontally)??((j=u.preferences)==null?void 0:j.splitHorizontally),splitNodeGap:(d==null?void 0:d.splitNodeGap)??((S=u.preferences)==null?void 0:S.splitNodeGap),borderButton:(d==null?void 0:d.borderButton)??((C=u.preferences)==null?void 0:C.borderButton),arrowStyleButton:(d==null?void 0:d.arrowStyleButton)??((N=u.preferences)==null?void 0:N.arrowStyleButton),arrangeButton:(d==null?void 0:d.arrangeButton)??((A=u.preferences)==null?void 0:A.arrangeButton),segmentedButtons:(d==null?void 0:d.segmentedButtons)??((k=u.preferences)==null?void 0:k.segmentedButtons),projectsManagerSearch:(d==null?void 0:d.projectsManagerSearch)??((E=u.preferences)==null?void 0:E.projectsManagerSearch),recentCanvases:(d==null?void 0:d.recentCanvases)??((R=u.preferences)==null?void 0:R.recentCanvases),goToSymbolSearch:(d==null?void 0:d.goToSymbolSearch)??((M=u.preferences)==null?void 0:M.goToSymbolSearch),openTabs:(d==null?void 0:d.openTabs)??((L=u.preferences)==null?void 0:L.openTabs)};return{...u,state:{projects:o,activeProjectId:l??null,nodes:void 0,arrows:void 0,selectedArrows:void 0},preferences:f,actions:{...u.actions,sequencePresets:(p==null?void 0:p.sequencePresets)??((T=u.actions)==null?void 0:T.sequencePresets),history:(p==null?void 0:p.history)??((W=u.actions)==null?void 0:W.history),historySelection:(p==null?void 0:p.historySelection)??((z=u.actions)==null?void 0:z.historySelection)},uiState:{...u.uiState,dragInfo:null,resizingNode:null,temporaryArrow:null,selectionBox:null,isPanning:!1,nodeToFocusId:null}}}),console.log(`Canvas data replaced: ${i} project(s) imported.`)}else{const l=r.preferences,d=r.actions;s(p=>{var m,g,x,b,v,w,y,j,S,C,N,A,k,E,R,M,L,T,W,z,te;const u=((m=p.state)==null?void 0:m.projects)??{},f={...u};for(const[O,ee]of Object.entries(o))u[O]?(c++,console.warn(`Project "${ee.name}" (${O}) already exists, skipping.`)):(f[O]=ee,i++);return{...p,state:{...p.state,projects:f},...l&&{preferences:{...p.preferences,splitPresets:l.splitPresets??((g=p.preferences)==null?void 0:g.splitPresets),arrangePresets:l.arrangePresets??((x=p.preferences)==null?void 0:x.arrangePresets),arrangeConfigFavorites:l.arrangeConfigFavorites??((b=p.preferences)==null?void 0:b.arrangeConfigFavorites),pinnedPaletteItems:l.pinnedPaletteItems??((v=p.preferences)==null?void 0:v.pinnedPaletteItems),canvasConfig:l.canvasConfig??((w=p.preferences)==null?void 0:w.canvasConfig),keepArrowsOnSplit:l.keepArrowsOnSplit??((y=p.preferences)==null?void 0:y.keepArrowsOnSplit),keepSplitMatch:l.keepSplitMatch??((j=p.preferences)==null?void 0:j.keepSplitMatch),splitHorizontally:l.splitHorizontally??((S=p.preferences)==null?void 0:S.splitHorizontally),splitNodeGap:l.splitNodeGap??((C=p.preferences)==null?void 0:C.splitNodeGap),borderButton:l.borderButton??((N=p.preferences)==null?void 0:N.borderButton),arrowStyleButton:l.arrowStyleButton??((A=p.preferences)==null?void 0:A.arrowStyleButton),arrangeButton:l.arrangeButton??((k=p.preferences)==null?void 0:k.arrangeButton),segmentedButtons:l.segmentedButtons??((E=p.preferences)==null?void 0:E.segmentedButtons),projectsManagerSearch:l.projectsManagerSearch??((R=p.preferences)==null?void 0:R.projectsManagerSearch),recentCanvases:l.recentCanvases??((M=p.preferences)==null?void 0:M.recentCanvases),goToSymbolSearch:l.goToSymbolSearch??((L=p.preferences)==null?void 0:L.goToSymbolSearch),openTabs:l.openTabs??((T=p.preferences)==null?void 0:T.openTabs)}},...d&&{actions:{...p.actions,sequencePresets:d.sequencePresets??((W=p.actions)==null?void 0:W.sequencePresets),history:d.history??((z=p.actions)==null?void 0:z.history),historySelection:d.historySelection??((te=p.actions)==null?void 0:te.historySelection)}}}}),console.log(`Canvas data merged: ${i} project(s) imported, ${c} skipped.`)}return{projectsImported:i,projectsSkipped:c}}catch(r){return console.error("Failed to import canvas project data:",r),{projectsImported:0,projectsSkipped:0}}},Cv=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Date().toISOString(),u=d.map(f=>({...f,id:ll(f.id),createdAt:p,updatedAt:p,isSelected:!1,isEditing:!1}));s(Q(f=>{var g,x,b,v,w,y;const m=(y=(w=(v=(b=(x=(g=f.state)==null?void 0:g.projects)==null?void 0:x[r])==null?void 0:b.workspaces)==null?void 0:v[o])==null?void 0:w.canvases)==null?void 0:y[i];m!=null&&m.coreState&&(m.coreState.nodes.push(...u),m.lastModified=Date.now())}))},Nv=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Set(n),u=new Date().toISOString();s(Q(f=>{var j,S,C,N,A,k,E,R,M,L,T;const m=(j=f.state)==null?void 0:j.activeProjectId;if(!m)return;const g=(C=(S=f.state)==null?void 0:S.projects)==null?void 0:C[m];if(!g)return;const x=g.activeWorkspaceId;if(!x)return;const b=(N=g.workspaces)==null?void 0:N[x];if(!b)return;const v=b.activeCanvasId;if(!v)return;const w=(A=b.canvases)==null?void 0:A[v];w!=null&&w.coreState&&(w.coreState.nodes=w.coreState.nodes.filter(W=>!p.has(W.id)),w.coreState.selectedNodes=[],w.coreState.arrows=w.coreState.arrows.filter(W=>!(W.startNodeId&&p.has(W.startNodeId)||W.endNodeId&&p.has(W.endNodeId))),w.lastModified=Date.now());const y=(T=(L=(M=(R=(E=(k=f.state)==null?void 0:k.projects)==null?void 0:E[r])==null?void 0:R.workspaces)==null?void 0:M[o])==null?void 0:L.canvases)==null?void 0:T[i];if(y!=null&&y.coreState){const W=d.map(z=>({...z,updatedAt:u,isSelected:!1,isEditing:!1}));y.coreState.nodes.push(...W),y.lastModified=Date.now()}}))},kv=(s,e)=>({exportCanvasData:()=>bv(s),exportSingleCanvas:t=>wv(s)(t),exportSingleWorkspace:t=>yv(s)(t),exportSingleProject:t=>Sv(s)(t),importCanvasData:(t,n)=>jv(e,t,n),copyNodesToCanvas:t=>Cv(e,s,t),moveNodesToCanvas:t=>Nv(e,s,t)}),Ev=(s,e,t)=>{const n=Ue(10),r=Date.now(),o=Ue(10),i={id:o,name:"Default Canvas",createdAt:r,lastModified:r,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},c=Ue(10),l={id:c,name:"Default Workspace",createdAt:r,lastModified:r,canvases:{[o]:i},activeCanvasId:o},d={id:n,name:t||"New Project",createdAt:r,lastModified:r,workspaces:{[c]:l},activeWorkspaceId:c};return s(Q(p=>{p.state||(p.state={projects:{},activeProjectId:null}),p.state.projects[n]=d,p.state.activeProjectId=n})),n},Iv=(s,e,t)=>{s(Q(n=>{var r;(r=n.state)!=null&&r.projects[t]?n.state.activeProjectId=t:console.warn(`Project with ID ${t} not found.`)}))},Tv=(s,e,t)=>{s(Q(n=>{var r;if((r=n.state)!=null&&r.projects[t]&&(delete n.state.projects[t],n.state.activeProjectId===t)){const o=Object.keys(n.state.projects);n.state.activeProjectId=o.length>0?o[0]:null}}))},Av=(s,e,t,n)=>{s(Q(r=>{var i;const o=(i=r.state)==null?void 0:i.projects[t];o&&(n.name!==void 0&&(o.name=n.name),n.hideFromSearch!==void 0&&(o.hideFromSearch=n.hideFromSearch),o.lastModified=n.lastModified??Date.now())}))},fl=s=>{const e=s().state;if(!e)return null;const{projects:t,activeProjectId:n}=e;return n?t[n]??null:null},Pv=(s,e)=>({create:t=>Ev(s,e,t),switch:t=>Iv(s,e,t),delete:t=>Tv(s,e,t),updateMetadata:(t,n)=>Av(s,e,t,n),getActive:()=>fl(e)}),Rv=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId;if(!n)return null;const r=Ue(10),o=Date.now(),i=Ue(10),c={id:i,name:"Default Canvas",createdAt:o,lastModified:o,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},l={id:r,name:t||"New Workspace",createdAt:o,lastModified:o,canvases:{[i]:c},activeCanvasId:i};return s(Q(p=>{var f;const u=(f=p.state)==null?void 0:f.projects[n];u&&(u.workspaces[r]=l,u.activeWorkspaceId=r,u.lastModified=o)})),r},Dv=(s,e,t)=>{s(Q(n=>{var o;const r=(o=n.state)!=null&&o.activeProjectId?n.state.projects[n.state.activeProjectId]:null;r&&r.workspaces[t]?(r.activeWorkspaceId=t,r.lastModified=Date.now()):console.warn(`Workspace with ID ${t} not found in active project.`)}))},_v=(s,e,t)=>{s(Q(n=>{var o;const r=(o=n.state)!=null&&o.activeProjectId?n.state.projects[n.state.activeProjectId]:null;if(r&&r.workspaces[t]&&(delete r.workspaces[t],r.lastModified=Date.now(),r.activeWorkspaceId===t)){const i=Object.keys(r.workspaces);r.activeWorkspaceId=i.length>0?i[0]:null}}))},Ov=(s,e,t,n)=>{s(Q(r=>{var c;const o=(c=r.state)!=null&&c.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o?o.workspaces[t]:null;if(i){n.name!==void 0&&(i.name=n.name),n.hideFromSearch!==void 0&&(i.hideFromSearch=n.hideFromSearch);const l=n.lastModified??Date.now();i.lastModified=l,o&&(o.lastModified=l)}}))},Ga=s=>{const e=fl(s);return e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]??null:null},Lv=(s,e)=>({create:t=>Rv(s,e,t),switch:t=>Dv(s,e,t),delete:t=>_v(s,e,t),updateMetadata:(t,n)=>Ov(s,e,t,n),getActive:()=>Ga(e)}),Mv={CanvasStateV2:!1,useSelectionHandler:!1,useArrowDrawingV2:!1,useDrawingV2:!1,useCanvasKeyboardEventsV2:!1,useCanvasMouseEventsV2:!1,WriteModeHandlerV2:!1},Qo=10,Fv=(s,e)=>{const t=s.replace(/\s*\(\d+\)$/,"");if(!e.includes(t)&&s!==t)return t;const n=new RegExp(`^${$v(t)}\\s*\\((\\d+)\\)$`),r=e.map(c=>{const l=c.match(n);return l?parseInt(l[1],10):0}).filter(c=>c>0),o=e.includes(t);let i=1;return(o||r.length>0)&&(i=Math.max(0,...r)+1),`${t} (${i})`},$v=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Uv=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId,r=Ga(e),o=r==null?void 0:r.id;if(!n||!o)return null;const i=Ue(10),c=Date.now(),l={id:i,name:t||"New Canvas",createdAt:c,lastModified:c,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}};return s(Q(p=>{var m;const u=(m=p.state)==null?void 0:m.projects[n],f=u==null?void 0:u.workspaces[o];f&&(f.canvases[i]=l,f.activeCanvasId=i,f.lastModified=c,u&&(u.lastModified=c))})),i},Bv=(s,e,t)=>{s(Q(n=>{if(!n.state)return;let r=null,o=null;for(const[p,u]of Object.entries(n.state.projects)){for(const[f,m]of Object.entries(u.workspaces))if(m.canvases[t]){r=p,o=f;break}if(r)break}if(!r||!o){console.warn(`Canvas with ID ${t} not found in any workspace.`);return}const i=Date.now();n.state.activeProjectId!==r&&(n.state.activeProjectId=r);const c=n.state.projects[r];if(!c)return;c.activeWorkspaceId!==o&&(c.activeWorkspaceId=o);const l=c.workspaces[o];if(!l)return;l.activeCanvasId=t,l.lastModified=i,c.lastModified=i;const d=l.canvases[t];if(d){n.preferences||(n.preferences={}),n.preferences.recentCanvases||(n.preferences.recentCanvases=[]);const p={projectId:r,workspaceId:o,canvasId:t,canvasName:d.name,projectName:c.name,workspaceName:l.name,visitedAt:i};if(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(f=>f.canvasId!==t),n.preferences.recentCanvases.unshift(p),n.preferences.recentCanvases.length>Qo&&(n.preferences.recentCanvases=n.preferences.recentCanvases.slice(0,Qo)),n.preferences.openTabs||(n.preferences.openTabs=[]),!n.preferences.openTabs.some(f=>f.canvasId===t)){const f={canvasId:t,projectId:r,workspaceId:o};n.preferences.openTabs.push(f)}}}))},Wv=(s,e,t)=>{s(Q(n=>{var i,c;const r=(i=n.state)!=null&&i.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null;if(o&&o.canvases[t]){delete o.canvases[t];const l=Date.now();if(o.lastModified=l,r&&(r.lastModified=l),o.activeCanvasId===t){const d=Object.keys(o.canvases);o.activeCanvasId=d.length>0?d[0]:null}}(c=n.preferences)!=null&&c.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(l=>l.canvasId!==t))}))},zv=(s,e,t,n)=>{s(Q(r=>{var l;const o=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i?i.canvases[t]:null;if(c){n.name!==void 0&&(c.name=n.name),n.hideFromSearch!==void 0&&(c.hideFromSearch=n.hideFromSearch);const d=n.lastModified??Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}}))},Hv=(s,e,t,n,r)=>{const o=e().state;if(!o)return null;const i=o.projects[n];if(!i)return null;const c=i.workspaces[r];if(!c)return null;const l=c.canvases[t];if(!l)return null;const d=Object.values(c.canvases).map(g=>g.name),p=Fv(l.name,d),u=Ue(10),f=Date.now(),m={id:u,name:p,createdAt:f,lastModified:f,coreState:{nodes:l.coreState.nodes.map(g=>({...g})),arrows:l.coreState.arrows.map(g=>({...g})),selectedNodes:[],selectedArrows:[],layers:(l.coreState.layers??[]).map(g=>({...g})),activeLayerId:l.coreState.activeLayerId??null},viewState:{offset:{...l.viewState.offset},scale:l.viewState.scale}};return s(Q(g=>{var v;const x=(v=g.state)==null?void 0:v.projects[n],b=x==null?void 0:x.workspaces[r];b&&(b.canvases[u]=m,b.activeCanvasId=u,b.lastModified=f,x&&(x.lastModified=f))})),u},Gv=(s,e,t)=>{s(Q(n=>{var r;(r=n.preferences)!=null&&r.recentCanvases&&(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(o=>o.canvasId!==t))}))},qv=s=>{const e=Ga(s),t=e&&e.activeCanvasId?e.canvases[e.activeCanvasId]??null:null;return window.activeCanvas=t,t},Vv=(s,e)=>({create:t=>Uv(s,e,t),switch:t=>Bv(s,e,t),delete:t=>Wv(s,e,t),duplicate:(t,n,r)=>Hv(s,e,t,n,r),updateMetadata:(t,n)=>zv(s,e,t,n),getActive:()=>qv(e),removeRecentCanvas:t=>Gv(s,e,t)});class Kv{constructor(e,t=!1){Z(this,"enabled");Z(this,"name");this.name=e,this.enabled=t}setEnabled(e){this.enabled=e}formatMessage(e){return[`[${this.name}]`,...e]}log(...e){this.enabled&&console.log(...this.formatMessage(e))}warn(...e){this.enabled&&console.warn(...this.formatMessage(e))}error(...e){this.enabled&&console.error(...this.formatMessage(e))}}const Jv=(s,e,t,n)=>{const r=t/2-s.x*e,o=n/2-s.y*e;return{x:r,y:o}},Yv=(s,e)=>{const t=e.find(i=>i.id===s.startNodeId),n=e.find(i=>i.id===s.endNodeId),r=t?Ko(t):s.startPoint,o=n?Ko(n):s.endPoint;return{x:(r.x+o.x)/2,y:(r.y+o.y)/2}},Xv=(s,e,t,n=500)=>{const{uiState:r,projectCanvas:o,setActiveCanvasViewState:i}=e(),c=o.getActive();if(!c){console.warn("Cannot center view: No active canvas.");return}const l=c.coreState.arrows,d=c.coreState.nodes,p=c.viewState.scale,u=r==null?void 0:r.canvasWidth,f=r==null?void 0:r.canvasHeight,m=typeof t=="string"?l==null?void 0:l.find(b=>b.id===t):t;if(!m){console.warn("Cannot center view: Arrow not found.");return}if(!u||!f){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=Yv(m,d),x=Jv(g,p,u,f);i(b=>({...b,targetView:{targetOffset:x,targetScale:p,animationStartTime:performance.now(),animationDuration:n}}))},Sn=20,Zo=40;function Qv(s){if(s.length===0)return{x:0,y:0,width:100,height:100};let e=1/0,t=1/0,n=-1/0,r=-1/0;return s.forEach(o=>{e=Math.min(e,o.x),t=Math.min(t,o.y),n=Math.max(n,o.x+(o.width??100)),r=Math.max(r,o.y+(o.height??50))}),{x:e-Sn,y:t-Sn-Zo,width:n-e+Sn*2,height:r-t+Sn*2+Zo}}function Ls(s){return s.type===Ve.GROUP}function qa(s){if(Ls(s))return s.data}const Zv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const o=r.coreState.selectedNodes;if(o.length<2)return null;const i=Ue(10),c=Qv(o),l=o.map(m=>m.id),d=r.coreState.nodes.filter(Ls),p=t||`Group ${d.length+1}`,u=new Date().toISOString(),f={id:i,type:Ve.GROUP,x:c.x,y:c.y,width:c.width,height:c.height,title:p,data:{childNodeIds:l},createdAt:u,updatedAt:u};return s(Q(m=>{if(!m.state)return;const g=m.state.activeProjectId?m.state.projects[m.state.activeProjectId]:null,x=g&&g.activeWorkspaceId?g.workspaces[g.activeWorkspaceId]:null,b=x&&x.activeCanvasId?x.canvases[x.activeCanvasId]:null;if(!b)return;b.coreState.nodes.push(f),b.coreState.nodes=b.coreState.nodes.map(w=>l.includes(w.id)?{...w,groupId:i}:w),b.coreState.selectedNodes=[f];const v=Date.now();b.lastModified=v,x&&(x.lastModified=v),g&&(g.lastModified=v)})),i},eb=(s,e,t)=>{s(Q(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return;const c=i.coreState.nodes.findIndex(m=>m.id===t&&Ls(m));if(c===-1)return;const l=i.coreState.nodes[c],d=qa(l),p=(d==null?void 0:d.childNodeIds)??[];i.coreState.nodes=i.coreState.nodes.map(m=>{if(m.groupId===t){const{groupId:g,...x}=m;return x}return m});const u=i.coreState.nodes.filter(m=>p.includes(m.id));i.coreState.nodes.splice(c,1),i.coreState.selectedNodes=u;const f=Date.now();i.lastModified=f,o&&(o.lastModified=f),r&&(r.lastModified=f)}))},tb=(s,e,t,n)=>{var c;const r=e().getNodeById(t),o=r==null?void 0:r.data,i=(c=o==null?void 0:o.automation)==null?void 0:c.onEnter;if(s(Q(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=u.coreState.nodes.findIndex(v=>v.id===t&&Ls(v));if(f===-1)return;const m=u.coreState.nodes[f],g=qa(m)??{childNodeIds:[]},x=new Set([...g.childNodeIds,...n]);g.childNodeIds=Array.from(x),m.data=g,u.coreState.nodes=u.coreState.nodes.map(v=>n.includes(v.id)?{...v,groupId:t}:v),m.updatedAt=new Date().toISOString();const b=Date.now();u.lastModified=b,p&&(p.lastModified=b),d&&(d.lastModified=b)})),i!=null&&i.enabled&&i.tags.length>0)for(const l of n)for(const d of i.tags)e().addTagToNode(l,{id:Ue(8),title:d})},sb=(s,e,t)=>{var r;const n=new Map;for(const o of t){const i=e().getNodeById(o);if(i!=null&&i.groupId){const c=e().getNodeById(i.groupId),l=c==null?void 0:c.data,d=(r=l==null?void 0:l.automation)==null?void 0:r.onLeave;d!=null&&d.enabled&&d.tags.length>0&&n.set(o,{groupId:i.groupId,onLeaveTags:d.tags})}}s(Q(o=>{if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=new Set;l.coreState.nodes.forEach(u=>{t.includes(u.id)&&u.groupId&&d.add(u.groupId)}),l.coreState.nodes=l.coreState.nodes.map(u=>{if(t.includes(u.id)&&u.groupId){const{groupId:f,...m}=u;return m}return u}),d.forEach(u=>{const f=l.coreState.nodes.findIndex(x=>x.id===u&&Ls(x));if(f===-1)return;const m=l.coreState.nodes[f],g=qa(m);g&&(g.childNodeIds=g.childNodeIds.filter(x=>!t.includes(x)),m.data=g,m.updatedAt=new Date().toISOString())});const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}));for(const[o,{onLeaveTags:i}]of n){const c=e().getNodeById(o);if(c!=null&&c.tags)for(const l of i){const d=c.tags.find(p=>p.title===l);d&&e().removeTagFromNode(o,d.id)}}},nb=(s,e,t)=>{s(Q(n=>{n.uiState.activeGroupId=t}))},rb=(s,e)=>{const t=s().projectCanvas.getActive();return t?t.coreState.nodes.find(r=>r.id===e&&Ls(r))??null:null},ab=(s,e)=>({createFromSelected:t=>Zv(s,e,t),ungroup:t=>eb(s,e,t),addNodesToGroup:(t,n)=>tb(s,e,t,n),removeNodesFromGroup:t=>sb(s,e,t),setActiveGroupId:t=>nb(s,e,t),getById:t=>rb(e,t)}),ob=33,ei=24;function ml(s){return s===Ve.TABLE}function gl(s){const e=s;return!(e!=null&&e.columns)||!Array.isArray(e.columns)?null:e}const ib=(s,e,t,n,r)=>{let o=!1;return s(Q(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=d.coreState.nodes.findIndex(S=>S.id===t&&ml(S.type));if(p===-1)return;const u=d.coreState.nodes[p],f=gl(u.data);if(!f)return;const m={id:`row-${Date.now()}`};f.columns.forEach(S=>{m[S.key]=S.key===n?r:""}),f.rows.push(m),u.data=f,u.updatedAt=new Date().toISOString();const g=f.columns.find(S=>S.key===n);let x=150;if(g!=null&&g.width){const S=parseInt(g.width,10);isNaN(S)||(x=S)}const b=x-ei,v=Vn(r,b),w=Math.max(ob,v+ei),y=u.height??250;u.height=y+w;const j=Date.now();d.lastModified=j,l&&(l.lastModified=j),c&&(c.lastModified=j),o=!0})),o},cb=(s,e,t,n,r,o)=>{let i=!1;return s(Q(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;if(!p)return;const u=p.coreState.nodes.findIndex(b=>b.id===t&&ml(b.type));if(u===-1)return;const f=p.coreState.nodes[u],m=gl(f.data);if(!m)return;const g=m.rows.findIndex(b=>b.id===n);if(g===-1)return;m.rows[g][r]=o,f.data=m,f.updatedAt=new Date().toISOString();const x=Date.now();p.lastModified=x,d&&(d.lastModified=x),l&&(l.lastModified=x),i=!0})),i},lb=(s,e)=>({addRowFromDrop:(t,n,r)=>ib(s,e,t,n,r),updateCellFromDrop:(t,n,r,o)=>cb(s,e,t,n,r,o)}),fs="default-layer",db="Layer 1";function ub(s=fs,e=db){const t=new Date().toISOString();return{id:s,name:e,order:0,isVisible:!0,opacity:100,isLocked:!1,createdAt:t,updatedAt:t}}function xl(s){return[...s].sort((e,t)=>e.order-t.order)}function Va(s){return s.length===0?-1:Math.max(...s.map(e=>e.order))}function Yn(s){return s.length===0?[ub()]:s}const pb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const o=Yn(r.coreState.layers??[]),i=Va(o),c=Ue(10),l=t||`Layer ${o.length+1}`,d=new Date().toISOString(),p={id:c,name:l,order:i+1,isVisible:!0,opacity:100,isLocked:!1,createdAt:d,updatedAt:d};return s(Q(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=Yn(g.coreState.layers??[]),g.coreState.layers.push(p),g.coreState.activeLayerId=c;const x=Date.now();g.lastModified=x,m&&(m.lastModified=x),f&&(f.lastModified=x)})),c},hb=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||(r.coreState.layers??[]).length<=1||s(Q(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=xl(d.coreState.layers??[]),u=p.findIndex(g=>g.id===t);if(u===-1)return;let f;u>0?f=p[u-1].id:p.length>1&&(f=p[1].id),f&&(d.coreState.nodes=d.coreState.nodes.map(g=>(g.layerId??fs)===t?{...g,layerId:f}:g)),d.coreState.layers=d.coreState.layers.filter(g=>g.id!==t),d.coreState.activeLayerId===t&&(d.coreState.activeLayerId=f??null);const m=Date.now();d.lastModified=m,l&&(l.lastModified=m),c&&(c.lastModified=m)}))},fb=(s,e,t,n)=>{s(Q(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.name=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},mb=(s,e,t,n)=>{s(Q(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isVisible=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},gb=(s,e,t,n)=>{const r=Math.max(0,Math.min(100,n));s(Q(o=>{var u;if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=(u=l.coreState.layers)==null?void 0:u.find(f=>f.id===t);if(!d)return;d.opacity=r,d.updatedAt=new Date().toISOString();const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}))},xb=(s,e,t,n)=>{s(Q(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isLocked=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},vb=(s,e,t,n)=>{s(Q(r=>{var u,f;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(u=c.coreState.layers)==null?void 0:u.find(m=>m.id===t);if(!l)return;const d=l.order;l.order=n,(f=c.coreState.layers)==null||f.forEach(m=>{m.id!==t&&(n>d?m.order>d&&m.order<=n&&m.order--:m.order>=n&&m.order<d&&m.order++)}),l.updatedAt=new Date().toISOString();const p=Date.now();c.lastModified=p,i&&(i.lastModified=p),o&&(o.lastModified=p)}))},bb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(d=>d.id===t);if(!i)return;const c=Va(o);if(i.order>=c)return;const l=o.find(d=>d.order===i.order+1);l&&s(Q(d=>{var v,w;if(!d.state)return;const p=d.state.activeProjectId?d.state.projects[d.state.activeProjectId]:null,u=p&&p.activeWorkspaceId?p.workspaces[p.activeWorkspaceId]:null,f=u&&u.activeCanvasId?u.canvases[u.activeCanvasId]:null;if(!f)return;const m=(v=f.coreState.layers)==null?void 0:v.find(y=>y.id===t),g=(w=f.coreState.layers)==null?void 0:w.find(y=>y.id===l.id);if(!m||!g)return;const x=new Date().toISOString();g.order=m.order,m.order=m.order+1,m.updatedAt=x,g.updatedAt=x;const b=Date.now();f.lastModified=b,u&&(u.lastModified=b),p&&(p.lastModified=b)}))},wb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(l=>l.id===t);if(!i||i.order<=0)return;const c=o.find(l=>l.order===i.order-1);c&&s(Q(l=>{var b,v;if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=(b=u.coreState.layers)==null?void 0:b.find(w=>w.id===t),m=(v=u.coreState.layers)==null?void 0:v.find(w=>w.id===c.id);if(!f||!m)return;const g=new Date().toISOString();m.order=f.order,f.order=f.order-1,f.updatedAt=g,m.updatedAt=g;const x=Date.now();u.lastModified=x,p&&(p.lastModified=x),d&&(d.lastModified=x)}))},yb=(s,e,t)=>{s(Q(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return;i.coreState.activeLayerId=t;const c=Date.now();i.lastModified=c,o&&(o.lastModified=c),r&&(r.lastModified=c)}))},Sb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;let o=r.coreState.layers??[];if(o.length===0&&t===fs){const u=Ue(10),f=new Date().toISOString(),m={id:u,name:"Layer 1 (Copy)",order:1,isVisible:!0,opacity:100,isLocked:!1,createdAt:f,updatedAt:f};return s(Q(g=>{if(!g.state)return;const x=g.state.activeProjectId?g.state.projects[g.state.activeProjectId]:null,b=x&&x.activeWorkspaceId?x.workspaces[x.activeWorkspaceId]:null,v=b&&b.activeCanvasId?b.canvases[b.activeCanvasId]:null;if(!v)return;v.coreState.layers=Yn(v.coreState.layers??[]),v.coreState.layers.push(m);const y=v.coreState.nodes.filter(S=>!S.layerId||S.layerId===fs).map(S=>({...S,id:Ue(10),layerId:u,createdAt:f,updatedAt:f}));v.coreState.nodes=[...v.coreState.nodes,...y],v.coreState.activeLayerId=u;const j=Date.now();v.lastModified=j,b&&(b.lastModified=j),x&&(x.lastModified=j)})),u}const i=o.find(u=>u.id===t);if(!i)return null;const c=Va(o),l=Ue(10),d=new Date().toISOString(),p={id:l,name:`${i.name} (Copy)`,order:c+1,isVisible:i.isVisible,opacity:i.opacity,isLocked:!1,createdAt:d,updatedAt:d};return s(Q(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=Yn(g.coreState.layers??[]),g.coreState.layers.push(p);const b=g.coreState.nodes.filter(w=>(w.layerId??fs)===t).map(w=>({...w,id:Ue(10),layerId:l,createdAt:d,updatedAt:d}));g.coreState.nodes=[...g.coreState.nodes,...b],g.coreState.activeLayerId=l;const v=Date.now();g.lastModified=v,m&&(m.lastModified=v),f&&(f.lastModified=v)})),l},jb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(l=>l.id===t);if(!i)return;const c=o.find(l=>l.order===i.order-1);c&&s(Q(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;u.coreState.nodes=u.coreState.nodes.map(m=>(m.layerId??fs)===t?{...m,layerId:c.id}:m),u.coreState.layers=u.coreState.layers.filter(m=>m.id!==t),u.coreState.layers.forEach(m=>{m.order>i.order&&m.order--}),u.coreState.activeLayerId===t&&(u.coreState.activeLayerId=c.id);const f=Date.now();u.lastModified=f,p&&(p.lastModified=f),d&&(d.lastModified=f)}))},Cb=(s,e,t,n)=>{s(Q(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c||!((p=c.coreState.layers)==null?void 0:p.find(u=>u.id===n))&&n!==fs)return;c.coreState.nodes=c.coreState.nodes.map(u=>t.includes(u.id)?{...u,layerId:n}:u);const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},Nb=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.coreState.layers)==null?void 0:n.find(r=>r.id===e))??null:null},kb=s=>{const e=s().projectCanvas.getActive();return e?xl(e.coreState.layers??[]):[]},Eb=s=>{var n;const e=s().projectCanvas.getActive();if(!e)return null;const t=e.coreState.activeLayerId;return t?((n=e.coreState.layers)==null?void 0:n.find(r=>r.id===t))??null:null},Ib=(s,e)=>({create:t=>pb(s,e,t),delete:t=>hb(s,e,t),rename:(t,n)=>fb(s,e,t,n),duplicate:t=>Sb(s,e,t),setVisibility:(t,n)=>mb(s,e,t,n),setOpacity:(t,n)=>gb(s,e,t,n),setLocked:(t,n)=>xb(s,e,t,n),reorder:(t,n)=>vb(s,e,t,n),moveUp:t=>bb(s,e,t),moveDown:t=>wb(s,e,t),setActive:t=>yb(s,e,t),mergeDown:t=>jb(s,e,t),moveNodesToLayer:(t,n)=>Cb(s,e,t,n),getById:t=>Nb(e,t),getAll:()=>kb(e),getActive:()=>Eb(e)});function Tb(s,e,t){const n=new Date().toISOString();return{id:s,name:e,nodePositions:[],groupNodes:[],filterConfig:t,createdAt:n,updatedAt:n}}function At(s){if(!s.state)return{project:null,workspace:null,canvas:null};const e=s.state.activeProjectId?s.state.projects[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]:null,n=t&&t.activeCanvasId?t.canvases[t.activeCanvasId]:null;return{project:e,workspace:t,canvas:n}}function Pt(s,e,t){const n=Date.now();s&&(s.lastModified=n),e&&(e.lastModified=n),t&&(t.lastModified=n)}const Ab=(s,e,t,n)=>{const o=e().projectCanvas.getActive();if(!o)return null;const i=Ue(10),c=Tb(i,t,n);return c.nodePositions=o.coreState.nodes.map(l=>({nodeId:l.id,x:l.x,y:l.y})),s(Q(l=>{const{project:d,workspace:p,canvas:u}=At(l);u&&(u.viewLayers||(u.viewLayers=[]),u.viewLayers.push(c),u.activeViewLayerId=i,Pt(u,p,d))})),i},Pb=(s,e,t)=>{e().projectCanvas.getActive()&&s(Q(o=>{const{project:i,workspace:c,canvas:l}=At(o);!l||!l.viewLayers||(l.viewLayers=l.viewLayers.filter(d=>d.id!==t),l.activeViewLayerId===t&&(l.activeViewLayerId=null),Pt(l,c,i))}))},Rb=(s,e,t,n)=>{s(Q(r=>{const{project:o,workspace:i,canvas:c}=At(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.name=n,l.updatedAt=new Date().toISOString(),Pt(c,i,o))}))},Db=(s,e,t)=>{var d;const r=e().projectCanvas.getActive();if(!r)return null;const o=(d=r.viewLayers)==null?void 0:d.find(p=>p.id===t);if(!o)return null;const i=Ue(10),c=new Date().toISOString(),l={...o,id:i,name:`${o.name} (Copy)`,nodePositions:[...o.nodePositions],groupNodes:o.groupNodes.map(p=>({...p,id:Ue(10)})),createdAt:c,updatedAt:c};return s(Q(p=>{const{project:u,workspace:f,canvas:m}=At(p);m&&(m.viewLayers||(m.viewLayers=[]),m.viewLayers.push(l),m.activeViewLayerId=i,Pt(m,f,u))})),i},_b=(s,e,t)=>{s(Q(n=>{const{project:r,workspace:o,canvas:i}=At(n);i&&(i.activeViewLayerId=t,Pt(i,o,r))}))},Ob=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(Q(c=>{const{project:l,workspace:d,canvas:p}=At(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;const f=u.nodePositions.find(m=>m.nodeId===t);f?(f.x=n,f.y=r):u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Pt(p,d,l)}))},Lb=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||!r.activeViewLayerId||s(Q(o=>{const{project:i,workspace:c,canvas:l}=At(o);if(!l||!l.viewLayers||!l.activeViewLayerId)return;const d=l.viewLayers.find(u=>u.id===l.activeViewLayerId);if(!d)return;const p=new Map(d.nodePositions.map((u,f)=>[u.nodeId,f]));for(const u of t){const f=p.get(u.id);f!==void 0?(d.nodePositions[f].x=u.x,d.nodePositions[f].y=u.y):d.nodePositions.push({nodeId:u.id,x:u.x,y:u.y})}d.updatedAt=new Date().toISOString(),Pt(l,c,i)}))},Mb=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(Q(c=>{const{project:l,workspace:d,canvas:p}=At(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;u.nodePositions.some(m=>m.nodeId===t)||(u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Pt(p,d,l))}))},Fb=(s,e,t)=>{s(Q(n=>{const{project:r,workspace:o,canvas:i}=At(n);if(!i||!i.viewLayers)return;let c=!1;for(const l of i.viewLayers){const d=l.nodePositions.length;l.nodePositions=l.nodePositions.filter(p=>p.nodeId!==t);for(const p of l.groupNodes)p.childNodeIds=p.childNodeIds.filter(u=>u!==t);l.nodePositions.length!==d&&(l.updatedAt=new Date().toISOString(),c=!0)}c&&Pt(i,o,r)}))},$b=(s,e,t,n)=>{s(Q(r=>{const{project:o,workspace:i,canvas:c}=At(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes.push(n),l.updatedAt=new Date().toISOString(),Pt(c,i,o))}))},Ub=(s,e,t,n,r)=>{s(Q(o=>{const{project:i,workspace:c,canvas:l}=At(o);if(!l||!l.viewLayers)return;const d=l.viewLayers.find(u=>u.id===t);if(!d)return;const p=d.groupNodes.find(u=>u.id===n);p&&(Object.assign(p,r),d.updatedAt=new Date().toISOString(),Pt(l,c,i))}))},Bb=(s,e,t,n)=>{s(Q(r=>{const{project:o,workspace:i,canvas:c}=At(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes=l.groupNodes.filter(d=>d.id!==n),l.updatedAt=new Date().toISOString(),Pt(c,i,o))}))},Wb=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.viewLayers)==null?void 0:n.find(r=>r.id===e))??null:null},zb=s=>{const e=s().projectCanvas.getActive();return e?e.viewLayers??[]:[]},Hb=s=>{var t;const e=s().projectCanvas.getActive();return!e||!e.activeViewLayerId?null:((t=e.viewLayers)==null?void 0:t.find(n=>n.id===e.activeViewLayerId))??null},Gb=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.activeViewLayerId)??null},qb=(s,e)=>{const t=s().projectCanvas.getActive();return(t==null?void 0:t.activeViewLayerId)===e},Vb=(s,e)=>{var o;const t=s().projectCanvas.getActive();if(!t||!t.activeViewLayerId)return null;const n=(o=t.viewLayers)==null?void 0:o.find(i=>i.id===t.activeViewLayerId);if(!n)return null;const r=n.nodePositions.find(i=>i.nodeId===e);return r?{x:r.x,y:r.y}:null},Kb=s=>{var c;const e=s().projectCanvas.getActive();if(!e)return[];const t=e.coreState.nodes;if(!e.activeViewLayerId)return t;const n=(c=e.viewLayers)==null?void 0:c.find(l=>l.id===e.activeViewLayerId);if(!n)return t;const r=new Map(n.nodePositions.map(l=>[l.nodeId,l])),o=t.map(l=>{const d=r.get(l.id);return d?{...l,x:d.x,y:d.y}:l}),i=n.groupNodes.map(l=>({id:l.id,type:Ve.GROUP,x:l.x,y:l.y,width:l.width,height:l.height,content:l.name,data:{childNodeIds:l.childNodeIds}}));return[...o,...i]},Jb=(s,e)=>({create:(t,n)=>Ab(s,e,t,n),delete:t=>Pb(s,e,t),rename:(t,n)=>Rb(s,e,t,n),duplicate:t=>Db(s,e,t),setActive:t=>_b(s,e,t),updateNodePosition:(t,n,r)=>Ob(s,e,t,n,r),updateNodePositions:t=>Lb(s,e,t),addNodeToActiveView:(t,n,r)=>Mb(s,e,t,n,r),removeNodeFromAllViews:t=>Fb(s,e,t),addGroupNode:(t,n)=>$b(s,e,t,n),updateGroupNode:(t,n,r)=>Ub(s,e,t,n,r),removeGroupNode:(t,n)=>Bb(s,e,t,n),getById:t=>Wb(e,t),getAll:()=>zb(e),getActive:()=>Hb(e),getActiveId:()=>Gb(e),isActive:t=>qb(e,t),getEffectivePosition:t=>Vb(e,t),getNodesWithEffectivePositions:()=>Kb(e)});function Ms(s){return s.extensions||(s.extensions={registry:{},settings:{},runtime:{}}),s.extensions.registry||(s.extensions.registry={}),s.extensions.settings||(s.extensions.settings={}),s.extensions.runtime||(s.extensions.runtime={}),s.extensions}const Yb=(s,e,t,n)=>{s(Q(r=>{const o=Ms(r);o.registry[t]||(o.registry[t]={enabled:!0,installedAt:new Date().toISOString(),version:n})}))},Xb=(s,e,t)=>{s(Q(n=>{var o;const r=Ms(n);delete r.registry[t],delete r.settings[t],(o=r.runtime)==null||delete o[t]}))},Qb=(s,e,t,n)=>{s(Q(r=>{const o=Ms(r);o.registry[t]?o.registry[t].enabled=n:o.registry[t]={enabled:n,installedAt:new Date().toISOString()}}))},Zb=(s,e)=>{var n,r,o;return((o=(r=(n=s().extensions)==null?void 0:n.registry)==null?void 0:r[e])==null?void 0:o.enabled)??!1},ew=(s,e)=>{var n,r;return!!((r=(n=s().extensions)==null?void 0:n.registry)!=null&&r[e])},tw=(s,e)=>{var r,o;return((o=(r=s().extensions)==null?void 0:r.settings)==null?void 0:o[e])??null},sw=(s,e,t,n)=>{s(Q(r=>{const o=Ms(r);o.settings[t]=n}))},nw=(s,e,t,n)=>{s(Q(r=>{const o=Ms(r),i=o.settings[t]??{};o.settings[t]={...i,...n}}))},rw=(s,e)=>{var r,o;return((o=(r=s().extensions)==null?void 0:r.runtime)==null?void 0:o[e])??null},aw=(s,e,t,n)=>{s(Q(r=>{const o=Ms(r);o.runtime||(o.runtime={}),o.runtime[t]=n}))},ow=(s,e)=>({register:(t,n)=>Yb(s,e,t,n),unregister:t=>Xb(s,e,t),setEnabled:(t,n)=>Qb(s,e,t,n),isEnabled:t=>Zb(e,t),isRegistered:t=>ew(e,t),getSettings:t=>tw(e,t),setSettings:(t,n)=>sw(s,e,t,n),updateSettings:(t,n)=>nw(s,e,t,n),getRuntime:t=>rw(e,t),setRuntime:(t,n)=>aw(s,e,t,n)});function mr(){return{nodes:{},current:null,root:null}}function iw(s){switch(s.type){case"node:move":return"Move node";case"node:resize":return"Resize node";case"node:create":return`Create ${s.node.type.toLowerCase()}`;case"node:delete":return`Delete ${s.node.type.toLowerCase()}`;case"node:update":return"Update node";case"batch":return s.label??`Batch (${s.operations.length} ops)`;case"arrow:create":return"Create arrow";case"arrow:delete":return"Delete arrow";case"arrow:update":return"Update arrow";case"tag:add":return"Add tag";case"tag:remove":return"Remove tag"}}function cw(){return`hn_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}class Ka{constructor(e){Z(this,"data");this.data=e??mr()}commit(e){const t=cw(),n={id:t,operation:e,parent:this.data.current,children:[],timestamp:Date.now(),label:iw(e)};if(this.data.nodes[t]=n,this.data.current!==null){const r=this.data.nodes[this.data.current];r&&r.children.push(t)}return this.data.root===null&&(this.data.root=t),this.data.current=t,t}undo(){if(this.data.current===null)return null;const e=this.data.nodes[this.data.current];return e?(this.data.current=e.parent,e.operation):null}redo(e){const t=this.getBranches();if(t.length===0)return null;const n=e??t.length-1,r=t[n];return r?(this.data.current=r.id,r.operation):null}getBranches(){if(this.data.current===null){if(this.data.root!==null){const t=this.data.nodes[this.data.root];return t?[t]:[]}return[]}const e=this.data.nodes[this.data.current];return e?e.children.map(t=>this.data.nodes[t]).filter(t=>t!==void 0):[]}getPath(){const e=[];let t=this.data.current;for(;t!==null;){const n=this.data.nodes[t];if(!n)break;e.unshift(n),t=n.parent}return e}getRedoPath(){const e=[];let t=this.getBranches();for(;t.length>0;){const n=t[t.length-1];e.push(n),t=n.children.map(r=>this.data.nodes[r]).filter(r=>r!==void 0)}return e}jumpTo(e){var u;if(!this.data.nodes[e])return{undo:[],redo:[]};const n=new Set(this.getPath().map(f=>f.id)),r=[];let o=e;for(;o!==null;){const f=this.data.nodes[o];if(!f||(r.unshift(f),n.has(o)))break;o=f.parent}const i=[];let c=this.data.current;const l=((u=r[0])==null?void 0:u.id)??null;for(;c!==null&&c!==l;){const f=this.data.nodes[c];if(!f)break;i.push(f.operation),c=f.parent}const d=[];let p=0;l!==null&&(p=r.findIndex(f=>f.id===l)+1);for(let f=p;f<r.length;f++)d.push(r[f].operation);return this.data.current=e,{undo:i,redo:d}}getCurrent(){return this.data.current===null?null:this.data.nodes[this.data.current]??null}getRoot(){return this.data.root===null?null:this.data.nodes[this.data.root]??null}getSize(){return Object.keys(this.data.nodes).length}canUndo(){return this.data.current!==null}canRedo(){return this.getBranches().length>0}getAllNodes(){return Object.values(this.data.nodes)}serialize(){return structuredClone(this.data)}static deserialize(e){return new Ka(structuredClone(e))}prune(e){if(this.getSize()<=e)return;const n=new Set;this.getPath().forEach(i=>n.add(i.id));const o=this.getAllNodes();o.sort((i,c)=>c.timestamp-i.timestamp);for(const i of o){if(n.size>=e)break;n.add(i.id)}for(const i of Object.keys(this.data.nodes))if(!n.has(i)){const c=this.data.nodes[i];if(c!=null&&c.parent){const l=this.data.nodes[c.parent];l&&(l.children=l.children.filter(d=>d!==i))}if(this.data.root===i){const d=Object.values(this.data.nodes).filter(p=>p.id!==i&&n.has(p.id)).find(p=>p.parent===null||!n.has(p.parent));this.data.root=(d==null?void 0:d.id)??null}delete this.data.nodes[i]}for(const i of Object.values(this.data.nodes))i.children=i.children.filter(c=>this.data.nodes[c]!==void 0)}}function Ja(s,e){switch(e.type){case"node:move":return vl(s,e.nodeId,e.to);case"node:resize":return bl(s,e.nodeId,e.to);case"node:create":return wl(s,e.node);case"node:delete":return yl(s,e.node.id,e.connectedArrows);case"node:update":return Sl(s,e.nodeId,e.to);case"arrow:create":return ua(s,e.arrow);case"arrow:delete":return jl(s,e.arrow.id);case"arrow:update":return Cl(s,e.arrowId,e.to);case"batch":return e.operations.reduce((t,n)=>Ja(t,n),s);case"tag:add":return Nl(s,e.nodeId,e.tag,e.autoGroup);case"tag:remove":return lw(s,e.nodeId,e.tag.id)}}function Ya(s,e){switch(e.type){case"node:move":return vl(s,e.nodeId,e.from);case"node:resize":return bl(s,e.nodeId,e.from);case"node:create":return yl(s,e.node.id);case"node:delete":let t=wl(s,e.node);if(e.connectedArrows)for(const n of e.connectedArrows)t=ua(t,n);return t;case"node:update":return Sl(s,e.nodeId,e.from);case"arrow:create":return jl(s,e.arrow.id);case"arrow:delete":return ua(s,e.arrow);case"arrow:update":return Cl(s,e.arrowId,e.from);case"batch":return[...e.operations].reverse().reduce((n,r)=>Ya(n,r),s);case"tag:add":return dw(s,e.nodeId,e.tag.id,e.autoGroup);case"tag:remove":return Nl(s,e.nodeId,e.tag)}}function vl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,x:t.x,y:t.y}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,x:t.x,y:t.y}:o);return{...s,nodes:n,selectedNodes:r}}function bl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,x:t.x,y:t.y,width:t.width,height:t.height}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,x:t.x,y:t.y,width:t.width,height:t.height}:o);return{...s,nodes:n,selectedNodes:r}}function wl(s,e){return s.nodes.some(t=>t.id===e.id)?s:{...s,nodes:[...s.nodes,e]}}function yl(s,e,t){const n=s.nodes.filter(c=>c.id!==e),r=s.selectedNodes.filter(c=>c.id!==e),o=s.arrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e),i=s.selectedArrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e);return{...s,nodes:n,arrows:o,selectedNodes:r,selectedArrows:i}}function Sl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,...t}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,...t}:o);return{...s,nodes:n,selectedNodes:r}}function ua(s,e){return s.arrows.some(t=>t.id===e.id)?s:{...s,arrows:[...s.arrows,e]}}function jl(s,e){const t=s.arrows.filter(r=>r.id!==e),n=s.selectedArrows.filter(r=>r.id!==e);return{...s,arrows:t,selectedArrows:n}}function Cl(s,e,t){const n=s.arrows.map(o=>o.id===e?{...o,...t}:o),r=s.selectedArrows.map(o=>o.id===e?{...o,...t}:o);return{...s,arrows:n,selectedArrows:r}}function Nl(s,e,t,n){const r=i=>{if(i.id!==e)return i;const c=Array.isArray(i.tags)?i.tags:[];if(c.some(d=>d.id===t.id))return i;let l={...i,tags:[...c,t]};return n&&(l={...l,groupId:n.groupId}),l};let o={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(o=uw(o,n.groupId,e)),o}function lw(s,e,t){const n=r=>r.id!==e||!Array.isArray(r.tags)?r:{...r,tags:r.tags.filter(o=>o.id!==t)};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function dw(s,e,t,n){const r=i=>{if(i.id!==e)return i;let c={...i,tags:Array.isArray(i.tags)?i.tags.filter(l=>l.id!==t):[]};return n&&(c={...c,x:n.previousPosition.x,y:n.previousPosition.y,groupId:n.previousGroupId}),c};let o={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(o=pw(o,n.groupId,e)),o}function uw(s,e,t){const n=r=>{if(r.id!==e)return r;const o=r.data??{childNodeIds:[]},i=o.childNodeIds??[];return i.includes(t)?r:{...r,data:{...o,childNodeIds:[...i,t]}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function pw(s,e,t){const n=r=>{if(r.id!==e)return r;const o=r.data??{childNodeIds:[]},i=o.childNodeIds??[];return{...r,data:{...o,childNodeIds:i.filter(c=>c!==t)}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function ti(s,e,t){return{type:"node:move",nodeId:s,from:e,to:t}}function SC(s){return s.length===1?ti(s[0].nodeId,s[0].from,s[0].to):{type:"batch",operations:s.map(e=>ti(e.nodeId,e.from,e.to)),label:`Move ${s.length} nodes`}}const hw="UndoArchiveDB",fw=2,Ge="archived_nodes",zt="tree_data";class mw{constructor(){Z(this,"db",null);Z(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,t)=>{const n=indexedDB.open(hw,fw);n.onerror=()=>{this.initPromise=null,t(new Error("Failed to open UndoArchiveDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const o=r.target.result;if(!o.objectStoreNames.contains(Ge)){const i=o.createObjectStore(Ge,{keyPath:"id"});i.createIndex("canvasId","canvasId",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("canvasId_timestamp",["canvasId","timestamp"],{unique:!1})}o.objectStoreNames.contains(zt)||o.createObjectStore(zt,{keyPath:"canvasId"})}}),this.initPromise)}async ensureInit(){if(this.db||await this.init(),!this.db)throw new Error("Database not initialized")}async archiveNode(e,t){await this.ensureInit();const n={...t,canvasId:e};return new Promise((r,o)=>{const l=this.db.transaction([Ge],"readwrite").objectStore(Ge).put(n);l.onsuccess=()=>r(),l.onerror=()=>o(new Error("Failed to archive node"))})}async archiveNodes(e,t){if(t.length!==0)return await this.ensureInit(),new Promise((n,r)=>{const i=this.db.transaction([Ge],"readwrite").objectStore(Ge);let c=0,l=!1;for(const d of t){const p={...d,canvasId:e},u=i.put(p);u.onsuccess=()=>{c++,c===t.length&&!l&&n()},u.onerror=()=>{l||(l=!0,r(new Error("Failed to archive nodes")))}}})}async getNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([Ge],"readonly").objectStore(Ge).get(e);i.onsuccess=()=>t(i.result??null),i.onerror=()=>n(new Error("Failed to get archived node"))})}async getNodes(e){return e.length===0?[]:(await this.ensureInit(),new Promise((t,n)=>{const o=this.db.transaction([Ge],"readonly").objectStore(Ge),i=[];let c=0;for(const l of e){const d=o.get(l);d.onsuccess=()=>{d.result&&i.push(d.result),c++,c===e.length&&t(i)},d.onerror=()=>{c++,c===e.length&&t(i)}}}))}async getAllForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([Ge],"readonly").objectStore(Ge).index("canvasId").getAll(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to get archived nodes for canvas"))})}async countForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([Ge],"readonly").objectStore(Ge).index("canvasId").count(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to count archived nodes"))})}async deleteNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([Ge],"readwrite").objectStore(Ge).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete archived node"))})}async deleteNodes(e){if(e.length!==0)return await this.ensureInit(),new Promise((t,n)=>{const o=this.db.transaction([Ge],"readwrite").objectStore(Ge);let i=0;for(const c of e){const l=o.delete(c);l.onsuccess=()=>{i++,i===e.length&&t()},l.onerror=()=>{i++,i===e.length&&t()}}})}async clearForCanvas(e){await this.ensureInit();const n=(await this.getAllForCanvas(e)).map(r=>r.id);await this.deleteNodes(n)}async getOldestForCanvas(e,t){return await this.ensureInit(),new Promise((n,r)=>{const c=this.db.transaction([Ge],"readonly").objectStore(Ge).index("canvasId_timestamp"),l=IDBKeyRange.bound([e,0],[e,1/0]),d=[],p=c.openCursor(l);p.onsuccess=u=>{const f=u.target.result;f&&d.length<t?(d.push(f.value),f.continue()):n(d)},p.onerror=()=>r(new Error("Failed to get oldest archived nodes"))})}async pruneForCanvas(e,t){const n=await this.countForCanvas(e);if(n<=t)return 0;const r=n-t,i=(await this.getOldestForCanvas(e,r)).map(c=>c.id);return await this.deleteNodes(i),i.length}async countAll(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([Ge],"readonly").objectStore(Ge).count();o.onsuccess=()=>e(o.result),o.onerror=()=>t(new Error("Failed to count all archived nodes"))})}async clearAll(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([Ge],"readwrite").objectStore(Ge).clear();o.onsuccess=()=>e(),o.onerror=()=>t(new Error("Failed to clear all archived nodes"))})}async saveTreeData(e,t){await this.ensureInit();const n={canvasId:e,treeData:t,lastModified:Date.now()};return new Promise((r,o)=>{const l=this.db.transaction([zt],"readwrite").objectStore(zt).put(n);l.onsuccess=()=>r(),l.onerror=()=>o(new Error("Failed to save tree data"))})}async loadTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([zt],"readonly").objectStore(zt).get(e);i.onsuccess=()=>{const c=i.result;t((c==null?void 0:c.treeData)??null)},i.onerror=()=>n(new Error("Failed to load tree data"))})}async deleteTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([zt],"readwrite").objectStore(zt).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete tree data"))})}async clearAllTreeData(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([zt],"readwrite").objectStore(zt).clear();o.onsuccess=()=>e(),o.onerror=()=>t(new Error("Failed to clear all tree data"))})}}const Ft=new mw;function kl(){return typeof window>"u"?!1:window.innerWidth<$e.history.tabletBreakpoint}function El(){const{archiveLimit:s,tabletArchiveLimit:e}=$e.history;return kl()?e:s}function Il(){const{historyLimit:s,tabletHistoryLimit:e}=$e.history;return kl()?e:s}function gw(s){const e=new Set;let t=s.current;for(;t!==null;){e.add(t);const n=s.nodes[t];if(!n)break;t=n.parent}return e}async function xw(s,e){const t=Il(),n=Object.keys(e.nodes).length;if(n<=t)return e;const r=gw(e),o=Object.values(e.nodes);o.sort((f,m)=>f.timestamp-m.timestamp);const i=[],c=n-t;for(const f of o){if(i.length>=c)break;r.has(f.id)||i.push(f)}if(i.length===0)return e;await Ft.archiveNodes(s,i);const l=El();await Ft.pruneForCanvas(s,l);const d=new Set(i.map(f=>f.id)),p={};for(const[f,m]of Object.entries(e.nodes))d.has(f)||(p[f]={...m,children:m.children.filter(g=>!d.has(g))});let u=e.root;if(u&&d.has(u)){const m=Object.values(p).find(g=>g.parent===null||!p[g.parent]);u=(m==null?void 0:m.id)??null}return{nodes:p,current:e.current,root:u}}function vw(s,e){return!s.nodes[e]}async function bw(s,e,t){const n=await Ft.getNode(t);if(!n)return null;const r=new Set;r.add(t);let o=n;for(;o;){r.add(o.id);for(const d of o.children)r.add(d);if(o.parent){if(e.nodes[o.parent])break;o=await Ft.getNode(o.parent)}else o=null}const i=await Ft.getNodes(Array.from(r)),c={...e.nodes};for(const d of i)if(!c[d.id]){const{canvasId:p,...u}=d;c[d.id]=u}for(const d of i)if(d.parent&&c[d.parent]){const p=c[d.parent];p.children.includes(d.id)||(p.children=[...p.children,d.id])}let l=e.root;if(!l){const d=Object.values(c).find(p=>p.parent===null||!c[p.parent]);l=(d==null?void 0:d.id)??null}return{nodes:c,current:e.current,root:l}}async function ww(s){return{archivedCount:await Ft.countForCanvas(s),archiveLimit:El(),historyLimit:Il()}}async function yw(s){await Ft.clearForCanvas(s),await Ft.deleteTreeData(s)}async function Sw(){await Ft.init()}async function Xn(s,e){await Ft.saveTreeData(s,e)}async function jw(s){return Ft.loadTreeData(s)}function Cw(){return window.innerWidth<$e.history.tabletBreakpoint}function Nw(){const{historyLimit:s,tabletHistoryLimit:e}=$e.history;return Cw()?e:s}function Rt(s){const e=s().projectCanvas.getActive();if(!e)return null;const t=e.undoTree??mr();return Ka.deserialize(t)}function ws(s){const e=s().state;if(!e)return null;const t=e.activeProjectId?e.projects[e.activeProjectId]:null,n=t&&t.activeWorkspaceId?t.workspaces[t.activeWorkspaceId]:null;return(n==null?void 0:n.activeCanvasId)??null}function Xa(s,e){s(Q(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;o&&(o.undoTree=e.serialize())}))}const kw=(s,e,t)=>{const n=Rt(e);if(!n)return;n.commit(t),Xa(s,n);const r=ws(e),o=Nw();r&&(async()=>{try{const i=n.serialize();if(await Xn(r,i),n.getSize()>o){const c=await xw(r,i);s(Q(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;u&&u.id===r&&(u.undoTree=c)})),await Xn(r,c)}}catch(i){console.warn("Failed to persist undo history:",i)}})()},Ew=(s,e)=>{const t=Rt(e);if(!t||!t.canUndo())return!1;const n=t.undo();if(!n)return!1;const r=ws(e);return s(Q(o=>{if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;l.coreState=Ya(l.coreState,n),l.undoTree=t.serialize();const d=Date.now();l.lastModified=d,c&&(c.lastModified=d),i&&(i.lastModified=d)})),r&&Xn(r,t.serialize()).catch(o=>{console.warn("Failed to persist undo position:",o)}),!0},Iw=(s,e,t)=>{const n=Rt(e);if(!n||!n.canRedo())return!1;const r=n.redo(t);if(!r)return!1;const o=ws(e);return s(Q(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;d.coreState=Ja(d.coreState,r),d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),o&&Xn(o,n.serialize()).catch(i=>{console.warn("Failed to persist redo position:",i)}),!0},Tl=(s,e,t)=>{const n=Rt(e);if(!n)return!1;const{undo:r,redo:o}=n.jumpTo(t);return r.length===0&&o.length===0?(Xa(s,n),!0):(s(Q(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;for(const u of r)d.coreState=Ya(d.coreState,u);for(const u of o)d.coreState=Ja(d.coreState,u);d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),!0)},Tw=async(s,e,t)=>{var o;const n=ws(e);if(!n)return!1;let r=(o=e().projectCanvas.getActive())==null?void 0:o.undoTree;if(r||(r=mr()),vw(r,t)){const i=await bw(n,r,t);if(!i)return!1;s(Q(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;p&&(p.undoTree=i)})),r=i}return Tl(s,e,t)},Aw=s=>{const e=Rt(s);return(e==null?void 0:e.canUndo())??!1},Pw=s=>{const e=Rt(s);return(e==null?void 0:e.canRedo())??!1},Rw=s=>{const e=Rt(s);return(e==null?void 0:e.getBranches())??[]},Dw=s=>{const e=Rt(s);return(e==null?void 0:e.getCurrent())??null},_w=s=>{const e=Rt(s);return(e==null?void 0:e.getPath())??[]},Ow=s=>{const e=Rt(s);return(e==null?void 0:e.getRedoPath())??[]},Lw=s=>{const e=Rt(s);return(e==null?void 0:e.getAllNodes())??[]},Mw=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.undoTree)??null},Fw=(s,e)=>{const t=ws(e);s(Q(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;i&&(i.undoTree=mr())})),t&&yw(t).catch(n=>{console.warn("Failed to clear undo archive:",n)})},$w=(s,e,t)=>{const n=Rt(e);n&&(n.prune(t),Xa(s,n))},Uw=async s=>{const e=ws(s);return e?ww(e):null},Bw=async()=>{await Sw()},Ww=async(s,e)=>{const t=ws(e);if(!t)return!1;try{const n=await jw(t);return n?(s(Q(r=>{if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;c&&c.id===t&&(c.undoTree=n)})),!0):!1}catch(n){return console.warn("Failed to load undo history from archive:",n),!1}},zw=(s,e)=>({commit:t=>kw(s,e,t),undo:()=>Ew(s,e),redo:t=>Iw(s,e,t),jumpTo:t=>Tl(s,e,t),jumpToAsync:t=>Tw(s,e,t),canUndo:()=>Aw(e),canRedo:()=>Pw(e),getBranches:()=>Rw(e),getCurrent:()=>Dw(e),getPath:()=>_w(e),getRedoPath:()=>Ow(e),getAllNodes:()=>Lw(e),getTreeData:()=>Mw(e),clear:()=>Fw(s,e),prune:t=>$w(s,e,t),getArchiveStats:()=>Uw(e),initArchive:()=>Bw(),loadFromArchive:()=>Ww(s,e)}),Hw=s=>{const e={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse","canvas-tag":"tag"};if(e[s])return e[s];const t=s.split("-");return t.length>=2?t[1]:null},Gw=(s,e,t,n)=>({getSegmentedButtonAction:r=>{var i,c;return((c=(i=s().preferences)==null?void 0:i.segmentedButtons)==null?void 0:c[r])??null},setSegmentedButtonAction:(r,o,i,c)=>{const l=n(),d=(c==null?void 0:c.skipHistoryUpdate)??!1,p=c==null?void 0:c.actionId,u=c==null?void 0:c.params;if(i){const f=i();f&&t.set(l,f)}e(Q(f=>{var b,v,w;if(f.preferences||(f.preferences={segmentedButtons:{}}),f.preferences.segmentedButtons||(f.preferences.segmentedButtons={}),f.preferences.segmentedButtons[r]=o,d){if((v=(b=f.actions)==null?void 0:b.history)!=null&&v.entries){const y=f.actions.history.entries.find(j=>j.source===r&&j.label===o);y&&(y.executorId&&t.delete(y.executorId),y.executorId=l,p&&!y.actionId&&(y.actionId=p),u&&!y.params&&(y.params=u))}return}f.actions||(f.actions={}),f.actions.history||(f.actions.history={entries:[],lastAction:void 0,maxSize:50});const m=f.actions.history.entries,g=m[0];if(g&&g.source===r&&g.label===o)g.executorId&&t.delete(g.executorId),g.executorId=l,g.timestamp=Date.now(),g.actionId=p,g.params=u,f.actions.history.lastAction=g;else{const y={executorId:l,source:r,label:o,timestamp:Date.now(),actionId:p,params:u};for(m.unshift(y);m.length>f.actions.history.maxSize;){const j=m.pop();j!=null&&j.executorId&&t.delete(j.executorId)}f.actions.history.lastAction=y}if((w=f.actions.recording)!=null&&w.isRecording){const y=Hw(r);if(y&&p){const j={id:Ue(8),action:{facadeKey:y,actionId:p,params:u,label:o},delayMs:0};f.actions.recording.capturedSteps.push(j)}}}))},getKeepArrowsOnSplit:()=>{var o;return((o=s().preferences)==null?void 0:o.keepArrowsOnSplit)??!1},setKeepArrowsOnSplit:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.keepArrowsOnSplit=r}))},getKeepSplitMatch:()=>{var o;return((o=s().preferences)==null?void 0:o.keepSplitMatch)??!1},setKeepSplitMatch:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.keepSplitMatch=r}))},getSplitHorizontally:()=>{var o;return((o=s().preferences)==null?void 0:o.splitHorizontally)??!1},setSplitHorizontally:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.splitHorizontally=r}))},getSplitNodeGap:()=>{var o;return((o=s().preferences)==null?void 0:o.splitNodeGap)??rt.NEW_NODE_SEGMENT_SPACING},setSplitNodeGap:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.splitNodeGap=r}))},getLastUsedBorder:()=>{var r,o,i,c,l,d;return{lastUsedColor:((o=(r=s().preferences)==null?void 0:r.borderButton)==null?void 0:o.lastUsedColor)??"hsl(var(--primary))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.borderButton)==null?void 0:c.lastUsedWidth)??"1px",lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.borderButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedBorder:(r,o,i)=>{e(Q(c=>{c.preferences||(c.preferences={}),c.preferences.borderButton||(c.preferences.borderButton={}),c.preferences.borderButton.lastUsedColor=r,c.preferences.borderButton.lastUsedWidth=o,c.preferences.borderButton.lastUsedStyle=i}))},getLastUsedArrowStyle:()=>{var r,o,i,c,l,d;return{lastUsedColor:((o=(r=s().preferences)==null?void 0:r.arrowStyleButton)==null?void 0:o.lastUsedColor)??"hsl(var(--muted-light))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.arrowStyleButton)==null?void 0:c.lastUsedWidth)??1,lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.arrowStyleButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedArrowStyle:(r,o,i)=>{e(Q(c=>{c.preferences||(c.preferences={}),c.preferences.arrowStyleButton||(c.preferences.arrowStyleButton={}),c.preferences.arrowStyleButton.lastUsedColor=r,c.preferences.arrowStyleButton.lastUsedWidth=o,c.preferences.arrowStyleButton.lastUsedStyle=i}))},getLastArrangeOption:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.lastArrangeOption)??null},setLastArrangeOption:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.lastArrangeOption=r}))},getSortByLastArrange:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.sortByLastArrange)??!1},setSortByLastArrange:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.sortByLastArrange=r}))},getArrangeNodeGap:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.nodeGap)??$e.arrange.gap},setArrangeNodeGap:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.nodeGap=r}))},getArrangeGridColumns:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.gridColumns)??$e.arrange.gridColumns},setArrangeGridColumns:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.gridColumns=r}))},getArrangeGridRows:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.gridRows)??$e.arrange.gridRows},setArrangeGridRows:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.gridRows=r}))},getCycleRowBuffer:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.cycleRowBuffer)??20},setCycleRowBuffer:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.cycleRowBuffer=r}))},getLastTagTitle:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.tagButton)==null?void 0:o.lastTagTitle)??null},setLastTagTitle:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.tagButton||(o.preferences.tagButton={}),o.preferences.tagButton.lastTagTitle=r}))},getGoToSymbolSearch:()=>{var r;return((r=s().preferences)==null?void 0:r.goToSymbolSearch)??null},setGoToSymbolSearchOptions:r=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.goToSymbolSearch?o.preferences.goToSymbolSearch.options=r:o.preferences.goToSymbolSearch={options:r,searchHistory:[]}}))},addGoToSymbolSearchHistory:r=>{r.trim()&&e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.goToSymbolSearch||(o.preferences.goToSymbolSearch={options:{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"},searchHistory:[]});const i=o.preferences.goToSymbolSearch.searchHistory.filter(c=>c!==r);i.unshift(r),o.preferences.goToSymbolSearch.searchHistory=i.slice(0,20)}))}}),qw=(s,e)=>({getSplitPresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.presets)??[]},getSplitPresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.splitPresets)==null?void 0:r.presets.find(o=>o.id===t)},getSplitPresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.favoriteIds)??[]},getActiveSplitPresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.activePresetId)??null},createSplitPreset:(t,n)=>{const r=Ue(10);return e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.splitPresets||(o.preferences.splitPresets={presets:[],favoriteIds:[]}),o.preferences.splitPresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateSplitPreset:(t,n)=>{e(Q(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n)}))},duplicateSplitPreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.splitPresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const o=`split-preset-${Date.now()}`,i={id:o,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(Q(d=>{d.preferences||(d.preferences={}),d.preferences.splitPresets||(d.preferences.splitPresets={presets:[],favoriteIds:[]}),d.preferences.splitPresets.presets.push(i)})),o},deleteSplitPreset:t=>{e(Q(n=>{var r;(r=n.preferences)!=null&&r.splitPresets&&(n.preferences.splitPresets.presets=n.preferences.splitPresets.presets.filter(o=>o.id!==t),n.preferences.splitPresets.favoriteIds=n.preferences.splitPresets.favoriteIds.filter(o=>o!==t),n.preferences.splitPresets.activePresetId===t&&(n.preferences.splitPresets.activePresetId=void 0))}))},renameSplitPreset:(t,n)=>{e(Q(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);o&&(o.name=n)}))},applySplitPreset:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.splitPresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(Q(c=>{c.preferences||(c.preferences={}),c.preferences.keepArrowsOnSplit=r.config.keepArrowsOnSplit,c.preferences.keepSplitMatch=r.config.keepSplitMatch,c.preferences.splitHorizontally=r.config.splitHorizontally,c.preferences.splitNodeGap=r.config.splitNodeGap,c.preferences.splitPresets||(c.preferences.splitPresets={presets:[],favoriteIds:[]}),c.preferences.splitPresets.activePresetId=t}))},toggleSplitPresetFavorite:t=>{e(Q(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]});const r=n.preferences.splitPresets.favoriteIds.indexOf(t);r===-1?n.preferences.splitPresets.favoriteIds.push(t):n.preferences.splitPresets.favoriteIds.splice(r,1)}))},setActiveSplitPresetId:t=>{e(Q(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]}),n.preferences.splitPresets.activePresetId=t??void 0}))}}),Vw=(s,e)=>({getArrangePresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.presets)??[]},getArrangePresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.arrangePresets)==null?void 0:r.presets.find(o=>o.id===t)},getArrangePresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.favoriteIds)??[]},getActiveArrangePresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.activePresetId)??null},createArrangePreset:(t,n)=>{const r=Ue(10);return e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangePresets||(o.preferences.arrangePresets={presets:[],favoriteIds:[]}),o.preferences.arrangePresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateArrangePreset:(t,n)=>{e(Q(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n)}))},duplicateArrangePreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.arrangePresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const o=`arrange-preset-${Date.now()}`,i={id:o,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(Q(d=>{d.preferences||(d.preferences={}),d.preferences.arrangePresets||(d.preferences.arrangePresets={presets:[],favoriteIds:[]}),d.preferences.arrangePresets.presets.push(i)})),o},deleteArrangePreset:t=>{e(Q(n=>{var r;(r=n.preferences)!=null&&r.arrangePresets&&(n.preferences.arrangePresets.presets=n.preferences.arrangePresets.presets.filter(o=>o.id!==t),n.preferences.arrangePresets.favoriteIds=n.preferences.arrangePresets.favoriteIds.filter(o=>o!==t),n.preferences.arrangePresets.activePresetId===t&&(n.preferences.arrangePresets.activePresetId=void 0))}))},renameArrangePreset:(t,n)=>{e(Q(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&(o.name=n)}))},applyArrangePreset:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.arrangePresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(Q(c=>{c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),c.preferences.arrangeButton.nodeGap=r.config.nodeGap,c.preferences.arrangeButton.gridColumns=r.config.gridColumns,c.preferences.arrangeButton.sortByLastArrange=r.config.sortByLastArrange,c.preferences.arrangePresets||(c.preferences.arrangePresets={presets:[],favoriteIds:[]}),c.preferences.arrangePresets.activePresetId=t}))},toggleArrangePresetFavorite:t=>{e(Q(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]});const r=n.preferences.arrangePresets.favoriteIds.indexOf(t);r===-1?n.preferences.arrangePresets.favoriteIds.push(t):n.preferences.arrangePresets.favoriteIds.splice(r,1)}))},setActiveArrangePresetId:t=>{e(Q(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]}),n.preferences.arrangePresets.activePresetId=t??void 0}))}}),Kw=(s,e)=>({getArrangeConfigFavorites:()=>{var t;return((t=s().preferences)==null?void 0:t.arrangeConfigFavorites)??[]},getArrangeConfigFavoritesByType:t=>{var n;return(((n=s().preferences)==null?void 0:n.arrangeConfigFavorites)??[]).filter(r=>r.type===t)},addArrangeConfigFavorite:(t,n)=>{const r=Ue(10);return e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeConfigFavorites||(o.preferences.arrangeConfigFavorites=[]),o.preferences.arrangeConfigFavorites.some(c=>c.type===t&&c.value===n)||o.preferences.arrangeConfigFavorites.push({id:r,type:t,value:n})})),r},removeArrangeConfigFavorite:t=>{e(Q(n=>{var r;(r=n.preferences)!=null&&r.arrangeConfigFavorites&&(n.preferences.arrangeConfigFavorites=n.preferences.arrangeConfigFavorites.filter(o=>o.id!==t))}))},applyArrangeConfigFavorite:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.arrangeConfigFavorites)==null?void 0:i.find(c=>c.id===t);r&&e(Q(c=>{switch(c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),r.type){case"gap":c.preferences.arrangeButton.nodeGap=r.value;break;case"columns":c.preferences.arrangeButton.gridColumns=r.value;break;case"rows":c.preferences.arrangeButton.gridRows=r.value;break}}))},isArrangeConfigFavorite:(t,n)=>{var r;return(((r=s().preferences)==null?void 0:r.arrangeConfigFavorites)??[]).some(o=>o.type===t&&o.value===n)},toggleArrangeConfigFavorite:(t,n)=>{var c;const r=s(),i=(((c=r.preferences)==null?void 0:c.arrangeConfigFavorites)??[]).find(l=>l.type===t&&l.value===n);i?r.removeArrangeConfigFavorite(i.id):r.addArrangeConfigFavorite(t,n)}}),Jw=(s,e)=>({getPinnedPaletteItems:t=>{var n,r;return((r=(n=s().preferences)==null?void 0:n.pinnedPaletteItems)==null?void 0:r[t])??[]},pinPaletteItem:(t,n)=>{e(Q(r=>{r.preferences||(r.preferences={}),r.preferences.pinnedPaletteItems||(r.preferences.pinnedPaletteItems={}),r.preferences.pinnedPaletteItems[t]||(r.preferences.pinnedPaletteItems[t]=[]),r.preferences.pinnedPaletteItems[t].includes(n)||r.preferences.pinnedPaletteItems[t].push(n)}))},unpinPaletteItem:(t,n)=>{e(Q(r=>{var o,i;(i=(o=r.preferences)==null?void 0:o.pinnedPaletteItems)!=null&&i[t]&&(r.preferences.pinnedPaletteItems[t]=r.preferences.pinnedPaletteItems[t].filter(c=>c!==n))}))},togglePinPaletteItem:(t,n)=>{s().isPaletteItemPinned(t,n)?s().unpinPaletteItem(t,n):s().pinPaletteItem(t,n)},isPaletteItemPinned:(t,n)=>{var r,o,i;return((i=(o=(r=s().preferences)==null?void 0:r.pinnedPaletteItems)==null?void 0:o[t])==null?void 0:i.includes(n))??!1}}),Yw=(s,e)=>({getOpenTabs:()=>{var t;return((t=s().preferences)==null?void 0:t.openTabs)??[]},openTab:(t,n,r)=>{e(Q(o=>{o.preferences||(o.preferences={}),o.preferences.openTabs||(o.preferences.openTabs=[]),o.preferences.openTabs.some(c=>c.canvasId===t)||o.preferences.openTabs.push({canvasId:t,projectId:n,workspaceId:r})}))},closeTab:t=>{var c;const n=((c=s().preferences)==null?void 0:c.openTabs)??[];if(n.length<=1)return;const r=n.findIndex(l=>l.canvasId===t),o=s().projectCanvas.getActive(),i=(o==null?void 0:o.id)===t;if(e(Q(l=>{var d;(d=l.preferences)!=null&&d.openTabs&&(l.preferences.openTabs=l.preferences.openTabs.filter(p=>p.canvasId!==t))})),i){const l=r>=n.length-1?r-1:r,d=n.filter(p=>p.canvasId!==t)[l];d&&s().projectCanvas.switch(d.canvasId)}},closeOtherTabs:t=>{e(Q(n=>{var r;(r=n.preferences)!=null&&r.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(o=>o.canvasId===t))}))},closeTabsToRight:t=>{e(Q(n=>{var o;if(!((o=n.preferences)!=null&&o.openTabs))return;const r=n.preferences.openTabs.findIndex(i=>i.canvasId===t);r!==-1&&(n.preferences.openTabs=n.preferences.openTabs.slice(0,r+1))}))},reorderTabs:t=>{e(Q(n=>{var o;if(!((o=n.preferences)!=null&&o.openTabs))return;const r=new Map(n.preferences.openTabs.map(i=>[i.canvasId,i]));n.preferences.openTabs=t.map(i=>r.get(i)).filter(i=>i!==void 0)}))}}),Xw=(s,e,t,n)=>({getGlobalActionHistory:()=>{var r,o;return((o=(r=s().actions)==null?void 0:r.history)==null?void 0:o.entries)??[]},getGlobalLastAction:()=>{var r,o;return(o=(r=s().actions)==null?void 0:r.history)==null?void 0:o.lastAction},executeGlobalLastAction:()=>{var i,c;const r=(c=(i=s().actions)==null?void 0:i.history)==null?void 0:c.lastAction;if(!r)return!1;if(r.actionId){const l=n.get(r.actionId);if(l)return l(r.params),!0}const o=r.executorId?t.get(r.executorId):void 0;return o?(o(),!0):!1},executeActionById:r=>{const o=t.get(r);return o?(o(),!0):!1},hasExecutor:r=>t.has(r),clearGlobalActionHistory:()=>{var o,i;const r=((i=(o=s().actions)==null?void 0:o.history)==null?void 0:i.entries)??[];for(const c of r)c.executorId&&t.delete(c.executorId);e(Q(c=>{var l;(l=c.actions)!=null&&l.history&&(c.actions.history.entries=[],c.actions.history.lastAction=void 0)}))}}),Qw=(s,e)=>({isRecording:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.isRecording)??!1},startRecording:()=>{e(Q(t=>{t.actions||(t.actions={}),t.actions.recording={isRecording:!0,capturedSteps:[],startedAt:Date.now()}}))},stopRecording:()=>{var n,r;const t=((r=(n=s().actions)==null?void 0:n.recording)==null?void 0:r.capturedSteps)??[];return e(Q(o=>{var i;(i=o.actions)!=null&&i.recording&&(o.actions.recording.isRecording=!1)})),t},cancelRecording:()=>{e(Q(t=>{t.actions&&(t.actions.recording={isRecording:!1,capturedSteps:[]})}))},getRecordingSteps:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.capturedSteps)??[]}}),Zw=(s,e)=>({isHistorySelecting:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.isSelecting)??!1},toggleHistorySelectionMode:()=>{e(Q(t=>{t.actions||(t.actions={}),t.actions.historySelection||(t.actions.historySelection={isSelecting:!1,selectedIds:[]}),t.actions.historySelection.isSelecting=!t.actions.historySelection.isSelecting,t.actions.historySelection.isSelecting||(t.actions.historySelection.selectedIds=[])}))},toggleHistoryItemSelection:t=>{e(Q(n=>{var o;if(!((o=n.actions)!=null&&o.historySelection))return;const r=n.actions.historySelection.selectedIds.indexOf(t);r===-1?n.actions.historySelection.selectedIds.push(t):n.actions.historySelection.selectedIds.splice(r,1)}))},getSelectedHistoryIds:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.selectedIds)??[]},clearHistorySelection:()=>{e(Q(t=>{var n;(n=t.actions)!=null&&n.historySelection&&(t.actions.historySelection.selectedIds=[],t.actions.historySelection.isSelecting=!1)}))}}),ey=(s,e)=>({getSequencePresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.presets)??[]},getSequencePresetById:t=>{var n,r;return(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.presets.find(o=>o.id===t)},createSequencePreset:(t,n)=>{const r=Ue(10);return e(Q(o=>{o.actions||(o.actions={}),o.actions.sequencePresets||(o.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),o.actions.sequencePresets.presets.push({id:r,name:t,steps:n,createdAt:Date.now()})})),r},updateSequencePreset:(t,n)=>{e(Q(r=>{var i,c;const o=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n,{updatedAt:Date.now()})}))},deleteSequencePreset:t=>{e(Q(n=>{var r;(r=n.actions)!=null&&r.sequencePresets&&(n.actions.sequencePresets.presets=n.actions.sequencePresets.presets.filter(o=>o.id!==t),n.actions.sequencePresets.favoriteIds=n.actions.sequencePresets.favoriteIds.filter(o=>o!==t),n.actions.sequencePresets.activePresetId===t&&(n.actions.sequencePresets.activePresetId=void 0))}))},duplicateSequencePreset:t=>{var o,i;const n=(i=(o=s().actions)==null?void 0:o.sequencePresets)==null?void 0:i.presets.find(c=>c.id===t);if(!n)return"";const r=crypto.randomUUID();return e(Q(c=>{c.actions||(c.actions={}),c.actions.sequencePresets||(c.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const l=n.steps.map(d=>({...d,id:crypto.randomUUID()}));c.actions.sequencePresets.presets.push({id:r,name:`${n.name} (copy)`,steps:l,createdAt:Date.now()})})),r},toggleSequencePresetFavorite:t=>{e(Q(n=>{n.actions||(n.actions={}),n.actions.sequencePresets||(n.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const r=n.actions.sequencePresets.favoriteIds.indexOf(t);r===-1?n.actions.sequencePresets.favoriteIds.push(t):n.actions.sequencePresets.favoriteIds.splice(r,1)}))},getSequencePresetFavorites:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.favoriteIds)??[]}}),ty=(s,e)=>({getVisualWorkflowPresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.visualWorkflows)??[]},getVisualWorkflowPresetById:t=>{var n,r,o;return(o=(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.visualWorkflows)==null?void 0:o.find(i=>i.id===t)},createVisualWorkflowPreset:(t,n,r)=>{const o=Ue(10);return e(Q(i=>{i.actions||(i.actions={}),i.actions.sequencePresets||(i.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),i.actions.sequencePresets.visualWorkflows||(i.actions.sequencePresets.visualWorkflows=[]),i.actions.sequencePresets.visualWorkflows.push({id:o,name:t,steps:n,sourceLocation:r,createdAt:Date.now()})})),o},updateVisualWorkflowPreset:(t,n)=>{e(Q(r=>{var i,c,l;const o=(l=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)==null?void 0:l.find(d=>d.id===t);o&&Object.assign(o,n,{updatedAt:Date.now()})}))},deleteVisualWorkflowPreset:t=>{e(Q(n=>{var r,o;(o=(r=n.actions)==null?void 0:r.sequencePresets)!=null&&o.visualWorkflows&&(n.actions.sequencePresets.visualWorkflows=n.actions.sequencePresets.visualWorkflows.filter(i=>i.id!==t))}))}}),sy=(s,e)=>({addTagToNode:(t,n,r)=>{const o=s().getNodeById(t);if(!o)return;const i={x:o.x,y:o.y},c=o.groupId,l=typeof n=="string"?{id:Math.random().toString(36).slice(2,10),title:n}:n,d=Array.isArray(o.tags)?o.tags:[];if(d.some(f=>f.title===l.title))return;s().updateNode(t,{tags:[...d,l]});let u;if(!o.groupId&&o.type!==Ve.GROUP&&(u=s().getNodesByTag(l.title).find(m=>m.type===Ve.GROUP&&m.id!==t),u)){const g=o.width??200,x=o.height??100,b=u.width??400,v=u.height??300,w=u.x+b-g-20,y=u.y+v-x-20;s().updateNode(t,{x:w,y}),s().group.addNodesToGroup(u.id,[t])}r!=null&&r.skipUndo||s().undo.commit({type:"tag:add",nodeId:t,tag:l,autoGroup:u?{groupId:u.id,previousPosition:i,previousGroupId:c}:void 0})},removeTagFromNode:(t,n,r)=>{const o=s().getNodeById(t);if(!o||!Array.isArray(o.tags))return;const i=o.tags.find(c=>c.id===n);s().updateNode(t,{tags:o.tags.filter(c=>c.id!==n)}),!(r!=null&&r.skipUndo)&&i&&s().undo.commit({type:"tag:remove",nodeId:t,tag:i})},getNodesByTag:t=>{const n=s().projectCanvas.getActive();return n?(n.coreState.nodes||[]).filter(o=>Array.isArray(o.tags)&&o.tags.some(i=>i.title===t)):[]},hasTag:(t,n)=>{const r=s().getNodeById(t);return!r||!Array.isArray(r.tags)?!1:r.tags.some(o=>o.title===n)}}),ny=5e3,Us={HEALTH:"/api/canvas/health",STATE:"/api/canvas/state",USER_STATE:"/api/canvas/user"};class Al{constructor(e="http://localhost:3030",t=ny){Z(this,"baseUrl");Z(this,"timeout");this.baseUrl=e,this.timeout=t}async health(){const e=`${this.baseUrl}${Us.HEALTH}`;try{const t=await this.fetchWithTimeout(e,{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?await t.json():(console.error("[CanvasApiClient] Health check failed:",t.status),{status:"error",timestamp:new Date().toISOString()})}catch(t){return console.error("[CanvasApiClient] Health check error:",t),{status:"error",timestamp:new Date().toISOString()}}}async getState(){const e=`${this.baseUrl}${Us.STATE}`;try{const t=await this.fetchWithTimeout(e,{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?await t.json():(console.error("[CanvasApiClient] Get state failed:",t.status),{success:!1,error:`HTTP ${t.status}`})}catch(t){return console.error("[CanvasApiClient] Get state error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async saveState(e){const t=`${this.baseUrl}${Us.STATE}`;try{const n=await this.fetchWithTimeout(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return n.ok?await n.json():(console.error("[CanvasApiClient] Save state failed:",n.status),{success:!1,error:`HTTP ${n.status}`})}catch(n){return console.error("[CanvasApiClient] Save state error:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async getUserState(e){const t=`${this.baseUrl}${Us.USER_STATE}/${e}/state`;try{const n=await this.fetchWithTimeout(t,{method:"GET",headers:{"Content-Type":"application/json"}});return n.ok?await n.json():(console.error("[CanvasApiClient] Get user state failed:",n.status),{success:!1,error:`HTTP ${n.status}`})}catch(n){return console.error("[CanvasApiClient] Get user state error:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async saveUserState(e,t){const n=`${this.baseUrl}${Us.USER_STATE}/${e}/state`;try{const r=await this.fetchWithTimeout(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({canvasState:t})});return r.ok?await r.json():(console.error("[CanvasApiClient] Save user state failed:",r.status),{success:!1,error:`HTTP ${r.status}`})}catch(r){return console.error("[CanvasApiClient] Save user state error:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}const pa=new Al,ry=Object.freeze(Object.defineProperty({__proto__:null,CanvasApiClient:Al,canvasApiClient:pa},Symbol.toStringTag,{value:"Module"})),Dt="[ApiSync]",ay=s=>{var r,o;const e=s(),t=((r=e.state)==null?void 0:r.projects)??{},n={};for(const[i,c]of Object.entries(t)){const l={};for(const[d,p]of Object.entries(c.workspaces)){const u={};for(const[f,m]of Object.entries(p.canvases)){const{undoTree:g,...x}=m;u[f]=x}l[d]={...p,canvases:u}}n[i]={...c,workspaces:l}}return{projects:n,activeProjectId:((o=e.state)==null?void 0:o.activeProjectId)??null,preferences:e.preferences??{},actions:e.actions??{}}},oy=(s,e)=>{s(Q(t=>{t.state||(t.state={projects:{},activeProjectId:null}),t.state.projects=e.projects,t.state.activeProjectId=e.activeProjectId,t.preferences||(t.preferences={}),Object.assign(t.preferences,e.preferences),t.actions||(t.actions={}),Object.assign(t.actions,e.actions)}))},iy=(s,e)=>({syncToApi:async()=>{var n;if(!(((n=s().preferences)==null?void 0:n.apiSyncEnabled)??!1)){console.log(Dt,"API sync disabled, skipping sync");return}try{const r=ay(s);console.log(Dt,"Syncing state to API...");const o=await pa.saveState(r);o.success?console.log(Dt,"State synced successfully"):(console.error(Dt,"Sync failed:",o.error),ke.error("API Sync Failed",{description:o.error??"Unknown error",duration:3e3}))}catch(r){console.error(Dt,"Sync error:",r),ke.error("API Sync Error",{description:r instanceof Error?r.message:"Unknown error",duration:3e3})}},loadFromApi:async()=>{try{console.log(Dt,"Loading state from API...");const t=await pa.getState();return t.success?t.data?Object.keys(t.data.projects??{}).length>0?(oy(e,t.data),console.log(Dt,"State loaded successfully from API"),ke.success("Loaded from Cloud",{description:`${Object.keys(t.data.projects).length} project(s) loaded`,duration:2e3}),!0):(console.log(Dt,"API returned empty projects"),!1):(console.log(Dt,"No data returned from API (empty state)"),!1):(console.error(Dt,"Load failed:",t.error),ke.error("API Load Failed",{description:t.error??"Unknown error",duration:3e3}),!1)}catch(t){return console.error(Dt,"Load error:",t),ke.error("API Load Error",{description:t instanceof Error?t.message:"Unknown error",duration:3e3}),!1}},getApiSyncEnabled:()=>{var t;return((t=s().preferences)==null?void 0:t.apiSyncEnabled)??!1},setApiSyncEnabled:t=>{e(Q(n=>{n.preferences||(n.preferences={}),n.preferences.apiSyncEnabled=t}))}}),si=new Map,Pl=new Map,cy=(s,e)=>{Pl.set(s,e)},ly=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,ni="markop-canvas-v2-storage",Xt=new Kv("CanvasStateV2",Mv.CanvasStateV2),dy=(s,e)=>({...Ba,...pv(e,s),...Zx(e,s),project:Pv(s,e),workspace:Lv(s,e),projectCanvas:Vv(s,e),arrow:Pg(s,e),group:ab(s,e),table:lb(s,e),layer:Ib(s,e),viewLayer:Jb(s,e),ext:ow(s,e),undo:zw(s,e),getCanvasMouseCoords:()=>fg(e),...sv(e,s),setFlags:t=>Px(s,t),...Gw(e,s,si,ly),...qw(e,s),...Vw(e,s),...Kw(e,s),...Jw(e,s),...Yw(e,s),...Xw(e,s,si,Pl),...Qw(e,s),...Zw(e,s),...ey(e,s),...ty(e,s),resetState:()=>Rx(s),resetEverything:()=>qx([ni,"paper-texture-live-config","paper-texture-saved-presets"]),scrollToNode:(t,n=500,r)=>pg(s,e,t,n,r),scrollToArrow:(t,n=500)=>Xv(s,e,t,n),...sy(e),...kv(e,s),...mv(e,ni,Xt),...iy(e,s)}),uy=dy,Mt=Jc()(uy);let Qa=!1;(async()=>{var s,e;try{const{loadActiveUserId:t,DEFAULT_USERS:n,saveActiveUserId:r}=await qe(async()=>{const{loadActiveUserId:d,DEFAULT_USERS:p,saveActiveUserId:u}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:d,DEFAULT_USERS:p,saveActiveUserId:u}},[]),{loadCanvasStateForUser:o,createDefaultCanvasStateForUser:i}=await qe(async()=>{const{loadCanvasStateForUser:d,createDefaultCanvasStateForUser:p}=await import("./userCanvasStateStorage-BQhrJ7tu.js");return{loadCanvasStateForUser:d,createDefaultCanvasStateForUser:p}},__vite__mapDeps([66,1,4,5,6,2]));let c=t(),l=null;if(!c&&n.length>0){const d=n[0];c=d.id,r(c),Xt.log(`No active user found, initializing with default: ${d.username}`)}if(c){const d=await o(c);let p=null,u=0;const{canvasApiClient:f}=await qe(async()=>{const{canvasApiClient:g}=await Promise.resolve().then(()=>ry);return{canvasApiClient:g}},void 0);try{const g=await f.getUserState(c);g.success&&((s=g.data)!=null&&s.canvasState)&&(p=JSON.parse(g.data.canvasState),u=g.data.lastModified??0,Xt.log(`API state available for user: ${c}, lastModified: ${u}`))}catch(g){Xt.log(`API fetch failed for user: ${c}`,g)}const m=(e=d==null?void 0:d.state)!=null&&e.projects?Math.max(...Object.values(d.state.projects).map(g=>g.lastModified??0)):0;if(p&&u>=m?(l=p,Xt.log(`Using API state (newer: ${u} >= ${m})`)):d&&(l=d,Xt.log(`Using localStorage state (newer: ${m} > ${u})`)),!l){const g=n.find(b=>b.id===c),x=(g==null?void 0:g.username)??"User";l=i(c,x),Xt.log(`Created default canvas state for user: ${x}`)}}if(l){const d=xv(Ba,l);vv(d.preferences),Mt.setState({version:d.version,dataVersion:d.dataVersion,state:d.state,uiState:d.uiState,flags:d.flags,preferences:d.preferences,extensions:d.extensions,actions:d.actions}),Xt.log("Canvas state rehydrated from user-specific storage");try{await Mt.getState().undo.initArchive(),await Mt.getState().undo.loadFromArchive()&&Xt.log("Undo history loaded from IndexedDB")}catch(p){console.warn("[PERSISTENCE] Failed to load undo history from IndexedDB:",p)}}}catch(t){console.error("[PERSISTENCE] Failed to rehydrate from localStorage:",t)}finally{Qa=!0}})();let Tr=null;const py=1e3;$e.autosave&&$e.persistState&&Mt.subscribe(s=>{Qa&&(Tr&&clearTimeout(Tr),Tr=setTimeout(async()=>{s.saveStateToLocalStorage(),s.getApiSyncEnabled()&&s.syncToApi();const{loadActiveUserId:e}=await qe(async()=>{const{loadActiveUserId:r}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:r}},[]),{saveCanvasStateForUser:t}=await qe(async()=>{const{saveCanvasStateForUser:r}=await import("./userCanvasStateStorage-BQhrJ7tu.js");return{saveCanvasStateForUser:r}},__vite__mapDeps([66,1,4,5,6,2])),n=e();n&&t(n)},py))});const hy={mousePosition:null},fy=(s,e)=>({...hy,setMousePosition:t=>Yg(s,t)}),Rl=Jc()(fy),jC=Object.freeze(Object.defineProperty({__proto__:null,canvasStoreV2:Mt,canvasUiStoreV2:Rl,get isRehydrated(){return Qa},registerActionHandler:cy},Symbol.toStringTag,{value:"Module"}));class my{constructor(){Z(this,"activeTranscriptions",new Map);Z(this,"listeners",new Set)}register(e,t){this.activeTranscriptions.set(e,{nodeId:e,sessionName:t,startedAt:Date.now(),status:"recording"}),this.notify()}updateStatus(e,t){const n=this.activeTranscriptions.get(e);n&&(n.status=t,this.notify())}complete(e,t){const n=Mt.getState(),r=n.getNodeById(e);if(r){const o=r.content||"",i=o+(o?`
`:"")+t;n.updateNodeContent(e,i),$g();const{width:c,height:l}=Ug(i);n.updateNode(e,{width:c,height:l,options:{...r.options,lockSize:!1}})}this.activeTranscriptions.delete(e),this.notify()}fail(e){this.activeTranscriptions.delete(e),this.notify()}has(e){return this.activeTranscriptions.has(e)}getStatus(e){var t;return((t=this.activeTranscriptions.get(e))==null?void 0:t.status)??null}getAll(){return Array.from(this.activeTranscriptions.values())}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}}const jn=new my;var Za=(s=>(s.EN="en",s.VI="vi",s.DE="de",s))(Za||{});const CC={en:"EN",vi:"VI",de:"DE"},NC={en:"English",vi:"Vietnamese",de:"German"},kC={en:"ðŸ‡¬ðŸ‡§",vi:"ðŸ‡»ðŸ‡³",de:"ðŸ‡©ðŸ‡ª"},Dl="en",EC=["en","vi","de"];function _l({onTranscriptionComplete:s,className:e="",sessionName:t="audio-button-default",getTextAreaElement:n,variant:r="default",autoStartRecording:o=!1,style:i,nodeId:c,language:l}){const[d,p]=h.useState(!1),[u,f]=h.useState(0),[m,g]=h.useState(0),[x,b]=h.useState(!1),v=h.useRef(0),w=h.useRef({});v.current++;const y={onTranscriptionComplete:s,sessionName:t,getTextAreaElement:n,variant:r,autoStartRecording:o,nodeId:c,language:l};Object.keys(y).forEach(I=>{w.current[I],y[I]}),w.current=y,h.useEffect(()=>{if(o&&!d){const I=setTimeout(()=>{f(_=>_+1)},100);return()=>clearTimeout(I)}},[o]);const j=h.useCallback(I=>"value"in I?I.value:I.textContent||"",[]),S=h.useCallback((I,_)=>{var q;if("value"in I){const J=(q=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:q.set;J?J.call(I,_):I.value=_}else I.textContent=_;const F=new Event("input",{bubbles:!0});I.dispatchEvent(F)},[]),[C,N]=h.useState([]),[A,k]=h.useState(0),[E,R]=h.useState(!1),M=h.useCallback(I=>{N(_=>[..._,I]),(I.transcriptionStatus==="pending"||I.transcriptionStatus==="processing")&&b(!0)},[]),L=h.useCallback(I=>{N(_=>_.map(F=>F.id===I.id?I:F)),I.transcription?(k(_=>_+1),c?jn.complete(c,I.transcription):s==null||s(I.transcription),b(!1)):I.transcriptionStatus==="failed"&&(c&&jn.fail(c),b(!1))},[s,c]),T=h.useCallback(I=>{p(I),c&&(I?jn.register(c,t):jn.updateStatus(c,"transcribing"))},[c,t]),W=h.useCallback(I=>{I&&(I.preventDefault(),I.stopPropagation()),d?g(_=>_+1):f(_=>_+1)},[d]),z=h.useCallback(I=>{if(I.preventDefault(),I.stopPropagation(),A>0&&n){const _=n();if(!_)return;const F=C[A-1];if(!(F!=null&&F.transcription))return;const q=j(_),J=F.transcription;let P=q;q.endsWith(J)?P=q.slice(0,-J.length):q.endsWith(" "+J)&&(P=q.slice(0,-(J.length+1))),P=P.trimEnd(),S(_,P),k(B=>B-1)}},[A,C,n,j,S]),te=h.useCallback(I=>{if(I.preventDefault(),I.stopPropagation(),A<C.length&&n){const _=n();if(!_)return;const F=C[A];if(!(F!=null&&F.transcription))return;const q=j(_),J=q.trim()?" ":"",P=q+J+F.transcription;S(_,P),k(B=>B+1)}},[A,C,n,j,S]),O=h.useCallback(I=>{const _=C.findIndex(F=>F.id===I);if(_!==-1){if(_<A&&n){const F=n();if(F){const J=C.filter((P,B)=>B<A&&B!==_).map(P=>P.transcription).filter(Boolean).join(" ");S(F,J),k(P=>P-1)}}N(F=>F.filter(q=>q.id!==I))}},[C,A,n,S]),ee=h.useCallback(()=>{if(n){const I=n();I&&S(I,"")}N([]),k(0)},[n,S]);return h.useEffect(()=>{const I=_=>{if(_.ctrlKey&&_.shiftKey&&_.key==="A")if(n){const F=n();F&&document.activeElement===F&&(_.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation(),W())}else _.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation(),W()};return window.addEventListener("keydown",I,!0),()=>{window.removeEventListener("keydown",I,!0)}},[W,n]),a.jsxs("div",{className:`audio-button-wrapper flex items-center gap-1 ${e}`,"data-test":"audio-button-wrapper",style:i,children:[x&&a.jsx("div",{className:"transcription-spinner","data-test":"audio-button-transcription-spinner",children:a.jsx(ir,{className:"w-4 h-4 animate-spin text-muted-foreground","data-test":"audio-button-transcription-spinner-icon"})}),C.length>0&&a.jsxs("div",{className:"chunk-navigation flex items-center gap-0.5","data-test":"audio-button-chunk-navigation",children:[a.jsx("button",{onMouseDown:I=>I.preventDefault(),onClick:z,disabled:A===0,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Remove previous chunk",type:"button","data-test":"audio-button-previous-chunk-button",children:a.jsx(Ds,{className:Fe.sm,"data-test":"audio-button-previous-chunk-icon"})}),a.jsxs(st,{open:E,onOpenChange:R,"data-test":"audio-button-chunk-panel-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsxs("button",{onMouseDown:I=>I.preventDefault(),onDoubleClick:()=>{ee(),R(!1)},className:"chunk-counter text-xs text-muted-foreground px-1 hover:bg-accent rounded cursor-pointer",title:"View all chunks (double-click to clear)",type:"button","data-test":"audio-button-chunk-counter-button",children:[A,"/",C.length]})}),a.jsx(Xe,{className:"w-96 p-0",side:"top",align:"center","data-test":"audio-button-chunk-panel-content",children:a.jsx("div",{className:"chunk-panel-popover","data-test":"audio-button-chunk-panel-wrapper",children:a.jsx(Kc,{chunks:C,onChunkDelete:O,onChunkTranscribe:()=>{},onClearAll:ee})})})]}),a.jsx("button",{onMouseDown:I=>I.preventDefault(),onClick:te,disabled:A>=C.length,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Add next chunk",type:"button","data-test":"audio-button-next-chunk-button",children:a.jsx($t,{className:Fe.sm,"data-test":"audio-button-next-chunk-icon"})})]}),a.jsx("button",{onMouseDown:I=>I.preventDefault(),onClick:W,className:r==="muted"?`voice-input-button p-1 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"text-muted-foreground/40 hover:text-foreground hover:bg-accent"}`:`voice-input-button p-1.5 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"hover:bg-accent"}`,title:d?"Stop recording (Ctrl+Shift+A)":"Start voice input (Ctrl+Shift+A)",type:"button","data-test":"audio-button-voice-input-button",children:a.jsx(rr,{className:`voice-input-icon ${r==="muted"?Fe.xs:Fe.sm} ${d?"animate-pulse":""}`,"data-test":"audio-button-voice-input-icon"})}),a.jsx("div",{className:"audio-panel-wrapper hidden","data-test":"audio-button-audio-panel-wrapper",children:a.jsx(Im,{sessionName:t,enableAutoPersist:!1,loadPersistedChunks:!1,autoStart:!1,startTrigger:u,stopTrigger:m,onChunkCreated:M,onChunkUpdated:L,onRecordingStateChange:T,initialConfig:l?{transcribeOptions:{language:l,...l===Za.VI?{model:"ggml-large-v3"}:{}}}:void 0})})]})}const ri=s=>{const{header:e,itemList:t,maxHeight:n,selectedIndices:r,selectedValues:o,getItemValue:i=(O,ee)=>ee,onSelectionChange:c,searchable:l=!1,searchPlaceholder:d="Search...",filterItem:p=(O,ee)=>String(O).toLowerCase().includes(ee.toLowerCase()),showAllOption:u=l,allOptionLabel:f="All",enableDelete:m=!1,onItemDelete:g,itemStyles:x="",moreOptions:b,initiallyCollapsed:v=!1,...w}=s,y=h.useRef({}),j=h.useRef(!1),[S,C]=h.useState(new Set(r)),[N,A]=h.useState(r==null?void 0:r[r.length-1]),[k,E]=h.useState(""),[R,M]=h.useState(v);h.useEffect(()=>{const O=Array.from(S),ee=r||[];if(O.length!==ee.length||!O.every((I,_)=>I===ee[_])){j.current=!0,C(new Set(r));const I=r==null?void 0:r[r.length-1];A(I)}},[r]),h.useEffect(()=>{if(o===void 0)return;const O=new Set,ee=new Set(o);if(t.forEach((I,_)=>{ee.has(i(I,_))&&O.add(_)}),O.size!==S.size||!Array.from(O).every(I=>S.has(I))){j.current=!0,C(O);const I=o[o.length-1],_=t.findIndex((F,q)=>i(F,q)===I);A(_!==-1?_:void 0)}},[o,t,i]),h.useEffect(()=>{if(j.current){const O=N;if(O!==void 0&&S.has(O)){const ee=y.current[O];ee&&ee.scrollIntoView({behavior:"smooth",block:"nearest"})}j.current=!1}},[S,N]);const L=(O,ee)=>{const I=te[O],_=t.findIndex(q=>q===I);if(_===-1)return;let F=new Set(S);if(ee.shiftKey&&N!==void 0){const q=Math.min(N,_),J=Math.max(N,_);for(let P=q;P<=J;P++)te.some(se=>t[P]===se)&&F.add(P)}else ee.ctrlKey||ee.metaKey?(F.has(_)?F.delete(_):F.add(_),A(_)):(F=new Set([_]),A(_));if(C(F),c){const q=Array.from(F),J=q.map(P=>i(t[P],P));c(q,J)}},T=(O,ee)=>{if(ee.stopPropagation(),g){const I=i(t[O],O);g(O,I)}},W=()=>{E(""),C(new Set),A(void 0),c&&c([],[])},z=()=>{M(!R)},te=k&&l?t.filter((O,ee)=>p(O,k,ee)):t;return a.jsxs("div",{id:"UiList","data-test":"ui-list-container",className:"bg-background text-foreground select-none",...w,children:[e?a.jsxs("div",{id:"header-container","data-test":"ui-list-header-container",className:"flex justify-between items-center sticky top-0 bg-background z-10 py-2 px-2 border-b border-border",children:[a.jsx("div",{"data-test":"ui-list-header-content",className:`flex-grow ${typeof e=="string"?"font-bold":""}`,children:e}),b&&a.jsx("div",{className:"flex items-center ml-2 flex-shrink-0","data-test":"ui-list-more-options",children:b}),a.jsx(ue,{variant:"ghost",size:"sm",onClick:z,className:"p-1 h-auto flex-shrink-0","aria-label":R?"Expand list":"Collapse list","data-test":"ui-list-collapse-toggle",children:R?a.jsx(wt,{size:16}):a.jsx(ar,{size:16})})]}):null,!R&&a.jsxs(a.Fragment,{children:[l&&a.jsx("div",{className:"sticky top-0 bg-background z-10 py-2 px-2 border-b border-border","data-test":"ui-list-search-container",children:a.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:d,value:k,onChange:O=>E(O.target.value),"data-test":"ui-list-search-input"})}),a.jsxs("div",{id:"itemList","data-test":"ui-list-items-container",className:qs("space-y-1 py-1 p-2 overflow-auto"),style:{maxHeight:n},children:[l&&u&&a.jsx("div",{className:`p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${!k&&S.size===0?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:W,"data-test":"ui-list-all-option",children:f}),te.map((O,ee)=>{const I=O,_=t.findIndex(q=>q===I),F=S.has(_);return a.jsxs("div",{ref:q=>y.current[_]=q,className:`flex justify-between items-center p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${F?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:q=>L(ee,q),"data-test":"ui-list-item",children:[a.jsx("span",{className:"flex-grow","data-test":"ui-list-item-content",children:O}),m&&a.jsx(gp,{onClick:q=>T(_,q),className:"ml-2 px-1 py-0 text-xs text-destructive-foreground rounded hover:bg-destructive/80 focus:outline-none focus:ring-1 focus:ring-destructive","aria-label":`Delete item ${_+1}`,"data-test":"ui-list-item-delete"})]},_)})]})]})]})},Ol=h.forwardRef(({className:s,onSelectionChange:e,showBuiltInPopover:t=!0,showCopyButton:n=!1,showAudioButton:r=!1,audioButtonVariant:o="default",onAudioTranscription:i,getTextAreaElement:c,keyboard:l,triggerPopover:d,fuzzyAutocomplete:p,...u},f)=>{const m=bs(),[g,x]=h.useState(""),[b,v]=h.useState(!1),[w,y]=h.useState({top:0,left:0}),[j,S]=h.useState(!1),C=h.useRef(null),N=h.useRef(null),[A,k]=h.useState(!1),[E,R]=h.useState({top:0,left:0}),[M,L]=h.useState(null),[T,W]=h.useState(""),[z,te]=h.useState(0),O=h.useRef(null),[ee,I]=h.useState(!1),[_,F]=h.useState({top:0,left:0}),[q,J]=h.useState(""),[P,B]=h.useState(0),se=h.useRef(null),le=h.useMemo(()=>{if(!(d!=null&&d.items))return[];if(!T)return d.items;const V=T.toLowerCase();return d.items.filter(D=>D.label.toLowerCase().includes(V)||D.id.toLowerCase().includes(V))},[d==null?void 0:d.items,T]);h.useEffect(()=>{te(0)},[le.length]);const me=h.useMemo(()=>{if(!(p!=null&&p.items)||!q)return[];const V=p.filterFn??((D,Y)=>D.toLowerCase().includes(Y.toLowerCase()));return p.items.filter(D=>V(D,q))},[p==null?void 0:p.items,p==null?void 0:p.filterFn,q]);h.useEffect(()=>{B(0)},[me.length]);const ae=h.useCallback(async()=>{const V=C.current;if(!(!V||!V.value))try{await navigator.clipboard.writeText(V.value),S(!0),setTimeout(()=>S(!1),2e3)}catch(D){console.error("Failed to copy text:",D)}},[]),H=h.useCallback(()=>{k(!1),L(null),W(""),te(0)},[]),X=h.useCallback(()=>{I(!1),J(""),B(0)},[]),ge=h.useCallback((V,D)=>{const Y=window.getComputedStyle(V),we=V.scrollTop,ne=parseInt(Y.paddingLeft)||12,xe=parseInt(Y.paddingTop)||8,K=parseInt(Y.lineHeight)||20,je=V.value.substring(0,D).split(`
`),Ie=je[je.length-1],Te=je.length-1,_e=document.createElement("canvas").getContext("2d");if(!_e)return{top:xe+K,left:ne};_e.font=`${Y.fontWeight} ${Y.fontSize} ${Y.fontFamily}`;const Me=_e.measureText(Ie).width,Be=(Te+1)*K-we+xe,ze=Me+ne;return{top:Be,left:ze}},[]),ce=h.useCallback(V=>{if(!d)return;const D=V.selectionStart,Y=V.value,we=d.triggerChar;if(M!==null){if(D<=M||Y[M]!==we){H();return}const ne=Y.substring(M+1,D);if(/\s/.test(ne)){H();return}W(ne);return}if(D>0&&Y[D-1]===we){const ne=D>1?Y[D-2]:null;if(ne===null||ne===" "||ne===`
`||ne==="	"){const K=ge(V,D);R(K),L(D-1),k(!0),W(""),te(0);return}}},[d,M,ge,H]),Ae=h.useCallback(V=>{if(!p)return;const D=V.selectionStart,Y=V.value,we=p.triggerAfterChars??1;if(Y.length<we){ee&&X();return}if(J(Y),Y.length>=we&&!ee){const ne=ge(V,D);F(ne),I(!0)}},[p,ee,ge,X]),Ce=h.useCallback(V=>{var we,ne;const D=C.current;if(!D)return;const Y=(we=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:we.set;Y&&(Y.call(D,V),D.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{D.setSelectionRange(V.length,V.length),D.focus()},0),(ne=p==null?void 0:p.onSelect)==null||ne.call(p,V),X()},[p,X]),ve=h.useCallback(()=>{var D;if(!(p!=null&&p.findLCS)||me.length===0)return!1;const V=p.findLCS(me,q);if(V.length>q.length){const Y=C.current;if(!Y)return!1;const we=(D=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:D.set;return we&&(we.call(Y,V),Y.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{Y.setSelectionRange(V.length,V.length),Y.focus()},0),J(V),!0}return!1},[p,me,q]),$=h.useCallback(()=>{const V=C.current;if(!V)return;const D=V.selectionStart,Y=V.selectionEnd,we=V.value.substring(D,Y).trim();if(we.length>0){x(we),v(t);const ne=V.scrollTop,xe=window.getComputedStyle(V),K=V.getBoundingClientRect(),he=parseInt(xe.paddingLeft)||12,je=parseInt(xe.paddingTop)||8,Ie=V.value.substring(0,D).split(`
`),Te=parseInt(xe.lineHeight)||20,Ne=Ie.length-1,_e=Ie[Ne],Be=document.createElement("canvas").getContext("2d");if(!Be)return;Be.font=`${xe.fontWeight} ${xe.fontSize} ${xe.fontFamily}`;const ze=parseInt(xe.paddingRight)||12,lt=K.width-he-ze;let Ke=0,nt=0,gt=0;for(;gt<_e.length;){let vt=gt+1;for(;vt<=_e.length;){const vr=_e.substring(gt,vt);if(Be.measureText(vr).width>lt){let ys=vt-1;for(let Ss=vt-1;Ss>gt;Ss--)if(_e[Ss]===" "){ys=Ss;break}ys===gt&&vt-gt>1&&(ys=vt-1),vt=ys;break}vt++}Ke=gt;const oo=Math.min(vt,_e.length);if(oo>=_e.length){const vr=_e.substring(Ke),io=Be.measureText(vr).width,ys=(Ne+nt)*Te-ne+Te+je,Ss=io+he,co={top:ys,left:Ss};y(co),e==null||e(we,co);return}nt++,gt=oo,_e[gt]===" "&&gt++}}else v(!1),x(""),e==null||e("",void 0)},[e,t]),re=h.useCallback(()=>{$()},[$]),G=h.useCallback(V=>{var D;V.shiftKey&&$(),(D=u.onKeyUp)==null||D.call(u,V)},[$,u]),oe=h.useCallback(V=>{var je,Ie;const D=C.current;if(!D||M===null)return;const Y=D.value,we=Y.substring(0,M),ne=Y.substring(M+1+T.length),xe=we+V.value+ne,K=(je=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:je.set;K&&(K.call(D,xe),D.dispatchEvent(new Event("input",{bubbles:!0})));const he=M+V.value.length;setTimeout(()=>{D.setSelectionRange(he,he),D.focus()},0),(Ie=d==null?void 0:d.onSelect)==null||Ie.call(d,V,{filterText:T,triggerPosition:M}),H()},[M,T,d,H]),de=h.useCallback(V=>{var D;if(A&&d)switch(V.key){case"Escape":V.preventDefault(),H();return;case"ArrowDown":V.preventDefault(),te(Y=>Y<le.length-1?Y+1:0);return;case"ArrowUp":V.preventDefault(),te(Y=>Y>0?Y-1:le.length-1);return;case"Enter":case"Tab":le.length>0&&(V.preventDefault(),oe(le[z]));return}if(ee&&p)switch(V.key){case"Escape":V.preventDefault(),X();return;case"ArrowDown":V.preventDefault(),B(Y=>Y<me.length-1?Y+1:0);return;case"ArrowUp":V.preventDefault(),B(Y=>Y>0?Y-1:me.length-1);return;case"Tab":V.preventDefault(),!ve()&&me.length===1&&Ce(me[0]);return;case"Enter":me.length>0&&(V.preventDefault(),Ce(me[P]));return}(D=u.onKeyDown)==null||D.call(u,V)},[A,d,H,le,z,oe,ee,p,X,me,P,ve,Ce,u]),pe=h.useCallback(V=>{var D;ce(V.target),Ae(V.target),(D=u.onChange)==null||D.call(u,V)},[ce,Ae,u]),fe=h.useCallback(V=>{var D;setTimeout(()=>{v(!1),d!=null&&d.stayOpen||H(),X()},200),(D=u.onBlur)==null||D.call(u,V)},[u,H,X,d==null?void 0:d.stayOpen]),be=h.useCallback(()=>{if(!g||g.length===0)return"";const V=g[0];return V>="A"&&V<="Z"?"text-red-600":V>="a"&&V<="z"?"text-blue-600":""},[g]),Pe=h.useCallback(V=>{i==null||i(V)},[i]),Ee=h.useCallback(()=>C.current,[]);return h.useImperativeHandle(f,()=>({insertTextAtStart:V=>{const D=C.current;if(!D)return;D.focus();const Y=D.selectionStart,we=D.selectionEnd;if(D.setSelectionRange(0,0),!document.execCommand("insertText",!1,V)){const he=V+D.value;D.value=he,D.dispatchEvent(new Event("input",{bubbles:!0}))}const xe=Y+V.length,K=we+V.length;D.setSelectionRange(xe,K)},getTextArea:()=>C.current,getSelectionPosition:()=>w,closeTriggerPopover:H,getTriggerPosition:()=>M}),[w,H,M]),a.jsxs("div",{className:"textarea-container relative w-full h-full","data-test":"selectable-textarea-container",children:[a.jsxs(st,{open:b,"data-test":"selectable-textarea-popover",children:[a.jsx(Mc,{...u,className:U("flex w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),style:{fontSize:m?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:m?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...u.style},ref:C,onChange:pe,onKeyDown:de,onMouseUp:re,onKeyUp:G,onBlur:fe,"data-node-textarea":"true","data-test":"selectable-textarea-rich-textarea"}),a.jsx(Tn,{ref:N,style:{position:"absolute",top:`${w.top}px`,left:`${w.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-popover-anchor"}),a.jsx(Xe,{side:"bottom",align:"start",className:"selection-popover w-auto max-w-md",onOpenAutoFocus:V=>V.preventDefault(),"data-test":"selectable-textarea-popover-content",children:a.jsxs("div",{className:"popover-content flex flex-col gap-2","data-test":"selectable-textarea-popover-content-wrapper",children:[a.jsx("div",{className:"popover-label text-xs text-muted-foreground font-medium","data-test":"selectable-textarea-popover-label",children:"Selected Text:"}),a.jsx("div",{className:U("popover-text text-sm font-mono bg-muted px-2 py-1 rounded font-semibold",be()),"data-test":"selectable-textarea-popover-text",children:g})]})})]}),d&&a.jsxs(st,{open:A,"data-test":"selectable-textarea-trigger-popover",children:[a.jsx(Tn,{ref:O,style:{position:"absolute",top:`${E.top}px`,left:`${E.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-trigger-popover-anchor"}),a.jsx(Xe,{side:"bottom",align:"start",className:U("trigger-popover p-1",d.widthClass??"w-48"),style:d.zIndex?{zIndex:d.zIndex}:void 0,onOpenAutoFocus:V=>V.preventDefault(),"data-test":"selectable-textarea-trigger-popover-content",children:a.jsxs("div",{"data-test":"trigger-popover-menu",children:[a.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:d.header??"Select"}),le.length>0?a.jsx(ri,{itemList:le.map(V=>a.jsxs("div",{className:"flex items-center gap-2 px-1","data-test":"trigger-item",children:[V.icon&&a.jsx("span",{className:"font-mono text-xs w-6 text-muted-foreground",children:V.icon}),a.jsx("span",{className:"text-sm",children:V.label})]},V.id)),selectedIndices:[z],onSelectionChange:V=>{V.length>0&&le[V[0]]&&oe(le[V[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"trigger-popover-list"}):a.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"trigger-popover-empty",children:d.emptyMessage??"No matches"})]})})]}),p&&a.jsxs(st,{open:ee,"data-test":"selectable-textarea-fuzzy-popover",children:[a.jsx(Tn,{ref:se,style:{position:"absolute",top:`${_.top}px`,left:`${_.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-fuzzy-popover-anchor"}),a.jsx(Xe,{side:"bottom",align:"start",className:U("fuzzy-popover p-1",p.widthClass??"w-48"),style:p.zIndex?{zIndex:p.zIndex}:void 0,onOpenAutoFocus:V=>V.preventDefault(),"data-test":"selectable-textarea-fuzzy-popover-content",children:a.jsxs("div",{"data-test":"fuzzy-popover-menu",children:[a.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:p.header??"Suggestions"}),me.length>0?a.jsx(ri,{itemList:me.map((V,D)=>a.jsx("div",{className:"flex items-center gap-2 px-1 text-sm","data-test":"fuzzy-item",children:a.jsx("span",{className:"truncate",children:V})},D)),selectedIndices:[P],onSelectionChange:V=>{V.length>0&&me[V[0]]&&Ce(me[V[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"fuzzy-popover-list"}):a.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"fuzzy-popover-empty",children:p.emptyMessage??"No matches"})]})})]}),a.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:tt.nodeAudioButton},"data-test":"selectable-textarea-action-buttons",children:[n&&a.jsx("button",{type:"button",onClick:ae,className:"p-1 rounded hover:bg-muted/80 text-muted-foreground hover:text-foreground transition-colors",title:j?"Copied!":"Copy text","data-test":"selectable-textarea-copy-button",children:j?a.jsx(ct,{className:"h-4 w-4 text-green-500"}):a.jsx(Ra,{className:"h-4 w-4"})}),r&&a.jsx(_l,{onTranscriptionComplete:Pe,sessionName:"selectable-textarea",getTextAreaElement:c||Ee,variant:o,language:l,"data-test":"selectable-textarea-audio-button"})]})]})});Ol.displayName="SelectableTextArea";class gy{constructor(){Z(this,"directoryMapCache",new Map);Z(this,"loadPromiseCache",new Map)}async loadDirectoryMap(e){var c;const t=e??"default",r=(c=ie.getState().ui)==null?void 0:c.directoryMaps;if(r!=null&&r[t])return this.directoryMapCache.set(t,r[t]),r[t];if(this.directoryMapCache.has(t))return this.directoryMapCache.get(t);if(this.loadPromiseCache.has(t))return this.loadPromiseCache.get(t);const o=e?`/directory-map?cwd=${encodeURIComponent(e)}`:"/directoryMap.json",i=fetch("http://localhost:3333"+o).then(l=>{if(!l.ok)throw new Error(`Failed to load directory map: ${l.statusText}`);return l.json()}).then(l=>{const d=l.success?l.data:l;return this.directoryMapCache.set(t,d),this.loadPromiseCache.delete(t),this.saveToGlobalStore(t,d),d}).catch(l=>{throw this.loadPromiseCache.delete(t),l});return this.loadPromiseCache.set(t,i),i}saveToGlobalStore(e,t){var o;const n=ie.getState(),r=((o=n.ui)==null?void 0:o.directoryMaps)??{};ie.updateState({ui:{...n.ui,directoryMaps:{...r,[e]:t}}})}async getFilePath(e,t){const n=await this.loadDirectoryMap(t);if(n[e])return n[e];const r=e.toLowerCase();for(const[o,i]of Object.entries(n))if(o.toLowerCase()===r)return i}async getAllFilenames(e){const t=await this.loadDirectoryMap(e);return Object.keys(t)}async searchFiles(e,t){const n=await this.loadDirectoryMap(t),r=e.toLowerCase();return Object.entries(n).filter(([o])=>o.toLowerCase().includes(r)).map(([o,i])=>({filename:o,path:i}))}clearCache(e){var t;if(e){const n=e;this.directoryMapCache.delete(n),this.loadPromiseCache.delete(n);const r=ie.getState(),i={...((t=r.ui)==null?void 0:t.directoryMaps)??{}};delete i[n],ie.updateState({ui:{...r.ui,directoryMaps:i}})}else{this.directoryMapCache.clear(),this.loadPromiseCache.clear();const n=ie.getState();ie.updateState({ui:{...n.ui,directoryMaps:{}}})}}}const ha=new gy;function Cn(s,e){const t=s.toLowerCase(),n=e.toLowerCase();if(t==="")return{score:0,matches:[]};let r=0,o=0;const i=[];let c=0,l=0;for(;r<t.length&&o<n.length;)t[r]===n[o]?(i.push(o),l++,c+=1+l,(o===0||/[\s\-_\/\\.]/.test(e[o-1]))&&(c+=10),r++):l=0,o++;if(r!==t.length)return null;if(i.length>0){const d=i[i.length-1]-i[0]-i.length+1;c-=d}return c+=100/(e.length+1),{score:c,matches:i}}function xy(s,e){if(e.length===0)return[{text:s,isMatch:!1}];const t=[];let n=0;for(const r of e)r>n&&t.push({text:s.substring(n,r),isMatch:!1}),t.push({text:s[r],isMatch:!0}),n=r+1;return n<s.length&&t.push({text:s.substring(n),isMatch:!1}),t}const nn=h.forwardRef(({className:s,viewportClassName:e,children:t,...n},r)=>a.jsxs(qi,{ref:r,className:U("relative overflow-hidden",s),...n,children:[a.jsx(Bu,{className:U("h-full w-full rounded-[inherit]",e),children:t}),a.jsx(Ll,{}),a.jsx(Wu,{})]}));nn.displayName=qi.displayName;const Ll=h.forwardRef(({className:s,orientation:e="vertical",...t},n)=>a.jsx(Vi,{ref:n,orientation:e,className:U("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...t,children:a.jsx(zu,{className:"relative flex-1 rounded-full bg-border"})}));Ll.displayName=Vi.displayName;function vy({items:s,selectedIndex:e,renderItem:t,onItemClick:n,onItemHover:r,className:o,height:i="h-[400px]",emptyMessage:c="No items found",isLoading:l=!1,loadingMessage:d="Loading...",getItemKey:p}){const u=h.useRef(null);return h.useEffect(()=>{u.current&&u.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[e]),a.jsx(nn,{className:U("scrollable-list rounded-md border",i,o),"data-test":"scrollable-list-container",children:l?a.jsx("div",{className:"loading-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-loading-state",children:a.jsx("span",{"data-test":"scrollable-list-loading-message",children:d})}):s.length===0?a.jsx("div",{className:"empty-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-empty-state",children:a.jsx("span",{"data-test":"scrollable-list-empty-message",children:c})}):a.jsx("div",{className:"list-items","data-test":"scrollable-list-items",children:s.map((f,m)=>{const g=m===e,x=p?p(f,m):m;return t(f,m,g,x,g?u:void 0,()=>n==null?void 0:n(f,m),()=>r==null?void 0:r(m))})})})}const fa=h.forwardRef(({onFileSelect:s,className:e,maxResults:t=10,placeholder:n="Search files...",mode:r="normal",searchMode:o="filename",cwd:i,externalSearchQuery:c,hideSearchInput:l=!1,onTabComplete:d,onLoadComplete:p},u)=>{const[f,m]=h.useState([]),[g,x]=h.useState([]),[b,v]=h.useState(t),[w,y]=h.useState(""),[j,S]=h.useState(!0),[C,N]=h.useState(0),[A,k]=h.useState(o),E=c??w;h.useEffect(()=>{(async()=>{try{S(!0);const B=await ha.getAllFilenames(i),se=[];for(const le of B){const me=await ha.getFilePath(le,i);me&&se.push({filename:le,path:me})}m(se),x(se),v(t)}catch(B){console.error("Failed to load files:",B)}finally{S(!1),p==null||p()}})()},[t,i,p]),h.useEffect(()=>{E.startsWith("/")?A!=="fullPath"&&k("fullPath"):A!=="filename"&&k("filename");const P=E.startsWith("/")?E.slice(1):E;if(!P.trim()){x(f),v(t),N(0);return}let B=f;if(A==="fullPath"){const me=new Set,ae=[];for(const H of f){ae.push(H),me.add(H.path);const X=H.path.split("/").filter(Boolean);for(let ge=1;ge<X.length;ge++){const ce=X.slice(0,ge).join("/")+"/";me.has(ce)||(me.add(ce),ae.push({filename:X[ge-1],path:ce,isDirectory:!0}))}}B=ae}const se=[];for(const me of B)if(A==="fullPath"){const ae=Cn(P,me.path);ae&&se.push({file:me,score:ae.score,matches:ae.matches})}else{const ae=Cn(P,me.filename),H=Cn(P,me.path),X=ae&&H?ae.score>H.score?ae:H:ae??H;X&&se.push({file:me,score:X.score,matches:X.matches})}se.sort((me,ae)=>ae.score-me.score);const le=se.map(me=>me.file);x(le),v(t),N(0)},[E,f,t,A]);const R=h.useCallback(P=>{s==null||s(P)},[s]),M=h.useCallback(P=>{N(P==="down"?B=>{const se=Math.min(B+1,g.length-1);return se>=b-2&&b<g.length&&v(le=>Math.min(le+t,g.length)),se}:B=>Math.max(B-1,0))},[g.length,b,t]),L=h.useCallback(()=>{g[C]&&R(g[C])},[g,C,R]),T=h.useCallback(()=>{if(!g[C]||!E.startsWith("/"))return null;const P=g[C].path,B=E.slice(1),se=P.indexOf("/",B.length);let le;return se!==-1?le="/"+P.substring(0,se+1):le="/"+P,c===void 0&&y(le),d==null||d(le),le},[g,C,E,c,d]),W=h.useCallback(()=>g[C]??null,[g,C]);h.useImperativeHandle(u,()=>({navigate:M,selectCurrent:L,tabComplete:T,getSelectedFile:W}),[M,L,T,W]);const z=h.useCallback(P=>{switch(P.key){case"Tab":P.preventDefault(),T();break;case"ArrowDown":P.preventDefault(),M("down");break;case"ArrowUp":P.preventDefault(),M("up");break;case"Enter":P.preventDefault(),L();break;case"Escape":P.preventDefault(),y("");break}},[M,L,T]),te=(P,B)=>{if(!B.trim())return a.jsx("span",{children:P});const se=Cn(B,P);if(!se)return a.jsx("span",{children:P});const le=xy(P,se.matches);return a.jsx("span",{children:le.map((me,ae)=>a.jsx("span",{className:me.isMatch?"bg-yellow-200 dark:bg-yellow-900 font-semibold":"",children:me.text},ae))})},O=P=>{var le;const B=(le=P.split(".").pop())==null?void 0:le.toLowerCase(),se="w-4 h-4 flex-shrink-0";return["tsx","ts","jsx","js"].includes(B??"")?a.jsx(Fs,{className:U(se,"text-blue-500")}):["json","yml","yaml"].includes(B??"")?a.jsx(Fs,{className:U(se,"text-yellow-500")}):["md","txt"].includes(B??"")?a.jsx(Fs,{className:U(se,"text-gray-500")}):["css","scss"].includes(B??"")?a.jsx(Fs,{className:U(se,"text-purple-500")}):a.jsx(Fs,{className:U(se,"text-muted-foreground")})},ee=P=>P.split("/").slice(0,-1).join("/")||"/",I=r==="compact"||r==="fileNameOnly",_=r==="fileNameOnly",F=E.startsWith("/")?E.slice(1):E,q=g.slice(0,b),J=(P,B,se,le,me,ae,H)=>a.jsxs("button",{ref:me,onClick:ae,onMouseEnter:H,"data-test":"file-picker-item",className:U("file-item w-full flex items-start hover:bg-accent text-left transition-colors border-b border-border last:border-b-0",I?"px-2 py-1 gap-2":"px-3 py-2 gap-3",se&&"bg-accent"),children:[!_&&(P.isDirectory?a.jsx(xp,{className:U("w-4 h-4 flex-shrink-0","text-blue-400"),"data-test":"file-picker-item-folder-icon"}):O(P.filename)),a.jsx("div",{className:"file-info flex-1 min-w-0","data-test":"file-picker-item-info",children:A==="fullPath"?a.jsx("div",{className:U("filename font-medium truncate",I?"text-xs":"text-sm"),"data-test":"file-picker-item-path",children:te(P.path,F)}):a.jsxs("div",{className:U("filename truncate flex items-baseline gap-2",I?"text-xs":"text-sm"),"data-test":"file-picker-item-filename",children:[a.jsx("span",{className:"font-medium flex-shrink-0","data-test":"file-picker-item-name",children:te(P.filename,F)}),a.jsx("span",{className:U("text-muted-foreground overflow-hidden text-ellipsis whitespace-nowrap",I?"text-[10px]":"text-xs"),style:{direction:"rtl",textAlign:"left"},"data-test":"file-picker-item-directory",children:ee(P.path)})]})})]},le);return a.jsxs("div",{className:U("file-picker flex flex-col",I?"gap-1.5":"gap-3",e),"data-test":"file-picker-container",children:[!l&&a.jsxs("div",{className:"search-input-wrapper relative","data-test":"file-picker-search-wrapper",children:[a.jsx(or,{className:U("absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none",I?"w-3 h-3":"w-4 h-4"),"data-test":"file-picker-search-icon"}),a.jsx(We,{type:"text",value:E,onChange:P=>y(P.target.value),onKeyDown:z,placeholder:n,className:U("search-input pl-9",I&&"h-8 text-xs"),autoFocus:!c,"data-test":"file-picker-search-input"})]}),!_&&a.jsx("div",{className:U("results-info text-xs text-muted-foreground",I?"px-0.5":"px-1"),"data-test":"file-picker-results-info",children:j?a.jsx("span",{"data-test":"file-picker-loading-text",children:"Loading files..."}):a.jsxs("span",{"data-test":"file-picker-results-text",children:["Showing ",q.length," of ",g.length," results",g.length<f.length&&` (filtered from ${f.length} total)`]})}),a.jsx(vy,{items:q,selectedIndex:C,renderItem:J,onItemClick:P=>R(P),onItemHover:P=>N(P),getItemKey:P=>P.path,height:"max-h-fit",className:"file-list",emptyMessage:"No files found",isLoading:j,loadingMessage:"Loading files...","data-test":"file-picker-file-list"}),!_&&!l&&a.jsxs("div",{className:U("keyboard-hints text-muted-foreground flex",I?"text-[10px] px-0.5 gap-2":"text-xs px-1 gap-4"),"data-test":"file-picker-keyboard-hints",children:[a.jsxs("span",{"data-test":"file-picker-hint-navigate",children:[a.jsx("kbd",{className:U("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"â†‘â†“"})," Navigate"]}),a.jsxs("span",{"data-test":"file-picker-hint-autocomplete",children:[a.jsx("kbd",{className:U("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Tab"})," Autocomplete"]}),a.jsxs("span",{"data-test":"file-picker-hint-select",children:[a.jsx("kbd",{className:U("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Enter"})," Select"]}),a.jsxs("span",{"data-test":"file-picker-hint-clear",children:[a.jsx("kbd",{className:U("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Esc"})," Clear"]})]})]})});fa.displayName="FilePicker";const Dn="â€‹";function Qn(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Qt(s){const e=[];let t=0,n=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(r,o,i)=>{const c=`LINKPLACEHOLDER${t}END`,l=Qn(o),d=`<a href="${i}" class="text-primary underline hover:text-primary/80 cursor-pointer" target="_blank" rel="noopener noreferrer">${l}</a>`;return e.push({placeholder:c,html:d}),t++,c});n=Qn(n).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(new RegExp("(?<!\\w)__(.+?)__(?!\\w)","g"),"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(new RegExp("(?<!\\w)_(.+?)_(?!\\w)","g"),"<em>$1</em>").replace(/~~(.+?)~~/g,"<del>$1</del>").replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm font-mono">$1</code>');for(const{placeholder:r,html:o}of e)n=n.replace(r,o);return n}function Ar(s){function e(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent||"";if(t.nodeType===Node.ELEMENT_NODE){const n=t,r=n.tagName.toLowerCase(),o=Array.from(t.childNodes).map(e).join("");switch(r){case"strong":case"b":return`**${o}**`;case"em":case"i":return`*${o}*`;case"del":case"s":return`~~${o}~~`;case"code":return`\`${o}\``;case"a":{const i=n.getAttribute("href")||"";return`[${o}](${i})`}default:return o}}return""}return Array.from(s.childNodes).map(e).join("").trim()}function ma(s){const e=s.trim(),t=e.startsWith("|")?e.slice(1):e;return(t.endsWith("|")?t.slice(0,-1):t).split("|").map(r=>r.trim())}function Ml(s){return ma(s).every(t=>/^:?-+:?$/.test(t))}function ai(s){if(s.length<2)return s.map(Qn).join("<br>");const e=s.findIndex(o=>Ml(o));if(e===-1||e===0)return s.map(Qn).join("<br>");const t=s.slice(0,e),n=s.slice(e+1);let r='<table class="markdown-table border-collapse w-full my-2" data-test="markdown-table">';if(t.length>0){r+="<thead>";for(const o of t){const i=ma(o);r+="<tr>";for(const c of i)r+=`<th class="border border-border px-2 py-1 h-6 bg-muted font-medium text-left">${Qt(c)}</th>`;r+="</tr>"}r+="</thead>"}if(n.length>0){r+="<tbody>";for(const o of n){if(!o.trim())continue;const i=ma(o);r+="<tr>";for(const c of i)r+=`<td class="border border-border px-2 py-1 h-6">${Qt(c)}</td>`;r+="</tr>"}r+="</tbody>"}return r+="</table>",r}function by(s){const e=s.split(`
`),t=[];let n=[],r=!1;for(let i=0;i<e.length;i++){const c=e[i];if(c.trim().startsWith("|")||c.includes("|")&&Ml(c))r||(r=!0),n.push(c);else{if(r){const d=ai(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(d),n=[],r=!1}t.push(c)}}if(r&&n.length>0){const i=ai(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(i)}const o=[];for(let i=0;i<t.length;i++)t[i].startsWith("__TABLE_PLACEHOLDER_")?i+1<t.length&&(o.push(t[i+1]),i++):o.push(t[i]);return o.join(`
`)}function wy(s){const e=[];let t=!1;const n=s.querySelector("thead");if(n){t=!0;const c=n.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("th, td")).map(p=>Ar(p));e.push(d)}}const r=s.querySelector("tbody");if(r){const c=r.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>Ar(p));e.push(d)}}if(!n&&!r){const c=s.querySelectorAll(":scope > tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>Ar(p));e.push(d)}}if(e.length===0)return"";const o=[],i=Math.max(...e.map(c=>c.length));for(let c=0;c<e.length;c++){const l=e[c];for(;l.length<i;)l.push("");o.push("| "+l.join(" | ")+" |"),t&&c===0&&o.push("| "+l.map(()=>"---").join(" | ")+" |")}if(!t&&e.length>0){const c=e[0];o.splice(1,0,"| "+c.map(()=>"---").join(" | ")+" |")}return o.join(`
`)+`
`}function it(s){if(!s)return"";const e=by(s),t=[],r=e.replace(/<table[\s\S]*?<\/table>/g,c=>(t.push(c),`MARKDOWNTABLEPLACEHOLDER${t.length-1}ENDPLACEHOLDER`)).split(`
`),o=[];for(let c=0;c<r.length;c++){const l=r[c],d=/^# (.+)$/.test(l),p=/^## (.+)$/.test(l),u=/^### (.+)$/.test(l),f=/^- (.+)$/.test(l),m=/^(\d+)\. (.+)$/.test(l),g=/^> (.+)$/.test(l),x=/^---$/.test(l),b=/^MARKDOWNTABLEPLACEHOLDER\d+ENDPLACEHOLDER$/.test(l),v=l==="";let w;if(u){const y=l.replace(/^### (.+)$/,"$1");w=`<h3>${Qt(y)}</h3>`}else if(p){const y=l.replace(/^## (.+)$/,"$1");w=`<h2>${Qt(y)}</h2>`}else if(d){const y=l.replace(/^# (.+)$/,"$1");w=`<h1>${Qt(y)}</h1>`}else if(g){const y=l.replace(/^> (.+)$/,"$1");w=`<blockquote class="border-l-2 border-muted-foreground/30 pl-3 m-0 text-muted-foreground italic">${Qt(y)}</blockquote>`}else if(x)w='<hr class="border-t border-muted-foreground/30 m-0">';else if(f){const y=l.replace(/^- (.+)$/,"$1"),j=c>0?r[c-1]:"";w=`<div class="${!(/^- /.test(j)||/^\d+\. /.test(j))&&c>0?"mt-[1lh] ":""}list-item-ul flex"><span class="mr-1.5">â€¢</span><span>${Qt(y)}</span></div>`}else if(m){const y=l.match(/^(\d+)\. (.+)$/),j=y[1],S=y[2],C=c>0?r[c-1]:"";w=`<div class="${!(/^- /.test(C)||/^\d+\. /.test(C))&&c>0?"mt-[1lh] ":""}list-item-ol flex"><span class="mr-1.5">${j}.</span><span>${Qt(S)}</span></div>`}else b?w=l:v?w='<div class="empty-line"><br></div>':w=`<div class="paragraph">${Qt(l)}</div>`;o.push(w)}let i=o.join("");for(let c=0;c<t.length;c++)i=i.replace(`MARKDOWNTABLEPLACEHOLDER${c}ENDPLACEHOLDER`,t[c]);return i}function ms(s){if(!s)return"";const e=document.createElement("div");e.innerHTML=s.replace(new RegExp(Dn,"g"),"");function t(c,l=!1){if(c.nodeType===Node.TEXT_NODE)return c.textContent||"";if(c.nodeType===Node.ELEMENT_NODE){const d=c,p=d.tagName.toLowerCase(),u=Array.from(c.childNodes).map(f=>t(f,!1)).join("");switch(p){case"strong":case"b":return`**${u}**`;case"em":case"i":return`*${u}*`;case"del":case"s":return`~~${u}~~`;case"code":return`\`${u}\``;case"a":{const f=d.getAttribute("href")||"";return`[${u}](${f})`}case"br":return`
`;case"blockquote":return`> ${u}
`;case"h1":return`# ${u}
`;case"h2":return`## ${u}
`;case"h3":return`### ${u}
`;case"table":return wy(d);case"div":case"p":if(d.classList.contains("list-item-ul")){const f=d.querySelector("span:last-child");return`- ${f?f.textContent||"":u}
`}if(d.classList.contains("list-item-ol")){const f=d.querySelector("span:first-child"),m=d.querySelector("span:last-child"),g=f?(f.textContent||"1.").replace(".",""):"1",x=m?m.textContent||"":u;return`${g}. ${x}
`}if(d.classList.contains("paragraph"))return u+`
`;if(d.classList.contains("empty-line")){const f=d.textContent||"";return f.trim()?f+`
`:`
`}return l?u:u?u+`
`:"";case"span":return d.classList.contains("text-2xl")?`# ${u}`:d.classList.contains("text-xl")?`## ${u}`:d.classList.contains("text-lg")?`### ${u}`:u;default:return u}}return""}const n=t(e,!0);let r=0;const o=Array.from(e.children);for(let c=o.length-1;c>=0;c--){const l=o[c];if(l.classList.contains("empty-line"))if(!(l.textContent||"").trim())r++;else break;else break}return r>0?n.replace(/\n+$/,"")+`
`.repeat(r):n.replace(/\n+$/,"")}const ft={a:["a","Ã¡","Ã ","áº£","Ã£","áº¡","Äƒ","áº¯","áº±","áº³","áºµ","áº·","Ã¢","áº¥","áº§","áº©","áº«","áº­"],A:["A","Ã","Ã€","áº¢","Ãƒ","áº ","Ä‚","áº®","áº°","áº²","áº´","áº¶","Ã‚","áº¤","áº¦","áº¨","áºª","áº¬"],e:["e","Ã©","Ã¨","áº»","áº½","áº¹","Ãª","áº¿","á»","á»ƒ","á»…","á»‡"],E:["E","Ã‰","Ãˆ","áºº","áº¼","áº¸","ÃŠ","áº¾","á»€","á»‚","á»„","á»†"],i:["i","Ã­","Ã¬","á»‰","Ä©","á»‹"],I:["I","Ã","ÃŒ","á»ˆ","Ä¨","á»Š"],o:["o","Ã³","Ã²","á»","Ãµ","á»","Ã´","á»‘","á»“","á»•","á»—","á»™","Æ¡","á»›","á»","á»Ÿ","á»¡","á»£"],O:["O","Ã“","Ã’","á»Ž","Ã•","á»Œ","Ã”","á»","á»’","á»”","á»–","á»˜","Æ ","á»š","á»œ","á»ž","á» ","á»¢"],u:["u","Ãº","Ã¹","á»§","Å©","á»¥","Æ°","á»©","á»«","á»­","á»¯","á»±"],U:["U","Ãš","Ã™","á»¦","Å¨","á»¤","Æ¯","á»¨","á»ª","á»¬","á»®","á»°"],y:["y","Ã½","á»³","á»·","á»¹","á»µ"],Y:["Y","Ã","á»²","á»¶","á»¸","á»´"],d:["d","Ä‘"],D:["D","Ä"]},yy={s:"acute",f:"grave",r:"hook",x:"tilde",j:"dot"},Sy={w:"horn",aa:"circumflex",aw:"breve",ee:"circumflex",oo:"circumflex",ow:"horn",uw:"horn",dd:"stroke"},ks={a:null,e:null,i:null,o:null,u:null,y:null,d:null,Äƒ:null,Ã¢:null,Ãª:null,Ã´:null,Æ¡:null,Æ°:null,Ä‘:null,Ã¡:"s",áº¯:"s",áº¥:"s",Ã©:"s",áº¿:"s",Ã­:"s",Ã³:"s",á»‘:"s",á»›:"s",Ãº:"s",á»©:"s",Ã½:"s",Ã :"f",áº±:"f",áº§:"f",Ã¨:"f",á»:"f",Ã¬:"f",Ã²:"f",á»“:"f",á»:"f",Ã¹:"f",á»«:"f",á»³:"f",áº£:"r",áº³:"r",áº©:"r",áº»:"r",á»ƒ:"r",á»‰:"r",á»:"r",á»•:"r",á»Ÿ:"r",á»§:"r",á»­:"r",á»·:"r",Ã£:"x",áºµ:"x",áº«:"x",áº½:"x",á»…:"x",Ä©:"x",Ãµ:"x",á»—:"x",á»¡:"x",Å©:"x",á»¯:"x",á»¹:"x",áº¡:"j",áº·:"j",áº­:"j",áº¹:"j",á»‡:"j",á»‹:"j",á»:"j",á»™:"j",á»£:"j",á»¥:"j",á»±:"j",á»µ:"j"};Object.keys(ks).forEach(s=>{const e=s.toUpperCase(),t=ks[s];e!==s&&(ks[e]=t)});function ds(s,e){const t=s.toLowerCase();switch(e){case"breve":return["Äƒ","áº¯","áº±","áº³","áºµ","áº·"].includes(t);case"circumflex":return["Ã¢","áº¥","áº§","áº©","áº«","áº­","Ãª","áº¿","á»","á»ƒ","á»…","á»‡","Ã´","á»‘","á»“","á»•","á»—","á»™"].includes(t);case"horn":return["Æ¡","á»›","á»","á»Ÿ","á»¡","á»£","Æ°","á»©","á»«","á»­","á»¯","á»±"].includes(t);case"stroke":return["Ä‘"].includes(t);default:return!1}}function Es(s){return s in yy}function Zn(s){return s==="w"||s==="a"||s==="e"||s==="o"||s==="u"||s==="d"}function es(s){const e=s.toLowerCase();if(ft[e]!==void 0&&e!=="d")return e;for(const t of["a","e","i","o","u","y"])if(ft[t].includes(e))return t;return null}function jy(s,e,t){const n=s.substring(e,t).toLowerCase(),r=[];for(let o=0;o<n.length;o++){const i=n[o],c=es(i);c!==null&&r.push({char:i,pos:e+o,base:c})}if(r.length===0)return-1;if(r.length===1)return r[0].pos;if(r.length===2){const o=r[0].base,i=r[1].base,c=r[1].char;return o==="o"&&["a","e"].includes(i)||o==="u"&&i==="y"||["Ãª","Ã´","Æ¡"].includes(c)?r[1].pos:r[0].pos}return r.length>=3?r[1].pos:r[r.length-1].pos}function hs(s){return s?/[\s.,;:!?()[\]{}'"<>\/\\-]/.test(s):!0}function ga(s,e){return s==="a"&&e.includes("a")&&e.includes("w")||s==="a"&&e.includes("w")&&!e.includes("a")?"aw":s==="o"&&e.includes("w")?"ow":s==="u"&&e.includes("w")?"uw":s==="a"&&e.includes("a")?"aa":s==="e"&&e.includes("e")?"ee":s==="o"&&e.includes("o")?"oo":s==="d"&&e.includes("d")?"dd":e.includes("w")?"w":null}function Cy(s){const e=Sy[s];return e==="breve"?"breve":e.includes("circumflex")?"circumflex":e.includes("horn")?"horn":e==="stroke"?"stroke":null}function Cs(s,e){const t=ft[s]||[];if(!e||e===s)return t;const n=e.slice(s.length).toLowerCase();let r=null;n.includes("s")?r="s":n.includes("j")?r="j":n.includes("r")?r="r":n.includes("x")?r="x":n.includes("f")&&(r="f");const o=ga(s,n),i=o?Cy(o):null;return t.filter(c=>!(r!==null&&ks[c]!==r||i&&!ds(c,i)))}function Ny(s){const e=s.toLowerCase();if(ft[e]!==void 0)return!1;for(const t in ft)if(ft[t].includes(e))return!0;return!1}function oi(s){const e=s.toLowerCase();for(const t in ft)if(ft[t].includes(e))return t;return s}function ky(s,e){let t=-1,n="";const r=s.charAt(e-1).toLowerCase();if(Es(r)){let o=0;for(let i=e-2;i>=0;i--)if(hs(s.charAt(i))){o=i+1;break}for(let i=o;i<e-1;i++){const c=s.charAt(i),l=es(c);if(l)return{sequenceStart:o,detectedBaseChar:l,found:!0}}}if(Zn(r)){if(r==="w")for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(hs(i))break;if(i==="o"&&o>0&&s.charAt(o-1).toLowerCase()==="u")return{sequenceStart:o-1,detectedBaseChar:"u",found:!0}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(hs(i))break;const c=es(i);if((i===r||c===r)&&ft[r])return{sequenceStart:o,detectedBaseChar:r,found:!0}}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase(),c=es(i);if(ft[i]||c){if(c!==null&&c!==i&&!(Es(r)||r===c||r==="w"))return{sequenceStart:-1,detectedBaseChar:"",found:!1};if(t=o,n=c||i,o>0){const p=s.charAt(o-1).toLowerCase(),u=es(p);(p===n||u===n)&&ft[n]&&(t=o-1)}const d=s.slice(t+1,e-1).toLowerCase();for(const p of d)if(!Es(p)&&!Zn(p)&&p!==n)return{sequenceStart:-1,detectedBaseChar:"",found:!1};break}}return{sequenceStart:t,detectedBaseChar:n,found:t>=0}}function Ey(s){const e=s.slice(0,-1);return/\s/.test(e)}function Iy(s,e,t,n,r){const o=s.slice(t,e).toLowerCase(),i=s.charAt(e-1).toLowerCase();if(e>=2&&s.charAt(e-2),Es(i)){let d=0;for(let u=e-2;u>=0;u--)if(hs(s.charAt(u))){d=u+1;break}s.substring(d,e-1);const p=jy(s,d,e-1);if(p>=0){const u=s.charAt(p),f=u.toLowerCase(),m=oi(f);if(ft[m]){let g="";ds(f,"breve")?g="w":ds(f,"circumflex")?g=m:ds(f,"horn")&&(g="w");const x=m+g+i,b=Cs(m,x);if(b.length>0){const v=b[0],w=u===u.toUpperCase()?v.toUpperCase():v,y=s.substring(0,p),j=s.substring(p+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:y+w+j+S,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let u=e-2;u>=Math.max(0,e-6);u--){const f=s.charAt(u);if(hs(f))break;if(Ny(f)){const m=oi(f);let g="";const x=f.toLowerCase();ds(x,"breve")?g="w":ds(x,"circumflex")?g=m:ds(x,"horn")&&(g="w");const b=m+g+i,v=Cs(m,b);if(v.length>0){const w=v[0],y=s.substring(0,u),j=s.substring(u+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:y+w+j+S,newCursorPos:e-1,realTimeReplacement:!0}}}if(ft[f.toLowerCase()])break}}if(Zn(i)){if(i==="w"){if(s.substring(0,e),n==="u"){const g=s.substring(t,e).toLowerCase();if(g.startsWith("uo")){const x=g.substring(2,g.length-1),b=s.substring(0,t),v=s.substring(e);return{type:"auto-complete",replacement:b+"Æ°Æ¡"+x+v,newCursorPos:t+2+x.length,realTimeReplacement:!0}}}const d=o.toLowerCase();if(d==="uow"||d.endsWith("uow")){const g=s.substring(0,t),x=s.substring(e);return{type:"auto-complete",replacement:g+"Æ°Æ¡"+x,newCursorPos:t+2,realTimeReplacement:!0}}let p=0;for(let g=e-2;g>=0;g--)if(hs(s.charAt(g))){p=g+1;break}const u=s.substring(p,e-1);let f=-1,m="";for(let g=u.length-1;g>=0;g--){const x=u[g];if(es(x.toLowerCase())==="a"){f=p+g,m="a";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(es(x.toLowerCase())==="o"){f=p+g,m="o";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(es(x.toLowerCase())==="u"){f=p+g,m="u";break}}if(f>=0){const g=s.charAt(f),x=g.toLowerCase(),b=ks[x];let v=m;v+="w",b&&(v+=b);const w=Cs(m,v);if(w.length>0){const y=w[0],j=g===g.toUpperCase()?y.toUpperCase():y,S=s.substring(0,f),C=s.substring(f+1,e-1),N=s.substring(e);return{type:"auto-complete",replacement:S+j+C+N,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let d=e-2;d>=Math.max(0,e-6);d--){const p=s.charAt(d).toLowerCase();if(hs(p))break;const u=es(p);if((p===i||u===i)&&ft[i]){const f=i+i;if(ga(i,f)){const g=ks[p],x=g?f+g:f,b=Cs(i,x);if(b.length>0){const v=b[0],w=s.substring(0,d),y=s.substring(d+1,e-1),j=s.substring(e);return{type:"auto-complete",replacement:w+v+y+j,newCursorPos:e-1,realTimeReplacement:!0}}}break}}}if(Ey(o))return{type:"terminate"};const c=Es(i)||Zn(i);let l=!1;if(c)if(Es(i))l=!0;else{const d=o.slice(n.length).toLowerCase();ga(n,d)===null?(e>=2&&s.charAt(e-2).toLowerCase(),t<e-1&&s.charAt(t).toLowerCase()===i&&(l=!0)):l=!0}if(l){const d=Cs(n,o);if(d.length>0){const p=d[0],u=s.substring(0,t),f=s.substring(e);return{type:"auto-complete",replacement:u+p+f,newCursorPos:t+1,realTimeReplacement:!0}}return{type:"terminate"}}else return Ty(s,e,t,n,o)}function Ty(s,e,t,n,r){const i=(t>0?s.charAt(t-1).toLowerCase():"")+r;if(i==="uown"||i==="uow"){const l=s.substring(0,t-1),d=s.substring(e),p=s.charAt(e-1);return{type:"auto-complete",replacement:l+"Æ°Æ¡"+p+d,newCursorPos:t-1+2+1}}const c=Cs(n,r.slice(0,-1));if(c.length>0){const l=c[0],d=s.substring(0,t),p=s.substring(e),u=s.charAt(e-1);return{type:"auto-complete",replacement:d+l+u+p,newCursorPos:t+1+1}}return{type:"terminate"}}function IC(s){return s!==""&&ft[s]!==void 0}function TC(s,e,t,n){const r=t-1;switch(e){case"right":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===c?i:s+1}case"left":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===i?c:s-1}case"down":{const o=s%n,i=Math.floor(s/n),c=Math.ceil((r+1)/n),l=i+1;if(l>=c){const d=o;return d<=r?d:s}else{const d=l*n+o;return d<=r?d:s}}case"up":{const o=s%n,i=Math.floor(s/n);if(i===0){const d=(Math.ceil((r+1)/n)-1)*n+o;return d<=r?d:s}else return(i-1)*n+o}default:return s}}function ii(s){let e=s.replace(/<strong>([^<]*)<\/strong>/g,"**$1**");return e=e.replace(/<em>([^<]*)<\/em>/g,"*$1*"),e=e.replace(/<code>([^<]*)<\/code>/g,"`$1`"),e=e.replace(/<[^>]+>/g,""),e}function Fl(s){const e=[],t=[],n=/<th[^>]*>([\s\S]*?)<\/th>/g;let r;for(;(r=n.exec(s))!==null;)e.push(ii(r[1]));const o=s.match(/<tbody>([\s\S]*?)<\/tbody>/);if(o){const i=/<tr>([\s\S]*?)<\/tr>/g;let c;for(;(c=i.exec(o[1]))!==null;){const l=/<td[^>]*>([\s\S]*?)<\/td>/g,d=[];let p;for(;(p=l.exec(c[1]))!==null;)d.push(ii(p[1]));d.length>0&&t.push(d)}}return{headerCells:e,bodyCells:t}}function $l(s){const{headerCells:e,bodyCells:t}=Fl(s);let n=0,r=0;if(e.length>0){const o=e.reduce((i,c)=>i+c.length,0);n+=2+o+(e.length-1)*3+2+1,r++,n+=2+e.length*1+(e.length-1)*3+2+1,r++}for(const o of t){const i=o.reduce((c,l)=>c+l.length,0);n+=2+i+(o.length-1)*3+2+1,r++}return{markdownLength:n,lineCount:r}}function Ul(s){const{headerCells:e,bodyCells:t}=Fl(s),n=[];let r=0,o=0;if(e.length>0){r+=2;for(let i=0;i<e.length;i++){const c=e[i],l=c.trim().length>0;n.push({markdownStart:r,content:c,textNodeIndex:l?o:-1,isEmpty:!l,rowIndex:0,colIndex:i}),l&&o++,r+=c.length,i<e.length-1&&(r+=3)}r+=3,r+=2;for(let i=0;i<e.length;i++)r+=1,i<e.length-1&&(r+=3);r+=3}for(let i=0;i<t.length;i++){const c=t[i];r+=2;for(let l=0;l<c.length;l++){const d=c[l],p=d.trim().length>0;n.push({markdownStart:r,content:d,textNodeIndex:p?o:-1,isEmpty:!p,rowIndex:i+1,colIndex:l}),p&&o++,r+=d.length,l<c.length-1&&(r+=3)}r+=2,i<t.length-1&&(r+=1)}return{cells:n,totalLength:r}}function xa(s){var X,ge,ce,Ae,Ce;const e=window.getSelection();if(!e||e.rangeCount===0)return{text:ms(s.innerHTML),cursorPos:0};const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");r.appendChild(n.cloneContents());const o=Array.from(r.children).filter(ve=>{const $=ve.tagName.toLowerCase();return $==="h1"||$==="h2"||$==="h3"||$==="div"||$==="blockquote"||$==="hr"||$==="table"}),i=r.querySelectorAll(".empty-line"),c=Array.from(i).filter(ve=>{var re;return(((re=ve.textContent)==null?void 0:re.trim())||"").length===0});let l=0;const d=t.startContainer;if(d.nodeType===Node.ELEMENT_NODE)(X=d.classList)!=null&&X.contains("empty-line")&&(l=1);else if(d.nodeType===Node.TEXT_NODE){const ve=d.parentElement;(ge=ve==null?void 0:ve.classList)!=null&&ge.contains("empty-line")&&(l=1)}const p=o.filter(ve=>!ve.classList.contains("empty-line")),u=c.length,f=(p.length>0?p.length-1:0)+u+l;let m=0;r.querySelectorAll("h1").forEach(()=>{m+=2}),r.querySelectorAll("h2").forEach(()=>{m+=3}),r.querySelectorAll("h3").forEach(()=>{m+=4}),r.querySelectorAll("blockquote").forEach(()=>{m+=2}),r.querySelectorAll("hr").forEach(()=>{m+=3});const g=r.querySelectorAll("h1, h2, h3, blockquote, hr"),x=s.querySelectorAll("h1, h2, h3, blockquote, hr");let b=!1;const v=t.startContainer;for(const ve of x)if(ve.contains(v)){b=!0;break}const w=s.querySelectorAll(".list-item-ul, .list-item-ol");for(const ve of w)if(ve.contains(v))break;const y=s.querySelectorAll("table");let j=null,S=null;for(const ve of y)if(ve.contains(v)){j=ve;const $=ve.querySelectorAll("th, td");for(const re of $)if(re.contains(v)||re===v){S=re;break}break}const C=0;let N=0;x.forEach(ve=>{var re;const $=ve.nextSibling||ve.nextElementSibling;if($){const G=$.nodeName==="BR"||$.nodeType===Node.ELEMENT_NODE&&$.tagName==="BR",oe=$.nodeType===Node.ELEMENT_NODE&&((re=$.classList)==null?void 0:re.contains("empty-line")),de=$.nodeType===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes($.tagName);!G&&!oe&&!de&&(N+=1)}});let A=g.length;b&&A>0&&(A-=1);const k=Math.min(N,A);m+=k;const E=r.querySelectorAll(":scope > div:not(.list-item-ul):not(.list-item-ol):not(.empty-line):not(.paragraph)");r.querySelectorAll("h1, h2, h3, blockquote, hr, .list-item-ul, .list-item-ol, .paragraph").length===0&&E.length>1&&(m+=E.length-1);const M=r.querySelectorAll(".list-item-ul");M.forEach(()=>{m+=1});const L=r.querySelectorAll(".list-item-ol");L.forEach(()=>{m+=1});const T=M.length+L.length;if(T>1&&(m+=T-1),T>0){let $=(L.length>0?L[L.length-1]:M[M.length-1]).nextSibling;for(;$;){if($.nodeType===Node.TEXT_NODE){const re=(ce=$.textContent)==null?void 0:ce.replace(new RegExp(Dn,"g"),"").trim();if(re&&re.length>0){m+=1;break}}else if($.nodeType===Node.ELEMENT_NODE)break;$=$.nextSibling}}const z=(r.textContent||"").replace(new RegExp(Dn,"g"),""),O=Array.from(r.querySelectorAll(".empty-line")).filter(ve=>{var re;return(((re=ve.textContent)==null?void 0:re.trim())||"").length>0}).length;let ee=0;const I=ve=>{const $=r.querySelectorAll(ve);let re=0;for(const G of $)!G.closest("table")&&G.textContent&&G.textContent.length>0&&re++;return re};ee+=I("strong, b")*4,ee+=I("em, i")*2,ee+=I("code")*2,ee+=I("del, s")*4;let _=0;const F=r.querySelectorAll("table");F.forEach(ve=>{var G,oe;const $=ve.outerHTML,re=ve===F[F.length-1];if(j&&S&&re){const pe=Array.from(j.querySelectorAll("th, td")).findIndex(be=>be===S||be.contains(v)),fe=Array.from(ve.querySelectorAll("th, td"));if(pe>=0){const be=Ul($);if(pe<be.cells.length){const Pe=be.cells[pe],Ee=t.startOffset,V=Pe.markdownStart+Ee;let D=0;for(let Y=0;Y<pe;Y++)D+=((G=fe[Y].textContent)==null?void 0:G.length)||0;D+=Ee,_+=V-D}}}else{const{markdownLength:de}=$l($),pe=(ve.textContent||"").length;_+=de-pe;const fe=ve.nextSibling||ve.nextElementSibling,be=(fe==null?void 0:fe.nodeName)==="BR"||(fe==null?void 0:fe.nodeType)===Node.ELEMENT_NODE&&fe.tagName==="BR",Pe=!fe||fe.nodeType===Node.TEXT_NODE&&!((oe=fe.textContent)!=null&&oe.trim()),Ee=(fe==null?void 0:fe.nodeType)===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(fe.tagName);!be&&!Pe&&!Ee&&(_+=1),Ee&&(_-=1)}});const q=z.length+f+m+O+_+ee+C;let J=ms(s.innerHTML);const B=s.innerHTML.replace(new RegExp(Dn+"$"),""),se=/(<br>)+$/.exec(B);if(se){const ve=(se[0].match(/<br>/g)||[]).length,$=(/\n+$/.exec(J)||[""])[0].length,re=ve-$;re>0&&(J=J+`
`.repeat(re))}const le=t.startContainer.nodeType===Node.TEXT_NODE&&t.startContainer.textContent==="â€‹",me=le&&(((Ce=(Ae=t.startContainer.parentElement)==null?void 0:Ae.classList)==null?void 0:Ce.contains("empty-line"))??!1),H=q+(le&&!me?-1:0);return{text:J,cursorPos:H}}function Ay(s){const e=s.match(/<th[^>]*>([^<]*)<\/th>/g)||[],t=s.match(/<td[^>]*>([^<]*)<\/td>/g)||[],n=s.match(/<th[^>]*>(?=.*\S)[\s\S]*?<\/th>/g)||[],r=s.match(/<td[^>]*>(?=.*\S)[\s\S]*?<\/td>/g)||[];let o=0;const i=[...new Set([...e,...n])],c=[...new Set([...t,...r])];for(const l of i)l.replace(/<[^>]+>/g,"").trim().length>0&&o++;for(const l of c)l.replace(/<[^>]+>/g,"").trim().length>0&&o++;return o}function Py(s){const e=/<table[^>]*>[\s\S]*?<\/table>/g,t=[];let n=s,r=0,o;for(;(o=e.exec(s))!==null;){const i=o[0],{markdownLength:c,lineCount:l}=$l(i),d=Ay(i);t.push({start:o.index-r,end:o.index+i.length-r,markdownLength:c,lineCount:l,textNodeCount:d,html:i});const p=`__TABLE_${t.length-1}__`;n=n.slice(0,o.index-r)+p+n.slice(o.index+i.length-r),r+=i.length-p.length}return{processedHtml:n,tables:t}}function Ry(s){return s==="<strong>"||s==="</strong>"||s==="<b>"||s==="</b>"?{type:"formatting",markdownChars:2}:s==="<em>"||s==="</em>"||s==="<i>"||s==="</i>"?{type:"formatting",markdownChars:1}:s.startsWith("<code")||s==="</code>"?{type:"formatting",markdownChars:1}:s==="<del>"||s==="</del>"||s==="<s>"||s==="</s>"?{type:"formatting",markdownChars:2}:null}function Dy(s){const{processedHtml:e,tables:t}=Py(s),n=[];let r=0,o=0,i=0,c=0,l=!1,d=!1,p=!1,u=null;const f=/(__TABLE_(\d+)__)|(<div class="empty-line"><br><\/div>)|(<br>)|(<h([123])>)|(<blockquote[^>]*>)|(<div[^>]*(list-item-(ul|ol))[^>]*>)|(<[^>]+>)|([^<]+)/g;let m;for(;(m=f.exec(e))!==null;)if(m[1]){const g=parseInt(m[2],10),x=t[g];n.push({type:"table",tableIndex:g,markdownLength:x.markdownLength,lineCount:x.lineCount,textNodeCount:x.textNodeCount})}else if(m[3])n.push({type:"br-empty-line",index:i++});else if(m[4])n.push({type:"br-standalone",index:o++});else if(m[5]){const g=parseInt(m[6],10);n.push({type:"header",level:g}),u=g}else if(m[7])n.push({type:"blockquote"});else if(m[8]){const g=m[10];n.push({type:"list-item-start",listType:g,index:c++}),l=g==="ol",p=!0}else if(m[11]){const g=m[11].toLowerCase(),x=m[11],b=Ry(g);b&&n.push(b),(x.includes('class="paragraph"')||x.includes("class='paragraph'"))&&(d=!0),x==="</div>"&&(l=!1,d&&(n.push({type:"block-end"}),d=!1),p&&(n.push({type:"block-end"}),p=!1)),/^<\/h[123]>$/.test(x)&&(u=null,n.push({type:"block-end"})),x==="</blockquote>"&&n.push({type:"block-end"})}else if(m[12]){const g=m[12];if(/^\s+$/.test(g)){r++,n.push({type:"whitespace",length:g.length});continue}const x=g==="â€¢",b=l&&/^\d+\.$/.test(g),v=u!==null,w=u;v&&(u=null),n.push({type:"text",content:g,index:r++,isBullet:x,isOlNumber:b,isHeaderText:v,headerLevel:w}),l&&(l=!1)}return{tokens:n,tables:t,processedHtml:e}}function _y(s,e,t,n,r,o){const i=s-e,c=Ul(t.html);for(let l=0;l<c.cells.length;l++){const d=c.cells[l],p=d.markdownStart,u=p+d.content.length;if(i>=p&&i<=u){if(d.isEmpty)return{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in empty table cell at row ${d.rowIndex}, col ${d.colIndex}`,emptyCellIndex:l,emptyCellRow:d.rowIndex,emptyCellCol:d.colIndex};const f=i-p;return{nodeType:"text",nodeIndex:n+d.textNodeIndex,offset:Math.min(f,d.content.length),expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is within table cell "${d.content.substring(0,20)}" at offset ${f}`}}}if(c.cells.length>0){const l=c.cells[c.cells.length-1],d=l.markdownStart+l.content.length;if(i>=d)return l.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is after last (empty) table cell at row ${l.rowIndex}, col ${l.colIndex}`,emptyCellIndex:c.cells.length-1,emptyCellRow:l.rowIndex,emptyCellCol:l.colIndex}:{nodeType:"text",nodeIndex:n+l.textNodeIndex,offset:l.content.length,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is past last table cell, placing at end of "${l.content.substring(0,20)}"`};{for(let f=0;f<c.cells.length;f++){const m=c.cells[f],g=f>0?c.cells[f-1].markdownStart+c.cells[f-1].content.length:0;if(i>=g&&i<m.markdownStart)return m.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before empty table cell at row ${m.rowIndex}, col ${m.colIndex}`,emptyCellIndex:f,emptyCellRow:m.rowIndex,emptyCellCol:m.colIndex}:{nodeType:"text",nodeIndex:n+m.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before cell "${m.content.substring(0,20)}", placing at start`}}const p=c.cells[0];return p.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing in empty first cell`,emptyCellIndex:0,emptyCellRow:p.rowIndex,emptyCellCol:p.colIndex}:{nodeType:"text",nodeIndex:n+p.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing at start of first cell`}}}return{nodeType:"text",nodeIndex:(n>0?n-1:0)+o,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!1,explanation:`Position ${s} is within table but no cells found`}}function Oy(s,e,t,n,r,o){const i=t;let c;s.isBullet?c=2:s.isOlNumber?c=s.content.length+1:c=s.content.length;const l=i,d=i+c;if(s.isBullet||s.isOlNumber?e>=l&&e<d:e>=l&&e<=d){const u=s.index+r;if(s.isBullet){const f=Math.min(e-l,1);return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within bullet text node #${u} at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else if(s.isOlNumber){const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within OL number text node #${u} "${s.content}" at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else{const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within text node #${u} "${s.content.substring(0,20)}..." at offset ${f}`},newPos:d,adjustedPos:i}}}return{placement:null,newPos:d,adjustedPos:i}}function ci(s,e,t,n,r,o,i){const c=n+1;return t===n?{nodeType:s,nodeIndex:e,offset:0,expectedLine:r-1,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!0,explanation:`Position ${t} is at ${s} #${e}`}:t===c&&s==="br-standalone"?{nodeType:s,nodeIndex:e,offset:i?1:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!1,explanation:`Position ${t} is after ${s} #${e}`}:null}function Ly(s,e){const{tokens:t,tables:n}=Dy(s);let r=0,o=1,i=!1,c=!1,l=0,d=0,p=0,u=!1;for(let m=0;m<t.length;m++){const g=t[m];if(g.type==="header"){l=g.level+1,c=!1;continue}if(g.type==="formatting"){r+=g.markdownChars;continue}if(g.type==="whitespace"){r+=g.length;continue}if(g.type==="block-end"){u=!0;continue}if(g.type==="blockquote"){r+=2,c=!1;continue}if(g.type==="table"){u&&(r+=1,o++,u=!1);const x=r,b=r+g.markdownLength,v=n[g.tableIndex];if(e>=x&&e<b){const w=_y(e,x,v,p,o,d);if(w)return w}r=b,o+=g.lineCount,d+=g.textNodeCount,c=!1;continue}if(g.type==="list-item-start"){u?(r+=1,o++,u=!1):i&&!c&&(r+=1,o++),i=!0,c=!1;continue}if(g.type==="text"){if(u){if(e===r)return{nodeType:"text",nodeIndex:g.index+d,offset:0,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at implicit newline after block element`};r+=1,o++,u=!1}l>0&&(r+=l,l=0);const x=Oy(g,e,r,o,d);if(x.placement)return x.placement;r=x.newPos,p++,c=!1}else if(g.type==="br-standalone"){u&&(u=!1),o++;const x=ci("br-standalone",g.index,e,r,o,d,!1);if(x)return x;r+=1,c=!0,i=!1}else if(g.type==="br-empty-line"){u&&(r+=1,o++,u=!1),o++;const x=ci("br-empty-line",g.index,e,r,o,d,!0);if(x)return x;r+=1,c=!0,i=!1}}const f=t[t.length-1];if((f==null?void 0:f.type)==="text"){const m=f.index+d;return{nodeType:"text",nodeIndex:m,offset:f.content.length,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at end of last text node #${m}`}}return{nodeType:"end",nodeIndex:0,offset:0,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is beyond content (currentPos=${r})`}}function rn(s,e){var o;const t=window.getSelection();if(!t)return;const n=Ly(s.innerHTML,e),r=document.createRange();if(n.nodeType==="text"){let i;if(n.insideTableCell)i=n.nodeIndex;else if(n.tableTextNodeOffset===0)i=n.nodeIndex;else{const f=s.querySelectorAll("table");let m=0;f.forEach(x=>{const b=document.createTreeWalker(x,NodeFilter.SHOW_TEXT);for(;b.nextNode()!==null;)m++});const g=n.tableTextNodeOffset;i=n.nodeIndex-g+m}const c=document.createTreeWalker(s,NodeFilter.SHOW_TEXT);let l=null,d=0,p=null;const u=[];for(;(l=c.nextNode())!==null;){p=l;const f=l.textContent||"";if(u.push(`[${d}]: "${f.substring(0,30)}${f.length>30?"...":""}"`),d===i){const m=(l.textContent||"").length,g=Math.min(n.offset,m);if(n.atListItemStart){const x=(o=l.parentElement)==null?void 0:o.closest(".list-item-ul, .list-item-ol");if(x!=null&&x.parentNode){const b=document.createTextNode("â€‹");x.parentNode.insertBefore(b,x),r.setStart(b,1),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.setStart(l,g),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}d++}if(p){const f=(p.textContent||"").length;r.setStart(p,f),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}if(n.nodeType==="empty-table-cell"){const i=s.querySelector("table");if(i){const c=i.querySelectorAll("tr");let l=null,d=null;if(n.emptyCellRow===0)l=c[0],l&&(d=l.querySelectorAll("th")[n.emptyCellCol??0]);else{const p=i.querySelector("tbody");p?l=p.querySelectorAll("tr")[(n.emptyCellRow??1)-1]:l=c[n.emptyCellRow??1],l&&(d=l.querySelectorAll("td")[n.emptyCellCol??0])}if(d){const p=document.createTextNode("â€‹");d.appendChild(p),r.setStart(p,0),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}}if(n.nodeType==="br-standalone"){const i=s.querySelectorAll("br");let c=0;for(const l of i){const d=l.parentElement,p=d==null?void 0:d.classList.contains("empty-line"),u=l.closest("table")!==null;if(`${c}${d==null?void 0:d.tagName}${p}${u}`,!p&&!u){if(c===n.nodeIndex){if(n.placeBefore)r.setStartBefore(l),r.collapse(!0);else{const f=l.nextSibling;if(f)if(f.nodeType===Node.TEXT_NODE)r.setStart(f,0);else if(f.tagName==="BR"){const m=document.createTextNode("â€‹");l.parentNode.insertBefore(m,f),r.setStart(m,1)}else{const m=document.createTextNode("â€‹");l.parentNode.insertBefore(m,f),r.setStart(m,1)}else{const m=document.createTextNode("â€‹");l.parentNode.appendChild(m),r.setStart(m,1)}r.collapse(!0)}t.removeAllRanges(),t.addRange(r);return}c++}}}if(n.nodeType==="br-empty-line"){const c=s.querySelectorAll(".empty-line")[n.nodeIndex];if(c){if(n.placeBefore)r.setStart(c,0);else{const l=c.querySelector("br"),d=document.createTextNode("â€‹");l&&l.nextSibling?c.insertBefore(d,l.nextSibling):c.appendChild(d),r.setStart(d,1)}r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.selectNodeContents(s),r.collapse(!1),t.removeAllRanges(),t.addRange(r)}function eo(s){let e="";function t(n){var r;if(n.nodeType===Node.TEXT_NODE)e+=n.textContent||"";else if(n.nodeType===Node.ELEMENT_NODE){const o=n,i=o.tagName.toLowerCase();if(i==="br")e+=`
`;else if(i==="div"||i==="p"){const c=o.childNodes.length===1&&((r=o.firstChild)==null?void 0:r.nodeName)==="BR";e.length>0&&!e.endsWith(`
`)&&!c&&(e+=`
`),o.childNodes.forEach(t)}else o.childNodes.forEach(t)}}return s.childNodes.forEach(t),e}function My(s){let e=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return e.endsWith("<br>")&&(e+="â€‹"),e}function Fy(s){const e=window.getSelection();if(!e||e.rangeCount===0)return 0;const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");return r.appendChild(n.cloneContents()),eo(r).length}function $y(s,e){const t=window.getSelection();if(!t)return;let n=0;const r=document.createTreeWalker(s,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let o=r.nextNode();for(;o;){if(o.nodeType===Node.TEXT_NODE){const l=(o.textContent||"").length;if(n+l>=e){const d=document.createRange(),p=e-n;d.setStart(o,Math.min(p,l)),d.collapse(!0),t.removeAllRanges(),t.addRange(d);return}n+=l}else o.nodeName==="BR"&&(n+=1);o=r.nextNode()}const i=document.createRange();i.selectNodeContents(s),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}function Uy(s){const{editorRef:e,applyingActionRef:t,value:n,isRawMode:r,setInternalValue:o,onChange:i}=s,c=h.useCallback(()=>{if(!e.current)return null;if(r){const d=eo(e.current),p=Fy(e.current);return{text:d,cursorPos:p}}else{const{cursorPos:d}=xa(e.current);return{text:n??xa(e.current).text,cursorPos:d}}},[e,r,n]),l=h.useCallback((d,p)=>{if(!e.current)return;t.current=!0;let u;if(d.replaceTextAfterCursor!==void 0?u=p.substring(0,d.selectionStart)+d.textToInsert+d.replaceTextAfterCursor:u=p.substring(0,d.selectionStart)+d.textToInsert+p.substring(d.selectionEnd),r)e.current.innerHTML=My(u),$y(e.current,d.newCursorPosition);else{const f=it(u);e.current.innerHTML=f,rn(e.current,d.newCursorPosition)}n===void 0&&o(u),i==null||i(u),setTimeout(()=>{t.current=!1},0)},[e,r,n,o,i,t]);return{getTextAndCursor:c,applyAction:l}}function By(s){const{applyAction:e}=s,t=h.useCallback((o,i,c)=>{if(!c.hasSelection||o.metaKey||o.ctrlKey||o.altKey)return!1;const l=Ff(o.key);if(!l)return!1;o.preventDefault();const d=Oo(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),n=h.useCallback((o,i,c)=>{if(!(o.metaKey||o.ctrlKey)||!c.hasSelection)return!1;const l=Mf(o.key);if(!l)return!1;o.preventDefault();const d=Oo(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),r=h.useCallback(o=>(o.metaKey||o.ctrlKey)&&!Wf(o.key),[]);return{handleAutoWrap:t,handleFormatShortcut:n,shouldPassThrough:r}}class Wy{constructor(e){this.apiClient=e}log(e,t){try{const{customLogFile:n,...r}=t||{};this.apiClient.sendLogs(e,r,n)}catch(n){console.error("[ClientLogsService] Failed to log event:",e,n)}}logCritical(e,t){try{return this.apiClient.sendBeacon(e,t)}catch(n){return console.error("[ClientLogsService] Failed to log critical event:",e,n),!1}}async clearLogs(){try{return await this.apiClient.clearLogs()}catch(e){return console.error("[ClientLogsService] Failed to clear logs:",e),!1}}}class zy{constructor(e){this.client=e}async log(e,t){await this.client.sendLogs(e,t)}logCritical(e,t){return this.client.sendBeacon(e,t)}}class Hy{constructor(e={}){Z(this,"_clientLogsApiClient",null);Z(this,"_clientLogsService",null);Z(this,"_logger",null);Z(this,"_config");this._config={clientLogsApiBaseUrl:e.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",clientLogsEnabled:e.clientLogsEnabled!==!1}}get clientLogsApiClient(){return this._clientLogsApiClient||(this._clientLogsApiClient=new Oa(this._config.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",5e3)),this._clientLogsApiClient}get clientLogsService(){return this._clientLogsService||(this._clientLogsService=new Wy(this.clientLogsApiClient)),this._clientLogsService}get logger(){return this._logger||(this._logger=new zy(this.clientLogsApiClient)),this._logger}setConfig(e){this._config={...this._config,...e},this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}setClientLogsApiClient(e){this._clientLogsApiClient=e,this._clientLogsService=null,this._logger=null}reset(){this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}}const Pr=new Hy;class ye{constructor(e,t,n,r){this.isSuccess=e,this.isFailure=t,this._value=n,this._error=r}get value(){if(!this.isSuccess)throw new Error("Cannot get value from a failure result");return this._value}get error(){if(!this.isFailure)throw new Error("Cannot get error from a success result");return this._error}static success(e){return new ye(!0,!1,e,void 0)}static failure(e){return new ye(!1,!0,void 0,e)}}class Rr extends Error{constructor(e){super(`User not found: ${e}`),this.userId=e,this.name="UserNotFoundError"}}class Gy extends Error{constructor(){super("Username cannot be empty"),this.name="UsernameEmptyError"}}class qy extends Error{constructor(e){super(`Username must be at least ${e} characters`),this.minLength=e,this.name="UsernameTooShortError"}}class Vy extends Error{constructor(e){super(`Username cannot exceed ${e} characters`),this.maxLength=e,this.name="UsernameTooLongError"}}function gr(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():typeof crypto<"u"&&typeof crypto.getRandomValues=="function"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return(s==="x"?e:e&3|8).toString(16)}):(console.warn("[UUID] Using Math.random() fallback - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}))}class Gt{constructor(e,t,n,r,o,i,c){this.id=e,this.username=t,this.profilePicture=n,this.isOnline=r,this.lastSeen=o,this.createdAt=i,this.updatedAt=c,this.validate()}validate(){if(!this.id.trim())throw new Error("User ID cannot be empty");if(!this.username.trim())throw new Error("Username cannot be empty");if(this.username.length<2)throw new Error("Username must be at least 2 characters");if(this.username.length>50)throw new Error("Username cannot exceed 50 characters")}static create(e,t){const n=new Date().toISOString();return new Gt(gr(),e.trim(),t,!1,n,n,n)}static fromData(e){return new Gt(e.id,e.username,e.profilePicture,e.isOnline,e.lastSeen,e.createdAt,e.updatedAt)}setOnline(e){return new Gt(this.id,this.username,this.profilePicture,e,new Date().toISOString(),this.createdAt,new Date().toISOString())}updateProfile(e,t){return new Gt(this.id,(e==null?void 0:e.trim())||this.username,t!==void 0?t:this.profilePicture,this.isOnline,this.lastSeen,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,username:this.username,profilePicture:this.profilePicture,isOnline:this.isOnline,lastSeen:this.lastSeen,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Ky{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;console.log("[CreateUserUseCase] Executing with command:",e);try{const n=e.username.trim();if(n.length===0)return console.log("[CreateUserUseCase] Validation failed: Username is empty"),ye.failure(new Gy);if(n.length<2)return console.log("[CreateUserUseCase] Validation failed: Username too short"),ye.failure(new qy(2));if(n.length>50)return console.log("[CreateUserUseCase] Validation failed: Username too long"),ye.failure(new Vy(50));console.log("[CreateUserUseCase] Validation passed, creating user entity");const r=Gt.create(n,e.profilePicture);console.log("[CreateUserUseCase] User entity created:",r),console.log("[CreateUserUseCase] Calling repository.create...");const o=await this.repository.create(r);return console.log("[CreateUserUseCase] User persisted successfully:",o),(t=this.logger)==null||t.log("user_created",{userId:o.id,usernameLength:n.length,hasProfilePicture:!!e.profilePicture}),console.log("[CreateUserUseCase] Returning success result"),ye.success(o)}catch(n){return console.error("[CreateUserUseCase] CAUGHT ERROR:",n),ye.failure(n instanceof Error?n:new Error("Failed to create user"))}}}class Ps{constructor(e,t,n,r,o,i,c,l,d,p){this.id=e,this.gameId=t,this.senderId=n,this.senderUsername=r,this.senderProfilePicture=o,this.text=i,this.timestamp=c,this.createdAt=l,this.isPersona=d,this.isIntroduction=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Message ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.senderId.trim())throw new Error("Sender ID cannot be empty");if(!this.senderUsername.trim())throw new Error("Sender username cannot be empty");if(!this.text.trim())throw new Error("Message text cannot be empty");if(this.text.length>500)throw new Error("Message text cannot exceed 500 characters")}static create(e,t,n,r,o,i,c){const l=new Date().toISOString();return new Ps(gr(),e.trim(),t.trim(),n.trim(),r,o.trim(),l,l,i,c)}static fromData(e){return new Ps(e.id,e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,e.text,e.timestamp,e.createdAt,e.isPersona,e.isIntroduction)}toJSON(){return{id:this.id,gameId:this.gameId,senderId:this.senderId,senderUsername:this.senderUsername,senderProfilePicture:this.senderProfilePicture,text:this.text,timestamp:this.timestamp,createdAt:this.createdAt,isPersona:this.isPersona,isIntroduction:this.isIntroduction}}}class Jy{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t,n;try{const r=e.text.trim();if(r.length===0)return ye.failure(new Error("Message text cannot be empty"));if(r.length>500)return ye.failure(new Error("Message text cannot exceed 500 characters"));if(!e.gameId.trim())return ye.failure(new Error("Game ID is required"));if(!e.senderId.trim())return ye.failure(new Error("Sender ID is required"));if(!e.senderUsername.trim())return ye.failure(new Error("Sender username is required"));const o=Ps.create(e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,r),i=await this.repository.create(o);if(i.isFailure)return i;const c=/@(\w+)/g,l=Array.from(r.matchAll(c)).map(p=>p[1]);l.length>0&&!e.isFromPersona&&((t=this.logger)==null||t.log("persona_mentioned",{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,mentionedNames:l,mentionCount:l.length}));const d=e.isFromPersona?"persona_message_sent":"chat_message_sent";return(n=this.logger)==null||n.log(d,{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,messageLength:r.length,isFromPersona:e.isFromPersona||!1,hasMentions:l.length>0}),ye.success(i.value)}catch(r){return ye.failure(r instanceof Error?r:new Error("Failed to send message"))}}}class Yy{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;try{if(!e.gameId.trim())return ye.failure(new Error("Game ID is required"));const n=await this.repository.findByGameId(e.gameId);return n.isFailure?n:((t=this.logger)==null||t.log("chat_messages_loaded",{gameId:e.gameId,messageCount:n.value.length}),ye.success(n.value))}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to retrieve messages"))}}}class Xy{constructor(e,t,n,r){Z(this,"_createUserUseCase");Z(this,"_sendMessageUseCase");Z(this,"_getMessagesUseCase");this.userRepository=e,this.chatRepository=t,this.webSocketService=n,this.logger=r}async createUser(e){var n;this._createUserUseCase||(this._createUserUseCase=new Ky(this.userRepository,this.logger));const t=await this._createUserUseCase.execute(e);if(t.isSuccess){const r=await this.setUserOnline({userId:t.value.id,isOnline:!0});if((n=this.logger)==null||n.log("user_set_online",{userId:t.value.id,isOnline:!0,triggeredBy:"user_creation"}),r.isSuccess)return ye.success(r.value)}return t}async updateUser(e){try{const t=await this.userRepository.getById(e.userId);if(!t)return ye.failure(new Rr(e.userId));const n=t.updateProfile(e.username,e.profilePicture),r=await this.userRepository.update(n);return ye.success(r)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to update user"))}}async setUserOnline(e){var t;try{const n=await this.userRepository.getById(e.userId);if(!n)return ye.failure(new Rr(e.userId));const r=n.setOnline(e.isOnline),o=await this.userRepository.update(r);return(t=this.logger)==null||t.log("user_online_status_changed",{userId:e.userId,username:n.username,previousStatus:n.isOnline,newStatus:e.isOnline}),ye.success(o)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to set user online status"))}}async deleteUser(e){try{return await this.userRepository.delete(e.userId),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to delete user"))}}async getAllUsers(e){try{let t=await this.userRepository.getAll();return e.onlineOnly&&(t=t.filter(n=>n.isOnline)),ye.success(t)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to get users"))}}async getUserById(e){try{const t=await this.userRepository.getById(e.userId);return t?ye.success(t):ye.failure(new Rr(e.userId))}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to get user"))}}async connect(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to connect"))}}async disconnect(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return await this.webSocketService.disconnect(),ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to disconnect"))}}async joinLobby(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to join lobby"))}}async leaveLobby(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to leave lobby"))}}async sendMessage(e){return this._sendMessageUseCase||(this._sendMessageUseCase=new Jy(this.chatRepository,this.logger)),this._sendMessageUseCase.execute(e)}async clearMessages(e){var t;try{return await this.chatRepository.deleteByGameId(e.gameId),(t=this.logger)==null||t.log("chat_messages_cleared",{gameId:e.gameId}),ye.success(void 0)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to clear messages"))}}async getMessages(e){return this._getMessagesUseCase||(this._getMessagesUseCase=new Yy(this.chatRepository,this.logger)),this._getMessagesUseCase.execute(e)}}class Nt{constructor(e,t,n,r,o,i,c,l,d,p){this.id=e,this.name=t,this.gameType=n,this.players=r,this.status=o,this.currentTurn=i,this.winner=c,this.gameData=l,this.createdAt=d,this.updatedAt=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Game ID cannot be empty");if(this.players.length===0)throw new Error("Game must have at least one player")}static create(e,t,n){const r=new Date().toISOString(),o={metadata:{}};return new Nt(gr(),n,t,[e],"waiting",void 0,void 0,o,r,r)}static fromData(e){return new Nt(e.id,e.name,e.gameType,e.players,e.status,e.currentTurn,e.winner,e.gameData,e.createdAt,e.updatedAt)}addPlayer(e){if(this.players.includes(e))throw new Error("Player already in game");if(this.players.length>=10)throw new Error("Lobby is full");const n=[...this.players,e],r=n.length>=2?"ready":"waiting";return new Nt(this.id,this.name,this.gameType,n,r,this.currentTurn,this.winner,this.gameData,this.createdAt,new Date().toISOString())}start(){if(this.status!=="ready")throw new Error("Lobby must be in ready state to start");return new Nt(this.id,this.name,this.gameType,this.players,"in_progress",this.players[0],this.winner,this.gameData,this.createdAt,new Date().toISOString())}updateGameData(e,t){return new Nt(this.id,this.name,this.gameType,this.players,this.status,t!==void 0?t:this.currentTurn,this.winner,e,this.createdAt,new Date().toISOString())}complete(e){return new Nt(this.id,this.name,this.gameType,this.players,"completed",void 0,e,this.gameData,this.createdAt,new Date().toISOString())}abandon(){return new Nt(this.id,this.name,this.gameType,this.players,"abandoned",void 0,this.winner,this.gameData,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,name:this.name,gameType:this.gameType,players:this.players,status:this.status,currentTurn:this.currentTurn,winner:this.winner,gameData:this.gameData,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class kt{constructor(e,t,n,r,o,i,c,l){this.id=e,this.gameId=t,this.name=n,this.description=r,this.emoji=o,this.isActive=i,this.createdAt=c,this.updatedAt=l,this.validate()}validate(){if(!this.id.trim())throw new Error("Persona ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.name.trim())throw new Error("Persona name cannot be empty");if(this.name.length<2)throw new Error("Persona name must be at least 2 characters");if(this.name.length>50)throw new Error("Persona name cannot exceed 50 characters");if(!this.description.trim())throw new Error("Persona description cannot be empty");if(this.description.length<5)throw new Error("Persona description must be at least 5 characters");if(this.description.length>500)throw new Error("Persona description cannot exceed 500 characters")}static create(e,t,n,r){const o=new Date().toISOString();return new kt(gr(),e.trim(),t.trim(),n.trim(),r.trim(),!1,o,o)}static fromData(e){return new kt(e.id,e.gameId,e.name,e.description,e.emoji,e.isActive,e.createdAt,e.updatedAt)}activate(){return this.isActive?this:new kt(this.id,this.gameId,this.name,this.description,this.emoji,!0,this.createdAt,new Date().toISOString())}deactivate(){return this.isActive?new kt(this.id,this.gameId,this.name,this.description,this.emoji,!1,this.createdAt,new Date().toISOString()):this}update(e,t,n){return new kt(this.id,this.gameId,(e==null?void 0:e.trim())||this.name,(t==null?void 0:t.trim())||this.description,(n==null?void 0:n.trim())||this.emoji,this.isActive,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,gameId:this.gameId,name:this.name,description:this.description,emoji:this.emoji,isActive:this.isActive,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Qy{constructor(e,t=5e3){this.baseUrl=e,this.timeout=t}async createUser(e){const t=`${this.baseUrl}/users`;console.log("[HttpGameService.createUser] Making POST request to:",t),console.log("[HttpGameService.createUser] Request body:",e);try{const n=await this.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("[HttpGameService.createUser] Response received:",n.status);const r=await n.json();return console.log("[HttpGameService.createUser] Response data:",r),{user:Gt.fromData(r.user)}}catch(n){throw console.error("[HttpGameService.createUser] ERROR:",n),n}}async getUser(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"GET"})).json();return{user:Gt.fromData(n.user)}}async getAllUsers(){return{users:(await(await this.fetchWithTimeout(`${this.baseUrl}/users`,{method:"GET"})).json()).users.map(n=>Gt.fromData(n))}}async updateUser(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{user:Gt.fromData(r.user)}}async createGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{game:Nt.fromData(n.game)}}async getGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"GET"})).json();return{game:Nt.fromData(n.game)}}async getAllGames(e){const t=new URLSearchParams;e!=null&&e.status&&t.append("status",e.status),e!=null&&e.gameType&&t.append("gameType",e.gameType),e!=null&&e.playerId&&t.append("playerId",e.playerId);const n=`${this.baseUrl}/games${t.toString()?`?${t.toString()}`:""}`;return{games:(await(await this.fetchWithTimeout(n,{method:"GET"})).json()).games.map(i=>Nt.fromData(i))}}async joinGame(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{game:Nt.fromData(r.game)}}async startGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/start`,{method:"POST"})}async deleteGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"DELETE"})}async createChatMessage(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e.gameId}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderId:e.senderId,senderUsername:e.senderUsername,text:e.text})})).json();return{message:Ps.fromData(n.message)}}async getChatMessages(e){return{messages:(await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"GET"})).json()).messages.map(r=>Ps.fromData(r))}}async clearChatMessages(e){return await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"DELETE"})).json()}async createPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{persona:kt.fromData(n.persona)}}async getPersonas(e){return{personas:(await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"GET"})).json()).personas.map(r=>kt.fromData(r))}}async getPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/detail/${e}`,{method:"GET"})).json();return{persona:kt.fromData(n.persona)}}async updatePersona(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{persona:kt.fromData(r.persona)}}async deletePersona(e){await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"DELETE"})}async activatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/activate`,{method:"POST"})).json();return{persona:kt.fromData(n.persona)}}async deactivatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/deactivate`,{method:"POST"})).json();return{persona:kt.fromData(n.persona)}}async fetchWithTimeout(e,t){console.log("[fetchWithTimeout] Starting fetch to:",e),console.log("[fetchWithTimeout] Method:",t.method),console.log("[fetchWithTimeout] Timeout:",this.timeout+"ms");const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});if(console.log("[fetchWithTimeout] Response status:",o.status,o.statusText),!o.ok){const i=`HTTP error! status: ${o.status}`;throw console.error("[fetchWithTimeout]",i),new Error(i)}return o}catch(o){if(o instanceof Error&&o.name==="AbortError"){const i=`Request timeout after ${this.timeout}ms`;throw console.error("[fetchWithTimeout]",i),new Error(i)}throw console.error("[fetchWithTimeout] Network error:",o),o}finally{clearTimeout(r)}}}var jt=(s=>(s.DISCONNECTED="DISCONNECTED",s.CONNECTING="CONNECTING",s.CONNECTED="CONNECTED",s.RECONNECTING="RECONNECTING",s.ERROR="ERROR",s))(jt||{});class Zy{constructor(){Z(this,"ws",null);Z(this,"config",null);Z(this,"connectionState",jt.DISCONNECTED);Z(this,"messageHandlers",new Set);Z(this,"stateHandlers",new Set);Z(this,"reconnectAttempts",0);Z(this,"reconnectTimeoutId",null);Z(this,"heartbeatIntervalId",null)}async connect(e){return this.config=e,this.reconnectAttempts=0,this.doConnect()}async disconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null),this.ws&&(this.ws.close(),this.ws=null),this.updateConnectionState(jt.DISCONNECTED)}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");const t={...e,timestamp:new Date().toISOString()};this.ws.send(JSON.stringify(t))}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}onConnectionStateChange(e){return this.stateHandlers.add(e),()=>{this.stateHandlers.delete(e)}}getConnectionState(){return this.connectionState}isConnected(){return this.connectionState===jt.CONNECTED}async doConnect(){if(!this.config)throw new Error("Config not set");return new Promise((e,t)=>{this.updateConnectionState(this.reconnectAttempts>0?jt.RECONNECTING:jt.CONNECTING),this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("[WebSocket] Connected"),this.reconnectAttempts=0,this.updateConnectionState(jt.CONNECTED),this.startHeartbeat(),e()},this.ws.onmessage=n=>{try{const r=JSON.parse(n.data);this.handleMessage(r)}catch(r){console.error("[WebSocket] Failed to parse message:",r)}},this.ws.onerror=n=>{console.error("[WebSocket] Error:",n),this.updateConnectionState(jt.ERROR),t(n)},this.ws.onclose=()=>{console.log("[WebSocket] Disconnected"),this.stopHeartbeat(),this.connectionState!==jt.DISCONNECTED&&this.attemptReconnect()}})}handleMessage(e){e.type!=="pong"&&this.messageHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] Message handler error:",n)}})}attemptReconnect(){if(!this.config)return;const e=this.config.maxReconnectAttempts??10;if(this.reconnectAttempts>=e){console.error(`[WebSocket] Max reconnection attempts (${e}) reached`),this.updateConnectionState(jt.ERROR);return}this.reconnectAttempts++;const t=this.config.reconnectInterval??3e3;console.log(`[WebSocket] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${e})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.doConnect().catch(n=>{console.error("[WebSocket] Reconnection failed:",n)})},t)}startHeartbeat(){if(!this.config)return;const e=this.config.heartbeatInterval??3e4;this.heartbeatIntervalId=window.setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping"}).catch(t=>{console.error("[WebSocket] Failed to send heartbeat:",t)})},e)}stopHeartbeat(){this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null)}updateConnectionState(e){this.connectionState!==e&&(this.connectionState=e,this.stateHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] State handler error:",n)}}))}}class eS{constructor(e){this.httpService=e}async getAll(e){return(await this.httpService.getAllGames(e)).games}async getById(e){try{return(await this.httpService.getGame(e)).game}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){return(await this.httpService.createGame({gameType:e.gameType||"tic-tac-toe",creatorId:e.players[0]})).game}async update(e){return e}async delete(e){await this.httpService.deleteGame(e)}}class tS{constructor(e){this.httpService=e}async getAll(){return(await this.httpService.getAllUsers()).users}async getById(e){try{return(await this.httpService.getUser(e)).user}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){console.log("[HttpUserRepository.create] Creating user:",{username:e.username,id:e.id});try{const t=await this.httpService.createUser({username:e.username,profilePicture:e.profilePicture});return console.log("[HttpUserRepository.create] User created successfully:",t.user),t.user}catch(t){throw console.error("[HttpUserRepository.create] ERROR:",t),t}}async update(e){return(await this.httpService.updateUser(e.id,{isOnline:e.isOnline,profilePicture:e.profilePicture})).user}async delete(e){console.warn("[HttpUserRepository] Delete not implemented")}}class sS{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createChatMessage({gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,text:e.text});return ye.success(t.message)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to create chat message"))}}async findByGameId(e){try{const t=await this.httpService.getChatMessages(e);return ye.success(t.messages)}catch(t){return t instanceof Error&&t.message.includes("404")?ye.success([]):ye.failure(t instanceof Error?t:new Error("Failed to retrieve chat messages"))}}async deleteByGameId(e){try{return await this.httpService.clearChatMessages(e),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to clear chat messages"))}}}class nS{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createPersona({gameId:e.gameId,name:e.name,description:e.description,emoji:e.emoji});return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to create persona"))}}async findByGameId(e){try{const t=await this.httpService.getPersonas(e);return ye.success(t.personas)}catch(t){return t instanceof Error&&t.message.includes("404")?ye.success([]):ye.failure(t instanceof Error?t:new Error("Failed to retrieve personas"))}}async findById(e){try{const t=await this.httpService.getPersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to retrieve persona"))}}async update(e,t){try{const n=await this.httpService.updatePersona(e,{name:t.name,description:t.description,emoji:t.emoji,isActive:t.isActive});return ye.success(n.persona)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to update persona"))}}async delete(e){try{return await this.httpService.deletePersona(e),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to delete persona"))}}async activate(e){try{const t=await this.httpService.activatePersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to activate persona"))}}async deactivate(e){try{const t=await this.httpService.deactivatePersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to deactivate persona"))}}}class rS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.create(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_created",{personaId:t.value.id,gameId:e.gameId,name:e.name,description:e.description,isActive:t.value.isActive})),t}}class aS{constructor(e){this.personaRepository=e}async execute(e){return await this.personaRepository.findByGameId(e)}}class oS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t){var r;const n=await this.personaRepository.update(e,t);return n.isSuccess&&((r=this.logger)==null||r.log("persona_updated",{personaId:e,updates:t,name:n.value.name,gameId:n.value.gameId})),n}}class iS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.delete(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_deleted",{personaId:e})),t}}class cS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t=!0){var r;const n=t?await this.personaRepository.activate(e):await this.personaRepository.deactivate(e);if(n.isSuccess){const o=t?"persona_activated":"persona_deactivated";(r=this.logger)==null||r.log(o,{personaId:e,isActive:t,name:n.value.name,gameId:n.value.gameId})}return n}}const to="CONNECT_REQUEST",Bl="CONNECT_SUCCESS",Wl="CONNECT_FAILURE",so="DISCONNECT",zl="CONNECTION_STATE_CHANGED",Hl="CREATE_USER_REQUEST",Gl="CREATE_USER_SUCCESS",ql="CREATE_USER_FAILURE",Vl="UPDATE_USER_REQUEST",Kl="UPDATE_USER_SUCCESS",Jl="UPDATE_USER_FAILURE",Yl="FETCH_USERS_REQUEST",Xl="FETCH_USERS_SUCCESS",Ql="FETCH_USERS_FAILURE",Zl="SET_USER_ONLINE_REQUEST",ed="SET_USER_ONLINE_SUCCESS",td="SET_USER_ONLINE_FAILURE",sd="SET_CURRENT_USER",lS="CREATE_GAME_REQUEST",dS="CREATE_GAME_SUCCESS",uS="CREATE_GAME_FAILURE",pS="JOIN_GAME_REQUEST",hS="JOIN_GAME_SUCCESS",fS="JOIN_GAME_FAILURE",mS="START_GAME_REQUEST",gS="START_GAME_SUCCESS",xS="START_GAME_FAILURE",vS="MAKE_MOVE_REQUEST",bS="MAKE_MOVE_SUCCESS",wS="MAKE_MOVE_FAILURE",yS="LEAVE_GAME_REQUEST",SS="LEAVE_GAME_SUCCESS",jS="LEAVE_GAME_FAILURE",CS="FETCH_GAMES_REQUEST",NS="FETCH_GAMES_SUCCESS",kS="FETCH_GAMES_FAILURE",ES="GAME_UPDATED",IS="GAME_ENDED",nd="USER_LIST_UPDATED",rd="SEND_MESSAGE_REQUEST",ad="SEND_MESSAGE_SUCCESS",od="SEND_MESSAGE_FAILURE",id="FETCH_MESSAGES_REQUEST",cd="FETCH_MESSAGES_SUCCESS",ld="FETCH_MESSAGES_FAILURE",dd="CLEAR_MESSAGES_REQUEST",ud="CLEAR_MESSAGES_SUCCESS",pd="CLEAR_MESSAGES_FAILURE",hd="CHAT_MESSAGE_RECEIVED",fd="CREATE_PERSONA_REQUEST",md="CREATE_PERSONA_SUCCESS",gd="CREATE_PERSONA_FAILURE",xd="FETCH_PERSONAS_REQUEST",vd="FETCH_PERSONAS_SUCCESS",bd="FETCH_PERSONAS_FAILURE",wd="UPDATE_PERSONA_REQUEST",yd="UPDATE_PERSONA_SUCCESS",Sd="UPDATE_PERSONA_FAILURE",jd="DELETE_PERSONA_REQUEST",Cd="DELETE_PERSONA_SUCCESS",Nd="DELETE_PERSONA_FAILURE",kd="ACTIVATE_PERSONA_REQUEST",Ed="ACTIVATE_PERSONA_SUCCESS",Id="ACTIVATE_PERSONA_FAILURE",Td="PERSONA_CREATED",Ad="PERSONA_UPDATED",Pd="PERSONA_DELETED",Rd="PERSONA_ACTIVATED",Dd="PERSONA_DEACTIVATED",TS="SET_SELECTED_GAME",AS="CLEAR_ERROR",AC=()=>({type:to}),PS=()=>({type:Bl}),li=s=>({type:Wl,error:s}),RS=s=>({type:zl,payload:s}),PC=()=>({type:so}),DS=s=>({type:sd,payload:s}),_S=()=>({type:Yl}),OS=s=>({type:Xl,payload:s}),LS=s=>({type:Ql,error:s}),MS=s=>({type:nd,payload:s}),RC=(s,e)=>async t=>{console.log("[createUser] Starting user creation for username:",s),t({type:Hl});const n=at.gameApplicationService;console.log("[createUser] Calling application service...");const r=await n.createUser({username:s,profilePicture:e});console.log("[createUser] Result received:",{isSuccess:r.isSuccess,error:r.isSuccess?null:r.error.message}),r.isSuccess?(console.log("[createUser] Success! User created:",r.value),t({type:Gl,payload:r.value}),t(DS(r.value))):(console.error("[createUser] FAILURE! Error:",r.error.message),t({type:ql,error:r.error.message}))},DC=(s,e,t)=>async n=>{n({type:Vl});const o=await at.gameApplicationService.updateUser({userId:s,username:e,profilePicture:t});o.isSuccess?n({type:Kl,payload:o.value}):n({type:Jl,error:o.error.message})},_C=(s,e)=>async t=>{t({type:Zl});const r=await at.gameApplicationService.setUserOnline({userId:s,isOnline:e});r.isSuccess?t({type:ed,payload:r.value}):t({type:td,error:r.error.message})},OC=()=>async s=>{s(_S());const t=await at.gameApplicationService.getAllUsers({onlineOnly:!1});t.isSuccess?s(OS(t.value)):s(LS(t.error.message))},FS=s=>({type:hd,payload:s}),$S=(s,e,t,n,r,o)=>async i=>{i({type:rd});const l=await at.gameApplicationService.sendMessage({gameId:s,senderId:e,senderUsername:t,senderProfilePicture:n,text:r,isFromPersona:o});l.isSuccess?i({type:ad,payload:l.value}):i({type:od,error:l.error.message})},LC=s=>async e=>{e({type:id});const n=await at.gameApplicationService.getMessages({gameId:s});n.isSuccess?e({type:cd,payload:n.value}):e({type:ld,error:n.error.message})},MC=s=>async e=>{e({type:dd});const n=await at.gameApplicationService.clearMessages({gameId:s});n.isSuccess?e({type:ud,payload:s}):e({type:pd,error:n.error.message})},US={maxContextMessages:10,responseDelay:1e3,maxResponseLength:300};function BS(s){return`You are ${s.name}, an AI assistant in a multiplayer chat lobby.

Your role and behavior:
${s.description}

Guidelines:
- Stay in character as ${s.name}
- Keep responses concise (under 300 characters)
- Be helpful and engaging
- Respond naturally to the conversation flow
- Don't mention that you're an AI unless directly asked
- Use the persona's personality consistently

Current conversation context will be provided. Respond as ${s.name} would.`}class WS{constructor(e,t,n){Z(this,"isProcessing",!1);Z(this,"config");this.ollamaApi=e,this.store=t,this.config={...US,...n}}extractMentions(e){const t=/@(\w+)/g;return Array.from(e.matchAll(t)).map(r=>r[1])}async processMessage(e,t){if(console.log("[PersonaResponseService] ========== PROCESSING MESSAGE =========="),console.log("[PersonaResponseService] Message:",e),console.log("[PersonaResponseService] Game ID:",t),this.isProcessing){console.log("[PersonaResponseService] Already processing, skipping");return}try{this.isProcessing=!0;const n=this.store.getState(),r=n.currentUser;if(console.log("[PersonaResponseService] Current user:",r==null?void 0:r.username),console.log("[PersonaResponseService] Total personas in state:",Object.keys(n.personas.byId).length),this.isPersonaMessage(e,n.personas.byId)){console.log("[PersonaResponseService] Message from persona, skipping");return}const o=this.extractMentions(e.text);if(console.log("[PersonaResponseService] Extracted mentions:",o),o.length===0){console.log("[PersonaResponseService] No @mentions in message, skipping");return}console.log("[PersonaResponseService] âœ… Detected @mentions:",o);const c=(n.personas.byGameId[t]||[]).map(d=>n.personas.byId[d]).filter(d=>d&&d.isActive);if(c.length===0){console.log("[PersonaResponseService] No active personas");return}const l=(n.chatMessages[t]||[]).slice(-this.config.maxContextMessages).map(d=>({sender:d.senderUsername,text:d.text,isPersona:this.isPersonaMessage(d,n.personas.byId)}));for(const d of c)o.some(u=>u.toLowerCase()===d.name.toLowerCase())&&(console.log("[PersonaResponseService] Persona @mentioned, generating AI response:",d.name),await this.generatePersonaResponse(d,l,t,r==null?void 0:r.id))}catch(n){console.error("[PersonaResponseService] Error processing message:",n)}finally{this.isProcessing=!1}}isPersonaMessage(e,t){return Object.values(t).some(n=>n.id===e.senderId)}async generatePersonaResponse(e,t,n,r){var o,i;try{await new Promise(u=>setTimeout(u,this.config.responseDelay));const c=[{role:"system",content:BS(e)},...t.map(u=>({role:u.isPersona?"assistant":"user",content:`${u.sender}: ${u.text}`}))];console.log("[PersonaResponseService] Generating response for:",e.name);const d=(i=(o=(await this.ollamaApi.chat(c,void 0,{stream:!1})).message)==null?void 0:o.content)==null?void 0:i.trim();if(!d){console.log("[PersonaResponseService] No response generated");return}const p=d.length>this.config.maxResponseLength?d.substring(0,this.config.maxResponseLength-3)+"...":d;console.log("[PersonaResponseService] Generated response:",p),this.store.dispatch($S(n,e.id,e.name,void 0,p,!0))}catch(c){console.error("[PersonaResponseService] Error generating response for",e.name,c)}}}const FC=["gpt-oss:latest","gemma3:4b","gemma3:27b","qwen2.5:32b","qwen3:4b","qwen3:30b","qwen3-vl:latest","qwen3-vl:4b","granite3.2-vision","granite4:small-h","deepseek-r1:32b"],_d="gemma3:27b",di="http://192.168.2.70:11434";class zS{constructor(e=_d){this.model=e}async generateStructuredCompletion(e,t,n=this.model,r){return((r==null?void 0:r.useEndpoint)??"chat")==="chat"?this.generateStructuredCompletionWithChat(e,t,n,r):this.generateStructuredCompletionWithGenerate(e,t,n,r)}async generateStructuredCompletionWithChat(e,t,n,r){var l;const o=(r==null?void 0:r.system)??"You are a helpful assistant. Always respond in valid JSON format according to the provided schema.",i=await this.chat([{role:"system",content:o},{role:"user",content:e,images:r==null?void 0:r.images}],n,{format:t,stream:!1,signal:r==null?void 0:r.signal});console.log("ðŸ” Raw chat API result:",i);const c=(l=i.message)==null?void 0:l.content;if(console.log("ðŸ” Response type:",typeof c),console.log("ðŸ” Response value:",c),!c)throw console.error("âŒ Empty response from API:",i),new Error("Received empty response from Ollama API");if(typeof c=="string"){if(c.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(c)}catch(d){throw console.error("âŒ JSON parse error. Response was:",c),new Error(`Failed to parse JSON response: ${d instanceof Error?d.message:"Unknown error"}`)}}return c}async generateStructuredCompletionWithGenerate(e,t,n,r){const o=await this.generateCompletion(e,n,{...r,format:t});if(console.log("ðŸ” Raw generate API result:",o),console.log("ðŸ” Response type:",typeof o.response),console.log("ðŸ” Response value:",o.response),!o.response)throw console.error("âŒ Empty response from API:",o),new Error("Received empty response from Ollama API");if(typeof o.response=="string"){if(o.response.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(o.response)}catch(i){throw console.error("âŒ JSON parse error. Response was:",o.response),new Error(`Failed to parse JSON response: ${i instanceof Error?i.message:"Unknown error"}`)}}return o.response}async generateCompletion(e,t=this.model,n){var v;const{suffix:r,images:o,format:i,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f,onStreamChunk:m,signal:g}=n??{stream:!1},x=`${di}/api/generate`,b=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:e,suffix:r,images:o,format:i,options:n==null?void 0:n.options,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f}),signal:g});if(!b.ok)throw new Error(`HTTP error! status: ${b.status}`);if(d&&b.headers.get("Content-Type")==="application/x-ndjson"){const w=(v=b.body)==null?void 0:v.getReader(),y=new TextDecoder("utf-8");let j="",S="";for(;;){const{done:C,value:N}=await(w==null?void 0:w.read())??{};if(C)break;j+=y.decode(N,{stream:!0});const A=j.split(`
`);j=A.pop();for(const k of A)if(k.trim()){const E=JSON.parse(k);E.response&&(S+=E.response,m==null||m(E.response)),console.log(E)}}return{response:S}}else{const w=await b.json();return console.log("ðŸ“¥ Non-streaming API response:",w),w}}async chat(e,t=this.model,n){var u,f;const{stream:r,format:o,keep_alive:i,onStreamChunk:c,signal:l}=n??{},d=`${di}/api/chat`,p=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,format:o,stream:r,keep_alive:i}),signal:l});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);if(r&&p.headers.get("Content-Type")==="application/x-ndjson"){const m=(u=p.body)==null?void 0:u.getReader(),g=new TextDecoder("utf-8");let x="",b="";for(;;){const{done:v,value:w}=await(m==null?void 0:m.read())??{};if(v)break;x+=g.decode(w,{stream:!0});const y=x.split(`
`);x=y.pop();for(const j of y)if(j.trim()){const S=JSON.parse(j);(f=S.message)!=null&&f.content&&(b+=S.message.content,c==null||c(S.message.content)),console.log(S)}}return{message:{role:"assistant",content:b}}}else return await p.json()}}const HS=new zS(_d),va="game_current_user";function GS(){try{const s=localStorage.getItem(va);return s?JSON.parse(s):null}catch(s){return console.error("[gameReducer] Failed to load currentUser from localStorage:",s),null}}function Bs(s){try{s?localStorage.setItem(va,JSON.stringify(s)):localStorage.removeItem(va)}catch(e){console.error("[gameReducer] Failed to save currentUser to localStorage:",e)}}const qS={connectionState:"DISCONNECTED",isConnected:!1,currentUser:GS(),users:[],usersLoading:!1,usersError:null,games:[],gamesLoading:!1,gamesError:null,selectedGameId:null,chatMessages:{},chatLoading:!1,chatError:null,personas:{byId:{},byGameId:{},loading:!1,error:null},loading:!1,error:null};function ui(s=qS,e){var t,n,r,o,i;switch(e.type){case to:return{...s,loading:!0,error:null};case Bl:return{...s,loading:!1,isConnected:!0,error:null};case Wl:return{...s,loading:!1,isConnected:!1,error:e.error};case so:return{...s,isConnected:!1,connectionState:"DISCONNECTED"};case zl:return{...s,connectionState:e.payload,isConnected:e.payload==="CONNECTED"};case sd:{const c={...s,currentUser:e.payload};return Bs(e.payload),c}case Hl:return{...s,usersLoading:!0,usersError:null};case Gl:{const c={...s,usersLoading:!1,currentUser:e.payload,users:[...s.users,e.payload],usersError:null};return Bs(e.payload),c}case ql:return{...s,usersLoading:!1,usersError:e.error};case Vl:return{...s,usersLoading:!0,usersError:null};case Kl:{const c=((t=s.currentUser)==null?void 0:t.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((n=s.currentUser)==null?void 0:n.id)===e.payload.id&&Bs(e.payload),l}case Jl:return{...s,usersLoading:!1,usersError:e.error};case Yl:return{...s,usersLoading:!0,usersError:null};case Xl:{const c=e.payload,l=s.currentUser?c.find(p=>p.id===s.currentUser.id):null,d=l?s.currentUser:null;return!l&&s.currentUser&&(console.warn("[gameReducer] Current user not found in backend, clearing localStorage"),Bs(null)),{...s,usersLoading:!1,currentUser:d,users:c,usersError:null}}case Ql:return{...s,usersLoading:!1,usersError:e.error};case Zl:return{...s,usersLoading:!0,usersError:null};case ed:{const c=((r=s.currentUser)==null?void 0:r.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((o=s.currentUser)==null?void 0:o.id)===e.payload.id&&Bs(e.payload),l}case td:return{...s,usersLoading:!1,usersError:e.error};case nd:return{...s,users:e.payload};case lS:return{...s,gamesLoading:!0,gamesError:null};case dS:return{...s,gamesLoading:!1,games:[...s.games,e.payload],gamesError:null};case uS:return{...s,gamesLoading:!1,gamesError:e.error};case pS:return{...s,gamesLoading:!0,gamesError:null};case hS:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case fS:return{...s,gamesLoading:!1,gamesError:e.error};case mS:return{...s,gamesLoading:!0,gamesError:null};case gS:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case xS:return{...s,gamesLoading:!1,gamesError:e.error};case vS:return{...s,gamesLoading:!0,gamesError:null};case bS:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case wS:return{...s,gamesLoading:!1,gamesError:e.error};case yS:return{...s,gamesLoading:!0,gamesError:null};case SS:return{...s,gamesLoading:!1,games:s.games.filter(c=>c.id!==e.payload),gamesError:null};case jS:return{...s,gamesLoading:!1,gamesError:e.error};case CS:return{...s,gamesLoading:!0,gamesError:null};case NS:return{...s,gamesLoading:!1,games:e.payload,gamesError:null};case kS:return{...s,gamesLoading:!1,gamesError:e.error};case ES:return{...s,games:s.games.map(c=>c.id===e.payload.id?e.payload:c)};case IS:return{...s,games:s.games.filter(c=>c.id!==e.payload)};case rd:return{...s,chatLoading:!0,chatError:null};case ad:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]},chatError:null}}case od:return{...s,chatLoading:!1,chatError:e.error};case id:return{...s,chatLoading:!0,chatError:null};case cd:{if(e.payload.length===0)return{...s,chatLoading:!1,chatError:null};const c=e.payload[0].gameId;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:e.payload},chatError:null}}case ld:return{...s,chatLoading:!1,chatError:e.error};case dd:return{...s,chatLoading:!0,chatError:null};case ud:{const c=e.payload;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:[]},chatError:null}}case pd:return{...s,chatLoading:!1,chatError:e.error};case hd:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return l.find(d=>d.id===c.id)?s:{...s,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]}}}case fd:case xd:case wd:case jd:case kd:return{...s,personas:{...s.personas,loading:!0,error:null}};case md:case Td:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},byGameId:{...s.personas.byGameId,[c.gameId]:[...s.personas.byGameId[c.gameId]||[],c.id]},loading:!1}}}case vd:{const{personas:c}=e.payload,l={},d={};return c.forEach(p=>{l[p.id]=p,d[p.gameId]||(d[p.gameId]=[]),d[p.gameId].push(p.id)}),{...s,personas:{...s.personas,byId:{...s.personas.byId,...l},byGameId:{...s.personas.byGameId,...d},loading:!1}}}case yd:case Ad:case Ed:case Rd:case Dd:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},loading:!1}}}case Cd:case Pd:{const c="id"in e.payload?e.payload.id:e.payload.personaId,l=s.personas.byId[c];if(!l)return s;const{[c]:d,...p}=s.personas.byId,u=((i=s.personas.byGameId[l.gameId])==null?void 0:i.filter(f=>f!==c))||[];return{...s,personas:{...s.personas,byId:p,byGameId:{...s.personas.byGameId,[l.gameId]:u},loading:!1}}}case gd:case bd:case Sd:case Nd:case Id:return{...s,personas:{...s.personas,loading:!1,error:e.payload.error}};case TS:return{...s,selectedGameId:e.payload};case AS:return{...s,error:null,gamesError:null,usersError:null};default:return s}}const VS=()=>({type:fd}),KS=s=>({type:md,payload:{persona:s}}),JS=s=>({type:gd,payload:{error:s}}),YS=()=>({type:xd}),XS=s=>({type:vd,payload:{personas:s}}),QS=s=>({type:bd,payload:{error:s}}),ZS=()=>({type:wd}),e0=s=>({type:yd,payload:{persona:s}}),t0=s=>({type:Sd,payload:{error:s}}),s0=()=>({type:jd}),n0=s=>({type:Cd,payload:{id:s}}),r0=s=>({type:Nd,payload:{error:s}}),Od=()=>({type:kd}),Ld=s=>({type:Ed,payload:{persona:s}}),Md=s=>({type:Id,payload:{error:s}}),a0=s=>({type:Td,payload:{persona:s}}),o0=s=>({type:Ad,payload:{persona:s}}),i0=s=>({type:Pd,payload:{personaId:s}}),c0=s=>({type:Rd,payload:{persona:s}}),l0=s=>({type:Dd,payload:{persona:s}}),$C=(s,e,t,n)=>async r=>{r(VS());const o=await at.personaUseCases.createPersona.execute({gameId:s,name:e,description:t,emoji:n});o.isSuccess?r(KS(o.value.toJSON())):r(JS(o.error.message))},UC=s=>async e=>{e(YS());const t=await at.personaUseCases.getPersonas.execute(s);t.isSuccess?e(XS(t.value.map(n=>n.toJSON()))):e(QS(t.error.message))},BC=(s,e)=>async t=>{t(ZS());const n=await at.personaUseCases.updatePersona.execute(s,e);n.isSuccess?t(e0(n.value.toJSON())):t(t0(n.error.message))},WC=s=>async e=>{e(s0());const t=await at.personaUseCases.deletePersona.execute(s);t.isSuccess?e(n0(s)):e(r0(t.error.message))},zC=s=>async e=>{e(Od());const t=await at.personaUseCases.activatePersona.execute(s,!0);t.isSuccess?e(Ld(t.value.toJSON())):e(Md(t.error.message))},HC=s=>async e=>{e(Od());const t=await at.personaUseCases.activatePersona.execute(s,!1);t.isSuccess?e(Ld(t.value.toJSON())):e(Md(t.error.message))},d0=s=>{let e=!1;return t=>n=>{const r=t(n);if(n.type===to){if(e)return console.log("[WebSocket Middleware] Connection already initialized"),r;e=!0;const o=at.webSocketService,i=at.webSocketConfig;o.onMessage(c=>{switch(console.log("[WebSocket Middleware] Received message:",c.type),c.type){case"chat_message":{const d=c.message;d.isIntroduction&&d.isPersona?console.log(`[WebSocket Middleware] ðŸŽ­ Persona introduction received from ${d.senderUsername}:`,d.text):d.isPersona?console.log(`[WebSocket Middleware] ðŸ¤– Persona message received from ${d.senderUsername}:`,d.text):console.log("[WebSocket Middleware] Chat message received:",d),s.dispatch(FS(d));break}case"user_list":{const d=c.users;console.log("[WebSocket Middleware] User list updated:",d.length,"users"),s.dispatch(MS(d));break}case"game_update":{const d=c.game;console.log("[WebSocket Middleware] Game update received:",d.id);break}case"PERSONA_CREATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona created:",d.id),s.dispatch(a0(d));break}case"PERSONA_UPDATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona updated:",d.id),s.dispatch(o0(d));break}case"PERSONA_DELETED":{const d=c.personaId;console.log("[WebSocket Middleware] Persona deleted:",d),s.dispatch(i0(d));break}case"PERSONA_ACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona activated:",d.id),s.dispatch(c0(d));break}case"PERSONA_DEACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona deactivated:",d.id),s.dispatch(l0(d));break}case"error":{const d=c.message;console.error("[WebSocket Middleware] Error from server:",d);break}}}),o.onConnectionStateChange(c=>{if(s.dispatch(RS(c)),c===jt.CONNECTED){s.dispatch(PS());const d=s.getState().currentUser;d?(console.log(`[WebSocket Middleware] Sending JOIN message for user ${d.username} (${d.id})`),o.send({type:"join",userId:d.id,username:d.username}).catch(p=>{console.error("[WebSocket Middleware] Failed to send JOIN message:",p)})):console.warn("[WebSocket Middleware] No currentUser available to send JOIN message")}else c===jt.ERROR&&s.dispatch(li("WebSocket connection failed"))}),o.connect(i).then(()=>{console.log("[WebSocket Middleware] Successfully connected")}).catch(c=>{console.error("[WebSocket Middleware] Connection error:",c),s.dispatch(li(c instanceof Error?c.message:"Unknown connection error")),e=!1})}return n.type===so&&at.webSocketService.disconnect().then(()=>{console.log("[WebSocket Middleware] Disconnected"),e=!1}).catch(i=>{console.error("[WebSocket Middleware] Disconnect error:",i),e=!1}),r}},u0=s=>e=>t=>e(t),p0=s=>e=>t=>typeof t=="function"?t(s.dispatch,s.getState):e(t);function h0(s=!0){let e=ui(void 0,{type:"@@INIT"});const t=new Set,n={getState(){return e},dispatch(r){let o=i=>(e=ui(e,i),t.forEach(c=>c()),i);return o=d0(n)(o),o=p0(n)(o),s&&(o=u0()(o)),o(r)},subscribe(r){return t.add(r),()=>{t.delete(r)}}};return n}class f0{constructor(){Z(this,"_httpService",null);Z(this,"_webSocketService",null);Z(this,"_gameRepository",null);Z(this,"_userRepository",null);Z(this,"_chatRepository",null);Z(this,"_personaRepository",null);Z(this,"_store",null);Z(this,"_gameApplicationService",null);Z(this,"_config",null);Z(this,"_personaUseCases",null);Z(this,"_personaResponseService",null);Z(this,"_logger",null)}get config(){if(!this._config){const e=()=>`http://${window.location.hostname}:3030/api/multiplayer`,t=()=>`ws://${window.location.hostname}:3030/multiplayer`;this._config={httpApiBaseUrl:e(),webSocketUrl:t(),enableLogging:!0,webSocketReconnectInterval:parseInt("3000",10),webSocketMaxReconnectAttempts:parseInt("10",10),webSocketHeartbeatInterval:parseInt("30000",10),clientLogsEnabled:!0,clientLogsApiBaseUrl:"http://localhost:3030/client-logs"}}return this._config}get httpService(){return this._httpService||(this._httpService=new Qy(this.config.httpApiBaseUrl,5e3)),this._httpService}get webSocketService(){return this._webSocketService||(this._webSocketService=new Zy),this._webSocketService}get gameRepository(){return this._gameRepository||(this._gameRepository=new eS(this.httpService)),this._gameRepository}get userRepository(){return this._userRepository||(this._userRepository=new tS(this.httpService)),this._userRepository}get chatRepository(){return this._chatRepository||(this._chatRepository=new sS(this.httpService)),this._chatRepository}get personaRepository(){return this._personaRepository||(this._personaRepository=new nS(this.httpService)),this._personaRepository}get personaUseCases(){if(!this._personaUseCases){const e=this.personaRepository,t=this.logger;this._personaUseCases={createPersona:new rS(e,t),getPersonas:new aS(e),updatePersona:new oS(e,t),deletePersona:new iS(e,t),activatePersona:new cS(e,t)}}return this._personaUseCases}get clientLogsApiClient(){return Pr.clientLogsApiClient}get clientLogsService(){return Pr.clientLogsService}get logger(){return Pr.logger}get gameApplicationService(){return this._gameApplicationService||(this._gameApplicationService=new Xy(this.userRepository,this.chatRepository,this.webSocketService,this.logger)),this._gameApplicationService}get store(){return this._store||(this._store=h0(this.config.enableLogging)),this._store}get personaResponseService(){return this._personaResponseService||(this._personaResponseService=new WS(HS,this.store)),this._personaResponseService}get webSocketConfig(){return{url:this.config.webSocketUrl,reconnectInterval:this.config.webSocketReconnectInterval,maxReconnectAttempts:this.config.webSocketMaxReconnectAttempts,heartbeatInterval:this.config.webSocketHeartbeatInterval}}reset(){this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._personaResponseService=null,this._store=null,this._gameApplicationService=null,this._config=null}setHttpService(e){this._httpService=e,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._gameApplicationService=null}setWebSocketService(e){this._webSocketService=e,this._gameApplicationService=null}setGameRepository(e){this._gameRepository=e,this._gameApplicationService=null}setUserRepository(e){this._userRepository=e,this._gameApplicationService=null}setGameApplicationService(e){this._gameApplicationService=e}setLogger(e){this._logger=e,this._gameApplicationService=null}setConfig(e){this._config={...this.config,...e},this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._gameApplicationService=null,this._store=null}}const at=new f0,m0="backspace-debug.log";let g0=0;function pi(){return++g0}function xr(s,e){at.clientLogsApiClient.sendLogs(s,e,m0)}function hi(s,e,t,n,r,o){const i=o.substring(Math.max(0,n-5),n),c=o.substring(n,Math.min(o.length,n+5)),l=n>0?o[n-1]:"<none>";xr(`${e.toUpperCase()}_BEFORE`,{eventId:s,key:e,mode:t,cursorPos:n,selectionEnd:r,hasSelection:n!==r,textLength:o.length,charToDelete:e==="Backspace"?l:void 0,charToDeleteCode:e==="Backspace"&&l!=="<none>"?l.charCodeAt(0):void 0,context5Before:i,context5After:c,contextVisual:`"${i}|${c}"`,fullText:o.length<200?o:`${o.substring(0,100)}...(${o.length} chars)...${o.substring(o.length-50)}`})}function x0(s,e,t,n,r,o){const{text:i,cursorPos:c}=t,l=i.substring(Math.max(0,c-5),c),d=i.substring(c,Math.min(i.length,c+5));xr(`${e.toUpperCase()}_AFTER`,{eventId:s,newCursorPos:c,newTextLength:i.length,context5Before:l,context5After:d,contextVisual:`"${l}|${d}"`,cursorDelta:c-r,textDelta:i.length-o,expectedCursorPos:n,cursorMismatch:c!==n})}function fi(s,e,t){xr(`${e}_ACTION`,{eventId:s,actionType:e,action:{selectionStart:t.selectionStart,selectionEnd:t.selectionEnd,textToInsert:t.textToInsert,newCursorPosition:t.newCursorPosition}})}function mi(s,e,t){xr(`BACKSPACE_PREVIEW_${e}`,{eventId:s,...t})}function v0(s){const{editorRef:e,isRawMode:t,getTextAndCursor:n,applyAction:r,useRichEditing:o,setInternalValue:i,onChange:c}=s,l=h.useCallback((m,g,x,b,v)=>{setTimeout(()=>{const w=n();w&&x0(m,g,w,v,x,b)},10)},[n]),d=h.useCallback((m,g,x,b)=>{if(e.current){if(x===b&&x>0){const v=g.substring(0,x-1)+g.substring(x),w=x-1;mi(m,"DELETE",{deletedChar:g[x-1],deletedCharCode:g.charCodeAt(x-1),oldCursorPos:x,newCursorPos:w,oldTextLength:g.length,newTextLength:v.length});const y=it(v);e.current.innerHTML=y,rn(e.current,w),i(v),c==null||c(v),l(m,"Backspace",x,g.length,w)}else if(x!==b){const v=g.substring(0,x)+g.substring(b),w=x;mi(m,"DELETE_SELECTION",{deletedText:g.substring(x,b),selectionStart:x,selectionEnd:b,newCursorPos:w});const y=it(v);e.current.innerHTML=y,rn(e.current,w),i(v),c==null||c(v)}}},[e,i,c,l]),p=h.useCallback((m,g,x)=>{const b=pi(),{selectionStart:v,selectionEnd:w}=x;hi(b,"Backspace",t?"raw":"preview",v,w,g);const y=Bf(g,v,w);return y?(m.preventDefault(),fi(b,"BACKSPACE",{selectionStart:y.selectionStart,selectionEnd:y.selectionEnd,textToInsert:y.textToInsert,newCursorPosition:y.newCursorPosition}),r(y,g),l(b,"Backspace",v,g.length,y.newCursorPosition),!0):t?!1:(m.preventDefault(),d(b,g,v,w),!0)},[t,r,l,d]),u=h.useCallback((m,g,x)=>{if(!o||m.shiftKey)return!1;const b=pi(),{selectionStart:v,selectionEnd:w}=x;hi(b,"Enter",t?"raw":"preview",v,w,g);const y=_c(g,v,w);return fi(b,"ENTER",{selectionStart:y.selectionStart,selectionEnd:y.selectionEnd,textToInsert:JSON.stringify(y.textToInsert),newCursorPosition:y.newCursorPosition}),m.preventDefault(),r(y,g),l(b,"Enter",v,g.length,y.newCursorPosition),!0},[o,t,r,l]),f=h.useCallback((m,g,x)=>{if(!o)return!1;m.preventDefault();const b=m.shiftKey?Lc(g,x.selectionStart,x.selectionEnd):Oc(g,x.selectionStart,x.selectionEnd);return r(b,g),!0},[o,r]);return{handleBackspace:p,handleEnter:u,handleTab:f}}function b0(s){switch(s){case"strong":return"**";case"em":return"*";case"code":return"`";case"del":return"~~";case"blockquote":return"> ";default:return""}}function w0(s){const{editorRef:e,editingRawMarkdownRef:t,isRawMode:n,allowRawPreviewOnClick:r,handleInput:o}=s,i=h.useCallback((d,p)=>{var S;d.preventDefault();const u=p.textContent||"",f=p.tagName.toLowerCase(),m=b0(f);if(!m)return;t.current=!0;const g=window.getSelection();if(!g||g.rangeCount===0)return;const x=g.getRangeAt(0);let b=0;if(p.contains(x.startContainer)){const C=document.createRange();C.selectNodeContents(p),C.setEnd(x.startContainer,x.startOffset);const N=document.createElement("div");N.appendChild(C.cloneContents()),b=((S=N.textContent)==null?void 0:S.length)||0}const v=f==="blockquote"?`${m}${u}`:`${m}${u}${m}`,w=document.createTextNode(v);p.replaceWith(w);const y=document.createRange(),j=m.length+b;y.setStart(w,j),y.setEnd(w,j),g.removeAllRanges(),g.addRange(y),o()},[t,o]),c=h.useCallback(()=>{var m;if(!e.current)return;t.current=!1;const d=window.getSelection();let p=0;if(d&&d.rangeCount>0){const g=d.getRangeAt(0),x=g.cloneRange();x.selectNodeContents(e.current),x.setEnd(g.startContainer,g.startOffset);const b=document.createElement("div");b.appendChild(x.cloneContents());const v=b.textContent||"";p=v.length;let w=0;for(let y=0;y<Math.min(p,v.length);y++){const j=v[y],S=v[y+1];j==="*"&&S==="*"?(w+=2,y++):(j==="*"||j==="_"||j==="`"||j==="~")&&w++}p=p-w}const u=ms(e.current.innerHTML),f=it(u);if(e.current.innerHTML!==f&&(e.current.innerHTML=f,d&&d.rangeCount>0)){let g=0;const x=document.createTreeWalker(e.current,NodeFilter.SHOW_TEXT);let b=x.nextNode(),v=!1;for(;b&&!v;){const w=((m=b.textContent)==null?void 0:m.length)||0;if(g+w>=p){const y=p-g,j=document.createRange();j.setStart(b,y),j.setEnd(b,y),d.removeAllRanges(),d.addRange(j),v=!0}else g+=w,b=x.nextNode()}}},[e,t]);return{handleClick:h.useCallback(d=>{if(!e.current||!r||n)return;const u=d.target.closest("strong, em, code, del, blockquote");u?i(d,u):t.current&&c()},[e,r,n,t,i,c])}}function y0(s){const e=window.getSelection();let t=s;return e&&e.rangeCount>0&&!e.isCollapsed&&(t=s+e.toString().length),{selectionStart:s,selectionEnd:t,hasSelection:s!==t}}function S0(s){const{editorRef:e,editingRawMarkdownRef:t,applyingActionRef:n,value:r,isRawMode:o,useRichEditing:i,keyboard:c,allowRawPreviewOnClick:l,setInternalValue:d,onChange:p,onKeyDown:u,onPaste:f}=s,{getTextAndCursor:m,applyAction:g}=Uy({editorRef:e,applyingActionRef:n,value:r,isRawMode:o,setInternalValue:d,onChange:p}),{handleAutoWrap:x,handleFormatShortcut:b,shouldPassThrough:v}=By({applyAction:g}),{handleBackspace:w,handleEnter:y,handleTab:j}=v0({editorRef:e,isRawMode:o,getTextAndCursor:m,applyAction:g,useRichEditing:i,setInternalValue:d,onChange:p}),S=h.useCallback(()=>{if(!e.current)return;if(o){const R=eo(e.current);r===void 0&&d(R),p==null||p(R);return}const k=e.current.innerHTML;let E=ms(k);if(c===Za.VI){const{cursorPos:R}=xa(e.current),M=E,L=R,T=ky(M,L);if(T.found){const W=Iy(M,L,T.sequenceStart,T.detectedBaseChar);if(W.type==="auto-complete"&&W.replacement){E=W.replacement;const z=W.newCursorPos??E.length;e.current.innerHTML=it(E),rn(e.current,z)}}}r===void 0&&d(E),p==null||p(E)},[p,r,c,o,e,d]),{handleClick:C}=w0({editorRef:e,editingRawMarkdownRef:t,isRawMode:o,allowRawPreviewOnClick:l,handleInput:S}),N=h.useCallback(k=>{const E=m();if(!E||!e.current){u==null||u(k);return}const{text:R,cursorPos:M}=E,L=y0(M);if(x(k,R,L)){u==null||u(k);return}if(b(k,R,L)){u==null||u(k);return}if(v(k)){u==null||u(k);return}if(k.key==="Backspace"&&w(k,R,L)){u==null||u(k);return}if(k.key==="Enter"&&y(k,R,L)){u==null||u(k);return}if(k.key==="Tab"&&j(k,R,L)){u==null||u(k);return}u==null||u(k)},[m,x,b,v,w,y,j,e,u]),A=h.useCallback(k=>{k.preventDefault();const E=k.clipboardData.getData("text/plain"),R=E.split(`
`);if(R.length===1)document.execCommand("insertText",!1,E);else{const M=window.getSelection();if(!M||M.rangeCount===0)return;const L=M.getRangeAt(0);L.deleteContents();const T=document.createDocumentFragment();R.forEach((z,te)=>{te>0&&T.appendChild(document.createElement("br")),z&&T.appendChild(document.createTextNode(z))}),L.insertNode(T),L.collapse(!1),M.removeAllRanges(),M.addRange(L);const W=e.current;W&&W.dispatchEvent(new Event("input",{bubbles:!0}))}f==null||f()},[e,f]);return{handleInput:S,handleClick:C,handleKeyDown:N,handlePaste:A}}function j0(s){const{editorRef:e,editingRawMarkdownRef:t,currentModeRef:n,applyingActionRef:r,currentValue:o,isFocused:i,allowRawPreviewOnClick:c}=s;h.useEffect(()=>{if(!e.current||r.current)return;const l=n.current,d=l==="raw"?e.current.textContent||"":ms(e.current.innerHTML);if(d===o)return;const p=o.startsWith(d)&&o.length>d.length;if((!i||p)&&(l==="raw"?e.current.textContent=o:e.current.innerHTML=it(o),i&&p)){const u=document.createRange(),f=window.getSelection();u.selectNodeContents(e.current),u.collapse(!1),f==null||f.removeAllRanges(),f==null||f.addRange(u)}},[o,i,e,n,r]),h.useEffect(()=>{if(!i||!e.current||!c)return;const l=()=>{if(t.current)return;const d=window.getSelection();if(!(!d||!e.current)&&d.isCollapsed&&e.current.contains(d.anchorNode)){const p=ms(e.current.innerHTML),u=it(p);if(e.current.innerHTML!==u){const f=d.getRangeAt(0),m=f.cloneRange();m.selectNodeContents(e.current),m.setEnd(f.startContainer,f.startOffset);const g=document.createElement("div");g.appendChild(m.cloneContents());const x=ms(g.innerHTML).length;e.current.innerHTML=u,rn(e.current,x)}}};return document.addEventListener("selectionchange",l),()=>{document.removeEventListener("selectionchange",l)}},[i,o,c,e,t])}const Fd=h.forwardRef(({value:s,defaultValue:e,onChange:t,onBlur:n,onKeyDown:r,onPaste:o,className:i,style:c,placeholder:l,readOnly:d=!1,useRichEditing:p=!0,allowRawPreviewOnClick:u=!1,showHints:f=!0,showAudioButton:m=!1,audioButtonVariant:g="default",autoStartAudioRecording:x=!1,onAudioTranscription:b,getTextAreaElement:v,audioNodeId:w,keyboard:y=Dl,showConfigButton:j=!0,mode:S,onModeChange:C,...N},A)=>{const k=bs(),[E,R]=h.useState(e||""),[M,L]=h.useState(!1),T=h.useRef(null),W=h.useRef(!1),z=h.useRef("preview"),te=h.useRef(!1),O=h.useRef(!1),ee=h.useRef(!1),[I,_]=h.useState(()=>{try{const G=localStorage.getItem("watcher-markdown-textarea-mode");if(G==="raw"||G==="preview")return G}catch{}return"preview"}),F=S??I,q=S!==void 0?G=>C==null?void 0:C(G):_,J=F==="raw";h.useEffect(()=>{if(S===void 0)try{localStorage.setItem("watcher-markdown-textarea-mode",F)}catch{}},[F,S]),h.useEffect(()=>{z.current=F,te.current=!1,O.current=!1},[F]);const P=s!==void 0?s:E,B=!P||P.trim()==="",se=h.useRef(P);O.current||(O.current=!0,se.current=P);const le=h.useRef(F),me=h.useRef(s!==void 0?s:E);me.current=s!==void 0?s:E;const ae=h.useRef(null);ae.current||(ae.current=G=>{const de=G.target.closest("a");if(de){G.preventDefault(),G.stopPropagation();const pe=de.getAttribute("href");if(pe){const fe=document.createElement("a");fe.href=pe,fe.target="_blank",fe.rel="noopener noreferrer",fe.style.display="none",document.body.appendChild(fe),fe.click(),document.body.removeChild(fe)}}});const H=h.useCallback(G=>{const oe=F!==le.current;if(le.current=F,T.current&&ae.current&&T.current.removeEventListener("click",ae.current,!0),T.current=G,G&&F!=="raw"&&ae.current&&G.addEventListener("click",ae.current,!0),G&&(oe||!te.current)){te.current=!0;const de=me.current;F==="raw"?G.textContent=de:G.innerHTML=it(de)}},[F]);h.useImperativeHandle(A,()=>({getElement:()=>T.current,getValue:()=>P,setValue:G=>{if(s===void 0&&R(G),T.current){const oe=it(G);T.current.innerHTML=oe;const de=document.createRange(),pe=window.getSelection();de.selectNodeContents(T.current),de.collapse(!1),pe==null||pe.removeAllRanges(),pe==null||pe.addRange(de)}t==null||t(G)},focus:()=>{var G;(G=T.current)==null||G.focus()}})),j0({editorRef:T,editingRawMarkdownRef:W,currentModeRef:z,applyingActionRef:ee,currentValue:P,isFocused:M,allowRawPreviewOnClick:u});const{handleInput:X,handleClick:ge,handleKeyDown:ce,handlePaste:Ae}=S0({editorRef:T,editingRawMarkdownRef:W,applyingActionRef:ee,value:s,isRawMode:J,useRichEditing:p,keyboard:y,allowRawPreviewOnClick:u,setInternalValue:R,onChange:t,onKeyDown:r,onPaste:o}),Ce=h.useCallback(()=>{L(!0)},[]),ve=h.useCallback(G=>{b==null||b(G)},[b]),$=h.useCallback(()=>T.current,[]),re=h.useCallback(G=>{L(!1);const oe=z.current;T.current&&(oe==="raw"?T.current.textContent!==P&&(T.current.textContent=P):T.current.innerHTML=it(P)),n==null||n(G)},[P,n]);return a.jsxs("div",{className:"markdown-textarea-container h-full","data-test":"markdown-textarea-container",children:[a.jsxs("div",{className:"markdown-textarea-wrapper relative h-full","data-test":"markdown-textarea-wrapper",children:[a.jsx("div",{ref:H,contentEditable:!d,onInput:X,onClick:J?void 0:ge,onFocus:Ce,onBlur:re,spellCheck:!1,onKeyDown:ce,onPaste:Ae,className:U("markdown-textarea min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm","ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50",!J&&"[&_strong]:font-bold [&_em]:italic [&_del]:line-through",!J&&"[&_code]:bg-muted [&_code]:px-1 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono",d&&"cursor-default",i),style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:k?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:k?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...c},suppressContentEditableWarning:!0,"data-node-textarea":N["data-node-textarea"],"data-test":`markdown-textarea-editor${J?"-raw":""}`},F),B&&!M&&l&&a.jsx("div",{className:"absolute top-2 left-3 text-sm text-muted-foreground pointer-events-none","aria-hidden":!0,"data-test":"markdown-textarea-placeholder",children:l}),a.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:tt.nodeAudioButton},onMouseDownCapture:G=>G.preventDefault(),children:[j&&a.jsx(dr,{compact:!0,label:J?a.jsx(ho,{className:"h-3 w-3"}):a.jsx(Hr,{className:"h-3 w-3"}),onAction:()=>{const G=J?"preview":"raw";q(G),C==null||C(G)},variant:"ghost",size:"icon",buttonClassName:"p-1 h-auto w-auto rounded-md transition-colors text-muted-foreground/40 hover:text-foreground hover:bg-accent",configOptions:[{label:"Preview",value:"preview",icon:a.jsx(Hr,{className:"h-4 w-4"}),onClick:()=>{q("preview"),C==null||C("preview")}},{label:"Raw Markdown",value:"raw",icon:a.jsx(ho,{className:"h-4 w-4"}),onClick:()=>{q("raw"),C==null||C("raw")}}],tooltipText:`${J?"Raw":"Preview"} mode (click to toggle, hold for options)`,ariaLabel:"Toggle markdown display mode","data-test":"markdown-mode-toggle"}),m&&a.jsx(_l,{onTranscriptionComplete:ve,sessionName:"markdown-textarea",getTextAreaElement:v||$,variant:g,autoStartRecording:x,nodeId:w,language:y,"data-test":"markdown-textarea-audio-button"})]})]}),f&&a.jsxs("div",{className:"markdown-hints text-xs text-muted-foreground mt-1 flex gap-3 flex-wrap","data-test":"markdown-textarea-hints",children:[a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+B"})," Bold"]}),a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+I"})," Italic"]}),a.jsx("span",{children:"**bold** *italic* `code` > quote"}),p&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"text-muted-foreground/50",children:"|"}),a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Tab"})," Indent"]}),a.jsx("span",{children:"Auto-list on Enter"})]})]})]})});Fd.displayName="MarkdownTextarea";const $d=Math.round(rt.LINE_HEIGHT*2/3),C0=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath},N0=(s,e)=>{const n=s.value.substring(0,e),r=(n.match(/\n/g)||[]).length,o=n.lastIndexOf(`
`),i=n.substring(o+1),c=window.getComputedStyle(s),l=parseFloat(c.paddingLeft)||0,p=document.createElement("canvas").getContext("2d");let u=0;p&&(p.font=`${c.fontSize} ${c.fontFamily}`,u=p.measureText(i).width);const f=l+u;return{top:r*rt.LINE_HEIGHT+$d,left:f}},gi=(s,e)=>{let t=-1;for(let o=e;o>=0;o--){if(s[o]==="@"){t=o;break}if(s[o]===" "||s[o]===`
`||s[o]==="	")break}if(t===-1)return null;let n=t+1;for(;n<s.length;){const o=s[n];if(o===" "||o===`
`||o==="	")break;n++}const r=s.substring(t,n);return r.startsWith("@")&&r.includes("/")?{start:t,end:n,path:r}:null},as=h.forwardRef(({defaultValue:s,value:e,onChange:t,onBlur:n,onFocus:r,onKeyDown:o,onMouseDown:i,onClick:c,onPaste:l,onPasteComplete:d,className:p,style:u,placeholder:f,onSelectionChange:m,onFileSelect:g,logger:x,showBuiltInPopover:b=!1,showFilePicker:v=!0,showCopyButton:w=!1,showAudioButton:y=!0,showConfigButton:j=!0,audioButtonVariant:S="default",autoStartAudioRecording:C=!1,onAudioTranscriptionComplete:N,audioNodeId:A,readOnly:k=!1,rows:E,autoFocus:R=!1,useMarkdown:M=!1,showMarkdownHints:L=!1,keyboard:T=Dl,onModeChange:W},z)=>{const[te,O]=h.useState(!1),[ee,I]=h.useState({top:0,left:0}),[_,F]=h.useState(500),[q,J]=h.useState(null),[P,B]=h.useState(!1),[se,le]=h.useState(!1),[me,ae]=h.useState(!1),H=h.useRef(null),X=h.useRef(null),ge=h.useRef(null),ce=h.useRef(null),Ae=h.useRef(null),Ce=h.useCallback(()=>{B(!0),se&&(O(!0),le(!1))},[se]),ve=Le(C0),$=bs();h.useEffect(()=>{var je;const K=(je=H.current)==null?void 0:je.getTextArea();if(!K)return;const he=Ie=>{const Te=Ie.relatedTarget;!((Te==null?void 0:Te.closest('[data-test="textarea-file-picker-popover-content"]'))!==null)&&te&&(O(!1),J(null),ae(!1))};return K.addEventListener("blur",he),()=>{K.removeEventListener("blur",he)}},[te]),h.useImperativeHandle(z,()=>({getTextArea:()=>{var K,he;return M?(K=X.current)==null?void 0:K.getElement():((he=H.current)==null?void 0:he.getTextArea())??null},insertTextAtStart:K=>{var he,je;M?(he=X.current)==null||he.focus():(je=H.current)==null||je.insertTextAtStart(K)},focus:()=>{var K,he,je;M?(K=X.current)==null||K.focus():(je=(he=H.current)==null?void 0:he.getTextArea())==null||je.focus()}}),[M]);const re=h.useCallback(K=>{var he,je,Ie,Te;if(M){const Ne=((he=X.current)==null?void 0:he.getValue())??"",_e=Ne.trim()?" ":"",Me=Ne+_e+K;(je=X.current)==null||je.setValue(Me);const Be={target:{value:Me},currentTarget:{value:Me}};t==null||t(Be)}else{const Ne=(Ie=H.current)==null?void 0:Ie.getTextArea();if(!Ne)return;const _e=Ne.value,Me=_e.trim()?" ":"",Be=_e+Me+K,ze=(Te=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Te.set;ze?ze.call(Ne,Be):Ne.value=Be;const lt=new Event("input",{bubbles:!0});Ne.dispatchEvent(lt)}N==null||N()},[M,t,N]),G=h.useCallback(()=>{var K;return((K=X.current)==null?void 0:K.getElement())??null},[]),oe=h.useCallback(()=>{var K;return((K=H.current)==null?void 0:K.getTextArea())??null},[]),de=h.useCallback(()=>{var Ie;if(q===null)return"";const K=(Ie=H.current)==null?void 0:Ie.getTextArea();if(!K)return"";const he=K.value,je=K.selectionStart;return he.substring(q+1,je)},[q]),pe=h.useCallback((K,he)=>{for(let je=he-1;je>=0;je--){const Ie=K[je];if(Ie===" "||Ie===`
`||Ie==="	")return null;if(Ie==="@"){const Te=je>0?K[je-1]:null;return Te===null||Te===" "||Te===`
`||Te==="	"?je:null}}return null},[]),fe=K=>{var Te;if(!v)return!1;const he=K.selectionStart,je=K.value,Ie=pe(je,he);if(Ie!==null){const Ne=(Te=H.current)==null?void 0:Te.getTextArea();if(Ne){const _e=Ne.getBoundingClientRect(),Me=N0(Ne,he);I(Me),F(_e.width),ae(!0)}return q!==Ie&&J(Ie),!te&&!se&&(P?(O(!0),x==null||x.info("@ character detected - showing file picker")):(le(!0),x==null||x.info("@ character detected - waiting for files to load"))),!0}else(te||se)&&(O(!1),le(!1),J(null),ae(!1));return!1},be=K=>{const he=K.target;fe(he),t==null||t(K)},Pe=K=>{const he=K.currentTarget;setTimeout(()=>{fe(he)},0)},Ee=K=>{const he=K.currentTarget;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(K.key)&&fe(he)},V=h.useCallback(K=>{var je,Ie;if(!te||!ce.current)return!1;const he=de();switch(K.key){case"ArrowDown":return K.preventDefault(),ce.current.navigate("down"),!0;case"ArrowUp":return K.preventDefault(),ce.current.navigate("up"),!0;case"Enter":return K.preventDefault(),ce.current.selectCurrent(),!0;case"Tab":if(he.startsWith("/")){K.preventDefault();const Te=ce.current.tabComplete();if(Te&&q!==null){const Ne=(je=H.current)==null?void 0:je.getTextArea();if(Ne){const _e=Ne.value.substring(0,q+1),Me=Ne.value.substring(Ne.selectionStart),Be=_e+Te+Me,ze=q+1+Te.length,lt=(Ie=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Ie.set;lt?lt.call(Ne,Be):Ne.value=Be,Ne.setSelectionRange(ze,ze),Ne.dispatchEvent(new Event("input",{bubbles:!0}))}}return!0}return!1;case"Escape":return K.preventDefault(),O(!1),J(null),!0;default:return!1}},[te,de,q]),D=h.useCallback(K=>{V(K)||o==null||o(K)},[V,o]),Y=(K,he)=>{var je,Ie;if(m==null||m(K,he),!!v)if(K.length>0){const Te=K.toLowerCase()==="file",Ne=(je=H.current)==null?void 0:je.getTextArea();let _e=null;if(Ne){const Me=Ne.value,Be=Ne.selectionStart;_e=gi(Me,Be)}Te||_e?(O(!0),he&&I(he),Te?(J(null),x==null||x.info('Word "file" selected - showing file picker')):(J(null),x==null||x.info(`File path "${_e==null?void 0:_e.path}" detected - showing file picker to replace`))):(O(!1),J(null),ae(!1))}else{const Te=(Ie=H.current)==null?void 0:Ie.getTextArea();if(Te&&pe(Te.value,Te.selectionStart)!==null)return;O(!1),J(null),ae(!1)}},we=K=>{var he;if(O(K),!K){ae(!1);const je=(he=H.current)==null?void 0:he.getTextArea();je&&je.focus()}},ne=K=>{var Ke;const he=(Ke=H.current)==null?void 0:Ke.getTextArea();if(!he)return;he.focus();const je=he.value,Ie=he.selectionStart,Ne=he.value.substring(he.selectionStart,he.selectionEnd).toLowerCase()==="file",_e=gi(je,Ie);let Me,Be,ze;if(q!==null)Me=q,Be=Ie,ze="@"+K.path+" ";else if(Ne)Me=he.selectionStart,Be=he.selectionEnd,ze="@"+K.path+" ";else if(_e)Me=_e.start,Be=_e.end,ze="@"+K.path+" ";else{O(!1),J(null),ae(!1);return}if(he.setSelectionRange(Me,Be),!document.execCommand("insertText",!1,ze)){const nt=he.value.substring(0,Me),gt=he.value.substring(Be);he.value=nt+ze+gt,he.setSelectionRange(Me+ze.length,Me+ze.length),he.dispatchEvent(new Event("input",{bubbles:!0}))}if(q!==null){const nt=je.substring(q,Ie);x==null||x.info(`Replaced "${nt}" with: ${ze}`)}else Ne?x==null||x.info(`Replaced "file" with: ${ze}`):_e&&(x==null||x.info(`Replaced "${_e.path}" with: ${ze}`));g==null||g(K),O(!1),J(null),ae(!1)},xe=h.useCallback(K=>{const he={target:{value:K},currentTarget:{value:K}};t==null||t(he)},[t]);return a.jsxs(st,{open:te&&me,onOpenChange:we,modal:!1,"data-test":"textarea-file-picker-popover",children:[a.jsxs("div",{ref:Ae,className:"textarea-with-file-picker relative w-full h-full","data-test":"textarea-file-picker-container",onMouseDown:K=>{K.stopPropagation()},onClick:K=>{K.stopPropagation()},children:[M?a.jsx("div",{className:"relative w-full h-full",onMouseDown:i,onPaste:l,onClick:K=>{Pe(K),c==null||c(K)},onKeyUp:Ee,children:a.jsx(Fd,{ref:X,defaultValue:s,value:e,onChange:xe,onBlur:n,onKeyDown:o,onPaste:d,className:p,style:u,placeholder:f,readOnly:k,useRichEditing:!0,showHints:L,showAudioButton:y,showConfigButton:j,audioButtonVariant:S,autoStartAudioRecording:C,onAudioTranscription:re,getTextAreaElement:G,audioNodeId:A,keyboard:T,onModeChange:W,"data-node-textarea":!0,"data-test":"textarea-file-picker-markdown-textarea"})}):a.jsx(Ol,{ref:H,defaultValue:s,value:e,onChange:be,onBlur:n,onFocus:r,onKeyDown:D,onMouseDown:i,onPaste:l,onClick:K=>{Pe(K),c==null||c(K)},onKeyUp:Ee,className:p,style:u,onSelectionChange:Y,placeholder:f,showBuiltInPopover:b,showCopyButton:w,showAudioButton:y,audioButtonVariant:S,onAudioTranscription:re,getTextAreaElement:oe,readOnly:k,rows:E,autoFocus:R,keyboard:T,"data-test":"textarea-file-picker-selectable-textarea"}),v&&a.jsx(Tn,{ref:ge,style:{position:"absolute",top:`${ee.top}px`,left:`${ee.left}px`,width:"1px",height:"1px"},"data-test":"textarea-file-picker-popover-anchor"}),v&&!P&&a.jsx("div",{className:"hidden",children:a.jsx(fa,{maxResults:1,cwd:ve??void 0,onLoadComplete:Ce,"data-test":"textarea-file-picker-preloader"})})]}),v&&a.jsxs(Xe,{className:"file-picker-popover p-0 border-none",side:"bottom",align:"start",sideOffset:$d,avoidCollisions:!0,collisionPadding:16,style:{zIndex:tt.draggablePopoverDropdown,width:`${Math.round(_*.7)}px`},onOpenAutoFocus:K=>K.preventDefault(),onCloseAutoFocus:K=>K.preventDefault(),onInteractOutside:K=>K.preventDefault(),onPointerDownOutside:K=>K.preventDefault(),"data-test":"textarea-file-picker-popover-content",children:[a.jsx(fa,{ref:ce,onFileSelect:ne,maxResults:$?5:10,placeholder:"Search for a file...",mode:"fileNameOnly",cwd:ve??void 0,externalSearchQuery:de(),hideSearchInput:!0,"data-test":"textarea-file-picker-file-picker"}),a.jsx("div",{className:"text-[10px] text-muted-foreground p-1","data-test":"textarea-file-picker-popover-description",children:'Type to filter. Use "/" for directory navigation, Tab to autocomplete.'})]})]})});as.displayName="TextareaWithFilePicker";const Ud=h.forwardRef(({className:s,style:e,...t},n)=>{const r=bs();return a.jsx("textarea",{className:U("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),style:{fontSize:r?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:r?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...e},ref:n,...t})});Ud.displayName="Textarea";const k0=[];function E0({sessionId:s,isVisible:e,onClose:t,onSendMessage:n,triggerPosition:r}){const o=Le(u=>{var f,m,g,x;return((x=(g=(m=(f=u.app)==null?void 0:f.claude)==null?void 0:m.ui)==null?void 0:g.messageQueues)==null?void 0:x[s])??k0}),i=u=>{var g,x,b,v,w,y;const f=ie.getState(),m=((b=(x=(g=f.app)==null?void 0:g.claude)==null?void 0:x.ui)==null?void 0:b.messageQueues)??{};ie.updateState({app:{...f.app,claude:{...(v=f.app)==null?void 0:v.claude,ui:{...(y=(w=f.app)==null?void 0:w.claude)==null?void 0:y.ui,messageQueues:{...m,[s]:u}}}}})},c=(u,f)=>{const m=o.map(g=>g.id===u?{...g,content:f}:g);i(m)},l=u=>{const f=o.filter(m=>m.id!==u);i(f)},d=u=>{const f=o.find(m=>m.id===u);f&&(n(f.content),l(u))},p=()=>{i([])};return a.jsx(os,{isVisible:e,onClose:t,title:`Message Queue (${o.length})`,triggerPosition:r,initialSize:{width:500,height:400},resizable:!0,children:a.jsx("div",{"data-test":"message-queue-content",className:"flex flex-col h-full",children:o.length===0?a.jsx("div",{"data-test":"message-queue-empty",className:"flex-1 flex items-center justify-center text-muted-foreground text-sm",children:'No queued messages. End a message with "qqq" or "queue" to add it here.'}):a.jsxs(a.Fragment,{children:[a.jsx(nn,{className:"flex-1 pr-4",children:a.jsx("div",{"data-test":"message-queue-list",className:"space-y-3 p-2",children:o.map((u,f)=>a.jsxs("div",{"data-test":"queue-item",className:"border rounded-lg p-3 space-y-2 bg-muted/30",children:[a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["#",f+1]}),a.jsx("span",{children:new Date(u.createdAt).toLocaleTimeString()})]}),a.jsx(Ud,{"data-test":"queue-item-textarea",value:u.content,onChange:m=>c(u.id,m.target.value),rows:3,className:"resize-y text-sm"}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(ue,{"data-test":"queue-item-delete",variant:"ghost",size:"sm",onClick:()=>l(u.id),title:"Delete",children:a.jsx(Et,{className:"h-4 w-4 text-destructive"})}),a.jsxs(ue,{"data-test":"queue-item-send",variant:"outline",size:"sm",onClick:()=>d(u.id),title:"Send now",children:[a.jsx(Ln,{className:"h-4 w-4 mr-1"}),"Send"]})]})]},u.id))})}),a.jsx("div",{"data-test":"message-queue-footer",className:"flex justify-end gap-2 pt-3 border-t mt-2",children:a.jsx(ue,{"data-test":"message-queue-clear-all",variant:"destructive",size:"sm",onClick:p,children:"Clear All"})})]})})})}const Dr={outputFormat:"text",permissionMode:"acceptEdits"};function ba({variant:s="outline",size:e="sm",buttonLabel:t="Options",className:n,children:r,sessionId:o,onSendQueuedMessage:i}){const[c,l]=h.useState(!1),[d,p]=h.useState(!1),u=h.useRef(null),[f,m]=h.useState(),g=Le(y=>{var j,S,C,N,A;return o?((A=(N=(C=(S=(j=y.app)==null?void 0:j.claude)==null?void 0:S.ui)==null?void 0:C.messageQueues)==null?void 0:N[o])==null?void 0:A.length)??0:0}),x=()=>{if(u.current){const y=u.current.getBoundingClientRect();m({x:y.left,y:y.bottom+8})}l(!1),p(!0)},b=Le(y=>{var j,S,C;return(C=(S=(j=y.ui)==null?void 0:j.claude)==null?void 0:S.message)==null?void 0:C.options}),v={outputFormat:(b==null?void 0:b.outputFormat)??Dr.outputFormat,permissionMode:(b==null?void 0:b.permissionMode)??Dr.permissionMode};h.useEffect(()=>{var y,j,S;if(!b){const C=ie.getState();ie.updateState({ui:{...C.ui,claude:{...(y=C.ui)==null?void 0:y.claude,message:{...(S=(j=C.ui)==null?void 0:j.claude)==null?void 0:S.message,options:Dr}}}})}},[b]);const w=y=>{var S,C,N;const j=ie.getState();ie.updateState({ui:{...j.ui,claude:{...(S=j.ui)==null?void 0:S.claude,message:{...(N=(C=j.ui)==null?void 0:C.claude)==null?void 0:N.message,options:y}}}})};return a.jsxs(a.Fragment,{children:[a.jsxs(st,{open:c,onOpenChange:l,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(ue,{variant:s,size:e,className:n,title:"Message Options","data-test":"message-options-button",children:[a.jsx(Vt,{className:"h-4 w-4"}),t&&a.jsx("span",{className:"ml-2",children:t})]})}),a.jsx(Xe,{className:"w-80",style:{zIndex:tt.draggablePopoverDropdown},onClick:y=>y.stopPropagation(),"data-test":"message-options-popover",children:a.jsxs("div",{className:"message-options-panel space-y-4","data-test":"message-options-panel",children:[a.jsxs("div",{className:"output-format-select","data-test":"output-format-select",children:[a.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Output Format"}),a.jsxs(Ut,{value:v.outputFormat,onValueChange:y=>w({...v,outputFormat:y}),children:[a.jsx(It,{"data-test":"output-format-trigger",children:a.jsx(Jt,{})}),a.jsxs(Tt,{"data-test":"output-format-content",children:[a.jsx(Oe,{value:"text","data-test":"output-format-text",children:"Text"}),a.jsx(Oe,{value:"json","data-test":"output-format-json",children:"JSON"}),a.jsx(Oe,{value:"stream-json","data-test":"output-format-stream-json",children:"Stream JSON"})]})]})]}),a.jsxs("div",{className:"permission-mode-select","data-test":"permission-mode-select",children:[a.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Permission Mode"}),a.jsxs(Ut,{value:v.permissionMode,onValueChange:y=>w({...v,permissionMode:y}),children:[a.jsx(It,{"data-test":"permission-mode-trigger",children:a.jsx(Jt,{})}),a.jsxs(Tt,{"data-test":"permission-mode-content",children:[a.jsx(Oe,{value:"default","data-test":"permission-mode-default",children:"Default"}),a.jsx(Oe,{value:"acceptEdits","data-test":"permission-mode-accept-edits",children:"Accept Edits"}),a.jsx(Oe,{value:"bypassPermissions","data-test":"permission-mode-bypass",children:"Bypass Permissions"}),a.jsx(Oe,{value:"plan","data-test":"permission-mode-plan",children:"Plan Mode"})]})]})]}),o&&a.jsx("div",{"data-test":"view-queue-section",className:"pt-2 border-t",children:a.jsxs(ue,{ref:u,variant:"outline",size:"sm",className:"w-full justify-start",onClick:x,"data-test":"view-queue-button",children:[a.jsx(Zi,{className:"h-4 w-4 mr-2"}),"View Queue",g>0&&a.jsx("span",{className:"ml-auto bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:g})]})})]})})]}),o&&i&&a.jsx(E0,{sessionId:o,isVisible:d,onClose:()=>p(!1),onSendMessage:i,triggerPosition:f}),r==null?void 0:r(v)]})}const I0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.items)??[]},T0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.loading)??!1},A0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.error)??null},P0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.pagination)??null},R0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.currentPage)??1},D0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.favoritesOnly)??!1},_0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.isInitialized)??!1};function O0(s={}){const{loadOnMount:e=!1,parentSessionId:t,pageSize:n=20}=s,{update:r,getState:o}=_a(),i=h.useRef(!1),c=Le(I0),l=Le(T0),d=Le(A0),p=Le(P0),u=Le(R0),f=Le(D0),m=Le(_0),g=h.useCallback(async(N=1,A=!1)=>{var k,E,R,M;try{const L=(E=(k=o().app)==null?void 0:k.claude)==null?void 0:E.forks;r("app",{claude:{forks:{...L,loading:!0,error:null,currentPage:N}}});const T={page:N,pageSize:n,sortBy:"createdAt",sortOrder:"desc"};t&&(T.parentSessionId=t),L!=null&&L.favoritesOnly&&(T.favoritesOnly=!0);const W=await Ye.getForks(T),z=(L==null?void 0:L.items)??[],te=A?[...z,...W.forks]:W.forks;r("app",{claude:{forks:{items:te,pagination:W.pagination,currentPage:N,loading:!1,error:null,favoritesOnly:(L==null?void 0:L.favoritesOnly)??!1,isInitialized:!0}}})}catch(L){console.error("[useForks] API request failed:",{error:L,errorMessage:L instanceof Error?L.message:"Unknown error",page:N,append:A,parentSessionId:t,timestamp:new Date().toISOString()});const T=(M=(R=o().app)==null?void 0:R.claude)==null?void 0:M.forks;r("app",{claude:{forks:{items:A?(T==null?void 0:T.items)??[]:[],pagination:null,currentPage:N,loading:!1,error:L instanceof Error?L.message:"Failed to load forks",favoritesOnly:(T==null?void 0:T.favoritesOnly)??!1,isInitialized:!0}}})}},[r,o,t,n]),x=h.useCallback(()=>{var k,E;const N=(E=(k=o().app)==null?void 0:k.claude)==null?void 0:E.forks,A=!(N!=null&&N.favoritesOnly);r("app",{claude:{forks:{...N,favoritesOnly:A}}}),g(1)},[r,o,g]),b=h.useCallback(async N=>{var E,R,M,L,T;const A=((M=(R=(E=o().app)==null?void 0:E.claude)==null?void 0:R.forks)==null?void 0:M.items)??[],k=A.find(W=>W.sessionId===N);if(k)try{const W=await Ye.updateFork(N,{isFavorite:!k.isFavorite}),z=A.map(O=>O.sessionId===N?W.fork:O),te=(T=(L=o().app)==null?void 0:L.claude)==null?void 0:T.forks;r("app",{claude:{forks:{...te,items:z}}})}catch(W){console.error("[useForks] Failed to toggle favorite:",{sessionId:N,error:W,errorMessage:W instanceof Error?W.message:"Unknown error",timestamp:new Date().toISOString()})}},[r,o]),v=h.useCallback(async(N,A)=>{try{return(await Ye.forkSession(N,A)).success?(g(1),!0):!1}catch(k){return console.error("[useForks] Failed to create fork:",{sessionId:N,request:A,error:k,errorMessage:k instanceof Error?k.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[g]),w=h.useCallback(async N=>{var A,k;try{if((await Ye.deleteFork(N)).success){const R=(k=(A=o().app)==null?void 0:A.claude)==null?void 0:k.forks,L=((R==null?void 0:R.items)??[]).filter(T=>T.sessionId!==N);return r("app",{claude:{forks:{...R,items:L}}}),!0}return!1}catch(E){return console.error("[useForks] Failed to delete fork:",{sessionId:N,error:E,errorMessage:E instanceof Error?E.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[r,o]),y=h.useCallback(()=>{p&&u<p.totalPages&&g(u+1,!0)},[p,u,g]),j=h.useCallback(()=>{g(1)},[g]),S=h.useCallback(async(N,A)=>{var k,E;try{const R=await Ye.updateFork(N,A);if(R.success){const M=(E=(k=o().app)==null?void 0:k.claude)==null?void 0:E.forks,T=((M==null?void 0:M.items)??[]).map(W=>W.sessionId===N?R.fork:W);return r("app",{claude:{forks:{...M,items:T}}}),R.fork}return null}catch(R){return console.error("[useForks] Failed to update fork:",{sessionId:N,updates:A,error:R,errorMessage:R instanceof Error?R.message:"Unknown error",timestamp:new Date().toISOString()}),null}},[r,o]),C=h.useCallback((N,A)=>{var L,T;const k=(T=(L=o().app)==null?void 0:L.claude)==null?void 0:T.forks,E=(k==null?void 0:k.items)??[],R=E.findIndex(W=>W.sessionId===N);if(R===-1)return;const M=[...E];M[R]={...M[R],...A},r("app",{claude:{forks:{...k,items:M}}})},[r,o]);return h.useEffect(()=>{e&&(m||i.current||(i.current=!0,g(1)))},[e,m,g]),{forks:c,loading:l,error:d,pagination:p,currentPage:u,favoritesOnly:f,isInitialized:m,loadForks:g,refreshForks:j,handleLoadMore:y,toggleFavoritesOnly:x,toggleFavorite:b,createFork:v,deleteFork:w,updateFork:S,updateSingleFork:C}}const L0="Use @agent-code-worktree-specialist to help with this task.",M0="Please implement this feature following best practices and ensure all tests pass.";function wa({variant:s="ghost",size:e="icon",className:t="create-session-panel-button",disabled:n=!1,icon:r,initialMessage:o,buttonTitle:i="Create New Session with Message",projectPath:c,initialForkSessionId:l,onOpen:d,onCreating:p,onSessionCreated:u,useModal:f=!1}){const[m,g]=h.useState(!1),[x,b]=h.useState(!1),[v,w]=h.useState(o||""),[y,j]=h.useState(o||""),[S,C]=h.useState(void 0),[N,A]=h.useState(!1),[k,E]=h.useState(null),[R,M]=h.useState(l??null),L=h.useRef(null),{forks:T,loading:W}=O0({loadOnMount:!0}),z=Le(P=>{var B,se,le;return(le=(se=(B=P.app)==null?void 0:B.claude)==null?void 0:se.ui)==null?void 0:le.selectedProjectPath}),te=Le(P=>{var B,se;return(se=(B=P.ui)==null?void 0:B.global)==null?void 0:se.createClaudeSessionPopoverSize}),O=te?{width:te.width}:void 0,ee=P=>{var se;const B=ie.getState();ie.updateState({ui:{...B.ui,global:{...(se=B.ui)==null?void 0:se.global,createClaudeSessionPopoverSize:{width:P.width}}}})};h.useEffect(()=>{o!==y&&(w(o||""),j(o||""))},[o,y]),h.useEffect(()=>{M(l??null)},[l]),h.useEffect(()=>{var P,B,se,le,me,ae;if(m&&c&&c!=="none"){const H=ie.getState();((se=(B=(P=H.app)==null?void 0:P.claude)==null?void 0:B.ui)==null?void 0:se.selectedProjectPath)!==c&&ie.updateState({app:{...H.app,claude:{...(le=H.app)==null?void 0:le.claude,ui:{...(ae=(me=H.app)==null?void 0:me.claude)==null?void 0:ae.ui,selectedProjectPath:c}}}})}},[m,c]);const I=()=>{if(!f&&L.current){const P=L.current.getBoundingClientRect();C({x:P.left,y:P.bottom+8})}g(!0),d&&d()},_=()=>{g(!1)},F=(P,B)=>{const se=[];return B.usePrompt1&&B.prompt1Text&&se.push(B.prompt1Text),B.usePrompt2&&B.prompt2Text&&se.push(B.prompt2Text),se.length>0?`${se.join(`

`)}

${P}`:P},q=P=>{const B=z??c;return{message:v.trim(),cwd:B,projectId:B,options:{outputFormat:P.outputFormat,permissionMode:P.permissionMode}}},J=async P=>{if(console.log("ðŸŽ¯ [ButtonCreateSession] handleSendMessage called",{messageLength:v.trim().length,sessionOptions:P,selectedForkSessionId:R,timestamp:new Date().toISOString()}),!v.trim()){console.log("âš ï¸ [ButtonCreateSession] Message is empty, aborting");return}try{if(console.log("ðŸ“¤ [ButtonCreateSession] Setting sending state to true"),b(!0),p&&(console.log("ðŸ“£ [ButtonCreateSession] Calling onCreating callback"),p()),R){console.log("ðŸ´ [ButtonCreateSession] Creating new fork from selected fork",{parentSessionId:R});const B=await Ye.forkSession(R,{description:`Fork for: ${v.trim().slice(0,50)}...`});if(console.log("âœ… [ButtonCreateSession] New fork created",{success:B.success,newSessionId:B.sessionId,parentSessionId:B.parentSessionId}),!B.success||!B.sessionId)throw new Error("Failed to create fork from selected session");console.log("ðŸ“¤ [ButtonCreateSession] Sending message to new fork",{sessionId:B.sessionId});const se=await Ye.sendMessage({sessionId:B.sessionId,message:v.trim(),options:{outputFormat:P.outputFormat,permissionMode:P.permissionMode}});if(console.log("âœ… [ButtonCreateSession] Message sent to new fork",{success:se.success,sessionId:se.sessionId}),se.success)u&&u(se.sessionId,se.response),_();else throw new Error("Failed to send message to new fork session")}else{const B=q(P);console.log("ðŸ“¦ [ButtonCreateSession] Request body built",{hasMessage:!!B.message,hasCwd:!!B.cwd,hasProjectId:!!B.projectId,optionsCount:Object.keys(B.options||{}).length}),console.log("ðŸš€ [ButtonCreateSession] Calling claudeAPI.createSession");const se=await Ye.createSession(B);if(console.log("âœ… [ButtonCreateSession] API response received",{success:se.success,hasSessionId:!!se.sessionId,error:se.error}),se.success&&se.sessionId)console.log("ðŸŽ‰ [ButtonCreateSession] Session created successfully",{sessionId:se.sessionId}),u&&(console.log("ðŸ“ž [ButtonCreateSession] Calling onSessionCreated callback"),u(se.sessionId,se.response)),_();else throw new Error(se.error??"Failed to create session")}}catch(B){console.error("âŒ [ButtonCreateSession] Failed to create/resume session:",B)}finally{console.log("ðŸ [ButtonCreateSession] Setting sending state to false"),b(!1)}};return a.jsx(dn,{storageKey:"claude-session-prompts",initialConfig:{usePrompt1:!1,usePrompt2:!1,prompt1Text:L0,prompt2Text:M0},children:(P,B,se)=>{const le=(ae,H)=>{const X={...P,[ae]:H};B(X);const ge=F(o||"",X);w(ge)},me=a.jsxs("div",{"data-test":"create-session-content",className:"content-wrapper p-4 space-y-4",children:[a.jsxs("div",{"data-test":"create-session-project-selector-section",className:"project-selector-container mb-4",children:[a.jsxs("div",{"data-test":"create-session-header",className:"flex items-center justify-between",children:[a.jsxs("div",{"data-test":"create-session-labels",className:"flex items-center gap-4",children:[a.jsx("label",{"data-test":"create-session-project-label",className:"project-selector-label text-sm font-medium",children:"Select Project"}),a.jsxs("label",{"data-test":"create-session-fork-label",className:"fork-selector-label text-sm font-medium flex items-center gap-1",children:[a.jsx(ts,{className:"h-3 w-3"}),"Fork From"]})]}),a.jsx(se,{title:"Prompt Configuration",buttonClassName:"prompt-config-button",children:a.jsxs("div",{"data-test":"prompt-config-panel",className:"prompt-config-panel space-y-4",onClick:ae=>ae.stopPropagation(),children:[a.jsxs("div",{"data-test":"prompt-checkbox-1-container",className:"prompt-checkbox-container flex items-center space-x-2",children:[a.jsx(Ct,{"data-test":"prompt-checkbox-1",id:"use-prompt-1",checked:P.usePrompt1,onCheckedChange:ae=>le("usePrompt1",ae===!0)}),a.jsx(Se,{htmlFor:"use-prompt-1",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 1"})]}),a.jsx("div",{"data-test":"prompt-text-display-1",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:P.prompt1Text}),a.jsxs("div",{"data-test":"prompt-checkbox-2-container",className:"prompt-checkbox-container flex items-center space-x-2 mt-4",children:[a.jsx(Ct,{"data-test":"prompt-checkbox-2",id:"use-prompt-2",checked:P.usePrompt2,onCheckedChange:ae=>le("usePrompt2",ae===!0)}),a.jsx(Se,{htmlFor:"use-prompt-2",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 2"})]}),a.jsx("div",{"data-test":"prompt-text-display-2",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:P.prompt2Text})]})})]}),a.jsxs("div",{"data-test":"create-session-selectors",className:"flex gap-2 mt-2",children:[a.jsx("div",{className:`flex-1 ${R?"opacity-50 pointer-events-none":""}`,children:a.jsx(Pc,{"data-test":"create-session-project-selector",variant:"select",className:"project-selector w-full"})}),a.jsxs(Ut,{value:R??"none",onValueChange:ae=>M(ae==="none"?null:ae),children:[a.jsx(It,{"data-test":"create-session-fork-selector",className:"fork-selector flex-1",children:a.jsx(Jt,{placeholder:"No fork (new session)"})}),a.jsxs(Tt,{"data-test":"create-session-fork-options",style:{zIndex:tt.draggablePopoverDropdown},children:[a.jsx(Oe,{value:"none","data-test":"fork-option-none",children:a.jsx("span",{className:"text-muted-foreground",children:"No fork (new session)"})}),W?a.jsx(Oe,{value:"loading",disabled:!0,children:"Loading forks..."}):T.map(ae=>a.jsx(Oe,{value:ae.sessionId,"data-test":"fork-option-item",children:a.jsxs("div",{className:"flex flex-col items-start",children:[a.jsx("span",{className:"font-medium",children:ae.sessionName??ae.description??`Fork ${ae.sessionId.slice(0,8)}`}),a.jsxs("span",{className:"text-xs text-muted-foreground",children:[ae.messageCount??0," messages"]})]})},ae.id))]})]})]})]}),a.jsxs("div",{"data-test":"create-session-message-container",className:"new-session-input-container space-y-3",children:[a.jsx(as,{"data-test":"create-session-textarea",value:v,onChange:ae=>w(ae.target.value),placeholder:"Type your message...",rows:10,className:"resize-y"}),a.jsx("div",{"data-test":"create-session-actions",className:"flex justify-end gap-2 items-center",children:a.jsx(ba,{variant:"outline",size:"sm",buttonLabel:"Options",className:"session-options-button","data-test":"create-session-options-button",children:ae=>a.jsx(dr,{"data-test":"create-session-send-button",label:a.jsxs(a.Fragment,{children:[R?a.jsx(ts,{className:"h-4 w-4 mr-2"}):a.jsx(Ln,{className:"h-4 w-4 mr-2"}),x?R?"Forking...":"Creating Session...":R?"Fork & Send":"Create Session"]}),onAction:()=>{console.log("ðŸ‘† [ButtonCreateSession] ConfigurableButton onAction triggered",{messageLength:v.trim().length,sending:x,selectedForkSessionId:R,disabled:!v.trim()||x,timestamp:new Date().toISOString()}),J(ae)},disabled:!v.trim()||x,variant:"default",configOptions:[{label:"Preview Request Body",value:"preview",onClick:()=>{E(ae),A(!0)},icon:a.jsx(Hr,{className:"h-4 w-4"})}],showHint:!0,tooltipText:R?"Click to fork and send message":"Click to send, hold to preview request",ariaLabel:R?"Fork and Send button":"Create Session button with preview option"})})}),N&&k&&a.jsx(Fn,{open:N,onOpenChange:A,children:a.jsxs($n,{className:"sm:max-w-[600px] max-h-[70vh] overflow-y-auto",children:[a.jsx(Un,{children:a.jsx(Zs,{children:"Request Body Preview"})}),a.jsx("pre",{className:"request-preview-content bg-muted p-4 rounded-md text-xs font-mono overflow-x-auto whitespace-pre-wrap",children:JSON.stringify(q(k),null,2)}),a.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[a.jsx(ue,{variant:"outline",onClick:()=>A(!1),children:"Close"}),a.jsxs(ue,{onClick:()=>{A(!1),J(k)},children:[a.jsx(Ln,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})]});return a.jsxs(a.Fragment,{children:[a.jsx(ue,{ref:L,"data-test":"create-session-button",variant:s,size:e,disabled:n,className:t,title:i,onClick:I,children:r??a.jsx(Gr,{className:"h-4 w-4 hover:text-purple-500 transition-colors"})}),f?a.jsx(Fn,{open:m,onOpenChange:g,children:a.jsxs($n,{"data-test":"create-session-dialog",className:"sm:max-w-[700px] max-h-[80vh] overflow-y-auto",children:[a.jsx(Un,{children:a.jsx(Zs,{children:"Create New Session"})}),me]})}):a.jsx(os,{"data-test":"create-session-popover",isVisible:m,onClose:_,title:"Create New Session",className:"max-h-[80vh]",shouldCloseManually:!0,resizable:!0,initialSize:O||{width:700},onSizeChange:ee,triggerPosition:S,children:me})]})}})}function xi({buttonLabel:s,icon:e=a.jsx(rr,{className:"h-5 w-5"}),variant:t="ghost",size:n="icon",buttonClassName:r="",contentClassName:o="",align:i="end",side:c="bottom",title:l="Audio Recorder"}){const[d,p]=h.useState(!1);return a.jsxs(st,{open:d,onOpenChange:p,"data-test":"audio-recorder-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:t,size:n,className:`audio-recorder-button ${r}`,title:l,"data-test":"audio-recorder-trigger-button",children:s?a.jsxs(a.Fragment,{children:[e,s&&a.jsx("span",{className:"ml-2","data-test":"audio-recorder-button-label",children:s})]}):e})}),a.jsxs(Xe,{className:`audio-recorder-panel w-[400px] ${o}`,align:i,side:c,"data-test":"audio-recorder-popover-content",children:[l&&a.jsx("div",{className:"audio-panel-header pb-2 mb-2 border-b border-border","data-test":"audio-recorder-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"audio-recorder-panel-title",children:l})}),a.jsx("div",{className:"audio-panel-content","data-test":"audio-recorder-panel-content",children:a.jsx(as,{})})]})]})}const Bd=Hu,no=h.forwardRef(({className:s,...e},t)=>a.jsx(Ki,{ref:t,className:U("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",s),...e}));no.displayName=Ki.displayName;const an=h.forwardRef(({className:s,...e},t)=>a.jsx(Ji,{ref:t,className:U("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",s),...e}));an.displayName=Ji.displayName;const on=h.forwardRef(({className:s,...e},t)=>a.jsx(Yi,{ref:t,className:U("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...e}));on.displayName=Yi.displayName;var qt=(s=>(s.LOW="low",s.MEDIUM="medium",s.HIGH="high",s.URGENT="urgent",s))(qt||{}),Je=(s=>(s.FREEZER="freezer",s.BACKLOG="backlog",s.SELECTED="selected",s.DOING="doing",s.DONE="done",s.ARCHIVE="archive",s))(Je||{}),Zt=(s=>(s.PERSONAL="personal",s.WORK="work",s.SHOPPING="shopping",s.HEALTH="health",s.OTHER="other",s))(Zt||{});function Wd({session:s,segmentsToStrip:e=3,onNameUpdated:t}){const[n,r]=h.useState(!1),[o,i]=h.useState(""),[c,l]=h.useState(!1),d=h.useRef(null),p=h.useRef(0),u=h.useMemo(()=>{const{name:v,cwd:w}=s;if(!v.startsWith("-home-"))return v;let j=v;const S=/\/[a-f0-9]{8}[a-f0-9-]*$/i;j=j.replace(S,""),j.startsWith("-")&&(j=j.substring(1));const C="/"+j.replace(/-/g,"/");w&&C.startsWith(w);const N=C.split("/").filter(Boolean);return e>0&&N.length>e?N.slice(e).join("/"):N.length===0?v:N.join("/")},[s,e]),f=s.customName||u;h.useEffect(()=>{n&&d.current&&(d.current.focus(),d.current.select())},[n]);const m=()=>{i(s.customName||""),r(!0)},g=v=>{const w=Date.now(),y=w-p.current;y<300&&y>0&&(v.preventDefault(),m()),p.current=w},x=async()=>{if(!c)try{l(!0);const v=o.trim()===""?null:o.trim();await Ye.updateSessionName(s.id,v),t==null||t(),r(!1)}catch(v){console.error("Failed to update session name:",v),alert("Failed to update session name")}finally{l(!1)}},b=v=>{v.key==="Enter"?x():v.key==="Escape"&&r(!1)};return n?a.jsxs("div",{className:"session-name-edit flex items-center gap-2","data-test":"session-name-edit-container",children:[a.jsx("input",{ref:d,type:"text",value:o,onChange:v=>i(v.target.value),onKeyDown:b,onBlur:()=>r(!1),className:"flex-1 px-2 py-1 border rounded",placeholder:u,disabled:c,"data-test":"session-name-input"}),a.jsx("button",{onMouseDown:v=>{v.preventDefault(),x()},disabled:c,className:"session-name-save-btn p-1 hover:bg-gray-100 rounded",title:"Save (Enter)","data-test":"session-name-save-button",children:a.jsx(ct,{className:"w-4 h-4"})})]}):a.jsx("span",{className:"session-name-display cursor-pointer hover:underline",style:{touchAction:"manipulation"},onPointerDown:g,onDoubleClick:m,title:"Double-click to edit","data-test":"session-name-display",children:f})}function F0({sessionIds:s=[],className:e="",title:t="Claude session is running",showCount:n=!1,lastActiveTime:r,isCreating:o=!1}){const[i,c]=h.useState({}),[l,d]=h.useState([]),p=h.useRef(s);h.useEffect(()=>{p.current=s},[s]),h.useEffect(()=>{var A,k,E;const C=((E=(k=(A=ie.get("app"))==null?void 0:A.claude)==null?void 0:k.data)==null?void 0:E.sessions)??[];d(C);const N=ie.selectSlice(R=>{var M,L,T;return(T=(L=(M=R.app)==null?void 0:M.claude)==null?void 0:L.data)==null?void 0:T.sessions}).subscribe(R=>{d(R??[])});return()=>N.unsubscribe()},[]);const u=h.useMemo(()=>{if(r!==void 0)return r;if(!s.length||!l.length)return;const C=l.filter(A=>s.includes(A.id));if(!C.length)return;const N=C.reduce((A,k)=>{const E=new Date(k.lastModified).getTime();return E>A?E:A},0);return N>0?N:void 0},[r,s,l]);h.useEffect(()=>{var R,M,L;const C=T=>{if(!T)return{};const W={};for(const z of p.current)T[z]&&(W[z]=T[z]);return W},N=(T,W)=>{const z=Object.keys(T),te=Object.keys(W);if(z.length!==te.length)return!0;for(const O of te)if(!T[O]||T[O].isOpened!==W[O].isOpened||T[O].isProcessing!==W[O].isProcessing)return!0;return!1},A=((L=(M=(R=ie.get("app"))==null?void 0:R.claude)==null?void 0:M.ui)==null?void 0:L.activity)??{},k=C(A);c(k);const E=ie.selectSlice(T=>{var W,z,te;return(te=(z=(W=T.app)==null?void 0:W.claude)==null?void 0:z.ui)==null?void 0:te.activity}).subscribe(T=>{const W=C(T);c(z=>N(z,W)?W:z)});return()=>E.unsubscribe()},[]);const f=h.useCallback(C=>{const N=i[C];if(N!=null&&N.isProcessing)return"running";if(N!=null&&N.isOpened&&!(N!=null&&N.isProcessing))return"opened";if(u){const A=Date.now()-36e5;if(u>A)return"recent"}return"inactive"},[i,u]),m=C=>{switch(C){case"running":return{status:"running",color:"bg-green-500",bgColor:"bg-green-500",textColor:"text-green-600"};case"opened":return{status:"opened",color:"bg-orange-500",bgColor:"bg-orange-500",textColor:"text-orange-600"};case"recent":return{status:"recent",color:"bg-yellow-500",bgColor:"bg-yellow-500",textColor:"text-yellow-600"};case"inactive":default:return{status:"inactive",color:"bg-gray-400",bgColor:"bg-gray-400",textColor:"text-gray-500"}}},g=h.useMemo(()=>s.map(C=>({id:C,status:f(C)})).filter(C=>C.status!=="inactive"),[s,f]),x=g.length>0,b=h.useMemo(()=>g.some(C=>C.status==="running")?"running":g.some(C=>C.status==="opened")?"opened":g.some(C=>C.status==="recent")?"recent":"inactive",[g]),v=m(b),w=h.useMemo(()=>{if(n&&g.length>1){const N={running:"running",opened:"opened",recent:"recently active",inactive:"inactive"}[b];return`${g.length} Claude sessions ${N}`}const C={running:"Claude session is running",opened:"Claude session is opened",recent:"Claude session recently active",inactive:"Claude session inactive"}[b];return t||C},[n,g.length,b,t]);if(!x&&!o)return null;const y=o?"running":b,j=o?m("running"):v,S=o?"Creating Claude session...":w;return a.jsxs("div",{className:`session-activity-indicator flex items-center gap-1 ${e}`,title:S,"data-test":"session-activity-indicator",children:[a.jsx("div",{className:`activity-dot w-2 h-2 ${j.bgColor} rounded-full ${y==="running"?"animate-pulse":""}`,"data-test":"activity-dot","data-activity-status":y,"data-is-creating":o}),n&&g.length>1&&a.jsx("span",{className:`activity-count text-xs ${j.textColor} font-medium`,"data-test":"activity-count",children:g.length})]})}function $0(s,e){if(s.className!==e.className||s.title!==e.title||s.showCount!==e.showCount||s.lastActiveTime!==e.lastActiveTime||s.isCreating!==e.isCreating)return!1;const t=s.sessionIds??[],n=e.sessionIds??[];return t.length!==n.length?!1:t.every((r,o)=>r===n[o])}const ro=h.memo(F0,$0),U0=[{value:"user",label:"User Messages",description:"Pure user messages (no tool content)"},{value:"assistant",label:"Assistant Responses",description:"Pure assistant responses (no thinking/tool blocks)"},{value:"thinking",label:"Thinking Blocks",description:"Messages containing thinking blocks"},{value:"tools",label:"Tool Calls/Results",description:"Messages containing tool_use or tool_result blocks"}],zd=h.forwardRef(({searchQuery:s,onSearchChange:e,onAdvancedSearch:t,className:n},r)=>{const[o,i]=h.useState(!1),[c,l]=h.useState({messageType:[],sortOrder:"desc",pageSize:50}),d=h.useMemo(()=>{const{sortOrder:b,pageSize:v,messageType:w,...y}=c,j=Object.values(y).some(N=>N!==void 0),S=w&&w.length>0;return j||S||b!=="desc"},[c]),p=(b,v)=>{l(w=>({...w,[b]:v}))},u=(b,v)=>{l(w=>{const y=w.messageType||[],j=v?[...y,b]:y.filter(S=>S!==b);return{...w,messageType:j.length>0?j:[]}})},f=()=>{t&&t(s,c),i(!1)},m=()=>{l({messageType:[],sortOrder:"desc",pageSize:50})},g=b=>{b.key==="Enter"&&t&&t(s,c)},x=()=>{e("")};return a.jsx("div",{ref:r,className:U("messages-search-container relative",n),"data-test":"messages-search-container",children:a.jsxs("div",{className:"search-input-wrapper relative flex items-center gap-1","data-test":"messages-search-input-wrapper",children:[a.jsx(or,{className:"search-icon absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10","data-test":"messages-search-icon"}),a.jsx(We,{type:"text",placeholder:"Search messages...",value:s,onChange:b=>e(b.target.value),onKeyDown:g,className:U("search-input pl-9",s?"pr-16":"pr-10"),"data-test":"messages-search-input"}),s&&a.jsx(ue,{variant:"ghost",size:"icon",onClick:x,className:"clear-button absolute right-9 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"messages-search-clear-button",children:a.jsx(ht,{className:"h-4 w-4"})}),d&&a.jsx("div",{className:U("filter-indicator absolute top-1/2 -translate-y-1/2 h-2 w-2 rounded-full bg-primary pointer-events-none z-10",s?"right-17":"right-11"),"data-test":"messages-search-filter-indicator"}),a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0","aria-label":o?"Collapse advanced search":"Expand advanced search","data-test":"messages-search-expand-button",children:o?a.jsx(ar,{className:"h-4 w-4"}):a.jsx(wt,{className:"h-4 w-4"})})}),a.jsxs(Xe,{align:"start",className:"advanced-search-panel w-96 max-h-[600px] overflow-y-auto","data-test":"messages-advanced-search-panel",children:[a.jsxs("div",{className:"panel-header space-y-2 pb-3 border-b","data-test":"messages-panel-header",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),a.jsx(ue,{variant:"ghost",size:"sm",onClick:m,className:"h-7 text-xs","data-test":"messages-clear-filters-button",children:"Clear All"})]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Search message content with filters"})]}),a.jsxs("div",{className:"panel-content space-y-4 py-4","data-test":"messages-panel-content",children:[a.jsxs("div",{className:"message-types-filter space-y-2","data-test":"messages-types-section",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Message Types"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Filter by message type"}),a.jsx("div",{className:"message-types-grid space-y-2",children:U0.map(b=>{var v;return a.jsxs("div",{className:"message-type-item flex items-center space-x-2",children:[a.jsx(Ct,{id:`msgtype-${b.value}`,checked:(v=c.messageType)==null?void 0:v.includes(b.value),onCheckedChange:w=>u(b.value,w===!0),"data-test":"messages-message-type-checkbox"}),a.jsxs("label",{htmlFor:`msgtype-${b.value}`,className:"text-sm cursor-pointer flex-1",children:[a.jsx("span",{children:b.label}),a.jsx("span",{className:"text-xs text-muted-foreground block",children:b.description})]})]},b.value)})})]}),a.jsxs("div",{className:"timestamp-range-filter space-y-2",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Timestamp Range"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"timestamp-input-wrapper",children:[a.jsx(Se,{htmlFor:"timestamp-after",className:"text-xs text-muted-foreground",children:"After"}),a.jsx(We,{id:"timestamp-after",type:"datetime-local",value:c.after??"",onChange:b=>p("after",b.target.value||void 0),className:"h-8"})]}),a.jsxs("div",{className:"timestamp-input-wrapper",children:[a.jsx(Se,{htmlFor:"timestamp-before",className:"text-xs text-muted-foreground",children:"Before"}),a.jsx(We,{id:"timestamp-before",type:"datetime-local",value:c.before??"",onChange:b=>p("before",b.target.value||void 0),className:"h-8"})]})]})]}),a.jsxs("div",{className:"sorting-section space-y-2",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Sort By Timestamp"}),a.jsxs(Ut,{value:c.sortOrder,onValueChange:b=>p("sortOrder",b),children:[a.jsx(It,{className:"h-8",children:a.jsx(Jt,{})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"desc",children:"Newest First"}),a.jsx(Oe,{value:"asc",children:"Oldest First"})]})]})]}),a.jsxs("div",{className:"pagination-section space-y-2",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Results Per Page"}),a.jsx(We,{type:"number",min:"1",max:"100",value:c.pageSize??50,onChange:b=>p("pageSize",b.target.value?parseInt(b.target.value):50),className:"h-8"})]})]}),a.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 border-t","data-test":"messages-panel-footer",children:[a.jsx(ue,{onClick:f,className:"flex-1",size:"sm","data-test":"messages-apply-search-button",children:"Apply Search"}),a.jsx(ue,{onClick:()=>i(!1),variant:"outline",size:"sm","data-test":"messages-cancel-button",children:"Cancel"})]})]})]})]})})});zd.displayName="MessagesSearch";function Ns({onClick:s,textToCopy:e,title:t="Copy formatted text",size:n="icon",variant:r="ghost"}){const[o,i]=h.useState(!1),c=async()=>{if(s){s();return}if(!e){ke.error("No text to copy");return}try{await navigator.clipboard.writeText(e),i(!0),ke.success("Copied to clipboard!"),setTimeout(()=>i(!1),2e3)}catch(l){ke.error("Failed to copy to clipboard"),console.error("Copy failed:",l)}};return a.jsx(ue,{onClick:c,title:t,size:n,variant:r,children:o?a.jsx(ct,{}):a.jsx(Ra,{})})}function B0(s){return s.name==="Bash"}function W0(s){return s.name==="TodoWrite"}function Hd(s){return s.name==="ExitPlanMode"}function z0(s){return s.name==="Task"}function Gd(s){return s.name==="AskUserQuestion"}function qd(s){return typeof s=="object"&&s!==null&&"type"in s&&s.type==="tool_use"}const Vd=h.forwardRef(({className:s,...e},t)=>a.jsx(Xi,{className:U("grid gap-2",s),...e,ref:t}));Vd.displayName=Xi.displayName;const Kd=h.forwardRef(({className:s,...e},t)=>a.jsx(Qi,{ref:t,className:U("aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",s),...e,children:a.jsx(Gu,{className:"flex items-center justify-center",children:a.jsx(Ys,{className:"h-3.5 w-3.5 fill-primary"})})}));Kd.displayName=Qi.displayName;const H0=s=>{var t,n,r;const e=ie.getState();ie.updateState({ui:{...e.ui,claude:{...(t=e.ui)==null?void 0:t.claude,message:{...(r=(n=e.ui)==null?void 0:n.claude)==null?void 0:r.message,prefill:s}}}})},ao=h.memo(({toolBlock:s})=>{const{questions:e}=s.input,[t,n]=h.useState({}),r=h.useCallback(c=>{const l=[];e.forEach((d,p)=>{const u=c[p];if(u!==void 0)if(d.multiSelect&&u instanceof Set){const f=Array.from(u).sort().map(m=>d.options[m].label);f.length>0&&l.push(`**${d.header}**: ${f.join(", ")}`)}else typeof u=="number"&&l.push(`**${d.header}**: ${d.options[u].label}`)}),H0(l.join(`
`))},[e]),o=h.useCallback((c,l,d)=>{const p=d.findIndex(u=>u.label===l);p!==-1&&n(u=>{const f={...u,[c]:p};return r(f),f})},[r]),i=h.useCallback((c,l,d)=>{n(p=>{const u=p[c]instanceof Set?p[c]:new Set,f=new Set(u);d?f.add(l):f.delete(l);const m={...p,[c]:f};return r(m),m})},[r]);return a.jsxs("div",{className:"ask-user-question-block bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-ask-user-question",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"ask-user-header",children:[a.jsx(vp,{className:"h-4 w-4 text-muted-foreground"}),a.jsxs("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:["Question",e.length>1?"s":""]})]}),a.jsx("div",{className:"questions-list space-y-4","data-test":"questions-list",children:e.map((c,l)=>a.jsxs("div",{className:"question-item","data-test":"question-item",children:[a.jsxs("div",{className:"question-header flex items-center gap-2 mb-1",children:[a.jsx("span",{className:"text-xs font-medium text-muted-foreground bg-muted-foreground/10 px-1.5 py-0.5 rounded","data-test":"question-tag",children:c.header}),c.multiSelect&&a.jsx("span",{className:"text-xs text-muted-foreground/70","data-test":"multi-select-indicator",children:"(select multiple)"})]}),a.jsx("p",{className:"question-text text-sm mb-2","data-test":"question-text",children:c.question}),c.multiSelect?a.jsx("div",{className:"options-list space-y-2","data-test":"options-list-checkbox",children:c.options.map((d,p)=>{const u=t[l]instanceof Set?t[l]:new Set;return a.jsxs("div",{className:"option-item flex items-start gap-2","data-test":"option-item",children:[a.jsx(Ct,{id:`q${l}-opt${p}`,className:"mt-0.5",checked:u.has(p),onCheckedChange:f=>i(l,p,!!f),"data-test":"option-checkbox"}),a.jsxs(Se,{htmlFor:`q${l}-opt${p}`,className:"text-sm cursor-pointer leading-tight",children:[a.jsx("span",{className:"font-medium","data-test":"option-label",children:d.label}),d.description&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1","data-test":"option-description",children:["â€” ",d.description]})]})]},p)})}):a.jsx(Vd,{className:"space-y-2",value:typeof t[l]=="number"?c.options[t[l]].label:void 0,onValueChange:d=>o(l,d,c.options),"data-test":"options-list-radio",children:c.options.map((d,p)=>a.jsxs("div",{className:"option-item flex items-start gap-2","data-test":"option-item",children:[a.jsx(Kd,{value:d.label,id:`q${l}-opt${p}`,className:"mt-0.5","data-test":"option-radio"}),a.jsxs(Se,{htmlFor:`q${l}-opt${p}`,className:"text-sm cursor-pointer leading-tight",children:[a.jsx("span",{className:"font-medium","data-test":"option-label",children:d.label}),d.description&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1","data-test":"option-description",children:["â€” ",d.description]})]})]},p))})]},l))})]})});ao.displayName="AskUserQuestionBlock";const Jd=h.memo(({toolBlock:s})=>{const{plan:e}=s.input;return e?a.jsxs("div",{className:"plan-block bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-plan",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"plan-header",children:[a.jsx(Js,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Plan"})]}),a.jsx("div",{className:"plan-content prose prose-sm dark:prose-invert max-w-none text-sm [&_h1]:text-lg [&_h1]:font-bold [&_h1]:mt-3 [&_h1]:mb-2 [&_h2]:text-base [&_h2]:font-semibold [&_h2]:mt-3 [&_h2]:mb-1 [&_h3]:text-sm [&_h3]:font-semibold [&_h3]:mt-2 [&_h3]:mb-1 [&_pre]:bg-background/50 [&_pre]:p-2 [&_pre]:rounded [&_pre]:text-xs [&_pre]:overflow-x-auto [&_code]:text-xs [&_code]:bg-background/50 [&_code]:px-1 [&_code]:rounded [&_.list-item-ul]:flex [&_.list-item-ul]:ml-2 [&_.list-item-ol]:flex [&_.list-item-ol]:ml-2","data-test":"plan-content",dangerouslySetInnerHTML:{__html:it(e)}})]}):null});Jd.displayName="PlanBlock";const ya=h.memo(({messages:s,renderMessage:e})=>{const[t,n]=h.useState(!1),{askUserQuestionBlocks:r,planBlocks:o}=h.useMemo(()=>{const p=[],u=[];for(const f of s)if(Array.isArray(f.content))for(const m of f.content)qd(m)&&(Gd(m)?p.push(m):Hd(m)&&m.input.plan&&u.push(m));return{askUserQuestionBlocks:p,planBlocks:u}},[s]),i=s.map(p=>{if(!Array.isArray(p.content))return"Tool";for(const u of p.content){if(typeof u=="object"&&u.type==="tool_use"&&"name"in u)return u.name;if(typeof u=="object"&&u.type==="tool_result")return"Result"}return"Tool"}),c=h.useMemo(()=>{for(const p of s)if(Array.isArray(p.content)){for(const u of p.content)if(typeof u=="object"&&u.type==="tool_use"&&"name"in u&&u.name==="Bash"&&"input"in u&&typeof u.input=="object"&&u.input!==null&&"command"in u.input&&typeof u.input.command=="string"&&u.input.command.includes("git commit -m"))return!0}return!1},[s]),l=[...new Set(i)];let d=l.length<=3?l.join(", "):`${l.slice(0,2).join(", ")} +${l.length-2} more`;return c&&(d=`Committed, ${d}`),a.jsxs("div",{className:"tool-call-group w-full space-y-2","data-test":"tool-call-group","data-test-tool-count":s.length,children:[a.jsxs("button",{onClick:()=>n(!t),className:"tool-group-header flex items-center gap-2 w-full py-2 rounded-lg hover:bg-muted/50 transition-colors","data-test":"tool-group-toggle",children:[t?a.jsx(wt,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}):a.jsx($t,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),a.jsxs("span",{className:"text-xs uppercase text-muted-foreground","data-test":"tool-group-label",children:[s.length," Tool Call",s.length!==1?"s":""]}),!t&&a.jsx("span",{className:"text-xs text-muted-foreground/70 font-mono truncate","data-test":"tool-group-summary",children:d})]}),t&&a.jsx("div",{className:"tool-group-content space-y-2 mt-2 pl-4 border-l-2 border-muted-foreground/20","data-test":"tool-group-content",children:s.map(p=>e(p))}),o.length>0&&a.jsx(Jd,{toolBlock:o[o.length-1]},`plan-${o[o.length-1].id}`),r.length>0&&a.jsx(ao,{toolBlock:r[r.length-1]},`ask-user-${r[r.length-1].id}`)]})});ya.displayName="ToolCallGroup";const Yd=h.memo(({content:s})=>{const[e,t]=h.useState(!1);return a.jsxs("div",{className:"thinking-section","data-test":"thinking-block",children:[a.jsxs("button",{onClick:n=>{n.stopPropagation(),t(!e)},className:"thinking-toggle flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"thinking-toggle",children:[e?a.jsx(wt,{className:"h-3 w-3"}):a.jsx($t,{className:"h-3 w-3"}),a.jsx("span",{className:"font-semibold uppercase",children:"Thinking"}),!e&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1 truncate max-w-[200px]",children:[s.slice(0,50),"..."]})]}),e&&a.jsx("div",{className:"thinking-content mt-2 p-2 bg-muted-foreground/5 rounded border-l-2 border-muted-foreground/30 text-sm text-muted-foreground whitespace-pre-wrap break-words max-w-full","data-test":"thinking-content",children:s})]})});Yd.displayName="ThinkingBlockComponent";const Xd=s=>typeof s=="string"?a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-text",dangerouslySetInnerHTML:{__html:it(s)}}):Array.isArray(s)?s.map((e,t)=>{if(typeof e=="string")return a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-block-string",dangerouslySetInnerHTML:{__html:it(e)}},t);if(typeof e=="object"&&e.type==="text"&&"text"in e)return a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-block-text",dangerouslySetInnerHTML:{__html:it(e.text)}},t);if(typeof e=="object"&&e.type==="thinking"){const n=("thinking"in e?e.thinking:null)||("text"in e?e.text:null);if(n)return a.jsx(Yd,{content:n},t)}if(qd(e)){const n=e;if(Hd(n)&&n.input.plan)return a.jsxs("div",{className:"tool-use-plan bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-plan",children:[a.jsx("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"plan-header",children:a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Plan"})}),a.jsx("div",{className:"plan-content prose prose-sm dark:prose-invert max-w-none text-sm [&_h1]:text-lg [&_h1]:font-bold [&_h1]:mt-3 [&_h1]:mb-2 [&_h2]:text-base [&_h2]:font-semibold [&_h2]:mt-3 [&_h2]:mb-1 [&_h3]:text-sm [&_h3]:font-semibold [&_h3]:mt-2 [&_h3]:mb-1 [&_pre]:bg-background/50 [&_pre]:p-2 [&_pre]:rounded [&_pre]:text-xs [&_pre]:overflow-x-auto [&_code]:text-xs [&_code]:bg-background/50 [&_code]:px-1 [&_code]:rounded [&_.list-item-ul]:flex [&_.list-item-ul]:ml-2 [&_.list-item-ol]:flex [&_.list-item-ol]:ml-2","data-test":"plan-content",dangerouslySetInnerHTML:{__html:it(n.input.plan)}})]},t);if(W0(n)){const{todos:o}=n.input;return a.jsxs("div",{className:"tool-use-todos bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-todos",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"todos-header",children:[a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Todo List"}),a.jsxs("span",{className:"text-xs text-muted-foreground/70",children:["(",o.length," items)"]})]}),a.jsx("ul",{className:"todos-list space-y-1","data-test":"todos-list",children:o.map((i,c)=>a.jsxs("li",{className:"todo-item flex items-start gap-2 text-xs","data-test":"todo-item",children:[a.jsx("span",{className:`todo-status flex-shrink-0 ${i.status==="completed"?"text-green-500":i.status==="in_progress"?"text-yellow-500":"text-muted-foreground/50"}`,"data-test":"todo-status",children:i.status==="completed"?"âœ“":i.status==="in_progress"?"â–¶":"â—‹"}),a.jsx("span",{className:`todo-content ${i.status==="completed"?"line-through text-muted-foreground/70":""}`,"data-test":"todo-content",children:i.content})]},c))})]},t)}if(Gd(n))return a.jsx(ao,{toolBlock:n},t);let r;return(B0(n)||z0(n))&&(r=n.input.description),a.jsxs("div",{className:"tool-use bg-muted-foreground/10 p-2 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-tool-use",children:[a.jsxs("div",{className:"text-xs font-mono truncate","data-test":"tool-use-name",children:["Tool: ",n.name]}),r&&a.jsx("div",{className:"text-xs text-muted-foreground mt-1 truncate","data-test":"tool-use-description",children:r})]},t)}return a.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded mt-1 overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-block-json",children:JSON.stringify(e,null,2)},t)}):typeof s=="object"&&s!==null?s.text?a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-object-text",dangerouslySetInnerHTML:{__html:it(s.text)}}):s.content?a.jsx("div",{"data-test":"message-content-recursive",children:Xd(s.content)}):a.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-object-json",children:JSON.stringify(s,null,2)}):a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-fallback",dangerouslySetInnerHTML:{__html:it(String(s))}}),vi=s=>{const e=s.match(/<thinking>([\s\S]*?)<\/thinking>/);if(e){const t=e[1].trim(),n=s.replace(/<thinking>[\s\S]*?<\/thinking>/,"").trim();return{thinking:t||null,mainContent:n}}return{thinking:null,mainContent:s}},Hs=h.memo(({message:s,formatTime:e})=>{const[t,n]=h.useState(!1),[r,o]=h.useState(!1),[i,c]=h.useState(!1),l=h.useMemo(()=>Array.isArray(s.content)?s.content.some(b=>typeof b=="object"&&(b.type==="tool_result"||b.type==="tool_use")):!1,[s.content]),{thinkingContent:d,mainContent:p}=h.useMemo(()=>{if(s.role!=="assistant"||l)return{thinkingContent:null,mainContent:s.content};if(Array.isArray(s.content)){const b=[];let v=null;for(const w of s.content)if(typeof w=="object"&&w.type==="text"&&"text"in w){const y=vi(w.text);y.thinking&&(v=y.thinking),y.mainContent&&b.push({type:"text",text:y.mainContent})}else b.push(w);return{thinkingContent:v,mainContent:b.length>0?b:s.content}}if(typeof s.content=="string"){const b=vi(s.content);return{thinkingContent:b.thinking,mainContent:b.mainContent}}return{thinkingContent:null,mainContent:s.content}},[s.content,s.role,l]),u=l?"TOOL":s.role,f=b=>typeof b=="string"?b:Array.isArray(b)?b.map(v=>typeof v=="string"?v:typeof v=="object"&&v.type==="text"&&"text"in v?v.text:"").filter(Boolean).join(`
`):typeof b=="object"&&b!==null?b.text?b.text:b.content?f(b.content):JSON.stringify(b,null,2):String(b),m=async b=>{b.stopPropagation();const v=f(s.content);try{await navigator.clipboard.writeText(v),n(!0),setTimeout(()=>n(!1),2e3)}catch(w){console.error("Failed to copy message:",w)}},g=()=>{if(!Array.isArray(s.content))return"Tool";for(const b of s.content){if(typeof b=="object"&&b.type==="tool_result")return`Result${"is_error"in b&&b.is_error?" (error)":""}`;if(typeof b=="object"&&b.type==="tool_use"&&"name"in b)return b.name}return"Tool"},x=()=>{var b;if(!Array.isArray(s.content))return"";for(const v of s.content){if(typeof v=="object"&&v.type==="tool_result"&&"tool_use_id"in v){let w="";if("content"in v){const y=v.content;if(typeof y=="string")w=y.slice(0,50)+(y.length>50?"...":"");else if(Array.isArray(y)&&((b=y[0])!=null&&b.text)){const j=y[0].text;w=j.slice(0,50)+(j.length>50?"...":"")}}return w||"(empty)"}if(typeof v=="object"&&v.type==="tool_use"&&"name"in v){const w=v.name,y=[];if("input"in v&&typeof v.input=="object"&&v.input!==null){const j=v.input;if(j.description&&typeof j.description=="string"&&y.push(j.description),w==="Bash"&&j.command&&typeof j.command=="string"){const S=j.command.slice(0,40)+(j.command.length>40?"...":"");y.push(`$ ${S}`)}if(["Read","Write","Edit"].includes(w)&&j.file_path&&typeof j.file_path=="string"){const S=j.file_path.split("/").slice(-3).join("/");y.push(S)}["Grep","Glob"].includes(w)&&j.pattern&&typeof j.pattern=="string"&&y.push(`"${j.pattern}"`)}return y.join(" | ")||""}}return""};return a.jsxs("div",{className:`message-item flex flex-col w-full ${s.role==="user"?"items-end":"items-start"} ${s._isOptimistic?"opacity-60":""}`,"data-test":"message-item-wrapper","data-test-message-id":s.id,"data-test-optimistic":s._isOptimistic?"true":void 0,children:[a.jsxs("div",{className:`message-role-header flex items-center gap-1.5 mb-1 px-1 ${s.role==="user"?"flex-row-reverse":"flex-row"}`,"data-test":"message-role-header",children:[a.jsx("span",{className:"message-role text-xs font-semibold uppercase text-muted-foreground","data-test":"message-role-label",children:u}),a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"message-info-button p-0.5 hover:bg-muted rounded transition-colors",onClick:b=>b.stopPropagation(),"data-test":"message-info-button",children:a.jsx(Qs,{className:"h-3 w-3 text-muted-foreground/50"})})}),a.jsxs(Kt,{className:"flex items-center gap-2","data-test":"message-id-tooltip",children:[a.jsxs("span",{className:"text-xs font-mono",children:["ID: ",s.id]}),a.jsx(Ns,{textToCopy:s.id,title:"Copy message ID",size:"smIconCompact",variant:"ghost"})]})]})})]}),a.jsxs("div",{onClick:()=>{console.log("Message clicked:",s)},className:`message-bubble max-w-[85%] rounded-lg p-3 overflow-hidden cursor-pointer ${s.role==="user"?"bg-primary text-primary-foreground":l?"bg-muted/50 border border-muted-foreground/20":"bg-muted"}`,"data-test":"message-bubble",children:[l&&a.jsxs("div",{className:"message-tool-header mb-2 flex items-center gap-2","data-test":"message-tool-header",children:[a.jsx("button",{onClick:b=>{b.stopPropagation(),o(!r)},className:"expand-tool-button p-0.5 -ml-1 hover:bg-muted-foreground/10 rounded transition-colors flex-shrink-0","data-test":"expand-tool-button",children:r?a.jsx(wt,{className:"h-3 w-3 text-muted-foreground"}):a.jsx($t,{className:"h-3 w-3 text-muted-foreground"})}),a.jsx("span",{className:"text-xs text-muted-foreground font-semibold","data-test":"tool-name",children:g()})]}),l&&!r&&a.jsx("div",{className:"tool-summary-content text-xs text-muted-foreground font-mono truncate mb-2","data-test":"tool-summary",children:x()}),d&&a.jsxs("div",{className:"thinking-section mb-2","data-test":"thinking-section",children:[a.jsxs("button",{onClick:b=>{b.stopPropagation(),c(!i)},className:"thinking-toggle flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"thinking-toggle",children:[i?a.jsx(wt,{className:"h-3 w-3"}):a.jsx($t,{className:"h-3 w-3"}),a.jsx("span",{className:"font-semibold uppercase",children:"Thinking"}),!i&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1 truncate max-w-[200px]",children:[d.slice(0,50),"..."]})]}),i&&a.jsx("div",{className:"thinking-content mt-2 p-2 bg-muted-foreground/5 rounded border-l-2 border-muted-foreground/30 text-sm text-muted-foreground whitespace-pre-wrap break-words max-w-full","data-test":"thinking-content",children:d})]}),(!l||r)&&a.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words overflow-wrap-anywhere word-break max-w-full","data-test":"message-content",children:Xd(p)}),s.toolCalls&&s.toolCalls.length>0&&a.jsxs("div",{className:"message-tool-calls mt-2 space-y-1","data-test":"message-tool-calls",children:[a.jsx("div",{className:`text-xs font-semibold ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":"message-tool-calls-label",children:"Tool Calls:"}),s.toolCalls.map((b,v)=>a.jsx("div",{className:`tool-call-item p-2 rounded text-xs font-mono ${s.role==="user"?"bg-primary-foreground/10":"bg-muted-foreground/10"}`,"data-test":"tool-call-item",children:a.jsx("pre",{className:"whitespace-pre-wrap break-words max-w-full","data-test":"tool-call-json",children:JSON.stringify(b,null,2)})},v))]}),a.jsxs("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"message-footer",children:[a.jsx("div",{className:`message-time text-xs max-w-full ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"} ${s._isOptimistic?"italic":""}`,"data-test":"message-timestamp",children:s._isOptimistic?"Sending...":e(s.timestamp)}),a.jsx("button",{onClick:m,className:`copy-button p-1 rounded hover:bg-opacity-20 transition-colors ${s.role==="user"?"hover:bg-primary-foreground":"hover:bg-foreground"}`,title:"Copy message","data-test":"copy-message-button",children:t?a.jsx(ct,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground":"text-muted-foreground"}`,"data-test":"copy-success-icon"}):a.jsx(Ra,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"copy-icon"})})]})]})]},s.id)});Hs.displayName="MessageItem";const Qd=h.memo(({message:s})=>{const e=s.entryType==="user";return a.jsxs("div",{className:`inherited-message-item flex flex-col w-full ${e?"items-end":"items-start"}`,"data-test":"inherited-message-item","data-test-message-id":s.uuid,children:[a.jsxs("div",{className:`message-role-header flex items-center gap-1.5 mb-1 px-1 ${e?"flex-row-reverse":"flex-row"}`,"data-test":"inherited-message-role-header",children:[a.jsx("span",{className:"message-role text-xs font-semibold uppercase text-muted-foreground/70",children:s.entryType}),e?a.jsx(yp,{className:"h-3 w-3 text-muted-foreground/50"}):a.jsx(qr,{className:"h-3 w-3 text-muted-foreground/50"})]}),a.jsxs("div",{className:`message-bubble max-w-[85%] rounded-lg p-3 border-dashed border ${e?"bg-primary/30 text-primary-foreground/80 border-primary/30":"bg-muted/30 border-muted-foreground/20"}`,"data-test":"inherited-message-bubble",children:[a.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words","data-test":"inherited-message-content",children:s.preview||"(empty)"}),a.jsx("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"inherited-message-footer",children:a.jsx("div",{className:`message-time text-xs ${e?"text-primary-foreground/50":"text-muted-foreground/50"}`,"data-test":"inherited-message-timestamp",children:new Date(s.timestamp).toLocaleTimeString()})})]})]})});Qd.displayName="InheritedMessageItem";function G0({messages:s,sessionDetails:e,metadata:t,loading:n,pagination:r,onLoadOlder:o,onSearch:i,onNameUpdated:c,onFork:l,scrollToMessageId:d,onBackClick:p,showBackButton:u,inheritedMessages:f}){var P,B,se,le,me,ae;const m=h.useRef(null),g=h.useRef(null),x=h.useRef(0),b=h.useRef(null),v=h.useRef(0),w=h.useRef(!1),[y,j]=h.useState(""),[S,C]=h.useState(!1),N=h.useRef(!1),[A,k]=h.useState(!1),[E,R]=h.useState(((se=(B=(P=ie.getState().app)==null?void 0:P.claude)==null?void 0:B.ui)==null?void 0:se.autoScrollThreshold)??300);h.useEffect(()=>{const H=(e==null?void 0:e.name)??null;b.current!==H&&(x.current=0,b.current=H,N.current=!1,k(!1))},[e==null?void 0:e.name]);const M=h.useCallback(H=>new Date(H).toLocaleTimeString(),[]),L=h.useCallback(H=>{const X=new Date(H);return X.toLocaleDateString()+" "+X.toLocaleTimeString()},[]),[T,W]=h.useState(((ae=(me=(le=ie.getState().app)==null?void 0:le.claude)==null?void 0:me.ui)==null?void 0:ae.messageFilters)??["user","assistant","thinking","tools"]),z=h.useCallback(H=>{const{scrollTop:X,scrollHeight:ge,clientHeight:ce}=H,Ce=getComputedStyle(H).flexDirection==="column-reverse";let ve;return Ce?ve=X<=E:ve=ge-X-ce<=E,console.log("[scroll-debug]",{isColumnReverse:Ce,scrollTop:X,scrollHeight:ge,clientHeight:ce,autoScrollThreshold:E,nearBottom:ve}),ve},[E]),te=h.useCallback(H=>{const X=H.target;X&&(z(X)?(N.current=!1,k(!1)):(N.current=!0,k(!0)))},[z]);h.useEffect(()=>{const H=m.current;if(!H)return;const X=H.querySelector("[data-radix-scroll-area-viewport]");if(X)return z(X)?k(!1):k(!0),X.addEventListener("scroll",te),()=>X.removeEventListener("scroll",te)},[te,z]);const O=h.useCallback(H=>{var ge,ce,Ae;R(H);const X=ie.getState();ie.setState({...X,app:{...X.app,claude:{...(ge=X.app)==null?void 0:ge.claude,ui:{...(Ae=(ce=X.app)==null?void 0:ce.claude)==null?void 0:Ae.ui,autoScrollThreshold:H}}}})},[]);h.useEffect(()=>{var ce,Ae,Ce,ve,$,re;((Ce=(Ae=(ce=ie.getState().app)==null?void 0:ce.claude)==null?void 0:Ae.ui)==null?void 0:Ce.messageFilters)||ie.update("app",{claude:{...(ve=ie.getState().app)==null?void 0:ve.claude,ui:{...(re=($=ie.getState().app)==null?void 0:$.claude)==null?void 0:re.ui,messageFilters:["user","assistant","thinking","tools"]}}});const X=ie.selectSlice(G=>{var oe,de,pe;return(pe=(de=(oe=G.app)==null?void 0:oe.claude)==null?void 0:de.ui)==null?void 0:pe.messageFilters}).subscribe(G=>{G&&W(G)}),ge=ie.selectSlice(G=>{var oe,de,pe;return(pe=(de=(oe=G.app)==null?void 0:oe.claude)==null?void 0:de.ui)==null?void 0:pe.autoScrollThreshold}).subscribe(G=>{G!==void 0&&R(G)});return()=>{X.unsubscribe(),ge.unsubscribe()}},[]);const ee=H=>{var Ae,Ce,ve,$,re,G;const X=((ve=(Ce=(Ae=ie.getState().app)==null?void 0:Ae.claude)==null?void 0:Ce.ui)==null?void 0:ve.messageFilters)??T,ge=X.includes(H)?X.filter(oe=>oe!==H):[...X,H],ce=ie.getState();ie.setState({...ce,app:{...ce.app,claude:{...($=ce.app)==null?void 0:$.claude,ui:{...(G=(re=ce.app)==null?void 0:re.claude)==null?void 0:G.ui,messageFilters:ge}}}})},I=(H,X)=>{i&&i(H,X)},_=h.useMemo(()=>s.filter(X=>!X.content||X.content===""?!1:Array.isArray(X.content)&&X.content.some(ce=>typeof ce=="object"&&(ce.type==="tool_use"||ce.type==="tool_result"))?T.includes("tools"):!!(X.role==="user"&&T.includes("user")||X.role==="assistant"&&T.includes("assistant"))),[s,T]),F=h.useCallback(H=>Array.isArray(H.content)?H.content.some(X=>typeof X=="object"&&(X.type==="tool_use"||X.type==="tool_result")):!1,[]),q=h.useMemo(()=>{const H=[];let X=[];for(const ge of _)F(ge)?X.push(ge):(X.length>0&&(H.push({type:"tool-group",messages:X}),X=[]),H.push({type:"single",message:ge}));return X.length>0&&H.push({type:"tool-group",messages:X}),H},[_,F]);h.useLayoutEffect(()=>{const H=x.current===0&&_.length>0,X=_.length>x.current&&x.current>0;if(m.current){const ge=m.current.querySelector("[data-radix-scroll-area-viewport]");if(H&&ge)ge.scrollTop=ge.scrollHeight,v.current=ge.scrollHeight,x.current=_.length,w.current=!1;else if(X&&ge){const ce=ge.scrollHeight,Ae=ce-v.current;ge.scrollTop=ge.scrollTop+Ae,v.current=ce,x.current=_.length,w.current=!0}}},[_]),h.useEffect(()=>{if(x.current!==0){if(w.current){w.current=!1;return}if(!N.current&&m.current){const H=m.current.querySelector("[data-radix-scroll-area-viewport]");H&&setTimeout(()=>{H.scrollTo({top:H.scrollHeight,behavior:"smooth"})},50)}}},[_]),h.useEffect(()=>{if(S&&g.current){const H=g.current.querySelector("[data-radix-scroll-area-viewport]");H&&setTimeout(()=>{H.scrollTo({top:H.scrollHeight,behavior:"auto"})},100)}},[S]);const J=h.useCallback((H=!0,X=!1)=>{const ge=X?g:m;if(ge.current){const ce=ge.current.querySelector("[data-radix-scroll-area-viewport]");ce&&(ce.scrollTo({top:ce.scrollHeight,behavior:H?"smooth":"auto"}),X||(N.current=!1,k(!1)))}},[]);return h.useEffect(()=>{if(!d||!m.current)return;const H=m.current.querySelector(`[data-test-message-id="${d}"]`);H&&(H.scrollIntoView({behavior:"smooth",block:"center"}),H.classList.add("message-highlight"),setTimeout(()=>{H.classList.remove("message-highlight")},2e3))},[d]),a.jsxs(hn,{className:"chat-interface-card h-full flex flex-col overflow-hidden rounded-none border-0 md:rounded-lg md:border","data-test":"chat-interface-card",children:[a.jsxs(La,{className:"chat-header pb-2 pt-2 px-2 md:pt-4 md:px-6 flex-shrink-0","data-test":"chat-header",children:[a.jsxs("div",{className:"header-title-container flex items-center gap-2 text-sm","data-test":"header-title-container",children:[u&&p&&a.jsx(ue,{variant:"ghost",size:"icon",onClick:p,className:"md:hidden h-8 w-8 flex-shrink-0","data-test":"back-to-sessions-button",children:a.jsx(Ds,{className:"h-5 w-5"})}),a.jsx(ro,{sessionIds:e!=null&&e.id?[e.id]:[]}),a.jsx(Ma,{className:"text-base truncate","data-test":"chat-title",children:e?a.jsx(Wd,{session:e,segmentsToStrip:3,onNameUpdated:c}):"New Conversation"}),t&&a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"info-button p-1 hover:bg-muted rounded-sm transition-colors","data-test":"session-info-button",children:a.jsx(Qs,{className:"h-4 w-4 text-muted-foreground"})})}),a.jsx(Kt,{className:"metadata-tooltip","data-test":"session-metadata-tooltip",children:a.jsxs("div",{className:"metadata-section text-xs space-y-1","data-test":"metadata-section",children:[a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-created",children:[a.jsx("span",{className:"font-medium",children:"Created:"})," ",L(t.created)]}),a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-modified",children:[a.jsx("span",{className:"font-medium",children:"Last Modified:"})," ",L(t.lastModified)]}),a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-message-count",children:[a.jsx("span",{className:"font-medium",children:"Messages:"})," ",t.messageCount]}),t.model&&a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-model",children:[a.jsx("span",{className:"font-medium",children:"Model:"})," ",t.model]}),(e==null?void 0:e.id)&&a.jsxs("div",{className:"metadata-item flex items-center gap-1","data-test":"metadata-item-session-id",children:[a.jsx("span",{className:"font-medium",children:"ID:"}),a.jsxs("span",{className:"font-mono",children:[e.id.slice(0,6),"...",e.id.slice(-6)]}),a.jsx(Ns,{textToCopy:e.id,title:"Copy session ID",size:"smIconCompact",variant:"ghost"})]})]})})]})}),l&&a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"fork-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:H=>l({x:H.clientX,y:H.clientY}),"data-test":"fork-session-button",children:a.jsx(ts,{className:"h-4 w-4 text-muted-foreground"})})}),a.jsx(Kt,{children:a.jsx("p",{children:"Fork this session"})})]})}),a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"expand-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:()=>C(!0),"data-test":"expand-chat-button",children:a.jsx(bp,{className:"h-4 w-4 text-muted-foreground"})})}),a.jsx(Kt,{children:a.jsx("p",{children:"Expand chat view"})})]})}),a.jsx(dn,{storageKey:"chat-interface-config",title:"Chat Configuration",contentClassName:"chat-config-panel w-64",children:a.jsxs("div",{className:"config-content space-y-4","data-test":"chat-config-content",children:[a.jsxs("div",{className:"project-selector-section space-y-2","data-test":"project-selector-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Project"}),a.jsx(Pc,{variant:"select",className:"w-full"})]}),a.jsxs("div",{className:"filters-section space-y-2","data-test":"message-filters-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Show messages"}),a.jsxs("div",{className:"filter-options space-y-2","data-test":"filter-options",children:[a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-user",children:[a.jsx(Ct,{id:"filter-user",checked:T.includes("user"),onCheckedChange:()=>ee("user"),"data-test":"filter-checkbox-user"}),a.jsx(Se,{htmlFor:"filter-user",className:"text-sm cursor-pointer",children:"User"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-assistant",children:[a.jsx(Ct,{id:"filter-assistant",checked:T.includes("assistant"),onCheckedChange:()=>ee("assistant"),"data-test":"filter-checkbox-assistant"}),a.jsx(Se,{htmlFor:"filter-assistant",className:"text-sm cursor-pointer",children:"Assistant"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-thinking",children:[a.jsx(Ct,{id:"filter-thinking",checked:T.includes("thinking"),onCheckedChange:()=>ee("thinking"),"data-test":"filter-checkbox-thinking"}),a.jsx(Se,{htmlFor:"filter-thinking",className:"text-sm cursor-pointer",children:"Thinking"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-tools",children:[a.jsx(Ct,{id:"filter-tools",checked:T.includes("tools"),onCheckedChange:()=>ee("tools"),"data-test":"filter-checkbox-tools"}),a.jsx(Se,{htmlFor:"filter-tools",className:"text-sm cursor-pointer",children:"Tools"})]})]})]}),a.jsxs("div",{className:"auto-scroll-section space-y-2","data-test":"auto-scroll-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Auto-scroll threshold"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Auto-scroll only when within this distance from bottom (px)"}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(_t,{value:[E],onValueChange:([H])=>O(H),min:0,max:500,step:10,className:"flex-1","data-test":"auto-scroll-threshold-slider"}),a.jsx("span",{className:"text-sm font-mono w-12 text-right","data-test":"auto-scroll-threshold-value",children:E})]})]})]})})]}),i&&a.jsx(zd,{searchQuery:y,onSearchChange:j,onAdvancedSearch:I,className:"mt-3"})]}),a.jsxs(fn,{className:"chat-content flex-1 min-h-0 overflow-hidden p-0 relative","data-test":"chat-content",children:[a.jsx(nn,{ref:m,className:"chat-scroll-area h-full w-full",viewportClassName:"!block","data-test":"chat-scroll-area",children:a.jsxs("div",{className:"messages-container space-y-4 px-2 md:px-4 pt-2 w-full max-w-full overflow-x-hidden","data-test":"messages-container",children:[o&&r&&a.jsx("div",{className:"load-older-container flex justify-center pb-4 pt-2","data-test":"load-older-container",children:a.jsxs(ue,{variant:"outline",size:"sm",onClick:o,disabled:n,className:"load-older-button","data-test":"load-older-button",children:[a.jsx(wt,{className:"h-4 w-4 mr-2 rotate-180"}),"Load Older Messages",r&&a.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(",s.length," of ",r.totalCount,")"]})]})}),f&&f.length>0&&a.jsxs("div",{className:"inherited-messages-section","data-test":"inherited-messages-section",children:[a.jsxs("div",{className:"inherited-messages-header flex items-center gap-2 mb-3 pb-2 border-b border-dashed border-muted-foreground/30",children:[a.jsx(ts,{className:"h-4 w-4 text-muted-foreground"}),a.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["Inherited from parent session (",f.length," messages)"]})]}),a.jsx("div",{className:"inherited-messages-list space-y-4 opacity-70",children:f.map(H=>a.jsx(Qd,{message:H},H.uuid))}),a.jsxs("div",{className:"fork-point-divider flex items-center gap-2 my-4 py-2",children:[a.jsx("div",{className:"flex-1 border-t border-dashed border-primary/40"}),a.jsxs("span",{className:"text-xs font-medium text-primary/70 flex items-center gap-1",children:[a.jsx(ts,{className:"h-3 w-3"}),"Fork point"]}),a.jsx("div",{className:"flex-1 border-t border-dashed border-primary/40"})]})]}),n&&_.length===0?a.jsx("div",{className:"loading-message text-sm text-muted-foreground","data-test":"loading-message",children:"Loading messages..."}):_.length===0&&(!f||f.length===0)?a.jsxs("div",{className:"empty-state text-center mt-8","data-test":"empty-state",children:[a.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"New Session"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Type your first message below to start the conversation"})]}):q.map((H,X)=>H.type==="tool-group"?a.jsx(ya,{messages:H.messages,renderMessage:ge=>a.jsx(Hs,{message:ge,formatTime:M},ge.id)},`tool-group-${H.messages[0].id}`):a.jsx(Hs,{message:H.message,formatTime:M},H.message.id))]})}),A&&a.jsx(ue,{variant:"outline",size:"icon",onClick:()=>J(!0),className:"absolute bottom-4 right-4 h-8 w-8 rounded-full shadow-md bg-background/90 backdrop-blur-sm hover:bg-background z-10","data-test":"chat-scroll-to-bottom",title:"Scroll to latest message",children:a.jsx(wt,{className:"h-4 w-4"})})]}),a.jsx(os,{isVisible:S,onClose:()=>C(!1),title:e?typeof e.customName=="string"?e.customName:e.name:"Chat Messages",shouldCloseManually:!0,resizable:!0,initialSize:{width:1e3,height:700},initialPosition:{x:100,y:50},children:a.jsxs("div",{className:"expanded-chat-content flex flex-col flex-1 overflow-hidden","data-test":"expanded-chat-view",children:[a.jsxs("div",{className:"expanded-controls-header flex items-center justify-between gap-4 px-4 py-2 border-b border-border flex-shrink-0","data-test":"expanded-controls-header",children:[a.jsxs("div",{className:"filter-controls flex items-center gap-3","data-test":"expanded-filter-controls",children:[a.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Show:"}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(Ct,{id:"expanded-filter-user",checked:T.includes("user"),onCheckedChange:()=>ee("user"),"data-test":"expanded-filter-checkbox-user"}),a.jsx(Se,{htmlFor:"expanded-filter-user",className:"text-xs cursor-pointer",children:"User"})]}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(Ct,{id:"expanded-filter-assistant",checked:T.includes("assistant"),onCheckedChange:()=>ee("assistant"),"data-test":"expanded-filter-checkbox-assistant"}),a.jsx(Se,{htmlFor:"expanded-filter-assistant",className:"text-xs cursor-pointer",children:"Assistant"})]}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(Ct,{id:"expanded-filter-tools",checked:T.includes("tools"),onCheckedChange:()=>ee("tools"),"data-test":"expanded-filter-checkbox-tools"}),a.jsx(Se,{htmlFor:"expanded-filter-tools",className:"text-xs cursor-pointer",children:"Tools"})]})]}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>J(!0,!0),className:"scroll-to-bottom-button flex items-center gap-1.5 h-7 text-xs","data-test":"scroll-to-bottom-button",title:"Scroll to latest message",children:[a.jsx(wp,{className:"h-3 w-3"}),"Latest"]})]}),a.jsx("div",{className:"flex-1 min-h-0 p-4 pt-2",children:a.jsx(nn,{className:"h-full",ref:g,children:a.jsx("div",{className:"messages-container-expanded space-y-4 pr-4",children:_.length===0?a.jsxs("div",{className:"empty-state text-center mt-8","data-test":"expanded-empty-state",children:[a.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"No Messages"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"This session has no messages yet"})]}):q.map(H=>H.type==="tool-group"?a.jsx(ya,{messages:H.messages,renderMessage:X=>a.jsx(Hs,{message:X,formatTime:M},X.id)},`expanded-tool-group-${H.messages[0].id}`):a.jsx(Hs,{message:H.message,formatTime:M},H.message.id))})})})]})})]})}function Sa({sessionId:s,message:e,onBeforeSend:t,onSendSuccess:n,onSendError:r,outputFormat:o="text",permissionMode:i="acceptEdits",variant:c="ghost",size:l="icon",className:d="",title:p="Send to Claude session",disabled:u,...f}){const[m,g]=h.useState(!1);h.useEffect(()=>{g(!1)},[s]);const x=h.useCallback(async()=>{if(e.trim()){t==null||t();try{g(!0),await Ye.sendMessage({message:e.trim(),sessionId:s,options:{outputFormat:o,permissionMode:i}}),console.log(`Sent message to Claude session ${s}: ${e}`),n==null||n()}catch(b){console.error("Failed to send message to Claude:",b),r==null||r(b)}finally{g(!1)}}},[e,s,o,i,m,t,n,r]);return a.jsx(ue,{variant:c,size:l,onClick:x,className:d,title:p,disabled:u||!e.trim(),"data-test":"claude-send-button","data-test-sending":m?"true":"false",...f,children:m?a.jsx(ir,{className:"h-3 w-3 animate-spin loading-indicator","data-test":"send-button-loading"}):a.jsx(Ln,{className:"h-3 w-3","data-test":"send-button-icon"})})}const _r=["acceptEdits","bypassPermissions","plan"],q0={acceptEdits:"Accept Edits",bypassPermissions:"Bypass",plan:"Plan"};function V0({sessionId:s,initialMessage:e="",rows:t=3,value:n,onChange:r,onSendSuccess:o,onSendError:i,onAddOptimisticMessage:c,onRemoveOptimisticMessage:l,userMessages:d}){const[p,u]=h.useState(e),f=h.useRef(null),m=h.useRef(null),[g,x]=h.useState(-1),b=h.useRef(""),v=bs(),[w,y]=h.useState(1),j=Le(I=>{var _,F,q,J;return(J=(q=(F=(_=I.ui)==null?void 0:_.claude)==null?void 0:F.message)==null?void 0:q.options)==null?void 0:J.permissionMode}),S=j==="default"||!j?"acceptEdits":j,C=Le(I=>{var _,F,q;return(q=(F=(_=I.ui)==null?void 0:_.claude)==null?void 0:F.message)==null?void 0:q.prefill});h.useEffect(()=>{var I,_,F;if(C){u(C);const q=ie.getState();ie.updateState({ui:{...q.ui,claude:{...(I=q.ui)==null?void 0:I.claude,message:{...(F=(_=q.ui)==null?void 0:_.claude)==null?void 0:F.message,prefill:void 0}}}})}},[C]);const N=h.useCallback(()=>{var J,P,B,se,le,me;const _=(_r.indexOf(S)+1)%_r.length,F=_r[_],q=ie.getState();ie.updateState({ui:{...q.ui,claude:{...(J=q.ui)==null?void 0:J.claude,message:{...(B=(P=q.ui)==null?void 0:P.claude)==null?void 0:B.message,options:{...(me=(le=(se=q.ui)==null?void 0:se.claude)==null?void 0:le.message)==null?void 0:me.options,permissionMode:F}}}}})},[S]),A=n??p,k=r??u,E=h.useMemo(()=>{if(!d)return[];const I=["This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation"];return d.map(_=>typeof _.content=="string"?_.content:"").filter(_=>_&&!I.some(F=>_.startsWith(F))).reverse()},[d]);h.useEffect(()=>{var F,q,J;const I=(J=(q=(F=ie.getState().app)==null?void 0:F.claude)==null?void 0:q.ui)==null?void 0:J.messageDrafts,_=I==null?void 0:I[s];u(_||"")},[s]),h.useEffect(()=>{var I,_,F,q,J,P;if(!n){const se={...((F=(_=(I=ie.getState().app)==null?void 0:I.claude)==null?void 0:_.ui)==null?void 0:F.messageDrafts)||{}};p.trim()?se[s]=p:delete se[s],ie.updateState({app:{...ie.getState().app,claude:{...(q=ie.getState().app)==null?void 0:q.claude,ui:{...(P=(J=ie.getState().app)==null?void 0:J.claude)==null?void 0:P.ui,messageDrafts:se}}}})}},[p,s,n]);const R=h.useRef(1),[M,L]=h.useState(void 0);h.useEffect(()=>{var Ae;if(!v){y(t),L(void 0);return}const I=(Ae=f.current)==null?void 0:Ae.getTextArea();if(!I)return;const _=1,F=4,q=getComputedStyle(I),J=parseFloat(q.lineHeight)||24,P=parseFloat(q.paddingTop)||0,B=parseFloat(q.paddingBottom)||0,se=parseFloat(q.borderTopWidth)||0,le=parseFloat(q.borderBottomWidth)||0;if(!A.trim()){const Ce=J*_+P+B;R.current=_,y(_),L(`${Ce}px`),I.style.overflowY="hidden";return}const me=I.style.height;I.style.height="auto";const H=I.scrollHeight-P-B-se-le,X=Math.max(1,Math.round(H/J));I.style.height=me;const ge=Math.min(F,Math.max(_,X)),ce=J*ge+P+B;R.current=ge,y(ge),L(`${ce}px`),I.style.overflowY=X>F?"auto":"hidden"},[A,v,t]);const T=()=>{var P,B,se,le,me,ae,H,X,ge,ce,Ae,Ce,ve,$;const I=A.trim(),_=I.match(/(qqq|queue)$/i);if(_){const re=I.slice(0,-_[0].length).trim();if(re){te(re),k("");const G=(P=f.current)==null?void 0:P.getTextArea();G&&(G.value="",G.dispatchEvent(new Event("input",{bubbles:!0})));const de={...((le=(se=(B=ie.getState().app)==null?void 0:B.claude)==null?void 0:se.ui)==null?void 0:le.messageDrafts)??{}};delete de[s],ie.updateState({app:{...ie.getState().app,claude:{...(me=ie.getState().app)==null?void 0:me.claude,ui:{...(H=(ae=ie.getState().app)==null?void 0:ae.claude)==null?void 0:H.ui,messageDrafts:de}}}})}return}if(c&&A.trim()){const re=c(A.trim());m.current=re}x(-1),b.current="",k("");const F=(X=f.current)==null?void 0:X.getTextArea();F&&(F.value="",F.dispatchEvent(new Event("input",{bubbles:!0})));const J={...((Ae=(ce=(ge=ie.getState().app)==null?void 0:ge.claude)==null?void 0:ce.ui)==null?void 0:Ae.messageDrafts)||{}};delete J[s],ie.updateState({app:{...ie.getState().app,claude:{...(Ce=ie.getState().app)==null?void 0:Ce.claude,ui:{...($=(ve=ie.getState().app)==null?void 0:ve.claude)==null?void 0:$.ui,messageDrafts:J}}}})},W=()=>{m.current=null,o==null||o()},z=I=>{l&&m.current&&(l(m.current),m.current=null),i==null||i(I)},te=I=>{var B,se,le,me,ae,H;const _=ie.getState(),F=((le=(se=(B=_.app)==null?void 0:B.claude)==null?void 0:se.ui)==null?void 0:le.messageQueues)??{},q=F[s]??[],J={id:crypto.randomUUID(),content:I,createdAt:Date.now()},P={...F,[s]:[...q,J]};ie.updateState({app:{..._.app,claude:{...(me=_.app)==null?void 0:me.claude,ui:{...(H=(ae=_.app)==null?void 0:ae.claude)==null?void 0:H.ui,messageQueues:P}}}})},O=I=>{k(I),setTimeout(()=>{var _;(_=document.querySelector(".claude-send-button"))==null||_.click()},0)},ee=I=>{var _;if(I.key==="Enter"&&!I.shiftKey){I.preventDefault(),(_=document.querySelector(".claude-send-button"))==null||_.click();return}if(I.key==="ArrowUp"&&E.length>0&&(I.currentTarget.selectionStart===0||!A)){I.preventDefault(),g===-1&&(b.current=A);const q=Math.min(g+1,E.length-1);q!==g&&(x(q),k(E[q]))}if(I.key==="ArrowDown"&&g>=0){const F=I.currentTarget;if(F.selectionStart===F.value.length||!A){I.preventDefault();const J=g-1;J<0?(x(-1),k(b.current)):(x(J),k(E[J]))}}};return a.jsxs("div",{className:"message-input-container","data-test":"message-input-container",children:[a.jsxs("div",{className:U("message-input-area flex gap-2",v?"items-end":"items-start"),"data-test":"message-input-area",children:[v&&a.jsx(ba,{variant:"ghost",size:"icon",buttonLabel:"",sessionId:s,onSendQueuedMessage:O,className:"!size-12"}),a.jsx(as,{ref:f,value:A,onChange:I=>k(I.target.value),onKeyDown:ee,placeholder:v?"Type your message...":"Type your message... (Shift+Enter for new line, @ to insert file path)",className:U("message-textarea flex-1",v?"resize-none":"resize-y"),style:M?{height:M,transition:"height 150ms ease-out"}:void 0,showBuiltInPopover:!1,rows:v?1:w,"data-test":"message-textarea"}),v?a.jsx(Sa,{sessionId:s,message:A,outputFormat:"text",permissionMode:S,className:"claude-send-button send-button !size-12",size:"icon",onBeforeSend:T,onSendSuccess:W,onSendError:z}):a.jsx("div",{className:"send-controls flex flex-col gap-2","data-test":"send-controls",children:a.jsx(ba,{variant:"ghost",size:"icon",buttonLabel:"",sessionId:s,onSendQueuedMessage:O,children:I=>a.jsx(Sa,{sessionId:s,message:A,outputFormat:I.outputFormat,permissionMode:I.permissionMode,className:"claude-send-button send-button",size:"icon",onBeforeSend:T,onSendSuccess:W,onSendError:z})})})]}),a.jsx("div",{className:"message-input-footer flex items-center justify-start mt-1 px-1","data-test":"message-input-footer",children:a.jsx("button",{type:"button",onClick:N,className:"permission-mode-toggle text-xs text-muted-foreground hover:text-foreground transition-colors cursor-pointer","data-test":"permission-mode-toggle",title:"Click to cycle permission mode",children:q0[S]})})]})}function K0({forkCount:s,forkedFromName:e,forkedFromId:t,onClick:n,size:r="default"}){if(!s&&!e)return null;const o=!!e,i=s&&s>0,c=r==="sm"?10:12,l=r==="sm"?"text-[10px] px-1.5 py-0":"",d=p=>{o&&t&&n&&(p.stopPropagation(),n(t))};return o?a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsxs(pt,{"data-test":"fork-indicator-forked-from",variant:"secondary",className:`fork-indicator-badge gap-1 cursor-pointer hover:bg-secondary/80 ${l}`,onClick:d,children:[a.jsx(ts,{size:c,"data-test":"fork-indicator-icon"}),a.jsx("span",{"data-test":"fork-indicator-label",children:"Forked"})]})}),a.jsxs(Kt,{"data-test":"fork-indicator-tooltip",children:[a.jsxs("p",{children:["Forked from: ",e]}),n&&a.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to view parent"})]})]})}):i?a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsxs(pt,{"data-test":"fork-indicator-count",variant:"outline",className:`fork-indicator-badge gap-1 ${l}`,children:[a.jsx(ts,{size:c,"data-test":"fork-indicator-icon"}),a.jsx("span",{"data-test":"fork-indicator-count-value",children:s})]})}),a.jsx(Kt,{"data-test":"fork-indicator-tooltip",children:a.jsxs("p",{children:[s," fork",s>1?"s":""," created from this session"]})})]})}):null}function J0(s){const e=new Date,t=new Date(s),n=e.getTime()-t.getTime(),r=Math.floor(n/(1e3*60)),o=Math.floor(n/(1e3*60*60)),i=Math.floor(n/(1e3*60*60*24)),c=Math.floor(i/7),l=Math.floor(i/365);return r<1?"just now":r<60?`${r} min ago`:o<24?`${o} ${o===1?"hour":"hours"} ago`:i<7?`${i} ${i===1?"day":"days"} ago`:c<52?`${c} ${c===1?"week":"weeks"} ago`:`${l} ${l===1?"year":"years"} ago`}function Zd({session:s,isSelected:e,isFocused:t=!1,onClick:n,formatDate:r,formatCwd:o,segmentsToStrip:i=3,onNameUpdated:c,compact:l=!1,forkCount:d,forkedFromName:p,forkedFromId:u,onFork:f,onNavigateToParent:m,hasDraft:g=!1}){const x=b=>{b.stopPropagation(),f==null||f(s)};return a.jsxs("div",{"data-test":"session-list-item",onClick:()=>{n()},className:`session-item group relative ${l?"p-1.5":"p-3"} rounded-lg border cursor-pointer transition-colors ${e?"bg-primary/10 border-primary":t?"bg-accent/50 border-accent-foreground/30 ring-2 ring-accent-foreground/20":"hover:bg-accent"}`,children:[a.jsx("div",{"data-test":"session-cwd",className:"session-cwd text-xs text-muted-foreground truncate",children:o(s.cwd)}),a.jsxs("div",{"data-test":"session-name-container",className:`session-name-container ${l?"font-medium text-sm":"font-bold text-base"} break-words line-clamp-2 ${l?"":"mt-1"} flex items-center gap-2`,children:[a.jsx(ro,{sessionIds:[s.id]}),a.jsx(Wd,{session:s,segmentsToStrip:i,onNameUpdated:c}),g&&a.jsx("span",{"data-test":"session-draft-indicator",title:"Has draft message",className:"text-amber-500 flex-shrink-0",children:a.jsx(Sp,{size:14})})]}),(s.latestMessage||s.firstMessage)&&!l&&a.jsx("div",{"data-test":"session-latest-message",className:"session-latest-message text-sm text-muted-foreground truncate mt-1",children:s.latestMessage||s.firstMessage}),a.jsxs("div",{"data-test":"session-meta",className:`session-meta text-xs text-muted-foreground flex items-center gap-2 flex-wrap ${l?"mt-0.5":"mt-1"}`,children:[a.jsxs("span",{children:[s.messageCount," messages"]}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:J0(s.lastModified)}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:r(s.lastModified)}),(d||p)&&a.jsxs(a.Fragment,{children:[a.jsx("span",{children:"â€¢"}),a.jsx(K0,{forkCount:d,forkedFromName:p,forkedFromId:u,onClick:m,size:"sm"})]})]}),f&&!l&&a.jsx("div",{"data-test":"session-fork-action",className:"session-fork-action absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity",children:a.jsx(ue,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:x,title:"Fork this session","data-test":"session-fork-btn",children:a.jsx(ts,{size:14})})})]})}const Y0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},X0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1};function eu({value:s,onChange:e,className:t="",placeholder:n="Select a session",label:r="Claude Session",showLabel:o=!0,multiSelect:i=!1}){const[c,l]=h.useState(!1),d=Le(Y0),p=Le(X0),u=Array.isArray(s)?s:s?[s]:[],f=h.useMemo(()=>[...d].sort((v,w)=>{const y=new Date(v.lastModified).getTime();return new Date(w.lastModified).getTime()-y}),[d]),m=f.filter(v=>u.includes(v.id)),g=v=>new Date(v).toLocaleDateString(),x=v=>v?v.split("/").slice(-2).join("/"):"No directory",b=v=>{if(i){const w=u.includes(v)?u.filter(y=>y!==v):[...u,v];e(w)}else e(v===s?"":v),l(!1)};return a.jsxs("div",{"data-test":"session-selector",className:`session-selector-container ${t}`,children:[o&&a.jsx(Se,{"data-test":"session-selector-label",className:"session-selector-label",children:r}),a.jsxs(st,{open:c,onOpenChange:l,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(ue,{"data-test":"session-selector-trigger",variant:"outline",role:"combobox","aria-expanded":c,className:"session-selector-trigger w-full justify-between",disabled:p,children:[m.length>0?a.jsx("span",{className:"truncate",children:i?`${m.length} session${m.length>1?"s":""} selected`:m[0].customName||m[0].name}):a.jsx("span",{className:"text-muted-foreground",children:n}),a.jsx(rc,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),a.jsx(Xe,{"data-test":"session-selector-content",className:"session-selector-content w-[400px] p-0",style:{zIndex:tt.draggablePopoverDropdown},children:a.jsxs(cr,{children:[a.jsx(lr,{"data-test":"session-selector-search",placeholder:"Search sessions..."}),a.jsxs(un,{className:"max-h-[300px]",children:[a.jsx(pn,{children:"No sessions found."}),a.jsxs(Ts,{children:[!i&&a.jsxs(is,{"data-test":"session-selector-item-none",value:"none",onSelect:()=>{e(""),l(!1)},className:"session-selector-item-none",children:[a.jsx(ct,{className:U("mr-2 h-4 w-4",u.length===0?"opacity-100":"opacity-0")}),"No Session"]}),f.map(v=>a.jsx(is,{"data-test":"session-selector-item",value:v.id,onSelect:()=>b(v.id),className:"session-selector-item p-0 cursor-pointer",children:a.jsxs("div",{className:"flex items-center w-full",children:[a.jsx(ct,{className:U("mr-2 h-4 w-4 shrink-0",u.includes(v.id)?"opacity-100":"opacity-0")}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx(Zd,{session:v,isSelected:u.includes(v.id),onClick:()=>{},formatDate:g,formatCwd:x,compact:!0})})]})},v.id))]}),f.length===0&&!p&&a.jsx("div",{"data-test":"session-selector-no-sessions",className:"no-sessions text-center py-4 text-sm text-muted-foreground",children:"No sessions available"}),p&&a.jsx("div",{"data-test":"session-selector-loading",className:"loading-sessions text-center py-4 text-sm text-muted-foreground",children:"Loading sessions..."})]})]})})]})]})}const Q0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]};function Z0({sessionIds:s,currentIndex:e,onIndexChange:t,disabled:n=!1,className:r=""}){const[o,i]=h.useState(!1),[c,l]=h.useState(""),d=Le(Q0),p=h.useMemo(()=>s.map(w=>d.find(y=>y.id===w)).filter(w=>w!==void 0),[s,d]),u=p[e],f=p.filter(w=>(w.customName??w.name).toLowerCase().includes(c.toLowerCase())),m=w=>{t(w),i(!1),l("")},g=w=>{if(w.stopPropagation(),n||p.length===0)return;const y=e-1,j=y<0?p.length-1:y;t(j)},x=w=>{if(w.stopPropagation(),n||p.length===0)return;const y=e+1,j=y>=p.length?0:y;t(j)},b=w=>new Date(w).toLocaleDateString(),v=w=>w?w.split("/").slice(-2).join("/"):"No directory";return p.length===0?null:p.length===1?a.jsx(pt,{variant:"outline",className:U("navigable-session-badge bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed",r),"data-test":"navigable-session-badge-single",children:(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"}):a.jsxs("div",{className:U("navigable-session-selector flex items-center gap-1",r),"data-test":"navigable-session-selector",children:[a.jsx("button",{onClick:g,disabled:n,className:U("chevron-left p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous session","data-test":"navigable-session-previous-button",children:a.jsx(Ds,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(pt,{variant:"outline",className:U("navigable-badge cursor-pointer hover:opacity-80 transition-opacity bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed"),onClick:w=>{w.stopPropagation(),n&&w.preventDefault()},"data-test":"navigable-session-badge",children:[(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"," (",e+1,"/",p.length,")"]})}),a.jsx(Xe,{className:"popover-content w-[400px] p-2",align:"start","data-test":"navigable-session-popover-content",children:a.jsxs("div",{className:"selector-container space-y-2","data-test":"navigable-session-selector-container",children:[a.jsx(We,{placeholder:"Search sessions...",value:c,onChange:w=>l(w.target.value),className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"navigable-session-search-input"}),a.jsx("div",{className:"sessions-list max-h-64 overflow-y-auto space-y-1","data-test":"navigable-session-list",children:f.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"navigable-session-empty-state",children:"No sessions found"}):f.map(w=>{const y=p.indexOf(w);return a.jsxs(ue,{variant:"ghost",className:U("session-item w-full justify-between h-auto px-2 py-1",y===e&&"bg-accent"),onClick:()=>m(y),"data-test":"navigable-session-item",children:[a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx(Zd,{session:w,isSelected:y===e,onClick:()=>{},formatDate:b,formatCwd:v,compact:!0})}),y===e&&a.jsx(ct,{className:"check-icon h-4 w-4 ml-2 shrink-0","data-test":"navigable-session-check-icon"})]},w.id)})})]})})]}),a.jsx("button",{onClick:x,disabled:n,className:U("chevron-right p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Next session","data-test":"navigable-session-next-button",children:a.jsx($t,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]})}function ej(s,e={}){const{loadOnMount:t=!0,subscribeToSSE:n=!0,pageSize:r=50,messageType:o,onSessionDeleted:i}=e,[c,l]=h.useState([]),[d,p]=h.useState(null),[u,f]=h.useState(null),[m,g]=h.useState(!1),[x,b]=h.useState(null),[v,w]=h.useState(1),[y,j]=h.useState(""),[S,C]=h.useState(null),[N,A]=h.useState(!1),k=h.useRef(),E=h.useRef(s),R=h.useRef(new Map);h.useEffect(()=>{E.current=s},[s]);const M=h.useCallback(async(O=1,ee=!1,I=!1)=>{var F,q,J;if(!s)return;const _=s;try{I||g(!0),j(""),C(null),A(!1);const P=o??((J=(q=(F=ie.getState().app)==null?void 0:F.claude)==null?void 0:q.ui)==null?void 0:J.messageFilters),B=await Ye.getSessionDetails(s,{page:O,pageSize:r,messageType:P});if(E.current!==_)return;if(ee)l(se=>[...B.messages,...se]);else{const se=new Set(B.messages.filter(ae=>ae.role==="user").map(ae=>typeof ae.content=="string"?ae.content:JSON.stringify(ae.content)));l(ae=>{const X=ae.filter(ge=>ge._isOptimistic).filter(ge=>{const ce=typeof ge.content=="string"?ge.content:JSON.stringify(ge.content);return!se.has(ce)});return[...B.messages,...X]});const le=R.current.get(s)||[],me=le.filter(ae=>{const H=typeof ae.content=="string"?ae.content:JSON.stringify(ae.content);return!se.has(H)});me.length!==le.length&&R.current.set(s,me)}p({id:s,name:B.name,customName:B.customName,cwd:B.cwd}),f(B.metadata),b(B.pagination??null),w(O)}catch(P){console.error("Failed to load session details:",P),l([]),p(null),f(null),b(null)}finally{I||g(!1)}},[s,r,o]),L=h.useCallback(async(O,ee,I=!1)=>{if(!s)return;const _=s;try{g(!0),j(O),C(ee),A(!0);const F=await Ye.searchSessionMessages(s,O,ee);if(E.current!==_)return;l(I?q=>[...F.results,...q]:F.results),b(F.pagination),w(F.pagination.page)}catch(F){I||l([]),console.error("Failed to search messages:",F)}finally{g(!1)}},[s]),T=h.useCallback(()=>{if(!(!s||!x||v>=x.totalPages))if(N&&y!==void 0){const O={...S,page:v+1};L(y,O,!0)}else M(v+1,!0)},[s,x,v,N,y,S,L,M]),W=h.useCallback(async()=>{s&&(N&&y!==void 0?await L(y,{...S,page:v}):await M(v))},[s,N,y,S,v,L,M]),z=h.useCallback(O=>{if(!s)return"";const ee=`optimistic-${Date.now()}`,I={id:ee,role:"user",content:O,timestamp:new Date().toISOString(),_isOptimistic:!0},_=R.current.get(s)||[];return R.current.set(s,[..._,I]),l(F=>[...F,I]),ee},[s]),te=h.useCallback(O=>{if(s){const ee=R.current.get(s)||[];R.current.set(s,ee.filter(I=>I.id!==O))}l(ee=>ee.filter(I=>I.id!==O))},[s]);return h.useEffect(()=>{const O=s?R.current.get(s)||[]:[];l(O),p(null),f(null),b(null),w(1),j(""),C(null),A(!1),s&&t&&M(1)},[s,t]),h.useEffect(()=>{if(!s)return;const O=ie.selectSlice(ee=>{var I,_,F;return(F=(_=(I=ee.app)==null?void 0:I.claude)==null?void 0:_.ui)==null?void 0:F.messageFilters}).subscribe(ee=>{if(JSON.stringify(k.current)!==JSON.stringify(ee)&&(k.current=ee,!o))if(N&&y!==void 0){const _={...S,messageType:ee,page:1};L(y,_)}else M(1,!1,!0)});return()=>O.unsubscribe()},[s,o,N,y,S,L,M]),Da(O=>{O.type!=="batch-modified"&&("sessionId"in O&&O.sessionId!==s||(O.type==="modified"&&(async()=>{var I,_,F;if(!s)return;const ee=s;try{const q=o??((F=(_=(I=ie.getState().app)==null?void 0:I.claude)==null?void 0:_.ui)==null?void 0:F.messageFilters),J=await Ye.getSessionDetails(s,{page:1,pageSize:r,messageType:q});if(E.current!==ee)return;const P=new Set(J.messages.filter(le=>le.role==="user").map(le=>typeof le.content=="string"?le.content:JSON.stringify(le.content)));l(le=>{const me=new Set(le.filter(X=>!X._isOptimistic).map(X=>X.id)),ae=J.messages.filter(X=>!me.has(X.id)),H=le.filter(X=>{if(!X._isOptimistic)return!0;const ge=typeof X.content=="string"?X.content:JSON.stringify(X.content);return!P.has(ge)});return ae.length===0&&H.length===le.length?le:[...H,...ae]});const B=R.current.get(s)||[],se=B.filter(le=>{const me=typeof le.content=="string"?le.content:JSON.stringify(le.content);return!P.has(me)});se.length!==B.length&&R.current.set(s,se),f(J.metadata)}catch(q){console.error("Failed to fetch new messages on SSE update:",q)}})(),O.type==="deleted"&&(l([]),p(null),f(null),b(null),i==null||i())))},O=>{console.error("SSE connection error in useSessionMessages:",O)},!!s&&n),{messages:c,sessionDetails:d,metadata:u,loading:m,pagination:x,currentPage:v,isSearchActive:N,loadSessionDetails:M,loadOlderMessages:T,searchMessages:L,refreshSession:W,addOptimisticMessage:z,removeOptimisticMessage:te}}function tj({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1}){const[o,i]=h.useState(!1),[c,l]=h.useState(""),d=e.find(x=>x.value===s),p=e.findIndex(x=>x.value===s),u=e.filter(x=>x.label.toLowerCase().includes(c.toLowerCase())),f=x=>{t==null||t(x),i(!1),l("")},m=x=>{if(x.stopPropagation(),r)return;const b=p-1,v=b<0?e.length-1:b;t==null||t(e[v].value)},g=x=>{if(x.stopPropagation(),r)return;const b=p+1,v=b>=e.length?0:b;t==null||t(e[v].value)};return d?a.jsxs("div",{className:"navigable-select-container flex items-center gap-1",children:[a.jsx("button",{onClick:m,disabled:r,className:U("chevron-left p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous option",children:a.jsx(Ds,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsx(pt,{variant:d.variant||"secondary",className:U("navigable-badge cursor-pointer hover:opacity-80 transition-opacity",d.className,r&&"opacity-50 cursor-not-allowed"),onClick:x=>{x.stopPropagation(),r&&x.preventDefault()},children:d.label})}),a.jsx(Xe,{className:"popover-content w-64 p-2",align:"start",children:a.jsxs("div",{className:"selector-container space-y-2",children:[a.jsx(We,{placeholder:n,value:c,onChange:x=>l(x.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),a.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(x=>a.jsxs(ue,{variant:"ghost",className:U("option-item w-full justify-between h-8 px-2",x.value===s&&"bg-accent"),onClick:()=>f(x.value),children:[a.jsx(pt,{variant:x.variant||"secondary",className:U("text-xs",x.className),children:x.label}),x.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4"})]},x.value))})]})})]}),a.jsx("button",{onClick:g,disabled:r,className:U("chevron-right p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Next option",children:a.jsx($t,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]}):null}function Gs(){var s;try{const e=(s=ie.getState().app)==null?void 0:s.kanban;return e?{spaces:e.spaces??[],activeSpaceId:e.activeSpaceId??"all",customPresets:e.customPresets??[],activePresetId:e.activePresetId??"all",currentFilters:e.currentFilters??ja,customCategories:e.customCategories??[]}:null}catch(e){return console.error("Failed to load persisted Kanban state:",e),null}}function _n(s){var e;try{const t=ie.getState();ie.updateState({app:{...t.app,kanban:{...(e=t.app)==null?void 0:e.kanban,...s}}})}catch(t){console.error("Failed to save persisted Kanban state:",t)}}function sj(){try{const s=ie.getState();ie.updateState({app:{...s.app,kanban:void 0}})}catch(s){console.error("Failed to clear persisted Kanban state:",s)}}const GC={id:!0,title:!0,description:!0,status:!0,priority:!0,category:!0,space:!0,claudeProjectPath:!0,dueDate:!0,createdAt:!0,updatedAt:!0,completedAt:!0,tags:!0,subtasks:!0},ja={searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[Je.FREEZER,Je.BACKLOG,Je.SELECTED,Je.DOING,Je.DONE,Je.ARCHIVE]};function nj(s){return s&&s.version==="4.0"&&"todos"in s&&"spaces"in s}function rj(s){return{version:"4.0",exportedAt:new Date().toISOString(),...s,loading:!1,error:void 0}}const aj=[{value:Zt.PERSONAL,label:"Personal",variant:"secondary",className:"bg-purple-100 text-purple-800 border-purple-200"},{value:Zt.WORK,label:"Work",variant:"secondary",className:"bg-indigo-100 text-indigo-800 border-indigo-200"},{value:Zt.SHOPPING,label:"Shopping",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Zt.HEALTH,label:"Health",variant:"secondary",className:"bg-pink-100 text-pink-800 border-pink-200"},{value:Zt.OTHER,label:"Other",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}],Or=["bg-red-100 text-red-800 border-red-200","bg-orange-100 text-orange-800 border-orange-200","bg-amber-100 text-amber-800 border-amber-200","bg-yellow-100 text-yellow-800 border-yellow-200","bg-lime-100 text-lime-800 border-lime-200","bg-emerald-100 text-emerald-800 border-emerald-200","bg-teal-100 text-teal-800 border-teal-200","bg-cyan-100 text-cyan-800 border-cyan-200","bg-sky-100 text-sky-800 border-sky-200","bg-blue-100 text-blue-800 border-blue-200","bg-violet-100 text-violet-800 border-violet-200","bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200","bg-rose-100 text-rose-800 border-rose-200"];class oj{getAllCategories(){const e=this.getCustomCategories();return[...aj,...e]}getCustomCategories(){try{const e=Gs();return(e==null?void 0:e.customCategories)??[]}catch(e){return console.error("[CategoryFacade] Failed to load custom categories:",e),[]}}createCategory(e){try{if(!e||!e.trim())return{success:!1,error:"Category label cannot be empty"};const t=e.trim();if(this.getAllCategories().find(f=>f.label.toLowerCase()===t.toLowerCase()))return{success:!1,error:`Category "${t}" already exists`};const o=`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=this.getCustomCategories(),c=i.map(f=>f.className||""),l=this.getRandomColorClass(c),d={id:o,value:o,label:t,variant:"secondary",className:l,isCustom:!0},p=Gs(),u=[...i,d];return _n({...p,spaces:(p==null?void 0:p.spaces)??[],activeSpaceId:(p==null?void 0:p.activeSpaceId)??"all",customPresets:(p==null?void 0:p.customPresets)??[],activePresetId:(p==null?void 0:p.activePresetId)??"all",currentFilters:(p==null?void 0:p.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:u}),{success:!0,category:d}}catch(t){return console.error("[CategoryFacade] Failed to create category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}deleteCategory(e){try{if(this.isDefaultCategory(e))return{success:!1,error:"Cannot delete default categories"};const t=this.getCustomCategories();if(!t.find(i=>i.id===e))return{success:!1,error:`Category with ID "${e}" not found`};const r=t.filter(i=>i.id!==e),o=Gs();return _n({...o,spaces:(o==null?void 0:o.spaces)??[],activeSpaceId:(o==null?void 0:o.activeSpaceId)??"all",customPresets:(o==null?void 0:o.customPresets)??[],activePresetId:(o==null?void 0:o.activePresetId)??"all",currentFilters:(o==null?void 0:o.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:r}),{success:!0,deletedId:e}}catch(t){return console.error("[CategoryFacade] Failed to delete category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}isDefaultCategory(e){return Object.values(Zt).includes(e)}categoryExists(e){return this.getAllCategories().some(n=>n.value===e)}getCategoryByValue(e){return this.getAllCategories().find(n=>n.value===e)}clearAllCustomCategories(){try{const e=Gs();_n({...e,spaces:(e==null?void 0:e.spaces)??[],activeSpaceId:(e==null?void 0:e.activeSpaceId)??"all",customPresets:(e==null?void 0:e.customPresets)??[],activePresetId:(e==null?void 0:e.activePresetId)??"all",currentFilters:(e==null?void 0:e.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:[]}),console.info("[CategoryFacade] Cleared all custom categories")}catch(e){console.error("[CategoryFacade] Failed to clear custom categories:",e)}}getRandomColorClass(e){const t=Or.filter(n=>!e.includes(n));return t.length===0?Or[Math.floor(Math.random()*Or.length)]:t[Math.floor(Math.random()*t.length)]}}const js=new oj,ij=s=>{var e,t;return((t=(e=s.app)==null?void 0:e.kanban)==null?void 0:t.customCategories)??[]};function cj({value:s,onChange:e,placeholder:t="Search categories...",disabled:n=!1}){const[r,o]=h.useState(!1),[i,c]=h.useState(""),l=Le(ij),d=h.useMemo(()=>js.getAllCategories(),[l]),p=d.find(v=>v.value===s),u=d.filter(v=>v.label.toLowerCase().includes(i.toLowerCase())),f=h.useCallback(v=>{e==null||e(v),o(!1),c("")},[e]),m=h.useCallback(()=>{if(!i.trim())return;const v=js.createCategory(i.trim());v.success&&v.category?(f(v.category.value),c("")):console.error("[CategorySelector] Failed to create category:",v.error)},[i,f]),g=h.useCallback((v,w)=>{var j;if(v.stopPropagation(),js.isDefaultCategory(w))return;const y=js.deleteCategory(w);if(y.success){if(s===w){const S=js.getAllCategories();f(((j=S[0])==null?void 0:j.value)||"")}}else console.error("[CategorySelector] Failed to delete category:",y.error)},[s,f]),x=h.useCallback(v=>{o(v),v||c("")},[]);if(!p)return null;const b=i.trim()&&u.length===0;return a.jsxs(st,{open:r,onOpenChange:x,children:[a.jsx(ut,{asChild:!0,children:a.jsx(pt,{"data-test":"category-selector-trigger",variant:p.variant||"secondary",className:U("cursor-pointer hover:opacity-80 transition-opacity",p.className,n&&"opacity-50 cursor-not-allowed"),onClick:v=>{v.stopPropagation(),n&&v.preventDefault()},children:p.label})}),a.jsx(Xe,{className:"popover-content w-64 p-2",align:"start","data-test":"category-selector-popover",children:a.jsxs("div",{className:"selector-container space-y-2","data-test":"category-selector-container",children:[a.jsx(We,{"data-test":"category-search-input",placeholder:t,value:i,onChange:v=>c(v.target.value),onKeyDown:v=>{v.key==="Enter"&&b&&(v.preventDefault(),m())},className:"search-input h-8 text-sm",autoFocus:!0}),a.jsxs("div",{className:"options-list max-h-64 overflow-y-auto space-y-1","data-test":"category-options-list",children:[u.length===0&&!b&&a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"category-empty-state",children:"No options found"}),b&&a.jsxs(ue,{"data-test":"category-create-button",variant:"ghost",className:"category-create-button w-full justify-start h-8 px-2 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:m,children:[a.jsx(Ks,{className:"create-icon h-4 w-4 mr-2","data-test":"category-create-icon"}),'Create "',i,'"']}),u.map(v=>{const w=!js.isDefaultCategory(v.value);return a.jsxs("div",{"data-test":"category-option-wrapper",className:U("option-item-wrapper flex items-center gap-1",v.value===s&&"bg-accent rounded"),children:[a.jsxs(ue,{"data-test":"category-option-button",variant:"ghost",className:U("option-item flex-1 justify-between h-8 px-2"),onClick:()=>f(v.value),children:[a.jsx(pt,{"data-test":"category-option-badge",variant:v.variant||"secondary",className:U("text-xs",v.className),children:v.label}),v.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4","data-test":"category-selected-check"})]}),w&&a.jsx(ue,{"data-test":"category-delete-button",variant:"ghost",size:"icon",className:"category-delete-button h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50",onClick:y=>g(y,v.value),title:"Delete category",children:a.jsx(Et,{className:"delete-icon h-4 w-4","data-test":"category-delete-icon"})})]},v.value)})]})]})})]})}function er(){return"xxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class qC{constructor(e){Z(this,"items",[]);this.initialItems=e,e&&(e.forEach(t=>{t.id===void 0&&(t.id=er())}),this.items=e)}create(e,t={}){const n={id:er(),created:new Date().toISOString(),...e},{allowDuplicate:r,uniqueByKey:o}=t;if(r)return this.items.push(n),n;let i=-1;if(o&&(i=this.items.findIndex(p=>p[o]===n[o])),i!==-1)return;const l=this.items.findIndex(p=>p.id===n.id);return l!==-1?(this.items[l]=n,n):(this.items.push(n),n)}insertAt(e,t){const n=structuredClone(this.items);return n.splice(e,0,...t),n}batchCreate(e){this.items.push(...e)}readAll(e=!0){return e?structuredClone(this.items):this.items}readBetween(e,t){const n=[];for(let r=e;r<=t;r++){const o=this.items[r];n.push(o)}return n}readById(e){return this.items.find(t=>t.id===e)}readByKey(e,t){return this.items.find(n=>n[e]===t)}readFirst(){return this.items.length===0?void 0:this.items[0]}readLast(){return this.items.length===0?void 0:this.items[this.items.length-1]}update(e){const t=this.items.findIndex(n=>n.id===e.id);t!==-1&&(this.items[t]=e)}batchUpdate(e){e.forEach(t=>{const n=this.items.findIndex(r=>r.id===t.id);n!==-1&&(this.items[n]=t)})}delete(e){console.log("[CRUDService.ts,123] this.items: ",this.items);const t=this.items.findIndex(n=>n.id===e);console.log("[CRUDService.ts,123] indexToDelete: ",t),t!==-1&&this.items.splice(t,1)}deleteByKey(e,t){this.items=this.items.filter(n=>n[e]!==t)}deleteBetween(e,t){const n=this.items.slice(0,e),r=this.items.slice(t+1,this.items.length);return[...n,...r]}batchDelete(e){this.items=this.items.filter(t=>!e.includes(t.id))}getPreviousItem(e){const n=this.getCurrentItemIndex(e)-1,r=Math.max(n,0);return this.items[r]}getNextItem(e){const n=this.getCurrentItemIndex(e)+1,r=this.count()-1,o=Math.min(n,r);return this.items[o]}getCurrentItemIndex(e){return this.findIndexByKey("id",e)}count(){return this.items.length}clear(){this.items=[]}filterByKey(e,t){return this.items.filter(n=>n[e]===t)}findByKey(e,t){return this.items.find(n=>n[e]===t)}findIndexByKey(e,t){return this.items.findIndex(n=>n[e]===t)}replace(e){e&&(this.items=e)}replaceOne(e,t){console.log(">>>> _ >>>> ~ file: CRUDService.ts:203 ~ replace:",t);const n=structuredClone(this.items);return n[e]=t,n}sort(e,t=!0){this.items.sort((n,r)=>{const o=n[e],i=r[e];return o===i?0:t?o<i?-1:1:o>i?-1:1})}}const lj="TodoDB",dj=2,ot="todos";class uj{constructor(){Z(this,"db",null)}async init(){return new Promise((e,t)=>{const n=indexedDB.open(lj,dj);n.onerror=()=>{t(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const o=r.target.result,i=r.target.transaction,c=r.oldVersion;if(!o.objectStoreNames.contains(ot)){const l=o.createObjectStore(ot,{keyPath:"id.value"});l.createIndex("status","status",{unique:!1}),l.createIndex("priority","priority",{unique:!1}),l.createIndex("category","category",{unique:!1}),l.createIndex("createdAt","createdAt.value",{unique:!1}),l.createIndex("dueDate","dueDate.value",{unique:!1}),l.createIndex("sortOrder","sortOrder",{unique:!1})}if(c<2){const l=i.objectStore(ot);l.indexNames.contains("sortOrder")||l.createIndex("sortOrder","sortOrder",{unique:!1});const d=l.getAll();d.onsuccess=()=>{const p=d.result,u={};p.forEach(f=>{const m=f.status||"backlog";u[m]||(u[m]=[]),u[m].push(f)}),Object.keys(u).forEach(f=>{u[f].forEach((m,g)=>{m.sortOrder===void 0&&(m.sortOrder=g,l.put(m))})})}}}})}async getAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([ot],"readonly").objectStore(ot).getAll();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to get todos"))}})}async getById(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([ot],"readonly").objectStore(ot).get(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{n(new Error("Failed to get todo"))}})}async add(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([ot],"readwrite").objectStore(ot).add(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to add todo"))}})}async update(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([ot],"readwrite").objectStore(ot).put(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to update todo"))}})}async delete(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([ot],"readwrite").objectStore(ot).delete(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to delete todo"))}})}async clear(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([ot],"readwrite").objectStore(ot).clear();o.onsuccess=()=>{e()},o.onerror=()=>{t(new Error("Failed to clear todos"))}})}async count(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([ot],"readonly").objectStore(ot).count();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to count todos"))}})}}const dt=new uj;function pj(s){return s&&typeof s=="object"&&("claudeProject"in s||"sessionIds"in s)}class hj{constructor(){Z(this,"initialized",!1)}async init(){if(this.initialized)return;await dt.init(),this.initialized=!0,await dt.count()===0&&await this.seedMockData()}createTodoId(e){return{value:e}}createTimestamp(e){return{value:e??new Date}}async createTodo(e){await this.init();const t=e.status??Je.BACKLOG;let n=e.sortOrder;if(n===void 0){const i=(await dt.getAll()).filter(l=>l.status===t);n=(i.length>0?Math.max(...i.map(l=>l.sortOrder??0)):-1)+1}const r={id:this.createTodoId(er()),title:e.title,description:e.description,status:t,priority:e.priority??qt.MEDIUM,category:e.category??Zt.PERSONAL,space:e.space,sortOrder:n,dueDate:e.dueDate?this.createTimestamp(e.dueDate):void 0,createdAt:this.createTimestamp(),updatedAt:this.createTimestamp(),tags:e.tags??[],subtasks:[],customProps:e.customProps};return await dt.add(r),r}async getTodo(e){await this.init();const t=await dt.getById(e.value);if(!t)throw new Error(`Todo with id ${e.value} not found`);return t}async getAllTodos(e){await this.init();let t=await dt.getAll();if(e!=null&&e.filters){const{status:n,priority:r,category:o,space:i,claudeProjectPath:c,tags:l,searchQuery:d}=e.filters;if(n&&n.length>0&&(t=t.filter(p=>n.includes(p.status))),r&&r.length>0&&(t=t.filter(p=>r.includes(p.priority))),o&&o.length>0&&(t=t.filter(p=>o.includes(p.category))),i&&i.length>0&&(t=t.filter(p=>p.space&&i.includes(p.space))),c&&c.length>0&&(t=t.filter(p=>{if(pj(p.customProps))return p.customProps.claudeProjectPath&&c.includes(p.customProps.claudeProjectPath)})),l&&l.length>0&&(t=t.filter(p=>l.some(u=>p.tags.includes(u)))),d){const p=d.toLowerCase();t=t.filter(u=>{var f;return u.title.toLowerCase().includes(p)||((f=u.description)==null?void 0:f.toLowerCase().includes(p))})}}if(e!=null&&e.sort){const{field:n,direction:r}=e.sort;t.sort((o,i)=>{const c=o[n],l=i[n];if(c==null||l===void 0||l===null)return 0;const d=c<l?-1:c>l?1:0;return r==="asc"?d:-d})}else t.sort((n,r)=>(n.sortOrder??0)-(r.sortOrder??0));if((e==null?void 0:e.offset)!==void 0||(e==null?void 0:e.limit)!==void 0){const n=e.offset??0,r=e.limit??t.length;t=t.slice(n,n+r)}return t}async updateTodo(e,t){await this.init();const n=await this.getTodo(e),r={...n,...t,dueDate:t.dueDate?this.createTimestamp(t.dueDate instanceof Date?t.dueDate:new Date(t.dueDate.value)):n.dueDate,updatedAt:this.createTimestamp(),customProps:t.customProps?{...n.customProps,...t.customProps}:n.customProps};return await dt.update(r),r}async deleteTodo(e){await this.init(),await dt.delete(e.value)}async startTodo(e){return this.updateTodo(e,{status:Je.DOING})}async completeTodo(e){const t=await this.updateTodo(e,{status:Je.DONE});return t.completedAt=this.createTimestamp(),await dt.update(t),t}async cancelTodo(e){return this.updateTodo(e,{status:Je.ARCHIVE})}async addSubtask(e,t){await this.init();const n=await this.getTodo(e),r={id:this.createTodoId(er()),title:t.title,isCompleted:!1,createdAt:this.createTimestamp()};return n.subtasks.push(r),n.updatedAt=this.createTimestamp(),await dt.update(n),n}async updateSubtask(e,t,n){await this.init();const r=await this.getTodo(e),o=r.subtasks.find(i=>i.id.value===t.value);if(!o)throw new Error(`Subtask with id ${t.value} not found`);return n.title!==void 0&&(o.title=n.title),n.isCompleted!==void 0&&(o.isCompleted=n.isCompleted),r.updatedAt=this.createTimestamp(),await dt.update(r),r}async toggleSubtask(e,t){await this.init();const n=await this.getTodo(e),r=n.subtasks.find(o=>o.id.value===t.value);if(!r)throw new Error(`Subtask with id ${t.value} not found`);return r.isCompleted=!r.isCompleted,n.updatedAt=this.createTimestamp(),await dt.update(n),n}async removeSubtask(e,t){await this.init();const n=await this.getTodo(e);return n.subtasks=n.subtasks.filter(r=>r.id.value!==t.value),n.updatedAt=this.createTimestamp(),await dt.update(n),n}async bulkUpdateStatus(e,t){await this.init(),await Promise.all(e.map(n=>this.updateTodo(n,{status:t})))}async bulkDelete(e){await this.init(),await Promise.all(e.map(t=>this.deleteTodo(t)))}async seedMockData(){const e=[];for(const n of e){const r=await this.createTodo(n);n.title==="Complete project documentation"&&(await this.addSubtask(r.id,{title:"Write API documentation"}),await this.addSubtask(r.id,{title:"Create usage examples"}),await this.addSubtask(r.id,{title:"Add screenshots"})),n.title==="Buy groceries"&&(await this.addSubtask(r.id,{title:"Check pantry inventory"}),await this.addSubtask(r.id,{title:"Make shopping list"}))}const t=await this.getAllTodos();t.length>0&&await this.startTodo(t[0].id),t.length>3&&await this.completeTodo(t[3].id)}async clearAllTodos(){await this.init(),await dt.clear()}async exportTodos(){await this.init();const e=await this.getAllTodos(),t=Gs(),n={todos:e,spaces:(t==null?void 0:t.spaces)??[],activeSpaceId:(t==null?void 0:t.activeSpaceId)??"all",customPresets:(t==null?void 0:t.customPresets)??[],activePresetId:(t==null?void 0:t.activePresetId)??"all",currentFilters:(t==null?void 0:t.currentFilters)??ja,customCategories:(t==null?void 0:t.customCategories)??[],loading:!1},r={...n,todos:n.todos.map(i=>({...i,createdAt:{value:i.createdAt.value.toISOString()},updatedAt:{value:i.updatedAt.value.toISOString()},completedAt:i.completedAt?{value:i.completedAt.value.toISOString()}:void 0,dueDate:i.dueDate?{value:i.dueDate.value.toISOString()}:void 0,subtasks:i.subtasks.map(c=>({...c,createdAt:{value:c.createdAt.value.toISOString()}}))}))},o=rj(r);return JSON.stringify(o,null,2)}async importTodos(e,t){var d,p,u;await this.init();const n=[];let r=0,o=0,i=0,c=0,l=0;try{const f=JSON.parse(e);if(!nj(f))throw new Error("Invalid format: Expected KanbanExportData v4.0 format");const m=f;t!=null&&t.replace&&(await this.clearAllTodos(),sj());const g=m.todos??[];for(const x of g)try{const b={...x,createdAt:{value:new Date(x.createdAt.value)},updatedAt:{value:new Date(x.updatedAt.value)},completedAt:x.completedAt?{value:new Date(x.completedAt.value)}:void 0,dueDate:x.dueDate?{value:new Date(x.dueDate.value)}:void 0,subtasks:(x.subtasks??[]).map(w=>({...w,createdAt:{value:new Date(w.createdAt.value)}}))};await dt.getById(b.id.value)&&!(t!=null&&t.replace)?o++:(await dt.add(b),r++)}catch(b){n.push(`Failed to import todo "${x.title}": ${b instanceof Error?b.message:"Unknown error"}`),o++}try{const x={spaces:m.spaces??[],activeSpaceId:m.activeSpaceId??"all",customPresets:m.customPresets??[],activePresetId:m.activePresetId??"all",currentFilters:m.currentFilters??ja,customCategories:m.customCategories??[]};_n(x),c=((d=m.spaces)==null?void 0:d.length)??0,i=((p=m.customPresets)==null?void 0:p.length)??0,l=((u=m.customCategories)==null?void 0:u.length)??0}catch(x){n.push(`Failed to save persisted state: ${x instanceof Error?x.message:"Unknown error"}`)}return{imported:r,skipped:o,errors:n,presetsImported:i,spacesImported:c,categoriesImported:l}}catch(f){throw new Error(`Failed to parse JSON: ${f instanceof Error?f.message:"Unknown error"}`)}}}const et=new hj;class fj{async createTicket(e,t){await et.createTodo({...t,status:e})}}class mj{async createSessionForTodo(e,t){const n=await Ye.createSession({message:t.message,cwd:t.projectPath,projectId:t.projectPath,options:{outputFormat:t.outputFormat,permissionMode:t.permissionMode}});return n.success&&n.sessionId&&await this.linkSessionToTodo(e,n.sessionId),n}async linkSessionToTodo(e,t,n={mode:"append"}){var c;const r=await et.getTodo(e),o=((c=r.customProps)==null?void 0:c.sessionIds)??[],i=n.mode==="replace"?[t]:[...o,t];await et.updateTodo(e,{customProps:{...r.customProps,sessionIds:i}})}async unlinkSessionFromTodo(e,t){var i;const n=await et.getTodo(e),o=(((i=n.customProps)==null?void 0:i.sessionIds)??[]).filter(c=>c!==t);await et.updateTodo(e,{customProps:{...n.customProps,sessionIds:o}})}async getSessionsForTodo(e){var n;return((n=(await et.getTodo(e)).customProps)==null?void 0:n.sessionIds)??[]}async hasLinkedSessions(e){return(await this.getSessionsForTodo(e)).length>0}buildInitialMessageFromTodo(e){const t=[];if(t.push(`# ${e.title}
`),e.description&&(t.push("## Description"),t.push(e.description),t.push("")),e.dueDate){const n=new Date(e.dueDate.value);t.push(`**Due Date:** ${n.toLocaleDateString()}`),t.push("")}return e.subtasks&&e.subtasks.length>0&&(t.push("## Subtasks"),e.subtasks.forEach(n=>{const r=n.isCompleted?"[x]":"[ ]";t.push(`${r} ${n.title}`)}),t.push("")),e.tags&&e.tags.length>0&&(t.push(`**Tags:** ${e.tags.join(", ")}`),t.push("")),t.push("---"),t.push("I permit and approve all file changes in this session to help complete this task."),t.join(`
`)}async createSessionWithTodoContext(e,t,n={}){var l;const r=await et.getTodo(e),o=this.buildInitialMessageFromTodo(r),i=t?`${o}

---

${t}`:o,c=n.projectPath??((l=r.customProps)==null?void 0:l.claudeProjectPath);return this.createSessionForTodo(e,{message:i,projectPath:c,outputFormat:n.outputFormat,permissionMode:n.permissionMode})}async setProjectPath(e,t){const n=await et.getTodo(e);await et.updateTodo(e,{customProps:{...n.customProps,claudeProjectPath:t}})}async getProjectPath(e){var n;return(n=(await et.getTodo(e)).customProps)==null?void 0:n.claudeProjectPath}}class gj{constructor(){Z(this,"column");Z(this,"claude");this.column=new fj,this.claude=new mj}async createTestFailureTicket(e){const t=this.buildFailureDescription(e),n=`[Test Failure] ${e.scenario}`;await this.column.createTicket(Je.BACKLOG,{title:n,description:t,priority:qt.HIGH,category:Zt.WORK,tags:["test-failure","bdd",e.feature.toLowerCase().replace(/\s+/g,"-")],customProps:{testFailureId:e.id,feature:e.feature,scenario:e.scenario,failedStep:e.failedStep,stepType:e.stepType,stepIndex:e.stepIndex,timestamp:e.timestamp}})}async sendTestFailureToClaude(e,t){const n=this.buildClaudeMessage(e);return await Ye.createSession({message:n,cwd:t==null?void 0:t.projectPath,projectId:t==null?void 0:t.projectPath,options:{outputFormat:t==null?void 0:t.outputFormat,permissionMode:t==null?void 0:t.permissionMode}})}buildClaudeMessage(e){const t=[];return t.push(`I have a BDD test failure that needs debugging help.
`),t.push("## Test Context"),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Step Type:** ${e.stepType||"Unknown"}`),t.push(`**Step Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Step Text:** \`${e.failedStep}\`
`)),t.push("## Error Details"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
## Request`),t.push("Please help me understand:"),t.push("1. What caused this test failure?"),t.push("2. What is the root cause of the error?"),t.push("3. How can I fix this issue?"),t.push("4. Are there any related issues I should be aware of?"),t.join(`
`)}buildFailureDescription(e){const t=[];return t.push(`# Test Failure Report
`),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Type:** ${e.stepType||"Unknown"}`),t.push(`**Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Text:** ${e.failedStep}
`)),t.push("## Error"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
---`),t.push("**Next Steps:**"),t.push("1. Review the error and failed step"),t.push("2. Reproduce the issue locally"),t.push("3. Send to Claude for analysis (Future: Phase 3)"),t.join(`
`)}}const tu=new gj,xj=[{value:qt.LOW,label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:qt.MEDIUM,label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:qt.HIGH,label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:qt.URGENT,label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],vj=[{value:Je.FREEZER,label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:Je.BACKLOG,label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Je.SELECTED,label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:Je.DOING,label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Je.DONE,label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Je.ARCHIVE,label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],bj=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},wj=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1};function yj({todo:s,mode:e,onUpdate:t,onClose:n,activeSessionId:r,isProcessingAll:o=!1,currentProcessingSubtaskId:i=null,onProcessAll:c,onStopProcessing:l}){const[d,p]=h.useState(""),[u,f]=h.useState(""),[m,g]=h.useState(""),[x,b]=h.useState(""),[v,w]=h.useState(""),[y,j]=h.useState(Je.BACKLOG),[S,C]=h.useState(qt.MEDIUM),[N,A]=h.useState(""),[k,E]=h.useState([]),[R,M]=h.useState([]),[L,T]=h.useState([]),[W,z]=h.useState(void 0),[te,O]=h.useState(0),[ee,I]=h.useState({}),_=h.useRef(null),F=h.useRef({}),q=Le(bj),J=Le(wj);h.useEffect(()=>{var D,Y;s?(p(s.title),f(s.description??""),g(s.dueDate?new Date(s.dueDate.value).toISOString().split("T")[0]:""),j(s.status),C(s.priority),A(s.category),E(s.tags),M(s.subtasks),T(((D=s.customProps)==null?void 0:D.sessionIds)??[]),z((Y=s.customProps)==null?void 0:Y.claudeProjectPath)):(p(""),f(""),g(""),j(Je.BACKLOG),C(qt.MEDIUM),A(""),E([]),M([]),T([]),z(void 0))},[s]);const P=h.useCallback((D,Y)=>{const we=F.current[D],ne=we==null?void 0:we.getTextArea();if(!ne||!Y)return 1;const xe=ne.offsetWidth;if(xe===0)return 1;const K=window.getComputedStyle(ne),he=K.font,je=K.lineHeight,Ie=je==="normal"?parseFloat(K.fontSize)*1.2:parseFloat(je),Te=Vn(Y,xe,he,Ie);return Math.max(1,Math.ceil(Te/Ie))},[]);h.useEffect(()=>{const D={};R.forEach(Y=>{const we=P(Y.id.value,Y.title);D[Y.id.value]=we}),I(D)},[R,P]),h.useEffect(()=>{var Y;const D=(Y=_.current)==null?void 0:Y.getTextArea();if(D){const we=()=>{const xe=D.offsetWidth;O(xe)};we();const ne=new ResizeObserver(we);return ne.observe(D),()=>{ne.disconnect()}}},[]);const B=h.useCallback(async D=>{if(e==="edit"&&s)try{await et.updateTodo(s.id,D),t()}catch(Y){console.error("Failed to update todo:",Y)}},[e,s,t]),se=h.useCallback(async()=>{if(e==="create"&&d.trim())try{await tu.column.createTicket(y,{title:d.trim(),description:u.trim()||void 0,priority:S,category:N||void 0,tags:k,dueDate:m?new Date(m):void 0,customProps:{sessionIds:L,claudeProject:W}}),t(),n()}catch(D){console.error("Failed to create todo:",D)}},[e,d,u,y,S,N,k,m,L,W,t,n]);h.useCallback(()=>{e==="edit"&&s&&d!==s.title&&d.trim()&&B({title:d})},[e,s,d,B]);const le=h.useCallback(()=>{e==="edit"&&s&&u!==(s.description??"")&&B({description:u})},[e,s,u,B]),me=h.useCallback(D=>{g(D),e==="edit"&&B(D?{dueDate:{value:new Date(D)}}:{dueDate:void 0})},[e,B]),ae=h.useCallback(()=>{const D=x.trim();if(D&&!k.includes(D)){const Y=[...k,D];E(Y),e==="edit"&&B({tags:Y}),b("")}},[x,k,e,B]),H=h.useCallback(D=>{const Y=k.filter(we=>we!==D);E(Y),e==="edit"&&B({tags:Y})},[k,e,B]),X=h.useCallback(async()=>{if(v.trim())if(e==="edit"&&s)try{await et.addSubtask(s.id,{title:v.trim()}),w(""),t()}catch(D){console.error("Failed to add subtask:",D)}else M([...R,{id:{value:`temp-${Date.now()}`},title:v.trim(),isCompleted:!1}]),w("")},[e,s,v,R,t]),ge=h.useCallback(async D=>{if(e==="edit"&&s)try{await et.toggleSubtask(s.id,D),t()}catch(Y){console.error("Failed to toggle subtask:",Y)}else M(R.map(Y=>Y.id.value===D.value?{...Y,isCompleted:!Y.isCompleted}:Y))},[e,s,R,t]),ce=h.useCallback(async D=>{if(e==="edit"&&s)try{await et.removeSubtask(s.id,D),t()}catch(Y){console.error("Failed to remove subtask:",Y)}else M(R.filter(Y=>Y.id.value!==D.value))},[e,s,R,t]),Ae=h.useCallback(async()=>{if(u.trim())try{const D=u.split(`
`),Y=[];for(const we of D){const ne=we.trim(),K=/^-\s*\[([ x])\]\s*(.+)$/i.exec(ne);if(K){const Ie=K[1].toLowerCase()==="x",Te=K[2].trim();Te&&Y.push({title:Te,isCompleted:Ie});continue}const je=/^-\s+(.+)$/.exec(ne);if(je){const Ie=je[1].trim();Ie&&Y.push({title:Ie,isCompleted:!1})}}if(e==="edit"&&s){for(const we of Y){const ne=await et.addSubtask(s.id,{title:we.title});if(we.isCompleted){const xe=ne.subtasks[ne.subtasks.length-1];xe&&await et.toggleSubtask(s.id,xe.id)}}t()}else{const we=Y.map((ne,xe)=>({id:{value:`temp-${Date.now()}-${xe}`},title:ne.title,isCompleted:ne.isCompleted}));M([...R,...we])}}catch(D){console.error("Failed to split tasks:",D)}},[e,s,u,R,t]),Ce=h.useCallback(D=>{j(D),e==="edit"&&B({status:D})},[e,B]),ve=h.useCallback(D=>{C(D),e==="edit"&&B({priority:D})},[e,B]),$=h.useCallback(D=>{A(D),e==="edit"&&B({category:D})},[e,B]),re=h.useCallback(D=>{const Y=Array.isArray(D)?D:[D];T(Y),e==="edit"&&B({customProps:{sessionIds:Y}})},[e,B]),G=h.useCallback(D=>{var we,ne,xe;z(D);const Y=ie.getState();ie.updateState({app:{...Y.app,claude:{...(we=Y.app)==null?void 0:we.claude,ui:{...(xe=(ne=Y.app)==null?void 0:ne.claude)==null?void 0:xe.ui,selectedProjectPath:D}}}}),e==="edit"&&B({customProps:{claudeProjectPath:D}})},[e,B]),oe=h.useMemo(()=>q.map(D=>({value:D.path,label:D.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[q]),de=h.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...oe],[oe]);h.useCallback(D=>{p(D.target.value)},[]);const pe=h.useCallback(D=>{f(D.target.value)},[]),fe=h.useCallback(D=>{D.key==="Escape"&&D.currentTarget.blur()},[]),be=h.useCallback(D=>{b(D.target.value)},[]),Pe=h.useCallback(D=>{D.key==="Enter"&&(D.preventDefault(),ae())},[ae]),Ee=h.useCallback(D=>{w(D.target.value)},[]),V=h.useCallback(D=>{D.key==="Enter"&&!D.shiftKey&&(D.preventDefault(),X())},[X]);return a.jsxs("div",{className:"details-grid grid grid-cols-4 gap-6","data-test":"todo-details-form",children:[a.jsxs("div",{className:"left-column col-span-3 space-y-6","data-test":"todo-details-left-column",children:[a.jsxs("div",{className:"form-field-description space-y-2","data-test":"todo-details-description-field",children:[a.jsx(Se,{htmlFor:"description","data-test":"todo-details-description-label",children:"Description"}),a.jsx(as,{value:u,onChange:pe,onBlur:le,onKeyDown:fe,placeholder:"Enter description...",rows:12,className:"description-textarea min-h-[100px] w-full","data-test":"todo-details-description-textarea",useMarkdown:!0}),a.jsxs("div",{className:"description-actions mt-2 flex gap-2 justify-between","data-test":"todo-details-description-actions",children:[a.jsx(ue,{onClick:Ae,size:"sm",variant:"outline",className:"split-tasks-button",disabled:!u.trim(),"data-test":"todo-details-split-tasks-button",children:"Split Tasks"}),e==="edit"?a.jsx(ue,{onClick:le,size:"sm",variant:"outline",className:"save-description-button","data-test":"todo-details-save-description-button",children:"Save"}):a.jsx(ue,{onClick:se,size:"sm",variant:"default",className:"create-todo-button",disabled:!d.trim(),"data-test":"todo-details-create-button",children:"Create Todo"})]})]}),a.jsxs("div",{className:"form-field-subtasks space-y-2","data-test":"todo-details-subtasks-field",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{"data-test":"todo-details-subtasks-label",children:"Subtasks"}),e==="edit"&&r&&R.some(D=>!D.isCompleted)&&(c??l)&&a.jsx(ue,{size:"sm",variant:o?"destructive":"outline",onClick:o?l:c,className:"process-all-button","data-test":"todo-details-process-all-button",children:o?a.jsxs(a.Fragment,{children:[a.jsx(ht,{className:"w-3 h-3 mr-1"}),"Stop"]}):"Process All"})]}),a.jsxs("div",{className:"subtasks-container space-y-2","data-test":"todo-details-subtasks-container",children:[a.jsx("div",{className:"subtasks-list space-y-2","data-test":"todo-details-subtasks-list",children:R.map(D=>a.jsxs("div",{className:"subtask-item flex items-center gap-2 p-2 rounded border","data-test":"todo-details-subtask-item",children:[a.jsx("input",{type:"checkbox",checked:D.isCompleted,onChange:()=>ge(D.id),className:"subtask-checkbox",disabled:o,"data-test":"todo-details-subtask-checkbox"}),a.jsx("div",{className:U("subtask-title-wrapper flex-1",D.isCompleted&&"line-through text-gray-500"),children:a.jsx(as,{ref:Y=>{F.current[D.id.value]=Y},value:D.title,onChange:async Y=>{const we=Y.target.value,ne=P(D.id.value,we);if(I(xe=>({...xe,[D.id.value]:ne})),e==="edit"&&s)try{await et.updateSubtask(s.id,D.id,{title:we}),t()}catch(xe){console.error("Failed to update subtask title:",xe)}else M(R.map(xe=>xe.id.value===D.id.value?{...xe,title:we}:xe))},placeholder:"Edit subtask...",className:"subtask-title-textarea resize-none w-full",rows:ee[D.id.value]||1,"data-test":"todo-details-subtask-textarea"})}),i===D.id.value&&a.jsx(ir,{className:"w-4 h-4 animate-spin text-blue-500","data-test":"todo-details-subtask-loading"}),e==="edit"&&r&&a.jsx(Sa,{sessionId:r,message:D.title,className:"subtask-send h-7 w-7 hover:text-blue-500",disabled:o,"data-test":"todo-details-subtask-send"}),a.jsx("button",{onClick:()=>ce(D.id),className:"subtask-remove hover:text-red-500",disabled:o,"data-test":"todo-details-subtask-remove",children:a.jsx(ht,{className:"w-4 h-4"})})]},D.id.value))}),a.jsxs("div",{className:"subtask-input flex gap-2","data-test":"todo-details-subtask-input-container",children:[a.jsx(as,{ref:_,value:v,onChange:Ee,onKeyDown:V,placeholder:"Add a subtask...",rows:1,className:"flex-1","data-test":"todo-details-subtask-input"}),a.jsx(ue,{onClick:()=>void X(),size:"sm",className:"subtask-add-button","data-test":"todo-details-subtask-add-button",children:a.jsx(Ks,{className:"w-4 h-4"})})]})]})]}),e==="edit"&&L.length>0&&a.jsxs("div",{className:"form-field-sessions space-y-2","data-test":"todo-details-sessions-field",children:[a.jsxs(Se,{"data-test":"todo-details-sessions-label",children:["Claude Session IDs (",L.length,")"]}),L.map((D,Y)=>a.jsx(We,{value:D,readOnly:!0,className:"session-id-input bg-gray-50 mb-1",title:`Session ${Y+1}`,"data-test":"todo-details-session-input"},D))]})]}),a.jsxs("div",{className:"right-column col-span-1 space-y-4","data-test":"todo-details-right-column",children:[a.jsxs("div",{className:"form-field-selectors space-y-4","data-test":"todo-details-selectors",children:[a.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-details-status-selector",children:[a.jsx(Se,{"data-test":"todo-details-status-label",children:"Status"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(tj,{value:y,options:vj,onChange:Ce,placeholder:"Search status...","data-test":"todo-details-status-select"})})]}),a.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-details-priority-selector",children:[a.jsx(Se,{"data-test":"todo-details-priority-label",children:"Priority"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(Zr,{value:S,options:xj,onChange:ve,placeholder:"Search priorities...",contentStyle:{zIndex:tt.draggablePopoverDropdown},"data-test":"todo-details-priority-badge"})})]}),a.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-details-category-selector",children:[a.jsx(Se,{"data-test":"todo-details-category-label",children:"Category"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(cj,{value:N||"personal",onChange:$,placeholder:"Search categories...","data-test":"todo-details-category-select"})})]}),!J&&de.length>1&&a.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-details-project-selector",children:[a.jsx(Se,{"data-test":"todo-details-project-label",children:"Claude Project"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(Zr,{value:W??"__no_project__",options:de,onChange:G,placeholder:"Search projects...",contentStyle:{zIndex:tt.draggablePopoverDropdown},"data-test":"todo-details-project-badge"})})]}),e==="edit"&&a.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-details-session-selector",children:[a.jsx(Se,{"data-test":"todo-details-session-selector-label",children:"Claude Sessions"}),a.jsx(eu,{value:L,onChange:re,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-details-session-select"})]}),a.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-details-tags-selector",children:[a.jsx(Se,{"data-test":"todo-details-tags-label",children:"Tags"}),a.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-details-tags-container",children:[a.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-details-tags-list",children:k.map(D=>a.jsxs(pt,{variant:"outline",className:"tag-badge gap-1","data-test":"todo-details-tag",children:[D,a.jsx("button",{onClick:()=>H(D),className:"tag-remove ml-1 hover:text-red-500","data-test":"todo-details-tag-remove",children:a.jsx(ht,{className:"w-3 h-3"})})]},D))}),a.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-details-tag-input-container",children:[a.jsx(We,{value:x,onChange:be,onKeyDown:Pe,placeholder:"Add a tag...","data-test":"todo-details-tag-input"}),a.jsx(ue,{onClick:ae,size:"sm",className:"tag-add-button","data-test":"todo-details-tag-add-button",children:a.jsx(Ks,{className:"w-4 h-4"})})]})]})]})]}),a.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-details-due-date-field",children:[a.jsx(Se,{htmlFor:"dueDate","data-test":"todo-details-due-date-label",children:"Due Date"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(jp,{className:"w-4 h-4 text-gray-400"}),a.jsx(We,{id:"dueDate",type:"date",value:m,onChange:D=>me(D.target.value),"data-test":"todo-details-due-date-input"})]})]})]})]})}function Sj({todo:s,isOpen:e,onClose:t,onUpdate:n,currentCardIndex:r,totalCardsInColumn:o,onNavigatePrevious:i,onNavigateNext:c,initialValues:l}){var X,ge,ce,Ae,Ce,ve;const[d,p]=h.useState("details"),[u,f]=h.useState(""),[m,g]=h.useState(!1),[x,b]=h.useState(null),[v,w]=h.useState(!1),[y,j]=h.useState(!1),[S,C]=h.useState(0),[N,A]=h.useState((s==null?void 0:s.title)??(l==null?void 0:l.title)??""),[k,E]=h.useState(!1),R=!s||s.id.value==="temp-new-todo",M=h.useMemo(()=>R?{id:{value:"temp-create"},title:(l==null?void 0:l.title)??N,description:(l==null?void 0:l.description)??"",status:Je.BACKLOG,priority:qt.MEDIUM,category:(l==null?void 0:l.category)??"",sortOrder:0,tags:(l==null?void 0:l.tags)??[],subtasks:[],createdAt:{value:new Date},updatedAt:{value:new Date},customProps:{sessionIds:[],claudeProjectPath:l==null?void 0:l.claudeProjectPath}}:null,[R,l==null?void 0:l.title,l==null?void 0:l.description,l==null?void 0:l.category,l==null?void 0:l.tags,l==null?void 0:l.claudeProjectPath,N]),L=(ge=(X=s==null?void 0:s.customProps)==null?void 0:X.sessionIds)==null?void 0:ge[S],T=h.useMemo(()=>{var $;return(($=s==null?void 0:s.customProps)==null?void 0:$.sessionIds)??[]},[(ce=s==null?void 0:s.customProps)==null?void 0:ce.sessionIds]),W=h.useMemo(()=>({loadOnMount:d==="session",subscribeToSSE:d==="session"}),[d]),{messages:z,sessionDetails:te,metadata:O,loading:ee,pagination:I,loadOlderMessages:_,refreshSession:F,addOptimisticMessage:q,removeOptimisticMessage:J}=ej(L,W);h.useLayoutEffect(()=>{var $,re,G,oe,de,pe,fe;if(e&&(($=s==null?void 0:s.customProps)!=null&&$.claudeProjectPath)){const be=ie.getState();((oe=(G=(re=be.app)==null?void 0:re.claude)==null?void 0:G.ui)==null?void 0:oe.selectedProjectPath)!==s.customProps.claudeProjectPath&&ie.updateState({app:{...be.app,claude:{...(de=be.app)==null?void 0:de.claude,ui:{...(fe=(pe=be.app)==null?void 0:pe.claude)==null?void 0:fe.ui,selectedProjectPath:s.customProps.claudeProjectPath}}}})}},[e,(Ae=s==null?void 0:s.customProps)==null?void 0:Ae.claudeProjectPath]),h.useEffect(()=>{p("details"),C(0),A((s==null?void 0:s.title)??(l==null?void 0:l.title)??"")},[s==null?void 0:s.id.value,s==null?void 0:s.title,s==null?void 0:s.description,e,l==null?void 0:l.title]),h.useEffect(()=>{const $=T.length;$>0&&S>=$&&C(0)},[T.length,S]),h.useEffect(()=>{d==="session"&&L&&F()},[S,L,d,F]);const P=h.useCallback($=>{p($),$==="session"&&L&&F()},[L,F]),B=h.useCallback(()=>{E(!0)},[]),se=h.useCallback(async $=>{if(!s){E(!1);return}try{await tu.claude.linkSessionToTodo(s.id,$),n(),E(!1),p("session"),await F()}catch(re){console.error("Failed to handle session creation:",re),E(!1)}},[s,n,F]),le=h.useCallback(async()=>{w(!0);try{await F()}finally{w(!1)}},[F]),me=h.useCallback(async()=>{var re,G,oe,de,pe,fe,be,Pe,Ee,V;if(!s||!L)return;const $=s.subtasks.filter(D=>!D.isCompleted);if($.length!==0){g(!0),j(!1);try{const D=s.id;for(const Y of $){if(y)break;b(Y.id.value),await Ye.sendMessage({message:Y.title,sessionId:L,options:{outputFormat:"text",permissionMode:"acceptEdits"}});let we=!1;for(let ne=0;ne<50;ne++)if(await new Promise(K=>setTimeout(K,100)),(pe=(de=(oe=(G=(re=ie.get("app"))==null?void 0:re.claude)==null?void 0:G.ui)==null?void 0:oe.activity)==null?void 0:de[L])==null?void 0:pe.isProcessing){we=!0;break}if(!we)console.warn(`[ProcessAll] ${Y.title} - Processing never started, continuing anyway`);else for(let ne=0;ne<600&&(await new Promise(K=>setTimeout(K,100)),!!((V=(Ee=(Pe=(be=(fe=ie.get("app"))==null?void 0:fe.claude)==null?void 0:be.ui)==null?void 0:Pe.activity)==null?void 0:Ee[L])==null?void 0:V.isProcessing));ne++);await et.toggleSubtask(D,Y.id),await new Promise(ne=>setTimeout(ne,500))}n()}catch(D){console.error("Failed to process all subtasks:",D)}finally{g(!1),b(null),j(!1)}}},[s,L,n,y]),ae=h.useCallback(()=>{j(!0)},[]),H=h.useCallback(async $=>{const re=$.target.value;if(A(re),!R&&s)try{await et.updateTodo(s.id,{title:re}),n()}catch(G){console.error("Failed to update todo title:",G)}},[R,s,n]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"panel-header","data-test":"kanban-card-details-header",children:a.jsxs("div",{className:"header-title-row flex items-center justify-between gap-4","data-test":"kanban-card-details-title-row",children:[a.jsxs("div",{className:"header-left flex items-center gap-2 flex-1 min-w-0","data-test":"kanban-card-details-header-left",children:[!R&&a.jsx(ro,{"data-test":"kanban-card-details-session-activity",sessionIds:T,showCount:!0,isCreating:k}),!R&&i&&a.jsx(ue,{"data-test":"kanban-card-details-navigate-previous",variant:"ghost",size:"icon",onClick:i,disabled:r===0,className:"navigate-previous-card h-8 w-8 flex-shrink-0",title:"Previous card in column",children:a.jsx(Ds,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-left-icon"})}),a.jsx("div",{className:"flex-1 min-w-0","data-test":"kanban-card-details-title-wrapper",children:a.jsx(as,{"data-test":"kanban-card-details-title-textarea",value:N,onChange:H,placeholder:R?"Enter todo title...":"Edit todo title",className:"todo-title-textarea text-lg font-semibold resize-none w-full",rows:1})}),!R&&c&&a.jsx(ue,{"data-test":"kanban-card-details-navigate-next",variant:"ghost",size:"icon",onClick:c,disabled:r!==void 0&&o!==void 0&&r>=o-1,className:"navigate-next-card h-8 w-8 flex-shrink-0",title:"Next card in column",children:a.jsx($t,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-right-icon"})})]}),!R&&s&&a.jsxs("div",{className:"header-actions flex items-center gap-2 flex-shrink-0","data-test":"kanban-card-details-header-actions",children:[a.jsx(eu,{"data-test":"kanban-card-details-session-selector",value:((Ce=s.customProps)==null?void 0:Ce.sessionIds)??[],onChange:async $=>{const re=Array.isArray($)?$:[];await et.updateTodo(s.id,{customProps:{...s.customProps,sessionIds:re}}),n()},className:"session-selector-header",showLabel:!1,placeholder:"Link to sessions",multiSelect:!0}),a.jsx(wa,{"data-test":"kanban-card-details-create-session-button",variant:"ghost",size:"icon",className:"create-session-button-panel",initialMessage:`Working on: ${s.title}

${s.description??""}`,projectPath:(ve=s.customProps)==null?void 0:ve.claudeProjectPath,onCreating:B,onSessionCreated:se,useModal:!0})]})]})}),a.jsxs(Bd,{value:d,onValueChange:P,className:"panel-tabs flex-1 flex flex-col overflow-hidden","data-test":"kanban-card-details-tabs",children:[a.jsxs(no,{className:U("grid w-full",R?"grid-cols-1":"grid-cols-2"),"data-test":"kanban-card-details-tabs-list",children:[a.jsx(an,{value:"details","data-test":"kanban-card-details-tab-details",children:"Details"}),!R&&a.jsx(an,{value:"session",disabled:!L,"data-test":"kanban-card-details-tab-session",children:"Claude Session"})]}),a.jsx(on,{value:"details",className:"panel-form mt-4 flex-1 overflow-y-auto data-[state=inactive]:hidden","data-test":"kanban-card-details-details-content",children:a.jsx(yj,{todo:R?M:s,mode:R?"create":"edit",onUpdate:n,onClose:t,activeSessionId:L,isProcessingAll:m,currentProcessingSubtaskId:x,onProcessAll:me,onStopProcessing:ae})}),!R&&a.jsxs(on,{value:"session",className:"session-tab mt-4 flex-1 flex flex-col overflow-hidden data-[state=inactive]:hidden","data-test":"kanban-card-details-session-content",children:[null,ee?a.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session",children:"Loading session..."}):L&&!te?a.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session-initial",children:a.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>void F(),className:"load-session-button",children:[a.jsx(On,{className:"w-4 h-4 mr-2"}),"Load Session"]})}):te?a.jsxs("div",{className:"session-chat-area flex flex-col gap-4 h-[calc(100vh-220px)]","data-test":"kanban-card-details-chat-area",children:[a.jsxs("div",{className:"session-header flex items-center justify-between","data-test":"kanban-card-details-session-header",children:[a.jsxs("div",{className:"session-header-left flex items-center gap-3","data-test":"kanban-card-details-session-header-left",children:[a.jsx("h3",{className:"session-title text-sm font-medium text-muted-foreground","data-test":"kanban-card-details-session-title",children:"Session Messages"}),T.length>1&&a.jsx(Z0,{"data-test":"kanban-card-details-session-navigator",sessionIds:T,currentIndex:S,onIndexChange:C,className:"session-navigator"})]}),a.jsxs(ue,{"data-test":"kanban-card-details-refresh-button",onClick:()=>void le(),size:"sm",variant:"outline",disabled:v,className:"refresh-session-button",children:[a.jsx(On,{className:U("w-4 h-4 mr-2",v&&"animate-spin"),"data-test":"kanban-card-details-refresh-icon"}),v?"Refreshing...":"Refresh"]})]}),a.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden","data-test":"kanban-card-details-chat-messages",children:a.jsx(G0,{"data-test":"kanban-card-details-chat-interface",messages:z,sessionDetails:te,metadata:O,loading:ee,pagination:I,onLoadOlder:I&&I.page<I.totalPages?_:void 0})}),a.jsx("div",{className:"chat-input flex-shrink-0","data-test":"kanban-card-details-chat-input",children:a.jsx(V0,{"data-test":"kanban-card-details-message-input",sessionId:L,value:u,onChange:f,onSendSuccess:()=>{F()},onAddOptimisticMessage:q,onRemoveOptimisticMessage:J})})]}):a.jsx("div",{className:"no-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-no-session",children:"No Claude session found"})]})]})]})}function jj({isOpen:s,onClose:e,onUpdate:t,triggerPosition:n,initialValues:r}){var c,l,d;const i={claudeProjectPath:((d=(l=(c=ie.getState().app)==null?void 0:c.claude)==null?void 0:l.ui)==null?void 0:d.selectedProjectPath)??void 0,...r};return a.jsx(os,{isVisible:s,onClose:e,title:"Create New Todo",shouldCloseManually:!0,resizable:!0,initialSize:{width:900,height:600},triggerPosition:n??void 0,className:"add-ticket-popover","data-test":"add-ticket-popover",children:a.jsx("div",{"data-test":"add-ticket-popover-content",className:"popover-content flex flex-col h-full overflow-hidden p-4",children:a.jsx(Sj,{todo:null,isOpen:s,onClose:e,onUpdate:t,initialValues:i})})})}function bi({onTicketCreated:s,initialValues:e,variant:t="ghost",size:n="icon",className:r="add-ticket-button",title:o="Add New Ticket"}){const[i,c]=h.useState(!1),[l,d]=h.useState(null),p=m=>{const g=m.currentTarget.getBoundingClientRect();d({x:g.left,y:g.top}),c(!0)},u=()=>{c(!1),d(null)},f=()=>{s&&s(),u()};return a.jsxs(a.Fragment,{children:[a.jsx(ue,{variant:t,size:n,onClick:p,title:o,className:r,"data-test":"add-ticket-button",children:a.jsx(Cp,{className:"h-5 w-5","data-test":"add-ticket-button-icon"})}),a.jsx(jj,{isOpen:i,onClose:u,onUpdate:f,triggerPosition:l,initialValues:e,"data-test":"add-ticket-popover"})]})}function Cj({version:s}){const e=Na(),t=bs(),[n,r]=h.useState(!1);if(e.pathname==="/game"||e.pathname==="/new-home")return null;const o=typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port.startsWith("517");if(t)return a.jsxs("header",{"data-test":n?"mobile-header-expanded":"mobile-header-collapsed",className:"sticky top-0 z-50 bg-black text-white shadow-md",children:[a.jsx("div",{className:"overflow-hidden transition-[max-height] duration-300 ease-in-out",style:{maxHeight:n?"200px":"0px"},children:a.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[a.jsx(Jr,{}),o&&a.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qr,{className:Fe.md}),a.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Vt,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Mr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?a.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?a.jsxs(a.Fragment,{children:[a.jsx(fo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?a.jsxs(a.Fragment,{children:[a.jsx(mo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?a.jsxs(a.Fragment,{children:[a.jsx(zr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?a.jsxs(a.Fragment,{children:[a.jsx(go,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):a.jsxs(a.Fragment,{children:[a.jsx(Wr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Js,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(xo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Fr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Br,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx($r,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Ur,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Lr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):a.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&a.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),a.jsx(Do,{}),a.jsx(bi,{}),a.jsx(xi,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(wa,{variant:"ghost",size:"icon",icon:a.jsx(Gr,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),a.jsx(ko,{variant:"ghost",size:"icon"})]})]})}),a.jsx("button",{"data-test":"mobile-header-toggle-btn",onClick:()=>r(!n),className:"w-full h-[10px] flex items-center justify-center active:bg-gray-800 cursor-pointer",children:a.jsx("div",{className:"transition-transform duration-300",style:{transform:n?"rotate(180deg)":"rotate(0deg)"},children:a.jsx(wt,{className:"h-3 w-3 text-gray-400"})})})]});const i=a.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[a.jsx(Jr,{}),o&&a.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qr,{className:Fe.md}),a.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Vt,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Mr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?a.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?a.jsxs(a.Fragment,{children:[a.jsx(fo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?a.jsxs(a.Fragment,{children:[a.jsx(mo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?a.jsxs(a.Fragment,{children:[a.jsx(zr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?a.jsxs(a.Fragment,{children:[a.jsx(go,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):a.jsxs(a.Fragment,{children:[a.jsx(Wr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Js,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(xo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Fr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Br,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx($r,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Ur,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Lr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):a.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&a.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),a.jsx(Do,{}),a.jsx(bi,{}),a.jsx(xi,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(wa,{variant:"ghost",size:"icon",icon:a.jsx(Gr,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),a.jsx(ko,{variant:"ghost",size:"icon"})]})]});return a.jsx("header",{"data-test":"desktop-header",className:"sticky top-0 z-50 bg-black text-white shadow-md",children:i})}function Nj(){const s=document.activeElement;if(!s)return null;const e=["INPUT","TEXTAREA"].includes(s.nodeName??""),t=s.contentEditable==="true";return e||t}class kj{constructor(){Z(this,"shortcuts",new Map);Z(this,"isListening",!1);this.handleKeyDown=this.handleKeyDown.bind(this)}generateShortcutId(e){const t=[];return e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),`${t.join("+")}-${e.key.toLowerCase()}`}handleKeyDown(e){if(Nj())return;const t=this.generateShortcutId({key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey}),n=this.shortcuts.get(t);n&&(n.preventDefault!==!1&&e.preventDefault(),n.callback())}register(e){const t=this.generateShortcutId(e);return this.shortcuts.set(t,e),this.isListening||this.startListening(),()=>this.unregister(t)}unregister(e){this.shortcuts.delete(e),this.shortcuts.size===0&&this.stopListening()}unregisterAll(){this.shortcuts.clear(),this.stopListening()}startListening(){this.isListening||(document.addEventListener("keydown",this.handleKeyDown),this.isListening=!0)}stopListening(){this.isListening&&(document.removeEventListener("keydown",this.handleKeyDown),this.isListening=!1)}getRegisteredShortcuts(){return Array.from(this.shortcuts.values())}isShortcutRegistered(e){const t=this.generateShortcutId(e);return this.shortcuts.has(t)}}const Is=new kj,wi="command-palette-recently-used",Ej=5;function Ij({actions:s=[],placeholder:e="Type a command or search..."}){const[t,n]=h.useState(!1),[r,o]=h.useState(""),[i,c]=h.useState(()=>{try{const u=localStorage.getItem(wi);return u?JSON.parse(u):[]}catch{return[]}});h.useEffect(()=>{const u=Is.register({key:"q",altKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),f=Is.register({key:"p",metaKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),m=Is.register({key:"q",ctrlKey:!0,altKey:!0,preventDefault:!0,callback:()=>{const g=i[0];if(g){const x=s.find(b=>b.id===g);x&&x.action()}}});return()=>{u(),f(),m()}},[i,s]),h.useEffect(()=>{if(!t)return;const u=f=>{if(f.key!=="ArrowUp"&&f.key!=="ArrowDown")return;const m=Array.from(document.querySelectorAll("[cmdk-item]")).filter(v=>v.getAttribute("data-disabled")!=="true");if(m.length===0)return;const g=m.map(v=>v.getAttribute("data-value")||""),x=g.indexOf(r);let b;if(f.key==="ArrowUp"){x<=0&&(f.preventDefault(),f.stopPropagation(),b=m.length-1,o(g[b]));return}else{x>=m.length-1&&(f.preventDefault(),f.stopPropagation(),b=0,o(g[b]));return}};return document.addEventListener("keydown",u,{capture:!0}),()=>document.removeEventListener("keydown",u,{capture:!0})},[t,r]);const l=s.reduce((u,f)=>{const m=f.group??"General";return u[m]||(u[m]=[]),u[m].push(f),u},{}),d=u=>{n(!1),u.action(),c(f=>{const m=f.filter(x=>x!==u.id),g=[u.id,...m].slice(0,Ej);try{localStorage.setItem(wi,JSON.stringify(g))}catch{}return g})},p=i.map(u=>s.find(f=>f.id===u)).filter(u=>u!==void 0);return a.jsxs(Ac,{open:t,onOpenChange:n,value:r,onValueChange:o,"data-test":"command-palette-dialog",children:[a.jsx(lr,{"data-test":"command-palette-input",placeholder:e}),a.jsxs(un,{"data-test":"command-palette-list",children:[a.jsx(pn,{"data-test":"command-palette-empty",children:"No results found."}),p.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(Ts,{heading:"Recently Used","data-test":"command-group-recent",children:p.map(u=>a.jsxs(is,{value:`recent-${u.id}`,onSelect:()=>d(u),className:"command-item flex justify-between items-center","data-test":"command-item-recent",children:[a.jsx("span",{"data-test":"command-item-recent-label",children:u.label}),u.shortcut&&a.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":"command-item-recent-shortcut",children:u.shortcut})]},`recent-${u.id}`))}),a.jsx(ea,{"data-test":"command-separator-recent"})]}),Object.entries(l).map(([u,f],m)=>a.jsxs("div",{"data-test":"command-group-container",children:[m>0&&a.jsx(ea,{"data-test":"command-separator"}),a.jsx(Ts,{heading:u,"data-test":"command-group",children:f.map(g=>a.jsxs(is,{value:g.id,onSelect:()=>d(g),className:"command-item flex justify-between items-center","data-test":"command-item",children:[a.jsx("span",{"data-test":"command-item-label",children:g.label}),g.shortcut&&a.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":"command-item-shortcut",children:g.shortcut})]},g.id))})]},u))]})]})}const Tj=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Aj=s=>(e,t)=>{if(!t)return 1;let n=t,r=e;if(s.matchCase||(n=n.toLowerCase(),r=r.toLowerCase()),s.matchWholeWord)return new RegExp(`\\b${Tj(n)}\\b`,s.matchCase?"":"i").test(e)?1:0;const o=r.includes(n);if(s.mode==="fuzzy"){if(o)return 2;let i=0;for(let c=0;c<r.length&&i<n.length;c++)r[c]===n[i]&&i++;return i===n.length?1:0}else return o?1:0},Pj={matchCase:!1,matchWholeWord:!1,mode:"fuzzy"};function Rj({placeholder:s="Search...",initialOptions:e,onSearchOptionsChange:t,onSearchChange:n,onNavigate:r,className:o}){const[i,c]=h.useState(e??Pj),l=h.useCallback(f=>{c(f),t==null||t(f)},[t]),d=()=>{const f={...i,matchCase:!i.matchCase};l(f)},p=()=>{const f={...i,matchWholeWord:!i.matchWholeWord};l(f)},u=()=>{const f={...i,mode:i.mode==="fuzzy"?"exact":"fuzzy"};l(f)};return a.jsxs("div",{className:U("flex items-center border-b px-3 pr-12",o),"cmdk-input-wrapper":"","data-test":"search-input-with-options",children:[a.jsx(or,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),a.jsx(mt.Input,{"data-test":"search-input",placeholder:s,onValueChange:n,className:"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"}),a.jsxs("div",{className:"flex items-center gap-0.5 shrink-0","data-test":"search-options",children:[a.jsx("button",{type:"button",onClick:d,className:U("p-1.5 rounded hover:bg-accent transition-colors",i.matchCase&&"bg-accent text-accent-foreground"),title:"Match Case (Aa)","data-test":"search-match-case-button",children:a.jsx(Np,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:p,className:U("p-1.5 rounded hover:bg-accent transition-colors",i.matchWholeWord&&"bg-accent text-accent-foreground"),title:"Match Whole Word","data-test":"search-match-whole-word-button",children:a.jsx(kp,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:u,className:U("p-1.5 rounded hover:bg-accent transition-colors text-xs font-mono",i.mode==="exact"&&"bg-accent text-accent-foreground"),title:i.mode==="fuzzy"?"Fuzzy Search (click for Exact)":"Exact Search (click for Fuzzy)","data-test":"search-mode-button",children:i.mode==="fuzzy"?"Fz":"Ex"}),a.jsx("div",{className:"w-px h-4 bg-border mx-1","data-test":"search-separator"}),a.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("up"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Previous Result (â†‘)","data-test":"search-navigate-up-button",children:a.jsx(ar,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("down"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Next Result (â†“)","data-test":"search-navigate-down-button",children:a.jsx(wt,{className:"h-4 w-4"})})]})]})}function Dj(s,e){return{navigateResults:h.useCallback(n=>{const r=Array.from(document.querySelectorAll("[cmdk-item]")).filter(l=>l.getAttribute("data-disabled")!=="true");if(r.length===0)return;const o=r.map(l=>l.getAttribute("data-value")||""),i=o.indexOf(s);let c;n==="up"?c=i<=0?r.length-1:i-1:c=i>=r.length-1?0:i+1,e(o[c])},[s,e])}}function _j({placeholder:s="Go to node by title or content..."}){const[e,t]=h.useState(!1),[n,r]=h.useState(""),[o,i]=h.useState(""),c=Mt.getState().getGoToSymbolSearch(),[l,d]=h.useState((c==null?void 0:c.options)??{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}),p=h.useCallback(b=>{d(b),Mt.getState().setGoToSymbolSearchOptions(b)},[]),u=h.useMemo(()=>Aj(l),[l]),{navigateResults:f}=Dj(n,r),m=h.useMemo(()=>{var w;if(!e)return[];const b=Mt.getState();if(!((w=b.state)!=null&&w.projects))return[];const v=[];return Object.values(b.state.projects).forEach(y=>{Object.values(y.workspaces).forEach(j=>{Object.values(j.canvases).forEach(S=>{(S.coreState.nodes||[]).forEach(N=>{var M;const A=(M=N.data)==null?void 0:M.nodeType;if(A==="workflowOrchestration"||A==="workflowSource")return;const k=N.title||"",E=typeof N.content=="string"?N.content:"",R=E.length>80?E.substring(0,80)+"...":E;!k&&!E||v.push({id:`${S.id}:${N.id}`,nodeId:N.id,canvasId:S.id,title:k||R.substring(0,40)||N.id,contentPreview:R,path:`${y.name} / ${j.name} / ${S.name}`,node:N})})})})}),v},[e]),g=h.useMemo(()=>{const b={};return m.forEach(v=>{b[v.path]||(b[v.path]=[]),b[v.path].push(v)}),b},[m]),x=h.useCallback(b=>{o.trim()&&Mt.getState().addGoToSymbolSearchHistory(o.trim()),t(!1),i("");const v=Mt.getState();v.projectCanvas.switch(b.canvasId),setTimeout(()=>{v.scrollToNode(b.nodeId,500),v.setSelectedNodes([b.node])},50)},[o]);return h.useEffect(()=>{const b=Is.register({key:"o",ctrlKey:!0,preventDefault:!0,callback:()=>t(w=>!w)}),v=Is.register({key:"o",metaKey:!0,preventDefault:!0,callback:()=>t(w=>!w)});return()=>{b(),v()}},[]),h.useEffect(()=>{if(!e)return;const b=v=>{if(v.key!=="ArrowUp"&&v.key!=="ArrowDown")return;const w=Array.from(document.querySelectorAll("[cmdk-item]")).filter(S=>S.getAttribute("data-disabled")!=="true");if(w.length===0)return;const y=w.map(S=>S.getAttribute("data-value")||""),j=y.indexOf(n);if(v.key==="ArrowUp"){j<=0&&(v.preventDefault(),v.stopPropagation(),r(y[w.length-1]));return}else{j>=w.length-1&&(v.preventDefault(),v.stopPropagation(),r(y[0]));return}};return document.addEventListener("keydown",b,{capture:!0}),()=>document.removeEventListener("keydown",b,{capture:!0})},[e,n]),a.jsxs(Ac,{open:e,onOpenChange:t,value:n,onValueChange:r,filter:u,"data-test":"go-to-symbol-dialog",children:[a.jsx(Rj,{placeholder:s,initialOptions:l,onSearchOptionsChange:p,onSearchChange:i,onNavigate:f}),a.jsxs(un,{"data-test":"go-to-symbol-list",children:[a.jsx(pn,{"data-test":"go-to-symbol-empty",children:"No nodes found."}),Object.entries(g).map(([b,v])=>a.jsx(Ts,{heading:b,"data-test":"go-to-symbol-group",children:v.map(w=>a.jsxs(is,{value:`${w.title} ${w.contentPreview} ${w.path}`,onSelect:()=>x(w),className:"flex flex-col items-start gap-0.5","data-test":"go-to-symbol-item",children:[a.jsx("span",{className:"font-medium text-sm","data-test":"go-to-symbol-item-title",children:w.title}),w.contentPreview&&w.title!==w.contentPreview.substring(0,40)&&a.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-full","data-test":"go-to-symbol-item-preview",children:w.contentPreview})]},w.id))},b))]})]})}function Oj(s){const e=s.split(/[/\\]/),t=e.pop()||"",n=/:(\d+)(?::\d+)?$/.exec(t);let r="",o=t;return n&&(r=n[1],o=t.slice(0,n.index)),{dir:e.join("/"),filename:o,line:r}}function Ca(s){return Oj(s).filename}function Lj(s,e,t=300,n=15,r=10,o=200){let i=s+n,c=e+n;return i+t>window.innerWidth&&(i=window.innerWidth-t-r),c+o>window.innerHeight&&(c=window.innerHeight-o-r),i<r&&(i=r),c<r&&(c=r),{left:i,top:c}}function Mj({onElementClicked:s,onElementHovered:e,onInspectorActivated:t,onInspectorDeactivated:n,shouldInspectElement:r,renderTooltip:o,excludeClassNames:i=[],tooltipOwnerId:c,clickOwnerId:l=null}){const[d,p]=h.useState(!1),[u,f]=h.useState(null),m=h.useRef(null),g=h.useRef(s),x=h.useRef(e),b=h.useRef(t),v=h.useRef(n),w=h.useRef(r),y=h.useRef(null),j=h.useRef(null),S=h.useRef(null);h.useEffect(()=>{g.current=s,x.current=e,b.current=t,v.current=n,w.current=r}),h.useEffect(()=>{if(c)return xt.claimTooltip(c),()=>{xt.releaseTooltip(c)}},[c]);const C=h.useMemo(()=>["inspector-tooltip","collected-elements-popover",...i],[i]),N=h.useRef({}),A=h.useCallback((z,...te)=>{const O=Date.now();(!N.current[z]||O-N.current[z]>500)&&(N.current[z]=O,console.log(...te))},[]),k=h.useCallback((z,te="hover")=>{for(const F of C)if(z.closest(`.${F}`))return A("class-"+F,`[Inspector:${te}] Excluding by class:`,F,z),!0;const O=["word-extractor-app","word-extractor-app-body","word-extractor-mount","watcher-context-menu"];if(z.id&&O.includes(z.id))return A("id-"+z.id,`[Inspector:${te}] Excluding by ID:`,z.id,z),!0;if(z.closest("#word-extractor-app"))return A("closest-app",`[Inspector:${te}] Excluding by closest #word-extractor-app`,z),!0;const ee=z.getRootNode();if(ee instanceof ShadowRoot){const F=ee.host;if(F&&O.includes(F.id))return A("shadow-host",`[Inspector:${te}] Excluding by shadow DOM host:`,F.id),!0}const I=["custom-capture-controller","custom-capture-content","content-capture-controller","capture-mode-select","custom-selector","field-dialog","array-dialog","draggable-popover-container","draggable-popover-wrapper","schema-panel","preview-panel","watcher-extension-app"];let _=z;for(;_;){const F=_.getAttribute("data-test");if(F){for(const q of I)if(F===q||F.startsWith(q))return!0}_=_.parentElement}return!!(w.current&&!w.current(z))},[C,A]),E=h.useCallback(z=>{var P;const O=z.composedPath()[0]||z.target;if(O.closest("[data-radix-select-content]")||O.closest("[data-radix-popper-content-wrapper]")||O.closest("[role='option']")||k(O))return;const ee=m.current===O;m.current&&!ee&&(m.current.style.outline="",m.current.style.outlineOffset=""),O.style.outline="2px solid #06b6d4",O.style.outlineOffset="2px",m.current=O;const I=O.tagName.toLowerCase(),_=Array.from(O.classList),F=O.getAttribute("data-test")||void 0,q=O.getAttribute("data-react-inspector")||void 0,J={tagName:I,classes:_,dataTest:F,reactInspectorId:q,resolvedPath:void 0,x:z.clientX,y:z.clientY};ee?f(B=>B?{...B,x:z.clientX,y:z.clientY}:J):(f(J),(P=x.current)==null||P.call(x,O,J))},[k]),R=h.useCallback(z=>{var J;const O=z.composedPath()[0]||z.target;if(O.closest("[data-radix-select-content]")||O.closest("[data-radix-popper-content-wrapper]")||O.closest("[role='option']")||k(O,"click")||!xt.canHandleClicks(l))return;z.preventDefault(),z.stopPropagation();const ee=O.tagName.toLowerCase(),I=Array.from(O.classList),_=O.getAttribute("data-test")||void 0,F=O.getAttribute("data-react-inspector")||void 0,q={tagName:ee,classes:I,dataTest:_,reactInspectorId:F,resolvedPath:void 0,x:z.clientX,y:z.clientY};(J=g.current)==null||J.call(g,O,q)},[k,l]),M=h.useCallback(z=>{z.key==="Escape"&&d&&xt.deactivate()},[d]);h.useEffect(()=>(p(xt.getState()),xt.subscribe(te=>{var O,ee;p(te),te?(O=b.current)==null||O.call(b):(ee=v.current)==null||ee.call(v)})),[]),h.useEffect(()=>{var z;return d?(y.current=E,j.current=R,S.current=M,document.body.style.setProperty("cursor","crosshair","important"),document.addEventListener("mousemove",E),document.addEventListener("click",R,!0),document.addEventListener("keydown",M)):(document.body.style.removeProperty("cursor"),y.current&&document.removeEventListener("mousemove",y.current),j.current&&document.removeEventListener("click",j.current,!0),S.current&&document.removeEventListener("keydown",S.current),f(null),(z=x.current)==null||z.call(x,null,null),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)),()=>{document.body.style.removeProperty("cursor"),y.current&&document.removeEventListener("mousemove",y.current),j.current&&document.removeEventListener("click",j.current,!0),S.current&&document.removeEventListener("keydown",S.current),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)}},[d]);const L=u?Lj(u.x,u.y):{left:0,top:0},T=u&&a.jsx("div",{className:"inspector-tooltip fixed z-[9999] bg-black text-white p-3 rounded-lg shadow-xl text-xs font-mono pointer-events-none",style:{left:`${L.left}px`,top:`${L.top}px`,width:"300px"},"data-test":"element-inspector-tooltip",children:a.jsxs("div",{className:"metadata-section space-y-2","data-test":"element-inspector-metadata-section",children:[a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-tag-row",children:[a.jsx(oc,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"Tag"}),a.jsxs("div",{className:"text-blue-300","data-test":"element-inspector-tag-value",children:["<",u.tagName,">"]})]})]}),u.dataTest&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-data-test-row",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"Data Test"}),a.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-data-test-value",children:u.dataTest})]})]}),!u.dataTest&&u.classes.length>0&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-classes-row",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-gray-400 text-[10px]",children:["Classes (",u.classes.length,")"]}),a.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-classes-value",children:u.classes.join(" ")})]})]}),u.reactInspectorId&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-file-row",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Name"}),a.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-name",children:Ca(u.resolvedPath||u.reactInspectorId)}),a.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Path"}),a.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-path",children:u.resolvedPath||u.reactInspectorId||"Resolving..."})]})]}),!u.reactInspectorId&&a.jsxs("div",{className:"metadata-row flex items-start gap-2",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-gray-600"}),a.jsx("div",{children:a.jsx("div",{className:"text-gray-500 text-[10px] italic",children:"No data-react-inspector attribute"})})]})]})}),W=xt.canRenderTooltip(c??null);return a.jsx(a.Fragment,{children:d&&u&&W&&(o?o(u):T)})}async function Fj(s){if(!s)return;const n=s.split(":")[0].split("/").pop();if(n)try{return await ha.getFilePath(n)}catch(r){console.error("Failed to resolve inspector path:",r);return}}function $j({onElementCollected:s,onElementRemoved:e,onElementsCleared:t,renderCollectedItem:n,renderCollectedPanel:r,showDefaultPanel:o=!0,tooltipOwnerId:i,panelOwnerId:c}){const[l,d]=h.useState([]),[p,u]=h.useState(!1),[f,m]=h.useState({x:100,y:100}),g=h.useRef(!1),x=h.useRef({x:0,y:0});h.useEffect(()=>{if(c)return xt.claimPanel(c),()=>{xt.releasePanel(c)}},[c]);const b=h.useCallback((T,W)=>{(async()=>{const te=await Fj(W.reactInspectorId)||W.reactInspectorId,O={id:`${Date.now()}-${Math.random()}`,tagName:W.tagName,classes:W.classes,dataTest:W.dataTest,reactInspectorId:W.reactInspectorId,resolvedPath:te,timestamp:Date.now()};d(ee=>[...ee,O]),s==null||s(O,T),ke.success("Element collected!",{description:`<${W.tagName}>${te?` [${te}]`:""}`,duration:2e3})})()},[s]),v=h.useCallback(()=>{(l.length>0||p)&&u(!0)},[l.length,p]),w=T=>{T.target.closest(".popover-drag-handle")&&(g.current=!0,x.current={x:T.clientX-f.x,y:T.clientY-f.y})},y=h.useCallback(T=>{g.current&&m({x:T.clientX-x.current.x,y:T.clientY-x.current.y})},[]),j=h.useCallback(()=>{g.current=!1},[]);h.useEffect(()=>(p&&(document.addEventListener("mousemove",y),document.addEventListener("mouseup",j)),()=>{document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",j)}),[p,y,j]),h.useEffect(()=>{const T=W=>{W.key==="Escape"&&p&&u(!1)};return p&&document.addEventListener("keydown",T),()=>{document.removeEventListener("keydown",T)}},[p]);const S=T=>{d(W=>W.filter(z=>z.id!==T.id)),e==null||e(T),ke.info("Element removed from collection")},C=()=>{d([]),u(!1),t==null||t(),ke.info("All collected elements cleared")},N=()=>{u(!1),d([]),t==null||t()},A=()=>l.map((T,W)=>{const z=T.dataTest?`[data-test="${T.dataTest}"]`:T.classes.length>0?`.${T.classes[0]}`:"",te=T.resolvedPath||"unknown";return`${W+1}. ${T.tagName}${z} inside @${te}`}).join(`
`),k=(T,W)=>a.jsxs("div",{className:"collected-element p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors","data-test":"element-inspector-collected-item",children:[a.jsxs("div",{className:"element-header flex items-center justify-between mb-2","data-test":"element-inspector-collected-item-header",children:[a.jsxs("div",{className:"element-index text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded","data-test":"element-inspector-collected-item-index",children:["#",W+1]}),a.jsx("button",{onClick:()=>S(T),className:"remove-btn p-1 hover:bg-red-100 rounded transition-colors",title:"Remove element","data-test":"element-inspector-collected-item-remove-button",children:a.jsx(Et,{className:"w-4 h-4 text-red-600"})})]}),a.jsxs("div",{className:"element-details space-y-1 text-xs",children:[a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(oc,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-600"}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"Tag:"})," ",a.jsxs("span",{className:"font-mono text-blue-700",children:["<",T.tagName,">"]})]})]}),T.resolvedPath&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-600"}),a.jsxs("div",{children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"File Name:"})," ",a.jsx("span",{className:"font-mono text-purple-700",children:Ca(T.resolvedPath)}),a.jsx(Ns,{textToCopy:Ca(T.resolvedPath),size:"sm"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"File Path:"})," ",a.jsx("span",{className:"font-mono text-purple-700",children:T.resolvedPath}),a.jsx(Ns,{textToCopy:T.resolvedPath,size:"sm"})]})]})]}),T.dataTest&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("span",{className:"text-gray-500",children:"Data Test:"})," ",a.jsx("span",{className:"font-mono text-green-700",children:T.dataTest}),a.jsx(Ns,{textToCopy:T.dataTest,size:"sm"})]})]}),!T.dataTest&&T.classes.length>0&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("span",{className:"text-gray-500",children:["Classes (",T.classes.length,"):"]}),a.jsx("div",{className:"font-mono text-green-700 text-[10px] break-all mt-1",children:T.classes.join(" ")})]})]}),a.jsx("div",{className:"timestamp text-[10px] text-gray-400 mt-2",children:new Date(T.timestamp).toLocaleTimeString()})]})]},T.id),E=a.jsxs("div",{className:"collected-elements-popover fixed z-[9999] bg-white border-2 border-purple-400 rounded-lg shadow-2xl",style:{left:`${f.x}px`,top:`${f.y}px`,width:"550px",maxHeight:"500px"},onMouseDown:w,"data-test":"element-inspector-collected-popover",children:[a.jsxs("div",{className:"popover-drag-handle popover-header bg-purple-500 text-white p-3 rounded-t-lg cursor-move flex items-center justify-between","data-test":"element-inspector-collected-header",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ep,{className:"w-5 h-5"}),a.jsxs("h3",{className:"font-semibold","data-test":"element-inspector-collected-title",children:["Collected Elements (",l.length,")"]})]}),a.jsxs("div",{className:"flex items-center gap-2","data-test":"element-inspector-collected-actions",children:[a.jsx(Ns,{textToCopy:A()}),a.jsx("button",{onClick:N,className:"hover:bg-purple-600 rounded p-1 transition-colors",title:"Close","data-test":"element-inspector-collected-close-button",children:a.jsx(ht,{className:"w-5 h-5"})})]})]}),a.jsxs(Bd,{defaultValue:"list",className:"popover-tabs px-3","data-test":"element-inspector-collected-tabs",children:[a.jsxs(no,{className:"tabs-list grid w-full grid-cols-2 mt-3","data-test":"element-inspector-collected-tabs-list",children:[a.jsx(an,{value:"list","data-test":"element-inspector-collected-list-tab",children:"List View"}),a.jsx(an,{value:"text","data-test":"element-inspector-collected-text-tab",children:"Text View"})]}),a.jsxs(on,{value:"list",className:"tabs-content m-0","data-test":"element-inspector-collected-list-content",children:[a.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4 space-y-2","data-test":"element-inspector-collected-list",children:l.map((T,W)=>n?n(T,W,()=>k(T,W)):k(T,W))}),a.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-list-footer",children:a.jsxs(ue,{onClick:C,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-clear-all-button",children:[a.jsx(Et,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]}),a.jsxs(on,{value:"text",className:"tabs-content m-0","data-test":"element-inspector-collected-text-content",children:[a.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4","data-test":"element-inspector-collected-text",children:a.jsx("pre",{className:"text-xs font-mono text-gray-800 whitespace-pre-wrap break-words bg-gray-50 p-3 rounded border border-gray-200","data-test":"element-inspector-collected-text-formatted",children:A()})}),a.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-text-footer",children:a.jsxs(ue,{onClick:C,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-text-clear-all-button",children:[a.jsx(Et,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]})]})]}),R=xt.canRenderPanel(c??null),M=o&&p&&l.length>0&&R,L=r?r(l,E):E;return a.jsxs(a.Fragment,{children:[a.jsx(Mj,{tooltipOwnerId:i,onElementClicked:b,onInspectorDeactivated:v}),M&&L]})}const Uj=({...s})=>{const{theme:e="system"}=uu();return a.jsx(pu,{theme:e,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"!text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...s})};function Bj({navigate:s}){return[{id:"nav-home",label:"Go to Home",shortcut:"Ctrl+H",action:()=>s("/"),group:"Navigation"},{id:"nav-chat",label:"Go to Chat",action:()=>s("/chat"),group:"Navigation"},{id:"nav-demo",label:"Go to Demo",action:()=>s("/demo"),group:"Navigation"},{id:"nav-settings",label:"Go to Settings",action:()=>s("/settings"),group:"Navigation"},{id:"nav-todo",label:"Go to Todo",action:()=>s("/todo"),group:"Navigation"},{id:"nav-kanban",label:"Go to Kanban Board",action:()=>s("/todo/kanban"),group:"Navigation"},{id:"nav-content",label:"Go to Content",action:()=>s("/content"),group:"Navigation"},{id:"nav-vocabulary",label:"Go to Vocabulary",action:()=>s("/vocabulary"),group:"Navigation"},{id:"nav-live-transcription",label:"Go to Live Transcription",action:()=>s("/live-transcription"),group:"Navigation"},{id:"nav-claude",label:"Go to Claude",action:()=>s("/claude"),group:"Navigation"},{id:"nav-state",label:"Go to Global State",action:()=>s("/state"),group:"Navigation"},{id:"toggle-element-inspector",label:"Toggle Element Inspector",shortcut:"Ctrl+Shift+I",action:()=>{xt.toggle();const e=xt.getState();ke.success(`Element Inspector ${e?"activated":"deactivated"}`,{description:e?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})},group:"Tools"},{id:"toggle-fullscreen",label:"Toggle Fullscreen",shortcut:"F11",action:()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{ke.success("Fullscreen mode deactivated",{duration:2e3})}).catch(e=>{ke.error("Failed to exit fullscreen",{description:e.message,duration:3e3})}):document.documentElement.requestFullscreen().then(()=>{ke.success("Fullscreen mode activated",{description:"Press F11 or ESC to exit fullscreen",duration:2e3})}).catch(e=>{ke.error("Failed to enter fullscreen",{description:e.message,duration:3e3})})},group:"Tools"}]}function Wj(){const{logs:s,actions:e}=ic(),t=Na(),n=yi(),[r,o]=h.useState(null);$p({loadOnMount:!0,subscribeToSSE:!0}),Hp({loadOnMount:!0}),Gp(),h.useEffect(()=>{localStorage.getItem("VITE_CLEAR_LOGS_ON_RELOAD"),at.clientLogsService.clearLogs()},[t.pathname]);const i=Bj({navigate:n});return h.useEffect(()=>{(async()=>{})()},[]),h.useEffect(()=>{const c=Is.register({key:"c",callback:()=>{console.clear(),ke.success("Console cleared",{duration:1500})}});return()=>c()},[]),h.useEffect(()=>{document.title=Lh(t.pathname)},[t.pathname]),a.jsxs(gc,{defaultOpen:!1,children:[a.jsx(Ij,{actions:i}),a.jsx(_j,{}),a.jsx($j,{}),a.jsx(Uj,{}),a.jsx(Uh,{}),a.jsx(vc,{className:"h-screen overflow-hidden",children:a.jsxs("div",{className:"h-full bg-background flex flex-col",children:[t.pathname!=="/stt"&&a.jsx(Cj,{version:r}),a.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:a.jsx(Mh,{logger:e,logs:s})})]})})]})}iu.createRoot(document.getElementById("root")).render(a.jsx(Wh,{defaultTheme:"light",storageKey:"watcher-ui-theme",children:a.jsx(cu,{children:a.jsx(Wj,{})})}));export{wo as $,Im as A,pt as B,hn as C,Fa as D,as as E,Dl as F,yC as G,hv as H,We as I,pa as J,Ve as K,Se as L,V0 as M,Ue as N,Mt as O,bo as P,yo as Q,_t as R,Ut as S,Ud as T,Fe as U,U as V,ky as W,Iy as X,IC as Y,ft as Z,TC as _,ue as a,Zd as a$,gc as a0,xc as a1,bc as a2,wc as a3,ih as a4,ch as a5,dh as a6,yc as a7,Ws as a8,zs as a9,ut as aA,Xe as aB,_a as aC,Pc as aD,xt as aE,Mj as aF,$j as aG,Lj as aH,fa as aI,qe as aJ,rn as aK,Kr as aL,sC as aM,ha as aN,FC as aO,HS as aP,Mc as aQ,iC as aR,rt as aS,$g as aT,Ug as aU,Vn as aV,J0 as aW,O0 as aX,ns as aY,rs as aZ,Kt as a_,vc as aa,Jr as ab,os as ac,Gf as ad,qf as ae,Fc as af,$c as ag,bs as ah,$e as ai,Ct as aj,Oa as ak,lc as al,Wn as am,Lo as an,zc as ao,Wc as ap,dr as aq,Fd as ar,xa as as,Je as at,qt as au,nn as av,ri as aw,Re as ax,tt as ay,st as az,La as b,Ol as b$,wa as b0,Vd as b1,Kd as b2,Ll as b3,zS as b4,Xp as b5,Yj as b6,Kp as b7,uc as b8,Is as b9,zC as bA,HC as bB,cr as bC,un as bD,pn as bE,Ts as bF,is as bG,rf as bH,tu as bI,Zr as bJ,cj as bK,Sj as bL,Yt as bM,Zt as bN,oj as bO,Fn as bP,eC as bQ,$n as bR,Un as bS,Zs as bT,Cc as bU,ef as bV,ja as bW,Gs as bX,_n as bY,GC as bZ,Zf as b_,vo as ba,ss as bb,qC as bc,vC as bd,Jf as be,Yo as bf,Jo as bg,mr as bh,bi,xi as bj,Hh as bk,at as bl,OC as bm,RC as bn,DC as bo,_C as bp,DS as bq,AC as br,PC as bs,$S as bt,LC as bu,MC as bv,$C as bw,UC as bx,BC as by,WC as bz,Ma as c,Dj as c$,dt as c0,gj as c1,Jx as c2,Nj as c3,er as c4,Pr as c5,Rg as c6,Tn as c7,Jc as c8,Rl as c9,Zj as cA,cy as cB,gC as cC,Yc as cD,Q as cE,tC as cF,Vf as cG,Kf as cH,Xf as cI,Qf as cJ,aC as cK,oC as cL,bC as cM,wC as cN,uC as cO,zh as cP,dC as cQ,pC as cR,lC as cS,fC as cT,EC as cU,CC as cV,kC as cW,Za as cX,NC as cY,ub as cZ,Aj as c_,Kv as ca,Ua as cb,hg as cc,Mv as cd,dl as ce,us as cf,_g as cg,Dm as ch,Mg as ci,Pn as cj,Rn as ck,vs as cl,Ko as cm,Jj as cn,fs as co,xC as cp,SC as cq,mC as cr,cC as cs,iw as ct,jn as cu,nC as cv,rC as cw,Tm as cx,tj as cy,eu as cz,zf as d,Ac as d0,Rj as d1,ea as d2,Lg as d3,hC as d4,pc as d5,hc as d6,Xj as d7,Qj as d8,jC as d9,fn as e,bt as f,dn as g,It as h,Jt as i,Tt as j,Oe as k,Ot as l,Bd as m,no as n,an as o,on as p,Kc as q,ej as r,G0 as s,ro as t,$p as u,jr as v,Ye as w,et as x,ie as y,Le as z};
