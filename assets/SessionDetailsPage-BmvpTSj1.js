import{r as t,j as s,u as Fe,d as Ee}from"./react-vendor-Byz07MLO.js";import{t as ce}from"./utils-DJ2ViQ2u.js";import{S as Ie}from"./SessionSidebar-BExSPAHd.js";import{ac as Te,L as P,I as de,T as Re,S as Le,h as Oe,i as Ae,j as De,k as Be,B as $e,aj as ze,aw as Xe,V as _e,a as ue,r as Ve,u as Ye,y as fe,w as he,s as He,M as Ge}from"./index-eHP58yiE.js";import{X as Ue,N as We,G as qe}from"./icons-vtiX7BHn.js";import{u as Ke}from"./useSessionKeyboardNavigation-CJVY-X6Z.js";import"./radix-ui-v9Pxfv0s.js";import"./ui-utils-BxIQ3qGg.js";const W="none",Je=[{value:W,label:"None"},{value:"template",label:"Template"},{value:"bug",label:"Bug"},{value:"experiment",label:"Experiment"},{value:"archive",label:"Archive"}];function Qe({isVisible:r,onClose:b,sessionId:O,sessionName:c,messages:w,onFork:q,isSubmitting:l=!1,triggerPosition:K,onMessageSelect:F}){const[A,y]=t.useState(""),[D,B]=t.useState(""),[j,$]=t.useState(W),[h,E]=t.useState([]),[z,I]=t.useState(""),[J,p]=t.useState(null),[T,X]=t.useState(!0),x=t.useMemo(()=>w.filter(e=>e.role==="user"),[w]),f=t.useMemo(()=>x.length===0?null:x[x.length-1].id,[x]),m=J??f,v=e=>{if(e.preventDefault(),!m)return;let n=m;if(T){const Y=w.findIndex(H=>H.id===m);Y>0&&(n=w[Y-1].id)}const M={forkPointEntryUuid:n,customName:A.trim()||void 0,description:D.trim()||void 0,category:j!==W?j:void 0,tags:h.length>0?h:void 0};q(M)},R=()=>{y(""),B(""),$(W),E([]),I(""),p(null),X(!0)},N=()=>{const e=z.trim().toLowerCase();e&&!h.includes(e)&&E([...h,e]),I("")},_=e=>{E(h.filter(n=>n!==e))},V=e=>{e.key==="Enter"&&(e.preventDefault(),N())},g=()=>{R(),b()},d=e=>{if(typeof e.content=="string")return e.content.slice(0,100);if(Array.isArray(e.content))for(const n of e.content){if(typeof n=="string")return n.slice(0,100);if(typeof n=="object"&&n!==null){if(n.type==="text"&&"text"in n)return n.text.slice(0,100);if(n.type==="tool_result"&&"content"in n){const M=n.content;if(typeof M=="string")return M.slice(0,100)}}}if(typeof e.content=="object"&&e.content!==null){if("text"in e.content)return e.content.text.slice(0,100);if("content"in e.content&&typeof e.content.content=="string")return e.content.content.slice(0,100)}return"Message content"},i=s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(qe,{size:14}),"Fork Session"]});return s.jsx(Te,{isVisible:r,onClose:g,title:i,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,initialPosition:K??"center",initialSize:{width:400,height:500},resizable:!0,children:s.jsxs("form",{"data-test":"fork-session-form",onSubmit:v,className:"fork-session-form flex flex-col h-full",children:[s.jsxs("div",{"data-test":"fork-session-content",className:"fork-session-content p-4 flex-1 min-h-0 flex flex-col gap-4 overflow-auto",children:[s.jsxs("div",{"data-test":"fork-session-name-field",className:"fork-session-name-field space-y-1",children:[s.jsx(P,{htmlFor:"fork-name",children:"Fork Name (optional)"}),s.jsx(de,{id:"fork-name","data-test":"fork-session-name-input",placeholder:"e.g., Refactor approach, Bug fix v2...",value:A,onChange:e=>y(e.target.value),disabled:l})]}),s.jsxs("div",{"data-test":"fork-session-description-field",className:"fork-session-description-field space-y-1",children:[s.jsx(P,{htmlFor:"fork-description",children:"Description (optional)"}),s.jsx(Re,{id:"fork-description","data-test":"fork-session-description-input",placeholder:"Why are you creating this fork?",value:D,onChange:e=>B(e.target.value),disabled:l,rows:2,className:"resize-none"})]}),s.jsxs("div",{"data-test":"fork-session-category-field",className:"fork-session-category-field space-y-1",children:[s.jsx(P,{htmlFor:"fork-category",children:"Category (optional)"}),s.jsxs(Le,{value:j,onValueChange:e=>$(e),disabled:l,children:[s.jsx(Oe,{id:"fork-category","data-test":"fork-session-category-trigger",children:s.jsx(Ae,{placeholder:"Select a category"})}),s.jsx(De,{"data-test":"fork-session-category-content",children:Je.map(e=>s.jsx(Be,{value:e.value,"data-test":"fork-session-category-option",children:e.label},e.value))})]})]}),s.jsxs("div",{"data-test":"fork-session-tags-field",className:"fork-session-tags-field space-y-1",children:[s.jsx(P,{htmlFor:"fork-tags",children:"Tags (optional)"}),s.jsx("div",{className:"flex gap-2",children:s.jsx(de,{id:"fork-tags","data-test":"fork-session-tags-input",placeholder:"Add a tag and press Enter",value:z,onChange:e=>I(e.target.value),onKeyDown:V,onBlur:N,disabled:l,className:"flex-1"})}),h.length>0&&s.jsx("div",{"data-test":"fork-session-tags-list",className:"flex flex-wrap gap-1 mt-2",children:h.map(e=>s.jsxs($e,{variant:"secondary",className:"flex items-center gap-1","data-test":"fork-session-tag",children:[e,s.jsx("button",{type:"button",onClick:()=>_(e),className:"ml-1 hover:text-destructive",disabled:l,"data-test":"fork-session-tag-remove",children:s.jsx(Ue,{className:"h-3 w-3"})})]},e))})]}),s.jsxs("div",{"data-test":"fork-session-point-field",className:"fork-session-point-field flex-1 flex flex-col gap-2 min-h-0",children:[s.jsx(P,{children:"Fork Point (select a message)"}),s.jsx("div",{className:"text-xs text-muted-foreground",children:T?"The fork will include all messages up to (but not including) the selected message.":"The fork will include all messages up to and including the selected message."}),s.jsxs("div",{"data-test":"fork-session-exclude-checkbox",className:"flex items-center gap-2",children:[s.jsx(ze,{id:"exclude-selected",checked:T,onCheckedChange:e=>X(e===!0),disabled:l}),s.jsx(P,{htmlFor:"exclude-selected",className:"text-sm font-normal cursor-pointer",children:"Exclude selected message (fork before it)"})]}),s.jsx(Xe,{"data-test":"fork-session-messages",className:"fork-session-messages flex-1 border rounded-md",children:s.jsx("div",{className:"p-2 space-y-1",children:x.length===0?s.jsx("div",{"data-test":"fork-session-no-messages",className:"text-sm text-muted-foreground text-center py-4",children:"No user messages available to fork from."}):x.map((e,n)=>s.jsx("button",{type:"button","data-test":"fork-session-message",className:_e("fork-session-message w-full text-left p-2 rounded-md transition-colors","hover:bg-accent",m===e.id&&"bg-primary/10 border border-primary"),onClick:()=>{p(e.id),F==null||F(e.id)},disabled:l,children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(We,{size:14,className:"mt-0.5 flex-shrink-0 text-muted-foreground"}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"text-xs text-muted-foreground",children:["Message ",n+1]}),s.jsx("div",{className:"text-sm truncate",children:d(e)})]})]})},e.id))})})]})]}),s.jsxs("div",{"data-test":"fork-session-actions",className:"fork-session-actions p-4 border-t flex justify-end gap-2",children:[s.jsx(ue,{type:"button",variant:"outline","data-test":"fork-session-cancel",onClick:g,disabled:l,children:"Cancel"}),s.jsx(ue,{type:"submit","data-test":"fork-session-submit",disabled:l||!m,children:l?"Creating Fork...":"Create Fork"})]})]})})}function ds(){const{sessionId:r}=Fe(),b=Ee(),{messages:O,sessionDetails:c,metadata:w,loading:q,pagination:l,currentPage:K,loadOlderMessages:F,searchMessages:A,refreshSession:y,addOptimisticMessage:D,removeOptimisticMessage:B}=Ve(r,{onSessionDeleted:()=>{b("/claude")}}),{sessions:j,loadingSessions:$,sessionsError:h,pagination:E,currentPage:z,excludeAgents:I,searchSessions:J,refreshSessions:p,handlePageChange:T,handleLoadMore:X,toggleExcludeAgents:x}=Ye({loadOnMount:!1,subscribeToSSE:!1});t.useLayoutEffect(()=>{var a,o,u,k,C,S;if(c!=null&&c.cwd){const U=fe.getState();((u=(o=(a=U.app)==null?void 0:a.claude)==null?void 0:o.ui)==null?void 0:u.selectedProjectPath)!==c.cwd&&fe.updateState({app:{...U.app,claude:{...(k=U.app)==null?void 0:k.claude,ui:{...(S=(C=U.app)==null?void 0:C.claude)==null?void 0:S.ui,selectedProjectPath:c.cwd}}}})}},[c==null?void 0:c.cwd]);const[f,m]=t.useState(!!r);t.useRef(null);const[v,R]=t.useState(!1),N=t.useRef(0),_=t.useRef(0),V=t.useRef(0),g=t.useRef(null),d=t.useRef(null),i=t.useRef(null),e=t.useRef(null);t.useEffect(()=>{r&&m(!0)},[r]);const n=t.useCallback(()=>{m(!1)},[]),M=40,Y=.4,H=t.useMemo(()=>typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches,[]),te=t.useCallback(a=>{d.current&&(d.current.style.transform=`translateX(calc(-100% + ${a}px))`),i.current&&(i.current.style.transform=`translateX(${a}px)`)},[]),G=t.useCallback(()=>{d.current&&(d.current.style.transform=""),i.current&&(i.current.style.transform="")},[]),L=t.useRef(!1),Q=t.useCallback(a=>{if(H||a.target.closest('input, textarea, button, select, [role="button"], a'))return;const k=a.touches[0];_.current=k.clientX,V.current=k.clientY,g.current=null,N.current=0,k.clientX<=M&&f&&(L.current=!0,R(!0),d.current&&(d.current.style.willChange="transform"),i.current&&(i.current.style.willChange="transform"))},[f,H]),Z=t.useCallback(a=>{if(!L.current)return;const o=a.touches[0],u=o.clientX-_.current,k=o.clientY-V.current;if(g.current===null){const C=Math.abs(u),S=Math.abs(k);if((C>10||S>10)&&(g.current=C>S,!g.current)){L.current=!1,R(!1),G(),d.current&&(d.current.style.willChange=""),i.current&&(i.current.style.willChange="");return}}if(g.current){a.preventDefault();const C=window.innerWidth,S=Math.max(0,Math.min(u,C));N.current=S,e.current&&cancelAnimationFrame(e.current),e.current=requestAnimationFrame(()=>{te(S)})}},[te,G]),ee=t.useCallback(()=>{if(!L.current)return;e.current&&(cancelAnimationFrame(e.current),e.current=null);const a=window.innerWidth,o=N.current>a*Y;G(),d.current&&(d.current.style.willChange=""),i.current&&(i.current.style.willChange=""),o&&n(),L.current=!1,R(!1),N.current=0,g.current=null},[n,G]);t.useEffect(()=>{const a=i.current;if(!(!a||!f))return a.addEventListener("touchstart",Q,{passive:!0}),a.addEventListener("touchmove",Z,{passive:!1}),a.addEventListener("touchend",ee,{passive:!0}),()=>{a.removeEventListener("touchstart",Q),a.removeEventListener("touchmove",Z),a.removeEventListener("touchend",ee)}},[Q,Z,ee,f]);const me=t.useMemo(()=>j.map(a=>a.id),[j]),ae=t.useCallback(a=>{m(!0),b(`/claude/${a}`)},[b]),ge=t.useCallback(()=>{const a=document.querySelector('[data-test="message-input-container"]'),o=a==null?void 0:a.querySelector("textarea");o==null||o.focus()},[]),{focusedIndex:pe,sidebarHasFocus:xe,focusSidebar:ve,sidebarRef:ke}=Ke({sessionIds:me,selectedSessionId:r??null,onSessionSelect:ae,onFocusMessageInput:ge,enabled:!0}),[Ze,ne]=t.useState(null),[es,oe]=t.useState(!1),[Se,re]=t.useState(!1),[be,le]=t.useState(!1),[ye,ie]=t.useState(null),[je,Ne]=t.useState(null),Ce=t.useCallback(a=>{Ne(a),re(!0)},[]),se=t.useCallback(()=>{re(!1),ie(null)},[]),we=t.useCallback(a=>{ie(a)},[]),Me=t.useCallback(async a=>{if(r){le(!0);try{const o=await he.forkSession(r,a);ce.success("Fork created successfully",{description:`Fork "${a.customName||"Unnamed fork"}" has been created.`}),se(),p(),b(`/claude/${o.sessionId}`)}catch(o){console.error("Failed to create fork:",o),ce.error("Failed to create fork",{description:o instanceof Error?o.message:"An unknown error occurred"})}finally{le(!1)}}},[r,se,p,b]),Pe=async(a,o)=>{try{oe(!0);const u=await he.searchMessages(a,o);ne(u.results),console.log("Message search results:",u)}catch(u){console.error("Message search failed:",u),ne([])}finally{oe(!1)}};return s.jsxs("div",{className:"session-details-page h-full overflow-hidden md:p-4","data-test":"session-details-page",children:[s.jsxs("div",{className:"session-layout relative h-full overflow-hidden md:grid md:grid-cols-[350px_1fr] md:gap-4","data-test":"session-layout",children:[s.jsx("div",{ref:d,className:`sessions-sidebar overflow-hidden bg-background
            absolute inset-0 z-10 md:relative md:inset-auto md:z-auto
            ${v?"":"transition-transform duration-300 ease-in-out"}
            ${!v&&f?"-translate-x-full md:translate-x-0":""}
            ${!v&&!f?"translate-x-0":""}
          `,"data-test":"sessions-sidebar-panel",children:s.jsx(Ie,{sessions:j,loading:$,error:h,onSessionSelect:ae,selectedSessionId:r??null,onRefresh:()=>{p(),y()},pagination:E,currentPage:z,onPageChange:T,onLoadMore:X,onSearch:J,onMessageSearch:Pe,onNameUpdated:()=>{y(),p()},excludeAgents:I,onToggleExcludeAgents:x,focusedIndex:xe?pe:-1,sidebarRef:ke,onSidebarClick:ve})}),s.jsxs("div",{ref:i,className:`chat-area flex flex-col gap-4 min-h-0 overflow-hidden bg-background
            absolute inset-0 z-10 md:relative md:inset-auto md:z-auto
            ${v?"":"transition-transform duration-300 ease-in-out"}
            ${!v&&f?"translate-x-0":""}
            ${!v&&!f?"translate-x-full md:translate-x-0 pointer-events-none md:pointer-events-auto":""}
          `,"data-test":"chat-area-panel",children:[s.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden",children:s.jsx(He,{messages:O,sessionDetails:c,metadata:w,loading:q,pagination:l,onLoadOlder:l&&K<l.totalPages?F:void 0,onSearch:A,onNameUpdated:()=>{y(),p()},onFork:r?Ce:void 0,scrollToMessageId:ye,onBackClick:n,showBackButton:!0})}),s.jsx("div",{className:"chat-input flex-shrink-0",children:r&&s.jsx(Ge,{sessionId:r,onSendSuccess:()=>{y()},onAddOptimisticMessage:D,onRemoveOptimisticMessage:B,userMessages:O.filter(a=>a.role==="user"&&!a._isOptimistic)})})]})]}),r&&c&&s.jsx(Qe,{isVisible:Se,onClose:se,sessionId:r,sessionName:c.customName||c.name,messages:O,onFork:Me,isSubmitting:be,onMessageSelect:we,triggerPosition:je??void 0})]})}export{ds as SessionDetailsPage};
