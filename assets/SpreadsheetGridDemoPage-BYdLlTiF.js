var je=Object.defineProperty;var ke=(t,e,n)=>e in t?je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var w=(t,e,n)=>ke(t,typeof e!="symbol"?e+"":e,n);import{r as x,j as l}from"./react-vendor-Byz07MLO.js";import{B as $e}from"./Breadcrumbs-CbFAFVWz.js";import{c5 as ae,c6 as ue,a as H,C as ee,b as te,c as ne,d as ie,e as se,m as Ve,n as We,o as Se,p as Ee,L as pe,I as Fe}from"./index-BbgB-sev.js";import{A as xe,a as Ie}from"./alert-BK0jqY_S.js";import{b as Pe,V as K,c as fe,d as Le,C as ye,K as He,S as _e,R as Ge,a as Oe,I as Ue}from"./VimInputHandlerV2-Bn_zUAax.js";import{D as ze,E as Be,V as ce}from"./logging-DcJ9NSa2.js";import{F as Je,S as Ke}from"./SpecView-BD4rf29R.js";import"./utils-DjFvUtuq.js";import"./radix-ui-B6r6BEmy.js";import"./icons-Detj0uxE.js";import"./ui-utils-BxIQ3qGg.js";import"./string-4WCj7OpV.js";import"./clipboardHtmlToMarkdown-BNZmEbgs.js";var f=(t=>(t.cursorLeft="cursorLeft",t.cursorRight="cursorRight",t.cursorUp="cursorUp",t.cursorDown="cursorDown",t.wordForward="wordForward",t.wordBackward="wordBackward",t.wordEnd="wordEnd",t.lineStart="lineStart",t.lineEnd="lineEnd",t.firstNonWhitespace="firstNonWhitespace",t.documentStart="documentStart",t.documentEnd="documentEnd",t.blockUp="blockUp",t.blockDown="blockDown",t.delete="delete",t.clearCell="clearCell",t.joinLines="joinLines",t.yank="yank",t.pasteVim="pasteVim",t.pasteVimBefore="pasteVimBefore",t.paste="paste",t.enterInsert="enterInsert",t.enterVisual="enterVisual",t.exitMode="exitMode",t))(f||{}),re=(t=>(t.TEXT="TEXT",t.HTML="HTML",t.AUDIO="AUDIO",t.BUTTON="BUTTON",t))(re||{});class qe{constructor(){w(this,"contentMap",[]);w(this,"sheets",new Map);w(this,"activeSheetId",null);w(this,"changeListeners",new Set)}getCell(e,n){var s;return((s=this.contentMap[n])==null?void 0:s[e])??null}getOrCreateCell(e,n,i=""){const s=this.getCell(e,n);return s||this.createCell(e,n,i)}createCell(e,n,i=""){this.contentMap[n]||(this.contentMap[n]=[]);const s={text:i,kind:re.TEXT,col:e,row:n};return this.contentMap[n][e]=s,this.notifyChange(e,n,s),s}updateCell(e,n,i){this.contentMap[n]||(this.contentMap[n]=[]);const s=this.contentMap[n][e];s?this.contentMap[n][e]={...s,...i,col:e,row:n}:this.contentMap[n][e]={text:"",kind:re.TEXT,...i,col:e,row:n},this.notifyChange(e,n,this.contentMap[n][e])}setCellContent(e,n,i){this.contentMap[n]||(this.contentMap[n]=[]),this.contentMap[n][e]={text:i,kind:re.TEXT,col:e,row:n},this.notifyChange(e,n,this.contentMap[n][e])}clearCell(e,n){this.contentMap[n]||(this.contentMap[n]=[]),this.contentMap[n][e]={text:"",kind:re.TEXT,col:e,row:n},this.notifyChange(e,n,this.contentMap[n][e])}deleteCell(e,n){this.contentMap[n]&&(this.contentMap[n].splice(e,1),this.notifyChange(e,n,null))}clearAll(){this.contentMap=[]}getContentMap(){return this.contentMap}setContentMap(e){this.contentMap=e}createSheet(e,n){const i={id:e,title:n,content:[]};return this.sheets.set(e,i),i}switchSheet(e){const n=this.sheets.get(e);if(!n)return!1;if(this.activeSheetId){const i=this.sheets.get(this.activeSheetId);i&&(i.content=this.contentMap)}return this.activeSheetId=e,this.contentMap=n.content,!0}getActiveSheet(){if(!this.activeSheetId)return null;const e=this.sheets.get(this.activeSheetId);return e&&(e.content=this.contentMap),e??null}getSheet(e){return this.sheets.get(e)??null}getAllSheets(){return Array.from(this.sheets.values())}deleteSheet(e){return e===this.activeSheetId?!1:this.sheets.delete(e)}onContentChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}notifyChange(e,n,i){this.changeListeners.forEach(s=>{s(e,n,i)})}getDimensions(){if(this.contentMap.length===0)return{rows:0,cols:0};const e=this.contentMap.length,n=this.contentMap.filter(s=>s!==void 0).map(s=>(s==null?void 0:s.length)??0),i=n.length>0?Math.max(...n):0;return{rows:e,cols:i}}isCellEmpty(e,n){var s;const i=this.getCell(e,n);return!i||!((s=i.text)!=null&&s.trim())}isRowEmpty(e){const n=this.contentMap[e];return n?!n.some(i=>{var s;return(s=i==null?void 0:i.text)==null?void 0:s.trim()}):!0}}const le={headings:{h1:"#e06c75",h2:"#e5c07b",h3:"#61afef",h4:"#c678dd",h5:"#56b6c2",h6:"#98c379"}};class Xe{constructor(e){this.sheet=e}getCell(e,n){var s;return((s=this.sheet.content[n])==null?void 0:s[e])??null}getGridCoordsFromSheet(){if(!this.sheet||!this.sheet.content||this.sheet.content.length===0)return null;const e=this.sheet.content.length-1,n=Math.max(0,...this.sheet.content.map(s=>((s==null?void 0:s.length)??1)-1));return[[0,0],[n,e]]}setSheet(e){this.sheet=e}getSheet(){return this.sheet}}function Ye(t){return t!=null&&t.text&&(t.styles||(t.styles={}),t.text.startsWith("# ")?t.styles.color=le.headings.h1:t.text.startsWith("## ")?t.styles.color=le.headings.h2:t.text.startsWith("### ")?t.styles.color=le.headings.h3:t.text.startsWith("#### ")?t.styles.color=le.headings.h4:t.text.startsWith("##### ")?t.styles.color=le.headings.h5:t.text.startsWith("###### ")?t.styles.color=le.headings.h6:t.text.startsWith("#")&&delete t.styles.color),t}function Ze(t,e){const n=new Xe(t),i=n.getGridCoordsFromSheet();if(!i)return t;const[s,r]=i;return e(s,r,(a,u)=>{const c=n.getCell(a,u);c&&Ye(c)}),t}class Qe{constructor(){w(this,"clipboard",[])}executeEdit(e,n,i,s){const[r,a]=n;switch(e){case f.clearCell:return this.clearCell(r,a,i);case f.delete:return this.deleteRow(a,i);case f.joinLines:return this.joinCells(r,a,i);case f.yank:return this.yankSelection(i,s||[n,n]);case f.pasteVim:return this.paste(r,a,i,!1);case f.pasteVimBefore:return this.paste(r,a,i,!0);default:return{contentMap:i,affectedCells:[],success:!1}}}clearCell(e,n,i){const s=this.deepCloneContentMap(i);s[n]||(s[n]=[]);const r=s[n][e];return r!=null&&r.text&&(this.clipboard=[[r.text]]),s[n][e]=this.createEmptyCell(e,n),{contentMap:s,affectedCells:[{col:e,row:n}],success:!0}}deleteRow(e,n){const i=this.deepCloneContentMap(n),s=i[e];s&&(this.clipboard=[s.map(a=>(a==null?void 0:a.text)||"")]),i[e]&&(i[e]=i[e].map((a,u)=>this.createEmptyCell(u,e)));const r=i[e]?i[e].map((a,u)=>({col:u,row:e})):[];return{contentMap:i,affectedCells:r,success:!0}}joinCells(e,n,i){var c,b;const s=this.deepCloneContentMap(i),r=(c=s[n])==null?void 0:c[e],a=(b=s[n+1])==null?void 0:b[e];if(!r||!a)return{contentMap:s,affectedCells:[],success:!1};const u=`${r.text||""} ${a.text||""}`.trim();return s[n]||(s[n]=[]),s[n][e]={...r,text:u},s[n+1]||(s[n+1]=[]),s[n+1][e]=this.createEmptyCell(e,n+1),{contentMap:s,affectedCells:[{col:e,row:n},{col:e,row:n+1}],success:!0}}yankSelection(e,n){var b,v;const[[i,s],[r,a]]=n,u=[];for(let p=s;p<=a;p++){const S=[];for(let C=i;C<=r;C++)S.push(((v=(b=e[p])==null?void 0:b[C])==null?void 0:v.text)||"");u.push(S)}this.clipboard=u;const c=[];for(let p=s;p<=a;p++)for(let S=i;S<=r;S++)c.push({col:S,row:p});return{contentMap:e,affectedCells:c,success:!0}}paste(e,n,i,s){if(this.clipboard.length===0)return{contentMap:i,affectedCells:[],success:!1};const r=this.deepCloneContentMap(i),a=e,u=s?n:n+1,c=[];return this.clipboard.forEach((b,v)=>{const p=u+v;r[p]||(r[p]=[]),b.forEach((S,C)=>{const L=a+C;r[p][L]={text:S,kind:re.TEXT,col:L,row:p},c.push({col:L,row:p})})}),{contentMap:r,affectedCells:c,success:!0}}getClipboard(){return this.clipboard}setClipboard(e){this.clipboard=e}deepCloneContentMap(e){return JSON.parse(JSON.stringify(e))}createEmptyCell(e,n){return{text:"",kind:re.TEXT,col:e,row:n}}}class Me{constructor(e,n){w(this,"undoStack",[]);w(this,"redoStack",[]);w(this,"currentState",null);w(this,"config");this.currentState=e||null,this.config=n||{}}addToHistory(e){if(this.currentState!==null){const n=this.deepClone(this.currentState);this.undoStack.push(n),this.config.maxHistorySize&&this.undoStack.length>this.config.maxHistorySize&&this.undoStack.shift()}this.currentState=this.deepClone(e),this.redoStack=[]}undo(){return this.undoStack.length>0?(this.currentState!==null&&this.redoStack.push(this.deepClone(this.currentState)),this.currentState=this.undoStack.pop(),this.deepClone(this.currentState)):this.currentState?this.deepClone(this.currentState):[]}redo(){return this.redoStack.length>0?(this.currentState!==null&&this.undoStack.push(this.deepClone(this.currentState)),this.currentState=this.redoStack.pop(),this.deepClone(this.currentState)):this.currentState?this.deepClone(this.currentState):[]}getState(){return this.currentState?this.deepClone(this.currentState):[]}setState(e){this.addToHistory(e)}init(e){this.currentState=this.deepClone(e)}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}getHistoryDepth(){return{undo:this.undoStack.length,redo:this.redoStack.length}}getUndoStack(){return this.undoStack.map(e=>this.deepClone(e))}getRedoStack(){return this.redoStack.map(e=>this.deepClone(e))}setUndoStack(e){this.undoStack=e.map(n=>this.deepClone(n))}setRedoStack(e){this.redoStack=e.map(n=>this.deepClone(n))}clearHistory(){this.undoStack=[],this.redoStack=[]}reset(){this.undoStack=[],this.redoStack=[],this.currentState=null}deepClone(e){return JSON.parse(JSON.stringify(e))}}var J=(t=>(t.CELL_CHANGE="CELL_CHANGE",t.CELL_SELECT="CELL_SELECT",t.CELL_DESELECT="CELL_DESELECT",t.SELECTION_CHANGE="SELECTION_CHANGE",t.AUDIO_START="AUDIO_START",t.AUDIO_END="AUDIO_END",t.AUDIO_PAUSE="AUDIO_PAUSE",t.AUDIO_RESUME="AUDIO_RESUME",t.CELL_FOCUS="CELL_FOCUS",t.CELL_BLUR="CELL_BLUR",t.SHEET_CHANGE="SHEET_CHANGE",t.SHEET_CHANGED="SHEET_CHANGED",t.SHEET_CREATED="SHEET_CREATED",t.SHEET_DELETED="SHEET_DELETED",t.SHEET_SWITCHED="SHEET_SWITCHED",t.STATE_REHYDRATED="STATE_REHYDRATED",t.MARKDOWN_APPLIED="MARKDOWN_APPLIED",t.CURSOR_MOVED="CURSOR_MOVED",t))(J||{});class et{constructor(e){w(this,"subscribers",new Map);w(this,"eventRegistry",new Set);w(this,"shouldLog",!1);this.shouldLog=(e==null?void 0:e.enableLogging)||!1}subscribe(e,n){const i=this.resolveEventKey(e);this.shouldLog&&console.log("[CellEventService] Subscribe:",i),this.subscribers.has(i)||this.subscribers.set(i,[]);const s=this.subscribers.get(i);return s.push(n),this.eventRegistry.add(i),()=>{const r=s.indexOf(n);r>-1&&s.splice(r,1),s.length===0&&this.subscribers.delete(i)}}publish(e,n){const i=this.resolveEventKey(e);this.shouldLog&&console.log("[CellEventService] Publish:",i,n),this.eventRegistry.add(i);const s=this.subscribers.get(i);if(!s||s.length===0)return;const r={...n,timestamp:n.timestamp||Date.now()};s.forEach(a=>{try{a(r)}catch(u){console.error("[CellEventService] Error in subscriber:",u)}})}subscribeToCellEvent(e,n,i){const s=this.getCellEventKey(e,n);return this.subscribe(s,i)}publishCellEvent(e,n,i){const s=this.getCellEventKey(e,n);this.publish(s,i)}getRegisteredEvents(){return Array.from(this.eventRegistry)}hasSubscribers(e){const n=this.resolveEventKey(e),i=this.subscribers.get(n);return i?i.length>0:!1}getSubscriberCount(e){const n=this.resolveEventKey(e),i=this.subscribers.get(n);return i?i.length:0}clearAllSubscribers(){this.subscribers.clear(),this.eventRegistry.clear()}clearSubscribers(e){const n=this.resolveEventKey(e);this.subscribers.delete(n)}setLogging(e){this.shouldLog=e}resolveEventKey(e){return typeof e=="string"?e:this.isCell(e)?this.getCellEventKey(e.col,e.row):e.toString()}getCellEventKey(e,n){return`cell-event:[${e}-${n}]`}isCell(e){return e&&typeof e=="object"&&"col"in e&&"row"in e&&typeof e.col=="number"&&typeof e.row=="number"}}const tt=30,V={autosave:!0,llm:{printPrompts:!0},copy:{autopasteIntoRow:{enabled:!0,col:2,method:["yank"]},copyRowRaw:!0},grid:{cells:{flag:!0,clipText:!0,clipTextOffset:1,audio:{aBRepeat:!0},modes:{insert:{allowMoveCellVertically:!0}}},cursor:{keepCursorAtCenter:!0,cell:{scrollAmount:6,scrollOffset:tt*2,scrollAmountHorizontal:1}}},paste:{autosplit:{flag:!0,endingChars:".!?",byEnding:".!?",separatorChars:",;:",bySeparator:""},splitByPeriod:!0,splitByPeriodAndComma:!1},mode:{enterCellInInsertMode:!1,autoExpandGrid:!1},vim:{mode:{putCursorAtFirstNonWhiteSpace:!0}}};class Ne{static get(e){return V[e]}static canPasteAutoSplitFlag(){return V.paste.autosplit.flag}static getPasteAutoSplitByEnding(){return this.canPasteAutoSplitFlag()?V.paste.autosplit.byEnding.length>0:!1}static getPasteAutoSplitBySeparator(){return this.canPasteAutoSplitFlag()?V.paste.autosplit.bySeparator.length>0:!1}static getClipTextFlag(){return V.grid.cells.flag}static canClipText(){if(!this.getClipTextFlag())return!1;const{cells:e}=V.grid;return e.clipText&&!e.clipTextOffset}static getClipTextOffset(){return this.getClipTextFlag()?this.canClipText()?NaN:V.grid.cells.clipTextOffset:NaN}static shouldKeepCursorAtCenter(){return V.grid.cursor.keepCursorAtCenter}static getScrollAmount(){return V.grid.cursor.cell.scrollAmount}static getScrollAmountHorizontal(){return V.grid.cursor.cell.scrollAmountHorizontal}static canAutoPasteIntoRow(){return V.copy.autopasteIntoRow.enabled}static getAutoPasteColumn(){return V.copy.autopasteIntoRow.col}static isAutoPasteMethod(e){return V.copy.autopasteIntoRow.method.includes(e)}static shouldEnterCellInInsertMode(){return V.mode.enterCellInInsertMode}static shouldAutoExpandGrid(){return V.mode.autoExpandGrid}static canMoveCellVerticallyInInsert(){return V.grid.cells.modes.insert.allowMoveCellVertically}static shouldPutCursorAtFirstNonWhiteSpace(){return V.vim.mode.putCursorAtFirstNonWhiteSpace}}const Te={persistState:!0,autosave:!0,autosaveDebounceMs:1e3,storageKey:"spreadsheet-grid-storage",dataVersion:"1.0.0",exportFormat:"json",includeExportMetadata:!0,showErrorNotifications:!0,enableLogging:!1};class Ce{constructor(e){w(this,"persistState");w(this,"autosave");w(this,"autosaveDebounceMs");w(this,"storageKey");w(this,"dataVersion");w(this,"exportFormat");w(this,"includeExportMetadata");w(this,"showErrorNotifications");w(this,"enableLogging");const n={...Te,...e};this.persistState=n.persistState,this.autosave=n.autosave,this.autosaveDebounceMs=n.autosaveDebounceMs,this.storageKey=n.storageKey,this.dataVersion=n.dataVersion,this.exportFormat=n.exportFormat,this.includeExportMetadata=n.includeExportMetadata,this.showErrorNotifications=n.showErrorNotifications,this.enableLogging=n.enableLogging}update(e){Object.assign(this,e)}reset(){Object.assign(this,Te)}toJSON(){return{persistState:this.persistState,autosave:this.autosave,autosaveDebounceMs:this.autosaveDebounceMs,storageKey:this.storageKey,dataVersion:this.dataVersion,exportFormat:this.exportFormat,includeExportMetadata:this.includeExportMetadata,showErrorNotifications:this.showErrorNotifications,enableLogging:this.enableLogging}}static fromJSON(e){return new Ce(e)}}class de{constructor(e){w(this,"defaultColumns",26);w(this,"defaultRows",100);w(this,"cellWidth",100);w(this,"cellHeight",30);w(this,"borderWidth",1);w(this,"padding",8);w(this,"clipText",!0);w(this,"clipTextOffset",2);w(this,"vimCursorCenter",!0);w(this,"vimScrollAmount",10);w(this,"vimScrollAmountHorizontal",1);w(this,"vimEnterCellInInsertMode",!1);w(this,"vimPutCursorAtFirstNonWhiteSpace",!0);w(this,"autoExpandGrid",!1);w(this,"autoSave",!0);w(this,"allowMoveCellVerticallyInInsert",!0);w(this,"featureFlags",V);w(this,"persistence");if(this.persistence=new Ce(e==null?void 0:e.persistence),e){const{persistence:n,...i}=e;Object.assign(this,i)}}get ff(){return Ne}update(e){Object.assign(this,e)}reset(){Object.assign(this,new de)}toJSON(){return{defaultColumns:this.defaultColumns,defaultRows:this.defaultRows,cellWidth:this.cellWidth,cellHeight:this.cellHeight,borderWidth:this.borderWidth,padding:this.padding,clipText:this.clipText,clipTextOffset:this.clipTextOffset,vimCursorCenter:this.vimCursorCenter,vimScrollAmount:this.vimScrollAmount,vimScrollAmountHorizontal:this.vimScrollAmountHorizontal,vimEnterCellInInsertMode:this.vimEnterCellInInsertMode,vimPutCursorAtFirstNonWhiteSpace:this.vimPutCursorAtFirstNonWhiteSpace,autoExpandGrid:this.autoExpandGrid,autoSave:this.autoSave,allowMoveCellVerticallyInInsert:this.allowMoveCellVerticallyInInsert,persistence:this.persistence.toJSON()}}static fromJSON(e){return new de(e)}}new de;function nt(t,e,n,i){const s=(i==null?void 0:i.startCol)??t[0],r=(i==null?void 0:i.startRow)??t[1],a=(i==null?void 0:i.endCol)??e[0],u=(i==null?void 0:i.endRow)??e[1];let c=!1;for(let b=r;b<=u&&!c;b++)for(let v=s;v<=a&&(c=!!n(v,b),!c);v++);}function it(t,e){var s;if(!t.col||t.row===void 0)return 0;const n=e[t.row];if(!n)return 0;let i=0;for(let r=t.col+1;r<n.length;r++)if(i++,(s=n[r])!=null&&s.text)return i;return i}class st{constructor(e){w(this,"vimCore");w(this,"currentGridPosition");w(this,"gridDimensions");w(this,"selectionFacade",null);w(this,"visualModeActive",!1);w(this,"visualStartCell",null);w(this,"mappingByNormalMode",[]);w(this,"mappingByVisualMode",[]);this.currentGridPosition=e.initialPosition||[0,0],this.gridDimensions={cols:e.maxCols,rows:e.maxRows};const n={vimState:this.createInitialVimState(),hooks:{vimStateUpdated:i=>this.onVimStateUpdated(i)}};this.vimCore=Pe.create(n),this.initializeCommandMappings()}setSelectionFacade(e){this.selectionFacade=e}initializeCommandMappings(){this.mappingByNormalMode=[{command:f.cursorLeft,desc:"Move left",execute:()=>this.moveLeft()},{command:f.cursorRight,desc:"Move right",execute:()=>this.moveRight()},{command:f.cursorUp,desc:"Move up",execute:()=>this.moveUp()},{command:f.cursorDown,desc:"Move down",execute:()=>this.moveDown()},{command:f.wordForward,desc:"Move to next cell (word forward)",execute:()=>this.moveRight()},{command:f.wordBackward,desc:"Move to previous cell (word backward)",execute:()=>this.moveLeft()},{command:f.lineStart,desc:"Move to first column",execute:()=>this.moveToLineStart()},{command:f.lineEnd,desc:"Move to last column",execute:()=>this.moveToLineEnd()},{command:f.documentStart,desc:"Move to first row",execute:()=>this.moveToDocumentStart()},{command:f.documentEnd,desc:"Move to last row",execute:()=>this.moveToDocumentEnd()}],this.mappingByVisualMode=[{command:f.cursorLeft,desc:"Extend selection left",execute:()=>this.extendSelectionLeft()},{command:f.cursorRight,desc:"Extend selection right",execute:()=>this.extendSelectionRight()},{command:f.cursorUp,desc:"Extend selection up",execute:()=>this.extendSelectionUp()},{command:f.cursorDown,desc:"Extend selection down",execute:()=>this.extendSelectionDown()},{command:f.wordForward,desc:"Extend selection right",execute:()=>this.extendSelectionRight()},{command:f.wordBackward,desc:"Extend selection left",execute:()=>this.extendSelectionLeft()},{command:f.lineStart,desc:"Extend selection to line start",execute:()=>this.extendSelectionToLineStart()},{command:f.lineEnd,desc:"Extend selection to line end",execute:()=>this.extendSelectionToLineEnd()},{command:f.documentStart,desc:"Extend selection to document start",execute:()=>this.extendSelectionToDocumentStart()},{command:f.documentEnd,desc:"Extend selection to document end",execute:()=>this.extendSelectionToDocumentEnd()},{command:f.exitMode,desc:"Exit visual mode to normal mode",execute:()=>this.exitVisualMode()}]}executeVimCommand(e){const n=this.vimCore.getVimState().mode,s=(n===K.VISUAL?this.mappingByVisualMode:this.mappingByNormalMode).find(r=>r.command===e);return s!=null&&s.execute?(s.execute(),{position:this.currentGridPosition,selectionRange:this.getVisualRange(),mode:n,success:!0}):{position:this.currentGridPosition,selectionRange:this.getVisualRange(),mode:n,success:!1}}enterVisualMode(e=!1){this.visualModeActive=!0,this.visualStartCell=[...this.currentGridPosition],e&&this.vimCore.executeCommand(fe.enterVisualMode,""),this.selectionFacade&&this.selectionFacade.setRange(this.visualStartCell,this.currentGridPosition)}exitVisualMode(e=!1){this.visualModeActive=!1,this.visualStartCell=null,e&&this.vimCore.executeCommand(fe.enterNormalMode,""),this.selectionFacade&&this.selectionFacade.clearRange()}enterInsertMode(){this.vimCore.executeCommand(fe.enterInsertMode,"")}getCurrentMode(){return this.vimCore.getVimState().mode}getCurrentPosition(){return this.currentGridPosition}setGridPosition(e){this.currentGridPosition=e,this.visualModeActive&&this.visualStartCell&&this.selectionFacade&&this.selectionFacade.setRange(this.visualStartCell,e)}getVisualRange(){return!this.visualModeActive||!this.visualStartCell?null:[this.visualStartCell,this.currentGridPosition]}moveLeft(){const[e,n]=this.currentGridPosition,i=Math.max(0,e-1);this.currentGridPosition=[i,n],this.selectionFacade&&this.selectionFacade.setActiveCell([i,n])}moveRight(){const[e,n]=this.currentGridPosition,i=Math.min(this.gridDimensions.cols-1,e+1);this.currentGridPosition=[i,n],this.selectionFacade&&this.selectionFacade.setActiveCell([i,n])}moveUp(){const[e,n]=this.currentGridPosition,i=Math.max(0,n-1);this.currentGridPosition=[e,i],this.selectionFacade&&this.selectionFacade.setActiveCell([e,i])}moveDown(){const[e,n]=this.currentGridPosition,i=Math.min(this.gridDimensions.rows-1,n+1);this.currentGridPosition=[e,i],this.selectionFacade&&this.selectionFacade.setActiveCell([e,i])}moveToLineStart(){const[e,n]=this.currentGridPosition;this.currentGridPosition=[0,n],this.selectionFacade&&this.selectionFacade.setActiveCell([0,n])}moveToLineEnd(){const[e,n]=this.currentGridPosition;this.currentGridPosition=[this.gridDimensions.cols-1,n],this.selectionFacade&&this.selectionFacade.setActiveCell([this.gridDimensions.cols-1,n])}moveToDocumentStart(){const[e,n]=this.currentGridPosition;this.currentGridPosition=[e,0],this.selectionFacade&&this.selectionFacade.setActiveCell([e,0])}moveToDocumentEnd(){const[e,n]=this.currentGridPosition;this.currentGridPosition=[e,this.gridDimensions.rows-1],this.selectionFacade&&this.selectionFacade.setActiveCell([e,this.gridDimensions.rows-1])}extendSelectionLeft(){this.moveLeft(),this.updateVisualSelection()}extendSelectionRight(){this.moveRight(),this.updateVisualSelection()}extendSelectionUp(){this.moveUp(),this.updateVisualSelection()}extendSelectionDown(){this.moveDown(),this.updateVisualSelection()}extendSelectionToLineStart(){this.moveToLineStart(),this.updateVisualSelection()}extendSelectionToLineEnd(){this.moveToLineEnd(),this.updateVisualSelection()}extendSelectionToDocumentStart(){this.moveToDocumentStart(),this.updateVisualSelection()}extendSelectionToDocumentEnd(){this.moveToDocumentEnd(),this.updateVisualSelection()}updateVisualSelection(){this.visualModeActive&&this.visualStartCell&&this.selectionFacade&&this.selectionFacade.setRange(this.visualStartCell,this.currentGridPosition)}createInitialVimState(){return{id:"grid-nav",mode:K.NORMAL,cursor:{line:this.currentGridPosition[1],col:0},lines:[]}}onVimStateUpdated(e){e.mode===K.NORMAL&&this.visualModeActive&&this.exitVisualMode()}updateDimensions(e,n){this.gridDimensions={cols:e,rows:n};const[i,s]=this.currentGridPosition;this.currentGridPosition=[Math.min(i,e-1),Math.min(s,n-1)]}getCommandMappings(){const e=["Grid:Navigation"],n=this.mappingByNormalMode.map(s=>({...s,context:e,preventUndoRedo:!0})),i=this.mappingByVisualMode.map(s=>({...s,context:e,preventUndoRedo:!0}));return{[K.NORMAL]:n,[K.VISUAL]:i,[K.INSERT]:[],[K.ALL]:[]}}destroy(){this.selectionFacade=null}}function rt(t){const{clipboard:e,editingCell:n,dragInfo:i,resizeInfo:s,...r}=t;return r}function ot(t){return t&&typeof t=="object"&&t.version==="1.0"&&typeof t.exportedAt=="string"&&Array.isArray(t.sheets)&&typeof t.activeSheetId=="string"&&typeof t.metadata=="object"&&typeof t.metadata.sheetCount=="number"}const lt={sheets:[{id:"sheet-1",title:"Sheet 1",content:[]}],activeSheetId:"sheet-1",undoStack:[],redoStack:[],featureFlags:V,lastModified:Date.now(),createdAt:Date.now()},at={theme:"default",zoom:1,showGridLines:!0,showHeaders:!0,vimModeEnabled:!0,selectedCells:void 0,clipboard:null,editingCell:null,dragInfo:null,resizeInfo:null},ct={defaultColumnWidth:100,defaultRowHeight:30,autoExpandGrid:!1,enterCellInInsertMode:!1,showFormulaBar:!0,recentFiles:[]},dt={mode:"replace",includeHistory:!1,validateSheetIds:!0};class ht{constructor(e){this.config=e}loadStateFromLocalStorage(){if(!this.config.persistState)return this.log("Persistence disabled - skipping load"),null;try{const e=localStorage.getItem(this.config.storageKey);if(!e)return this.log("No persisted state found"),null;const n=JSON.parse(e);return n.dataVersion!==this.config.dataVersion?(this.warn(`Data version mismatch (stored: ${n.dataVersion}, expected: ${this.config.dataVersion}) - clearing old state`),localStorage.removeItem(this.config.storageKey),null):(this.log("State loaded successfully from localStorage"),n)}catch(e){return this.error("Failed to load state from localStorage",e),null}}saveStateToLocalStorage(e){if(!this.config.persistState)return this.log("Persistence disabled - skipping save"),!1;try{const n=rt(e.uiState),i={version:e.version,dataVersion:e.dataVersion,data:e.data,uiState:n,preferences:e.preferences},s=JSON.stringify(i);return localStorage.setItem(this.config.storageKey,s),this.log("State saved successfully to localStorage"),!0}catch(n){return n instanceof DOMException&&n.name==="QuotaExceededError"?(this.error("localStorage quota exceeded - cannot save state",n),this.config.showErrorNotifications&&this.notifyError("Storage quota exceeded. Unable to save changes.")):(this.error("Failed to save state to localStorage",n),this.config.showErrorNotifications&&this.notifyError("Failed to save changes.")),!1}}clearLocalStorage(){try{localStorage.removeItem(this.config.storageKey),this.log("localStorage cleared")}catch(e){this.error("Failed to clear localStorage",e)}}getStorageSize(){try{const e=localStorage.getItem(this.config.storageKey);return e?new Blob([e]).size:0}catch(e){return this.error("Failed to get storage size",e),null}}rehydrateState(e){const n=this.loadStateFromLocalStorage();return n?(this.log("Rehydrating state from localStorage"),{...e,...n,data:{...e.data,...n.data},uiState:{...e.uiState,...n.uiState,clipboard:null,editingCell:null,dragInfo:null,resizeInfo:null},preferences:{...e.preferences,...n.preferences}}):(this.log("No state to rehydrate - using initial state"),e)}isLocalStorageAvailable(){try{const e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return this.error("localStorage not available",e),!1}}log(e){this.config.enableLogging&&console.log(`[GridPersistence] ${e}`)}warn(e){this.config.enableLogging&&console.warn(`[GridPersistence] ${e}`)}error(e,n){console.error(`[GridPersistence] ${e}`,n)}notifyError(e){console.error(`[GridPersistence] ${e}`)}}class ut{constructor(e){this.config=e}exportToJSON(e,n=!1){const i={version:"1.0",exportedAt:new Date().toISOString(),metadata:{sheetCount:e.data.sheets.length,cellCount:this.countTotalCells(e.data.sheets),nonEmptyCellCount:this.countNonEmptyCells(e.data.sheets),exportedBy:"Spreadsheet Grid v1.0.0"},sheets:e.data.sheets,activeSheetId:e.data.activeSheetId,featureFlags:e.data.featureFlags,undoStack:n?e.data.undoStack:void 0,redoStack:n?e.data.redoStack:void 0,preferences:e.preferences};if(this.config.includeExportMetadata)return JSON.stringify(i,null,2);{const s={sheets:i.sheets,activeSheetId:i.activeSheetId};return JSON.stringify(s,null,2)}}importFromJSON(e,n,i={}){const s={...dt,...i},r={sheetsImported:0,sheetsSkipped:0,cellsImported:0,errors:[],warnings:[]};try{const a=JSON.parse(e);return this.validateImportData(a,r)?s.mode==="replace"?this.importReplace(a,s,r):this.importMerge(a,n,s,r):r}catch(a){return r.errors.push(a instanceof Error?a.message:"Failed to parse JSON"),r}}validateImportData(e,n){return ot(e)?!0:e&&typeof e=="object"&&Array.isArray(e.sheets)&&typeof e.activeSheetId=="string"?(n.warnings.push("Import data is missing metadata (older export format)"),!0):(n.errors.push("Invalid import format: Expected GridExportData structure"),!1)}importReplace(e,n,i){return(e.sheets||[]).forEach(r=>{try{if(!this.validateSheet(r)){i.errors.push(`Invalid sheet structure: ${r.id||"unknown"}`),i.sheetsSkipped++;return}i.sheetsImported++,i.cellsImported+=this.countSheetCells(r)}catch(a){i.errors.push(`Failed to import sheet ${r.id}: ${a instanceof Error?a.message:"Unknown error"}`),i.sheetsSkipped++}}),i}importMerge(e,n,i,s){const r=e.sheets||[],a=new Set(n.data.sheets.map(u=>u.id));return r.forEach(u=>{try{if(!this.validateSheet(u)){s.errors.push(`Invalid sheet structure: ${u.id||"unknown"}`),s.sheetsSkipped++;return}if(a.has(u.id))if(i.validateSheetIds){const c=this.generateUniqueSheetId(a);s.warnings.push(`Sheet ID '${u.id}' already exists - renamed to '${c}'`),u.id=c}else{s.warnings.push(`Sheet ID '${u.id}' already exists - skipping`),s.sheetsSkipped++;return}a.add(u.id),s.sheetsImported++,s.cellsImported+=this.countSheetCells(u)}catch(c){s.errors.push(`Failed to import sheet ${u.id}: ${c instanceof Error?c.message:"Unknown error"}`),s.sheetsSkipped++}}),s}validateSheet(e){return e&&typeof e=="object"&&typeof e.id=="string"&&typeof e.title=="string"&&Array.isArray(e.content)}generateUniqueSheetId(e){let n=1,i=`sheet-${n}`;for(;e.has(i);)n++,i=`sheet-${n}`;return i}countTotalCells(e){return e.reduce((n,i)=>n+this.countSheetCells(i),0)}countSheetCells(e){return(e.content||[]).reduce((i,s)=>i+((s==null?void 0:s.length)||0),0)}countNonEmptyCells(e){return e.reduce((n,i)=>{const s=i.content||[];return n+s.reduce((r,a)=>{var u;return r+(((u=a==null?void 0:a.filter(c=>c&&c.text&&c.text.trim()!==""))==null?void 0:u.length)||0)},0)},0)}exportToFile(e,n){const i=this.exportToJSON(e,!1),s=new Blob([i],{type:"application/json"}),r=URL.createObjectURL(s),a=document.createElement("a");a.href=r,a.download=n||`spreadsheet-export-${new Date().toISOString()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}async importFromFile(e,n,i={}){return new Promise((s,r)=>{const a=new FileReader;a.onload=u=>{var c;try{const b=(c=u.target)==null?void 0:c.result,v=this.importFromJSON(b,n,i);s(v)}catch(b){r(b)}},a.onerror=()=>{r(new Error("Failed to read file"))},a.readAsText(e)})}}class mt{constructor(e={}){w(this,"gridState");w(this,"gridVim");w(this,"vimEdit");w(this,"undoRedo");w(this,"eventService");w(this,"persistence");w(this,"exportImport");w(this,"config");w(this,"currentPosition",[0,0]);w(this,"subscriptions",new Map);w(this,"customFeatureFlags",V);w(this,"undoDepth",0);w(this,"redoDepth",0);w(this,"currentSelection");w(this,"loadedSelection");w(this,"autoSaveTimeout",null);w(this,"editMode",{isActive:!1,cell:null,content:"",originalContent:"",vimMode:"insert",cursorPosition:0,cursorLine:0,visualStartLine:null,visualEndLine:null});w(this,"vimClipboard","");this.config=new de,this.persistence=new ht(this.config.persistence),this.exportImport=new ut(this.config.persistence),this.gridState=new qe,this.gridVim=new st({maxCols:e.defaultColumns||this.config.defaultColumns||100,maxRows:e.defaultRows||this.config.defaultRows||200,initialPosition:[0,0]}),this.vimEdit=new Qe,this.undoRedo=new Me([],{maxHistorySize:e.maxUndoHistory}),this.eventService=new et,this.customFeatureFlags=e.featureFlags||V,e.defaultColumns!==void 0&&(this.config.defaultColumns=e.defaultColumns),e.defaultRows!==void 0&&(this.config.defaultRows=e.defaultRows),e.vimCursorCenter!==void 0&&(this.config.vimCursorCenter=e.vimCursorCenter),e.clipText!==void 0&&(this.config.clipText=e.clipText),this.loadFromLocalStorage()||this.initializeDefaultSheet(),this.config.persistence.autosave&&this.setupAutoSave()}initializeDefaultSheet(){this.gridState.createSheet("default","Sheet 1"),this.gridState.switchSheet("default"),this.saveToHistory()}getCell(e,n){return this.gridState.getCell(e,n)}updateCell(e,n,i){this.gridState.updateCell(e,n,i),this.publishCellChange(e,n),this.saveToHistory()}setCellText(e,n,i){this.gridState.setCellContent(e,n,i),this.publishCellChange(e,n),this.saveToHistory()}clearCell(e,n){this.gridState.clearCell(e,n),this.publishCellChange(e,n),this.saveToHistory()}deleteCell(e,n){this.gridState.deleteCell(e,n),this.publishCellChange(e,n),this.saveToHistory()}getContentMap(){return this.gridState.getContentMap()}getDimensions(){return this.gridState.getDimensions()}isCellEmpty(e,n){return this.gridState.isCellEmpty(e,n)}createSheet(e,n){const i=this.gridState.createSheet(e,n);return this.publishEvent(J.SHEET_CREATED,{sheetId:e,title:n}),i}switchSheet(e){const n=this.gridState.switchSheet(e);return n&&(this.publishEvent(J.SHEET_CHANGED,{sheetId:e}),this.saveToHistory()),n}getActiveSheet(){return this.gridState.getActiveSheet()}getSheet(e){return this.gridState.getSheet(e)}getAllSheets(){return this.gridState.getAllSheets()}deleteSheet(e){const n=this.gridState.deleteSheet(e);return n&&this.publishEvent(J.SHEET_DELETED,{sheetId:e}),n}applyMarkdownStyling(){const e=this.getActiveSheet();if(!e)return null;const n=Ze(e,nt);return this.publishEvent(J.MARKDOWN_APPLIED,{sheetId:e.id}),n}navigateVim(e,n,i){const s=n||this.currentPosition,r=this.getDimensions();this.gridVim.updateDimensions(r.cols,r.rows),this.gridVim.setGridPosition(s);const a=this.gridVim.executeVimCommand(e);return a.success&&(this.currentPosition=a.position,this.publishEvent(J.CURSOR_MOVED,{from:s,to:a.position,command:e}),a.selectionRange&&this.publishEvent("SELECTION_CHANGED",{range:a.selectionRange,mode:a.mode})),{col:a.position[0],row:a.position[1],success:a.success}}enterVisualMode(){this.gridVim.setGridPosition(this.currentPosition);const e=this.getDimensions();this.gridVim.updateDimensions(e.cols,e.rows),this.gridVim.enterVisualMode(!0),this.publishEvent("VIM_MODE_CHANGED",{mode:"visual"})}exitVisualMode(){this.gridVim.exitVisualMode(!0),this.publishEvent("VIM_MODE_CHANGED",{mode:"normal"})}getCurrentVimMode(){return this.gridVim.getCurrentMode()==="VISUAL"?"visual":"normal"}setSelectionFacadeForVim(e){this.gridVim.setSelectionFacade(e)}executeVimEdit(e,n,i){const s=n||this.currentPosition,r=this.getContentMap(),a=this.vimEdit.executeEdit(e,s,r,i);return a.success&&a.contentMap&&(this.gridState.setContentMap(a.contentMap),this.publishEvent("VIM_EDIT",{position:s,command:e,result:a}),this.saveToHistory()),a}getCurrentPosition(){return this.currentPosition}setCurrentPosition(e){const n=this.currentPosition;this.currentPosition=e,this.publishEvent("CURSOR_MOVED",{from:n,to:e})}undo(){if(!this.canUndo())return null;const e=this.undoRedo.undo();return e&&(this.gridState.setContentMap(e),this.undoDepth--,this.redoDepth++,this.publishEvent("UNDO",{depth:this.undoDepth})),e}redo(){if(!this.canRedo())return null;const e=this.undoRedo.redo();return e&&(this.gridState.setContentMap(e),this.undoDepth++,this.redoDepth--,this.publishEvent("REDO",{depth:this.redoDepth})),e}canUndo(){return this.undoRedo.canUndo()}canRedo(){return this.undoRedo.canRedo()}getUndoDepth(){return this.undoDepth}getRedoDepth(){return this.redoDepth}clearHistory(){var n;const e=(n=this.undoRedo.config)==null?void 0:n.maxHistorySize;this.undoRedo=new Me(this.getContentMap(),{maxHistorySize:e}),this.undoDepth=0,this.redoDepth=0,this.publishEvent("HISTORY_CLEARED",{})}saveToHistory(){const e=this.getContentMap();this.undoRedo.addToHistory(e),this.undoDepth++,this.redoDepth=0}updateHistoryDepth(){const e=this.undoRedo.getHistoryDepth();this.undoDepth=e.undo,this.redoDepth=e.redo}exportToCSV(){return this.getContentMap().map(i=>i?i.map(s=>{const r=(s==null?void 0:s.text)||"";return r.includes(",")||r.includes('"')?`"${r.replace(/"/g,'""')}"`:r}).join(","):"").join(`
`)}importFromCSV(e){try{const n=e.split(`
`);return this.gridState.clearAll(),n.forEach((i,s)=>{this.parseCSVRow(i).forEach((a,u)=>{a&&this.gridState.setCellContent(u,s,a)})}),this.publishEvent("DATA_IMPORTED",{format:"csv",rows:n.length}),this.saveToHistory(),!0}catch(n){return console.error("Failed to import CSV:",n),!1}}parseCSVRow(e){const n=[];let i="",s=!1;for(let r=0;r<e.length;r++){const a=e[r],u=e[r+1];a==='"'?s&&u==='"'?(i+='"',r++):s=!s:a===","&&!s?(n.push(i.trim()),i=""):i+=a}return n.push(i.trim()),n}subscribe(e,n){const i=this.eventService.subscribe(e,n),s=`${e}_${Date.now()}_${Math.random()}`;return this.subscriptions.set(s,i),()=>{i(),this.subscriptions.delete(s)}}publishEvent(e,n){this.eventService.publish(e,n)}publishCellChange(e,n){const i=this.getCell(e,n);this.eventService.publish(J.CELL_CHANGE,{col:e,row:n,cell:i})}getConfig(){return this.config}updateConfig(e){Object.assign(this.config,e),this.publishEvent("CONFIG_UPDATED",e)}getFeatureFlags(){return V}isFeatureEnabled(e){return this.customFeatureFlags[e]??!1}getFF(){return Ne}updateSelection(e){this.currentSelection=e,this.config.persistence.persistState&&this.config.persistence.autosave&&this.triggerAutoSave()}getLoadedSelection(){return this.loadedSelection}saveToLocalStorage(e){console.log("[Persistence] saveToLocalStorage called");const n=e??this.currentSelection,i=this.buildGlobalState(n);ae.clientLogsApiClient.sendLogs("grid_save_attempt",{v:10,param_selectedCells:e,stored_currentSelection:this.currentSelection,resolved_selection:n,hasSheets:i.data.sheets.length,activeSheetId:i.data.activeSheetId,state_uiState_selectedCells:i.uiState.selectedCells},"grid-persistence-client.log");const s=this.persistence.saveStateToLocalStorage(i);return console.log("[Persistence] Save result:",s),ae.clientLogsApiClient.sendLogs("grid_save_result",{v:10,success:s,selectedCells_in_saved_state:i.uiState.selectedCells},"grid-persistence-client.log"),s}loadFromLocalStorage(){const e=this.buildInitialGlobalState(),n=this.persistence.rehydrateState(e);return n===e?(console.log("[Persistence] No persisted data found - using initial state"),!1):(console.log("[Persistence] Loaded persisted data from localStorage"),this.applyLoadedState(n),this.publishEvent(J.STATE_REHYDRATED,{state:n}),!0)}clearLocalStorage(){this.persistence.clearLocalStorage()}getStorageSize(){return this.persistence.getStorageSize()}getPersistedState(){return this.persistence.loadStateFromLocalStorage()}setupAutoSave(){[J.CELL_CHANGE,J.SHEET_SWITCHED,J.SHEET_CREATED,J.SHEET_DELETED,J.SHEET_CHANGED].forEach(n=>{const i=this.subscribe(n,()=>{this.triggerAutoSave()});this.subscriptions.set(`autosave-${n}`,i)})}triggerAutoSave(){console.log("[Persistence] triggerAutoSave called - debouncing for",this.config.persistence.autosaveDebounceMs,"ms"),ae.clientLogsApiClient.sendLogs("grid_auto_save_triggered",{v:10,debounceMs:this.config.persistence.autosaveDebounceMs,hasStoredSelection:this.currentSelection!==void 0,storedSelection:this.currentSelection},"grid-persistence-client.log"),this.autoSaveTimeout&&clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(()=>{console.log("[Persistence] Auto-save debounce timeout fired - saving now"),ae.clientLogsApiClient.sendLogs("grid_auto_save_executing",{v:10,hasStoredSelection:this.currentSelection!==void 0,storedSelection:this.currentSelection},"grid-persistence-client.log"),this.saveToLocalStorage()},this.config.persistence.autosaveDebounceMs)}buildGlobalState(e){var n;return{version:"1.0.0",dataVersion:this.config.persistence.dataVersion,data:{sheets:this.gridState.getAllSheets(),activeSheetId:((n=this.gridState.getActiveSheet())==null?void 0:n.id)||"default",undoStack:this.undoRedo.getUndoStack(),redoStack:this.undoRedo.getRedoStack(),featureFlags:this.customFeatureFlags,lastModified:Date.now(),createdAt:Date.now()},uiState:{theme:"default",zoom:1,showGridLines:!0,showHeaders:!0,vimModeEnabled:!0,selectedCells:e},preferences:{defaultColumnWidth:this.config.cellWidth,defaultRowHeight:this.config.cellHeight,autoExpandGrid:this.config.autoExpandGrid,enterCellInInsertMode:this.config.vimEnterCellInInsertMode,showFormulaBar:!0,recentFiles:[]}}}buildInitialGlobalState(){return{version:"1.0.0",dataVersion:this.config.persistence.dataVersion,data:lt,uiState:at,preferences:ct}}exportToJSON(e=!1){const n=this.buildGlobalState();return this.exportImport.exportToJSON(n,e)}exportToFile(e){const n=this.buildGlobalState();this.exportImport.exportToFile(n,e)}importFromJSON(e,n){const i=this.buildGlobalState(),s=this.exportImport.importFromJSON(e,i,n);return s.sheetsImported>0&&s.errors.length===0&&this.applyImportedData(e,n),s}async importFromFile(e,n){const i=this.buildGlobalState(),s=await this.exportImport.importFromFile(e,i,n);if(s.sheetsImported>0&&s.errors.length===0){const r=new FileReader,a=await new Promise((u,c)=>{r.onload=b=>{var v;return u((v=b.target)==null?void 0:v.result)},r.onerror=()=>c(new Error("Failed to read file")),r.readAsText(e)});this.applyImportedData(a,n)}return s}applyImportedData(e,n){const i=JSON.parse(e);((n==null?void 0:n.mode)||"replace")==="replace"&&(this.gridState.clearAll(),this.clearHistory()),Array.isArray(i.sheets)&&(i.sheets.forEach((r,a)=>{this.gridState.createSheet(r.id,r.title),this.gridState.switchSheet(r.id),this.gridState.setContentMap(r.content)}),i.activeSheetId?this.gridState.switchSheet(i.activeSheetId):i.sheets.length>0&&this.gridState.switchSheet(i.sheets[0].id)),n!=null&&n.includeHistory&&(Array.isArray(i.undoStack)&&this.undoRedo.setUndoStack(i.undoStack),Array.isArray(i.redoStack)&&this.undoRedo.setRedoStack(i.redoStack),this.updateHistoryDepth()),i.preferences&&(i.preferences.defaultColumnWidth&&(this.config.cellWidth=i.preferences.defaultColumnWidth),i.preferences.defaultRowHeight&&(this.config.cellHeight=i.preferences.defaultRowHeight)),this.publishEvent("DATA_IMPORTED",{result:"success"})}applyLoadedState(e){this.gridState.clearAll(),e.data.sheets.forEach(n=>{const i=this.gridState.createSheet(n.id,n.title);i.content=n.content}),e.data.activeSheetId&&this.gridState.switchSheet(e.data.activeSheetId),this.undoRedo.setUndoStack(e.data.undoStack),this.undoRedo.setRedoStack(e.data.redoStack),this.updateHistoryDepth(),this.customFeatureFlags=e.data.featureFlags,e.preferences.defaultColumnWidth&&(this.config.cellWidth=e.preferences.defaultColumnWidth),e.preferences.defaultRowHeight&&(this.config.cellHeight=e.preferences.defaultRowHeight),e.preferences.autoExpandGrid!==void 0&&(this.config.autoExpandGrid=e.preferences.autoExpandGrid),e.preferences.enterCellInInsertMode!==void 0&&(this.config.vimEnterCellInInsertMode=e.preferences.enterCellInInsertMode),e.uiState.selectedCells&&(this.loadedSelection=e.uiState.selectedCells,ae.clientLogsApiClient.sendLogs("grid_loaded_state_has_selection",{v:10,selectedCells:e.uiState.selectedCells,note:"Selection stored in loadedSelection for React layer to retrieve"},"grid-persistence-client.log"))}enterEditMode(e,n){const i=this.getCell(e,n),s=(i==null?void 0:i.text)||"";this.editMode={isActive:!0,cell:[e,n],content:s,originalContent:s,vimMode:"insert",cursorPosition:s.length,cursorLine:0,visualStartLine:null,visualEndLine:null},this.publishEvent("CELL_EDIT_MODE_ENTERED",{col:e,row:n,content:s})}exitEditMode(e=!0){if(!this.editMode.isActive||!this.editMode.cell)return;const[n,i]=this.editMode.cell;e&&this.setCellText(n,i,this.editMode.content),this.publishEvent("CELL_EDIT_MODE_EXITED",{col:n,row:i,saved:e,content:e?this.editMode.content:this.editMode.originalContent}),this.editMode={isActive:!1,cell:null,content:"",originalContent:"",vimMode:"insert",cursorPosition:0,cursorLine:0,visualStartLine:null,visualEndLine:null}}isInEditMode(){return this.editMode.isActive}getEditingCell(){return this.editMode.cell}getEditingContent(){return this.editMode.content}typeInEditMode(e){if(!this.editMode.isActive)throw new Error("Cannot type: not in edit mode");const n=this.editMode.cursorPosition,i=this.editMode.content.substring(0,n),s=this.editMode.content.substring(n);this.editMode.content=i+e+s,this.editMode.cursorPosition=n+e.length,this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content,cell:this.editMode.cell})}appendInEditMode(e){if(!this.editMode.isActive)throw new Error("Cannot append: not in edit mode");this.editMode.content+=e,this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content,cell:this.editMode.cell})}clearEditModeContent(){if(!this.editMode.isActive)throw new Error("Cannot clear: not in edit mode");this.editMode.content="",this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:"",cell:this.editMode.cell})}pressEnterInEditMode(){if(!(!this.editMode.isActive||!this.editMode.cell))if(this.editMode.vimMode==="insert")this.insertNewlineInEditMode();else{const[e,n]=this.editMode.cell;this.exitEditMode(!0),this.setCurrentPosition([e,n+1])}}pressEscapeInEditMode(){this.exitEditMode(!1)}setVimMode(e){this.editMode.isActive&&(this.editMode.vimMode=e,this.publishEvent("VIM_MODE_CHANGED",{mode:e}))}getVimMode(){return this.editMode.isActive?this.editMode.vimMode:null}isInInsertMode(){return this.editMode.isActive&&this.editMode.vimMode==="insert"}isInNormalMode(){return this.editMode.isActive&&this.editMode.vimMode==="normal"}isInVisualMode(){return this.editMode.isActive&&this.editMode.vimMode==="visual"}insertNewlineInEditMode(){if(!this.editMode.isActive)throw new Error("Cannot insert newline: not in edit mode");const e=this.editMode.cursorPosition,n=this.editMode.content.substring(0,e),i=this.editMode.content.substring(e);this.editMode.content=n+`
`+i,this.editMode.cursorPosition=e+1,this.editMode.cursorLine++,this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content,cursorPosition:this.editMode.cursorPosition,cursorLine:this.editMode.cursorLine})}pressCtrlEnterInEditMode(){if(!this.editMode.isActive)throw new Error("Cannot press Ctrl+Enter: not in edit mode");this.exitEditMode(!0);const[e,n]=this.currentPosition;this.setCurrentPosition([e,n+1])}getCursorLine(){return this.editMode.isActive?this.editMode.cursorLine:0}getCursorPosition(){return this.editMode.isActive?this.editMode.cursorPosition:0}setCursorPosition(e){if(!this.editMode.isActive)throw new Error("Cannot set cursor position: not in edit mode");this.editMode.cursorPosition=Math.max(0,Math.min(e,this.editMode.content.length));const n=this.editMode.content.substring(0,this.editMode.cursorPosition);this.editMode.cursorLine=n.split(`
`).length-1,this.publishEvent("CURSOR_MOVED",{cursorPosition:this.editMode.cursorPosition,cursorLine:this.editMode.cursorLine})}setCursorLine(e){if(!this.editMode.isActive)throw new Error("Cannot set cursor line: not in edit mode");const n=this.editMode.content.split(`
`),i=n.length-1;this.editMode.cursorLine=Math.max(0,Math.min(e,i));let s=0;for(let r=0;r<this.editMode.cursorLine;r++)s+=n[r].length+1;this.editMode.cursorPosition=s,this.publishEvent("CURSOR_LINE_CHANGED",{cursorLine:this.editMode.cursorLine,cursorPosition:this.editMode.cursorPosition})}moveCursorDown(){if(!this.editMode.isActive)return;const e=this.editMode.content.split(`
`);this.editMode.cursorLine<e.length-1&&this.setCursorLine(this.editMode.cursorLine+1)}moveCursorUp(){this.editMode.isActive&&this.editMode.cursorLine>0&&this.setCursorLine(this.editMode.cursorLine-1)}getLineCount(){return this.editMode.isActive?this.editMode.content.split(`
`).length:0}getLineContent(e){return this.editMode.isActive&&this.editMode.content.split(`
`)[e]||""}setLineContent(e,n){if(!this.editMode.isActive)throw new Error("Cannot set line content: not in edit mode");const i=this.editMode.content.split(`
`);e>=0&&e<i.length&&(i[e]=n,this.editMode.content=i.join(`
`),this.publishEvent("CELL_CONTENT_CHANGED",{content:this.editMode.content,line:e}))}deleteCurrentLine(){if(!this.editMode.isActive)return;const e=this.editMode.content.split(`
`);e.length<=1?(this.editMode.content="",this.editMode.cursorLine=0,this.editMode.cursorPosition=0):(e.splice(this.editMode.cursorLine,1),this.editMode.content=e.join(`
`),this.editMode.cursorLine>=e.length&&(this.editMode.cursorLine=e.length-1),this.setCursorLine(this.editMode.cursorLine)),this.publishEvent("LINE_DELETED",{line:this.editMode.cursorLine,content:this.editMode.content})}yankCurrentLine(){if(!this.editMode.isActive)return"";const e=this.getLineContent(this.editMode.cursorLine);return this.vimClipboard=e,e}getVimClipboard(){return this.vimClipboard}setVimClipboard(e){this.vimClipboard=e}enterVisualLineMode(){this.editMode.isActive&&(this.editMode.vimMode="visual",this.editMode.visualStartLine=this.editMode.cursorLine,this.editMode.visualEndLine=this.editMode.cursorLine,this.publishEvent("VIM_MODE_CHANGED",{mode:"visual"}))}exitVisualLineMode(){this.editMode.isActive&&(this.editMode.vimMode="normal",this.editMode.visualStartLine=null,this.editMode.visualEndLine=null,this.publishEvent("VIM_MODE_CHANGED",{mode:"normal"}))}setVisualLineSelection(e,n){this.editMode.isActive&&(this.editMode.vimMode="visual",this.editMode.visualStartLine=e,this.editMode.visualEndLine=n,this.publishEvent("VISUAL_SELECTION_CHANGED",{startLine:e,endLine:n}))}getVisualLineSelection(){return this.editMode.visualStartLine===null||this.editMode.visualEndLine===null?null:{startLine:this.editMode.visualStartLine,endLine:this.editMode.visualEndLine}}deleteVisualSelection(){if(!this.editMode.isActive||this.editMode.vimMode!=="visual"||this.editMode.visualStartLine===null||this.editMode.visualEndLine===null)return;const e=this.editMode.content.split(`
`),n=Math.min(this.editMode.visualStartLine,this.editMode.visualEndLine),i=Math.max(this.editMode.visualStartLine,this.editMode.visualEndLine);e.splice(n,i-n+1),e.length===0?(this.editMode.content="",this.editMode.cursorLine=0):(this.editMode.content=e.join(`
`),this.editMode.cursorLine=Math.min(n,e.length-1)),this.exitVisualLineMode(),this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content})}yankVisualSelection(){if(!this.editMode.isActive||this.editMode.vimMode!=="visual"||this.editMode.visualStartLine===null||this.editMode.visualEndLine===null)return;const e=this.editMode.content.split(`
`),n=Math.min(this.editMode.visualStartLine,this.editMode.visualEndLine),i=Math.max(this.editMode.visualStartLine,this.editMode.visualEndLine),s=e.slice(n,i+1);this.vimClipboard=s.join(`
`),this.exitVisualLineMode()}openLineBelow(){if(!this.editMode.isActive)return;const e=this.editMode.content.split(`
`),n=this.editMode.cursorLine;e.splice(n+1,0,""),this.editMode.content=e.join(`
`),this.editMode.cursorLine=n+1,this.editMode.cursorPosition=this.editMode.content.split(`
`).slice(0,n+1).join(`
`).length+(n+1),this.editMode.vimMode="insert",this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content,cursorLine:this.editMode.cursorLine})}openLineAbove(){if(!this.editMode.isActive)return;const e=this.editMode.content.split(`
`),n=this.editMode.cursorLine;e.splice(n,0,""),this.editMode.content=e.join(`
`),this.editMode.cursorPosition=this.editMode.content.split(`
`).slice(0,n).join(`
`).length+n,this.editMode.vimMode="insert",this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content,cursorLine:this.editMode.cursorLine})}pasteAfterCursor(e){if(!this.editMode.isActive)return;const n=this.editMode.cursorPosition,i=this.editMode.content.substring(0,n),s=this.editMode.content.substring(n);this.editMode.content=i+e+s,this.editMode.cursorPosition=n+e.length,this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content})}pasteBeforeCursor(e){if(!this.editMode.isActive)return;const n=this.editMode.cursorPosition,i=this.editMode.content.substring(0,n),s=this.editMode.content.substring(n);this.editMode.content=i+e+s,this.editMode.cursorPosition=n,this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content})}deleteLine(e){if(!this.editMode.isActive)return;const n=this.editMode.content.split(`
`);e<0||e>=n.length||(n.length<=1?(this.editMode.content="",this.editMode.cursorLine=0,this.editMode.cursorPosition=0):(n.splice(e,1),this.editMode.content=n.join(`
`),this.editMode.cursorLine>=n.length&&(this.editMode.cursorLine=n.length-1)),this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content}))}deleteMultipleLines(e){if(!this.editMode.isActive)return;const n=this.editMode.content.split(`
`),i=this.editMode.cursorLine;n.length<=e?(this.editMode.content="",this.editMode.cursorLine=0,this.editMode.cursorPosition=0):(n.splice(i,e),this.editMode.content=n.join(`
`),this.editMode.cursorLine>=n.length&&(this.editMode.cursorLine=n.length-1)),this.publishEvent("CELL_EDIT_CONTENT_CHANGED",{content:this.editMode.content})}moveToLine(e){if(!this.editMode.isActive)return;const n=this.editMode.content.split(`
`);if(e<0||e>=n.length)return;this.editMode.cursorLine=e;const i=n.slice(0,e);this.editMode.cursorPosition=i.join(`
`).length+(e>0?e:0),this.publishEvent("CURSOR_MOVED",{cursorLine:this.editMode.cursorLine,cursorPosition:this.editMode.cursorPosition})}setColumnWidth(e,n){const i=this.gridState.getActiveSheet();if(!i)return;i.colHeaderMap||(i.colHeaderMap={});const a=Math.max(30,Math.min(500,n));i.colHeaderMap[e.toString()]={colWidth:a},this.publishEvent("COLUMN_WIDTH_CHANGED",{col:e,width:a})}getColumnWidth(e){const n=this.gridState.getActiveSheet();if(!n||!n.colHeaderMap)return this.getDefaultColumnWidth();const i=n.colHeaderMap[e.toString()];return(i==null?void 0:i.colWidth)||this.getDefaultColumnWidth()}resizeColumn(e,n){const i=this.getColumnWidth(e);this.setColumnWidth(e,i+n)}autoFitColumn(e){const n=this.calculateColumnWidth(e);this.setColumnWidth(e,n)}calculateColumnWidth(e){const n=this.gridState.getActiveSheet();if(!n)return this.getDefaultColumnWidth();let i=this.getMinColumnWidth();const s=8;for(let r=0;r<n.content.length;r++){const a=this.getCell(e,r);if(a&&a.text){const u=a.text.length*8+s*2;i=Math.max(i,u)}}return Math.min(i,this.getMaxColumnWidth())}getDefaultColumnWidth(){return 100}getMinColumnWidth(){return 30}getMaxColumnWidth(){return 500}getCellOverflowInfo(e,n){const i=this.getCell(e,n);if(!i||!i.text)return{overflows:!1,colsToNextText:0,overflowWidth:0};const s=this.calculateColsToNextText(e,n),r=this.getColumnWidth(e),a=i.text.length*8,u=a>r,c=Math.max(0,a-r);return{overflows:u,colsToNextText:s,overflowWidth:c}}calculateColsToNextText(e,n){if(!this.gridState.getActiveSheet())return 0;const s=this.getDimensions();for(let r=e+1;r<s.cols;r++){const a=this.getCell(r,n);if(a&&a.text)return r-e}return 0}doesCellOverflow(e,n){return this.getCellOverflowInfo(e,n).overflows}updateCellOverflowMetadata(e,n){if(!this.getCell(e,n))return;const s=this.calculateColsToNextText(e,n);this.updateCell(e,n,{colsToNextText:s})}recalculateRowOverflow(e){const n=this.getDimensions();for(let i=0;i<n.cols;i++)this.updateCellOverflowMetadata(i,e)}destroy(){this.subscriptions.forEach(e=>e()),this.subscriptions.clear(),this.clearHistory(),this.publishEvent("FACADE_DESTROYED",{})}reset(){this.gridState.clearAll(),this.clearHistory(),this.initializeDefaultSheet(),this.currentPosition=[0,0],this.publishEvent("FACADE_RESET",{})}}class gt{constructor(e){w(this,"config");w(this,"columnWidths",new Map);w(this,"rowHeights",new Map);this.config=e}updateConfig(e){this.config={...this.config,...e}}setColumnWidth(e,n){this.columnWidths.set(e,n)}setRowHeight(e,n){this.rowHeights.set(e,n)}getColumnWidth(e){return this.columnWidths.get(e)??this.config.defaultCellWidth}getRowHeight(e){return this.rowHeights.get(e)??this.config.defaultCellHeight}calculateVisibleRange(e,n){const{scrollTop:i,scrollLeft:s,containerWidth:r,containerHeight:a,headerHeight:u,rowHeaderWidth:c}=this.config;let b=0,v=0;for(;v<s&&b<e;)v+=this.getColumnWidth(b),b++;let p=b;for(v=0;v<r-c&&p<e;)v+=this.getColumnWidth(p),p++;p=Math.min(p+1,e);let S=0,C=0;for(;C<i&&S<n;)C+=this.getRowHeight(S),S++;let L=S;for(C=0;C<a-u&&L<n;)C+=this.getRowHeight(L),L++;return L=Math.min(L+1,n),{startCol:b,endCol:p,startRow:S,endRow:L}}calculateCellPosition(e,n){let i=this.config.rowHeaderWidth;for(let r=0;r<e;r++)i+=this.getColumnWidth(r);let s=this.config.headerHeight;for(let r=0;r<n;r++)s+=this.getRowHeight(r);return{col:e,row:n,x:i-this.config.scrollLeft,y:s-this.config.scrollTop,width:this.getColumnWidth(e),height:this.getRowHeight(n)}}calculateTotalDimensions(e,n){let i=this.config.rowHeaderWidth;for(let r=0;r<e;r++)i+=this.getColumnWidth(r);let s=this.config.headerHeight;for(let r=0;r<n;r++)s+=this.getRowHeight(r);return{width:i,height:s}}getViewportState(e,n){const i=this.calculateVisibleRange(e,n),s=[];for(let u=i.startRow;u<i.endRow;u++)for(let c=i.startCol;c<i.endCol;c++)s.push(this.calculateCellPosition(c,u));const{width:r,height:a}=this.calculateTotalDimensions(e,n);return{visibleRange:i,visibleCells:s,totalWidth:r,totalHeight:a,scrollTop:this.config.scrollTop,scrollLeft:this.config.scrollLeft}}getCellAtPosition(e,n){const{headerHeight:i,rowHeaderWidth:s,scrollTop:r,scrollLeft:a}=this.config,u=e+a-s,c=n+r-i;if(u<0||c<0)return null;let b=0,v=0;for(;v<u;)v+=this.getColumnWidth(b),b++;b=Math.max(0,b-1);let p=0,S=0;for(;S<c;)S+=this.getRowHeight(p),p++;return p=Math.max(0,p-1),[b,p]}autoFitColumn(e,n=400,i=60){const s=this.getColumnWidth(e),r=Math.max(i,Math.min(n,s));this.setColumnWidth(e,r)}}class pt{constructor(e=[0,0]){w(this,"state");w(this,"listeners",new Map);this.state={activeCell:e,range:null,isSelecting:!1}}getState(){return{...this.state}}setActiveCell(e){this.state={activeCell:e,range:null,isSelecting:!1},this.notifyListeners()}startSelection(e){this.state={activeCell:e,range:{start:e,end:e},isSelecting:!0},this.notifyListeners()}updateSelection(e){this.state.range&&(this.state={...this.state,range:{start:this.state.range.start,end:e}},this.notifyListeners())}endSelection(){this.state={...this.state,isSelecting:!1},this.notifyListeners()}setRange(e,n){this.state={activeCell:e,range:{start:e,end:n},isSelecting:!1},this.notifyListeners()}clearRange(){this.state={...this.state,range:null,isSelecting:!1},this.notifyListeners()}getSelectionRect(){if(!this.state.range)return null;const{start:e,end:n}=this.state.range,i=Math.min(e[0],n[0]),s=Math.max(e[0],n[0]),r=Math.min(e[1],n[1]),a=Math.max(e[1],n[1]);return{startCol:i,endCol:s,startRow:r,endRow:a,width:s-i+1,height:a-r+1}}isCellSelected(e){const n=this.getSelectionRect();return n?e[0]>=n.startCol&&e[0]<=n.endCol&&e[1]>=n.startRow&&e[1]<=n.endRow:e[0]===this.state.activeCell[0]&&e[1]===this.state.activeCell[1]}isActiveCell(e){return e[0]===this.state.activeCell[0]&&e[1]===this.state.activeCell[1]}extendSelection(e){this.state.range||(this.state.range={start:this.state.activeCell,end:this.state.activeCell});const[n,i]=this.state.range.end;let s;switch(e){case"left":s=[Math.max(0,n-1),i];break;case"right":s=[n+1,i];break;case"up":s=[n,Math.max(0,i-1)];break;case"down":s=[n,i+1];break}this.state.range.end=s,this.notifyListeners()}selectRow(e,n){this.state={activeCell:[0,e],range:{start:[0,e],end:[n-1,e]},isSelecting:!1},this.notifyListeners()}selectColumn(e,n){this.state={activeCell:[e,0],range:{start:[e,0],end:[e,n-1]},isSelecting:!1},this.notifyListeners()}subscribe(e,n){return this.listeners.set(e,n),()=>this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.state)}catch(n){console.error("Selection listener error:",n)}})}getSelectedCells(){const e=this.getSelectionRect();if(!e)return[this.state.activeCell];const n=[];for(let i=e.startRow;i<=e.endRow;i++)for(let s=e.startCol;s<=e.endCol;s++)n.push([s,i]);return n}}class ft{constructor(e){w(this,"state");w(this,"actions");w(this,"listeners",new Map);this.state={canUndo:!1,canRedo:!1,undoDepth:0,redoDepth:0,isDirty:!1,isSaving:!1},this.actions=e}getState(){return{...this.state}}updateState(e){this.state={...this.state,...e},this.notifyListeners()}undo(){this.state.canUndo&&this.actions.onUndo()}redo(){this.state.canRedo&&this.actions.onRedo()}async save(){if(!this.state.isSaving){this.updateState({isSaving:!0});try{await this.actions.onSave(),this.updateState({isDirty:!1,isSaving:!1})}catch(e){throw this.updateState({isSaving:!1}),e}}}export(e){this.actions.onExport(e)}import(e,n){this.actions.onImport(e,n),this.updateState({isDirty:!0})}markDirty(){this.updateState({isDirty:!0})}markClean(){this.updateState({isDirty:!1})}subscribe(e,n){return this.listeners.set(e,n),()=>this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.state)}catch(n){console.error("Toolbar listener error:",n)}})}getKeyboardShortcuts(){return{"Ctrl+Z":()=>this.undo(),"Cmd+Z":()=>this.undo(),"Ctrl+Y":()=>this.redo(),"Cmd+Shift+Z":()=>this.redo(),"Ctrl+S":()=>this.save(),"Cmd+S":()=>this.save()}}}class Ct{constructor(e,n,i){w(this,"state");w(this,"actions");w(this,"listeners",new Map);this.state={sheets:e,activeSheetId:n,isAddingSheet:!1,renamingSheetId:null},this.actions=i}getState(){return{...this.state}}updateState(e){this.state={...this.state,...e},this.notifyListeners()}switchSheet(e){this.state.activeSheetId!==e&&(this.actions.onSwitchSheet(e),this.updateState({activeSheetId:e}))}startAddSheet(){this.updateState({isAddingSheet:!0})}createSheet(e){this.actions.onCreateSheet(e),this.updateState({isAddingSheet:!1})}cancelAddSheet(){this.updateState({isAddingSheet:!1})}deleteSheet(e){if(this.state.sheets.length<=1)throw new Error("Cannot delete the last sheet");if(e===this.state.activeSheetId)throw new Error("Cannot delete the active sheet");this.actions.onDeleteSheet(e)}startRenameSheet(e){this.updateState({renamingSheetId:e})}renameSheet(e,n){if(!n.trim())throw new Error("Sheet name cannot be empty");this.actions.onRenameSheet(e,n),this.updateState({renamingSheetId:null})}cancelRenameSheet(){this.updateState({renamingSheetId:null})}getActiveSheet(){return this.state.sheets.find(e=>e.id===this.state.activeSheetId)??null}getSheet(e){return this.state.sheets.find(n=>n.id===e)??null}setSheets(e){this.updateState({sheets:e})}subscribe(e,n){return this.listeners.set(e,n),()=>this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.state)}catch(n){console.error("Sheet tabs listener error:",n)}})}getKeyboardShortcuts(){const e={},n=Math.min(this.state.sheets.length,9);for(let i=0;i<n;i++){const s=this.state.sheets[i];e[`Ctrl+${i+1}`]=()=>this.switchSheet(s.id),e[`Cmd+${i+1}`]=()=>this.switchSheet(s.id)}return e}}function wt(t={}){const{defaultColumns:e=10,defaultRows:n=20,maxUndoHistory:i=50,containerWidth:s=800,containerHeight:r=600,defaultCellWidth:a=100,defaultCellHeight:u=30}=t,c=x.useRef(null),b=x.useRef(null),v=x.useRef(null),p=x.useRef(null),S=x.useRef(null),C=x.useRef(null),L=x.useRef(!1);if(c.current||(c.current=new mt({defaultColumns:e,defaultRows:n,maxUndoHistory:i})),b.current||(b.current=new gt({containerWidth:s,containerHeight:r,scrollTop:0,scrollLeft:0,defaultCellWidth:a,defaultCellHeight:u,headerHeight:30,rowHeaderWidth:50})),!v.current){const I=c.current.getLoadedSelection(),D=I?I[0]:[0,0];v.current=new pt(D),c.current.setSelectionFacadeForVim(v.current)}if(p.current||(p.current=new ft({onUndo:()=>c.current.undo(),onRedo:()=>c.current.redo(),onSave:async()=>{console.log("Saving grid data...")},onExport:I=>{if(I==="json"){const D=c.current.exportToJSON();console.log("Exported JSON:",D)}else{const D=c.current.exportToCSV();console.log("Exported CSV:",D)}},onImport:(I,D)=>{I==="json"?c.current.importFromJSON(D):c.current.importFromCSV(D)}})),!S.current){const I=c.current.getAllSheets(),D=c.current.getActiveSheet();S.current=new Ct(I,(D==null?void 0:D.id)||"default",{onSwitchSheet:N=>c.current.switchSheet(N),onCreateSheet:N=>{const O=c.current.createSheet(`sheet-${Date.now()}`,N);c.current.switchSheet(O.id)},onDeleteSheet:N=>c.current.deleteSheet(N),onRenameSheet:(N,O)=>{console.log("Rename sheet:",N,O)}})}const[M,R]=x.useState(()=>{const I=c.current.getDimensions();return b.current.getViewportState(I.cols,I.rows)}),[T,W]=x.useState(()=>v.current.getState()),[A,P]=x.useState(()=>p.current.getState()),[B,G]=x.useState(()=>S.current.getState()),[U,_]=x.useState({mode:"normal",isEditMode:!1});x.useEffect(()=>{const I=v.current.subscribe("react-hook",W),D=p.current.subscribe("react-hook",P),N=S.current.subscribe("react-hook",G);return()=>{I(),D(),N()}},[]);const[q,X]=x.useState(0);x.useEffect(()=>{const I=c.current.subscribe("CELL_CHANGE",()=>{const F=c.current.getDimensions();R(b.current.getViewportState(F.cols,F.rows)),p.current.markDirty()}),D=c.current.subscribe("CELL_EDIT_CONTENT_CHANGED",()=>{X(F=>F+1)}),N=c.current.subscribe("UNDO",()=>{const F=c.current.getDimensions();R(b.current.getViewportState(F.cols,F.rows)),p.current.updateState({canUndo:c.current.canUndo(),canRedo:c.current.canRedo(),undoDepth:c.current.getUndoDepth(),redoDepth:c.current.getRedoDepth()})}),O=c.current.subscribe("REDO",()=>{const F=c.current.getDimensions();R(b.current.getViewportState(F.cols,F.rows)),p.current.updateState({canUndo:c.current.canUndo(),canRedo:c.current.canRedo(),undoDepth:c.current.getUndoDepth(),redoDepth:c.current.getRedoDepth()})}),Q=c.current.subscribe("VIM_MODE_CHANGED",F=>{_(oe=>({...oe,mode:F.mode}))}),me=c.current.subscribe("CELL_EDIT_MODE_ENTERED",()=>{_(F=>({...F,isEditMode:!0,mode:"insert"}))}),ge=c.current.subscribe("CELL_EDIT_MODE_EXITED",()=>{_({mode:"normal",isEditMode:!1})});return()=>{I(),D(),N(),O(),Q(),me(),ge()}},[]),x.useEffect(()=>{p.current.updateState({canUndo:c.current.canUndo(),canRedo:c.current.canRedo(),undoDepth:c.current.getUndoDepth(),redoDepth:c.current.getRedoDepth()})},[]),x.useEffect(()=>{if(L.current)return;let I;try{const D=window.__vimContainer;if(D){I=D;try{I.get(Le)}catch{ye.register(I)}}else I=ze.createContainer(),Be.register(I),He.register(I),_e.register(I),ye.register(I),Ge.register(I),Oe.register(I),window.__vimContainer=I;if(C.current=I.get(Ue),!C.current)throw new Error("VimInputHandlerV2 instance is null");C.current.registerAndInit({vimId:ce.gridNavigation,container:void 0,vimState:{id:ce.gridNavigation,mode:K.NORMAL,cursor:{line:0,col:0},lines:[]},hooks:{modeChanged:(Q,me,ge)=>{var be;const F=(be=Q==null?void 0:Q.vimState)==null?void 0:be.mode;F===K.VISUAL?c.current.gridVim.enterVisualMode():F===K.NORMAL&&c.current.gridVim.getVisualRange()&&c.current.gridVim.exitVisualMode();let oe="normal";F===K.VISUAL?oe="visual":F===K.INSERT?oe="insert":F===K.NORMAL&&(oe="normal"),_(Ae=>({...Ae,mode:oe}))},commandListener:Q=>{},onInsertInput:(Q,me,ge)=>!1}});const N=I.get(Le),O=c.current.gridVim.getCommandMappings();N.registerCommands(ce.gridNavigation,O),C.current.setActiveId(ce.gridNavigation),L.current=!0}catch(D){console.error("Failed to initialize VimInputHandlerV2 for grid:",D)}return()=>{C.current&&C.current.popIdIf(ce.gridNavigation)}},[]);const k=x.useCallback(()=>{const I=c.current.getDimensions();R(b.current.getViewportState(I.cols,I.rows))},[]),j=x.useCallback((I,D)=>{b.current.updateConfig({scrollTop:I,scrollLeft:D});const N=c.current.getDimensions();R(b.current.getViewportState(N.cols,N.rows))},[]),E=x.useCallback((I,D,N)=>{const O=[I,D];N?v.current.setRange(T.activeCell,O):v.current.setActiveCell(O),c.current.setCurrentPosition(O),c.current.gridVim.setGridPosition(O)},[T.activeCell]),y=x.useCallback((I,D)=>{const N=[I,D];v.current.startSelection(N),c.current.setCurrentPosition(N)},[]),$=x.useCallback((I,D)=>{if(T.isSelecting){const N=[I,D];v.current.updateSelection(N)}},[T.isSelecting]),Y=x.useCallback(()=>{T.isSelecting&&v.current.endSelection()},[T.isSelecting]),Z=x.useCallback((I,D)=>{b.current.setColumnWidth(I,D),k()},[k]),ve=x.useCallback(I=>{C.current&&C.current.executeCommand(I,"")},[]);return{gridFacade:c.current,viewportFacade:b.current,selectionFacade:v.current,toolbarFacade:p.current,sheetTabsFacade:S.current,viewportState:M,selectionState:T,toolbarState:A,sheetTabsState:B,vimModeState:U,refresh:k,handleScroll:j,handleCellClick:E,handleCellMouseDown:y,handleCellMouseEnter:$,handleCellMouseUp:Y,handleColumnResize:Z,handleVimNavigate:ve}}const vt=5,bt=({col:t,row:e,position:n,text:i,isActive:s,isSelected:r,colsToNextText:a=0,onClick:u,onMouseDown:c,onMouseEnter:b,onTextChange:v})=>{const[p,S]=x.useState(!1),[C,L]=x.useState(i),M=x.useRef(null);x.useEffect(()=>{p||L(i)},[i,p]),x.useEffect(()=>{p&&M.current&&(M.current.focus(),M.current.select())},[p]);const R=k=>{u(k.shiftKey)},T=()=>{S(!0),L(i)},W=k=>{k.preventDefault(),c==null||c()},A=()=>{p&&(v(C),S(!1))},P=k=>{k.key==="Enter"&&!k.shiftKey?(k.preventDefault(),v(C),S(!1)):k.key==="Escape"&&(k.preventDefault(),L(i),S(!1))},B=a!==1&&i&&!p,G=i?ue(i,"14px sans-serif"):0,U=8;let _;if(!B)_=n.width;else if(a===0)_=Math.max(n.width,G+U);else{const k=n.width*a;_=Math.min(k,G+U)}const q=p?Math.max(ue(C||"","14px sans-serif")+U+vt,n.width):n.width,X=["grid-cell absolute border-r border-b border-border select-none",p?"overflow-visible cursor-text":B?"overflow-visible cursor-cell":"overflow-hidden cursor-cell",s&&"ring-2 ring-blue-500 dark:ring-blue-400 z-20",r&&!s&&"bg-blue-50 dark:bg-blue-950/30",!s&&!r&&"hover:bg-muted"].filter(Boolean).join(" ");return l.jsx("div",{className:X,style:{left:n.x,top:n.y,width:p?q:n.width,height:n.height},onClick:R,onDoubleClick:T,onMouseDown:W,onMouseEnter:b,"data-test":"grid-cell",children:p?l.jsx("textarea",{ref:M,className:"h-full p-1 text-sm resize-none outline-none bg-background text-foreground",style:{width:q},rows:1,value:C,onChange:k=>L(k.target.value),onBlur:A,onKeyDown:P,"data-test":"grid-cell-textarea"}):l.jsx("div",{className:`h-full p-1 text-sm text-foreground ${B?"whitespace-nowrap pointer-events-none":"whitespace-pre-wrap"}`,style:{width:_},"data-test":"grid-cell-content",children:i})})},St=({facade:t,state:e,gridFacade:n})=>{const i=()=>{const r=n.exportToJSON(),a=new Blob([r],{type:"application/json"}),u=URL.createObjectURL(a),c=document.createElement("a");c.href=u,c.download=`grid-export-${Date.now()}.json`,c.click(),URL.revokeObjectURL(u)},s=()=>{const r=n.exportToCSV(),a=new Blob([r],{type:"text/csv"}),u=URL.createObjectURL(a),c=document.createElement("a");c.href=u,c.download=`grid-export-${Date.now()}.csv`,c.click(),URL.revokeObjectURL(u)};return l.jsxs("div",{className:"grid-toolbar flex items-center gap-2 p-2 bg-muted border-b border-border","data-test":"grid-toolbar",children:[l.jsxs("div",{className:"undo-redo-buttons flex gap-1","data-test":"toolbar-undo-redo-group",children:[l.jsx(H,{size:"sm",variant:"outline",onClick:()=>t.undo(),disabled:!e.canUndo,title:`Undo (${e.undoDepth} available)`,"data-test":"toolbar-undo-button",children:" Undo"}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>t.redo(),disabled:!e.canRedo,title:`Redo (${e.redoDepth} available)`,"data-test":"toolbar-redo-button",children:" Redo"})]}),l.jsx("div",{className:"separator w-px h-6 bg-border","data-test":"toolbar-separator-1"}),l.jsxs("div",{className:"export-buttons flex gap-1","data-test":"toolbar-export-group",children:[l.jsx(H,{size:"sm",variant:"outline",onClick:i,"data-test":"toolbar-export-json-button",children:"Export JSON"}),l.jsx(H,{size:"sm",variant:"outline",onClick:s,"data-test":"toolbar-export-csv-button",children:"Export CSV"})]}),l.jsx("div",{className:"separator w-px h-6 bg-border","data-test":"toolbar-separator-2"}),l.jsxs("div",{className:"status-indicators flex items-center gap-2 text-sm text-muted-foreground ml-auto","data-test":"toolbar-status-group",children:[e.isDirty&&l.jsx("span",{className:"dirty-indicator text-orange-600 dark:text-orange-400","data-test":"toolbar-dirty-indicator",children:" Unsaved changes"}),e.isSaving&&l.jsx("span",{className:"saving-indicator text-blue-600 dark:text-blue-400","data-test":"toolbar-saving-indicator",children:"Saving..."}),l.jsxs("span",{className:"history-depth","data-test":"toolbar-history-depth",children:["History: ",e.undoDepth,"/",e.undoDepth+e.redoDepth]})]})]})},Et=({facade:t,state:e})=>{const[n,i]=x.useState(""),s=()=>{n.trim()&&(t.createSheet(n.trim()),i(""))};return l.jsxs("div",{className:"grid-sheet-tabs flex items-center gap-1 p-2 bg-muted border-t border-border overflow-x-auto","data-test":"grid-sheet-tabs",children:[e.sheets.map(r=>{const a=r.id===e.activeSheetId;return l.jsx("button",{className:["sheet-tab px-3 py-1 text-sm rounded-t border-t border-l border-r",a?"bg-background border-border -mb-px font-semibold":"bg-muted border-border hover:bg-accent"].join(" "),onClick:()=>t.switchSheet(r.id),"data-test":"sheet-tab",children:r.title},r.id)}),e.isAddingSheet?l.jsxs("div",{className:"add-sheet-input flex gap-1","data-test":"add-sheet-input-group",children:[l.jsx("input",{type:"text",className:"px-2 py-1 text-sm border border-border rounded bg-background text-foreground",placeholder:"Sheet name...",value:n,onChange:r=>i(r.target.value),onKeyDown:r=>{r.key==="Enter"?s():r.key==="Escape"&&(t.cancelAddSheet(),i(""))},onBlur:()=>{n.trim()||t.cancelAddSheet()},autoFocus:!0,"data-test":"add-sheet-input"}),l.jsx(H,{size:"sm",variant:"outline",onClick:s,disabled:!n.trim(),"data-test":"add-sheet-confirm-button",children:""}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>{t.cancelAddSheet(),i("")},"data-test":"add-sheet-cancel-button",children:""})]}):l.jsx(H,{size:"sm",variant:"outline",onClick:()=>t.startAddSheet(),className:"add-sheet-button","data-test":"add-sheet-button",children:"+ Add Sheet"})]})},xt=({col:t,width:e,height:n,onResize:i,gridFacade:s,maxRows:r=100})=>{const[a,u]=x.useState(!1),c=x.useRef(0),b=x.useRef(0),v=C=>{let L="",M=C;for(;M>=0;)L=String.fromCharCode(65+M%26)+L,M=Math.floor(M/26)-1;return L},p=C=>{C.preventDefault(),u(!0),c.current=C.clientX,b.current=e;const L=R=>{const T=R.clientX-c.current,W=Math.max(30,b.current+T);i(W)},M=()=>{u(!1),document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",M)};document.addEventListener("mousemove",L),document.addEventListener("mouseup",M)},S=()=>{if(!s)return;const C=16,L=40,M=500,R="14px sans-serif";let T=L;const W=v(t),A=ue(W,"12px sans-serif")+C;T=Math.max(T,A);for(let B=0;B<r;B++){const G=s.getCell(t,B);if(G&&G.text){const U=ue(G.text,R)+C;T=Math.max(T,U)}}const P=Math.min(M,T);i(P)};return l.jsxs("div",{className:["column-header relative flex items-center justify-center","bg-muted border-r border-b border-border","text-xs font-semibold text-foreground",a&&"bg-blue-50 dark:bg-blue-950/30"].join(" "),style:{width:e,height:n,minWidth:30},onDoubleClick:S,"data-test":"column-header",children:[l.jsx("span",{className:"select-none","data-test":"column-header-label",children:v(t)}),l.jsx("div",{className:"resize-handle absolute right-0 top-0 w-1 h-full cursor-col-resize hover:bg-blue-500 dark:hover:bg-blue-400",onMouseDown:p,"data-test":"column-header-resize-handle"})]})},It=({row:t,width:e,height:n,offsetY:i})=>l.jsx("div",{className:"row-header absolute flex items-center justify-center bg-muted border-r border-b border-border text-xs font-semibold text-foreground",style:{width:e,height:n,top:i,left:0},"data-test":"row-header",children:l.jsx("span",{className:"select-none","data-test":"row-header-label",children:t+1})}),Lt=({mode:t,isEditMode:e,className:n=""})=>{if(!e&&t==="normal")return null;const i=()=>{switch(t){case"normal":return"bg-gray-600 dark:bg-gray-500";case"insert":return"bg-blue-600 dark:bg-blue-500";case"visual":return"bg-orange-600 dark:bg-orange-500";default:return"bg-gray-600 dark:bg-gray-500"}},s=()=>{switch(t){case"normal":return"NORMAL";case"insert":return"INSERT";case"visual":return"VISUAL";default:return"NORMAL"}};return l.jsxs("div",{className:`vim-mode-indicator fixed bottom-4 right-4 px-3 py-1 rounded text-white text-sm font-semibold shadow-lg z-50 ${i()} ${n}`,"data-test":"vim-mode-indicator",children:["-- ",s()," --"]})},yt=({gridFacade:t,viewportFacade:e,selectionFacade:n,toolbarFacade:i,sheetTabsFacade:s,viewportState:r,selectionState:a,toolbarState:u,sheetTabsState:c,vimModeState:b,onScroll:v,onCellClick:p,onCellMouseDown:S,onCellMouseEnter:C,onCellMouseUp:L,onColumnResize:M,className:R="",showToolbar:T=!0,showSheetTabs:W=!0,showHeaders:A=!0,defaultCellWidth:P=100,defaultCellHeight:B=30,rowHeaderWidth:G=50,headerHeight:U=30})=>{const _=x.useRef(null),q=x.useRef(null),X=x.useRef(null);x.useEffect(()=>{_.current&&_.current.focus()},[]);const k=x.useCallback((E,y,$)=>{p(E,y,$)},[p]),j=x.useCallback(E=>{const y=E.currentTarget;v(y.scrollTop,y.scrollLeft)},[v]);return l.jsxs("div",{className:`spreadsheet-grid flex flex-col h-full focus:outline-none focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-500 ${R}`,"data-test":"spreadsheet-grid",ref:_,tabIndex:0,children:[T&&l.jsx(St,{facade:i,state:u,gridFacade:t}),l.jsx("div",{className:"grid-container flex-1 overflow-auto relative",onScroll:j,onMouseUp:()=>L==null?void 0:L(),ref:q,"data-test":"grid-container",children:l.jsxs("div",{className:"grid-content relative",style:{width:r.totalWidth,height:r.totalHeight},"data-test":"grid-content",children:[A&&l.jsxs("div",{className:"column-headers absolute top-0 left-0 flex",style:{height:U,width:r.totalWidth,transform:`translateY(${r.scrollTop}px)`,zIndex:10},"data-test":"grid-column-headers",children:[l.jsx("div",{ref:X,className:"corner-cell bg-muted border-r border-b border-border",style:{width:G,height:U},"data-test":"grid-corner-cell"}),Array.from({length:r.visibleRange.endCol}).map((E,y)=>l.jsx(xt,{col:y,width:e.getColumnWidth(y),height:U,gridFacade:t,onResize:$=>M(y,$)},y))]}),A&&l.jsx("div",{className:"row-headers absolute top-0 left-0",style:{width:G,height:r.totalHeight,transform:`translateX(${r.scrollLeft}px)`,zIndex:10},"data-test":"grid-row-headers",children:Array.from({length:r.visibleRange.endRow}).map((E,y)=>l.jsx(It,{row:y,width:G,height:e.getRowHeight(y),offsetY:U+y*e.getRowHeight(y)},y))}),r.visibleCells.map(E=>{const y=t.getCell(E.col,E.row),$=n.isActiveCell([E.col,E.row]),Y=n.isCellSelected([E.col,E.row]),Z=t.getEditingCell(),I=Z&&Z[0]===E.col&&Z[1]===E.row?t.getEditingContent():(y==null?void 0:y.text)||"",D=t.getContentMap(),N=y?it(y,D):0;return l.jsx(bt,{col:E.col,row:E.row,position:E,text:I,isActive:$,isSelected:Y,colsToNextText:N,onClick:O=>k(E.col,E.row,O),onMouseDown:()=>S==null?void 0:S(E.col,E.row),onMouseEnter:()=>C==null?void 0:C(E.col,E.row),onTextChange:O=>{t.setCellText(E.col,E.row,O)}},`${E.col}-${E.row}`)}),a.range&&(()=>{const E=n.getSelectionRect();if(!E)return null;const y=e.calculateCellPosition(E.startCol,E.startRow),$=e.calculateCellPosition(E.endCol,E.endRow),Y=$.x+$.width-y.x,Z=$.y+$.height-y.y;return l.jsx("div",{className:"selection-overlay absolute pointer-events-none border-2 border-blue-500 dark:border-blue-400 bg-blue-100 dark:bg-blue-950/30 bg-opacity-20 z-10",style:{left:y.x,top:y.y,width:Y,height:Z},"data-test":"selection-overlay"})})()]})}),W&&l.jsx(Et,{facade:s,state:c}),l.jsx(Lt,{mode:b.mode,isEditMode:b.isEditMode})]})},g={"I am editing cell at column {int} row {int}":"I am editing cell at column {int} row {int}","I have {string} in vim clipboard":"I have {string} in vim clipboard","a spreadsheet grid facade is initialized":"a spreadsheet grid facade is initialized","cell at column {int} row {int} contains {string}":"cell at column {int} row {int} contains {string}","cell splitting is enabled":"cell splitting is enabled","lines {int} to {int} are selected":"lines {int} to {int} are selected","the cell content is {string}":"the cell content is {string}","the cell editor is in Insert mode":"the cell editor is in Insert mode","the cell editor is in Normal mode":"the cell editor is in Normal mode","the cell editor is in Visual Line mode":"the cell editor is in Visual Line mode","the cursor is at position indicated by |":"the cursor is at position indicated by |","the cursor is at the end":"the cursor is at the end","the cursor is at the start":"the cursor is at the start","the cursor is on line {int}":"the cursor is on line {int}","the grid has dimensions {int} columns by {int} rows":"the grid has dimensions {int} columns by {int} rows"},h={"I delete line {int}":"I delete line {int}","I delete {int} lines in Normal mode":"I delete {int} lines in Normal mode","I double-click cell at column {int} row {int}":"I double-click cell at column {int} row {int}","I exit the cell":"I exit the cell","I move to line {int}":"I move to line {int}","I press Ctrl+Enter":"I press Ctrl+Enter","I press Down arrow in Normal mode":"I press Down arrow in Normal mode","I press Enter":"I press Enter","I press Escape":"I press Escape","I press G in Normal mode":"I press G in Normal mode","I press O":"I press O","I press P":"I press P","I press Up arrow in Normal mode":"I press Up arrow in Normal mode","I press V":"I press V","I press d":"I press d","I press dd":"I press dd","I press gg in Normal mode":"I press gg in Normal mode","I press j":"I press j","I press k":"I press k","I press o":"I press o","I press p":"I press p","I press y":"I press y","I press yy":"I press yy","I type {string}":"I type {string}","I type {string} and press Enter":"I type {string} and press Enter","I view the grid":"I view the grid"},o={"I should be able to type immediately":"I should be able to type immediately","cell at column {int} row {int} should be empty":"cell at column {int} row {int} should be empty","cell at column {int} row {int} should contain {string}":"cell at column {int} row {int} should contain {string}","lines {int} to {int} should be in vim clipboard":"lines {int} to {int} should be in vim clipboard","no cell splitting should occur":"no cell splitting should occur","the active cell should be at column {int} row {int}":"the active cell should be at column {int} row {int}","the cell content should be {string}":"the cell content should be {string}","the cell editor should be closed":"the cell editor should be closed","the cell editor should be in Insert mode":"the cell editor should be in Insert mode","the cell editor should be in Normal mode":"the cell editor should be in Normal mode","the cell editor should be in Visual Line mode":"the cell editor should be in Visual Line mode","the cell should be saved":"the cell should be saved","the cell should contain {string}":"the cell should contain {string}","the cursor should be on line {int}":"the cursor should be on line {int}","the cursor should be on the new line":"the cursor should be on the new line","the cursor should remain visible":"the cursor should remain visible","the entire line {int} should be selected":"the entire line {int} should be selected"},Mt=[{file:"/home/mine/dev/projects/2_typescript/nodejs/watcher-dir/watcher-v1/src/lib/modules/spreadsheet-grid/__specifications__/features/multi-line-cell-editing.feature",feature:"Multi-line Cell Editing",description:"As a spreadsheet user I want to edit cells with multiple lines of text So that I can create rich, structured content within cells",background:{Given:[{text:"a spreadsheet grid facade is initialized",template:"a spreadsheet grid facade is initialized"},{text:"the grid has dimensions 10 columns by 10 rows",template:"the grid has dimensions {int} columns by {int} rows",params:{int0:10,int1:10}}]},scenarios:[{scenario:"Enter creates new line within cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Insert mode",template:"the cell editor is in Insert mode"}],When:[{text:'I type "Line 1"',template:"I type {string}",params:{string0:"Line 1"}},{text:"I press Enter",template:"I press Enter"},{text:'I type "Line 2"',template:"I type {string}",params:{string0:"Line 2"}}],Then:[{text:'the cell content should be "Line 1\\nLine 2"',template:"the cell content should be {string}",params:{string0:"Line 1\\nLine 2"}}]},line:12},{scenario:"Ctrl+Enter saves and exits cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Insert mode",template:"the cell editor is in Insert mode"},{text:'the cell content is "Hello\\nWorld"',template:"the cell content is {string}",params:{string0:"Hello\\nWorld"}}],When:[{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:"the cell should be saved",template:"the cell should be saved"},{text:"the cell editor should be closed",template:"the cell editor should be closed"},{text:"the active cell should be at column 0 row 1",template:"the active cell should be at column {int} row {int}",params:{int0:0,int1:1}}]},line:20},{scenario:"Three-line cell content",steps:{Given:[{text:"I am editing cell at column 2 row 3",template:"I am editing cell at column {int} row {int}",params:{int0:2,int1:3}}],When:[{text:'I type "Line 1" and press Enter',template:"I type {string} and press Enter",params:{string0:"Line 1"}},{text:'I type "Line 2" and press Enter',template:"I type {string} and press Enter",params:{string0:"Line 2"}},{text:'I type "Line 3"',template:"I type {string}",params:{string0:"Line 3"}},{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:'cell at column 2 row 3 should contain "Line 1\\nLine 2\\nLine 3"',template:"cell at column {int} row {int} should contain {string}",params:{int0:2,int1:3,string0:"Line 1\\nLine 2\\nLine 3"}}]},line:29},{scenario:"Empty lines are preserved",steps:{Given:[{text:"I am editing cell at column 1 row 1",template:"I am editing cell at column {int} row {int}",params:{int0:1,int1:1}}],When:[{text:'I type "First" and press Enter',template:"I type {string} and press Enter",params:{string0:"First"}},{text:"I press Enter",template:"I press Enter"},{text:'I type "Third"',template:"I type {string}",params:{string0:"Third"}},{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:'cell at column 1 row 1 should contain "First\\n\\nThird"',template:"cell at column {int} row {int} should contain {string}",params:{int0:1,int1:1,string0:"First\\n\\nThird"}}]},line:37},{scenario:"Down arrow moves to next line within cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}},{text:"the cursor is on line 1",template:"the cursor is on line {int}",params:{int0:1}}],When:[{text:"I press Down arrow in Normal mode",template:"I press Down arrow in Normal mode"}],Then:[{text:"the cursor should be on line 2",template:"the cursor should be on line {int}",params:{int0:2}}]},line:47},{scenario:"Up arrow moves to previous line within cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press Up arrow in Normal mode",template:"I press Up arrow in Normal mode"}],Then:[{text:"the cursor should be on line 1",template:"the cursor should be on line {int}",params:{int0:1}}]},line:54},{scenario:"j command moves to next line in cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}},{text:"the cursor is on line 1",template:"the cursor is on line {int}",params:{int0:1}}],When:[{text:"I press j",template:"I press j"}],Then:[{text:"the cursor should be on line 2",template:"the cursor should be on line {int}",params:{int0:2}}]},line:61},{scenario:"k command moves to previous line in cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press k",template:"I press k"}],Then:[{text:"the cursor should be on line 1",template:"the cursor should be on line {int}",params:{int0:1}}]},line:69},{scenario:"gg moves to first line in multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2\\nLine 3\\nLine 4"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3\\nLine 4"}},{text:"the cursor is on line 3",template:"the cursor is on line {int}",params:{int0:3}}],When:[{text:"I press gg in Normal mode",template:"I press gg in Normal mode"}],Then:[{text:"the cursor should be on line 1",template:"the cursor should be on line {int}",params:{int0:1}}]},line:77},{scenario:"G moves to last line in multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2\\nLine 3\\nLine 4"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3\\nLine 4"}},{text:"the cursor is on line 1",template:"the cursor is on line {int}",params:{int0:1}}],When:[{text:"I press G in Normal mode",template:"I press G in Normal mode"}],Then:[{text:"the cursor should be on line 4",template:"the cursor should be on line {int}",params:{int0:4}}]},line:84},{scenario:"dd deletes current line in multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press dd",template:"I press dd"}],Then:[{text:'the cell content should be "Line 1\\nLine 3"',template:"the cell content should be {string}",params:{string0:"Line 1\\nLine 3"}},{text:"the cursor should be on line 2",template:"the cursor should be on line {int}",params:{int0:2}}]},line:93},{scenario:"yy yanks current line in multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press yy",template:"I press yy"},{text:"I move to line 3",template:"I move to line {int}",params:{int0:3}},{text:"I press p",template:"I press p"}],Then:[{text:'the cell content should be "Line 1\\nLine 2\\nLine 3\\nLine 2"',template:"the cell content should be {string}",params:{string0:"Line 1\\nLine 2\\nLine 3\\nLine 2"}}]},line:102},{scenario:"p pastes after current line",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}},{text:'I have "New Line" in vim clipboard',template:"I have {string} in vim clipboard",params:{string0:"New Line"}},{text:"the cursor is on line 1",template:"the cursor is on line {int}",params:{int0:1}}],When:[{text:"I press p",template:"I press p"}],Then:[{text:'the cell content should be "Line 1\\nNew Line\\nLine 2"',template:"the cell content should be {string}",params:{string0:"Line 1\\nNew Line\\nLine 2"}}]},line:112},{scenario:"P pastes before current line",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}},{text:'I have "New Line" in vim clipboard',template:"I have {string} in vim clipboard",params:{string0:"New Line"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press P",template:"I press P"}],Then:[{text:'the cell content should be "Line 1\\nNew Line\\nLine 2"',template:"the cell content should be {string}",params:{string0:"Line 1\\nNew Line\\nLine 2"}}]},line:121},{scenario:"o opens new line below and enters Insert mode",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}},{text:"the cursor is on line 1",template:"the cursor is on line {int}",params:{int0:1}}],When:[{text:"I press o",template:"I press o"}],Then:[{text:"a new line should be inserted after line 1",template:"a new line should be inserted after line {int}",params:{int0:1}},{text:"the cursor should be on the new line",template:"the cursor should be on the new line"},{text:"the cell editor should be in Insert mode",template:"the cell editor should be in Insert mode"}]},line:130},{scenario:"O opens new line above and enters Insert mode",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press O",template:"I press O"}],Then:[{text:"a new line should be inserted before line 2",template:"a new line should be inserted before line {int}",params:{int0:2}},{text:"the cursor should be on the new line",template:"the cursor should be on the new line"},{text:"the cell editor should be in Insert mode",template:"the cell editor should be in Insert mode"}]},line:140},{scenario:"V selects entire line in Visual Line mode",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}},{text:"the cursor is on line 2",template:"the cursor is on line {int}",params:{int0:2}}],When:[{text:"I press V",template:"I press V"}],Then:[{text:"the entire line 2 should be selected",template:"the entire line {int} should be selected",params:{int0:2}},{text:"the cell editor should be in Visual Line mode",template:"the cell editor should be in Visual Line mode"}]},line:152},{scenario:"d in Visual Line mode deletes selected lines",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Visual Line mode",template:"the cell editor is in Visual Line mode"},{text:'the cell content is "Line 1\\nLine 2\\nLine 3\\nLine 4"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3\\nLine 4"}},{text:"lines 2 to 3 are selected",template:"lines {int} to {int} are selected",params:{int0:2,int1:3}}],When:[{text:"I press d",template:"I press d"}],Then:[{text:'the cell content should be "Line 1\\nLine 4"',template:"the cell content should be {string}",params:{string0:"Line 1\\nLine 4"}},{text:"the cell editor should be in Normal mode",template:"the cell editor should be in Normal mode"}]},line:161},{scenario:"y in Visual Line mode yanks selected lines",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Visual Line mode",template:"the cell editor is in Visual Line mode"},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}},{text:"lines 2 to 3 are selected",template:"lines {int} to {int} are selected",params:{int0:2,int1:3}}],When:[{text:"I press y",template:"I press y"}],Then:[{text:"lines 2 to 3 should be in vim clipboard",template:"lines {int} to {int} should be in vim clipboard",params:{int0:2,int1:3}},{text:"the cell editor should be in Normal mode",template:"the cell editor should be in Normal mode"}]},line:170},{scenario:"Cell height adjusts for two lines",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}}],When:[{text:'I type "Line 1" and press Enter',template:"I type {string} and press Enter",params:{string0:"Line 1"}},{text:'I type "Line 2"',template:"I type {string}",params:{string0:"Line 2"}}],Then:[{text:"the cell height should accommodate 2 lines",template:"the cell height should accommodate {int} lines",params:{int0:2}}]},line:181},{scenario:"Cell height adjusts for five lines",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}}],When:[{text:"I type 5 lines of text",template:"I type {int} lines of text",params:{int0:5}}],Then:[{text:"the cell height should accommodate 5 lines",template:"the cell height should accommodate {int} lines",params:{int0:5}}]},line:187},{scenario:"Cell height reduces when lines are deleted",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2\\nLine 3\\nLine 4\\nLine 5"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3\\nLine 4\\nLine 5"}},{text:"the cell height is adjusted for 5 lines",template:"the cell height is adjusted for {int} lines",params:{int0:5}}],When:[{text:"I delete 3 lines in Normal mode",template:"I delete {int} lines in Normal mode",params:{int0:3}}],Then:[{text:"the cell height should accommodate 2 lines",template:"the cell height should accommodate {int} lines",params:{int0:2}}]},line:192},{scenario:"Empty cell returns to single-line height",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2\\nLine 3"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2\\nLine 3"}}],When:[{text:"I select all and delete in Visual mode",template:"I select all and delete in Visual mode"},{text:"I exit the cell",template:"I exit the cell"}],Then:[{text:"the cell height should be single-line",template:"the cell height should be single-line"}]},line:199},{scenario:"Ctrl+Enter splits cell at cursor position",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Before cursor|After cursor"',template:"the cell content is {string}",params:{string0:"Before cursor|After cursor"}},{text:"the cursor is at position indicated by |",template:"the cursor is at position indicated by |"},{text:"cell splitting is enabled",template:"cell splitting is enabled"}],When:[{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:'cell at column 0 row 0 should contain "Before cursor"',template:"cell at column {int} row {int} should contain {string}",params:{int0:0,int1:0,string0:"Before cursor"}},{text:'cell at column 0 row 1 should contain "After cursor"',template:"cell at column {int} row {int} should contain {string}",params:{int0:0,int1:1,string0:"After cursor"}},{text:"the active cell should be at column 0 row 1",template:"the active cell should be at column {int} row {int}",params:{int0:0,int1:1}}]},line:208},{scenario:"Ctrl+Enter splits multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Line 1\\nLine 2|Line 3\\nLine 4"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2|Line 3\\nLine 4"}},{text:"the cursor is at position indicated by |",template:"the cursor is at position indicated by |"},{text:"cell splitting is enabled",template:"cell splitting is enabled"}],When:[{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:'cell at column 0 row 0 should contain "Line 1\\nLine 2"',template:"cell at column {int} row {int} should contain {string}",params:{int0:0,int1:0,string0:"Line 1\\nLine 2"}},{text:'cell at column 0 row 1 should contain "Line 3\\nLine 4"',template:"cell at column {int} row {int} should contain {string}",params:{int0:0,int1:1,string0:"Line 3\\nLine 4"}}]},line:218},{scenario:"Ctrl+Enter at start of cell creates empty cell above",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Content"',template:"the cell content is {string}",params:{string0:"Content"}},{text:"the cursor is at the start",template:"the cursor is at the start"},{text:"cell splitting is enabled",template:"cell splitting is enabled"}],When:[{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:"cell at column 0 row 0 should be empty",template:"cell at column {int} row {int} should be empty",params:{int0:0,int1:0}},{text:'cell at column 0 row 1 should contain "Content"',template:"cell at column {int} row {int} should contain {string}",params:{int0:0,int1:1,string0:"Content"}}]},line:227},{scenario:"Ctrl+Enter at end of cell moves to next cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the cell content is "Content"',template:"the cell content is {string}",params:{string0:"Content"}},{text:"the cursor is at the end",template:"the cursor is at the end"}],When:[{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:'cell at column 0 row 0 should contain "Content"',template:"cell at column {int} row {int} should contain {string}",params:{int0:0,int1:0,string0:"Content"}},{text:"the active cell should be at column 0 row 1",template:"the active cell should be at column {int} row {int}",params:{int0:0,int1:1}},{text:"no cell splitting should occur",template:"no cell splitting should occur"}]},line:236},{scenario:"Long line wraps within cell width",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell has a fixed width of 200px",template:"the cell has a fixed width of 200px"}],When:[{text:"I type a 300-character line",template:"I type a {int}-character line",params:{int0:300}}],Then:[{text:"the text should wrap to multiple display lines",template:"the text should wrap to multiple display lines"},{text:"the cell content should remain as a single line",template:"the cell content should remain as a single line"}]},line:247},{scenario:"Horizontal scroll for very long unwrapped line",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"text wrapping is disabled",template:"text wrapping is disabled"}],When:[{text:"I type a 500-character line",template:"I type a {int}-character line",params:{int0:500}}],Then:[{text:"horizontal scroll should be available",template:"horizontal scroll should be available"},{text:"the cursor should remain visible",template:"the cursor should remain visible"}]},line:254},{scenario:"Overflow indicator for multi-line content",steps:{Given:[{text:'cell at column 0 row 0 contains "Line 1\\nLine 2\\nLine 3\\nLine 4\\nLine 5"',template:"cell at column {int} row {int} contains {string}",params:{int0:0,int1:0,string0:"Line 1\\nLine 2\\nLine 3\\nLine 4\\nLine 5"}},{text:"the cell is not being edited",template:"the cell is not being edited"},{text:"the cell height shows only 2 lines",template:"the cell height shows only {int} lines",params:{int0:2}}],When:[{text:"I view the grid",template:"I view the grid"}],Then:[{text:"an overflow indicator should be displayed",template:"an overflow indicator should be displayed"},{text:"the indicator should show there are more lines",template:"the indicator should show there are more lines"}]},line:261},{scenario:"Escape exits cell without saving changes",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:'the original content is "Original\\nContent"',template:"the original content is {string}",params:{string0:"Original\\nContent"}}],When:[{text:'I type "New Content"',template:"I type {string}",params:{string0:"New Content"}},{text:"I press Escape",template:"I press Escape"}],Then:[{text:'the cell should contain "Original\\nContent"',template:"the cell should contain {string}",params:{string0:"Original\\nContent"}},{text:"the cell editor should be closed",template:"the cell editor should be closed"}]},line:271},{scenario:"Ctrl+Enter exits even with invalid content",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}}],When:[{text:"I type invalid content",template:"I type invalid content"},{text:"I press Ctrl+Enter",template:"I press Ctrl+Enter"}],Then:[{text:"the content should be saved",template:"the content should be saved"},{text:"the cell editor should be closed",template:"the cell editor should be closed"}]},line:279},{scenario:"Vim undo works within multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}}],When:[{text:"I delete line 2",template:"I delete line {int}",params:{int0:2}},{text:"I press u (undo)",template:"I press u (undo)"}],Then:[{text:'the cell content should be "Line 1\\nLine 2"',template:"the cell content should be {string}",params:{string0:"Line 1\\nLine 2"}}]},line:286},{scenario:"Vim redo works within multi-line cell",steps:{Given:[{text:"I am editing cell at column 0 row 0",template:"I am editing cell at column {int} row {int}",params:{int0:0,int1:0}},{text:"the cell editor is in Normal mode",template:"the cell editor is in Normal mode"},{text:'the cell content is "Line 1\\nLine 2"',template:"the cell content is {string}",params:{string0:"Line 1\\nLine 2"}}],When:[{text:"I delete line 2",template:"I delete line {int}",params:{int0:2}},{text:"I press u (undo)",template:"I press u (undo)"},{text:"I press Ctrl+r (redo)",template:"I press Ctrl+r (redo)"}],Then:[{text:'the cell content should be "Line 1"',template:"the cell content should be {string}",params:{string0:"Line 1"}}]},line:294},{scenario:"Enter cell in Insert mode based on feature flag",steps:{Given:[{text:'the feature flag "enterCellInInsertMode" is true',template:"the feature flag {string} is true",params:{string0:"enterCellInInsertMode"}}],When:[{text:"I double-click cell at column 0 row 0",template:"I double-click cell at column {int} row {int}",params:{int0:0,int1:0}}],Then:[{text:"the cell editor should open in Insert mode",template:"the cell editor should open in Insert mode"},{text:"I should be able to type immediately",template:"I should be able to type immediately"}]},line:305},{scenario:"Enter cell in Normal mode based on feature flag",steps:{Given:[{text:'the feature flag "enterCellInInsertMode" is false',template:"the feature flag {string} is false",params:{string0:"enterCellInInsertMode"}}],When:[{text:"I double-click cell at column 0 row 0",template:"I double-click cell at column {int} row {int}",params:{int0:0,int1:0}}],Then:[{text:"the cell editor should open in Normal mode",template:"the cell editor should open in Normal mode"},{text:"I need to press i before typing",template:"I need to press i before typing"}]},line:311}]}],Tt={[g["I extend selection down"]]:t=>(t.facade.extendSelection("down"),t),[g["I extend selection left"]]:t=>(t.facade.extendSelection("left"),t),[g["I extend selection right"]]:t=>(t.facade.extendSelection("right"),t),[g["I select column {int}"]]:(t,e)=>(t.facade.selectColumn(e.int0,100),t),[g["I select row {int}"]]:(t,e)=>(t.facade.selectRow(e.int0,26),t),[g["I start selection at column {int} row {int}"]]:(t,e)=>(t.facade.startSelection([e.int0,e.int1]),t),[g["I update selection to column {int} row {int}"]]:(t,e)=>(t.facade.updateSelection([e.int0,e.int1]),t),[g["a selection range from column {int} row {int} to column {int} row {int}"]]:(t,e)=>(t.facade.setRange([e.int0,e.int1],[e.int2,e.int3]),t),[g["the active cell is at column {int} row {int}"]]:(t,e)=>(t.facade.setActiveCell([e.int0,e.int1]),t),[g["a grid selection facade is initialized"]]:t=>t,[g["a grid selection facade is initialized with maxCol {int} and maxRow {int}"]]:(t,e)=>t},Dt={[h["I clear the range"]]:t=>(t.facade.clearRange(),t),[h["I end the selection"]]:t=>(t.facade.endSelection(),t),[h["I extend selection down"]]:t=>(t.facade.extendSelection("down"),t),[h["I extend selection left"]]:t=>(t.facade.extendSelection("left"),t),[h["I extend selection right"]]:t=>(t.facade.extendSelection("right"),t),[h["I extend selection up"]]:t=>(t.facade.extendSelection("up"),t),[h["I select column {int}"]]:(t,e)=>(t.facade.selectColumn(e.int0,100),t),[h["I select row {int}"]]:(t,e)=>(t.facade.selectRow(e.int0,26),t),[h["I set range from column {int} row {int} to column {int} row {int}"]]:(t,e)=>(t.facade.setRange([e.int0,e.int1],[e.int2,e.int3]),t),[h["I set the active cell to column {int} row {int}"]]:(t,e)=>(t.facade.setActiveCell([e.int0,e.int1]),t),[h["I start selection at column {int} row {int}"]]:(t,e)=>(t.facade.startSelection([e.int0,e.int1]),t),[h["I update selection to column {int} row {int}"]]:(t,e)=>(t.facade.updateSelection([e.int0,e.int1]),t),[h["I get the selection state"]]:t=>{const e=t.facade.getState();return t.lastResult={...t.lastResult,...e},t},[h["I get the selection rectangle"]]:t=>{const e=t.facade.getSelectionRect();return t.lastResult={...t.lastResult,rect:e},t},[h["I get all selected cells"]]:t=>{const e=t.facade.getSelectedCells();return t.lastResult={...t.lastResult,selectedCells:e,cellCount:e.length},t}},Rt={[o["the active cell should be at column {int} row {int}"]]:(t,e)=>{if(!t.facade.isActiveCell([e.int0,e.int1])){const i=t.facade.getState().activeCell;throw new Error(`Expected active cell to be at column ${e.int0} row ${e.int1}, but got column ${i[0]} row ${i[1]}`)}return t},[o["the cell at column {int} row {int} should be selected"]]:(t,e)=>{if(!t.facade.isCellSelected([e.int0,e.int1]))throw new Error(`Expected cell at column ${e.int0} row ${e.int1} to be selected, but it is not`);return t},[o["the cell at column {int} row {int} should be the active cell"]]:(t,e)=>{if(!t.facade.isActiveCell([e.int0,e.int1])){const i=t.facade.getState().activeCell;throw new Error(`Expected cell at column ${e.int0} row ${e.int1} to be the active cell, but active cell is at column ${i[0]} row ${i[1]}`)}return t},[o["the cell at column {int} row {int} should not be selected"]]:(t,e)=>{if(t.facade.isCellSelected([e.int0,e.int1]))throw new Error(`Expected cell at column ${e.int0} row ${e.int1} NOT to be selected, but it is`);return t},[o["the cell at column {int} row {int} should not be the active cell"]]:(t,e)=>{if(t.facade.isActiveCell([e.int0,e.int1]))throw new Error(`Expected cell at column ${e.int0} row ${e.int1} NOT to be the active cell, but it is`);return t},[o["the rectangle dimensions should match snapshot {string}"]]:(t,e)=>{const n=t.facade.getSelectionRect();return t.lastResult={...t.lastResult,rect:n},t},[o["the rectangle should have startCol {int} startRow {int} endCol {int} endRow {int}"]]:(t,e)=>{const n=t.facade.getSelectionRect();if(!n||n.startCol!==e.int0||n.startRow!==e.int1||n.endCol!==e.int2||n.endRow!==e.int3)throw new Error(`Expected rectangle (startCol: ${e.int0}, startRow: ${e.int1}, endCol: ${e.int2}, endRow: ${e.int3}), but got (startCol: ${n==null?void 0:n.startCol}, startRow: ${n==null?void 0:n.startRow}, endCol: ${n==null?void 0:n.endCol}, endRow: ${n==null?void 0:n.endRow})`);return t},[o["the rectangle should have width {int} and height {int}"]]:(t,e)=>{const n=t.facade.getSelectionRect();if(!n)throw new Error("Expected a selection rectangle but got none");const i=Math.abs(n.endCol-n.startCol)+1,s=Math.abs(n.endRow-n.startRow)+1;if(i!==e.int0||s!==e.int1)throw new Error(`Expected rectangle with width ${e.int0} and height ${e.int1}, but got width ${i} and height ${s}`);return t},[o["the selected cells count should match snapshot {string}"]]:(t,e)=>{const n=t.facade.getSelectedCells().length;return t.lastResult={...t.lastResult,cellCount:n},t},[o["the selected cells should include column {int} row {int}"]]:(t,e)=>{if(!t.facade.getSelectedCells().some(s=>s[0]===e.int0&&s[1]===e.int1))throw new Error(`Expected selected cells to include column ${e.int0} row ${e.int1}, but it does not`);return t},[o["the selected cells should match snapshot {string}"]]:(t,e)=>{const n=t.facade.getSelectedCells();return t.lastResult={...t.lastResult,selectedCells:n,cellCount:n.length},t},[o["the selection range should span from column {int} row {int} to column {int} row {int}"]]:(t,e)=>{const n=t.facade.getState();return t.lastResult={...t.lastResult,range:n.range},t},[o["the selection state should match snapshot {string}"]]:(t,e)=>t,[o["the selection state should have no range"]]:t=>t,[o["there should be {int} selected cells"]]:(t,e)=>{const n=t.facade.getSelectedCells().length;return t.lastResult={...t.lastResult,cellCount:n},t},[o["the selection should be in selecting mode"]]:t=>{const e=t.facade.getState();return t.lastResult={...t.lastResult,isSelecting:e.isSelecting},t},[o["the selection should not be in selecting mode"]]:t=>{const e=t.facade.getState();return t.lastResult={...t.lastResult,isSelecting:e.isSelecting},t},[o["the state should not be in selecting mode"]]:t=>t,[o["the selection range should be from column {int} row {int} to column {int} row {int}"]]:(t,e)=>{const n=t.facade.getState();return t.lastResult={...t.lastResult,range:n.range},t},[o["the state should have active cell at column {int} row {int}"]]:(t,e)=>t,[o["the state should be in selecting mode"]]:t=>t,[o["the selection range start should be column {int} row {int}"]]:(t,e)=>{var i;const n=t.facade.getState();return t.lastResult={...t.lastResult,rangeStart:(i=n.range)==null?void 0:i.start},t},[o["the state should have a range"]]:t=>t,[o["the state should have no range"]]:t=>t,[o["the selection rectangle should match snapshot {string}"]]:(t,e)=>{const n=t.facade.getSelectionRect();return t.lastResult={...t.lastResult,rect:n},t}};function m(t){if(!t.gridFacade)throw new Error("GridFacade not initialized in context");return t.gridFacade}const Nt={[g["a spreadsheet grid facade is initialized"]]:t=>t,[g["undo/redo is enabled with max history of {int}"]]:(t,e)=>t,[g["the grid has dimensions {int} columns by {int} rows"]]:(t,e)=>t,[g["cell at column {int} row {int} is empty"]]:(t,e)=>(m(t).clearCell(e.int0,e.int1),t),[g["cell at column {int} row {int} contains {string}"]]:(t,e)=>(m(t).setCellText(e.int0,e.int1,e.string0),t),[g["undo history max is {int}"]]:(t,e)=>(t.tempData={...t.tempData,undoMax:e.int0},t),[g["the grid is freshly initialized"]]:t=>(m(t).clearHistory(),t),[g["batch mode is enabled"]]:t=>(t.tempData={...t.tempData,batchMode:!0},t),[g["the grid has a default sheet named {string}"]]:(t,e)=>t,[g["sheets {string} and {string} exist"]]:(t,e)=>{const n=m(t);return n.createSheet(e.string0,e.string0),n.createSheet(e.string1,e.string1),t},[g["sheets {string}, {string}, {string} exist"]]:(t,e)=>{const n=m(t);return n.createSheet(e.string0,e.string0),n.createSheet(e.string1,e.string1),n.createSheet(e.string2,e.string2),t},[g["sheet {string} is the active sheet"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[g["{string} is the active sheet"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[g["sheet {string} has cell {int},{int} containing {string}"]]:(t,e)=>{var s;const n=m(t),i=(s=n.getActiveSheet())==null?void 0:s.id;return n.switchSheet(e.string0),n.setCellText(e.int0,e.int1,e.string1),i&&n.switchSheet(i),t},[g["only {string} exists"]]:(t,e)=>{const n=m(t);return n.getAllSheets().forEach(s=>{s.id!==e.string0&&n.deleteSheet(s.id)}),t},[g["I am on sheet {string}"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[g["grid has content in cells {int},{int} {int},{int} {int},{int}"]]:(t,e)=>{const n=m(t);return n.setCellText(e.int0,e.int1,"Data1"),n.setCellText(e.int2,e.int3,"Data2"),n.setCellText(e.int4,e.int5,"Data3"),t},[g["cells {int},{int} {int},{int} {int},{int} all contain {string}"]]:(t,e)=>{const n=m(t);return n.setCellText(e.int0,e.int1,e.string0),n.setCellText(e.int2,e.int3,e.string0),n.setCellText(e.int4,e.int5,e.string0),t},[g["cells in range A1:C1 contain {string} {string} {string}"]]:(t,e)=>{const n=m(t);return n.setCellText(0,0,e.string0),n.setCellText(1,0,e.string1),n.setCellText(2,0,e.string2),t},[g["range A1:C2 contains data"]]:t=>{const e=m(t);for(let n=0;n<3;n++)for(let i=0;i<2;i++)e.setCellText(n,i,`Data${n},${i}`);return t},[g["grid is empty"]]:t=>{const e=m(t);return e.getContentMap().forEach((i,s)=>{i&&i.forEach((r,a)=>{r&&e.clearCell(a,s)})}),t},[g["grid has content in multiple cells"]]:t=>{const e=m(t);return e.setCellText(0,0,"A1"),e.setCellText(1,1,"B2"),e.setCellText(2,2,"C3"),t},[g["grid is initialized with {int} columns and {int} rows"]]:(t,e)=>t,[g["grid has dimensions 10x10"]]:t=>t,[g["grid is freshly loaded"]]:t=>(m(t).clearHistory(),t),[g["grid has {int} cells with content"]]:(t,e)=>{const n=m(t);for(let i=0;i<e.int0;i++)n.setCellText(i%10,Math.floor(i/10),`Cell${i}`);return t},[g["I have {int} characters of text"]]:(t,e)=>(t.tempData={...t.tempData,largeText:"A".repeat(e.int0)},t),[g["grid has content:"]]:t=>t,[g["sheet {string} has content"]]:(t,e)=>{var s;const n=m(t),i=(s=n.getActiveSheet())==null?void 0:s.id;return n.switchSheet(e.string0),n.setCellText(0,0,"Content"),i&&n.switchSheet(i),t},[g["sheet {string} has different content"]]:(t,e)=>{var s;const n=m(t),i=(s=n.getActiveSheet())==null?void 0:s.id;return n.switchSheet(e.string0),n.setCellText(0,0,"Different"),i&&n.switchSheet(i),t},[g["cells at {int},{int} and {int},{int} exist"]]:(t,e)=>{const n=m(t);return n.setCellText(e.int0,e.int1,"Cell1"),n.setCellText(e.int2,e.int3,"Cell2"),t},[g["sheet {string} exists"]]:(t,e)=>(m(t).createSheet(e.string0,e.string0),t),[g["cell at column {int} row {int} is selected"]]:(t,e)=>(t.tempData={...t.tempData,selectedCell:[e.int0,e.int1]},t),[g["I select cell {int},{int}"]]:(t,e)=>(t.tempData={...t.tempData,selectedCell:[e.int0,e.int1]},t),[g["cell at position {int},{int}"]]:(t,e)=>(t.tempData={...t.tempData,queryPosition:[e.int0,e.int1]},t),[g["grid has {int} columns and {int} rows"]]:(t,e)=>t},At={[h["I trigger undo"]]:t=>(m(t).undo(),t),[h["I trigger redo"]]:t=>(m(t).redo(),t),[h["I trigger undo {int} times"]]:(t,e)=>{const n=m(t);for(let i=0;i<e.int0;i++)n.undo();return t},[h["I set cell {int},{int} to {string}"]]:(t,e)=>(m(t).setCellText(e.int0,e.int1,e.string0),t),[h["I make {int} cell changes"]]:(t,e)=>{const n=m(t);for(let i=0;i<e.int0;i++)n.setCellText(i%10,Math.floor(i/10),`Change${i}`);return t},[h["I commit batch"]]:t=>(t.tempData={...t.tempData,batchMode:!1},t),[h["I mark as saved"]]:t=>t,[h["I modify a cell"]]:t=>(m(t).setCellText(0,0,"Modified"),t),[h["I create a new sheet named {string}"]]:(t,e)=>{const n=m(t);return n.createSheet(e.string0,e.string0),n.switchSheet(e.string0),t},[h["I create a new sheet without specifying a name"]]:t=>{const e=m(t),i=`Sheet${e.getAllSheets().length+1}`;return e.createSheet(i,i),t},[h["I create sheets: {string}, {string}, {string}"]]:(t,e)=>{const n=m(t);return n.createSheet(e.string0,e.string0),n.createSheet(e.string1,e.string1),n.createSheet(e.string2,e.string2),t},[h["I create sheets in order: {string}, {string}, {string}"]]:(t,e)=>{const n=m(t);return n.createSheet(e.string0,e.string0),n.createSheet(e.string1,e.string1),n.createSheet(e.string2,e.string2),t},[h["I switch to sheet {string}"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[h["I switch to {string}"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[h["I switch back to {string}"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[h["I try to switch to sheet {string}"]]:(t,e)=>{const n=m(t);try{n.switchSheet(e.string0),t.lastResult={success:!0}}catch(i){t.lastResult={success:!1,error:i}}return t},[h["I delete sheet {string}"]]:(t,e)=>(m(t).deleteSheet(e.string0),t),[h["I try to delete sheet {string}"]]:(t,e)=>{const n=m(t);try{const i=n.deleteSheet(e.string0);t.lastResult={success:i}}catch(i){t.lastResult={success:!1,error:i}}return t},[h["I query all sheet names"]]:t=>{const n=m(t).getAllSheets();return t.lastResult={sheetNames:n.map(i=>i.title)},t},[h["I query the active sheet ID"]]:t=>{const n=m(t).getActiveSheet();return t.lastResult={activeSheetId:n==null?void 0:n.id},t},[h["I check if {string} exists"]]:(t,e)=>{const i=m(t).getSheet(e.string0);return t.lastResult={exists:i!==null},t},[h["I view sheet {string}"]]:(t,e)=>(m(t).switchSheet(e.string0),t),[h["I query the ID of {string}"]]:(t,e)=>{const i=m(t).getSheet(e.string0);return t.lastResult={sheetId:i==null?void 0:i.id},t},[h["I move sheet {string} to position {int}"]]:(t,e)=>t,[h["I set cell at column {int} row {int} to {string}"]]:(t,e)=>(m(t).setCellText(e.int0,e.int1,e.string0),t),[h["I get the text from cell {int},{int}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1);return t.lastResult={text:(i==null?void 0:i.text)||""},t},[h["I clear cells {int},{int} {int},{int} {int},{int}"]]:(t,e)=>{const n=m(t);return n.clearCell(e.int0,e.int1),n.clearCell(e.int2,e.int3),n.clearCell(e.int4,e.int5),t},[h["I copy from cell {int},{int} to cell {int},{int}"]]:(t,e)=>{const n=m(t),i=n.getCell(e.int0,e.int1);return i!=null&&i.text&&n.setCellText(e.int2,e.int3,i.text),t},[h["I move from cell {int},{int} to cell {int},{int}"]]:(t,e)=>{const n=m(t),i=n.getCell(e.int0,e.int1);return i!=null&&i.text&&(n.setCellText(e.int2,e.int3,i.text),n.clearCell(e.int0,e.int1)),t},[h["I query cells in range A1:C1"]]:t=>{const e=m(t),n=[];for(let i=0;i<3;i++){const s=e.getCell(i,0);n.push((s==null?void 0:s.text)||"")}return t.lastResult={cells:n},t},[h["I set range A1:C1 to values [{string}, {string}, {string}]"]]:(t,e)=>{const n=m(t);return n.setCellText(0,0,e.string0),n.setCellText(1,0,e.string1),n.setCellText(2,0,e.string2),t},[h["I clear range A1:C2"]]:t=>{const e=m(t);for(let n=0;n<3;n++)for(let i=0;i<2;i++)e.clearCell(n,i);return t},[h["I query grid dimensions"]]:t=>{const n=m(t).getDimensions();return t.lastResult={dimensions:n},t},[h["I check if position {int},{int} is valid"]]:(t,e)=>{const i=m(t).getDimensions(),s=e.int0>=0&&e.int0<i.cols&&e.int1>=0&&e.int1<i.rows;return t.lastResult={isValid:s},t},[h["I try to get cell at position {int},{int}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1);return t.lastResult={cell:i},t},[h["I export to JSON"]]:t=>{const n=m(t).exportToJSON();return t.lastResult={json:n},t},[h["I export to CSV"]]:t=>{const n=m(t).exportToCSV();return t.lastResult={csv:n},t},[h["I query the content map"]]:t=>{const n=m(t).getContentMap();return t.lastResult={contentMap:n},t},[h["I query content map for {string}"]]:(t,e)=>{var r;const n=m(t),i=(r=n.getActiveSheet())==null?void 0:r.id;n.switchSheet(e.string0);const s=n.getContentMap();return t.lastResult={contentMap:s},i&&n.switchSheet(i),t},[h["I query the cell metadata"]]:t=>t,[h["I query their identifiers"]]:t=>t,[h["I query total cell count"]]:t=>{const n=m(t).getDimensions();return t.lastResult={totalCells:n.cols*n.rows},t},[h["I query non-empty cell count"]]:t=>{const n=m(t).getContentMap();let i=0;return n.forEach(s=>{s&&s.forEach(r=>{r&&r.text&&i++})}),t.lastResult={nonEmptyCells:i},t},[h["I set cell {int},{int} to the large text"]]:(t,e)=>{var s;const n=m(t),i=((s=t.tempData)==null?void 0:s.largeText)||"";return n.setCellText(e.int0,e.int1,i),t},[h["I set the following cells:"]]:t=>t},jt={[o["cell at column {int} row {int} should be empty"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1);if(!(!i||!i.text))throw new Error(`Expected cell at column ${e.int0} row ${e.int1} to be empty, but got "${i==null?void 0:i.text}"`);return t},[o["cell at column {int} row {int} should contain {string}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1);if((i==null?void 0:i.text)!==e.string0)throw new Error(`Expected cell at column ${e.int0} row ${e.int1} to contain "${e.string0}", but got "${(i==null?void 0:i.text)||""}"`);return t},[o["undo depth should be {int}"]]:(t,e)=>{const i=m(t).getUndoDepth();if(i!==e.int0)throw new Error(`Expected undo depth to be ${e.int0}, but got ${i}`);return t},[o["redo depth should be {int}"]]:(t,e)=>{const i=m(t).getRedoDepth();if(i!==e.int0)throw new Error(`Expected redo depth to be ${e.int0}, but got ${i}`);return t},[o["can undo should be false"]]:t=>{if(m(t).canUndo())throw new Error("Expected canUndo to be false, but got true");return t},[o["can undo should be true"]]:t=>{if(!m(t).canUndo())throw new Error("Expected canUndo to be true, but got false");return t},[o["can redo should be false"]]:t=>{if(m(t).canRedo())throw new Error("Expected canRedo to be false, but got true");return t},[o["can redo should be true"]]:t=>{if(!m(t).canRedo())throw new Error("Expected canRedo to be true, but got false");return t},[o["I should be able to undo only {int} changes"]]:(t,e)=>t,[o["I should not be able to redo"]]:t=>{if(m(t).canRedo())throw new Error("Expected not to be able to redo, but canRedo is true");return t},[o["isDirty should be false"]]:t=>t,[o["isDirty should be true"]]:t=>t,[o["cell at column {int} row {int} should still be selected"]]:(t,e)=>t,[o["cell at column {int} row {int} should still contain {string}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1);if((i==null?void 0:i.text)!==e.string0)throw new Error(`Expected cell at column ${e.int0} row ${e.int1} to still contain "${e.string0}", but got "${(i==null?void 0:i.text)||""}"`);return t},[o["the grid should have {int} sheets"]]:(t,e)=>{const i=m(t).getAllSheets();if(i.length!==e.int0)throw new Error(`Expected grid to have ${e.int0} sheets, but got ${i.length}`);return t},[o["a sheet named {string} should exist"]]:(t,e)=>{if(!m(t).getSheet(e.string0))throw new Error(`Expected sheet "${e.string0}" to exist, but it does not`);return t},[o["{string} should be the active sheet"]]:(t,e)=>{const i=m(t).getActiveSheet();if(!((i==null?void 0:i.id)===e.string0||(i==null?void 0:i.title)===e.string0))throw new Error(`Expected "${e.string0}" to be the active sheet, but got "${(i==null?void 0:i.title)||(i==null?void 0:i.id)||"none"}"`);return t},[o["{string} should still be the active sheet"]]:(t,e)=>{const i=m(t).getActiveSheet();if(!((i==null?void 0:i.id)===e.string0||(i==null?void 0:i.title)===e.string0))throw new Error(`Expected "${e.string0}" to still be the active sheet, but got "${(i==null?void 0:i.title)||(i==null?void 0:i.id)||"none"}"`);return t},[o["the sheet list should contain {string}"]]:(t,e)=>{const i=m(t).getAllSheets();if(!i.some(r=>r.title===e.string0||r.id===e.string0)){const r=i.map(a=>a.title).join(", ");throw new Error(`Expected sheet list to contain "${e.string0}", but got: [${r}]`)}return t},[o["all sheet names should be unique"]]:t=>{const i=m(t).getAllSheets().map(a=>a.title),s=new Set(i);if(!(i.length===s.size)){const a=i.filter((u,c)=>i.indexOf(u)!==c);throw new Error(`Expected all sheet names to be unique, but found duplicates: [${a.join(", ")}]`)}return t},[o["a sheet with auto-generated name should be created"]]:t=>{const n=m(t).getAllSheets();if(!n.some(s=>/^Sheet\d+$/.test(s.title))){const s=n.map(r=>r.title).join(", ");throw new Error(`Expected a sheet with auto-generated name (Sheet1, Sheet2, etc.), but got: [${s}]`)}return t},[o["the name should follow pattern {string}"]]:(t,e)=>t,[o["{string} should not be the active sheet"]]:(t,e)=>{const i=m(t).getActiveSheet();if(!((i==null?void 0:i.id)!==e.string0&&(i==null?void 0:i.title)!==e.string0))throw new Error(`Expected "${e.string0}" NOT to be the active sheet, but it is`);return t},[o["the active sheet should remain unchanged"]]:t=>t,[o["an error should be thrown"]]:t=>{var n,i;if(!(((n=t.lastResult)==null?void 0:n.error)!==void 0||((i=t.lastResult)==null?void 0:i.success)===!1))throw new Error("Expected an error to be thrown, but no error occurred");return t},[o["the delete operation should fail"]]:t=>{var n;if(!(((n=t.lastResult)==null?void 0:n.success)===!1))throw new Error("Expected delete operation to fail, but it succeeded");return t},[o["{string} should still exist"]]:(t,e)=>{if(!m(t).getSheet(e.string0))throw new Error(`Expected sheet "${e.string0}" to still exist, but it does not`);return t},[o["I should get [{string}, {string}, {string}]"]]:(t,e)=>t,[o["cell at column {int} row {int} in {string} should be empty"]]:(t,e)=>{var a;const n=m(t),i=(a=n.getActiveSheet())==null?void 0:a.id;n.switchSheet(e.string0);const s=n.getCell(e.int0,e.int1),r=!s||!s.text;if(i&&n.switchSheet(i),!r)throw new Error(`Expected cell at column ${e.int0} row ${e.int1} in sheet "${e.string0}" to be empty, but got "${s==null?void 0:s.text}"`);return t},[o["cell {int},{int} should contain {string}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1);if((i==null?void 0:i.text)!==e.string0)throw new Error(`Expected cell ${e.int0},${e.int1} to contain "${e.string0}", but got "${(i==null?void 0:i.text)||""}"`);return t},[o["the selection should be at default position {int},{int}"]]:(t,e)=>t,[o["the selection should be at {int},{int}"]]:(t,e)=>t,[o["the sheet list should be [{string}, {string}, {string}, {string}] in that order"]]:(t,e)=>{const s=m(t).getAllSheets().map(u=>u.title),r=[e.string0,e.string1,e.string2,e.string3];if(!(JSON.stringify(s)===JSON.stringify(r)))throw new Error(`Expected sheet list to be [${r.join(", ")}] in that order, but got [${s.join(", ")}]`);return t},[o["the sheet list should be [{string}, {string}, {string}, {string}]"]]:(t,e)=>{const s=m(t).getAllSheets().map(u=>u.title),r=[e.string0,e.string1,e.string2,e.string3];if(!(JSON.stringify(s)===JSON.stringify(r)))throw new Error(`Expected sheet list to be [${r.join(", ")}], but got [${s.join(", ")}]`);return t},[o["the sheet {string} should have a creation timestamp"]]:(t,e)=>t,[o["the timestamp should be recent"]]:t=>t,[o["I should get a unique identifier"]]:t=>{var n;const e=((n=t.lastResult)==null?void 0:n.sheetId)!==void 0;return t.lastResult={...t.lastResult,hasUniqueId:e},t},[o["the ID should not change across operations"]]:t=>t,[o["I should get the ID of sheet {string}"]]:(t,e)=>{const i=m(t).getSheet(e.string0);return t.lastResult={...t.lastResult,sheetId:i==null?void 0:i.id},t},[o["I should receive {string}"]]:(t,e)=>{var i;const n=((i=t.lastResult)==null?void 0:i.text)===e.string0;return t.lastResult={...t.lastResult,receivedCorrectText:n},t},[o["the old content {string} should not be present"]]:(t,e)=>t,[o["cell {int},{int} should contain {string}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1),s=(i==null?void 0:i.text)===e.string0;return t.lastResult={...t.lastResult,[`cellContent_${e.int0}_${e.int1}`]:i==null?void 0:i.text,matches:s},t},[o["all three cells should be empty"]]:t=>t,[o["cell {int},{int} should still contain {string}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1),s=(i==null?void 0:i.text)===e.string0;return t.lastResult={...t.lastResult,[`cellStillContains_${e.int0}_${e.int1}`]:s},t},[o["cell {int},{int} should be empty"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1),s=!i||!i.text;return t.lastResult={...t.lastResult,[`isEmpty_${e.int0}_${e.int1}`]:s},t},[o["I should receive {int} cells"]]:(t,e)=>{var s,r;const n=((r=(s=t.lastResult)==null?void 0:s.cells)==null?void 0:r.length)||0,i=n===e.int0;return t.lastResult={...t.lastResult,cellCount:n,countMatches:i},t},[o["their contents should be [{string}, {string}, {string}]"]]:(t,e)=>{var r;const n=((r=t.lastResult)==null?void 0:r.cells)||[],i=[e.string0,e.string1,e.string2],s=JSON.stringify(n)===JSON.stringify(i);return t.lastResult={...t.lastResult,contentsMatch:s},t},[o["all {int} cells in the range should be empty"]]:(t,e)=>t,[o["cell {int},{int} should contain exactly {string}"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1),s=(i==null?void 0:i.text)===e.string0;return t.lastResult={...t.lastResult,[`exactMatch_${e.int0}_${e.int1}`]:s},t},[o["the content should have {int} lines"]]:(t,e)=>t,[o["cell {int},{int} should contain all {int} characters"]]:(t,e)=>{var a;const i=m(t).getCell(e.int0,e.int1),s=((a=i==null?void 0:i.text)==null?void 0:a.length)||0,r=s===e.int2;return t.lastResult={...t.lastResult,[`charCount_${e.int0}_${e.int1}`]:s,lengthMatches:r},t},[o["cell {int},{int} should contain {string} with leading and trailing spaces"]]:(t,e)=>{const i=m(t).getCell(e.int0,e.int1),s=(i==null?void 0:i.text)===e.string0;return t.lastResult={...t.lastResult,[`preservesWhitespace_${e.int0}_${e.int1}`]:s},t},[o["I should receive a 2D array representation"]]:t=>{var n;const e=Array.isArray((n=t.lastResult)==null?void 0:n.contentMap);return t.lastResult={...t.lastResult,is2DArray:e},t},[o["empty cells should be represented appropriately"]]:t=>t,[o["I should receive only {string} content"]]:(t,e)=>t,[o["columns should be {int}"]]:(t,e)=>{var s,r;const i=((r=(s=t.lastResult)==null?void 0:s.dimensions)==null?void 0:r.cols)===e.int0;return t.lastResult={...t.lastResult,colsMatch:i},t},[o["rows should be {int}"]]:(t,e)=>{var s,r;const i=((r=(s=t.lastResult)==null?void 0:s.dimensions)==null?void 0:r.rows)===e.int0;return t.lastResult={...t.lastResult,rowsMatch:i},t},[o["the result should be true"]]:t=>{var n,i;const e=((n=t.lastResult)==null?void 0:n.isValid)===!0||((i=t.lastResult)==null?void 0:i.exists)===!0;return t.lastResult={...t.lastResult,resultIsTrue:e},t},[o["the result should be false"]]:t=>{var n,i;const e=((n=t.lastResult)==null?void 0:n.isValid)===!1||((i=t.lastResult)==null?void 0:i.exists)===!1;return t.lastResult={...t.lastResult,resultIsFalse:e},t},[o["I should receive null or undefined"]]:t=>{var n,i;const e=((n=t.lastResult)==null?void 0:n.cell)===null||((i=t.lastResult)==null?void 0:i.cell)===void 0;return t.lastResult={...t.lastResult,isNullOrUndefined:e},t},[o["the JSON should have correct sheet structure"]]:t=>t,[o["cell content should match exactly"]]:t=>t,[o["the CSV should be {string}"]]:(t,e)=>{var s;const i=((s=t.lastResult)==null?void 0:s.csv)===e.string0;return t.lastResult={...t.lastResult,csvMatches:i},t},[o["the JSON should represent empty content"]]:t=>t,[o["col should be {int}"]]:(t,e)=>t,[o["row should be {int}"]]:(t,e)=>t,[o["each cell should have a unique identifier"]]:t=>t,[o["identifiers should be stable across operations"]]:t=>t,[o["isDirty flag should be true"]]:t=>(t.lastResult={...t.lastResult,isDirty:!0},t),[o["the count should be {int}"]]:(t,e)=>{var s,r;const i=(((s=t.lastResult)==null?void 0:s.totalCells)||((r=t.lastResult)==null?void 0:r.nonEmptyCells)||0)===e.int0;return t.lastResult={...t.lastResult,countMatches:i},t},[o["the grid should have {int} sheet"]]:(t,e)=>{const i=m(t).getAllSheets();return t.lastResult={...t.lastResult,sheetCount:i.length},t}};function d(t){if(!t.gridFacade)throw new Error("[StepDefinitionsUI] Grid facade not initialized");return t.gridFacade}const kt={[g["a spreadsheet grid facade is initialized"]]:t=>t,[g["the grid has dimensions {int} columns by {int} rows"]]:(t,e)=>t,[g["each cell has a default width of 100px"]]:t=>t,[g["each column has a default width of 100px"]]:t=>t,[g["cell at column {int} row {int} contains {string}"]]:(t,e)=>(d(t).setCellText(e.int0,e.int1,e.string0),t),[g["cell at column {int} row {int} is empty"]]:(t,e)=>(d(t).clearCell(e.int0,e.int1),t),[g["cells at column {int}-{int} row {int} are empty"]]:(t,e)=>{const n=d(t);for(let i=e.int0;i<=e.int1;i++)n.clearCell(i,e.int2);return t},[g["I am editing cell at column {int} row {int}"]]:(t,e)=>(d(t).enterEditMode(e.int0,e.int1),t.lastEditedCell=[e.int0,e.int1],t),[g["I am editing the cell"]]:t=>(d(t).enterEditMode(0,0),t.lastEditedCell=[0,0],t),[g["I type {string}"]]:(t,e)=>(d(t).typeInEditMode(e.string0),t),[g["I type a very long text"]]:t=>{const e=d(t),n="A".repeat(300);return e.typeInEditMode(n),t.tempData||(t.tempData={}),t.tempData.veryLongText=n,t},[g["the cell content is {string}"]]:(t,e)=>{const n=d(t);if(!n.isInEditMode())throw new Error("Cannot set cell content: not in edit mode");const i=e.string0.replace(/\\n/g,`
`);return n.clearEditModeContent(),n.typeInEditMode(i),t},[g["the cell editor is in Visual Line mode"]]:t=>(d(t).enterVisualLineMode(),t),[g["lines {int} to {int} are selected"]]:(t,e)=>(d(t).setVisualLineSelection(e.int0,e.int1),t),[g["I have {string} in vim clipboard"]]:(t,e)=>{const n=d(t),i=e.string0.replace(/\\n/g,`
`);return n.setVimClipboard(i),t},[g["the cursor is at position indicated by |"]]:(t,e)=>{const n=d(t),i=e.string0,s=i.indexOf("|");if(s===-1)throw new Error("Cursor position marker | not found in content");const r=i.replace("|","");return n.clearEditModeContent(),n.typeInEditMode(r),n.setCursorPosition&&n.setCursorPosition(s),t},[g["the cursor is at the end"]]:t=>{const e=d(t),n=e.getEditingContent();return e.setCursorPosition&&e.setCursorPosition(n.length),t},[g["the cursor is at the start"]]:t=>{const e=d(t);return e.setCursorPosition&&e.setCursorPosition(0),t},[g["cell splitting is enabled"]]:t=>(t.tempData||(t.tempData={}),t.tempData.cellSplittingEnabled=!0,t),[g["column {int} has width 100px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,100),t),[g["column {int} has width 200px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,200),t),[g["column {int} has width 50px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,50),t),[g["column {int} contains cells with text of varying lengths"]]:(t,e)=>{const n=d(t);return n.setCellText(e.int0,0,"Short"),n.setCellText(e.int0,1,"Medium text"),n.setCellText(e.int0,2,"Very long content"),t},[g["the longest text is {string} at 120px"]]:(t,e)=>(t.tempData||(t.tempData={}),t.tempData.longestText=e.string0,t.tempData.longestTextWidth=120,t),[g["column {int} contains only short text"]]:(t,e)=>{const n=d(t);return n.setCellText(e.int0,0,"A"),n.setCellText(e.int0,1,"B"),n.setCellText(e.int0,2,"C"),t},[g["column {int} header is {string}"]]:(t,e)=>(t.tempData||(t.tempData={}),t.tempData.columnHeader=e.string0,t),[g["column {int} is completely empty"]]:(t,e)=>{const n=d(t),i=n.getDimensions();for(let s=0;s<i.rows;s++)n.clearCell(e.int0,s);return t},[g["column {int} contains very long text of 600px"]]:(t,e)=>{const n=d(t),i="A".repeat(75);return n.setCellText(e.int0,0,i),t},[g["cell at column {int} row {int} is at position x={int}"]]:(t,e)=>(t.tempData||(t.tempData={}),t.tempData.expectedPosition=e.int2,t),[g["the grid has total width 1000px ({int} columns x 100px)"]]:(t,e)=>(t.tempData||(t.tempData={}),t.tempData.initialGridWidth=1e3,t),[g["column {int} row {int} contains {string}"]]:(t,e)=>(d(t).setCellText(e.int0,e.int1,e.string0),t),[g["the text is truncated"]]:t=>t,[g["columns {int}-{int} row {int} are all empty"]]:(t,e)=>{const n=d(t);for(let i=e.int0;i<=e.int1;i++)n.clearCell(i,e.int2);return t},[g["the text overflows into column {int} row {int}"]]:(t,e)=>t,[g["the cell has expanded to 300px"]]:t=>(t.tempData||(t.tempData={}),t.tempData.expandedWidth=300,t),[g["the cell editor is in Insert mode"]]:t=>(d(t).setVimMode("insert"),t),[g["the cell editor is in Normal mode"]]:t=>(d(t).setVimMode("normal"),t),[g["the cursor is on line {int}"]]:(t,e)=>(d(t).setCursorLine(e.int0),t)},$t={[h["I double-click cell at column {int} row {int}"]]:(t,e)=>(d(t).enterEditMode(e.int0,e.int1),t.lastEditedCell=[e.int0,e.int1],t),[h["I click cell at column {int} row {int}"]]:(t,e)=>{const n=d(t);return n.isInEditMode()&&n.exitEditMode(!0),n.setCurrentPosition([e.int0,e.int1]),t},[h["I type {string}"]]:(t,e)=>(d(t).typeInEditMode(e.string0),t),[h["I press Enter"]]:t=>(d(t).pressEnterInEditMode(),t),[h["I exit the cell"]]:t=>(d(t).exitEditMode(!0),t),[h["I press Enter to save"]]:t=>(d(t).pressEnterInEditMode(),t),[h["I click outside the cell"]]:t=>(d(t).exitEditMode(!0),t),[h["I press Escape"]]:t=>(d(t).pressEscapeInEditMode(),t),[h["I press o"]]:t=>(d(t).openLineBelow(),t),[h["I press O"]]:t=>(d(t).openLineAbove(),t),[h["I press p"]]:t=>{const e=d(t),n=e.getVimClipboard();return e.pasteAfterCursor(n),t},[h["I press P"]]:t=>{const e=d(t),n=e.getVimClipboard();return e.pasteBeforeCursor(n),t},[h["I press dd"]]:t=>(d(t).deleteCurrentLine(),t),[h["I press yy"]]:t=>(d(t).yankCurrentLine(),t),[h["I delete line {int}"]]:(t,e)=>(d(t).deleteLine(e.int0),t),[h["I delete {int} lines in Normal mode"]]:(t,e)=>(d(t).deleteMultipleLines(e.int0),t),[h["I move to line {int}"]]:(t,e)=>(d(t).moveToLine(e.int0),t),[h["I press V"]]:t=>(d(t).enterVisualLineMode(),t),[h["I press d"]]:t=>{const e=d(t);return e.isInVisualMode&&e.isInVisualMode()&&e.deleteVisualSelection(),t},[h["I press y"]]:t=>{const e=d(t);return e.isInVisualMode&&e.isInVisualMode()&&e.yankVisualSelection(),t},[h["I select all text"]]:t=>(d(t),t),[h["I delete all text"]]:t=>(d(t).clearEditModeContent(),t),[h["I type {int} characters of text"]]:(t,e)=>{const n=d(t),i="A".repeat(e.int0);return n.typeInEditMode(i),t.tempData||(t.tempData={}),t.tempData[`longText${e.int0}`]=i,t},[h["I type additional text {string}"]]:(t,e)=>(d(t).appendInEditMode(e.string0),t),[h["I press 'h' key"]]:t=>(d(t).appendInEditMode("h"),t),[h["I drag the right border of column {int} by 50px"]]:(t,e)=>(d(t).resizeColumn(e.int0,50),t),[h["I drag the right border of column {int} by -80px"]]:(t,e)=>(d(t).resizeColumn(e.int0,-80),t),[h["I resize column {int} to 150px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,150),t),[h["I resize column {int} to 80px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,80),t),[h["I resize column {int} to 200px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,200),t),[h["I resize column {int} to 50px"]]:(t,e)=>(d(t).setColumnWidth(e.int0,50),t),[h["I double-click the right border of column {int}"]]:(t,e)=>(d(t).autoFitColumn(e.int0),t),[h["I hover over the right border of column {int} header"]]:(t,e)=>t,[h["I start dragging the right border of column {int}"]]:(t,e)=>t,[h["I view the grid"]]:t=>t,[h["I calculate colsToNextText for cell {int},{int}"]]:(t,e)=>{const i=d(t).calculateColsToNextText(e.int0,e.int1);return t.tempData||(t.tempData={}),t.tempData.colsToNextText=i,t},[h["I click on the overflowed portion in column {int}"]]:(t,e)=>(d(t).setCurrentPosition([e.int0,0]),t),[h["I press Ctrl+Enter"]]:t=>(d(t).pressCtrlEnterInEditMode(),t),[h["I type {string} and press Enter"]]:(t,e)=>{const n=d(t);return n.typeInEditMode(e.string0),n.pressEnterInEditMode(),t},[h["I press Down arrow in Normal mode"]]:t=>(d(t).moveCursorDown(),t),[h["I press Up arrow in Normal mode"]]:t=>(d(t).moveCursorUp(),t),[h["I press j"]]:t=>(d(t).moveCursorDown(),t),[h["I press k"]]:t=>(d(t).moveCursorUp(),t),[h["I press gg in Normal mode"]]:t=>(d(t).setCursorLine(0),t),[h["I press G in Normal mode"]]:t=>{const e=d(t),n=e.getLineCount();return e.setCursorLine(n-1),t},[h["I press dd in Normal mode"]]:t=>(d(t).deleteCurrentLine(),t),[h["I press yy in Normal mode"]]:t=>{const n=d(t).yankCurrentLine();return t.tempData||(t.tempData={}),t.tempData.yankedLine=n,t}},Vt={[o["the cell should enter edit mode"]]:t=>{if(!d(t).isInEditMode())throw new Error("Cell is not in edit mode");return t},[o["a textarea should be displayed"]]:t=>{if(!d(t).isInEditMode())throw new Error("Textarea not displayed (edit mode not active)");return t},[o["the textarea should contain {string}"]]:(t,e)=>{const i=d(t).getEditingContent();if(i!==e.string0)throw new Error(`Textarea contains "${i}", expected "${e.string0}"`);return t},[o["the textarea should be focused"]]:t=>{if(!d(t).isInEditMode())throw new Error("Textarea not focused (edit mode not active)");return t},[o["the cell should be selected"]]:t=>{if(!d(t).getCurrentPosition())throw new Error("No cell is selected");return t},[o["the cell should not enter edit mode"]]:t=>{if(d(t).isInEditMode())throw new Error("Cell should not be in edit mode");return t},[o["no textarea should be displayed"]]:t=>{if(d(t).isInEditMode())throw new Error("Textarea should not be displayed");return t},[o["the textarea should be empty"]]:t=>{const n=d(t).getEditingContent();if(n!=="")throw new Error(`Textarea is not empty, contains: "${n}"`);return t},[o["I should be able to type immediately"]]:t=>{if(!d(t).isInEditMode())throw new Error("Cannot type - not in edit mode");return t},[o["the cell should contain {string}"]]:(t,e)=>{var u;const n=d(t),i=n.getEditingCell()||t.lastEditedCell;if(!i)throw new Error("No cell is being edited or was last edited");const[s,r]=i,a=n.isInEditMode()&&n.getEditingCell()?n.getEditingContent():((u=n.getCell(s,r))==null?void 0:u.text)||"";if(a!==e.string0)throw new Error(`Cell contains "${a}", expected "${e.string0}"`);return t},[o["the cell should exit edit mode"]]:t=>{if(d(t).isInEditMode())throw new Error("Cell should have exited edit mode");return t},[o["the active cell should move to column {int} row {int}"]]:(t,e)=>{const n=d(t),[i,s]=n.getCurrentPosition();if(i!==e.int0||s!==e.int1)throw new Error(`Active cell is at [${i}, ${s}], expected [${e.int0}, ${e.int1}]`);return t},[o["the changes should be discarded"]]:t=>t,[o["the textarea should display {string}"]]:(t,e)=>{const i=d(t).getEditingContent();if(i!==e.string0)throw new Error(`Textarea displays "${i}", expected "${e.string0}"`);return t},[o["the textarea should contain 'h'"]]:t=>{const n=d(t).getEditingContent();if(n!=="h")throw new Error(`Textarea contains "${n}", expected "h"`);return t},[o["the textarea should have rows={int}"]]:(t,e)=>{if(e.int0!==1)throw new Error(`Expected rows=${e.int0}, but facade only supports single-row`);return t},[o["the text should be visible as I type"]]:t=>t,[o["cell {int},{int} should save and exit edit mode"]]:(t,e)=>{if(d(t).isInEditMode())throw new Error("Cell should have exited edit mode");return t},[o["cell {int},{int} should be selected"]]:(t,e)=>{const n=d(t),[i,s]=n.getCurrentPosition();if(i!==e.int0||s!==e.int1)throw new Error(`Cell [${i}, ${s}] is selected, expected [${e.int0}, ${e.int1}]`);return t},[o["only one cell should be in edit mode at a time"]]:t=>(d(t).getEditingCell(),t),[o["vim navigation should not be triggered"]]:t=>{if(!d(t).isInEditMode())throw new Error("Should still be in edit mode");return t},[o["the active cell should not move"]]:t=>t,[o["the cell should be empty"]]:t=>{const n=d(t).getCell(0,0);if(n&&n.text)throw new Error(`Cell is not empty, contains: "${n.text}"`);return t},[o["the cell should display nothing"]]:t=>t,[o["the cell should contain all {int} characters"]]:(t,e)=>{var u;const n=d(t),i=n.getEditingCell()||t.lastEditedCell||[0,0],[s,r]=i,a=n.isInEditMode()&&n.getEditingCell()?n.getEditingContent():((u=n.getCell(s,r))==null?void 0:u.text)||"";if(a.length!==e.int0)throw new Error(`Cell contains ${a.length} characters, expected ${e.int0}`);return t},[o["the text should overflow if needed"]]:t=>t,[o["the cell should have a blue selection ring"]]:t=>{if(!d(t).isInEditMode())throw new Error("Edit mode not active (no selection ring)");return t},[o["the ring should have z-index priority"]]:t=>t,[o["the textarea width should match content width"]]:t=>t,[o["the textarea should expand horizontally"]]:t=>t,[o["the textarea should auto-resize"]]:t=>t,[o["the textarea should have rows=1"]]:t=>t,[o["the textarea should not wrap to new lines"]]:t=>t,[o["overflow should extend horizontally"]]:t=>t,[o["column {int} should have width 150px"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i!==150)throw new Error(`Column ${e.int0} has width ${i}px, expected 150px`);return t},[o["column {int} should have width 30px"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i!==30)throw new Error(`Column ${e.int0} has width ${i}px, expected 30px`);return t},[o["column {int} should have width 80px"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i!==80)throw new Error(`Column ${e.int0} has width ${i}px, expected 80px`);return t},[o["all cells in column {int} should have width 150px"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i!==150)throw new Error(`Column ${e.int0} width is ${i}px, expected 150px`);return t},[o["the column should not be smaller than 30px"]]:t=>t,[o["other columns should remain at 100px"]]:t=>{const n=d(t).getColumnWidth(2);if(n!==100)throw new Error(`Column 2 has width ${n}px, expected 100px`);return t},[o["column {int} should resize to fit the longest content"]]:(t,e)=>{if(d(t).getColumnWidth(e.int0)===100)throw new Error("Column should have resized to fit content");return t},[o["column {int} width should be approximately 128px (text + padding)"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i<110||i>160)throw new Error(`Column width is ${i}px, expected approximately 128px (range 110-160)`);return t},[o["column {int} should resize to fit the header width"]]:(t,e)=>t,[o["the width should accommodate the header text"]]:t=>t,[o["column {int} should have minimum width of 40px"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i<30)throw new Error(`Column width ${i}px is below minimum`);return t},[o["column {int} should have maximum width of 500px"]]:(t,e)=>{const i=d(t).getColumnWidth(e.int0);if(i!==500)throw new Error(`Column width is ${i}px, expected 500px (max)`);return t},[o["the text should overflow or wrap"]]:t=>t,[o["cell at column {int} row {int} should be at position x={int}"]]:(t,e)=>{const n=d(t);let i=0;for(let s=0;s<e.int0;s++)i+=n.getColumnWidth(s);if(i!==e.int2)throw new Error(`Cell position is x=${i}, expected x=${e.int2}`);return t},[o["all cells in column {int} should shift right by 50px"]]:(t,e)=>t,[o["the grid total width should be 1100px"]]:t=>{const e=d(t),n=10;let i=0;for(let s=0;s<n;s++)i+=e.getColumnWidth(s);if(i!==1100)throw new Error(`Grid total width is ${i}px, expected 1100px`);return t},[o["cell at column {int} row {int} should still contain {string}"]]:(t,e)=>{const i=d(t).getCell(e.int0,e.int1);if((i==null?void 0:i.text)!==e.string0)throw new Error(`Cell contains "${i==null?void 0:i.text}", expected "${e.string0}"`);return t},[o["the cursor should change to col-resize"]]:t=>t,[o["the border should highlight"]]:t=>t,[o["the column header should have a highlighted background"]]:t=>t,[o["the drag operation should be visually indicated"]]:t=>t,[o["the full text should be visible"]]:t=>t,[o["no overflow should occur"]]:t=>t,[o["the text should overflow into column {int}"]]:(t,e)=>{if(!d(t).getCellOverflowInfo(0,0).overflows)throw new Error("Text should overflow but does not");return t},[o["column {int} should be empty"]]:(t,e)=>{const i=d(t).getCell(e.int0,0);if(i&&i.text)throw new Error(`Column ${e.int0} is not empty`);return t},[o["the text from cell {int},{int} should overflow into cell {int},{int}"]]:(t,e)=>{if(!d(t).getCellOverflowInfo(e.int0,e.int1).overflows)throw new Error(`Cell [${e.int0}, ${e.int1}] does not overflow`);return t},[o["the overflow should be visually displayed"]]:t=>t,[o["the text from cell {int},{int} should be truncated"]]:(t,e)=>{if(d(t).getCellOverflowInfo(e.int0,e.int1).colsToNextText===0)throw new Error("Text is not truncated");return t},[o["the overflow should not extend beyond cell {int},{int} width"]]:(t,e)=>t,[o["the text should overflow across columns {int}, {int}, and {int}"]]:(t,e)=>{const i=d(t).getCellOverflowInfo(0,0);return i.colsToNextText===0||i.colsToNextText<3,t},[o["the overflow should stop at column {int}"]]:(t,e)=>t,[o["the text should overflow only into column {int}"]]:(t,e)=>{const i=d(t).getCellOverflowInfo(0,0);if(i.colsToNextText!==2)throw new Error(`Overflow extends to ${i.colsToNextText} columns`);return t},[o["the overflow should not overlap with column {int} content"]]:(t,e)=>t,[o["the cell should expand horizontally to fit the content"]]:t=>t,[o["the cell should use auto-expanding textarea"]]:t=>t,[o["the cell width should match the text width plus padding"]]:t=>t,[o["the minimum width should be the default cell width"]]:t=>t,[o["the cell should return to 100px width"]]:t=>{const n=d(t).getColumnWidth(0);if(n!==100)throw new Error(`Column width is ${n}px, expected 100px`);return t},[o["the text should overflow into adjacent cells if empty"]]:t=>t,[o["colsToNextText should be {int}"]]:(t,e)=>{var i;const n=(i=t.tempData)==null?void 0:i.colsToNextText;if(n!==e.int0)throw new Error(`colsToNextText is ${n}, expected ${e.int0}`);return t},[o["the cell should allow unlimited overflow"]]:t=>{var n;const e=(n=t.tempData)==null?void 0:n.colsToNextText;if(e!==0)throw new Error(`colsToNextText should be 0 (unlimited), got ${e}`);return t},[o["overflow should be prevented"]]:t=>t,[o["overflow should be limited to {int} cells width"]]:(t,e)=>{var i;const n=(i=t.tempData)==null?void 0:i.colsToNextText;if(n!==e.int0)throw new Error(`Overflow limited to ${n} cells, expected ${e.int0}`);return t},[o["cell at column {int} row {int} should not be selected"]]:(t,e)=>{const n=d(t),[i,s]=n.getCurrentPosition();if(i===e.int0&&s===e.int1)throw new Error(`Cell [${i}, ${s}] should not be selected`);return t},[o["cell at column {int} row {int} should be selected"]]:(t,e)=>{const n=d(t),[i,s]=n.getCurrentPosition();if(i!==e.int0||s!==e.int1)throw new Error(`Cell [${i}, ${s}] is selected, expected [${e.int0}, ${e.int1}]`);return t},[o["pointer-events-none prevents overflow click capture"]]:t=>t,[o["the selection ring should be visible"]]:t=>t,[o["the overflow text should remain visible"]]:t=>t,[o["the cursor should be on line {int}"]]:(t,e)=>{const i=d(t).getCursorLine();if(i!==e.int0)throw new Error(`Cursor is on line ${i}, expected line ${e.int0}`);return t},[o["the cell should be saved"]]:t=>{if(d(t).isInEditMode())throw new Error("Cell should be saved and exited from edit mode");return t},[o["the cell content should be {string}"]]:(t,e)=>{var c;const n=d(t),i=n.getEditingCell()||t.lastEditedCell;if(!i)throw new Error("No cell is being edited or was last edited");const[s,r]=i,a=n.isInEditMode()&&n.getEditingCell()?n.getEditingContent():((c=n.getCell(s,r))==null?void 0:c.text)||"",u=e.string0.replace(/\\n/g,`
`);if(a!==u)throw new Error(`Cell contains "${a}", expected "${u}"`);return t},[o["cell at column {int} row {int} should contain {string}"]]:(t,e)=>{const i=d(t).getCell(e.int0,e.int1),s=e.string0.replace(/\\n/g,`
`);if((i==null?void 0:i.text)!==s)throw new Error(`Cell at column ${e.int0} row ${e.int1} contains "${(i==null?void 0:i.text)||""}", expected "${s}"`);return t},[o["cell at column {int} row {int} should be empty"]]:(t,e)=>{const i=d(t).getCell(e.int0,e.int1);if(i!=null&&i.text)throw new Error(`Cell at column ${e.int0} row ${e.int1} should be empty, but contains "${i.text}"`);return t},[o["the cell editor should be in Visual Line mode"]]:t=>{const e=d(t);if(!e.isInVisualMode||!e.isInVisualMode())throw new Error("Cell editor should be in Visual Line mode");return t},[o["the entire line {int} should be selected"]]:(t,e)=>{const i=d(t).getVisualLineSelection();if(!i||i.startLine!==e.int0||i.endLine!==e.int0)throw new Error(`Line ${e.int0} should be selected`);return t},[o["lines {int} to {int} should be in vim clipboard"]]:(t,e)=>{const i=d(t).getVimClipboard();if(t.tempData||(t.tempData={}),t.tempData.expectedClipboardLines={start:e.int0,end:e.int1},!i)throw new Error("Vim clipboard should contain yanked lines");return t},[o["the cursor should be on the new line"]]:t=>{const e=d(t);t.tempData||(t.tempData={});const n=t.tempData.previousCursorLine||0,i=e.getCursorLine?e.getCursorLine():0;if(i!==n+1)throw new Error(`Cursor should be on line ${n+1}, but is on line ${i}`);return t},[o["the cursor should remain visible"]]:t=>{const e=d(t);if(e.getCursorPosition){const n=e.getCursorPosition(),i=e.getEditingContent();if(n<0||n>i.length)throw new Error("Cursor position is out of bounds")}return t},[o["the cell editor should be closed"]]:t=>{if(d(t).isInEditMode())throw new Error("Cell editor should be closed");return t},[o["the active cell should be at column {int} row {int}"]]:(t,e)=>{const i=d(t).getCurrentPosition();if(i[0]!==e.int0||i[1]!==e.int1)throw new Error(`Active cell should be at column ${e.int0} row ${e.int1}, but is at ${i[0]},${i[1]}`);return t},[o["no cell splitting should occur"]]:t=>(t.tempData||(t.tempData={}),t.tempData.noCellSplitting=!0,t),[o["the cell should display {string}"]]:(t,e)=>{const i=d(t).getEditingContent(),s=e.string0.replace(/\\n/g,`
`);if(i!==s)throw new Error(`Cell should display "${s}", but displays "${i}"`);return t},[o["the cell should show {int} lines"]]:(t,e)=>{const s=d(t).getEditingContent().split(`
`).length;if(s!==e.int0)throw new Error(`Cell should show ${e.int0} lines, but shows ${s}`);return t},[o["the cell should wrap text"]]:t=>(t.tempData||(t.tempData={}),t.tempData.textWrappingEnabled=!0,t),[o["the cell should not wrap text"]]:t=>(t.tempData||(t.tempData={}),t.tempData.textWrappingEnabled=!1,t),[o["each line should be independently scrollable"]]:t=>(t.tempData||(t.tempData={}),t.tempData.independentScrolling=!0,t),[o["long text should scroll horizontally"]]:t=>(t.tempData||(t.tempData={}),t.tempData.horizontalScrolling=!0,t),[o["the cell height should adjust to content"]]:t=>(t.tempData||(t.tempData={}),t.tempData.autoHeightAdjust=!0,t),[o["all lines should remain visible"]]:t=>{const i=d(t).getEditingContent().split(`
`);return t.tempData||(t.tempData={}),t.tempData.visibleLines=i.length,t},[o["an overflow indicator should appear on the right"]]:t=>(t.tempData||(t.tempData={}),t.tempData.overflowIndicatorRight=!0,t),[o["an overflow indicator should appear on the bottom"]]:t=>(t.tempData||(t.tempData={}),t.tempData.overflowIndicatorBottom=!0,t),[o["overflow indicators should appear"]]:t=>(t.tempData||(t.tempData={}),t.tempData.overflowIndicators=!0,t),[o["the cell editor should expand vertically"]]:t=>(t.tempData||(t.tempData={}),t.tempData.verticalExpansion=!0,t),[o["the cell should remain single-line"]]:t=>{const i=d(t).getEditingContent().split(`
`).length;if(i>1)throw new Error(`Cell should remain single-line, but has ${i} lines`);return t},[o["the cell editor should be in Insert mode"]]:t=>{const n=d(t).getVimMode();if(n!=="insert")throw new Error(`Cell editor should be in Insert mode, but is in ${n} mode`);return t},[o["the cell editor should be in Normal mode"]]:t=>{const n=d(t).getVimMode();if(n!=="normal")throw new Error(`Cell editor should be in Normal mode, but is in ${n} mode`);return t},[o["the cell content should not change"]]:t=>{const e=d(t);if(!t.tempData||!t.tempData.previousContent)t.tempData||(t.tempData={}),t.tempData.previousContent=e.getEditingContent();else if(e.getEditingContent()!==t.tempData.previousContent)throw new Error("Cell content should not have changed");return t},[o["the cell should show a cursor"]]:t=>{if(!d(t).isInEditMode())throw new Error("Cell should show a cursor (must be in edit mode)");return t},[o["line {int} should contain {string}"]]:(t,e)=>{const s=d(t).getEditingContent().split(`
`);if(e.int0<0||e.int0>=s.length)throw new Error(`Line ${e.int0} does not exist`);const r=e.string0.replace(/\\n/g,`
`);if(s[e.int0]!==r)throw new Error(`Line ${e.int0} should contain "${r}", but contains "${s[e.int0]}"`);return t},[o["the vim clipboard should contain {string}"]]:(t,e)=>{const i=d(t).getVimClipboard(),s=e.string0.replace(/\\n/g,`
`);if(i!==s)throw new Error(`Vim clipboard should contain "${s}", but contains "${i}"`);return t},[o["the vim clipboard should be empty"]]:t=>{const n=d(t).getVimClipboard();if(n)throw new Error(`Vim clipboard should be empty, but contains "${n}"`);return t},[o["line {int} should be empty"]]:(t,e)=>{const s=d(t).getEditingContent().split(`
`);if(e.int0<0||e.int0>=s.length)throw new Error(`Line ${e.int0} does not exist`);if(s[e.int0]!=="")throw new Error(`Line ${e.int0} should be empty, but contains "${s[e.int0]}"`);return t},[o["the cell should contain {int} lines"]]:(t,e)=>{const s=d(t).getEditingContent().split(`
`).length;if(s!==e.int0)throw new Error(`Cell should contain ${e.int0} lines, but contains ${s}`);return t},[o["line {int} should be selected"]]:(t,e)=>{const i=d(t).getVisualLineSelection();if(!i||i.startLine!==e.int0||i.endLine!==e.int0)throw new Error(`Line ${e.int0} should be selected`);return t},[o["lines {int} to {int} should be selected"]]:(t,e)=>{const i=d(t).getVisualLineSelection(),s=Math.min(e.int0,e.int1),r=Math.max(e.int0,e.int1);if(!i||i.startLine!==s||i.endLine!==r)throw new Error(`Lines ${s} to ${r} should be selected`);return t},[o["the content should be {string}"]]:(t,e)=>{const i=d(t).getEditingContent(),s=e.string0.replace(/\\n/g,`
`);if(i!==s)throw new Error(`Content should be "${s}", but is "${i}"`);return t},[o["there should be {int} lines"]]:(t,e)=>{const s=d(t).getEditingContent().split(`
`).length;if(s!==e.int0)throw new Error(`There should be ${e.int0} lines, but there are ${s}`);return t},[o["the cell should be empty"]]:t=>{const n=d(t).getEditingContent();if(n)throw new Error(`Cell should be empty, but contains "${n}"`);return t}};function z(t){if(!t.gridFacade)throw new Error("[StepDefinitionsVim] Grid facade not initialized");return t.gridFacade}function De(t){return{h:f.cursorLeft,j:f.cursorDown,k:f.cursorUp,l:f.cursorRight,w:f.wordForward,b:f.wordBackward,e:f.wordEnd,0:f.lineStart,$:f.lineEnd,"^":f.firstNonWhitespace,gg:f.documentStart,G:f.documentEnd,"{":f.blockUp,"}":f.blockDown,dd:f.delete,cc:f.clearCell,J:f.joinLines,yy:f.yank,p:f.pasteVim,P:f.pasteVimBefore,i:f.enterInsert,v:f.enterVisual,Esc:f.exitMode,dw:f.delete,d$:f.delete,u:f.exitMode,"Ctrl+r":f.exitMode}[t]||null}function Re(t){const e=t.match(/^(\d+)(.+)$/);if(e){const i=parseInt(e[1],10),s=e[2],r=De(s);return s==="G"?r?{command:r,count:1,lineNumber:i}:null:r?{command:r,count:i}:null}const n=De(t);return n?{command:n,count:1}:null}const Wt={[g["a spreadsheet grid facade is initialized"]]:t=>t,[g["the grid has dimensions {int} columns by {int} rows"]]:(t,e)=>t,[g["cell at column {int} row {int} contains {string}"]]:(t,e)=>(z(t).setCellText(e.int0,e.int1,e.string0),t),[g["the active cell is at column {int} row {int}"]]:(t,e)=>{const n=z(t),i=[e.int0,e.int1];return n.setCurrentPosition(i),t.selectionFacade&&t.selectionFacade.setActiveCell(i),t},[g["cell at column {int} row {int} is empty"]]:(t,e)=>(z(t).clearCell(e.int0,e.int1),t),[g["the vim clipboard contains {string}"]]:(t,e)=>(t.vimClipboard=e.string0,t),[g["the cell is in edit mode"]]:t=>{const e=z(t),[n,i]=e.getCurrentPosition();return e.enterEditMode(n,i),t}},we={[h["I press vim command {string}"]]:(t,e)=>{var b,v;const n=z(t);if(e.string0==="u")return n.undo(),t;if(e.string0==="Ctrl+r")return n.redo(),t;if(e.string0==="dw"){const[p,S]=n.getCurrentPosition(),C=n.getCell(p,S);if(C!=null&&C.text){const M=C.text.trim().split(/\s+/).slice(1).join(" ");n.setCellText(p,S,M)}return t.tempData||(t.tempData={}),t.tempData.lastCommand=e.string0,t}if(e.string0.startsWith("/")||e.string0.startsWith("?")){const p=e.string0.substring(1),S=e.string0.startsWith("/"),[C,L]=n.getCurrentPosition(),M=n.getDimensions();let R=!1;if(S)for(let T=L;T<M.rows&&!R;T++){const W=T===L?C:0;for(let A=W;A<M.cols&&!R;A++){const P=n.getCell(A,T);P!=null&&P.text&&P.text.includes(p)&&(n.setCurrentPosition([A,T]),t.selectionFacade&&t.selectionFacade.setActiveCell([A,T]),R=!0)}}else for(let T=L;T>=0&&!R;T--){const W=T===L?C-1:M.cols-1;for(let A=W;A>=0&&!R;A--){const P=n.getCell(A,T);P!=null&&P.text&&P.text.includes(p)&&(n.setCurrentPosition([A,T]),t.selectionFacade&&t.selectionFacade.setActiveCell([A,T]),R=!0)}}return t.tempData||(t.tempData={}),t.tempData.lastSearch={term:p,forward:S,startPos:[C,L]},t}if(e.string0===".")return(b=t.tempData)!=null&&b.lastCommand&&Re(t.tempData.lastCommand)?we[h["I press vim command {string}"]](t,{string0:t.tempData.lastCommand}):t;const i=Re(e.string0);if(!i)throw new Error(`Unknown vim command: "${e.string0}"`);const{command:s,count:r,lineNumber:a}=i,u=[f.cursorLeft,f.cursorRight,f.cursorUp,f.cursorDown,f.wordForward,f.wordBackward,f.wordEnd,f.lineStart,f.lineEnd,f.firstNonWhitespace,f.documentStart,f.documentEnd,f.blockUp,f.blockDown],c=[f.delete,f.clearCell,f.joinLines,f.yank,f.pasteVim,f.pasteVimBefore];if(u.includes(s)){for(let p=0;p<r;p++)n.navigateVim(s,void 0,a);if(t.selectionFacade){const p=n.getCurrentPosition();t.selectionFacade.setActiveCell(p)}}else if(c.includes(s)){if((s===f.pasteVim||s===f.pasteVimBefore)&&t.vimClipboard){const p=n.vimEdit;p&&p.setClipboard&&p.setClipboard([[t.vimClipboard]])}if(n.executeVimEdit(s),s===f.yank){const[p,S]=n.getCurrentPosition(),C=n.getCell(p,S);t.vimClipboard=(C==null?void 0:C.text)||""}if(s===f.clearCell){const[p,S]=n.getCurrentPosition();n.enterEditMode(p,S),n.setVimMode("insert")}t.tempData||(t.tempData={}),t.tempData.lastCommand=e.string0}else if(s===f.enterInsert){const[p,S]=n.getCurrentPosition();n.enterEditMode(p,S),n.setVimMode("insert")}else s===f.enterVisual?(t.tempData||(t.tempData={}),t.tempData.visualMode=!0):s===f.exitMode&&(n.isInEditMode()&&n.pressEscapeInEditMode(),(v=t.tempData)!=null&&v.visualMode&&(t.tempData.visualMode=!1));return t},[h["I press n"]]:t=>{var b;const e=z(t),n=(b=t.tempData)==null?void 0:b.lastSearch;if(!n)return t;const{term:i,forward:s}=n,[r,a]=e.getCurrentPosition(),u=e.getDimensions();let c=!1;if(s)for(let v=a;v<u.rows&&!c;v++){const p=v===a?r+1:0;for(let S=p;S<u.cols&&!c;S++){const C=e.getCell(S,v);C!=null&&C.text&&C.text.includes(i)&&(e.setCurrentPosition([S,v]),t.selectionFacade&&t.selectionFacade.setActiveCell([S,v]),c=!0)}}else for(let v=a;v>=0&&!c;v--){const p=v===a?r-1:u.cols-1;for(let S=p;S>=0&&!c;S--){const C=e.getCell(S,v);C!=null&&C.text&&C.text.includes(i)&&(e.setCurrentPosition([S,v]),t.selectionFacade&&t.selectionFacade.setActiveCell([S,v]),c=!0)}}return t},[h["I press N"]]:t=>{var S;const e=z(t),n=(S=t.tempData)==null?void 0:S.lastSearch;if(!n)return t;const{term:i,forward:s,startPos:r}=n,[a,u]=e.getCurrentPosition(),c=e.getDimensions(),[b,v]=r||[a,u];let p=!1;if(s)for(let C=u;C>=0&&!p;C--){const L=C===u?a-1:c.cols-1;for(let M=L;M>=0&&!p;M--){const R=e.getCell(M,C);R!=null&&R.text&&R.text.includes(i)&&(e.setCurrentPosition([M,C]),t.selectionFacade&&t.selectionFacade.setActiveCell([M,C]),p=!0)}}else for(let C=u;C<c.rows&&!p;C++){const L=C===u?a+1:0;for(let M=L;M<c.cols&&!p;M++){if(M===b&&C===v)continue;const R=e.getCell(M,C);R!=null&&R.text&&R.text.includes(i)&&(e.setCurrentPosition([M,C]),t.selectionFacade&&t.selectionFacade.setActiveCell([M,C]),p=!0)}}return t},[h["I move to column {int} row {int}"]]:(t,e)=>{const n=z(t),i=[e.int0,e.int1];return n.setCurrentPosition(i),t.selectionFacade&&t.selectionFacade.setActiveCell(i),t},[h["I clear cell at column {int} row {int}"]]:(t,e)=>(z(t).clearCell(e.int0,e.int1),t)},Ft={[o["the active cell should be at column {int} row {int}"]]:(t,e)=>{const n=z(t),[i,s]=n.getCurrentPosition();if(i!==e.int0||s!==e.int1)throw new Error(`Active cell is at column ${i} row ${s}, expected column ${e.int0} row ${e.int1}`);return t},[o["cell at column {int} row {int} should be empty"]]:(t,e)=>{const i=z(t).getCell(e.int0,e.int1);if(i&&i.text)throw new Error(`Cell at column ${e.int0} row ${e.int1} is not empty, contains: "${i.text}"`);return t},[o["cell at column {int} row {int} should contain {string}"]]:(t,e)=>{var a;const n=z(t),i=n.getEditingCell(),r=i&&i[0]===e.int0&&i[1]===e.int1&&n.isInEditMode()?n.getEditingContent():((a=n.getCell(e.int0,e.int1))==null?void 0:a.text)||"";if(r!==e.string0)throw new Error(`Cell at column ${e.int0} row ${e.int1} contains "${r}", expected "${e.string0}"`);return t},[o["the vim clipboard should contain {string}"]]:(t,e)=>{if(t.vimClipboard!==e.string0)throw new Error(`Vim clipboard contains "${t.vimClipboard||""}", expected "${e.string0}"`);return t},[o["visual mode should be active"]]:t=>{var e;if(!((e=t.tempData)!=null&&e.visualMode))throw new Error("Visual mode is not active");return t},[o["the cell should be in edit mode"]]:t=>{if(!z(t).isInEditMode())throw new Error("Cell is not in edit mode");return t},[o["the cell should not be in edit mode"]]:t=>{if(z(t).isInEditMode())throw new Error("Cell should not be in edit mode");return t},[o["the cell editor should be in Insert mode"]]:t=>{if(!z(t).isInInsertMode())throw new Error("Cell editor is not in Insert mode");return t}};({...we});const he=new Je;he.register("grid-selection",{features:["Single Cell Selection","Range Selection","Selection Queries","Keyboard Selection","Row and Column Selection"],createContext:t=>({facade:t.selection}),stepDefinitions:{...Tt,...Dt,...Rt}});he.register("extended",{features:["Undo and Redo Operations","Sheet Management","Grid Data Operations"],createContext:t=>({gridFacade:t.grid,selectionFacade:t.selection}),stepDefinitions:{...Nt,...At,...jt}});he.register("ui",{features:["Basic Cell Editing","Column Resizing","Cell Content Overflow","Multi-line Cell Editing"],createContext:t=>({gridFacade:t.grid,selectionFacade:t.selection}),stepDefinitions:{...kt,...$t,...Vt}});he.register("vim",{features:["Vim Motions and Commands"],createContext:t=>({gridFacade:t.grid,selectionFacade:t.selection}),stepDefinitions:{...Wt,...we,...Ft}});function Pt({gridFacade:t,selectionFacade:e}){return l.jsx(Ke,{config:{registry:he,features:[...Mt],facades:{grid:t,selection:e},enableStepByStep:!0},storageKey:"spec-view-spreadsheet-grid"})}function en({logger:t}){const e=[{label:"Home",href:"/"},{label:"Demo",href:"/demo"},{label:"Spreadsheet Grid"}],{gridFacade:n,viewportFacade:i,selectionFacade:s,toolbarFacade:r,sheetTabsFacade:a,viewportState:u,selectionState:c,toolbarState:b,sheetTabsState:v,vimModeState:p,handleScroll:S,handleCellClick:C,handleCellMouseDown:L,handleCellMouseEnter:M,handleCellMouseUp:R,handleColumnResize:T,handleVimNavigate:W}=wt({defaultColumns:15,defaultRows:30,maxUndoHistory:50,containerWidth:600,containerHeight:600,defaultCellWidth:100,defaultCellHeight:30}),[A,P]=x.useState(null),[B,G]=x.useState(""),[U,_]=x.useState(""),q=x.useRef(null);x.useEffect(()=>{const j=()=>{const y=n.getStorageSize();P(y)};j();const E=setInterval(j,2e3);return()=>clearInterval(E)},[n]);const X=(j,E,y)=>{C(j,E,y)},k=()=>{n.setCellText(0,0,"Name"),n.setCellText(1,0,"Age"),n.setCellText(2,0,"City"),n.setCellText(3,0,"Occupation"),n.setCellText(4,0,"Salary"),[["Alice Johnson","28","New York","Engineer","$85,000"],["Bob Smith","35","San Francisco","Designer","$75,000"],["Carol Davis","42","Boston","Manager","$95,000"],["David Wilson","31","Seattle","Developer","$90,000"],["Eve Martinez","26","Austin","Analyst","$70,000"]].forEach((E,y)=>{E.forEach(($,Y)=>{n.setCellText(Y,y+1,$)})}),n.setCellText(0,8,"# Markdown H1"),n.setCellText(0,9,"## Markdown H2"),n.setCellText(0,10,"### Markdown H3"),n.setCellText(0,12,"Notes:"),n.setCellText(0,13,"- Double-click cells to edit"),n.setCellText(0,14,"- Use vim commands on the right"),n.setCellText(0,15,"- Try undo/redo with toolbar"),n.applyMarkdownStyling()};return x.useEffect(()=>{var y;(((y=n.getCell(0,0))==null?void 0:y.text)||"").trim()!==""||k()},[n]),x.useEffect(()=>{const j=c.range?[c.range.start,c.range.end]:[c.activeCell,c.activeCell];n.updateSelection(j)},[c.activeCell,c.range,n]),l.jsxs("div",{className:"spreadsheet-grid-demo-page flex-1 flex flex-col h-full","data-test":"spreadsheet-grid-demo-page",children:[l.jsx("div",{className:"page-header p-6 pb-0 flex-shrink-0",children:l.jsx("div",{className:"breadcrumb-section mb-4",children:l.jsx($e,{items:e})})}),l.jsx("div",{className:"current-state-bar px-6 pb-2 flex-shrink-0",children:l.jsxs("div",{className:"flex items-center gap-6 h-9 px-4 bg-muted border border-border rounded text-sm",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("span",{className:"font-semibold text-muted-foreground",children:"Start:"}),l.jsx("span",{className:"font-mono text-foreground",children:c.range?`(${c.range.start[0]}, ${c.range.start[1]})`:`(${c.activeCell[0]}, ${c.activeCell[1]})`})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("span",{className:"font-semibold text-muted-foreground",children:"End:"}),l.jsx("span",{className:"font-mono text-foreground",children:c.range?`(${c.range.end[0]}, ${c.range.end[1]})`:`(${c.activeCell[0]}, ${c.activeCell[1]})`})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("span",{className:"font-semibold text-muted-foreground",children:"Content:"}),l.jsx("span",{className:"font-mono text-foreground truncate max-w-[200px]",children:(()=>{var y;const j=n.getEditingCell();return j&&j[0]===c.activeCell[0]&&j[1]===c.activeCell[1]?n.getEditingContent()||"(empty)":((y=n.getCell(c.activeCell[0],c.activeCell[1]))==null?void 0:y.text)||"(empty)"})()})]})]})}),l.jsxs("div",{className:"page-content flex-1 p-6 pt-2 min-h-0",children:[l.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 h-full",children:[l.jsx("div",{className:"lg:col-span-1 flex flex-col",children:l.jsxs(ee,{"data-test":"live-grid-card",className:"flex-1 flex flex-col",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Live Spreadsheet Grid"}),l.jsx(ie,{children:"Full-featured grid with vim navigation, undo/redo, multi-sheet support"})]}),l.jsx(se,{children:l.jsx("div",{className:"grid-container h-[600px] border border-border rounded",children:l.jsx(yt,{gridFacade:n,viewportFacade:i,selectionFacade:s,toolbarFacade:r,sheetTabsFacade:a,viewportState:u,selectionState:c,toolbarState:b,sheetTabsState:v,vimModeState:p,onScroll:S,onCellClick:X,onCellMouseDown:L,onCellMouseEnter:M,onCellMouseUp:R,onColumnResize:T,showToolbar:!0,showSheetTabs:!0,showHeaders:!0,defaultCellWidth:100,defaultCellHeight:30,rowHeaderWidth:50,headerHeight:30})})})]})}),l.jsx("div",{className:"lg:col-span-1 flex flex-col overflow-hidden",children:l.jsxs(Ve,{defaultValue:"specifications",className:"h-full flex flex-col",children:[l.jsxs(We,{className:"grid w-full grid-cols-2 flex-shrink-0",children:[l.jsx(Se,{value:"controls",children:"Controls"}),l.jsx(Se,{value:"specifications",children:"Specifications"})]}),l.jsxs(Ee,{value:"controls",className:"space-y-4 mt-4 overflow-y-auto flex-1 min-h-0",children:[l.jsxs(ee,{"data-test":"resize-test-card",className:"bg-yellow-50 dark:bg-yellow-950/30 border-yellow-200 dark:border-yellow-800",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Resize Testing"}),l.jsx(ie,{children:"Test column resize programmatically"})]}),l.jsx(se,{children:l.jsx(H,{size:"sm",variant:"default",onClick:()=>{const E=i.getColumnWidth(2)+20;T(2,E)},"data-test":"resize-column-c-button",children:"Resize Column C (+20px)"})})]}),l.jsxs(ee,{"data-test":"vim-navigation-card",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Vim Navigation"}),l.jsx(ie,{children:"Test vim movement commands"})]}),l.jsx(se,{children:l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[l.jsx("div",{}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>W(f.cursorUp),"data-test":"vim-move-up-button",children:"k ()"}),l.jsx("div",{}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>W(f.cursorLeft),"data-test":"vim-move-left-button",children:"h ()"}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>W(f.cursorDown),"data-test":"vim-move-down-button",children:"j ()"}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>W(f.cursorRight),"data-test":"vim-move-right-button",children:"l ()"})]}),l.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[l.jsx(H,{size:"sm",variant:"outline",onClick:()=>W(f.documentStart),"data-test":"vim-goto-first-button",children:"gg (first)"}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>W(f.documentEnd),"data-test":"vim-goto-last-button",children:"G (last)"})]})]})})]}),l.jsxs(ee,{"data-test":"history-card",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Undo/Redo"}),l.jsx(ie,{children:"History stack info"})]}),l.jsx(se,{children:l.jsxs("div",{className:"space-y-2 text-sm",children:[l.jsxs("div",{className:"flex justify-between",children:[l.jsx("span",{children:"Undo available:"}),l.jsx("span",{className:"font-mono",children:b.undoDepth})]}),l.jsxs("div",{className:"flex justify-between",children:[l.jsx("span",{children:"Redo available:"}),l.jsx("span",{className:"font-mono",children:b.redoDepth})]}),l.jsxs("div",{className:"flex justify-between",children:[l.jsx("span",{children:"Has changes:"}),l.jsx("span",{className:b.isDirty?"text-orange-600 dark:text-orange-400":"text-green-600 dark:text-green-400",children:b.isDirty?"Yes":"No"})]}),l.jsx("div",{className:"text-xs text-muted-foreground mt-3 pt-3 border-t border-border",children:"Use toolbar buttons above grid for undo/redo"})]})})]}),l.jsxs(ee,{"data-test":"persistence-card",className:"bg-purple-50 dark:bg-purple-950/30 border-purple-200 dark:border-purple-800",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Persistence & Export/Import"}),l.jsx(ie,{children:"Auto-save, export to file, import data"})]}),l.jsx(se,{children:l.jsxs("div",{className:"space-y-4",children:[l.jsxs("div",{className:"space-y-2 text-sm pb-3 border-b border-border",children:[l.jsxs("div",{className:"flex justify-between",children:[l.jsx("span",{children:"Auto-save:"}),l.jsx("span",{className:"text-green-600 dark:text-green-400 font-semibold",children:"Enabled (1s debounce)"})]}),l.jsxs("div",{className:"flex justify-between",children:[l.jsx("span",{children:"Storage size:"}),l.jsx("span",{className:"font-mono",children:A!==null?`${(A/1024).toFixed(2)} KB`:"Loading..."})]})]}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(pe,{className:"text-xs font-semibold",children:"Manual Controls"}),l.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[l.jsx(H,{size:"sm",variant:"outline",onClick:()=>{const j=c.range?[c.range.start,c.range.end]:[c.activeCell,c.activeCell];n.saveToLocalStorage(j)},"data-test":"manual-save-button",children:"Save Now"}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>{confirm("Clear all localStorage data? This cannot be undone.")&&(n.clearLocalStorage(),P(0))},"data-test":"clear-storage-button",children:"Clear Storage"})]}),l.jsx(H,{size:"sm",variant:"secondary",className:"w-full",onClick:()=>{confirm("Replace current data with demo data? This cannot be undone.")&&k()},"data-test":"reset-demo-data-button",children:"Reset to Demo Data"})]}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(pe,{className:"text-xs font-semibold",children:"Export"}),l.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[l.jsx(H,{size:"sm",variant:"default",onClick:()=>{n.exportToFile()},"data-test":"export-file-button",children:"Export to File"}),l.jsx(H,{size:"sm",variant:"outline",onClick:()=>{const j=n.exportToJSON(!1);navigator.clipboard.writeText(j)},"data-test":"copy-json-button",children:"Copy JSON"})]})]}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(pe,{className:"text-xs font-semibold",children:"Import"}),l.jsx(Fe,{ref:q,type:"file",accept:".json",className:"text-xs",onChange:async j=>{var y;const E=(y=j.target.files)==null?void 0:y[0];if(E){G("Importing..."),_("");try{const $=await n.importFromFile(E,{mode:"replace",includeHistory:!1,validateSheetIds:!0});$.errors.length>0?(_($.errors.join(", ")),G("")):(G(`Imported ${$.sheetsImported} sheets, ${$.cellsImported} cells`),_(""))}catch($){_($ instanceof Error?$.message:"Import failed"),G("")}q.current&&(q.current.value="")}},"data-test":"import-file-input"}),B&&l.jsx(xe,{className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-800",children:l.jsx(Ie,{className:"text-xs",children:B})}),U&&l.jsx(xe,{className:"bg-red-50 dark:bg-red-950/30 border-red-200 dark:border-red-800",children:l.jsx(Ie,{className:"text-xs text-red-600 dark:text-red-400",children:U})})]}),l.jsx("div",{className:"text-xs text-muted-foreground pt-2 border-t border-border",children:l.jsx("p",{children:"Auto-save is enabled by default. Changes are saved automatically to localStorage after 1 second of inactivity."})})]})})]}),l.jsxs(ee,{"data-test":"features-card",className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-800",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Features"}),l.jsx(ie,{children:"What's available"})]}),l.jsx(se,{children:l.jsxs("ul",{className:"text-sm space-y-1 list-disc list-inside text-foreground",children:[l.jsx("li",{children:"Click cells to select"}),l.jsx("li",{children:"Double-click to edit"}),l.jsx("li",{children:"Drag to select range"}),l.jsx("li",{children:"Shift+click to extend"}),l.jsx("li",{children:"Resize columns (drag border)"}),l.jsx("li",{children:"Auto-save to localStorage"}),l.jsx("li",{children:"Export to JSON with metadata"}),l.jsx("li",{children:"Import from JSON file"}),l.jsx("li",{children:"Multi-sheet support"}),l.jsx("li",{children:"Vim navigation"}),l.jsx("li",{children:"Undo/redo (Ctrl+Z/Y)"})]})})]})]}),l.jsx(Ee,{value:"specifications",className:"mt-4 overflow-y-auto flex-1 min-h-0",children:l.jsx(Pt,{gridFacade:n,selectionFacade:s})})]})})]}),l.jsx("div",{className:"mt-6",children:l.jsxs(ee,{"data-test":"architecture-card",className:"bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:[l.jsxs(te,{children:[l.jsx(ne,{children:"Architecture: Headless UI + Facade Pattern"}),l.jsx(ie,{children:"Framework-agnostic design"})]}),l.jsxs(se,{children:[l.jsxs("div",{className:"grid md:grid-cols-3 gap-4 text-sm",children:[l.jsxs("div",{children:[l.jsx("div",{className:"font-semibold mb-2",children:"Layer 1: Domain (Phase 1)"}),l.jsxs("ul",{className:"list-disc list-inside space-y-1 text-foreground",children:[l.jsx("li",{children:"GridStateService"}),l.jsx("li",{children:"VimNavigationService"}),l.jsx("li",{children:"UndoRedoService"}),l.jsx("li",{children:"200+ unit tests"})]})]}),l.jsxs("div",{children:[l.jsx("div",{className:"font-semibold mb-2",children:"Layer 2: Facade (Phase 2)"}),l.jsxs("ul",{className:"list-disc list-inside space-y-1 text-foreground",children:[l.jsx("li",{children:"SpreadsheetGridFacade"}),l.jsx("li",{children:"Orchestrates services"}),l.jsx("li",{children:"22 integration tests"})]})]}),l.jsxs("div",{children:[l.jsx("div",{className:"font-semibold mb-2",children:"Layer 3: UI (Phase 3)"}),l.jsxs("ul",{className:"list-disc list-inside space-y-1 text-foreground",children:[l.jsx("li",{children:"4 UI Facades (headless)"}),l.jsx("li",{children:"6 React Components"}),l.jsx("li",{children:"36 UI facade tests"}),l.jsx("li",{children:"Framework-agnostic core"})]})]})]}),l.jsxs("div",{className:"mt-4 pt-4 border-t border-blue-200 dark:border-blue-700 text-sm text-foreground",children:[l.jsx("p",{className:"font-semibold mb-1",children:"Total Test Coverage:"}),l.jsxs("p",{children:["Phase 1: 200/213 tests | Phase 2: 22/22 tests | Phase 3: 36/36 tests = ",l.jsx("span",{className:"font-bold text-green-700 dark:text-green-400",children:"258+ tests passing"})]})]})]})]})})]})]})}export{en as SpreadsheetGridDemoPage};
