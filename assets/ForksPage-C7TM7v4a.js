import{j as e,d as ie,r,h as Pe,u as Ee}from"./react-vendor-Byz07MLO.js";import{t as L}from"./utils-CsrmMPoT.js";import{V as $,aW as re,a as h,w as ne,aX as Le,r as Ae,C as K,b as Q,c as O,l as ee,L as A,e as se,av as $e,aY as Re,aZ as Ve,a_ as We,ac as te,s as Be,M as De,I as Ue,T as _e}from"./index-DPqC4dt9.js";import{G as I,aY as W,M as le,aZ as He,c as Ge,T as Ye,F as Ze,a_ as qe,a$ as Xe,a5 as Je,b0 as Ke,l as Qe,V as Oe,O as es,e as ss}from"./icons-Ce2OFwrV.js";import{Tree as ts}from"./tree-DcQ_KECY.js";import"./radix-ui-CdiC0DQF.js";import"./ui-utils-BxIQ3qGg.js";function as({fork:s,isSelected:o=!1,onClick:n,onToggleFavorite:a,onEdit:l,onDelete:d,sessionName:g,messageCount:p}){const u=()=>{n==null||n(s)},m=f=>{f.stopPropagation(),a==null||a(s)},j=f=>{f.stopPropagation(),l==null||l(s)},c=f=>{f.stopPropagation(),d==null||d(s)};return e.jsxs("div",{"data-test":"fork-list-item",className:$("fork-list-item group relative p-3 rounded-lg border cursor-pointer transition-colors",o?"bg-primary/10 border-primary":"hover:bg-accent border-transparent hover:border-border"),onClick:u,children:[e.jsxs("div",{"data-test":"fork-list-item-header",className:"fork-list-item-header flex items-start gap-2",children:[e.jsx(I,{size:16,className:"mt-0.5 flex-shrink-0 text-muted-foreground","data-test":"fork-list-item-icon"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{"data-test":"fork-list-item-name",className:"fork-list-item-name font-medium text-sm truncate",children:s.sessionName||s.description||"Unnamed Fork"}),s.isFavorite&&e.jsx(W,{size:12,className:"flex-shrink-0 fill-yellow-400 text-yellow-400","data-test":"fork-list-item-favorite-icon"})]}),g&&e.jsx("div",{"data-test":"fork-list-item-session",className:"fork-list-item-session text-xs text-muted-foreground truncate",children:g})]})]}),e.jsxs("div",{"data-test":"fork-list-item-meta",className:"fork-list-item-meta mt-2 flex items-center gap-3 text-xs text-muted-foreground",children:[p!==void 0&&e.jsxs("span",{className:"flex items-center gap-1","data-test":"fork-list-item-message-count",children:[e.jsx(le,{size:10}),p," messages"]}),e.jsxs("span",{className:"flex items-center gap-1","data-test":"fork-list-item-date",children:[e.jsx(He,{size:10}),re(s.forkedAt)]})]}),e.jsxs("div",{"data-test":"fork-list-item-actions",className:$("fork-list-item-actions absolute right-2 top-2 flex gap-1","opacity-0 group-hover:opacity-100 transition-opacity"),children:[a&&e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:m,"data-test":"fork-list-item-favorite-btn",title:s.isFavorite?"Remove from favorites":"Add to favorites",children:e.jsx(W,{size:12,className:$(s.isFavorite&&"fill-yellow-400 text-yellow-400")})}),l&&e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:j,"data-test":"fork-list-item-edit-btn",title:"Edit fork",children:e.jsx(Ge,{size:12})}),d&&e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:text-destructive",onClick:c,"data-test":"fork-list-item-delete-btn",title:"Delete fork",children:e.jsx(Ye,{size:12})})]})]})}function is(s){switch(s){case"user":return e.jsx(Je,{size:10,className:"text-primary"});case"assistant":return e.jsx(Xe,{size:10,className:"text-green-500"});case"tool_result":return e.jsx(qe,{size:10,className:"text-orange-500"});default:return e.jsx(le,{size:10,className:"text-muted-foreground"})}}function ae({message:s}){return e.jsxs("div",{"data-test":"fork-message-preview",className:"flex items-start gap-1.5 text-xs text-muted-foreground py-0.5",children:[e.jsx("span",{className:"flex-shrink-0 mt-0.5",children:is(s.entryType)}),e.jsx("span",{className:"truncate",children:s.preview||"(empty)"})]})}function oe(s){const n=!!s.forkedAt?e.jsx(I,{size:14,className:"text-muted-foreground"}):e.jsx(Ze,{size:14,className:"text-muted-foreground"});return{id:s.sessionId,label:s.customName||s.name||`Session ${s.sessionId.slice(0,8)}`,icon:n,data:s,children:s.children.map(oe)}}function de(s){const o=new Set([s.sessionId]);for(const n of s.children)de(n).forEach(l=>o.add(l));return o}function rs({tree:s,selectedSessionId:o,loading:n=!1,error:a,onSessionSelect:l,showMessages:d=!1}){const g=ie(),p=r.useMemo(()=>s?[oe(s)]:[],[s]),u=r.useMemo(()=>s?de(s):new Set,[s]),m=c=>{l?l(c.id):g(`/claude/${c.id}`)},j=(c,f,v)=>{const i=c.data,k=d&&(i==null?void 0:i.inheritedMessages)&&i.inheritedMessages.length>0,M=d&&(i==null?void 0:i.messages)&&i.messages.length>0;return e.jsxs("div",{"data-test":"fork-tree-node",className:$("fork-tree-node flex flex-col py-2 px-3 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors",f&&"bg-primary/10 border border-primary"),onClick:v,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"fork-tree-node-icon w-4 h-4 mr-2 flex-shrink-0"}),c.icon&&e.jsx("div",{className:"fork-tree-node-custom-icon mr-2 flex-shrink-0","data-test":"fork-tree-node-icon",children:c.icon}),e.jsxs("div",{className:"fork-tree-node-content flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"fork-tree-node-label truncate","data-test":"fork-tree-node-label",children:c.label}),(i==null?void 0:i.isFavorite)&&e.jsx(W,{size:12,className:"flex-shrink-0 fill-yellow-400 text-yellow-400","data-test":"fork-tree-node-favorite"}),(i==null?void 0:i.messageCount)!==void 0&&e.jsxs("span",{className:"text-xs text-muted-foreground","data-test":"fork-tree-node-message-count",children:["(",i.messageCount,")"]})]}),(i==null?void 0:i.forkedAt)&&e.jsx("div",{className:"text-xs text-muted-foreground","data-test":"fork-tree-node-meta",children:re(i.forkedAt)})]})]}),k&&e.jsxs("div",{"data-test":"fork-tree-node-inherited-messages",className:"fork-tree-node-inherited-messages mt-2 ml-6 pl-2 border-l-2 border-muted-foreground/30 space-y-0.5",children:[e.jsx("div",{className:"text-xs text-muted-foreground/70 font-medium mb-1",children:"Inherited from parent:"}),i.inheritedMessages.slice(0,3).map(x=>e.jsx(ae,{message:x},x.uuid)),i.inheritedMessages.length>3&&e.jsxs("div",{className:"text-xs text-muted-foreground italic",children:["+",i.inheritedMessages.length-3," more..."]})]}),M&&e.jsxs("div",{"data-test":"fork-tree-node-messages",className:"fork-tree-node-messages mt-2 ml-6 pl-2 border-l-2 border-primary/30 space-y-0.5",children:[k&&e.jsx("div",{className:"text-xs text-muted-foreground/70 font-medium mb-1",children:"New in this fork:"}),i.messages.slice(0,5).map(x=>e.jsx(ae,{message:x},x.uuid)),i.messages.length>5&&e.jsxs("div",{className:"text-xs text-muted-foreground italic",children:["+",i.messages.length-5," more..."]})]})]})};return n?e.jsx("div",{"data-test":"fork-tree-loading",className:"fork-tree-loading flex items-center justify-center h-full",children:e.jsx("div",{className:"text-muted-foreground animate-pulse",children:"Loading fork tree..."})}):a?e.jsx("div",{"data-test":"fork-tree-error",className:"fork-tree-error flex items-center justify-center h-full text-destructive",children:a}):!s||p.length===0?e.jsxs("div",{"data-test":"fork-tree-empty",className:"fork-tree-empty flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(I,{size:48,className:"mb-4 opacity-50"}),e.jsx("p",{children:"No fork tree available"}),e.jsx("p",{className:"text-sm",children:"Select a session to view its fork hierarchy"})]}):e.jsx("div",{"data-test":"fork-tree-visualization",className:"fork-tree-visualization h-full",children:e.jsx(ts,{data:p,onItemClick:m,defaultExpandedIds:u,selectedId:o,renderLeaf:j,className:"p-2"})})}function ns(s){const[o,n]=r.useState(null),[a,l]=r.useState(0),[d,g]=r.useState(!1),[p,u]=r.useState(null),m=r.useCallback(async(c,f)=>{g(!0),u(null);const v={includeMessages:s==null?void 0:s.includeMessages,messageTypes:s==null?void 0:s.messageTypes,messageLimit:s==null?void 0:s.messageLimit,...f};try{const i=await ne.getForkTree(c,v);n(i.root),l(i.totalNodes)}catch(i){console.error("[useForkTree] Failed to load fork tree:",{sessionId:c,options:v,error:i,errorMessage:i instanceof Error?i.message:"Unknown error",timestamp:new Date().toISOString()}),u(i instanceof Error?i.message:"Failed to load fork tree"),n(null),l(0)}finally{g(!1)}},[s==null?void 0:s.includeMessages,s==null?void 0:s.messageTypes,s==null?void 0:s.messageLimit]),j=r.useCallback(()=>{n(null),l(0),u(null)},[]);return{tree:o,totalNodes:a,loading:d,error:p,loadTree:m,clearTree:j}}function ce(s,o){if(!s)return null;if(s.sessionId===o)return s;for(const n of s.children){const a=ce(n,o);if(a)return a}return null}function xs(){const[s]=Pe(),{forkId:o}=Ee(),n=ie(),[a,l]=r.useState(null),[d,g]=r.useState(null),[p,u]=r.useState(!1),[m,j]=r.useState(null),[c,f]=r.useState(""),[v,i]=r.useState(""),[k,M]=r.useState(!1),[x,me]=r.useState(!0),C=s.get("sessionId"),{forks:w,loading:R,error:B,pagination:N,currentPage:S,favoritesOnly:D,refreshForks:z,loadForks:U,toggleFavoritesOnly:_,toggleFavorite:H,updateFork:G,deleteFork:Y}=Le({loadOnMount:!0,parentSessionId:C??void 0,pageSize:20}),{tree:T,loading:fe,error:ue,loadTree:F}=ns({includeMessages:x,messageTypes:"user,assistant",messageLimit:10}),{messages:Z,sessionDetails:y,metadata:xe,loading:he,pagination:ge,loadOlderMessages:pe,refreshSession:q,addOptimisticMessage:je,removeOptimisticMessage:ve}=Ae(d,{loadOnMount:!0,subscribeToSSE:!0}),X=r.useMemo(()=>{const t=Math.round(window.innerWidth*.6),b=Math.round(window.innerHeight*.8),E=Math.round((window.innerWidth-t)/2),Fe=Math.round((window.innerHeight-b)/2);return{size:{width:t,height:b},position:{x:E,y:Fe}}},[]),V=r.useMemo(()=>!d||!T?null:ce(T,d),[d,T]);r.useEffect(()=>{if(o&&w.length>0){const t=w.find(b=>String(b.id)===o);t&&(a==null?void 0:a.id)!==t.id&&l(t)}},[o,w,a==null?void 0:a.id]),r.useEffect(()=>{const t=(a==null?void 0:a.sessionId)??C;t&&F(t)},[a==null?void 0:a.sessionId,C,F,x]);const ke=r.useCallback(t=>{l(t),n(`/claude/forks/${t.id}`)},[n]),Ne=r.useCallback(t=>{H(t.sessionId)},[H]),ye=r.useCallback(async t=>{window.confirm(`Are you sure you want to delete this fork${t.description?` "${t.description}"`:""}?`)&&(await Y(t.sessionId),(a==null?void 0:a.id)===t.id&&l(null))},[Y,a]),be=r.useCallback(t=>{j(t),f(t.sessionName??""),i(t.description??"")},[]),P=r.useCallback(()=>{j(null),f(""),i("")},[]),Ce=r.useCallback(async()=>{if(m){M(!0);try{const t=[],b=v.trim()||void 0;b!==m.description&&t.push(G(m.sessionId,{description:b}));const E=c.trim()||null;E!==(m.sessionName??null)&&t.push(ne.updateSessionName(m.sessionId,E)),t.length>0&&(await Promise.all(t),L.success("Fork updated"),z()),P()}catch{L.error("Failed to update fork")}finally{M(!1)}}},[m,c,v,G,z,P]),we=r.useCallback(t=>{g(t),u(!0)},[]),Se=r.useCallback(()=>{u(!1)},[]),Ie=r.useCallback(()=>{z();const t=(a==null?void 0:a.sessionId)??C;t&&F(t)},[z,F,a==null?void 0:a.sessionId,C]),J=r.useCallback(t=>{U(t)},[U]),Me=r.useCallback(()=>{_()},[_]),ze=r.useCallback(t=>t.length<=19?t:`${t.slice(0,8)}...${t.slice(-8)}`,[]),Te=r.useCallback(async t=>{try{await navigator.clipboard.writeText(t),L.success("Session ID copied")}catch{L.error("Failed to copy")}},[]);return e.jsxs("div",{"data-test":"forks-page",className:"forks-page h-full p-4 overflow-hidden",children:[e.jsxs("div",{className:"forks-page-layout grid grid-cols-[350px_1fr] gap-4 h-full overflow-hidden",children:[e.jsxs(K,{"data-test":"forks-sidebar",className:"forks-sidebar flex flex-col overflow-hidden",children:[e.jsxs(Q,{className:"flex-shrink-0 pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"flex items-center gap-2 text-lg",children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>n("/claude"),"data-test":"forks-back-btn",title:"Back to Sessions",children:e.jsx(Ke,{size:16})}),e.jsx(I,{size:18}),"Forks",N&&N.totalCount>0&&e.jsxs("span",{"data-test":"forks-count",className:"text-sm font-normal text-muted-foreground",children:["(",N.totalCount,")"]})]}),e.jsx(h,{variant:"ghost",size:"icon",onClick:Ie,disabled:R,"data-test":"forks-refresh-btn",title:"Refresh",children:e.jsx(Qe,{size:16,className:R?"animate-spin":""})})]}),e.jsx("div",{className:"flex items-center gap-4 mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{id:"favorites-only",checked:D,onCheckedChange:()=>Me(),"data-test":"forks-favorites-toggle"}),e.jsx(A,{htmlFor:"favorites-only",className:"text-sm",children:"Favorites only"})]})})]}),e.jsx(se,{className:"flex-1 min-h-0 p-0",children:e.jsx($e,{"data-test":"forks-list",className:"forks-list h-full px-4",children:R?e.jsx("div",{"data-test":"forks-loading",className:"flex items-center justify-center py-8 text-muted-foreground",children:"Loading forks..."}):B?e.jsx("div",{"data-test":"forks-error",className:"flex items-center justify-center py-8 text-destructive",children:B}):w.length===0?e.jsxs("div",{"data-test":"forks-empty",className:"flex flex-col items-center justify-center py-8 text-muted-foreground",children:[e.jsx(I,{size:32,className:"mb-2 opacity-50"}),e.jsx("p",{children:D?"No favorite forks":"No forks yet"}),e.jsx("p",{className:"text-sm",children:"Create a fork from any session to start exploring alternatives"})]}):e.jsx("div",{className:"space-y-2 py-2",children:w.map(t=>e.jsx(as,{fork:t,isSelected:(a==null?void 0:a.id)===t.id,onClick:ke,onToggleFavorite:Ne,onEdit:be,onDelete:ye},t.id))})})}),N&&N.totalPages>1&&e.jsxs("div",{"data-test":"forks-pagination",className:"forks-pagination flex items-center justify-between px-4 py-2 border-t",children:[e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>J(S-1),disabled:S<=1,"data-test":"forks-prev-page",children:[e.jsx(Oe,{size:16}),"Previous"]}),e.jsxs("span",{className:"text-sm text-muted-foreground","data-test":"forks-page-info",children:["Page ",S," of ",N.totalPages]}),e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>J(S+1),disabled:S>=N.totalPages,"data-test":"forks-next-page",children:["Next",e.jsx(es,{size:16})]})]})]}),e.jsxs(K,{"data-test":"forks-tree-panel",className:"forks-tree-panel flex flex-col overflow-hidden",children:[e.jsxs(Q,{className:"flex-shrink-0 pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(O,{className:"text-lg",children:"Fork Tree"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{id:"show-messages",checked:x,onCheckedChange:me,"data-test":"forks-show-messages-toggle"}),e.jsx(A,{htmlFor:"show-messages",className:"text-sm",children:"Show messages"})]})]}),a&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground","data-test":"forks-tree-panel-selected",children:["Viewing: ",a.sessionName||a.description||`Fork ${a.sessionId.slice(0,8)}`]}),e.jsxs("div",{className:"flex items-center gap-1","data-test":"forks-tree-panel-session-id",children:[e.jsxs(Re,{children:[e.jsx(Ve,{asChild:!0,children:e.jsx("span",{className:"text-xs font-mono text-muted-foreground cursor-default",children:ze(a.sessionId)})}),e.jsx(We,{children:e.jsx("span",{className:"font-mono text-xs",children:a.sessionId})})]}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>Te(a.sessionId),"data-test":"forks-tree-panel-copy-id",title:"Copy session ID",children:e.jsx(ss,{size:12})})]})]})]}),e.jsx(se,{className:"flex-1 min-h-0 p-0",children:e.jsx(rs,{tree:T,selectedSessionId:a==null?void 0:a.sessionId,loading:fe,error:ue??void 0,onSessionSelect:we,showMessages:x})})]})]}),e.jsx(te,{isVisible:p,onClose:Se,title:(y==null?void 0:y.customName)??(y==null?void 0:y.name)??"Session Chat",shouldCloseManually:!0,resizable:!0,initialSize:X.size,initialPosition:X.position,children:e.jsxs("div",{className:"flex flex-col h-full","data-test":"fork-chat-popover-content",children:[e.jsx("div",{className:"flex-1 overflow-auto","data-test":"fork-chat-messages-area",children:e.jsx(Be,{messages:Z,sessionDetails:y,metadata:xe,loading:he,pagination:ge,onLoadOlder:pe,onNameUpdated:q,inheritedMessages:V==null?void 0:V.inheritedMessages})}),d&&e.jsx("div",{className:"border-t p-2","data-test":"fork-chat-input-area",children:e.jsx(De,{sessionId:d,onSendSuccess:()=>{q()},onAddOptimisticMessage:je,onRemoveOptimisticMessage:ve,userMessages:Z.filter(t=>t.role==="user"&&!t._isOptimistic)})})]})}),e.jsx(te,{isVisible:m!==null,onClose:P,title:"Edit Fork",shouldCloseManually:!0,resizable:!1,initialSize:{width:400,height:380},initialPosition:{x:Math.round((window.innerWidth-400)/2),y:Math.round((window.innerHeight-380)/2)},children:e.jsxs("div",{className:"p-4 flex flex-col gap-4","data-test":"fork-edit-popover-content",children:[e.jsxs("div",{"data-test":"fork-edit-name-field",className:"space-y-2",children:[e.jsx(A,{htmlFor:"fork-edit-name",children:"Name"}),e.jsx(Ue,{id:"fork-edit-name","data-test":"fork-edit-name-input",placeholder:"Fork name...",value:c,onChange:t=>f(t.target.value),disabled:k})]}),e.jsxs("div",{"data-test":"fork-edit-description-field",className:"space-y-2",children:[e.jsx(A,{htmlFor:"fork-edit-description",children:"Description"}),e.jsx(_e,{id:"fork-edit-description","data-test":"fork-edit-description-input",placeholder:"Why was this fork created?",value:v,onChange:t=>i(t.target.value),disabled:k,rows:3,className:"resize-none"})]}),e.jsxs("div",{"data-test":"fork-edit-actions",className:"flex justify-end gap-2",children:[e.jsx(h,{variant:"outline",onClick:P,disabled:k,"data-test":"fork-edit-cancel",children:"Cancel"}),e.jsx(h,{onClick:Ce,disabled:k,"data-test":"fork-edit-submit",children:k?"Saving...":"Save"})]})]})})]})}export{xs as ForksPage};
