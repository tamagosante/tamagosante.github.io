var Rs=Object.defineProperty;var Is=(t,e,s)=>e in t?Rs(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var P=(t,e,s)=>Is(t,typeof e!="symbol"?e+"":e,s);import{r as h,j as a,d as Ls}from"./react-vendor-Byz07MLO.js";import{H as _s,E as $}from"./EnemyCircle-Bn6ZwsVI.js";import{I as X,a as Q,al as J,b3 as Ps,b4 as Os,L as Hs,m as at,n as nt,o as se,p as ae,ad as Gs,ae as $s,af as Ds,ag as Fs,aA as Bs,aB as Ks,aC as Ws,ac as Ue,ah as Us}from"./index-eHP58yiE.js";import{d as Vs,a as Ys,f as Xs,g as zs,h as qs,e as kt}from"./EasyFormV2-Bnzz3jgo.js";import{C as _e,e as Pe,u as Js,D as Zs,aA as Bt,E as Qs,f as ea,R as ta,a7 as sa,d as aa,a as na,bi as la,bx as ra,bR as ia,aU as oa}from"./icons-vtiX7BHn.js";import"./utils-DJ2ViQ2u.js";import"./radix-ui-v9Pxfv0s.js";import"./ui-utils-BxIQ3qGg.js";const U=800,K=500,_=25,Ee=50,Re=6,Kt=45,ca=12,da=35,ua=1,ma=3,Wt=5e3,z={health:10,attack:2,defense:0,hpRecovery:1,movementSpeed:3},Oe=120,je=15,Ut=800,ha=3,lt={GOBLIN:{name:"Goblin",maxCount:8,stats:{health:5,attack:1,defense:0,hpRecovery:0,movementSpeed:.8}}},rt=lt.GOBLIN.name,B=lt.GOBLIN.stats,ga=lt.GOBLIN.maxCount,Ct=500,fa=750,pa=5,xa=.7,He=2e3,Vt=5e3,Yt=80,va=1200,ya=1.5,wa=150,Xt=500,de=.1,Ge=.9,Et=.1;function $e(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}function zt(t,e){return $e(t,e)<=Oe}function Ve(t,e){return Math.max(1,t.attack-e.defense)}function qt(t,e,s,n){return{id:s,x:t,y:e,gold:n}}function De(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}function Ie(t,e){return De(t,e)<=da}function jt(t,e){return e.length===0?null:e.reduce((s,n)=>{const l=$e(t,s);return $e(t,n)<l?n:s})}function Nt(t,e){return e.length===0?null:e.reduce((s,n)=>{const l=De(t,s);return De(t,n)<l?n:s})}function ba(t,e){return e.length===0?null:e.reduce((s,n)=>n.health<s.health?n:s)}const Fe={MANA:"mana"},ue={mana:100,maxMana:100,manaRegen:5};function Jt(){return{id:"hero",name:"Hero",x:150,y:K/2,health:z.health,maxHealth:z.health,attack:z.attack,defense:z.defense,hpRecovery:z.hpRecovery,movementSpeed:z.movementSpeed,isHero:!0,isFlashing:!1,exp:0,level:1,mana:ue.mana,maxMana:ue.maxMana,manaRegen:ue.manaRegen,heroClass:_s.WARRIOR}}const ye={spawnsPerLevelUp:5,maxEnemyLevel:10,scaling:{healthMultiplier:1.2,attackMultiplier:1.15,defenseMultiplier:1.1}};function Zt(t,e){const s=Math.floor(t/e.spawnsPerLevelUp)+1;return Math.min(s,e.maxEnemyLevel)}function Qt(t,e,s){const n=e-1;return{health:Math.floor(t.health*Math.pow(s.healthMultiplier,n)),attack:Math.floor(t.attack*Math.pow(s.attackMultiplier,n)),defense:Math.floor(t.defense*Math.pow(s.defenseMultiplier,n))}}const Ye={1:{types:[$.GOBLIN_ANGRY],namePrefix:"Goblin"},2:{types:[$.GOBLIN_ANGRY,$.GOBLIN_FIERCE],namePrefix:"Goblin"},3:{types:[$.GOBLIN_ANGRY,$.GOBLIN_FIERCE,$.GOBLIN_SCOUT],namePrefix:"Goblin"},4:{types:[$.GOBLIN_ANGRY,$.GOBLIN_FIERCE,$.GOBLIN_SCOUT,$.GOBLIN_FRIENDLY],namePrefix:"Goblin"},5:{types:[$.GOBLIN_FIERCE,$.GOBLIN_SCOUT,$.ORC],namePrefix:"Monster"},6:{types:[$.ORC,$.SKELETON],namePrefix:"Undead"},7:{types:[$.SKELETON,$.BAT,$.SPIDER],namePrefix:"Creature"},8:{types:[$.ORC,$.SKELETON,$.SLIME,$.BAT,$.SPIDER],namePrefix:"Monster"}},ka=8;function es(t){let s=Math.max(1,Math.min(t,ka));for(;s>0&&!Ye[s];)s--;return Ye[s]||Ye[1]}function ts(t){const e=es(t);return e.types[Math.floor(Math.random()*e.types.length)]}function ss(t){return es(t).namePrefix||"Enemy"}function Ca(t){if(t.length===0)return;let e=null,s=0;for(const n of t){const l=n.damageDealtToHero??0;l>s&&(s=l,e=n)}return e&&s>0?e.aggression:void 0}function as(t,e=Math.random,s=!0){if(t!==void 0){const n=s?e()*Et:(e()*2-1)*Et;return Math.max(de,Math.min(Ge,t+n))}return e()*(Ge-de)+de}function Ea(t=Math.random){const e=t()*(fa-Ct)+Ct,s=t()*(K-_*2)+_;return{x:e,y:s}}function ja(t,e,s,n,l,r,i=Math.random,o=!0){const c={health:B.health,attack:B.attack,defense:B.defense},d=Qt(c,n,l.scaling),u=ss(n),m=n>1?`${u} Lv.${n}`:u;return{id:t,name:m,x:e,y:s,health:d.health,maxHealth:d.health,attack:d.attack,defense:d.defense,hpRecovery:B.hpRecovery,movementSpeed:B.movementSpeed,isHero:!1,isFlashing:!1,isIdle:!0,level:n,aggression:as(r,i,o),damageDealtToHero:0,enemyType:ts(n)}}function ns(t,e,s,n,l=Math.random){if(t>=s.maxEnemies)return{enemy:null,skipped:!0};const r=Zt(e,s.difficultyConfig),{x:i,y:o}=Ea(l),c=s.baseAggression??(s.existingEnemies?Ca(s.existingEnemies):void 0);return{enemy:ja(n(),i,o,r,s.difficultyConfig,c,l,s.hardMode??!0),skipped:!1}}const Na=1;function ls(t,e={}){const{level:s=Na,config:n=ye,baseAggression:l}=e,r=[],i=K/(t+1),o={health:B.health,attack:B.attack,defense:B.defense},c=Qt(o,s,n.scaling),d=ss(s),u=s>1?`${d} Lv.${s}`:d;for(let m=0;m<t;m++)r.push({id:`enemy-${m}`,name:u,x:U-150,y:i*(m+1),health:c.health,maxHealth:c.health,attack:c.attack,defense:c.defense,hpRecovery:B.hpRecovery,movementSpeed:B.movementSpeed,isHero:!1,isFlashing:!1,isIdle:!0,level:s,aggression:as(l),damageDealtToHero:0,enemyType:ts(s)});return r}const O={POWER_STRIKE:"power_strike",HEAL:"heal"},Be={POWER_STRIKE:3e3,HEAL:5e3},Ke={POWER_STRIKE_MULTIPLIER:2,HEAL_BASE_AMOUNT:5},We={[O.POWER_STRIKE]:{type:Fe.MANA,amount:40},[O.HEAL]:{type:Fe.MANA,amount:50}},rs=[{id:O.POWER_STRIKE,name:"Power Strike",description:"A powerful attack that deals 2x damage (20 mana)",cooldown:Be.POWER_STRIKE,targetType:"enemy",effects:[{type:"damage",value:Ke.POWER_STRIKE_MULTIPLIER}],resourceCost:We[O.POWER_STRIKE]},{id:O.HEAL,name:"Heal",description:"Heals the target for a fixed amount (30 mana)",cooldown:Be.HEAL,targetType:"self",effects:[{type:"heal",value:Ke.HEAL_BASE_AMOUNT}],resourceCost:We[O.HEAL]}],ee={powerStrike:{damageMultiplier:Ke.POWER_STRIKE_MULTIPLIER,manaCost:We[O.POWER_STRIKE].amount,cooldown:Be.POWER_STRIKE/1e3},heal:{healAmount:Ke.HEAL_BASE_AMOUNT,manaCost:We[O.HEAL].amount,cooldown:Be.HEAL/1e3}},is={powerStrike:{damageMultiplier:{min:1,max:5,step:.5},manaCost:{min:0,max:50,step:1},cooldown:{min:1,max:10,step:.5}},heal:{healAmount:{min:1,max:20,step:1},manaCost:{min:0,max:50,step:1},cooldown:{min:1,max:10,step:.5}}},he={maxLevel:10,thresholds:[{level:1,xpRequired:0},{level:2,xpRequired:10},{level:3,xpRequired:25},{level:4,xpRequired:50},{level:5,xpRequired:85},{level:6,xpRequired:130},{level:7,xpRequired:190},{level:8,xpRequired:265},{level:9,xpRequired:360},{level:10,xpRequired:475}],levelUpBonus:{maxHealth:2,attack:1,defense:0,maxMana:10},xpPerKill:5};function et(t,e){let s=1;for(const c of e.thresholds)if(t>=c.xpRequired)s=c.level;else break;if(s>=e.maxLevel)return{level:e.maxLevel,currentXp:t,xpToNextLevel:0,xpProgress:100};const n=e.thresholds.find(c=>c.level===s),l=e.thresholds.find(c=>c.level===s+1),r=t-n.xpRequired,i=l.xpRequired-n.xpRequired,o=r/i*100;return{level:s,currentXp:t,xpToNextLevel:l.xpRequired-t,xpProgress:o}}function Sa(t,e,s){switch(t.type){case"damage":const n=Ve(e,s);return Math.floor(n*t.value);case"heal":return t.value;default:return t.value}}function Ma(t,e){return{...t,health:Math.max(0,t.health-e),isFlashing:!0,isAggroed:!0}}function Aa(t,e){return{...t,health:Math.min(t.maxHealth,t.health+e)}}function os(t){const{caster:e,target:s,skill:n}=t;let l={...s},r=0,i=0;const o=[];for(const d of n.effects){const u=Sa(d,e,s);switch(d.type){case"damage":l=Ma(l,u),r+=u,o.push(`${e.name} uses ${n.name} on ${s.name} for ${u} damage!`);break;case"heal":l=Aa(l,u),i+=u,e.id===s.id?o.push(`${e.name} heals for ${u} HP!`):o.push(`${e.name} heals ${s.name} for ${u} HP!`);break;default:o.push(`${n.name} effect applied.`)}}return{result:{success:!0,message:o.join(" "),damage:r>0?r:void 0,healing:i>0?i:void 0,affectedEntityId:s.id},updatedTarget:l}}function tt(t,e,s,n){switch(n??t.targetType){case"self":return e.id===s.id;case"ally":return e.isHero===s.isHero;case"enemy":return e.isHero!==s.isHero;default:return!1}}function it(t,e){return e.type!==Fe.MANA?!0:(t.mana??0)>=e.amount}function cs(t,e){if(e.type!==Fe.MANA)return t;const s=t.mana??0,n=Math.max(0,s-e.amount);return{...t,mana:n}}function Ta(t,e){return e?it(t,e):!0}class Ra{now(){return Date.now()}hasElapsed(e,s,n){const l=s/n;return this.now()-e>=l}}class Ia{constructor(e=60){P(this,"currentTimeMs",0);P(this,"msPerTick");this.msPerTick=1e3/e}now(){return this.currentTimeMs}tick(){this.currentTimeMs+=this.msPerTick}advanceTicks(e){this.currentTimeMs+=this.msPerTick*e}reset(){this.currentTimeMs=0}hasElapsed(e,s,n){const l=s/n;return this.now()-e>=l}}const ds=new Ra,pe=new Map;let ot=ds;function us(t){ot=t}function ct(t){return rs.find(e=>e.id===t)}function ve(t,e){return st(t,e)>0}function st(t,e){const s=pe.get(t);if(!s)return 0;const n=s.get(e);if(n===void 0)return 0;const l=ct(e);if(!l)return 0;const r=ot.now()-n,i=l.cooldown-r;return Math.max(0,i)}function ms(t,e){pe.has(t)||pe.set(t,new Map),pe.get(t).set(e,ot.now())}function La(t){pe.delete(t)}function hs(t,e,s=ee){const n=ct(O.POWER_STRIKE);if(!n||ve(t.id,n.id))return null;const l=s.powerStrike.manaCost;if(!it(t,{type:"mana",amount:l})||!tt(n,t,e,"enemy"))return null;const r=cs(t,{type:"mana",amount:l}),i={...n,effects:[{type:"damage",value:s.powerStrike.damageMultiplier}]},{result:o,updatedTarget:c}=os({caster:r,target:e,skill:i});return ms(t.id,n.id),{result:o,updatedTarget:c,updatedCaster:r}}function gs(t,e,s=ee){const n=ct(O.HEAL);if(!n||ve(t.id,n.id))return null;const l=s.heal.manaCost;if(!it(t,{type:"mana",amount:l}))return null;const r=t;if(!tt(n,t,r,"self")&&!tt(n,t,r,"ally"))return null;let i=cs(t,{type:"mana",amount:l});const o=r.id===t.id,c=o?i:r,d={...n,effects:[{type:"heal",value:s.heal.healAmount}]},{result:u,updatedTarget:m}=os({caster:i,target:c,skill:d});return ms(t.id,n.id),o&&(i=m),{result:u,updatedTarget:m,updatedCaster:i}}function St(t,e,s=ee){if(ve(t.id,e))return!1;let n=0;return e===O.POWER_STRIKE?n=s.powerStrike.manaCost:e===O.HEAL&&(n=s.heal.manaCost),Ta(t,{type:"mana",amount:n})}function _a(t,e,s=ee){const n={shouldUseSkill:!1,skillId:null,targetId:null};if(t.health/t.maxHealth<.5&&St(t,O.HEAL,s))return{shouldUseSkill:!0,skillId:O.HEAL,targetId:t.id};if(e.length>0&&St(t,O.POWER_STRIKE,s)){const r=e.reduce((i,o)=>o.health<i.health?o:i);return{shouldUseSkill:!0,skillId:O.POWER_STRIKE,targetId:r.id}}return n}function Pa(t,e){const s=t.exp??0,n=t.level??1,r=et(s,e).level;if(r<=n)return{entity:t,leveledUp:!1,newLevel:n,previousLevel:n};const i=r-n,{levelUpBonus:o}=e,c=o.maxHealth*i,d=o.attack*i,u=o.defense*i,m=o.maxMana*i;return{entity:{...t,level:r,maxHealth:t.maxHealth+c,health:t.health+c,attack:t.attack+d,defense:t.defense+u,maxMana:(t.maxMana??0)+m},leveledUp:!0,newLevel:r,previousLevel:n}}function Oa(t,e,s){const n={...t,exp:(t.exp??0)+e};return Pa(n,s)}const Ha={minGold:1,maxGold:5};function Ga(t=Math.random()){const{minGold:e,maxGold:s}=Ha;return Math.floor(t*(s-e+1))+e}function $a(t,e,s,n){if(e.length===0)return{target:null,newTargetId:null,changed:n!==null};switch(s){case"attack_until_dead":{if(n){const i=e.find(o=>o.id===n);if(i)return{target:i,newTargetId:n,changed:!1}}const l=jt(t,e),r=(l==null?void 0:l.id)??null;return{target:l,newTargetId:r,changed:r!==n}}case"focus_least_hp":return{target:ba(t,e),newTargetId:n,changed:!1};case"closest":default:return{target:jt(t,e),newTargetId:n,changed:!1}}}function Xe(t,e,s){const n=e.x-t.x,l=e.y-t.y,r=Math.sqrt(n*n+l*l);return r<=1?t:{...t,x:t.x+n/r*s,y:t.y+l/r*s}}function Mt(t,e,s,n,l,r,i=Math.random()){const o=[];o.push({type:"enemy_killed",enemyId:t.id,enemyName:t.name});const c=s.filter(f=>f.id!==t.id),d=Ga(i),u=[...n,qt(t.x,t.y,r,d)];o.push({type:"gold_dropped",amount:d});const m=Oa(e,l.xpPerKill,l),p={...e,...m.entity};return o.push({type:"xp_gained",amount:l.xpPerKill}),m.leveledUp&&o.push({type:"level_up",newLevel:m.newLevel}),{hero:p,enemies:c,loot:u,events:o}}function At(t,e,s){if(e.length===0)return{hero:t,events:[],heroDied:!1};const n=Math.floor(s*e.length),l=e[n],r=Ve(l,t),i=Math.max(0,t.health-r),o=[{type:"counterattack",attackerId:l.id,attackerName:l.name,damage:r}];return{hero:{...t,health:i},events:o,heroDied:i<=0}}function fs(t,e,s,n,l=Math.random()){const r=[];let i={...t.hero},o=[...t.enemies],c=[...t.loot],d=s.currentTargetId;const u=ha*e.gameSpeed,m=Nt(i,c);if(m){if(Ie(i,m)){const w=m.gold??0;return w>0&&(i={...i,gold:(i.gold??0)+w},r.push({type:"gold_picked",amount:w})),c=c.filter(N=>N.id!==m.id),o.length===0&&c.length===0?(r.push({type:"victory"}),{hero:i,enemies:o,loot:c,events:r,isGameOver:!0,heroWon:!0,targetCleared:!1}):{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:!1}}if(De(i,m)<Oe)return i=Xe(i,m,u),{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:!1}}const p=$a(i,o,e.aiMode,d);d=p.newTargetId,p.changed&&p.newTargetId&&r.push({type:"target_changed",from:s.currentTargetId,to:p.newTargetId});const f=p.target;if(!f){if(c.length>0){const w=Nt(i,c);i=Xe(i,w,u)}return{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:!1}}if($e(i,f)>Oe-10)return i=Xe(i,f,u),{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:!1};if(!s.canAttack)return{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:!1};const k=_a(i,o,e.skillConfig);let g=!1;if(k.shouldUseSkill&&k.skillId){if(k.skillId===O.HEAL){const w=gs(i,void 0,e.skillConfig);if(w)return i={...w.updatedCaster,health:w.updatedTarget.health},r.push({type:"skill_used",skillId:"heal",caster:"hero",target:"hero",message:w.result.message}),r.push({type:"heal_applied",target:"hero",amount:w.result.healing??0}),{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:!1}}if(k.skillId===O.POWER_STRIKE){const w=hs(i,f,e.skillConfig);if(w){i=w.updatedCaster;const N=w.updatedTarget,H=f.health-N.health;if(r.push({type:"skill_used",skillId:"power_strike",caster:"hero",target:f.id,message:w.result.message}),r.push({type:"damage_dealt",source:"hero",target:f.id,amount:H}),N.health<=0){const L=Mt(f,i,o,c,e.levelConfig,n(),l);i=L.hero,o=L.enemies,c=L.loot,r.push(...L.events),g=!0,d=null}else{const L=o.findIndex(E=>E.id===f.id);o[L]=N}if(o.length===0&&c.length===0)return r.push({type:"victory"}),{hero:i,enemies:o,loot:c,events:r,isGameOver:!0,heroWon:!0,targetCleared:g};const I=At(i,o,l);return i=I.hero,r.push(...I.events),I.heroDied?(r.push({type:"hero_died"}),{hero:i,enemies:o,loot:c,events:r,isGameOver:!0,heroWon:!1,targetCleared:g}):{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:g}}}}const v=Ve(i,f),y={...f,health:f.health-v,isAggroed:!0};if(r.push({type:"damage_dealt",source:"hero",target:f.id,amount:v}),y.health<=0){const w=Mt(f,i,o,c,e.levelConfig,n(),l);i=w.hero,o=w.enemies,c=w.loot,r.push(...w.events),g=!0,d=null}else{const w=o.findIndex(N=>N.id===f.id);o[w]=y}if(o.length===0&&c.length===0)return r.push({type:"victory"}),{hero:i,enemies:o,loot:c,events:r,isGameOver:!0,heroWon:!0,targetCleared:g};const b=At(i,o,l);return i=b.hero,r.push(...b.events),b.heroDied?(r.push({type:"hero_died"}),{hero:i,enemies:o,loot:c,events:r,isGameOver:!0,heroWon:!1,targetCleared:g}):{hero:i,enemies:o,loot:c,events:r,isGameOver:!1,heroWon:!1,targetCleared:g}}const Da=60;function Fa(t){return Math.max(1,Math.ceil(t/Da))}function Ba(t){switch(t.type){case"skill_used":return`[Auto] ${t.message}`;case"enemy_killed":return`[Auto] ${t.enemyName} defeated!`;case"xp_gained":return`[Auto] +${t.amount} XP`;case"gold_picked":return`[Auto] +${t.amount} Gold`;case"level_up":return`[Auto] LEVEL UP! Now level ${t.newLevel}!`;case"counterattack":return`[Auto] ${t.attackerName} hits Hero for ${t.damage}!`;case"hero_died":return"[Auto] Game Over!";case"victory":return"[Auto] Victory!";case"damage_dealt":return null;default:return null}}function Ka({isAutoMode:t,aiMode:e,gameState:s,setGameState:n,gameSpeed:l,isPaused:r,skillConfig:i,addEffect:o}){const c=i??ee,d=h.useRef(o);d.current=o;const u=h.useRef(null),m=h.useRef(0),p=h.useRef(null),f=h.useRef({currentTargetId:null,canAttack:!1});h.useEffect(()=>{if(!t||s.isGameOver||r){u.current&&cancelAnimationFrame(u.current);return}const x={skillConfig:c,levelConfig:he,aiMode:e,gameSpeed:l},k=()=>{const g=Fa(l);if(n(v=>{if(v.isGameOver)return v;let y=v,b=[],w=[],N=v.aggressionHistory;for(let I=0;I<g&&!y.isGameOver;I++){const L=Date.now(),E=Ut/l,A=L-m.current>=E;f.current.canAttack=A;const M=fs(y,x,f.current,()=>`loot-${Date.now()}-${I}`,Math.random());if(A&&M.events.some(S=>S.type==="damage_dealt"||S.type==="skill_used")){m.current=L;const S=M.events.find(G=>G.type==="damage_dealt");if(S&&S.type==="damage_dealt"){const G=M.enemies.find(V=>V.id===S.target);G&&(p.current={heroX:M.hero.x,heroY:M.hero.y,enemyX:G.x,enemyY:G.y})}}if(M.targetCleared)f.current.currentTargetId=null;else if(M.events.some(S=>S.type==="target_changed")){const S=M.events.find(G=>G.type==="target_changed");S&&S.type==="target_changed"&&(f.current.currentTargetId=S.to)}b.push(...M.events);const F=M.events.map(Ba).filter(S=>S!==null);w.push(...F);for(const S of M.events)if(S.type==="counterattack"){const G=M.enemies.find(V=>V.id===S.attackerId)??y.enemies.find(V=>V.id===S.attackerId);if((G==null?void 0:G.aggression)!==void 0){const V=N.findIndex(te=>te.enemyId===S.attackerId);V>=0?N=N.map((te,le)=>le===V?{...te,damageDealt:te.damageDealt+S.damage}:te):N=[...N,{enemyId:S.attackerId,aggression:G.aggression,damageDealt:S.damage}]}}y={...y,hero:M.hero,enemies:M.enemies,loot:M.loot,isGameOver:M.isGameOver,heroWon:M.heroWon}}const H=[...v.gameLog,...w].slice(-8);return{...y,gameLog:H,aggressionHistory:N}}),p.current&&d.current){const{heroX:v,heroY:y,enemyX:b,enemyY:w}=p.current;d.current("hook_punch",v,y,b,w),p.current=null}u.current=requestAnimationFrame(k)};return u.current=requestAnimationFrame(k),()=>{u.current&&cancelAnimationFrame(u.current)}},[t,e,s.isGameOver,n,l,r,c])}const Wa=500;function Ua({gameState:t,setGameState:e}){const s=h.useCallback((l,r,i,o,c,d=Wa)=>{const u={id:`effect-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,type:l,sourceX:r,sourceY:i,targetX:o,targetY:c,startTime:Date.now(),duration:d};e(m=>({...m,activeEffects:[...m.activeEffects,u]}))},[e]);h.useEffect(()=>{if(t.activeEffects.length===0)return;const l=Date.now();t.activeEffects.some(i=>l-i.startTime>=i.duration)&&e(i=>({...i,activeEffects:i.activeEffects.filter(o=>l-o.startTime<o.duration)}))},[t.activeEffects,e]);const n=h.useCallback(l=>{const r=Date.now()-l.startTime;return Math.min(1,r/l.duration)},[]);return{addEffect:s,getEffectProgress:n,activeEffects:t.activeEffects}}function ps(t=Math.random){return{x:_+t()*(U-_*2),y:_+t()*(K-_*2)}}function xs(t,e,s,n){const{gameSpeed:l,currentTime:r,idleDurationFn:i,randomFn:o,roamTargetFn:c}=n,d=new Map(s.roamTargets),u=new Map(s.idleEndTimes),m=e.map(f=>f.isAggroed?Va(f,t,l):f.isIdle?Ya(f,r,u,i,l):Xa(f,l,d,o,c)),p=new Set(e.map(f=>f.id));for(const f of d.keys())p.has(f)||d.delete(f);for(const f of u.keys())p.has(f)||u.delete(f);return{enemies:m,state:{roamTargets:d,idleEndTimes:u}}}function Va(t,e,s){const n=e.x-t.x,l=e.y-t.y,r=Math.sqrt(n*n+l*l);if(r<=Yt)return t;const i=ya*s,o=n/r*i,c=l/r*i,d=Math.max(_,Math.min(U-_,t.x+o)),u=Math.max(_,Math.min(K-_,t.y+c));return{...t,x:d,y:u}}function Ya(t,e,s,n,l){const r=s.get(t.id);if(r===void 0){const i=n()/l;return s.set(t.id,e+i),t}return e<r?t:(s.delete(t.id),{...t,isIdle:!1})}function Xa(t,e,s,n,l){let r=s.get(t.id);r||(r=l(),s.set(t.id,r));const i=r.x-t.x,o=r.y-t.y,c=Math.sqrt(i*i+o*o);if(c<pa)return s.delete(t.id),n()<xa?{...t,isIdle:!0}:t;const d=t.movementSpeed*e,u=i/c*d,m=o/c*d,p=Math.max(_,Math.min(U-_,t.x+u)),f=Math.max(_,Math.min(K-_,t.y+m));return{...t,x:p,y:f}}function za(){return Math.random()*(Vt-He)+He}function qa({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}){const l=h.useRef(null),r=h.useRef({roamTargets:new Map,idleEndTimes:new Map});h.useEffect(()=>{if(t.isGameOver||n){l.current&&(cancelAnimationFrame(l.current),l.current=null);return}const i=()=>{e(o=>{if(o.isGameOver||o.enemies.length===0)return o;const c=xs(o.hero,o.enemies,r.current,{gameSpeed:s,currentTime:Date.now(),idleDurationFn:za,randomFn:Math.random,roamTargetFn:()=>ps()});return r.current=c.state,{...o,enemies:c.enemies}}),l.current=requestAnimationFrame(i)};return l.current=requestAnimationFrame(i),()=>{l.current&&(cancelAnimationFrame(l.current),l.current=null)}},[t.isGameOver,e,s,n])}function Ja({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}){const l=h.useRef(null),r=h.useRef(0);h.useEffect(()=>{if(t.isGameOver||n){l.current&&(clearInterval(l.current),l.current=null);return}const i=()=>{const o=Date.now(),c=va/s;o-r.current<c||(e(d=>{if(d.isGameOver)return d;const u=d.enemies.filter(v=>{if(!v.isAggroed)return!1;const y=d.hero.x-v.x,b=d.hero.y-v.y;return Math.sqrt(y*y+b*b)<=Yt});if(u.length===0)return d;const m=u[0],p=Ve(m,d.hero),f=Math.max(0,d.hero.health-p),x=[...d.gameLog,`${m.name} attacks Hero for ${p} damage!`].slice(-8),k=d.enemies.map(v=>v.id===m.id?{...v,damageDealtToHero:(v.damageDealtToHero??0)+p}:v);let g=d.aggressionHistory;if(m.aggression!==void 0){const v=g.findIndex(y=>y.enemyId===m.id);v>=0?g=g.map((y,b)=>b===v?{...y,damageDealt:y.damageDealt+p}:y):g=[...g,{enemyId:m.id,aggression:m.aggression,damageDealt:p}]}return r.current=o,f<=0?(x.push("Game Over! The Hero has fallen!"),{...d,hero:{...d.hero,health:0,isFlashing:!0},enemies:k,gameLog:x,isGameOver:!0,heroWon:!1,aggressionHistory:g}):{...d,hero:{...d.hero,health:f,isFlashing:!0},enemies:k,gameLog:x,aggressionHistory:g}}),setTimeout(()=>{e(d=>({...d,hero:{...d.hero,isFlashing:!1}}))},200))};return l.current=window.setInterval(i,100),()=>{l.current&&(clearInterval(l.current),l.current=null)}},[t.isGameOver,e,s,n])}function vs(t,e,s=Math.random){const n=[];return{enemies:e.map(r=>{if(r.isAggroed)return r;const i=t.x-r.x,o=t.y-r.y;if(Math.sqrt(i*i+o*o)>wa)return r;const d=r.aggression??.5;return s()<d?(n.push(r.id),{...r,isAggroed:!0,isIdle:!1}):r}),newlyAggroedIds:n}}function Za({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}){const l=h.useRef(null);h.useEffect(()=>{if(t.isGameOver||n){l.current&&(clearInterval(l.current),l.current=null);return}const r=Xt/s,i=()=>{e(o=>{if(o.isGameOver)return o;const c=vs(o.hero,o.enemies);return c.newlyAggroedIds.length===0?o:{...o,enemies:c.enemies}})};return l.current=window.setInterval(i,r),()=>{l.current&&(clearInterval(l.current),l.current=null)}},[t.isGameOver,e,s,n])}function Qa({gameState:t,setGameState:e,gameSpeed:s,isPaused:n,spawnInterval:l,spawnJitter:r,maxEnemies:i,difficultyConfig:o=ye,baseAggression:c,hardMode:d=!0}){const u=h.useRef(null),[m,p]=h.useState(0),[f,x]=h.useState(0),k=h.useRef(0),g=h.useRef(0),v=h.useRef(null),[y,b]=h.useState(0),w=Zt(y,o);return qa({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}),Za({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}),Ja({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}),h.useEffect(()=>{if(t.isGameOver||n||l===0){u.current&&(clearTimeout(u.current),u.current=null),p(0),x(0),g.current=0;return}const H=()=>{const I=(Math.random()*2-1)*r*1e3,L=l*1e3,E=Math.max(100,(L+I)/s);k.current=Date.now(),g.current=E,u.current=window.setTimeout(()=>{b(A=>{const M=A+1;return e(F=>{if(F.isGameOver)return F;const S={difficultyConfig:o,baseAggression:c,maxEnemies:i,existingEnemies:F.enemies,hardMode:d},G=ns(F.enemies.length,M,S,()=>`enemy-spawn-${Date.now()}`);return G.enemy?{...F,enemies:[...F.enemies,G.enemy],gameLog:[...F.gameLog,`${G.enemy.name} appeared!`].slice(-8)}:F}),M}),H()},E)};return H(),()=>{u.current&&(clearTimeout(u.current),u.current=null)}},[t.isGameOver,e,s,n,l,r,i,o,c,d]),h.useEffect(()=>{if(t.isGameOver||n||l===0){v.current&&(cancelAnimationFrame(v.current),v.current=null);return}const H=()=>{const I=g.current,L=k.current;if(I>0&&L>0){const E=Date.now()-L,A=Math.max(0,I-E),M=Math.min(100,Math.max(0,E/I*100));p(M),x(A/1e3)}v.current=requestAnimationFrame(H)};return v.current=requestAnimationFrame(H),()=>{v.current&&(cancelAnimationFrame(v.current),v.current=null)}},[t.isGameOver,n,l]),{spawnProgress:m,timeRemaining:f,currentEnemyLevel:w,resetSpawnCount:()=>{b(0)}}}function Tt(t){const e=t.hpRecovery??0;if(e<=0||t.health>=t.maxHealth)return{entity:t,healAmount:0};const s=Math.min(e,t.maxHealth-t.health);return{entity:{...t,health:t.health+s},healAmount:s}}function ys(t,e){const s=Tt(t),n=new Map,l=e.map(r=>{const i=Tt(r);return i.healAmount>0&&n.set(r.id,i.healAmount),i.entity});return{hero:s.entity,enemies:l,heroHealAmount:s.healAmount,enemyHealAmounts:n}}function en({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}){h.useEffect(()=>{if(t.isGameOver||n)return;const l=setInterval(()=>{e(r=>{if(r.isGameOver)return r;const i=ys(r.hero,r.enemies);if(i.heroHealAmount===0&&i.enemyHealAmounts.size===0)return r;const o=i.heroHealAmount>0?[...r.gameLog,`Hero recovers ${i.heroHealAmount} HP`].slice(-8):r.gameLog;return{...r,hero:i.hero,enemies:i.enemies,gameLog:o}})},Wt/s);return()=>clearInterval(l)},[t.isGameOver,e,s,n])}function ws(t){const e=t.mana??0,s=t.maxMana??0,n=t.manaRegen??0;if(n<=0||e>=s)return{entity:t,regenAmount:0};const l=Math.min(n,s-e);return{entity:{...t,mana:e+l},regenAmount:l}}const tn=1e3;function sn({gameState:t,setGameState:e,gameSpeed:s,isPaused:n}){h.useEffect(()=>{if(t.isGameOver||n||!(t.hero.mana!==void 0&&t.hero.maxMana!==void 0&&t.hero.manaRegen!==void 0))return;const r=setInterval(()=>{e(i=>{if(i.isGameOver)return i;const o=ws(i.hero);return o.regenAmount===0?i:{...i,hero:o.entity}})},tn/s);return()=>clearInterval(r)},[t.isGameOver,e,s,n,t.hero.manaRegen])}const T={heroBall:"#93c5fd",heroOutline:"#3b82f6",heroHealthBar:"#86efac",enemyBall:"#fca5a5",enemyBallPassive:"#fca5a5",enemyBallAggressive:"#dc2626",enemyOutline:"#ef4444",healthBarBg:"#e5e7eb",healthBarDamaged:"#fde68a",background:"#fef3c7",gridLine:"#fcd34d",text:"#374151",attackFlash:"#fbbf24",rangeCircle:"#93c5fd",rangeCircleActive:"#22c55e",lootBall:"#fde047",lootOutline:"#eab308",aggroOutline:"#f97316",manaBar:"#3b82f6",manaBarBg:"#93c5fd",xpBar:"#fbbf24",xpBarBg:"#4b5563",xpText:"#f59e0b",goldText:"#ca8a04",enemyLevelText:"#991b1b"},Rt=50;function an(t,e,s){const n=parseInt(t.slice(1,3),16),l=parseInt(t.slice(3,5),16),r=parseInt(t.slice(5,7),16),i=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),c=parseInt(e.slice(5,7),16),d=Math.round(n+(i-n)*s),u=Math.round(l+(o-l)*s),m=Math.round(r+(c-r)*s);return`#${d.toString(16).padStart(2,"0")}${u.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`}function nn(t){if(t.isFlashing)return T.attackFlash;if(t.isHero)return T.heroBall;const e=t.aggression??0;return an(T.enemyBallPassive,T.enemyBallAggressive,e)}const Ne=50,ze=4,ln=2,It=10,fe=100,Se=36,rn=8,Lt=6,re=200,Me=12,ie=20,qe=4,_t=15,on=12;function xe(t,e,s,n,l,r){t.beginPath(),t.moveTo(e+r,s),t.lineTo(e+n-r,s),t.quadraticCurveTo(e+n,s,e+n,s+r),t.lineTo(e+n,s+l-r),t.quadraticCurveTo(e+n,s+l,e+n-r,s+l),t.lineTo(e+r,s+l),t.quadraticCurveTo(e,s+l,e,s+l-r),t.lineTo(e,s+r),t.quadraticCurveTo(e,s,e+r,s),t.closePath()}function cn(t,e){if(e.mana===void 0||e.maxMana===void 0)return;const s=e.y-Kt,n=e.x-Ne/2,l=s+Re+ln;t.fillStyle=T.manaBarBg,t.fillRect(n,l,Ne,ze);const r=e.maxMana>0?e.mana/e.maxMana:0;t.fillStyle=T.manaBar,t.fillRect(n,l,Ne*r,ze),t.strokeStyle=T.text,t.lineWidth=1,t.strokeRect(n,l,Ne,ze)}function dn(t,e,s){const n=(U-re)/2;xe(t,n,ie,re,Me,qe),t.fillStyle=T.xpBarBg,t.fill();const l=s.xpProgress/100;l>0&&(t.save(),t.beginPath(),xe(t,n,ie,re,Me,qe),t.clip(),t.fillStyle=T.xpBar,t.fillRect(n,ie,re*l,Me),t.restore()),xe(t,n,ie,re,Me,qe),t.strokeStyle=T.xpText,t.lineWidth=1,t.stroke(),t.fillStyle=T.xpText,t.font="bold 11px sans-serif",t.textAlign="right",t.fillText(`Lv.${s.level}`,n-8,ie+10),t.textAlign="left",t.font="10px sans-serif";const r=s.xpToNextLevel>0?`${s.currentXp} / ${s.currentXp+s.xpToNextLevel}`:"MAX";t.fillText(r,n+re+8,ie+10)}function Pt(t,e){e.isHero&&e.heroClass?Vs(t,e.heroClass,e.x,e.y,_):!e.isHero&&e.enemyType?Ys(t,e.enemyType,e.x,e.y,_,e.isFlashing,e.isAggroed):(t.beginPath(),t.arc(e.x,e.y,_,0,Math.PI*2),t.fillStyle=nn(e),t.fill(),!e.isHero&&e.isAggroed?(t.strokeStyle=T.aggroOutline,t.lineWidth=4):(t.strokeStyle=e.isHero?T.heroOutline:T.enemyOutline,t.lineWidth=3),t.stroke());const s=e.x-Ee/2,n=e.y-Kt;t.fillStyle=T.healthBarBg,t.fillRect(s,n,Ee,Re);const l=e.health/e.maxHealth,r=l>.5?T.heroHealthBar:T.healthBarDamaged;t.fillStyle=r,t.fillRect(s,n,Ee*l,Re),t.strokeStyle=T.text,t.lineWidth=1,t.strokeRect(s,n,Ee,Re),e.isHero&&cn(t,e),!e.isHero&&e.level!==void 0&&(t.fillStyle=T.enemyLevelText,t.font="bold 11px sans-serif",t.textAlign="center",t.fillText(`Lv.${e.level}`,e.x,n-4)),t.fillStyle=T.text,t.font="12px sans-serif",t.textAlign="center",t.fillText(`HP: ${e.health}/${e.maxHealth}`,e.x,e.y+_+15),t.fillText(`ATK: ${e.attack} DEF: ${e.defense}`,e.x,e.y+_+28)}function un(t){t.fillStyle=T.background,t.fillRect(0,0,U,K),t.strokeStyle=T.gridLine,t.lineWidth=1;for(let e=0;e<=U;e+=Rt)t.beginPath(),t.moveTo(e,0),t.lineTo(e,K),t.stroke();for(let e=0;e<=K;e+=Rt)t.beginPath(),t.moveTo(0,e),t.lineTo(U,e),t.stroke()}function mn(t,e){t.beginPath(),t.arc(e.x,e.y,_+8,0,Math.PI*2),t.strokeStyle=T.attackFlash,t.lineWidth=3,t.setLineDash([5,5]),t.stroke(),t.setLineDash([])}function hn(t,e,s){const n=s.some(l=>zt(e,l));t.beginPath(),t.arc(e.x,e.y,Oe,0,Math.PI*2),t.strokeStyle=n?T.rangeCircleActive:T.rangeCircle,t.lineWidth=2,t.setLineDash([8,4]),t.stroke(),t.setLineDash([])}function gn(t,e,s=0){t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,U,K),t.fillStyle=e?T.heroHealthBar:T.enemyBall,t.font="bold 48px sans-serif",t.textAlign="center",t.fillText(e?"VICTORY!":"GAME OVER",U/2,K/2);const n=U/2,l=K/2+50,r=20,i=12,o=-Math.PI/2,c=o+s*Math.PI*2;t.beginPath(),t.arc(n,l,r,0,Math.PI*2),t.arc(n,l,i,Math.PI*2,0,!0),t.fillStyle="rgba(255, 255, 255, 0.3)",t.fill(),s>0&&(t.beginPath(),t.moveTo(n+Math.cos(o)*i,l+Math.sin(o)*i),t.arc(n,l,r,o,c),t.arc(n,l,i,c,o,!0),t.closePath(),t.fillStyle=e?T.heroHealthBar:"rgba(255, 255, 255, 0.8)",t.fill())}function fn(t,e,s){t.fillStyle=T.text,t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("HERO",e,s-50)}function pn(t,e){t.beginPath(),t.arc(e.x,e.y,ca,0,Math.PI*2),t.fillStyle=T.lootBall,t.fill(),t.strokeStyle=T.lootOutline,t.lineWidth=2,t.stroke(),t.fillStyle="white",t.beginPath(),t.arc(e.x-3,e.y-3,3,0,Math.PI*2),t.fill()}function xn(t,e){const s=It,n=K-It-Se;e.forEach((l,r)=>{var x;const i=s+r*(fe+rn),o=n,{skill:c,onCooldown:d,cooldownRemaining:u,cooldownPercent:m}=l,p=c.effects[0],f=(p==null?void 0:p.type)==="damage";if(xe(t,i,o,fe,Se,Lt),d?t.fillStyle="#d1d5db":t.fillStyle=f?"#fecaca":"#bbf7d0",t.fill(),d){t.save(),t.clip();const k=fe*(m/100);t.fillStyle="rgba(107, 114, 128, 0.5)",t.fillRect(i,o,k,Se),t.restore(),xe(t,i,o,fe,Se,Lt)}if(t.strokeStyle=d?"#9ca3af":f?"#f87171":"#4ade80",t.lineWidth=2,t.stroke(),t.fillStyle=d?"#6b7280":"#1f2937",t.font="bold 11px sans-serif",t.textAlign="left",t.fillText(c.name,i+6,o+14),t.font="10px sans-serif",t.fillStyle="#4b5563",t.textAlign="left",d)t.fillText(`${(u/1e3).toFixed(1)}s`,i+6,o+28);else{const k=f?`${p==null?void 0:p.value}x DMG`:`+${p==null?void 0:p.value} HP`,g=((x=c.resourceCost)==null?void 0:x.amount)??0;t.fillText(k,i+6,o+28),t.fillStyle="#3b82f6",t.textAlign="right",t.fillText(`${g} MP`,i+fe-6,o+28)}})}function vn(t,e){const s=U-_t,n=K-_t;t.beginPath(),t.arc(s-50,n-6,on/2,0,Math.PI*2),t.fillStyle=T.lootBall,t.fill(),t.strokeStyle=T.lootOutline,t.lineWidth=1.5,t.stroke(),t.fillStyle=T.goldText,t.font="bold 8px sans-serif",t.textAlign="center",t.fillText("G",s-50,n-3),t.fillStyle=T.goldText,t.font="bold 16px sans-serif",t.textAlign="right",t.fillText(`${e}`,s,n)}function yn(t,e,s,n={}){const{showArcGuide:l=!1}=n;e.forEach(r=>{const i=s(r),o=Xs.find(u=>u.id===r.type);if(!o)return;const c={x:r.sourceX,y:r.sourceY},d={x:r.targetX,y:r.targetY};switch(r.type){case"hook_punch":zs(t,i,o.baseColor,o.accentColor,c,d,{fistSize:12,impactRays:8,showArcGuide:l,showArcTrail:l});break;default:t.beginPath(),t.moveTo(r.sourceX,r.sourceY);const u=r.sourceX+(r.targetX-r.sourceX)*i,m=r.sourceY+(r.targetY-r.sourceY)*i;t.lineTo(u,m),t.strokeStyle=o.baseColor,t.lineWidth=3,t.stroke();break}})}function wn({gameState:t,setGameState:e,isGameOver:s,skillConfig:n}){const l=n??ee,[,r]=h.useState(0),i=h.useMemo(()=>{const x=l.powerStrike.cooldown*1e3,k=l.heal.cooldown*1e3;return rs.map(g=>g.id===O.POWER_STRIKE?{...g,cooldown:x,resourceCost:g.resourceCost?{...g.resourceCost,amount:l.powerStrike.manaCost}:void 0}:g.id===O.HEAL?{...g,cooldown:k,resourceCost:g.resourceCost?{...g.resourceCost,amount:l.heal.manaCost}:void 0}:g)},[l.powerStrike.cooldown,l.powerStrike.manaCost,l.heal.cooldown,l.heal.manaCost]),o=h.useMemo(()=>i.map(x=>({skillId:x.id,isOnCooldown:ve(t.hero.id,x.id),remainingCooldown:st(t.hero.id,x.id)})),[i,t.hero.id]),c=h.useCallback(x=>ve(t.hero.id,x),[t.hero.id]),d=h.useCallback(x=>st(t.hero.id,x),[t.hero.id]),u=h.useCallback((x,k)=>{if(!x)return{success:!1,message:"Skill failed",affectedEntityId:""};const{result:g,updatedTarget:v}=x;return e(y=>{if(k)return{...y,hero:v,gameLog:[...y.gameLog,g.message].slice(-8)};const b=y.enemies.findIndex(I=>I.id===v.id);if(b===-1)return y;let w=[...y.enemies],N=[...y.loot],H=[...y.gameLog,g.message];if(v.health<=0){if(H.push(`${v.name} defeated!`),w=w.filter(I=>I.id!==v.id),N.push(qt(v.x,v.y,`loot-${Date.now()}`)),w.length===0)return H.push("Victory! All enemies defeated!"),{...y,enemies:w,loot:N,gameLog:H.slice(-8),isGameOver:!0,heroWon:!0}}else w[b]=v;return{...y,enemies:w,loot:N,gameLog:H.slice(-8)}}),r(y=>y+1),setTimeout(()=>{e(y=>({...y,hero:{...y.hero,isFlashing:!1},enemies:y.enemies.map(b=>({...b,isFlashing:!1}))}))},200),g},[e]),m=h.useCallback((x,k)=>{if(s)return{success:!1,message:"Game is over",affectedEntityId:""};if(x===O.POWER_STRIKE){const g=t.enemies.find(y=>y.id===k);if(!g)return{success:!1,message:"No target",affectedEntityId:""};const v=hs(t.hero,g,l);return u(v,!1)}if(x===O.HEAL){const g=gs(t.hero,void 0,l);return u(g,!0)}return{success:!1,message:"Unknown skill",affectedEntityId:""}},[s,t.hero,t.enemies,u,l]),p=h.useCallback(x=>m(O.POWER_STRIKE,x),[m]),f=h.useCallback(x=>m(O.HEAL,x??t.hero.id),[m,t.hero.id]);return{skills:i,skillStates:o,useSkill:m,usePowerStrike:p,useHeal:f,isSkillOnCooldown:c,getRemainingCooldown:d}}const D={isAutoMode:!0,aiMode:"attack_until_dead",gameSpeed:1,speedMultiplier:1,isSlowMode:!1,spawnInterval:5,spawnJitter:2,maxEnemies:ga,baseAggression:.5,isHardMode:!0,xpPerKill:he.xpPerKill,skillConfig:ee,difficultyConfig:ye,debug:{showEffectArcGuide:!1},ui:{controlPanelTab:"entity"}};class bn{getItem(e){try{return localStorage.getItem(e)}catch{return null}}setItem(e,s){try{localStorage.setItem(e,s)}catch{}}removeItem(e){try{localStorage.removeItem(e)}catch{}}}const kn="rpg-game-config";class Cn{constructor(e=new bn,s=kn){P(this,"storage");P(this,"storageKey");this.storage=e,this.storageKey=s}loadConfig(){const e=this.storage.getItem(this.storageKey);if(!e)return D;try{const s=JSON.parse(e);return this.mergeWithDefaults(s)}catch{return D}}saveConfig(e){const s=JSON.stringify(e);this.storage.setItem(this.storageKey,s)}clearConfig(){this.storage.removeItem(this.storageKey)}mergeWithDefaults(e){var s,n,l;return{...D,...e,skillConfig:{...D.skillConfig,...e.skillConfig,powerStrike:{...D.skillConfig.powerStrike,...(s=e.skillConfig)==null?void 0:s.powerStrike},heal:{...D.skillConfig.heal,...(n=e.skillConfig)==null?void 0:n.heal}},difficultyConfig:{...D.difficultyConfig,...e.difficultyConfig,scaling:{...D.difficultyConfig.scaling,...(l=e.difficultyConfig)==null?void 0:l.scaling}},ui:{...D.ui,...e.ui}}}}const Ot=new Cn;function En(){const t=()=>Ot.loadConfig(),[e,s]=h.useState(()=>t().isAutoMode),[n,l]=h.useState(()=>t().aiMode),[r,i]=h.useState(()=>t().gameSpeed),[o,c]=h.useState(()=>t().speedMultiplier),[d,u]=h.useState(()=>t().isSlowMode),[m,p]=h.useState(!1),[f,x]=h.useState(()=>t().spawnInterval),[k,g]=h.useState(()=>t().spawnJitter),[v,y]=h.useState(()=>t().maxEnemies),[b,w]=h.useState(()=>t().xpPerKill),[N,H]=h.useState(()=>t().skillConfig),[I,L]=h.useState(()=>t().difficultyConfig),[E,A]=h.useState(()=>{var Z;return((Z=t().debug)==null?void 0:Z.showEffectArcGuide)??!1}),[M,F]=h.useState(()=>t().ui.controlPanelTab),[S,G]=h.useState(()=>t().baseAggression),[V,te]=h.useState(()=>t().isHardMode??!0);h.useEffect(()=>{Ot.saveConfig({isAutoMode:e,aiMode:n,gameSpeed:r,speedMultiplier:o,isSlowMode:d,spawnInterval:f,spawnJitter:k,maxEnemies:v,baseAggression:S,isHardMode:V,xpPerKill:b,skillConfig:N,difficultyConfig:I,debug:{showEffectArcGuide:E},ui:{controlPanelTab:M}})},[e,n,r,o,d,f,k,v,S,V,b,N,I,E,M]);const le=h.useCallback(()=>{s(Z=>!Z)},[]),we=h.useCallback(()=>{p(Z=>!Z)},[]);return{isAutoMode:e,setIsAutoMode:s,aiMode:n,setAiMode:l,gameSpeed:r,setGameSpeed:i,speedMultiplier:o,setSpeedMultiplier:c,isSlowMode:d,setIsSlowMode:u,isPaused:m,setIsPaused:p,spawnInterval:f,setSpawnInterval:x,spawnJitter:k,setSpawnJitter:g,maxEnemies:v,setMaxEnemies:y,xpPerKill:b,setXpPerKill:w,skillConfig:N,setSkillConfig:H,difficultyConfig:I,setDifficultyConfig:L,showEffectArcGuide:E,setShowEffectArcGuide:A,controlPanelTab:M,setControlPanelTab:F,baseAggression:S,setBaseAggression:G,isHardMode:V,setIsHardMode:te,toggleAutoMode:le,togglePause:we}}const Ht=.15;function jn({gameState:t,setGameState:e}){const s=h.useRef(null),n=h.useRef(null),l=h.useCallback((o,c)=>{t.isGameOver||e(d=>{const u=Math.max(_,Math.min(U-_,d.hero.x+o)),m=Math.max(_,Math.min(K-_,d.hero.y+c));return{...d,hero:{...d.hero,x:u,y:m}}})},[t.isGameOver,e]);h.useEffect(()=>{const o=c=>{if(!t.isGameOver)switch(n.current&&(cancelAnimationFrame(n.current),n.current=null),c.key.toLowerCase()){case"w":case"arrowup":l(0,-je);break;case"s":case"arrowdown":l(0,je);break;case"a":case"arrowleft":l(-je,0);break;case"d":case"arrowright":l(je,0);break}};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[l,t.isGameOver]);const r=h.useCallback((o,c)=>{n.current&&cancelAnimationFrame(n.current);const d=()=>{e(u=>{const m=o-u.hero.x,p=c-u.hero.y;if(Math.sqrt(m*m+p*p)<1)return n.current=null,{...u,hero:{...u.hero,x:o,y:c}};const x=u.hero.x+m*Ht,k=u.hero.y+p*Ht;return n.current=requestAnimationFrame(d),{...u,hero:{...u.hero,x,y:k}}})};n.current=requestAnimationFrame(d)},[e]);h.useEffect(()=>()=>{n.current&&cancelAnimationFrame(n.current)},[]);const i=h.useCallback(o=>{if(t.isGameOver)return;const c=s.current;if(!c)return;const d=c.getBoundingClientRect(),u=o.clientX-d.left,m=o.clientY-d.top,p=Math.max(_,Math.min(U-_,u)),f=Math.max(_,Math.min(K-_,m));r(p,f)},[t.isGameOver,r]);return{canvasRef:s,handleCanvasClick:i}}const Nn=60;function Sn(t){return Math.max(1,Math.ceil(t/Nn))}function Mn(t,e){const[s,n]=h.useState(0),[l,r]=h.useState(0),i=h.useRef(0),o=h.useRef(0),c=h.useRef(performance.now()),d=h.useRef(null),u=h.useCallback(()=>{o.current++},[]);h.useEffect(()=>{if(e){n(0),r(0);return}const p=()=>{i.current++;const f=performance.now(),x=f-c.current;x>=1e3&&(n(Math.round(i.current*1e3/x)),r(Math.round(o.current*1e3/x)),i.current=0,o.current=0,c.current=f),d.current=requestAnimationFrame(p)};return d.current=requestAnimationFrame(p),()=>{d.current&&cancelAnimationFrame(d.current)}},[e]);const m=Sn(t);return{fps:s,renders:l,ticksPerFrame:m,effectiveTps:s*m,countRender:u}}function bs({gameState:t,setGameState:e}){return a.jsxs("div",{"data-test":"entity-tab-content",className:"h-full overflow-y-auto space-y-4 landscape:space-y-2 md:landscape:space-y-4 mt-3 landscape:mt-1 md:landscape:mt-3",children:[a.jsx(An,{gameState:t,setGameState:e}),a.jsx(Tn,{gameState:t,setGameState:e}),a.jsx(Rn,{gameState:t,setGameState:e})]})}function An({gameState:t,setGameState:e}){return a.jsxs("div",{"data-test":"hero-controls",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Hero Stats"}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Health"}),a.jsx(X,{type:"number",value:t.hero.health,onChange:s=>e(n=>({...n,hero:{...n.hero,health:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Max Health"}),a.jsx(X,{type:"number",value:t.hero.maxHealth,onChange:s=>e(n=>({...n,hero:{...n.hero,maxHealth:Math.max(1,parseInt(s.target.value)||1)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Mana"}),a.jsx(X,{type:"number",value:t.hero.mana??0,onChange:s=>e(n=>({...n,hero:{...n.hero,mana:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Max Mana"}),a.jsx(X,{type:"number",value:t.hero.maxMana??0,onChange:s=>e(n=>({...n,hero:{...n.hero,maxMana:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Attack"}),a.jsx(X,{type:"number",value:t.hero.attack,onChange:s=>e(n=>({...n,hero:{...n.hero,attack:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Defense"}),a.jsx(X,{type:"number",value:t.hero.defense,onChange:s=>e(n=>({...n,hero:{...n.hero,defense:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"HP Recovery"}),a.jsx(X,{type:"number",value:t.hero.hpRecovery,onChange:s=>e(n=>({...n,hero:{...n.hero,hpRecovery:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Mana Regen"}),a.jsx(X,{type:"number",value:t.hero.manaRegen??0,onChange:s=>e(n=>({...n,hero:{...n.hero,manaRegen:Math.max(0,parseInt(s.target.value)||0)}})),className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Move Speed"}),a.jsx(X,{type:"number",step:"0.5",value:t.hero.movementSpeed,onChange:s=>e(n=>({...n,hero:{...n.hero,movementSpeed:Math.max(0,parseFloat(s.target.value)||0)}})),className:"h-8 text-sm"})]})]})]})}function Tn({gameState:t,setGameState:e}){var s,n,l,r;return a.jsxs("div",{"data-test":"enemy-stats-controls",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Enemy Stats (All)"}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Health"}),a.jsx(X,{type:"number",value:((s=t.enemies[0])==null?void 0:s.health)??5,onChange:i=>{const o=Math.max(1,parseInt(i.target.value)||1);e(c=>({...c,enemies:c.enemies.map(d=>({...d,health:o,maxHealth:o}))}))},className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Attack"}),a.jsx(X,{type:"number",value:((n=t.enemies[0])==null?void 0:n.attack)??1,onChange:i=>{const o=Math.max(0,parseInt(i.target.value)||0);e(c=>({...c,enemies:c.enemies.map(d=>({...d,attack:o}))}))},className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Defense"}),a.jsx(X,{type:"number",value:((l=t.enemies[0])==null?void 0:l.defense)??0,onChange:i=>{const o=Math.max(0,parseInt(i.target.value)||0);e(c=>({...c,enemies:c.enemies.map(d=>({...d,defense:o}))}))},className:"h-8 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"text-xs text-gray-600",children:"Move Speed"}),a.jsx(X,{type:"number",step:"0.1",value:((r=t.enemies[0])==null?void 0:r.movementSpeed)??.8,onChange:i=>{const o=Math.max(0,parseFloat(i.target.value)||0);e(c=>({...c,enemies:c.enemies.map(d=>({...d,movementSpeed:o}))}))},className:"h-8 text-sm"})]})]})]})}function Rn({gameState:t,setGameState:e}){return a.jsxs("div",{"data-test":"enemy-actions",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Enemy Actions"}),a.jsxs("div",{className:"flex flex-col gap-2",children:[a.jsx(Q,{size:"sm",variant:"outline",className:"bg-red-100 hover:bg-red-200 border-red-300 text-xs",onClick:()=>e(s=>{var n,l,r,i,o;return{...s,enemies:[...s.enemies,{id:`enemy-${Date.now()}`,name:rt,x:600,y:Math.random()*400+50,health:((n=s.enemies[0])==null?void 0:n.maxHealth)??5,maxHealth:((l=s.enemies[0])==null?void 0:l.maxHealth)??5,attack:((r=s.enemies[0])==null?void 0:r.attack)??1,defense:((i=s.enemies[0])==null?void 0:i.defense)??0,hpRecovery:0,movementSpeed:((o=s.enemies[0])==null?void 0:o.movementSpeed)??.8,isHero:!1,isFlashing:!1,isIdle:!0}]}}),children:"+ Spawn Enemy"}),a.jsx(Q,{size:"sm",variant:"outline",className:"bg-orange-100 hover:bg-orange-200 border-orange-300 text-xs",onClick:()=>e(s=>({...s,enemies:s.enemies.slice(0,-1)})),children:"- Remove Last"}),a.jsx(Q,{size:"sm",variant:"outline",className:"bg-gray-100 hover:bg-gray-200 border-gray-300 text-xs",onClick:()=>e(s=>({...s,enemies:[]})),children:"Clear All"})]})]})}const Gt=1,$t=10,In=[1,5,10];function Ln({gameState:t,setGameState:e,gameSpeed:s,setGameSpeed:n,speedMultiplier:l,setSpeedMultiplier:r,isSlowMode:i,setIsSlowMode:o,spawnInterval:c,setSpawnInterval:d,spawnJitter:u,setSpawnJitter:m,maxEnemies:p,setMaxEnemies:f,xpPerKill:x,setXpPerKill:k,currentEnemyLevel:g,difficultyConfig:v,setDifficultyConfig:y}){return a.jsxs("div",{"data-test":"game-tab-content",className:"h-full overflow-y-auto space-y-4 landscape:space-y-2 md:landscape:space-y-4 mt-3 landscape:mt-1 md:landscape:mt-3",children:[a.jsx(_n,{gameSpeed:s,setGameSpeed:n,speedMultiplier:l,setSpeedMultiplier:r,isSlowMode:i,setIsSlowMode:o}),a.jsx(Pn,{spawnInterval:c,setSpawnInterval:d,spawnJitter:u,setSpawnJitter:m,maxEnemies:p,setMaxEnemies:f}),a.jsx(Gn,{currentEnemyLevel:g,difficultyConfig:v,setDifficultyConfig:y}),a.jsx(On,{xpPerKill:x,setXpPerKill:k}),a.jsx(Hn,{gameState:t,setGameState:e})]})}function _n({gameSpeed:t,setGameSpeed:e,speedMultiplier:s,setSpeedMultiplier:n,isSlowMode:l,setIsSlowMode:r}){const i=Math.min($t,Math.max(Gt,Math.round(t/s))),o=m=>{const p=Number(m);n(p),e(i*p)},c=m=>{e(m*s)},d=i*s,u=l?`1/${d}x`:`${d}x`;return a.jsxs("div",{"data-test":"game-speed-controls",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Game Speed"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Speed"}),a.jsx("span",{className:l?"text-blue-600":"",children:u})]}),a.jsx(J,{"data-test":"game-speed-slider",value:[i],onValueChange:([m])=>c(m),min:Gt,max:$t,step:1,className:"w-full"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("span",{className:"text-xs text-gray-600",children:"Multiplier:"}),a.jsx(Ps,{"data-test":"speed-multiplier-radio",value:String(s),onValueChange:o,className:"flex gap-4",children:In.map(m=>a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(Os,{"data-test":`speed-multiplier-${m}`,value:String(m),id:`speed-mult-${m}`,className:"h-3 w-3"}),a.jsxs(Hs,{htmlFor:`speed-mult-${m}`,className:"text-xs text-gray-600 cursor-pointer",children:["Ã—",m]})]},m))})]}),a.jsxs("label",{className:"flex items-center gap-2 text-xs text-gray-600 cursor-pointer",children:[a.jsx("input",{type:"checkbox","data-test":"slow-mode-checkbox",checked:l,onChange:m=>r(m.target.checked),className:"rounded border-gray-300"}),a.jsx("span",{children:"Slow down"})]})]})]})}function Pn({spawnInterval:t,setSpawnInterval:e,spawnJitter:s,setSpawnJitter:n,maxEnemies:l,setMaxEnemies:r}){return a.jsxs("div",{"data-test":"spawn-interval-controls",className:"space-y-3 landscape:space-y-1 md:landscape:space-y-3",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Enemy Spawn"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Interval"}),a.jsx("span",{children:t===0?"Off":`${t}s`})]}),a.jsx(J,{value:[t],onValueChange:([i])=>e(i),min:0,max:15,step:1,className:"w-full"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Jitter"}),a.jsxs("span",{children:["+/-",s,"s"]})]}),a.jsx(J,{value:[s],onValueChange:([i])=>n(i),min:0,max:5,step:.5,className:"w-full"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Max Goblins"}),a.jsx("span",{children:l})]}),a.jsx(J,{value:[l],onValueChange:([i])=>r(i),min:1,max:20,step:1,className:"w-full"})]})]})}function On({xpPerKill:t,setXpPerKill:e}){return a.jsxs("div",{"data-test":"leveling-controls",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Leveling"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"XP per Kill"}),a.jsx("span",{children:t})]}),a.jsx(J,{"data-test":"xp-per-kill-slider",value:[t],onValueChange:([s])=>e(s),min:1,max:20,step:1,className:"w-full"})]})]})}function Hn({gameState:t,setGameState:e}){return a.jsxs("div",{"data-test":"game-controls-section",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Game"}),a.jsx(Q,{size:"sm",variant:"outline",className:"w-full bg-green-100 hover:bg-green-200 border-green-300 text-xs",onClick:()=>e(s=>({...s,hero:{...s.hero,health:s.hero.maxHealth}})),children:"Full Heal Hero"})]})}function Gn({currentEnemyLevel:t,difficultyConfig:e,setDifficultyConfig:s}){const{spawnsPerLevelUp:n,maxEnemyLevel:l,scaling:r}=e,i=d=>`+${Math.round((d-1)*100)}%`,o=d=>{s(u=>({...u,...d}))},c=d=>{s(u=>({...u,scaling:{...u.scaling,...d}}))};return a.jsxs("div",{"data-test":"difficulty-scaling-controls",className:"space-y-3 landscape:space-y-1 md:landscape:space-y-3",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Difficulty Scaling"}),t!==void 0&&a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Current Enemy Level"}),a.jsxs("span",{className:"font-semibold text-red-600",children:["Lv.",t]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Level Up Every"}),a.jsxs("span",{children:[n," spawns"]})]}),a.jsx(J,{"data-test":"spawns-per-levelup-slider",value:[n],onValueChange:([d])=>o({spawnsPerLevelUp:d}),min:1,max:20,step:1,className:"w-full"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:"Max Level"}),a.jsx("span",{children:l})]}),a.jsx(J,{"data-test":"max-enemy-level-slider",value:[l],onValueChange:([d])=>o({maxEnemyLevel:d}),min:1,max:50,step:1,className:"w-full"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{className:"text-green-600",children:"HP per Level"}),a.jsx("span",{children:i(r.healthMultiplier)})]}),a.jsx(J,{"data-test":"health-multiplier-slider",value:[r.healthMultiplier*100],onValueChange:([d])=>c({healthMultiplier:d/100}),min:100,max:200,step:5,className:"w-full"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{className:"text-red-600",children:"ATK per Level"}),a.jsx("span",{children:i(r.attackMultiplier)})]}),a.jsx(J,{"data-test":"attack-multiplier-slider",value:[r.attackMultiplier*100],onValueChange:([d])=>c({attackMultiplier:d/100}),min:100,max:200,step:5,className:"w-full"})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{className:"text-blue-600",children:"DEF per Level"}),a.jsx("span",{children:i(r.defenseMultiplier)})]}),a.jsx(J,{"data-test":"defense-multiplier-slider",value:[r.defenseMultiplier*100],onValueChange:([d])=>c({defenseMultiplier:d/100}),min:100,max:200,step:5,className:"w-full"})]})]})}function $n({skills:t,isSkillOnCooldown:e,getRemainingCooldown:s,skillConfig:n,setSkillConfig:l}){return a.jsx("div",{"data-test":"skills-tab-content",className:"h-full overflow-y-auto space-y-4 landscape:space-y-2 md:landscape:space-y-4 mt-3 landscape:mt-1 md:landscape:mt-3",children:a.jsxs("div",{"data-test":"skills-controls",className:"space-y-3 landscape:space-y-1 md:landscape:space-y-3",children:[a.jsx("h3",{className:"text-sm landscape:text-[10px] md:landscape:text-sm font-semibold text-purple-700",children:"Hero Skills"}),t.map(r=>{const i=e(r.id),o=s(r.id),c=r.effects[0],d=(c==null?void 0:c.type)==="damage";return a.jsx(Dn,{skill:r,onCooldown:i,cooldownRemaining:o,isDamage:d,effectValue:c==null?void 0:c.value,skillConfig:n,setSkillConfig:l},r.id)})]})})}function Dn({skill:t,onCooldown:e,cooldownRemaining:s,isDamage:n,skillConfig:l,setSkillConfig:r}){const i=t.id===O.POWER_STRIKE,o=t.id===O.HEAL;return a.jsxs("div",{"data-test":`skill-panel-${t.id}`,className:`p-3 landscape:p-1.5 md:landscape:p-3 rounded-lg border ${n?"bg-red-50 border-red-200":"bg-green-50 border-green-200"}`,children:[a.jsxs("div",{className:"flex justify-between items-center mb-1 landscape:mb-0.5 md:landscape:mb-1",children:[a.jsx("span",{className:"font-medium text-sm landscape:text-[10px] md:landscape:text-sm",children:t.name}),a.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${e?"bg-gray-200 text-gray-600":"bg-green-200 text-green-700"}`,children:e?`${(s/1e3).toFixed(1)}s`:"Ready"})]}),i&&a.jsx(Fn,{skillConfig:l,setSkillConfig:r}),o&&a.jsx(Bn,{skillConfig:l,setSkillConfig:r})]})}function Fn({skillConfig:t,setSkillConfig:e}){const{powerStrike:s}=t,n=is.powerStrike;return a.jsxs("div",{"data-test":"power-strike-controls",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2 mt-2",children:[a.jsx(me,{dataTest:"power-strike-damage-multiplier",label:"Damage Multiplier",value:s.damageMultiplier,displayValue:`${s.damageMultiplier}x`,min:n.damageMultiplier.min,max:n.damageMultiplier.max,step:n.damageMultiplier.step,onChange:l=>e(r=>({...r,powerStrike:{...r.powerStrike,damageMultiplier:l}}))}),a.jsx(me,{dataTest:"power-strike-mana-cost",label:"Mana Cost",value:s.manaCost,displayValue:s.manaCost.toString(),min:n.manaCost.min,max:n.manaCost.max,step:n.manaCost.step,onChange:l=>e(r=>({...r,powerStrike:{...r.powerStrike,manaCost:l}}))}),a.jsx(me,{dataTest:"power-strike-cooldown",label:"Cooldown",value:s.cooldown,displayValue:`${s.cooldown}s`,min:n.cooldown.min,max:n.cooldown.max,step:n.cooldown.step,onChange:l=>e(r=>({...r,powerStrike:{...r.powerStrike,cooldown:l}}))})]})}function Bn({skillConfig:t,setSkillConfig:e}){const{heal:s}=t,n=is.heal;return a.jsxs("div",{"data-test":"heal-controls",className:"space-y-2 landscape:space-y-1 md:landscape:space-y-2 mt-2",children:[a.jsx(me,{dataTest:"heal-heal-amount",label:"Heal Amount",value:s.healAmount,displayValue:`+${s.healAmount} HP`,min:n.healAmount.min,max:n.healAmount.max,step:n.healAmount.step,onChange:l=>e(r=>({...r,heal:{...r.heal,healAmount:l}}))}),a.jsx(me,{dataTest:"heal-mana-cost",label:"Mana Cost",value:s.manaCost,displayValue:s.manaCost.toString(),min:n.manaCost.min,max:n.manaCost.max,step:n.manaCost.step,onChange:l=>e(r=>({...r,heal:{...r.heal,manaCost:l}}))}),a.jsx(me,{dataTest:"heal-cooldown",label:"Cooldown",value:s.cooldown,displayValue:`${s.cooldown}s`,min:n.cooldown.min,max:n.cooldown.max,step:n.cooldown.step,onChange:l=>e(r=>({...r,heal:{...r.heal,cooldown:l}}))})]})}function me({dataTest:t,label:e,value:s,displayValue:n,min:l,max:r,step:i,onChange:o}){return a.jsxs("div",{"data-test":t,className:"space-y-1 landscape:space-y-0.5 md:landscape:space-y-1",children:[a.jsxs("div",{className:"flex justify-between text-xs text-gray-600",children:[a.jsx("span",{children:e}),a.jsx("span",{className:"font-medium",children:n})]}),a.jsx(J,{"data-test":`${t}-slider`,value:[s],onValueChange:([c])=>o(c),min:l,max:r,step:i,className:"w-full"})]})}function Dt({gameState:t,setGameState:e,controlPanelTab:s,setControlPanelTab:n,gameSpeed:l,setGameSpeed:r,speedMultiplier:i,setSpeedMultiplier:o,isSlowMode:c,setIsSlowMode:d,spawnInterval:u,setSpawnInterval:m,spawnJitter:p,setSpawnJitter:f,maxEnemies:x,setMaxEnemies:k,xpPerKill:g,setXpPerKill:v,skills:y,isSkillOnCooldown:b,getRemainingCooldown:w,skillConfig:N,setSkillConfig:H,currentEnemyLevel:I,difficultyConfig:L,setDifficultyConfig:E,className:A=""}){return a.jsxs("div",{"data-test":"control-panel",className:`bg-purple-50 border-2 border-purple-300 rounded-lg p-4 landscape:p-2 md:landscape:p-4 shadow-md flex flex-col h-full min-h-0 overflow-auto md:overflow-hidden ${A}`,children:[a.jsx("h2",{"data-test":"control-title",className:"text-lg landscape:text-xs md:landscape:text-lg font-semibold mb-3 landscape:mb-1 md:landscape:mb-3 text-purple-800 flex-shrink-0",children:"Control Panel"}),a.jsxs(at,{value:s,onValueChange:n,className:"flex-1 flex flex-col min-h-0",children:[a.jsxs(nt,{className:"w-full flex-shrink-0",children:[a.jsx(se,{value:"entity",className:"flex-1",children:"Entity"}),a.jsx(se,{value:"game",className:"flex-1",children:"Game"}),a.jsx(se,{value:"skills",className:"flex-1",children:"Skills"})]}),a.jsx(ae,{value:"entity",className:"flex-1 min-h-0 overflow-auto md:overflow-hidden",children:a.jsx(bs,{gameState:t,setGameState:e})}),a.jsx(ae,{value:"game",className:"flex-1 min-h-0 overflow-auto md:overflow-hidden",children:a.jsx(Ln,{gameState:t,setGameState:e,gameSpeed:l,setGameSpeed:r,speedMultiplier:i,setSpeedMultiplier:o,isSlowMode:c,setIsSlowMode:d,spawnInterval:u,setSpawnInterval:m,spawnJitter:p,setSpawnJitter:f,maxEnemies:x,setMaxEnemies:k,xpPerKill:g,setXpPerKill:v,currentEnemyLevel:I,difficultyConfig:L,setDifficultyConfig:E})}),a.jsx(ae,{value:"skills",className:"flex-1 min-h-0 overflow-auto md:overflow-hidden",children:a.jsx($n,{skills:y,isSkillOnCooldown:b,getRemainingCooldown:w,skillConfig:N,setSkillConfig:H})})]})]})}const Ft=qs({tabs:[{id:"game",label:"Game",sections:[{id:"speed",label:"Game Speed",fields:[{name:"gameSpeed",label:"Speed",type:"slider",min:1,max:10,step:1,format:(t,e)=>{const s=(e==null?void 0:e.speedMultiplier)??1,n=(e==null?void 0:e.isSlowMode)??!1,l=t*s;return n?`${t} (1/${l}Ã—)`:`${t} (${l}Ã—)`}},{name:"speedMultiplier",label:"Multiplier",type:"radio",direction:"horizontal",options:[{value:1,label:"Ã—1"},{value:5,label:"Ã—5"},{value:10,label:"Ã—10"},{value:100,label:"Ã—100"}]},{name:"isSlowMode",label:"Slow down (1/speed)",type:"checkbox"}]},{id:"aiTarget",label:"AI Target",fields:[{name:"aiMode",label:"Target Mode",type:"radio",direction:"horizontal",options:[{value:"closest",label:"Closest"},{value:"attack_until_dead",label:"Focus"},{value:"focus_least_hp",label:"Low HP"}]}]},{id:"spawn",label:"Enemy Spawn",fields:[{name:"spawnInterval",label:"Interval",type:"slider",min:0,max:15,step:1,format:t=>t===0?"Off":`${t}s`},{name:"spawnJitter",label:"Jitter",type:"slider",min:0,max:5,step:.5,format:t=>`Â±${t}s`},{name:"maxEnemies",label:"Max Goblins",type:"slider",min:1,max:20,step:1},{name:"baseAggression",label:"Base Aggression",type:"slider",min:0,max:1,step:.1,format:t=>`${Math.round(t*100)}%`}]},{id:"difficulty",label:"Difficulty Scaling",fields:[{name:"difficultyConfig.spawnsPerLevelUp",label:"Level Up Every",type:"slider",min:1,max:20,step:1,format:t=>`${t} spawns`},{name:"difficultyConfig.maxEnemyLevel",label:"Max Level",type:"slider",min:1,max:50,step:1},{name:"difficultyConfig.scaling.healthMultiplier",label:"HP per Level",type:"slider",min:1,max:2,step:.05,format:t=>`+${Math.round((t-1)*100)}%`},{name:"difficultyConfig.scaling.attackMultiplier",label:"ATK per Level",type:"slider",min:1,max:2,step:.05,format:t=>`+${Math.round((t-1)*100)}%`},{name:"difficultyConfig.scaling.defenseMultiplier",label:"DEF per Level",type:"slider",min:1,max:2,step:.05,format:t=>`+${Math.round((t-1)*100)}%`}]},{id:"leveling",label:"Leveling",fields:[{name:"xpPerKill",label:"XP per Kill",type:"slider",min:1,max:20,step:1}]}]},{id:"skills",label:"Skills",sections:[{id:"powerStrike",label:"Power Strike",className:"bg-red-50 border border-red-200 rounded-lg p-3",fields:[{name:"skillConfig.powerStrike.damageMultiplier",label:"Damage Multiplier",type:"slider",min:1,max:5,step:.5,format:t=>`${t}x`},{name:"skillConfig.powerStrike.manaCost",label:"Mana Cost",type:"slider",min:0,max:50,step:1},{name:"skillConfig.powerStrike.cooldown",label:"Cooldown",type:"slider",min:1,max:10,step:.5,format:t=>`${t}s`}]},{id:"heal",label:"Heal",className:"bg-green-50 border border-green-200 rounded-lg p-3",fields:[{name:"skillConfig.heal.healAmount",label:"Heal Amount",type:"slider",min:1,max:20,step:1,format:t=>`+${t} HP`},{name:"skillConfig.heal.manaCost",label:"Mana Cost",type:"slider",min:0,max:50,step:1},{name:"skillConfig.heal.cooldown",label:"Cooldown",type:"slider",min:1,max:10,step:.5,format:t=>`${t}s`}]}]}]}),q={GAME:"game",SKILLS:"skills",ENTITY:"entity"};function Kn(t,e,s){const n=e.split("."),l={...t};let r=l;for(let i=0;i<n.length-1;i++){const o=n[i];r[o]={...r[o]},r=r[o]}return r[n[n.length-1]]=s,l}function Wn(t){return t.split(".")[0]}function Un({config:t,onConfigChange:e,activeTab:s,onTabChange:n,gameState:l,setGameState:r,className:i=""}){const[o,c]=h.useState(!1),d=h.useCallback(()=>{switch(s){case q.GAME:return{isAutoMode:t.isAutoMode,aiMode:t.aiMode,gameSpeed:t.gameSpeed,speedMultiplier:t.speedMultiplier,isSlowMode:t.isSlowMode,spawnInterval:t.spawnInterval,spawnJitter:t.spawnJitter,maxEnemies:t.maxEnemies,baseAggression:t.baseAggression,xpPerKill:t.xpPerKill,difficultyConfig:t.difficultyConfig,debug:t.debug,ui:t.ui};case q.SKILLS:return{skillConfig:t.skillConfig};case q.ENTITY:return{hero:l.hero,enemies:l.enemies};default:return{}}},[s,t,l]),u=h.useCallback(async()=>{const p=d();await navigator.clipboard.writeText(JSON.stringify(p,null,2)),c(!0),setTimeout(()=>c(!1),1500)},[d]),m=h.useCallback((p,f)=>{const x=Wn(p);if(p.includes(".")){const g=Kn(t,p,f)[x];e(x,g)}else e(x,f)},[t,e]);return a.jsxs("div",{"data-test":"control-panel-v2",className:`bg-purple-50 border-2 border-purple-300 rounded-lg p-4 landscape:p-2 md:landscape:p-4 shadow-md flex flex-col h-full min-h-0 overflow-hidden ${i}`,children:[a.jsxs("div",{"data-test":"control-title",className:"flex items-center justify-between mb-3 landscape:mb-1 md:landscape:mb-3 flex-shrink-0",children:[a.jsx("h2",{className:"text-lg landscape:text-xs md:landscape:text-lg font-semibold text-purple-800",children:"Control Panel v2"}),a.jsx(Q,{"data-test":"copy-tab-data",variant:"ghost",size:"smIcon",onClick:u,title:"Copy tab data",children:o?a.jsx(_e,{className:"h-4 w-4 text-green-600"}):a.jsx(Pe,{className:"h-4 w-4"})})]}),a.jsxs(at,{value:s,onValueChange:p=>n(p),className:"flex-1 flex flex-col min-h-0",children:[a.jsxs(nt,{className:"w-full flex-shrink-0",children:[a.jsx(se,{value:q.GAME,className:"flex-1",children:"Game"}),a.jsx(se,{value:q.SKILLS,className:"flex-1",children:"Skills"}),a.jsx(se,{value:q.ENTITY,className:"flex-1",children:"Entity"})]}),a.jsx(ae,{value:q.GAME,className:"flex-1 min-h-0 overflow-auto mt-3",children:a.jsx(kt,{schema:Ft,values:t,onChange:m,activeTab:q.GAME,className:"space-y-4 landscape:space-y-2 md:landscape:space-y-4"})}),a.jsx(ae,{value:q.SKILLS,className:"flex-1 min-h-0 overflow-auto mt-3",children:a.jsx(kt,{schema:Ft,values:t,onChange:m,activeTab:q.SKILLS,className:"space-y-4 landscape:space-y-2 md:landscape:space-y-4"})}),a.jsx(ae,{value:q.ENTITY,className:"flex-1 min-h-0 overflow-auto mt-3",children:a.jsx(bs,{gameState:l,setGameState:r})})]})]})}function Vn({fpsStats:t,gameSpeed:e}){return a.jsx("div",{"data-test":"stats-panel",className:"bg-gray-50 border border-gray-200 rounded-lg p-2 flex-1",children:a.jsxs("div",{"data-test":"debug-fps",className:"grid grid-cols-5 gap-1 text-xs",children:[a.jsxs("div",{className:"text-center p-1 bg-white rounded border",children:[a.jsx("div",{className:"text-gray-500 text-[10px]",children:"FPS"}),a.jsx("div",{className:"font-mono text-gray-700",children:t.fps})]}),a.jsxs("div",{className:"text-center p-1 bg-white rounded border",children:[a.jsx("div",{className:"text-gray-500 text-[10px]",children:"Renders"}),a.jsx("div",{className:"font-mono text-orange-600",children:t.renders})]}),a.jsxs("div",{className:"text-center p-1 bg-white rounded border",children:[a.jsx("div",{className:"text-gray-500 text-[10px]",children:"Speed"}),a.jsxs("div",{className:"font-mono text-gray-700",children:[e,"x"]})]}),a.jsxs("div",{className:"text-center p-1 bg-white rounded border",children:[a.jsx("div",{className:"text-gray-500 text-[10px]",children:"Batch"}),a.jsx("div",{className:"font-mono text-blue-600",children:t.ticksPerFrame})]}),a.jsxs("div",{className:"text-center p-1 bg-white rounded border",children:[a.jsx("div",{className:"text-gray-500 text-[10px]",children:"TPS"}),a.jsx("div",{className:"font-mono text-purple-600 font-bold",children:t.effectiveTps})]})]})})}function Yn({gameState:t,spawnProgress:e,timeRemaining:s,spawnInterval:n,inheritedAggression:l}){return a.jsxs("div",{"data-test":"enemies-panel",className:"bg-red-50 border border-red-200 rounded-lg p-3 landscape:p-1.5 md:landscape:p-3 flex-1",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2 landscape:mb-1 md:landscape:mb-2 gap-4 landscape:gap-2 md:landscape:gap-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("h3",{"data-test":"enemies-title",className:"font-semibold text-red-700 text-sm landscape:text-xs md:landscape:text-sm whitespace-nowrap",children:["Enemies (",t.enemies.length,")"]}),l!==void 0&&a.jsxs("span",{"data-test":"inherited-aggression",className:"text-xs text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded",children:["Base: ",Math.round(l*100),"%"]})]}),a.jsx(Xn,{spawnProgress:e,timeRemaining:s,spawnInterval:n})]}),a.jsx(zn,{gameState:t})]})}function Xn({spawnProgress:t,timeRemaining:e,spawnInterval:s}){return a.jsxs("div",{"data-test":"spawn-progress",className:"flex items-center gap-2 landscape:gap-1 md:landscape:gap-2 flex-1 min-w-0",children:[a.jsx("span",{className:"text-xs landscape:text-[10px] md:landscape:text-xs text-gray-500 whitespace-nowrap",children:s===0?"Spawn: Off":`${e.toFixed(1)}s`}),a.jsx("div",{className:"h-2 landscape:h-1.5 md:landscape:h-2 flex-1 bg-red-200 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-red-500",style:{width:`${t}%`}})})]})}function zn({gameState:t}){return a.jsx("div",{"data-test":"enemies-list",className:"flex gap-2 landscape:gap-1 md:landscape:gap-2 flex-wrap max-h-16 landscape:max-h-8 md:landscape:max-h-16 overflow-y-auto landscape:hidden md:landscape:flex",children:t.enemies.map(e=>a.jsxs("div",{"data-test":"enemy-status",className:`text-xs landscape:text-[10px] md:landscape:text-xs px-2 landscape:px-1 md:landscape:px-2 py-1 landscape:py-0.5 md:landscape:py-1 rounded ${zt(t.hero,e)?"bg-green-100 border border-green-300":"bg-white"}`,children:[a.jsxs("span",{"data-test":"enemy-health",className:"text-gray-600",children:[e.health,"/",e.maxHealth]}),e.aggression!==void 0&&a.jsxs("span",{"data-test":"enemy-aggression",className:"text-orange-500 ml-1",children:["A:",Math.round(e.aggression*100),"%"]})]},e.id))})}const qn=60;function dt(t){const e=t/qn;if(e>=60){const s=Math.floor(e/60),n=(e%60).toFixed(1);return`${s}m ${n}s`}return`${e.toFixed(1)}s`}function ks({run:t}){const[e,s]=h.useState(!1);return a.jsxs(Bs,{open:e,onOpenChange:s,children:[a.jsx(Ks,{asChild:!0,onMouseEnter:()=>s(!0),onMouseLeave:()=>s(!1),children:a.jsx("span",{"data-test":"run-info-trigger",className:"inline-flex items-center",children:a.jsx(Bt,{className:"w-3 h-3 text-gray-400 hover:text-gray-600 cursor-help ml-1"})})}),a.jsx(Ws,{"data-test":"run-info-popover",className:"w-48 p-2 text-xs",onMouseEnter:()=>s(!0),onMouseLeave:()=>s(!1),side:"top",align:"start",children:a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{"data-test":"run-info-duration",className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-500",children:"Duration:"}),a.jsxs("span",{className:"font-medium",children:[dt(t.tickCount)," (",t.tickCount," ticks)"]})]}),a.jsxs("div",{"data-test":"run-info-level",className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-500",children:"Level:"}),a.jsx("span",{className:"font-medium",children:t.level})]}),a.jsxs("div",{"data-test":"run-info-kills",className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-500",children:"Enemies slain:"}),a.jsx("span",{className:"font-medium",children:t.enemiesSlain})]}),t.inheritedAggression!==void 0&&a.jsxs("div",{"data-test":"run-info-aggression",className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-500",children:"Inherited aggression:"}),a.jsxs("span",{className:"font-medium",children:[(t.inheritedAggression*100).toFixed(0),"%"]})]}),t.won!==void 0&&a.jsxs("div",{"data-test":"run-info-result",className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-500",children:"Result:"}),a.jsx("span",{className:`font-medium ${t.won?"text-green-600":"text-red-500"}`,children:t.won?"Victory":"Defeat"})]})]})})]})}function Jn({run:t,isCollapsed:e,onToggle:s}){return a.jsxs("div",{"data-test":"run-group",className:"mb-2 opacity-60",children:[a.jsxs("div",{"data-test":"run-header",className:"w-full text-left text-gray-500 border-b border-gray-300 mb-0.5 hover:text-gray-700 flex items-center gap-1",children:[a.jsxs("button",{"data-test":"run-toggle",onClick:s,className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-[10px]",children:e?"â–¶":"â–¼"}),a.jsxs("span",{children:["Run ",t.id]})]}),a.jsx("span",{className:"text-gray-400",children:"Â·"}),a.jsx("span",{children:dt(t.tickCount)}),a.jsx("span",{className:"text-gray-400",children:"Â·"}),a.jsxs("span",{children:["Lv.",t.level]}),a.jsx("span",{className:"text-gray-400",children:"Â·"}),a.jsxs("span",{children:[t.enemiesSlain," kills"]}),a.jsx(ks,{run:t})]}),!e&&t.logs.map((n,l)=>a.jsx("div",{"data-test":"log-entry",title:n,className:"text-gray-600 pl-3 whitespace-nowrap overflow-hidden text-ellipsis",children:n},l))]})}function Zn({runs:t,currentLogs:e,currentRunId:s,currentTickCount:n,currentLevel:l,currentEnemiesSlain:r,currentInheritedAggression:i,className:o=""}){const[c,d]=h.useState(new Set),u=h.useCallback(()=>{const x=["Run","Aggression (%)","Level","Kills"],k=t.map(w=>[w.id,w.inheritedAggression!==void 0?Math.round(w.inheritedAggression*100):"",w.level,w.enemiesSlain]),g=[x.join(","),...k.map(w=>w.join(","))].join(`
`),v=new Blob([g],{type:"text/csv;charset=utf-8;"}),y=URL.createObjectURL(v),b=document.createElement("a");b.href=y,b.download=`rpg-stats-${new Date().toISOString().slice(0,10)}.csv`,b.click(),URL.revokeObjectURL(y)},[t]),m=t.length>0?t[t.length-1].id:0;h.useEffect(()=>{t.length>0&&d(new Set(t.map(x=>x.id)))},[m,t]);const p=x=>{d(k=>{const g=new Set(k);return g.has(x)?g.delete(x):g.add(x),g})},f=[...t].reverse();return a.jsxs("div",{"data-test":"game-log-container",className:`bg-gray-100 border border-gray-300 rounded p-2 flex flex-col h-full min-h-0 overflow-hidden ${o}`,children:[a.jsxs("div",{"data-test":"log-title",className:"flex items-center justify-between mb-1",children:[a.jsx("h2",{className:"text-xs font-medium text-gray-600",children:"Log"}),a.jsxs(Gs,{children:[a.jsx($s,{"data-test":"log-menu-trigger",className:"p-0.5 hover:bg-gray-200 rounded",children:a.jsx(Js,{className:"w-3 h-3 text-gray-500"})}),a.jsx(Ds,{"data-test":"log-menu-content",align:"end",children:a.jsxs(Fs,{"data-test":"log-menu-export-csv",onClick:u,disabled:t.length===0,className:"text-xs",children:[a.jsx(Zs,{className:"w-3 h-3 mr-2"}),"Export to CSV"]})})]})]}),a.jsxs("div",{"data-test":"game-log",className:"font-mono text-xs leading-tight flex-1 overflow-y-auto",children:[a.jsxs("div",{"data-test":"current-run",className:"mb-2",children:[a.jsxs("div",{"data-test":"run-header",className:"text-gray-700 font-medium border-b border-gray-400 mb-0.5 flex items-center gap-1",children:[a.jsxs("span",{children:["Run ",s]}),a.jsx("span",{className:"text-gray-400",children:"Â·"}),a.jsx("span",{children:dt(n)}),a.jsx("span",{className:"text-gray-400",children:"Â·"}),a.jsxs("span",{children:["Lv.",l]}),a.jsx("span",{className:"text-gray-400",children:"Â·"}),a.jsxs("span",{children:[r," kills"]}),a.jsx(ks,{run:{level:l,enemiesSlain:r,tickCount:n,inheritedAggression:i}})]}),e.map((x,k)=>a.jsx("div",{"data-test":"log-entry",title:x,className:"text-gray-700 pl-3 whitespace-nowrap overflow-hidden text-ellipsis",children:x},k))]}),f.map(x=>a.jsx(Jn,{run:x,isCollapsed:c.has(x.id),onToggle:()=>p(x.id)},x.id))]})]})}function Qn({isAutoMode:t,toggleAutoMode:e,isPaused:s,togglePause:n,onReset:l,className:r=""}){return a.jsxs("div",{"data-test":"game-controls",className:`flex flex-col landscape:flex-row md:landscape:flex-col gap-2 landscape:gap-1 md:landscape:gap-2 items-start landscape:items-end md:landscape:items-start justify-end ${r}`,children:[a.jsxs("div",{className:"flex gap-1",children:[a.jsx(Q,{"data-test":"reset-button",onClick:l,variant:"outline",size:"sm",className:"bg-amber-100 hover:bg-amber-200 border-amber-300 landscape:h-6 landscape:text-xs landscape:px-2 md:landscape:h-auto md:landscape:text-sm md:landscape:px-3",children:"Reset"}),a.jsx(Q,{"data-test":"pause-button",onClick:n,variant:"outline",size:"sm",className:`landscape:h-6 landscape:text-xs landscape:px-2 md:landscape:h-auto md:landscape:text-sm md:landscape:px-3 ${s?"bg-yellow-200 hover:bg-yellow-300 border-yellow-400":"bg-gray-100 hover:bg-gray-200 border-gray-300"}`,children:s?"Resume":"Pause"})]}),a.jsx(Q,{"data-test":"auto-button",onClick:e,variant:"outline",size:"sm",className:`landscape:h-6 landscape:text-xs landscape:px-2 md:landscape:h-auto md:landscape:text-sm md:landscape:px-3 ${t?"bg-green-200 hover:bg-green-300 border-green-400":"bg-purple-100 hover:bg-purple-200 border-purple-300"}`,children:t?"Auto: ON":"Auto: OFF"})]})}function el(){const t=Ls();return a.jsx("button",{"data-test":"assets-button",onClick:()=>void t("/demo/rpg-game/assets-v2"),className:"p-2 bg-teal-600 hover:bg-teal-500 text-white rounded-full shadow-lg transition-colors",title:"Game Assets",children:a.jsx(Qs,{size:20})})}function tl({showEffectArcGuide:t,setShowEffectArcGuide:e,onResetAllConfig:s}){const[n,l]=h.useState(!1),r=h.useCallback(()=>{s(),l(!1)},[s]);return a.jsxs(a.Fragment,{children:[a.jsx("button",{"data-test":"config-button",onClick:()=>l(i=>!i),className:"p-2 bg-amber-600 hover:bg-amber-500 text-white rounded-full shadow-lg transition-colors",title:"Game Config",children:a.jsx(ea,{size:20})}),a.jsx(Ue,{isVisible:n,onClose:()=>l(!1),title:"Game Config",initialPosition:"center",resizable:!0,initialSize:{width:350,height:280},shouldCloseManually:!0,children:a.jsxs("div",{"data-test":"config-panel",className:"p-4 space-y-4",children:[a.jsxs("div",{"data-test":"debug-section",className:"space-y-2",children:[a.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Debug Options"}),a.jsxs("label",{"data-test":"effect-arc-guide-toggle",className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:t,onChange:i=>e(i.target.checked),className:"h-4 w-4 rounded border-gray-300"}),a.jsx("span",{className:"text-sm text-gray-600",children:"Show Effect Arc Guide"})]})]}),a.jsxs("div",{"data-test":"reset-section",className:"pt-2 border-t",children:[a.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Reset all game configuration values to their defaults."}),a.jsxs(Q,{"data-test":"reset-all-config",variant:"destructive",className:"w-full flex items-center justify-center gap-2",onClick:r,children:[a.jsx(ta,{size:16}),"Reset All to Defaults"]})]})]})})]})}function sl({gameState:t,spawnInterval:e,spawnJitter:s,maxEnemies:n,currentEnemyLevel:l,inheritedAggression:r,difficultyConfig:i,skillConfig:o,isAutoMode:c,aiMode:d,gameSpeed:u,speedMultiplier:m,isSlowMode:p,effectiveGameSpeed:f,isPaused:x,xpPerKill:k}){const[g,v]=h.useState(!1),[y,b]=h.useState(null),w=JSON.stringify(t,null,2),N=JSON.stringify({gameState:t,spawning:{spawnInterval:e,spawnJitter:s,maxEnemies:n,currentEnemyLevel:l,inheritedAggression:r},difficulty:i,skills:o,levelSystem:he,ai:{isAutoMode:c,aiMode:d},speed:{gameSpeed:u,speedMultiplier:m,isSlowMode:p,effectiveSpeed:f,isPaused:x},xpPerKill:k},null,2),H=L=>{L.stopPropagation(),navigator.clipboard.writeText(w),b("v1"),setTimeout(()=>b(null),2e3)},I=L=>{L.stopPropagation(),navigator.clipboard.writeText(N),b("v2"),setTimeout(()=>b(null),2e3)};return a.jsxs(a.Fragment,{children:[a.jsx("button",{"data-test":"debug-info-button",onClick:()=>v(L=>!L),className:"p-2 bg-gray-800 hover:bg-gray-700 text-white rounded-full shadow-lg transition-colors",title:"Game World Debug Info",children:a.jsx(Bt,{size:20})}),a.jsx(Ue,{isVisible:g,onClose:()=>v(!1),title:"Game World Debug",initialPosition:"center",resizable:!0,initialSize:{width:550,height:650},shouldCloseManually:!0,children:a.jsxs(at,{defaultValue:"v1","data-test":"debug-tabs",className:"h-full flex flex-col",children:[a.jsxs(nt,{"data-test":"debug-tabs-list",className:"grid w-full grid-cols-2 flex-shrink-0",children:[a.jsxs(se,{value:"v1","data-test":"debug-tab-v1",className:"flex items-center justify-center gap-2",children:[a.jsx("span",{children:"JSON v1"}),a.jsx("button",{"data-test":"copy-json-v1",onClick:H,className:"p-1 hover:bg-gray-300 rounded transition-colors",title:"Copy JSON",children:y==="v1"?a.jsx(_e,{size:14,className:"text-green-600"}):a.jsx(Pe,{size:14,className:"text-gray-500"})})]}),a.jsxs(se,{value:"v2","data-test":"debug-tab-v2",className:"flex items-center justify-center gap-2",children:[a.jsx("span",{children:"JSON v2"}),a.jsx("button",{"data-test":"copy-json-v2",onClick:I,className:"p-1 hover:bg-gray-300 rounded transition-colors",title:"Copy JSON",children:y==="v2"?a.jsx(_e,{size:14,className:"text-green-600"}):a.jsx(Pe,{size:14,className:"text-gray-500"})})]})]}),a.jsx(ae,{value:"v1","data-test":"debug-tab-v1-content",className:"flex-1 overflow-auto mt-2",children:a.jsx("pre",{"data-test":"game-world-json-v1",className:"p-4 text-xs font-mono whitespace-pre-wrap bg-gray-50 rounded",children:w})}),a.jsx(ae,{value:"v2","data-test":"debug-tab-v2-content",className:"flex-1 overflow-auto mt-2",children:a.jsx("pre",{"data-test":"game-world-json-v2",className:"p-4 text-xs font-mono whitespace-pre-wrap bg-gray-50 rounded",children:N})})]})})]})}const al={level:1,health:z.health,maxHealth:z.health,mana:ue.mana,maxMana:ue.maxMana,manaRegen:ue.manaRegen,attack:z.attack,defense:z.defense,hpRecovery:z.hpRecovery,movementSpeed:z.movementSpeed,exp:0,position:{x:150,y:200}};class ut{constructor(){P(this,"hero",{...al})}static create(){return new ut}level(e){return this.hero.level=e,this}health(e){return this.hero.health=e,this}maxHealth(e){return this.hero.maxHealth=e,this}mana(e){return this.hero.mana=e,this}maxMana(e){return this.hero.maxMana=e,this}manaRegen(e){return this.hero.manaRegen=e,this}attack(e){return this.hero.attack=e,this}defense(e){return this.hero.defense=e,this}hpRecovery(e){return this.hero.hpRecovery=e,this}movementSpeed(e){return this.hero.movementSpeed=e,this}exp(e){return this.hero.exp=e,this}gold(e){return this.hero.gold=e,this}atPosition(e,s){return this.hero.position={x:e,y:s},this}withCooldown(e,s){return this.hero.skillCooldowns={...this.hero.skillCooldowns,[e]:s},this}lowHealth(){return this.health(10).maxHealth(100)}noMana(){return this.mana(0)}fullResources(){return this.health(this.hero.maxHealth).mana(this.hero.maxMana)}build(){return{...this.hero}}}const nl={health:B.health,maxHealth:B.health,attack:B.attack,defense:B.defense,hpRecovery:B.hpRecovery,movementSpeed:B.movementSpeed,position:{x:450,y:200},isAggroed:!1,isIdle:!0},ce=class ce{constructor(){P(this,"enemy",{...nl})}static create(){return new ce}static resetCounter(){ce.counter=0}id(e){return this.enemy.id=e,this}name(e){return this.enemy.name=e,this}health(e){return this.enemy.health=e,this}maxHealth(e){return this.enemy.maxHealth=e,this}attack(e){return this.enemy.attack=e,this}defense(e){return this.enemy.defense=e,this}hpRecovery(e){return this.enemy.hpRecovery=e,this}movementSpeed(e){return this.enemy.movementSpeed=e,this}atPosition(e,s){return this.enemy.position={x:e,y:s},this}aggroed(){return this.enemy.isAggroed=!0,this.enemy.isIdle=!1,this}idle(){return this.enemy.isIdle=!0,this.enemy.isAggroed=!1,this}aggression(e){return this.enemy.aggression=Math.max(0,Math.min(1,e)),this}passive(){return this.aggression(de)}aggressive(){return this.aggression(Ge)}damageDealtToHero(e){return this.enemy.damageDealtToHero=e,this}weak(){return this.health(10).attack(2).defense(0)}strong(){return this.health(50).attack(10).defense(5)}boss(){return this.health(200).attack(20).defense(10)}build(){return this.enemy.id||(this.enemy.id=`enemy-${ce.counter++}`),this.enemy.name||(this.enemy.name=rt),{...this.enemy}}};P(ce,"counter",0);let oe=ce;const ll={skillConfig:ee,levelConfig:he,difficultyConfig:ye,aiMode:"closest",gameSpeed:1,spawnInterval:0,maxEnemies:10};class mt{constructor(){P(this,"heroBuilder",ut.create());P(this,"enemies",[]);P(this,"config",{...ll})}static create(){return oe.resetCounter(),new mt}withHero(e){return this.heroBuilder=e(this.heroBuilder),this}withEnemy(e){const s=e(oe.create());return this.enemies.push(s),this}withLastEnemy(e){return this.enemies.length>0&&(this.enemies[this.enemies.length-1]=e(this.enemies[this.enemies.length-1])),this}withEnemies(e,s){for(let n=0;n<e;n++){const l=s?s(oe.create(),n):oe.create();this.enemies.push(l)}return this}withConfig(e){return this.config={...this.config,...e},this}withSkillConfig(e){return this.config.skillConfig={...this.config.skillConfig,...e,powerStrike:{...this.config.skillConfig.powerStrike,...e.powerStrike??{}},heal:{...this.config.skillConfig.heal,...e.heal??{}}},this}withLevelConfig(e){return this.config.levelConfig={...this.config.levelConfig,...e},this}withAiMode(e){return this.config.aiMode=e,this}withGameSpeed(e){return this.config.gameSpeed=e,this}withSpawnInterval(e){return this.config.spawnInterval=e,this}withMaxEnemies(e){return this.config.maxEnemies=e,this}withDifficultyConfig(e){return this.config.difficultyConfig={...this.config.difficultyConfig,...e},this}withBaseAggression(e){return this.config.baseAggression=e,this}build(){return{hero:this.heroBuilder.build(),enemies:this.enemies.map(e=>e.build()),config:{...this.config}}}}const ne=.5,W="[Sim]";function rl(t){return`${W} Starting simulation { maxTicks: ${t.maxTicks}, gameSpeed: ${t.gameSpeed}, enemies: ${t.enemyCount} }`}function il(t){return`${W} Level ${t.level} reached at tick ${t.tick}, kills: ${t.kills}, HP: ${t.health}/${t.maxHealth}`}function ol(t){const e={target_reached:"Target reached",victory:"Victory",defeat:"Hero died",timeout:"Timeout"}[t.reason];return`${W} Ended: ${e} at tick ${t.tick}, level ${t.level}, kills: ${t.kills}`}function cl(t){const e={};for(const s of t)e[s.type]=(e[s.type]||0)+1;return e}function Cs(t){const{finalState:e,tickCount:s,events:n}=t,l=e.hero,r=cl(n),i=e.isGameOver?e.heroWon?"Victory":"Defeat":"Ongoing";return[`${W} === Summary ===`,`${W} Ticks: ${s} (${(s/60).toFixed(1)} seconds)`,`${W} Hero: Lv.${l.level} | HP: ${l.health}/${l.maxHealth} | Mana: ${l.mana??0}/${l.maxMana??100}`,`${W} Enemies: ${e.enemies.length} remaining | Loot: ${e.loot.length}`,`${W} Outcome: ${i}`,`${W} Events: ${JSON.stringify(r)}`]}function dl(t){return[`${W} === Aggregate (${t.totalRuns} runs) ===`,`${W} Win Rate: ${t.winRate.toFixed(1)}%`,`${W} Wins: ${t.wins} | Losses: ${t.losses} | Timeouts: ${t.timeouts}`,`${W} Avg Ticks: ${t.avgTicks} (${(t.avgTicks/60).toFixed(1)} seconds)`,`${W} Avg Level: ${t.avgHeroLevel}`,`${W} Avg Kills: ${t.avgKills}`]}function ul(t){const e=[];return t.totalRuns>1&&(e.push(...dl(t)),e.push("")),t.runs.length>0&&e.push(...Cs(t.runs[0])),e}const ml=1e3,hl={maxTicks:2e4,tickInterval:16,stopCondition:()=>!1,recordEvents:!0,survivalMode:!0,debug:!1};class gl{constructor(e,s={}){P(this,"world");P(this,"options");P(this,"clock");P(this,"events",[]);P(this,"tickCount",0);P(this,"lastLoggedLevel",1);P(this,"lastAttackTime",0);P(this,"lastAggressionCheckTime",0);P(this,"lastHpRecoveryTime",0);P(this,"lastManaRegenTime",0);P(this,"lastSpawnTime",0);P(this,"engineContext",{currentTargetId:null,canAttack:!1});P(this,"lootCounter",0);P(this,"spawnCount",0);P(this,"enemyIdCounter",0);P(this,"movementState",{roamTargets:new Map,idleEndTimes:new Map});this.world=e,this.options={...hl,...s},this.clock=new Ia(60),us(this.clock)}run(){var i,o,c,d;La("hero");let e=this.buildInitialState();const s=this.world.config,n=s.gameSpeed,l=this.options.debug;l&&console.log(rl({maxTicks:this.options.maxTicks,gameSpeed:n,enemyCount:e.enemies.length}));const r={skillConfig:s.skillConfig??ee,levelConfig:s.levelConfig,aiMode:"attack_until_dead",gameSpeed:n};for(;this.tickCount<this.options.maxTicks&&!e.isGameOver&&!((o=(i=this.options).stopCondition)!=null&&o.call(i,e,this.events));){const u=this.clock.now(),m=xs(e.hero,e.enemies,this.movementState,{gameSpeed:n,currentTime:u,idleDurationFn:()=>He+ne*(Vt-He),randomFn:()=>ne,roamTargetFn:()=>ps(()=>ne)});e={...e,enemies:m.enemies},this.movementState=m.state;const p=Ut/n;this.engineContext.canAttack=u-this.lastAttackTime>=p;const f=fs(e,r,this.engineContext,()=>`loot-${this.lootCounter++}`,ne);if(this.engineContext.canAttack&&f.events.some(b=>b.type==="damage_dealt"||b.type==="skill_used")&&(this.lastAttackTime=u),f.targetCleared)this.engineContext.currentTargetId=null;else{const b=f.events.find(w=>w.type==="target_changed");b&&b.type==="target_changed"&&(this.engineContext.currentTargetId=b.to)}this.recordGameEvents(f.events);const x=this.formatEventsToLog(f.events);let k=f.enemies;for(const b of f.events)b.type==="counterattack"&&(k=k.map(w=>w.id===b.attackerId?{...w,damageDealtToHero:(w.damageDealtToHero??0)+b.damage}:w));if(e={...e,hero:f.hero,enemies:k,loot:f.loot,isGameOver:f.isGameOver,heroWon:f.heroWon,gameLog:x.length>0?[...e.gameLog,...x].slice(-8):e.gameLog},l&&(e.hero.level??0)>this.lastLoggedLevel){const b=this.events.filter(w=>w.type==="enemy_killed").length;console.log(il({level:e.hero.level??0,tick:this.tickCount,kills:b,health:e.hero.health,maxHealth:e.hero.maxHealth})),this.lastLoggedLevel=e.hero.level??0}if(e.isGameOver)if(this.options.survivalMode&&e.heroWon)e={...e,isGameOver:!1,heroWon:!1};else break;const g=Xt/n;if(u-this.lastAggressionCheckTime>=g){const b=vs(e.hero,e.enemies,()=>ne);e={...e,enemies:b.enemies},this.lastAggressionCheckTime=u}const v=Wt/n;if(u-this.lastHpRecoveryTime>=v){const b=ys(e.hero,e.enemies);e={...e,hero:b.hero,enemies:b.enemies},b.heroHealAmount>0&&this.recordEvent({type:"heal_applied",target:"hero",amount:b.heroHealAmount}),this.lastHpRecoveryTime=u}const y=ml/n;if(u-this.lastManaRegenTime>=y){const b=ws(e.hero);e={...e,hero:b.entity},b.regenAmount>0&&this.recordEvent({type:"mana_regenerated",entityId:"hero",amount:b.regenAmount}),this.lastManaRegenTime=u}if(s.spawnInterval>0){const b=s.spawnInterval*1e3/n;if(u-this.lastSpawnTime>=b){this.spawnCount++;const w={difficultyConfig:s.difficultyConfig,maxEnemies:s.maxEnemies,existingEnemies:e.enemies},N=ns(e.enemies.length,this.spawnCount,w,()=>`enemy-${this.enemyIdCounter++}`,()=>ne);N.enemy&&(e={...e,enemies:[...e.enemies,N.enemy]},this.recordEvent({type:"enemy_spawned",enemyId:N.enemy.id,level:N.enemy.level??1})),this.lastSpawnTime=u}}this.clock.tick(),this.tickCount++}if(l){const u=this.events.filter(x=>x.type==="enemy_killed").length,p=((d=(c=this.options).stopCondition)==null?void 0:d.call(c,e,this.events))?"target_reached":e.isGameOver?e.heroWon?"victory":"defeat":"timeout";console.log(ol({reason:p,tick:this.tickCount,level:e.hero.level??0,kills:u}));const f={finalState:e,tickCount:this.tickCount,events:this.events};for(const x of Cs(f))console.log(x)}return{finalState:e,tickCount:this.tickCount,events:this.events}}buildInitialState(){var l,r;const e=this.world.config,s=this.world.hero,n=this.world.enemies;return this.enemyIdCounter=n.length,{hero:{id:s.id??"hero",name:s.name??"Hero",x:s.x??((l=s.position)==null?void 0:l.x)??0,y:s.y??((r=s.position)==null?void 0:r.y)??0,health:s.health,maxHealth:s.maxHealth,attack:s.attack,defense:s.defense??0,hpRecovery:s.hpRecovery??1,movementSpeed:s.movementSpeed??3,isHero:!0,isFlashing:!1,exp:s.exp??0,level:s.level??1,mana:s.mana??100,maxMana:s.maxMana??100,manaRegen:s.manaRegen??5},enemies:n.map((i,o)=>{var c,d;return{id:i.id??`enemy-${o}`,name:i.name??rt,x:i.x??((c=i.position)==null?void 0:c.x)??0,y:i.y??((d=i.position)==null?void 0:d.y)??0,health:i.health,maxHealth:i.maxHealth,attack:i.attack,defense:i.defense??0,hpRecovery:i.hpRecovery??0,movementSpeed:i.movementSpeed??B.movementSpeed,isHero:!1,isFlashing:!1,isAggroed:i.isAggroed??!1,isIdle:i.isIdle??!0,aggression:i.aggression??e.baseAggression??de+ne*(Ge-de),damageDealtToHero:0,level:i.level??1}}),loot:[],selectedEnemy:null,gameLog:[],isGameOver:!1,heroWon:!1,activeEffects:[],aggressionHistory:[]}}recordEvent(e){this.options.recordEvents&&this.events.push(e)}recordGameEvents(e){for(const s of e)switch(s.type){case"damage_dealt":this.recordEvent({type:"damage_dealt",source:s.source,target:s.target,amount:s.amount});break;case"enemy_killed":this.recordEvent({type:"enemy_killed",enemyId:s.enemyId});break;case"xp_gained":this.recordEvent({type:"xp_gained",amount:s.amount});break;case"level_up":this.recordEvent({type:"level_up",newLevel:s.newLevel});break;case"gold_dropped":this.recordEvent({type:"gold_dropped",amount:s.amount});break;case"gold_picked":this.recordEvent({type:"gold_picked",amount:s.amount});break;case"skill_used":this.recordEvent({type:"skill_used",skillId:s.skillId,target:s.target});break;case"heal_applied":this.recordEvent({type:"heal_applied",target:s.target,amount:s.amount});break}}formatEventsToLog(e){const s=[];for(const n of e)switch(n.type){case"skill_used":s.push(`[Auto] ${n.message}`);break;case"enemy_killed":s.push(`[Auto] ${n.enemyName} defeated!`);break;case"xp_gained":s.push(`[Auto] +${n.amount} XP`);break;case"gold_picked":s.push(`[Auto] +${n.amount} Gold`);break;case"level_up":s.push(`[Auto] LEVEL UP! Now level ${n.newLevel}!`);break;case"counterattack":s.push(`[Auto] ${n.attackerName} hits Hero for ${n.damage}!`);break;case"hero_died":s.push("[Auto] Game Over!");break;case"victory":s.push("[Auto] Victory!");break}return s}}const Es={runCount:10,enemyCount:3,enemyHealth:5,enemyAttack:1,maxTicks:2e4,spawnInterval:5,maxEnemies:8,survivalMode:!0,gameSpeed:15};class fl{static run(e={}){const s={...Es,...e},n=[];for(let l=0;l<s.runCount;l++){const r=this.runSingle(s);n.push(r)}return us(ds),this.calculateStats(n)}static runSingle(e){const s=mt.create().withSpawnInterval(e.spawnInterval).withMaxEnemies(e.maxEnemies).withGameSpeed(e.gameSpeed).withSkillConfig(e.skillConfig??ee).withDifficultyConfig(e.difficultyConfig??ye).withBaseAggression(e.baseAggression);(e.heroHealth!==void 0||e.heroAttack!==void 0)&&s.withHero(r=>(e.heroHealth!==void 0&&r.health(e.heroHealth).maxHealth(e.heroHealth),e.heroAttack!==void 0&&r.attack(e.heroAttack),r));for(let r=0;r<e.enemyCount;r++){const i=[125,250,375];s.withEnemy(o=>o.health(e.enemyHealth).maxHealth(e.enemyHealth).attack(e.enemyAttack).atPosition(650,i[r%3]))}const n=s.build();return new gl(n,{maxTicks:e.maxTicks,survivalMode:e.survivalMode,debug:e.debug,stopCondition:e.stopCondition}).run()}static calculateStats(e){const s=e.length,n=e.filter(g=>g.finalState.heroWon).length,l=e.filter(g=>g.finalState.isGameOver&&!g.finalState.heroWon).length,r=s-n-l,i=e.filter(g=>g.finalState.heroWon),o=e.filter(g=>g.finalState.isGameOver&&!g.finalState.heroWon),c=e.reduce((g,v)=>g+v.tickCount,0)/s,d=i.length>0?i.reduce((g,v)=>g+v.tickCount,0)/i.length:0,u=o.length>0?o.reduce((g,v)=>g+v.tickCount,0)/o.length:0,m=i.map(g=>g.tickCount),p=m.length>0?Math.min(...m):0,f=m.length>0?Math.max(...m):0,x=e.reduce((g,v)=>g+(v.finalState.hero.level??1),0)/s,k=e.reduce((g,v)=>{const y=v.events.filter(b=>b.type==="enemy_killed").length;return g+y},0)/s;return{totalRuns:s,wins:n,losses:l,timeouts:r,winRate:n/s*100,avgTicks:Math.round(c),avgTicksWin:Math.round(d),avgTicksLoss:Math.round(u),minTicksWin:p,maxTicksWin:f,avgHeroLevel:Math.round(x*10)/10,avgKills:Math.round(k*10)/10,runs:e}}}const pl={primary:"bg-purple-600 hover:bg-purple-500 disabled:bg-purple-400",success:"bg-green-600 hover:bg-green-500 disabled:bg-green-400",warning:"bg-amber-600 hover:bg-amber-500 disabled:bg-amber-400"},xl={id:"basic",name:"Run Sim",description:"Run multiple simulations with current settings",variant:"primary",getConfig:t=>({...t})},vl=2,yl=5e3,wl={id:"reach-level-2",name:"Lvl 2",description:"Run until hero reaches level 2",variant:"success",getConfig:t=>({...t,runCount:1,maxTicks:yl,debug:!0,stopCondition:e=>(e.hero.level??0)>=vl})},bl=3,kl=8e3,Cl={id:"reach-level-3",name:"Lvl 3",description:"Run until hero reaches level 3",variant:"success",getConfig:t=>({...t,runCount:1,maxTicks:kl,debug:!0,stopCondition:e=>(e.hero.level??0)>=bl})},El=4,jl=12e3,Nl={id:"reach-level-4",name:"Lvl 4",description:"Run until hero reaches level 4",variant:"success",getConfig:t=>({...t,runCount:1,maxTicks:jl,debug:!0,stopCondition:e=>(e.hero.level??0)>=El})},Sl=5,Ml=15e3,Al={id:"reach-level-5",name:"Lvl 5",description:"Run until hero reaches level 5",variant:"success",getConfig:t=>({...t,runCount:1,maxTicks:Ml,debug:!0,stopCondition:e=>(e.hero.level??0)>=Sl})},Tl=6,Rl=18e3,Il={id:"reach-level-6",name:"Lvl 6",description:"Run until hero reaches level 6",variant:"success",getConfig:t=>({...t,runCount:1,maxTicks:Rl,debug:!0,stopCondition:e=>(e.hero.level??0)>=Tl})},Ll=7,_l=2e4,Pl={id:"reach-level-7",name:"Lvl 7",description:"Run until hero reaches level 7",variant:"warning",getConfig:t=>({...t,runCount:1,maxTicks:_l,debug:!0,stopCondition:e=>(e.hero.level??0)>=Ll})},Ol=8,Hl=25e3,Gl={id:"reach-level-8",name:"Lvl 8",description:"Run until hero reaches level 8",variant:"warning",getConfig:t=>({...t,runCount:1,maxTicks:Hl,debug:!0,stopCondition:e=>(e.hero.level??0)>=Ol})},$l=[xl,wl,Cl,Nl,Al,Il,Pl,Gl];function Dl({spawnInterval:t,maxEnemies:e,skillConfig:s,difficultyConfig:n,baseAggression:l}){const r=h.useMemo(()=>({...Es,spawnInterval:t,maxEnemies:e,skillConfig:s,difficultyConfig:n,baseAggression:l}),[t,e,s,n,l]),[i,o]=h.useState(!1),[c,d]=h.useState(r),[u,m]=h.useState(null),[p,f]=h.useState(!1),[x,k]=h.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx("button",{"data-test":"simulation-button",onClick:()=>o(g=>!g),className:"p-2 bg-purple-700 hover:bg-purple-600 text-white rounded-full shadow-lg transition-colors",title:"Balance Simulator",children:a.jsx(sa,{size:20})}),a.jsx(Ue,{isVisible:i,onClose:()=>o(!1),title:"Balance Simulator",initialPosition:"center",resizable:!0,initialSize:{width:750,height:500},shouldCloseManually:!0,children:a.jsxs("div",{"data-test":"simulation-panel",className:"p-3 space-y-3",children:[a.jsxs("div",{"data-test":"sim-config-grid",className:"grid grid-cols-2 gap-x-3 gap-y-2 text-xs",children:[a.jsxs("div",{"data-test":"sim-enemy-count-field",className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600 w-16",children:"Enemies:"}),a.jsx("input",{type:"range",min:"1",max:"10",value:c.enemyCount,onChange:g=>d(v=>({...v,enemyCount:parseInt(g.target.value)})),className:"flex-1 h-4","data-test":"sim-enemy-count"}),a.jsx("span",{className:"w-6 text-right font-medium",children:c.enemyCount})]}),a.jsxs("div",{"data-test":"sim-enemy-health-field",className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600 w-16",children:"Health:"}),a.jsx("input",{type:"range",min:"1",max:"50",value:c.enemyHealth,onChange:g=>d(v=>({...v,enemyHealth:parseInt(g.target.value)})),className:"flex-1 h-4","data-test":"sim-enemy-health"}),a.jsx("span",{className:"w-6 text-right font-medium",children:c.enemyHealth})]}),a.jsxs("div",{"data-test":"sim-enemy-attack-field",className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600 w-16",children:"Attack:"}),a.jsx("input",{type:"range",min:"1",max:"10",value:c.enemyAttack,onChange:g=>d(v=>({...v,enemyAttack:parseInt(g.target.value)})),className:"flex-1 h-4","data-test":"sim-enemy-attack"}),a.jsx("span",{className:"w-6 text-right font-medium",children:c.enemyAttack})]}),a.jsxs("div",{"data-test":"sim-run-count-field",className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600 w-16",children:"Runs:"}),a.jsx("input",{type:"range",min:"1",max:"100",value:c.runCount,onChange:g=>d(v=>({...v,runCount:parseInt(g.target.value)})),className:"flex-1 h-4","data-test":"sim-run-count"}),a.jsx("span",{className:"w-6 text-right font-medium",children:c.runCount})]})]}),a.jsx("div",{"data-test":"sim-presets-container",className:"flex gap-2",children:$l.map(g=>a.jsx("button",{onClick:()=>{f(!0),m(null),setTimeout(()=>{const v=g.getConfig(c),y=fl.run(v);m(y),f(!1)},50)},disabled:p,className:`flex-1 py-1.5 px-3 ${pl[g.variant]} text-white text-sm rounded-lg flex items-center justify-center gap-1.5 transition-colors`,"data-test":"sim-preset-button",title:g.description,children:p?a.jsx(aa,{size:14,className:"animate-spin"}):a.jsxs(a.Fragment,{children:[a.jsx(na,{size:14}),g.name]})},g.id))}),u&&a.jsxs("div",{"data-test":"sim-results",className:"bg-gray-50 rounded-lg p-3 space-y-2",children:[a.jsxs("div",{"data-test":"sim-results-header",className:"flex items-center justify-between border-b pb-1",children:[a.jsx("h4",{className:"font-semibold text-sm",children:"Results"}),a.jsx("button",{"data-test":"sim-results-copy",onClick:()=>{const g=ul(u).join(`
`);navigator.clipboard.writeText(g),k(!0),setTimeout(()=>k(!1),2e3)},className:"p-1 hover:bg-gray-200 rounded transition-colors",title:"Copy simulation output",children:x?a.jsx(_e,{size:14,className:"text-green-600"}):a.jsx(Pe,{size:14,className:"text-gray-500"})})]}),a.jsxs("div",{"data-test":"sim-results-grid",className:"grid grid-cols-2 gap-2 text-sm",children:[a.jsxs("div",{"data-test":"sim-result-win-rate",children:[a.jsx("span",{className:"text-gray-500",children:"Win Rate:"}),a.jsxs("span",{className:`ml-2 font-bold ${u.winRate>=50?"text-green-600":"text-red-600"}`,children:[u.winRate.toFixed(1),"%"]})]}),a.jsxs("div",{"data-test":"sim-result-total-runs",children:[a.jsx("span",{className:"text-gray-500",children:"Total Runs:"}),a.jsx("span",{className:"ml-2 font-medium",children:u.totalRuns})]}),a.jsxs("div",{"data-test":"sim-result-wins",children:[a.jsx("span",{className:"text-gray-500",children:"Wins:"}),a.jsx("span",{className:"ml-2 text-green-600",children:u.wins})]}),a.jsxs("div",{"data-test":"sim-result-losses",children:[a.jsx("span",{className:"text-gray-500",children:"Losses:"}),a.jsx("span",{className:"ml-2 text-red-600",children:u.losses})]}),a.jsxs("div",{"data-test":"sim-result-avg-ticks",children:[a.jsx("span",{className:"text-gray-500",children:"Avg Ticks:"}),a.jsx("span",{className:"ml-2",children:u.avgTicks})]}),a.jsxs("div",{"data-test":"sim-result-timeouts",children:[a.jsx("span",{className:"text-gray-500",children:"Timeouts:"}),a.jsx("span",{className:"ml-2",children:u.timeouts})]}),a.jsxs("div",{"data-test":"sim-result-avg-level",children:[a.jsx("span",{className:"text-gray-500",children:"Avg Level:"}),a.jsx("span",{className:"ml-2",children:u.avgHeroLevel})]}),a.jsxs("div",{"data-test":"sim-result-avg-kills",children:[a.jsx("span",{className:"text-gray-500",children:"Avg Kills:"}),a.jsx("span",{className:"ml-2",children:u.avgKills})]}),u.wins>0&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{"data-test":"sim-result-avg-win",children:[a.jsx("span",{className:"text-gray-500",children:"Avg Win:"}),a.jsxs("span",{className:"ml-2",children:[u.avgTicksWin," ticks"]})]}),a.jsxs("div",{"data-test":"sim-result-win-range",children:[a.jsx("span",{className:"text-gray-500",children:"Win Range:"}),a.jsxs("span",{className:"ml-2",children:[u.minTicksWin,"-",u.maxTicksWin]})]})]})]})]})]})})]})}const Je={width:300,height:150,padding:{top:30,right:20,bottom:25,left:35},colors:{aggression:"#ef4444",level:"#3b82f6",kills:"#22c55e"},maxLevel:10};function Ze(t,e,s){return s===e?50:(t-e)/(s-e)*100}function Ae(t,e,s){return s+e-t/100*e}function Te(t,e,s,n){return e<=1?n+s/2:n+t/(e-1)*s}function Qe(t){return t.length===0?"":t.map((e,s)=>`${s===0?"M":"L"} ${e.x} ${e.y}`).join(" ")}function Fl(t,e,s){const n=e-t;if(n===0)return[t];const l=n/(s-1),r=Math.pow(10,Math.floor(Math.log10(l))),i=l/r;let o;i<=1.5?o=r:i<=3?o=2*r:i<=7?o=5*r:o=10*r;const c=Math.floor(t/o)*o,d=Math.ceil(e/o)*o,u=[];for(let m=c;m<=d;m+=o)u.push(m);return u}function Bl({runs:t}){const[e,s]=h.useState(!1),[n,l]=h.useState(null),[r,i]=h.useState({width:Je.width,height:Je.height}),o=h.useRef(null);h.useEffect(()=>{if(!o.current)return;const E=new ResizeObserver(A=>{for(const M of A){const{width:F,height:S}=M.contentRect;F>0&&S>0&&i({width:F,height:S})}});return E.observe(o.current),()=>E.disconnect()},[]);const{padding:c,colors:d,maxLevel:u}=Je,{width:m,height:p}=r,f=m-c.left-c.right,x=p-c.top-c.bottom,k=Math.max(...t.map(E=>E.enemiesSlain),1),g=4,y=(()=>{switch(n){case"aggression":return{min:0,max:100,suffix:"%"};case"level":return{min:1,max:u,suffix:""};case"kills":return{min:0,max:k,suffix:""};default:return null}})(),b=y?Fl(y.min,y.max,g):[],w=E=>{if(!y)return 0;const A=Ze(E,y.min,y.max);return Ae(A,x,c.top)},N=E=>{l(A=>A===E?null:E)},H=t.map((E,A)=>({x:Te(A,t.length,f,c.left),y:Ae((E.inheritedAggression??0)*100,x,c.top)})),I=t.map((E,A)=>({x:Te(A,t.length,f,c.left),y:Ae(Ze(E.level,1,u),x,c.top)})),L=t.map((E,A)=>({x:Te(A,t.length,f,c.left),y:Ae(Ze(E.enemiesSlain,0,k),x,c.top)}));return a.jsxs(a.Fragment,{children:[a.jsx("button",{"data-test":"stats-button",onClick:()=>s(E=>!E),className:"p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-lg transition-colors",title:"Run Statistics",children:a.jsx(la,{size:20})}),a.jsx(Ue,{isVisible:e,onClose:()=>s(!1),title:"Run Statistics",initialPosition:"center",resizable:!0,initialSize:{width:350,height:280},shouldCloseManually:!0,children:a.jsx("div",{"data-test":"stats-panel",className:"p-4 h-full flex flex-col",children:t.length===0?a.jsxs("div",{"data-test":"stats-empty",className:"text-center text-gray-500 py-8 flex-1 flex items-center justify-center flex-col",children:[a.jsx("p",{className:"text-sm",children:"No game runs yet"}),a.jsx("p",{className:"text-xs mt-1",children:"Play some games to see stats"})]}):a.jsxs("div",{"data-test":"stats-content",className:"flex-1 flex flex-col gap-2 min-h-0",children:[a.jsxs("div",{"data-test":"stats-legend",className:"flex justify-center gap-3 text-xs flex-shrink-0",children:[a.jsxs("button",{"data-test":"stats-legend-aggression",onClick:()=>N("aggression"),className:`flex items-center gap-1 px-1 rounded cursor-pointer hover:bg-red-50 transition-colors ${n==="aggression"?"bg-red-100 ring-1 ring-red-300":""}`,children:[a.jsx("span",{className:"w-3 h-0.5 bg-red-500 inline-block"}),a.jsx("span",{children:"Aggr (0-100%)"})]}),a.jsxs("button",{"data-test":"stats-legend-level",onClick:()=>N("level"),className:`flex items-center gap-1 px-1 rounded cursor-pointer hover:bg-blue-50 transition-colors ${n==="level"?"bg-blue-100 ring-1 ring-blue-300":""}`,children:[a.jsx("span",{className:"w-3 h-0.5 bg-blue-500 inline-block"}),a.jsxs("span",{children:["Lvl (1-",u,")"]})]}),a.jsxs("button",{"data-test":"stats-legend-kills",onClick:()=>N("kills"),className:`flex items-center gap-1 px-1 rounded cursor-pointer hover:bg-green-50 transition-colors ${n==="kills"?"bg-green-100 ring-1 ring-green-300":""}`,children:[a.jsx("span",{className:"w-3 h-0.5 bg-green-500 inline-block"}),a.jsxs("span",{children:["Kills (0-",k,")"]})]})]}),a.jsx("div",{ref:o,className:"flex-1 min-h-0",children:a.jsxs("svg",{"data-test":"stats-chart",viewBox:`0 0 ${m} ${p}`,className:"w-full h-full",children:[a.jsx("line",{x1:c.left,y1:c.top,x2:c.left,y2:p-c.bottom,stroke:"#d1d5db",strokeWidth:"1"}),a.jsx("line",{x1:c.left,y1:p-c.bottom,x2:m-c.right,y2:p-c.bottom,stroke:"#d1d5db",strokeWidth:"1"}),n&&b.length>0?b.map(E=>{const A=w(E);return a.jsxs("g",{children:[a.jsx("line",{x1:c.left,y1:A,x2:m-c.right,y2:A,stroke:"#e5e7eb",strokeWidth:"1",strokeDasharray:"2,2"}),a.jsxs("text",{x:c.left-5,y:A+3,fontSize:"7",textAnchor:"end",fill:"#6b7280",children:[E,y==null?void 0:y.suffix]})]},E)}):a.jsxs(a.Fragment,{children:[a.jsx("text",{x:c.left-5,y:c.top+3,fontSize:"7",textAnchor:"end",fill:"#6b7280",children:"max"}),a.jsx("text",{x:c.left-5,y:p-c.bottom+3,fontSize:"7",textAnchor:"end",fill:"#6b7280",children:"min"})]}),(()=>{const E=t.length,A=5,M=E<=A?1:Math.ceil(E/A);return t.filter((F,S)=>S===0||S===E-1||(S+1)%M===0).map(F=>{const S=t.findIndex(G=>G.id===F.id);return a.jsx("text",{x:Te(S,t.length,f,c.left),y:p-c.bottom+12,fontSize:"8",textAnchor:"middle",fill:"#6b7280",children:F.id},F.id)})})(),a.jsx("path",{d:Qe(H),fill:"none",stroke:d.aggression,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),a.jsx("path",{d:Qe(I),fill:"none",stroke:d.level,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),a.jsx("path",{d:Qe(L),fill:"none",stroke:d.kills,strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),H.map((E,A)=>a.jsx("circle",{cx:E.x,cy:E.y,r:"3",fill:d.aggression},`agg-${A}`)),I.map((E,A)=>a.jsx("circle",{cx:E.x,cy:E.y,r:"3",fill:d.level},`lvl-${A}`)),L.map((E,A)=>a.jsx("circle",{cx:E.x,cy:E.y,r:"3",fill:d.kills},`kill-${A}`))]})}),a.jsxs("div",{"data-test":"stats-summary",className:"text-xs text-gray-600 text-center flex-shrink-0",children:[a.jsxs("span",{children:["Total runs: ",t.length]}),a.jsx("span",{className:"mx-2",children:"|"}),a.jsxs("span",{children:["Max kills: ",k]})]})]})})})]})}function Kl({showEffectArcGuide:t,setShowEffectArcGuide:e,onResetAllConfig:s,gameState:n,spawnInterval:l,spawnJitter:r,maxEnemies:i,currentEnemyLevel:o,inheritedAggression:c,difficultyConfig:d,skillConfig:u,isAutoMode:m,aiMode:p,gameSpeed:f,speedMultiplier:x,isSlowMode:k,effectiveGameSpeed:g,isPaused:v,xpPerKill:y,baseAggression:b,runs:w}){return a.jsx(a.Fragment,{children:a.jsxs("div",{"data-test":"debug-buttons-container",className:"fixed bottom-4 left-4 z-50 flex gap-2",children:[a.jsx(el,{}),a.jsx(tl,{showEffectArcGuide:t,setShowEffectArcGuide:e,onResetAllConfig:s}),a.jsx(sl,{gameState:n,spawnInterval:l,spawnJitter:r,maxEnemies:i,currentEnemyLevel:o,inheritedAggression:c,difficultyConfig:d,skillConfig:u,isAutoMode:m,aiMode:p,gameSpeed:f,speedMultiplier:x,isSlowMode:k,effectiveGameSpeed:g,isPaused:v,xpPerKill:y}),a.jsx(Dl,{spawnInterval:l,maxEnemies:i,skillConfig:u,difficultyConfig:d,baseAggression:b}),a.jsx(Bl,{runs:w})]})})}function Wl({isHardMode:t,setIsHardMode:e}){return a.jsx("button",{"data-test":"hard-mode-toggle",onClick:()=>e(!t),className:`p-2 rounded-full shadow-lg transition-colors ${t?"bg-red-600 hover:bg-red-500 text-white":"bg-gray-400 hover:bg-gray-500 text-white"}`,title:t?"Hard Mode: ON (jitter only increases)":"Hard Mode: OFF (jitter goes both ways)",children:a.jsx(ra,{size:20})})}const Le=3;function Ul(){return{hero:Jt(),enemies:ls(Le),loot:[],selectedEnemy:null,gameLog:["Game started!"],isGameOver:!1,heroWon:!1,activeEffects:[],aggressionHistory:[]}}const Vl=2e3;function sr({logger:t}){const e=En(),[s,n]=h.useState(Ul),[l,r]=h.useState([]),[i,o]=h.useState(1),[c,d]=h.useState(0),[u,m]=h.useState(0),[p,f]=h.useState(null),[x,k]=h.useState(!0),g=h.useRef(Le),v=h.useRef(null),y=h.useRef(()=>{}),b=h.useRef(Date.now()),[w,N]=h.useState(0);h.useEffect(()=>{const j=s.enemies.length,C=g.current;j<C&&!s.isGameOver&&d(R=>R+(C-j)),g.current=j},[s.enemies.length,s.isGameOver]),h.useEffect(()=>{if(s.isGameOver||e.isPaused)return;const j=setInterval(()=>{const C=Date.now()-b.current,R=Math.floor(C/1e3*60*e.gameSpeed);N(R)},100);return()=>clearInterval(j)},[s.isGameOver,e.isPaused,e.gameSpeed]);const{addEffect:H,getEffectProgress:I}=Ua({gameState:s,setGameState:n}),{canvasRef:L,handleCanvasClick:E}=jn({gameState:s,setGameState:n});h.useEffect(()=>{s.loot.length!==0&&s.loot.some(j=>Ie(s.hero,j))&&n(j=>{const C=j.loot.filter(ge=>Ie(j.hero,ge));if(C.length===0)return j;const R=C.length*ma,Y=C.reduce((ge,Ts)=>ge+(Ts.gold??0),0),Ce=Math.min(j.hero.maxHealth,j.hero.health+R),As=Y>0?`Loot collected! +${C.length} EXP, +${R} HP, +${Y} Gold`:`Loot collected! +${C.length} EXP, +${R} HP`;return{...j,hero:{...j.hero,health:Ce,exp:(j.hero.exp??0)+C.length*ua,gold:(j.hero.gold??0)+Y},loot:j.loot.filter(ge=>!Ie(j.hero,ge)),gameLog:[...j.gameLog,As].slice(-8)}})},[s.hero.x,s.hero.y,s.loot]);const M=(e.isSlowMode?1/e.gameSpeed:e.gameSpeed)*e.speedMultiplier,S=Math.min(M,10),G=Mn(M,e.isPaused);en({gameState:s,setGameState:n,gameSpeed:M,isPaused:e.isPaused}),sn({gameState:s,setGameState:n,gameSpeed:M,isPaused:e.isPaused}),Ka({isAutoMode:e.isAutoMode,aiMode:e.aiMode,gameState:s,setGameState:n,gameSpeed:M,isPaused:e.isPaused,skillConfig:e.skillConfig,addEffect:H});const{spawnProgress:V,timeRemaining:te,currentEnemyLevel:le,resetSpawnCount:we}=Qa({gameState:s,setGameState:n,gameSpeed:S,isPaused:e.isPaused,spawnInterval:e.spawnInterval,spawnJitter:e.spawnJitter,maxEnemies:e.maxEnemies,difficultyConfig:e.difficultyConfig,baseAggression:p??e.baseAggression,hardMode:e.isHardMode}),Z=et(s.hero.exp??0,he).level,ht=h.useCallback(()=>{const j=[...s.aggressionHistory].sort((R,Y)=>Y.damageDealt-R.damageDealt).slice(0,3),C=j.length>0?j.reduce((R,Y)=>R+Y.aggression,0)/j.length:null;r(R=>{const Y={id:i,logs:s.gameLog,won:s.heroWon,level:Z,enemiesSlain:c,tickCount:w,inheritedAggression:C??void 0};return[...R,Y]}),o(R=>R+1),d(0),N(0),b.current=Date.now(),g.current=Le,f(C),e.setIsAutoMode(!0),we(),n({hero:Jt(),enemies:ls(Le,{baseAggression:C??e.baseAggression}),loot:[],selectedEnemy:null,gameLog:["Game started!"],isGameOver:!1,heroWon:!1,activeEffects:[],aggressionHistory:[]})},[e,we,i,s.gameLog,s.heroWon,s.aggressionHistory,Z,c,w]);y.current=ht,h.useEffect(()=>{if(!s.isGameOver){v.current=null,m(0);return}v.current=Date.now();let j;const C=()=>{const R=v.current;if(!R)return;const Y=Date.now()-R,Ce=Math.min(1,Y/Vl);m(Ce),Ce>=1?y.current():j=requestAnimationFrame(C)};return j=requestAnimationFrame(C),()=>{j&&cancelAnimationFrame(j)}},[s.isGameOver]);const{skills:be,isSkillOnCooldown:ke,getRemainingCooldown:gt}=wn({gameState:s,setGameState:n,isGameOver:s.isGameOver,skillConfig:e.skillConfig}),[,ft]=h.useState(0);h.useEffect(()=>{if(!be.some(R=>ke(R.id)))return;const C=setInterval(()=>ft(R=>R+1),100);return()=>clearInterval(C)},[be,ke]);const pt=be.map(j=>{const C=ke(j.id),R=gt(j.id),Y=C?R/j.cooldown*100:0;return{skill:j,onCooldown:C,cooldownRemaining:R,cooldownPercent:Y}}),xt=et(s.hero.exp??0,he);h.useEffect(()=>{const j=L.current;if(!j)return;const C=j.getContext("2d");C&&(G.countRender(),un(C),hn(C,s.hero,s.enemies),s.loot.forEach(R=>pn(C,R)),s.enemies.forEach(R=>{s.selectedEnemy===R.id&&mn(C,R),Pt(C,R)}),Pt(C,s.hero),fn(C,s.hero.x,s.hero.y),dn(C,s.hero,xt),xn(C,pt),vn(C,s.hero.gold??0),yn(C,s.activeEffects,I,{showArcGuide:e.showEffectArcGuide}),s.isGameOver&&gn(C,s.heroWon,u))},[s,pt,L,xt,u,I,e.showEffectArcGuide]),h.useEffect(()=>{if(s.activeEffects.length===0)return;let j;const C=()=>{ft(R=>R+1),j=requestAnimationFrame(C)};return j=requestAnimationFrame(C),()=>cancelAnimationFrame(j)},[s.activeEffects.length]);const js=Us(),vt={gameState:s,setGameState:n,controlPanelTab:e.controlPanelTab,setControlPanelTab:e.setControlPanelTab,gameSpeed:e.gameSpeed,setGameSpeed:e.setGameSpeed,speedMultiplier:e.speedMultiplier,setSpeedMultiplier:e.setSpeedMultiplier,isSlowMode:e.isSlowMode,setIsSlowMode:e.setIsSlowMode,spawnInterval:e.spawnInterval,setSpawnInterval:e.setSpawnInterval,spawnJitter:e.spawnJitter,setSpawnJitter:e.setSpawnJitter,maxEnemies:e.maxEnemies,setMaxEnemies:e.setMaxEnemies,xpPerKill:e.xpPerKill,setXpPerKill:e.setXpPerKill,skills:be,isSkillOnCooldown:ke,getRemainingCooldown:gt,skillConfig:e.skillConfig,setSkillConfig:e.setSkillConfig,currentEnemyLevel:le,difficultyConfig:e.difficultyConfig,setDifficultyConfig:e.setDifficultyConfig},Ns=h.useMemo(()=>({isAutoMode:e.isAutoMode,aiMode:e.aiMode,gameSpeed:e.gameSpeed,speedMultiplier:e.speedMultiplier,isSlowMode:e.isSlowMode,spawnInterval:e.spawnInterval,spawnJitter:e.spawnJitter,maxEnemies:e.maxEnemies,baseAggression:e.baseAggression,isHardMode:e.isHardMode,xpPerKill:e.xpPerKill,skillConfig:e.skillConfig,difficultyConfig:e.difficultyConfig,debug:{showEffectArcGuide:e.showEffectArcGuide},ui:{controlPanelTab:e.controlPanelTab}}),[e.isAutoMode,e.aiMode,e.gameSpeed,e.speedMultiplier,e.isSlowMode,e.spawnInterval,e.spawnJitter,e.maxEnemies,e.baseAggression,e.isHardMode,e.xpPerKill,e.skillConfig,e.difficultyConfig,e.showEffectArcGuide,e.controlPanelTab]),Ss=h.useCallback((j,C)=>{switch(j){case"isAutoMode":e.setIsAutoMode(C);break;case"aiMode":e.setAiMode(C);break;case"gameSpeed":e.setGameSpeed(C);break;case"speedMultiplier":e.setSpeedMultiplier(C);break;case"isSlowMode":e.setIsSlowMode(C);break;case"spawnInterval":e.setSpawnInterval(C);break;case"spawnJitter":e.setSpawnJitter(C);break;case"maxEnemies":e.setMaxEnemies(C);break;case"xpPerKill":e.setXpPerKill(C);break;case"skillConfig":e.setSkillConfig(C);break;case"difficultyConfig":e.setDifficultyConfig(C);break;case"debug":e.setShowEffectArcGuide(C.showEffectArcGuide);break;case"ui":e.setControlPanelTab(C.controlPanelTab);break}},[e]),yt=a.jsx("canvas",{"data-test":"game-canvas",ref:L,width:U,height:K,onClick:E,tabIndex:0,className:"border-2 border-amber-300 rounded-lg cursor-pointer shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-400 max-w-full max-h-full"}),Ms=h.useCallback(()=>{e.setIsAutoMode(D.isAutoMode),e.setAiMode(D.aiMode),e.setGameSpeed(D.gameSpeed),e.setSpeedMultiplier(D.speedMultiplier),e.setIsSlowMode(D.isSlowMode),e.setSpawnInterval(D.spawnInterval),e.setSpawnJitter(D.spawnJitter),e.setMaxEnemies(D.maxEnemies),e.setXpPerKill(D.xpPerKill),e.setSkillConfig(D.skillConfig),e.setDifficultyConfig(D.difficultyConfig),e.setShowEffectArcGuide(D.debug.showEffectArcGuide),e.setControlPanelTab(D.ui.controlPanelTab),f(null)},[e]),wt=a.jsx(Kl,{showEffectArcGuide:e.showEffectArcGuide,setShowEffectArcGuide:e.setShowEffectArcGuide,onResetAllConfig:Ms,gameState:s,spawnInterval:e.spawnInterval,spawnJitter:e.spawnJitter,maxEnemies:e.maxEnemies,currentEnemyLevel:le,inheritedAggression:p,difficultyConfig:e.difficultyConfig,skillConfig:e.skillConfig,isAutoMode:e.isAutoMode,aiMode:e.aiMode,gameSpeed:e.gameSpeed,speedMultiplier:e.speedMultiplier,isSlowMode:e.isSlowMode,effectiveGameSpeed:M,isPaused:e.isPaused,xpPerKill:e.xpPerKill,baseAggression:e.baseAggression,runs:l}),bt=a.jsx("div",{"data-test":"bottom-right-buttons",className:"fixed bottom-4 right-4 z-50",children:a.jsx(Wl,{isHardMode:e.isHardMode,setIsHardMode:e.setIsHardMode})});return js?a.jsxs("div",{"data-test":"rpg-game-demo-page",className:"rpg-game-demo-page h-screen w-screen bg-gray-100",children:[a.jsxs("div",{"data-test":"mobile-layout",className:"flex flex-col h-full w-full pt-1 px-1 pb-1 gap-1",children:[a.jsx("div",{"data-test":"canvas-wrapper-mobile",className:"flex items-start justify-center flex-shrink-0",children:yt}),a.jsx(Dt,{className:"flex-1 min-h-0 overflow-auto",...vt})]}),wt,bt]}):a.jsxs("div",{"data-test":"rpg-game-demo-page",className:"rpg-game-demo-page h-screen w-screen bg-gray-100",children:[a.jsxs("div",{"data-test":"game-grid",className:"grid grid-cols-[1fr_60vw_1fr] grid-rows-[100px_1fr_auto] gap-4 p-4 landscape:gap-1 landscape:p-2 landscape:text-xs md:landscape:gap-4 md:landscape:p-4 md:landscape:text-base h-full w-full",children:[a.jsxs("div",{"data-test":"stats-row",className:"col-span-3 flex justify-between items-stretch gap-4 h-[100px]",children:[a.jsx(Vn,{fpsStats:G,gameSpeed:M}),a.jsx(Yn,{gameState:s,spawnProgress:V,timeRemaining:te,spawnInterval:e.spawnInterval,inheritedAggression:p??void 0})]}),a.jsx(Zn,{runs:l,currentLogs:s.gameLog,currentRunId:i,currentTickCount:w,currentLevel:Z,currentEnemiesSlain:c,currentInheritedAggression:p??void 0}),a.jsx("div",{"data-test":"canvas-wrapper",className:"flex items-center justify-center",children:yt}),x?a.jsx(Un,{config:Ns,onConfigChange:Ss,activeTab:e.controlPanelTab,onTabChange:j=>e.setControlPanelTab(j),gameState:s,setGameState:n}):a.jsx(Dt,{...vt}),a.jsx("div",{}),a.jsx("div",{}),a.jsxs("div",{"data-test":"controls-row",className:"flex flex-col gap-2",children:[a.jsx(Qn,{isAutoMode:e.isAutoMode,toggleAutoMode:e.toggleAutoMode,isPaused:e.isPaused,togglePause:e.togglePause,onReset:ht}),a.jsxs(Q,{"data-test":"toggle-control-panel",variant:"outline",size:"sm",onClick:()=>k(j=>!j),className:"flex items-center gap-2",children:[x?a.jsx(ia,{size:16}):a.jsx(oa,{size:16}),a.jsx("span",{className:"text-xs",children:"Toggle Control Panel"})]})]})]}),wt,bt]})}export{sr as RpgGameDemoPage};
