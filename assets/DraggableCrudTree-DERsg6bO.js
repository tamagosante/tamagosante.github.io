import{r as i,j as t}from"./react-vendor-Byz07MLO.js";import{V as ee,I as oe,a as X,ad as le,ae as ce,af as ie,ag as W}from"./index-DPqC4dt9.js";import{D as de}from"./DragDropManager-CacIWg_Z.js";import{r as ue,f as O,D as ge,i as he}from"./treeHelpers-DUv_6quS.js";import{Y as xe,S as pe,X as me,_ as fe,$ as ve,T as U,g as be,O as Ne}from"./icons-Ce2OFwrV.js";function te({node:r,level:S,parentId:B,index:q,onItemClick:C,onUpdate:R,onDelete:j,defaultExpandedIds:D,selectedId:Z,enableEdit:$=!0,enableDelete:b=!0,enableDrag:F=!0,deleteConfirmMessage:z,renderNode:T,moreOptionsItems:A,dropdownZIndex:H,quickActions:Y,dragSortIndex:m,dragTargetParent:I,draggedNodeId:g,onTreeStructureChange:P,allNodes:V}){const[w,k]=i.useState((D==null?void 0:D.has(r.id))??!1),[y,u]=i.useState(!1),[N,K]=i.useState(r.label),L=!!(r.children&&r.children.length>0),M=Z===r.id,l=i.useRef(null);i.useEffect(()=>{P()},[w,P]),i.useEffect(()=>{M&&l.current&&l.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[M]);const h=e=>{e.stopPropagation(),y||(L&&k(!w),C==null||C(r))},x=()=>{N.trim()&&N!==r.label&&(R==null||R(r.id,N.trim())),u(!1)},d=()=>{K(r.label),u(!1)},o=e=>{e.stopPropagation();const s=(z==null?void 0:z(r))??`Are you sure you want to delete "${r.label}"?`;window.confirm(s)&&(j==null||j(r.id))},c={paddingLeft:`${S*1.5}rem`},p=L?t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:w?t.jsx(be,{className:"h-4 w-4"}):t.jsx(Ne,{className:"h-4 w-4"})}):t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),a=g&&g!==r.id&&I===B&&m===q,n=t.jsxs(t.Fragment,{children:[a&&t.jsx("div",{className:"drop-indicator h-0.5 bg-primary -mt-1 mb-1",style:c}),t.jsxs("div",{ref:l,className:ee("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",M&&"bg-primary/10 border border-primary"),style:c,onClick:h,children:[F&&t.jsx("div",{"data-drag-handle":r.id,"data-parent-id":B,className:"drag-handle cursor-grab active:cursor-grabbing mr-1 opacity-0 group-hover:opacity-100",children:t.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})}),p,r.icon&&t.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:r.icon}),y?t.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[t.jsx(oe,{type:"text",value:N,onChange:e=>K(e.target.value),onKeyDown:e=>{e.key==="Enter"&&x(),e.key==="Escape"&&d()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:e=>e.stopPropagation()}),t.jsx(X,{variant:"ghost",size:"sm",onClick:e=>{e.stopPropagation(),x()},className:"h-6 w-6 p-0",children:t.jsx(pe,{className:"h-3 w-3"})}),t.jsx(X,{variant:"ghost",size:"sm",onClick:e=>{e.stopPropagation(),d()},className:"h-6 w-6 p-0",children:t.jsx(me,{className:"h-3 w-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"tree-item-label flex-grow truncate",title:r.label,children:r.label}),t.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[(()=>{const e=Y==null?void 0:Y(r);return e&&e.length>0?e.map(s=>t.jsx(X,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),s.onClick(r)},className:"h-6 w-6 p-0",title:s.title,"data-test":"tree-item-quick-action",children:s.icon},s.id)):null})(),$&&R&&t.jsx(X,{variant:"ghost",size:"sm",onClick:e=>{e.stopPropagation(),u(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:t.jsx(fe,{className:"h-3 w-3"})}),(()=>{const e=A==null?void 0:A(r);return e&&e.length>0?t.jsxs(le,{children:[t.jsx(ce,{asChild:!0,children:t.jsx(X,{variant:"ghost",size:"sm",onClick:s=>s.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:t.jsx(ve,{className:"h-3 w-3"})})}),t.jsxs(ie,{align:"end",style:H?{zIndex:H}:void 0,"data-test":"tree-item-more-options-content",children:[e.map(s=>t.jsxs(W,{onClick:f=>{f.stopPropagation(),s.onClick(r)},className:s.className,"data-test":"tree-item-menu-option",children:[s.icon,s.label]},s.id)),b&&j&&t.jsxs(W,{onClick:s=>{s.stopPropagation(),o(s)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[t.jsx(U,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):b&&j?t.jsx(X,{variant:"ghost",size:"sm",onClick:o,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:t.jsx(U,{className:"h-3 w-3"})}):null})()]})]})]})]});return t.jsxs("div",{className:"draggable-crud-tree-item",children:[T?T(r,M,L,n):n,L&&w&&t.jsx("div",{"data-drop-zone":r.id,"data-node-name":r.label,children:r.children.map((e,s)=>t.jsx(te,{node:e,level:S+1,parentId:r.id,index:s,onItemClick:C,onUpdate:R,onDelete:j,defaultExpandedIds:D,selectedId:Z,enableEdit:$,enableDelete:b,enableDrag:F,deleteConfirmMessage:z,renderNode:T,moreOptionsItems:A,dropdownZIndex:H,quickActions:Y,dragSortIndex:m,dragTargetParent:I,dragOverNode:null,dragX:null,dragY:null,dragExpectedX:null,dragExpectedY:null,draggedNodeId:g,dragNextNodeLabel:null,onTreeStructureChange:P,allNodes:V},e.id))})]})}function Ee({data:r,onReorder:S,onItemClick:B,onUpdate:q,onDelete:C,className:R,defaultExpandedIds:j,selectedId:D,enableEdit:Z=!0,enableDelete:$=!0,enableDrag:b=!0,deleteConfirmMessage:F,renderNode:z,moreOptionsItems:T,dropdownZIndex:A,quickActions:H,queryRoot:Y}){const m=Y??document,I=i.useRef(null),g=i.useRef(r),P=i.useRef(S),V=i.useRef(null),w=i.useRef([]),k=i.useRef(null),y=i.useRef({targetParent:null,sortIndex:null});i.useEffect(()=>{g.current=r,P.current=S},[r,S]);const[u,N]=i.useState({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),[K,L]=i.useState(0),M=i.useCallback(()=>{L(l=>l+1)},[]);return i.useEffect(()=>{if(b)return I.current=new de({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:({item:l})=>{const h=l.data.nodeId;k.current=null,y.current={targetParent:null,sortIndex:null};const x=m.querySelector(`[data-drag-handle="${h}"]`);if(x){const a=x.parentElement;if(a){const n=a.getBoundingClientRect();V.current={top:Math.round(n.top),bottom:Math.round(n.bottom)}}}const d=[];m.querySelectorAll("[data-drag-handle]").forEach(a=>{const n=a.getAttribute("data-drag-handle");if(n){const e=a.parentElement;if(e){const s=e.getBoundingClientRect(),f=O(g.current,n);d.push({id:n,label:(f==null?void 0:f.node.label)||n,rect:{top:Math.round(s.top),bottom:Math.round(s.bottom)}})}}});const c=new Map;d.forEach(a=>{const n=a.rect.bottom-a.rect.top,e=c.get(a.id);if(!e)c.set(a.id,a);else{const s=e.rect.bottom-e.rect.top;n<s&&c.set(a.id,a)}});const p=Array.from(c.values());return p.sort((a,n)=>a.rect.top-n.rect.top),w.current=p,N({isDragging:!0,nodeId:l.id,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),!0},onDragMove:({item:l,position:h})=>{var f,Q;l.data.nodeId;const x=Math.round(h.x),d=Math.round(h.y),o=V.current;if(o&&d>=o.top&&d<=o.bottom){N(v=>({...v,x,y:d,sortIndex:null,targetParent:null,overNode:null,expectedX:null,expectedY:null,nextNodeLabel:null}));return}const a=w.current.find(v=>d>=v.rect.top&&d<=v.rect.bottom);let n=null;if(a){const v=O(g.current,a.id);if(v){const re=a.rect.bottom-a.rect.top,G=(d-a.rect.top)/re,ne=G>=.33&&G<.66,ae=G>=.66;if(ne)n={targetParentId:a.id,sortIndex:0};else if(ae){const E=v.parent,_=(E===null?g.current:((f=O(g.current,E))==null?void 0:f.node.children)||[]).findIndex(J=>J.id===a.id);n={targetParentId:E,sortIndex:_+1}}else{const E=v.parent,_=(E===null?g.current:((Q=O(g.current,E))==null?void 0:Q.node.children)||[]).findIndex(J=>J.id===a.id);n={targetParentId:E,sortIndex:_}}}n&&(k.current=n)}else k.current&&(n=k.current);const e=(n==null?void 0:n.targetParentId)??null,s=(n==null?void 0:n.sortIndex)??0;y.current={targetParent:e??null,sortIndex:s??null},N(v=>({...v,sortIndex:s??null,targetParent:e??null,overNode:e??null,x,y:d,expectedX:null,expectedY:null,nextNodeLabel:null}))},onDrop:({item:l})=>{const h=l.data.nodeId,x=y.current.targetParent,d=y.current.sortIndex;if(d==null)return;const{newNodes:o,removed:c}=ue(g.current,h);if(!c)return;const p=he(o,c,x,d);P.current&&P.current(p)},onDragEnd:()=>{V.current=null,w.current=[],y.current={targetParent:null,sortIndex:null},N({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null})}}),()=>{var l;(l=I.current)==null||l.destroy()}},[b]),i.useEffect(()=>{if(!I.current||!b)return;m.querySelectorAll('[data-dnd-registered="true"]').forEach(o=>o.removeAttribute("data-dnd-registered")),m.querySelectorAll('[data-dnd-zone-registered="true"]').forEach(o=>o.removeAttribute("data-dnd-zone-registered")),m.querySelectorAll("[data-drop-zone]").forEach(o=>{const c=o.getAttribute("data-drop-zone"),p=o.getAttribute("data-node-name");c&&(I.current.registerDropZone(c,o,void 0,{nodeName:p||c}),o.setAttribute("data-dnd-zone-registered","true"))}),m.querySelectorAll("[data-drag-handle]").forEach(o=>{const c=o.getAttribute("data-drag-handle"),p=o.getAttribute("data-parent-id");let a="root",n=o.parentElement;for(;n;){const e=n.getAttribute("data-drop-zone");if(e){a=e;break}n=n.parentElement}c&&(I.current.registerDraggable(c,o,{nodeId:c,parentId:p||null,dropZoneId:a}),o.setAttribute("data-dnd-registered","true"))})},[r,K,b,m]),t.jsx("div",{className:ee("draggable-crud-tree",R),children:t.jsxs("div",{"data-drop-zone":"root","data-node-name":"root","data-tree-root":!0,style:{position:"relative"},children:[r.map((l,h)=>t.jsx(te,{node:l,level:0,parentId:null,index:h,onItemClick:B,onUpdate:q,onDelete:C,defaultExpandedIds:j,selectedId:D,enableEdit:Z,enableDelete:$,enableDrag:b,deleteConfirmMessage:F,renderNode:z,moreOptionsItems:T,dropdownZIndex:A,quickActions:H,dragSortIndex:u.sortIndex,dragTargetParent:u.targetParent,dragOverNode:u.overNode,dragX:u.x,dragY:u.y,dragExpectedX:u.expectedX,dragExpectedY:u.expectedY,draggedNodeId:u.nodeId,dragNextNodeLabel:u.nextNodeLabel,onTreeStructureChange:M,allNodes:r},l.id)),u.sortIndex===r.length&&u.targetParent===null&&t.jsx(ge,{message:"Drop at end"})]})})}export{Ee as D};
