const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePage-DTWl9QNI.js","assets/react-vendor-BOZDwKwV.js","assets/icons-Cf9puwNc.js","assets/recordingStorage-XzvoUejy.js","assets/utils-CGefl9Xh.js","assets/radix-ui-DhHtVSYQ.js","assets/ui-utils-BxIQ3qGg.js","assets/Chat-Dp3i_1he.js","assets/format-utils-Ba8uG3XU.js","assets/systemPromptService-CiGRUnu2.js","assets/InputWithAudio-B6s87S4E.js","assets/textarea-BYE7lOdv.js","assets/Settings-D66t-Zt2.js","assets/Demo-DubgCTCW.js","assets/Breadcrumbs-S61b4Rvs.js","assets/Content-Dr9w-8mi.js","assets/TablePage-BDHpCqyU.js","assets/data-table-DcNd1KXe.js","assets/table-ilz88M9w.js","assets/VocabularyPage-D0SsVEIi.js","assets/definitionHelper-cMYKfgYf.js","assets/useVietnameseTyping-CIrK2WEd.js","assets/TextareaPopoverAtCursor-CTiQM1rI.js","assets/LiveTranscriptionPage-vaO1vryH.js","assets/AudioPanelDemo-nrp69AyU.js","assets/ClaudePage-C7p8WBZC.js","assets/SessionSidebar-BGwCRfnY.js","assets/tree-CY2JL3NQ.js","assets/SessionDetailsPage-DMBlmNpD.js","assets/KanbanPage-iU9cyl7E.js","assets/DemoLayout-DfXs0Dx6.js","assets/react-hooks-Dl1bdWHK.js","assets/DragDropManager-BCQ9eUTy.js","assets/KanbanDataPage-BEtcc_ji.js","assets/JsonViewerApp-C--NIchR.js","assets/index-BxmPIzXM.js","assets/GlobalStatePage-Cxc-xZ62.js","assets/GamePage-DKHMiDe7.js","assets/NewHomeApp-RcLBckri.js","assets/CanvasAppV2-uVZdePrV.js","assets/index.browser-BYu060nj.js","assets/string-C17ai3Kd.js","assets/random-CIc2u2bh.js","assets/DraggableTree-CLiJf_vF.js","assets/DropIndicator-GmEeK0_B.js","assets/useOcr-UEiJANMF.js","assets/alert-DmIJ9i2z.js","assets/DraggableCrudTree-Cnti-YJb.js","assets/easy-form-BOcKu_hU.js","assets/forms-DZWYrWtp.js","assets/form-xiPnKTSn.js","assets/MobileLogViewerButton-vWqOu4ib.js"])))=>i.map(i=>d[i]);
var Lo=Object.defineProperty;var Mo=(a,e,t)=>e in a?Lo(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var X=(a,e,t)=>Mo(a,typeof e!="symbol"?e+"":e,t);import{r as i,j as s,d as Oo,e as Ea,u as qa,h as ia,b as $o,R as Uo,i as Fo,B as zo}from"./react-vendor-BOZDwKwV.js";import{B as Bo,m as ka,d as Ho,_ as Ve,t as Je,z as Wo,T as Go}from"./utils-CGefl9Xh.js";import{S as It,k as Ka,O as Ns,d as ca,C as Kt,j as la,T as Es,D as ks,R as Ja,l as Vo,m as Qa,n as qo,o as Ko,p as Jo,q as Qo,r as Yo,s as Xo,t as Zo,v as ei,w as ti,x as Ya,A as si,y as Xa,z as ai,B as Za,E as ri,V as ni,F as er,G as oi,H as ii,J as tr,K as ci,L as sr,M as li,N as di,Q as ar,U as rr,W as nr,X as or,Y as ui,Z as hi,$ as pi,a0 as mi,a1 as ir,a2 as cr,a3 as lr,a4 as dr,a5 as ur,a6 as hr,a7 as pr,a8 as mr,a9 as fr,aa as gr,ab as fi,ac as gi,ad as xi,ae as xr,af as bi,ag as br,ah as vi,ai as yi,aj as vr,ak as wi,al as Si,am as yr,an as wr,ao as Sr}from"./radix-ui-DhHtVSYQ.js";import{t as ji,a as os,c as Jt}from"./ui-utils-BxIQ3qGg.js";import{X as Qe,a$ as Ci,b0 as Ta,b1 as Ni,c as bt,M as jr,b2 as Ei,aQ as ki,b3 as Ti,b4 as Ai,aK as Ri,W as Pi,b5 as Cr,z as Ii,b6 as Nr,b7 as Er,b8 as kr,r as Tr,t as Ar,b9 as Rr,au as Qt,a8 as Et,V as hs,F as da,aO as Di,aP as _i,J as We,a7 as Yt,aj as Pr,Y as ua,ba as Ir,bb as Li,av as Mi,bc as Oi,ai as $i,y as Os,D as Nt,aG as Ui,ak as Dr,ab as Fi,v as Ts,w as zi,x as Bi,E as Hi,aC as Ks,S as Bt,d as ha,bd as Wi,$ as Aa,_ as Lt,an as Gi,a as Js,at as _r,ap as ps,be as Vi,bf as qi,O as Lr,bg as Ki,bh as Ji,B as Qi,N as Yi,L as Xi,e as Zi,aV as ec,ad as tc,ao as Mr,a9 as sc}from"./icons-Cf9puwNc.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const jt=class jt{constructor(){X(this,"logs",[]);X(this,"counter",0);X(this,"maxLogs",100);X(this,"listeners",[]);X(this,"isCollecting",!1);X(this,"collectedLogs",[]);X(this,"originalConsole",{log:console.log,warn:console.warn,error:console.error,debug:console.debug})}static getInstance(){return jt.instance||(jt.instance=new jt),jt.instance}log(e,t="info",r){const n=new Date().toLocaleTimeString(),o={id:`log-${this.counter++}`,timestamp:n,message:e,level:t,service:r},l=t==="error"?console.error:t==="warning"?console.warn:t==="debug"?console.debug:console.log,c=r?`[${r}] `:"",d=`[${n}] ${c}${e}`;l(d),this.isCollecting&&this.collectedLogs.push(d),this.logs=[o,...this.logs.slice(0,this.maxLogs-1)],this.notifyListeners()}info(e,t){this.log(e,"info",t)}error(e,t){this.log(e,"error",t)}warning(e,t){this.log(e,"warning",t)}debug(e,t){this.log(e,"debug",t)}getLogs(){return this.logs}clear(){this.logs=[],this.notifyListeners()}export(){return this.logs.slice().reverse().map(e=>{const t=e.service?`[${e.service}] `:"";return`[${e.timestamp}] ${e.level.toUpperCase()}: ${t}${e.message}`}).join(`
`)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}collectLogs(e=!0){this.isCollecting=!0,this.collectedLogs=[],e&&typeof window<"u"&&this.interceptConsole(),console.log("ðŸ“ Log collection started. Call window.printCollectedLogs() to retrieve.")}interceptConsole(){const e=this;console.log=function(...t){const r=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(r),e.originalConsole.log.apply(console,t)},console.warn=function(...t){const r=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(`WARN: ${r}`),e.originalConsole.warn.apply(console,t)},console.error=function(...t){const r=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(`ERROR: ${r}`),e.originalConsole.error.apply(console,t)},console.debug=function(...t){const r=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(`DEBUG: ${r}`),e.originalConsole.debug.apply(console,t)}}restoreConsole(){console.log=this.originalConsole.log,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,console.debug=this.originalConsole.debug}stopCollecting(){this.isCollecting=!1,this.restoreConsole();const e=this.collectedLogs.join(`
`);return console.log("ðŸ›‘ Log collection stopped."),e}getCollectedLogs(){return this.collectedLogs.join(`
`)}clearCollectedLogs(){this.collectedLogs=[]}};X(jt,"instance");let Qs=jt;const pe=Qs.getInstance();typeof window<"u"&&(window.getCollectedLogs=()=>pe.getCollectedLogs(),window.printCollectedLogs=()=>{const a=pe.getCollectedLogs();return console.log(`ðŸ“‹ Collected logs:
`+a),a},window.startCollectingLogs=()=>pe.collectLogs(),window.stopCollectingLogs=()=>pe.stopCollecting(),window.clearCollectedLogs=()=>pe.clearCollectedLogs());const Or=()=>{const[a,e]=i.useState(()=>pe.getLogs());i.useEffect(()=>pe.subscribe(n=>{e(n)}),[]);const t=i.useRef();return t.current||(t.current={log:(r,n,o)=>pe.log(r,n,o),info:(r,n)=>pe.info(r,n),error:(r,n)=>pe.error(r,n),warning:(r,n)=>pe.warning(r,n),debug:(r,n)=>pe.debug(r,n),clear:()=>pe.clear(),export:()=>pe.export()}),{logs:a,actions:t.current}};class ac{constructor(e="http://localhost:3333"){X(this,"baseUrl");X(this,"eventSource",null);this.baseUrl=e}async getProjects(e){const t=new URLSearchParams;(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const r=`${this.baseUrl}/claude/projects${t.toString()?`?${t.toString()}`:""}`;try{const n=await fetch(r);if(!n.ok)throw new Error(`Failed to fetch projects: ${n.statusText}`);return await n.json()}catch(n){throw console.error("[ClaudeAPI.getProjects] Fetch error:",{url:r,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",errorName:n instanceof Error?n.name:void 0,timestamp:new Date().toISOString()}),n}}async getProjectDetails(e){const t=`${this.baseUrl}/claude/projects/${encodeURIComponent(e)}`,r=await fetch(t);if(!r.ok)throw new Error(`Failed to fetch project details: ${r.statusText}`);return r.json()}async getSessions(e){const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const r=`${this.baseUrl}/claude/sessions${t.toString()?`?${t.toString()}`:""}`;try{const n=await fetch(r);if(!n.ok)throw new Error(`Failed to fetch sessions: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getSessions] Fetch error:",{url:r,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",errorName:n instanceof Error?n.name:void 0,errorStack:n instanceof Error?n.stack:void 0,timestamp:new Date().toISOString()}),n}}async searchSessions(e,t){const r=new URLSearchParams;e&&(t!=null&&t.messageTypes&&t.messageTypes.length>0?r.append("messageContent",e):r.append("q",e)),t!=null&&t.fields&&t.fields.length>0&&!(t!=null&&t.messageTypes&&t.messageTypes.length>0)&&r.append("fields",t.fields.join(",")),(t==null?void 0:t.isActive)!==void 0&&r.append("isActive",t.isActive.toString()),(t==null?void 0:t.minMessages)!==void 0&&r.append("minMessages",t.minMessages.toString()),(t==null?void 0:t.maxMessages)!==void 0&&r.append("maxMessages",t.maxMessages.toString()),t!=null&&t.modifiedAfter&&r.append("modifiedAfter",t.modifiedAfter),t!=null&&t.modifiedBefore&&r.append("modifiedBefore",t.modifiedBefore),t!=null&&t.messageTypes&&t.messageTypes.length>0&&r.append("messageTypes",t.messageTypes.join(",")),t!=null&&t.sortBy&&r.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&r.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&r.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&r.append("pageSize",t.pageSize.toString());const n=`${this.baseUrl}/claude/sessions/search${r.toString()?`?${r.toString()}`:""}`;try{const o=await fetch(n);if(!o.ok)throw new Error(`Failed to search sessions: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.searchSessions] Fetch error:",{url:n,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,errorStack:o instanceof Error?o.stack:void 0,timestamp:new Date().toISOString()}),o}}async searchSessionMessages(e,t,r){const n=new URLSearchParams;t&&n.append("content",t),r!=null&&r.messageType&&r.messageType.length>0?n.append("messageType",r.messageType.join(",")):r!=null&&r.role&&n.append("role",r.role),r!=null&&r.after&&n.append("after",r.after),r!=null&&r.before&&n.append("before",r.before),r!=null&&r.sortOrder&&n.append("sortOrder",r.sortOrder),(r==null?void 0:r.page)!==void 0&&n.append("page",r.page.toString()),(r==null?void 0:r.pageSize)!==void 0&&n.append("pageSize",r.pageSize.toString());const o=`${this.baseUrl}/claude/sessions/${e}/search${n.toString()?`?${n.toString()}`:""}`,l=await fetch(o);if(!l.ok)throw new Error(`Failed to search session messages: ${l.statusText}`);return l.json()}async searchMessages(e,t){const r=new URLSearchParams;e&&r.append("q",e),t!=null&&t.messageType&&t.messageType.length>0&&r.append("messageTypes",t.messageType.join(",")),t!=null&&t.after&&r.append("after",t.after),t!=null&&t.before&&r.append("before",t.before),t!=null&&t.sortOrder&&r.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&r.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&r.append("pageSize",t.pageSize.toString());const n=`${this.baseUrl}/claude/messages/search${r.toString()?`?${r.toString()}`:""}`,o=await fetch(n);if(!o.ok)throw new Error(`Failed to search messages: ${o.statusText}`);return o.json()}async getSessionDetails(e,t){const r=new URLSearchParams;(t==null?void 0:t.page)!==void 0&&r.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&r.append("pageSize",t.pageSize.toString()),t!=null&&t.messageType&&t.messageType.length>0&&r.append("messageType",t.messageType.join(","));const n=`${this.baseUrl}/claude/sessions/${e}${r.toString()?`?${r.toString()}`:""}`;try{const o=await fetch(n);if(!o.ok)throw new Error(`Failed to fetch session details: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionDetails] Fetch error:",{url:n,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,timestamp:new Date().toISOString()}),o}}async sendMessage(e){const t=await fetch(`${this.baseUrl}/claude/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to send message: ${t.statusText}`);return t.json()}async createSession(e={}){const t=await fetch(`${this.baseUrl}/claude/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to create session: ${t.statusText}`);return t.json()}async updateSessionName(e,t){const r=await fetch(`${this.baseUrl}/claude/sessions/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customName:t})});if(!r.ok)throw new Error(`Failed to update session name: ${r.statusText}`);return r.json()}async updateSessionStatus(e,t){const r=await fetch(`${this.baseUrl}/claude/sessions/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to update session status: ${r.statusText}`);return r.json()}subscribeToSessionChanges(e,t){const r=`${this.baseUrl}/claude/sessions/events`;return this.eventSource=new EventSource(r),this.eventSource.onopen=()=>{var n;console.log("[ClaudeAPI.subscribeToSessionChanges] SSE connection opened:",{url:r,readyState:(n=this.eventSource)==null?void 0:n.readyState,timestamp:new Date().toISOString()})},this.eventSource.onmessage=n=>{try{const o=JSON.parse(n.data);o.type!=="connected"&&e(o)}catch(o){console.error("[ClaudeAPI.subscribeToSessionChanges] Failed to parse SSE event:",{error:o,eventData:n.data,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=n=>{var o,l,c,d;console.error("[ClaudeAPI.subscribeToSessionChanges] SSE connection error:",{error:n,readyState:(o=this.eventSource)==null?void 0:o.readyState,readyStateText:((l=this.eventSource)==null?void 0:l.readyState)===0?"CONNECTING":((c=this.eventSource)==null?void 0:c.readyState)===1?"OPEN":((d=this.eventSource)==null?void 0:d.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),t&&t(n)},()=>{var n;(n=this.eventSource)==null||n.close(),this.eventSource=null}}}const Ye=new ac;class rc{constructor(e="http://localhost:3333"){X(this,"eventSource",null);X(this,"eventHandlers",new Set);X(this,"errorHandlers",new Set);X(this,"baseUrl");X(this,"reconnectAttempts",0);X(this,"maxReconnectAttempts",5);X(this,"reconnectDelay",1e3);this.baseUrl=e}subscribe(e,t){return this.eventHandlers.add(e),t&&this.errorHandlers.add(t),this.eventHandlers.size===1&&!this.eventSource&&this.connect(),()=>{this.eventHandlers.delete(e),t&&this.errorHandlers.delete(t),this.eventHandlers.size===0&&this.disconnect()}}connect(){const e=`${this.baseUrl}/claude/sessions/events`;this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.reconnectAttempts=0},this.eventSource.onmessage=t=>{try{const r=JSON.parse(t.data);if(r.type==="connected")return;this.eventHandlers.forEach(n=>{try{n(r)}catch(o){console.error("[ClaudeSSEManager] Error in event handler:",{error:o,eventType:r.type,timestamp:new Date().toISOString()})}})}catch(r){console.error("[ClaudeSSEManager] Failed to parse SSE event:",{error:r,eventData:t.data,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=t=>{var r,n,o,l;if(console.error("[ClaudeSSEManager] SSE connection error:",{error:t,readyState:(r=this.eventSource)==null?void 0:r.readyState,readyStateText:((n=this.eventSource)==null?void 0:n.readyState)===0?"CONNECTING":((o=this.eventSource)==null?void 0:o.readyState)===1?"OPEN":((l=this.eventSource)==null?void 0:l.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),this.errorHandlers.forEach(c=>{try{c(t)}catch(d){console.error("[ClaudeSSEManager] Error in error handler:",d)}}),this.eventHandlers.size>0&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const c=this.reconnectDelay*this.reconnectAttempts;setTimeout(()=>{this.eventHandlers.size>0&&(this.disconnect(),this.connect())},c)}}}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null,this.reconnectAttempts=0)}getConnectionState(){var e;return((e=this.eventSource)==null?void 0:e.readyState)??null}getSubscriberCount(){return this.eventHandlers.size}}const nc=new rc;function pa(a,e,t=!0){const r=i.useRef(a),n=i.useRef(e);i.useEffect(()=>{r.current=a},[a]),i.useEffect(()=>{n.current=e},[e]);const o=i.useCallback(d=>{r.current(d)},[]),l=i.useCallback(d=>{var u;(u=n.current)==null||u.call(n,d)},[]),c=i.useRef(!!e);i.useEffect(()=>{c.current=!!e},[e]),i.useEffect(()=>{if(!t)return;const d=nc.subscribe(o,c.current?l:void 0);return()=>{d()}},[t,o,l])}function $r(a,e){const t={...a};for(const r in e)if(Object.prototype.hasOwnProperty.call(e,r)){const n=e[r],o=t[r];n&&typeof n=="object"&&!Array.isArray(n)&&o&&typeof o=="object"&&!Array.isArray(o)?t[r]=$r(o,n):t[r]=n}return t}class oc{constructor(e={}){X(this,"STORAGE_KEY","global-store");X(this,"state$");const t=this.loadFromStorage();this.state$=new Bo({...e,...t})}getState(){return this.state$.value}getState$(){return this.state$.asObservable()}get(e){return this.state$.value[e]}select(e){return this.state$.pipe(ka(t=>t[e]),Ho())}selectSlice(e){return this.state$.pipe(ka(e))}setState(e){this.state$.next(e),this.saveToStorage()}updateState(e){const t={...this.state$.value,...e};this.state$.next(t),this.saveToStorage()}set(e,t){this.updateState({[e]:t})}update(e,t){const r=this.state$.value[e],n=typeof r=="object"&&r!==null&&typeof t=="object"&&t!==null?$r(r,t):t;this.set(e,n)}remove(e){const t={...this.state$.value};delete t[e],this.state$.next(t),this.saveToStorage()}reset(){this.state$.next({}),this.clearStorage()}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load global store from localStorage:",e),{}}}saveToStorage(){try{const e=this.getStateToPersist(this.state$.value);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save global store to localStorage:",e)}}getStateToPersist(e){var r,n;const t={...e};if(t.ui&&(t.ui={...t.ui,directoryMaps:void 0}),(r=t.app)!=null&&r.claude){const o=t.app.claude;t.app={...t.app,claude:{...o,data:void 0,ui:o.ui?{...o.ui,isInitialized:void 0,loadingSessions:void 0,sessionsError:void 0,projectsInitialized:void 0,loadingProjects:void 0,projectsError:void 0,activity:void 0}:void 0}}}if((n=t.app)!=null&&n.kanban){const o=t.app.kanban;t.app={...t.app,kanban:{...o,loading:void 0,error:void 0}}}return t}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear global store from localStorage:",e)}}export(){return JSON.stringify(this.state$.value,null,2)}import(e){try{const t=JSON.parse(e);return this.setState(t),!0}catch(t){return console.error("Failed to import global store data:",t),!1}}}const Y=new oc;function Te(a){const[e,t]=i.useState(()=>a(Y.getState()));return i.useEffect(()=>{const r=Y.selectSlice(a).subscribe(t);return()=>r.unsubscribe()},[a]),e}function Ur(){return{get:Y.get.bind(Y),set:Y.set.bind(Y),update:Y.update.bind(Y),updateState:Y.updateState.bind(Y),remove:Y.remove.bind(Y),reset:Y.reset.bind(Y),getState:Y.getState.bind(Y)}}const ic=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.sessions)??[]},cc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.loadingSessions)??!1},lc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.sessionsError)??null},dc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.pagination)??null},uc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.currentPage)??1},hc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.isInitialized)??!1};function pc(a={}){const{loadOnMount:e=!0,subscribeToSSE:t=!0}=a,{update:r,getState:n}=Ur(),o=i.useRef(!1),l=Te(ic),c=Te(cc),d=Te(lc),u=Te(dc),h=Te(uc),m=Te(hc),g=async(x=1,C=!1)=>{var j,S,N,T,W;try{const L=(j=n().app)==null?void 0:j.claude;r("app",{claude:{ui:{...L==null?void 0:L.ui,loadingSessions:!0,sessionsError:null,currentPage:x,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1}}});const P=await Ye.getSessions({page:x,pageSize:20}),U=[...P.sessions].sort((O,E)=>new Date(E.lastModified).getTime()-new Date(O.lastModified).getTime()),$=((S=L==null?void 0:L.data)==null?void 0:S.sessions)??[],k=C?[...$,...U]:U;r("app",{claude:{data:{sessions:k,pagination:P.pagination||null},ui:{loadingSessions:!1,sessionsError:null,currentPage:x,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}})}catch(L){console.error("[SessionLoader] API request failed:",{error:L,errorMessage:L instanceof Error?L.message:"Unknown error",page:x,append:C,timestamp:new Date().toISOString()}),pe.error(`Session load failed: ${L instanceof Error?L.message:"Unknown error"}`,"SessionLoader"),r("app",{claude:{data:{sessions:C?((W=(T=(N=n().app)==null?void 0:N.claude)==null?void 0:T.data)==null?void 0:W.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:L instanceof Error?L.message:"Failed to load sessions",currentPage:x,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}}),pe.error("Store updated with error state","SessionLoader")}},b=async(x,C,j=!1)=>{var S,N,T,W,L;try{const P=(S=n().app)==null?void 0:S.claude;r("app",{claude:{ui:{...P==null?void 0:P.ui,loadingSessions:!0,sessionsError:null,searchQuery:x,searchFilters:C,isSearchActive:!0}}});const U=await Ye.searchSessions(x,C),$=((N=P==null?void 0:P.data)==null?void 0:N.sessions)??[],k=j?[...$,...U.results]:U.results;r("app",{claude:{data:{sessions:k,pagination:U.pagination},ui:{loadingSessions:!1,sessionsError:null,currentPage:U.pagination.page,searchQuery:x,searchFilters:C,isSearchActive:!0}}})}catch(P){console.error("[SessionLoader] API request failed:",{error:P,errorMessage:P instanceof Error?P.message:"Unknown error",query:x,filters:C,append:j,timestamp:new Date().toISOString()}),r("app",{claude:{data:{sessions:j?((L=(W=(T=n().app)==null?void 0:T.claude)==null?void 0:W.data)==null?void 0:L.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:P instanceof Error?P.message:"Failed to search sessions",currentPage:1,searchQuery:x,searchFilters:C,isSearchActive:!0}}})}},w=(x,C)=>{var W,L,P;const j=((P=(L=(W=n().app)==null?void 0:W.claude)==null?void 0:L.data)==null?void 0:P.sessions)??[],S=j.findIndex(U=>U.id===x);if(S===-1)return;const N=[...j];N[S]={...N[S],...C};const T=N.sort((U,$)=>new Date($.lastModified).getTime()-new Date(U.lastModified).getTime());r("app",{claude:{data:{sessions:T},ui:{loadingSessions:!1,sessionsError:null}}})},p=x=>{var S,N,T;const j=(((T=(N=(S=n().app)==null?void 0:S.claude)==null?void 0:N.data)==null?void 0:T.sessions)??[]).filter(W=>W.id!==x);r("app",{claude:{data:{sessions:j},ui:{loadingSessions:!1,sessionsError:null}}})},v=x=>{var j,S;const C=(S=(j=n().app)==null?void 0:j.claude)==null?void 0:S.ui;if(C!=null&&C.isSearchActive&&(C==null?void 0:C.searchQuery)!==void 0){const N={...C.searchFilters,page:x};b(C.searchQuery,N)}else g(x)},y=()=>{var x,C;if(u&&h<u.totalPages){const j=(C=(x=n().app)==null?void 0:x.claude)==null?void 0:C.ui;if(j!=null&&j.isSearchActive&&(j==null?void 0:j.searchQuery)!==void 0){const S={...j.searchFilters,page:h+1};b(j.searchQuery,S,!0)}else g(h+1,!0)}},f=()=>{g(1)};return i.useEffect(()=>{e&&(m||o.current||(o.current=!0,g(1)))},[m]),pa(x=>{x.type==="created"&&g(h),x.type==="modified"&&x.sessionId&&(async()=>{try{const C=await Ye.getSessionDetails(x.sessionId);w(x.sessionId,{name:C.name,lastModified:C.metadata.lastModified,messageCount:C.metadata.messageCount})}catch(C){console.error("[SSE] Failed to fetch modified session:",{sessionId:x.sessionId,error:C,timestamp:new Date().toISOString()})}})(),x.type==="batch-modified"&&x.sessionIds&&g(h),x.type==="deleted"&&x.sessionId&&p(x.sessionId)},x=>{console.error("[SSE] Connection error:",{error:x,errorMessage:x instanceof Error?x.message:"Unknown error",timestamp:new Date().toISOString()})},t),{sessions:l,loadingSessions:c,sessionsError:d,pagination:u,currentPage:h,isInitialized:m,loadSessions:g,searchSessions:b,refreshSessions:f,handlePageChange:v,handleLoadMore:y}}const mc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.projects)??[]},fc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.loadingProjects)??!1},gc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.projectsError)??null},xc=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.projectsInitialized)??!1};function bc(a={}){const{loadOnMount:e=!0}=a,{update:t,getState:r}=Ur(),n=i.useRef(!1),o=Te(mc),l=Te(fc),c=Te(gc),d=Te(xc),u=async()=>{var m,g,b;try{const w=r(),p=(m=w.app)==null?void 0:m.claude;t("app",{...w.app,claude:{...p,data:{...p==null?void 0:p.data},ui:{...p==null?void 0:p.ui,loadingProjects:!0,projectsError:null}}});const v=await Ye.getProjects({pageSize:100}),y=r(),f=(g=y.app)==null?void 0:g.claude;t("app",{...y.app,claude:{...f,data:{...f==null?void 0:f.data,projects:v.projects},ui:{...f==null?void 0:f.ui,loadingProjects:!1,projectsError:null,projectsInitialized:!0}}})}catch(w){console.error("[ProjectsLoader] API request failed:",{error:w,errorMessage:w instanceof Error?w.message:"Unknown error",timestamp:new Date().toISOString()}),pe.error(`Projects load failed: ${w instanceof Error?w.message:"Unknown error"}`,"ProjectsLoader");const p=r(),v=(b=p.app)==null?void 0:b.claude;t("app",{...p.app,claude:{...v,data:{...v==null?void 0:v.data,projects:[]},ui:{...v==null?void 0:v.ui,loadingProjects:!1,projectsError:w instanceof Error?w.message:"Failed to load projects",projectsInitialized:!0}}}),pe.error("Store updated with error state","ProjectsLoader")}},h=()=>{u()};return i.useEffect(()=>{e&&(d||n.current||(n.current=!0,u()))},[d,e]),{projects:o,loadingProjects:l,projectsError:c,projectsInitialized:d,loadProjects:u,refreshProjects:h}}function vc(){const[a,e]=i.useState(new Set),t=i.useCallback(r=>r?a.has(r):!1,[a]);return pa(r=>{var o,l,c,d,u,h,m,g,b,w,p,v,y,f,x;if(r.type==="batch-modified")return;const n=r.sessionId;if(n){if(r.type==="session-started"&&e(C=>{const j=new Set(C);return j.add(n),j}),r.type==="session-ended"&&e(C=>{const j=new Set(C);return j.delete(n),j}),r.type==="session-opened"){const C=((c=(l=(o=Y.get("app"))==null?void 0:o.claude)==null?void 0:l.ui)==null?void 0:c.activity)??{},j={...C,[n]:{...C[n],isOpened:!0}};Y.update("app",{claude:{ui:{activity:j}}}),e(S=>{const N=new Set(S);return N.add(n),N})}if(r.type==="session-closed"){const C=((h=(u=(d=Y.get("app"))==null?void 0:d.claude)==null?void 0:u.ui)==null?void 0:h.activity)??{},j=((m=C[n])==null?void 0:m.isOpened)===!0||((g=C[n])==null?void 0:g.isProcessing)===!0,S={...C,[n]:{...C[n],isOpened:!!j,isProcessing:!1}};Y.update("app",{claude:{ui:{activity:S}}}),j||e(N=>{const T=new Set(N);return T.delete(n),T}),console.log("[useSessionRunningStatus] Session closed, keeping as opened:",j)}if(r.type==="session-processing-started"){const C=((p=(w=(b=Y.get("app"))==null?void 0:b.claude)==null?void 0:w.ui)==null?void 0:p.activity)??{},j={...C,[n]:{...C[n],isProcessing:!0,isOpened:!0}};Y.update("app",{claude:{ui:{activity:j}}}),e(S=>{const N=new Set(S);return N.add(n),N})}if(r.type==="session-processing-stopped"){const C=((f=(y=(v=Y.get("app"))==null?void 0:v.claude)==null?void 0:y.ui)==null?void 0:f.activity)??{},j={...C,[n]:{...C[n],isProcessing:!1}};Y.update("app",{claude:{ui:{activity:j}}}),(((x=j[n])==null?void 0:x.isOpened)??!1)||e(N=>{const T=new Set(N);return T.delete(n),T})}}},r=>{console.error("[useSessionRunningStatus] SSE connection error:",r)}),{isSessionRunning:t,runningSessions:a}}const $s=768;function yc(){const[a,e]=i.useState(void 0);return i.useEffect(()=>{const t=window.matchMedia(`(max-width: ${$s-1}px)`),r=()=>{e(window.innerWidth<$s)};return t.addEventListener("change",r),e(window.innerWidth<$s),()=>t.removeEventListener("change",r)},[]),!!a}function D(...a){return ji(os(a))}const wc={default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},Sc=Jt("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive cursor-pointer",{variants:{variant:wc,size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",compact:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-1.2",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",smIcon:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 [&_svg:not([class*='size-'])]:size-3",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),ae=i.forwardRef(({className:a,variant:e,size:t,asChild:r=!1,...n},o)=>{const l=r?It:"button";return s.jsx(l,{"data-slot":"button",className:D(Sc({variant:e,size:t,className:a})),ref:o,...n})});ae.displayName="Button";const Be=i.forwardRef(({className:a,type:e,...t},r)=>s.jsx("input",{type:e,className:D("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",a),ref:r,...t}));Be.displayName="Input";const Fr=i.forwardRef(({className:a,orientation:e="horizontal",decorative:t=!0,...r},n)=>s.jsx(Ka,{ref:n,decorative:t,orientation:e,className:D("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...r}));Fr.displayName=Ka.displayName;const jc=Ja,Cc=ca,zr=i.forwardRef(({className:a,...e},t)=>s.jsx(Ns,{className:D("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...e,ref:t}));zr.displayName=Ns.displayName;const Nc=Jt("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Br=i.forwardRef(({side:a="right",className:e,children:t,...r},n)=>s.jsxs(Cc,{children:[s.jsx(zr,{}),s.jsxs(Kt,{ref:n,className:D(Nc({side:a}),e),...r,children:[s.jsxs(la,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[s.jsx(Qe,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]}),t]})]}));Br.displayName=Kt.displayName;const Hr=({className:a,...e})=>s.jsx("div",{className:D("flex flex-col space-y-2 text-center sm:text-left",a),...e});Hr.displayName="SheetHeader";const Wr=i.forwardRef(({className:a,...e},t)=>s.jsx(Es,{ref:t,className:D("text-lg font-semibold text-foreground",a),...e}));Wr.displayName=Es.displayName;const Gr=i.forwardRef(({className:a,...e},t)=>s.jsx(ks,{ref:t,className:D("text-sm text-muted-foreground",a),...e}));Gr.displayName=ks.displayName;function Ra({className:a,...e}){return s.jsx("div",{className:D("animate-pulse rounded-md bg-primary/10",a),...e})}const _e={xs:"w-3 h-3",sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},mp={deleteButton:"text-red-600 hover:text-red-700 hover:bg-red-50"},fp={input:"bg-green-500",process:"bg-blue-500",output:"bg-red-500",text:"bg-blue-500",select:"bg-purple-500",audio:"bg-green-500",default:"bg-gray-500"},gp={base:"absolute w-4 h-4 bg-background rounded-full border-2 border-border transform -translate-y-1/2 cursor-crosshair z-10",input:"node-handle node-handle-input -left-2 top-1/2",output:"node-handle node-handle-output -right-2 top-1/2",hover:"hover:border-blue-400 hover:bg-accent",active:"border-blue-400 bg-accent"},Ec={input:"w-full p-2 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background",textarea:"w-full p-3 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring resize-y bg-background",label:"text-xs font-medium text-foreground block mb-1",error:"text-destructive text-xs mt-1"},xp=.2,it={popover:1500,skipLink:1600,tooltip:1800,backdrop:1390,draggablePopover:1450,canvasArrows:1,canvasNodes:10,canvasResizeHandles:15,nodeTextarea:10,nodeAudioButton:20},ms=qo,fs=Ko,gs=Jo,Ht=i.forwardRef(({className:a,sideOffset:e=4,style:t,...r},n)=>s.jsx(Vo,{children:s.jsx(Qa,{ref:n,sideOffset:e,className:D("overflow-hidden rounded-md border bg-card px-3 py-1.5 text-xs text-card-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",a),style:{zIndex:it.tooltip,...t},...r})}));Ht.displayName=Qa.displayName;class kc{constructor(){X(this,"STORAGE_KEY","ui-store")}getStore(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to parse UI store from localStorage:",e),{}}}setStore(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save UI store to localStorage:",t)}}get(e){return this.getStore()[e]}set(e,t){const r=this.getStore();r[e]=t,this.setStore(r)}update(e,t){const r=this.getStore(),n=r[e]||{};r[e]={...n,...t},this.setStore(r)}remove(e){const t=this.getStore();delete t[e],this.setStore(t)}clear(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear UI store:",e)}}getAllData(){return this.getStore()}export(){return JSON.stringify(this.getStore(),null,2)}import(e){try{const t=JSON.parse(e);return this.setStore(t),!0}catch(t){return console.error("Failed to import UI store data:",t),!1}}}const Ys=new kc,Tc="16rem",Ac="18rem",Rc="3rem",Pc="b",Vr=i.createContext(null);function Dt(){const a=i.useContext(Vr);if(!a)throw new Error("useSidebar must be used within a SidebarProvider.");return a}const qr=i.forwardRef(({defaultOpen:a=!0,open:e,onOpenChange:t,className:r,style:n,children:o,...l},c)=>{const d=yc(),[u,h]=i.useState(!1),[m,g]=i.useState(()=>{const f=Ys.get("sidebar");return(f==null?void 0:f.isOpen)??a}),b=e??m,w=i.useCallback(f=>{const x=typeof f=="function"?f(b):f;t?t(x):g(x),Ys.update("sidebar",{isOpen:x})},[t,b]),p=i.useCallback(()=>d?h(f=>!f):w(f=>!f),[d,w,h]);i.useEffect(()=>{const f=x=>{x.key===Pc&&(x.metaKey||x.ctrlKey)&&(x.preventDefault(),p())};return window.addEventListener("keydown",f),()=>window.removeEventListener("keydown",f)},[p]);const v=b?"expanded":"collapsed",y=i.useMemo(()=>({state:v,open:b,setOpen:w,isMobile:d,openMobile:u,setOpenMobile:h,toggleSidebar:p}),[v,b,w,d,u,h,p]);return s.jsx(Vr.Provider,{value:y,children:s.jsx(ms,{delayDuration:0,children:s.jsx("div",{style:{"--sidebar-width":Tc,"--sidebar-width-icon":Rc,...n},className:D("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",r),ref:c,...l,children:o})})})});qr.displayName="SidebarProvider";const Kr=i.forwardRef(({side:a="left",variant:e="sidebar",collapsible:t="offcanvas",className:r,children:n,...o},l)=>{i.useEffect(()=>{Ys.update("sidebar",{side:a,variant:e})},[a,e]);const{isMobile:c,state:d,openMobile:u,setOpenMobile:h,toggleSidebar:m}=Dt();return t==="none"?s.jsx("div",{className:D("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",r),ref:l,...o,children:n}):c?s.jsx(jc,{open:u,onOpenChange:h,...o,children:s.jsxs(Br,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":Ac},side:a,children:[s.jsxs(Hr,{className:"sr-only",children:[s.jsx(Wr,{children:"Sidebar"}),s.jsx(Gr,{children:"Displays the mobile sidebar."})]}),s.jsx("div",{className:"flex h-full w-full flex-col",children:n})]})}):s.jsxs("div",{ref:l,className:"group peer hidden text-sidebar-foreground md:block","data-state":d,"data-collapsible":d==="collapsed"?t:"","data-variant":e,"data-side":a,children:[s.jsx("div",{className:D("relative bg-transparent transition-[width] duration-200 ease-linear",e==="floating"?"w-0":"w-[--sidebar-width]","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",e==="floating"||e==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),d==="expanded"&&t==="offcanvas"&&s.jsx("div",{className:"fixed inset-0 z-[55] bg-black/50",onClick:m}),s.jsx("div",{className:D("fixed inset-y-0 z-[60] hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",a==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",e==="floating"||e==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",r),...o,children:s.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:n})})]})});Kr.displayName="Sidebar";const Jr=i.forwardRef(({className:a,onClick:e,...t},r)=>{const{toggleSidebar:n}=Dt();return s.jsxs(ae,{ref:r,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:D("h-7 w-7",a),onClick:o=>{e==null||e(o),n()},...t,children:[s.jsx(Ci,{}),s.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});Jr.displayName="SidebarTrigger";const Ic=i.forwardRef(({className:a,...e},t)=>{const{toggleSidebar:r}=Dt();return s.jsx("button",{ref:t,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:r,title:"Toggle Sidebar",className:D("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",a),...e})});Ic.displayName="SidebarRail";const Qr=i.forwardRef(({className:a,...e},t)=>s.jsx("main",{ref:t,className:D("relative flex w-full flex-1 flex-col bg-background","md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow","peer-data-[collapsible=offcanvas]:ml-0 peer-data-[collapsible=offcanvas]:mr-0","peer-data-[variant=floating]:ml-0 peer-data-[variant=floating]:mr-0",a),...e}));Qr.displayName="SidebarInset";const Dc=i.forwardRef(({className:a,...e},t)=>s.jsx(Be,{ref:t,"data-sidebar":"input",className:D("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",a),...e}));Dc.displayName="SidebarInput";const Yr=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,"data-sidebar":"header",className:D("flex flex-col gap-2 p-2",a),...e}));Yr.displayName="SidebarHeader";const _c=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,"data-sidebar":"footer",className:D("flex flex-col gap-2 p-2",a),...e}));_c.displayName="SidebarFooter";const Lc=i.forwardRef(({className:a,...e},t)=>s.jsx(Fr,{ref:t,"data-sidebar":"separator",className:D("mx-2 w-auto bg-sidebar-border",a),...e}));Lc.displayName="SidebarSeparator";const Xr=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,"data-sidebar":"content",className:D("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",a),...e}));Xr.displayName="SidebarContent";const Mc=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,"data-sidebar":"group",className:D("relative flex w-full min-w-0 flex-col p-2",a),...e}));Mc.displayName="SidebarGroup";const Oc=i.forwardRef(({className:a,asChild:e=!1,...t},r)=>{const n=e?It:"div";return s.jsx(n,{ref:r,"data-sidebar":"group-label",className:D("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",a),...t})});Oc.displayName="SidebarGroupLabel";const $c=i.forwardRef(({className:a,asChild:e=!1,...t},r)=>{const n=e?It:"button";return s.jsx(n,{ref:r,"data-sidebar":"group-action",className:D("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",a),...t})});$c.displayName="SidebarGroupAction";const Uc=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,"data-sidebar":"group-content",className:D("w-full text-sm",a),...e}));Uc.displayName="SidebarGroupContent";const Zr=i.forwardRef(({className:a,...e},t)=>s.jsx("ul",{ref:t,"data-sidebar":"menu",className:D("flex w-full min-w-0 flex-col gap-1",a),...e}));Zr.displayName="SidebarMenu";const $t=i.forwardRef(({className:a,...e},t)=>s.jsx("li",{ref:t,"data-sidebar":"menu-item",className:D("group/menu-item relative",a),...e}));$t.displayName="SidebarMenuItem";const Fc=Jt("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),Ut=i.forwardRef(({asChild:a=!1,isActive:e=!1,variant:t="default",size:r="default",tooltip:n,className:o,...l},c)=>{const d=a?It:"button",{isMobile:u,state:h}=Dt(),m=s.jsx(d,{ref:c,"data-sidebar":"menu-button","data-size":r,"data-active":e,className:D(Fc({variant:t,size:r}),o),...l});return n?(typeof n=="string"&&(n={children:n}),s.jsxs(fs,{children:[s.jsx(gs,{asChild:!0,children:m}),s.jsx(Ht,{side:"right",align:"center",hidden:h!=="collapsed"||u,...n})]})):m});Ut.displayName="SidebarMenuButton";const zc=i.forwardRef(({className:a,asChild:e=!1,showOnHover:t=!1,...r},n)=>{const o=e?It:"button";return s.jsx(o,{ref:n,"data-sidebar":"menu-action",className:D("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",t&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",a),...r})});zc.displayName="SidebarMenuAction";const Bc=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,"data-sidebar":"menu-badge",className:D("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",a),...e}));Bc.displayName="SidebarMenuBadge";const Hc=i.forwardRef(({className:a,showIcon:e=!1,...t},r)=>{const n=i.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return s.jsxs("div",{ref:r,"data-sidebar":"menu-skeleton",className:D("flex h-8 items-center gap-2 rounded-md px-2",a),...t,children:[e&&s.jsx(Ra,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),s.jsx(Ra,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":n}})]})});Hc.displayName="SidebarMenuSkeleton";const Xs=i.forwardRef(({className:a,...e},t)=>s.jsx("ul",{ref:t,"data-sidebar":"menu-sub",className:D("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",a),...e}));Xs.displayName="SidebarMenuSub";const is=i.forwardRef(({...a},e)=>s.jsx("li",{ref:e,...a}));is.displayName="SidebarMenuSubItem";const cs=i.forwardRef(({asChild:a=!1,size:e="md",isActive:t,className:r,...n},o)=>{const l=a?It:"a";return s.jsx(l,{ref:o,"data-sidebar":"menu-sub-button","data-size":e,"data-active":t,className:D("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",e==="sm"&&"text-xs",e==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",r),...n})});cs.displayName="SidebarMenuSubButton";const Wc="audio-chunks-db",Gc=1,tt="chunks",Re="metadata";class Vc{constructor(){X(this,"dbPromise");X(this,"initializationPromise");this.dbPromise=this.initDB(),this.initializationPromise=this.waitForDB()}async waitForDB(){await this.dbPromise}async waitForInitialization(){await this.initializationPromise}async initDB(){return new Promise((e,t)=>{const r=indexedDB.open(Wc,Gc);r.onupgradeneeded=n=>{const o=n.target.result;if(o.objectStoreNames.contains(tt)||o.createObjectStore(tt),!o.objectStoreNames.contains(Re)){const l=o.createObjectStore(Re);l.createIndex("sessionName","sessionName",{unique:!1}),l.createIndex("createdAt","createdAt",{unique:!1}),l.createIndex("chunkNumber","chunkNumber",{unique:!1})}},r.onsuccess=n=>{e(n.target.result)},r.onerror=n=>{t(new Error(`IndexedDB error: ${n.target.error}`))}})}async saveChunk(e,t){var r;if(await this.waitForInitialization(),!e.blob)throw new Error("Cannot save chunk without blob data");try{const o=(await this.dbPromise).transaction([Re,tt],"readwrite"),l=o.objectStore(Re),c=o.objectStore(tt),d={id:e.id,chunkNumber:e.chunkNumber,startTime:e.startTime.toISOString(),endTime:(r=e.endTime)==null?void 0:r.toISOString(),duration:e.duration,size:e.size??e.blob.size,name:e.name,sessionName:t,transcription:e.transcription,transcriptionStatus:e.transcriptionStatus,transcriptionError:e.transcriptionError,createdAt:new Date().toISOString(),mimeType:e.blob.type};l.put(d,e.id),c.put(e.blob,e.id),await new Promise((u,h)=>{o.oncomplete=()=>u(),o.onerror=()=>h(new Error(`Transaction failed: ${o.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to save chunk:",n),n}}async loadChunksBySession(e){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Re,tt],"readonly"),n=r.objectStore(Re),o=r.objectStore(tt),c=n.index("sessionName").getAll(e),d=await new Promise((h,m)=>{c.onsuccess=()=>h(c.result),c.onerror=()=>m(new Error(`Failed to load metadata: ${c.error}`))});if(d.length===0)return[];const u=[];for(const h of d)try{const m=o.get(h.id),g=await new Promise((b,w)=>{m.onsuccess=()=>b(m.result),m.onerror=()=>w(new Error(`Failed to load blob: ${m.error}`))});if(g){const b={id:h.id,chunkNumber:h.chunkNumber,startTime:new Date(h.startTime),endTime:h.endTime?new Date(h.endTime):void 0,duration:h.duration,blob:g,size:h.size,name:h.name,transcription:h.transcription,transcriptionStatus:h.transcriptionStatus,transcriptionError:h.transcriptionError};u.push(b)}}catch(m){console.warn(`ðŸŽ¤ðŸ“¦ðŸ’¾ âš ï¸ Failed to load chunk ${h.id}:`,m)}return u.sort((h,m)=>h.chunkNumber-m.chunkNumber),u}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to load chunks:",t),t}}async updateChunkTranscription(e,t){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Re],"readwrite"),o=n.objectStore(Re),l=o.get(e),c=await new Promise((u,h)=>{l.onsuccess=()=>u(l.result),l.onerror=()=>h(new Error(`Failed to get metadata: ${l.error}`))});if(!c)throw new Error(`Chunk not found: ${e}`);const d={...c,transcription:t,transcriptionStatus:"completed"};o.put(d,e),await new Promise((u,h)=>{n.oncomplete=()=>u(),n.onerror=()=>h(new Error(`Transaction failed: ${n.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription:",r),r}}async updateChunkTranscriptionStatus(e,t,r){await this.waitForInitialization();try{const o=(await this.dbPromise).transaction([Re],"readwrite"),l=o.objectStore(Re),c=l.get(e),d=await new Promise((h,m)=>{c.onsuccess=()=>h(c.result),c.onerror=()=>m(new Error(`Failed to get metadata: ${c.error}`))});if(!d)throw new Error(`Chunk not found: ${e}`);const u={...d,transcriptionStatus:t,transcriptionError:r};l.put(u,e),await new Promise((h,m)=>{o.oncomplete=()=>h(),o.onerror=()=>m(new Error(`Transaction failed: ${o.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription status:",n),n}}async deleteChunk(e){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Re,tt],"readwrite"),n=r.objectStore(Re),o=r.objectStore(tt);n.delete(e),o.delete(e),await new Promise((l,c)=>{r.oncomplete=()=>l(),r.onerror=()=>c(new Error(`Transaction failed: ${r.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunk:",t),t}}async deleteChunksBySession(e){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Re,tt],"readwrite"),n=r.objectStore(Re),o=r.objectStore(tt),c=n.index("sessionName").getAll(e),d=await new Promise((u,h)=>{c.onsuccess=()=>u(c.result),c.onerror=()=>h(new Error(`Failed to load metadata: ${c.error}`))});for(const u of d)n.delete(u.id),o.delete(u.id);await new Promise((u,h)=>{r.oncomplete=()=>u(),r.onerror=()=>h(new Error(`Transaction failed: ${r.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunks by session:",t),t}}async getAllSessions(){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Re],"readonly").objectStore(Re).getAll(),o=await new Promise((c,d)=>{n.onsuccess=()=>c(n.result),n.onerror=()=>d(new Error(`Failed to load all metadata: ${n.error}`))});return[...new Set(o.map(c=>c.sessionName))].sort()}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get all sessions:",e),e}}async getStorageStats(){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Re],"readonly").objectStore(Re).getAll(),o=await new Promise((d,u)=>{n.onsuccess=()=>d(n.result),n.onerror=()=>u(new Error(`Failed to load all metadata: ${n.error}`))}),l=o.reduce((d,u)=>d+u.size,0),c=new Set(o.map(d=>d.sessionName)).size;return{totalChunks:o.length,totalSize:l,sessionCount:c}}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get storage stats:",e),e}}async clearAllData(){await this.waitForInitialization();try{const t=(await this.dbPromise).transaction([Re,tt],"readwrite"),r=t.objectStore(Re),n=t.objectStore(tt);r.clear(),n.clear(),await new Promise((o,l)=>{t.oncomplete=()=>o(),t.onerror=()=>l(new Error(`Transaction failed: ${t.error}`))})}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to clear all data:",e),e}}}const qe=new Vc,Us="vocabulary-lists",ct="default";class qc{getAllLists(){try{const e=localStorage.getItem(Us);return e?JSON.parse(e).map(r=>({...r,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt)})):[this.createDefaultList()]}catch(e){return console.error("Failed to load vocabulary lists:",e),[this.createDefaultList()]}}getListById(e){return this.getAllLists().find(r=>r.id===e)??null}createList(e){const t=this.getAllLists(),r={id:`list-${Date.now()}`,name:e,createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(r),this.saveLists(t),r}updateList(e,t){const r=this.getAllLists(),n=r.findIndex(o=>o.id===e);return n===-1?null:(r[n]={...r[n],...t,updatedAt:new Date},this.saveLists(r),r[n])}async deleteList(e){const t=this.getAllLists();if(t.length<=1)return console.warn("Cannot delete the last vocabulary list"),!1;if(e===ct){const n=t.find(o=>o.id===ct);if(n&&n.entryCount>0&&t.length===1)return console.warn("Cannot delete default list with data when it's the only list"),!1}const r=t.filter(n=>n.id!==e);return this.saveLists(r),localStorage.removeItem(`vocabulary-entries-${e}`),await qe.deleteChunksBySession(`vocabulary-session-${e}`),!0}getDefaultListId(){return this.getAllLists().find(r=>r.id===ct)||this.createDefaultList(),ct}updateEntryCount(e,t){this.updateList(e,{entryCount:t})}migrateOldData(){const e="vocabulary-entries",t=localStorage.getItem(e);if(!t)return!1;try{this.getAllLists().find(c=>c.id===ct)??(n=this.createDefaultList());const o=`vocabulary-entries-${ct}`;if(!localStorage.getItem(o)){localStorage.setItem(o,t);const c=JSON.parse(t);return this.updateEntryCount(ct,c.length),localStorage.removeItem(e),console.log("Migrated old vocabulary data to default list"),!0}return localStorage.removeItem(e),!1}catch(r){return console.error("Failed to migrate vocabulary data:",r),!1}}createDefaultList(){const e=localStorage.getItem(Us);let t=[];if(e)try{t=JSON.parse(e).map(l=>({...l,createdAt:new Date(l.createdAt),updatedAt:new Date(l.updatedAt)}));const o=t.find(l=>l.id===ct);if(o)return o}catch(n){console.error("Error parsing stored lists:",n),t=[]}const r={id:ct,name:"Default",createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(r),this.saveLists(t),r}saveLists(e){localStorage.setItem(Us,JSON.stringify(e))}}const Fs=new qc,Pa=Qo,Ia=Yo,Da=Xo,Kc="modulepreload",Jc=function(a){return"/"+a},_a={},Ue=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let l=function(u){return Promise.all(u.map(h=>Promise.resolve(h).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),d=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));n=l(t.map(u=>{if(u=Jc(u),u in _a)return;_a[u]=!0;const h=u.endsWith(".css"),m=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${m}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":Kc,h||(g.as="script"),g.crossOrigin="",g.href=u,d&&g.setAttribute("nonce",d),document.head.appendChild(g),h)return new Promise((b,w)=>{g.addEventListener("load",b),g.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(l){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=l,window.dispatchEvent(c),!c.defaultPrevented)throw l}return n.then(l=>{for(const c of l||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})},zs=i.lazy(()=>Ue(()=>import("./HomePage-DTWl9QNI.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(a=>({default:a.HomePage}))),Qc=i.lazy(()=>Ue(()=>import("./Chat-Dp3i_1he.js"),__vite__mapDeps([7,1,8,9,10,11,2,4,5,6])).then(a=>({default:a.Chat}))),Yc=i.lazy(()=>Ue(()=>import("./Settings-D66t-Zt2.js"),__vite__mapDeps([12,1,8,2,4,5,6])).then(a=>({default:a.Settings}))),La=i.lazy(()=>Ue(()=>import("./Demo-DubgCTCW.js"),__vite__mapDeps([13,1,14,5,2,4,6])).then(a=>({default:a.Demo}))),Ma=i.lazy(()=>Ue(()=>import("./Content-Dr9w-8mi.js"),__vite__mapDeps([15,1,8,2,4,5,6])).then(a=>({default:a.Content}))),Xc=i.lazy(()=>Ue(()=>import("./TablePage-BDHpCqyU.js"),__vite__mapDeps([16,1,17,18,4,5,6,2])).then(a=>({default:a.TablePage}))),Oa=i.lazy(()=>Ue(()=>import("./VocabularyPage-D0SsVEIi.js"),__vite__mapDeps([19,1,17,18,11,20,21,22,2,4,5,6])).then(a=>({default:a.VocabularyPage}))),Zc=i.lazy(()=>Ue(()=>import("./LiveTranscriptionPage-vaO1vryH.js"),__vite__mapDeps([23,1,11,2,4,5,6])).then(a=>({default:a.LiveTranscriptionPage}))),el=i.lazy(()=>Ue(()=>import("./AudioPanelDemo-nrp69AyU.js"),__vite__mapDeps([24,1,4,5,6,2])).then(a=>({default:a.AudioPanelDemo}))),tl=i.lazy(()=>Ue(()=>import("./ClaudePage-C7p8WBZC.js"),__vite__mapDeps([25,1,26,5,2,27,4,6])).then(a=>({default:a.ClaudePage}))),sl=i.lazy(()=>Ue(()=>import("./SessionDetailsPage-DMBlmNpD.js"),__vite__mapDeps([28,1,26,5,2,27,4,6])).then(a=>({default:a.SessionDetailsPage}))),Bs=i.lazy(()=>Ue(()=>import("./KanbanPage-iU9cyl7E.js"),__vite__mapDeps([29,1,30,14,5,2,31,32,4,6])).then(a=>({default:a.KanbanPage}))),al=i.lazy(()=>Ue(()=>import("./KanbanDataPage-BEtcc_ji.js"),__vite__mapDeps([33,1,34,14,5,2,4,6])).then(a=>({default:a.KanbanDataPage}))),rl=i.lazy(()=>Ue(()=>import("./index-BxmPIzXM.js"),__vite__mapDeps([35,1,2,4,5,6])).then(a=>({default:a.ActionTodoPage}))),nl=i.lazy(()=>Ue(()=>import("./GlobalStatePage-Cxc-xZ62.js"),__vite__mapDeps([36,1,34,4,5,2,6])).then(a=>({default:a.GlobalStatePage}))),ol=i.lazy(()=>Ue(()=>import("./GamePage-DKHMiDe7.js"),__vite__mapDeps([37,1,2,11,4,5,6])).then(a=>({default:a.GamePage}))),il=i.lazy(()=>Ue(()=>import("./NewHomeApp-RcLBckri.js"),__vite__mapDeps([38,1,6,4,5,2,39,40,41,42,22,20,11,32,43,44,45,46,47,48,49,50,51])).then(a=>({default:a.NewHomeApp})));function cl(){return s.jsx("div",{className:"page-loader flex items-center justify-center h-full",children:s.jsx("div",{className:"page-loader-spinner animate-pulse text-muted-foreground",children:"Loading..."})})}const xs=[{path:"/",element:zs,title:"Watcher",icon:Ta,label:"Home",showInSidebar:!0},{path:"/new-home",element:il,title:"New Home",icon:Ta,label:"New Home",showInSidebar:!0},{path:"/chat",element:Qc,title:"Chat with Ollama",icon:Ni,label:"Chat",showInSidebar:!0},{path:"/settings",element:Yc,title:"Settings",icon:bt,label:"Settings",showInSidebar:!0},{path:"/claude",element:tl,title:"Claude",icon:jr,label:"Claude",showInSidebar:!0},{path:"/claude/:sessionId",element:sl,title:"Claude",showInSidebar:!1},{path:"/state",element:nl,title:"Global State",icon:Ei,label:"Global State",showInSidebar:!0},{path:"/game",element:ol,title:"Multiplayer Games",icon:ki,label:"Games",showInSidebar:!0},{path:"/todo",element:Bs,title:"Todo",icon:Cr,label:"Todo",showInSidebar:!0,group:"collapsible",children:[{path:"/todo",element:Bs,title:"Todo",icon:Ti,label:"Overview",showInSidebar:!0},{path:"/todo/kanban",element:Bs,title:"Kanban Board",icon:Ai,label:"Kanban Board",showInSidebar:!0},{path:"/todo/kanban/data",element:al,title:"Kanban Data",icon:Ri,label:"Data",showInSidebar:!0},{path:"/todo/action",element:rl,title:"Action Todo",icon:Pi,label:"Action-Driven",showInSidebar:!0}]},{path:"/content",element:Ma,title:"Content",icon:Ii,label:"Content",showInSidebar:!0},{path:"/content/:contentId",element:Ma,title:"Content",showInSidebar:!1},{path:"/active-recording",element:zs,title:"Active Recording",icon:Nr,label:"Active Recording",showInSidebar:!0},{path:"/vocabulary",element:Oa,title:"Vocabulary",icon:Er,label:"Vocabulary",showInSidebar:!0,group:"collapsible-vocabulary"},{path:"/vocabulary/:listId",element:Oa,title:"Vocabulary",showInSidebar:!1},{path:"/live-transcription",element:Zc,title:"Live Transcription",icon:kr,label:"Live Transcription",showInSidebar:!0},{path:"/table",element:Xc,title:"Table Demo",icon:Tr,label:"Table Demo",showInSidebar:!0},{path:"/demo",element:La,title:"Demo",icon:Ar,label:"Demo",showInSidebar:!0},{path:"/demo/*",element:La,title:"Demo",showInSidebar:!1},{path:"/demo/audio-panel",element:el,title:"Audio Panel Demo",icon:Rr,label:"Audio Panel Demo",showInSidebar:!0},{path:"/realtime",element:zs,title:"Real-time Audio",showInSidebar:!1}];function ll(a){const e=xs.find(t=>t.children&&t.children.find(n=>n.path===a)?!0:t.path===a);if(e){if(e.children){const t=e.children.find(r=>r.path===a);if(t)return t.title}return e.title}for(const t of xs){if(a.startsWith(t.path.split("/:")[0]))return t.title;if(t.children){for(const r of t.children)if(a.startsWith(r.path.split("/:")[0]))return r.title}}return"Watcher"}function dl({logger:a,logs:e}){return s.jsx(i.Suspense,{fallback:s.jsx(cl,{}),children:s.jsx(Oo,{children:xs.map(t=>{const r=t.element,n=s.jsx(r,{logger:a,logs:e});return t.children?t.children.map(o=>{const l=o.element;return s.jsx(Ea,{path:o.path,element:s.jsx(l,{logger:a})},o.path)}):s.jsx(Ea,{path:t.path,element:n},t.path)})})})}function ul(){const{open:a,toggleSidebar:e}=Dt();return s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h2",{className:"text-lg font-semibold px-2",children:"Menu"}),a&&s.jsx(ae,{variant:"ghost",size:"icon",onClick:e,className:"h-7 w-7",children:s.jsx(Qt,{className:"w-4 h-4"})})]})}function hl(){const a=qa(),e=ia(),{isMobile:t,setOpen:r,setOpenMobile:n}=Dt(),{actions:o}=Or(),[l,c]=i.useState([]),[d,u]=i.useState(!1),[h,m]=i.useState(!1);i.useEffect(()=>{const p=Fs.getAllLists();c(p)},[e.pathname]),i.useEffect(()=>{e.pathname.startsWith("/vocabulary")&&u(!0)},[e.pathname]),i.useEffect(()=>{e.pathname.startsWith("/todo")&&m(!0)},[e.pathname]);const g=i.useCallback((p,v)=>{p.ctrlKey||p.metaKey||p.button===1||(p.preventDefault(),a(v),t?n(!1):r(!1))},[a,t,r,n]),b=i.useCallback(async()=>{try{o.info("Fetching logs from /logs endpoint...");const v=await(await fetch("/logs")).json();console.log("Logs response:",v),o.info("Logs endpoint response logged to console")}catch(p){o.error(`Failed to fetch logs: ${p}`),console.error("Failed to fetch logs:",p)}t?n(!1):r(!1)},[o,t,r,n]),w=i.useCallback(()=>{const p=prompt("Enter a name for the new vocabulary list:");if(p!=null&&p.trim()){const v=Fs.createList(p.trim());c(Fs.getAllLists()),a(`/vocabulary/${v.id}`),t?n(!1):r(!1)}},[a,t,r,n]);return s.jsxs(Zr,{children:[xs.filter(p=>p.showInSidebar).map(p=>p.group==="collapsible"&&p.children?s.jsx(Pa,{open:h,onOpenChange:m,className:"group/collapsible",children:s.jsxs($t,{children:[s.jsx(Ia,{asChild:!0,children:s.jsxs(Ut,{children:[p.icon&&s.jsx(p.icon,{className:"w-4 h-4"}),p.label,s.jsx(Et,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),s.jsx(Da,{children:s.jsx(Xs,{children:p.children.filter(v=>v.showInSidebar).map(v=>s.jsx(is,{children:s.jsx(cs,{asChild:!0,isActive:e.pathname===v.path,children:s.jsxs("a",{href:v.path,onClick:y=>g(y,v.path),children:[v.icon&&s.jsx(v.icon,{className:"w-4 h-4"}),v.label]})})},v.path))})})]})},p.path):p.group==="collapsible-vocabulary"?s.jsx(Pa,{open:d,onOpenChange:u,className:"group/collapsible",children:s.jsxs($t,{children:[s.jsx(Ia,{asChild:!0,children:s.jsxs(Ut,{children:[p.icon&&s.jsx(p.icon,{className:"w-4 h-4"}),p.label,s.jsx(Et,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),s.jsx(Da,{children:s.jsxs(Xs,{children:[l.map(v=>s.jsx(is,{children:s.jsx(cs,{asChild:!0,isActive:e.pathname===`/vocabulary/${v.id}`,children:s.jsxs("a",{href:`/vocabulary/${v.id}`,onClick:y=>g(y,`/vocabulary/${v.id}`),children:[v.name,v.entryCount>0&&s.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:v.entryCount})]})})},v.id)),s.jsx(is,{children:s.jsxs(cs,{onClick:w,children:[s.jsx(hs,{className:"w-4 h-4"}),"Create New List"]})})]})})]})},p.path):s.jsx($t,{children:s.jsx(Ut,{asChild:!0,isActive:e.pathname===p.path,children:s.jsxs("a",{href:p.path,onClick:v=>g(v,p.path),children:[p.icon&&s.jsx(p.icon,{className:"w-4 h-4"}),p.label]})})},p.path)),s.jsx($t,{children:s.jsxs(Ut,{onClick:b,children:[s.jsx(da,{className:"w-4 h-4"}),"Logs"]})})]})}function pl(){return s.jsxs(Kr,{variant:"floating",collapsible:"offcanvas",children:[s.jsx(Yr,{children:s.jsx(ul,{})}),s.jsx(Xr,{children:s.jsx(hl,{})})]})}class ma{constructor(e="http://localhost:3030/client-logs",t=5e3,r=!1){X(this,"baseUrl");X(this,"timeout");X(this,"sessionId");X(this,"shouldLogToConsole");this.baseUrl=e,this.timeout=t,this.shouldLogToConsole=r,this.sessionId=`todo-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async sendLogs(e,t,r){this.shouldLogToConsole&&console.log(`[${r||"client.log"}] ${e}`,t?JSON.stringify(t,null,2):"");try{const n={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),customLogFile:r,logs:{[e]:[`${e}`]},metadata:t},o=await this.fetchWithTimeout(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok)throw console.error("[ClientLogs] HTTP error:",o.status),new Error(`HTTP ${o.status}`);return await o.json()}catch(n){return console.error("[ClientLogs] Failed to send:",n),null}}sendBeacon(e,t){console.log("[ClientLogs] Sending beacon:",{message:e,metadata:t});try{const r={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),logs:{[e]:[`${e}`]},metadata:t};if(typeof navigator<"u"&&navigator.sendBeacon){const n=this.baseUrl.startsWith("http")?this.baseUrl:`${window.location.origin}${this.baseUrl}`,o=new Blob([JSON.stringify(r)],{type:"application/json"}),l=navigator.sendBeacon(n,o);return l?console.log("[ClientLogs] Beacon accepted"):console.warn("[ClientLogs] Beacon rejected (queue full?)"),l}else return console.log("[ClientLogs] sendBeacon not available, using fetch fallback"),fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),keepalive:!0}).catch(n=>{console.error("[ClientLogs] Fetch fallback failed:",n)}),!0}catch(r){return console.error("[ClientLogs] Failed to send beacon:",r),!1}}async clearLogs(e="client.log",t){if(t&&typeof window<"u"&&window.location.pathname!==t)return!1;try{const r=`${this.baseUrl}?customLogFile=${encodeURIComponent(e)}&confirm=true`,n=await this.fetchWithTimeout(r,{method:"DELETE",headers:{"Content-Type":"application/json"}});return n.ok?(await n.json()).success:(console.error("[ClientLogs] Failed to clear logs:",n.status),!1)}catch(r){return console.error("[ClientLogs] Failed to clear logs:",r),!1}}async fetchWithTimeout(e,t){const r=new AbortController,n=setTimeout(()=>r.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:r.signal});return clearTimeout(n),o}catch(o){throw clearTimeout(n),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}new ma;const ml={theme:"system",setTheme:()=>null},en=i.createContext(ml);function fl({children:a,defaultTheme:e="system",storageKey:t="vite-ui-theme",...r}){const[n,o]=i.useState(()=>localStorage.getItem(t)||e);i.useEffect(()=>{const c=window.document.documentElement;if(c.classList.remove("light","dark"),n==="system"){const d=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";c.classList.add(d);return}c.classList.add(n)},[n]);const l={theme:n,setTheme:c=>{localStorage.setItem(t,c),o(c)}};return s.jsx(en.Provider,{...r,value:l,children:a})}const gl=()=>{const a=i.useContext(en);if(a===void 0)throw new Error("useTheme must be used within a ThemeProvider");return a};function xl(){const{theme:a,setTheme:e}=gl(),t=()=>{e(a==="dark"?"light":"dark")},r=a==="dark"||a==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return s.jsx(ae,{onClick:t,variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","aria-label":r?"Switch to light mode":"Switch to dark mode",children:r?s.jsx(Di,{className:"h-5 w-5"}):s.jsx(_i,{className:"h-5 w-5"})})}const $e=Zo,He=ei,tn=si,Me=i.forwardRef(({className:a,align:e="center",sideOffset:t=4,style:r,...n},o)=>s.jsx(ti,{children:s.jsx(Ya,{ref:o,align:e,sideOffset:t,style:{zIndex:it.popover,...r},className:D("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",a),...n})}));Me.displayName=Ya.displayName;function bl(a){return"initialConfig"in a&&typeof a.children=="function"}function As(a){if(bl(a)){const{storageKey:b,initialConfig:w,children:p,prefix:v="watcher-"}=a,y=`${v}${b}`,[f,x]=i.useState(()=>{try{const N=localStorage.getItem(y);if(N)return JSON.parse(N)}catch(N){console.error(`Failed to load config from localStorage (${y}):`,N)}return w}),[C,j]=i.useState(!1);i.useEffect(()=>{try{localStorage.setItem(y,JSON.stringify(f))}catch(N){console.error(`Failed to save config to localStorage (${y}):`,N)}},[f,y]);const S=i.useMemo(()=>({buttonLabel:N,icon:T=s.jsx(bt,{className:"h-4 w-4"}),variant:W="ghost",size:L="icon",buttonClassName:P="",contentClassName:U="",align:$="end",side:k="bottom",title:O,children:E})=>s.jsxs($e,{open:C,onOpenChange:j,"data-test":"config-popover",children:[s.jsx(He,{asChild:!0,children:s.jsx(ae,{variant:W,size:L,className:`config-button ${P}`,title:O||"Configuration","data-test":"config-button",children:N?s.jsxs(s.Fragment,{children:[T,N&&s.jsx("span",{className:"ml-2","data-test":"config-button-label",children:N})]}):T})}),s.jsxs(Me,{className:`config-panel ${U}`,align:$,side:k,"data-test":"config-panel",onInteractOutside:_=>{_.target.closest(".config-panel")&&_.preventDefault()},onPointerDownOutside:_=>{_.target.closest(".config-panel")&&_.preventDefault()},children:[O&&s.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:s.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:O})}),s.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:E})]})]}),[C,j]);return s.jsx(s.Fragment,{children:p(f,x,S)})}const{children:e,buttonLabel:t,icon:r=s.jsx(bt,{className:"h-4 w-4"}),variant:n="ghost",size:o="icon",buttonClassName:l="",contentClassName:c="",align:d="end",side:u="bottom",title:h}=a,[m,g]=i.useState(!1);return s.jsxs($e,{open:m,onOpenChange:g,"data-test":"config-popover",children:[s.jsx(He,{asChild:!0,children:s.jsx(ae,{variant:n,size:o,className:`config-button ${l}`,title:h||"Configuration","data-test":"config-button",children:t?s.jsxs(s.Fragment,{children:[r,t&&s.jsx("span",{className:"ml-2","data-test":"config-button-label",children:t})]}):r})}),s.jsxs(Me,{className:`config-panel ${c}`,align:d,side:u,"data-test":"config-panel",onInteractOutside:b=>{b.target.closest(".config-panel")&&b.preventDefault()},onPointerDownOutside:b=>{b.target.closest(".config-panel")&&b.preventDefault()},children:[h&&s.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:s.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:h})}),s.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:e})]})]})}const dt=i.forwardRef(({className:a,...e},t)=>s.jsx(Xa,{ref:t,className:D("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",a),...e,children:s.jsx(ai,{className:D("flex items-center justify-center text-current"),children:s.jsx(We,{className:"h-4 w-4"})})}));dt.displayName=Xa.displayName;const vl=Jt("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),de=i.forwardRef(({className:a,...e},t)=>s.jsx(Za,{ref:t,className:D(vl(),a),...e}));de.displayName=Za.displayName;const yl=Jt("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}}),Ge=i.forwardRef(({className:a,variant:e,...t},r)=>s.jsx("div",{ref:r,className:D(yl({variant:e}),a),...t}));Ge.displayName="Badge";function Zs({value:a,options:e,onChange:t,placeholder:r="Search...",disabled:n=!1}){const[o,l]=i.useState(!1),[c,d]=i.useState(""),u=e.find(g=>g.value===a),h=e.filter(g=>g.label.toLowerCase().includes(c.toLowerCase())),m=g=>{t==null||t(g),l(!1),d("")};return u?s.jsxs($e,{open:o,onOpenChange:l,children:[s.jsx(He,{asChild:!0,children:s.jsx(Ge,{variant:u.variant||"secondary",className:D("cursor-pointer hover:opacity-80 transition-opacity",u.className,n&&"opacity-50 cursor-not-allowed"),onClick:g=>{g.stopPropagation(),n&&g.preventDefault()},children:u.label})}),s.jsx(Me,{className:"popover-content w-64 p-2",align:"start",children:s.jsxs("div",{className:"selector-container space-y-2",children:[s.jsx(Be,{placeholder:r,value:c,onChange:g=>d(g.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),s.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:h.length===0?s.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):h.map(g=>s.jsxs(ae,{variant:"ghost",className:D("option-item w-full justify-between h-8 px-2",g.value===a&&"bg-accent"),onClick:()=>m(g.value),children:[s.jsx(Ge,{variant:g.variant||"secondary",className:D("text-xs",g.className),children:g.label}),g.value===a&&s.jsx(We,{className:"check-icon h-4 w-4"})]},g.value))})]})})]}):null}const vt=ri,yt=ni,mt=i.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(er,{ref:r,className:D("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...t,children:[e,s.jsx(oi,{asChild:!0,children:s.jsx(Yt,{className:"h-4 w-4 opacity-50"})})]}));mt.displayName=er.displayName;const sn=i.forwardRef(({className:a,...e},t)=>s.jsx(ar,{ref:t,className:D("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(Pr,{className:"h-4 w-4"})}));sn.displayName=ar.displayName;const an=i.forwardRef(({className:a,...e},t)=>s.jsx(rr,{ref:t,className:D("flex cursor-default items-center justify-center py-1",a),...e,children:s.jsx(Yt,{className:"h-4 w-4"})}));an.displayName=rr.displayName;const ft=i.forwardRef(({className:a,children:e,position:t="popper",style:r,...n},o)=>s.jsx(ii,{children:s.jsxs(tr,{ref:o,style:{zIndex:it.tooltip,...r},className:D("relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:t,...n,children:[s.jsx(sn,{}),s.jsx(ci,{className:D("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),s.jsx(an,{})]})}));ft.displayName=tr.displayName;const wl=i.forwardRef(({className:a,...e},t)=>s.jsx(nr,{ref:t,className:D("px-2 py-1.5 text-sm font-semibold",a),...e}));wl.displayName=nr.displayName;const ye=i.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(sr,{ref:r,className:D("relative flex w-full cursor-default select-none items-start rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center mt-0.5",children:s.jsx(li,{children:s.jsx(We,{className:"h-4 w-4"})})}),s.jsx(di,{className:"flex-1",children:e})]}));ye.displayName=sr.displayName;const Sl=i.forwardRef(({className:a,...e},t)=>s.jsx(or,{ref:t,className:D("-mx-1 my-1 h-px bg-muted",a),...e}));Sl.displayName=or.displayName;const bs=Ja,bp=ui,jl=ca,rn=i.forwardRef(({className:a,style:e,...t},r)=>s.jsx(Ns,{ref:r,className:D("fixed inset-0 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),style:{zIndex:it.popover,...e},...t}));rn.displayName=Ns.displayName;const vs=i.forwardRef(({className:a,children:e,style:t,...r},n)=>s.jsxs(jl,{children:[s.jsx(rn,{}),s.jsxs(Kt,{ref:n,className:D("fixed left-[50%] top-[50%] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),style:{zIndex:it.popover,...t},...r,children:[e,s.jsxs(la,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[s.jsx(Qe,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));vs.displayName=Kt.displayName;const ys=({className:a,...e})=>s.jsx("div",{className:D("flex flex-col space-y-1.5 text-center sm:text-left",a),...e});ys.displayName="DialogHeader";const Cl=({className:a,...e})=>s.jsx("div",{className:D("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",a),...e});Cl.displayName="DialogFooter";const Wt=i.forwardRef(({className:a,...e},t)=>s.jsx(Es,{ref:t,className:D("text-lg font-semibold leading-none tracking-tight",a),...e}));Wt.displayName=Es.displayName;const nn=i.forwardRef(({className:a,...e},t)=>s.jsx(ks,{ref:t,className:D("text-sm text-muted-foreground",a),...e}));nn.displayName=ks.displayName;const Rs=i.forwardRef(({className:a,...e},t)=>s.jsx(Ve,{ref:t,className:D("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",a),...e}));Rs.displayName=Ve.displayName;const Nl=({children:a,value:e,onValueChange:t,...r})=>s.jsx(bs,{modal:!1,...r,children:s.jsx(ca,{children:s.jsxs(Kt,{className:D("overflow-hidden p-0 fixed left-[50%] top-[10%] translate-x-[-50%] translate-y-0 max-w-2xl w-full z-[60]","gap-4 border bg-background shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","sm:rounded-lg"),"data-test":"command-dialog",children:[s.jsx(Wt,{className:"sr-only",children:"Command Palette"}),s.jsx(Rs,{value:e,onValueChange:t,className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:a}),s.jsxs(la,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[s.jsx(Qe,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"Close"})]})]})})}),Ps=i.forwardRef(({className:a,...e},t)=>s.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[s.jsx(ua,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),s.jsx(Ve.Input,{ref:t,className:D("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",a),...e})]}));Ps.displayName=Ve.Input.displayName;const Is=i.forwardRef(({className:a,...e},t)=>s.jsx(Ve.List,{ref:t,className:D("max-h-[300px] overflow-y-auto overflow-x-hidden",a),...e}));Is.displayName=Ve.List.displayName;const Ds=i.forwardRef((a,e)=>s.jsx(Ve.Empty,{ref:e,className:"py-6 text-center text-sm",...a}));Ds.displayName=Ve.Empty.displayName;const Gt=i.forwardRef(({className:a,...e},t)=>s.jsx(Ve.Group,{ref:t,className:D("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",a),...e}));Gt.displayName=Ve.Group.displayName;const ea=i.forwardRef(({className:a,...e},t)=>s.jsx(Ve.Separator,{ref:t,className:D("-mx-1 h-px bg-border",a),...e}));ea.displayName=Ve.Separator.displayName;const kt=i.forwardRef(({className:a,...e},t)=>s.jsx(Ve.Item,{ref:t,className:D("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",a),...e}));kt.displayName=Ve.Item.displayName;const gt="__no_project__",El=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.projects)??[]},kl=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.loadingProjects)??!1},Tl=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.projectsError)??null},Al=a=>{var e,t,r;return(r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.selectedProjectPath};function on({variant:a="badge",className:e,multiSelect:t=!1,value:r,onChange:n}){const[o,l]=i.useState(!1),c=n!==void 0,d=Te(El),u=Te(kl),h=Te(Tl),m=Te(Al),g=c?r:m,b=t?Array.isArray(g)?g:g?[g]:[]:null,w=i.useCallback(f=>{var j,S,N;const x=d.find(T=>T.id===f||T.path===f),C=(x==null?void 0:x.path)??f;if(c)n(f);else{const T=Y.getState();Y.updateState({app:{...T.app,claude:{...(j=T.app)==null?void 0:j.claude,ui:{...(N=(S=T.app)==null?void 0:S.claude)==null?void 0:N.ui,selectedProjectPath:C}}}})}},[c,n,d]),p=i.useCallback(f=>{if(!t||!b)return;const x=d.find(S=>S.id===f||S.path===f),C=(x==null?void 0:x.path)??f,j=b.includes(C)?b.filter(S=>S!==C):[...b,C];c&&n(j)},[t,b,d,c,n]),v=i.useCallback(()=>{var f,x,C;if(c)n(t?[]:void 0);else{const j=Y.getState();Y.updateState({app:{...j.app,claude:{...(f=j.app)==null?void 0:f.claude,ui:{...(C=(x=j.app)==null?void 0:x.claude)==null?void 0:C.ui,selectedProjectPath:void 0}}}})}},[c,n,t]);if(i.useEffect(()=>{!c&&!u&&d.length>0&&!m&&w(d[0].path)},[c,u,d,m,w]),u)return s.jsx("div",{"data-test":"project-selector-loading",className:e,children:s.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading projects..."})});if(h)return s.jsx("div",{"data-test":"project-selector-error",className:e,children:s.jsx("span",{className:"text-sm text-destructive",children:h})});if(d.length===0)return s.jsx("div",{"data-test":"project-selector-empty",className:e,children:s.jsx("span",{className:"text-sm text-muted-foreground",children:"No projects found"})});const y=t?null:d.find(f=>f.path===g||f.id===g);if(t&&b){const f=d.filter(j=>b.includes(j.path)),x=b.includes(gt),C=b.length>0;return s.jsxs("div",{"data-test":"project-selector-multi",className:"project-selector-multi-wrapper",children:[s.jsxs($e,{open:o,onOpenChange:l,children:[s.jsx(He,{asChild:!0,children:s.jsxs(ae,{"data-test":"project-selector-trigger",variant:"outline",role:"combobox","aria-expanded":o,className:D("project-selector-trigger w-full justify-between",C&&"h-auto min-h-[40px] py-2"),disabled:u,children:[s.jsx("div",{className:"flex flex-wrap gap-1 flex-1 mr-2",children:C?s.jsxs(s.Fragment,{children:[x&&s.jsxs(Ge,{"data-test":"project-badge-none",variant:"secondary",className:"selected-project-badge gap-1",children:["No project",s.jsx(Qe,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:j=>{j.stopPropagation(),p(gt)}})]}),f.map(j=>s.jsxs(Ge,{"data-test":`project-badge-${j.id}`,variant:"secondary",className:"selected-project-badge gap-1",children:[j.name,s.jsx(Qe,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:S=>{S.stopPropagation(),p(j.path)}})]},j.id))]}):s.jsx("span",{className:"text-muted-foreground",children:"Select projects..."})}),s.jsx(Ir,{className:"h-4 w-4 shrink-0 opacity-50"})]})}),s.jsx(Me,{"data-test":"project-selector-content",className:"project-selector-content w-[400px] p-0",style:{zIndex:it.tooltip},children:s.jsxs(Rs,{children:[s.jsx(Ps,{"data-test":"project-selector-search",placeholder:"Search projects..."}),s.jsxs(Is,{className:"max-h-[300px]",children:[s.jsx(Ds,{children:"No projects found."}),s.jsxs(Gt,{children:[s.jsxs(kt,{"data-test":"project-selector-item-none",value:gt,onSelect:()=>p(gt),className:"project-selector-item cursor-pointer",children:[s.jsx(We,{className:D("mr-2 h-4 w-4 shrink-0",b.includes(gt)?"opacity-100":"opacity-0")}),s.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[s.jsx("span",{className:"project-name font-medium",children:"No project"}),s.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})]}),d.map(j=>s.jsxs(kt,{"data-test":`project-selector-item-${j.id}`,value:j.path,onSelect:()=>p(j.path),className:"project-selector-item cursor-pointer",children:[s.jsx(We,{className:D("mr-2 h-4 w-4 shrink-0",b.includes(j.path)?"opacity-100":"opacity-0")}),s.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[s.jsx("span",{className:"project-name font-medium",children:j.name}),s.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[j.sessionCount," sessions"]})]})]},j.id))]})]})]})})]}),C&&s.jsxs(ae,{"data-test":"project-selector-clear-all",variant:"outline",size:"sm",onClick:v,className:"clear-all-button w-full mt-2",children:[s.jsx(Qe,{className:"h-4 w-4 mr-2"}),"Clear all (",b.length,")"]})]})}if(a==="badge"&&!t){const f=typeof g=="string"?g:void 0,x=[{value:gt,label:"No project",variant:"secondary"},...d.map(C=>({value:C.path,label:`${C.name} (${C.sessionCount})`,variant:"secondary"}))];return s.jsx(Zs,{"data-test":"project-selector-badge",value:f??d[0].path,options:x,onChange:w,placeholder:"Search projects..."})}if(!t){const f=typeof g=="string"?g:void 0;return s.jsxs("div",{"data-test":"project-selector-select",className:"project-selector-wrapper flex gap-2",children:[s.jsxs(vt,{value:f??d[0].path,onValueChange:w,children:[s.jsx(mt,{"data-test":"project-selector-trigger",className:e,children:s.jsx(yt,{children:f===gt?"No project":y?`${y.name} (${y.sessionCount})`:"Select project"})}),s.jsxs(ft,{children:[s.jsx(ye,{"data-test":"project-selector-item-none",value:gt,children:s.jsxs("div",{className:"project-option flex flex-col items-start",children:[s.jsx("span",{className:"project-name font-medium",children:"No project"}),s.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})},gt),d.map(x=>s.jsx(ye,{"data-test":`project-selector-item-${x.id}`,value:x.path,children:s.jsxs("div",{className:"project-option flex flex-col items-start",children:[s.jsx("span",{className:"project-name font-medium",children:x.name}),s.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[x.sessionCount," sessions"]})]})},x.id))]})]}),f&&s.jsx(ae,{"data-test":"project-selector-clear",variant:"outline",size:"icon",onClick:v,className:"clear-project-button shrink-0",title:"Clear project filter",children:s.jsx(Qe,{className:"h-4 w-4"})})]})}return null}const fa=i.forwardRef(({label:a,onAction:e,configOptions:t=[],popoverContent:r,longPressDuration:n=400,showStaticGear:o=!1,showHint:l=!1,enableOnboarding:c=!1,tooltipText:d,ariaLabel:u,variant:h="secondary",size:m="default",disabled:g=!1,className:b,...w},p)=>{const[v,y]=i.useState(!1),[f,x]=i.useState(!1),[C,j]=i.useState(!1),[S,N]=i.useState(0),[T,W]=i.useState(c),L=i.useRef(null),P=i.useRef(null),U=i.useRef(0),$=i.useRef(!1),k=i.useRef(!1),O=i.useRef(null),E=i.useRef(null),_=i.useRef(null),B=i.useCallback(()=>{L.current&&(clearTimeout(L.current),L.current=null),P.current&&(clearInterval(P.current),P.current=null),y(!1),N(0)},[]);i.useEffect(()=>B,[B]),i.useEffect(()=>{g&&(B(),x(!1))},[g,B]),i.useEffect(()=>{if(!f||C)return;const Z=ce=>{var ue,ve;const ie=ce.target;(ue=_.current)!=null&&ue.contains(ie)||(ve=E.current)!=null&&ve.contains(ie)||x(!1)};return document.addEventListener("mousedown",Z),()=>{document.removeEventListener("mousedown",Z)}},[f,C]);const A=r!==void 0||t.length>0,I=i.useCallback(Z=>{if(g||!A)return;Z.type==="touchstart"&&Z.preventDefault(),y(!0),x(!1),U.current=Date.now(),$.current=!1,k.current=!0,T&&W(!1);const ce=100/(n/16);P.current=setInterval(()=>{N(ie=>{const ue=ie+ce;return ue>100?100:ue})},16),L.current=setTimeout(()=>{x(!0),N(0),P.current&&(clearInterval(P.current),P.current=null)},n)},[g,A,n,T]),R=i.useCallback(()=>{if(g)return;Date.now()-U.current<n&&!f?($.current=!0,e()):$.current=!0,B()},[g,n,f,e,B]),H=i.useCallback(()=>{g||(k.current||e(),k.current=!1)},[g,e]),V=i.useCallback(()=>{g||f||B()},[g,f,B]),K=i.useCallback(Z=>{Z.stopPropagation(),j(!0)},[]),F=i.useCallback(Z=>{Z.onClick(),j(!1),x(!1)},[]),Q=20,oe=2*Math.PI*Q,q=oe-S/100*oe,J=`${a} (Click) / Configure (Hold)`,re=d??J;return s.jsxs("div",{ref:p,className:D("relative inline-flex items-center gap-2",b),children:[s.jsx(ms,{children:s.jsxs(fs,{open:T?!0:f?!1:void 0,children:[s.jsx(gs,{asChild:!0,children:s.jsxs("div",{ref:_,className:"button-container relative inline-block",children:[v&&S>0&&s.jsx("svg",{className:"progress-ring absolute inset-0 pointer-events-none",width:"100%",height:"100%",style:{transform:"rotate(-90deg)"},children:s.jsx("circle",{className:"progress-ring-circle stroke-primary/30",strokeWidth:"3",fill:"transparent",r:Q,cx:"50%",cy:"50%",style:{strokeDasharray:oe,strokeDashoffset:q,transition:"stroke-dashoffset 16ms linear"}})}),s.jsxs(ae,{ref:O,variant:h,size:m,disabled:g,className:D("button-main relative transition-all",v&&"scale-95",l&&A&&"pr-8"),onPointerDown:I,onPointerUp:R,onPointerLeave:V,onClick:H,"aria-label":u||(typeof a=="string"?`Button: ${a}. Secondary action: long press for configuration`:"Button with configuration options"),"aria-pressed":v,"aria-expanded":C,"aria-haspopup":"menu",...w,children:[a,l&&A&&s.jsx(Li,{className:"hint-icon absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 opacity-30"})]}),f&&!o&&s.jsxs($e,{open:C,onOpenChange:Z=>{j(Z),Z||x(!1)},children:[s.jsx(He,{asChild:!0,children:s.jsx("button",{ref:E,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200","aria-label":"Open configuration",children:s.jsx(bt,{className:"h-4 w-4"})})}),s.jsx(Me,{align:"end",className:D("config-panel",r?"w-auto":"w-56"),children:r?s.jsx("div",{className:"config-panel-custom-content",children:r}):s.jsx("div",{className:"config-panel-content space-y-1",children:t.map((Z,ce)=>s.jsxs("button",{onClick:()=>F(Z),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[Z.icon&&s.jsx("span",{className:"shrink-0",children:Z.icon}),s.jsx("span",{children:Z.label})]},Z.value??ce))})})]}),f&&o&&s.jsx("button",{ref:E,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200",onClick:K,onTouchEnd:Z=>{Z.preventDefault(),K(Z)},"aria-label":"Open configuration",children:s.jsx(bt,{className:"h-4 w-4"})})]})}),s.jsx(Ht,{children:s.jsx("p",{children:T?"Try holding this button for advanced settings":re})})]})}),o&&A&&s.jsxs($e,{open:C,onOpenChange:Z=>{j(Z),Z||x(!1)},children:[s.jsx(He,{asChild:!0,children:s.jsx(ae,{variant:"ghost",size:"icon",className:"static-gear h-8 w-8 shrink-0",disabled:g,"aria-label":"Configure",tabIndex:0,children:s.jsx(bt,{className:"h-4 w-4"})})}),s.jsx(Me,{align:"end",className:D("config-panel",r?"w-auto":"w-56"),children:r?s.jsx("div",{className:"config-panel-custom-content",children:r}):s.jsx("div",{className:"config-panel-content space-y-1",children:t.map((Z,ce)=>s.jsxs("button",{onClick:()=>F(Z),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[Z.icon&&s.jsx("span",{className:"shrink-0",children:Z.icon}),s.jsx("span",{children:Z.label})]},Z.value??ce))})})]})]})});fa.displayName="ConfigurableButton";class Rl{constructor(){X(this,"isActive",!1);X(this,"callbacks",new Set);X(this,"tooltipOwnerId",null);X(this,"panelOwnerId",null)}subscribe(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}getState(){return this.isActive}toggle(){this.isActive=!this.isActive,this.notifySubscribers()}setState(e){this.isActive!==e&&(this.isActive=e,this.notifySubscribers())}activate(){this.setState(!0)}deactivate(){this.setState(!1)}claimTooltip(e){this.tooltipOwnerId=e}releaseTooltip(e){this.tooltipOwnerId===e&&(this.tooltipOwnerId=null)}canRenderTooltip(e){return this.tooltipOwnerId===null?e===null:this.tooltipOwnerId===e}claimPanel(e){this.panelOwnerId=e}releasePanel(e){this.panelOwnerId===e&&(this.panelOwnerId=null)}canRenderPanel(e){return this.panelOwnerId===null?e===null:this.panelOwnerId===e}notifySubscribers(){this.callbacks.forEach(e=>e(this.isActive))}}const Ke=new Rl,ga=({isVisible:a,onClose:e,title:t,children:r,className:n,initialPosition:o="bottom-right",triggerPosition:l,shouldCloseManually:c=!1,resizable:d=!1,initialSize:u,onSizeChange:h,headerActions:m,portalContainer:g})=>{const b=i.useMemo(()=>{if(!l||!u)return null;const V=window.innerWidth,K=window.innerHeight,F=u.width,Q=u.height;let oe=l.x,q=l.y;return oe+F>V&&(oe=V-F-16),oe<16&&(oe=16),q+Q>K&&(q=K-Q-16),q<16&&(q=16),{x:oe,y:q}},[l,u]),[w,p]=i.useState(null),[v,y]=i.useState(u||null),[f,x]=i.useState(!1),[C,j]=i.useState(!1),[S,N]=i.useState({x:0,y:0}),[T,W]=i.useState({x:0,y:0,width:0,height:0}),[L,P]=i.useState(!1),[U,$]=i.useState(!1),k=i.useRef(null),O=i.useRef(null),E=V=>{const K=V.target;if(!(K.tagName==="INPUT"||K.tagName==="TEXTAREA"||K.tagName==="SELECT"||K.tagName==="BUTTON"||K.closest("button")!==null||K.closest("input")!==null||K.closest("textarea")!==null||K.closest("select")!==null||K.classList.contains("resize-handle"))&&O.current){const Q=O.current.getBoundingClientRect(),oe=Q.left,q=Q.top;p({x:oe,y:q}),x(!0),N({x:V.clientX-oe,y:V.clientY-q})}},_=V=>{if(V.stopPropagation(),O.current){const K=O.current.getBoundingClientRect();j(!0),W({x:V.clientX,y:V.clientY,width:K.width,height:K.height})}},B=V=>{V.stopPropagation(),Ke.toggle();const K=Ke.getState();Je.success(`Element Inspector ${K?"activated":"deactivated"}`,{description:K?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};i.useEffect(()=>{if(c||!a||L||U){k.current&&(clearTimeout(k.current),k.current=null);return}return k.current=setTimeout(()=>{e()},2e3),()=>{k.current&&(clearTimeout(k.current),k.current=null)}},[a,L,U,e,c]);const A=()=>{$(!0)},I=()=>{$(!1)};i.useEffect(()=>{if(!f)return;const V=F=>{p({x:F.clientX-S.x,y:F.clientY-S.y})},K=()=>{x(!1)};return document.addEventListener("mousemove",V),document.addEventListener("mouseup",K),()=>{document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",K)}},[f,S]),i.useEffect(()=>{if(!C)return;const V=F=>{const Q=F.clientX-T.x,oe=F.clientY-T.y,q=Math.max(300,T.width+Q),J=Math.max(200,T.height+oe);y({width:q,height:J})},K=()=>{j(!1),v&&h&&h(v)};return document.addEventListener("mousemove",V),document.addEventListener("mouseup",K),()=>{document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",K)}},[C,T,v,h]),i.useEffect(()=>{if(!a||c)return;const V=K=>{K.key==="Escape"&&e()};return document.addEventListener("keydown",V),()=>{document.removeEventListener("keydown",V)}},[a,e,c]);const R=w||b;if(!a)return null;const H=s.jsxs("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:it.backdrop},"data-test":"draggable-popover-wrapper",children:[!c&&s.jsx("div",{className:"backdrop-click-outside fixed inset-0",style:{zIndex:it.backdrop,pointerEvents:"auto"},onClick:e,"aria-hidden":"true","data-test":"draggable-popover-backdrop"}),s.jsxs("div",{ref:O,className:os("fixed","w-80 bg-background text-foreground border border-border rounded-lg shadow-lg","flex flex-col",d&&"relative",n),style:{zIndex:it.draggablePopover,pointerEvents:"auto",top:R?`${R.y}px`:o==="bottom-right"?"1rem":typeof o=="object"?`${o.y}px`:"auto",right:!R&&o==="bottom-right"?"1rem":"auto",left:R?`${R.x}px`:typeof o=="object"?`${o.x}px`:"auto",bottom:"auto",cursor:C?"nwse-resize":"default",width:v?`${v.width}px`:void 0,height:v?`${v.height}px`:void 0,maxHeight:"calc(100vh - 2rem)"},onMouseEnter:A,onMouseLeave:I,"data-test":"draggable-popover-container",children:[s.jsxs("div",{className:"header px-3 py-2 border-b border-border flex justify-between items-center cursor-grab active:cursor-grabbing",onMouseDown:E,"data-test":"draggable-popover-header",children:[s.jsx("h3",{className:"title-text text-sm font-semibold select-none","data-test":"draggable-popover-title",children:t}),s.jsxs("div",{className:"action-buttons flex items-center gap-1","data-test":"draggable-popover-actions",children:[m,s.jsx("button",{className:"inspector-button p-1 rounded hover:bg-accent transition-colors",onClick:B,onMouseDown:V=>V.stopPropagation(),"aria-label":"Toggle Element Inspector",title:"Toggle Element Inspector","data-test":"draggable-popover-inspector-button",children:s.jsx(Mi,{size:14})}),s.jsx("button",{className:os("pin-button p-1 rounded hover:bg-accent transition-colors",L&&"bg-accent text-accent-foreground"),onClick:V=>{V.stopPropagation(),P(!L)},onMouseDown:V=>V.stopPropagation(),"aria-label":L?"Unpin popover":"Pin popover",title:L?"Unpin":"Pin","data-test":"draggable-popover-pin-button",children:s.jsx(Oi,{size:14,className:os(L&&"fill-current")})}),s.jsx("button",{className:"close-button p-1 rounded hover:bg-accent transition-colors",onClick:V=>{V.stopPropagation(),e()},onMouseDown:V=>V.stopPropagation(),"aria-label":"Close popover",title:"Close","data-test":"draggable-popover-close-button",children:s.jsx(Qe,{size:14})})]})]}),s.jsx("div",{className:"flex-1 min-h-0 overflow-hidden","data-test":"draggable-popover-content",children:r}),d&&s.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize",onMouseDown:_,style:{background:"linear-gradient(135deg, transparent 50%, currentColor 50%)",opacity:.3},title:"Drag to resize","data-test":"draggable-popover-resize-handle"})]})]});return $o.createPortal(H,g??document.body)};function _s(a){const e=/^(\s*)(\d+)\.\s*(.*)$/.exec(a);if(e)return{type:"numbered",indent:e[1],number:parseInt(e[2],10),fullMatch:e[0].replace(e[3],""),contentAfterPrefix:e[3]};const t=/^(\s*)-\s*(.*)$/.exec(a);return t?{type:"dash",indent:t[1],fullMatch:t[0].replace(t[2],""),contentAfterPrefix:t[2]}:{type:"none",indent:"",fullMatch:"",contentAfterPrefix:a}}function cn(a,e,t,r){const n=_s(a);if(n.type==="none")return{type:"newline",textToInsert:`
`};if(!(n.contentAfterPrefix.trim().length>0)){const d=n.fullMatch.length;if(n.type==="numbered"){const u=Pl(t,r,n.indent,n.number??1);return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:d,textAfterCursor:u}}return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:d}}if(e.split(`
`)[0].trim().length>0)return{type:"newline",textToInsert:`
`};if(n.type==="numbered"){const d=(n.number??0)+1,u=`
${n.indent}${d}. `,h=Il(t,r,n.indent,d);return{type:"continue",textToInsert:u,textAfterCursor:h}}return{type:"continue",textToInsert:`
${n.indent}- `}}function Pl(a,e,t,r){const o=a.substring(e).split(`
`);let l=!1,c=r-1;const d=[];for(let u=0;u<o.length;u++){const h=o[u],m=_s(h);if(m.type==="numbered"&&m.indent===t)if(c++,m.number!==c){const g=`${m.indent}${c}. ${m.contentAfterPrefix}`;d.push(g),l=!0}else d.push(h);else if(m.type==="numbered"&&m.indent.length<t.length){d.push(...o.slice(u));break}else if(h.trim()===""&&u<o.length-1)d.push(h);else if(m.type!=="numbered"){d.push(...o.slice(u));break}else d.push(h)}return l?d.join(`
`):void 0}function Il(a,e,t,r){const o=a.substring(e).split(`
`);let l=!1,c=r;const d=[];for(let u=0;u<o.length;u++){const h=o[u],m=_s(h);if(m.type==="numbered"&&m.indent===t)if(c++,m.number!==c){const g=`${m.indent}${c}. ${m.contentAfterPrefix}`;d.push(g),l=!0}else d.push(h);else if(m.type==="numbered"&&m.indent.length<t.length){d.push(...o.slice(u));break}else if(h.trim()===""&&u<o.length-1)d.push(h);else if(m.type!=="numbered"){d.push(...o.slice(u));break}else d.push(h)}return l?d.join(`
`):void 0}function xa(a,e){const t=a.lastIndexOf(`
`,e-1)+1,r=a.indexOf(`
`,e),n=r===-1?a.length:r;return{lineStart:t,lineEnd:n,currentLine:a.substring(t,n),textBeforeLine:a.substring(0,t),textAfterLine:a.substring(n)}}function ln(a,e){if(e===0)return{type:"default"};const{lineStart:t,currentLine:r}=xa(a,e),n=e-t,o=_s(r);if(o.type==="none")return{type:"default"};const l=o.fullMatch.length;if(n<=l&&n>0){const c=e-1;return{type:"delete-char",newText:a.substring(0,c)+a.substring(e),newCursorPos:c}}return{type:"default"}}function Dl(a,e,t){const{lineStart:r,textAfterLine:n}=xa(a,e),o=a.substring(r,e),l=a.substring(e,a.indexOf(`
`,e)===-1?a.length:a.indexOf(`
`,e)),c=cn(o,l+n,a,e);if(c.type==="remove-prefix"){const d=c.charsToRemoveBeforeCursor??0,u=e-d;return{selectionStart:u,selectionEnd:e,textToInsert:c.textToInsert,newCursorPosition:u+c.textToInsert.length}}return c.type==="continue"?{selectionStart:e,selectionEnd:t,textToInsert:c.textToInsert,newCursorPosition:e+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}:{selectionStart:e,selectionEnd:t,textToInsert:`
`,newCursorPosition:e+1}}function _l(a,e,t){const r=a.lastIndexOf(`
`,e-1)+1,n="  ",o=e+2;return{selectionStart:r,selectionEnd:r,textToInsert:n,newCursorPosition:o}}function Ll(a,e,t){const r=a.lastIndexOf(`
`,e-1)+1,n=a.indexOf(`
`,e),o=n===-1?a.length:n,l=a.substring(r,o);let c=0;for(let u=0;u<Math.min(2,l.length)&&l[u]===" ";u++)c++;if(c===0)return{selectionStart:e,selectionEnd:t,textToInsert:"",newCursorPosition:e};const d=Math.max(r,e-c);return{selectionStart:r,selectionEnd:r+c,textToInsert:"",newCursorPosition:d}}const dn=i.forwardRef(({value:a,defaultValue:e,onChange:t,placeholder:r,onClick:n,onMouseDown:o,onMouseUp:l,onPaste:c,onKeyDown:d,onKeyUp:u,onBlur:h,rows:m=4,className:g="",readOnly:b=!1,disabled:w=!1,...p},v)=>{const y=f=>{if(d==null||d(f),f.defaultPrevented)return;const x=f.currentTarget,{selectionStart:C,selectionEnd:j}=x,S=x.value;if(f.key==="Enter"){f.preventDefault();const N=Dl(S,C,j);if(x.focus(),x.setSelectionRange(N.selectionStart,N.selectionEnd),N.replaceTextAfterCursor!==void 0){const W=S.substring(0,N.selectionStart)+N.textToInsert+N.replaceTextAfterCursor;x.value=W,x.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:x,currentTarget:x})}else{if(!document.execCommand("insertText",!1,N.textToInsert)&&t){const W=S.substring(0,N.selectionStart)+N.textToInsert+S.substring(N.selectionEnd);x.value=W,t({target:x,currentTarget:x})}x.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}}if(f.key==="Backspace"){const N=ln(S,C);if(N.type==="delete-char"&&N.newText!==void 0&&N.newCursorPos!==void 0){f.preventDefault(),x.value=N.newText,x.setSelectionRange(N.newCursorPos,N.newCursorPos),t&&t({target:x,currentTarget:x});return}}if(f.key==="Tab"){f.preventDefault();const N=f.shiftKey?Ll(S,C,j):_l(S,C);if(x.focus(),x.setSelectionRange(N.selectionStart,N.selectionEnd),!document.execCommand("insertText",!1,N.textToInsert)&&t){const W=S.substring(0,N.selectionStart)+N.textToInsert+S.substring(N.selectionEnd);x.value=W,t({target:x,currentTarget:x})}x.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}};return s.jsx("textarea",{ref:v,value:a,defaultValue:e,onChange:t,onKeyDown:y,onKeyUp:u,placeholder:r,onClick:n,onMouseDown:o,onMouseUp:l,onPaste:c,onBlur:h,rows:m,className:D(Ec.textarea,g),readOnly:b,disabled:w,"data-test":p["data-test"],...p})});dn.displayName="RichTextarea";const Xt=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:D("rounded-xl border bg-card text-card-foreground shadow",a),...e}));Xt.displayName="Card";const ba=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:D("flex flex-col space-y-1.5 p-6",a),...e}));ba.displayName="CardHeader";const va=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:D("font-semibold leading-none tracking-tight",a),...e}));va.displayName="CardTitle";const Ml=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:D("text-sm text-muted-foreground",a),...e}));Ml.displayName="CardDescription";const Zt=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:D("p-6 pt-0",a),...e}));Zt.displayName="CardContent";const Ol=i.forwardRef(({className:a,...e},t)=>s.jsx("div",{ref:t,className:D("flex items-center p-6 pt-0",a),...e}));Ol.displayName="CardFooter";const $l=hi,Ul=pi,Fl=i.forwardRef(({className:a,inset:e,children:t,...r},n)=>s.jsxs(ur,{ref:n,className:D("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",a),...r,children:[t,s.jsx(Et,{className:"ml-auto"})]}));Fl.displayName=ur.displayName;const zl=i.forwardRef(({className:a,...e},t)=>s.jsx(hr,{ref:t,className:D("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",a),...e}));zl.displayName=hr.displayName;const un=i.forwardRef(({className:a,sideOffset:e=4,...t},r)=>s.jsx(mi,{children:s.jsx(ir,{ref:r,sideOffset:e,className:D("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",a),...t})}));un.displayName=ir.displayName;const hn=i.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(cr,{ref:r,className:D("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",a),...t}));hn.displayName=cr.displayName;const Bl=i.forwardRef(({className:a,children:e,checked:t,...r},n)=>s.jsxs(pr,{ref:n,className:D("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:t,...r,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(mr,{children:s.jsx(We,{className:"h-4 w-4"})})}),e]}));Bl.displayName=pr.displayName;const Hl=i.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(fr,{ref:r,className:D("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...t,children:[s.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:s.jsx(mr,{children:s.jsx($i,{className:"h-2 w-2 fill-current"})})}),e]}));Hl.displayName=fr.displayName;const Wl=i.forwardRef(({className:a,inset:e,...t},r)=>s.jsx(lr,{ref:r,className:D("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",a),...t}));Wl.displayName=lr.displayName;const Gl=i.forwardRef(({className:a,...e},t)=>s.jsx(dr,{ref:t,className:D("-mx-1 my-1 h-px bg-muted",a),...e}));Gl.displayName=dr.displayName;function Vl({onClick:a,label:e,icon:t,variant:r="default",size:n="sm",options:o=[],showDropdown:l=!0,className:c="",disabled:d=!1,"data-test":u}){return s.jsxs("div",{className:`split-button-group flex ${c}`,"data-test":u,children:[s.jsxs(ae,{onClick:a,variant:r,size:n,disabled:d,className:`${l&&o.length>0?"rounded-r-none":""}`,"data-test":u?`${u}-main-button`:void 0,children:[t&&s.jsx(t,{className:"w-3 h-3 mr-1","data-test":u?`${u}-icon`:void 0}),e]}),l&&o.length>0&&s.jsxs($l,{children:[s.jsx(Ul,{asChild:!0,children:s.jsx(ae,{variant:r,size:n,disabled:d,className:"border-l border-l-white/20 rounded-l-none px-1.5","data-test":u?`${u}-dropdown-trigger`:void 0,children:s.jsx(Yt,{className:"w-3 h-3","data-test":u?`${u}-dropdown-icon`:void 0})})}),s.jsx(un,{align:"start","data-test":u?`${u}-dropdown-menu`:void 0,children:o.map((h,m)=>s.jsx(hn,{onClick:h.onClick,"data-test":u?`${u}-option-${h.label.toLowerCase().replace(/\s+/g,"-")}`:void 0,children:h.label},m))})]})]})}async function $a(a,e){try{e==null||e.info(`Converting ${a.type} (${a.size} bytes) to WAV`);const t=new(window.AudioContext||window.webkitAudioContext),r=await a.arrayBuffer(),n=await t.decodeAudioData(r);e==null||e.debug(`Decoded: ${n.duration}s, ${n.sampleRate}Hz, ${n.numberOfChannels}ch`);const o=n.numberOfChannels,l=n.sampleRate,c=n.length,d=new Float32Array(c*o);for(let m=0;m<o;m++){const g=n.getChannelData(m);for(let b=0;b<c;b++)d[b*o+m]=g[b]}const u=ql(d,l,o),h=new Blob([u],{type:"audio/wav"});if(!h||h.size===0)throw new Error("Failed to create valid WAV blob");return e==null||e.info(`Conversion complete: ${h.size} bytes`),h}catch(t){throw e==null||e.error(`Audio conversion failed: ${t}`),t}}function ql(a,e,t){const r=new ArrayBuffer(44+a.length*2),n=new DataView(r),o=(c,d)=>{for(let u=0;u<d.length;u++)n.setUint8(c+u,d.charCodeAt(u))};o(0,"RIFF"),n.setUint32(4,36+a.length*2,!0),o(8,"WAVE"),o(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,t,!0),n.setUint32(24,e,!0),n.setUint32(28,e*t*2,!0),n.setUint16(32,t*2,!0),n.setUint16(34,16,!0),o(36,"data"),n.setUint32(40,a.length*2,!0);let l=44;return a.forEach(c=>{const d=Math.max(-1,Math.min(1,c));n.setInt16(l,d*32767,!0),l+=2}),r}function Kl(a){const e=/\.[a-zA-Z0-9]+$/.exec(a),t=e?e[0]:"",n=(t?a.slice(0,-t.length):a).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return n.length===0?a:n.map((l,c)=>c===0?l.toLowerCase():l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join("")+t}function Jl(a){const e=/\.[a-zA-Z0-9]+$/.exec(a),t=e?e[0]:"",n=(t?a.slice(0,-t.length):a).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return n.length===0?a:n.map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join("")+t}function Ql(a){const e=/\.[a-zA-Z0-9]+$/.exec(a),t=e?e[0]:"",n=(t?a.slice(0,-t.length):a).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return n.length===0?a:n.map(l=>l.toLowerCase()).join("_")+t}function vp(a,e){switch(e){case"camel":return Kl(a);case"pascal":return Jl(a);case"snake":return Ql(a);default:return a}}function Ua(a){return a.endsWith("...")?a.slice(0,-3).trim():a}function Yl(a){return a.trim().endsWith(".")?a.slice(0,-1).trim():a}let Xl="transcriptions";const Fa=["ggml-large-v3","ggml-large-v3-q5_0","ggml-large-v3-turbo","ggml-distil-large-v3","distil-large-v3.5"];let Zl="ggml-distil-large-v3";const pn={language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:Zl},ed=["CÃ¡c báº¡n","CÃ¡c báº¡n nhá»› Ä‘Äƒng kÃ½ kÃªnh Ä‘á»ƒ á»§ng há»™ kÃªnh cá»§a mÃ¬nh nhÃ©! Háº¹n gáº·p láº¡i cÃ¡c báº¡n trong nhá»¯ng video tiáº¿p theo!","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi, quÃ½ vá»‹","Hi, quÃ½ vá»‹. Xin chÃ o táº¥t cáº£ cÃ¡c báº¡n","HÃ£y subscribe cho kÃªnh","HÃ£y subscribe cho kÃªnh Ghiá»n MÃ¬ GÃµ Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","HÃ£y subscribe cho kÃªnh La La School Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","lalaschool","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Cáº¢M Æ N CÃC Báº N ÄÃƒ THEO DÃ•I VÃ€ ÄÄ‚NG KÃ KÃŠNH NHÃ‰!"];class es extends Error{constructor(e,t,r,n){super(e),this.code=t,this.statusCode=r,this.detail=n,this.name="PythonTranscribeApiError"}}class td extends es{constructor(e){super(e??"Bad Request - invalid file format or missing file","PTApi_BAD_REQUEST",400,e),this.name="PTApiBadRequestError"}}class sd extends es{constructor(e){super(e??"Payload Too Large - file exceeds size limit","PTApi_PAYLOAD_TOO_LARGE",413,e),this.name="PTApiPayloadTooLargeError"}}class ad extends es{constructor(e){super(e??"Internal Server Error - transcription service error","PTApi_INTERNAL_SERVER_ERROR",500,e),this.name="PTApiInternalServerError"}}class rd extends es{constructor(e,t){super(t??`HTTP error! status: ${e}`,"PTApi_HTTP_ERROR",e,t),this.name="PTApiHttpError"}}class mn extends es{constructor(){super("Transcription contains denied phrases.","PTApi_DENIED_PHRASES"),this.name="PTApiDeniedPhrasesError"}}class nd{constructor(){X(this,"baseUrl");this.baseUrl="http://192.168.2.185:9876"}async transcribeAudio(e,t={}){t={...pn,...t};const r=new FormData;t.language!==void 0&&r.append("language",t.language),t.translate!==void 0&&r.append("translate",t.translate.toString()),t.no_timestamps!==void 0&&r.append("no_timestamps",t.no_timestamps.toString()),t.no_prints!==void 0&&r.append("no_prints",t.no_prints.toString()),t.auto_detect_language!==void 0&&r.append("auto_detect_language",t.auto_detect_language.toString()),t.model!==void 0&&r.append("model",t.model),r.append("file",e);try{const n=await fetch(`${this.baseUrl}/${Xl}`,{method:"POST",body:r});if(!n.ok){const l=await n.json();switch(n.status){case 400:throw new td(l.detail);case 413:throw new sd(l.detail);case 500:throw new ad(l.detail);default:throw new rd(n.status,l.detail)}}const o=await n.json();if(o.transcription=Yl(o.transcription),ed.some(l=>o.transcription.toLowerCase().includes(l.toLowerCase())))throw new mn;return o}catch(n){throw n}}setBaseUrl(e){this.baseUrl=e}}const fn=new nd,ss={language:"auto",translate:!1,no_timestamps:!0,auto_detect_language:!0,word_level_timestamps:!1,split:!1},ws={DEFAULT:{silenceThreshold:-20,minSilenceDuration:40,holdTime:100,padding:-60,waveformSamples:1e3},TIGHT:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3},LOOSE:{silenceThreshold:-30,minSilenceDuration:100,holdTime:200,padding:0,waveformSamples:1e3},WORD_STREAMING:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3}};class od{constructor(e={}){X(this,"defaultConfig");const t=ws.DEFAULT;this.defaultConfig={silenceThreshold:e.silenceThreshold??t.silenceThreshold,minSilenceDuration:e.minSilenceDuration??t.minSilenceDuration,holdTime:e.holdTime??t.holdTime,padding:e.padding??t.padding,waveformSamples:e.waveformSamples??t.waveformSamples??1e3}}async analyzeAudio(e,t={}){const r={silenceThreshold:t.silenceThreshold??this.defaultConfig.silenceThreshold,minSilenceDuration:t.minSilenceDuration??this.defaultConfig.minSilenceDuration,holdTime:t.holdTime??this.defaultConfig.holdTime,padding:t.padding??this.defaultConfig.padding,waveformSamples:t.waveformSamples??this.defaultConfig.waveformSamples},n=this._generateWaveform(e,r.waveformSamples),o=this._normalize(n),l=this._toDbfs(o),c=this._detectActiveRegions(l,e.duration,r.silenceThreshold),d=this._mergeCloseRegions(c,r.holdTime),u=this._calculateSilences(d,e.duration*1e3),h=this._filterByDuration(u,r.minSilenceDuration),m=this._applySilencePadding(h,e.duration*1e3,r.padding);return this._getActiveRegions(m,e.duration)}_generateWaveform(e,t){const r=e.numberOfChannels,n=e.length,o=new Float32Array(n);for(let d=0;d<n;d++){let u=0;for(let h=0;h<r;h++)u+=e.getChannelData(h)[d];o[d]=u/r}const l=Math.max(1,Math.floor(n/t)),c=[];for(let d=0;d<t;d++){const u=d*l,h=Math.min(u+l,n);if(u<n&&h>u){let m=0;for(let b=u;b<h;b++)m+=Math.abs(o[b])**2;const g=Math.sqrt(m/(h-u));c.push(g)}else c.push(0)}return c}_normalize(e){const t=e.map(o=>isNaN(o)||!isFinite(o)?0:o),r=Math.max(...t),n=r>0?r:1;return t.map(o=>o/n)}_toDbfs(e){return e.map(r=>20*Math.log10(r+1e-10))}_detectActiveRegions(e,t,r){const n=e.map(d=>d>r),o=[];let l=!1,c=0;for(let d=0;d<n.length;d++)if(n[d]&&!l)c=d,l=!0;else if(!n[d]&&l){const u=d,h=c/e.length*t*1e3,m=u/e.length*t*1e3;o.push([h,m]),l=!1}if(l){const d=t*1e3,u=c/e.length*t*1e3;o.push([u,d])}return o}_mergeCloseRegions(e,t){if(e.length===0)return[];const r=[...e].sort((o,l)=>o[0]-l[0]),n=[r[0]];for(let o=1;o<r.length;o++){const[l,c]=r[o],d=n.length-1,[u,h]=n[d];l-h<=t?n[d]=[u,c]:n.push([l,c])}return n}_calculateSilences(e,t){const r=[];if(e.length===0)return[[0,t]];e[0][0]>0&&r.push([0,e[0][0]]);for(let o=0;o<e.length-1;o++){const l=e[o][1],c=e[o+1][0];c>l&&r.push([l,c])}const n=e[e.length-1][1];return n<t&&r.push([n,t]),r}_filterByDuration(e,t){return e.filter(([r,n])=>n-r>=t)}_applySilencePadding(e,t,r){if(r===0||e.length===0)return e;const n=[];for(let o=0;o<e.length;o++){const[l,c]=e[o];if(l===0){const u=Math.min(t,c+r);u>0&&n.push([0,u])}else if(o===e.length-1&&c===t){const d=Math.max(0,l-r),u=t;u>d&&n.push([d,u])}else{const d=Math.max(0,l-r),u=Math.min(t,c+r);u>d&&n.push([d,u])}}return n}_getActiveRegions(e,t){const r=[];if(e.length===0)return[[0,t]];const n=e.map(([l,c])=>[l/1e3,c/1e3]);n[0][0]>0&&r.push([0,n[0][0]]);for(let l=0;l<n.length-1;l++){const c=n[l][1],d=n[l+1][0];d>c&&r.push([c,d])}const o=n[n.length-1][1];return o<t&&r.push([o,t]),r}}class gn{constructor(e={}){X(this,"detector");this.detector=new od(e)}async chunkFile(e){const t=await e.arrayBuffer(),n=await new AudioContext().decodeAudioData(t);return this.chunkAudio(n)}async chunkAudio(e,t){return(await this.detector.analyzeAudio(e,t)).map((o,l)=>{const[c,d]=o,u=this._extractChunk(e,c,d);return{blob:this._audioBufferToWav(u),startTime:c,endTime:d,duration:d-c,index:l+1}})}_extractChunk(e,t,r){const n=e.sampleRate,o=Math.floor(t*n),c=Math.floor(r*n)-o,u=new AudioContext().createBuffer(e.numberOfChannels,c,n);for(let h=0;h<e.numberOfChannels;h++){const m=e.getChannelData(h),g=u.getChannelData(h);for(let b=0;b<c;b++)g[b]=m[o+b]}return u}_audioBufferToWav(e){const t=e.numberOfChannels,r=e.sampleRate,n=1,o=16,l=o/8,c=t*l,d=r*c,u=e.length*c,h=new ArrayBuffer(44+u),m=new DataView(h),g=(p,v)=>{for(let y=0;y<v.length;y++)m.setUint8(p+y,v.charCodeAt(y))};g(0,"RIFF"),m.setUint32(4,36+u,!0),g(8,"WAVE"),g(12,"fmt "),m.setUint32(16,16,!0),m.setUint16(20,n,!0),m.setUint16(22,t,!0),m.setUint32(24,r,!0),m.setUint32(28,d,!0),m.setUint16(32,c,!0),m.setUint16(34,o,!0),g(36,"data"),m.setUint32(40,u,!0);const b=[];for(let p=0;p<t;p++)b.push(e.getChannelData(p));let w=44;for(let p=0;p<e.length;p++)for(let v=0;v<t;v++){const y=Math.max(-1,Math.min(1,b[v][p])),f=y<0?y*32768:y*32767;m.setInt16(w,f,!0),w+=2}return new Blob([h],{type:"audio/wav"})}async getActiveRegions(e,t){return this.detector.analyzeAudio(e,t)}}const Ee="WebSocketTranscriptionService";class id{constructor(e){X(this,"ws",null);X(this,"wsUrl");X(this,"eventHandlers",{});X(this,"isConnected",!1);X(this,"reconnectAttempts",0);X(this,"maxReconnectAttempts",3);X(this,"reconnectDelay",1e3);this.wsUrl=e??"ws://192.168.2.185:9876/ws/transcribe"??"ws://localhost:9876/ws/transcribe"}setEventHandlers(e){this.eventHandlers=e}async connect(){return new Promise((e,t)=>{try{pe.info(`Connecting to WebSocket: ${this.wsUrl}`,Ee),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var r,n;pe.info("WebSocket connection opened",Ee),this.isConnected=!0,this.reconnectAttempts=0,(n=(r=this.eventHandlers).onConnectionOpen)==null||n.call(r),e()},this.ws.onmessage=r=>{this.handleMessage(r)},this.ws.onerror=r=>{var n,o;pe.error(`WebSocket error: ${r}`,Ee),(o=(n=this.eventHandlers).onConnectionError)==null||o.call(n,r),t(r)},this.ws.onclose=r=>{var n,o;pe.info(`WebSocket closed: code=${r.code}, reason=${r.reason}`,Ee),this.isConnected=!1,(o=(n=this.eventHandlers).onConnectionClose)==null||o.call(n,r.code,r.reason),this.reconnectAttempts<this.maxReconnectAttempts&&r.code!==1e3&&(this.reconnectAttempts++,pe.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,Ee),setTimeout(()=>{this.connect().catch(l=>{pe.error(`Reconnection failed: ${l}`,Ee)})},this.reconnectDelay))}}catch(r){pe.error(`Failed to create WebSocket connection: ${r}`,Ee),t(r)}})}handleMessage(e){var t,r,n,o,l,c,d,u,h,m;try{const g=JSON.parse(e.data);switch(g.type){case"progress":pe.info(`Progress: ${g.data.percentage}% - ${g.data.message}`,Ee),(r=(t=this.eventHandlers).onProgress)==null||r.call(t,g.data);break;case"word":pe.info(`Word: "${g.data.word}" [${g.data.start_time}s - ${g.data.end_time}s]`,Ee),(o=(n=this.eventHandlers).onWord)==null||o.call(n,g.data);break;case"segment":pe.info(`Segment ${g.data.segment}: "${g.data.transcription}"`,Ee),(c=(l=this.eventHandlers).onSegment)==null||c.call(l,g.data);break;case"complete":pe.info("Transcription complete",Ee),(u=(d=this.eventHandlers).onComplete)==null||u.call(d,g.data);break;case"error":pe.error(`Server error: ${g.data.message} (code: ${g.data.code})`,Ee),(m=(h=this.eventHandlers).onError)==null||m.call(h,g.data);break;default:pe.error(`Unknown message type: ${g.type}`,Ee)}}catch(g){pe.error(`Failed to parse message: ${g}`,Ee)}}async sendConfig(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"config",data:e};pe.info(`Sending config: ${JSON.stringify(e)}`,Ee),this.ws.send(JSON.stringify(t))}async sendAudioChunk(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"audio_chunk",data:{chunk:e}};pe.info(`Sending audio chunk (${e.length} chars)`,Ee),this.ws.send(JSON.stringify(t))}async sendAudioChunks(e){for(const t of e)await this.sendAudioChunk(t)}async startTranscription(){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const e={type:"start",data:{}};pe.info("Starting transcription",Ee),this.ws.send(JSON.stringify(e))}async transcribeAudioFile(e,t=ss){this.isConnected||await this.connect(),await this.sendConfig(t);const r=await e.arrayBuffer(),n=new Uint8Array(r);let o="";const l=n.byteLength;for(let d=0;d<l;d++)o+=String.fromCharCode(n[d]);const c=btoa(o);await this.sendAudioChunk(c),await this.startTranscription()}async transcribeAudioBlob(e,t=ss){const r=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFile(r,t)}async transcribeAudioFileWithChunking(e,t={...ss,word_level_timestamps:!0,split:!1},r=ws.WORD_STREAMING){this.isConnected||await this.connect(),pe.info("Starting client-side silence-based chunking",Ee);const o=await new gn(r).chunkFile(e);pe.info(`Audio split into ${o.length} chunks (client-side)`,Ee);for(let l=0;l<o.length;l++){const c=o[l];await this._transcribeChunk(c,l+1,o.length,t)}pe.info("All chunks processed",Ee)}async _transcribeChunk(e,t,r,n){return new Promise((o,l)=>{pe.info(`Processing chunk ${t}/${r} (${e.startTime.toFixed(2)}s - ${e.endTime.toFixed(2)}s)`,Ee);const c=this.eventHandlers.onComplete,d=this.eventHandlers.onError;this.eventHandlers.onComplete=u=>{if(this.eventHandlers.onComplete=c,this.eventHandlers.onError=d,c){const h={...u,metadata:{...u.metadata,chunk_index:t,chunk_start_time:e.startTime,chunk_end_time:e.endTime}};c(h)}pe.info(`Chunk ${t}/${r} transcription complete`,Ee),o()},this.eventHandlers.onError=u=>{this.eventHandlers.onComplete=c,this.eventHandlers.onError=d,d&&d(u),pe.error(`Chunk ${t}/${r} transcription failed: ${u.message}`,Ee),l(new Error(u.message))},this._sendChunkTranscriptionRequest(e,n).catch(l)})}async _sendChunkTranscriptionRequest(e,t){const r={...t,split:!1};await this.sendConfig(r);const n=await e.blob.arrayBuffer(),o=new Uint8Array(n);let l="";const c=o.byteLength;for(let u=0;u<c;u++)l+=String.fromCharCode(o[u]);const d=btoa(l);await this.sendAudioChunk(d),await this.startTranscription()}async transcribeAudioBlobWithChunking(e,t={...ss,word_level_timestamps:!0,split:!1},r=ws.WORD_STREAMING){const n=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFileWithChunking(n,t,r)}disconnect(){this.ws&&(pe.info("Disconnecting WebSocket",Ee),this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}setUrl(e){if(this.isConnected)throw pe.error("Cannot update URL while connected. Disconnect first.",Ee),new Error("Cannot update URL while connected");this.wsUrl=e,pe.info(`WebSocket URL updated to: ${this.wsUrl}`,Ee)}setMaxReconnectAttempts(e){this.maxReconnectAttempts=e}setReconnectDelay(e){this.reconnectDelay=e}}const cd=(a={})=>{const{onChunkCreated:e,onChunkUpdated:t,onChunkDeleted:r,onChunksLoaded:n,onError:o,sessionName:l="recording-session",enableAutoPersist:c=!0,enableAutoTranscription:d=!0,minChunkDuration:u=1e3,loadPersistedChunks:h=!0,skipLastSessionChunk:m=!1,transcribeOptions:g,useWebSocket:b=!1,onWordReceived:w,onTranscriptionProgress:p}=a,[v,y]=i.useState(!1),[f,x]=i.useState(!1),[C,j]=i.useState([]),[S,N]=i.useState(0),[T,W]=i.useState(null),L=i.useRef([]);i.useEffect(()=>{L.current=C},[C]);const P=i.useRef(null),U=i.useRef(null),$=i.useRef([]),k=i.useRef([]),O=i.useRef(null),E=i.useRef(null),_=i.useRef(null),B=i.useRef(0),A=i.useRef(!1),I=i.useRef(null),R=i.useRef(null),H=i.useCallback(G=>{const te=new Date().toISOString().slice(0,19).replace(/[:]/g,"-");return`${l}-chunk-${G.toString().padStart(3,"0")}-${te}`},[l]),V=i.useCallback(async()=>{if(h)try{const G=await qe.loadChunksBySession(l);if(G.length===0)return;j(G);const te=Math.max(...G.map(fe=>fe.chunkNumber),0);N(te),n==null||n(G)}catch(G){o==null||o(`Failed to load persisted chunks: ${G instanceof Error?G.message:"Unknown error"}`)}},[l,h,n]);i.useEffect(()=>(b&&!I.current&&(I.current=new id,I.current.setEventHandlers({onWord:G=>{const te=R.current;te&&(w==null||w(G,te))},onProgress:G=>{const te=R.current;te&&(p==null||p(G,te))},onComplete:G=>{const te=R.current;if(!te)return;const fe=Ua(G.transcription);j(Ce=>{const he=Ce.find(ge=>ge.id===te);if(!he)return Ce;const xe={...he,transcription:fe,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(xe)),Ce.map(ge=>ge.id===te?xe:ge)}),c&&qe.updateChunkTranscription(te,fe).catch(()=>{}),R.current=null},onError:G=>{const te=R.current;te&&(j(fe=>{const Ce=fe.find(xe=>xe.id===te);if(!Ce)return fe;const he={...Ce,transcriptionStatus:"failed",transcriptionError:G.message};return queueMicrotask(()=>t==null?void 0:t(he)),fe.map(xe=>xe.id===te?he:xe)}),c&&qe.updateChunkTranscriptionStatus(te,"failed",G.message).catch(()=>{})),o==null||o(G.message),R.current=null},onConnectionOpen:()=>{},onConnectionClose:()=>{},onConnectionError:()=>{o==null||o("WebSocket connection error")}})),()=>{I.current&&(I.current.disconnect(),I.current=null)}),[b,w,p,t,o,c]);const K=i.useCallback(async(G,te,fe,Ce)=>{const he=Ce||g,xe=L.current.find(be=>be.id===G);if(!xe||xe.transcriptionStatus==="processing"||xe.transcriptionStatus==="completed"&&xe.transcription)return;const ge={...xe,transcriptionStatus:"processing"};if(j(be=>(queueMicrotask(()=>t==null?void 0:t(ge)),be.map(je=>je.id===G?ge:je))),c)try{await qe.updateChunkTranscriptionStatus(G,"processing")}catch{}if(b&&I.current){try{R.current=G,I.current.connected||await I.current.connect(),await I.current.transcribeAudioBlob(te,{language:(he==null?void 0:he.language)||"auto",word_level_timestamps:!0,no_timestamps:(he==null?void 0:he.no_timestamps)??!0,translate:(he==null?void 0:he.translate)??!1,auto_detect_language:(he==null?void 0:he.auto_detect_language)??!0})}catch(be){const je=be instanceof Error?be.message:"WebSocket transcription error";if(j(we=>{const Se=we.find(M=>M.id===G);if(!Se)return we;const ke={...Se,transcriptionStatus:"failed",transcriptionError:je};return queueMicrotask(()=>t==null?void 0:t(ke)),we.map(M=>M.id===G?ke:M)}),c)try{await qe.updateChunkTranscriptionStatus(G,"failed",je)}catch{}o==null||o(`WebSocket transcription failed for ${fe}: ${je}`),R.current=null}return}try{const be=new File([te],`${fe}.wav`,{type:"audio/wav"}),je=await fn.transcribeAudio(be,he),we=Ua(je.transcription);if(j(Se=>{const ke=Se.find(z=>z.id===G);if(!ke)return Se;const M={...ke,transcription:we,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(M)),Se.map(z=>z.id===G?M:z)}),c)try{await qe.updateChunkTranscription(G,we)}catch{}}catch(be){if(be instanceof mn){if(console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Skipping chunk due to denied phrases:",fe),j(we=>we.filter(Se=>Se.id!==G)),c)try{await qe.deleteChunk(G)}catch(we){console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Failed to delete chunk from storage:",we)}r==null||r(G);return}const je=be instanceof Error?be.message:"Unknown transcription error";if(j(we=>{const Se=we.find(M=>M.id===G);if(!Se)return we;const ke={...Se,transcriptionStatus:"failed",transcriptionError:je};return queueMicrotask(()=>t==null?void 0:t(ke)),we.map(M=>M.id===G?ke:M)}),c)try{await qe.updateChunkTranscriptionStatus(G,"failed",je)}catch{}o==null||o(`Transcription failed for ${fe}: ${je}`)}},[c,t,b]),F=i.useCallback(async()=>{try{const G=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return U.current=G,!0}catch(G){const te=G instanceof Error?G.message:"Failed to access microphone";return W(te),o==null||o(te),!1}},[o]),Q=i.useCallback(async()=>{if(!(!P.current||f))try{const G=B.current+1,te={id:`segment-${crypto.randomUUID()}`,chunkNumber:G,startTime:new Date,name:H(G)};_.current=te,x(!0)}catch(G){const te=G instanceof Error?G.message:"Failed to start segment recording";W(te),o==null||o(te),x(!1)}},[f,H,o]),oe=i.useCallback(async()=>{if(!(!P.current||!f||!_.current))try{const G=_.current;_.current=null,x(!1),P.current.requestData(),await new Promise(je=>setTimeout(je,50));const te=new Date,fe=te.getTime()-G.startTime.getTime();if(fe<u){k.current=[];return}const Ce=P.current.mimeType||"audio/webm",he=[];O.current&&he.push(O.current),he.push(...k.current);const xe=new Blob(he,{type:Ce});let ge;try{ge=await $a(xe)}catch{ge=xe}const be={...G,endTime:te,duration:fe,blob:ge,size:ge.size,transcriptionStatus:d?"pending":void 0};if(j(je=>[...je,be]),L.current=[...L.current,be],B.current=G.chunkNumber,N(G.chunkNumber),k.current=[],c)try{await qe.saveChunk(be,l),e==null||e(be),d&&K(be.id,ge,be.name,g).catch(()=>{})}catch(je){const we=je instanceof Error?je.message:"Failed to save segment";W(we),o==null||o(we)}else e==null||e(be),d&&K(be.id,ge,be.name,g).catch(()=>{})}catch(G){const te=G instanceof Error?G.message:"Failed to stop segment";W(te),o==null||o(te),x(!1)}},[f,u,c,d,l,e,o,K]),q=i.useCallback(async()=>{if(!await F())return;const te=new Date().toISOString().slice(0,19).replace(/[:]/g,"-"),fe={id:`session-${crypto.randomUUID()}`,chunkNumber:0,startTime:new Date,name:`${l}-session-${te}`};E.current=fe,$.current=[],k.current=[],B.current=0,O.current=null,A.current=!1;const he=["audio/webm;codecs=opus","audio/webm;codecs=vorbis","audio/webm","audio/ogg;codecs=opus","audio/mp4;codecs=mp4a.40.2","audio/mp4"].find(ge=>MediaRecorder.isTypeSupported(ge))??"audio/webm",xe=new MediaRecorder(U.current,{mimeType:he});P.current=xe,xe.ondataavailable=ge=>{if(ge.data.size>0){if(!A.current){O.current=ge.data,A.current=!0,$.current.push(ge.data);return}$.current.push(ge.data),k.current.push(ge.data)}},xe.onstop=async()=>{if(!E.current)return;if(m){E.current=null;return}const ge=new Blob($.current,{type:he}),be=new Date,je=be.getTime()-E.current.startTime.getTime();let we;try{we=await $a(ge)}catch{we=ge}const Se={...E.current,endTime:be,duration:je,blob:we,size:we.size,transcriptionStatus:d?"pending":void 0};if(j(ke=>[...ke,Se]),L.current=[...L.current,Se],c)try{await qe.saveChunk(Se,l),e==null||e(Se),d&&K(Se.id,we,Se.name,g).catch(()=>{})}catch(ke){const M=ke instanceof Error?ke.message:"Failed to save session chunk";W(M),o==null||o(M)}else e==null||e(Se);E.current=null},xe.onerror=()=>{W("Session recording failed"),o==null||o("Session recording failed")},xe.start(100),y(!0),W(null)},[F,l,c,d,m,e,o,K]),J=i.useCallback(()=>{P.current&&P.current.state!=="inactive"&&P.current.stop(),y(!1),x(!1),U.current&&(U.current.getTracks().forEach(G=>{G.stop()}),U.current=null)},[]),re=i.useCallback(()=>{v&&J(),j([]),N(0),W(null),_.current=null,E.current=null},[v,J]),Z=i.useCallback(()=>{f&&(x(!1),_.current=null,k.current=[])},[f]),ce=i.useCallback(async G=>{if(j(te=>te.filter(fe=>fe.id!==G)),c)try{await qe.deleteChunk(G)}catch(te){o==null||o(`Failed to delete chunk from storage: ${te instanceof Error?te.message:"Unknown error"}`)}},[c]);i.useEffect(()=>{V()},[]),i.useEffect(()=>()=>{U.current&&U.current.getTracks().forEach(G=>G.stop())},[]);const ie=i.useCallback(async()=>{if(!(!b||!I.current)){I.current.disconnect(),await new Promise(G=>setTimeout(G,100));try{await I.current.connect()}catch{o==null||o("Failed to reconnect WebSocket")}}},[b,o]),ue={isRecording:v,isChunkRecording:f,chunks:C,currentChunkNumber:S,error:T},ve={startRecording:q,stopRecording:J,resetRecording:re},ne=i.useCallback(async(G,te)=>{if(j(fe=>{const Ce=fe.find(xe=>xe.id===G);if(!Ce)return fe;const he={...Ce,transcription:te,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(he)),fe.map(xe=>xe.id===G?he:xe)}),c)try{await qe.updateChunkTranscription(G,te)}catch{}},[c,t]);return{state:ue,actions:ve,startChunk:Q,stopChunk:oe,discardCurrentChunk:Z,deleteChunk:ce,transcribeChunk:K,updateChunkTranscription:ne,reconnectWebSocket:ie}};function ld({config:a,isRecording:e,isChunkRecording:t,callbacks:r,cumulativeActiveTimeRef:n,peakAudioLevelRef:o}){const l=i.useRef(null),c=i.useRef(!1),d=i.useRef(null),u=i.useRef({vadSilenceTimeout:a.vadSilenceTimeout,vadMaxChunkDuration:a.vadMaxChunkDuration,minActiveDuration:a.silenceDetectionConfig.minActiveDuration,activationThreshold:a.silenceDetectionConfig.activationThreshold}),h=i.useRef({isRecording:e,isChunkRecording:t});i.useEffect(()=>{u.current={vadSilenceTimeout:a.vadSilenceTimeout,vadMaxChunkDuration:a.vadMaxChunkDuration,minActiveDuration:a.silenceDetectionConfig.minActiveDuration,activationThreshold:a.silenceDetectionConfig.activationThreshold},h.current={isRecording:e,isChunkRecording:t}},[a.vadSilenceTimeout,a.vadMaxChunkDuration,a.silenceDetectionConfig.minActiveDuration,a.silenceDetectionConfig.activationThreshold,e,t]);const m=i.useCallback(()=>{l.current=null,c.current=!1,d.current=null,o.current=0},[o]),g=i.useCallback(async()=>{l.current=Date.now(),c.current=!0,d.current=null,o.current=0,await r.startChunk()},[r,o]),b=i.useCallback(async f=>{f?await r.stopChunk():r.discardCurrentChunk(),m()},[r,m]),w=i.useCallback(async()=>{h.current.isChunkRecording?(c.current=!0,d.current=null):await g()},[g]),p=i.useCallback(async()=>{if(!h.current.isChunkRecording||!c.current)return;const f=Date.now();if(d.current===null){d.current=f;return}if(f-d.current>=u.current.vadSilenceTimeout){const S=n.current>=u.current.minActiveDuration,T=o.current>=u.current.activationThreshold;await b(S&&T)}},[b,n,o]),v=i.useCallback(async()=>{if(!h.current.isChunkRecording||!l.current)return;Date.now()-l.current>=u.current.vadMaxChunkDuration&&(await r.stopChunk(),c.current&&!h.current.isChunkRecording?await g():m())},[r,g,m]);return{processVADAudio:i.useCallback((f,x)=>{if(!h.current.isRecording)return;const C=!f,j=C&&x,S=C&&!h.current.isChunkRecording&&!c.current;(j||S)&&w(),f&&p(),v()},[w,p,v]),resetVADState:m}}const ya={silenceThreshold:.47,minSilenceDuration:0,minActiveDuration:1500,activationThreshold:.67},zt={enableAutoTranscription:!0,minChunkDuration:500,silenceDetectionConfig:ya,autoStopOnSilence:!1,autoCreateChunks:!0,autoChunkCreationTime:1e3,skipLastSessionChunk:!0,transcribeOptions:pn,chunkingMode:"time",vadMaxChunkDuration:1e4,vadSilenceTimeout:1500,useWebSocket:!1},ls={default:{id:"custom-1759528805538",name:"Default (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:ya.activationThreshold},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},eng:{id:"custom-1759528805538",name:"Eng (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},vi:{name:"VN",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},ws:{name:"WS",description:"WebSocket real-time streaming",config:{silenceDetectionConfig:{minActiveDuration:800,activationThreshold:.67},useWebSocket:!0,chunkingMode:"time",autoCreateChunks:!0,autoChunkCreationTime:1e3,minChunkDuration:500,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,model:"ggml-distil-large-v3"}}}},xn="audio-panel-custom-presets";function bn(a,e){if(a===e)return!0;if(typeof a!="object"||typeof e!="object"||a===null||e===null)return!1;const t=Object.keys(a),r=Object.keys(e);if(t.length!==r.length)return!1;for(const n of t)if(!r.includes(n)||!bn(a[n],e[n]))return!1;return!0}function vn(a){const e={};return Object.keys(a).forEach(t=>{bn(a[t],zt[t])||(e[t]=a[t])}),e}function Ss(a){return{...zt,...a,silenceDetectionConfig:{...zt.silenceDetectionConfig,...a.silenceDetectionConfig??{}},transcribeOptions:{...zt.transcribeOptions,...a.transcribeOptions??{}}}}function ts(){try{const a=localStorage.getItem(xn);return a?JSON.parse(a).map(t=>({...t,createdAt:new Date(t.createdAt)})):[]}catch(a){return console.error("Failed to load custom presets:",a),[]}}function wa(a){try{localStorage.setItem(xn,JSON.stringify(a))}catch(e){console.error("Failed to save custom presets:",e)}}function dd(a,e,t){const r=vn(t),n={id:`custom-${Date.now()}`,name:a,description:e,config:r,createdAt:new Date},o=ts();return o.push(n),wa(o),n}function ud(a,e){const t=ts(),r=t.findIndex(l=>l.id===a);if(r===-1)return console.error(`Preset with id ${a} not found`),null;const n=vn(e),o={...t[r],config:n};return t[r]=o,wa(t),o}function hd(a){const t=ts().filter(r=>r.id!==a);wa(t)}function pd(a={}){const e=i.useMemo(()=>({...ya,...a}),[a]),[t,r]=Uo.useState({isSilent:!0,currentLevel:0,silenceThreshold:e.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}),n=i.useCallback(c=>{const d=Math.max(...c),u=Date.now();r(h=>{const m=u-h.lastStateChange,g=d<=h.silenceThreshold;let b=h.isSilent,w=h.silenceDuration,p=h.activeDuration,v=h.lastStateChange;return g?(w+=m,p=0,!h.isSilent&&w>=e.minSilenceDuration&&(b=!0,v=u)):(p+=m,w=0,h.isSilent&&p>=e.minActiveDuration&&(b=!1,v=u)),{isSilent:b,currentLevel:d,silenceThreshold:h.silenceThreshold,silenceDuration:w,activeDuration:p,lastStateChange:v}})},[e.minSilenceDuration,e.minActiveDuration,t.lastStateChange]),o=i.useCallback(c=>{const d=Math.max(0,Math.min(1,c));r(u=>({...u,silenceThreshold:d}))},[]),l=i.useCallback(()=>{r(c=>({isSilent:!0,currentLevel:0,silenceThreshold:c.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}))},[]);return{state:t,processAudioData:n,updateThreshold:o,reset:l}}const lt=i.forwardRef(({className:a,...e},t)=>s.jsxs(gr,{ref:t,className:D("relative flex w-full touch-none select-none items-center",a),...e,children:[s.jsx(fi,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:s.jsx(gi,{className:"absolute h-full bg-primary"})}),s.jsx(xi,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));lt.displayName=gr.displayName;const md=({audioData:a,silenceState:e,onThresholdChange:t,hideSilenceControls:r=!1,duration:n=0,className:o=""})=>{const l=i.useCallback(u=>{t==null||t(u[0])},[t]),c=u=>{const h=u/1e3,m=Math.floor(h/60),g=Math.floor(h%60),b=Math.floor(h%1*10);return`${m}:${g.toString().padStart(2,"0")}.${b}`};return s.jsx("div",{className:`silence-detection-visualizer ${o}`,children:s.jsxs("div",{className:"visualization-container relative flex flex-col p-2 bg-muted/50 rounded-lg",style:{height:"64px"},children:[s.jsxs("div",{className:"top-controls flex justify-between items-center gap-2 mb-1 z-20",children:[s.jsx("div",{className:"time-display flex items-center",children:s.jsx("span",{className:"text-[9px] font-medium text-foreground",children:c(n)})}),s.jsxs("div",{className:"right-controls flex items-center gap-2",children:[s.jsxs("div",{className:"status-display flex items-center gap-1",children:[s.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${e.isSilent?"bg-gray-400":"bg-green-500 animate-pulse"}`}),s.jsx("span",{className:"text-[9px] font-medium",children:e.isSilent?"Silent":"Active"}),s.jsx("span",{className:"text-[9px] text-muted-foreground",children:`${(e.currentLevel*100).toFixed(0)}%`})]}),!r&&s.jsxs("div",{className:"threshold-control flex-1 flex items-center gap-1.5",children:[s.jsx("label",{className:"text-[9px] font-medium shrink-0",children:`T: ${(e.silenceThreshold*100).toFixed(0)}%`}),s.jsx(lt,{min:0,max:1,step:.01,value:[e.silenceThreshold],onValueChange:l,className:"flex-1"})]})]})]}),s.jsxs("div",{className:"bars-container relative flex items-end justify-center flex-1",children:[s.jsx("div",{className:"threshold-line absolute left-0 right-0 border-t border-red-500 border-dashed z-10",style:{bottom:`${e.silenceThreshold*100}%`}}),s.jsx("div",{className:"visualization-bars flex items-end justify-center gap-0.5 h-full w-full max-w-2xl relative z-0",children:a.map((u,h)=>{const m=Math.max(u*100,2),g=u>e.silenceThreshold;return s.jsx("div",{className:"visualization-bar flex-1 max-w-2 rounded-t transition-all duration-75 ease-out",style:{height:`${m}%`,backgroundColor:g?`rgba(34, 197, 94, ${.3+u*.7})`:`rgba(156, 163, 175, ${.3+u*.7})`,minHeight:"2px"}},h)})})]})]})})},ut=i.forwardRef(({className:a,...e},t)=>s.jsx(xr,{className:D("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...e,ref:t,children:s.jsx(bi,{className:D("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));ut.displayName=xr.displayName;function yn({transcribeOptions:a,useWebSocket:e,onTranscribeOptionsChange:t,onUseWebSocketChange:r}){return s.jsxs("div",{className:"transcription-options-section space-y-1 pt-2 border-t border-border",children:[s.jsx("h3",{className:"text-[9px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcription Options"}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"use-websocket",className:"text-[9px] font-semibold",children:"Use WebSocket Transcription"}),s.jsx(ut,{id:"use-websocket",checked:e,onCheckedChange:r,className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:e?"Real-time streaming with progress updates and word-by-word results":"Standard HTTP API with complete results"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsx(de,{className:"text-[9px] font-semibold",children:"Language"}),s.jsxs(vt,{value:a.language??"auto",onValueChange:n=>t({...a,language:n}),children:[s.jsx(mt,{className:"h-7 text-[9px]",children:s.jsx(yt,{placeholder:"Select language"})}),s.jsxs(ft,{children:[s.jsx(ye,{value:"auto",children:"Auto Detect"}),s.jsx(ye,{value:"en",children:"English"}),s.jsx(ye,{value:"vi",children:"Vietnamese"}),s.jsx(ye,{value:"es",children:"Spanish"}),s.jsx(ye,{value:"fr",children:"French"}),s.jsx(ye,{value:"de",children:"German"}),s.jsx(ye,{value:"pt",children:"Portuguese"}),s.jsx(ye,{value:"ru",children:"Russian"}),s.jsx(ye,{value:"ja",children:"Japanese"}),s.jsx(ye,{value:"zh",children:"Chinese"}),s.jsx(ye,{value:"ko",children:"Korean"}),s.jsx(ye,{value:"it",children:"Italian"}),s.jsx(ye,{value:"nl",children:"Dutch"})]})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Transcription language"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsx(de,{className:"text-[9px] font-semibold",children:"Model"}),s.jsxs(vt,{value:a.model??Fa[0],onValueChange:n=>t({...a,model:n}),children:[s.jsx(mt,{className:"h-7 text-[9px]",children:s.jsx(yt,{placeholder:"Select model"})}),s.jsx(ft,{children:Fa.map(n=>s.jsx(ye,{value:n,children:n},n))})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Whisper model"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"translate-english",className:"text-[9px] font-semibold",children:"Translate"}),s.jsx(ut,{id:"translate-english",checked:a.translate??!1,onCheckedChange:n=>t({...a,translate:n}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Translate to English"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"auto-detect-lang",className:"text-[9px] font-semibold",children:"Auto-Detect"}),s.jsx(ut,{id:"auto-detect-lang",checked:a.auto_detect_language??!1,onCheckedChange:n=>t({...a,auto_detect_language:n}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto language detection"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"no-timestamps",className:"text-[9px] font-semibold",children:"No Timestamps"}),s.jsx(ut,{id:"no-timestamps",checked:a.no_timestamps!==!1,onCheckedChange:n=>t({...a,no_timestamps:n}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Remove timestamps"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"no-prints",className:"text-[9px] font-semibold",children:"Quiet Mode"}),s.jsx(ut,{id:"no-prints",checked:a.no_prints!==!1,onCheckedChange:n=>t({...a,no_prints:n}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Suppress verbose output"})]})]})]})}const as="audio-panel-selected-preset";function fd({config:a,onConfigChange:e}){const[t,r]=i.useState([]),[n,o]=i.useState(!1),[l,c]=i.useState(""),[d,u]=i.useState(!1),[h,m]=i.useState("");i.useEffect(()=>{const f=ts();r(f);let x=localStorage.getItem(as);x||(x="default",localStorage.setItem(as,x)),m(x)},[]);const g=f=>{m(f),localStorage.setItem(as,f);const x=ls[f];if(x){const j=Ss(x.config);e(j);return}const C=t.find(j=>j.id===f);if(C){const j=Ss(C.config);e(j)}},b=()=>{if(!l.trim()){alert("Please enter a preset name");return}const f=dd(l.trim(),"Custom configuration",a);r([...t,f]),c(""),o(!1)},w=()=>{c(""),o(!1)},p=f=>{const x=ud(f,a);x&&(r(t.map(C=>C.id===f?x:C)),u(!0))},v=f=>{hd(f),r(t.filter(x=>x.id!==f)),h===f&&(m(""),localStorage.removeItem(as))},y=()=>{const f=ls[h];if(f)return f.name;const x=t.find(C=>C.id===h);return(x==null?void 0:x.name)||""};return s.jsxs("div",{className:"config-view space-y-2 text-[10px]",children:[s.jsxs("div",{className:"preset-selector space-y-1",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{className:"text-[9px] font-semibold",children:"Configuration Preset"}),!n&&s.jsx(ae,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>o(!0),title:"Save current configuration as preset",children:s.jsx(Os,{className:"h-3 w-3"})})]}),n?s.jsxs("div",{className:"flex gap-1",children:[s.jsx(Be,{placeholder:"Enter preset name...",value:l,onChange:f=>c(f.target.value),onKeyDown:f=>{f.key==="Enter"&&b(),f.key==="Escape"&&w()},className:"h-8 text-[9px] flex-1",autoFocus:!0}),s.jsx(ae,{onClick:b,size:"sm",className:"h-8 px-2",title:"Save preset",children:s.jsx(Os,{className:"h-3 w-3"})}),s.jsx(ae,{onClick:w,size:"sm",variant:"ghost",className:"h-8 px-2",title:"Cancel",children:"âœ•"})]}):s.jsxs(vt,{value:h,onValueChange:g,open:d,onOpenChange:u,children:[s.jsx(mt,{className:"h-8 text-[9px]",children:s.jsx(yt,{placeholder:"Select a preset...",children:h&&s.jsx("span",{className:"font-medium",children:y()})})}),s.jsxs(ft,{children:[Object.entries(ls).map(([f,x])=>s.jsxs(ye,{value:f,children:[s.jsx("span",{className:"font-medium",children:x.name}),s.jsx("span",{className:"text-[8px] text-muted-foreground ml-2",children:x.description})]},f)),t.map(f=>s.jsx(ye,{value:f.id,children:s.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[s.jsxs("div",{className:"flex flex-col items-start flex-1 min-w-0",children:[s.jsx("span",{className:"font-medium",children:f.name}),s.jsx("span",{className:"text-[8px] text-muted-foreground",children:f.description})]}),s.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[s.jsx(ae,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:x=>{x.preventDefault(),x.stopPropagation(),p(f.id)},onClick:x=>{x.preventDefault(),x.stopPropagation()},title:"Update preset with current settings",children:s.jsx(Os,{className:"h-3 w-3 text-blue-500"})}),s.jsx(ae,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:x=>{x.preventDefault(),x.stopPropagation(),v(f.id)},onClick:x=>{x.preventDefault(),x.stopPropagation()},title:"Delete preset",children:s.jsx(Nt,{className:"h-3 w-3 text-red-500"})})]})]})},f.id))]})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:n?"Enter a name for the current configuration":"Quick apply preset configurations"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"auto-transcription",className:"text-[9px] font-semibold",children:"Auto-Transcribe"}),s.jsx(ut,{id:"auto-transcription",checked:a.enableAutoTranscription,onCheckedChange:f=>e({enableAutoTranscription:f}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-transcribe chunks"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Chunk: ",a.minChunkDuration,"ms"]}),s.jsx(lt,{min:500,max:5e3,step:500,value:[a.minChunkDuration],onValueChange:f=>e({minChunkDuration:f[0]}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min chunk duration"})]}),s.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[s.jsx(de,{className:"text-[9px] font-semibold",children:"Chunking Mode"}),s.jsxs(vt,{value:a.chunkingMode,onValueChange:f=>e({chunkingMode:f}),children:[s.jsx(mt,{className:"h-7 text-[9px]",children:s.jsx(yt,{})}),s.jsxs(ft,{children:[s.jsx(ye,{value:"time",children:"Time-based"}),s.jsx(ye,{value:"vad",children:"Voice Activity Detection (VAD)"}),s.jsx(ye,{value:"silence-based",children:"Silence-based Splitting"})]})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:a.chunkingMode==="time"?"Fixed interval chunking for predictable real-time updates":a.chunkingMode==="vad"?"Speech-driven chunking for natural boundaries and better accuracy":"VAD recording with post-processing silence-based splits for precise segmentation"})]}),a.chunkingMode==="time"&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"auto-create-chunks",className:"text-[9px] font-semibold",children:"Auto-Create"}),s.jsx(ut,{id:"auto-create-chunks",checked:a.autoCreateChunks,onCheckedChange:f=>e({autoCreateChunks:f}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-create chunks"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Auto-Time: ",a.autoChunkCreationTime,"ms"]}),s.jsx(lt,{min:500,max:5e3,step:500,value:[a.autoChunkCreationTime],onValueChange:f=>e({autoChunkCreationTime:f[0]}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-creation interval"})]})]}),(a.chunkingMode==="vad"||a.chunkingMode==="silence-based")&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Max Duration: ",a.vadMaxChunkDuration,"ms"]}),s.jsx(lt,{min:3e3,max:3e4,step:1e3,value:[a.vadMaxChunkDuration],onValueChange:f=>e({vadMaxChunkDuration:f[0]}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Max VAD chunk duration (safety ceiling)"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Silence Timeout: ",a.vadSilenceTimeout,"ms"]}),s.jsx(lt,{min:500,max:5e3,step:100,value:[a.vadSilenceTimeout],onValueChange:f=>e({vadSilenceTimeout:f[0]}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence duration to end chunk"})]})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"skip-last-chunk",className:"text-[9px] font-semibold",children:"Skip Last Chunk"}),s.jsx(ut,{id:"skip-last-chunk",checked:a.skipLastSessionChunk,onCheckedChange:f=>e({skipLastSessionChunk:f}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Skip last session chunk"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{htmlFor:"auto-stop-silence",className:"text-[9px] font-semibold",children:"Auto-Stop"}),s.jsx(ut,{id:"auto-stop-silence",checked:a.autoStopOnSilence,onCheckedChange:f=>e({autoStopOnSilence:f}),className:"scale-75"})]}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Stop on silence"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Silence: ",Math.round(a.silenceDetectionConfig.silenceThreshold*100),"%"]}),s.jsx(lt,{min:0,max:1,step:.01,value:[a.silenceDetectionConfig.silenceThreshold],onValueChange:f=>e({silenceDetectionConfig:{...a.silenceDetectionConfig,silenceThreshold:f[0]}}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence threshold"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Silent: ",a.silenceDetectionConfig.minSilenceDuration,"ms"]}),s.jsx(lt,{min:100,max:5e3,step:100,value:[a.silenceDetectionConfig.minSilenceDuration],onValueChange:f=>e({silenceDetectionConfig:{...a.silenceDetectionConfig,minSilenceDuration:f[0]}}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min silence duration"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Active: ",a.silenceDetectionConfig.minActiveDuration,"ms"]}),s.jsx(lt,{min:100,max:3e3,step:100,value:[a.silenceDetectionConfig.minActiveDuration],onValueChange:f=>e({silenceDetectionConfig:{...a.silenceDetectionConfig,minActiveDuration:f[0]}}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min active duration"})]}),s.jsxs("div",{className:"config-item space-y-0.5",children:[s.jsxs(de,{className:"text-[9px] font-semibold",children:["Activation: ",Math.round(a.silenceDetectionConfig.activationThreshold*100),"%"]}),s.jsx(lt,{min:0,max:1,step:.01,value:[a.silenceDetectionConfig.activationThreshold],onValueChange:f=>e({silenceDetectionConfig:{...a.silenceDetectionConfig,activationThreshold:f[0]}}),className:"w-full"}),s.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Peak level threshold (filters body noise)"})]})]}),s.jsx(yn,{transcribeOptions:a.transcribeOptions,useWebSocket:a.useWebSocket,onTranscribeOptionsChange:f=>e({transcribeOptions:f}),onUseWebSocketChange:f=>e({useWebSocket:f})})]})}function Mt({audioBlob:a,isPlaying:e=!0,className:t="",height:r=80,barWidth:n=2,barGap:o=1,barColor:l="#94a3b8",progressColor:c="#3b82f6"}){const d=i.useRef(null),[u,h]=i.useState([]),[m,g]=i.useState(!1),[b,w]=i.useState({width:0,height:0});return i.useEffect(()=>{if(!a)return;let p=!1;return g(!0),(async()=>{try{const y=await a.arrayBuffer(),f=new AudioContext,x=await f.decodeAudioData(y);if(p){await f.close();return}const C=x.getChannelData(0),j=100,S=Math.floor(C.length/j),N=[];for(let P=0;P<j;P++){const U=S*P;let $=0;for(let O=0;O<S;O++){const E=C[U+O];$+=E*E}const k=Math.sqrt($/S);N.push(k)}const T=Math.max(...N),W=1.5,L=N.map(P=>Math.min(1,P/T*W));p||h(L),await f.close()}catch(y){console.error("Failed to generate waveform:",y)}finally{p||g(!1)}})(),()=>{p=!0}},[a]),i.useEffect(()=>{if(m)return;const p=d.current;if(!p||u.length===0)return;const v=p.getContext("2d");if(!v)return;const y=p.width,f=p.height;if(y===0||f===0)return;const x=n+o,C=Math.min(u.length,Math.floor(y/x));v.clearRect(0,0,y,f);for(let j=0;j<C;j++){const S=Math.floor(j/C*u.length),N=u[S],T=Math.max(3,f*.05),W=f*.95,L=Math.max(T,N*W),P=j*x,U=(f-L)/2;v.fillStyle=e?c:l,v.fillRect(P,U,n,L)}},[u,e,n,o,l,c,b,m]),i.useEffect(()=>{const p=d.current;if(!p)return;const v=()=>{const y=p.parentElement;if(!y)return;const f=y.getBoundingClientRect();f.width>0&&f.height>0&&(p.width!==f.width||p.height!==f.height)&&(p.width=f.width,p.height=f.height,w({width:f.width,height:f.height}))};return v(),u.length>0&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{v()})}),window.addEventListener("resize",v),()=>{window.removeEventListener("resize",v)}},[r,u.length]),m?s.jsx("div",{className:`waveform-loading flex items-center justify-center ${t}`,style:{height:r},children:s.jsx("div",{className:"text-xs text-gray-400",children:"Generating waveform..."})}):s.jsx("div",{className:`waveform-container ${t}`,style:{height:r},children:s.jsx("canvas",{ref:d,className:"waveform-visualizer w-full h-full",style:{display:"block"}})})}function gd({chunk:a,isPlaying:e,onPlay:t,onPause:r,onDownload:n,onDelete:o,onTranscribe:l,variant:c="default",showTranscribe:d=!1}){const u=c==="error"?"hover:bg-red-100":"hover:bg-slate-200";return s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(ae,{size:"sm",variant:"ghost",onClick:e?r:t,className:`h-7 w-7 p-0 ${u}`,disabled:!a.blob,children:e?s.jsx(zi,{className:"w-3.5 h-3.5"}):s.jsx(Bi,{className:"w-3.5 h-3.5"})}),s.jsx(ae,{size:"sm",variant:"ghost",onClick:n,className:`h-7 w-7 p-0 ${u}`,disabled:!a.blob,children:s.jsx(Hi,{className:"w-3.5 h-3.5"})}),d&&l&&s.jsx(ae,{size:"sm",variant:"ghost",onClick:l,className:`h-7 w-7 p-0 text-blue-600 hover:text-blue-700 ${c==="error"?"hover:bg-red-100":"hover:bg-blue-50"}`,disabled:!a.blob||a.transcriptionStatus==="processing",title:"Transcribe audio",children:s.jsx(Ks,{className:"w-3.5 h-3.5"})}),o&&s.jsx(ae,{size:"sm",variant:"ghost",onClick:o,className:`h-7 w-7 p-0 text-red-600 hover:text-red-700 ${c==="error"?"hover:bg-red-100":"hover:bg-red-50"}`,children:s.jsx(Nt,{className:"w-3.5 h-3.5"})})]})}function xd({duration:a,variant:e="default"}){const t=n=>{const o=n/1e3,l=Math.floor(o),c=Math.floor((o-l)*100);return c>0?`${l}.${c.toString().padStart(2,"0")}s`:`${l}s`},r={completed:"text-xs text-green-600 border-green-600 bg-green-50",processing:"text-xs text-blue-600 border-blue-600 bg-blue-50",failed:"text-xs text-red-600 border-red-600 bg-red-50",pending:"text-xs text-gray-600 border-gray-400 bg-gray-50",default:"text-xs text-gray-600 border-gray-400 bg-gray-50"};return s.jsxs(Ge,{variant:"outline",className:r[e],children:[s.jsx(Dr,{className:"w-3 h-3 mr-1"}),t(a)]})}const bd={completed:{className:"bg-card",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(a,e,t)=>s.jsxs("div",{className:"flex-1 space-y-2",children:[t&&a.blob&&s.jsx(Mt,{audioBlob:a.blob,isPlaying:e,className:"w-full",height:60}),s.jsx("div",{className:"text-sm leading-relaxed font-medium",children:a.transcription})]})},processing:{className:"bg-blue-50 border-blue-200",badgeVariant:"processing",controlsVariant:void 0,showTranscribe:!1,renderContent:(a,e,t)=>s.jsxs("div",{className:"flex-1 space-y-2",children:[t&&a.blob&&s.jsx(Mt,{audioBlob:a.blob,isPlaying:e,className:"w-full",height:60}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ts,{className:"w-4 h-4 text-blue-600 animate-spin"}),s.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Transcribing audio..."})]})]})},failed:{className:"bg-red-50 border-red-200",badgeVariant:"failed",controlsVariant:"error",showTranscribe:!0,renderContent:(a,e,t)=>s.jsxs("div",{className:"flex-1 space-y-2",children:[t&&a.blob&&s.jsx(Mt,{audioBlob:a.blob,isPlaying:e,className:"w-full",height:60}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Fi,{className:"w-4 h-4 text-red-600"}),s.jsxs("span",{className:"text-sm font-medium text-red-700",children:["Transcription Failed",a.transcriptionError&&s.jsxs("span",{className:"text-xs font-normal ml-1",children:["(",a.transcriptionError,")"]})]})]})]})},pending:{className:"bg-gray-50 border-gray-200",badgeVariant:"pending",controlsVariant:void 0,showTranscribe:!1,renderContent:(a,e,t)=>s.jsxs("div",{className:"flex-1 space-y-2",children:[t&&a.blob&&s.jsx(Mt,{audioBlob:a.blob,isPlaying:e,className:"w-full",height:60}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Dr,{className:"w-4 h-4 text-gray-500"}),s.jsx("span",{className:"text-sm text-gray-600",children:"Waiting to transcribe..."})]})]})},none:{className:"bg-gray-50 border-gray-200",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(a,e,t)=>s.jsxs("div",{className:"flex-1 space-y-2",children:[t&&a.blob&&s.jsx(Mt,{audioBlob:a.blob,isPlaying:e,className:"w-full",height:60}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(da,{className:"w-4 h-4 text-gray-500"}),s.jsx("span",{className:"text-sm text-gray-600",children:"No transcription available"})]})]})}};function vd({chunk:a,isPlaying:e,showWaveform:t,onPlay:r,onPause:n,onDownload:o,onDelete:l,onTranscribe:c}){const u=a.transcription?"completed":a.transcriptionStatus==="processing"?"processing":a.transcriptionStatus==="failed"?"failed":a.transcriptionStatus==="pending"?"pending":"none",h=bd[u];return s.jsx(Xt,{className:"chunk-item shadow-sm",children:s.jsx(Zt,{className:"p-0",children:s.jsxs("div",{className:`flex flex-col border rounded-md py-2 px-2 gap-2 ${h.className}`,children:[h.renderContent(a,e,t),s.jsxs("div",{className:"flex justify-between items-center",children:[a.duration&&s.jsx(xd,{duration:a.duration,variant:h.badgeVariant}),s.jsx(gd,{chunk:a,isPlaying:e,onPlay:r,onPause:n,onDownload:o,onDelete:l,onTranscribe:c,variant:h.controlsVariant,showTranscribe:h.showTranscribe})]})]})})})}function wn({chunks:a,className:e="",onChunkDelete:t,onChunkTranscribe:r,onTranscribeAll:n,onClearAll:o}){const[l,c]=i.useState(null),[d,u]=i.useState(!1),[h,m]=i.useState({language:"vi",model:"ggml-distil-large-v3",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1}),[g,b]=i.useState(!1),w=i.useRef(null),p=i.useRef(null),v=i.useCallback(W=>{if(!W.blob)return;w.current&&(w.current.pause(),p.current&&URL.revokeObjectURL(p.current));const L=new Audio;w.current=L;const P=URL.createObjectURL(W.blob);p.current=P,L.src=P,L.onplay=()=>{c(W.id)},L.onpause=()=>{c(null)},L.onended=()=>{c(null),p.current&&(URL.revokeObjectURL(p.current),p.current=null)},L.onerror=U=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Audio playback error:",U),c(null),p.current&&(URL.revokeObjectURL(p.current),p.current=null)},L.play().catch(U=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Failed to play audio:",U),c(null)})},[]),y=i.useCallback(()=>{w.current&&w.current.pause()},[]),f=i.useCallback(W=>{if(!W.blob)return;const L=URL.createObjectURL(W.blob),P=document.createElement("a");P.href=L,P.download=`${W.name}.wav`,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(L)},[]),x=i.useCallback(async W=>{l===W&&w.current&&(w.current.pause(),c(null)),await(t==null?void 0:t(W))},[l,t]),C=i.useCallback(async W=>{await(r==null?void 0:r(W))},[r]),j=i.useCallback(async()=>{w.current&&(w.current.pause(),c(null)),await(o==null?void 0:o())},[o]),S=i.useCallback(async()=>{await(n==null?void 0:n(h))},[n,h]);i.useEffect(()=>()=>{w.current&&w.current.pause(),p.current&&URL.revokeObjectURL(p.current)},[]);const N=a.reduce((W,L)=>W+(L.duration??0),0),T=a.reduce((W,L)=>W+(L.size??0),0);return s.jsx("div",{className:`chunks-panel flex flex-col h-full ${e}`,children:s.jsxs(Xt,{className:"flex-1 flex flex-col",children:[s.jsxs(ba,{className:"pb-4",children:[s.jsxs(va,{className:"flex items-center justify-between",children:[s.jsx("span",{children:"Audio Chunks"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ge,{variant:"outline",children:a.length}),a.length>0&&n&&s.jsx(As,{variant:"ghost",size:"sm",buttonClassName:"h-6 w-6 p-0",contentClassName:"w-80",title:"Transcription Options",align:"end",storageKey:"chunks-panel-transcription-options",children:s.jsx("div",{className:"chunk-options-config",children:s.jsx(fa,{label:"Transcribe All",onAction:S,size:"sm",className:"w-full",tooltipText:"Click to transcribe all chunks, or click gear for options",popoverContent:s.jsx(yn,{transcribeOptions:h,useWebSocket:g,onTranscribeOptionsChange:m,onUseWebSocketChange:b})})})}),a.length>0&&s.jsx(ae,{variant:"ghost",size:"sm",onClick:()=>u(!d),className:`h-6 px-2 text-xs ${d?"bg-blue-50 text-blue-600":"text-gray-600"}`,title:d?"Hide waveforms":"Show waveforms",children:s.jsx(Ui,{className:"w-3 h-3"})}),a.length>0&&o&&s.jsx(ae,{variant:"ghost",size:"sm",onClick:j,className:"h-6 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",title:"Clear all chunks",children:s.jsx(Nt,{className:"w-3 h-3"})})]})]}),a.length>0&&s.jsxs("div",{className:"stats-summary text-xs text-gray-600 space-y-1",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Duration:"}),s.jsxs("span",{children:[Math.floor(N/1e3),"s"]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Size:"}),s.jsxs("span",{children:[(T/1024).toFixed(1)," KB"]})]})]})]}),s.jsx(Zt,{className:"flex-1 overflow-hidden p-4",children:a.length===0?s.jsxs("div",{className:"empty-state flex flex-col items-center justify-center h-full text-center text-gray-500",children:[s.jsx("div",{className:"mb-2",children:"ðŸŽ¤"}),s.jsx("p",{className:"text-sm",children:"No chunks recorded yet"}),s.jsx("p",{className:"text-xs mt-1",children:"Start recording and speak to create chunks"})]}):s.jsx("div",{className:"chunks-list overflow-y-auto h-full space-y-2 pr-2",children:a.slice().reverse().map(W=>s.jsx(vd,{chunk:W,isPlaying:l===W.id,showWaveform:d,onPlay:()=>v(W),onPause:y,onDownload:()=>f(W),onDelete:()=>void x(W.id),onTranscribe:r?()=>void C(W.id):void 0},W.id))})})]})})}const za="audio-panel-config";function yd({sessionName:a="audio-panel-session",enableAutoPersist:e=!0,loadPersistedChunks:t=!1,initialConfig:r,autoStart:n=!1,startTrigger:o,stopTrigger:l,onChunkCreated:c,onChunkUpdated:d,onChunkDeleted:u,onSilenceDetected:h,onClearAndRecord:m,onWordReceived:g,onTranscriptionProgress:b,onRecordingStateChange:w,className:p=""}){const[v,y]=i.useState(Array(32).fill(0)),[f,x]=i.useState(0),j=(()=>{try{const z=localStorage.getItem(za);if(z)return JSON.parse(z)}catch(z){console.error("Failed to load persisted config:",z)}return{}})(),[S,N]=i.useState(()=>{let z={...zt,...j},se=localStorage.getItem("audio-panel-selected-preset");if(se||(se="default",localStorage.setItem("audio-panel-selected-preset",se)),se)try{const le=ls[se];if(le)z=Ss(le.config);else{const Ie=ts().find(nt=>nt.id===se);Ie&&(z=Ss(Ie.config))}}catch(le){console.error("Failed to apply selected preset:",le)}return{...z,...r}}),T=i.useRef(null),W=i.useRef(null),L=i.useRef(null),P=i.useRef(null),U=i.useRef(!1),$=i.useCallback(z=>{console.error("ðŸŽ¤ Recorder error:",z)},[]),k=i.useRef(S.autoStopOnSilence),O=i.useRef(h),E=i.useRef(null),_=i.useRef(null),B=i.useRef(null),A=i.useRef(!1),I=i.useRef(!0),R=i.useRef(0),H=i.useRef(null),V=i.useRef(0),K=i.useRef(S.chunkingMode);i.useEffect(()=>{k.current=S.autoStopOnSilence},[S.autoStopOnSilence]),i.useEffect(()=>{K.current=S.chunkingMode},[S.chunkingMode]),i.useEffect(()=>{O.current=h},[h]);const{state:F,actions:Q,startChunk:oe,stopChunk:q,discardCurrentChunk:J,deleteChunk:re,transcribeChunk:Z,updateChunkTranscription:ce,reconnectWebSocket:ie}=cd({sessionName:a,enableAutoPersist:e,enableAutoTranscription:S.chunkingMode==="silence-based"?!1:S.enableAutoTranscription,minChunkDuration:S.minChunkDuration,loadPersistedChunks:t,skipLastSessionChunk:S.skipLastSessionChunk,transcribeOptions:S.transcribeOptions,useWebSocket:S.useWebSocket,onWordReceived:g,onTranscriptionProgress:b,onChunkCreated:c,onChunkUpdated:d,onChunkDeleted:u,onError:$}),ue=i.useCallback(z=>{if(z.length===0)return"";if(z.length===1)return z[0].trim();let se=z[0].trim();for(let le=1;le<z.length;le++){let me=z[le].trim();if(!me)continue;!/[.!?â€¦]$/.test(se)&&me.length>0&&(me=me.charAt(0).toLowerCase()+me.slice(1)),se=`${se} ${me}`}return se},[]),ve=i.useCallback(async z=>{if(S.chunkingMode==="silence-based"&&z.blob){console.log(`ðŸŽ¤ Processing chunk for silence-based splitting: ${z.name} (${z.blob.size} bytes)`);try{const se=await z.blob.arrayBuffer(),me=await new AudioContext().decodeAudioData(se);console.log(`ðŸŽ¤ AudioBuffer duration: ${me.duration.toFixed(2)}s`);const Ie=ws.DEFAULT;console.log("ðŸŽ¤ Using DEFAULT preset:",Ie);const De=await new gn(Ie).chunkAudio(me);if(console.log(`ðŸŽ¤ Silence-based split: ${De.length} chunks detected`),console.log("ðŸŽ¤ Chunk details:",De.map((Ne,Xe)=>({index:Xe+1,startTime:Ne.startTime.toFixed(2)+"s",endTime:Ne.endTime.toFixed(2)+"s",duration:Ne.duration.toFixed(2)+"s",blobSize:Ne.blob.size+" bytes"}))),S.enableAutoTranscription&&De.length>0){const Ne=[];for(let Ze=0;Ze<De.length;Ze++){const Tt=De[Ze],_t=`${z.name}-split-${Ze+1}`;console.log(`ðŸŽ¤ Transcribing split ${Ze+1}/${De.length}: ${_t} (${Tt.duration.toFixed(2)}s)`);try{const wt=new File([Tt.blob],`${_t}.wav`,{type:"audio/wav"}),Fe=await fn.transcribeAudio(wt,S.transcribeOptions);Ne.push(Fe.transcription),console.log(`ðŸŽ¤ Split ${Ze+1} transcribed: "${Fe.transcription}"`);const et=ue(Ne);et&&(await ce(z.id,et),console.log(`ðŸŽ¤ Progressive update: "${et}"`))}catch(wt){console.error(`ðŸŽ¤ Failed to transcribe split ${Ze+1}:`,wt),Ne.push(`[Error: ${wt instanceof Error?wt.message:"Unknown error"}]`)}}const Xe=ue(Ne);console.log(`ðŸŽ¤ Final transcription (${De.length} splits): "${Xe}"`)}}catch(se){console.error("ðŸŽ¤ Failed to split chunk by silence:",se)}}},[S,ce,ue]);i.useEffect(()=>{if(S.chunkingMode==="silence-based"&&F.chunks.length>0){const z=F.chunks[F.chunks.length-1];!z.transcription&&!z.transcriptionStatus&&ve(z)}},[F.chunks,S.chunkingMode,ve]);const ne=pd(S.silenceDetectionConfig),G=i.useRef(ne);i.useEffect(()=>{G.current=ne},[ne]);const te=ld({config:S.chunkingMode==="silence-based"?{...S,vadSilenceTimeout:100}:S,isRecording:F.isRecording,isChunkRecording:F.isChunkRecording,callbacks:{startChunk:oe,stopChunk:q,discardCurrentChunk:J},cumulativeActiveTimeRef:R,peakAudioLevelRef:V}),fe=i.useRef(te);i.useEffect(()=>{fe.current=te},[te]);const Ce=i.useCallback(z=>{var se;N(le=>{const me={...le,...z};return z.silenceDetectionConfig&&(me.silenceDetectionConfig={...le.silenceDetectionConfig,...z.silenceDetectionConfig}),z.transcribeOptions&&(me.transcribeOptions={...le.transcribeOptions,...z.transcribeOptions}),me}),((se=z.silenceDetectionConfig)==null?void 0:se.silenceThreshold)!==void 0&&ne.updateThreshold(z.silenceDetectionConfig.silenceThreshold)},[ne]);i.useEffect(()=>{try{localStorage.setItem(za,JSON.stringify(S))}catch(z){console.error("Failed to persist config:",z)}},[S]),i.useEffect(()=>{B.current=oe},[oe]),i.useEffect(()=>{E.current=q},[q]),i.useEffect(()=>{_.current=J},[J]);const he=i.useRef(F.isRecording);i.useEffect(()=>{he.current=F.isRecording},[F.isRecording]),i.useEffect(()=>{A.current=F.isChunkRecording},[F.isChunkRecording]);const xe=i.useCallback(async()=>{try{const z=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),se=new AudioContext,le=se.createAnalyser();le.fftSize=256,le.smoothingTimeConstant=.8,se.createMediaStreamSource(z).connect(le),T.current=se,W.current=le;const Ie=()=>{var _t,wt;if(!W.current)return;const nt=W.current.frequencyBinCount,De=new Uint8Array(nt);W.current.getByteFrequencyData(De);const Ne=32,Xe=Math.floor(nt/Ne),Ze=[];for(let Fe=0;Fe<Ne;Fe++){let et=0;for(let Ms=0;Ms<Xe;Ms++)et+=De[Fe*Xe+Ms];const _o=et/Xe/255;Ze.push(_o)}if(y(Ze),G.current.processAudioData(Ze),A.current){const Fe=G.current.state.currentLevel;Fe>V.current&&(V.current=Fe)}if(K.current==="vad"||K.current==="silence-based"){const Fe=G.current.state.isSilent,et=I.current;fe.current.processVADAudio(Fe,et)}const Tt=Date.now();if(A.current)if(H.current===null)H.current=Tt;else{const Fe=Tt-H.current;I.current||(R.current+=Fe),H.current=Tt}else H.current=null,R.current=0;if(k.current&&F.isChunkRecording){const Fe=G.current.state.isSilent,et=U.current;!et&&!Fe?U.current=!0:et&&Fe&&((_t=O.current)==null||_t.call(O),(wt=E.current)==null||wt.call(E),U.current=!1)}I.current=G.current.state.isSilent,L.current=requestAnimationFrame(Ie)};Ie()}catch(z){console.error("ðŸŽ¤ âŒ Failed to setup audio analysis:",z)}},[]),ge=i.useCallback(()=>{L.current&&(cancelAnimationFrame(L.current),L.current=null),T.current&&(T.current.close(),T.current=null),W.current=null,y(Array(32).fill(0)),G.current.reset(),fe.current.resetVADState(),U.current=!1},[]),be=i.useCallback(async()=>{if(F.isRecording){if(F.isChunkRecording){const z=R.current,se=S.silenceDetectionConfig.minActiveDuration,le=V.current,me=S.silenceDetectionConfig.activationThreshold;z>=se&&le>=me?await q():J()}Q.stopRecording(),he.current=!1,ge(),P.current=null}else await Q.startRecording(),he.current=!0,await xe(),P.current=Date.now(),S.chunkingMode==="time"&&(await oe(),U.current=!1)},[F.isRecording,F.isChunkRecording,Q,xe,ge,S.chunkingMode,S.silenceDetectionConfig.minActiveDuration,S.silenceDetectionConfig.activationThreshold,oe,q,J]);i.useEffect(()=>{if(!F.isRecording)return;const z=setInterval(()=>{P.current&&x(Date.now()-P.current)},100);return()=>clearInterval(z)},[F.isRecording]),i.useEffect(()=>()=>{ge()},[ge]);const je=i.useRef(null);i.useEffect(()=>{je.current!==null&&je.current!==F.isRecording&&(w==null||w(F.isRecording)),je.current=F.isRecording},[F.isRecording,w]),i.useEffect(()=>{n&&!F.isRecording&&be()},[n]),i.useEffect(()=>{o!==void 0&&o>0&&!F.isRecording&&be()},[o]),i.useEffect(()=>{l!==void 0&&l>0&&F.isRecording&&be()},[l]);const we=i.useCallback(async z=>{const se=F.chunks.find(le=>le.id===z);if(!(se!=null&&se.blob)){console.error("ðŸŽ¤ âŒ Cannot transcribe chunk: blob not found",z);return}await Z(z,se.blob,se.name,S.transcribeOptions)},[F.chunks,Z,S]),Se=i.useCallback(async z=>{await re(z),u==null||u(z)},[re,u]),ke=i.useCallback(async()=>{const z=F.chunks.map(se=>se.id);await Promise.all(z.map(se=>Se(se)))},[F.chunks,Se]),M=i.useCallback(async()=>{await ke(),m==null||m(),await ie(),F.isRecording||await be()},[ke,m,ie,F.isRecording,be]);return i.useEffect(()=>{if(!F.isRecording||S.chunkingMode!=="time")return;const z=setInterval(()=>{var nt,De;const se=R.current,le=S.silenceDetectionConfig.minActiveDuration,me=V.current,Ie=S.silenceDetectionConfig.activationThreshold;if(se<le||me<Ie){(nt=_.current)==null||nt.call(_),setTimeout(()=>{var Ne;(Ne=B.current)==null||Ne.call(B),R.current=0,V.current=0},50);return}(De=E.current)==null||De.call(E),setTimeout(()=>{var Ne;(Ne=B.current)==null||Ne.call(B),R.current=0,V.current=0},50)},S.autoChunkCreationTime);return()=>{clearInterval(z)}},[F.isRecording,S.autoChunkCreationTime,S.silenceDetectionConfig.minActiveDuration,S.silenceDetectionConfig.activationThreshold,S.chunkingMode]),s.jsx("div",{className:`audio-panel ${p}`,children:s.jsx(Xt,{children:s.jsxs(Zt,{className:"p-3 space-y-1",children:[s.jsxs("div",{className:"controls-section flex justify-between items-center gap-1",children:[s.jsx(Vl,{onClick:be,label:F.isRecording?"Stop":"Record",icon:F.isRecording?Bt:ha,variant:F.isRecording?"destructive":"default",size:"sm",options:[{label:"Clear and Record",onClick:M}],showDropdown:!F.isRecording,className:"recording-toggle-group"}),s.jsxs($e,{children:[s.jsx(He,{asChild:!0,children:s.jsx(ae,{variant:"secondary",size:"sm",children:s.jsx(Wi,{className:"w-3 h-3"})})}),s.jsx(Me,{className:"w-80 p-3",align:"end",children:s.jsx(fd,{config:S,onConfigChange:Ce})})]})]}),s.jsx("div",{className:"visualizer-section",children:s.jsx(md,{audioData:v,silenceState:ne.state,onThresholdChange:ne.updateThreshold,hideSilenceControls:!0,duration:f})}),(S.chunkingMode==="vad"||S.chunkingMode==="silence-based")&&F.isRecording&&s.jsxs("div",{className:"vad-activity-indicator p-2 bg-slate-50 border border-slate-200 rounded-lg",children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"text-[9px] font-semibold text-slate-600",children:"VAD Activity"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-[8px] text-slate-500",children:["Level: ",(ne.state.currentLevel*100).toFixed(0),"%"]}),s.jsx("div",{className:`px-1.5 py-0.5 rounded text-[8px] font-medium ${ne.state.isSilent?"bg-gray-100 text-gray-600":"bg-green-100 text-green-700"}`,children:ne.state.isSilent?"ðŸ”‡ Silent":"ðŸŽ™ï¸ Active"})]})]}),s.jsxs("div",{className:"relative h-2 bg-slate-200 rounded-full overflow-hidden",children:[ne.state.silenceThreshold>0&&s.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-400 z-10",style:{left:`${ne.state.silenceThreshold*100}%`},title:`Threshold: ${(ne.state.silenceThreshold*100).toFixed(0)}%`}),s.jsx("div",{className:`h-full transition-all duration-100 ${ne.state.isSilent?"bg-gray-400":"bg-green-500"}`,style:{width:`${ne.state.currentLevel*100}%`}})]}),F.isChunkRecording&&s.jsxs("div",{className:"mt-1 text-[8px] text-blue-600 flex items-center gap-1",children:[s.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-blue-600 rounded-full animate-pulse"}),"Recording chunk..."]})]}),F.error&&s.jsx("div",{className:"error-display p-1.5 bg-red-50 border border-red-200 rounded-lg",children:s.jsx("p",{className:"text-[10px] text-red-600",children:F.error})}),s.jsx(wn,{chunks:F.chunks,onChunkDelete:Se,onChunkTranscribe:we,onClearAll:ke})]})})})}function Sn({onTranscriptionComplete:a,className:e="",sessionName:t="audio-button-default",getTextAreaElement:r,variant:n="default",autoStartRecording:o=!1,"data-test":l,style:c}){const[d,u]=i.useState(!1),[h,m]=i.useState(0),[g,b]=i.useState(0),[w,p]=i.useState(!1);i.useEffect(()=>{if(o&&!d){const E=setTimeout(()=>{m(_=>_+1)},100);return()=>clearTimeout(E)}},[o]);const v=i.useCallback(E=>"value"in E?E.value:E.textContent||"",[]),y=i.useCallback((E,_)=>{var A;if("value"in E){const I=(A=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:A.set;I?I.call(E,_):E.value=_}else E.textContent=_;const B=new Event("input",{bubbles:!0});E.dispatchEvent(B)},[]),[f,x]=i.useState([]),[C,j]=i.useState(0),[S,N]=i.useState(!1),T=i.useCallback(E=>{x(_=>[..._,E]),(E.transcriptionStatus==="pending"||E.transcriptionStatus==="processing")&&p(!0)},[]),W=i.useCallback(E=>{x(_=>_.map(B=>B.id===E.id?E:B)),E.transcription?(j(_=>_+1),a==null||a(E.transcription),p(!1)):E.transcriptionStatus==="failed"&&p(!1)},[a]),L=i.useCallback(E=>{u(E)},[]),P=i.useCallback(E=>{E&&(E.preventDefault(),E.stopPropagation()),d?b(_=>_+1):m(_=>_+1)},[d]),U=i.useCallback(E=>{if(E.preventDefault(),E.stopPropagation(),C>0&&r){const _=r();if(!_)return;const B=f[C-1];if(!(B!=null&&B.transcription))return;const A=v(_),I=B.transcription;let R=A;A.endsWith(I)?R=A.slice(0,-I.length):A.endsWith(" "+I)&&(R=A.slice(0,-(I.length+1))),R=R.trimEnd(),y(_,R),j(H=>H-1)}},[C,f,r,v,y]),$=i.useCallback(E=>{if(E.preventDefault(),E.stopPropagation(),C<f.length&&r){const _=r();if(!_)return;const B=f[C];if(!(B!=null&&B.transcription))return;const A=v(_),I=A.trim()?" ":"",R=A+I+B.transcription;y(_,R),j(H=>H+1)}},[C,f,r,v,y]),k=i.useCallback(E=>{const _=f.findIndex(B=>B.id===E);if(_!==-1){if(_<C&&r){const B=r();if(B){const I=f.filter((R,H)=>H<C&&H!==_).map(R=>R.transcription).filter(Boolean).join(" ");y(B,I),j(R=>R-1)}}x(B=>B.filter(A=>A.id!==E))}},[f,C,r,y]),O=i.useCallback(()=>{if(r){const E=r();E&&y(E,"")}x([]),j(0)},[r,y]);return i.useEffect(()=>{const E=_=>{if(_.ctrlKey&&_.shiftKey&&_.key==="A")if(r){const B=r();B&&document.activeElement===B&&(_.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation(),P())}else _.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation(),P()};return window.addEventListener("keydown",E,!0),()=>{window.removeEventListener("keydown",E,!0)}},[P,r]),s.jsxs("div",{className:`audio-button-wrapper flex items-center gap-1 ${e}`,"data-test":l||"audio-button-wrapper",style:c,children:[w&&s.jsx("div",{className:"transcription-spinner","data-test":l?`${l}-transcription-spinner`:"audio-button-transcription-spinner",children:s.jsx(Ts,{className:"w-4 h-4 animate-spin text-muted-foreground","data-test":l?`${l}-transcription-spinner-icon`:"audio-button-transcription-spinner-icon"})}),f.length>0&&s.jsxs("div",{className:"chunk-navigation flex items-center gap-0.5","data-test":l?`${l}-chunk-navigation`:"audio-button-chunk-navigation",children:[s.jsx("button",{onMouseDown:E=>E.preventDefault(),onClick:U,disabled:C===0,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Remove previous chunk",type:"button","data-test":l?`${l}-previous-chunk-button`:"audio-button-previous-chunk-button",children:s.jsx(Qt,{className:_e.sm,"data-test":l?`${l}-previous-chunk-icon`:"audio-button-previous-chunk-icon"})}),s.jsxs($e,{open:S,onOpenChange:N,"data-test":l?`${l}-chunk-panel-popover`:"audio-button-chunk-panel-popover",children:[s.jsx(He,{asChild:!0,children:s.jsxs("button",{onMouseDown:E=>E.preventDefault(),className:"chunk-counter text-xs text-muted-foreground px-1 hover:bg-accent rounded cursor-pointer",title:"View all chunks",type:"button","data-test":l?`${l}-chunk-counter-button`:"audio-button-chunk-counter-button",children:[C,"/",f.length]})}),s.jsx(Me,{className:"w-96 p-3",side:"top",align:"center","data-test":l?`${l}-chunk-panel-content`:"audio-button-chunk-panel-content",children:s.jsxs("div",{className:"chunk-panel-popover","data-test":l?`${l}-chunk-panel-wrapper`:"audio-button-chunk-panel-wrapper",children:[s.jsx("h3",{className:"text-sm font-semibold mb-2","data-test":l?`${l}-chunk-panel-title`:"audio-button-chunk-panel-title",children:"Recorded Chunks"}),s.jsx(wn,{chunks:f,onChunkDelete:k,onChunkTranscribe:()=>{},onClearAll:O})]})})]}),s.jsx("button",{onMouseDown:E=>E.preventDefault(),onClick:$,disabled:C>=f.length,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Add next chunk",type:"button","data-test":l?`${l}-next-chunk-button`:"audio-button-next-chunk-button",children:s.jsx(Et,{className:_e.sm,"data-test":l?`${l}-next-chunk-icon`:"audio-button-next-chunk-icon"})})]}),s.jsx("button",{onMouseDown:E=>E.preventDefault(),onClick:P,className:n==="muted"?`voice-input-button p-1 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"text-muted-foreground/40 hover:text-foreground hover:bg-accent"}`:`voice-input-button p-1.5 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"hover:bg-accent"}`,title:d?"Stop recording (Ctrl+Shift+A)":"Start voice input (Ctrl+Shift+A)",type:"button","data-test":l?`${l}-voice-input-button`:"audio-button-voice-input-button",children:s.jsx(ha,{className:`voice-input-icon ${n==="muted"?_e.xs:_e.sm} ${d?"animate-pulse":""}`,"data-test":l?`${l}-voice-input-icon`:"audio-button-voice-input-icon"})}),s.jsx("div",{className:"audio-panel-wrapper hidden","data-test":l?`${l}-audio-panel-wrapper`:"audio-button-audio-panel-wrapper",children:s.jsx(yd,{sessionName:t,enableAutoPersist:!1,loadPersistedChunks:!1,autoStart:!1,startTrigger:h,stopTrigger:g,onChunkCreated:T,onChunkUpdated:W,onRecordingStateChange:L})})]})}const jn=i.forwardRef(({className:a,onSelectionChange:e,showBuiltInPopover:t=!0,showAudioButton:r=!1,audioButtonVariant:n="default",onAudioTranscription:o,getTextAreaElement:l,"data-test":c,...d},u)=>{const[h,m]=i.useState(""),[g,b]=i.useState(!1),[w,p]=i.useState({top:0,left:0}),v=i.useRef(null),y=i.useRef(null),f=i.useCallback(()=>{const N=v.current;if(!N)return;const T=N.selectionStart,W=N.selectionEnd,L=N.value.substring(T,W).trim();if(L.length>0){m(L),b(t);const P=N.scrollTop,U=window.getComputedStyle(N),$=N.getBoundingClientRect(),k=parseInt(U.paddingLeft)||12,O=parseInt(U.paddingTop)||8,E=N.value.substring(0,T).split(`
`),_=parseInt(U.lineHeight)||20,B=E.length-1,A=E[B],R=document.createElement("canvas").getContext("2d");if(!R)return;R.font=`${U.fontWeight} ${U.fontSize} ${U.fontFamily}`;const H=parseInt(U.paddingRight)||12,V=$.width-k-H;let K=0,F=0,Q=0;for(;Q<A.length;){let oe=Q+1;for(;oe<=A.length;){const J=A.substring(Q,oe);if(R.measureText(J).width>V){let Z=oe-1;for(let ce=oe-1;ce>Q;ce--)if(A[ce]===" "){Z=ce;break}Z===Q&&oe-Q>1&&(Z=oe-1),oe=Z;break}oe++}K=Q;const q=Math.min(oe,A.length);if(q>=A.length){const J=A.substring(K),re=R.measureText(J).width,Z=(B+F)*_-P+_+O,ce=re+k,ie={top:Z,left:ce};p(ie),e==null||e(L,ie);return}F++,Q=q,A[Q]===" "&&Q++}}else b(!1),m(""),e==null||e("",void 0)},[e,t]),x=i.useCallback(()=>{f()},[f]),C=i.useCallback(N=>{var T;N.shiftKey&&f(),(T=d.onKeyUp)==null||T.call(d,N)},[f,d]),j=i.useCallback(N=>{var T;setTimeout(()=>b(!1),200),(T=d.onBlur)==null||T.call(d,N)},[d]),S=i.useCallback(()=>{if(!h||h.length===0)return"";const N=h[0];return N>="A"&&N<="Z"?"text-red-600":N>="a"&&N<="z"?"text-blue-600":""},[h]);return i.useImperativeHandle(u,()=>({insertTextAtStart:N=>{const T=v.current;if(!T)return;T.focus();const W=T.selectionStart,L=T.selectionEnd;if(T.setSelectionRange(0,0),!document.execCommand("insertText",!1,N)){const k=N+T.value;T.value=k,T.dispatchEvent(new Event("input",{bubbles:!0}))}const U=W+N.length,$=L+N.length;T.setSelectionRange(U,$)},getTextArea:()=>v.current,getSelectionPosition:()=>w}),[w]),s.jsxs("div",{className:"textarea-container relative w-full h-full","data-test":c?`${c}-container`:"selectable-textarea-container",children:[s.jsxs($e,{open:g,"data-test":c?`${c}-popover`:"selectable-textarea-popover",children:[s.jsx(dn,{className:D("flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),ref:v,onMouseUp:x,onKeyUp:C,onBlur:j,"data-node-textarea":"true","data-test":c?`${c}-rich-textarea`:"selectable-textarea-rich-textarea",...d}),s.jsx(tn,{ref:y,style:{position:"absolute",top:`${w.top}px`,left:`${w.left}px`,width:"1px",height:"1px"},"data-test":c?`${c}-popover-anchor`:"selectable-textarea-popover-anchor"}),s.jsx(Me,{side:"bottom",align:"start",className:"selection-popover w-auto max-w-md",onOpenAutoFocus:N=>N.preventDefault(),"data-test":c?`${c}-popover-content`:"selectable-textarea-popover-content",children:s.jsxs("div",{className:"popover-content flex flex-col gap-2","data-test":c?`${c}-popover-content-wrapper`:"selectable-textarea-popover-content-wrapper",children:[s.jsx("div",{className:"popover-label text-xs text-muted-foreground font-medium","data-test":c?`${c}-popover-label`:"selectable-textarea-popover-label",children:"Selected Text:"}),s.jsx("div",{className:D("popover-text text-sm font-mono bg-muted px-2 py-1 rounded font-semibold",S()),"data-test":c?`${c}-popover-text`:"selectable-textarea-popover-text",children:h})]})})]}),r&&s.jsx(Sn,{onTranscriptionComplete:N=>{o==null||o(N)},sessionName:"selectable-textarea",className:"absolute right-2 bottom-1",style:{zIndex:it.nodeAudioButton},getTextAreaElement:l||(()=>v.current),variant:n,"data-test":c?`${c}-audio-button`:"selectable-textarea-audio-button"})]})});jn.displayName="SelectableTextArea";class wd{constructor(){X(this,"directoryMapCache",new Map);X(this,"loadPromiseCache",new Map)}async loadDirectoryMap(e){var c;const t=e??"default",n=(c=Y.getState().ui)==null?void 0:c.directoryMaps;if(n!=null&&n[t])return this.directoryMapCache.set(t,n[t]),n[t];if(this.directoryMapCache.has(t))return this.directoryMapCache.get(t);if(this.loadPromiseCache.has(t))return this.loadPromiseCache.get(t);const o=e?`/directory-map?cwd=${encodeURIComponent(e)}`:"/directoryMap.json",l=fetch("http://localhost:3333"+o).then(d=>{if(!d.ok)throw new Error(`Failed to load directory map: ${d.statusText}`);return d.json()}).then(d=>{const u=d.success?d.data:d;return this.directoryMapCache.set(t,u),this.loadPromiseCache.delete(t),this.saveToGlobalStore(t,u),u}).catch(d=>{throw this.loadPromiseCache.delete(t),d});return this.loadPromiseCache.set(t,l),l}saveToGlobalStore(e,t){var o;const r=Y.getState(),n=((o=r.ui)==null?void 0:o.directoryMaps)??{};Y.updateState({ui:{...r.ui,directoryMaps:{...n,[e]:t}}})}async getFilePath(e,t){const r=await this.loadDirectoryMap(t);if(r[e])return r[e];const n=e.toLowerCase();for(const[o,l]of Object.entries(r))if(o.toLowerCase()===n)return l}async getAllFilenames(e){const t=await this.loadDirectoryMap(e);return Object.keys(t)}async searchFiles(e,t){const r=await this.loadDirectoryMap(t),n=e.toLowerCase();return Object.entries(r).filter(([o])=>o.toLowerCase().includes(n)).map(([o,l])=>({filename:o,path:l}))}clearCache(e){var t;if(e){const r=e;this.directoryMapCache.delete(r),this.loadPromiseCache.delete(r);const n=Y.getState(),l={...((t=n.ui)==null?void 0:t.directoryMaps)??{}};delete l[r],Y.updateState({ui:{...n.ui,directoryMaps:l}})}else{this.directoryMapCache.clear(),this.loadPromiseCache.clear();const r=Y.getState();Y.updateState({ui:{...r.ui,directoryMaps:{}}})}}}const ta=new wd;function rs(a,e){const t=a.toLowerCase(),r=e.toLowerCase();if(t==="")return{score:0,matches:[]};let n=0,o=0;const l=[];let c=0,d=0;for(;n<t.length&&o<r.length;)t[n]===r[o]?(l.push(o),d++,c+=1+d,(o===0||/[\s\-_\/\\.]/.test(e[o-1]))&&(c+=10),n++):d=0,o++;if(n!==t.length)return null;if(l.length>0){const u=l[l.length-1]-l[0]-l.length+1;c-=u}return c+=100/(e.length+1),{score:c,matches:l}}function Sd(a,e){if(e.length===0)return[{text:a,isMatch:!1}];const t=[];let r=0;for(const n of e)n>r&&t.push({text:a.substring(r,n),isMatch:!1}),t.push({text:a[n],isMatch:!0}),r=n+1;return r<a.length&&t.push({text:a.substring(r),isMatch:!1}),t}const js=i.forwardRef(({className:a,children:e,...t},r)=>s.jsxs(br,{ref:r,className:D("relative overflow-hidden",a),...t,children:[s.jsx(vi,{className:"h-full w-full rounded-[inherit]",children:e}),s.jsx(Cn,{}),s.jsx(yi,{})]}));js.displayName=br.displayName;const Cn=i.forwardRef(({className:a,orientation:e="vertical",...t},r)=>s.jsx(vr,{ref:r,orientation:e,className:D("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...t,children:s.jsx(wi,{className:"relative flex-1 rounded-full bg-border"})}));Cn.displayName=vr.displayName;function jd({items:a,selectedIndex:e,renderItem:t,onItemClick:r,onItemHover:n,className:o,height:l="h-[400px]",emptyMessage:c="No items found",isLoading:d=!1,loadingMessage:u="Loading...",getItemKey:h}){const m=i.useRef(null);return i.useEffect(()=>{m.current&&m.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[e]),s.jsx(js,{className:D("scrollable-list rounded-md border",l,o),"data-test":"scrollable-list-container",children:d?s.jsx("div",{className:"loading-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-loading-state",children:s.jsx("span",{"data-test":"scrollable-list-loading-message",children:u})}):a.length===0?s.jsx("div",{className:"empty-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-empty-state",children:s.jsx("span",{"data-test":"scrollable-list-empty-message",children:c})}):s.jsx("div",{className:"list-items","data-test":"scrollable-list-items",children:a.map((g,b)=>{const w=b===e,p=h?h(g,b):b;return t(g,b,w,p,w?m:void 0,()=>r==null?void 0:r(g,b),()=>n==null?void 0:n(b))})})})}function Cd({onFileSelect:a,className:e,maxResults:t=10,placeholder:r="Search files...",mode:n="normal",searchMode:o="filename",cwd:l,"data-test":c}){const[d,u]=i.useState([]),[h,m]=i.useState([]),[g,b]=i.useState(t),[w,p]=i.useState(""),[v,y]=i.useState(!0),[f,x]=i.useState(0),[C,j]=i.useState(o);i.useEffect(()=>{(async()=>{try{y(!0);const _=await ta.getAllFilenames(l),B=[];for(const A of _){const I=await ta.getFilePath(A,l);I&&B.push({filename:A,path:I})}u(B),m(B),b(t)}catch(_){console.error("Failed to load files:",_)}finally{y(!1)}})()},[t,l]),i.useEffect(()=>{w.startsWith("/")?C!=="fullPath"&&j("fullPath"):C!=="filename"&&j("filename");const E=w.startsWith("/")?w.slice(1):w;if(!E.trim()){m(d),b(t),x(0);return}let _=d;if(C==="fullPath"){const I=new Set,R=[];for(const H of d){R.push(H),I.add(H.path);const V=H.path.split("/").filter(Boolean);for(let K=1;K<V.length;K++){const F=V.slice(0,K).join("/")+"/";I.has(F)||(I.add(F),R.push({filename:V[K-1],path:F,isDirectory:!0}))}}_=R}const B=[];for(const I of _)if(C==="fullPath"){const R=rs(E,I.path);R&&B.push({file:I,score:R.score,matches:R.matches})}else{const R=rs(E,I.filename),H=rs(E,I.path),V=R&&H?R.score>H.score?R:H:R??H;V&&B.push({file:I,score:V.score,matches:V.matches})}B.sort((I,R)=>R.score-I.score);const A=B.map(I=>I.file);m(A),b(t),x(0)},[w,d,t,C]);const S=i.useCallback(E=>{a==null||a(E)},[a]),N=i.useCallback(E=>{switch(h.slice(0,g),E.key){case"Tab":if(E.preventDefault(),h[f]&&w.startsWith("/")){const _=h[f].path,B=w.slice(1),A=_.indexOf("/",B.length);if(A!==-1){const I=_.substring(0,A+1);p("/"+I)}else p("/"+_)}break;case"ArrowDown":E.preventDefault(),x(_=>{const B=Math.min(_+1,h.length-1);return B>=g-2&&g<h.length&&b(A=>Math.min(A+t,h.length)),B});break;case"ArrowUp":E.preventDefault(),x(_=>Math.max(_-1,0));break;case"Enter":E.preventDefault(),h[f]&&S(h[f]);break;case"Escape":E.preventDefault(),p("");break}},[h,g,f,S,t,w]),T=(E,_)=>{if(!_.trim())return s.jsx("span",{children:E});const B=rs(_,E);if(!B)return s.jsx("span",{children:E});const A=Sd(E,B.matches);return s.jsx("span",{children:A.map((I,R)=>s.jsx("span",{className:I.isMatch?"bg-yellow-200 dark:bg-yellow-900 font-semibold":"",children:I.text},R))})},W=E=>{var A;const _=(A=E.split(".").pop())==null?void 0:A.toLowerCase(),B="w-4 h-4 flex-shrink-0";return["tsx","ts","jsx","js"].includes(_??"")?s.jsx(Lt,{className:D(B,"text-blue-500")}):["json","yml","yaml"].includes(_??"")?s.jsx(Lt,{className:D(B,"text-yellow-500")}):["md","txt"].includes(_??"")?s.jsx(Lt,{className:D(B,"text-gray-500")}):["css","scss"].includes(_??"")?s.jsx(Lt,{className:D(B,"text-purple-500")}):s.jsx(Lt,{className:D(B,"text-muted-foreground")})},L=E=>E.split("/").slice(0,-1).join("/")||"/",P=n==="compact"||n==="fileNameOnly",U=n==="fileNameOnly",$=w.startsWith("/")?w.slice(1):w,k=h.slice(0,g),O=(E,_,B,A,I,R,H)=>s.jsxs("button",{ref:I,onClick:R,onMouseEnter:H,className:D("file-item w-full flex items-start hover:bg-accent text-left transition-colors border-b border-border last:border-b-0",P?"px-2 py-1 gap-2":"px-3 py-2 gap-3",B&&"bg-accent"),children:[!U&&(E.isDirectory?s.jsx(Aa,{className:D("w-4 h-4 flex-shrink-0","text-blue-400")}):W(E.filename)),s.jsx("div",{className:"file-info flex-1 min-w-0",children:C==="fullPath"?s.jsx(s.Fragment,{children:s.jsx("div",{className:D("filename font-medium truncate",P?"text-xs":"text-sm"),children:T(E.path,$)})}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:D("filename font-medium truncate",P?"text-xs":"text-sm"),children:T(E.filename,$)}),!U&&s.jsxs("div",{className:D("file-path text-muted-foreground truncate flex items-center gap-1",P?"text-[10px]":"text-xs"),children:[s.jsx(Aa,{className:D("flex-shrink-0",P?"w-2.5 h-2.5":"w-3 h-3")}),T(L(E.path),$)]})]})})]},A);return s.jsxs("div",{className:D("file-picker flex flex-col",P?"gap-1.5":"gap-3",e),"data-test":c||"file-picker-container",children:[s.jsxs("div",{className:"search-input-wrapper relative","data-test":c?`${c}-search-wrapper`:"file-picker-search-wrapper",children:[s.jsx(ua,{className:D("absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none",P?"w-3 h-3":"w-4 h-4"),"data-test":c?`${c}-search-icon`:"file-picker-search-icon"}),s.jsx(Be,{type:"text",value:w,onChange:E=>p(E.target.value),onKeyDown:N,placeholder:r,className:D("search-input pl-9",P&&"h-8 text-xs"),autoFocus:!0,"data-test":c?`${c}-search-input`:"file-picker-search-input"})]}),!U&&s.jsx("div",{className:D("results-info text-xs text-muted-foreground",P?"px-0.5":"px-1"),"data-test":c?`${c}-results-info`:"file-picker-results-info",children:v?s.jsx("span",{"data-test":c?`${c}-loading-text`:"file-picker-loading-text",children:"Loading files..."}):s.jsxs("span",{"data-test":c?`${c}-results-text`:"file-picker-results-text",children:["Showing ",k.length," of ",h.length," results",h.length<d.length&&` (filtered from ${d.length} total)`]})}),s.jsx(jd,{items:k,selectedIndex:f,renderItem:O,onItemClick:E=>S(E),onItemHover:E=>x(E),getItemKey:E=>E.path,height:P?"h-[300px]":"h-[400px]",className:"file-list",emptyMessage:"No files found",isLoading:v,loadingMessage:"Loading files...","data-test":c?`${c}-file-list`:"file-picker-file-list"}),!U&&s.jsxs("div",{className:D("keyboard-hints text-muted-foreground flex",P?"text-[10px] px-0.5 gap-2":"text-xs px-1 gap-4"),"data-test":c?`${c}-keyboard-hints`:"file-picker-keyboard-hints",children:[s.jsxs("span",{children:[s.jsx("kbd",{className:D("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"â†‘â†“"})," Navigate"]}),s.jsxs("span",{children:[s.jsx("kbd",{className:D("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Tab"})," Autocomplete"]}),s.jsxs("span",{children:[s.jsx("kbd",{className:D("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Enter"})," Select"]}),s.jsxs("span",{children:[s.jsx("kbd",{className:D("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Esc"})," Clear"]})]})]})}function ot(a){return a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/__(.+?)__/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/_(.+?)_/g,"<em>$1</em>").replace(/~~(.+?)~~/g,"<del>$1</del>").replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm font-mono">$1</code>').replace(/^### (.+)$/gm,'<span class="text-lg font-bold">$1</span>').replace(/^## (.+)$/gm,'<span class="text-xl font-bold">$1</span>').replace(/^# (.+)$/gm,'<span class="text-2xl font-bold">$1</span>').replace(/^&gt; (.+)$/gm,'<blockquote class="border-l-2 border-muted-foreground/30 pl-3 m-0 text-muted-foreground italic">$1</blockquote>').replace(/\n/g,"<br>"):""}function Ct(a){if(!a)return"";const e=document.createElement("div");e.innerHTML=a;function t(o,l=!1){if(o.nodeType===Node.TEXT_NODE)return o.textContent||"";if(o.nodeType===Node.ELEMENT_NODE){const c=o,d=c.tagName.toLowerCase(),u=Array.from(o.childNodes).map(h=>t(h,!1)).join("");switch(d){case"strong":case"b":return`**${u}**`;case"em":case"i":return`*${u}*`;case"del":case"s":return`~~${u}~~`;case"code":return`\`${u}\``;case"br":return`
`;case"blockquote":return`> ${u}`;case"div":case"p":return l?u:u?u+`
`:"";case"span":return c.classList.contains("text-2xl")?`# ${u}`:c.classList.contains("text-xl")?`## ${u}`:c.classList.contains("text-lg")?`### ${u}`:u;default:return u}}return""}return t(e,!0).replace(/\n+$/,"")}function Hs(a){const e=window.getSelection();if(!e||e.rangeCount===0)return{text:Ct(a.innerHTML),cursorPos:0};const t=e.getRangeAt(0),r=t.cloneRange();r.selectNodeContents(a),r.setEnd(t.startContainer,t.startOffset);const n=document.createElement("div");n.appendChild(r.cloneContents());const o=Ct(n.innerHTML);return{text:Ct(a.innerHTML),cursorPos:o.length}}function Nd(a,e){const t=a.lastIndexOf(`
`,e-1)+1,r=a.indexOf(`
`,e),n=r===-1?a.length:r,o=a.substring(t,n);return{lineStart:t,currentLine:o}}function At(a,e){var c;const t=window.getSelection();if(!t)return;let r=0;const n=document.createTreeWalker(a,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let o=n.nextNode();for(;o;){if(o.nodeType===Node.TEXT_NODE){const d=((c=o.textContent)==null?void 0:c.length)??0;if(r+d>=e){const u=document.createRange();u.setStart(o,e-r),u.collapse(!0),t.removeAllRanges(),t.addRange(u);return}r+=d}else if(o.nodeName==="BR"){if(r+1>=e){const d=document.createRange(),u=o.parentNode;if(u){const h=Array.from(u.childNodes).indexOf(o);d.setStart(u,h+1),d.collapse(!0),t.removeAllRanges(),t.addRange(d)}return}r+=1}o=n.nextNode()}const l=document.createRange();l.selectNodeContents(a),l.collapse(!1),t.removeAllRanges(),t.addRange(l)}const Nn=i.forwardRef(({value:a,defaultValue:e,onChange:t,onBlur:r,onKeyDown:n,className:o,style:l,placeholder:c,readOnly:d=!1,useRichEditing:u=!1,allowRawPreviewOnClick:h=!1,showHints:m=!0,showAudioButton:g=!1,audioButtonVariant:b="default",autoStartAudioRecording:w=!1,onAudioTranscription:p,getTextAreaElement:v,"data-test":y,...f},x)=>{const[C,j]=i.useState(e||""),[S,N]=i.useState(!1),T=i.useRef(null),W=i.useRef(!1),L=i.useRef(!1),P=a!==void 0?a:C,U=!P||P.trim()==="";i.useImperativeHandle(x,()=>({getElement:()=>T.current,getValue:()=>P,setValue:A=>{if(a===void 0&&j(A),T.current){const I=ot(A);T.current.innerHTML=I;const R=document.createRange(),H=window.getSelection();R.selectNodeContents(T.current),R.collapse(!1),H==null||H.removeAllRanges(),H==null||H.addRange(R)}t==null||t(A)},focus:()=>{var A;(A=T.current)==null||A.focus()}})),i.useEffect(()=>{T.current&&!W.current&&(T.current.innerHTML=ot(P),W.current=!0)},[]),i.useEffect(()=>{if(T.current&&!S&&W.current){const A=ot(P);T.current.innerHTML!==A&&(T.current.innerHTML=A)}},[P,S]),i.useEffect(()=>{if(!S||!T.current||!h)return;const A=()=>{if(L.current)return;const I=window.getSelection();if(!(!I||!T.current)&&I.isCollapsed&&T.current.contains(I.anchorNode)){const R=Ct(T.current.innerHTML),H=ot(R);if(T.current.innerHTML!==H){const V=I.getRangeAt(0),K=V.cloneRange();K.selectNodeContents(T.current),K.setEnd(V.startContainer,V.startOffset);const F=document.createElement("div");F.appendChild(K.cloneContents());const Q=Ct(F.innerHTML).length;T.current.innerHTML=H,At(T.current,Q)}}};return document.addEventListener("selectionchange",A),()=>{document.removeEventListener("selectionchange",A)}},[S,P,h]);const $=i.useCallback(()=>{if(!T.current)return;const A=T.current.innerHTML,I=Ct(A);a===void 0&&j(I),t==null||t(I)},[t,a]),k=i.useCallback(A=>{var H,V;if(!T.current||!h)return;const R=A.target.closest("strong, em, code, del, blockquote");if(R){A.preventDefault();const K=R.textContent||"";let F="";const Q=R.tagName.toLowerCase();switch(Q){case"strong":F="**";break;case"em":F="*";break;case"code":F="`";break;case"del":F="~~";break;case"blockquote":F="> ";break}if(F){L.current=!0;const oe=window.getSelection();if(!oe||oe.rangeCount===0)return;const q=oe.getRangeAt(0);let J=0;if(R.contains(q.startContainer)){const ue=document.createRange();ue.selectNodeContents(R),ue.setEnd(q.startContainer,q.startOffset);const ve=document.createElement("div");ve.appendChild(ue.cloneContents()),J=((H=ve.textContent)==null?void 0:H.length)||0}const re=Q==="blockquote"?`${F}${K}`:`${F}${K}${F}`,Z=document.createTextNode(re);R.replaceWith(Z);const ce=document.createRange(),ie=F.length+J;ce.setStart(Z,ie),ce.setEnd(Z,ie),oe.removeAllRanges(),oe.addRange(ce),$()}}else if(L.current&&(L.current=!1,T.current)){const K=window.getSelection();let F=0;if(K&&K.rangeCount>0){const q=K.getRangeAt(0),J=q.cloneRange();J.selectNodeContents(T.current),J.setEnd(q.startContainer,q.startOffset);const re=document.createElement("div");re.appendChild(J.cloneContents());const Z=re.textContent||"";F=Z.length;let ce=0;for(let ie=0;ie<Math.min(F,Z.length);ie++){const ue=Z[ie],ve=Z[ie+1];ue==="*"&&ve==="*"?(ce+=2,ie++):(ue==="*"||ue==="_"||ue==="`"||ue==="~")&&ce++}F=F-ce}const Q=Ct(T.current.innerHTML),oe=ot(Q);if(T.current.innerHTML!==oe&&(T.current.innerHTML=oe,K&&K.rangeCount>0)){let q=0;const J=document.createTreeWalker(T.current,NodeFilter.SHOW_TEXT);let re=J.nextNode(),Z=!1;for(;re&&!Z;){const ce=((V=re.textContent)==null?void 0:V.length)||0;if(q+ce>=F){const ie=F-q,ue=document.createRange();ue.setStart(re,ie),ue.setEnd(re,ie),K.removeAllRanges(),K.addRange(ue),Z=!0}else q+=ce,re=J.nextNode()}}}},[$,h]),O=i.useCallback(()=>{N(!0)},[]),E=i.useCallback(A=>{N(!1),T.current&&(T.current.innerHTML=ot(P)),r==null||r(A)},[P,r]),_=i.useCallback(A=>{const I=window.getSelection();if(I&&I.rangeCount>0&&!I.isCollapsed){const R=I.toString();if((A.key==="*"||A.key==="_"||A.key==="`")&&!A.metaKey&&!A.ctrlKey&&!A.altKey){A.preventDefault();const H=I.getRangeAt(0);H.deleteContents();const V=document.createTextNode(A.key);H.insertNode(V);const K=document.createTextNode(R);H.setStartAfter(V),H.insertNode(K);const F=document.createTextNode(A.key);H.setStartAfter(K),H.insertNode(F);const Q=document.createRange();Q.setStartAfter(V),Q.setEndBefore(F),I.removeAllRanges(),I.addRange(Q),$(),n==null||n(A);return}}if(A.metaKey||A.ctrlKey){if(!["b","i","`"].includes(A.key.toLowerCase())){n==null||n(A);return}const H=window.getSelection();if(!H||H.rangeCount===0){n==null||n(A);return}const V=H.toString();if(!V){n==null||n(A);return}let K="";switch(A.key){case"b":K="**";break;case"i":K="*";break;case"`":K="`";break}if(K){A.preventDefault();const F=H.getRangeAt(0);F.deleteContents();const Q=document.createTextNode(`${K}${V}${K}`);F.insertNode(Q),F.setStartAfter(Q),F.setEndAfter(Q),H.removeAllRanges(),H.addRange(F),$(),n==null||n(A);return}}if(u&&T.current){if(A.key==="Backspace"){const{text:R,cursorPos:H}=Hs(T.current),V=ln(R,H);if(V.type==="delete-char"&&V.newText!==void 0){A.preventDefault();const K=V.newCursorPos??H-1;T.current.innerHTML=ot(V.newText),At(T.current,K),a===void 0&&j(V.newText),t==null||t(V.newText),n==null||n(A);return}}if(A.key==="Enter"&&!A.shiftKey){const{text:R,cursorPos:H}=Hs(T.current),{lineStart:V,textAfterLine:K}=xa(R,H),F=R.substring(V,H),Q=R.indexOf(`
`,H),oe=R.substring(H,Q===-1?R.length:Q),q=cn(F,oe+K,R,H);if(q.type==="remove-prefix"){A.preventDefault();const J=q.charsToRemoveBeforeCursor??0;let re;q.textAfterCursor!==void 0?re=R.substring(0,H-J)+q.textToInsert+q.textAfterCursor:re=R.substring(0,H-J)+q.textToInsert+R.substring(H);const Z=H-J+q.textToInsert.length;T.current.innerHTML=ot(re),At(T.current,Z),a===void 0&&j(re),t==null||t(re),n==null||n(A);return}if(q.type==="continue"){A.preventDefault();let J;q.textAfterCursor!==void 0?J=R.substring(0,H)+q.textToInsert+q.textAfterCursor:J=R.substring(0,H)+q.textToInsert+R.substring(H);const re=H+q.textToInsert.length;T.current.innerHTML=ot(J),At(T.current,re),a===void 0&&j(J),t==null||t(J),n==null||n(A);return}}if(A.key==="Tab"){A.preventDefault();const{text:R,cursorPos:H}=Hs(T.current),{lineStart:V,currentLine:K}=Nd(R,H);if(A.shiftKey){let F=0;for(let Q=0;Q<Math.min(2,K.length)&&K[Q]===" ";Q++)F++;if(F>0){const Q=R.substring(0,V)+R.substring(V+F),oe=Math.max(V,H-F);T.current.innerHTML=ot(Q),At(T.current,oe),a===void 0&&j(Q),t==null||t(Q)}}else{const F=R.substring(0,V)+"  "+R.substring(V),Q=H+2;T.current.innerHTML=ot(F),At(T.current,Q),a===void 0&&j(F),t==null||t(F)}n==null||n(A);return}}n==null||n(A)},[$,n,u,a,t]),B=i.useCallback(A=>{A.preventDefault();const I=A.clipboardData.getData("text/plain");document.execCommand("insertText",!1,I)},[]);return s.jsxs("div",{className:"markdown-textarea-container h-full","data-test":y?`${y}-container`:"markdown-textarea-container",children:[s.jsxs("div",{className:"markdown-textarea-wrapper relative h-full","data-test":y?`${y}-wrapper`:"markdown-textarea-wrapper",children:[s.jsx("div",{ref:T,contentEditable:!d,onInput:$,onClick:k,onFocus:O,onBlur:E,onKeyDown:_,onPaste:B,className:D("markdown-textarea min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm","ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50","[&_strong]:font-bold [&_em]:italic [&_del]:line-through","[&_code]:bg-muted [&_code]:px-1 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono",d&&"cursor-default",o),style:{whiteSpace:"pre-wrap",wordBreak:"break-word",...l},suppressContentEditableWarning:!0,"data-node-textarea":f["data-node-textarea"],"data-test":y?`${y}-editor`:"markdown-textarea-editor"}),U&&!S&&c&&s.jsx("div",{className:"absolute top-2 left-3 text-sm text-muted-foreground pointer-events-none","aria-hidden":!0,"data-test":y?`${y}-placeholder`:"markdown-textarea-placeholder",children:c}),g&&s.jsx(Sn,{onTranscriptionComplete:A=>{p==null||p(A)},sessionName:"markdown-textarea",className:"absolute right-2 bottom-1",style:{zIndex:it.nodeAudioButton},getTextAreaElement:v||(()=>T.current),variant:b,autoStartRecording:w,"data-test":y?`${y}-audio-button`:"markdown-textarea-audio-button"})]}),m&&s.jsxs("div",{className:"markdown-hints text-xs text-muted-foreground mt-1 flex gap-3 flex-wrap","data-test":y?`${y}-hints`:"markdown-textarea-hints",children:[s.jsxs("span",{children:[s.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+B"})," Bold"]}),s.jsxs("span",{children:[s.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+I"})," Italic"]}),s.jsx("span",{children:"**bold** *italic* `code` > quote"}),u&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-muted-foreground/50",children:"|"}),s.jsxs("span",{children:[s.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Tab"})," Indent"]}),s.jsx("span",{children:"Auto-list on Enter"})]})]})]})});Nn.displayName="MarkdownTextarea";const Ed=a=>{var e,t,r;return(r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.selectedProjectPath},Ba=(a,e)=>{let t=-1;for(let o=e;o>=0;o--){if(a[o]==="@"){t=o;break}if(a[o]===" "||a[o]===`
`||a[o]==="	")break}if(t===-1)return null;let r=t+1;for(;r<a.length;){const o=a[r];if(o===" "||o===`
`||o==="	")break;r++}const n=a.substring(t,r);return n.startsWith("@")&&n.includes("/")?{start:t,end:r,path:n}:null},St=i.forwardRef(({defaultValue:a,value:e,onChange:t,onBlur:r,onKeyDown:n,onMouseDown:o,onClick:l,onPaste:c,className:d,style:u,placeholder:h,onSelectionChange:m,onFileSelect:g,logger:b,showBuiltInPopover:w=!1,showFilePicker:p=!0,showAudioButton:v=!0,audioButtonVariant:y="default",autoStartAudioRecording:f=!1,onAudioTranscriptionComplete:x,readOnly:C=!1,rows:j,useMarkdown:S=!1,showMarkdownHints:N=!1},T)=>{const[W,L]=i.useState(!1),[P,U]=i.useState({top:0,left:0}),[$,k]=i.useState(null),O=i.useRef(null),E=i.useRef(null),_=i.useRef(null),B=Te(Ed);i.useImperativeHandle(T,()=>({getTextArea:()=>{var q,J;return S?(q=E.current)==null?void 0:q.getElement():((J=O.current)==null?void 0:J.getTextArea())??null},insertTextAtStart:q=>{var J,re;S?(J=E.current)==null||J.focus():(re=O.current)==null||re.insertTextAtStart(q)},focus:()=>{var q,J,re;S?(q=E.current)==null||q.focus():(re=(J=O.current)==null?void 0:J.getTextArea())==null||re.focus()}}),[S]);const A=i.useCallback(q=>{var J,re,Z,ce;if(S){const ie=((J=E.current)==null?void 0:J.getValue())??"",ue=ie.trim()?" ":"",ve=ie+ue+q;(re=E.current)==null||re.setValue(ve);const ne={target:{value:ve},currentTarget:{value:ve}};t==null||t(ne)}else{const ie=(Z=O.current)==null?void 0:Z.getTextArea();if(!ie)return;const ue=ie.value,ve=ue.trim()?" ":"",ne=ue+ve+q,G=(ce=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:ce.set;G?G.call(ie,ne):ie.value=ne;const te=new Event("input",{bubbles:!0});ie.dispatchEvent(te)}x==null||x()},[S,t,x]),I=q=>{var Z;if(!p)return!1;const J=q.selectionStart,re=q.value;if(J>0&&re[J-1]==="@"){const ce=J>1?re[J-2]:null,ie=J<re.length?re[J]:null;if((ce===null||ce===" "||ce===`
`||ce==="	")&&(ie===null||ie===" "||ie===`
`||ie==="	")){const ne=(Z=O.current)==null?void 0:Z.getSelectionPosition();return ne&&U(ne),k(J-1),L(!0),b==null||b.info("@ character detected at cursor - showing file picker"),!0}}return!1},R=q=>{const J=q.target;I(J),t==null||t(q)},H=q=>{const J=q.currentTarget;setTimeout(()=>{I(J)},0)},V=q=>{const J=q.currentTarget;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(q.key)&&I(J)},K=(q,J)=>{var re;if(m==null||m(q,J),!!p)if(q.length>0){const Z=q.toLowerCase()==="file",ce=(re=O.current)==null?void 0:re.getTextArea();let ie=null;if(ce){const ue=ce.value,ve=ce.selectionStart;ie=Ba(ue,ve)}Z||ie?(L(!0),J&&U(J),Z?(k(null),b==null||b.info('Word "file" selected - showing file picker')):(k(null),b==null||b.info(`File path "${ie==null?void 0:ie.path}" detected - showing file picker to replace`))):(L(!1),k(null))}else L(!1),k(null)},F=q=>{var J;if(L(q),!q){const re=(J=O.current)==null?void 0:J.getTextArea();re&&re.focus()}},Q=q=>{var fe;const J=(fe=O.current)==null?void 0:fe.getTextArea();if(!J)return;J.focus();const re=J.value,Z=J.selectionStart,ie=J.value.substring(J.selectionStart,J.selectionEnd).toLowerCase()==="file",ue=Ba(re,Z);let ve,ne,G;if($!==null)ve=$,ne=$+1,G="@"+q.path;else if(ie)ve=J.selectionStart,ne=J.selectionEnd,G="@"+q.path;else if(ue)ve=ue.start,ne=ue.end,G="@"+q.path;else{L(!1),k(null);return}if(J.setSelectionRange(ve,ne),!document.execCommand("insertText",!1,G)){const Ce=J.value.substring(0,ve),he=J.value.substring(ne);J.value=Ce+G+he,J.setSelectionRange(ve+G.length,ve+G.length),J.dispatchEvent(new Event("input",{bubbles:!0}))}$!==null?b==null||b.info(`Replaced "@" with: ${G}`):ie?b==null||b.info(`Replaced "file" with: ${G}`):ue&&(b==null||b.info(`Replaced "${ue.path}" with: ${G}`)),g==null||g(q),L(!1),k(null)},oe=i.useCallback(q=>{const J={target:{value:q},currentTarget:{value:q}};t==null||t(J)},[t]);return s.jsxs($e,{open:W,onOpenChange:F,"data-test":"textarea-file-picker-popover",children:[s.jsxs("div",{className:"textarea-with-file-picker relative w-full h-full","data-test":"textarea-file-picker-container",children:[S?s.jsx("div",{className:"relative w-full h-full",onMouseDown:o,onPaste:c,onClick:q=>{H(q),l==null||l(q)},onKeyUp:V,children:s.jsx(Nn,{ref:E,defaultValue:a,value:e,onChange:oe,onBlur:r,onKeyDown:n,className:d,style:u,placeholder:h,readOnly:C,useRichEditing:!0,showHints:N,showAudioButton:v,audioButtonVariant:y,autoStartAudioRecording:f,onAudioTranscription:A,getTextAreaElement:()=>{var q;return((q=E.current)==null?void 0:q.getElement())??null},"data-node-textarea":!0,"data-test":"textarea-file-picker-markdown-textarea"})}):s.jsx(jn,{ref:O,defaultValue:a,value:e,onChange:R,onBlur:r,onKeyDown:n,onMouseDown:o,onPaste:c,onClick:q=>{H(q),l==null||l(q)},onKeyUp:V,className:d,style:u,onSelectionChange:K,placeholder:h,showBuiltInPopover:w,showAudioButton:v,audioButtonVariant:y,onAudioTranscription:A,getTextAreaElement:()=>{var q;return((q=O.current)==null?void 0:q.getTextArea())??null},readOnly:C,rows:j,"data-test":"textarea-file-picker-selectable-textarea"}),p&&s.jsx(tn,{ref:_,style:{position:"absolute",top:`${P.top}px`,left:`${P.left}px`,width:"1px",height:"1px"},"data-test":"textarea-file-picker-popover-anchor"})]}),p&&s.jsxs(Me,{className:"file-picker-popover w-[500px] p-2",side:"bottom",align:"start","data-test":"textarea-file-picker-popover-content",children:[s.jsxs("div",{className:"file-picker-header mb-2","data-test":"textarea-file-picker-popover-header",children:[s.jsx("h3",{className:"font-semibold text-xs","data-test":"textarea-file-picker-popover-title",children:'Replace "file" with a file path'}),s.jsx("p",{className:"text-[10px] text-muted-foreground","data-test":"textarea-file-picker-popover-description",children:'Select a file to replace the word "file" with its path. Type "/" to search by full path.'})]}),s.jsx(Cd,{onFileSelect:Q,maxResults:10,placeholder:"Search for a file...",mode:"fileNameOnly",cwd:B??void 0,"data-test":"textarea-file-picker-file-picker"})]})]})});St.displayName="TextareaWithFilePicker";const Ws={outputFormat:"text",permissionMode:"acceptEdits"};function En({variant:a="outline",size:e="sm",buttonLabel:t="Options",className:r,children:n}){const o=Te(d=>{var u,h,m;return(m=(h=(u=d.ui)==null?void 0:u.claude)==null?void 0:h.message)==null?void 0:m.options}),l={outputFormat:(o==null?void 0:o.outputFormat)??Ws.outputFormat,permissionMode:(o==null?void 0:o.permissionMode)??Ws.permissionMode};i.useEffect(()=>{var d,u,h;if(!o){const m=Y.getState();Y.updateState({ui:{...m.ui,claude:{...(d=m.ui)==null?void 0:d.claude,message:{...(h=(u=m.ui)==null?void 0:u.claude)==null?void 0:h.message,options:Ws}}}})}},[o]);const c=d=>{var h,m,g;const u=Y.getState();Y.updateState({ui:{...u.ui,claude:{...(h=u.ui)==null?void 0:h.claude,message:{...(g=(m=u.ui)==null?void 0:m.claude)==null?void 0:g.message,options:d}}}})};return s.jsxs(s.Fragment,{children:[s.jsxs($e,{children:[s.jsx(He,{asChild:!0,children:s.jsxs(ae,{variant:a,size:e,className:r,title:"Message Options","data-test":"message-options-button",children:[s.jsx(bt,{className:"h-4 w-4"}),t&&s.jsx("span",{className:"ml-2",children:t})]})}),s.jsx(Me,{className:"w-80",onClick:d=>d.stopPropagation(),"data-test":"message-options-popover",children:s.jsxs("div",{className:"message-options-panel space-y-4","data-test":"message-options-panel",children:[s.jsxs("div",{className:"output-format-select","data-test":"output-format-select",children:[s.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Output Format"}),s.jsxs(vt,{value:l.outputFormat,onValueChange:d=>c({...l,outputFormat:d}),children:[s.jsx(mt,{"data-test":"output-format-trigger",children:s.jsx(yt,{})}),s.jsxs(ft,{"data-test":"output-format-content",children:[s.jsx(ye,{value:"text","data-test":"output-format-text",children:"Text"}),s.jsx(ye,{value:"json","data-test":"output-format-json",children:"JSON"}),s.jsx(ye,{value:"stream-json","data-test":"output-format-stream-json",children:"Stream JSON"})]})]})]}),s.jsxs("div",{className:"permission-mode-select","data-test":"permission-mode-select",children:[s.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Permission Mode"}),s.jsxs(vt,{value:l.permissionMode,onValueChange:d=>c({...l,permissionMode:d}),children:[s.jsx(mt,{"data-test":"permission-mode-trigger",children:s.jsx(yt,{})}),s.jsxs(ft,{"data-test":"permission-mode-content",children:[s.jsx(ye,{value:"default","data-test":"permission-mode-default",children:"Default"}),s.jsx(ye,{value:"acceptEdits","data-test":"permission-mode-accept-edits",children:"Accept Edits"}),s.jsx(ye,{value:"bypassPermissions","data-test":"permission-mode-bypass",children:"Bypass Permissions"}),s.jsx(ye,{value:"plan","data-test":"permission-mode-plan",children:"Plan Mode"})]})]})]})]})})]}),n(l)]})}const kd="Use @agent-code-worktree-specialist to help with this task.",Td="Please implement this feature following best practices and ensure all tests pass.";function kn({variant:a="ghost",size:e="icon",className:t="create-session-panel-button",disabled:r=!1,icon:n,initialMessage:o,buttonTitle:l="Create New Session with Message",projectPath:c,onOpen:d,onCreating:u,onSessionCreated:h,useModal:m=!1}){const[g,b]=i.useState(!1),[w,p]=i.useState(!1),[v,y]=i.useState(o||""),[f,x]=i.useState(o||""),[C,j]=i.useState(void 0),[S,N]=i.useState(!1),[T,W]=i.useState(null),L=i.useRef(null),P=Te(A=>{var I,R,H;return(H=(R=(I=A.app)==null?void 0:I.claude)==null?void 0:R.ui)==null?void 0:H.selectedProjectPath}),U=Te(A=>{var I,R;return(R=(I=A.ui)==null?void 0:I.global)==null?void 0:R.createClaudeSessionPopoverSize}),$=A=>{var R;const I=Y.getState();Y.updateState({ui:{...I.ui,global:{...(R=I.ui)==null?void 0:R.global,createClaudeSessionPopoverSize:A}}})};i.useEffect(()=>{o!==f&&(y(o||""),x(o||""))},[o,f]),i.useEffect(()=>{var A,I,R,H,V,K;if(g&&c&&c!=="none"){const F=Y.getState();((R=(I=(A=F.app)==null?void 0:A.claude)==null?void 0:I.ui)==null?void 0:R.selectedProjectPath)!==c&&Y.updateState({app:{...F.app,claude:{...(H=F.app)==null?void 0:H.claude,ui:{...(K=(V=F.app)==null?void 0:V.claude)==null?void 0:K.ui,selectedProjectPath:c}}}})}},[g,c]);const k=()=>{if(!m&&L.current){const A=L.current.getBoundingClientRect();j({x:A.left,y:A.bottom+8})}b(!0),d&&d()},O=()=>{b(!1)},E=(A,I)=>{const R=[];return I.usePrompt1&&I.prompt1Text&&R.push(I.prompt1Text),I.usePrompt2&&I.prompt2Text&&R.push(I.prompt2Text),R.length>0?`${R.join(`

`)}

${A}`:A},_=A=>{const I=P??c;return{message:v.trim(),cwd:I,projectId:I,options:{outputFormat:A.outputFormat,permissionMode:A.permissionMode}}},B=async A=>{if(console.log("ðŸŽ¯ [ButtonCreateSession] handleSendMessage called",{messageLength:v.trim().length,sessionOptions:A,timestamp:new Date().toISOString()}),!v.trim()){console.log("âš ï¸ [ButtonCreateSession] Message is empty, aborting");return}try{console.log("ðŸ“¤ [ButtonCreateSession] Setting sending state to true"),p(!0),u&&(console.log("ðŸ“£ [ButtonCreateSession] Calling onCreating callback"),u());const I=_(A);console.log("ðŸ“¦ [ButtonCreateSession] Request body built",{hasMessage:!!I.message,hasCwd:!!I.cwd,hasProjectId:!!I.projectId,optionsCount:Object.keys(I.options||{}).length}),console.log("ðŸš€ [ButtonCreateSession] Calling claudeAPI.createSession");const R=await Ye.createSession(I);if(console.log("âœ… [ButtonCreateSession] API response received",{success:R.success,hasSessionId:!!R.sessionId,error:R.error}),R.success&&R.sessionId)console.log("ðŸŽ‰ [ButtonCreateSession] Session created successfully",{sessionId:R.sessionId}),h&&(console.log("ðŸ“ž [ButtonCreateSession] Calling onSessionCreated callback"),h(R.sessionId,R.response)),console.log("ðŸšª [ButtonCreateSession] Closing popover"),O();else throw new Error(R.error??"Failed to create session")}catch(I){console.error("âŒ [ButtonCreateSession] Failed to create session:",I)}finally{console.log("ðŸ [ButtonCreateSession] Setting sending state to false"),p(!1)}};return s.jsx(As,{storageKey:"claude-session-prompts",initialConfig:{usePrompt1:!1,usePrompt2:!1,prompt1Text:kd,prompt2Text:Td},children:(A,I,R)=>{const H=(K,F)=>{const Q={...A,[K]:F};I(Q);const oe=E(o||"",Q);y(oe)},V=s.jsxs("div",{"data-test":"create-session-content",className:"content-wrapper p-4 space-y-4",children:[s.jsxs("div",{"data-test":"create-session-project-selector-section",className:"project-selector-container mb-4",children:[s.jsxs("div",{"data-test":"create-session-header",className:"flex items-center justify-between",children:[s.jsx("label",{"data-test":"create-session-project-label",className:"project-selector-label text-sm font-medium block",children:"Select Project"}),s.jsx(R,{title:"Prompt Configuration",buttonClassName:"prompt-config-button",children:s.jsxs("div",{"data-test":"prompt-config-panel",className:"prompt-config-panel space-y-4",onClick:K=>K.stopPropagation(),children:[s.jsxs("div",{"data-test":"prompt-checkbox-1-container",className:"prompt-checkbox-container flex items-center space-x-2",children:[s.jsx(dt,{"data-test":"prompt-checkbox-1",id:"use-prompt-1",checked:A.usePrompt1,onCheckedChange:K=>H("usePrompt1",K===!0)}),s.jsx(de,{htmlFor:"use-prompt-1",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 1"})]}),s.jsx("div",{"data-test":"prompt-text-display-1",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:A.prompt1Text}),s.jsxs("div",{"data-test":"prompt-checkbox-2-container",className:"prompt-checkbox-container flex items-center space-x-2 mt-4",children:[s.jsx(dt,{"data-test":"prompt-checkbox-2",id:"use-prompt-2",checked:A.usePrompt2,onCheckedChange:K=>H("usePrompt2",K===!0)}),s.jsx(de,{htmlFor:"use-prompt-2",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 2"})]}),s.jsx("div",{"data-test":"prompt-text-display-2",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:A.prompt2Text})]})})]}),s.jsx(on,{"data-test":"create-session-project-selector",variant:"select",className:"project-selector w-full"})]}),s.jsxs("div",{"data-test":"create-session-message-container",className:"new-session-input-container space-y-3",children:[s.jsx(St,{"data-test":"create-session-textarea",value:v,onChange:K=>y(K.target.value),placeholder:"Type your message...",rows:10,className:"resize-y"}),s.jsx("div",{"data-test":"create-session-actions",className:"flex justify-end gap-2 items-center",children:s.jsx(En,{variant:"outline",size:"sm",buttonLabel:"Options",className:"session-options-button","data-test":"create-session-options-button",children:K=>s.jsx(fa,{"data-test":"create-session-send-button",label:s.jsxs(s.Fragment,{children:[s.jsx(Js,{className:"h-4 w-4 mr-2"}),w?"Creating Session...":"Create Session"]}),onAction:()=>{console.log("ðŸ‘† [ButtonCreateSession] ConfigurableButton onAction triggered",{messageLength:v.trim().length,sending:w,disabled:!v.trim()||w,timestamp:new Date().toISOString()}),B(K)},disabled:!v.trim()||w,variant:"default",configOptions:[{label:"Preview Request Body",value:"preview",onClick:()=>{W(K),N(!0)},icon:s.jsx(Gi,{className:"h-4 w-4"})}],showHint:!0,tooltipText:"Click to send, hold to preview request",ariaLabel:"Create Session button with preview option"})})}),S&&T&&s.jsx(bs,{open:S,onOpenChange:N,children:s.jsxs(vs,{className:"sm:max-w-[600px] max-h-[70vh] overflow-y-auto",children:[s.jsx(ys,{children:s.jsx(Wt,{children:"Request Body Preview"})}),s.jsx("pre",{className:"request-preview-content bg-muted p-4 rounded-md text-xs font-mono overflow-x-auto whitespace-pre-wrap",children:JSON.stringify(_(T),null,2)}),s.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[s.jsx(ae,{variant:"outline",onClick:()=>N(!1),children:"Close"}),s.jsxs(ae,{onClick:()=>{N(!1),B(T)},children:[s.jsx(Js,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})]});return s.jsxs(s.Fragment,{children:[s.jsx(ae,{ref:L,"data-test":"create-session-button",variant:a,size:e,disabled:r,className:t,title:l,onClick:k,children:n??s.jsx(_r,{className:"h-4 w-4 hover:text-purple-500 transition-colors"})}),m?s.jsx(bs,{open:g,onOpenChange:b,children:s.jsxs(vs,{"data-test":"create-session-dialog",className:"sm:max-w-[700px] max-h-[80vh] overflow-y-auto",children:[s.jsx(ys,{children:s.jsx(Wt,{children:"Create New Session"})}),V]})}):s.jsx(ga,{"data-test":"create-session-popover",isVisible:g,onClose:O,title:"Create New Session",className:"max-h-[80vh]",shouldCloseManually:!0,resizable:!0,initialSize:U||{width:700,height:600},onSizeChange:$,triggerPosition:C,children:s.jsx("div",{className:"overflow-y-auto max-h-[calc(80vh-3rem)]",children:V})})]})}})}function Ad({buttonLabel:a,icon:e=s.jsx(ha,{className:"h-5 w-5"}),variant:t="ghost",size:r="icon",buttonClassName:n="",contentClassName:o="",align:l="end",side:c="bottom",title:d="Audio Recorder"}){const[u,h]=i.useState(!1);return s.jsxs($e,{open:u,onOpenChange:h,"data-test":"audio-recorder-popover",children:[s.jsx(He,{asChild:!0,children:s.jsx(ae,{variant:t,size:r,className:`audio-recorder-button ${n}`,title:d,"data-test":"audio-recorder-trigger-button",children:a?s.jsxs(s.Fragment,{children:[e,a&&s.jsx("span",{className:"ml-2","data-test":"audio-recorder-button-label",children:a})]}):e})}),s.jsxs(Me,{className:`audio-recorder-panel w-[400px] ${o}`,align:l,side:c,"data-test":"audio-recorder-popover-content",children:[d&&s.jsx("div",{className:"audio-panel-header pb-2 mb-2 border-b border-border","data-test":"audio-recorder-panel-header",children:s.jsx("h3",{className:"text-sm font-semibold","data-test":"audio-recorder-panel-title",children:d})}),s.jsx("div",{className:"audio-panel-content","data-test":"audio-recorder-panel-content",children:s.jsx(St,{})})]})]})}const Tn=Si,Sa=i.forwardRef(({className:a,...e},t)=>s.jsx(yr,{ref:t,className:D("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",a),...e}));Sa.displayName=yr.displayName;const Vt=i.forwardRef(({className:a,...e},t)=>s.jsx(wr,{ref:t,className:D("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",a),...e}));Vt.displayName=wr.displayName;const qt=i.forwardRef(({className:a,...e},t)=>s.jsx(Sr,{ref:t,className:D("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",a),...e}));qt.displayName=Sr.displayName;var ht=(a=>(a.LOW="low",a.MEDIUM="medium",a.HIGH="high",a.URGENT="urgent",a))(ht||{}),Ae=(a=>(a.FREEZER="freezer",a.BACKLOG="backlog",a.SELECTED="selected",a.DOING="doing",a.DONE="done",a.ARCHIVE="archive",a))(Ae||{}),xt=(a=>(a.PERSONAL="personal",a.WORK="work",a.SHOPPING="shopping",a.HEALTH="health",a.OTHER="other",a))(xt||{});function An({session:a,segmentsToStrip:e=3,onNameUpdated:t}){const[r,n]=i.useState(!1),[o,l]=i.useState(""),[c,d]=i.useState(!1),u=i.useRef(null),h=i.useMemo(()=>{const{name:p,cwd:v}=a;if(!p.startsWith("-home-"))return p;let f=p;const x=/\/[a-f0-9]{8}[a-f0-9-]*$/i;f=f.replace(x,""),f.startsWith("-")&&(f=f.substring(1));const C="/"+f.replace(/-/g,"/");v&&C.startsWith(v);const j=C.split("/").filter(Boolean);return e>0&&j.length>e?j.slice(e).join("/"):j.length===0?p:j.join("/")},[a,e]),m=a.customName||h;i.useEffect(()=>{r&&u.current&&(u.current.focus(),u.current.select())},[r]);const g=()=>{l(a.customName||""),n(!0)},b=async()=>{if(!c)try{d(!0);const p=o.trim()===""?null:o.trim();await Ye.updateSessionName(a.id,p),t==null||t(),n(!1)}catch(p){console.error("Failed to update session name:",p),alert("Failed to update session name")}finally{d(!1)}},w=p=>{p.key==="Enter"?b():p.key==="Escape"&&n(!1)};return r?s.jsxs("div",{className:"session-name-edit flex items-center gap-2","data-test":"session-name-edit-container",children:[s.jsx("input",{ref:u,type:"text",value:o,onChange:p=>l(p.target.value),onKeyDown:w,onBlur:()=>n(!1),className:"flex-1 px-2 py-1 border rounded",placeholder:h,disabled:c,"data-test":"session-name-input"}),s.jsx("button",{onMouseDown:p=>{p.preventDefault(),b()},disabled:c,className:"session-name-save-btn p-1 hover:bg-gray-100 rounded",title:"Save (Enter)","data-test":"session-name-save-button",children:s.jsx(We,{className:"w-4 h-4"})})]}):s.jsx("span",{className:"session-name-display cursor-pointer hover:underline",onDoubleClick:g,title:"Double-click to edit","data-test":"session-name-display",children:m})}function Rd({sessionIds:a=[],className:e="",title:t="Claude session is running",showCount:r=!1,lastActiveTime:n,isCreating:o=!1}){const[l,c]=i.useState({}),[d,u]=i.useState([]),h=i.useRef(a);i.useEffect(()=>{h.current=a},[a]),i.useEffect(()=>{var T,W,L;const S=((L=(W=(T=Y.get("app"))==null?void 0:T.claude)==null?void 0:W.data)==null?void 0:L.sessions)??[];u(S);const N=Y.selectSlice(P=>{var U,$,k;return(k=($=(U=P.app)==null?void 0:U.claude)==null?void 0:$.data)==null?void 0:k.sessions}).subscribe(P=>{u(P??[])});return()=>N.unsubscribe()},[]);const m=i.useMemo(()=>{if(n!==void 0)return n;if(!a.length||!d.length)return;const S=d.filter(T=>a.includes(T.id));if(!S.length)return;const N=S.reduce((T,W)=>{const L=new Date(W.lastModified).getTime();return L>T?L:T},0);return N>0?N:void 0},[n,a,d]);i.useEffect(()=>{var P,U,$;const S=k=>{if(!k)return{};const O={};for(const E of h.current)k[E]&&(O[E]=k[E]);return O},N=(k,O)=>{const E=Object.keys(k),_=Object.keys(O);if(E.length!==_.length)return!0;for(const B of _)if(!k[B]||k[B].isOpened!==O[B].isOpened||k[B].isProcessing!==O[B].isProcessing)return!0;return!1},T=(($=(U=(P=Y.get("app"))==null?void 0:P.claude)==null?void 0:U.ui)==null?void 0:$.activity)??{},W=S(T);c(W);const L=Y.selectSlice(k=>{var O,E,_;return(_=(E=(O=k.app)==null?void 0:O.claude)==null?void 0:E.ui)==null?void 0:_.activity}).subscribe(k=>{const O=S(k);c(E=>N(E,O)?O:E)});return()=>L.unsubscribe()},[]);const g=i.useCallback(S=>{const N=l[S];if(N!=null&&N.isProcessing)return"running";if(N!=null&&N.isOpened&&!(N!=null&&N.isProcessing))return"opened";if(m){const T=Date.now()-36e5;if(m>T)return"recent"}return"inactive"},[l,m]),b=S=>{switch(S){case"running":return{status:"running",color:"bg-green-500",bgColor:"bg-green-500",textColor:"text-green-600"};case"opened":return{status:"opened",color:"bg-orange-500",bgColor:"bg-orange-500",textColor:"text-orange-600"};case"recent":return{status:"recent",color:"bg-yellow-500",bgColor:"bg-yellow-500",textColor:"text-yellow-600"};case"inactive":default:return{status:"inactive",color:"bg-gray-400",bgColor:"bg-gray-400",textColor:"text-gray-500"}}},w=i.useMemo(()=>a.map(S=>({id:S,status:g(S)})).filter(S=>S.status!=="inactive"),[a,g]),p=w.length>0,v=i.useMemo(()=>w.some(S=>S.status==="running")?"running":w.some(S=>S.status==="opened")?"opened":w.some(S=>S.status==="recent")?"recent":"inactive",[w]),y=b(v),f=i.useMemo(()=>{if(r&&w.length>1){const N={running:"running",opened:"opened",recent:"recently active",inactive:"inactive"}[v];return`${w.length} Claude sessions ${N}`}const S={running:"Claude session is running",opened:"Claude session is opened",recent:"Claude session recently active",inactive:"Claude session inactive"}[v];return t||S},[r,w.length,v,t]);if(!p&&!o)return null;const x=o?"running":v,C=o?b("running"):y,j=o?"Creating Claude session...":f;return s.jsxs("div",{className:`session-activity-indicator flex items-center gap-1 ${e}`,title:j,"data-test":"session-activity-indicator",children:[s.jsx("div",{className:`activity-dot w-2 h-2 ${C.bgColor} rounded-full ${x==="running"?"animate-pulse":""}`,"data-test":"activity-dot","data-activity-status":x,"data-is-creating":o}),r&&w.length>1&&s.jsx("span",{className:`activity-count text-xs ${C.textColor} font-medium`,"data-test":"activity-count",children:w.length})]})}function Pd(a,e){if(a.className!==e.className||a.title!==e.title||a.showCount!==e.showCount||a.lastActiveTime!==e.lastActiveTime||a.isCreating!==e.isCreating)return!1;const t=a.sessionIds??[],r=e.sessionIds??[];return t.length!==r.length?!1:t.every((n,o)=>n===r[o])}const ja=i.memo(Rd,Pd),Rn=i.forwardRef(({searchQuery:a,onSearchChange:e,onAdvancedSearch:t,className:r},n)=>{const[o,l]=i.useState(!1),[c,d]=i.useState({sortOrder:"desc",pageSize:50}),u=i.useMemo(()=>{const{sortOrder:p,pageSize:v,...y}=c;return Object.values(y).some(C=>C!==void 0)||p!=="desc"},[c]),h=(p,v)=>{d(y=>({...y,[p]:v}))},m=()=>{t&&t(a,c),l(!1)},g=()=>{d({sortOrder:"desc",pageSize:50})},b=p=>{p.key==="Enter"&&t&&t(a,c)},w=()=>{e("")};return s.jsx("div",{ref:n,className:D("messages-search-container relative",r),"data-test":"messages-search-container",children:s.jsxs("div",{className:"search-input-wrapper relative flex items-center gap-1","data-test":"messages-search-input-wrapper",children:[s.jsx(ua,{className:"search-icon absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10","data-test":"messages-search-icon"}),s.jsx(Be,{type:"text",placeholder:"Search messages...",value:a,onChange:p=>e(p.target.value),onKeyDown:b,className:D("search-input pl-9",a?"pr-16":"pr-10"),"data-test":"messages-search-input"}),a&&s.jsx(ae,{variant:"ghost",size:"icon",onClick:w,className:"clear-button absolute right-9 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"messages-search-clear-button",children:s.jsx(Qe,{className:"h-4 w-4"})}),u&&s.jsx("div",{className:D("filter-indicator absolute top-1/2 -translate-y-1/2 h-2 w-2 rounded-full bg-primary pointer-events-none z-10",a?"right-17":"right-11"),"data-test":"messages-search-filter-indicator"}),s.jsxs($e,{open:o,onOpenChange:l,children:[s.jsx(He,{asChild:!0,children:s.jsx(ae,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0","aria-label":o?"Collapse advanced search":"Expand advanced search","data-test":"messages-search-expand-button",children:o?s.jsx(Pr,{className:"h-4 w-4"}):s.jsx(Yt,{className:"h-4 w-4"})})}),s.jsxs(Me,{align:"start",className:"advanced-search-panel w-96 max-h-[600px] overflow-y-auto","data-test":"messages-advanced-search-panel",children:[s.jsxs("div",{className:"panel-header space-y-2 pb-3 border-b","data-test":"messages-panel-header",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),s.jsx(ae,{variant:"ghost",size:"sm",onClick:g,className:"h-7 text-xs","data-test":"messages-clear-filters-button",children:"Clear All"})]}),s.jsx("p",{className:"text-xs text-muted-foreground",children:"Search message content with filters"})]}),s.jsxs("div",{className:"panel-content space-y-4 py-4","data-test":"messages-panel-content",children:[s.jsxs("div",{className:"role-filter space-y-2",children:[s.jsx(de,{className:"text-sm font-medium",children:"Message Role"}),s.jsxs(vt,{value:c.role||"all",onValueChange:p=>h("role",p==="all"?void 0:p),children:[s.jsx(mt,{className:"h-8",children:s.jsx(yt,{})}),s.jsxs(ft,{children:[s.jsx(ye,{value:"all",children:"All Messages"}),s.jsx(ye,{value:"user",children:"User"}),s.jsx(ye,{value:"assistant",children:"Assistant"})]})]})]}),s.jsxs("div",{className:"timestamp-range-filter space-y-2",children:[s.jsx(de,{className:"text-sm font-medium",children:"Timestamp Range"}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"timestamp-input-wrapper",children:[s.jsx(de,{htmlFor:"timestamp-after",className:"text-xs text-muted-foreground",children:"After"}),s.jsx(Be,{id:"timestamp-after",type:"datetime-local",value:c.after??"",onChange:p=>h("after",p.target.value||void 0),className:"h-8"})]}),s.jsxs("div",{className:"timestamp-input-wrapper",children:[s.jsx(de,{htmlFor:"timestamp-before",className:"text-xs text-muted-foreground",children:"Before"}),s.jsx(Be,{id:"timestamp-before",type:"datetime-local",value:c.before??"",onChange:p=>h("before",p.target.value||void 0),className:"h-8"})]})]})]}),s.jsxs("div",{className:"sorting-section space-y-2",children:[s.jsx(de,{className:"text-sm font-medium",children:"Sort By Timestamp"}),s.jsxs(vt,{value:c.sortOrder,onValueChange:p=>h("sortOrder",p),children:[s.jsx(mt,{className:"h-8",children:s.jsx(yt,{})}),s.jsxs(ft,{children:[s.jsx(ye,{value:"desc",children:"Newest First"}),s.jsx(ye,{value:"asc",children:"Oldest First"})]})]})]}),s.jsxs("div",{className:"pagination-section space-y-2",children:[s.jsx(de,{className:"text-sm font-medium",children:"Results Per Page"}),s.jsx(Be,{type:"number",min:"1",max:"100",value:c.pageSize??50,onChange:p=>h("pageSize",p.target.value?parseInt(p.target.value):50),className:"h-8"})]})]}),s.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 border-t","data-test":"messages-panel-footer",children:[s.jsx(ae,{onClick:m,className:"flex-1",size:"sm","data-test":"messages-apply-search-button",children:"Apply Search"}),s.jsx(ae,{onClick:()=>l(!1),variant:"outline",size:"sm","data-test":"messages-cancel-button",children:"Cancel"})]})]})]})]})})});Rn.displayName="MessagesSearch";const Pn=a=>typeof a=="string"?s.jsx("span",{"data-test":"message-content-text",children:a}):Array.isArray(a)?a.map((e,t)=>typeof e=="string"?s.jsx("div",{className:"max-w-full break-words","data-test":"message-content-block-string",children:e},t):typeof e=="object"&&e.type==="text"&&"text"in e?s.jsx("div",{className:"max-w-full break-words","data-test":"message-content-block-text",children:e.text},t):typeof e=="object"&&e.type==="tool_use"?s.jsx("div",{className:"tool-use bg-muted-foreground/10 p-2 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-tool-use",children:s.jsxs("div",{className:"text-xs font-mono truncate","data-test":"tool-use-name",children:["Tool: ","name"in e?e.name??"Unknown":"Unknown"]})},t):s.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded mt-1 overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-block-json",children:JSON.stringify(e,null,2)},t)):typeof a=="object"&&a!==null?a.text?s.jsx("span",{"data-test":"message-content-object-text",children:a.text}):a.content?s.jsx("div",{"data-test":"message-content-recursive",children:Pn(a.content)}):s.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-object-json",children:JSON.stringify(a,null,2)}):s.jsx("span",{"data-test":"message-content-fallback",children:String(a)}),sa=i.memo(({message:a,formatTime:e})=>{const[t,r]=i.useState(!1),n=l=>typeof l=="string"?l:Array.isArray(l)?l.map(c=>typeof c=="string"?c:typeof c=="object"&&c.type==="text"&&"text"in c?c.text:"").filter(Boolean).join(`
`):typeof l=="object"&&l!==null?l.text?l.text:l.content?n(l.content):JSON.stringify(l,null,2):String(l),o=async l=>{l.stopPropagation();const c=n(a.content);try{await navigator.clipboard.writeText(c),r(!0),setTimeout(()=>r(!1),2e3)}catch(d){console.error("Failed to copy message:",d)}};return s.jsx("div",{className:`message-item flex w-full ${a.role==="user"?"justify-end":"justify-start"}`,"data-test":`message-item-wrapper-${a.role}`,"data-test-message-id":a.id,children:s.jsxs("div",{onClick:()=>{console.log("Message clicked:",a)},className:`message-bubble max-w-[85%] rounded-lg p-3 overflow-hidden cursor-pointer ${a.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,"data-test":`message-bubble-${a.role}`,children:[s.jsxs("div",{className:"message-header mb-2 flex items-center gap-2","data-test":"message-header",children:[s.jsx("span",{className:`message-role text-xs font-semibold uppercase ${a.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":`message-role-label-${a.role}`,children:a.role}),s.jsxs("span",{className:`message-id text-xs font-mono ${a.role==="user"?"text-primary-foreground/60":"text-muted-foreground/70"}`,"data-test":"message-id-label",children:["ID: ",a.id]})]}),s.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words overflow-wrap-anywhere word-break max-w-full","data-test":"message-content",children:Pn(a.content)}),a.toolCalls&&a.toolCalls.length>0&&s.jsxs("div",{className:"message-tool-calls mt-2 space-y-1","data-test":"message-tool-calls",children:[s.jsx("div",{className:`text-xs font-semibold ${a.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":"message-tool-calls-label",children:"Tool Calls:"}),a.toolCalls.map((l,c)=>s.jsx("div",{className:`tool-call-item p-2 rounded text-xs font-mono ${a.role==="user"?"bg-primary-foreground/10":"bg-muted-foreground/10"}`,"data-test":`tool-call-item-${c}`,children:s.jsx("pre",{className:"whitespace-pre-wrap break-words max-w-full","data-test":"tool-call-json",children:JSON.stringify(l,null,2)})},c))]}),s.jsxs("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"message-footer",children:[s.jsx("div",{className:`message-time text-xs max-w-full ${a.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"message-timestamp",children:e(a.timestamp)}),s.jsx("button",{onClick:o,className:`copy-button p-1 rounded hover:bg-opacity-20 transition-colors ${a.role==="user"?"hover:bg-primary-foreground":"hover:bg-foreground"}`,title:"Copy message","data-test":"copy-message-button",children:t?s.jsx(We,{className:`h-3 w-3 ${a.role==="user"?"text-primary-foreground":"text-muted-foreground"}`,"data-test":"copy-success-icon"}):s.jsx(Lr,{className:`h-3 w-3 ${a.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"copy-icon"})})]})]})},a.id)});sa.displayName="MessageItem";function Id({messages:a,sessionDetails:e,metadata:t,loading:r,pagination:n,onLoadOlder:o,onSearch:l,onNameUpdated:c}){var W,L,P;const d=i.useRef(null),u=i.useRef(null),h=i.useRef(0),m=i.useRef(null),g=i.useRef(0),[b,w]=i.useState(""),[p,v]=i.useState(!1);i.useEffect(()=>{const U=(e==null?void 0:e.name)??null;m.current!==U&&(h.current=0,m.current=U)},[e==null?void 0:e.name]);const y=i.useCallback(U=>new Date(U).toLocaleTimeString(),[]),f=i.useCallback(U=>{const $=new Date(U);return $.toLocaleDateString()+" "+$.toLocaleTimeString()},[]),[x,C]=i.useState(((P=(L=(W=Y.getState().app)==null?void 0:W.claude)==null?void 0:L.ui)==null?void 0:P.messageFilters)??["user","assistant","thinking","tools"]);i.useEffect(()=>{var k,O,E,_,B,A;((E=(O=(k=Y.getState().app)==null?void 0:k.claude)==null?void 0:O.ui)==null?void 0:E.messageFilters)||Y.update("app",{claude:{...(_=Y.getState().app)==null?void 0:_.claude,ui:{...(A=(B=Y.getState().app)==null?void 0:B.claude)==null?void 0:A.ui,messageFilters:["user","assistant","thinking","tools"]}}});const $=Y.selectSlice(I=>{var R,H,V;return(V=(H=(R=I.app)==null?void 0:R.claude)==null?void 0:H.ui)==null?void 0:V.messageFilters}).subscribe(I=>{I&&C(I)});return()=>$.unsubscribe()},[]);const j=U=>{var E,_,B,A,I,R;const $=((B=(_=(E=Y.getState().app)==null?void 0:E.claude)==null?void 0:_.ui)==null?void 0:B.messageFilters)??x,k=$.includes(U)?$.filter(H=>H!==U):[...$,U],O=Y.getState();Y.setState({...O,app:{...O.app,claude:{...(A=O.app)==null?void 0:A.claude,ui:{...(R=(I=O.app)==null?void 0:I.claude)==null?void 0:R.ui,messageFilters:k}}}})},S=(U,$)=>{l&&l(U,$)},N=i.useMemo(()=>a.filter($=>!$.content||$.content===""?!1:Array.isArray($.content)&&$.content.some(O=>typeof O=="object"&&(O.type==="tool_use"||O.type==="tool_result"))?x.includes("tools"):!!($.role==="user"&&x.includes("user")||$.role==="assistant"&&x.includes("assistant"))).reverse(),[a,x]);i.useLayoutEffect(()=>{const U=h.current===0&&N.length>0,$=N.length>h.current&&h.current>0;if(d.current){const k=d.current.querySelector("[data-radix-scroll-area-viewport]");if(U&&k)k.scrollTop=k.scrollHeight,g.current=k.scrollHeight,h.current=N.length;else if($&&k){const O=k.scrollHeight,E=O-g.current;k.scrollTop=k.scrollTop+E,g.current=O,h.current=N.length}}},[N]),i.useEffect(()=>{if(h.current!==0&&d.current){const U=d.current.querySelector("[data-radix-scroll-area-viewport]");U&&setTimeout(()=>{U.scrollTo({top:U.scrollHeight,behavior:"smooth"})},50)}},[N]),i.useEffect(()=>{if(p&&u.current){const U=u.current.querySelector("[data-radix-scroll-area-viewport]");U&&setTimeout(()=>{U.scrollTo({top:U.scrollHeight,behavior:"auto"})},100)}},[p]);const T=i.useCallback((U=!0)=>{if(u.current){const $=u.current.querySelector("[data-radix-scroll-area-viewport]");$&&$.scrollTo({top:$.scrollHeight,behavior:U?"smooth":"auto"})}},[]);return s.jsxs(Xt,{className:"chat-interface-card h-full flex flex-col overflow-hidden","data-test":"chat-interface-card",children:[s.jsxs(ba,{className:"chat-header pb-2 pt-4 flex-shrink-0","data-test":"chat-header",children:[s.jsxs("div",{className:"header-title-container flex items-center gap-2 text-sm","data-test":"header-title-container",children:[s.jsx(ja,{sessionIds:e!=null&&e.id?[e.id]:[]}),s.jsx(va,{className:"text-base truncate","data-test":"chat-title",children:e?s.jsx(An,{session:e,segmentsToStrip:3,onNameUpdated:c}):"New Conversation"}),t&&s.jsx(ms,{children:s.jsxs(fs,{children:[s.jsx(gs,{asChild:!0,children:s.jsx("button",{className:"info-button p-1 hover:bg-muted rounded-sm transition-colors","data-test":"session-info-button",children:s.jsx(ps,{className:"h-4 w-4 text-muted-foreground"})})}),s.jsx(Ht,{className:"metadata-tooltip","data-test":"session-metadata-tooltip",children:s.jsxs("div",{className:"metadata-section text-xs space-y-1","data-test":"metadata-section",children:[s.jsxs("div",{className:"metadata-item","data-test":"metadata-item-created",children:[s.jsx("span",{className:"font-medium",children:"Created:"})," ",f(t.created)]}),s.jsxs("div",{className:"metadata-item","data-test":"metadata-item-modified",children:[s.jsx("span",{className:"font-medium",children:"Last Modified:"})," ",f(t.lastModified)]}),s.jsxs("div",{className:"metadata-item","data-test":"metadata-item-message-count",children:[s.jsx("span",{className:"font-medium",children:"Messages:"})," ",t.messageCount]}),t.model&&s.jsxs("div",{className:"metadata-item","data-test":"metadata-item-model",children:[s.jsx("span",{className:"font-medium",children:"Model:"})," ",t.model]})]})})]})}),s.jsx(ms,{children:s.jsxs(fs,{children:[s.jsx(gs,{asChild:!0,children:s.jsx("button",{className:"expand-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:()=>v(!0),"data-test":"expand-chat-button",children:s.jsx(Vi,{className:"h-4 w-4 text-muted-foreground"})})}),s.jsx(Ht,{children:s.jsx("p",{children:"Expand chat view"})})]})}),s.jsx(As,{storageKey:"chat-interface-config",title:"Chat Configuration",contentClassName:"chat-config-panel w-64",children:s.jsxs("div",{className:"config-content space-y-4","data-test":"chat-config-content",children:[s.jsxs("div",{className:"project-selector-section space-y-2","data-test":"project-selector-section",children:[s.jsx("div",{className:"section-label text-sm font-medium",children:"Project"}),s.jsx(on,{variant:"select",className:"w-full"})]}),s.jsxs("div",{className:"filters-section space-y-2","data-test":"message-filters-section",children:[s.jsx("div",{className:"section-label text-sm font-medium",children:"Show messages"}),s.jsxs("div",{className:"filter-options space-y-2","data-test":"filter-options",children:[s.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-user",children:[s.jsx(dt,{id:"filter-user",checked:x.includes("user"),onCheckedChange:()=>j("user"),"data-test":"filter-checkbox-user"}),s.jsx(de,{htmlFor:"filter-user",className:"text-sm cursor-pointer",children:"User"})]}),s.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-assistant",children:[s.jsx(dt,{id:"filter-assistant",checked:x.includes("assistant"),onCheckedChange:()=>j("assistant"),"data-test":"filter-checkbox-assistant"}),s.jsx(de,{htmlFor:"filter-assistant",className:"text-sm cursor-pointer",children:"Assistant"})]}),s.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-thinking",children:[s.jsx(dt,{id:"filter-thinking",checked:x.includes("thinking"),onCheckedChange:()=>j("thinking"),"data-test":"filter-checkbox-thinking"}),s.jsx(de,{htmlFor:"filter-thinking",className:"text-sm cursor-pointer",children:"Thinking"})]}),s.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-tools",children:[s.jsx(dt,{id:"filter-tools",checked:x.includes("tools"),onCheckedChange:()=>j("tools"),"data-test":"filter-checkbox-tools"}),s.jsx(de,{htmlFor:"filter-tools",className:"text-sm cursor-pointer",children:"Tools"})]})]})]})]})})]}),l&&s.jsx(Rn,{searchQuery:b,onSearchChange:w,onAdvancedSearch:S,className:"mt-3"})]}),s.jsx(Zt,{className:"chat-content flex-1 min-h-0 overflow-hidden p-0","data-test":"chat-content",children:s.jsx(js,{ref:d,className:"chat-scroll-area h-full w-full","data-test":"chat-scroll-area",children:s.jsxs("div",{className:"messages-container space-y-4 px-4 pt-2 w-full","data-test":"messages-container",children:[o&&n&&s.jsx("div",{className:"load-older-container flex justify-center pb-4 pt-2","data-test":"load-older-container",children:s.jsxs(ae,{variant:"outline",size:"sm",onClick:o,disabled:r,className:"load-older-button","data-test":"load-older-button",children:[s.jsx(Yt,{className:"h-4 w-4 mr-2 rotate-180"}),"Load Older Messages",n&&s.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(",a.length," of ",n.totalCount,")"]})]})}),r&&N.length===0?s.jsx("div",{className:"loading-message text-sm text-muted-foreground","data-test":"loading-message",children:"Loading messages..."}):N.length===0?s.jsxs("div",{className:"empty-state text-center mt-8","data-test":"empty-state",children:[s.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"New Session"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Type your first message below to start the conversation"})]}):N.map(U=>s.jsx(sa,{message:U,formatTime:y,"data-test":`message-item-${U.id}`},U.id))]})})}),s.jsx(ga,{isVisible:p,onClose:()=>v(!1),title:e?typeof e.customName=="string"?e.customName:e.name:"Chat Messages",shouldCloseManually:!0,resizable:!0,initialSize:{width:1e3,height:700},initialPosition:{x:100,y:50},children:s.jsxs("div",{className:"expanded-chat-content flex flex-col flex-1 overflow-hidden","data-test":"expanded-chat-view",children:[s.jsxs("div",{className:"expanded-controls-header flex items-center justify-between gap-4 px-4 py-2 border-b border-border flex-shrink-0","data-test":"expanded-controls-header",children:[s.jsxs("div",{className:"filter-controls flex items-center gap-3","data-test":"expanded-filter-controls",children:[s.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Show:"}),s.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[s.jsx(dt,{id:"expanded-filter-user",checked:x.includes("user"),onCheckedChange:()=>j("user"),"data-test":"expanded-filter-checkbox-user"}),s.jsx(de,{htmlFor:"expanded-filter-user",className:"text-xs cursor-pointer",children:"User"})]}),s.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[s.jsx(dt,{id:"expanded-filter-assistant",checked:x.includes("assistant"),onCheckedChange:()=>j("assistant"),"data-test":"expanded-filter-checkbox-assistant"}),s.jsx(de,{htmlFor:"expanded-filter-assistant",className:"text-xs cursor-pointer",children:"Assistant"})]}),s.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[s.jsx(dt,{id:"expanded-filter-tools",checked:x.includes("tools"),onCheckedChange:()=>j("tools"),"data-test":"expanded-filter-checkbox-tools"}),s.jsx(de,{htmlFor:"expanded-filter-tools",className:"text-xs cursor-pointer",children:"Tools"})]})]}),s.jsxs(ae,{variant:"outline",size:"sm",onClick:()=>T(!0),className:"scroll-to-bottom-button flex items-center gap-1.5 h-7 text-xs","data-test":"scroll-to-bottom-button",title:"Scroll to latest message",children:[s.jsx(qi,{className:"h-3 w-3"}),"Latest"]})]}),s.jsx("div",{className:"flex-1 min-h-0 p-4 pt-2",children:s.jsx(js,{className:"h-full",ref:u,children:s.jsx("div",{className:"messages-container-expanded space-y-4 pr-4",children:N.length===0?s.jsxs("div",{className:"empty-state text-center mt-8","data-test":"expanded-empty-state",children:[s.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"No Messages"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"This session has no messages yet"})]}):N.map(U=>s.jsx(sa,{message:U,formatTime:y,"data-test":`expanded-message-item-${U.id}`},U.id))})})})]})})]})}function In({sessionId:a,message:e,onBeforeSend:t,onSendSuccess:r,onSendError:n,outputFormat:o="text",permissionMode:l="acceptEdits",variant:c="ghost",size:d="icon",className:u="",title:h="Send to Claude session",disabled:m,...g}){const[b,w]=i.useState(!1);i.useEffect(()=>{w(!1)},[a]);const p=i.useCallback(async()=>{if(e.trim()){t==null||t();try{w(!0),await Ye.sendMessage({message:e.trim(),sessionId:a,options:{outputFormat:o,permissionMode:l}}),console.log(`Sent message to Claude session ${a}: ${e}`),r==null||r()}catch(v){console.error("Failed to send message to Claude:",v),n==null||n(v)}finally{w(!1)}}},[e,a,o,l,b,t,r,n]);return s.jsx(ae,{variant:c,size:d,onClick:p,className:u,title:h,disabled:m||!e.trim(),"data-test":"claude-send-button","data-test-sending":b?"true":"false",...g,children:b?s.jsx(Ts,{className:"h-3 w-3 animate-spin loading-indicator","data-test":"send-button-loading"}):s.jsx(Js,{className:"h-3 w-3","data-test":"send-button-icon"})})}function Dd({sessionId:a,initialMessage:e="",rows:t=3,value:r,onChange:n,onSendSuccess:o,onSendError:l}){const[c,d]=i.useState(e),u=i.useRef(null),h=r??c,m=n??d;i.useEffect(()=>{var y,f,x;const p=(x=(f=(y=Y.getState().app)==null?void 0:y.claude)==null?void 0:f.ui)==null?void 0:x.messageDrafts,v=p==null?void 0:p[a];d(v||"")},[a]),i.useEffect(()=>{var p,v,y,f,x,C;if(!r){const S={...((y=(v=(p=Y.getState().app)==null?void 0:p.claude)==null?void 0:v.ui)==null?void 0:y.messageDrafts)||{}};c.trim()?S[a]=c:delete S[a],Y.updateState({app:{...Y.getState().app,claude:{...(f=Y.getState().app)==null?void 0:f.claude,ui:{...(C=(x=Y.getState().app)==null?void 0:x.claude)==null?void 0:C.ui,messageDrafts:S}}}})}},[c,a,r]);const g=()=>{var f,x,C,j,S,N,T;m("");const p=(f=u.current)==null?void 0:f.getTextArea();p&&(p.value="",p.dispatchEvent(new Event("input",{bubbles:!0})));const y={...((j=(C=(x=Y.getState().app)==null?void 0:x.claude)==null?void 0:C.ui)==null?void 0:j.messageDrafts)||{}};delete y[a],Y.updateState({app:{...Y.getState().app,claude:{...(S=Y.getState().app)==null?void 0:S.claude,ui:{...(T=(N=Y.getState().app)==null?void 0:N.claude)==null?void 0:T.ui,messageDrafts:y}}}})},b=()=>{o==null||o()},w=p=>{var v;p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),(v=document.querySelector(".claude-send-button"))==null||v.click())};return s.jsx("div",{className:"message-input-container","data-test":"message-input-container",children:s.jsxs("div",{className:"message-input-area flex gap-2","data-test":"message-input-area",children:[s.jsx(St,{ref:u,value:h,onChange:p=>m(p.target.value),onKeyDown:w,placeholder:"Type your message... (Shift+Enter for new line, @ to insert file path)",className:"message-textarea resize-y flex-1",showBuiltInPopover:!1,rows:t,"data-test":"message-textarea"}),s.jsx("div",{className:"send-controls flex flex-col gap-2","data-test":"send-controls",children:s.jsx(En,{variant:"ghost",size:"icon",buttonLabel:"",children:p=>s.jsx(In,{sessionId:a,message:h,outputFormat:p.outputFormat,permissionMode:p.permissionMode,className:"claude-send-button send-button",size:"icon",onBeforeSend:g,onSendSuccess:b,onSendError:l})})})]})})}function _d(a){const e=new Date,t=new Date(a),r=e.getTime()-t.getTime(),n=Math.floor(r/(1e3*60)),o=Math.floor(r/(1e3*60*60)),l=Math.floor(r/(1e3*60*60*24)),c=Math.floor(l/7),d=Math.floor(l/365);return n<1?"just now":n<60?`${n} min ago`:o<24?`${o} ${o===1?"hour":"hours"} ago`:l<7?`${l} ${l===1?"day":"days"} ago`:c<52?`${c} ${c===1?"week":"weeks"} ago`:`${d} ${d===1?"year":"years"} ago`}function Dn({session:a,isSelected:e,onClick:t,formatDate:r,formatCwd:n,segmentsToStrip:o=3,onNameUpdated:l,compact:c=!1}){return s.jsxs("div",{"data-test":"session-list-item",onClick:()=>{console.log("Session selected:",a),t()},className:`session-item ${c?"p-1.5":"p-3"} rounded-lg border cursor-pointer transition-colors ${e?"bg-primary/10 border-primary":"hover:bg-accent"}`,children:[s.jsx("div",{"data-test":"session-cwd",className:"session-cwd text-xs text-muted-foreground truncate",children:n(a.cwd)}),s.jsxs("div",{"data-test":"session-name-container",className:`session-name-container ${c?"font-medium text-sm":"font-bold text-base"} break-words line-clamp-2 ${c?"":"mt-1"} flex items-center gap-2`,children:[s.jsx(ja,{sessionIds:[a.id]}),s.jsx(An,{session:a,segmentsToStrip:o,onNameUpdated:l})]}),a.firstMessage&&!c&&s.jsx("div",{"data-test":"session-first-message",className:"session-first-message text-sm text-muted-foreground truncate mt-1",children:a.firstMessage}),s.jsxs("div",{"data-test":"session-meta",className:`session-meta text-xs text-muted-foreground flex items-center gap-2 ${c?"mt-0.5":"mt-1"}`,children:[s.jsxs("span",{children:[a.messageCount," messages"]}),s.jsx("span",{children:"â€¢"}),s.jsx("span",{children:_d(a.lastModified)}),s.jsx("span",{children:"â€¢"}),s.jsx("span",{children:r(a.lastModified)})]})]})}const Ld=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.sessions)??[]},Md=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.loadingSessions)??!1};function _n({value:a,onChange:e,className:t="",placeholder:r="Select a session",label:n="Claude Session",showLabel:o=!0,multiSelect:l=!1}){const[c,d]=i.useState(!1),u=Te(Ld),h=Te(Md),m=Array.isArray(a)?a:a?[a]:[],g=i.useMemo(()=>[...u].sort((y,f)=>{const x=new Date(y.lastModified).getTime();return new Date(f.lastModified).getTime()-x}),[u]),b=g.filter(y=>m.includes(y.id)),w=y=>new Date(y).toLocaleDateString(),p=y=>y?y.split("/").slice(-2).join("/"):"No directory",v=y=>{if(l){const f=m.includes(y)?m.filter(x=>x!==y):[...m,y];e(f)}else e(y===a?"":y),d(!1)};return s.jsxs("div",{"data-test":"session-selector",className:`session-selector-container ${t}`,children:[o&&s.jsx(de,{"data-test":"session-selector-label",className:"session-selector-label",children:n}),s.jsxs($e,{open:c,onOpenChange:d,children:[s.jsx(He,{asChild:!0,children:s.jsxs(ae,{"data-test":"session-selector-trigger",variant:"outline",role:"combobox","aria-expanded":c,className:"session-selector-trigger w-full justify-between",disabled:h,children:[b.length>0?s.jsx("span",{className:"truncate",children:l?`${b.length} session${b.length>1?"s":""} selected`:b[0].customName||b[0].name}):s.jsx("span",{className:"text-muted-foreground",children:r}),s.jsx(Ir,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),s.jsx(Me,{"data-test":"session-selector-content",className:"session-selector-content w-[400px] p-0",children:s.jsxs(Rs,{children:[s.jsx(Ps,{"data-test":"session-selector-search",placeholder:"Search sessions..."}),s.jsxs(Is,{className:"max-h-[300px]",children:[s.jsx(Ds,{children:"No sessions found."}),s.jsxs(Gt,{children:[!l&&s.jsxs(kt,{"data-test":"session-selector-item-none",value:"none",onSelect:()=>{e(""),d(!1)},className:"session-selector-item-none",children:[s.jsx(We,{className:D("mr-2 h-4 w-4",m.length===0?"opacity-100":"opacity-0")}),"No Session"]}),g.map(y=>s.jsx(kt,{"data-test":`session-selector-item-${y.id}`,value:y.id,onSelect:()=>v(y.id),className:"session-selector-item p-0 cursor-pointer",children:s.jsxs("div",{className:"flex items-center w-full",children:[s.jsx(We,{className:D("mr-2 h-4 w-4 shrink-0",m.includes(y.id)?"opacity-100":"opacity-0")}),s.jsx("div",{className:"flex-1 min-w-0",children:s.jsx(Dn,{session:y,isSelected:m.includes(y.id),onClick:()=>{},formatDate:w,formatCwd:p,compact:!0})})]})},y.id))]}),g.length===0&&!h&&s.jsx("div",{"data-test":"session-selector-no-sessions",className:"no-sessions text-center py-4 text-sm text-muted-foreground",children:"No sessions available"}),h&&s.jsx("div",{"data-test":"session-selector-loading",className:"loading-sessions text-center py-4 text-sm text-muted-foreground",children:"Loading sessions..."})]})]})})]})]})}const Od=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.sessions)??[]};function $d({sessionIds:a,currentIndex:e,onIndexChange:t,disabled:r=!1,className:n=""}){const[o,l]=i.useState(!1),[c,d]=i.useState(""),u=Te(Od),h=i.useMemo(()=>a.map(f=>u.find(x=>x.id===f)).filter(f=>f!==void 0),[a,u]),m=h[e],g=h.filter(f=>(f.customName??f.name).toLowerCase().includes(c.toLowerCase())),b=f=>{t(f),l(!1),d("")},w=f=>{if(f.stopPropagation(),r||h.length===0)return;const x=e-1,C=x<0?h.length-1:x;t(C)},p=f=>{if(f.stopPropagation(),r||h.length===0)return;const x=e+1,C=x>=h.length?0:x;t(C)},v=f=>new Date(f).toLocaleDateString(),y=f=>f?f.split("/").slice(-2).join("/"):"No directory";return h.length===0?null:h.length===1?s.jsx(Ge,{variant:"outline",className:D("navigable-session-badge bg-purple-50 text-purple-800 border-purple-200",r&&"opacity-50 cursor-not-allowed",n),"data-test":"navigable-session-badge-single",children:(m==null?void 0:m.customName)??(m==null?void 0:m.name)??"Session"}):s.jsxs("div",{className:D("navigable-session-selector flex items-center gap-1",n),"data-test":"navigable-session-selector",children:[s.jsx("button",{onClick:w,disabled:r,className:D("chevron-left p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous session","data-test":"navigable-session-previous-button",children:s.jsx(Qt,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),s.jsxs($e,{open:o,onOpenChange:l,children:[s.jsx(He,{asChild:!0,children:s.jsxs(Ge,{variant:"outline",className:D("navigable-badge cursor-pointer hover:opacity-80 transition-opacity bg-purple-50 text-purple-800 border-purple-200",r&&"opacity-50 cursor-not-allowed"),onClick:f=>{f.stopPropagation(),r&&f.preventDefault()},"data-test":"navigable-session-badge",children:[(m==null?void 0:m.customName)??(m==null?void 0:m.name)??"Session"," (",e+1,"/",h.length,")"]})}),s.jsx(Me,{className:"popover-content w-[400px] p-2",align:"start","data-test":"navigable-session-popover-content",children:s.jsxs("div",{className:"selector-container space-y-2","data-test":"navigable-session-selector-container",children:[s.jsx(Be,{placeholder:"Search sessions...",value:c,onChange:f=>d(f.target.value),className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"navigable-session-search-input"}),s.jsx("div",{className:"sessions-list max-h-64 overflow-y-auto space-y-1","data-test":"navigable-session-list",children:g.length===0?s.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"navigable-session-empty-state",children:"No sessions found"}):g.map(f=>{const x=h.indexOf(f);return s.jsxs(ae,{variant:"ghost",className:D("session-item w-full justify-between h-auto px-2 py-1",x===e&&"bg-accent"),onClick:()=>b(x),"data-test":`navigable-session-item-${f.id}`,children:[s.jsx("div",{className:"flex-1 min-w-0",children:s.jsx(Dn,{session:f,isSelected:x===e,onClick:()=>{},formatDate:v,formatCwd:y,compact:!0})}),x===e&&s.jsx(We,{className:"check-icon h-4 w-4 ml-2 shrink-0","data-test":"navigable-session-check-icon"})]},f.id)})})]})})]}),s.jsx("button",{onClick:p,disabled:r,className:D("chevron-right p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Next session","data-test":"navigable-session-next-button",children:s.jsx(Et,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]})}function Ud(a,e={}){const{loadOnMount:t=!0,subscribeToSSE:r=!0,pageSize:n=50,messageType:o,onSessionDeleted:l}=e,[c,d]=i.useState([]),[u,h]=i.useState(null),[m,g]=i.useState(null),[b,w]=i.useState(!1),[p,v]=i.useState(null),[y,f]=i.useState(1),[x,C]=i.useState(""),[j,S]=i.useState(null),[N,T]=i.useState(!1),W=i.useRef(),L=i.useCallback(async(k=1,O=!1,E=!1)=>{var _,B,A;if(a)try{E||w(!0),C(""),S(null),T(!1);const I=o??((A=(B=(_=Y.getState().app)==null?void 0:_.claude)==null?void 0:B.ui)==null?void 0:A.messageFilters),R=await Ye.getSessionDetails(a,{page:k,pageSize:n,messageType:I});d(O?H=>[...R.messages,...H]:R.messages),h({id:a,name:R.name,customName:R.customName,cwd:R.cwd}),g(R.metadata),v(R.pagination??null),f(k)}catch(I){console.error("Failed to load session details:",I),d([]),h(null),g(null),v(null)}finally{E||w(!1)}},[a,n,o]),P=i.useCallback(async(k,O,E=!1)=>{if(a)try{w(!0),C(k),S(O),T(!0);const _=await Ye.searchSessionMessages(a,k,O);d(E?B=>[..._.results,...B]:_.results),v(_.pagination),f(_.pagination.page)}catch(_){E||d([]),console.error("Failed to search messages:",_)}finally{w(!1)}},[a]),U=i.useCallback(()=>{if(!(!a||!p||y>=p.totalPages))if(N&&x!==void 0){const k={...j,page:y+1};P(x,k,!0)}else L(y+1,!0)},[a,p,y,N,x,j,P,L]),$=i.useCallback(async()=>{a&&(N&&x!==void 0?await P(x,{...j,page:y}):await L(y))},[a,N,x,j,y,P,L]);return i.useEffect(()=>{d([]),h(null),g(null),v(null),f(1),C(""),S(null),T(!1),a&&t&&L(1)},[a,t]),i.useEffect(()=>{if(!a)return;const k=Y.selectSlice(O=>{var E,_,B;return(B=(_=(E=O.app)==null?void 0:E.claude)==null?void 0:_.ui)==null?void 0:B.messageFilters}).subscribe(O=>{if(JSON.stringify(W.current)!==JSON.stringify(O)&&(W.current=O,!o))if(N&&x!==void 0){const _={...j,messageType:O,page:1};P(x,_)}else L(1,!1,!0)});return()=>k.unsubscribe()},[a,o,N,x,j,P,L]),pa(k=>{k.type!=="batch-modified"&&("sessionId"in k&&k.sessionId!==a||(k.type==="modified"&&(async()=>{var O,E,_;if(a)try{const B=o??((_=(E=(O=Y.getState().app)==null?void 0:O.claude)==null?void 0:E.ui)==null?void 0:_.messageFilters),A=await Ye.getSessionDetails(a,{page:1,pageSize:n,messageType:B});d(I=>{const R=new Set(I.map(V=>V.id)),H=A.messages.filter(V=>!R.has(V.id));return H.length===0?I:[...I,...H]}),g(A.metadata)}catch(B){console.error("Failed to fetch new messages on SSE update:",B)}})(),k.type==="deleted"&&(d([]),h(null),g(null),v(null),l==null||l())))},k=>{console.error("SSE connection error in useSessionMessages:",k)},!!a&&r),{messages:c,sessionDetails:u,metadata:m,loading:b,pagination:p,currentPage:y,isSearchActive:N,loadSessionDetails:L,loadOlderMessages:U,searchMessages:P,refreshSession:$}}function Fd({value:a,options:e,onChange:t,placeholder:r="Search...",disabled:n=!1}){const[o,l]=i.useState(!1),[c,d]=i.useState(""),u=e.find(p=>p.value===a),h=e.findIndex(p=>p.value===a),m=e.filter(p=>p.label.toLowerCase().includes(c.toLowerCase())),g=p=>{t==null||t(p),l(!1),d("")},b=p=>{if(p.stopPropagation(),n)return;const v=h-1,y=v<0?e.length-1:v;t==null||t(e[y].value)},w=p=>{if(p.stopPropagation(),n)return;const v=h+1,y=v>=e.length?0:v;t==null||t(e[y].value)};return u?s.jsxs("div",{className:"navigable-select-container flex items-center gap-1",children:[s.jsx("button",{onClick:b,disabled:n,className:D("chevron-left p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous option",children:s.jsx(Qt,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),s.jsxs($e,{open:o,onOpenChange:l,children:[s.jsx(He,{asChild:!0,children:s.jsx(Ge,{variant:u.variant||"secondary",className:D("navigable-badge cursor-pointer hover:opacity-80 transition-opacity",u.className,n&&"opacity-50 cursor-not-allowed"),onClick:p=>{p.stopPropagation(),n&&p.preventDefault()},children:u.label})}),s.jsx(Me,{className:"popover-content w-64 p-2",align:"start",children:s.jsxs("div",{className:"selector-container space-y-2",children:[s.jsx(Be,{placeholder:r,value:c,onChange:p=>d(p.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),s.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:m.length===0?s.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):m.map(p=>s.jsxs(ae,{variant:"ghost",className:D("option-item w-full justify-between h-8 px-2",p.value===a&&"bg-accent"),onClick:()=>g(p.value),children:[s.jsx(Ge,{variant:p.variant||"secondary",className:D("text-xs",p.className),children:p.label}),p.value===a&&s.jsx(We,{className:"check-icon h-4 w-4"})]},p.value))})]})})]}),s.jsx("button",{onClick:w,disabled:n,className:D("chevron-right p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Next option",children:s.jsx(Et,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]}):null}function Ft(){var a;try{const e=(a=Y.getState().app)==null?void 0:a.kanban;return e?{spaces:e.spaces??[],activeSpaceId:e.activeSpaceId??"all",customPresets:e.customPresets??[],activePresetId:e.activePresetId??"all",currentFilters:e.currentFilters??aa,customCategories:e.customCategories??[]}:null}catch(e){return console.error("Failed to load persisted Kanban state:",e),null}}function ds(a){var e;try{const t=Y.getState();Y.updateState({app:{...t.app,kanban:{...(e=t.app)==null?void 0:e.kanban,...a}}})}catch(t){console.error("Failed to save persisted Kanban state:",t)}}function zd(){try{const a=Y.getState();Y.updateState({app:{...a.app,kanban:void 0}})}catch(a){console.error("Failed to clear persisted Kanban state:",a)}}const yp={id:!0,title:!0,description:!0,status:!0,priority:!0,category:!0,space:!0,claudeProjectPath:!0,dueDate:!0,createdAt:!0,updatedAt:!0,completedAt:!0,tags:!0,subtasks:!0},aa={searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[Ae.FREEZER,Ae.BACKLOG,Ae.SELECTED,Ae.DOING,Ae.DONE,Ae.ARCHIVE]};function Bd(a){return a&&a.version==="4.0"&&"todos"in a&&"spaces"in a}function Hd(a){return{version:"4.0",exportedAt:new Date().toISOString(),...a,loading:!1,error:void 0}}const Wd=[{value:xt.PERSONAL,label:"Personal",variant:"secondary",className:"bg-purple-100 text-purple-800 border-purple-200"},{value:xt.WORK,label:"Work",variant:"secondary",className:"bg-indigo-100 text-indigo-800 border-indigo-200"},{value:xt.SHOPPING,label:"Shopping",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:xt.HEALTH,label:"Health",variant:"secondary",className:"bg-pink-100 text-pink-800 border-pink-200"},{value:xt.OTHER,label:"Other",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}],Gs=["bg-red-100 text-red-800 border-red-200","bg-orange-100 text-orange-800 border-orange-200","bg-amber-100 text-amber-800 border-amber-200","bg-yellow-100 text-yellow-800 border-yellow-200","bg-lime-100 text-lime-800 border-lime-200","bg-emerald-100 text-emerald-800 border-emerald-200","bg-teal-100 text-teal-800 border-teal-200","bg-cyan-100 text-cyan-800 border-cyan-200","bg-sky-100 text-sky-800 border-sky-200","bg-blue-100 text-blue-800 border-blue-200","bg-violet-100 text-violet-800 border-violet-200","bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200","bg-rose-100 text-rose-800 border-rose-200"];class Gd{getAllCategories(){const e=this.getCustomCategories();return[...Wd,...e]}getCustomCategories(){try{const e=Ft();return(e==null?void 0:e.customCategories)??[]}catch(e){return console.error("[CategoryFacade] Failed to load custom categories:",e),[]}}createCategory(e){try{if(!e||!e.trim())return{success:!1,error:"Category label cannot be empty"};const t=e.trim();if(this.getAllCategories().find(g=>g.label.toLowerCase()===t.toLowerCase()))return{success:!1,error:`Category "${t}" already exists`};const o=`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,l=this.getCustomCategories(),c=l.map(g=>g.className||""),d=this.getRandomColorClass(c),u={id:o,value:o,label:t,variant:"secondary",className:d,isCustom:!0},h=Ft(),m=[...l,u];return ds({...h,spaces:(h==null?void 0:h.spaces)??[],activeSpaceId:(h==null?void 0:h.activeSpaceId)??"all",customPresets:(h==null?void 0:h.customPresets)??[],activePresetId:(h==null?void 0:h.activePresetId)??"all",currentFilters:(h==null?void 0:h.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:m}),{success:!0,category:u}}catch(t){return console.error("[CategoryFacade] Failed to create category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}deleteCategory(e){try{if(this.isDefaultCategory(e))return{success:!1,error:"Cannot delete default categories"};const t=this.getCustomCategories();if(!t.find(l=>l.id===e))return{success:!1,error:`Category with ID "${e}" not found`};const n=t.filter(l=>l.id!==e),o=Ft();return ds({...o,spaces:(o==null?void 0:o.spaces)??[],activeSpaceId:(o==null?void 0:o.activeSpaceId)??"all",customPresets:(o==null?void 0:o.customPresets)??[],activePresetId:(o==null?void 0:o.activePresetId)??"all",currentFilters:(o==null?void 0:o.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:n}),{success:!0,deletedId:e}}catch(t){return console.error("[CategoryFacade] Failed to delete category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}isDefaultCategory(e){return Object.values(xt).includes(e)}categoryExists(e){return this.getAllCategories().some(r=>r.value===e)}getCategoryByValue(e){return this.getAllCategories().find(r=>r.value===e)}clearAllCustomCategories(){try{const e=Ft();ds({...e,spaces:(e==null?void 0:e.spaces)??[],activeSpaceId:(e==null?void 0:e.activeSpaceId)??"all",customPresets:(e==null?void 0:e.customPresets)??[],activePresetId:(e==null?void 0:e.activePresetId)??"all",currentFilters:(e==null?void 0:e.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:[]}),console.info("[CategoryFacade] Cleared all custom categories")}catch(e){console.error("[CategoryFacade] Failed to clear custom categories:",e)}}getRandomColorClass(e){const t=Gs.filter(r=>!e.includes(r));return t.length===0?Gs[Math.floor(Math.random()*Gs.length)]:t[Math.floor(Math.random()*t.length)]}}const Rt=new Gd,Vd=a=>{var e,t;return((t=(e=a.app)==null?void 0:e.kanban)==null?void 0:t.customCategories)??[]};function qd({value:a,onChange:e,placeholder:t="Search categories...",disabled:r=!1}){const[n,o]=i.useState(!1),[l,c]=i.useState(""),d=Te(Vd),u=i.useMemo(()=>Rt.getAllCategories(),[d]),h=u.find(y=>y.value===a),m=u.filter(y=>y.label.toLowerCase().includes(l.toLowerCase())),g=i.useCallback(y=>{e==null||e(y),o(!1),c("")},[e]),b=i.useCallback(()=>{if(!l.trim())return;const y=Rt.createCategory(l.trim());y.success&&y.category?(g(y.category.value),c("")):console.error("[CategorySelector] Failed to create category:",y.error)},[l,g]),w=i.useCallback((y,f)=>{var C;if(y.stopPropagation(),Rt.isDefaultCategory(f))return;const x=Rt.deleteCategory(f);if(x.success){if(a===f){const j=Rt.getAllCategories();g(((C=j[0])==null?void 0:C.value)||"")}}else console.error("[CategorySelector] Failed to delete category:",x.error)},[a,g]),p=i.useCallback(y=>{o(y),y||c("")},[]);if(!h)return null;const v=l.trim()&&m.length===0;return s.jsxs($e,{open:n,onOpenChange:p,children:[s.jsx(He,{asChild:!0,children:s.jsx(Ge,{"data-test":"category-selector-trigger",variant:h.variant||"secondary",className:D("cursor-pointer hover:opacity-80 transition-opacity",h.className,r&&"opacity-50 cursor-not-allowed"),onClick:y=>{y.stopPropagation(),r&&y.preventDefault()},children:h.label})}),s.jsx(Me,{className:"popover-content w-64 p-2",align:"start","data-test":"category-selector-popover",children:s.jsxs("div",{className:"selector-container space-y-2","data-test":"category-selector-container",children:[s.jsx(Be,{"data-test":"category-search-input",placeholder:t,value:l,onChange:y=>c(y.target.value),onKeyDown:y=>{y.key==="Enter"&&v&&(y.preventDefault(),b())},className:"search-input h-8 text-sm",autoFocus:!0}),s.jsxs("div",{className:"options-list max-h-64 overflow-y-auto space-y-1","data-test":"category-options-list",children:[m.length===0&&!v&&s.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"category-empty-state",children:"No options found"}),v&&s.jsxs(ae,{"data-test":"category-create-button",variant:"ghost",className:"category-create-button w-full justify-start h-8 px-2 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:b,children:[s.jsx(hs,{className:"create-icon h-4 w-4 mr-2","data-test":"category-create-icon"}),'Create "',l,'"']}),m.map(y=>{const f=!Rt.isDefaultCategory(y.value);return s.jsxs("div",{"data-test":`category-option-wrapper-${y.value}`,className:D("option-item-wrapper flex items-center gap-1",y.value===a&&"bg-accent rounded"),children:[s.jsxs(ae,{"data-test":`category-option-button-${y.value}`,variant:"ghost",className:D("option-item flex-1 justify-between h-8 px-2"),onClick:()=>g(y.value),children:[s.jsx(Ge,{"data-test":`category-option-badge-${y.value}`,variant:y.variant||"secondary",className:D("text-xs",y.className),children:y.label}),y.value===a&&s.jsx(We,{className:"check-icon h-4 w-4","data-test":"category-selected-check"})]}),f&&s.jsx(ae,{"data-test":`category-delete-button-${y.value}`,variant:"ghost",size:"icon",className:"category-delete-button h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50",onClick:x=>w(x,y.value),title:"Delete category",children:s.jsx(Nt,{className:"delete-icon h-4 w-4","data-test":"category-delete-icon"})})]},y.value)})]})]})})]})}function Cs(){return"xxxxxxxx".replace(/[xy]/g,function(a){const e=Math.random()*16|0;return(a==="x"?e:e&3|8).toString(16)})}class wp{constructor(e){X(this,"items",[]);this.initialItems=e,e&&(e.forEach(t=>{t.id===void 0&&(t.id=Cs())}),this.items=e)}create(e,t={}){const r={id:Cs(),created:new Date().toISOString(),...e},{allowDuplicate:n,uniqueByKey:o}=t;if(n)return this.items.push(r),r;let l=-1;if(o&&(l=this.items.findIndex(h=>h[o]===r[o])),l!==-1)return;const d=this.items.findIndex(h=>h.id===r.id);return d!==-1?(this.items[d]=r,r):(this.items.push(r),r)}insertAt(e,t){const r=structuredClone(this.items);return r.splice(e,0,...t),r}batchCreate(e){this.items.push(...e)}readAll(e=!0){return e?structuredClone(this.items):this.items}readBetween(e,t){const r=[];for(let n=e;n<=t;n++){const o=this.items[n];r.push(o)}return r}readById(e){return this.items.find(t=>t.id===e)}readByKey(e,t){return this.items.find(r=>r[e]===t)}readFirst(){return this.items.length===0?void 0:this.items[0]}readLast(){return this.items.length===0?void 0:this.items[this.items.length-1]}update(e){const t=this.items.findIndex(r=>r.id===e.id);t!==-1&&(this.items[t]=e)}batchUpdate(e){e.forEach(t=>{const r=this.items.findIndex(n=>n.id===t.id);r!==-1&&(this.items[r]=t)})}delete(e){console.log("[CRUDService.ts,123] this.items: ",this.items);const t=this.items.findIndex(r=>r.id===e);console.log("[CRUDService.ts,123] indexToDelete: ",t),t!==-1&&this.items.splice(t,1)}deleteByKey(e,t){this.items=this.items.filter(r=>r[e]!==t)}deleteBetween(e,t){const r=this.items.slice(0,e),n=this.items.slice(t+1,this.items.length);return[...r,...n]}batchDelete(e){this.items=this.items.filter(t=>!e.includes(t.id))}getPreviousItem(e){const r=this.getCurrentItemIndex(e)-1,n=Math.max(r,0);return this.items[n]}getNextItem(e){const r=this.getCurrentItemIndex(e)+1,n=this.count()-1,o=Math.min(r,n);return this.items[o]}getCurrentItemIndex(e){return this.findIndexByKey("id",e)}count(){return this.items.length}clear(){this.items=[]}filterByKey(e,t){return this.items.filter(r=>r[e]===t)}findByKey(e,t){return this.items.find(r=>r[e]===t)}findIndexByKey(e,t){return this.items.findIndex(r=>r[e]===t)}replace(e){e&&(this.items=e)}replaceOne(e,t){console.log(">>>> _ >>>> ~ file: CRUDService.ts:203 ~ replace:",t);const r=structuredClone(this.items);return r[e]=t,r}sort(e,t=!0){this.items.sort((r,n)=>{const o=r[e],l=n[e];return o===l?0:t?o<l?-1:1:o>l?-1:1})}}const Kd="TodoDB",Jd=2,Oe="todos";class Qd{constructor(){X(this,"db",null)}async init(){return new Promise((e,t)=>{const r=indexedDB.open(Kd,Jd);r.onerror=()=>{t(new Error("Failed to open IndexedDB"))},r.onsuccess=()=>{this.db=r.result,e()},r.onupgradeneeded=n=>{const o=n.target.result,l=n.target.transaction,c=n.oldVersion;if(!o.objectStoreNames.contains(Oe)){const d=o.createObjectStore(Oe,{keyPath:"id.value"});d.createIndex("status","status",{unique:!1}),d.createIndex("priority","priority",{unique:!1}),d.createIndex("category","category",{unique:!1}),d.createIndex("createdAt","createdAt.value",{unique:!1}),d.createIndex("dueDate","dueDate.value",{unique:!1}),d.createIndex("sortOrder","sortOrder",{unique:!1})}if(c<2){const d=l.objectStore(Oe);d.indexNames.contains("sortOrder")||d.createIndex("sortOrder","sortOrder",{unique:!1});const u=d.getAll();u.onsuccess=()=>{const h=u.result,m={};h.forEach(g=>{const b=g.status||"backlog";m[b]||(m[b]=[]),m[b].push(g)}),Object.keys(m).forEach(g=>{m[g].forEach((b,w)=>{b.sortOrder===void 0&&(b.sortOrder=w,d.put(b))})})}}}})}async getAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([Oe],"readonly").objectStore(Oe).getAll();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to get todos"))}})}async getById(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,r)=>{const l=this.db.transaction([Oe],"readonly").objectStore(Oe).get(e);l.onsuccess=()=>{t(l.result)},l.onerror=()=>{r(new Error("Failed to get todo"))}})}async add(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,r)=>{const l=this.db.transaction([Oe],"readwrite").objectStore(Oe).add(e);l.onsuccess=()=>{t()},l.onerror=()=>{r(new Error("Failed to add todo"))}})}async update(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,r)=>{const l=this.db.transaction([Oe],"readwrite").objectStore(Oe).put(e);l.onsuccess=()=>{t()},l.onerror=()=>{r(new Error("Failed to update todo"))}})}async delete(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,r)=>{const l=this.db.transaction([Oe],"readwrite").objectStore(Oe).delete(e);l.onsuccess=()=>{t()},l.onerror=()=>{r(new Error("Failed to delete todo"))}})}async clear(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([Oe],"readwrite").objectStore(Oe).clear();o.onsuccess=()=>{e()},o.onerror=()=>{t(new Error("Failed to clear todos"))}})}async count(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([Oe],"readonly").objectStore(Oe).count();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to count todos"))}})}}const ze=new Qd;function Yd(a){return a&&typeof a=="object"&&("claudeProject"in a||"sessionIds"in a)}class Xd{constructor(){X(this,"initialized",!1)}async init(){if(this.initialized)return;await ze.init(),this.initialized=!0,await ze.count()===0&&await this.seedMockData()}createTodoId(e){return{value:e}}createTimestamp(e){return{value:e??new Date}}async createTodo(e){await this.init();const t=e.status??Ae.BACKLOG;let r=e.sortOrder;if(r===void 0){const l=(await ze.getAll()).filter(d=>d.status===t);r=(l.length>0?Math.max(...l.map(d=>d.sortOrder??0)):-1)+1}const n={id:this.createTodoId(Cs()),title:e.title,description:e.description,status:t,priority:e.priority??ht.MEDIUM,category:e.category??xt.PERSONAL,space:e.space,sortOrder:r,dueDate:e.dueDate?this.createTimestamp(e.dueDate):void 0,createdAt:this.createTimestamp(),updatedAt:this.createTimestamp(),tags:e.tags??[],subtasks:[],customProps:e.customProps};return await ze.add(n),n}async getTodo(e){await this.init();const t=await ze.getById(e.value);if(!t)throw new Error(`Todo with id ${e.value} not found`);return t}async getAllTodos(e){await this.init();let t=await ze.getAll();if(e!=null&&e.filters){const{status:r,priority:n,category:o,space:l,claudeProjectPath:c,tags:d,searchQuery:u}=e.filters;if(r&&r.length>0&&(t=t.filter(h=>r.includes(h.status))),n&&n.length>0&&(t=t.filter(h=>n.includes(h.priority))),o&&o.length>0&&(t=t.filter(h=>o.includes(h.category))),l&&l.length>0&&(t=t.filter(h=>h.space&&l.includes(h.space))),c&&c.length>0&&(t=t.filter(h=>{if(Yd(h.customProps))return h.customProps.claudeProjectPath&&c.includes(h.customProps.claudeProjectPath)})),d&&d.length>0&&(t=t.filter(h=>d.some(m=>h.tags.includes(m)))),u){const h=u.toLowerCase();t=t.filter(m=>{var g;return m.title.toLowerCase().includes(h)||((g=m.description)==null?void 0:g.toLowerCase().includes(h))})}}if(e!=null&&e.sort){const{field:r,direction:n}=e.sort;t.sort((o,l)=>{const c=o[r],d=l[r];if(c==null||d===void 0||d===null)return 0;const u=c<d?-1:c>d?1:0;return n==="asc"?u:-u})}else t.sort((r,n)=>(r.sortOrder??0)-(n.sortOrder??0));if((e==null?void 0:e.offset)!==void 0||(e==null?void 0:e.limit)!==void 0){const r=e.offset??0,n=e.limit??t.length;t=t.slice(r,r+n)}return t}async updateTodo(e,t){await this.init();const r=await this.getTodo(e),n={...r,...t,dueDate:t.dueDate?this.createTimestamp(t.dueDate instanceof Date?t.dueDate:new Date(t.dueDate.value)):r.dueDate,updatedAt:this.createTimestamp(),customProps:t.customProps?{...r.customProps,...t.customProps}:r.customProps};return await ze.update(n),n}async deleteTodo(e){await this.init(),await ze.delete(e.value)}async startTodo(e){return this.updateTodo(e,{status:Ae.DOING})}async completeTodo(e){const t=await this.updateTodo(e,{status:Ae.DONE});return t.completedAt=this.createTimestamp(),await ze.update(t),t}async cancelTodo(e){return this.updateTodo(e,{status:Ae.ARCHIVE})}async addSubtask(e,t){await this.init();const r=await this.getTodo(e),n={id:this.createTodoId(Cs()),title:t.title,isCompleted:!1,createdAt:this.createTimestamp()};return r.subtasks.push(n),r.updatedAt=this.createTimestamp(),await ze.update(r),r}async updateSubtask(e,t,r){await this.init();const n=await this.getTodo(e),o=n.subtasks.find(l=>l.id.value===t.value);if(!o)throw new Error(`Subtask with id ${t.value} not found`);return r.title!==void 0&&(o.title=r.title),r.isCompleted!==void 0&&(o.isCompleted=r.isCompleted),n.updatedAt=this.createTimestamp(),await ze.update(n),n}async toggleSubtask(e,t){await this.init();const r=await this.getTodo(e),n=r.subtasks.find(o=>o.id.value===t.value);if(!n)throw new Error(`Subtask with id ${t.value} not found`);return n.isCompleted=!n.isCompleted,r.updatedAt=this.createTimestamp(),await ze.update(r),r}async removeSubtask(e,t){await this.init();const r=await this.getTodo(e);return r.subtasks=r.subtasks.filter(n=>n.id.value!==t.value),r.updatedAt=this.createTimestamp(),await ze.update(r),r}async bulkUpdateStatus(e,t){await this.init(),await Promise.all(e.map(r=>this.updateTodo(r,{status:t})))}async bulkDelete(e){await this.init(),await Promise.all(e.map(t=>this.deleteTodo(t)))}async seedMockData(){const e=[];for(const r of e){const n=await this.createTodo(r);r.title==="Complete project documentation"&&(await this.addSubtask(n.id,{title:"Write API documentation"}),await this.addSubtask(n.id,{title:"Create usage examples"}),await this.addSubtask(n.id,{title:"Add screenshots"})),r.title==="Buy groceries"&&(await this.addSubtask(n.id,{title:"Check pantry inventory"}),await this.addSubtask(n.id,{title:"Make shopping list"}))}const t=await this.getAllTodos();t.length>0&&await this.startTodo(t[0].id),t.length>3&&await this.completeTodo(t[3].id)}async clearAllTodos(){await this.init(),await ze.clear()}async exportTodos(){await this.init();const e=await this.getAllTodos(),t=Ft(),r={todos:e,spaces:(t==null?void 0:t.spaces)??[],activeSpaceId:(t==null?void 0:t.activeSpaceId)??"all",customPresets:(t==null?void 0:t.customPresets)??[],activePresetId:(t==null?void 0:t.activePresetId)??"all",currentFilters:(t==null?void 0:t.currentFilters)??aa,customCategories:(t==null?void 0:t.customCategories)??[],loading:!1},n={...r,todos:r.todos.map(l=>({...l,createdAt:{value:l.createdAt.value.toISOString()},updatedAt:{value:l.updatedAt.value.toISOString()},completedAt:l.completedAt?{value:l.completedAt.value.toISOString()}:void 0,dueDate:l.dueDate?{value:l.dueDate.value.toISOString()}:void 0,subtasks:l.subtasks.map(c=>({...c,createdAt:{value:c.createdAt.value.toISOString()}}))}))},o=Hd(n);return JSON.stringify(o,null,2)}async importTodos(e,t){var u,h,m;await this.init();const r=[];let n=0,o=0,l=0,c=0,d=0;try{const g=JSON.parse(e);if(!Bd(g))throw new Error("Invalid format: Expected KanbanExportData v4.0 format");const b=g;t!=null&&t.replace&&(await this.clearAllTodos(),zd());const w=b.todos??[];for(const p of w)try{const v={...p,createdAt:{value:new Date(p.createdAt.value)},updatedAt:{value:new Date(p.updatedAt.value)},completedAt:p.completedAt?{value:new Date(p.completedAt.value)}:void 0,dueDate:p.dueDate?{value:new Date(p.dueDate.value)}:void 0,subtasks:(p.subtasks??[]).map(f=>({...f,createdAt:{value:new Date(f.createdAt.value)}}))};await ze.getById(v.id.value)&&!(t!=null&&t.replace)?o++:(await ze.add(v),n++)}catch(v){r.push(`Failed to import todo "${p.title}": ${v instanceof Error?v.message:"Unknown error"}`),o++}try{const p={spaces:b.spaces??[],activeSpaceId:b.activeSpaceId??"all",customPresets:b.customPresets??[],activePresetId:b.activePresetId??"all",currentFilters:b.currentFilters??aa,customCategories:b.customCategories??[]};ds(p),c=((u=b.spaces)==null?void 0:u.length)??0,l=((h=b.customPresets)==null?void 0:h.length)??0,d=((m=b.customCategories)==null?void 0:m.length)??0}catch(p){r.push(`Failed to save persisted state: ${p instanceof Error?p.message:"Unknown error"}`)}return{imported:n,skipped:o,errors:r,presetsImported:l,spacesImported:c,categoriesImported:d}}catch(g){throw new Error(`Failed to parse JSON: ${g instanceof Error?g.message:"Unknown error"}`)}}}const Pe=new Xd;class Zd{async createTicket(e,t){await Pe.createTodo({...t,status:e})}}class eu{async createSessionForTodo(e,t){const r=await Ye.createSession({message:t.message,cwd:t.projectPath,projectId:t.projectPath,options:{outputFormat:t.outputFormat,permissionMode:t.permissionMode}});return r.success&&r.sessionId&&await this.linkSessionToTodo(e,r.sessionId),r}async linkSessionToTodo(e,t,r={mode:"append"}){var c;const n=await Pe.getTodo(e),o=((c=n.customProps)==null?void 0:c.sessionIds)??[],l=r.mode==="replace"?[t]:[...o,t];await Pe.updateTodo(e,{customProps:{...n.customProps,sessionIds:l}})}async unlinkSessionFromTodo(e,t){var l;const r=await Pe.getTodo(e),o=(((l=r.customProps)==null?void 0:l.sessionIds)??[]).filter(c=>c!==t);await Pe.updateTodo(e,{customProps:{...r.customProps,sessionIds:o}})}async getSessionsForTodo(e){var r;return((r=(await Pe.getTodo(e)).customProps)==null?void 0:r.sessionIds)??[]}async hasLinkedSessions(e){return(await this.getSessionsForTodo(e)).length>0}buildInitialMessageFromTodo(e){const t=[];if(t.push(`# ${e.title}
`),e.description&&(t.push("## Description"),t.push(e.description),t.push("")),e.dueDate){const r=new Date(e.dueDate.value);t.push(`**Due Date:** ${r.toLocaleDateString()}`),t.push("")}return e.subtasks&&e.subtasks.length>0&&(t.push("## Subtasks"),e.subtasks.forEach(r=>{const n=r.isCompleted?"[x]":"[ ]";t.push(`${n} ${r.title}`)}),t.push("")),e.tags&&e.tags.length>0&&(t.push(`**Tags:** ${e.tags.join(", ")}`),t.push("")),t.push("---"),t.push("I permit and approve all file changes in this session to help complete this task."),t.join(`
`)}async createSessionWithTodoContext(e,t,r={}){var d;const n=await Pe.getTodo(e),o=this.buildInitialMessageFromTodo(n),l=t?`${o}

---

${t}`:o,c=r.projectPath??((d=n.customProps)==null?void 0:d.claudeProjectPath);return this.createSessionForTodo(e,{message:l,projectPath:c,outputFormat:r.outputFormat,permissionMode:r.permissionMode})}async setProjectPath(e,t){const r=await Pe.getTodo(e);await Pe.updateTodo(e,{customProps:{...r.customProps,claudeProjectPath:t}})}async getProjectPath(e){var r;return(r=(await Pe.getTodo(e)).customProps)==null?void 0:r.claudeProjectPath}}class tu{constructor(){X(this,"column");X(this,"claude");this.column=new Zd,this.claude=new eu}async createTestFailureTicket(e){const t=this.buildFailureDescription(e),r=`[Test Failure] ${e.scenario}`;await this.column.createTicket(Ae.BACKLOG,{title:r,description:t,priority:ht.HIGH,category:xt.WORK,tags:["test-failure","bdd",e.feature.toLowerCase().replace(/\s+/g,"-")],customProps:{testFailureId:e.id,feature:e.feature,scenario:e.scenario,failedStep:e.failedStep,stepType:e.stepType,stepIndex:e.stepIndex,timestamp:e.timestamp}})}async sendTestFailureToClaude(e,t){const r=this.buildClaudeMessage(e);return await Ye.createSession({message:r,cwd:t==null?void 0:t.projectPath,projectId:t==null?void 0:t.projectPath,options:{outputFormat:t==null?void 0:t.outputFormat,permissionMode:t==null?void 0:t.permissionMode}})}buildClaudeMessage(e){const t=[];return t.push(`I have a BDD test failure that needs debugging help.
`),t.push("## Test Context"),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Step Type:** ${e.stepType||"Unknown"}`),t.push(`**Step Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Step Text:** \`${e.failedStep}\`
`)),t.push("## Error Details"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
## Request`),t.push("Please help me understand:"),t.push("1. What caused this test failure?"),t.push("2. What is the root cause of the error?"),t.push("3. How can I fix this issue?"),t.push("4. Are there any related issues I should be aware of?"),t.join(`
`)}buildFailureDescription(e){const t=[];return t.push(`# Test Failure Report
`),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Type:** ${e.stepType||"Unknown"}`),t.push(`**Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Text:** ${e.failedStep}
`)),t.push("## Error"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
---`),t.push("**Next Steps:**"),t.push("1. Review the error and failed step"),t.push("2. Reproduce the issue locally"),t.push("3. Send to Claude for analysis (Future: Phase 3)"),t.join(`
`)}}const Ln=new tu;function su(a,e=getComputedStyle(document.body).font){if(!a)return 0;const r=document.createElement("canvas").getContext("2d");return r?(r.font=e,r.measureText(a).width):0}function Sp(a,e=getComputedStyle(document.body).font){return a?a.split(/\n|&nbsp;/).map(n=>su(n,e)).reduce((n,o)=>Math.max(n,o),0):0}function au(a,e=getComputedStyle(document.body).font){const r=document.createElement("canvas").getContext("2d");if(!r)return 0;r.font=e;const n=r.measureText(a),o=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent;if(o&&o>0)return o;const l=r.measureText("M");return l.actualBoundingBoxAscent+l.actualBoundingBoxDescent||parseInt(e,10)*1.2}const ru=10;function nu(a){const e=a.trimStart();return e.startsWith("### ")?1.2:e.startsWith("## ")?1.35:e.startsWith("# ")?1.5:1}function ra(a,e,t=getComputedStyle(document.body).font,r){if(!a)return 0;const o=document.createElement("canvas").getContext("2d");if(!o)return 0;o.font=t;const l=(r??au("M",t))||parseInt(t,10)*1.2;if(l===0)return console.warn("measureWrappedTextHeight: Could not determine line height. Using fallback."),a.split(`
`).length*16;const c=a.split(`
`);let d=0;for(const u of c){if(u.trim()===""){d+=l;continue}const h=nu(u),m=l*h,g=u.split(" ");let b="",w=1;for(let p=0;p<g.length;p++){const v=g[p],y=b+(b?" ":"")+v;o.measureText(y).width>e&&b!==""?(w++,b=v,o.measureText(v).width>e):b=y}d+=w*m}return d+ru}function jp(a,e){if(!a)return 0;const{containerWidth:t,textarea:r}=e,n=r||document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(!n)return ra(a,t);const o=window.getComputedStyle(n),l=o.fontSize,c=o.fontFamily,u=`${o.fontWeight} ${l} ${c}`;let h;const m=o.lineHeight;if(m&&m!=="normal"){const v=parseFloat(m);isNaN(v)||(h=v)}const g=parseFloat(o.paddingLeft)||0,b=parseFloat(o.paddingRight)||0,w=g+b,p=t-w;return ra(a,p,u,h)}const ou=[{value:ht.LOW,label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:ht.MEDIUM,label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:ht.HIGH,label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:ht.URGENT,label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],iu=[{value:Ae.FREEZER,label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:Ae.BACKLOG,label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Ae.SELECTED,label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:Ae.DOING,label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Ae.DONE,label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Ae.ARCHIVE,label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],cu=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:r.projects)??[]},lu=a=>{var e,t,r;return((r=(t=(e=a.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:r.loadingProjects)??!1};function du({todo:a,mode:e,onUpdate:t,onClose:r,activeSessionId:n,isProcessingAll:o=!1,currentProcessingSubtaskId:l=null,onProcessAll:c,onStopProcessing:d}){const[u,h]=i.useState(""),[m,g]=i.useState(""),[b,w]=i.useState(""),[p,v]=i.useState(""),[y,f]=i.useState(""),[x,C]=i.useState(Ae.BACKLOG),[j,S]=i.useState(ht.MEDIUM),[N,T]=i.useState(""),[W,L]=i.useState([]),[P,U]=i.useState([]),[$,k]=i.useState([]),[O,E]=i.useState(void 0),[_,B]=i.useState(0),[A,I]=i.useState({}),R=i.useRef(null),H=i.useRef({}),V=Te(cu),K=Te(lu);i.useEffect(()=>{var M,z;a?(h(a.title),g(a.description??""),w(a.dueDate?new Date(a.dueDate.value).toISOString().split("T")[0]:""),C(a.status),S(a.priority),T(a.category),L(a.tags),U(a.subtasks),k(((M=a.customProps)==null?void 0:M.sessionIds)??[]),E((z=a.customProps)==null?void 0:z.claudeProjectPath)):(h(""),g(""),w(""),C(Ae.BACKLOG),S(ht.MEDIUM),T(""),L([]),U([]),k([]),E(void 0))},[a]);const F=i.useCallback((M,z)=>{const se=H.current[M],le=se==null?void 0:se.getTextArea();if(!le||!z)return 1;const me=le.offsetWidth;if(me===0)return 1;const Ie=window.getComputedStyle(le),nt=Ie.font,De=Ie.lineHeight,Ne=De==="normal"?parseFloat(Ie.fontSize)*1.2:parseFloat(De),Xe=ra(z,me,nt,Ne);return Math.max(1,Math.ceil(Xe/Ne))},[]);i.useEffect(()=>{const M={};P.forEach(z=>{const se=F(z.id.value,z.title);M[z.id.value]=se}),I(M)},[P,F]),i.useEffect(()=>{var z;const M=(z=R.current)==null?void 0:z.getTextArea();if(M){const se=()=>{const me=M.offsetWidth;B(me)};se();const le=new ResizeObserver(se);return le.observe(M),()=>{le.disconnect()}}},[]);const Q=i.useCallback(async M=>{if(e==="edit"&&a)try{await Pe.updateTodo(a.id,M),t()}catch(z){console.error("Failed to update todo:",z)}},[e,a,t]),oe=i.useCallback(async()=>{if(e==="create"&&u.trim())try{await Ln.column.createTicket(x,{title:u.trim(),description:m.trim()||void 0,priority:j,category:N||void 0,tags:W,dueDate:b?new Date(b):void 0,customProps:{sessionIds:$,claudeProject:O}}),t(),r()}catch(M){console.error("Failed to create todo:",M)}},[e,u,m,x,j,N,W,b,$,O,t,r]);i.useCallback(()=>{e==="edit"&&a&&u!==a.title&&u.trim()&&Q({title:u})},[e,a,u,Q]);const q=i.useCallback(()=>{e==="edit"&&a&&m!==(a.description??"")&&Q({description:m})},[e,a,m,Q]),J=i.useCallback(M=>{w(M),e==="edit"&&Q(M?{dueDate:{value:new Date(M)}}:{dueDate:void 0})},[e,Q]),re=i.useCallback(()=>{const M=p.trim();if(M&&!W.includes(M)){const z=[...W,M];L(z),e==="edit"&&Q({tags:z}),v("")}},[p,W,e,Q]),Z=i.useCallback(M=>{const z=W.filter(se=>se!==M);L(z),e==="edit"&&Q({tags:z})},[W,e,Q]),ce=i.useCallback(async()=>{if(y.trim())if(e==="edit"&&a)try{await Pe.addSubtask(a.id,{title:y.trim()}),f(""),t()}catch(M){console.error("Failed to add subtask:",M)}else U([...P,{id:{value:`temp-${Date.now()}`},title:y.trim(),isCompleted:!1}]),f("")},[e,a,y,P,t]),ie=i.useCallback(async M=>{if(e==="edit"&&a)try{await Pe.toggleSubtask(a.id,M),t()}catch(z){console.error("Failed to toggle subtask:",z)}else U(P.map(z=>z.id.value===M.value?{...z,isCompleted:!z.isCompleted}:z))},[e,a,P,t]),ue=i.useCallback(async M=>{if(e==="edit"&&a)try{await Pe.removeSubtask(a.id,M),t()}catch(z){console.error("Failed to remove subtask:",z)}else U(P.filter(z=>z.id.value!==M.value))},[e,a,P,t]),ve=i.useCallback(async()=>{if(m.trim())try{const M=m.split(`
`),z=[];for(const se of M){const le=se.trim(),Ie=/^-\s*\[([ x])\]\s*(.+)$/i.exec(le);if(Ie){const Ne=Ie[1].toLowerCase()==="x",Xe=Ie[2].trim();Xe&&z.push({title:Xe,isCompleted:Ne});continue}const De=/^-\s+(.+)$/.exec(le);if(De){const Ne=De[1].trim();Ne&&z.push({title:Ne,isCompleted:!1})}}if(e==="edit"&&a){for(const se of z){const le=await Pe.addSubtask(a.id,{title:se.title});if(se.isCompleted){const me=le.subtasks[le.subtasks.length-1];me&&await Pe.toggleSubtask(a.id,me.id)}}t()}else{const se=z.map((le,me)=>({id:{value:`temp-${Date.now()}-${me}`},title:le.title,isCompleted:le.isCompleted}));U([...P,...se])}}catch(M){console.error("Failed to split tasks:",M)}},[e,a,m,P,t]),ne=i.useCallback(M=>{C(M),e==="edit"&&Q({status:M})},[e,Q]),G=i.useCallback(M=>{S(M),e==="edit"&&Q({priority:M})},[e,Q]),te=i.useCallback(M=>{T(M),e==="edit"&&Q({category:M})},[e,Q]),fe=i.useCallback(M=>{const z=Array.isArray(M)?M:[M];k(z),e==="edit"&&Q({customProps:{sessionIds:z}})},[e,Q]),Ce=i.useCallback(M=>{var se,le,me;E(M);const z=Y.getState();Y.updateState({app:{...z.app,claude:{...(se=z.app)==null?void 0:se.claude,ui:{...(me=(le=z.app)==null?void 0:le.claude)==null?void 0:me.ui,selectedProjectPath:M}}}}),e==="edit"&&Q({customProps:{claudeProjectPath:M}})},[e,Q]),he=i.useMemo(()=>V.map(M=>({value:M.path,label:M.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[V]),xe=i.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...he],[he]);i.useCallback(M=>{h(M.target.value)},[]);const ge=i.useCallback(M=>{g(M.target.value)},[]),be=i.useCallback(M=>{M.key==="Escape"&&M.currentTarget.blur()},[]),je=i.useCallback(M=>{v(M.target.value)},[]),we=i.useCallback(M=>{M.key==="Enter"&&(M.preventDefault(),re())},[re]),Se=i.useCallback(M=>{f(M.target.value)},[]),ke=i.useCallback(M=>{M.key==="Enter"&&!M.shiftKey&&(M.preventDefault(),ce())},[ce]);return s.jsxs("div",{className:"details-grid grid grid-cols-4 gap-6","data-test":"todo-details-form",children:[s.jsxs("div",{className:"left-column col-span-3 space-y-6","data-test":"todo-details-left-column",children:[s.jsxs("div",{className:"form-field-description space-y-2","data-test":"todo-details-description-field",children:[s.jsx(de,{htmlFor:"description","data-test":"todo-details-description-label",children:"Description"}),s.jsx(St,{value:m,onChange:ge,onBlur:q,onKeyDown:be,placeholder:"Enter description...",rows:12,className:"description-textarea min-h-[100px] w-full","data-test":"todo-details-description-textarea"}),s.jsxs("div",{className:"description-actions mt-2 flex gap-2 justify-between","data-test":"todo-details-description-actions",children:[s.jsx(ae,{onClick:ve,size:"sm",variant:"outline",className:"split-tasks-button",disabled:!m.trim(),"data-test":"todo-details-split-tasks-button",children:"Split Tasks"}),e==="edit"?s.jsx(ae,{onClick:q,size:"sm",variant:"outline",className:"save-description-button","data-test":"todo-details-save-description-button",children:"Save"}):s.jsx(ae,{onClick:oe,size:"sm",variant:"default",className:"create-todo-button",disabled:!u.trim(),"data-test":"todo-details-create-button",children:"Create Todo"})]})]}),s.jsxs("div",{className:"form-field-subtasks space-y-2","data-test":"todo-details-subtasks-field",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(de,{"data-test":"todo-details-subtasks-label",children:"Subtasks"}),e==="edit"&&n&&P.some(M=>!M.isCompleted)&&(c??d)&&s.jsx(ae,{size:"sm",variant:o?"destructive":"outline",onClick:o?d:c,className:"process-all-button","data-test":"todo-details-process-all-button",children:o?s.jsxs(s.Fragment,{children:[s.jsx(Qe,{className:"w-3 h-3 mr-1"}),"Stop"]}):"Process All"})]}),s.jsxs("div",{className:"subtasks-container space-y-2","data-test":"todo-details-subtasks-container",children:[s.jsx("div",{className:"subtasks-list space-y-2","data-test":"todo-details-subtasks-list",children:P.map(M=>s.jsxs("div",{className:"subtask-item flex items-center gap-2 p-2 rounded border","data-test":`todo-details-subtask-item-${M.id.value}`,children:[s.jsx("input",{type:"checkbox",checked:M.isCompleted,onChange:()=>ie(M.id),className:"subtask-checkbox",disabled:o,"data-test":`todo-details-subtask-checkbox-${M.id.value}`}),s.jsx("div",{className:D("subtask-title-wrapper flex-1",M.isCompleted&&"line-through text-gray-500"),children:s.jsx(St,{ref:z=>{H.current[M.id.value]=z},value:M.title,onChange:async z=>{const se=z.target.value,le=F(M.id.value,se);if(I(me=>({...me,[M.id.value]:le})),e==="edit"&&a)try{await Pe.updateSubtask(a.id,M.id,{title:se}),t()}catch(me){console.error("Failed to update subtask title:",me)}else U(P.map(me=>me.id.value===M.id.value?{...me,title:se}:me))},placeholder:"Edit subtask...",className:"subtask-title-textarea resize-none w-full",rows:A[M.id.value]||1,"data-test":`todo-details-subtask-textarea-${M.id.value}`})}),l===M.id.value&&s.jsx(Ts,{className:"w-4 h-4 animate-spin text-blue-500","data-test":`todo-details-subtask-loading-${M.id.value}`}),e==="edit"&&n&&s.jsx(In,{sessionId:n,message:M.title,className:"subtask-send h-7 w-7 hover:text-blue-500",disabled:o,"data-test":`todo-details-subtask-send-${M.id.value}`}),s.jsx("button",{onClick:()=>ue(M.id),className:"subtask-remove hover:text-red-500",disabled:o,"data-test":`todo-details-subtask-remove-${M.id.value}`,children:s.jsx(Qe,{className:"w-4 h-4"})})]},M.id.value))}),s.jsxs("div",{className:"subtask-input flex gap-2","data-test":"todo-details-subtask-input-container",children:[s.jsx(St,{ref:R,value:y,onChange:Se,onKeyDown:ke,placeholder:"Add a subtask...",rows:1,className:"flex-1","data-test":"todo-details-subtask-input"}),s.jsx(ae,{onClick:()=>void ce(),size:"sm",className:"subtask-add-button","data-test":"todo-details-subtask-add-button",children:s.jsx(hs,{className:"w-4 h-4"})})]})]})]}),e==="edit"&&$.length>0&&s.jsxs("div",{className:"form-field-sessions space-y-2","data-test":"todo-details-sessions-field",children:[s.jsxs(de,{"data-test":"todo-details-sessions-label",children:["Claude Session IDs (",$.length,")"]}),$.map((M,z)=>s.jsx(Be,{value:M,readOnly:!0,className:"session-id-input bg-gray-50 mb-1",title:`Session ${z+1}`,"data-test":`todo-details-session-input-${z}`},M))]})]}),s.jsxs("div",{className:"right-column col-span-1 space-y-4","data-test":"todo-details-right-column",children:[s.jsxs("div",{className:"form-field-selectors space-y-4","data-test":"todo-details-selectors",children:[s.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-details-status-selector",children:[s.jsx(de,{"data-test":"todo-details-status-label",children:"Status"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:s.jsx(Fd,{value:x,options:iu,onChange:ne,placeholder:"Search status...","data-test":"todo-details-status-select"})})]}),s.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-details-priority-selector",children:[s.jsx(de,{"data-test":"todo-details-priority-label",children:"Priority"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:s.jsx(Zs,{value:j,options:ou,onChange:G,placeholder:"Search priorities...","data-test":"todo-details-priority-badge"})})]}),s.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-details-category-selector",children:[s.jsx(de,{"data-test":"todo-details-category-label",children:"Category"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:s.jsx(qd,{value:N||"personal",onChange:te,placeholder:"Search categories...","data-test":"todo-details-category-select"})})]}),!K&&xe.length>1&&s.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-details-project-selector",children:[s.jsx(de,{"data-test":"todo-details-project-label",children:"Claude Project"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:s.jsx(Zs,{value:O??"__no_project__",options:xe,onChange:Ce,placeholder:"Search projects...","data-test":"todo-details-project-badge"})})]}),e==="edit"&&s.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-details-session-selector",children:[s.jsx(de,{"data-test":"todo-details-session-selector-label",children:"Claude Sessions"}),s.jsx(_n,{value:$,onChange:fe,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-details-session-select"})]}),s.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-details-tags-selector",children:[s.jsx(de,{"data-test":"todo-details-tags-label",children:"Tags"}),s.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-details-tags-container",children:[s.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-details-tags-list",children:W.map(M=>s.jsxs(Ge,{variant:"outline",className:"tag-badge gap-1","data-test":`todo-details-tag-${M}`,children:[M,s.jsx("button",{onClick:()=>Z(M),className:"tag-remove ml-1 hover:text-red-500","data-test":`todo-details-tag-remove-${M}`,children:s.jsx(Qe,{className:"w-3 h-3"})})]},M))}),s.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-details-tag-input-container",children:[s.jsx(Be,{value:p,onChange:je,onKeyDown:we,placeholder:"Add a tag...","data-test":"todo-details-tag-input"}),s.jsx(ae,{onClick:re,size:"sm",className:"tag-add-button","data-test":"todo-details-tag-add-button",children:s.jsx(hs,{className:"w-4 h-4"})})]})]})]})]}),s.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-details-due-date-field",children:[s.jsx(de,{htmlFor:"dueDate","data-test":"todo-details-due-date-label",children:"Due Date"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ki,{className:"w-4 h-4 text-gray-400"}),s.jsx(Be,{id:"dueDate",type:"date",value:b,onChange:M=>J(M.target.value),"data-test":"todo-details-due-date-input"})]})]})]})]})}function uu({todo:a,isOpen:e,onClose:t,onUpdate:r,currentCardIndex:n,totalCardsInColumn:o,onNavigatePrevious:l,onNavigateNext:c,initialValues:d}){var re,Z,ce,ie,ue,ve;const[u,h]=i.useState("details"),[m,g]=i.useState(""),[b,w]=i.useState(!1),[p,v]=i.useState(null),[y,f]=i.useState(!1),[x,C]=i.useState(!1),[j,S]=i.useState(0),[N,T]=i.useState((a==null?void 0:a.title)??(d==null?void 0:d.title)??""),[W,L]=i.useState(!1),P=!a||a.id.value==="temp-new-todo",U=i.useMemo(()=>P?{id:{value:"temp-create"},title:(d==null?void 0:d.title)??N,description:(d==null?void 0:d.description)??"",status:Ae.BACKLOG,priority:ht.MEDIUM,category:(d==null?void 0:d.category)??"",sortOrder:0,tags:(d==null?void 0:d.tags)??[],subtasks:[],createdAt:{value:new Date},updatedAt:{value:new Date},customProps:{sessionIds:[]}}:null,[P,d==null?void 0:d.title,d==null?void 0:d.description,d==null?void 0:d.category,d==null?void 0:d.tags,N]),$=(Z=(re=a==null?void 0:a.customProps)==null?void 0:re.sessionIds)==null?void 0:Z[j],k=i.useMemo(()=>{var ne;return((ne=a==null?void 0:a.customProps)==null?void 0:ne.sessionIds)??[]},[(ce=a==null?void 0:a.customProps)==null?void 0:ce.sessionIds]),O=i.useMemo(()=>({loadOnMount:u==="session",subscribeToSSE:u==="session"}),[u]),{messages:E,sessionDetails:_,metadata:B,loading:A,pagination:I,loadOlderMessages:R,refreshSession:H}=Ud($,O);i.useLayoutEffect(()=>{var ne,G,te,fe,Ce,he,xe;if(e&&((ne=a==null?void 0:a.customProps)!=null&&ne.claudeProjectPath)){const ge=Y.getState();((fe=(te=(G=ge.app)==null?void 0:G.claude)==null?void 0:te.ui)==null?void 0:fe.selectedProjectPath)!==a.customProps.claudeProjectPath&&Y.updateState({app:{...ge.app,claude:{...(Ce=ge.app)==null?void 0:Ce.claude,ui:{...(xe=(he=ge.app)==null?void 0:he.claude)==null?void 0:xe.ui,selectedProjectPath:a.customProps.claudeProjectPath}}}})}},[e,(ie=a==null?void 0:a.customProps)==null?void 0:ie.claudeProjectPath]),i.useEffect(()=>{h("details"),S(0),T((a==null?void 0:a.title)??(d==null?void 0:d.title)??"")},[a==null?void 0:a.id.value,a==null?void 0:a.title,a==null?void 0:a.description,e,d==null?void 0:d.title]),i.useEffect(()=>{const ne=k.length;ne>0&&j>=ne&&S(0)},[k.length,j]),i.useEffect(()=>{u==="session"&&$&&H()},[j,$,u,H]);const V=i.useCallback(ne=>{h(ne),ne==="session"&&$&&H()},[$,H]),K=i.useCallback(()=>{L(!0)},[]),F=i.useCallback(async ne=>{if(!a){L(!1);return}try{await Ln.claude.linkSessionToTodo(a.id,ne),r(),L(!1),h("session"),await H()}catch(G){console.error("Failed to handle session creation:",G),L(!1)}},[a,r,H]),Q=i.useCallback(async()=>{f(!0);try{await H()}finally{f(!1)}},[H]),oe=i.useCallback(async()=>{var G,te,fe,Ce,he,xe,ge,be,je,we;if(!a||!$)return;const ne=a.subtasks.filter(Se=>!Se.isCompleted);if(ne.length!==0){w(!0),C(!1);try{const Se=a.id;for(const ke of ne){if(x)break;v(ke.id.value),await Ye.sendMessage({message:ke.title,sessionId:$,options:{outputFormat:"text",permissionMode:"acceptEdits"}});let M=!1;for(let z=0;z<50;z++)if(await new Promise(le=>setTimeout(le,100)),(he=(Ce=(fe=(te=(G=Y.get("app"))==null?void 0:G.claude)==null?void 0:te.ui)==null?void 0:fe.activity)==null?void 0:Ce[$])==null?void 0:he.isProcessing){M=!0;break}if(!M)console.warn(`[ProcessAll] ${ke.title} - Processing never started, continuing anyway`);else for(let z=0;z<600&&(await new Promise(le=>setTimeout(le,100)),!!((we=(je=(be=(ge=(xe=Y.get("app"))==null?void 0:xe.claude)==null?void 0:ge.ui)==null?void 0:be.activity)==null?void 0:je[$])==null?void 0:we.isProcessing));z++);await Pe.toggleSubtask(Se,ke.id),await new Promise(z=>setTimeout(z,500))}r()}catch(Se){console.error("Failed to process all subtasks:",Se)}finally{w(!1),v(null),C(!1)}}},[a,$,r,x]),q=i.useCallback(()=>{C(!0)},[]),J=i.useCallback(async ne=>{const G=ne.target.value;if(T(G),!P&&a)try{await Pe.updateTodo(a.id,{title:G}),r()}catch(te){console.error("Failed to update todo title:",te)}},[P,a,r]);return s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"panel-header","data-test":"kanban-card-details-header",children:s.jsxs("div",{className:"header-title-row flex items-center justify-between gap-4","data-test":"kanban-card-details-title-row",children:[s.jsxs("div",{className:"header-left flex items-center gap-2 flex-1 min-w-0","data-test":"kanban-card-details-header-left",children:[!P&&s.jsx(ja,{"data-test":"kanban-card-details-session-activity",sessionIds:k,showCount:!0,isCreating:W}),!P&&l&&s.jsx(ae,{"data-test":"kanban-card-details-navigate-previous",variant:"ghost",size:"icon",onClick:l,disabled:n===0,className:"navigate-previous-card h-8 w-8 flex-shrink-0",title:"Previous card in column",children:s.jsx(Qt,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-left-icon"})}),s.jsx("div",{className:"flex-1 min-w-0","data-test":"kanban-card-details-title-wrapper",children:s.jsx(St,{"data-test":"kanban-card-details-title-textarea",value:N,onChange:J,placeholder:P?"Enter todo title...":"Edit todo title",className:"todo-title-textarea text-lg font-semibold resize-none w-full",rows:1})}),!P&&c&&s.jsx(ae,{"data-test":"kanban-card-details-navigate-next",variant:"ghost",size:"icon",onClick:c,disabled:n!==void 0&&o!==void 0&&n>=o-1,className:"navigate-next-card h-8 w-8 flex-shrink-0",title:"Next card in column",children:s.jsx(Et,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-right-icon"})})]}),!P&&a&&s.jsxs("div",{className:"header-actions flex items-center gap-2 flex-shrink-0","data-test":"kanban-card-details-header-actions",children:[s.jsx(_n,{"data-test":"kanban-card-details-session-selector",value:((ue=a.customProps)==null?void 0:ue.sessionIds)??[],onChange:async ne=>{const G=Array.isArray(ne)?ne:[];await Pe.updateTodo(a.id,{customProps:{...a.customProps,sessionIds:G}}),r()},className:"session-selector-header",showLabel:!1,placeholder:"Link to sessions",multiSelect:!0}),s.jsx(kn,{"data-test":"kanban-card-details-create-session-button",variant:"ghost",size:"icon",className:"create-session-button-panel",initialMessage:`Working on: ${a.title}

${a.description??""}`,projectPath:(ve=a.customProps)==null?void 0:ve.claudeProjectPath,onCreating:K,onSessionCreated:F,useModal:!0})]})]})}),s.jsxs(Tn,{value:u,onValueChange:V,className:"panel-tabs flex-1 flex flex-col overflow-hidden","data-test":"kanban-card-details-tabs",children:[s.jsxs(Sa,{className:D("grid w-full",P?"grid-cols-1":"grid-cols-2"),"data-test":"kanban-card-details-tabs-list",children:[s.jsx(Vt,{value:"details","data-test":"kanban-card-details-tab-details",children:"Details"}),!P&&s.jsx(Vt,{value:"session",disabled:!$,"data-test":"kanban-card-details-tab-session",children:"Claude Session"})]}),s.jsx(qt,{value:"details",className:"panel-form mt-4 flex-1 overflow-y-auto data-[state=inactive]:hidden","data-test":"kanban-card-details-details-content",children:s.jsx(du,{todo:P?U:a,mode:P?"create":"edit",onUpdate:r,onClose:t,activeSessionId:$,isProcessingAll:b,currentProcessingSubtaskId:p,onProcessAll:oe,onStopProcessing:q})}),!P&&s.jsxs(qt,{value:"session",className:"session-tab mt-4 flex-1 flex flex-col overflow-hidden data-[state=inactive]:hidden","data-test":"kanban-card-details-session-content",children:[null,A?s.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session",children:"Loading session..."}):$&&!_?s.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session-initial",children:s.jsxs(ae,{variant:"outline",size:"sm",onClick:()=>void H(),className:"load-session-button",children:[s.jsx(Ks,{className:"w-4 h-4 mr-2"}),"Load Session"]})}):_?s.jsxs("div",{className:"session-chat-area flex flex-col gap-4 h-[calc(100vh-220px)]","data-test":"kanban-card-details-chat-area",children:[s.jsxs("div",{className:"session-header flex items-center justify-between","data-test":"kanban-card-details-session-header",children:[s.jsxs("div",{className:"session-header-left flex items-center gap-3","data-test":"kanban-card-details-session-header-left",children:[s.jsx("h3",{className:"session-title text-sm font-medium text-muted-foreground","data-test":"kanban-card-details-session-title",children:"Session Messages"}),k.length>1&&s.jsx($d,{"data-test":"kanban-card-details-session-navigator",sessionIds:k,currentIndex:j,onIndexChange:S,className:"session-navigator"})]}),s.jsxs(ae,{"data-test":"kanban-card-details-refresh-button",onClick:()=>void Q(),size:"sm",variant:"outline",disabled:y,className:"refresh-session-button",children:[s.jsx(Ks,{className:D("w-4 h-4 mr-2",y&&"animate-spin"),"data-test":"kanban-card-details-refresh-icon"}),y?"Refreshing...":"Refresh"]})]}),s.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden","data-test":"kanban-card-details-chat-messages",children:s.jsx(Id,{"data-test":"kanban-card-details-chat-interface",messages:E,sessionDetails:_,metadata:B,loading:A,pagination:I,onLoadOlder:I&&I.page<I.totalPages?R:void 0})}),s.jsx("div",{className:"chat-input flex-shrink-0","data-test":"kanban-card-details-chat-input",children:s.jsx(Dd,{"data-test":"kanban-card-details-message-input",sessionId:$,value:m,onChange:g,onSendSuccess:()=>{H()}})})]}):s.jsx("div",{className:"no-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-no-session",children:"No Claude session found"})]})]})]})}function hu({isOpen:a,onClose:e,onUpdate:t,triggerPosition:r,initialValues:n}){return s.jsx(ga,{isVisible:a,onClose:e,title:"Create New Todo",shouldCloseManually:!0,resizable:!0,initialSize:{width:900,height:600},triggerPosition:r??void 0,className:"add-ticket-popover","data-test":"add-ticket-popover",children:s.jsx("div",{"data-test":"add-ticket-popover-content",className:"popover-content flex flex-col h-full overflow-hidden p-4",children:s.jsx(uu,{todo:null,isOpen:a,onClose:e,onUpdate:t,initialValues:n})})})}function pu({onTicketCreated:a,initialValues:e,variant:t="ghost",size:r="icon",className:n="add-ticket-button",title:o="Add New Ticket","data-test":l}){const[c,d]=i.useState(!1),[u,h]=i.useState(null),m=w=>{const p=w.currentTarget.getBoundingClientRect();h({x:p.left,y:p.top}),d(!0)},g=()=>{d(!1),h(null)},b=()=>{a&&a(),g()};return s.jsxs(s.Fragment,{children:[s.jsx(ae,{variant:t,size:r,onClick:m,title:o,className:n,"data-test":l||"add-ticket-button",children:s.jsx(Ji,{className:"h-5 w-5","data-test":l?`${l}-icon`:"add-ticket-button-icon"})}),s.jsx(hu,{isOpen:c,onClose:g,onUpdate:b,triggerPosition:u,initialValues:e,"data-test":l?`${l}-popover`:"add-ticket-popover"})]})}new ma;const mu={primaryColor:"blue",setPrimaryColor:()=>null},fu=i.createContext(mu),gu=()=>{const a=i.useContext(fu);if(a===void 0)throw new Error("usePrimaryColor must be used within a PrimaryColorProvider");return a};function xu({onColorSelect:a,selectedHue:e=217}){const t=i.useRef(null),[r,n]=i.useState(!1),[o,l]=i.useState(e);i.useEffect(()=>{r||l(e)},[e,r]),i.useEffect(()=>{const w=t.current;if(!w)return;const p=w.getContext("2d");if(!p)return;const v=w.width,y=w.height,f=40,x=(y-f)/2,C=`hsl(${o} 70% 90%)`;p.fillStyle=C,p.fillRect(0,0,v,y);for(let S=0;S<v;S+=1){const N=S/v*360;p.fillStyle=`hsl(${N}, 100%, 50%)`,p.fillRect(S,x,1,f)}p.strokeStyle="#ccc",p.lineWidth=2,p.strokeRect(0,x,v,f);const j=o/360*v;p.strokeStyle="#000",p.lineWidth=3,p.beginPath(),p.moveTo(j,x-8),p.lineTo(j,x+f+8),p.stroke(),p.strokeStyle="#fff",p.lineWidth=1,p.beginPath(),p.moveTo(j,x-8),p.lineTo(j,x+f+8),p.stroke()},[o]);const c=w=>{const p=t.current;if(!p)return;const v=p.getBoundingClientRect(),y=w.clientX-v.left,f=Math.round(y/p.width*360),x=Math.max(0,Math.min(360,f));l(x),a(`${x} 70% 60%`)},d=()=>n(!0),u=()=>n(!1),h=w=>{r&&c(w)},m=()=>n(!0),g=()=>n(!1),b=w=>{if(!r)return;const p=t.current;if(!p)return;const v=p.getBoundingClientRect(),y=w.touches[0].clientX-v.left,f=Math.round(y/p.width*360),x=Math.max(0,Math.min(360,f));l(x),a(`${x} 70% 60%`)};return s.jsxs("div",{className:"color-strip-container flex flex-col items-center gap-3",children:[s.jsx("canvas",{ref:t,width:200,height:80,onClick:c,onMouseDown:d,onMouseUp:u,onMouseMove:h,onMouseLeave:()=>n(!1),onTouchStart:m,onTouchEnd:g,onTouchMove:b,className:"color-strip cursor-pointer rounded touch-none"}),s.jsx("div",{className:"color-info text-center",children:s.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hue: ",o,"Â°"]})})]})}const bu=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose","white","black"],vu={slate:"#64748b",gray:"#6b7280",zinc:"#71717a",neutral:"#737373",stone:"#78716c",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e",white:"#ffffff",black:"#000000"},yu={slate:"hsl(215 16% 47%)",gray:"hsl(218 11% 43%)",zinc:"hsl(220 13% 47%)",neutral:"hsl(0 0% 45%)",stone:"hsl(12 6% 44%)",red:"hsl(0 84% 60%)",orange:"hsl(24 97% 61%)",amber:"hsl(45 96% 71%)",yellow:"hsl(54 100% 68%)",lime:"hsl(84 85% 67%)",green:"hsl(142 72% 64%)",emerald:"hsl(160 84% 65%)",teal:"hsl(168 86% 55%)",cyan:"hsl(191 87% 55%)",sky:"hsl(198 93% 60%)",blue:"hsl(217 91% 60%)",indigo:"hsl(226 86% 61%)",violet:"hsl(259 84% 63%)",purple:"hsl(280 85% 64%)",fuchsia:"hsl(289 86% 66%)",pink:"hsl(330 81% 60%)",rose:"hsl(356 84% 61%)",white:"hsl(0 0% 100%)",black:"hsl(0 0% 0%)"};function wu({isOpen:a,onOpenChange:e}){const{primaryColor:t,setPrimaryColor:r}=gu(),[n,o]=i.useState(217),[l,c]=i.useState(t),d=h=>{c(h),r(h);const m=yu[h],g=parseInt(m.split(" ")[0].replace("hsl(",""));o(g)},u=h=>{const m=parseInt(h.split(" ")[0]);o(m);const g=`${m} 70% 90%`,b=`${m} 70% 85%`,w=`${m} 70% 80%`,p=`${m} 70% 70%`;r(`hsl-${m}`),c(`hsl-${m}`);const v=window.document.documentElement;v.style.setProperty("--background",g),v.style.setProperty("--card",b),v.style.setProperty("--tab",w),v.style.setProperty("--active",p)};return s.jsx(bs,{open:a,onOpenChange:e,children:s.jsxs(vs,{className:"theme-settings-dialog sm:max-w-3xl",children:[s.jsxs(ys,{children:[s.jsx(Wt,{className:"theme-settings-title",children:"Theme Settings"}),s.jsx(nn,{className:"theme-settings-description",children:"Choose a predefined color or use the color wheel for custom colors"})]}),s.jsxs("div",{className:"predefined-colors-section mb-6",children:[s.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Predefined Colors"}),s.jsx("div",{className:"predefined-colors-grid grid grid-cols-12 gap-2",children:bu.map(h=>s.jsx("button",{type:"button",title:h,onClick:()=>d(h),className:D("color-button w-8 h-8 rounded-full border-2 cursor-pointer transition-all","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","hover:scale-110",l===h?"ring-2 ring-ring ring-offset-2 scale-110":"border-muted",h==="white"&&"border-neutral-300"),style:{backgroundColor:vu[h]},"aria-label":`Select ${h} theme`},h))})]}),s.jsxs("div",{className:"theme-wheel-container flex gap-6 items-start",children:[s.jsxs("div",{className:"flex-shrink-0",children:[s.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Custom Color"}),s.jsx(xu,{onColorSelect:u,selectedHue:n})]}),s.jsxs("div",{className:"flex-1 space-y-3",children:[s.jsx("div",{className:"theme-preview-title",children:s.jsx("p",{className:"text-sm font-medium text-foreground",children:"Live Preview:"})}),s.jsx("div",{className:"theme-preview-bg p-4 rounded-lg border-2",style:{backgroundColor:`hsl(${n} 70% 90%)`},children:s.jsx("p",{className:"text-xs font-semibold text-gray-700",children:"Background"})}),s.jsx("div",{className:"theme-preview-card p-4 rounded-lg border",style:{backgroundColor:`hsl(${n} 70% 85%)`},children:s.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Card"})}),s.jsx("div",{className:"theme-preview-tab p-3 rounded-lg border",style:{backgroundColor:`hsl(${n} 70% 80%)`},children:s.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Tab"})}),s.jsx("div",{className:"theme-preview-active p-3 rounded-lg border font-semibold",style:{backgroundColor:`hsl(${n} 70% 70%)`},children:s.jsx("p",{className:"text-xs text-gray-900",children:"Active/Selected"})})]})]})]})})}function Su({version:a}){const e=ia(),[t,r]=i.useState(!1);if(e.pathname==="/game"||e.pathname==="/new-home")return null;const n=typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port.startsWith("517");return s.jsxs("header",{className:"sticky top-0 z-50 bg-black text-white shadow-md",children:[s.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[s.jsx(Jr,{}),n&&s.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(Qi,{className:_e.md}),s.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(bt,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(Cr,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?s.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?s.jsxs(s.Fragment,{children:[s.jsx(Yi,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?s.jsxs(s.Fragment,{children:[s.jsx(Xi,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?s.jsxs(s.Fragment,{children:[s.jsx(Rr,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?s.jsxs(s.Fragment,{children:[s.jsx(Zi,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):s.jsxs(s.Fragment,{children:[s.jsx(Ar,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(da,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(ec,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(Nr,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(Tr,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(Er,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(kr,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?s.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[s.jsx(jr,{className:_e.md}),s.jsxs("h1",{className:"text-xl font-semibold",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):s.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[n&&s.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&a&&s.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",a]}),s.jsx(pu,{}),s.jsx(Ad,{variant:"ghost",size:"icon",title:"Audio Recorder"}),s.jsx(kn,{variant:"ghost",size:"icon",icon:s.jsx(_r,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),s.jsx(As,{title:"Settings",icon:s.jsx(bt,{className:"h-5 w-5"}),variant:"ghost",size:"icon",align:"end",storageKey:"app-settings",children:s.jsxs("div",{className:"settings-panel space-y-3",children:[s.jsxs("div",{className:"theme-toggle-section",children:[s.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme"}),s.jsx(xl,{})]}),s.jsxs("div",{className:"theme-settings-section",children:[s.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme Colors"}),s.jsxs(ae,{variant:"outline",size:"sm",onClick:()=>r(!0),className:"w-full flex items-center gap-2",children:[s.jsx(tc,{className:"h-4 w-4"}),"Customize Colors"]})]})]})})]})]}),s.jsx(wu,{isOpen:t,onOpenChange:r})]})}function ju(){const a=document.activeElement;if(!a)return null;const e=["INPUT","TEXTAREA"].includes(a.nodeName??""),t=a.contentEditable==="true";return e||t}class Cu{constructor(){X(this,"shortcuts",new Map);X(this,"isListening",!1);this.handleKeyDown=this.handleKeyDown.bind(this)}generateShortcutId(e){const t=[];return e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),`${t.join("+")}-${e.key.toLowerCase()}`}handleKeyDown(e){if(ju())return;const t=this.generateShortcutId({key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey}),r=this.shortcuts.get(t);r&&(r.preventDefault!==!1&&e.preventDefault(),r.callback())}register(e){const t=this.generateShortcutId(e);return this.shortcuts.set(t,e),this.isListening||this.startListening(),()=>this.unregister(t)}unregister(e){this.shortcuts.delete(e),this.shortcuts.size===0&&this.stopListening()}unregisterAll(){this.shortcuts.clear(),this.stopListening()}startListening(){this.isListening||(document.addEventListener("keydown",this.handleKeyDown),this.isListening=!0)}stopListening(){this.isListening&&(document.removeEventListener("keydown",this.handleKeyDown),this.isListening=!1)}getRegisteredShortcuts(){return Array.from(this.shortcuts.values())}isShortcutRegistered(e){const t=this.generateShortcutId(e);return this.shortcuts.has(t)}}const us=new Cu,Ha="command-palette-recently-used",Nu=5;function Eu({actions:a=[],placeholder:e="Type a command or search..."}){const[t,r]=i.useState(!1),[n,o]=i.useState(""),[l,c]=i.useState(()=>{try{const m=localStorage.getItem(Ha);return m?JSON.parse(m):[]}catch{return[]}});i.useEffect(()=>{const m=us.register({key:"p",ctrlKey:!0,preventDefault:!0,callback:()=>r(w=>!w)}),g=us.register({key:"p",metaKey:!0,preventDefault:!0,callback:()=>r(w=>!w)}),b=us.register({key:"p",ctrlKey:!0,metaKey:!0,preventDefault:!0,callback:()=>{const w=l[0];if(w){const p=a.find(v=>v.id===w);p&&p.action()}}});return()=>{m(),g(),b()}},[l,a]),i.useEffect(()=>{if(!t)return;const m=g=>{if(g.key!=="ArrowUp"&&g.key!=="ArrowDown")return;const b=Array.from(document.querySelectorAll("[cmdk-item]")).filter(y=>y.getAttribute("data-disabled")!=="true");if(b.length===0)return;const w=b.map(y=>y.getAttribute("data-value")||""),p=w.indexOf(n);let v;if(g.key==="ArrowUp"){p<=0&&(g.preventDefault(),g.stopPropagation(),v=b.length-1,o(w[v]));return}else{p>=b.length-1&&(g.preventDefault(),g.stopPropagation(),v=0,o(w[v]));return}};return document.addEventListener("keydown",m,{capture:!0}),()=>document.removeEventListener("keydown",m,{capture:!0})},[t,n]);const d=a.reduce((m,g)=>{const b=g.group??"General";return m[b]||(m[b]=[]),m[b].push(g),m},{}),u=m=>{r(!1),m.action(),c(g=>{const b=g.filter(p=>p!==m.id),w=[m.id,...b].slice(0,Nu);try{localStorage.setItem(Ha,JSON.stringify(w))}catch{}return w})},h=l.map(m=>a.find(g=>g.id===m)).filter(m=>m!==void 0);return s.jsxs(Nl,{open:t,onOpenChange:r,value:n,onValueChange:o,"data-test":"command-palette-dialog",children:[s.jsx(Ps,{"data-test":"command-palette-input",placeholder:e}),s.jsxs(Is,{"data-test":"command-palette-list",children:[s.jsx(Ds,{"data-test":"command-palette-empty",children:"No results found."}),h.length>0&&s.jsxs(s.Fragment,{children:[s.jsx(Gt,{heading:"Recently Used","data-test":"command-group-recent",children:h.map(m=>s.jsxs(kt,{value:`recent-${m.id}`,onSelect:()=>u(m),className:"command-item flex justify-between items-center","data-test":`command-item-recent-${m.id}`,children:[s.jsx("span",{"data-test":`command-item-recent-${m.id}-label`,children:m.label}),m.shortcut&&s.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":`command-item-recent-${m.id}-shortcut`,children:m.shortcut})]},`recent-${m.id}`))}),s.jsx(ea,{"data-test":"command-separator-recent"})]}),Object.entries(d).map(([m,g],b)=>s.jsxs("div",{"data-test":`command-group-container-${m.toLowerCase().replace(/\s+/g,"-")}`,children:[b>0&&s.jsx(ea,{"data-test":`command-separator-${m.toLowerCase().replace(/\s+/g,"-")}`}),s.jsx(Gt,{heading:m,"data-test":`command-group-${m.toLowerCase().replace(/\s+/g,"-")}`,children:g.map(w=>s.jsxs(kt,{value:w.id,onSelect:()=>u(w),className:"command-item flex justify-between items-center","data-test":`command-item-${w.id}`,children:[s.jsx("span",{"data-test":`command-item-${w.id}-label`,children:w.label}),w.shortcut&&s.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":`command-item-${w.id}-shortcut`,children:w.shortcut})]},w.id))})]},m))]})]})}function ku(a){const e=a.split(/[/\\]/),t=e.pop()||"",r=/:(\d+)(?::\d+)?$/.exec(t);let n="",o=t;return r&&(n=r[1],o=t.slice(0,r.index)),{dir:e.join("/"),filename:o,line:n}}function na(a){return ku(a).filename}function ns({onClick:a,textToCopy:e,title:t="Copy formatted text",size:r="icon",variant:n="ghost"}){const[o,l]=i.useState(!1),c=async()=>{if(a){a();return}if(!e){Je.error("No text to copy");return}try{await navigator.clipboard.writeText(e),l(!0),Je.success("Copied to clipboard!"),setTimeout(()=>l(!1),2e3)}catch(d){Je.error("Failed to copy to clipboard"),console.error("Copy failed:",d)}};return s.jsx(ae,{onClick:c,title:t,size:r,variant:n,children:o?s.jsx(We,{}):s.jsx(Lr,{})})}function Tu(a,e,t=300,r=15,n=10,o=200){let l=a+r,c=e+r;return l+t>window.innerWidth&&(l=window.innerWidth-t-n),c+o>window.innerHeight&&(c=window.innerHeight-o-n),l<n&&(l=n),c<n&&(c=n),{left:l,top:c}}function Au({onElementClicked:a,onElementHovered:e,onInspectorActivated:t,onInspectorDeactivated:r,shouldInspectElement:n,renderTooltip:o,excludeClassNames:l=[],tooltipOwnerId:c}){const[d,u]=i.useState(!1),[h,m]=i.useState(null),g=i.useRef(null),b=i.useRef(a),w=i.useRef(e),p=i.useRef(t),v=i.useRef(r),y=i.useRef(n),f=i.useRef(null),x=i.useRef(null),C=i.useRef(null);i.useEffect(()=>{b.current=a,w.current=e,p.current=t,v.current=r,y.current=n}),i.useEffect(()=>{if(c)return Ke.claimTooltip(c),()=>{Ke.releaseTooltip(c)}},[c]);const j=i.useMemo(()=>["inspector-tooltip","collected-elements-popover",...l],[l]),S=i.useCallback($=>{for(const k of j)if($.closest(`.${k}`))return!0;return!!(y.current&&!y.current($))},[j]),N=i.useCallback($=>{var R;const k=$.target;if(S(k))return;const O=g.current===k;g.current&&!O&&(g.current.style.outline="",g.current.style.outlineOffset=""),k.style.outline="2px solid #06b6d4",k.style.outlineOffset="2px",g.current=k;const E=k.tagName.toLowerCase(),_=Array.from(k.classList),B=k.getAttribute("data-test")||void 0,A=k.getAttribute("data-react-inspector")||void 0,I={tagName:E,classes:_,dataTest:B,reactInspectorId:A,resolvedPath:void 0,x:$.clientX,y:$.clientY};O?m(H=>H?{...H,x:$.clientX,y:$.clientY}:I):(m(I),(R=w.current)==null||R.call(w,k,I))},[S]),T=i.useCallback($=>{var I;const k=$.target;if(S(k))return;$.preventDefault(),$.stopPropagation();const O=k.tagName.toLowerCase(),E=Array.from(k.classList),_=k.getAttribute("data-test")||void 0,B=k.getAttribute("data-react-inspector")||void 0,A={tagName:O,classes:E,dataTest:_,reactInspectorId:B,resolvedPath:void 0,x:$.clientX,y:$.clientY};(I=b.current)==null||I.call(b,k,A)},[S]),W=i.useCallback($=>{$.key==="Escape"&&d&&Ke.deactivate()},[d]);i.useEffect(()=>(u(Ke.getState()),Ke.subscribe(k=>{var O,E;u(k),k?(O=p.current)==null||O.call(p):(E=v.current)==null||E.call(v)})),[]),i.useEffect(()=>{var $;return d?(f.current=N,x.current=T,C.current=W,document.body.style.setProperty("cursor","crosshair","important"),document.addEventListener("mousemove",N),document.addEventListener("click",T,!0),document.addEventListener("keydown",W)):(document.body.style.removeProperty("cursor"),f.current&&document.removeEventListener("mousemove",f.current),x.current&&document.removeEventListener("click",x.current,!0),C.current&&document.removeEventListener("keydown",C.current),m(null),($=w.current)==null||$.call(w,null,null),g.current&&(g.current.style.outline="",g.current.style.outlineOffset="",g.current=null)),()=>{document.body.style.removeProperty("cursor"),f.current&&document.removeEventListener("mousemove",f.current),x.current&&document.removeEventListener("click",x.current,!0),C.current&&document.removeEventListener("keydown",C.current),g.current&&(g.current.style.outline="",g.current.style.outlineOffset="",g.current=null)}},[d]);const L=h?Tu(h.x,h.y):{left:0,top:0},P=h&&s.jsx("div",{className:"inspector-tooltip fixed z-[9999] bg-black text-white p-3 rounded-lg shadow-xl text-xs font-mono pointer-events-none",style:{left:`${L.left}px`,top:`${L.top}px`,width:"300px"},"data-test":"element-inspector-tooltip",children:s.jsxs("div",{className:"metadata-section space-y-2","data-test":"element-inspector-metadata-section",children:[s.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-tag-row",children:[s.jsx(Mr,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-400"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-gray-400 text-[10px]",children:"Tag"}),s.jsxs("div",{className:"text-blue-300","data-test":"element-inspector-tag-value",children:["<",h.tagName,">"]})]})]}),h.dataTest&&s.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-data-test-row",children:[s.jsx(Bt,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-gray-400 text-[10px]",children:"Data Test"}),s.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-data-test-value",children:h.dataTest})]})]}),!h.dataTest&&h.classes.length>0&&s.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-classes-row",children:[s.jsx(Bt,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),s.jsxs("div",{children:[s.jsxs("div",{className:"text-gray-400 text-[10px]",children:["Classes (",h.classes.length,")"]}),s.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-classes-value",children:h.classes.join(" ")})]})]}),h.reactInspectorId&&s.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-file-row",children:[s.jsx(ps,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-400"}),s.jsxs("div",{children:[s.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Name"}),s.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-name",children:na(h.resolvedPath||h.reactInspectorId)}),s.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Path"}),s.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-path",children:h.resolvedPath||h.reactInspectorId||"Resolving..."})]})]}),!h.reactInspectorId&&s.jsxs("div",{className:"metadata-row flex items-start gap-2",children:[s.jsx(ps,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-gray-600"}),s.jsx("div",{children:s.jsx("div",{className:"text-gray-500 text-[10px] italic",children:"No data-react-inspector attribute"})})]})]})}),U=Ke.canRenderTooltip(c??null);return s.jsx(s.Fragment,{children:d&&h&&U&&(o?o(h):P)})}async function Ru(a){if(!a)return;const r=a.split(":")[0].split("/").pop();if(r)try{return await ta.getFilePath(r)}catch(n){console.error("Failed to resolve inspector path:",n);return}}function Pu({onElementCollected:a,onElementRemoved:e,onElementsCleared:t,renderCollectedItem:r,renderCollectedPanel:n,showDefaultPanel:o=!0,tooltipOwnerId:l,panelOwnerId:c}){const[d,u]=i.useState([]),[h,m]=i.useState(!1),[g,b]=i.useState({x:100,y:100}),w=i.useRef(!1),p=i.useRef({x:0,y:0});i.useEffect(()=>{if(c)return Ke.claimPanel(c),()=>{Ke.releasePanel(c)}},[c]);const v=i.useCallback((k,O)=>{(async()=>{const _=await Ru(O.reactInspectorId)||O.reactInspectorId,B={id:`${Date.now()}-${Math.random()}`,tagName:O.tagName,classes:O.classes,dataTest:O.dataTest,reactInspectorId:O.reactInspectorId,resolvedPath:_,timestamp:Date.now()};u(A=>[...A,B]),a==null||a(B,k),Je.success("Element collected!",{description:`<${O.tagName}>${_?` [${_}]`:""}`,duration:2e3})})()},[a]),y=i.useCallback(()=>{(d.length>0||h)&&m(!0)},[d.length,h]),f=k=>{k.target.closest(".popover-drag-handle")&&(w.current=!0,p.current={x:k.clientX-g.x,y:k.clientY-g.y})},x=i.useCallback(k=>{w.current&&b({x:k.clientX-p.current.x,y:k.clientY-p.current.y})},[]),C=i.useCallback(()=>{w.current=!1},[]);i.useEffect(()=>(h&&(document.addEventListener("mousemove",x),document.addEventListener("mouseup",C)),()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",C)}),[h,x,C]),i.useEffect(()=>{const k=O=>{O.key==="Escape"&&h&&m(!1)};return h&&document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}},[h]);const j=k=>{u(O=>O.filter(E=>E.id!==k.id)),e==null||e(k),Je.info("Element removed from collection")},S=()=>{u([]),m(!1),t==null||t(),Je.info("All collected elements cleared")},N=()=>{m(!1),u([]),t==null||t()},T=()=>d.map((k,O)=>{const E=k.dataTest?`[data-test="${k.dataTest}"]`:k.classes.length>0?`.${k.classes[0]}`:"",_=k.resolvedPath||"unknown";return`${O+1}. ${k.tagName}${E} inside @${_}`}).join(`
`),W=(k,O)=>s.jsxs("div",{className:"collected-element p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors","data-test":`element-inspector-collected-item-${O}`,children:[s.jsxs("div",{className:"element-header flex items-center justify-between mb-2","data-test":`element-inspector-collected-item-${O}-header`,children:[s.jsxs("div",{className:"element-index text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded","data-test":`element-inspector-collected-item-${O}-index`,children:["#",O+1]}),s.jsx("button",{onClick:()=>j(k),className:"remove-btn p-1 hover:bg-red-100 rounded transition-colors",title:"Remove element","data-test":`element-inspector-collected-item-${O}-remove-button`,children:s.jsx(Nt,{className:"w-4 h-4 text-red-600"})})]}),s.jsxs("div",{className:"element-details space-y-1 text-xs",children:[s.jsxs("div",{className:"detail-row flex items-start gap-2",children:[s.jsx(Mr,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-600"}),s.jsxs("div",{children:[s.jsx("span",{className:"text-gray-500",children:"Tag:"})," ",s.jsxs("span",{className:"font-mono text-blue-700",children:["<",k.tagName,">"]})]})]}),k.resolvedPath&&s.jsxs("div",{className:"detail-row flex items-start gap-2",children:[s.jsx(ps,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-600"}),s.jsxs("div",{children:[s.jsxs("div",{children:[s.jsx("span",{className:"text-gray-500",children:"File Name:"})," ",s.jsx("span",{className:"font-mono text-purple-700",children:na(k.resolvedPath)}),s.jsx(ns,{textToCopy:na(k.resolvedPath),size:"sm"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"text-gray-500",children:"File Path:"})," ",s.jsx("span",{className:"font-mono text-purple-700",children:k.resolvedPath}),s.jsx(ns,{textToCopy:k.resolvedPath,size:"sm"})]})]})]}),k.dataTest&&s.jsxs("div",{className:"detail-row flex items-start gap-2",children:[s.jsx(Bt,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),s.jsxs("div",{className:"flex-1",children:[s.jsx("span",{className:"text-gray-500",children:"Data Test:"})," ",s.jsx("span",{className:"font-mono text-green-700",children:k.dataTest}),s.jsx(ns,{textToCopy:k.dataTest,size:"sm"})]})]}),!k.dataTest&&k.classes.length>0&&s.jsxs("div",{className:"detail-row flex items-start gap-2",children:[s.jsx(Bt,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("span",{className:"text-gray-500",children:["Classes (",k.classes.length,"):"]}),s.jsx("div",{className:"font-mono text-green-700 text-[10px] break-all mt-1",children:k.classes.join(" ")})]})]}),s.jsx("div",{className:"timestamp text-[10px] text-gray-400 mt-2",children:new Date(k.timestamp).toLocaleTimeString()})]})]},k.id),L=s.jsxs("div",{className:"collected-elements-popover fixed z-[9999] bg-white border-2 border-purple-400 rounded-lg shadow-2xl",style:{left:`${g.x}px`,top:`${g.y}px`,width:"550px",maxHeight:"500px"},onMouseDown:f,"data-test":"element-inspector-collected-popover",children:[s.jsxs("div",{className:"popover-drag-handle popover-header bg-purple-500 text-white p-3 rounded-t-lg cursor-move flex items-center justify-between","data-test":"element-inspector-collected-header",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(sc,{className:"w-5 h-5"}),s.jsxs("h3",{className:"font-semibold","data-test":"element-inspector-collected-title",children:["Collected Elements (",d.length,")"]})]}),s.jsxs("div",{className:"flex items-center gap-2","data-test":"element-inspector-collected-actions",children:[s.jsx(ns,{textToCopy:T()}),s.jsx("button",{onClick:N,className:"hover:bg-purple-600 rounded p-1 transition-colors",title:"Close","data-test":"element-inspector-collected-close-button",children:s.jsx(Qe,{className:"w-5 h-5"})})]})]}),s.jsxs(Tn,{defaultValue:"list",className:"popover-tabs","data-test":"element-inspector-collected-tabs",children:[s.jsxs(Sa,{className:"tabs-list grid w-full grid-cols-2 mx-3 mt-3","data-test":"element-inspector-collected-tabs-list",children:[s.jsx(Vt,{value:"list","data-test":"element-inspector-collected-list-tab",children:"List View"}),s.jsx(Vt,{value:"text","data-test":"element-inspector-collected-text-tab",children:"Text View"})]}),s.jsxs(qt,{value:"list",className:"tabs-content m-0","data-test":"element-inspector-collected-list-content",children:[s.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4 space-y-2","data-test":"element-inspector-collected-list",children:d.map((k,O)=>r?r(k,O,()=>W(k,O)):W(k,O))}),s.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-list-footer",children:s.jsxs(ae,{onClick:S,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-clear-all-button",children:[s.jsx(Nt,{className:"w-4 h-4 mr-2"}),"Clear All (",d.length,")"]})})]}),s.jsxs(qt,{value:"text",className:"tabs-content m-0","data-test":"element-inspector-collected-text-content",children:[s.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4","data-test":"element-inspector-collected-text",children:s.jsx("pre",{className:"text-xs font-mono text-gray-800 whitespace-pre-wrap break-words bg-gray-50 p-3 rounded border border-gray-200","data-test":"element-inspector-collected-text-formatted",children:T()})}),s.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-text-footer",children:s.jsxs(ae,{onClick:S,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-text-clear-all-button",children:[s.jsx(Nt,{className:"w-4 h-4 mr-2"}),"Clear All (",d.length,")"]})})]})]})]}),P=Ke.canRenderPanel(c??null),U=o&&h&&d.length>0&&P,$=n?n(d,L):L;return s.jsxs(s.Fragment,{children:[s.jsx(Au,{tooltipOwnerId:l,onElementClicked:v,onInspectorDeactivated:y}),U&&$]})}const Iu=({...a})=>{const{theme:e="system"}=Wo();return s.jsx(Go,{theme:e,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...a})};class Du{constructor(e){this.apiClient=e}log(e,t){try{const{customLogFile:r,...n}=t||{};this.apiClient.sendLogs(e,n,r)}catch(r){console.error("[ClientLogsService] Failed to log event:",e,r)}}logCritical(e,t){try{return this.apiClient.sendBeacon(e,t)}catch(r){return console.error("[ClientLogsService] Failed to log critical event:",e,r),!1}}async clearLogs(){try{return await this.apiClient.clearLogs()}catch(e){return console.error("[ClientLogsService] Failed to clear logs:",e),!1}}}class _u{constructor(e){this.client=e}async log(e,t){await this.client.sendLogs(e,t)}logCritical(e,t){return this.client.sendBeacon(e,t)}}class Lu{constructor(e={}){X(this,"_clientLogsApiClient",null);X(this,"_clientLogsService",null);X(this,"_logger",null);X(this,"_config");this._config={clientLogsApiBaseUrl:e.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",clientLogsEnabled:e.clientLogsEnabled!==!1}}get clientLogsApiClient(){return this._clientLogsApiClient||(this._clientLogsApiClient=new ma(this._config.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",5e3)),this._clientLogsApiClient}get clientLogsService(){return this._clientLogsService||(this._clientLogsService=new Du(this.clientLogsApiClient)),this._clientLogsService}get logger(){return this._logger||(this._logger=new _u(this.clientLogsApiClient)),this._logger}setConfig(e){this._config={...this._config,...e},this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}setClientLogsApiClient(e){this._clientLogsApiClient=e,this._clientLogsService=null,this._logger=null}reset(){this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}}const Vs=new Lu;class ee{constructor(e,t,r,n){this.isSuccess=e,this.isFailure=t,this._value=r,this._error=n}get value(){if(!this.isSuccess)throw new Error("Cannot get value from a failure result");return this._value}get error(){if(!this.isFailure)throw new Error("Cannot get error from a success result");return this._error}static success(e){return new ee(!0,!1,e,void 0)}static failure(e){return new ee(!1,!0,void 0,e)}}class qs extends Error{constructor(e){super(`User not found: ${e}`),this.userId=e,this.name="UserNotFoundError"}}class Mu extends Error{constructor(){super("Username cannot be empty"),this.name="UsernameEmptyError"}}class Ou extends Error{constructor(e){super(`Username must be at least ${e} characters`),this.minLength=e,this.name="UsernameTooShortError"}}class $u extends Error{constructor(e){super(`Username cannot exceed ${e} characters`),this.maxLength=e,this.name="UsernameTooLongError"}}function Ls(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():typeof crypto<"u"&&typeof crypto.getRandomValues=="function"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const e=crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return(a==="x"?e:e&3|8).toString(16)}):(console.warn("[UUID] Using Math.random() fallback - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const e=Math.random()*16|0;return(a==="x"?e:e&3|8).toString(16)}))}class pt{constructor(e,t,r,n,o,l,c){this.id=e,this.username=t,this.profilePicture=r,this.isOnline=n,this.lastSeen=o,this.createdAt=l,this.updatedAt=c,this.validate()}validate(){if(!this.id.trim())throw new Error("User ID cannot be empty");if(!this.username.trim())throw new Error("Username cannot be empty");if(this.username.length<2)throw new Error("Username must be at least 2 characters");if(this.username.length>50)throw new Error("Username cannot exceed 50 characters")}static create(e,t){const r=new Date().toISOString();return new pt(Ls(),e.trim(),t,!1,r,r,r)}static fromData(e){return new pt(e.id,e.username,e.profilePicture,e.isOnline,e.lastSeen,e.createdAt,e.updatedAt)}setOnline(e){return new pt(this.id,this.username,this.profilePicture,e,new Date().toISOString(),this.createdAt,new Date().toISOString())}updateProfile(e,t){return new pt(this.id,(e==null?void 0:e.trim())||this.username,t!==void 0?t:this.profilePicture,this.isOnline,this.lastSeen,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,username:this.username,profilePicture:this.profilePicture,isOnline:this.isOnline,lastSeen:this.lastSeen,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Uu{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;console.log("[CreateUserUseCase] Executing with command:",e);try{const r=e.username.trim();if(r.length===0)return console.log("[CreateUserUseCase] Validation failed: Username is empty"),ee.failure(new Mu);if(r.length<2)return console.log("[CreateUserUseCase] Validation failed: Username too short"),ee.failure(new Ou(2));if(r.length>50)return console.log("[CreateUserUseCase] Validation failed: Username too long"),ee.failure(new $u(50));console.log("[CreateUserUseCase] Validation passed, creating user entity");const n=pt.create(r,e.profilePicture);console.log("[CreateUserUseCase] User entity created:",n),console.log("[CreateUserUseCase] Calling repository.create...");const o=await this.repository.create(n);return console.log("[CreateUserUseCase] User persisted successfully:",o),(t=this.logger)==null||t.log("user_created",{userId:o.id,usernameLength:r.length,hasProfilePicture:!!e.profilePicture}),console.log("[CreateUserUseCase] Returning success result"),ee.success(o)}catch(r){return console.error("[CreateUserUseCase] CAUGHT ERROR:",r),ee.failure(r instanceof Error?r:new Error("Failed to create user"))}}}class Pt{constructor(e,t,r,n,o,l,c,d,u,h){this.id=e,this.gameId=t,this.senderId=r,this.senderUsername=n,this.senderProfilePicture=o,this.text=l,this.timestamp=c,this.createdAt=d,this.isPersona=u,this.isIntroduction=h,this.validate()}validate(){if(!this.id.trim())throw new Error("Message ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.senderId.trim())throw new Error("Sender ID cannot be empty");if(!this.senderUsername.trim())throw new Error("Sender username cannot be empty");if(!this.text.trim())throw new Error("Message text cannot be empty");if(this.text.length>500)throw new Error("Message text cannot exceed 500 characters")}static create(e,t,r,n,o,l,c){const d=new Date().toISOString();return new Pt(Ls(),e.trim(),t.trim(),r.trim(),n,o.trim(),d,d,l,c)}static fromData(e){return new Pt(e.id,e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,e.text,e.timestamp,e.createdAt,e.isPersona,e.isIntroduction)}toJSON(){return{id:this.id,gameId:this.gameId,senderId:this.senderId,senderUsername:this.senderUsername,senderProfilePicture:this.senderProfilePicture,text:this.text,timestamp:this.timestamp,createdAt:this.createdAt,isPersona:this.isPersona,isIntroduction:this.isIntroduction}}}class Fu{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t,r;try{const n=e.text.trim();if(n.length===0)return ee.failure(new Error("Message text cannot be empty"));if(n.length>500)return ee.failure(new Error("Message text cannot exceed 500 characters"));if(!e.gameId.trim())return ee.failure(new Error("Game ID is required"));if(!e.senderId.trim())return ee.failure(new Error("Sender ID is required"));if(!e.senderUsername.trim())return ee.failure(new Error("Sender username is required"));const o=Pt.create(e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,n),l=await this.repository.create(o);if(l.isFailure)return l;const c=/@(\w+)/g,d=Array.from(n.matchAll(c)).map(h=>h[1]);d.length>0&&!e.isFromPersona&&((t=this.logger)==null||t.log("persona_mentioned",{messageId:l.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,mentionedNames:d,mentionCount:d.length}));const u=e.isFromPersona?"persona_message_sent":"chat_message_sent";return(r=this.logger)==null||r.log(u,{messageId:l.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,messageLength:n.length,isFromPersona:e.isFromPersona||!1,hasMentions:d.length>0}),ee.success(l.value)}catch(n){return ee.failure(n instanceof Error?n:new Error("Failed to send message"))}}}class zu{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;try{if(!e.gameId.trim())return ee.failure(new Error("Game ID is required"));const r=await this.repository.findByGameId(e.gameId);return r.isFailure?r:((t=this.logger)==null||t.log("chat_messages_loaded",{gameId:e.gameId,messageCount:r.value.length}),ee.success(r.value))}catch(r){return ee.failure(r instanceof Error?r:new Error("Failed to retrieve messages"))}}}class Bu{constructor(e,t,r,n){X(this,"_createUserUseCase");X(this,"_sendMessageUseCase");X(this,"_getMessagesUseCase");this.userRepository=e,this.chatRepository=t,this.webSocketService=r,this.logger=n}async createUser(e){var r;this._createUserUseCase||(this._createUserUseCase=new Uu(this.userRepository,this.logger));const t=await this._createUserUseCase.execute(e);if(t.isSuccess){const n=await this.setUserOnline({userId:t.value.id,isOnline:!0});if((r=this.logger)==null||r.log("user_set_online",{userId:t.value.id,isOnline:!0,triggeredBy:"user_creation"}),n.isSuccess)return ee.success(n.value)}return t}async updateUser(e){try{const t=await this.userRepository.getById(e.userId);if(!t)return ee.failure(new qs(e.userId));const r=t.updateProfile(e.username,e.profilePicture),n=await this.userRepository.update(r);return ee.success(n)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to update user"))}}async setUserOnline(e){var t;try{const r=await this.userRepository.getById(e.userId);if(!r)return ee.failure(new qs(e.userId));const n=r.setOnline(e.isOnline),o=await this.userRepository.update(n);return(t=this.logger)==null||t.log("user_online_status_changed",{userId:e.userId,username:r.username,previousStatus:r.isOnline,newStatus:e.isOnline}),ee.success(o)}catch(r){return ee.failure(r instanceof Error?r:new Error("Failed to set user online status"))}}async deleteUser(e){try{return await this.userRepository.delete(e.userId),ee.success(void 0)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to delete user"))}}async getAllUsers(e){try{let t=await this.userRepository.getAll();return e.onlineOnly&&(t=t.filter(r=>r.isOnline)),ee.success(t)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to get users"))}}async getUserById(e){try{const t=await this.userRepository.getById(e.userId);return t?ee.success(t):ee.failure(new qs(e.userId))}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to get user"))}}async connect(){if(!this.webSocketService)return ee.failure(new Error("WebSocket service not configured"));try{return ee.success(void 0)}catch(e){return ee.failure(e instanceof Error?e:new Error("Failed to connect"))}}async disconnect(){if(!this.webSocketService)return ee.failure(new Error("WebSocket service not configured"));try{return await this.webSocketService.disconnect(),ee.success(void 0)}catch(e){return ee.failure(e instanceof Error?e:new Error("Failed to disconnect"))}}async joinLobby(){if(!this.webSocketService)return ee.failure(new Error("WebSocket service not configured"));try{return ee.success(void 0)}catch(e){return ee.failure(e instanceof Error?e:new Error("Failed to join lobby"))}}async leaveLobby(){if(!this.webSocketService)return ee.failure(new Error("WebSocket service not configured"));try{return ee.success(void 0)}catch(e){return ee.failure(e instanceof Error?e:new Error("Failed to leave lobby"))}}async sendMessage(e){return this._sendMessageUseCase||(this._sendMessageUseCase=new Fu(this.chatRepository,this.logger)),this._sendMessageUseCase.execute(e)}async clearMessages(e){var t;try{return await this.chatRepository.deleteByGameId(e.gameId),(t=this.logger)==null||t.log("chat_messages_cleared",{gameId:e.gameId}),ee.success(void 0)}catch(r){return ee.failure(r instanceof Error?r:new Error("Failed to clear messages"))}}async getMessages(e){return this._getMessagesUseCase||(this._getMessagesUseCase=new zu(this.chatRepository,this.logger)),this._getMessagesUseCase.execute(e)}}class at{constructor(e,t,r,n,o,l,c,d,u,h){this.id=e,this.name=t,this.gameType=r,this.players=n,this.status=o,this.currentTurn=l,this.winner=c,this.gameData=d,this.createdAt=u,this.updatedAt=h,this.validate()}validate(){if(!this.id.trim())throw new Error("Game ID cannot be empty");if(this.players.length===0)throw new Error("Game must have at least one player")}static create(e,t,r){const n=new Date().toISOString(),o={metadata:{}};return new at(Ls(),r,t,[e],"waiting",void 0,void 0,o,n,n)}static fromData(e){return new at(e.id,e.name,e.gameType,e.players,e.status,e.currentTurn,e.winner,e.gameData,e.createdAt,e.updatedAt)}addPlayer(e){if(this.players.includes(e))throw new Error("Player already in game");if(this.players.length>=10)throw new Error("Lobby is full");const r=[...this.players,e],n=r.length>=2?"ready":"waiting";return new at(this.id,this.name,this.gameType,r,n,this.currentTurn,this.winner,this.gameData,this.createdAt,new Date().toISOString())}start(){if(this.status!=="ready")throw new Error("Lobby must be in ready state to start");return new at(this.id,this.name,this.gameType,this.players,"in_progress",this.players[0],this.winner,this.gameData,this.createdAt,new Date().toISOString())}updateGameData(e,t){return new at(this.id,this.name,this.gameType,this.players,this.status,t!==void 0?t:this.currentTurn,this.winner,e,this.createdAt,new Date().toISOString())}complete(e){return new at(this.id,this.name,this.gameType,this.players,"completed",void 0,e,this.gameData,this.createdAt,new Date().toISOString())}abandon(){return new at(this.id,this.name,this.gameType,this.players,"abandoned",void 0,this.winner,this.gameData,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,name:this.name,gameType:this.gameType,players:this.players,status:this.status,currentTurn:this.currentTurn,winner:this.winner,gameData:this.gameData,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class rt{constructor(e,t,r,n,o,l,c,d){this.id=e,this.gameId=t,this.name=r,this.description=n,this.emoji=o,this.isActive=l,this.createdAt=c,this.updatedAt=d,this.validate()}validate(){if(!this.id.trim())throw new Error("Persona ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.name.trim())throw new Error("Persona name cannot be empty");if(this.name.length<2)throw new Error("Persona name must be at least 2 characters");if(this.name.length>50)throw new Error("Persona name cannot exceed 50 characters");if(!this.description.trim())throw new Error("Persona description cannot be empty");if(this.description.length<5)throw new Error("Persona description must be at least 5 characters");if(this.description.length>500)throw new Error("Persona description cannot exceed 500 characters")}static create(e,t,r,n){const o=new Date().toISOString();return new rt(Ls(),e.trim(),t.trim(),r.trim(),n.trim(),!1,o,o)}static fromData(e){return new rt(e.id,e.gameId,e.name,e.description,e.emoji,e.isActive,e.createdAt,e.updatedAt)}activate(){return this.isActive?this:new rt(this.id,this.gameId,this.name,this.description,this.emoji,!0,this.createdAt,new Date().toISOString())}deactivate(){return this.isActive?new rt(this.id,this.gameId,this.name,this.description,this.emoji,!1,this.createdAt,new Date().toISOString()):this}update(e,t,r){return new rt(this.id,this.gameId,(e==null?void 0:e.trim())||this.name,(t==null?void 0:t.trim())||this.description,(r==null?void 0:r.trim())||this.emoji,this.isActive,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,gameId:this.gameId,name:this.name,description:this.description,emoji:this.emoji,isActive:this.isActive,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Hu{constructor(e,t=5e3){this.baseUrl=e,this.timeout=t}async createUser(e){const t=`${this.baseUrl}/users`;console.log("[HttpGameService.createUser] Making POST request to:",t),console.log("[HttpGameService.createUser] Request body:",e);try{const r=await this.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("[HttpGameService.createUser] Response received:",r.status);const n=await r.json();return console.log("[HttpGameService.createUser] Response data:",n),{user:pt.fromData(n.user)}}catch(r){throw console.error("[HttpGameService.createUser] ERROR:",r),r}}async getUser(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"GET"})).json();return{user:pt.fromData(r.user)}}async getAllUsers(){return{users:(await(await this.fetchWithTimeout(`${this.baseUrl}/users`,{method:"GET"})).json()).users.map(r=>pt.fromData(r))}}async updateUser(e,t){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{user:pt.fromData(n.user)}}async createGame(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{game:at.fromData(r.game)}}async getGame(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"GET"})).json();return{game:at.fromData(r.game)}}async getAllGames(e){const t=new URLSearchParams;e!=null&&e.status&&t.append("status",e.status),e!=null&&e.gameType&&t.append("gameType",e.gameType),e!=null&&e.playerId&&t.append("playerId",e.playerId);const r=`${this.baseUrl}/games${t.toString()?`?${t.toString()}`:""}`;return{games:(await(await this.fetchWithTimeout(r,{method:"GET"})).json()).games.map(l=>at.fromData(l))}}async joinGame(e,t){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{game:at.fromData(n.game)}}async startGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/start`,{method:"POST"})}async deleteGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"DELETE"})}async createChatMessage(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e.gameId}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderId:e.senderId,senderUsername:e.senderUsername,text:e.text})})).json();return{message:Pt.fromData(r.message)}}async getChatMessages(e){return{messages:(await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"GET"})).json()).messages.map(n=>Pt.fromData(n))}}async clearChatMessages(e){return await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"DELETE"})).json()}async createPersona(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{persona:rt.fromData(r.persona)}}async getPersonas(e){return{personas:(await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"GET"})).json()).personas.map(n=>rt.fromData(n))}}async getPersona(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/detail/${e}`,{method:"GET"})).json();return{persona:rt.fromData(r.persona)}}async updatePersona(e,t){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{persona:rt.fromData(n.persona)}}async deletePersona(e){await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"DELETE"})}async activatePersona(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/activate`,{method:"POST"})).json();return{persona:rt.fromData(r.persona)}}async deactivatePersona(e){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/deactivate`,{method:"POST"})).json();return{persona:rt.fromData(r.persona)}}async fetchWithTimeout(e,t){console.log("[fetchWithTimeout] Starting fetch to:",e),console.log("[fetchWithTimeout] Method:",t.method),console.log("[fetchWithTimeout] Timeout:",this.timeout+"ms");const r=new AbortController,n=setTimeout(()=>r.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:r.signal});if(console.log("[fetchWithTimeout] Response status:",o.status,o.statusText),!o.ok){const l=`HTTP error! status: ${o.status}`;throw console.error("[fetchWithTimeout]",l),new Error(l)}return o}catch(o){if(o instanceof Error&&o.name==="AbortError"){const l=`Request timeout after ${this.timeout}ms`;throw console.error("[fetchWithTimeout]",l),new Error(l)}throw console.error("[fetchWithTimeout] Network error:",o),o}finally{clearTimeout(n)}}}var st=(a=>(a.DISCONNECTED="DISCONNECTED",a.CONNECTING="CONNECTING",a.CONNECTED="CONNECTED",a.RECONNECTING="RECONNECTING",a.ERROR="ERROR",a))(st||{});class Wu{constructor(){X(this,"ws",null);X(this,"config",null);X(this,"connectionState",st.DISCONNECTED);X(this,"messageHandlers",new Set);X(this,"stateHandlers",new Set);X(this,"reconnectAttempts",0);X(this,"reconnectTimeoutId",null);X(this,"heartbeatIntervalId",null)}async connect(e){return this.config=e,this.reconnectAttempts=0,this.doConnect()}async disconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null),this.ws&&(this.ws.close(),this.ws=null),this.updateConnectionState(st.DISCONNECTED)}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");const t={...e,timestamp:new Date().toISOString()};this.ws.send(JSON.stringify(t))}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}onConnectionStateChange(e){return this.stateHandlers.add(e),()=>{this.stateHandlers.delete(e)}}getConnectionState(){return this.connectionState}isConnected(){return this.connectionState===st.CONNECTED}async doConnect(){if(!this.config)throw new Error("Config not set");return new Promise((e,t)=>{this.updateConnectionState(this.reconnectAttempts>0?st.RECONNECTING:st.CONNECTING),this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("[WebSocket] Connected"),this.reconnectAttempts=0,this.updateConnectionState(st.CONNECTED),this.startHeartbeat(),e()},this.ws.onmessage=r=>{try{const n=JSON.parse(r.data);this.handleMessage(n)}catch(n){console.error("[WebSocket] Failed to parse message:",n)}},this.ws.onerror=r=>{console.error("[WebSocket] Error:",r),this.updateConnectionState(st.ERROR),t(r)},this.ws.onclose=()=>{console.log("[WebSocket] Disconnected"),this.stopHeartbeat(),this.connectionState!==st.DISCONNECTED&&this.attemptReconnect()}})}handleMessage(e){e.type!=="pong"&&this.messageHandlers.forEach(t=>{try{t(e)}catch(r){console.error("[WebSocket] Message handler error:",r)}})}attemptReconnect(){if(!this.config)return;const e=this.config.maxReconnectAttempts??10;if(this.reconnectAttempts>=e){console.error(`[WebSocket] Max reconnection attempts (${e}) reached`),this.updateConnectionState(st.ERROR);return}this.reconnectAttempts++;const t=this.config.reconnectInterval??3e3;console.log(`[WebSocket] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${e})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.doConnect().catch(r=>{console.error("[WebSocket] Reconnection failed:",r)})},t)}startHeartbeat(){if(!this.config)return;const e=this.config.heartbeatInterval??3e4;this.heartbeatIntervalId=window.setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping"}).catch(t=>{console.error("[WebSocket] Failed to send heartbeat:",t)})},e)}stopHeartbeat(){this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null)}updateConnectionState(e){this.connectionState!==e&&(this.connectionState=e,this.stateHandlers.forEach(t=>{try{t(e)}catch(r){console.error("[WebSocket] State handler error:",r)}}))}}class Gu{constructor(e){this.httpService=e}async getAll(e){return(await this.httpService.getAllGames(e)).games}async getById(e){try{return(await this.httpService.getGame(e)).game}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){return(await this.httpService.createGame({gameType:e.gameType||"tic-tac-toe",creatorId:e.players[0]})).game}async update(e){return e}async delete(e){await this.httpService.deleteGame(e)}}class Vu{constructor(e){this.httpService=e}async getAll(){return(await this.httpService.getAllUsers()).users}async getById(e){try{return(await this.httpService.getUser(e)).user}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){console.log("[HttpUserRepository.create] Creating user:",{username:e.username,id:e.id});try{const t=await this.httpService.createUser({username:e.username,profilePicture:e.profilePicture});return console.log("[HttpUserRepository.create] User created successfully:",t.user),t.user}catch(t){throw console.error("[HttpUserRepository.create] ERROR:",t),t}}async update(e){return(await this.httpService.updateUser(e.id,{isOnline:e.isOnline,profilePicture:e.profilePicture})).user}async delete(e){console.warn("[HttpUserRepository] Delete not implemented")}}class qu{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createChatMessage({gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,text:e.text});return ee.success(t.message)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to create chat message"))}}async findByGameId(e){try{const t=await this.httpService.getChatMessages(e);return ee.success(t.messages)}catch(t){return t instanceof Error&&t.message.includes("404")?ee.success([]):ee.failure(t instanceof Error?t:new Error("Failed to retrieve chat messages"))}}async deleteByGameId(e){try{return await this.httpService.clearChatMessages(e),ee.success(void 0)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to clear chat messages"))}}}class Ku{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createPersona({gameId:e.gameId,name:e.name,description:e.description,emoji:e.emoji});return ee.success(t.persona)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to create persona"))}}async findByGameId(e){try{const t=await this.httpService.getPersonas(e);return ee.success(t.personas)}catch(t){return t instanceof Error&&t.message.includes("404")?ee.success([]):ee.failure(t instanceof Error?t:new Error("Failed to retrieve personas"))}}async findById(e){try{const t=await this.httpService.getPersona(e);return ee.success(t.persona)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to retrieve persona"))}}async update(e,t){try{const r=await this.httpService.updatePersona(e,{name:t.name,description:t.description,emoji:t.emoji,isActive:t.isActive});return ee.success(r.persona)}catch(r){return ee.failure(r instanceof Error?r:new Error("Failed to update persona"))}}async delete(e){try{return await this.httpService.deletePersona(e),ee.success(void 0)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to delete persona"))}}async activate(e){try{const t=await this.httpService.activatePersona(e);return ee.success(t.persona)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to activate persona"))}}async deactivate(e){try{const t=await this.httpService.deactivatePersona(e);return ee.success(t.persona)}catch(t){return ee.failure(t instanceof Error?t:new Error("Failed to deactivate persona"))}}}class Ju{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var r;const t=await this.personaRepository.create(e);return t.isSuccess&&((r=this.logger)==null||r.log("persona_created",{personaId:t.value.id,gameId:e.gameId,name:e.name,description:e.description,isActive:t.value.isActive})),t}}class Qu{constructor(e){this.personaRepository=e}async execute(e){return await this.personaRepository.findByGameId(e)}}class Yu{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t){var n;const r=await this.personaRepository.update(e,t);return r.isSuccess&&((n=this.logger)==null||n.log("persona_updated",{personaId:e,updates:t,name:r.value.name,gameId:r.value.gameId})),r}}class Xu{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var r;const t=await this.personaRepository.delete(e);return t.isSuccess&&((r=this.logger)==null||r.log("persona_deleted",{personaId:e})),t}}class Zu{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t=!0){var n;const r=t?await this.personaRepository.activate(e):await this.personaRepository.deactivate(e);if(r.isSuccess){const o=t?"persona_activated":"persona_deactivated";(n=this.logger)==null||n.log(o,{personaId:e,isActive:t,name:r.value.name,gameId:r.value.gameId})}return r}}const Ca="CONNECT_REQUEST",Mn="CONNECT_SUCCESS",On="CONNECT_FAILURE",Na="DISCONNECT",$n="CONNECTION_STATE_CHANGED",Un="CREATE_USER_REQUEST",Fn="CREATE_USER_SUCCESS",zn="CREATE_USER_FAILURE",Bn="UPDATE_USER_REQUEST",Hn="UPDATE_USER_SUCCESS",Wn="UPDATE_USER_FAILURE",Gn="FETCH_USERS_REQUEST",Vn="FETCH_USERS_SUCCESS",qn="FETCH_USERS_FAILURE",Kn="SET_USER_ONLINE_REQUEST",Jn="SET_USER_ONLINE_SUCCESS",Qn="SET_USER_ONLINE_FAILURE",Yn="SET_CURRENT_USER",eh="CREATE_GAME_REQUEST",th="CREATE_GAME_SUCCESS",sh="CREATE_GAME_FAILURE",ah="JOIN_GAME_REQUEST",rh="JOIN_GAME_SUCCESS",nh="JOIN_GAME_FAILURE",oh="START_GAME_REQUEST",ih="START_GAME_SUCCESS",ch="START_GAME_FAILURE",lh="MAKE_MOVE_REQUEST",dh="MAKE_MOVE_SUCCESS",uh="MAKE_MOVE_FAILURE",hh="LEAVE_GAME_REQUEST",ph="LEAVE_GAME_SUCCESS",mh="LEAVE_GAME_FAILURE",fh="FETCH_GAMES_REQUEST",gh="FETCH_GAMES_SUCCESS",xh="FETCH_GAMES_FAILURE",bh="GAME_UPDATED",vh="GAME_ENDED",Xn="USER_LIST_UPDATED",Zn="SEND_MESSAGE_REQUEST",eo="SEND_MESSAGE_SUCCESS",to="SEND_MESSAGE_FAILURE",so="FETCH_MESSAGES_REQUEST",ao="FETCH_MESSAGES_SUCCESS",ro="FETCH_MESSAGES_FAILURE",no="CLEAR_MESSAGES_REQUEST",oo="CLEAR_MESSAGES_SUCCESS",io="CLEAR_MESSAGES_FAILURE",co="CHAT_MESSAGE_RECEIVED",lo="CREATE_PERSONA_REQUEST",uo="CREATE_PERSONA_SUCCESS",ho="CREATE_PERSONA_FAILURE",po="FETCH_PERSONAS_REQUEST",mo="FETCH_PERSONAS_SUCCESS",fo="FETCH_PERSONAS_FAILURE",go="UPDATE_PERSONA_REQUEST",xo="UPDATE_PERSONA_SUCCESS",bo="UPDATE_PERSONA_FAILURE",vo="DELETE_PERSONA_REQUEST",yo="DELETE_PERSONA_SUCCESS",wo="DELETE_PERSONA_FAILURE",So="ACTIVATE_PERSONA_REQUEST",jo="ACTIVATE_PERSONA_SUCCESS",Co="ACTIVATE_PERSONA_FAILURE",No="PERSONA_CREATED",Eo="PERSONA_UPDATED",ko="PERSONA_DELETED",To="PERSONA_ACTIVATED",Ao="PERSONA_DEACTIVATED",yh="SET_SELECTED_GAME",wh="CLEAR_ERROR",Cp=()=>({type:Ca}),Sh=()=>({type:Mn}),Wa=a=>({type:On,error:a}),jh=a=>({type:$n,payload:a}),Np=()=>({type:Na}),Ch=a=>({type:Yn,payload:a}),Nh=()=>({type:Gn}),Eh=a=>({type:Vn,payload:a}),kh=a=>({type:qn,error:a}),Th=a=>({type:Xn,payload:a}),Ep=(a,e)=>async t=>{console.log("[createUser] Starting user creation for username:",a),t({type:Un});const r=Le.gameApplicationService;console.log("[createUser] Calling application service...");const n=await r.createUser({username:a,profilePicture:e});console.log("[createUser] Result received:",{isSuccess:n.isSuccess,error:n.isSuccess?null:n.error.message}),n.isSuccess?(console.log("[createUser] Success! User created:",n.value),t({type:Fn,payload:n.value}),t(Ch(n.value))):(console.error("[createUser] FAILURE! Error:",n.error.message),t({type:zn,error:n.error.message}))},kp=(a,e,t)=>async r=>{r({type:Bn});const o=await Le.gameApplicationService.updateUser({userId:a,username:e,profilePicture:t});o.isSuccess?r({type:Hn,payload:o.value}):r({type:Wn,error:o.error.message})},Tp=(a,e)=>async t=>{t({type:Kn});const n=await Le.gameApplicationService.setUserOnline({userId:a,isOnline:e});n.isSuccess?t({type:Jn,payload:n.value}):t({type:Qn,error:n.error.message})},Ap=()=>async a=>{a(Nh());const t=await Le.gameApplicationService.getAllUsers({onlineOnly:!1});t.isSuccess?a(Eh(t.value)):a(kh(t.error.message))},Ah=a=>({type:co,payload:a}),Rh=(a,e,t,r,n,o)=>async l=>{l({type:Zn});const d=await Le.gameApplicationService.sendMessage({gameId:a,senderId:e,senderUsername:t,senderProfilePicture:r,text:n,isFromPersona:o});d.isSuccess?l({type:eo,payload:d.value}):l({type:to,error:d.error.message})},Rp=a=>async e=>{e({type:so});const r=await Le.gameApplicationService.getMessages({gameId:a});r.isSuccess?e({type:ao,payload:r.value}):e({type:ro,error:r.error.message})},Pp=a=>async e=>{e({type:no});const r=await Le.gameApplicationService.clearMessages({gameId:a});r.isSuccess?e({type:oo,payload:a}):e({type:io,error:r.error.message})},Ph={maxContextMessages:10,responseDelay:1e3,maxResponseLength:300};function Ih(a){return`You are ${a.name}, an AI assistant in a multiplayer chat lobby.

Your role and behavior:
${a.description}

Guidelines:
- Stay in character as ${a.name}
- Keep responses concise (under 300 characters)
- Be helpful and engaging
- Respond naturally to the conversation flow
- Don't mention that you're an AI unless directly asked
- Use the persona's personality consistently

Current conversation context will be provided. Respond as ${a.name} would.`}class Dh{constructor(e,t,r){X(this,"isProcessing",!1);X(this,"config");this.ollamaApi=e,this.store=t,this.config={...Ph,...r}}extractMentions(e){const t=/@(\w+)/g;return Array.from(e.matchAll(t)).map(n=>n[1])}async processMessage(e,t){if(console.log("[PersonaResponseService] ========== PROCESSING MESSAGE =========="),console.log("[PersonaResponseService] Message:",e),console.log("[PersonaResponseService] Game ID:",t),this.isProcessing){console.log("[PersonaResponseService] Already processing, skipping");return}try{this.isProcessing=!0;const r=this.store.getState(),n=r.currentUser;if(console.log("[PersonaResponseService] Current user:",n==null?void 0:n.username),console.log("[PersonaResponseService] Total personas in state:",Object.keys(r.personas.byId).length),this.isPersonaMessage(e,r.personas.byId)){console.log("[PersonaResponseService] Message from persona, skipping");return}const o=this.extractMentions(e.text);if(console.log("[PersonaResponseService] Extracted mentions:",o),o.length===0){console.log("[PersonaResponseService] No @mentions in message, skipping");return}console.log("[PersonaResponseService] âœ… Detected @mentions:",o);const c=(r.personas.byGameId[t]||[]).map(u=>r.personas.byId[u]).filter(u=>u&&u.isActive);if(c.length===0){console.log("[PersonaResponseService] No active personas");return}const d=(r.chatMessages[t]||[]).slice(-this.config.maxContextMessages).map(u=>({sender:u.senderUsername,text:u.text,isPersona:this.isPersonaMessage(u,r.personas.byId)}));for(const u of c)o.some(m=>m.toLowerCase()===u.name.toLowerCase())&&(console.log("[PersonaResponseService] Persona @mentioned, generating AI response:",u.name),await this.generatePersonaResponse(u,d,t,n==null?void 0:n.id))}catch(r){console.error("[PersonaResponseService] Error processing message:",r)}finally{this.isProcessing=!1}}isPersonaMessage(e,t){return Object.values(t).some(r=>r.id===e.senderId)}async generatePersonaResponse(e,t,r,n){var o,l;try{await new Promise(m=>setTimeout(m,this.config.responseDelay));const c=[{role:"system",content:Ih(e)},...t.map(m=>({role:m.isPersona?"assistant":"user",content:`${m.sender}: ${m.text}`}))];console.log("[PersonaResponseService] Generating response for:",e.name);const u=(l=(o=(await this.ollamaApi.chat(c,void 0,{stream:!1})).message)==null?void 0:o.content)==null?void 0:l.trim();if(!u){console.log("[PersonaResponseService] No response generated");return}const h=u.length>this.config.maxResponseLength?u.substring(0,this.config.maxResponseLength-3)+"...":u;console.log("[PersonaResponseService] Generated response:",h),this.store.dispatch(Rh(r,e.id,e.name,void 0,h,!0))}catch(c){console.error("[PersonaResponseService] Error generating response for",e.name,c)}}}const Ip=["gpt-oss:latest","gemma3:4b","gemma3:27b","qwen2.5:32b","qwen3:4b","qwen3:30b","qwen3-vl:latest","qwen3-vl:4b","granite3.2-vision","granite4:small-h","deepseek-r1:32b"],Ro="gemma3:27b",Ga="http://192.168.2.185:11434";class _h{constructor(e=Ro){this.model=e}async generateStructuredCompletion(e,t,r=this.model,n){return((n==null?void 0:n.useEndpoint)??"chat")==="chat"?this.generateStructuredCompletionWithChat(e,t,r,n):this.generateStructuredCompletionWithGenerate(e,t,r,n)}async generateStructuredCompletionWithChat(e,t,r,n){var d;const o=(n==null?void 0:n.system)??"You are a helpful assistant. Always respond in valid JSON format according to the provided schema.",l=await this.chat([{role:"system",content:o},{role:"user",content:e,images:n==null?void 0:n.images}],r,{format:t,stream:!1,signal:n==null?void 0:n.signal});console.log("ðŸ” Raw chat API result:",l);const c=(d=l.message)==null?void 0:d.content;if(console.log("ðŸ” Response type:",typeof c),console.log("ðŸ” Response value:",c),!c)throw console.error("âŒ Empty response from API:",l),new Error("Received empty response from Ollama API");if(typeof c=="string"){if(c.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(c)}catch(u){throw console.error("âŒ JSON parse error. Response was:",c),new Error(`Failed to parse JSON response: ${u instanceof Error?u.message:"Unknown error"}`)}}return c}async generateStructuredCompletionWithGenerate(e,t,r,n){const o=await this.generateCompletion(e,r,{...n,format:t});if(console.log("ðŸ” Raw generate API result:",o),console.log("ðŸ” Response type:",typeof o.response),console.log("ðŸ” Response value:",o.response),!o.response)throw console.error("âŒ Empty response from API:",o),new Error("Received empty response from Ollama API");if(typeof o.response=="string"){if(o.response.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(o.response)}catch(l){throw console.error("âŒ JSON parse error. Response was:",o.response),new Error(`Failed to parse JSON response: ${l instanceof Error?l.message:"Unknown error"}`)}}return o.response}async generateCompletion(e,t=this.model,r){var y;const{suffix:n,images:o,format:l,system:c,template:d,stream:u,raw:h,keep_alive:m,context:g,onStreamChunk:b,signal:w}=r??{stream:!1},p=`${Ga}/api/generate`,v=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:e,suffix:n,images:o,format:l,options:r==null?void 0:r.options,system:c,template:d,stream:u,raw:h,keep_alive:m,context:g}),signal:w});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);if(u&&v.headers.get("Content-Type")==="application/x-ndjson"){const f=(y=v.body)==null?void 0:y.getReader(),x=new TextDecoder("utf-8");let C="",j="";for(;;){const{done:S,value:N}=await(f==null?void 0:f.read())??{};if(S)break;C+=x.decode(N,{stream:!0});const T=C.split(`
`);C=T.pop();for(const W of T)if(W.trim()){const L=JSON.parse(W);L.response&&(j+=L.response,b==null||b(L.response)),console.log(L)}}return{response:j}}else{const f=await v.json();return console.log("ðŸ“¥ Non-streaming API response:",f),f}}async chat(e,t=this.model,r){var m,g;const{stream:n,format:o,keep_alive:l,onStreamChunk:c,signal:d}=r??{},u=`${Ga}/api/chat`,h=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,format:o,stream:n,keep_alive:l}),signal:d});if(!h.ok)throw new Error(`HTTP error! status: ${h.status}`);if(n&&h.headers.get("Content-Type")==="application/x-ndjson"){const b=(m=h.body)==null?void 0:m.getReader(),w=new TextDecoder("utf-8");let p="",v="";for(;;){const{done:y,value:f}=await(b==null?void 0:b.read())??{};if(y)break;p+=w.decode(f,{stream:!0});const x=p.split(`
`);p=x.pop();for(const C of x)if(C.trim()){const j=JSON.parse(C);(g=j.message)!=null&&g.content&&(v+=j.message.content,c==null||c(j.message.content)),console.log(j)}}return{message:{role:"assistant",content:v}}}else return await h.json()}}const Lh=new _h(Ro),oa="game_current_user";function Mh(){try{const a=localStorage.getItem(oa);return a?JSON.parse(a):null}catch(a){return console.error("[gameReducer] Failed to load currentUser from localStorage:",a),null}}function Ot(a){try{a?localStorage.setItem(oa,JSON.stringify(a)):localStorage.removeItem(oa)}catch(e){console.error("[gameReducer] Failed to save currentUser to localStorage:",e)}}const Oh={connectionState:"DISCONNECTED",isConnected:!1,currentUser:Mh(),users:[],usersLoading:!1,usersError:null,games:[],gamesLoading:!1,gamesError:null,selectedGameId:null,chatMessages:{},chatLoading:!1,chatError:null,personas:{byId:{},byGameId:{},loading:!1,error:null},loading:!1,error:null};function Va(a=Oh,e){var t,r,n,o,l;switch(e.type){case Ca:return{...a,loading:!0,error:null};case Mn:return{...a,loading:!1,isConnected:!0,error:null};case On:return{...a,loading:!1,isConnected:!1,error:e.error};case Na:return{...a,isConnected:!1,connectionState:"DISCONNECTED"};case $n:return{...a,connectionState:e.payload,isConnected:e.payload==="CONNECTED"};case Yn:{const c={...a,currentUser:e.payload};return Ot(e.payload),c}case Un:return{...a,usersLoading:!0,usersError:null};case Fn:{const c={...a,usersLoading:!1,currentUser:e.payload,users:[...a.users,e.payload],usersError:null};return Ot(e.payload),c}case zn:return{...a,usersLoading:!1,usersError:e.error};case Bn:return{...a,usersLoading:!0,usersError:null};case Hn:{const c=((t=a.currentUser)==null?void 0:t.id)===e.payload.id?e.payload:a.currentUser,d={...a,usersLoading:!1,currentUser:c,users:a.users.map(u=>u.id===e.payload.id?e.payload:u),usersError:null};return((r=a.currentUser)==null?void 0:r.id)===e.payload.id&&Ot(e.payload),d}case Wn:return{...a,usersLoading:!1,usersError:e.error};case Gn:return{...a,usersLoading:!0,usersError:null};case Vn:{const c=e.payload,d=a.currentUser?c.find(h=>h.id===a.currentUser.id):null,u=d?a.currentUser:null;return!d&&a.currentUser&&(console.warn("[gameReducer] Current user not found in backend, clearing localStorage"),Ot(null)),{...a,usersLoading:!1,currentUser:u,users:c,usersError:null}}case qn:return{...a,usersLoading:!1,usersError:e.error};case Kn:return{...a,usersLoading:!0,usersError:null};case Jn:{const c=((n=a.currentUser)==null?void 0:n.id)===e.payload.id?e.payload:a.currentUser,d={...a,usersLoading:!1,currentUser:c,users:a.users.map(u=>u.id===e.payload.id?e.payload:u),usersError:null};return((o=a.currentUser)==null?void 0:o.id)===e.payload.id&&Ot(e.payload),d}case Qn:return{...a,usersLoading:!1,usersError:e.error};case Xn:return{...a,users:e.payload};case eh:return{...a,gamesLoading:!0,gamesError:null};case th:return{...a,gamesLoading:!1,games:[...a.games,e.payload],gamesError:null};case sh:return{...a,gamesLoading:!1,gamesError:e.error};case ah:return{...a,gamesLoading:!0,gamesError:null};case rh:return{...a,gamesLoading:!1,games:a.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case nh:return{...a,gamesLoading:!1,gamesError:e.error};case oh:return{...a,gamesLoading:!0,gamesError:null};case ih:return{...a,gamesLoading:!1,games:a.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case ch:return{...a,gamesLoading:!1,gamesError:e.error};case lh:return{...a,gamesLoading:!0,gamesError:null};case dh:return{...a,gamesLoading:!1,games:a.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case uh:return{...a,gamesLoading:!1,gamesError:e.error};case hh:return{...a,gamesLoading:!0,gamesError:null};case ph:return{...a,gamesLoading:!1,games:a.games.filter(c=>c.id!==e.payload),gamesError:null};case mh:return{...a,gamesLoading:!1,gamesError:e.error};case fh:return{...a,gamesLoading:!0,gamesError:null};case gh:return{...a,gamesLoading:!1,games:e.payload,gamesError:null};case xh:return{...a,gamesLoading:!1,gamesError:e.error};case bh:return{...a,games:a.games.map(c=>c.id===e.payload.id?e.payload:c)};case vh:return{...a,games:a.games.filter(c=>c.id!==e.payload)};case Zn:return{...a,chatLoading:!0,chatError:null};case eo:{const c=e.payload,d=a.chatMessages[c.gameId]||[];return{...a,chatLoading:!1,chatMessages:{...a.chatMessages,[c.gameId]:[...d,c]},chatError:null}}case to:return{...a,chatLoading:!1,chatError:e.error};case so:return{...a,chatLoading:!0,chatError:null};case ao:{if(e.payload.length===0)return{...a,chatLoading:!1,chatError:null};const c=e.payload[0].gameId;return{...a,chatLoading:!1,chatMessages:{...a.chatMessages,[c]:e.payload},chatError:null}}case ro:return{...a,chatLoading:!1,chatError:e.error};case no:return{...a,chatLoading:!0,chatError:null};case oo:{const c=e.payload;return{...a,chatLoading:!1,chatMessages:{...a.chatMessages,[c]:[]},chatError:null}}case io:return{...a,chatLoading:!1,chatError:e.error};case co:{const c=e.payload,d=a.chatMessages[c.gameId]||[];return d.find(u=>u.id===c.id)?a:{...a,chatMessages:{...a.chatMessages,[c.gameId]:[...d,c]}}}case lo:case po:case go:case vo:case So:return{...a,personas:{...a.personas,loading:!0,error:null}};case uo:case No:{const{persona:c}=e.payload;return{...a,personas:{...a.personas,byId:{...a.personas.byId,[c.id]:c},byGameId:{...a.personas.byGameId,[c.gameId]:[...a.personas.byGameId[c.gameId]||[],c.id]},loading:!1}}}case mo:{const{personas:c}=e.payload,d={},u={};return c.forEach(h=>{d[h.id]=h,u[h.gameId]||(u[h.gameId]=[]),u[h.gameId].push(h.id)}),{...a,personas:{...a.personas,byId:{...a.personas.byId,...d},byGameId:{...a.personas.byGameId,...u},loading:!1}}}case xo:case Eo:case jo:case To:case Ao:{const{persona:c}=e.payload;return{...a,personas:{...a.personas,byId:{...a.personas.byId,[c.id]:c},loading:!1}}}case yo:case ko:{const c="id"in e.payload?e.payload.id:e.payload.personaId,d=a.personas.byId[c];if(!d)return a;const{[c]:u,...h}=a.personas.byId,m=((l=a.personas.byGameId[d.gameId])==null?void 0:l.filter(g=>g!==c))||[];return{...a,personas:{...a.personas,byId:h,byGameId:{...a.personas.byGameId,[d.gameId]:m},loading:!1}}}case ho:case fo:case bo:case wo:case Co:return{...a,personas:{...a.personas,loading:!1,error:e.payload.error}};case yh:return{...a,selectedGameId:e.payload};case wh:return{...a,error:null,gamesError:null,usersError:null};default:return a}}const $h=()=>({type:lo}),Uh=a=>({type:uo,payload:{persona:a}}),Fh=a=>({type:ho,payload:{error:a}}),zh=()=>({type:po}),Bh=a=>({type:mo,payload:{personas:a}}),Hh=a=>({type:fo,payload:{error:a}}),Wh=()=>({type:go}),Gh=a=>({type:xo,payload:{persona:a}}),Vh=a=>({type:bo,payload:{error:a}}),qh=()=>({type:vo}),Kh=a=>({type:yo,payload:{id:a}}),Jh=a=>({type:wo,payload:{error:a}}),Po=()=>({type:So}),Io=a=>({type:jo,payload:{persona:a}}),Do=a=>({type:Co,payload:{error:a}}),Qh=a=>({type:No,payload:{persona:a}}),Yh=a=>({type:Eo,payload:{persona:a}}),Xh=a=>({type:ko,payload:{personaId:a}}),Zh=a=>({type:To,payload:{persona:a}}),ep=a=>({type:Ao,payload:{persona:a}}),Dp=(a,e,t,r)=>async n=>{n($h());const o=await Le.personaUseCases.createPersona.execute({gameId:a,name:e,description:t,emoji:r});o.isSuccess?n(Uh(o.value.toJSON())):n(Fh(o.error.message))},_p=a=>async e=>{e(zh());const t=await Le.personaUseCases.getPersonas.execute(a);t.isSuccess?e(Bh(t.value.map(r=>r.toJSON()))):e(Hh(t.error.message))},Lp=(a,e)=>async t=>{t(Wh());const r=await Le.personaUseCases.updatePersona.execute(a,e);r.isSuccess?t(Gh(r.value.toJSON())):t(Vh(r.error.message))},Mp=a=>async e=>{e(qh());const t=await Le.personaUseCases.deletePersona.execute(a);t.isSuccess?e(Kh(a)):e(Jh(t.error.message))},Op=a=>async e=>{e(Po());const t=await Le.personaUseCases.activatePersona.execute(a,!0);t.isSuccess?e(Io(t.value.toJSON())):e(Do(t.error.message))},$p=a=>async e=>{e(Po());const t=await Le.personaUseCases.activatePersona.execute(a,!1);t.isSuccess?e(Io(t.value.toJSON())):e(Do(t.error.message))},tp=a=>{let e=!1;return t=>r=>{const n=t(r);if(r.type===Ca){if(e)return console.log("[WebSocket Middleware] Connection already initialized"),n;e=!0;const o=Le.webSocketService,l=Le.webSocketConfig;o.onMessage(c=>{switch(console.log("[WebSocket Middleware] Received message:",c.type),c.type){case"chat_message":{const u=c.message;u.isIntroduction&&u.isPersona?console.log(`[WebSocket Middleware] ðŸŽ­ Persona introduction received from ${u.senderUsername}:`,u.text):u.isPersona?console.log(`[WebSocket Middleware] ðŸ¤– Persona message received from ${u.senderUsername}:`,u.text):console.log("[WebSocket Middleware] Chat message received:",u),a.dispatch(Ah(u));break}case"user_list":{const u=c.users;console.log("[WebSocket Middleware] User list updated:",u.length,"users"),a.dispatch(Th(u));break}case"game_update":{const u=c.game;console.log("[WebSocket Middleware] Game update received:",u.id);break}case"PERSONA_CREATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona created:",u.id),a.dispatch(Qh(u));break}case"PERSONA_UPDATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona updated:",u.id),a.dispatch(Yh(u));break}case"PERSONA_DELETED":{const u=c.personaId;console.log("[WebSocket Middleware] Persona deleted:",u),a.dispatch(Xh(u));break}case"PERSONA_ACTIVATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona activated:",u.id),a.dispatch(Zh(u));break}case"PERSONA_DEACTIVATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona deactivated:",u.id),a.dispatch(ep(u));break}case"error":{const u=c.message;console.error("[WebSocket Middleware] Error from server:",u);break}}}),o.onConnectionStateChange(c=>{if(a.dispatch(jh(c)),c===st.CONNECTED){a.dispatch(Sh());const u=a.getState().currentUser;u?(console.log(`[WebSocket Middleware] Sending JOIN message for user ${u.username} (${u.id})`),o.send({type:"join",userId:u.id,username:u.username}).catch(h=>{console.error("[WebSocket Middleware] Failed to send JOIN message:",h)})):console.warn("[WebSocket Middleware] No currentUser available to send JOIN message")}else c===st.ERROR&&a.dispatch(Wa("WebSocket connection failed"))}),o.connect(l).then(()=>{console.log("[WebSocket Middleware] Successfully connected")}).catch(c=>{console.error("[WebSocket Middleware] Connection error:",c),a.dispatch(Wa(c instanceof Error?c.message:"Unknown connection error")),e=!1})}return r.type===Na&&Le.webSocketService.disconnect().then(()=>{console.log("[WebSocket Middleware] Disconnected"),e=!1}).catch(l=>{console.error("[WebSocket Middleware] Disconnect error:",l),e=!1}),n}},sp=a=>e=>t=>e(t),ap=a=>e=>t=>typeof t=="function"?t(a.dispatch,a.getState):e(t);function rp(a=!0){let e=Va(void 0,{type:"@@INIT"});const t=new Set,r={getState(){return e},dispatch(n){let o=l=>(e=Va(e,l),t.forEach(c=>c()),l);return o=tp(r)(o),o=ap(r)(o),a&&(o=sp()(o)),o(n)},subscribe(n){return t.add(n),()=>{t.delete(n)}}};return r}class np{constructor(){X(this,"_httpService",null);X(this,"_webSocketService",null);X(this,"_gameRepository",null);X(this,"_userRepository",null);X(this,"_chatRepository",null);X(this,"_personaRepository",null);X(this,"_store",null);X(this,"_gameApplicationService",null);X(this,"_config",null);X(this,"_personaUseCases",null);X(this,"_personaResponseService",null);X(this,"_logger",null)}get config(){if(!this._config){const e=()=>`http://${window.location.hostname}:3030/api/multiplayer`,t=()=>`ws://${window.location.hostname}:3030/multiplayer`;this._config={httpApiBaseUrl:e(),webSocketUrl:t(),enableLogging:!0,webSocketReconnectInterval:parseInt("3000",10),webSocketMaxReconnectAttempts:parseInt("10",10),webSocketHeartbeatInterval:parseInt("30000",10),clientLogsEnabled:!0,clientLogsApiBaseUrl:"http://localhost:3030/client-logs"}}return this._config}get httpService(){return this._httpService||(this._httpService=new Hu(this.config.httpApiBaseUrl,5e3)),this._httpService}get webSocketService(){return this._webSocketService||(this._webSocketService=new Wu),this._webSocketService}get gameRepository(){return this._gameRepository||(this._gameRepository=new Gu(this.httpService)),this._gameRepository}get userRepository(){return this._userRepository||(this._userRepository=new Vu(this.httpService)),this._userRepository}get chatRepository(){return this._chatRepository||(this._chatRepository=new qu(this.httpService)),this._chatRepository}get personaRepository(){return this._personaRepository||(this._personaRepository=new Ku(this.httpService)),this._personaRepository}get personaUseCases(){if(!this._personaUseCases){const e=this.personaRepository,t=this.logger;this._personaUseCases={createPersona:new Ju(e,t),getPersonas:new Qu(e),updatePersona:new Yu(e,t),deletePersona:new Xu(e,t),activatePersona:new Zu(e,t)}}return this._personaUseCases}get clientLogsApiClient(){return Vs.clientLogsApiClient}get clientLogsService(){return Vs.clientLogsService}get logger(){return Vs.logger}get gameApplicationService(){return this._gameApplicationService||(this._gameApplicationService=new Bu(this.userRepository,this.chatRepository,this.webSocketService,this.logger)),this._gameApplicationService}get store(){return this._store||(this._store=rp(this.config.enableLogging)),this._store}get personaResponseService(){return this._personaResponseService||(this._personaResponseService=new Dh(Lh,this.store)),this._personaResponseService}get webSocketConfig(){return{url:this.config.webSocketUrl,reconnectInterval:this.config.webSocketReconnectInterval,maxReconnectAttempts:this.config.webSocketMaxReconnectAttempts,heartbeatInterval:this.config.webSocketHeartbeatInterval}}reset(){this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._personaResponseService=null,this._store=null,this._gameApplicationService=null,this._config=null}setHttpService(e){this._httpService=e,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._gameApplicationService=null}setWebSocketService(e){this._webSocketService=e,this._gameApplicationService=null}setGameRepository(e){this._gameRepository=e,this._gameApplicationService=null}setUserRepository(e){this._userRepository=e,this._gameApplicationService=null}setGameApplicationService(e){this._gameApplicationService=e}setLogger(e){this._logger=e,this._gameApplicationService=null}setConfig(e){this._config={...this.config,...e},this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._gameApplicationService=null,this._store=null}}const Le=new np;function op({navigate:a}){return[{id:"nav-home",label:"Go to Home",shortcut:"Ctrl+H",action:()=>a("/"),group:"Navigation"},{id:"nav-chat",label:"Go to Chat",action:()=>a("/chat"),group:"Navigation"},{id:"nav-demo",label:"Go to Demo",action:()=>a("/demo"),group:"Navigation"},{id:"nav-settings",label:"Go to Settings",action:()=>a("/settings"),group:"Navigation"},{id:"nav-todo",label:"Go to Todo",action:()=>a("/todo"),group:"Navigation"},{id:"nav-kanban",label:"Go to Kanban Board",action:()=>a("/todo/kanban"),group:"Navigation"},{id:"nav-content",label:"Go to Content",action:()=>a("/content"),group:"Navigation"},{id:"nav-vocabulary",label:"Go to Vocabulary",action:()=>a("/vocabulary"),group:"Navigation"},{id:"nav-live-transcription",label:"Go to Live Transcription",action:()=>a("/live-transcription"),group:"Navigation"},{id:"nav-claude",label:"Go to Claude",action:()=>a("/claude"),group:"Navigation"},{id:"nav-state",label:"Go to Global State",action:()=>a("/state"),group:"Navigation"},{id:"toggle-element-inspector",label:"Toggle Element Inspector",shortcut:"Ctrl+Shift+I",action:()=>{Ke.toggle();const e=Ke.getState();Je.success(`Element Inspector ${e?"activated":"deactivated"}`,{description:e?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})},group:"Tools"},{id:"toggle-fullscreen",label:"Toggle Fullscreen",shortcut:"F11",action:()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{Je.success("Fullscreen mode deactivated",{duration:2e3})}).catch(e=>{Je.error("Failed to exit fullscreen",{description:e.message,duration:3e3})}):document.documentElement.requestFullscreen().then(()=>{Je.success("Fullscreen mode activated",{description:"Press F11 or ESC to exit fullscreen",duration:2e3})}).catch(e=>{Je.error("Failed to enter fullscreen",{description:e.message,duration:3e3})})},group:"Tools"}]}function ip(){const{logs:a,actions:e}=Or(),t=ia(),r=qa(),[n,o]=i.useState(null);pc({loadOnMount:!0,subscribeToSSE:!1}),bc({loadOnMount:!0}),vc(),i.useEffect(()=>{localStorage.getItem("VITE_CLEAR_LOGS_ON_RELOAD"),Le.clientLogsService.clearLogs(),Le.clientLogsApiClient.clearLogs("spec-view-debug.log"),Le.clientLogsApiClient.clearLogs("write-mode-debug.log","/new-home")},[t.pathname]);const l=op({navigate:r});return i.useEffect(()=>{(async()=>{})()},[]),i.useEffect(()=>{const c=us.register({key:"c",callback:()=>{console.clear(),Je.success("Console cleared",{duration:1500})}});return()=>c()},[]),i.useEffect(()=>{document.title=ll(t.pathname)},[t.pathname]),s.jsxs(qr,{defaultOpen:!1,children:[s.jsx(Eu,{actions:l}),s.jsx(Pu,{}),s.jsx(Iu,{}),s.jsx(pl,{}),s.jsx(Qr,{className:"h-screen overflow-hidden",children:s.jsxs("div",{className:"h-full bg-background flex flex-col",children:[s.jsx(Su,{version:n}),s.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:s.jsx(dl,{logger:e,logs:a})})]})})]})}Fo.createRoot(document.getElementById("root")).render(s.jsx(fl,{defaultTheme:"light",storageKey:"watcher-ui-theme",children:s.jsx(zo,{children:s.jsx(ip,{})})}));export{Ia as $,yd as A,ae as B,Xt as C,ya as D,ut as E,Sa as F,Vt as G,qt as H,_e as I,wn as J,pc as K,Ip as L,ja as M,Ye as N,_h as O,Ud as P,Y as Q,Id as R,vt as S,Tn as T,Dd as U,Pe as V,D as W,dt as X,Fr as Y,Pa as Z,Ue as _,mt as a,Op as a$,Da as a0,ma as a1,ws as a2,lt as a3,$a as a4,gn as a5,fn as a6,fa as a7,St as a8,Nn as a9,jc as aA,Br as aB,Dn as aC,js as aD,Cn as aE,us as aF,Ra as aG,ms as aH,fs as aI,gs as aJ,Ht as aK,ga as aL,Le as aM,Ap as aN,Ep as aO,kp as aP,Tp as aQ,Ch as aR,Cp as aS,Np as aT,Rh as aU,Rp as aV,Pp as aW,Dp as aX,_p as aY,Lp as aZ,Mp as a_,Ae as aa,ht as ab,$e as ac,He as ad,Me as ae,Ur as af,Te as ag,on as ah,Ke as ai,Au as aj,Pu as ak,Tu as al,Cd as am,Ys as an,vp as ao,ta as ap,Lh as aq,dn as ar,yc as as,pu as at,Ad as au,kn as av,xl as aw,Ec as ax,mp as ay,pe as az,yt as b,$p as b0,Rs as b1,Is as b2,Ds as b3,Gt as b4,kt as b5,wu as b6,Ln as b7,Zs as b8,qd as b9,it as bA,$l as bB,Ul as bC,un as bD,hn as bE,Wl as bF,Gl as bG,xp as bH,fp as bI,gp as bJ,uu as ba,gt as bb,xt as bc,Gd as bd,bs as be,bp as bf,vs as bg,ys as bh,Wt as bi,nn as bj,Cl as bk,aa as bl,Ft as bm,ds as bn,wp as bo,yp as bp,ze as bq,tu as br,Vl as bs,ju as bt,Cs as bu,Vs as bv,su as bw,Sp as bx,ra as by,jp as bz,ft as c,ye as d,qr as e,Kr as f,Yr as g,Xr as h,Mc as i,Oc as j,Uc as k,Zr as l,$t as m,Ut as n,Qr as o,Jr as p,Ge as q,ba as r,va as s,Ml as t,Zt as u,Fs as v,Be as w,qe as x,As as y,de as z};
