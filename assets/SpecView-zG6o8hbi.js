var we=Object.defineProperty;var ve=(a,e,t)=>e in a?we(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var ie=(a,e,t)=>ve(a,typeof e!="symbol"?e+"":e,t);import{j as s,r as v}from"./react-vendor-CrhW4DYn.js";import{B as I,z as oe,w as se,ag as ce}from"./index-CgyRe94A.js";import{a6 as le,a7 as de,aV as be,Z as Se,as as ye,D as te,a2 as ue,S as fe,al as je,aW as Fe}from"./icons-6Gjq1X59.js";class Be{constructor(){ie(this,"configs",new Map)}register(e,t){this.configs.set(e,t)}getConfig(e){return this.configs.get(e)}getConfigForFeature(e){for(const t of this.configs.values())if(t.features.includes(e))return t;return null}getAllStepDefinitions(){const e={};for(const t of this.configs.values())Object.assign(e,t.stepDefinitions);return e}createContextForFeature(e,t){const n=this.getConfigForFeature(e);if(!n){const r=[];for(const c of this.configs.values())r.push(...c.features);throw console.error("[FacadeRegistry] Looking for feature:",e),console.error("[FacadeRegistry] Registered features:",r),console.error("[FacadeRegistry] Config keys:",Array.from(this.configs.keys())),new Error(`No facade configuration found for feature: ${e}`)}return n.createContext(t)}getRegisteredNames(){return Array.from(this.configs.keys())}hasFeature(e){return this.getConfigForFeature(e)!==null}clear(){this.configs.clear()}}class Ee{constructor(e,t={},n){this.registry=e,this.facades=t,this.selfImprovingFacade=n}parseStep(e){const t=[],n=[],r=/\"([^\"]*)\"/g;let c;for(;(c=r.exec(e))!==null;)t.push(c[1]);const d=/\b(\d+)\b/g,o=e.replace(r,"");for(;(c=d.exec(o))!==null;)n.push(parseInt(c[1],10));const g=e.replace(/\"[^\"]*\"/g,"{string}").replace(/\b\d+\b/g,"{int}"),p={};return t.forEach((m,h)=>{p[`string${h}`]=m}),n.forEach((m,h)=>{p[`int${h}`]=m}),{template:g,params:p}}async executeStep(e,t,n){const{template:r,params:c}=this.parseStep(e),d=n[r];if(!d)throw new Error(`No step definition found for: "${r}"`);Object.keys(c).length>0?await d(t,c):await d(t)}async executeSteps(e,t,n,r){if(!e)return;const c=r!==void 0?e.slice(0,r):e;for(const d of c)await this.executeStep(d.text,t,n)}async runScenario(e,t){const n=performance.now();try{const r=this.facades.grid;if(r&&typeof r.setCellText=="function"){const p=r.getDimensions();for(let m=0;m<p.rows;m++)for(let h=0;h<p.cols;h++)r.setCellText(h,m,"");r.setCurrentPosition([0,0])}const c=this.facades.todo;c&&typeof c.clearAll=="function"&&(c.clearAll(),await new Promise(p=>setTimeout(p,100)));const d=this.registry.getAllStepDefinitions(),o=this.registry.createContextForFeature(e,this.facades);await this.executeSteps(t.steps.Given,o,d),await this.executeSteps(t.steps.When,o,d),await this.executeSteps(t.steps.Then,o,d);const g=performance.now()-n;return{feature:e,scenario:t.scenario,status:"pass",duration:g}}catch(r){const c=performance.now()-n;return this.selfImprovingFacade&&typeof this.selfImprovingFacade.captureTestFailure=="function"&&this.selfImprovingFacade.captureTestFailure({feature:e,scenario:t.scenario,error:r}),{feature:e,scenario:t.scenario,status:"fail",error:r instanceof Error?r.message:String(r),duration:c}}}async runScenarioUpToStep(e,t,n,r){const c=performance.now();try{const d=this.facades.grid;if(d&&typeof d.setCellText=="function"){const h=d.getDimensions();for(let E=0;E<h.rows;E++)for(let y=0;y<h.cols;y++)d.setCellText(y,E,"");d.setCurrentPosition([0,0])}const o=this.facades.todo;o&&typeof o.clearAll=="function"&&o.clearAll();const g=this.registry.getAllStepDefinitions(),p=this.registry.createContextForFeature(e,this.facades);if(t.steps.Given){const h=n==="Given"?r+1:t.steps.Given.length;await this.executeSteps(t.steps.Given,p,g,h)}if(n!=="Given"&&t.steps.When){const h=n==="When"?r+1:t.steps.When.length;await this.executeSteps(t.steps.When,p,g,h)}if(n==="Then"&&t.steps.Then){const h=r+1;await this.executeSteps(t.steps.Then,p,g,h)}const m=performance.now()-c;return{feature:e,scenario:t.scenario,status:"pass",duration:m}}catch(d){const o=performance.now()-c;return this.selfImprovingFacade&&typeof this.selfImprovingFacade.captureTestFailure=="function"&&this.selfImprovingFacade.captureTestFailure({feature:e,scenario:t.scenario,error:d}),{feature:e,scenario:t.scenario,status:"fail",error:d instanceof Error?d.message:String(d),duration:o}}}async runFeature(e){const t=[];for(const n of e.scenarios){const r=await this.runScenario(e.feature,n);t.push(r),await new Promise(c=>setTimeout(c,100))}return t}updateFacades(e){this.facades=e}}let pe=1;function ae(a){pe=Math.max(.03,Math.min(5,a))}async function $(a){return new Promise(e=>setTimeout(e,Math.round(a*pe)))}async function $e(a,e=50){a.scrollIntoView({behavior:"smooth",block:"center"}),await $(100);const t=new MouseEvent("mousedown",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(t),await $(e);const n=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(n);const r=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(r),await $(50)}async function Te(a,e,t=50){var d,o;a.focus(),await $(50);const n=(d=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:d.set,r=(o=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:o.set;a instanceof HTMLInputElement&&n?n.call(a,""):a instanceof HTMLTextAreaElement&&r&&r.call(a,""),a.dispatchEvent(new Event("input",{bubbles:!0})),await $(50),a instanceof HTMLInputElement&&n?n.call(a,e):a instanceof HTMLTextAreaElement&&r&&r.call(a,e);const c=new Event("input",{bubbles:!0});a.dispatchEvent(c),await $(100)}async function Ce(a){a.focus(),await $(50),a.value="",a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),a.blur(),await $(50)}async function ke(a,e="center"){a.scrollIntoView({behavior:"smooth",block:e}),await $(200)}async function Ne(a,e=5e3,t=document){const n=Date.now();for(;Date.now()-n<e;){const r=t.querySelector(a);if(r)return r;await $(100)}throw new Error(`Element not found after ${e}ms: ${a}`)}async function Ie(a,e=5e3,t=100){const n=Date.now();for(;Date.now()-n<e;){if(await Promise.resolve(a()))return;await $(t)}throw new Error(`Condition not met after ${e}ms`)}async function Le(a=100){return $(a)}function Me(a,e="red",t){const n=a.style.outline,r=a.style.outlineOffset,c=a.style.position,d=a.style.zIndex;a.style.outline=`3px solid ${e}`,a.style.outlineOffset="2px",a.style.position="relative",a.style.zIndex="10000";let o=null;return t&&(o=document.createElement("div"),o.textContent=t,o.style.position="absolute",o.style.top="-30px",o.style.left="0",o.style.backgroundColor=e,o.style.color="white",o.style.padding="4px 8px",o.style.fontSize="12px",o.style.fontWeight="bold",o.style.borderRadius="4px",o.style.zIndex="10001",o.style.whiteSpace="nowrap",a.appendChild(o)),a.scrollIntoView({behavior:"smooth",block:"center"}),()=>{a.style.outline=n,a.style.outlineOffset=r,a.style.position=c,a.style.zIndex=d,o&&o.parentElement&&o.parentElement.removeChild(o)}}const Ve=Object.freeze(Object.defineProperty({__proto__:null,highlightElement:Me,scrollToElement:ke,setE2ESpeed:ae,simulateClear:Ce,simulateClick:$e,simulateType:Te,wait:$,waitFor:Ie,waitForElement:Ne,waitForReactUpdate:Le},Symbol.toStringTag,{value:"Module"})),K="self-improving:data",P={testFailures:[],e2eSpeed:1,e2eTestResults:{},bddTestResults:{},selfImproveLogs:[],uiModeStepDelay:500};class re{static loadData(){try{const e=localStorage.getItem(K);if(!e)return{...P};const t=JSON.parse(e);return{testFailures:t.testFailures??P.testFailures,e2eSpeed:t.e2eSpeed??P.e2eSpeed,e2eTestResults:t.e2eTestResults??P.e2eTestResults,bddTestResults:t.bddTestResults??P.bddTestResults,selfImproveLogs:t.selfImproveLogs??P.selfImproveLogs,uiModeStepDelay:t.uiModeStepDelay??P.uiModeStepDelay}}catch(e){return console.error("[SelfImprovingPersistence] Failed to load data:",e),{...P}}}static saveData(e){try{localStorage.setItem(K,JSON.stringify(e))}catch(t){console.error("[SelfImprovingPersistence] Failed to save data:",t)}}static updateField(e,t){const n=this.loadData();n[e]=t,this.saveData(n)}static saveTestFailures(e){this.updateField("testFailures",e)}static loadTestFailures(){return this.loadData().testFailures}static clearTestFailures(){this.updateField("testFailures",[])}static addTestFailure(e){const n=this.loadTestFailures().filter(r=>!(r.feature===e.feature&&r.scenario===e.scenario));this.saveTestFailures([e,...n])}static removeTestFailure(e){const n=this.loadTestFailures().filter(r=>!(r.feature===e.feature&&r.scenario===e.scenario));this.saveTestFailures(n)}static getTestFailureCount(){return this.loadTestFailures().length}static saveE2ESpeed(e){const t=Math.max(.03,Math.min(5,e));this.updateField("e2eSpeed",t)}static loadE2ESpeed(){const e=this.loadData().e2eSpeed;return isNaN(e)||e<.03||e>5?1:e}static clearAll(){try{localStorage.removeItem(K)}catch(e){console.error("[SelfImprovingPersistence] Failed to clear all data:",e)}}static saveE2ETestResults(e){const t={};for(const[n,r]of e.entries())t[n]=r;this.updateField("e2eTestResults",t)}static loadE2ETestResults(){const e=this.loadData().e2eTestResults,t=new Map;for(const[n,r]of Object.entries(e))t.set(n,r);return t}static clearE2ETestResults(){this.updateField("e2eTestResults",{})}static saveBDDTestResults(e){const t={};for(const[n,r]of e.entries())t[n]=r;this.updateField("bddTestResults",t)}static loadBDDTestResults(){const e=this.loadData().bddTestResults,t=new Map;for(const[n,r]of Object.entries(e))t.set(n,r);return t}static clearBDDTestResults(){this.updateField("bddTestResults",{})}static saveSelfImproveLogs(e){this.updateField("selfImproveLogs",e)}static loadSelfImproveLogs(){return this.loadData().selfImproveLogs}static clearSelfImproveLogs(){this.updateField("selfImproveLogs",[])}static addSelfImproveLog(e){const t=this.loadSelfImproveLogs();t.push({timestamp:Date.now(),message:e}),this.saveSelfImproveLogs(t)}static saveUIModeStepDelay(e){const t=Math.max(100,Math.min(1e3,e));this.updateField("uiModeStepDelay",t)}static loadUIModeStepDelay(){const e=this.loadData().uiModeStepDelay;return isNaN(e)||e<100||e>1e3?500:e}}function Re({featureName:a,scenarioName:e,steps:t,lastExecutedStep:n,enableStepByStep:r=!0,onStepClick:c}){const d=(g,p)=>n!==null&&n.feature===a&&n.scenario===e&&n.stepType===g&&n.stepIndex===p,o=(g,p,m)=>{if(!p||p.length===0)return null;const E={purple:{text:"text-purple-600 dark:text-purple-400",hover:"hover:bg-purple-50 dark:hover:bg-purple-950/30",bg:"bg-purple-100 dark:bg-purple-950/40",border:"border-purple-500 dark:border-purple-400"},orange:{text:"text-orange-600 dark:text-orange-400",hover:"hover:bg-orange-50 dark:hover:bg-orange-950/30",bg:"bg-orange-100 dark:bg-orange-950/40",border:"border-orange-500 dark:border-orange-400"},green:{text:"text-green-600 dark:text-green-400",hover:"hover:bg-green-50 dark:hover:bg-green-950/30",bg:"bg-green-100 dark:bg-green-950/40",border:"border-green-500 dark:border-green-400"}}[m];return p.map((y,R)=>{const C=d(g,R),D=r&&c;return s.jsxs("div",{className:`text-card-foreground px-2 py-1 rounded transition-colors ${D?`cursor-pointer ${E.hover}`:""} ${C?`${E.bg} border-l-4 ${E.border}`:""}`,onClick:()=>D&&c(g,R),title:D?"Click to run scenario up to this step":void 0,children:[s.jsx("span",{className:`font-semibold ${E.text}`,children:g})," ",y.text,C&&s.jsx("span",{className:`ml-2 ${E.text} text-xs`,children:"â† executed"})]},`${g.toLowerCase()}-${R}`)})};return s.jsxs("div",{className:"step-list space-y-1 ml-4 mb-2",children:[o("Given",t.Given,"purple"),o("When",t.When,"orange"),o("Then",t.Then,"green")]})}function De({featureName:a,scenario:e,testResult:t,lastExecutedStep:n,enableStepByStep:r=!0,isRunningTests:c,onRunScenario:d,onStepClick:o,onGoToError:g}){const[p,m]=v.useState(!1),h=(t==null?void 0:t.status)||"pending";return s.jsxs("div",{className:"scenario-card bg-card border border-border rounded p-3 text-xs","data-test":`scenario-card-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:[s.jsxs("div",{className:"scenario-header flex items-center justify-between mb-2","data-test":`scenario-header-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:[s.jsxs("div",{className:"scenario-title font-semibold text-blue-700 dark:text-blue-300 flex items-center gap-2 cursor-pointer flex-1",onClick:()=>m(!p),"data-test":`scenario-title-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:[p?s.jsx(le,{size:14,"data-test":"scenario-chevron-down-icon"}):s.jsx(de,{size:14,"data-test":"scenario-chevron-right-icon"}),s.jsxs("span",{"data-test":`scenario-name-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:["Scenario: ",e.scenario]}),h==="pass"&&s.jsx("span",{className:"text-green-600 dark:text-green-400","data-test":`scenario-status-pass-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:"âœ“"}),h==="fail"&&s.jsx("span",{className:"text-red-600 dark:text-red-400","data-test":`scenario-status-fail-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:"âœ—"}),h==="pending"&&s.jsx("span",{className:"text-muted-foreground text-xs","data-test":`scenario-status-pending-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:"(not run)"})]}),s.jsx(I,{size:"sm",variant:"ghost",onClick:d,disabled:c,className:"text-xs h-6 px-2","data-test":`scenario-run-button-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:"Run"})]}),p&&s.jsx("div",{"data-test":`scenario-steps-container-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:s.jsx(Re,{featureName:a,scenarioName:e.scenario,steps:e.steps,lastExecutedStep:n,enableStepByStep:r,onStepClick:o})}),(t==null?void 0:t.duration)&&s.jsxs("div",{className:"duration text-xs text-muted-foreground mt-1","data-test":`scenario-duration-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:["Duration: ",t.duration.toFixed(2),"ms"]}),(t==null?void 0:t.status)==="fail"&&t.error&&s.jsxs("div",{className:"error-message mt-2 p-2 bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded","data-test":`scenario-error-message-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("div",{className:"text-xs font-semibold text-red-800 dark:text-red-200","data-test":`scenario-error-title-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:"Error:"}),g&&s.jsxs(I,{size:"sm",variant:"ghost",onClick:g,className:"text-xs h-5 px-2 text-red-700 dark:text-red-300 hover:text-red-900 dark:hover:text-red-100","data-test":`scenario-go-to-error-button-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:[s.jsx(be,{size:12,className:"mr-1"}),"Go to Error"]})]}),s.jsx("div",{className:"text-xs text-red-700 dark:text-red-300 font-mono whitespace-pre-wrap","data-test":`scenario-error-text-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:t.error})]}),(t==null?void 0:t.status)==="pass"&&s.jsx("div",{className:"success-message mt-2 p-2 bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded","data-test":`scenario-success-message-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:s.jsx("div",{className:"text-xs text-green-700 dark:text-green-300","data-test":`scenario-success-text-${e.scenario.toLowerCase().replace(/\s+/g,"-")}`,children:"âœ“ Test passed successfully"})})]})}function he({speedMultiplier:a,onSpeedChange:e,waitTime:t,onWaitTimeChange:n,testIdPrefix:r=""}){const c=r?`${r}-`:"",d=o=>{e(o),ae(o),re.saveE2ESpeed(o)};return s.jsxs("div",{className:"space-y-4 p-2","data-test":`${c}config-panel`,children:[s.jsxs("div",{className:"space-y-2",children:[s.jsxs(oe,{className:"text-sm font-medium flex items-center gap-2",children:[s.jsx(Se,{className:"h-4 w-4"}),"Test speed"]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(I,{size:"sm",variant:a===.03125?"default":"outline",onClick:()=>d(.03125),className:"h-7 text-xs","data-test":`${c}speed-max`,children:"32x"}),s.jsx(I,{size:"sm",variant:a===.0625?"default":"outline",onClick:()=>d(.0625),className:"h-7 text-xs","data-test":`${c}speed-ultra-fast`,children:"16x"}),s.jsx(I,{size:"sm",variant:a===.125?"default":"outline",onClick:()=>d(.125),className:"h-7 text-xs","data-test":`${c}speed-super-fast`,children:"8x"}),s.jsx(I,{size:"sm",variant:a===.25?"default":"outline",onClick:()=>d(.25),className:"h-7 text-xs","data-test":`${c}speed-very-fast`,children:"4x"}),s.jsx(I,{size:"sm",variant:a===.5?"default":"outline",onClick:()=>d(.5),className:"h-7 text-xs","data-test":`${c}speed-fast`,children:"2x"}),s.jsx(I,{size:"sm",variant:a===1?"default":"outline",onClick:()=>d(1),className:"h-7 text-xs","data-test":`${c}speed-normal`,children:"1x"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs(oe,{htmlFor:`${c}wait-time-input`,className:"text-sm font-medium flex items-center gap-2",children:[s.jsx(ye,{className:"h-4 w-4"}),"Wait time between scenarios"]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(se,{id:`${c}wait-time-input`,type:"number",min:0,max:1e3,step:50,value:t,onChange:o=>{const g=parseInt(o.target.value,10);!isNaN(g)&&g>=0&&g<=1e3&&n(g)},className:"h-8 w-20","data-test":`${c}wait-time-input`}),s.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"ms"})]})]})]})}function ee({feature:a,isExpanded:e,testResults:t,lastExecutedStep:n,enableStepByStep:r=!0,isRunningTests:c,onToggleExpand:d,onRunFeature:o,onRunScenario:g,onStepClick:p,onGoToError:m}){const[h,E]=v.useState(""),[y,R]=v.useState(100),[C,D]=v.useState(!1),B=v.useRef(!1),[k,G]=v.useState(()=>re.loadE2ESpeed()),L=a.scenarios.filter(w=>{var T;const z=`${a.feature}::${w.scenario}`;return((T=t.get(z))==null?void 0:T.status)==="pass"}).length,F=a.scenarios.length,M=a.scenarios.filter(w=>w.scenario.toLowerCase().includes(h.toLowerCase()));return s.jsxs("div",{className:"feature-section border rounded","data-test":`feature-section-${a.feature.toLowerCase().replace(/\s+/g,"-")}`,children:[s.jsx("div",{className:"feature-header bg-blue-50 dark:bg-blue-950/30 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors",onClick:d,"data-test":`feature-header-${a.feature.toLowerCase().replace(/\s+/g,"-")}`,children:e?s.jsx("div",{className:"flex items-center justify-between p-3","data-test":"feature-header-expanded",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(le,{size:16,className:"text-muted-foreground","data-test":"feature-expand-icon"}),s.jsx("span",{className:"font-semibold text-blue-900 dark:text-blue-100","data-test":"feature-title",children:a.feature}),s.jsxs("span",{className:"text-xs text-muted-foreground","data-test":"feature-passing-count",children:["(",L,"/",F," passing)"]})]})}):s.jsxs("div",{className:"p-3","data-test":"feature-header-collapsed",children:[s.jsx("div",{className:"mb-2",children:s.jsx("span",{className:"font-semibold text-blue-900 dark:text-blue-100 text-base leading-tight block truncate",title:a.feature,"data-test":"feature-title",children:a.feature})}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[s.jsx(de,{size:14,className:"flex-shrink-0","data-test":"feature-collapse-icon"}),s.jsxs("span",{"data-test":"feature-passing-count",children:[L,"/",F," passing"]})]}),s.jsx(I,{size:"lg",variant:"ghost",onClick:w=>{w.stopPropagation(),o()},disabled:c,className:"h-6 w-6 p-0 flex-shrink-0","data-test":"feature-run-button",children:s.jsx(te,{size:14})})]})]})}),e&&s.jsxs("div",{className:"feature-scenarios p-3 space-y-3","data-test":"feature-scenarios-container",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2","data-test":"feature-scenarios-toolbar",children:[s.jsxs("div",{className:"relative flex-1","data-test":"feature-scenarios-search-wrapper",children:[s.jsx(ue,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-muted-foreground","data-test":"feature-scenarios-search-icon"}),s.jsx(se,{type:"text",placeholder:"Search scenarios...",value:h,onChange:w=>E(w.target.value),className:"h-7 pl-7 text-xs","data-test":"feature-scenarios-search-input"})]}),s.jsx(ce,{label:C?s.jsxs(s.Fragment,{children:[s.jsx(fe,{className:"h-3 w-3 mr-1","data-test":"feature-stop-icon"}),"Stop"]}):s.jsxs(s.Fragment,{children:[s.jsx(te,{className:"h-3 w-3 mr-1","data-test":"feature-run-icon"}),"Run ",h?"Filtered":"All"," (",M.length,")"]}),onAction:async()=>{if(C){B.current=!0;return}B.current=!1,D(!0);try{if(!h){await o();return}for(let w=0;w<M.length&&!B.current;w++){const z=M[w];await g(z.scenario),await new Promise(T=>setTimeout(T,y))}}finally{D(!1),B.current=!1}},variant:C?"destructive":"default",size:"sm",disabled:!C&&c||M.length===0,className:"text-xs h-7","data-test":"feature-scenarios-run-all-button",ariaLabel:C?"Stop running scenarios":`Run ${h?"filtered":"all"} ${M.length} scenarios`,popoverContent:C?void 0:s.jsx(he,{speedMultiplier:k,onSpeedChange:G,waitTime:y,onWaitTimeChange:R,testIdPrefix:"feature"})})]}),M.length>0?M.map((w,z)=>{const T=`${a.feature}::${w.scenario}`,Z=t.get(T);return s.jsx(De,{featureName:a.feature,scenario:w,testResult:Z,lastExecutedStep:n,enableStepByStep:r,isRunningTests:c,onRunScenario:()=>g(w.scenario),onStepClick:p?(H,U)=>p(w.scenario,H,U):void 0,onGoToError:m?()=>m(w.scenario):void 0},z)}):s.jsxs("div",{className:"text-center text-muted-foreground text-sm py-4","data-test":"feature-scenarios-empty-state",children:['No scenarios match "',h,'"']})]})]})}function Ge({config:a,storageKey:e="spec-view-default",onTestResults:t,onGoToError:n,controlledTestResults:r}){const[c,d]=v.useState(new Set),[o,g]=v.useState(new Map),[p,m]=v.useState(!1),[h,E]=v.useState(null),y=v.useRef(!1),[R,C]=v.useState(100),[D,B]=v.useState(()=>{const i=re.loadE2ESpeed();return ae(i),i}),k=r??o,G=v.useRef(k);v.useEffect(()=>{G.current=k},[k]);const L=i=>{if(r&&t){const x=i(G.current);G.current=x,t(x)}else g(i)},[F,M]=v.useState(null),[w,z]=v.useState(()=>{try{return localStorage.getItem(`${e}-viewMode`)==="grid"?"grid":"list"}catch{return"list"}}),[T,Z]=v.useState(()=>{try{return localStorage.getItem(`${e}-featureSearch`)||""}catch{return""}}),{registry:H,features:U,facades:_={},selfImprovingFacade:ne,enableStepByStep:V=!0,logger:f}=a,A=Array.isArray(U)?U:[...U];v.useEffect(()=>{const i=new Ee(H,_,ne);M(i),f==null||f.info("SpecView initialized")},[H,_,ne,f]),v.useEffect(()=>{F&&F.updateFacades(_)},[_,F]),v.useEffect(()=>{try{localStorage.setItem(`${e}-viewMode`,w)}catch(i){f==null||f.error(`Failed to save viewMode to localStorage: ${i instanceof Error?i.message:String(i)}`)}},[w,e,f]),v.useEffect(()=>{try{localStorage.setItem(`${e}-featureSearch`,T)}catch(i){f==null||f.error(`Failed to save featureSearch to localStorage: ${i instanceof Error?i.message:String(i)}`)}},[T,e,f]),v.useEffect(()=>{t&&!r&&t(k)},[k,t,r]);const q=i=>{d(x=>{const l=new Set(x);return l.has(i)?l.delete(i):l.add(i),l})},J=async(i,x)=>{if(F){m(!0);try{const l=A.find(j=>j.feature===i);if(!l)throw new Error(`Feature not found: ${i}`);const S=l.scenarios.find(j=>j.scenario===x);if(!S)throw new Error(`Scenario not found: ${x}`);const u=await F.runScenario(i,S),b=`${i}::${x}`;L(j=>new Map(j).set(b,u))}catch(l){f==null||f.error(`Test execution error: ${l instanceof Error?l.message:String(l)}`);const S=`${i}::${x}`;L(u=>new Map(u).set(S,{feature:i,scenario:x,status:"fail",error:l instanceof Error?l.message:String(l)}))}finally{m(!1)}}},Y=async i=>{if(F){y.current=!1,m(!0);try{const x=A.find(l=>l.feature===i);if(!x)throw new Error(`Feature not found: ${i}`);for(let l=0;l<x.scenarios.length;l++){const S=x.scenarios[l];if(y.current){f==null||f.info("Feature test run cancelled by user");break}try{const u=await F.runScenario(x.feature,S),b=`${u.feature}::${u.scenario}`;L(j=>{const N=new Map(j);return N.set(b,u),N})}catch(u){f==null||f.error(`Scenario execution error: ${u instanceof Error?u.message:String(u)}`);const b=`${i}::${S.scenario}`;L(j=>new Map(j).set(b,{feature:i,scenario:S.scenario,status:"fail",error:u instanceof Error?u.message:String(u)}))}await new Promise(u=>setTimeout(u,R))}}catch(x){f==null||f.error(`Feature test execution error: ${x instanceof Error?x.message:String(x)}`)}finally{m(!1),y.current=!1}}},xe=async()=>{if(F){y.current=!1,m(!0);try{for(const i of A){if(y.current){f==null||f.info("Test run cancelled by user");break}for(const x of i.scenarios){if(y.current){f==null||f.info("Test run cancelled by user");break}const l=await F.runScenario(i.feature,x),S=`${l.feature}::${l.scenario}`;L(u=>new Map(u).set(S,l)),await new Promise(u=>setTimeout(u,100))}}}catch(i){f==null||f.error(`Run all tests error: ${i instanceof Error?i.message:String(i)}`)}finally{m(!1),y.current=!1}}},ge=()=>{y.current=!0},X=async(i,x,l,S)=>{if(F){m(!0);try{const u=A.find(W=>W.feature===i);if(!u)throw new Error(`Feature not found: ${i}`);const b=u.scenarios.find(W=>W.scenario===x);if(!b)throw new Error(`Scenario not found: ${x}`);const j=await F.runScenarioUpToStep(i,b,l,S),N=`${i}::${x}`;L(W=>new Map(W).set(N,j)),E({feature:i,scenario:x,stepType:l,stepIndex:S})}catch(u){f==null||f.error(`Step execution error: ${u instanceof Error?u.message:String(u)}`);const b=`${i}::${x}`;L(j=>new Map(j).set(b,{feature:i,scenario:x,status:"fail",error:u instanceof Error?u.message:String(u)}))}finally{m(!1)}}},Q=A.filter(i=>i.feature.toLowerCase().includes(T.toLowerCase())),O=(()=>{const i=A.reduce((l,S)=>l+S.scenarios.length,0);return{passed:Array.from(k.values()).filter(l=>l.status==="pass").length,total:i}})();return s.jsxs("div",{className:"spec-view bg-card border border-border rounded-lg h-full flex flex-col","data-test":"spec-view-container",children:[s.jsxs("div",{className:"spec-header p-4 border-b border-border","data-test":"spec-view-header",children:[s.jsxs("div",{className:"flex items-start justify-between mb-3","data-test":"spec-view-header-top",children:[s.jsx("h3",{className:"text-lg font-bold text-card-foreground","data-test":"spec-view-title",children:"ðŸ“‹ BDD Test Specifications"}),s.jsxs("div",{className:"flex items-center gap-2","data-test":"spec-view-header-actions",children:[s.jsx(ce,{label:p?s.jsxs(s.Fragment,{children:[s.jsx(fe,{className:"h-3 w-3 mr-2","data-test":"spec-view-stop-icon"}),"Stop"]}):s.jsxs(s.Fragment,{children:[s.jsx(te,{className:"h-3 w-3 mr-2","data-test":"spec-view-run-all-icon"}),"Run All (",O.total,")"]}),onAction:p?ge:xe,variant:p?"destructive":"default",size:"sm",disabled:!p&&A.length===0,className:"h-8","data-test":"spec-view-run-all-button",ariaLabel:p?"Stop running tests":`Run all ${O.total} tests`,popoverContent:p?void 0:s.jsx(he,{speedMultiplier:D,onSpeedChange:B,waitTime:R,onWaitTimeChange:C,testIdPrefix:"spec-view"})}),s.jsxs("div",{className:"view-toggle-buttons flex gap-1","data-test":"spec-view-toggle-buttons",children:[s.jsx(I,{variant:w==="list"?"default":"outline",size:"sm",onClick:()=>z("list"),className:"h-8 w-8 p-0","data-test":"spec-view-list-mode-button",children:s.jsx(je,{className:"h-4 w-4","data-test":"spec-view-list-mode-icon"})}),s.jsx(I,{variant:w==="grid"?"default":"outline",size:"sm",onClick:()=>z("grid"),className:"h-8 w-8 p-0","data-test":"spec-view-grid-mode-button",children:s.jsx(Fe,{className:"h-4 w-4","data-test":"spec-view-grid-mode-icon"})})]})]})]}),s.jsxs("div",{className:"flex items-center gap-3","data-test":"spec-view-search-stats",children:[s.jsxs("div",{className:"relative flex-1","data-test":"spec-view-search-container",children:[s.jsx(ue,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground","data-test":"spec-view-search-icon"}),s.jsx(se,{type:"text",placeholder:"Search features...",value:T,onChange:i=>Z(i.target.value),className:"h-8 pl-9 text-sm","data-test":"spec-view-search-input"})]}),O.passed>0&&s.jsxs("div",{className:"text-sm font-semibold text-green-600 dark:text-green-400 whitespace-nowrap","data-test":"spec-view-stats",children:[O.passed,"/",O.total," passing (",(O.passed/O.total*100).toFixed(1),"%)"]})]})]}),s.jsx("div",{className:"spec-content flex-1 overflow-y-auto","data-test":"spec-view-content",children:w==="grid"?s.jsx(s.Fragment,{children:(()=>{const i=[];for(let l=0;l<Q.length;l+=3){const S=Q.slice(l,l+3),u=S.find(b=>c.has(b.feature));i.push(s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4","data-test":`spec-view-grid-row-${l}`,children:S.map((b,j)=>s.jsx(ee,{feature:b,isExpanded:!1,testResults:k,lastExecutedStep:h,enableStepByStep:V,isRunningTests:p,onToggleExpand:()=>q(b.feature),onRunFeature:()=>Y(b.feature),onRunScenario:N=>J(b.feature,N),onStepClick:V?(N,W,me)=>X(b.feature,N,W,me):void 0,onGoToError:n},`feature-${l}-${j}`))},`row-${l}`)),u&&i.push(s.jsx(ee,{feature:u,isExpanded:!0,testResults:k,lastExecutedStep:h,enableStepByStep:V,isRunningTests:p,onToggleExpand:()=>q(u.feature),onRunFeature:()=>Y(u.feature),onRunScenario:b=>J(u.feature,b),onStepClick:V?(b,j,N)=>X(u.feature,b,j,N):void 0,onGoToError:n},`expanded-${u.feature}`))}return s.jsx("div",{className:"space-y-4","data-test":"spec-view-grid-container",children:i})})()}):s.jsx("div",{className:"space-y-4","data-test":"spec-view-list-container",children:Q.length>0?Q.map((i,x)=>s.jsx(ee,{feature:i,isExpanded:c.has(i.feature),testResults:k,lastExecutedStep:h,enableStepByStep:V,isRunningTests:p,onToggleExpand:()=>q(i.feature),onRunFeature:()=>Y(i.feature),onRunScenario:l=>J(i.feature,l),onStepClick:V?(l,S,u)=>X(i.feature,l,S,u):void 0,onGoToError:n},x)):s.jsxs("div",{className:"text-center text-muted-foreground text-sm py-8","data-test":"spec-view-empty-state",children:['No features match "',T,'"']})})})]})}export{Ve as E,Be as F,Ge as S,Ee as T,re as a,Ne as b,$ as c,Le as d,Te as e,Ce as f,ke as g,Me as h,ae as i,$e as s,Ie as w};
