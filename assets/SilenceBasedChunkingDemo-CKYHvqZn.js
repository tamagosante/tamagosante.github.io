import{r as o,j as e}from"./react-vendor-Byz07MLO.js";import{am as I,C as T,b as B,c as U,d as Q,e as A,m as le,n as ue,o as O,p as z,a as p,L as N,S as me,h as he,i as xe,j as fe,k as D,R as E,q as pe,an as je,ao as ve,ap as be}from"./index-BbgB-sev.js";import{r as S}from"./recordingStorage-XzvoUejy.js";import{U as X,N as Y,R as ye,aa as we,D as Ne,T as Se,ab as Ce,j as Re}from"./icons-Detj0uxE.js";import"./utils-DjFvUtuq.js";import"./radix-ui-B6r6BEmy.js";import"./ui-utils-BxIQ3qGg.js";function Le({logger:s}){const[u,j]=o.useState(null),[m,v]=o.useState(null),[P,f]=o.useState([]),[V,W]=o.useState(!1),[b,Z]=o.useState("DEFAULT"),[h,y]=o.useState(I.WORD_STREAMING),[H,x]=o.useState(null),[$,G]=o.useState(!1),[C,g]=o.useState("upload"),[_,q]=o.useState(null),[k,F]=o.useState([]),[ee,se]=o.useState(!0),K=o.useRef(null),L=o.useRef(null),M=o.useRef([]);o.useEffect(()=>{y(I[b])},[]),o.useEffect(()=>{(async()=>{try{const n=await S.getAllRecordings();if(F(n),s==null||s.info(`Loaded ${n.length} saved recordings from IndexedDB`),n.length>0){const t=n[0],i=new File([t.blob],t.name,{type:t.blob.type});j(i);const r=await t.blob.arrayBuffer(),d=await new AudioContext().decodeAudioData(r);v(d),s==null||s.info(`Autoloaded first recording: ${t.name}`)}}catch(n){const t=n instanceof Error?n.message:String(n);s==null||s.error(`Failed to load saved recordings: ${t}`)}finally{se(!1)}})()},[s]),o.useEffect(()=>{if(u){const a=URL.createObjectURL(u);return q(a),()=>{URL.revokeObjectURL(a)}}else q(null)},[u]);const ae=async a=>{var t;const n=(t=a.target.files)==null?void 0:t[0];if(n)try{x(null),j(n),f([]),s==null||s.info(`Selected file: ${n.name}`);const i=await n.arrayBuffer(),c=await new AudioContext().decodeAudioData(i);v(c),s==null||s.info(`Audio loaded: ${c.duration.toFixed(2)}s, ${c.numberOfChannels} channels, ${c.sampleRate}Hz`)}catch(i){const r=i instanceof Error?i.message:"Failed to load audio file";x(r),s==null||s.error(r)}},ne=async()=>{if(m)try{W(!0),x(null),s==null||s.info("Starting chunking process...");const t=(await new ve(h).chunkAudio(m)).map((i,r)=>({id:`chunk-${r}-${Date.now()}`,chunkNumber:i.index,startTime:new Date(Date.now()+i.startTime*1e3),endTime:new Date(Date.now()+i.endTime*1e3),duration:i.duration*1e3,blob:i.blob,size:i.blob.size,name:`chunk-${i.index}`}));f(t),s==null||s.info(`Created ${t.length} chunks`)}catch(a){const n=a instanceof Error?a.message:"Failed to chunk audio";x(n),s==null||s.error(n)}finally{W(!1)}},te=a=>{Z(a),y(I[a]),s==null||s.info(`Changed preset to: ${a}`)},R=a=>`${a.toFixed(2)}s`,ie=async()=>{try{x(null),f([]),v(null),j(null);const a=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(a);L.current=n,M.current=[],n.ondataavailable=t=>{t.data.size>0&&M.current.push(t.data)},n.onstop=async()=>{const t=new Blob(M.current,{type:"audio/webm"}),i=new File([t],`recording-${Date.now()}.webm`,{type:"audio/webm"});a.getTracks().forEach(r=>r.stop());try{j(i),s==null||s.info(`Recording completed: ${i.name}`);const r=await i.arrayBuffer(),d=await new AudioContext().decodeAudioData(r);v(d),s==null||s.info(`Audio loaded: ${d.duration.toFixed(2)}s, ${d.numberOfChannels} channels, ${d.sampleRate}Hz`);try{const l=await S.saveRecording(t,`Demo Recording ${new Date().toLocaleString()}`);s==null||s.info(`Recording saved to IndexedDB: ${l.id}`);const w=await S.getAllRecordings();F(w)}catch(l){const w=l instanceof Error?l.message:String(l);s==null||s.error(`Failed to save recording to IndexedDB: ${w}`)}}catch(r){const c=r instanceof Error?r.message:"Failed to process recorded audio";x(c),s==null||s.error(c)}},n.start(),G(!0),s==null||s.info("Recording started")}catch(a){const n=a instanceof Error?a.message:"Failed to start recording";x(n),s==null||s.error(n)}},ce=()=>{L.current&&$&&(L.current.stop(),G(!1),s==null||s.info("Recording stopped"))},J=async a=>{try{x(null),f([]);const n=new File([a.blob],a.name,{type:a.blob.type});j(n);const t=await a.blob.arrayBuffer(),r=await new AudioContext().decodeAudioData(t);v(r),s==null||s.info(`Loaded saved recording: ${a.name}`)}catch(n){const t=n instanceof Error?n.message:"Failed to load saved recording";x(t),s==null||s.error(t)}},re=async(a,n)=>{try{await S.deleteRecording(a),s==null||s.info(`Deleted recording: ${n}`);const t=await S.getAllRecordings();F(t),(u==null?void 0:u.name)===n&&(j(null),v(null),f([]))}catch(t){const i=t instanceof Error?t.message:"Failed to delete recording";x(i),s==null||s.error(i)}},de=async a=>{try{s==null||s.info(`Converting recording to WAV for download: ${a.name}`);const n=await je(a.blob,s),t=a.name.replace(/\.[^/.]+$/,"")+".wav",i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),s==null||s.info(`Downloaded recording as WAV: ${t}`)}catch(n){const t=n instanceof Error?n.message:"Failed to download recording";x(t),s==null||s.error(t)}},oe=async a=>{s==null||s.info("Transcribing all chunks..."),a&&(s==null||s.info(`Using options - Model: ${a.model}, Language: ${a.language}`)),f(c=>c.map(d=>({...d,transcriptionStatus:"processing"})));const n=P.map(async c=>{if(!c.blob)return s==null||s.error(`Chunk ${c.name} has no blob`),{chunkId:c.id,success:!1,error:"No audio blob"};try{const d=new File([c.blob],`${c.name}.wav`,{type:"audio/wav"}),l=await be.transcribeAudio(d,a);return s==null||s.info(`Transcribed ${c.name}: "${l.transcription.substring(0,50)}..."`),{chunkId:c.id,success:!0,transcription:l.transcription}}catch(d){const l=d instanceof Error?d.message:"Transcription failed";return s==null||s.error(`Failed to transcribe ${c.name}: ${l}`),{chunkId:c.id,success:!1,error:l}}}),t=await Promise.all(n);f(c=>c.map(d=>{const l=t.find(w=>w.chunkId===d.id);return l?l.success?{...d,transcriptionStatus:"completed",transcription:l.transcription}:{...d,transcriptionStatus:"failed",transcriptionError:l.error}:d}));const i=t.filter(c=>c.success).length,r=t.filter(c=>!c.success).length;s==null||s.info(`Transcription complete: ${i} succeeded, ${r} failed`)};return e.jsx("div",{className:"silence-chunking-demo-page h-full flex flex-col overflow-hidden",children:e.jsx("div",{className:"page-content flex-1 p-6 overflow-y-auto min-h-0",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 h-full",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(T,{children:[e.jsxs(B,{children:[e.jsx(U,{children:"Audio Input"}),e.jsx(Q,{children:"Upload a file or record live audio to test silence-based chunking"})]}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs(le,{value:C,onValueChange:a=>g(a),children:[e.jsxs(ue,{className:"grid w-full grid-cols-3",children:[e.jsxs(O,{value:"upload",className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4"}),"Upload"]}),e.jsxs(O,{value:"record",className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),"Record"]}),e.jsxs(O,{value:"saved",className:"flex items-center gap-2",children:[e.jsx(ye,{className:"w-4 h-4"}),"Saved (",k.length,")"]})]}),e.jsx(z,{value:"upload",className:"space-y-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{ref:K,type:"file",accept:"audio/*",onChange:ae,className:"hidden"}),e.jsxs(p,{onClick:()=>{var a;return(a=K.current)==null?void 0:a.click()},variant:"outline",className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4"}),u&&C==="upload"?"Change File":"Select Audio File"]}),u&&C==="upload"&&e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:u.name}),m&&e.jsxs("p",{className:"text-xs text-gray-500",children:[R(m.duration)," • ",m.numberOfChannels," channel(s) • ",m.sampleRate," Hz"]})]})]})}),e.jsxs(z,{value:"record",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[$?e.jsxs(p,{onClick:ce,variant:"destructive",className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),"Stop Recording"]}):e.jsxs(p,{onClick:ie,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),"Start Recording"]}),u&&C==="record"&&e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:u.name}),m&&e.jsxs("p",{className:"text-xs text-gray-500",children:[R(m.duration)," • ",m.numberOfChannels," channel(s) • ",m.sampleRate," Hz"]})]})]}),$&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("p",{className:"text-sm font-medium",children:"Recording in progress..."})]})]}),e.jsx(z,{value:"saved",className:"space-y-4",children:ee?e.jsx("div",{className:"text-sm text-gray-500 py-4 text-center",children:"Loading saved recordings..."}):k.length===0?e.jsx("div",{className:"text-sm text-gray-500 py-4 text-center",children:"No saved recordings yet. Record some audio to get started!"}):e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:k.map(a=>e.jsxs("div",{className:"flex items-center justify-between gap-2 p-3 border rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex-1 min-w-0 cursor-pointer",onClick:()=>void J(a),children:[e.jsx("p",{className:"text-sm font-medium truncate",children:a.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[a.timestamp.toLocaleString()," • ",(a.size/1024).toFixed(1)," KB",a.duration&&` • ${R(a.duration)}`]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),J(a)},children:"Load"}),e.jsx(p,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),de(a)},title:"Download as WAV",children:e.jsx(Ne,{className:"w-4 h-4"})}),e.jsx(p,{variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-700 hover:bg-red-50",onClick:n=>{n.stopPropagation(),re(a.id,a.name)},title:"Delete recording",children:e.jsx(Se,{className:"w-4 h-4"})})]})]},a.id))})})]}),H&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700",children:[e.jsx(Ce,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("p",{className:"text-sm",children:H})]})]})]}),e.jsx(T,{children:e.jsxs(A,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"preset",children:"Preset"}),e.jsxs(me,{value:b,onValueChange:te,children:[e.jsx(he,{id:"preset",children:e.jsx(xe,{})}),e.jsxs(fe,{children:[e.jsx(D,{value:"DEFAULT",children:"Default (Standard speech)"}),e.jsx(D,{value:"TIGHT",children:"Tight (Word streaming)"}),e.jsx(D,{value:"LOOSE",children:"Loose (Longer pauses)"}),e.jsx(D,{value:"WORD_STREAMING",children:"Word Streaming (Optimized)"})]})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[b==="DEFAULT"&&"Standard settings for general speech detection",b==="TIGHT"&&"Creates many small segments for fast transcription",b==="LOOSE"&&"Suitable for audio with deliberate pauses",b==="WORD_STREAMING"&&"Optimized for word-level streaming transcription"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{children:["Silence Threshold: ",h.silenceThreshold," dBFS"]}),e.jsx(E,{value:[h.silenceThreshold],onValueChange:([a])=>y({...h,silenceThreshold:a}),min:-60,max:0,step:1,className:"w-full"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Lower = more sensitive"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{children:["Min Silence: ",h.minSilenceDuration," ms"]}),e.jsx(E,{value:[h.minSilenceDuration],onValueChange:([a])=>y({...h,minSilenceDuration:a}),min:10,max:200,step:5,className:"w-full"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Minimum silence duration"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{children:["Hold Time: ",h.holdTime," ms"]}),e.jsx(E,{value:[h.holdTime],onValueChange:([a])=>y({...h,holdTime:a}),min:0,max:300,step:5,className:"w-full"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Merge regions closer than this"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{children:["Padding: ",h.padding," ms"]}),e.jsx(E,{value:[h.padding],onValueChange:([a])=>y({...h,padding:a}),min:-150,max:150,step:5,className:"w-full"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Extra time around chunks"})]})]}),e.jsx(p,{onClick:ne,disabled:!m||V,className:"w-full",children:V?e.jsx(e.Fragment,{children:"Processing..."}):e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Analyze & Chunk Audio"]})})]})}),e.jsxs(T,{children:[e.jsx(B,{children:e.jsx(U,{children:"How It Works"})}),e.jsxs(A,{className:"space-y-3 text-sm text-gray-600",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Silence-based chunking"})," analyzes audio to detect silence regions and splits the audio at natural pauses in speech. This enables:"]}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-4",children:[e.jsx("li",{children:"Faster word-level transcription by processing smaller chunks"}),e.jsx("li",{children:"Better real-time streaming of transcription results"}),e.jsx("li",{children:"More accurate timestamp alignment with natural speech boundaries"}),e.jsx("li",{children:"Efficient processing of long audio files"})]}),e.jsxs("p",{className:"mt-4",children:[e.jsx("strong",{children:"Algorithm:"})," Uses RMS energy analysis to detect voice activity, converts to dBFS scale, identifies regions above threshold, merges close regions, and extracts active segments."]})]})]})]}),e.jsxs("div",{className:"h-full space-y-6",children:[_&&m&&e.jsxs(T,{children:[e.jsxs(B,{children:[e.jsx(U,{children:"Full Audio"}),e.jsxs(Q,{children:[u==null?void 0:u.name," • ",R(m.duration)]})]}),e.jsx(A,{children:e.jsx("audio",{src:_,controls:!0,className:"w-full",preload:"metadata"})})]}),e.jsx(pe,{chunks:P,onTranscribeAll:oe})]})]})})})}export{Le as SilenceBasedChunkingDemo};
