import{j as r,r as f}from"./react-vendor-Byz07MLO.js";import{a as D}from"./ui-utils-BxIQ3qGg.js";import{a as w,aE as X,K as C,ac as F,T as ce,bf as V,bg as se,O as L,bh as G,aj as de,L as ue,S as pe,h as he,i as fe,j as me,k as ge,P as xe,$ as ye,Q as ve,I as Ce,bi as we,bj as be,b0 as Se,bk as je}from"./index-CJ-Awmlc.js";import{t as U}from"./utils-DjFvUtuq.js";import{bm as Ne,r as Pe,D as Te,C as ae,e as re,b4 as ze,a5 as ne,g as Ue,T as Ae,a2 as Ee,O as ke}from"./icons-Detj0uxE.js";import{c as Le,s as Re,u as O,E as Y,a as Ie,C as Oe}from"./CanvasAppV2-BueVjxKN.js";import{m as De,M as Be}from"./MobileLogViewer-BISJYgkg.js";import{initializeDefaultUsers as Me,loadActiveUserId as _e,saveCurrentUser as k,saveActiveUserId as oe,savePresets as z,createTimestamp as B,generateId as K,loadPresets as J,saveUsers as R,loadCurrentUser as Ve,loadUsers as We}from"./userStoreLocalStorage-D-7v21rP.js";import{switchCanvasStateForUser as $e}from"./userCanvasStateStorage-BfBB2NCT.js";import"./radix-ui-B6r6BEmy.js";import"./VimInputHandlerV2-CDXdgrNM.js";import"./logging-DZnpVkoA.js";import"./string-4WCj7OpV.js";import"./clipboardHtmlToMarkdown-BNZmEbgs.js";import"./UiButtonWithExpandOption-CTSSzq0j.js";import"./TextareaPopoverAtCursor-BhwkV6wH.js";import"./cursorPosition-otMhJ5rZ.js";import"./definitionHelper-CZjYPetp.js";import"./DraggableCrudTree-C1-qpnFJ.js";import"./DragDropManager-CacIWg_Z.js";import"./treeHelpers-DUv_6quS.js";import"./globalFacadeRegistry-BlelMPVg.js";import"./WorkflowRowItem-DAxAnbZw.js";import"./UiDataTable-Cxjs2xXn.js";import"./react-hooks-CNdHs55p.js";import"./markdownToHtml-C-4HvgxL.js";import"./DraggableTree-a5UCAJK7.js";import"./useOcr-BBhVsBi3.js";import"./alert-BFi5HBnF.js";import"./JsonViewerApp-BHZpouoC.js";import"./context-menu-C2OnqOmg.js";import"./easy-form-0WSGQjEd.js";import"./forms-B7OAPNGv.js";import"./form-DbJGM2lT.js";import"./SessionSidebar-DqdEUT6W.js";import"./tree-CEiLIGg_.js";import"./SlashCommandMenu-DDdDcz64.js";const Fe=({variant:e="ghost",size:n="icon",className:t,iconClassName:s="h-5 w-5",showTooltip:a=!0})=>{const o=()=>{X.toggle();const l=X.getState();U.success(`Element Inspector ${l?"activated":"deactivated"}`,{description:l?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};return r.jsx(w,{variant:e,size:n,onClick:o,className:t,title:a?"Toggle Element Inspector (Ctrl+Shift+I)":void 0,"aria-label":"Toggle Element Inspector","data-test":"element-inspector-button",children:r.jsx(Ne,{className:s})})},He=1,W="cs:",ie={[C.RECT]:0,[C.TEXT]:1,[C.TEXTCARD]:2,[C.DRAWING]:3},Xe={0:C.RECT,1:C.TEXT,2:C.TEXTCARD,3:C.DRAWING},I=e=>e.slice(0,8),Ge=e=>{if(typeof e=="string")return e;if(typeof e=="number")return String(e);e!=null},Ye=e=>{const n=ie[e.type];if(n===void 0)return null;const t={i:I(e.id),x:Math.round(e.x),y:Math.round(e.y),t:n};e.width&&(t.w=Math.round(e.width)),e.height&&(t.h=Math.round(e.height));const s=Ge(e.content);if(s&&(t.c=s),e.title&&(t.l=e.title),e.type===C.DRAWING&&e.data){const a=e.data,o=Le(a,30);t.d=Ke(o)}return t},Ke=e=>{var t;return(t=e.elements)!=null&&t.length?{el:e.elements.map(s=>{const a={t:s.type==="freehand"?"f":"s",c:s.style.strokeColor,w:s.style.strokeWidth};return s.type==="freehand"&&s.stroke?a.p=Re(s.stroke.smoothedPath,0):s.type==="shape"&&s.shape&&(a.st={t:s.shape.shapeType,s:[Math.round(s.shape.startPoint.x),Math.round(s.shape.startPoint.y)],e:[Math.round(s.shape.endPoint.x),Math.round(s.shape.endPoint.y)]}),a}),iw:e.intrinsicWidth?Math.round(e.intrinsicWidth):void 0,ih:e.intrinsicHeight?Math.round(e.intrinsicHeight):void 0}:void 0},Je=e=>({i:I(e.id),s:e.startNodeId?I(e.startNodeId):null,e:e.endNodeId?I(e.endNodeId):null,sp:[Math.round(e.startPoint.x),Math.round(e.startPoint.y)],ep:[Math.round(e.endPoint.x),Math.round(e.endPoint.y)],l:e.label||void 0}),qe=(e,n)=>{const t=e.filter(o=>ie[o.type]!==void 0).map(Ye).filter(o=>o!==null),s=new Set(t.map(o=>o.i)),a=n.filter(o=>{const l=!o.startNodeId||s.has(I(o.startNodeId)),u=!o.endNodeId||s.has(I(o.endNodeId));return l&&u}).map(Je);return{v:He,n:t,a}},Qe=e=>btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),Ze=e=>{let n=e.replace(/-/g,"+").replace(/_/g,"/");const t=n.length%4;return t&&(n+="=".repeat(4-t)),atob(n)},et=async(e,n)=>{const t=qe(e,n),s=JSON.stringify(t),o=new TextEncoder().encode(s),l=new CompressionStream("gzip"),u=l.writable.getWriter();u.write(o),u.close();const d=[],p=l.readable.getReader();for(;;){const{done:x,value:j}=await p.read();if(x)break;d.push(j)}const i=d.reduce((x,j)=>x+j.length,0),h=new Uint8Array(i);let m=0;for(const x of d)h.set(x,m),m+=x.length;const y=Array.from(h,x=>String.fromCharCode(x)).join(""),b=W+Qe(y);return{url:b,stats:{nodeCount:t.n.length,arrowCount:t.a.length,rawSize:s.length,compressedSize:b.length,compressionRatio:Math.round((1-b.length/s.length)*100)}}},q=async e=>{if(!e.startsWith(W))return null;try{const n=e.slice(W.length),t=Ze(n),s=Uint8Array.from(t,m=>m.charCodeAt(0)),a=new DecompressionStream("gzip"),o=a.writable.getWriter();o.write(s),o.close();const l=[],u=a.readable.getReader();for(;;){const{done:m,value:y}=await u.read();if(m)break;l.push(y)}const d=l.reduce((m,y)=>m+y.length,0),p=new Uint8Array(d);let i=0;for(const m of l)p.set(m,i),i+=m.length;const h=new TextDecoder().decode(p);return JSON.parse(h)}catch{return null}},Q=e=>{const n=new Map,t=e.n.map(a=>{const o=crypto.randomUUID();n.set(a.i,o);const l={id:o,x:a.x,y:a.y,type:Xe[a.t]??C.RECT};return a.w&&(l.width=a.w),a.h&&(l.height=a.h),a.c&&(l.content=a.c),a.l&&(l.title=a.l),a.d&&(l.data=tt(a.d)),l}),s=e.a.map(a=>({id:crypto.randomUUID(),startNodeId:a.s?n.get(a.s)??null:null,endNodeId:a.e?n.get(a.e)??null:null,startPoint:{x:a.sp[0],y:a.sp[1]},endPoint:{x:a.ep[0],y:a.ep[1]},label:a.l}));return{nodes:t,arrows:s}},tt=e=>({elements:e.el.map(t=>t.t==="f"&&t.p?{type:"freehand",stroke:{points:[],smoothedPath:t.p},style:{strokeColor:t.c,strokeWidth:t.w,strokeStyle:"solid"}}:t.t==="s"&&t.st?{type:"shape",shape:{shapeType:t.st.t,startPoint:{x:t.st.s[0],y:t.st.s[1]},endPoint:{x:t.st.e[0],y:t.st.e[1]}},style:{strokeColor:t.c,strokeWidth:t.w,strokeStyle:"solid"}}:{type:"freehand",stroke:{points:[],smoothedPath:""},style:{strokeColor:t.c,strokeWidth:t.w,strokeStyle:"solid"}}),intrinsicWidth:e.iw,intrinsicHeight:e.ih}),st=({isOpen:e,onClose:n,triggerPosition:t})=>{const[s,a]=f.useState(""),[o,l]=f.useState(!1),[u,d]=f.useState(null),[p,i]=f.useState(null),h=O(g=>{var v;return((v=g.projectCanvas.getActive())==null?void 0:v.coreState.nodes)??Y}),m=O(g=>{var v;return((v=g.projectCanvas.getActive())==null?void 0:v.coreState.arrows)??Y}),y=O(g=>g.setNodes),b=O(g=>g.arrow.setAll);f.useEffect(()=>{if(!s||!s.startsWith("cs:")){i(null);return}(async()=>{try{const v=await q(s);if(!v){i({textCount:0,drawingCount:0,arrowCount:0,isValid:!1});return}const{nodes:S,arrows:A}=Q(v),E=S.filter(T=>T.type===C.RECT||T.type===C.TEXT||T.type===C.TEXTCARD).length,c=S.filter(T=>T.type===C.DRAWING).length;i({textCount:E,drawingCount:c,arrowCount:A.length,isValid:!0})}catch{i({textCount:0,drawingCount:0,arrowCount:0,isValid:!1})}})()},[s]);const x=f.useCallback(async()=>{try{const{url:g,stats:v}=await et(h,m);await navigator.clipboard.writeText(g),d(v),l(!0),setTimeout(()=>l(!1),2e3),U.success("Canvas copied!",{description:`${v.nodeCount} nodes, ${v.arrowCount} arrows (${v.compressionRatio}% smaller)`})}catch(g){U.error("Failed to copy",{description:g instanceof Error?g.message:"Unknown error"})}},[h,m]),j=f.useCallback(async()=>{if(s.startsWith("cs:"))try{const g=await q(s);if(!g){U.error("Invalid share data");return}const{nodes:v,arrows:S}=Q(g),A=v.filter(c=>c.type===C.RECT||c.type===C.TEXT||c.type===C.TEXTCARD).length,E=v.filter(c=>c.type===C.DRAWING).length;v.length>0&&y(c=>[...c,...v]),S.length>0&&b(c=>[...c,...S]),U.success("Canvas imported!",{description:`Added ${A} text, ${E} drawings, ${S.length} arrows`}),a(""),i(null),n()}catch(g){U.error("Failed to import",{description:g instanceof Error?g.message:"Invalid data"})}},[s,y,b,n]),P=r.jsx(w,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:x,title:"Copy canvas to clipboard","data-test":"canvas-share-copy-button",children:o?r.jsx(ae,{size:14,className:"text-green-500"}):r.jsx(re,{size:14})});return r.jsx(F,{isVisible:e,onClose:n,title:"Share Canvas",triggerPosition:t,initialSize:{width:400,height:300},resizable:!0,headerActions:P,showPinButton:!1,showInspectorButton:!1,anchorOrigin:"top-right",children:r.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full","data-test":"canvas-share-content",children:[u&&r.jsxs("div",{className:"text-xs text-muted-foreground bg-muted/50 rounded p-2","data-test":"canvas-share-stats",children:["Last copy: ",u.nodeCount," nodes, ",u.arrowCount," arrows",r.jsx("br",{}),"Size: ",u.rawSize," â†’ ",u.compressedSize," bytes (",u.compressionRatio,"% reduction)"]}),r.jsxs("div",{className:"flex flex-col gap-1 flex-1 min-h-0",children:[r.jsx("label",{className:"text-xs font-medium",htmlFor:"paste-input",children:"Paste to import:"}),r.jsx(ce,{id:"paste-input",placeholder:"Paste cs:... data here",value:s,onChange:g=>a(g.target.value),className:"flex-1 min-h-[80px] text-xs font-mono resize-none","data-test":"canvas-share-paste-input"}),p&&r.jsx("div",{className:"flex items-center justify-between gap-2 mt-1","data-test":"canvas-share-import-preview",children:p.isValid?r.jsxs(r.Fragment,{children:[r.jsxs("span",{className:"text-xs text-muted-foreground",children:[p.textCount," text, ",p.drawingCount," drawings, ",p.arrowCount," arrows"]}),r.jsxs(w,{size:"sm",onClick:j,className:"gap-1","data-test":"canvas-share-import-button",children:[r.jsx(Te,{size:14}),"Import"]})]}):r.jsx("span",{className:"text-xs text-destructive",children:"Invalid share data"})})]})]})})},at=({onClick:e})=>{const n=t=>{const s=t.currentTarget.getBoundingClientRect();e({x:s.right,y:s.bottom+8})};return r.jsx(w,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5",onClick:n,title:"Share Canvas","data-test":"canvas-share-trigger",children:r.jsx(Pe,{className:"h-5 w-5"})})};function $(e){return se(JSON.stringify(e))}function rt(e){return se(JSON.stringify(e))}function H(e){const n=Object.values(e.nodes),t=rt(e);let s=0,a=null;const o={},l={};for(const p of n){const i=$(p);i>s&&(s=i,a=p.id);const h=p.operation.type;o[h]=(o[h]||0)+1,l[h]=(l[h]||0)+i}const u=n.filter(p=>p.children.length>1).length,d=ot(e);return{nodeCount:n.length,totalSizeBytes:t,totalSizeFormatted:V(t),avgNodeSizeBytes:n.length>0?Math.round(t/n.length):0,avgNodeSizeFormatted:V(n.length>0?t/n.length:0),largestNodeSizeBytes:s,largestNodeId:a,operationTypeCounts:o,operationTypeSizes:l,branchCount:u,maxDepth:d}}function nt(e,n){const s=Object.values(e.nodes).map(a=>({nodeId:a.id,operationType:a.operation.type,sizeBytes:$(a),sizeFormatted:V($(a)),timestamp:a.timestamp,label:a.label||a.operation.type}));return s.sort((a,o)=>o.sizeBytes-a.sizeBytes),n?s.slice(0,n):s}function le(e){const n=H(e),t=[];for(const[s,a]of Object.entries(n.operationTypeSizes)){const o=n.operationTypeCounts[s]||0;t.push({type:s,count:o,totalSize:a,avgSize:o>0?Math.round(a/o):0,formatted:V(a)})}return t.sort((s,a)=>a.totalSize-s.totalSize),t}function ot(e){if(!e.root)return 0;function n(t,s){if(s.has(t))return 0;s.add(t);const a=e.nodes[t];if(!a)return 0;if(a.children.length===0)return 1;let o=0;for(const l of a.children)o=Math.max(o,n(l,s));return 1+o}return n(e.root,new Set)}function it(e,n=1e4){return nt(e).filter(t=>t.sizeBytes>n)}function lt(e){const n=H(e),t=le(e);let s=`# Undo Tree Summary

`;s+=`## Statistics
`,s+=`- Total nodes: ${n.nodeCount}
`,s+=`- Total size: ${n.totalSizeFormatted}
`,s+=`- Average node size: ${n.avgNodeSizeFormatted}
`,s+=`- Branches: ${n.branchCount}
`,s+=`- Max depth: ${n.maxDepth}

`,s+=`## Size by Operation Type
`;for(const a of t)s+=`- ${a.type}: ${a.count} ops, ${a.formatted}
`;return s}function ct(){const[e,n]=f.useState(null),[t,s]=f.useState(!1),[a,o]=f.useState(!1),l=async()=>{o(!0);try{const p=L.getState().undo.getTreeData()??G(),i=H(p),h=le(p),m=it(p,5e3),y=await L.getState().undo.getArchiveStats();n({stats:i,byType:h,bloated:m,archive:y})}finally{o(!1)}},u=()=>{const p=L.getState().undo.getTreeData()??G(),i=lt(p);navigator.clipboard.writeText(i),s(!0),setTimeout(()=>s(!1),2e3)};return r.jsxs("div",{className:"flex flex-col gap-2","data-test":"undo-storage-analyzer",children:[r.jsxs("div",{className:"flex gap-2",children:[r.jsx(w,{variant:"outline",size:"sm",onClick:l,disabled:a,"data-test":"analyze-undo-storage-button",children:a?"Analyzing...":"Analyze Undo Storage"}),e&&r.jsx(w,{variant:"outline",size:"sm",onClick:u,"data-test":"copy-undo-summary-button",children:t?"Copied!":"Copy Summary"})]}),e&&r.jsxs("div",{className:"text-xs space-y-2 max-h-48 overflow-y-auto p-2 bg-muted rounded","data-test":"undo-analysis-results",children:[r.jsxs("div",{"data-test":"undo-stats-overview",children:[r.jsx("span",{className:"font-medium",children:"In Memory:"})," ",e.stats.totalSizeFormatted,r.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(",e.stats.nodeCount," nodes, avg ",e.stats.avgNodeSizeFormatted,")"]})]}),e.archive&&r.jsxs("div",{"data-test":"undo-stats-archive",children:[r.jsx("span",{className:"font-medium",children:"Archived:"})," ",r.jsxs("span",{className:"text-muted-foreground",children:[e.archive.archivedCount," / ",e.archive.archiveLimit," nodes"]}),r.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(limit: ",e.archive.historyLimit," in memory)"]})]}),e.byType.length>0&&r.jsxs("div",{"data-test":"undo-stats-by-type",children:[r.jsx("span",{className:"font-medium",children:"By Type:"}),r.jsx("ul",{className:"ml-2",children:e.byType.slice(0,5).map(d=>r.jsxs("li",{className:"text-muted-foreground",children:[d.type,": ",d.formatted," (",d.count,")"]},d.type))})]}),e.bloated.length>0&&r.jsxs("div",{className:"text-amber-600","data-test":"undo-stats-bloated",children:[r.jsxs("span",{className:"font-medium",children:["Bloated (",e.bloated.length,"):"]}),r.jsx("ul",{className:"ml-2",children:e.bloated.slice(0,3).map(d=>r.jsxs("li",{children:[d.label,": ",d.sizeFormatted]},d.nodeId))})]})]})]})}const Z="debug-reset-canvas-on-reload";function dt(){const[e,n]=f.useState(!1),[t,s]=f.useState(!1),[a,o]=f.useState(!1),[l,u]=f.useState();f.useEffect(()=>{localStorage.getItem(Z)==="true"&&(n(!0),L.getState().resetState())},[]);const d=i=>{n(i),localStorage.setItem(Z,String(i))},p=i=>{const h=i.currentTarget.getBoundingClientRect();u({x:h.left,y:h.bottom+8}),o(!0)};return r.jsxs(r.Fragment,{children:[r.jsx(w,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","data-test":"debug-popover-trigger",onClick:p,children:r.jsx(ze,{className:"h-5 w-5"})}),r.jsx(F,{isVisible:a,onClose:()=>o(!1),title:"Debug Actions",triggerPosition:l,className:"w-72",children:r.jsxs("div",{className:"flex flex-col gap-3 p-3","data-test":"debug-popover-content",children:[r.jsx(w,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>L.getState().resetState(),"data-test":"reset-canvas-state-button",children:"Reset canvas state"}),r.jsx(w,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>L.getState().resetEverything(),"data-test":"reset-everything-button",children:"Reset everything"}),r.jsxs("div",{className:"flex items-center gap-2","data-test":"reset-on-reload-container",children:[r.jsx(de,{id:"reset-on-reload",checked:e,onCheckedChange:d,"data-test":"reset-on-reload-checkbox"}),r.jsx(ue,{htmlFor:"reset-on-reload",className:"text-sm cursor-pointer","data-test":"reset-on-reload-label",children:"Reset on reload"})]}),r.jsx("hr",{className:"border-border"}),r.jsx("p",{className:"text-sm font-medium",children:"Storage Analysis"}),r.jsx(ct,{}),r.jsx("hr",{className:"border-border"}),r.jsx("p",{className:"text-sm font-medium",children:"Mobile Logs"}),r.jsxs("div",{className:"flex gap-2","data-test":"mobile-logs-actions",children:[r.jsx(w,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>{const i=!t;s(i),i&&o(!1)},"data-test":"toggle-mobile-logs-button",children:t?"Hide Mobile Logs":"Show Mobile Logs"}),r.jsx(w,{variant:"outline",size:"sm",onClick:async()=>{await De.copyToClipboard()?U.success("Logs copied to clipboard!"):U.error("Failed to copy logs")},title:"Copy mobile logs to clipboard","data-test":"copy-mobile-logs-button",children:r.jsx(re,{className:"h-4 w-4"})})]})]})}),t&&r.jsx(Be,{defaultVisible:!0,autoRefresh:!0,refreshInterval:500,onClose:()=>s(!1)})]})}const M=Me(),ee=_e(),_=ee&&M.find(e=>e.id===ee)||M[0];_&&(k(_),oe(_.id));const te={currentUser:_||null,users:M,presets:[],isLoading:!1,isOffline:!0,error:null,_apiClient:null},N=Ie((e,n)=>({...te,setApiClient:t=>e({_apiClient:t}),loadUsers:async()=>{e({isLoading:!0,error:null});const t=n()._apiClient;if(t)try{const a=await t.getUsers();R(a),e({users:a,isLoading:!1,isOffline:!1});return}catch{}const s=We();e({users:s||[],isLoading:!1,isOffline:!0})},loadActiveUser:async()=>{e({isLoading:!0,error:null});const t=n()._apiClient;if(t)try{const o=await t.getActiveUser();k(o),e({currentUser:o,isLoading:!1,isOffline:!1}),o&&await n().loadPresets(o.id);return}catch{}const s=Ve(),a=J();e({currentUser:s,presets:a||[],isLoading:!1,isOffline:!0})},setActiveUser:async t=>{e({isLoading:!0,error:null});const s=n()._apiClient,a=n().currentUser;let o=!s;if(s)try{await s.setActiveUser(t),o=!1}catch{o=!0}if(oe(t),t){const u=n().users.find(d=>d.id===t);u?(await $e((a==null?void 0:a.id)??null,u.id,u.username),k(u),e({currentUser:u,isLoading:!1,isOffline:o}),await n().loadPresets(t)):await n().loadActiveUser()}else k(null),z([]),e({currentUser:null,presets:[],isLoading:!1,isOffline:o})},createUser:async t=>{e({isLoading:!0,error:null});const s=n()._apiClient,a=B(),o={id:K(),username:t,profilePicture:"",isOnline:!0,lastSeen:a,createdAt:a,updatedAt:a};if(s)try{const u=await s.createUser({username:t}),d=[...n().users,u];return R(d),e({users:d,isLoading:!1,isOffline:!1}),u}catch{}const l=[...n().users,o];return R(l),e({users:l,isLoading:!1,isOffline:!0}),o},updateUser:async(t,s)=>{e({isLoading:!0,error:null});const a=n()._apiClient;if(a)try{const i=await a.updateUser(t,s),h=n().users.map(b=>b.id===t?i:b),m=n().currentUser,y=(m==null?void 0:m.id)===t?i:m;R(h),y&&k(y),e({users:h,currentUser:y,isLoading:!1,isOffline:!1});return}catch{}const o=n().users.find(i=>i.id===t);if(!o){e({error:"User not found",isLoading:!1});return}const l={...o,...s,updatedAt:B()},u=n().users.map(i=>i.id===t?l:i),d=n().currentUser,p=(d==null?void 0:d.id)===t?l:d;R(u),p&&k(p),e({users:u,currentUser:p,isLoading:!1,isOffline:!0})},deleteUser:async t=>{e({isLoading:!0,error:null});const s=n()._apiClient;let a=!s;if(s)try{await s.deleteUser(t),a=!1}catch{a=!0}const o=n().users.filter(d=>d.id!==t),l=n().currentUser,u=(l==null?void 0:l.id)===t;R(o),u&&(k(null),z([])),e({users:o,currentUser:u?null:l,presets:u?[]:n().presets,isLoading:!1,isOffline:a})},loadPresets:async t=>{e({isLoading:!0,error:null});const s=n()._apiClient;if(s)try{const l=await s.getPresets(t);z(l),e({presets:l,isLoading:!1,isOffline:!1});return}catch{}const a=J(),o=(a==null?void 0:a.filter(l=>l.userId===t))||[];e({presets:o,isLoading:!1,isOffline:!0})},createPreset:async(t,s)=>{const a=n().currentUser;if(!a)throw e({error:"No active user"}),new Error("No active user");e({isLoading:!0,error:null});const o=n()._apiClient,l=B(),u={id:K(),userId:a.id,name:t,settings:s||{},createdAt:l,updatedAt:l};if(o)try{const p=await o.createPreset(a.id,{name:t,settings:s}),i=[...n().presets,p];return z(i),e({presets:i,isLoading:!1,isOffline:!1}),p}catch{}const d=[...n().presets,u];return z(d),e({presets:d,isLoading:!1,isOffline:!0}),u},updatePreset:async(t,s)=>{e({isLoading:!0,error:null});const a=n()._apiClient;if(a)try{const d=await a.updatePreset(t,s),p=n().presets.map(i=>i.id===t?d:i);z(p),e({presets:p,isLoading:!1,isOffline:!1});return}catch{}const o=n().presets.find(d=>d.id===t);if(!o){e({error:"Preset not found",isLoading:!1});return}const l={...o,...s,updatedAt:B()},u=n().presets.map(d=>d.id===t?l:d);z(u),e({presets:u,isLoading:!1,isOffline:!0})},deletePreset:async t=>{e({isLoading:!0,error:null});const s=n()._apiClient;let a=!s;if(s)try{await s.deletePreset(t),a=!1}catch{a=!0}const o=n().presets.filter(l=>l.id!==t);z(o),e({presets:o,isLoading:!1,isOffline:a})},applyPreset:async t=>{const s=n().currentUser;if(!s){e({error:"No active user"});return}e({isLoading:!0,error:null});const a=n()._apiClient;if(a)try{await a.applyPreset(s.id,t),e({isLoading:!1,isOffline:!1});return}catch{}e({isLoading:!1,isOffline:!0})},clearError:()=>e({error:null}),reset:()=>e(te)})),ut=320,pt=400;function ht({isOpen:e,onClose:n,triggerPosition:t}){const s=N(c=>c.currentUser),a=N(c=>c.users),o=N(c=>c.presets),l=N(c=>c.setActiveUser),u=N(c=>c.createPreset),d=N(c=>c.deletePreset),p=N(c=>c.applyPreset),i=N(c=>c.isLoading),[h,m]=f.useState(!0),[y,b]=f.useState(""),[x,j]=f.useState(!1),[P,g]=f.useState(null),v=c=>{l(c)},S=async()=>{if(y.trim()){j(!0);try{await u(y.trim()),b("")}finally{j(!1)}}},A=async c=>{g(c.id),await p(c.id)},E=async c=>{await d(c),P===c&&g(null)};return r.jsx(F,{isVisible:e,onClose:n,title:"User Settings",triggerPosition:t,initialSize:{width:ut,height:pt},resizable:!0,shouldCloseManually:!0,anchorOrigin:"top-right","data-test":"user-settings-popover",children:r.jsxs("div",{className:"p-4 space-y-4","data-test":"user-settings-content",children:[r.jsx("section",{"data-test":"user-info-section",children:r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"w-12 h-12 rounded-full bg-muted flex items-center justify-center","data-test":"user-avatar",children:s!=null&&s.profilePicture?r.jsx("img",{src:s.profilePicture,alt:s.username,className:"w-full h-full rounded-full object-cover"}):r.jsx(ne,{className:"w-6 h-6 text-muted-foreground"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"font-medium text-sm","data-test":"user-display-name",children:(s==null?void 0:s.username)||"No user"}),r.jsxs(pe,{value:(s==null?void 0:s.id)||"",onValueChange:v,children:[r.jsx(he,{className:"h-7 text-xs mt-1","data-test":"user-switcher-select",children:r.jsx(fe,{placeholder:"Switch user"})}),r.jsx(me,{"data-test":"user-switcher-dropdown",children:a.map(c=>r.jsx(ge,{value:c.id,"data-test":`user-option-${c.id}`,children:c.username},c.id))})]})]})]})}),r.jsxs(xe,{open:h,onOpenChange:m,children:[r.jsxs(ye,{className:"flex items-center justify-between w-full py-2 text-sm font-medium hover:bg-muted/50 rounded px-2 -mx-2","data-test":"presets-section-trigger",children:[r.jsx("span",{children:"Presets"}),r.jsx(Ue,{className:D("w-4 h-4 transition-transform",h&&"rotate-180")})]}),r.jsx(ve,{"data-test":"presets-section-content",children:r.jsxs("div",{className:"mt-2 space-y-2",children:[o.length===0?r.jsx("p",{className:"text-xs text-muted-foreground py-2","data-test":"no-presets-message",children:"No presets yet. Create one below."}):r.jsx("ul",{className:"space-y-1","data-test":"presets-list",children:o.map(c=>r.jsxs("li",{className:D("flex items-center justify-between px-2 py-1.5 rounded text-sm","hover:bg-muted/50 transition-colors",P===c.id&&"bg-muted"),"data-test":`preset-item-${c.id}`,children:[r.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>void A(c),disabled:i,"data-test":`preset-apply-${c.id}`,children:[r.jsx("span",{className:D("w-4 h-4 rounded-full border flex items-center justify-center",P===c.id?"border-primary bg-primary":"border-muted-foreground"),children:P===c.id&&r.jsx(ae,{className:"w-3 h-3 text-primary-foreground"})}),r.jsx("span",{children:c.name})]}),r.jsx(w,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>void E(c.id),disabled:i,"data-test":`preset-delete-${c.id}`,children:r.jsx(Ae,{className:"w-3 h-3"})})]},c.id))}),r.jsxs("div",{className:"flex items-center gap-2 pt-2","data-test":"create-preset-form",children:[r.jsx(Ce,{placeholder:"New preset name",value:y,onChange:c=>b(c.target.value),onKeyDown:c=>{c.key==="Enter"&&S()},className:"h-8 text-sm",disabled:x,"data-test":"new-preset-input"}),r.jsx(w,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>void S(),disabled:!y.trim()||x,"data-test":"create-preset-button",children:r.jsx(Ee,{className:"w-4 h-4"})})]})]})})]})]})})}function ft({variant:e="ghost",size:n="icon"}){const t=N(p=>p.currentUser),[s,a]=f.useState(!1),[o,l]=f.useState(),u=f.useRef(null),d=()=>{if(u.current){const p=u.current.getBoundingClientRect();l({x:p.right,y:p.bottom+8})}a(!0)};return r.jsxs(r.Fragment,{children:[r.jsx(w,{ref:u,variant:e,size:n,onClick:d,"aria-label":"User settings",title:(t==null?void 0:t.username)||"User settings","data-test":"user-button",children:t!=null&&t.profilePicture?r.jsx("img",{src:t.profilePicture,alt:t.username,className:"w-5 h-5 rounded-full object-cover"}):r.jsx("span",{className:"flex items-center justify-center",children:t!=null&&t.username?r.jsx("span",{className:"text-sm font-medium",children:t.username.charAt(0).toUpperCase()}):r.jsx(ne,{className:"h-5 w-5"})})}),r.jsx(ht,{isOpen:s,onClose:()=>a(!1),triggerPosition:o})]})}function mt({showCollapseButton:e=!1}){const n=O(i=>i.uiState.floatingHeaderExpanded??!1),[t,s]=f.useState(!1),[a,o]=f.useState(),[l,u]=f.useState(!1),d=f.useRef(n);f.useEffect(()=>{if(d.current&&!n){u(!0);const i=setTimeout(()=>u(!1),300);return()=>clearTimeout(i)}d.current=n},[n]);const p=()=>{L.getState().setUiState(i=>({...i,floatingHeaderExpanded:!i.floatingHeaderExpanded}))};return!n&&!l?null:r.jsx("div",{className:"w-[98vw] pointer-events-none flex justify-end","data-test":"floating-header-wrapper",children:r.jsxs("header",{className:D("bg-card text-card-foreground top-0 flex items-center rounded-md p-2 shadow-md pointer-events-auto",n&&"animate-in slide-in-from-right duration-300",l&&"animate-out slide-out-to-right duration-300"),children:[e&&r.jsx(w,{variant:"ghost",size:"icon",onClick:p,"aria-label":"Collapse header","data-test":"floating-header-collapse-button",children:r.jsx(ke,{className:"size-5"})}),r.jsxs("div",{className:D("flex items-center gap-2",e&&"ml-2"),children:[r.jsx("h1",{className:"text-xl whitespace-nowrap",children:"CN-1"}),r.jsx(we,{}),r.jsx(be,{variant:"ghost",size:"icon",title:"Audio Recorder"}),r.jsx(Fe,{}),r.jsx(Se,{}),r.jsx(at,{onClick:i=>{o(i),s(!0)}}),r.jsx(st,{isOpen:t,onClose:()=>s(!1),triggerPosition:a}),r.jsx(dt,{}),r.jsx(ft,{}),r.jsx(je,{})]})]})})}function gt(){const[e,n]=f.useState(!1),[t,s]=f.useState({top:0,left:0}),[a,o]=f.useState(null),l=i=>{const h=i.getBoundingClientRect(),m=window.getComputedStyle(i),y=parseInt(m.lineHeight||m.fontSize),b=i.selectionStart,x=document.createElement("div");["boxSizing","width","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontFamily","fontSize","fontWeight","lineHeight","letterSpacing"].forEach(T=>{x.style[T]=m[T]}),x.style.position="absolute",x.style.top=h.top+"px",x.style.left=h.left+"px",x.style.visibility="hidden",x.style.whiteSpace="pre-wrap",x.style.wordWrap="break-word",x.style.overflow="hidden";const P=i.value.substring(0,b);x.textContent=P;const g=document.createElement("span");g.textContent="|",x.appendChild(g),document.body.appendChild(x);const v=g.getBoundingClientRect();document.body.removeChild(x);const S=v.top-h.top,A=v.left-h.left,E=S+y+4-i.scrollTop,c=A-i.scrollLeft;return{top:E,left:c}};return{showPopover:e,popoverPosition:t,handleKeyDown:i=>{if(i.key==="/"&&!e){const h=i.currentTarget,m=h.selectionStart,y=l(h);s(y),o(m),n(!0)}else(i.key==="Escape"||i.key==="Backspace"&&e&&a!==null&&i.currentTarget.selectionStart===a)&&(n(!1),o(null))},handleChange:i=>{e&&a!==null&&(a>=i.length||i[a]!=="/")&&(n(!1),o(null))},closePopover:()=>{n(!1),o(null)}}}const es=()=>{const[e,n]=f.useState("");return gt(),r.jsxs("div",{className:"page-container w-screen h-screen relative bg-background text-foreground",children:[r.jsx("div",{className:"absolute top-10 left-1/2 -translate-x-1/2 z-[60] pointer-events-none",children:r.jsx(mt,{})}),r.jsx("main",{className:"content-area w-full h-full",children:r.jsx("div",{className:"demo-section h-full",children:r.jsx(Oe,{width:"100%",height:"100%"})})})]})};export{es as NewHomeApp};
