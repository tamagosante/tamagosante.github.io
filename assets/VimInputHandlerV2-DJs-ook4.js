var Mn=Object.defineProperty;var Un=(a,e,t)=>e in a?Mn(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var k=(a,e,t)=>Un(a,typeof e!="symbol"?e+"":e,t);import{D as wt,V as Vt,R as It,L as nt,s as Cn,g as yn,P as Ln,I as Rn,S as Kn,W as zn,a as xn,b as qn}from"./logging-DNAPNJun.js";import{c7 as jn,c8 as $n,c9 as Gn}from"./index-eHP58yiE.js";import{i as En,S as Xe,g as Nn,r as Tn,b as Yn}from"./string-4WCj7OpV.js";import{h as Zn}from"./clipboardHtmlToMarkdown-BNZmEbgs.js";import{i as Qn}from"./react-vendor-Byz07MLO.js";async function Vr(){try{const a=await navigator.clipboard.read();for(const e of a){if(e.types.includes("text/html")){const n=await(await e.getType("text/html")).text();return Zn(n)}if(e.types.includes("text/plain"))return await(await e.getType("text/plain")).text()}return await navigator.clipboard.readText()}catch{return await navigator.clipboard.readText()}}async function Jn(a){var e,t;if((e=window.clipboardData)!=null&&e.setData)return window.clipboardData.setData("Text",a);if((t=document.queryCommandSupported)!=null&&t.call(document,"copy")){const n=document.createElement("textarea");n.textContent=a,n.style.position="fixed",document.body.appendChild(n),n.select();try{return document.execCommand("copy")}catch(s){return console.warn("Copy to clipboard failed.",s),prompt("Copy to clipboard: Ctrl+C, Enter",a)}finally{document.body.removeChild(n)}}}var Qt=(a=>(a.INDIVIDUAL="INDIVIDUAL",a.BATCH="BATCH",a))(Qt||{});const Xn={text:"",id:jn()};var T=(a=>(a.NORMAL="NORMAL",a.INSERT="INSERT",a.VISUAL="VISUAL",a.VISUALLINE="VISUALLINE",a.CUSTOM="CUSTOM",a.ALL="ALL",a))(T||{});const er="Enter",Tt="Space",tr=["Command","Control","Option","Alt","Shift","Caps Lock(Capital)","Escape","<Escape>","Enter","Backspace","CapsLock","Delete",Tt],nr=["⌘","⌃","⌥","⇧","⇪","↩︎"],Dn=[...tr,...nr],rr=["Tab","PageUp","Home","End","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"],Pn=[...Dn,...rr];var Q=(a=>(a.backspace="backspace",a.cancelAll="cancelAll",a.clearLine="clearLine",a.click="click",a.createNewLine="createNewLine",a.createNewLineAbove="createNewLineAbove",a.copy="copy",a.cursorRight="cursorRight",a.cursorUp="cursorUp",a.cursorLeft="cursorLeft",a.cursorDown="cursorDown",a.cursorWordForwardEnd="cursorWordForwardEnd",a.cursorWordForwardStart="cursorWordForwardStart",a.cursorBackwordsStartWord="cursorBackwordsStartWord",a.cursorLineEnd="cursorLineEnd",a.cursorLineStart="cursorLineStart",a.cut="cut",a.delete="delete",a.deleteInnerWord="deleteInnerWord",a.deleteLine="deleteLine",a.enterInsertAfterModeEnd="enterInsertAfterModeEnd",a.enterInsertAfterMode="enterInsertAfterMode",a.enterInsertMode="enterInsertMode",a.enterInsertModeStart="enterInsertModeStart",a.enterNormalMode="enterNormalMode",a.enterVisualMode="enterVisualMode",a.enterCustomMode="enterCustomMode",a.toggleFold="toggleFold",a.goToFirstLine="goToFirstLine",a.goToLastLine="goToLastLine",a.indentRight="indentRight",a.indentLeft="indentLeft",a.joinLine="joinLine",a.jumpNextBlock="jumpNextBlock",a.jumpPreviousBlock="jumpPreviousBlock",a.newLine="newLine",a.paste="paste",a.pasteVim="pasteVim",a.pasteVimBefore="pasteVimBefore",a.redo="redo",a.repeatLastCommand="repeatLastCommand",a.repeatLastCommandPaletteCommand="repeatLastCommandPaletteCommand",a.replace="replace",a.snippet="snippet",a.space="space",a.toCharacterAtBack="toCharacterAtBack",a.toCharacterAt="toCharacterAt",a.toCharacterAfterBack="toCharacterAfterBack",a.toCharacterBefore="toCharacterBefore",a.type="type",a.undo="undo",a.unfoldAll="unfoldAll",a.yank="yank",a.visualDelete="visualDelete",a.visualInnerWord="visualInnerWord",a.visualInnerBlock="visualInnerBlock",a.visualStartLineWise="visualStartLineWise",a.visualMoveToOtherEndOfMarkedArea="visualMoveToOtherEndOfMarkedArea",a.toggleCheckbox="toggleCheckbox",a.hint="hint",a.shift="shift",a.customExecute="customExecute",a.nothing="nothing",a))(Q||{});const ir=["enterInsertMode","enterInsertModeStart","enterNormalMode","enterVisualMode","visualStartLineWise","createNewLine","createNewLineAbove","enterInsertAfterModeEnd","enterInsertAfterMode","enterCustomMode"],ht={"<Alt>":"<Alt>","<Control>":"<Control>","<Enter>":"<Enter>","<Meta>":"<Meta>","<Shift>":"<Shift>","<Space>":"<Space>"},Ct=[{key:"<Control>c",command:Q.copy},{key:"<Control>x",command:Q.cut},{key:"<Control>z",command:Q.undo},{key:"<Control><Shift>Z",command:Q.redo},{key:"<Escape>",command:Q.enterNormalMode}],Jt=[{key:"<Shift>F",command:Q.toCharacterAtBack},{key:"F",command:Q.toCharacterAtBack},{key:"f",command:Q.toCharacterAt},{key:"r",command:Q.replace},{key:"<Shift>T",command:Q.toCharacterAfterBack},{key:"T",command:Q.toCharacterAfterBack},{key:"t",command:Q.toCharacterBefore}],Ot=[{key:"<ArrowLeft>",command:"cursorLeft"},{key:"<ArrowUp>",command:"cursorUp"},{key:"<ArrowRight>",command:"cursorRight"},{key:"<ArrowDown>",command:"cursorDown"}],sr=[{key:"<Control>]",command:"indentRight"},{key:"<Control>[",command:"indentLeft"}],bt=[{key:"b",command:"cursorBackwordsStartWord"},{key:"e",command:"cursorWordForwardEnd"},{key:"gg",command:"goToFirstLine"},{key:"h",command:"cursorLeft"},{key:"k",command:"cursorUp"},{key:"l",command:"cursorRight"},{key:"u",command:"cursorDown"},{key:"w",command:"cursorWordForwardStart"},{key:"y",command:"yank"},{key:"<Shift>G",command:"goToLastLine"},{key:"<Shift>$",command:"cursorLineEnd"},{key:"$",command:"cursorLineEnd"},{key:"<Shift>^",command:"cursorLineStart"},{key:"^",command:"cursorLineStart"},{key:"<Shift>}",command:"jumpNextBlock"},{key:"}",command:"jumpNextBlock"},{key:"<Shift>{",command:"jumpPreviousBlock"},{key:"{",command:"jumpPreviousBlock"},{key:"<Shift>><Shift>>",command:"indentRight"},{key:"<Shift><<Shift><",command:"indentLeft"},...Jt],tn={normal:[],[T.NORMAL]:[{key:"<Space>tc",sequence:"^elrx"},{key:"<Space>fu",command:Q.unfoldAll},{key:"a",command:Q.enterInsertAfterMode},{key:"cc",command:"clearLine"},{key:"dd",command:"deleteLine"},{key:"diw",command:"deleteInnerWord"},{key:"i",command:"enterInsertMode",preventUndoRedo:!0},{key:"<Shift>I",command:Q.enterInsertModeStart},{key:"J",command:"joinLine"},{key:"o",command:"createNewLine"},{key:"<Shift>O",command:Q.createNewLineAbove},{key:"p",command:Q.pasteVim},{key:"<Shift>P",command:Q.pasteVimBefore},{key:"v",command:"enterVisualMode"},{key:"<Shift>V",command:"visualStartLineWise"},{key:"x",command:"delete"},{key:"za",command:"toggleFold"},{key:".",command:Q.repeatLastCommand},{key:",.",command:Q.repeatLastCommandPaletteCommand},{key:"gh",command:"hint"},{key:"<Shift>A",command:Q.enterInsertAfterModeEnd},{key:"<Control>v",command:"paste"},{key:"<Enter>",command:"newLine"},{key:"<Backspace>",command:"backspace"},{key:"<Meta>",command:"nothing"},...Ct,...Ot,...sr,...bt],insert:[],[T.INSERT]:[{key:"<Enter>",command:"newLine"},{key:ht["<Space>"],command:"space"},...Ct],visual:[],[T.VISUAL]:[{key:"iw",command:"visualInnerWord"},{key:"ii",command:Q.visualInnerBlock},{key:"d",command:"visualDelete"},{key:"o",command:"visualMoveToOtherEndOfMarkedArea"},{key:"x",command:"visualDelete"},...Ct,...Ot,...bt],visualline:[],[T.VISUALLINE]:[{key:"d",command:"visualDelete"},{key:"o",command:"visualMoveToOtherEndOfMarkedArea"},{key:"x",command:"visualDelete"},...Ct,...Ot,...bt],[T.CUSTOM]:[{key:"x",command:"delete"},...Ct,...Ot,...bt],[T.ALL]:[{key:"<Space>cl",desc:"[cl]ear console",execute:()=>{console.clear()},preventUndoRedo:!0}]},or={"<esc>":"<Escape>",escape:"<Escape>"};function ar(a){return a===er||a===ht["<Enter>"]}function cr(...a){let e=0;if(a.length!==0){e.toString();for(let t=0;t<a.length;t++){const n=a[t];if(n)for(let s=0;s<n.length;s++){const o=n.charCodeAt(s);e=(e<<5)-e+o,e|=0}}return Math.abs(e).toString(16)}}function ur(a,e){const t=e.col,n=document.createNodeIterator(a,NodeFilter.SHOW_TEXT);let s,o=0,d=0;do{if(s=n.nextNode(),!s){s=document.createTextNode(""),a.appendChild(s);break}const x=s.textContent;if(x){const R=x.length;d=o,o+=R}}while(t>o);const h={...e,col:t-d};return{textNode:s,newCursor:h}}const nn=wt.createInterface("CommandsService");function rn(a){var t;return cr(a.desc,a.key,a.command,(t=a.context)==null?void 0:t.join(","),a.sequence)}class sn{constructor(e){k(this,"commandsRepository",{[Vt.default]:tn});k(this,"createId",rn);this.keyMappingService=e}static register(e){It.singleton(nn,sn).register(e)}registerCommands(e,t){if(!e)return;const n=hr(t,this.keyMappingService.keyBindings),s=dr(n);this.commandsRepository[e]=s}getCommand(e,t){const n=t.mode;return n?this.commandsRepository[e][n].find(o=>o.id===t.id):void 0}updateCommand(e,t){const n=this.commandsRepository[e].find(s=>s.command===t.command);console.log("[CommandsService.ts,46] commandInRepo: ",n)}async executeCommand(e,t){let n;const s=e.getVimState().mode;t!=null&&t.execute&&(n=e.getVimState(),await t.execute(s,n,e)),t!=null&&t.afterExecute&&await(t==null?void 0:t.afterExecute())}}Object.defineProperty(sn,"inject",{get(){return[Ht]},configurable:!0});const lr=navigator.userAgent.toUpperCase().includes("MAC");class tt{static clickGlobalShortcut(e){if($n())return;const n=document.querySelectorAll(`[data-shortcut="${e}"]`);n.length!==0&&(n.length>1&&(console.warn("Multiple elements with the same shortcut:"),console.log(n)),n[0].click())}static isModifierKey(e){const t=e;return Dn.includes(t)}static ensureVimModifier(e){return Pn.includes(e)?`<${e}>`:e}static getSynonymModifier(e){const t=or[e.toLowerCase()];return t||e}static getPressedKey(e){let t;return e.code===Tt?t=e.code:t=e.key,t}static checkAllowedBrowserShortcuts(e){const t=lr?e.metaKey:e.ctrlKey,n=e.key==="r"&&t,s=e.key==="R"&&t&&e.shiftKey;return n||s||e.key==="l"&&t||e.key==="C"&&t&&e.shiftKey||e.key==="="&&t?!0:!!(e.key==="-"&&t)}static assembleModifiers(e){let t="";const n=[];return e.ctrlKey&&(t+="Ctrl+",n.push(ht["<Control>"])),e.shiftKey&&(t+="Shift+",n.push(ht["<Shift>"])),e.altKey&&(t+="Alt+",n.push(ht["<Alt>"])),e.metaKey&&(t+="Meta+",n.push(ht["<Meta>"])),{collectedModifiers:n,modifiers:t}}static splitInputSequence(e){const t=new RegExp("(?<=>).|<(?=.)","g"),n=e.replace(t,o=>`,${o}`).split(","),s=[];return n.forEach(o=>{o.includes("<")?s.push(o):o.split("").forEach(d=>{s.push(d)})}),s}static getKeyWithModifer(e){const{collectedModifiers:t}=this.assembleModifiers(e),n=this.getPressedKey(e);return t.join("")+n}}const fe=new nt("KeyMappingService");function dr(a){return Object.entries(a).forEach(([e,t])=>{t.forEach(n=>{n.id=rn(n),n.mode=e})}),a}function hr(a,e){if(fe.shouldLog([4])&&console.log("base",a),fe.shouldLog([4])&&console.log("other",e),!a)return e;if(!e)return a;const t={...a??{},[T.NORMAL]:[...yt(a[T.NORMAL],a[T.ALL],e[T.NORMAL],e[T.ALL])],[T.INSERT]:[...yt(a[T.INSERT],a[T.ALL],e[T.INSERT],e[T.ALL])],[T.VISUAL]:[...yt(a[T.VISUAL],a[T.ALL],e[T.VISUAL],e[T.ALL])],[T.CUSTOM]:[...yt(a[T.CUSTOM],a[T.ALL],e[T.CUSTOM],e[T.ALL])],[T.ALL]:[...yt(a[T.ALL],e[T.ALL])]};return fe.shouldLog([4])&&console.log("merged",t),t}function yt(a,...e){const t=e.reduce((o,d)=>d?o==null?void 0:o.concat(d):o,[]),n=[],s=[...a??[]];return fe.shouldLog([1])&&console.log("Start -------------------------"),fe.shouldLog([1])&&console.log("finalCurrentBindings",n.length,n),fe.shouldLog([1])&&console.log("mergedAdditionals",t==null?void 0:t.length,t),s==null||s.forEach((o,d)=>{let h=0;t==null||t.forEach(x=>{const R=o.key===x.key,V=o.command===x.command;if(!o.key&&V){const W={...o,key:x.key};h>0?s.splice(d+h+1,0,W):(s[d]=W,h++)}else if(R){const W={...x,...o};s[d]=W}}),h=0}),s}function fr(a,e,t){const n=e.join("").concat(a),s=Jt.find(h=>h.key===n);if(s)return{targetCommand:void 0,potentialCommands:[s],keySequence:n};if(t.length!==1)return;const o=Jt.find(h=>h.command===t[0].command);return o?{targetCommand:o,potentialCommands:[o],keySequence:n}:void 0}const Ht=wt.createInterface("KeyMappingService");class on{constructor(){k(this,"keyBindings",tn);k(this,"potentialCommands",[]);k(this,"lastCommand");k(this,"lastCommandPaletteCommand");k(this,"lastKey");k(this,"queuedKeys",[]);k(this,"id","not-set")}static register(e){It.singleton(Ht,on).register(e),e.get(Ht)}initWithListener(e){document.addEventListener("keydown",t=>{const n=tt.getKeyWithModifer(t);if(e!=null&&e[n]){if(e[n]()===!1)return;t.preventDefault()}})}prepareCommandV2(e,t,n={}){let s=this.findPotentialCommandV2(e,[],t,n);return fe.shouldLog([,,3])&&console.log("targetCommand",s),!s&&this.potentialCommands.length===0&&(s=this.findPotentialCommandV2(e,[],T.ALL,n)),s?(s.execute&&(s.command=Q.customExecute),{targetCommand:s,potentialCommands:this.potentialCommands}):{targetCommand:s,potentialCommands:this.potentialCommands}}getCommandFromKey(e,t){const n=this.keyBindings[e];return n==null?void 0:n.find(o=>{if(o.key===t)return!0;const h=tt.getSynonymModifier(t);return o.key===h})}processCommandAwaitingNextInput(e){const t=fr(e,this.queuedKeys,this.potentialCommands);if(t!==void 0)return this.potentialCommands.length===0?this.potentialCommands=t.potentialCommands:this.potentialCommands.length===1&&(this.potentialCommands=[]),t}findPotentialCommandV2(e,t=[],n,s){var R,V,$,H,W,ne,ce;if(n!==T.INSERT){const G=this.processCommandAwaitingNextInput(e);if(G)return G.targetCommand}let o;if((R=this.potentialCommands)!=null&&R.length)o=this.potentialCommands;else{fe.shouldLog([3])&&console.log("this.keyBindings",this.keyBindings),fe.shouldLog([3])&&console.log("options?.keyBindings",s==null?void 0:s.keyBindings);const G=(s==null?void 0:s.keyBindings)??this.keyBindings;fe.shouldLog([3,,6])&&console.log("merged",G),o=(V=G[n])!=null&&V.length?G[n]:($=G[T.ALL])!=null&&$.length?G[T.ALL]:[]}fe.shouldLog([3,5,6])&&console.log("targetKeyBinding",o),e=this.ensureVimModifier(e),fe.culogger.debug(["Finding potential command for: ",e],{},(...G)=>console.log(...G)),fe.culogger.debug(["queuedKeys",this.queuedKeys],{},(...G)=>console.log(...G));let d="";if(this.queuedKeys.length)d=this.queuedKeys.join("").concat(e);else if(tt.getSynonymModifier(e)||t.length){const G=tt.getSynonymModifier(e);t.length&&(d+=t.join("")),G&&(d+=G)}else d=e;fe.culogger.debug(["keySequence: %s",d],{},(...G)=>console.log(...G)),fe.shouldLog([])&&console.log("targetKeyBinding",o),fe.shouldLog([])&&console.log("keySequence",d);const h=o==null?void 0:o.filter(G=>En(G.key,d));fe.culogger.debug(["potentialCommands: %o",h],{},(...G)=>console.log(...G)),fe.shouldLog([])&&console.log("finalPotentialCommands",h);let x;if((h==null?void 0:h.length)===0)fe.shouldLog([])&&console.log("1"),this.emptyQueuedKeys();else if((h==null?void 0:h.length)===1&&d===h[0].key){fe.shouldLog([])&&console.log("2");const G=(s==null?void 0:s.allowChaining)&&((W=(H=this.lastCommand)==null?void 0:H.key)==null?void 0:W.endsWith(d));if(s==null?void 0:s.allowExtendedChaining){fe.shouldLog([])&&console.log("2.1");const we=o==null?void 0:o.filter(Ce=>En(Ce.key,d));(ce=(ne=this.lastCommand)==null?void 0:ne.key)==null||ce.startsWith(d),x=we==null?void 0:we[0]}else G?(fe.shouldLog([])&&console.log("3"),x=this.lastCommand,this.emptyQueuedKeys()):(fe.shouldLog([])&&console.log("4"),x=h[0],fe.shouldLog([])&&console.log("finalPotentialCommands",h),this.emptyQueuedKeys())}else fe.shouldLog([,5])&&console.log("this.queuedKeys",this.queuedKeys),this.queuedKeys.push(e),h&&(this.potentialCommands=h);return fe.shouldLog([,,3])&&console.log("finalPotentialCommands,",h),fe.shouldLog([,,6])&&console.log("targetCommand",x),x}getLastCommand(){return this.lastCommand}setLastCommand(e){this.lastCommand=e}getLastCommandPaletteCommand(){return this.lastCommandPaletteCommand}setLastCommandPaletteCommand(e){this.lastCommandPaletteCommand=e}getLastKey(){return this.lastKey}setLastKey(e){this.lastKey=e}emptyQueuedKeys(){this.queuedKeys=[],this.potentialCommands=[]}ensureVimModifier(e){if(e.startsWith("<")&&e.endsWith(">"))return e;if(Pn.includes(e)){const n=`<${e}>`;return fe.culogger.debug(["Converted to vim modifier key: %s",n],{onlyVerbose:!0},(...s)=>console.log(...s)),n}return e}isEnter(e){return e.key==="Enter"}}function mr(a,e,t={}){console.log(">>>> _ >>>> ~ file: folding.ts:67 ~ foldMap:",t),console.log(">>>> _ >>>> ~ file: folding.ts:67 ~ nodes:",e),console.log(">>>> _ >>>> ~ file: folding.ts:67 ~ indentIndex:",a),e=vr(e);const n=gr(e,a);if(!n)return{foldMap:t,parentIndex:a};const[s,o]=n;if(s==null||o==null)return;let d=NaN;if(s===o)if(s===void 0)d=a;else{if(a===s&&a===0)return{foldMap:t,parentIndex:0};{const h=t[s];t[s]=!h,d=Math.max(s-1,0)}}else{for(let h=s;h<=o;h++){const x=t[h];t[h]=!x}d=Math.max(s-1,0)}return{foldMap:t,parentIndex:d}}function gr(a,e){var R,V,$,H,W,ne,ce,G,Be,we,Ce,xe,Se,U,Fe,ft;const t=(R=a[e])==null?void 0:R.indentation;if(t==null)return;const n=ot(e,a),s=(V=a[n])==null?void 0:V.indentation;if(s==null)return;const o=t<s&&((H=($=a[e])==null?void 0:$.text)==null?void 0:H.trim())!=="";let d=e,h=e;if(o){for(let X=n;X<a.length;X++){const Me=a[X].indentation;if(Me==null)break;const Ve=(W=a[ot(X,a)])==null?void 0:W.indentation;if(Ve==null)break;const $e=a[ot(X,a)];if(Me>t){h=X;continue}else{if(((ne=$e==null?void 0:$e.text)==null?void 0:ne.trim())==="")continue;if(Me>Ve)h=X;else if(Me<=t)break}}return[ot(d,a),h]}for(let X=e;X>=0&&X!==0;X--){if(a[Lt(X)]===void 0){d=void 0,h=void 0;break}const Me=a[X].indentation;if(Me==null)break;const Ve=a[Lt(X)].indentation;if(Ve==null)break;const $e=((G=(ce=a[X])==null?void 0:ce.text)==null?void 0:G.trim())==="",at=((we=(Be=a[Lt(X)])==null?void 0:Be.text)==null?void 0:we.trim())==="";if(!($e||at)){if(Me<Ve){d=void 0;break}else if(Me>Ve){d=X;break}}}if(d==null)return;const x=(Ce=a[Lt(d)])==null?void 0:Ce.indentation;if(x!=null){for(let X=e;X<a.length;X++){if(a[ot(X,a)]===void 0){h=void 0;break}const Me=a[X].indentation;if(Me==null)return;const Ve=(xe=a[ot(X,a)])==null?void 0:xe.indentation;if(Ve==null)return;const $e=((U=(Se=a[X])==null?void 0:Se.text)==null?void 0:U.trim())==="";if(!(((ft=(Fe=a[ot(X,a)])==null?void 0:Fe.text)==null?void 0:ft.trim())===""||$e)){if(Me<=x){h=Lt(X);break}else if(Ve<=x){h=X;break}}}return[d,h]}}function vr(a){return a.forEach(e=>{if(e.indentation)return;if(!e.text){e.indentation=0;return}const t=Xe.getLeadingWhitespaceNum(e.text);e.indentation=t}),a}function Lt(a){return Math.max(a-1,0)}function ot(a,e){return Math.min(a+1,e.length-1)}const Rt=new nt("VimState");class je{constructor(e){k(this,"id");k(this,"cursor");k(this,"foldMap");k(this,"lines");k(this,"mode");k(this,"visualStartCursor");k(this,"visualEndCursor");k(this,"deletedLinesIndeces");k(this,"deletedLines",{});k(this,"commandName");k(this,"snippet");this.vimState=e,e.id||(e.id=Gn()),this.updateVimState(e)}static create(e,t){return new je({mode:T.NORMAL,cursor:e,lines:t,id:""})}static createFromVimState(e){return new je(e)}static createEmpty(){return new je({mode:T.NORMAL,cursor:{col:0,line:0},lines:[{text:""}],id:"empty"})}serialize(){const e={id:this.id,cursor:this.cursor,lines:this.lines,mode:this.mode};return this.foldMap&&(e.foldMap=this.foldMap),this.visualStartCursor&&(e.visualStartCursor=this.visualStartCursor),this.visualEndCursor&&(e.visualEndCursor=this.visualEndCursor),this.deletedLinesIndeces&&(e.deletedLinesIndeces=this.deletedLinesIndeces),this.deletedLines&&(e.deletedLines=this.deletedLines),this.commandName&&(e.commandName=this.commandName),this.snippet&&(e.snippet=this.snippet),e}getLineAt(e){return this.lines?this.lines[e]:void 0}getActiveLine(){return this.cursor?this.getLineAt(this.cursor.line)??Xn:void 0}getPreviousLine(){if(!this.cursor)return;const e=Math.max(this.cursor.line-1,0);return this.getLineAt(e)}getNextLine(){if(!this.cursor||!this.lines)return;const e=this.getNextCursorLine();return e?this.getLineAt(e):void 0}getNextCursorLine(){if(!this.cursor||!this.lines)return;const e=this.lines.length;return Math.min(this.cursor.line+1,e-1)}getPreviousCursorLine(){return this.cursor?Math.max(this.cursor.line-1,0):void 0}insertLine(e,t){const n=structuredClone(this.lines);if(n)return n.splice(e,0,t),n}updateLine(e,t){this.lines&&(this.lines[e]={text:t})}updateActiveLine(e){this.cursor&&this.updateLine(this.cursor.line,e)}updateCursor(e){this.cursor=e}updateVimState(e){Object.assign(this,e),this.mode=e.mode??T.NORMAL}reportVimState(){const{cursor:e,lines:t,mode:n}=this;t&&(Rt.culogger.overwriteDefaultLogOtpions({log:!0}),n&&Rt.culogger.debug(["Vim in Mode:",n],{},(...s)=>console.log(...s)),Rt.culogger.debug(["Cursor at",{...e}],{},(...s)=>console.log(...s)),Rt.culogger.debug(["Lines are",t.map(s=>s.text)],{},(...s)=>console.log(...s)),Rt.culogger.overwriteDefaultLogOtpions({log:!1}))}isInsertMode(){return this.mode===T.INSERT}}class xt{static findIndexBackwardFromIndex(e,t,n){const o=e.slice(0,t).reverse().findIndex(n),d=t-o-1;return Math.max(0,d)}static findIndexFromIndex(e,t,n){return e.slice(t+1).findIndex(n)+t+1}static splitFirstMiddleLast(e){if(e.length<=2)return e;const t=this.splitIntoParts(e,[1,e.length-1]);return[t[0][0],t[1],t[2][0]]}static splitIntoParts(e,t){const n=Array.from({length:t.length+1},()=>[]);let s=0;return e.forEach((o,d)=>{t.includes(d)&&!0&&s++,n[s].push(o)}),n}static isTwoDimArray(e){return Array.isArray(e[0])}static ensureTwoDimArray(e){return this.isTwoDimArray(e)?e:e.map(t=>[t])}static getLongestElement(e){if(e.length===0)return"";let t="";for(const n of e)n&&n.length>t.length&&(t=n);return t}}const $t=new nt("AbstractMode"),Gt="*",pr={keyBindings:tn,leader:Tt,indentSize:4};class Ft{constructor(e){k(this,"vimStateClass");k(this,"vimState");k(this,"vimOptions",pr);e&&(this.vimState=new je(e),this.vimStateClass=this.vimState)}setVimState(e){this.vimState=je.create(e.cursor,e.lines)}executeCommand(e,t,n){this.vimStateClass=new je(e),this.vimState=this.vimStateClass;const s=this[t](n);if(!s)return;const o=s.serialize();return structuredClone(o)}commandExists(e){return!!this[e]}cursorRight(){return this.moveRight(1)}cursorLeft(){if(!this.vimStateClass.cursor)return this.vimStateClass;const e=this.vimStateClass.cursor.col-1,t=this.vimStateClass.getActiveLine();return t?Dt(e+1,t.text)?(this.setCursorCol(e),this.vimStateClass):this.vimStateClass:this.vimStateClass}cursorUp(){var d;if(!this.vimState.cursor)return this.vimState;if(!this.vimState.lines)return this.vimState;const e=this.vimState.cursor.line-1;if(!In(e+1,this.vimState.lines))return this.vimState;if(!this.vimState.lines)return this.vimState;const n=this.vimState.lines[e];Dt(this.vimState.cursor.col+1,n==null?void 0:n.text)||this.setCursorCol(Math.max(((d=n==null?void 0:n.text)==null?void 0:d.length)-1,0));const o=this.vimState.lines[e];return this.setCursorLine(e),this.reTokenizeInput(o==null?void 0:o.text),this.vimState}cursorDown(){var h;if(!this.vimState.cursor)return this.vimState;if(!this.vimState.lines)return this.vimState;const e=this.vimState.cursor.line+1,t=this.getAdjustedCursorLineWithFoldmap(e);if(!In(t+1,this.vimState.lines))return this.vimState;if(!this.vimState.lines)return this.vimState;const s=this.vimState.lines[t];Dt(this.vimState.cursor.col+1,s==null?void 0:s.text)||this.setCursorCol(Math.max(((h=s==null?void 0:s.text)==null?void 0:h.length)-1,0));const d=this.vimState.lines[t];return this.setCursorLine(t),this.reTokenizeInput(d==null?void 0:d.text),this.vimState}cursorWordForwardEnd(){if(!this.vimState.cursor)return this.vimState;const e=this.getTokenUnderCursor(),t=this.vimState.getActiveLine(),n=this.vimState.cursor.col===t.text.length-1,s=this.vimState.getNextCursorLine(),o=s>this.vimState.cursor.line,d=n&&o,h=(e==null?void 0:e.end)===this.vimState.cursor.col,x=e===void 0;let R;if(d){const V=this.vimState.getLineAt(s),H=this.reTokenizeInput(V.text)[0];R=H==null?void 0:H.end,this.setCursorLine(s)}else if(h){const V=this.getTokenAtIndex(e.index+1);V&&(R=V==null?void 0:V.end)}else if(x){const V=this.getNexToken();if(!V)return this.vimState;R=V==null?void 0:V.end}else R=e.end;return R&&this.setCursorCol(R),this.vimState}cursorWordForwardStart(){if(!this.vimState.cursor)return this.vimState;const e=this.getNexToken(),{col:t}=this.vimState.cursor,n=this.vimState.getActiveLine(),s=this.vimState.cursor.col===n.text.length-1,o=this.vimState.getNextCursorLine(),d=o>this.vimState.cursor.line,h=s&&d,x=(e==null?void 0:e.end)===t,R=e.start<=t&&t<e.end,V=e===void 0;let $;if(h){const H=this.vimState.getLineAt(o),ne=this.reTokenizeInput(H.text)[0];$=ne==null?void 0:ne.start,this.setCursorLine(o)}else if(x){const H=this.getTokenAtIndex(e.index+1);H&&($=H==null?void 0:H.end)}else if(R)$=e.end;else if(V){const H=this.getNexToken();H&&($=H==null?void 0:H.end)}else $=e.start;return $!=null&&this.setCursorCol($),this.vimState}cursorBackwordsStartWord(){if(!this.vimState.cursor)return this.vimState;let e=this.getTokenUnderCursor();if(e||(e=this.getPreviousToken()),!e)return this.vimState;const t=this.vimState.getActiveLine(),[n]=this.reTokenizeInput(t.text),{col:s,line:o}=this.vimState.cursor,d=s===(n==null?void 0:n.start),h=this.vimState.getPreviousCursorLine(),x=h<o,R=d&&x,V=(e==null?void 0:e.start)===this.vimState.cursor.col,$=e===void 0;let H;if(R){const W=this.vimState.getLineAt(h),ne=this.reTokenizeInput(W.text),ce=ne[ne.length-1];H=ce==null?void 0:ce.start,this.setCursorLine(h)}else if(V){const W=this.getTokenAtIndex(e.index-1);W&&(H=W==null?void 0:W.start)}else if($){const W=this.getPreviousToken();W&&(H=W==null?void 0:W.start)}else H=e.start;return H!==void 0&&this.setCursorCol(H),this.vimState}cursorLineEnd(){if(!this.vimState.cursor)return this.vimState;const e=this.vimState.getActiveLine();return e?(this.setCursorCol(Math.max(e.text.length-1,0)),this.vimState):this.vimState}cursorLineStart(){if(!this.vimState.cursor)return this.vimState;const e=this.vimState.getActiveLine();if(!e)return this.vimState;const t=Nn(e.text);return this.setCursorCol(t),this.vimState}goToFirstLine(){return this.vimState.cursor?(this.vimState.cursor.line=0,this.vimState):this.vimState}goToLastLine(){return this.vimState.cursor?this.vimState.lines?(this.vimState.cursor.line=this.vimState.lines.length,this.vimState):this.vimState:this.vimState}jumpNextBlock(){if(!this.vimState.cursor)return this.vimState;let e=NaN;const t=xt.findIndexFromIndex(this.vimState.lines??[],this.vimState.cursor.line,d=>d.text.trim()!==""),n=this.vimState.cursor.line-t+1;let s;n===0?s=this.vimState.cursor.line:s=t+1;const o=xt.findIndexFromIndex(this.vimState.lines??[],s,d=>d.text.trim()==="");return this.vimState.lines?(e=o,o===this.vimState.cursor.line?e=this.vimState.lines.length-1:o>=0&&(e=o),this.setCursorLine(e),this.vimState):this.vimState}jumpPreviousBlock(){if(!this.vimState.cursor)return this.vimState;if(!this.vimState.lines)return this.vimState;let e=NaN;const t=xt.findIndexBackwardFromIndex(this.vimState.lines,this.vimState.cursor.line,d=>d.text.trim()!==""),n=this.vimState.cursor.line-t-1;let s;n===0?s=this.vimState.cursor.line:s=t-1;const o=xt.findIndexBackwardFromIndex(this.vimState.lines,s,d=>d.text.trim()==="");return e=o,o===this.vimState.cursor.line?e=0:o>=0&&(e=o),this.setCursorLine(e),this.vimState}toCharacterAtBack(e){if(!this.vimState.cursor)return this.vimState;const{cursor:t}=this.vimState,n=this.vimState.getActiveLine();if(!n)return this.vimState;const o=n.text.substring(0,t.col),d=Xe.indexOfBack(o,e);return d>-1&&this.setCursorCol(d),this.vimState}toCharacterAt(e){if(!this.vimState.cursor)return this.vimState;const{cursor:t}=this.vimState,n=this.vimState.getActiveLine();if(!n)return this.vimState;const d=n.text.substring(t.col+1).indexOf(e)+1;if(d>-1){const h=t.col+d;this.setCursorCol(h)}return this.vimState}toCharacterAfterBack(e){if(!this.vimState.cursor)return this.vimState;const{cursor:t}=this.vimState,n=this.vimState.getActiveLine();if(!n)return this.vimState;const o=n.text.substring(0,t.col),d=Xe.indexOfBack(o,e);return d>-1&&this.setCursorCol(d+1),this.vimState}toCharacterBefore(e){if($t.shouldLog([3])&&console.trace("toCharacterBefore(commandInput:"),!this.vimState.cursor)return this.vimState;const{cursor:t}=this.vimState,n=this.vimState.getActiveLine();if(!n)return this.vimState;const d=n.text.substring(t.col).indexOf(e);if(d>0){const h=t.col+d-1;this.setCursorCol(h)}return this.vimState}moveRight(e){if(!this.vimStateClass.cursor)return this.vimStateClass;const t=this.vimStateClass.cursor.col+e,n=this.vimStateClass.getActiveLine();return n?Dt(t+1,n.text)?(this.setCursorCol(t),this.vimStateClass):this.vimStateClass:this.vimStateClass}getTokenUnderCursor(e){const t=e??this.vimState.getActiveLine();if(!t)return;const n=this.reTokenizeInput(t.text),s=n==null?void 0:n.find(o=>{if(!this.vimState.cursor)return;const d=this.vimState.cursor.col;return o.start<=d&&d<=o.end});return $t.culogger.debug(["Token under curor: %o",s],{onlyVerbose:!0}),s}getTokenAtIndex(e,t){const n=t??this.vimState.getActiveLine();if(!n)return;const s=this.reTokenizeInput(n.text);return s?(e<0?e=0:e>s.length-1&&(e=s.length-1),s[e]):void 0}getNexToken(e){const t=e??this.vimState.getActiveLine();if(!t)return;const n=this.reTokenizeInput(t.text);if(!n)return;const s=this.getTokenUnderCursor(e);let o=NaN;if(s==null){const h=this.getNextTokenFromCusor(n);if(!h)return;o=h.index}else o=s.index+1;const d=n[o];return d??s}getNextTokenFromCusor(e){if(!this.vimState.cursor||!e)return;const t=this.vimState.cursor.col,n=e.find(s=>s.end>=t);return n??e[0]}getPreviousToken(){if(!this.vimState.cursor||!this.vimState.lines)return;const e=this.vimState.getActiveLine();if(!e)return;const t=this.reTokenizeInput(e.text);if(!t||!this.getTokenUnderCursor())return;let s=0;const o=this.vimState.cursor.col;for(let h=0;h<t.length;h++){const x=t[h],R=t[h-1];if(!(!R||!(o<=x.start&&o>=R.end))){s=h-1;break}}return t[s]}indentRight(){if(!this.vimState.cursor)return this.vimState;const{indentSize:e}=this.vimOptions;if(!e)return this.vimState;if(!this.vimState.lines)return this.vimState;const t=this.vimState.getActiveLine();if(!t)return this.vimState;const n=t.text,s=wn(n);let o=this.vimState.cursor.col;s===this.vimState.cursor.col&&(o=o+e),this.setCursorCol(o);const h=`${" ".repeat(e)}${t.text}`;return this.vimState.updateActiveLine(h),this.reTokenizeInput(h),this.vimState}indentLeft(){if(!this.vimState.cursor)return this.vimState;if(!this.vimState.lines)return this.vimState;const{indentSize:e}=this.vimOptions;if(!e)return this.vimState;const t=this.vimState.getActiveLine();if(!t)return this.vimState;const n=t.text,s=wn(n);let o;o=s%e,o===0&&(o=e);const d=this.vimState.cursor.col,h=Math.max(s-o,0),x=d<h?d:h;this.setCursorCol(x);const R=n.substring(o);return this.vimState.lines[this.vimState.cursor.line].text=R,this.vimState.updateActiveLine(R),this.reTokenizeInput(R),this.vimState}delete(){if(!this.vimState.cursor)return this.vimState;const e=this.vimState.getActiveLine();if(!e)return this.vimState;const t=Tn(e.text,this.vimState.cursor.col,"");return this.vimState.updateActiveLine(t),this.vimState}replace(e){if(!this.vimState.cursor)return this.vimState;const t=this.vimState.getActiveLine();if(!t)return this.vimState;const n=t.text,{col:s}=this.vimState.cursor,o=Tn(n,s,e);return this.vimState.updateActiveLine(o),this.vimState}backspace(){return this.vimState}deleteLine(){if(!this.vimState.cursor)return this.vimState;if(!this.vimState.lines)return this.vimState;const e=this.vimState.cursor.line,t=this.vimState.getLineAt(e);if(!t)return this.vimState;this.vimState.deletedLines&&(this.vimState.deletedLines[Gt]=[t]),this.vimState.lines.splice(e,1);const n=this.vimState.getActiveLine(),s=n?Nn(n.text):0;return this.setCursorCol(s),this.vimState.deletedLinesIndeces=[e],this.vimState}saveDeletedLines(e,t=Gt){this.vimState.deletedLines&&(this.vimState.deletedLines[t]=e)}joinLine(){if(!this.vimState.cursor)return this.vimState;const e=this.vimState.getPreviousLine();if(!e)return this.vimState;const t=e.text,n=this.vimState.getActiveLine();if(!n)return this.vimState;const s=n.text,o=t.concat(s),d=this.vimState.cursor.line-1;return this.vimState.updateLine(d,o),this.deleteLine(),this.setCursorCol(t.length),this.vimState}toggleFold(){if(!this.vimState.cursor)return this.vimState;if(!this.vimState.lines)return this.vimState;const e=mr(this.vimState.cursor.line,this.vimState.lines,this.vimState.foldMap);if(!e)return this.vimState;const{foldMap:t,parentIndex:n}=e;return JSON.parse(JSON.stringify(t??{parseDefault:!0})),this.setCursorLine(n),this.vimState.foldMap=t,this.vimState}unfoldAll(){return this.vimState.foldMap=void 0,this.vimState}copy(){return this.vimState}cut(){return this.vimState}undo(){return this.vimState}redo(){return this.vimState}yank(){return this.vimState.mode=T.NORMAL,this.vimState}paste(e){if(!this.vimState.cursor)return this.vimState;const t=this.vimState.getActiveLine();if(!t)return this.vimState;const n=this.vimState.cursor.col;let s="";const o=[];if(e.length===1)s=Xe.insert(t.text,n,e[0]),o.push({...t,text:s});else if(e.length===2){const H=t.text.slice(0,n).concat(e[0]),W={...t,text:H},ne=t.text.slice(n,t.text.length),ce=e[1].concat(ne),G={...t,text:ce};o.push(W),o.push(G)}else{const[$,H,W]=xt.splitFirstMiddleLast(e),ce=t.text.slice(0,n).concat($),G={...t,text:ce},Be=t.text.slice(n,t.text.length),we=W.concat(Be),Ce={...t,text:we},xe=H.map(Se=>({text:Se}));o.push(G),o.push(...xe),o.push(Ce)}if(!this.vimState.lines)return this.vimState;const d=[...this.vimState.lines],h=this.vimState.cursor.line,x=[...d.slice(0,h)],R=[...d.slice(h+1,d.length)],V=[...x,...o,...R];return this.vimState.lines=V,this.vimState}pasteVim(){var h;if(!this.vimState.deletedLines)return this.vimState;const e=this.vimState.deletedLines[Gt];if(!e)return this.vimState;const t=this.vimState.getNextCursorLine();if(!t)return this.vimState;const n=new CRUDService;n.replace(this.vimState.lines);const s=n.insertAt(t,e);this.vimState.lines=s;const o=(h=this.vimState.getNextLine())==null?void 0:h.text;if(!o)return this.vimState;const d=Xe.getFirstNonWhiteSpaceCharIndex(o);return this.vimState.cursor&&(this.vimState.cursor.col=d,this.vimState.cursor.line=t),this.vimState}pasteVimBefore(){return this.vimState}cancelAll(){return this.vimState.mode=T.NORMAL,this.vimState.visualStartCursor=void 0,this.vimState.visualEndCursor=void 0,this.vimState}nothing(){return this.vimState}setCursorCol(e){this.vimStateClass.cursor&&(this.vimStateClass.cursor.col=Math.max(e,0))}setCursorLine(e){this.vimState.cursor&&(this.vimState.cursor.line=Math.max(e,0))}reTokenizeInput(e){if(e==="")return;const t=Sr(e);return $t.culogger.debug(["reTokenizeInput: %o",t],{onlyVerbose:!0}),t}getAdjustedCursorLineWithFoldmap(e){if(!this.vimState.foldMap||!this.vimState.cursor)return e;let t=0,n=e;for(;this.vimState.foldMap[n]===!0&&t<20;)n+=1,t++;return n}}function wn(a){const e=/\w/g.exec(a);let t=a.length;return e!==null&&(t=e.index),t}function Dt(a,e){return e?a===e.length+1?!0:!(a>e.length)&&!(a===0):!1}function In(a,e){return!(a>e.length)&&!(a===0)}function Sr(a){const e=[];let t="",n=0;for(let s=0;s<a.length;s++){const o=a[s];if(Cn.has(o)){for(t&&(e.push({string:t,start:n,end:n+t.length-1,index:e.length}),t=""),t+=o,n=s;s+1<a.length&&Cn.has(a[s+1]);)s++,t+=a[s];e.push({string:t,start:n,end:n+t.length-1,index:e.length}),t=""}else o.trim()?(t||(n=s),t+=o):t&&(e.push({string:t,start:n,end:n+t.length-1,index:e.length}),t="")}return t&&e.push({string:t,start:n,end:n+t.length-1,index:e.length}),e}class Et extends Ft{constructor(e){super(e)}deleteInnerWord(){var n;if(!this.vimState.cursor)return this.vimState;const e=super.getTokenUnderCursor();if(!e)return this.vimState;let t="";if(e){if(t=(n=this.vimState.getActiveLine())==null?void 0:n.text.replace(e.string,""),t){this.vimState.updateActiveLine(t);const s=e.start;this.vimState.updateCursor({...this.vimState.cursor,col:s})}}else this.delete();return this.vimState}clearLine(){return this.vimState.updateActiveLine(""),this.cursorLineEnd(),this.vimState}enterInsertMode(){return console.log("[NormalMode.ts,38] enterInsertMode: "),this.vimState.mode=T.INSERT,this.vimState}}const Cr=new nt("VisualMode");class yr extends Ft{constructor(e){super(e)}executeCommand(e,t,n){const s=super.executeCommand(e,t,n);if(s&&s.cursor)return s.visualEndCursor={col:s.cursor.col,line:s.cursor.line},s}visualMoveToOtherEndOfMarkedArea(){if(!this.vimState.cursor)return this.vimState;const e=this.vimState.cursor.col;return this.vimState.visualStartCursor&&(this.vimState.cursor.col=this.vimState.visualStartCursor.col,this.vimState.visualStartCursor.col=e),this.vimState}visualInnerWord(){if(!this.vimState.cursor)return this.vimState;const e=super.getTokenUnderCursor();return e?(e.start===this.vimState.cursor.col||(this.vimState.visualStartCursor={line:this.vimState.cursor.line,col:e.start},this.vimState.cursor.col=e.start),super.cursorWordForwardEnd(),this.vimState):this.vimState}visualStartLineWise(){if(!this.vimState.cursor)return this.vimState;this.vimState.visualStartCursor&&(this.vimState.visualStartCursor.col=0);const e=this.vimState.getActiveLine();return e?(this.vimState.cursor.col=e.text.length,this.vimState):this.vimState}visualDelete(){if(!this.vimState.cursor)return this.vimState;const{visualStartCursor:e,visualEndCursor:t}=this.vimState;if(!e)return Pt("Need start cursor"),this.vimState;if(!t)return Pt("Need end cursor"),this.vimState;const n=this.vimState.getActiveLine();if(!n)return this.vimState;const s=n.text,o=Yn(s,e.col,t.col);return this.vimState.updateActiveLine(o),this.vimState.cursor.col=e.col,this.vimState}yank(){return this.getSelectedText()?(this.vimState.mode=T.NORMAL,this.vimState):this.vimState}copy(){const e=this.getSelectedText();return e?(Jn(e),this.vimState.mode=T.NORMAL,this.vimState):this.vimState}getSelectedText(){const{visualStartCursor:e,visualEndCursor:t}=this.vimState;if(!e){Pt("Need start cursor");return}if(!t){Pt("Need end cursor");return}const n=this.vimState.getActiveLine();if(!n)return;const s=n.text,o=Math.min(e.col,t.col),d=Math.max(e.col,t.col);return s.slice(o,d+1)}}function Pt(a){Cr.culogger.debug([a],{isError:!0})}const Lr=new nt("VisualLineMode");class Rr extends Ft{constructor(){super(...arguments);k(this,"currentMode",T.VISUALLINE)}executeCommand(t,n,s){return super.executeCommand(t,n,s)}cursorUp(){const t=super.cursorUp();return t.cursor?(t.visualStartCursor&&(t.visualStartCursor.line=t.cursor.line),this.vimState=t,this.vimState):this.vimState}cursorDown(){const t=super.cursorDown();return t.cursor?(t.visualEndCursor&&(t.visualEndCursor.line=t.cursor.line),this.vimState=t,this.vimState):this.vimState}visualMoveToOtherEndOfMarkedArea(){if(!this.vimState.cursor)return this.vimState;const t=this.vimState.cursor.col;return this.vimState.visualStartCursor&&(this.vimState.cursor.col=this.vimState.visualStartCursor.col,this.vimState.visualStartCursor.col=t),this.vimState}visualDelete(){if(!this.vimState.cursor)return this.vimState;const{visualStartCursor:t,visualEndCursor:n}=this.vimState;if(!t)return kn("Need start cursor"),this.vimState;if(!n)return kn("Need end cursor"),this.vimState;const s=new CRUDService;s.replace(this.vimState.lines);const o=s.readBetween(t.line,n.line);if(this.saveDeletedLines(o),!this.vimState.getActiveLine())return this.vimState;const h=s.deleteBetween(t.line,n.line);return this.vimState.lines=h,this.vimState.cursor.col=t.col,this.vimState.cursor.line=t.line,this.vimState.mode=T.NORMAL,this.vimState}}function kn(a){Lr.culogger.debug([a],{isError:!0})}class Nt{static switchModes(e,t){if(!e)return;const{insert:n,normal:s,visual:o,custom:d}=t;switch(e){case T.NORMAL:{if(s)return s();break}case T.INSERT:{if(n)return n();break}case T.VISUAL:{if(o)return o();break}case T.CUSTOM:{if(d)return d();break}default:{console.log(`Mode not supported: ${e}`);return}}}static hasModeChanged(e,t){return e==null||t==null?!1:e!==t}static isModeChangingCommand(e){return ir.includes(e)}static getWordUnderCursor(e){if(!e)return;const n=new Et(e).getTokenUnderCursor();if(!n)return;let s=n.string;return s=Xe.matchWords(s)[0],s}static debugLog(e){var n;const t=(n=e.lines)==null?void 0:n.map(s=>s.text);console.log("[VimHelper.ts,76] onlyText: ",t)}static cursorToOffsetByVimState(e){if(!e.cursor||!e.lines)return;let t=0;for(let n=0;n<e.cursor.line;n++)t+=e.lines[n].text.length+1;return t+=e.cursor.col,t}static convertOffsetToVimStateCursor(e,t){if(e<0||!t.lines)return;let n=0,s=0,o=0;for(;o<e;){console.log("[VimHelper.ts,98] vimState.lines: ",t.lines);const d=t.lines[n].text;if(o+d.length+1>e){s=e-o;break}o+=d.length+1,n++}return{line:n,col:s}}}class xr extends Ft{constructor(e){super(e)}newLine(){const{cursor:e,lines:t}=this.vimState;if(!e)return this.vimState;if(!t)return this.vimState;const{line:n,col:s}=e,o=[...t];return o.splice(n,0,{text:""}),this.vimState.lines=o,this.vimState.updateCursor({line:n+1,col:0}),this.vimState}}const Yt=new nt("VimCommandManagerv3");class an{constructor(e){k(this,"internalVimState");this.options=e}static create(e){return new an(e)}executeCommand(e,t,n){var h,x;this.setInternalVimState(e);const s=this.getModeClass(e.mode),o=e.mode;if(Nt.isModeChangingCommand(t))return this.executeModeChange(t);if(!s)return;if(s.commandExists(t)){const R=s.executeCommand(e,t,n),V=e.mode;return o!==V&&(x=(h=this.options)==null?void 0:h.hooks)!=null&&x.modeChanged&&this.options.hooks.modeChanged({vimState:R,targetCommand:t,targetCommandFull:void 0,keys:"todo vcm"}),R}}setInternalVimState(e){this.internalVimState=structuredClone(e)}getModeClass(e){let t;switch(e){case T.NORMAL:{t=new Et(this.internalVimState);break}case T.INSERT:{t=new xr(this.internalVimState);break}case T.VISUAL:{t=new yr(this.internalVimState);break}case T.VISUALLINE:{t=new Rr(this.internalVimState);break}case T.CUSTOM:{this.internalVimState.mode=T.NORMAL,t=new Et(this.internalVimState);break}default:{console.log(`Mode not supported: ${e}`);break}}return t}executeModeChange(e){var o,d;if(Yt.culogger.debug(["Mode change command",e]),!this[e])return;const t=this[e](this.internalVimState);if(!((d=(o=this.options)==null?void 0:o.hooks)!=null&&d.modeChanged))return t;const n={vimState:t,targetCommand:this.internalVimState.commandName,targetCommandFull:void 0,keys:""},s=this.options.hooks.modeChanged(n);return s||t}enterNormalMode(e){return new Et(e).cancelAll().serialize()}enterVisualMode(e){var t;if(e.mode=T.VISUAL,!!(e!=null&&e.cursor))return e.visualStartCursor={col:(t=e==null?void 0:e.cursor)==null?void 0:t.col,line:e.cursor.line},e.visualEndCursor={col:e.cursor.col,line:e.cursor.line},e}enterCustomMode(e){const n=new Et(e).cancelAll().serialize();return n.mode=T.CUSTOM,n}visualStartLineWise(e){var n;if(!(e!=null&&e.cursor))return;Yt.culogger.debug(["Enter Visual Line mode"],{},(...s)=>console.log(...s));const t=new je(e);return e.visualStartCursor={col:0,line:e.cursor.line},e.visualEndCursor={col:((n=t.getActiveLine())==null?void 0:n.text.length)??0,line:e.cursor.line},e.mode=T.VISUALLINE,e}enterInsertMode(e){return Yt.shouldLog(36)&&console.log("[VimCommandManager.ts,200] enterInsertMode: "),e.mode=T.INSERT,e}createNewLine(e){const n=new je(e).getActiveLine();if(!n)return this.internalVimState;if(!e.cursor||!e.lines)return;const s=n.text,o=e.cursor.line+1,d=[...e.lines],h=Xe.getLeadingWhitespaceNum(s);d.splice(o,0,{text:" ".repeat(h)}),e.cursor.col=h;const x=e.cursor.line+1;return e.cursor.line=Math.max(x,0),e.lines=d,e.mode=T.INSERT,e}createNewLineAbove(e){if(!e.cursor||!e.lines)return;const n=new je(e).getActiveLine();if(!n)return;const s=n.text,o=Math.max(e.cursor.line,0),d=[...e.lines],h=Xe.getLeadingWhitespaceNum(s);return d.splice(o,0,{text:" ".repeat(h)}),e.cursor.col=h,e.cursor.line=o,e.lines=d,e.mode=T.INSERT,e}enterInsertModeStart(e){const n=new je(e).getActiveLine();if(!n)return e;const s=n.text,o=Xe.getFirstNonWhiteSpaceCharIndex(s);return e.cursor&&(e.cursor.col=o),e.mode=T.INSERT,e}enterInsertAfterMode(e){const t=e.mode,n=this.getModeClass(t),s=n==null?void 0:n.executeCommand(e,Q.cursorRight,"");return s?(s.mode=T.INSERT,s):e}enterInsertAfterModeEnd(e){const n=new je(e).getActiveLine();if(!n)return e;const s=n.text;return e.cursor&&(e.cursor.col=Math.max(s.length,0)),e.mode=T.INSERT,e}batchResults(e){const t=e.filter(o=>o.vimState);return n(t);function n(o){const d=s(o,x=>x.targetCommand);return Object.values(d).map(x=>x[x.length-1])}function s(o,d){return o.reduce((h,x)=>{const R=d(x);return h[R]||(h[R]=[]),h[R].push(x),h},{})}}}class cn{constructor(e){k(this,"vimState");k(this,"manager");k(this,"keyMappingService");var t;this.options=e,Object.assign(this,e),this.options=e,(t=this.options)!=null&&t.vimState||(this.vimState=je.createEmpty().serialize()),this.manager=an.create(this.options),this.manager.setInternalVimState(this.vimState),this.keyMappingService=new on}static create(e){return new cn(e)}init(){}getVimState(){return structuredClone(this.vimState)}setVimState(e){var t,n;e&&(this.vimState=e,(n=(t=this.options)==null?void 0:t.hooks)!=null&&n.vimStateUpdated&&this.options.hooks.vimStateUpdated(this.vimState))}executeCommand(e,t){const n=this.manager.executeCommand(this.vimState,e,t);if(n)return this.setVimState(n),n}executeCommandSequence(e){const t=tt.splitInputSequence(e),n=this.getVimState().mode;if(!n)return;const s=[];return t.forEach(d=>{console.log("[VimCore.ts,72] this.keyMappingService.id: ",this.keyMappingService.id);const{targetCommand:h}=this.keyMappingService.prepareCommandV2(d,n)??{};if(!(h!=null&&h.command))return;const x=Q[h.command];if(!x)return;const R=this.executeCommand(x,d);R&&s.push(R)}),s[s.length-1]}queueInput(e){const{targetCommand:t}=this.keyMappingService.prepareCommandV2(e,this.getVimState().mode)??{};if(!(t!=null&&t.command))return;const n=this.executeCommand(Q[t.command],e);return{vimState:n?structuredClone(n):this.getVimState(),targetCommand:Q[t.command],targetCommandFull:t,keys:e}}async queueInputSequence(e,t=Qt.INDIVIDUAL){const n=[];let s;typeof e=="string"?s=tt.splitInputSequence(e):s=e;for(const o of s){const d=this.queueInput(o);(d==null?void 0:d.targetCommand)!==void 0&&n.push(d)}return t===Qt.INDIVIDUAL?n:this.manager.batchResults(n)}}var Bn=(a=>(a[a.Text=3]="Text",a))(Bn||{});class Bt{static isTextNode(e){return e?e.nodeType===Bn.Text:!1}static isBr(e){return e?e.nodeName==="BR":!1}static isTag(e,t){return e?e.nodeName===t.toUpperCase():!1}}class Wt{constructor(e,t){this.container=e,this.childSelector=t}getInputContainerChildren(){return Wt.getInputContainerChildren(this.container,this.childSelector)}getInputContainerChildrenText(){return Wt.getInputContainerChildren(this.container,this.childSelector)}static getInputContainerChildren(e,t){return e==null?void 0:e.querySelectorAll(`.${t}`)}static getInputContainerChildrenText(e,t){return e==null?void 0:e.querySelectorAll(`.${t} .editorText`)}}var Zt={exports:{}},An;function Er(){return An||(An=1,(function(a,e){(function(t,n){a.exports=t()})(function(){var t="object",n="function",s="undefined",o=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],d=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],h=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],x=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function R(l,S){var v=typeof l[S];return v==n||!!(v==t&&l[S])||v=="unknown"}function V(l,S){return!!(typeof l[S]==t&&l[S])}function $(l,S){return typeof l[S]!=s}function H(l){return function(S,v){for(var w=v.length;w--;)if(!l(S,v[w]))return!1;return!0}}var W=H(R),ne=H(V),ce=H($);function G(l){return l&&W(l,x)&&ce(l,h)}function Be(l){return V(l,"body")?l.body:l.getElementsByTagName("body")[0]}var we=[].forEach?function(l,S){l.forEach(S)}:function(l,S){for(var v=0,w=l.length;v<w;++v)S(l[v],v)},Ce={},xe=typeof window!=s&&typeof document!=s,Se={isHostMethod:R,isHostObject:V,isHostProperty:$,areHostMethods:W,areHostObjects:ne,areHostProperties:ce,isTextRange:G,getBody:Be,forEach:we},U={version:"1.3.2",initialized:!1,isBrowser:xe,supported:!0,util:Se,features:{},modules:Ce,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==s?!0:rangyAutoInitialize}};function Fe(l){typeof console!=s&&R(console,"log")&&console.log(l)}function ft(l,S){xe&&S?alert(l):Fe(l)}function X(l){U.initialized=!0,U.supported=!1,ft("Rangy is not supported in this environment. Reason: "+l,U.config.alertOnFail)}U.fail=X;function Me(l){ft("Rangy warning: "+l,U.config.alertOnWarn)}U.warn=Me;var Ve;({}).hasOwnProperty?(Se.extend=Ve=function(l,S,v){var w,A;for(var _ in S)_==="__proto__"||_==="constructor"||_==="prototype"||S.hasOwnProperty(_)&&(w=l[_],A=S[_],v&&w!==null&&typeof w=="object"&&A!==null&&typeof A=="object"&&Ve(w,A,!0),l[_]=A);return S.hasOwnProperty("toString")&&(l.toString=S.toString),l},Se.createOptions=function(l,S){var v={};return Ve(v,S),l&&Ve(v,l),v}):X("hasOwnProperty not supported"),xe||X("Rangy can only run in a browser"),(function(){var l;if(xe){var S=document.createElement("div");S.appendChild(document.createElement("span"));var v=[].slice;try{v.call(S.childNodes,0)[0].nodeType==1&&(l=function(w){return v.call(w,0)})}catch{}}l||(l=function(w){for(var A=[],_=0,F=w.length;_<F;++_)A[_]=w[_];return A}),Se.toArray=l})();var $e;xe&&(R(document,"addEventListener")?$e=function(l,S,v){l.addEventListener(S,v,!1)}:R(document,"attachEvent")?$e=function(l,S,v){l.attachEvent("on"+S,v)}:X("Document does not have required addEventListener or attachEvent method"),Se.addListener=$e);var at=[];function dn(l){return l.message||l.description||String(l)}function Mt(){if(!(!xe||U.initialized)){var l,S=!1,v=!1;R(document,"createRange")&&(l=document.createRange(),W(l,d)&&ce(l,o)&&(S=!0));var w=Be(document);if(!w||w.nodeName.toLowerCase()!="body"){X("No body element found");return}if(w&&R(w,"createTextRange")&&(l=w.createTextRange(),G(l)&&(v=!0)),!S&&!v){X("Neither Range nor TextRange are available");return}U.initialized=!0,U.features={implementsDomRange:S,implementsTextRange:v};var A,_;for(var F in Ce)(A=Ce[F])instanceof kt&&A.init(A,U);for(var me=0,ye=at.length;me<ye;++me)try{at[me](U)}catch(Ee){_="Rangy init listener threw an exception. Continuing. Detail: "+dn(Ee),Fe(_)}}}function hn(l,S,v){v&&(l+=" in module "+v.name),U.warn("DEPRECATED: "+l+" is deprecated. Please use "+S+" instead.")}function fn(l,S,v,w){l[S]=function(){return hn(S,v,w),l[v].apply(l,Se.toArray(arguments))}}Se.deprecationNotice=hn,Se.createAliasForDeprecatedMethod=fn,U.init=Mt,U.addInitListener=function(l){U.initialized?l(U):at.push(l)};var Ut=[];U.addShimListener=function(l){Ut.push(l)};function Wn(l){l=l||window,Mt();for(var S=0,v=Ut.length;S<v;++S)Ut[S](l)}xe&&(U.shim=U.createMissingNativeApi=Wn,fn(U,"createMissingNativeApi","shim"));function kt(l,S,v){this.name=l,this.dependencies=S,this.initialized=!1,this.supported=!1,this.initializer=v}kt.prototype={init:function(){for(var l=this.dependencies||[],S=0,v=l.length,w,A;S<v;++S){if(A=l[S],w=Ce[A],!w||!(w instanceof kt))throw new Error("required module '"+A+"' not found");if(w.init(),!w.supported)throw new Error("required module '"+A+"' not supported")}this.initializer(this)},fail:function(l){throw this.initialized=!0,this.supported=!1,new Error(l)},warn:function(l){U.warn("Module "+this.name+": "+l)},deprecationNotice:function(l,S){U.warn("DEPRECATED: "+l+" in module "+this.name+" is deprecated. Please use "+S+" instead")},createError:function(l){return new Error("Error in Rangy "+this.name+" module: "+l)}};function mn(l,S,v){var w=new kt(l,S,function(A){if(!A.initialized){A.initialized=!0;try{v(U,A),A.supported=!0}catch(F){var _="Module '"+l+"' failed to load: "+dn(F);Fe(_),F.stack&&Fe(F.stack)}}});return Ce[l]=w,w}U.createModule=function(l){var S,v;arguments.length==2?(S=arguments[1],v=[]):(S=arguments[2],v=arguments[1]);var w=mn(l,v,S);U.initialized&&U.supported&&w.init()},U.createCoreModule=function(l,S,v){mn(l,S,v)};function gn(){}U.RangePrototype=gn,U.rangePrototype=new gn;function _n(){}U.selectionPrototype=new _n,U.createCoreModule("DomUtil",[],function(l,S){var v="undefined",w=l.util,A=w.getBody;w.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||S.fail("document missing a Node creation method"),w.isHostMethod(document,"getElementsByTagName")||S.fail("document missing getElementsByTagName method");var _=document.createElement("div");w.areHostMethods(_,["insertBefore","appendChild","cloneNode"])||S.fail("Incomplete Element implementation"),w.isHostProperty(_,"innerHTML")||S.fail("Element is missing innerHTML property");var F=document.createTextNode("test");w.areHostMethods(F,["splitText","deleteData","insertData","appendData","cloneNode"])||S.fail("Incomplete Text Node implementation");var me=function(f,L){for(var K=f.length;K--;)if(f[K]===L)return!0;return!1};function ye(f){var L;return typeof f.namespaceURI==v||(L=f.namespaceURI)===null||L=="http://www.w3.org/1999/xhtml"}function Ee(f){var L=f.parentNode;return L.nodeType==1?L:null}function ue(f){for(var L=0;f=f.previousSibling;)++L;return L}function Ue(f){switch(f.nodeType){case 7:case 10:return 0;case 3:case 8:return f.length;default:return f.childNodes.length}}function Oe(f,L){var K=[],D;for(D=f;D;D=D.parentNode)K.push(D);for(D=L;D;D=D.parentNode)if(me(K,D))return D;return null}function ve(f,L,K){for(var D=K?L:L.parentNode;D;){if(D===f)return!0;D=D.parentNode}return!1}function Ie(f,L){return ve(f,L,!0)}function de(f,L,K){for(var D,pe=K?f:f.parentNode;pe;){if(D=pe.parentNode,D===L)return pe;pe=D}return null}function He(f){var L=f.nodeType;return L==3||L==4||L==8}function C(f){if(!f)return!1;var L=f.nodeType;return L==3||L==8}function Z(f,L){var K=L.nextSibling,D=L.parentNode;return K?D.insertBefore(f,K):D.appendChild(f),f}function O(f,L,K){var D=f.cloneNode(!1);if(D.deleteData(0,L),f.deleteData(L,f.length-L),Z(D,f),K)for(var pe=0,oe;oe=K[pe++];)oe.node==f&&oe.offset>L?(oe.node=D,oe.offset-=L):oe.node==f.parentNode&&oe.offset>ue(f)&&++oe.offset;return D}function ie(f){if(f.nodeType==9)return f;if(typeof f.ownerDocument!=v)return f.ownerDocument;if(typeof f.document!=v)return f.document;if(f.parentNode)return ie(f.parentNode);throw S.createError("getDocument: no document found for node")}function ge(f){var L=ie(f);if(typeof L.defaultView!=v)return L.defaultView;if(typeof L.parentWindow!=v)return L.parentWindow;throw S.createError("Cannot get a window object for node")}function J(f){if(typeof f.contentDocument!=v)return f.contentDocument;if(typeof f.contentWindow!=v)return f.contentWindow.document;throw S.createError("getIframeDocument: No Document object found for iframe element")}function z(f){if(typeof f.contentWindow!=v)return f.contentWindow;if(typeof f.contentDocument!=v)return f.contentDocument.defaultView;throw S.createError("getIframeWindow: No Window object found for iframe element")}function he(f){return f&&w.isHostMethod(f,"setTimeout")&&w.isHostObject(f,"document")}function se(f,L,K){var D;if(f?w.isHostProperty(f,"nodeType")?D=f.nodeType==1&&f.tagName.toLowerCase()=="iframe"?J(f):ie(f):he(f)&&(D=f.document):D=document,!D)throw L.createError(K+"(): Parameter must be a Window object or DOM node");return D}function re(f){for(var L;L=f.parentNode;)f=L;return f}function Ke(f,L,K,D){var pe,oe,Ze,qe,De;if(f==K)return L===D?0:L<D?-1:1;if(pe=de(K,f,!0))return L<=ue(pe)?-1:1;if(pe=de(f,K,!0))return ue(pe)<D?-1:1;if(oe=Oe(f,K),!oe)throw new Error("comparePoints error: nodes have no common ancestor");if(Ze=f===oe?oe:de(f,oe,!0),qe=K===oe?oe:de(K,oe,!0),Ze===qe)throw S.createError("comparePoints got to case 4 and childA and childB are the same!");for(De=oe.firstChild;De;){if(De===Ze)return-1;if(De===qe)return 1;De=De.nextSibling}}var N=!1;function P(f){var L;try{return L=f.parentNode,!1}catch{return!0}}(function(){var f=document.createElement("b");f.innerHTML="1";var L=f.firstChild;f.innerHTML="<br />",N=P(L),l.features.crashyTextNodes=N})();function ee(f){if(!f)return"[No node]";if(N&&P(f))return"[Broken node]";if(He(f))return'"'+f.data+'"';if(f.nodeType==1){var L=f.id?' id="'+f.id+'"':"";return"<"+f.nodeName+L+">[index:"+ue(f)+",length:"+f.childNodes.length+"]["+(f.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return f.nodeName}function le(f){for(var L=ie(f).createDocumentFragment(),K;K=f.firstChild;)L.appendChild(K);return L}var Le;typeof window.getComputedStyle!=v?Le=function(f,L){return ge(f).getComputedStyle(f,null)[L]}:typeof document.documentElement.currentStyle!=v?Le=function(f,L){return f.currentStyle?f.currentStyle[L]:""}:S.fail("No means of obtaining computed style properties found");function ze(f,L,K){var D=A(f),pe=f.createElement("div");pe.contentEditable=""+!!K,L&&(pe.innerHTML=L);var oe=D.firstChild;return oe?D.insertBefore(pe,oe):D.appendChild(pe),pe}function be(f){return f.parentNode.removeChild(f)}function Ne(f){this.root=f,this._next=f}Ne.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var f=this._current=this._next,L,K;if(this._current)if(L=f.firstChild,L)this._next=L;else{for(K=null;f!==this.root&&!(K=f.nextSibling);)f=f.parentNode;this._next=K}return this._current},detach:function(){this._current=this._next=this.root=null}};function Te(f){return new Ne(f)}function ke(f,L){this.node=f,this.offset=L}ke.prototype={equals:function(f){return!!f&&this.node===f.node&&this.offset==f.offset},inspect:function(){return"[DomPosition("+ee(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};function We(f){this.code=this[f],this.codeName=f,this.message="DOMException: "+this.codeName}We.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},We.prototype.toString=function(){return this.message},l.dom={arrayContains:me,isHtmlNamespace:ye,parentElement:Ee,getNodeIndex:ue,getNodeLength:Ue,getCommonAncestor:Oe,isAncestorOf:ve,isOrIsAncestorOf:Ie,getClosestAncestorIn:de,isCharacterDataNode:He,isTextOrCommentNode:C,insertAfter:Z,splitDataNode:O,getDocument:ie,getWindow:ge,getIframeWindow:z,getIframeDocument:J,getBody:A,isWindow:he,getContentDocument:se,getRootContainer:re,comparePoints:Ke,isBrokenNode:P,inspectNode:ee,getComputedStyleProperty:Le,createTestElement:ze,removeNode:be,fragmentFromNodeChildren:le,createIterator:Te,DomPosition:ke},l.DOMException=We}),U.createCoreModule("DomRange",["DomUtil"],function(l,S){var v=l.dom,w=l.util,A=v.DomPosition,_=l.DOMException,F=v.isCharacterDataNode,me=v.getNodeIndex,ye=v.isOrIsAncestorOf,Ee=v.getDocument,ue=v.comparePoints,Ue=v.splitDataNode,Oe=v.getClosestAncestorIn,ve=v.getNodeLength,Ie=v.arrayContains,de=v.getRootContainer,He=l.features.crashyTextNodes,C=v.removeNode;function Z(i,c){return i.nodeType!=3&&(ye(i,c.startContainer)||ye(i,c.endContainer))}function O(i){return i.document||Ee(i.startContainer)}function ie(i){return de(i.startContainer)}function ge(i){return new A(i.parentNode,me(i))}function J(i){return new A(i.parentNode,me(i)+1)}function z(i,c,m){var y=i.nodeType==11?i.firstChild:i;return F(c)?m==c.length?v.insertAfter(i,c):c.parentNode.insertBefore(i,m==0?c:Ue(c,m)):m>=c.childNodes.length?c.appendChild(i):c.insertBefore(i,c.childNodes[m]),y}function he(i,c,m){if(ae(i),ae(c),O(c)!=O(i))throw new _("WRONG_DOCUMENT_ERR");var y=ue(i.startContainer,i.startOffset,c.endContainer,c.endOffset),b=ue(i.endContainer,i.endOffset,c.startContainer,c.startOffset);return m?y<=0&&b>=0:y<0&&b>0}function se(i){for(var c,m,y=O(i.range).createDocumentFragment(),b;m=i.next();){if(c=i.isPartiallySelectedSubtree(),m=m.cloneNode(!c),c&&(b=i.getSubtreeIterator(),m.appendChild(se(b)),b.detach()),m.nodeType==10)throw new _("HIERARCHY_REQUEST_ERR");y.appendChild(m)}return y}function re(i,c,m){var y,b;m=m||{stop:!1};for(var Y,p;Y=i.next();)if(i.isPartiallySelectedSubtree()){if(c(Y)===!1){m.stop=!0;return}else if(p=i.getSubtreeIterator(),re(p,c,m),p.detach(),m.stop)return}else for(y=v.createIterator(Y);b=y.next();)if(c(b)===!1){m.stop=!0;return}}function Ke(i){for(var c;i.next();)i.isPartiallySelectedSubtree()?(c=i.getSubtreeIterator(),Ke(c),c.detach()):i.remove()}function N(i){for(var c,m=O(i.range).createDocumentFragment(),y;c=i.next();){if(i.isPartiallySelectedSubtree()?(c=c.cloneNode(!1),y=i.getSubtreeIterator(),c.appendChild(N(y)),y.detach()):i.remove(),c.nodeType==10)throw new _("HIERARCHY_REQUEST_ERR");m.appendChild(c)}return m}function P(i,c,m){var y=!!(c&&c.length),b,Y=!!m;y&&(b=new RegExp("^("+c.join("|")+")$"));var p=[];return re(new le(i,!1),function(I){if(!(y&&!b.test(I.nodeType))&&!(Y&&!m(I))){var B=i.startContainer;if(!(I==B&&F(B)&&i.startOffset==B.length)){var j=i.endContainer;I==j&&F(j)&&i.endOffset==0||p.push(I)}}}),p}function ee(i){var c=typeof i.getName>"u"?"Range":i.getName();return"["+c+"("+v.inspectNode(i.startContainer)+":"+i.startOffset+", "+v.inspectNode(i.endContainer)+":"+i.endOffset+")]"}function le(i,c){if(this.range=i,this.clonePartiallySelectedTextNodes=c,!i.collapsed){this.sc=i.startContainer,this.so=i.startOffset,this.ec=i.endContainer,this.eo=i.endOffset;var m=i.commonAncestorContainer;this.sc===this.ec&&F(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===m&&!F(this.sc)?this.sc.childNodes[this.so]:Oe(this.sc,m,!0),this._last=this.ec===m&&!F(this.ec)?this.ec.childNodes[this.eo-1]:Oe(this.ec,m,!0))}}le.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var i=this._current=this._next;return i&&(this._next=i!==this._last?i.nextSibling:null,F(i)&&this.clonePartiallySelectedTextNodes&&(i===this.ec&&(i=i.cloneNode(!0)).deleteData(this.eo,i.length-this.eo),this._current===this.sc&&(i=i.cloneNode(!0)).deleteData(0,this.so))),i},remove:function(){var i=this._current,c,m;F(i)&&(i===this.sc||i===this.ec)?(c=i===this.sc?this.so:0,m=i===this.ec?this.eo:i.length,c!=m&&i.deleteData(c,m-c)):i.parentNode&&C(i)},isPartiallySelectedSubtree:function(){var i=this._current;return Z(i,this.range)},getSubtreeIterator:function(){var i;if(this.isSingleCharacterDataNode)i=this.range.cloneRange(),i.collapse(!1);else{i=new Re(O(this.range));var c=this._current,m=c,y=0,b=c,Y=ve(c);ye(c,this.sc)&&(m=this.sc,y=this.so),ye(c,this.ec)&&(b=this.ec,Y=this.eo),te(i,m,y,b,Y)}return new le(i,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Le=[1,3,4,5,7,8,10],ze=[2,9,11],be=[5,6,10,12],Ne=[1,3,4,5,7,8,10,11],Te=[1,3,4,5,7,8];function ke(i){return function(c,m){for(var y,b=m?c:c.parentNode;b;){if(y=b.nodeType,Ie(i,y))return b;b=b.parentNode}return null}}var We=ke([9,11]),f=ke(be),L=ke([6,10,12]),K=ke([1]);function D(i,c){if(L(i,c))throw new _("INVALID_NODE_TYPE_ERR")}function pe(i,c){if(!Ie(c,i.nodeType))throw new _("INVALID_NODE_TYPE_ERR")}function oe(i,c){if(c<0||c>(F(i)?i.length:i.childNodes.length))throw new _("INDEX_SIZE_ERR")}function Ze(i,c){if(We(i,!0)!==We(c,!0))throw new _("WRONG_DOCUMENT_ERR")}function qe(i){if(f(i,!0))throw new _("NO_MODIFICATION_ALLOWED_ERR")}function De(i,c){if(!i)throw new _(c)}function mt(i,c){return c<=(F(i)?i.length:i.childNodes.length)}function rt(i){return!!i.startContainer&&!!i.endContainer&&!(He&&(v.isBrokenNode(i.startContainer)||v.isBrokenNode(i.endContainer)))&&de(i.startContainer)==de(i.endContainer)&&mt(i.startContainer,i.startOffset)&&mt(i.endContainer,i.endOffset)}function ae(i){if(!rt(i))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+i.inspect()+")")}var gt=document.createElement("style"),Je=!1;try{gt.innerHTML="<b>x</b>",Je=gt.firstChild.nodeType==3}catch{}l.features.htmlParsingConforms=Je;var vt=Je?function(i){var c=this.startContainer,m=Ee(c);if(!c)throw new _("INVALID_STATE_ERR");var y=null;return c.nodeType==1?y=c:F(c)&&(y=v.parentElement(c)),y===null||y.nodeName=="HTML"&&v.isHtmlNamespace(Ee(y).documentElement)&&v.isHtmlNamespace(y)?y=m.createElement("body"):y=y.cloneNode(!1),y.innerHTML=i,v.fragmentFromNodeChildren(y)}:function(i){var c=O(this),m=c.createElement("body");return m.innerHTML=i,v.fragmentFromNodeChildren(m)};function ct(i,c){ae(i);var m=i.startContainer,y=i.startOffset,b=i.endContainer,Y=i.endOffset,p=m===b;F(b)&&Y>0&&Y<b.length&&Ue(b,Y,c),F(m)&&y>0&&y<m.length&&(m=Ue(m,y,c),p?(Y-=y,b=m):b==m.parentNode&&Y>=me(m)&&Y++,y=0),i.setStartAndEnd(m,y,b,Y)}function q(i){ae(i);var c=i.commonAncestorContainer.parentNode.cloneNode(!1);return c.appendChild(i.cloneContents()),c.innerHTML}var ut=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],lt=0,it=1,At=2,et=3,st=0,pt=1,St=2,dt=3;w.extend(l.rangePrototype,{compareBoundaryPoints:function(i,c){ae(this),Ze(this.startContainer,c.startContainer);var m,y,b,Y,p=i==et||i==lt?"start":"end",I=i==it||i==lt?"start":"end";return m=this[p+"Container"],y=this[p+"Offset"],b=c[I+"Container"],Y=c[I+"Offset"],ue(m,y,b,Y)},insertNode:function(i){if(ae(this),pe(i,Ne),qe(this.startContainer),ye(i,this.startContainer))throw new _("HIERARCHY_REQUEST_ERR");var c=z(i,this.startContainer,this.startOffset);this.setStartBefore(c)},cloneContents:function(){ae(this);var i,c;if(this.collapsed)return O(this).createDocumentFragment();if(this.startContainer===this.endContainer&&F(this.startContainer))return i=this.startContainer.cloneNode(!0),i.data=i.data.slice(this.startOffset,this.endOffset),c=O(this).createDocumentFragment(),c.appendChild(i),c;var m=new le(this,!0);return i=se(m),m.detach(),i},canSurroundContents:function(){ae(this),qe(this.startContainer),qe(this.endContainer);var i=new le(this,!0),c=i._first&&Z(i._first,this)||i._last&&Z(i._last,this);return i.detach(),!c},surroundContents:function(i){if(pe(i,Te),!this.canSurroundContents())throw new _("INVALID_STATE_ERR");var c=this.extractContents();if(i.hasChildNodes())for(;i.lastChild;)i.removeChild(i.lastChild);z(i,this.startContainer,this.startOffset),i.appendChild(c),this.selectNode(i)},cloneRange:function(){ae(this);for(var i=new Re(O(this)),c=ut.length,m;c--;)m=ut[c],i[m]=this[m];return i},toString:function(){ae(this);var i=this.startContainer;if(i===this.endContainer&&F(i))return i.nodeType==3||i.nodeType==4?i.data.slice(this.startOffset,this.endOffset):"";var c=[],m=new le(this,!0);return re(m,function(y){(y.nodeType==3||y.nodeType==4)&&c.push(y.data)}),m.detach(),c.join("")},compareNode:function(i){ae(this);var c=i.parentNode,m=me(i);if(!c)throw new _("NOT_FOUND_ERR");var y=this.comparePoint(c,m),b=this.comparePoint(c,m+1);return y<0?b>0?St:st:b>0?pt:dt},comparePoint:function(i,c){return ae(this),De(i,"HIERARCHY_REQUEST_ERR"),Ze(i,this.startContainer),ue(i,c,this.startContainer,this.startOffset)<0?-1:ue(i,c,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:vt,toHtml:function(){return q(this)},intersectsNode:function(i,c){if(ae(this),de(i)!=ie(this))return!1;var m=i.parentNode,y=me(i);if(!m)return!0;var b=ue(m,y,this.endContainer,this.endOffset),Y=ue(m,y+1,this.startContainer,this.startOffset);return c?b<=0&&Y>=0:b<0&&Y>0},isPointInRange:function(i,c){return ae(this),De(i,"HIERARCHY_REQUEST_ERR"),Ze(i,this.startContainer),ue(i,c,this.startContainer,this.startOffset)>=0&&ue(i,c,this.endContainer,this.endOffset)<=0},intersectsRange:function(i){return he(this,i,!1)},intersectsOrTouchesRange:function(i){return he(this,i,!0)},intersection:function(i){if(this.intersectsRange(i)){var c=ue(this.startContainer,this.startOffset,i.startContainer,i.startOffset),m=ue(this.endContainer,this.endOffset,i.endContainer,i.endOffset),y=this.cloneRange();return c==-1&&y.setStart(i.startContainer,i.startOffset),m==1&&y.setEnd(i.endContainer,i.endOffset),y}return null},union:function(i){if(this.intersectsOrTouchesRange(i)){var c=this.cloneRange();return ue(i.startContainer,i.startOffset,this.startContainer,this.startOffset)==-1&&c.setStart(i.startContainer,i.startOffset),ue(i.endContainer,i.endOffset,this.endContainer,this.endOffset)==1&&c.setEnd(i.endContainer,i.endOffset),c}else throw new _("Ranges do not intersect")},containsNode:function(i,c){return c?this.intersectsNode(i,!1):this.compareNode(i)==dt},containsNodeContents:function(i){return this.comparePoint(i,0)>=0&&this.comparePoint(i,ve(i))<=0},containsRange:function(i){var c=this.intersection(i);return c!==null&&i.equals(c)},containsNodeText:function(i){var c=this.cloneRange();c.selectNode(i);var m=c.getNodes([3]);if(m.length>0){c.setStart(m[0],0);var y=m.pop();return c.setEnd(y,y.length),this.containsRange(c)}else return this.containsNodeContents(i)},getNodes:function(i,c){return ae(this),P(this,i,c)},getDocument:function(){return O(this)},collapseBefore:function(i){this.setEndBefore(i),this.collapse(!1)},collapseAfter:function(i){this.setStartAfter(i),this.collapse(!0)},getBookmark:function(i){var c=O(this),m=l.createRange(c);i=i||v.getBody(c),m.selectNodeContents(i);var y=this.intersection(m),b=0,Y=0;return y&&(m.setEnd(y.startContainer,y.startOffset),b=m.toString().length,Y=b+y.toString().length),{start:b,end:Y,containerNode:i}},moveToBookmark:function(i){var c=i.containerNode,m=0;this.setStart(c,0),this.collapse(!0);for(var y=[c],b,Y=!1,p=!1,I,B,j;!p&&(b=y.pop());)if(b.nodeType==3)I=m+b.length,!Y&&i.start>=m&&i.start<=I&&(this.setStart(b,i.start-m),Y=!0),Y&&i.end>=m&&i.end<=I&&(this.setEnd(b,i.end-m),p=!0),m=I;else for(j=b.childNodes,B=j.length;B--;)y.push(j[B])},getName:function(){return"DomRange"},equals:function(i){return Re.rangesEqual(this,i)},isValid:function(){return rt(this)},inspect:function(){return ee(this)},detach:function(){}});function r(i){i.START_TO_START=lt,i.START_TO_END=it,i.END_TO_END=At,i.END_TO_START=et,i.NODE_BEFORE=st,i.NODE_AFTER=pt,i.NODE_BEFORE_AND_AFTER=St,i.NODE_INSIDE=dt}function u(i){r(i),r(i.prototype)}function g(i,c){return function(){ae(this);var m=this.startContainer,y=this.startOffset,b=this.commonAncestorContainer,Y=new le(this,!0),p,I;m!==b&&(p=Oe(m,b,!0),I=J(p),m=I.node,y=I.offset),re(Y,qe),Y.reset();var B=i(Y);return Y.detach(),c(this,m,y,m,y),B}}function E(i,c){function m(p,I){return function(B){pe(B,Le),pe(de(B),ze);var j=(p?ge:J)(B);(I?y:b)(this,j.node,j.offset)}}function y(p,I,B){var j=p.endContainer,Pe=p.endOffset;(I!==p.startContainer||B!==p.startOffset)&&((de(I)!=de(j)||ue(I,B,j,Pe)==1)&&(j=I,Pe=B),c(p,I,B,j,Pe))}function b(p,I,B){var j=p.startContainer,Pe=p.startOffset;(I!==p.endContainer||B!==p.endOffset)&&((de(I)!=de(j)||ue(I,B,j,Pe)==-1)&&(j=I,Pe=B),c(p,j,Pe,I,B))}var Y=function(){};Y.prototype=l.rangePrototype,i.prototype=new Y,w.extend(i.prototype,{setStart:function(p,I){D(p,!0),oe(p,I),y(this,p,I)},setEnd:function(p,I){D(p,!0),oe(p,I),b(this,p,I)},setStartAndEnd:function(){var p=arguments,I=p[0],B=p[1],j=I,Pe=B;switch(p.length){case 3:Pe=p[2];break;case 4:j=p[2],Pe=p[3];break}D(I,!0),oe(I,B),D(j,!0),oe(j,Pe),c(this,I,B,j,Pe)},setBoundary:function(p,I,B){this["set"+(B?"Start":"End")](p,I)},setStartBefore:m(!0,!0),setStartAfter:m(!1,!0),setEndBefore:m(!0,!1),setEndAfter:m(!1,!1),collapse:function(p){ae(this),p?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(p){D(p,!0),c(this,p,0,p,ve(p))},selectNode:function(p){D(p,!1),pe(p,Le);var I=ge(p),B=J(p);c(this,I.node,I.offset,B.node,B.offset)},extractContents:g(N,c),deleteContents:g(Ke,c),canSurroundContents:function(){ae(this),qe(this.startContainer),qe(this.endContainer);var p=new le(this,!0),I=p._first&&Z(p._first,this)||p._last&&Z(p._last,this);return p.detach(),!I},splitBoundaries:function(){ct(this)},splitBoundariesPreservingPositions:function(p){ct(this,p)},normalizeBoundaries:function(){ae(this);var p=this.startContainer,I=this.startOffset,B=this.endContainer,j=this.endOffset,Pe=function(_e){var Qe=_e.nextSibling;Qe&&Qe.nodeType==_e.nodeType&&(B=_e,j=_e.length,_e.appendData(Qe.data),C(Qe))},pn=function(_e){var Qe=_e.previousSibling;if(Qe&&Qe.nodeType==_e.nodeType){p=_e;var Fn=_e.length;if(I=Qe.length,_e.insertData(0,Qe.data),C(Qe),p==B)j+=I,B=p;else if(B==_e.parentNode){var Sn=me(_e);j==Sn?(B=_e,j=Fn):j>Sn&&j--}}},zt=!0,Ge;if(F(B))j==B.length?Pe(B):j==0&&(Ge=B.previousSibling,Ge&&Ge.nodeType==B.nodeType&&(j=Ge.length,p==B&&(zt=!1),Ge.appendData(B.data),C(B),B=Ge));else{if(j>0){var qt=B.childNodes[j-1];qt&&F(qt)&&Pe(qt)}zt=!this.collapsed}if(zt){if(F(p))I==0?pn(p):I==p.length&&(Ge=p.nextSibling,Ge&&Ge.nodeType==p.nodeType&&(B==Ge&&(B=p,j+=p.length),p.appendData(Ge.data),C(Ge)));else if(I<p.childNodes.length){var jt=p.childNodes[I];jt&&F(jt)&&pn(jt)}}else p=B,I=j;c(this,p,I,B,j)},collapseToPoint:function(p,I){D(p,!0),oe(p,I),this.setStartAndEnd(p,I)},parentElement:function(){ae(this);var p=this.commonAncestorContainer;return p?K(this.commonAncestorContainer,!0):null}}),u(i)}function M(i){i.collapsed=i.startContainer===i.endContainer&&i.startOffset===i.endOffset,i.commonAncestorContainer=i.collapsed?i.startContainer:v.getCommonAncestor(i.startContainer,i.endContainer)}function te(i,c,m,y,b){i.startContainer=c,i.startOffset=m,i.endContainer=y,i.endOffset=b,i.document=v.getDocument(c),M(i)}function Re(i){te(this,i,0,i,0)}E(Re,te),w.extend(Re,{rangeProperties:ut,RangeIterator:le,copyComparisonConstants:u,createPrototypeRange:E,inspect:ee,toHtml:q,getRangeDocument:O,rangesEqual:function(i,c){return i.startContainer===c.startContainer&&i.startOffset===c.startOffset&&i.endContainer===c.endContainer&&i.endOffset===c.endOffset}}),l.DomRange=Re}),U.createCoreModule("WrappedRange",["DomRange"],function(l,S){var v,w,A=l.dom,_=l.util,F=A.DomPosition,me=l.DomRange,ye=A.getBody,Ee=A.getContentDocument,ue=A.isCharacterDataNode;if(l.features.implementsDomRange&&(function(){var C,Z=me.rangeProperties;function O(N){for(var P=Z.length,ee;P--;)ee=Z[P],N[ee]=N.nativeRange[ee];N.collapsed=N.startContainer===N.endContainer&&N.startOffset===N.endOffset}function ie(N,P,ee,le,Le){var ze=N.startContainer!==P||N.startOffset!=ee,be=N.endContainer!==le||N.endOffset!=Le,Ne=!N.equals(N.nativeRange);(ze||be||Ne)&&(N.setEnd(le,Le),N.setStart(P,ee))}var ge;v=function(N){if(!N)throw S.createError("WrappedRange: Range must be specified");this.nativeRange=N,O(this)},me.createPrototypeRange(v,ie),C=v.prototype,C.selectNode=function(N){this.nativeRange.selectNode(N),O(this)},C.cloneContents=function(){return this.nativeRange.cloneContents()},C.surroundContents=function(N){this.nativeRange.surroundContents(N),O(this)},C.collapse=function(N){this.nativeRange.collapse(N),O(this)},C.cloneRange=function(){return new v(this.nativeRange.cloneRange())},C.refresh=function(){O(this)},C.toString=function(){return this.nativeRange.toString()};var J=document.createTextNode("test");ye(document).appendChild(J);var z=document.createRange();z.setStart(J,0),z.setEnd(J,0);try{z.setStart(J,1),C.setStart=function(N,P){this.nativeRange.setStart(N,P),O(this)},C.setEnd=function(N,P){this.nativeRange.setEnd(N,P),O(this)},ge=function(N){return function(P){this.nativeRange[N](P),O(this)}}}catch{C.setStart=function(P,ee){try{this.nativeRange.setStart(P,ee)}catch{this.nativeRange.setEnd(P,ee),this.nativeRange.setStart(P,ee)}O(this)},C.setEnd=function(P,ee){try{this.nativeRange.setEnd(P,ee)}catch{this.nativeRange.setStart(P,ee),this.nativeRange.setEnd(P,ee)}O(this)},ge=function(P,ee){return function(le){try{this.nativeRange[P](le)}catch{this.nativeRange[ee](le),this.nativeRange[P](le)}O(this)}}}C.setStartBefore=ge("setStartBefore","setEndBefore"),C.setStartAfter=ge("setStartAfter","setEndAfter"),C.setEndBefore=ge("setEndBefore","setStartBefore"),C.setEndAfter=ge("setEndAfter","setStartAfter"),C.selectNodeContents=function(N){this.setStartAndEnd(N,0,A.getNodeLength(N))},z.selectNodeContents(J),z.setEnd(J,3);var he=document.createRange();he.selectNodeContents(J),he.setEnd(J,4),he.setStart(J,2),z.compareBoundaryPoints(z.START_TO_END,he)==-1&&z.compareBoundaryPoints(z.END_TO_START,he)==1?C.compareBoundaryPoints=function(N,P){return P=P.nativeRange||P,N==P.START_TO_END?N=P.END_TO_START:N==P.END_TO_START&&(N=P.START_TO_END),this.nativeRange.compareBoundaryPoints(N,P)}:C.compareBoundaryPoints=function(N,P){return this.nativeRange.compareBoundaryPoints(N,P.nativeRange||P)};var se=document.createElement("div");se.innerHTML="123";var re=se.firstChild,Ke=ye(document);Ke.appendChild(se),z.setStart(re,1),z.setEnd(re,2),z.deleteContents(),re.data=="13"&&(C.deleteContents=function(){this.nativeRange.deleteContents(),O(this)},C.extractContents=function(){var N=this.nativeRange.extractContents();return O(this),N}),Ke.removeChild(se),Ke=null,_.isHostMethod(z,"createContextualFragment")&&(C.createContextualFragment=function(N){return this.nativeRange.createContextualFragment(N)}),ye(document).removeChild(J),C.getName=function(){return"WrappedRange"},l.WrappedRange=v,l.createNativeRange=function(N){return N=Ee(N,S,"createNativeRange"),N.createRange()}})(),l.features.implementsTextRange){var Ue=function(C){var Z=C.parentElement(),O=C.duplicate();O.collapse(!0);var ie=O.parentElement();O=C.duplicate(),O.collapse(!1);var ge=O.parentElement(),J=ie==ge?ie:A.getCommonAncestor(ie,ge);return J==Z?J:A.getCommonAncestor(Z,J)},Oe=function(C){return C.compareEndPoints("StartToEnd",C)==0},ve=function(C,Z,O,ie,ge){var J=C.duplicate();J.collapse(O);var z=J.parentElement();if(A.isOrIsAncestorOf(Z,z)||(z=Z),!z.canHaveHTML){var he=new F(z.parentNode,A.getNodeIndex(z));return{boundaryPosition:he,nodeInfo:{nodeIndex:he.offset,containerElement:he.node}}}var se=A.getDocument(z).createElement("span");se.parentNode&&A.removeNode(se);for(var re,Ke=O?"StartToStart":"StartToEnd",N,P,ee,le,Le=ge&&ge.containerElement==z?ge.nodeIndex:0,ze=z.childNodes.length,be=ze,Ne=be;Ne==ze?z.appendChild(se):z.insertBefore(se,z.childNodes[Ne]),J.moveToElementText(se),re=J.compareEndPoints(Ke,C),!(re==0||Le==be);){if(re==-1){if(be==Le+1)break;Le=Ne}else be=be==Le+1?Le:Ne;Ne=Math.floor((Le+be)/2),z.removeChild(se)}if(le=se.nextSibling,re==-1&&le&&ue(le)){J.setEndPoint(O?"EndToStart":"EndToEnd",C);var Te;if(/[\r\n]/.test(le.data)){var ke=J.duplicate(),We=ke.text.replace(/\r\n/g,"\r").length;for(Te=ke.moveStart("character",We);(re=ke.compareEndPoints("StartToEnd",ke))==-1;)Te++,ke.moveStart("character",1)}else Te=J.text.length;ee=new F(le,Te)}else N=(ie||!O)&&se.previousSibling,P=(ie||O)&&se.nextSibling,P&&ue(P)?ee=new F(P,0):N&&ue(N)?ee=new F(N,N.data.length):ee=new F(z,A.getNodeIndex(se));return A.removeNode(se),{boundaryPosition:ee,nodeInfo:{nodeIndex:Ne,containerElement:z}}},Ie=function(C,Z){var O,ie,ge=C.offset,J=A.getDocument(C.node),z,he,se=ye(J).createTextRange(),re=ue(C.node);return re?(O=C.node,ie=O.parentNode):(he=C.node.childNodes,O=ge<he.length?he[ge]:null,ie=C.node),z=J.createElement("span"),z.innerHTML="&#feff;",O?ie.insertBefore(z,O):ie.appendChild(z),se.moveToElementText(z),se.collapse(!Z),ie.removeChild(z),re&&se[Z?"moveStart":"moveEnd"]("character",ge),se};w=function(C){this.textRange=C,this.refresh()},w.prototype=new me(document),w.prototype.refresh=function(){var C,Z,O,ie=Ue(this.textRange);Oe(this.textRange)?Z=C=ve(this.textRange,ie,!0,!0).boundaryPosition:(O=ve(this.textRange,ie,!0,!1),C=O.boundaryPosition,Z=ve(this.textRange,ie,!1,!1,O.nodeInfo).boundaryPosition),this.setStart(C.node,C.offset),this.setEnd(Z.node,Z.offset)},w.prototype.getName=function(){return"WrappedTextRange"},me.copyComparisonConstants(w);var de=function(C){if(C.collapsed)return Ie(new F(C.startContainer,C.startOffset),!0);var Z=Ie(new F(C.startContainer,C.startOffset),!0),O=Ie(new F(C.endContainer,C.endOffset),!1),ie=ye(me.getRangeDocument(C)).createTextRange();return ie.setEndPoint("StartToStart",Z),ie.setEndPoint("EndToEnd",O),ie};if(w.rangeToTextRange=de,w.prototype.toTextRange=function(){return de(this)},l.WrappedTextRange=w,!l.features.implementsDomRange||l.config.preferTextRange){var He=(function(C){return C("return this;")()})(Function);typeof He.Range>"u"&&(He.Range=w),l.createNativeRange=function(C){return C=Ee(C,S,"createNativeRange"),ye(C).createTextRange()},l.WrappedRange=w}}l.createRange=function(C){return C=Ee(C,S,"createRange"),new l.WrappedRange(l.createNativeRange(C))},l.createRangyRange=function(C){return C=Ee(C,S,"createRangyRange"),new me(C)},_.createAliasForDeprecatedMethod(l,"createIframeRange","createRange"),_.createAliasForDeprecatedMethod(l,"createIframeRangyRange","createRangyRange"),l.addShimListener(function(C){var Z=C.document;typeof Z.createRange>"u"&&(Z.createRange=function(){return l.createRange(Z)}),Z=C=null})}),U.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(l,S){l.config.checkSelectionRanges=!0;var v="boolean",w="number",A=l.dom,_=l.util,F=_.isHostMethod,me=l.DomRange,ye=l.WrappedRange,Ee=l.DOMException,ue=A.DomPosition,Ue,Oe,ve=l.features,Ie="Control",de=A.getDocument,He=A.getBody,C=me.rangesEqual;function Z(r){return typeof r=="string"?/^backward(s)?$/i.test(r):!!r}function O(r,u){if(r){if(A.isWindow(r))return r;if(r instanceof ae)return r.win;var g=A.getContentDocument(r,S,u);return A.getWindow(g)}else return window}function ie(r){return O(r,"getWinSelection").getSelection()}function ge(r){return O(r,"getDocSelection").document.selection}function J(r){var u=!1;return r.anchorNode&&(u=A.comparePoints(r.anchorNode,r.anchorOffset,r.focusNode,r.focusOffset)==1),u}var z=F(window,"getSelection"),he=_.isHostObject(document,"selection");ve.implementsWinGetSelection=z,ve.implementsDocSelection=he;var se=he&&(!z||l.config.preferTextRange);if(se)Ue=ge,l.isSelectionValid=function(r){var u=O(r,"isSelectionValid").document,g=u.selection;return g.type!="None"||de(g.createRange().parentElement())==u};else if(z)Ue=ie,l.isSelectionValid=function(){return!0};else return S.fail("Neither document.selection or window.getSelection() detected."),!1;l.getNativeSelection=Ue;var re=Ue();if(!re)return S.fail("Native selection was null (possibly issue 138?)"),!1;var Ke=l.createNativeRange(document),N=He(document),P=_.areHostProperties(re,["anchorNode","focusNode","anchorOffset","focusOffset"]);ve.selectionHasAnchorAndFocus=P;var ee=F(re,"extend");ve.selectionHasExtend=ee;var le=F(re,"setBaseAndExtent");ve.selectionHasSetBaseAndExtent=le;var Le=typeof re.rangeCount==w;ve.selectionHasRangeCount=Le;var ze=!1,be=!0,Ne=ee?function(r,u){var g=me.getRangeDocument(u),E=l.createRange(g);E.collapseToPoint(u.endContainer,u.endOffset),r.addRange(D(E)),r.extend(u.startContainer,u.startOffset)}:null;_.areHostMethods(re,["addRange","getRangeAt","removeAllRanges"])&&typeof re.rangeCount==w&&ve.implementsDomRange&&(function(){var r=window.getSelection();if(r){for(var u=r.rangeCount,g=u>1,E=[],M=J(r),te=0;te<u;++te)E[te]=r.getRangeAt(te);var Re=A.createTestElement(document,"",!1),i=Re.appendChild(document.createTextNode("   ")),c=document.createRange();if(c.setStart(i,1),c.collapse(!0),r.removeAllRanges(),r.addRange(c),be=r.rangeCount==1,r.removeAllRanges(),!g){var m=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(m&&parseInt(m[1])>=36)ze=!1;else{var y=c.cloneRange();c.setStart(i,0),y.setEnd(i,3),y.setStart(i,2),r.addRange(c),r.addRange(y),ze=r.rangeCount==2}}for(A.removeNode(Re),r.removeAllRanges(),te=0;te<u;++te)te==0&&M?Ne?Ne(r,E[te]):(l.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),r.addRange(E[te])):r.addRange(E[te])}})(),ve.selectionSupportsMultipleRanges=ze,ve.collapsedNonEditableSelectionsSupported=be;var Te=!1,ke;N&&F(N,"createControlRange")&&(ke=N.createControlRange(),_.areHostProperties(ke,["item","add"])&&(Te=!0)),ve.implementsControlRange=Te,P?Oe=function(r){return r.anchorNode===r.focusNode&&r.anchorOffset===r.focusOffset}:Oe=function(r){return r.rangeCount?r.getRangeAt(r.rangeCount-1).collapsed:!1};function We(r,u,g){var E=g?"end":"start",M=g?"start":"end";r.anchorNode=u[E+"Container"],r.anchorOffset=u[E+"Offset"],r.focusNode=u[M+"Container"],r.focusOffset=u[M+"Offset"]}function f(r){var u=r.nativeSelection;r.anchorNode=u.anchorNode,r.anchorOffset=u.anchorOffset,r.focusNode=u.focusNode,r.focusOffset=u.focusOffset}function L(r){r.anchorNode=r.focusNode=null,r.anchorOffset=r.focusOffset=0,r.rangeCount=0,r.isCollapsed=!0,r._ranges.length=0,K(r)}function K(r){r.type=r.rangeCount==0?"None":Oe(r)?"Caret":"Range"}function D(r){var u;return r instanceof me?(u=l.createNativeRange(r.getDocument()),u.setEnd(r.endContainer,r.endOffset),u.setStart(r.startContainer,r.startOffset)):r instanceof ye?u=r.nativeRange:ve.implementsDomRange&&r instanceof A.getWindow(r.startContainer).Range&&(u=r),u}function pe(r){if(!r.length||r[0].nodeType!=1)return!1;for(var u=1,g=r.length;u<g;++u)if(!A.isAncestorOf(r[0],r[u]))return!1;return!0}function oe(r){var u=r.getNodes();if(!pe(u))throw S.createError("getSingleElementFromRange: range "+r.inspect()+" did not consist of a single element");return u[0]}function Ze(r){return!!r&&typeof r.text<"u"}function qe(r,u){var g=new ye(u);r._ranges=[g],We(r,g,!1),r.rangeCount=1,r.isCollapsed=g.collapsed,K(r)}function De(r){if(r._ranges.length=0,r.docSelection.type=="None")L(r);else{var u=r.docSelection.createRange();if(Ze(u))qe(r,u);else{r.rangeCount=u.length;for(var g,E=de(u.item(0)),M=0;M<r.rangeCount;++M)g=l.createRange(E),g.selectNode(u.item(M)),r._ranges.push(g);r.isCollapsed=r.rangeCount==1&&r._ranges[0].collapsed,We(r,r._ranges[r.rangeCount-1],!1),K(r)}}}function mt(r,u){for(var g=r.docSelection.createRange(),E=oe(u),M=de(g.item(0)),te=He(M).createControlRange(),Re=0,i=g.length;Re<i;++Re)te.add(g.item(Re));try{te.add(E)}catch{throw S.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}te.select(),De(r)}var rt;F(re,"getRangeAt")?rt=function(r,u){try{return r.getRangeAt(u)}catch{return null}}:P&&(rt=function(r){var u=de(r.anchorNode),g=l.createRange(u);return g.setStartAndEnd(r.anchorNode,r.anchorOffset,r.focusNode,r.focusOffset),g.collapsed!==this.isCollapsed&&g.setStartAndEnd(r.focusNode,r.focusOffset,r.anchorNode,r.anchorOffset),g});function ae(r,u,g){this.nativeSelection=r,this.docSelection=u,this._ranges=[],this.win=g,this.refresh()}ae.prototype=l.selectionPrototype;function gt(r){r.win=r.anchorNode=r.focusNode=r._ranges=null,r.rangeCount=r.anchorOffset=r.focusOffset=0,r.detached=!0,K(r)}var Je=[];function vt(r,u){for(var g=Je.length,E,M;g--;)if(E=Je[g],M=E.selection,u=="deleteAll")gt(M);else if(E.win==r)return u=="delete"?(Je.splice(g,1),!0):M;return u=="deleteAll"&&(Je.length=0),null}var ct=function(r){if(r&&r instanceof ae)return r.refresh(),r;r=O(r,"getNativeSelection");var u=vt(r),g=Ue(r),E=he?ge(r):null;return u?(u.nativeSelection=g,u.docSelection=E,u.refresh()):(u=new ae(g,E,r),Je.push({win:r,selection:u})),u};l.getSelection=ct,_.createAliasForDeprecatedMethod(l,"getIframeSelection","getSelection");var q=ae.prototype;function ut(r,u){for(var g=de(u[0].startContainer),E=He(g).createControlRange(),M=0,te,Re=u.length;M<Re;++M){te=oe(u[M]);try{E.add(te)}catch{throw S.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}E.select(),De(r)}if(!se&&P&&_.areHostMethods(re,["removeAllRanges","addRange"])){q.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),L(this)};var lt=function(r,u){Ne(r.nativeSelection,u),r.refresh()};Le?q.addRange=function(r,u){if(Te&&he&&this.docSelection.type==Ie)mt(this,r);else if(Z(u)&&ee)lt(this,r);else{var g;ze?g=this.rangeCount:(this.removeAllRanges(),g=0);var E=D(r).cloneRange();try{this.nativeSelection.addRange(E)}catch{}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==g+1){if(l.config.checkSelectionRanges){var M=rt(this.nativeSelection,this.rangeCount-1);M&&!C(M,r)&&(r=new ye(M))}this._ranges[this.rangeCount-1]=r,We(this,r,et(this.nativeSelection)),this.isCollapsed=Oe(this),K(this)}else this.refresh()}}:q.addRange=function(r,u){Z(u)&&ee?lt(this,r):(this.nativeSelection.addRange(D(r)),this.refresh())},q.setRanges=function(r){if(Te&&he&&r.length>1)ut(this,r);else{this.removeAllRanges();for(var u=0,g=r.length;u<g;++u)this.addRange(r[u])}}}else if(F(re,"empty")&&F(Ke,"select")&&Te&&se)q.removeAllRanges=function(){try{if(this.docSelection.empty(),this.docSelection.type!="None"){var r;if(this.anchorNode)r=de(this.anchorNode);else if(this.docSelection.type==Ie){var u=this.docSelection.createRange();u.length&&(r=de(u.item(0)))}if(r){var g=He(r).createTextRange();g.select(),this.docSelection.empty()}}}catch{}L(this)},q.addRange=function(r){this.docSelection.type==Ie?mt(this,r):(l.WrappedTextRange.rangeToTextRange(r).select(),this._ranges[0]=r,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,We(this,r,!1),K(this))},q.setRanges=function(r){this.removeAllRanges();var u=r.length;u>1?ut(this,r):u&&this.addRange(r[0])};else return S.fail("No means of selecting a Range or TextRange was found"),!1;q.getRangeAt=function(r){if(r<0||r>=this.rangeCount)throw new Ee("INDEX_SIZE_ERR");return this._ranges[r].cloneRange()};var it;if(se)it=function(r){var u;l.isSelectionValid(r.win)?u=r.docSelection.createRange():(u=He(r.win.document).createTextRange(),u.collapse(!0)),r.docSelection.type==Ie?De(r):Ze(u)?qe(r,u):L(r)};else if(F(re,"getRangeAt")&&typeof re.rangeCount==w)it=function(r){if(Te&&he&&r.docSelection.type==Ie)De(r);else if(r._ranges.length=r.rangeCount=r.nativeSelection.rangeCount,r.rangeCount){for(var u=0,g=r.rangeCount;u<g;++u)r._ranges[u]=new l.WrappedRange(r.nativeSelection.getRangeAt(u));We(r,r._ranges[r.rangeCount-1],et(r.nativeSelection)),r.isCollapsed=Oe(r),K(r)}else L(r)};else if(P&&typeof re.isCollapsed==v&&typeof Ke.collapsed==v&&ve.implementsDomRange)it=function(r){var u,g=r.nativeSelection;g.anchorNode?(u=rt(g,0),r._ranges=[u],r.rangeCount=1,f(r),r.isCollapsed=Oe(r),K(r)):L(r)};else return S.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;q.refresh=function(r){var u=r?this._ranges.slice(0):null,g=this.anchorNode,E=this.anchorOffset;if(it(this),r){var M=u.length;if(M!=this._ranges.length||this.anchorNode!=g||this.anchorOffset!=E)return!0;for(;M--;)if(!C(u[M],this._ranges[M]))return!0;return!1}};var At=function(r,u){var g=r.getAllRanges();r.removeAllRanges();for(var E=0,M=g.length;E<M;++E)C(u,g[E])||r.addRange(g[E]);r.rangeCount||L(r)};Te&&he?q.removeRange=function(r){if(this.docSelection.type==Ie){for(var u=this.docSelection.createRange(),g=oe(r),E=de(u.item(0)),M=He(E).createControlRange(),te,Re=!1,i=0,c=u.length;i<c;++i)te=u.item(i),te!==g||Re?M.add(u.item(i)):Re=!0;M.select(),De(this)}else At(this,r)}:q.removeRange=function(r){At(this,r)};var et;!se&&P&&ve.implementsDomRange?(et=J,q.isBackward=function(){return et(this)}):et=q.isBackward=function(){return!1},q.isBackwards=q.isBackward,q.toString=function(){for(var r=[],u=0,g=this.rangeCount;u<g;++u)r[u]=""+this._ranges[u];return r.join("")};function st(r,u){if(r.win.document!=de(u))throw new Ee("WRONG_DOCUMENT_ERR")}function pt(r,u){if(u<0||u>(A.isCharacterDataNode(r)?r.length:r.childNodes.length))throw new Ee("INDEX_SIZE_ERR")}q.collapse=function(r,u){st(this,r);var g=l.createRange(r);g.collapseToPoint(r,u),this.setSingleRange(g),this.isCollapsed=!0},q.collapseToStart=function(){if(this.rangeCount){var r=this._ranges[0];this.collapse(r.startContainer,r.startOffset)}else throw new Ee("INVALID_STATE_ERR")},q.collapseToEnd=function(){if(this.rangeCount){var r=this._ranges[this.rangeCount-1];this.collapse(r.endContainer,r.endOffset)}else throw new Ee("INVALID_STATE_ERR")},q.selectAllChildren=function(r){st(this,r);var u=l.createRange(r);u.selectNodeContents(r),this.setSingleRange(u)},le?q.setBaseAndExtent=function(r,u,g,E){this.nativeSelection.setBaseAndExtent(r,u,g,E),this.refresh()}:ee&&(q.setBaseAndExtent=function(r,u,g,E){pt(r,u),pt(g,E),st(this,r),st(this,g);var M=l.createRange(node),te=A.comparePoints(r,u,g,E)==-1;te?M.setStartAndEnd(g,E,r,u):M.setStartAndEnd(r,u,g,E),this.setSingleRange(M,te)}),q.deleteFromDocument=function(){if(Te&&he&&this.docSelection.type==Ie){for(var r=this.docSelection.createRange(),u;r.length;)u=r.item(0),r.remove(u),A.removeNode(u);this.refresh()}else if(this.rangeCount){var g=this.getAllRanges();if(g.length){this.removeAllRanges();for(var E=0,M=g.length;E<M;++E)g[E].deleteContents();this.addRange(g[M-1])}}},q.eachRange=function(r,u){for(var g=0,E=this._ranges.length;g<E;++g)if(r(this.getRangeAt(g)))return u},q.getAllRanges=function(){var r=[];return this.eachRange(function(u){r.push(u)}),r},q.setSingleRange=function(r,u){this.removeAllRanges(),this.addRange(r,u)},q.callMethodOnEachRange=function(r,u){var g=[];return this.eachRange(function(E){g.push(E[r].apply(E,u||[]))}),g};function St(r){return function(u,g){var E;this.rangeCount?(E=this.getRangeAt(0),E["set"+(r?"Start":"End")](u,g)):(E=l.createRange(this.win.document),E.setStartAndEnd(u,g)),this.setSingleRange(E,this.isBackward())}}q.setStart=St(!0),q.setEnd=St(!1),l.rangePrototype.select=function(r){ct(this.getDocument()).setSingleRange(this,r)},q.changeEachRange=function(r){var u=[],g=this.isBackward();this.eachRange(function(E){r(E),u.push(E)}),this.removeAllRanges(),g&&u.length==1?this.addRange(u[0],"backward"):this.setRanges(u)},q.containsNode=function(r,u){return this.eachRange(function(g){return g.containsNode(r,u)},!0)||!1},q.getBookmark=function(r){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[r])}},q.moveToBookmark=function(r){for(var u=[],g=0,E,M;E=r.rangeBookmarks[g++];)M=l.createRange(this.win),M.moveToBookmark(E),u.push(M);r.backward?this.setSingleRange(u[0],"backward"):this.setRanges(u)},q.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},q.restoreRanges=function(r){this.removeAllRanges();for(var u=0,g;g=r.ranges[u];++u)this.addRange(g,r.backward&&u==0)},q.toHtml=function(){var r=[];return this.eachRange(function(u){r.push(me.toHtml(u))}),r.join("")},ve.implementsTextRange&&(q.getNativeTextRange=function(){var r;if(r=this.docSelection){var u=r.createRange();if(Ze(u))return u;throw S.createError("getNativeTextRange: selection is a control selection")}else{if(this.rangeCount>0)return l.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw S.createError("getNativeTextRange: selection contains no range")}});function dt(r){var u=[],g=new ue(r.anchorNode,r.anchorOffset),E=new ue(r.focusNode,r.focusOffset),M=typeof r.getName=="function"?r.getName():"Selection";if(typeof r.rangeCount<"u")for(var te=0,Re=r.rangeCount;te<Re;++te)u[te]=me.inspect(r.getRangeAt(te));return"["+M+"(Ranges: "+u.join(", ")+")(anchor: "+g.inspect()+", focus: "+E.inspect()+"]"}q.getName=function(){return"WrappedSelection"},q.inspect=function(){return dt(this)},q.detach=function(){vt(this.win,"delete"),gt(this)},ae.detachAll=function(){vt(null,"deleteAll")},ae.inspect=dt,ae.isDirectionBackward=Z,l.Selection=ae,l.selectionPrototype=q,l.addShimListener(function(r){typeof r.getSelection>"u"&&(r.getSelection=function(){return ct(r)}),r=null})});var vn=!1,Kt=function(l){vn||(vn=!0,!U.initialized&&U.config.autoInitialize&&Mt())};return xe&&(document.readyState=="complete"?Kt():(R(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",Kt,!1),$e(window,"load",Kt))),U})})(Zt)),Zt.exports}var Nr=Er();const Xt=Qn(Nr),{createRangyRange:Hr}=Xt;class en{static getSelection(){return getSelection()}static getSingleRange(){const e=document.getSelection();if(!e)return;if(e.rangeCount>1)throw new Error("unsupported");return e.getRangeAt(0)}static createRange(e,t){const n=Xt.createRangyRange();return n.setStart(e,t.col),n.setEnd(e,t.col),n}static setSingleRange(e){Xt.getSelection().setRanges([e])}static getOffsetFromTextarea(e){return e.selectionStart}static getCursorFromSelection(e){const t=document.getSelection();if(t)for(let n=0;n<t.rangeCount;n++){const s=t.getRangeAt(n),o=s.startOffset,d=this.getLineIndex(e,s.startContainer);return d==null?void 0:{col:o,line:d}}}static getLineIndex(e,t){const n=t.parentElement;if(!n)return;const s=Array.from(n.classList);if(!s.length)return;const o=`.${s.join(".")}`;try{return Array.from(e.querySelectorAll(o)).indexOf(n)}catch{}}}const Ae=new nt("VimUi");class Tr{constructor(e,t){k(this,"mode");k(this,"container");k(this,"inputElement");k(this,"caret");k(this,"childSelector");k(this,"caretWidth");k(this,"caretHeight");k(this,"_currentLineNumber",0);k(this,"querySelectorService");k(this,"currentCaretCol",0);k(this,"scrollEditor",(e,t)=>{const n=this.caret;if(!n)return;const s=this.container;if(!s)return;const o=s.getBoundingClientRect(),d=n.getBoundingClientRect(),h=this.caretHeight,x=d.width,R=d.top,V=d.left,$=d.bottom,H=d.right,W=40,ne=o.bottom-W,ce=$>ne,G=o.top+W,Be=R<G,we=o.right-W,Ce=H>we,xe=o.left+W,Se=V<xe,U=t*h,Fe=t*x;switch(e){case"up":Be&&(s.scrollTop-=U);break;case"down":ce&&(s.scrollTop+=U);break;case"left":Se&&(s.scrollLeft-=Fe);break;case"right":Ce&&(s.scrollLeft+=Fe);break}});this.vimState=e,this.options=t,t?(this.container=t.container,this.inputElement=t.inputElement,this.caret=t.caret,this.childSelector=t.childSelector,this.querySelectorService=new Wt(this.container,this.childSelector)):Ae.culogger.debug(["[VimUi.ts,69] no options. This means, no insert mode available"],{logLevel:"WARNING"}),this.caretWidth=yn("--caret-size-width"),this.caretHeight=yn("--height-of-line"),this.caret||this.createCaret(),this.container&&this.update(e)}get currentLineNumber(){return this._currentLineNumber}set currentLineNumber(e){this._currentLineNumber=e}createCaret(){}update(e){e&&this.setCursorMovement(e.cursor)}updateV2(e){e&&this.setCursorMovement(e.cursor)}setCursorMovement(e){if(!this.caret)return;let t,n;e?(t=e.line,n=e.col):(t=this.currentLineNumber,n=this.currentCaretCol),this.commenKeyFunctionality();const s=this.getCurrentLineElement(0);if(!s)return;const o=s.offsetLeft||Ln,d=s.offsetTop||Ln/2;let h="none";this.currentLineNumber>t?h="up":this.currentLineNumber<t&&(h="down"),this.currentLineNumber,Math.abs(this.currentLineNumber-t),h==="down"&&(t=Ir(this.vimState.foldMap,this.vimState.cursor,Math.abs(t))),this.currentCaretCol>n,this.currentCaretCol,Math.abs(this.currentCaretCol-n),this.currentLineNumber=t,this.currentCaretCol=n;const x=t*this.caretHeight;this.caret.style.top=`${d+x}px`;const R=n*this.caretWidth;this.caret.style.left=`${o+R}px`}getLineRectOffsetLeft(){if(!this.childSelector)return;const e=this.querySelectorService.getInputContainerChildren();if(!e)return;const t=e[this.currentLineNumber];let n=0;return t!=null&&(n=t.offsetLeft),n}getCurrentLineElement(e=this.currentLineNumber){if(!this.childSelector)return;const t=this.querySelectorService.getInputContainerChildren();return t?t[e]:void 0}commenKeyFunctionality(){this.resetCaretBlinking()}resetCaretBlinking(){this.caret&&(this.caret.classList.remove("caret-blinking"),this.caret.offsetWidth,this.caret.classList.add("caret-blinking"))}enterInsertMode(e){window.setTimeout(()=>{this.focusContainer(),window.setTimeout(()=>{this.setCursorInInsert(e)},660)},660)}enterInsertModeV2(e){window.setTimeout(()=>{this.focusContainer(),this.setCursorInInsertV2(e)},66)}setCursorInInsertV2(e){var n;if(typeof e=="number"){(n=this.inputElement)==null||n.setSelectionRange(e,e);return}const t=e;if(this.inputElement){const s=(t==null?void 0:t.col)??0;this.inputElement.setSelectionRange(s,s);return}this.setCursorInInsert(t)}setCursorInInsert(e){if(!e)return;const t=this.querySelectorService.getInputContainerChildren();if(!t)return;const n=t[e.line];if(!n)return;const{textNode:s,newCursor:o}=ur(n,e);try{const d=en.createRange(s,o);console.log("[VimUi.ts,284] range: ",d),en.setSingleRange(d)}catch{}}focusContainer(){var e;if(this.inputElement){this.inputElement.focus();return}(e=this.container)==null||e.focus(),Ae.shouldLog(36)&&console.log("this.vimState",this.vimState),Ae.shouldLog(36)&&console.log("this.container",this.container)}getTextFromHtml(){Ae.shouldLog([,1])&&console.log("[VimUi.ts,329] getTextFromHtml: ");const e=this.querySelectorService.getInputContainerChildrenText(),t=[];return e==null||e.forEach(n=>{Ae.shouldLog([,1])&&console.log("-------------------------------------------------------------------");const{childNodes:s}=n;if(Ae.shouldLog([,1])&&console.log("[VimUi.ts,335] childNodes: ",s),!s)return;const[o,d,h,...x]=s;x.length&&console.error("More than 3 child nodes, check out the logic: ",x);const R=Bt.isTextNode(o);Ae.shouldLog([,1])&&console.log("[VimUi.ts,351] firstIsText: ",R);const V=Bt.isBr(d);Ae.shouldLog([,1])&&console.log("[VimUi.ts,353] secondIsBr: ",V);const $=Bt.isTextNode(h)&&h.nodeValue==="";Ae.shouldLog([,1])&&console.log("[VimUi.ts,355] thirdIsEmpty: ",$);const H=s.length===1&&R,W=s.length===2&&R&&V,ne=H&&W&&$;if(ne){if(Ae.shouldLog([,1])&&console.log("[VimUi.ts,344] simpleCase: ",ne),!n.textContent)return;t.push({text:n.textContent});return}const G=s.length>2&&!$;if(G){const we=wr(n);Ae.shouldLog([,1])&&console.log("[VimUi.ts,355] child: ",n),Ae.shouldLog([,1])&&console.log("[VimUi.ts,355] textNodes: ",we);const Ce=[];we.forEach(Se=>{var Fe;if(Se.normalize,!((Fe=Se.nodeValue)!=null&&Fe.trim()))return;Ae.shouldLog([,1])&&console.log("[VimUi.ts,354] isTextOnlyMultiLinePaste: ",G);const U=Se.nodeValue;Ae.shouldLog([,1])&&console.log("[VimUi.ts,369] text: ",U),Ce.push({text:U})});const xe=Ce.map(Se=>Se.text).join("");Ae.shouldLog([,1])&&console.log("[VimUi.ts,374] joined: ",xe),t.push({text:xe});return}const Be=Bt.isTag(o,"div");if(Be){Array.from(o.children).forEach(Ce=>{Ce.textContent&&(Ae.shouldLog([,1])&&console.log("[VimUi.ts,366] firstIsDiv: ",Be),t.push({text:Ce.textContent}))});return}n.textContent&&t.push({text:n.textContent})}),t}removeHtmlGeneratedNewLines(){const e=this.querySelectorService.getInputContainerChildren();e&&e.forEach(t=>{!!t.querySelector("br")&&t.remove()})}}function wr(a){const e=document.createNodeIterator(a,NodeFilter.SHOW_TEXT);let t;const n=[];for(;t=e.nextNode();)n.push(t);return n}function Ir(a,e,t){if(!a||!e)return t;console.log(">>>> _ >>>> ~ file: VimUi.ts:459 ~ foldMap:",a),console.log(">>>> _ >>>> ~ file: VimUi.ts:459 ~ unadjustedNewCusorLine:",t);let n=0,s=t;for(;a[s]===!0&&n<20;)s-=1,n++;return console.log(">>>> _ >>>> ~ file: VimUi.ts:474 ~ adjusted:",s),s}const kr="onTopicChange",Vn=wt.createInterface("IStore");class un{constructor(e){k(this,"isDrawerOpen");k(this,"isCommandPaletteOpen");k(this,"isZen");k(this,"activeTabName");k(this,"wordToLookUp");k(this,"dictionaryLookedUpList");k(this,"servicesDatabase",{RecentlyUsedService:{}});k(this,"audioTime",0);k(this,"audioTimeStart",0);k(this,"audioTimeEnd",0);k(this,"activeSheet");k(this,"onTopicChange",e=>{var t;(t=this.ea)==null||t.publish(kr,e)});k(this,"toggleZenMode",()=>{this.isZen=!this.isZen,this.updateLocalStorage()});k(this,"closeCommandPalette",()=>{this.isCommandPaletteOpen=!1,this.updateLocalStorage()});k(this,"toggleCommandPaletteOpen",()=>{this.isCommandPaletteOpen=!this.isCommandPaletteOpen,this.updateLocalStorage()});this.ea=e,this.setVariables()}static register(e){It.singleton(Vn,un).register(e)}setServiceItem(e,t){this.servicesDatabase[e]=t}getServiceItem(e){return this.servicesDatabase[e]}setVariables(){const e=this.loadLocalStorage();this.isDrawerOpen=(e==null?void 0:e.isDrawerOpen)??Rn.typing.tabs.isDrawerOpen,this.isZen=(e==null?void 0:e.isZen)??Rn.zen,this.activeTabName=(e==null?void 0:e.activeTabName)??Kn,this.wordToLookUp=(e==null?void 0:e.wordToLookUp)??zn,this.dictionaryLookedUpList=(e==null?void 0:e.dictionaryLookedUpList)??new Set,this.servicesDatabase=(e==null?void 0:e.servicesDatabase)??this.servicesDatabase,this.audioTime=(e==null?void 0:e.audioTime)??0,this.audioTimeStart=(e==null?void 0:e.audioTimeStart)??0,this.audioTimeEnd=(e==null?void 0:e.audioTimeEnd)??0}loadLocalStorage(){const e=localStorage.getItem(xn.APP_STATE);return JSON.parse(e??"{}")}updateLocalStorage(){localStorage.setItem(xn.APP_STATE,JSON.stringify(this))}}Object.defineProperty(un,"inject",{get(){return[qn]},configurable:!0});const Hn=wt.createInterface("RecentlyUsedService");class ln{constructor(e,t){k(this,"commands",[]);this.store=e,this.commandsService=t;const n=this.store.getServiceItem("RecentlyUsedService");Array.isArray(n)&&(n.forEach(s=>{s.item.id=rn(s.item)}),this.commands=n)}static register(e){It.singleton(Hn,ln).register(e)}getLastCommand(e){const t=this.commands[0].item;console.log("[RecentlyUsedService.ts,33] last: ",t);const n=this.commandsService.getCommand(e,t);return n?{lastUsed:new Date().toISOString(),item:n}:void 0}getCommands(){return this.commands}isPresent(e){return this.commands.some(n=>n.item.id===e.id)}addCommand(e){if(this.isPresent(e))return;const t={lastUsed:new Date().toISOString(),item:e};this.commands.unshift(t),this.save()}clearCommands(){this.commands=[]}save(){this.store.setServiceItem("RecentlyUsedService",this.commands)}}Object.defineProperty(ln,"inject",{get(){return[Vn,nn]},configurable:!0});const Ye=new nt("VimInputHandlerV2"),On=wt.createInterface("VimInputHandlerV2"),_t=class _t{constructor(e,t,n){k(this,"idHistory",[]);k(this,"instancesMap",{});k(this,"vimUi");this.keyMappingService=e,this.commandsService=t,this.recentlyUsedService=n}get activeId(){return this.idHistory[this.idHistory.length-1]}get vimCore(){return this.getVimCore(this.activeId)}static register(e){It.singleton(On,_t).register(e);const t=e.get(On);t.initEventHandlersV2(),window.v=t}getInstanceMap(e){return this.instancesMap[e]}getVimCore(e){return this.instancesMap[e].vimCore}setVimCore(e,t){this.instancesMap[e].vimCore=t}registerAndInit(e){var s;const t=e.vimId??((s=e.vimState)==null?void 0:s.id)??"";Ye.shouldLog([])&&console.log("id",t),t!==Vt.global&&this.pushIdToHistory(t);const n=this.initVimCore(e);this.instancesMap[t]={options:e,vimCore:n}}setActiveId(e){Ye.shouldLog([5])&&console.log("[VimInputHandlerV2.ts,52] id: ",e),this.pushIdToHistory(e),Ye.shouldLog([5])&&console.log("[VimInputHandlerV2.ts,55] this.idHistory: ",this.idHistory)}popId(){this.idHistory.length!==0&&this.idHistory.pop()}popIdIf(e){this.idHistory[this.idHistory.length-1]===e&&this.popId()}popIdIfContains(e){const t=this.idHistory.reverse().findIndex(s=>s===e);if(t!=null)return;const n=this.idHistory.length-1-t;this.idHistory.slice(n,0)}moveIdToLatest(e){const t=this.idHistory.reverse().findIndex(o=>o===e);if(t==null)return;const n=this.idHistory.length-1-t,s=this.idHistory.splice(n,1)[0];this.idHistory.push(s)}executeCommandSequence(e){this.vimCore.executeCommandSequence(e)}executeCommand(e,t){return this.vimCore.executeCommand(e,t)}reload(e){this.updateVimState(e),this.vimCore.setVimState(e)}pushIdToHistory(e){this.idHistory[this.idHistory.length-1]!==e&&this.idHistory.push(e)}initVimCore(e){var s;const t=this.keyMappingService.keyBindings,n=cn.create({keyBindings:t,...e,hooks:{...e==null?void 0:e.hooks,modeChanged:(...o)=>{var x;const{vimState:d}=o[0],h=d;if(h&&h.mode&&Nt.hasModeChanged(this.vimCore.getVimState().mode,d.mode)){if(Nt.switchModes(h.mode,{insert:()=>{this.vimUi.enterInsertMode(h.cursor)},normal:()=>{if(!(e!=null&&e.container))return;const R=en.getCursorFromSelection(e.container);R&&(R.line!==-1&&(h.cursor=R),e.container.blur())}}),(x=e==null?void 0:e.hooks)!=null&&x.modeChanged){const R=o;R[0].vimState=h,e.hooks.modeChanged(...R)}this.vimCore.setVimState(h),this.vimUi.update(h)}}}});return n.init(),this.vimUi=new Tr(n.getVimState(),e),(s=e==null?void 0:e.hooks)!=null&&s.afterInit&&e.hooks.afterInit(n),n}initEventHandlersV2(){document.addEventListener("keydown",async e=>{const t=this.getInstanceMap(this.activeId);if(!t)return;const n=this.getKeyData(e);Ye.shouldLog([,,3])&&console.log("keyData",n);const s=t.options,{targetCommand:o,potentialCommands:d}=this.getCommand(n,s)??{},x=t.vimCore.getVimState().mode===T.INSERT;(d==null?void 0:d.length)&&!x&&e.preventDefault(),Ye.shouldLog([,,3])&&console.log("command",o);const{vimState:V,preventDefault:$}=await this.executeCommandForListener(o,n,s);$&&e.preventDefault();const H=Q[(o==null?void 0:o.command)??"nothing"];Ye.shouldLog([,,3])&&console.log("commandName",H);let W=V==null?void 0:V.mode;W||(W=t.vimCore.getVimState().mode),Nt.switchModes(W,{insert:()=>{var ne;H&&$&&e.preventDefault(),(ne=s==null?void 0:s.hooks)!=null&&ne.onInsertInput&&s.hooks.onInsertInput(V,null,n.composite)===!0&&e.preventDefault()},normal:()=>{if(n.key===Tt&&e.preventDefault(),H){if(!$)return;e.preventDefault()}},visual:()=>{if(n.key===Tt&&e.preventDefault(),H){if(!$)return;e.preventDefault()}}})})}getKeyData(e){const{collectedModifiers:t}=tt.assembleModifiers(e),n=tt.getPressedKey(e);return{key:n,modifiers:t,composite:`${t.join("")}${n}`}}getCommand(e,t){var W;const n=t.vimId;if(!n)throw new Error("No context provided");const s=this.commandsService.commandsRepository[n];t.keyBindings=s;const o=this.vimCore.getVimState().mode,d=this.keyMappingService.prepareCommandV2(e.composite,o,t);let{targetCommand:h,potentialCommands:x}=d??{};Ye.shouldLog([3,,3])&&console.log("finalCommand",h),e.key;const R=this.keyMappingService.queuedKeys.length;if(!h&&!R){const ne=this.commandsService.commandsRepository[Vt.global];t!=null&&t.keyBindings&&(t.keyBindings=ne);const ce=this.keyMappingService.prepareCommandV2(e.composite,o,t);ce&&(h=ce.targetCommand,x=ce.potentialCommands)}if(!h&&!R){const ne=this.commandsService.commandsRepository[Vt.default];t.keyBindings=ne;const ce=this.keyMappingService.prepareCommandV2(e.composite,o,t);ce&&(h=ce.targetCommand,x=ce.potentialCommands)}const V=Q[(h==null?void 0:h.command)??"nothing"];return Ye.shouldLog([,,3])&&console.log("commandName",V),V===Q.repeatLastCommand?(h=this.keyMappingService.getLastCommand(),this.keyMappingService.getLastKey()):V===Q.repeatLastCommandPaletteCommand&&(h=this.keyMappingService.getLastCommandPaletteCommand(),h||(h=(W=this.recentlyUsedService.getLastCommand(n))==null?void 0:W.item),this.keyMappingService.getLastKey()),Ye.shouldLog([,,2])&&console.log("[] Repeating"),V!==Q.repeatLastCommand&&!Nt.isModeChangingCommand(V)&&(this.keyMappingService.setLastKey(e.composite),h&&this.keyMappingService.setLastCommand(h)),{targetCommand:h,potentialCommands:x??[]}}async executeCommandForListener(e,t,n){var $,H;Ye.shouldLog([,,2])&&console.log("[] Start of command execution");let s=!1,o;const d=this.vimCore.getVimState().mode,h=t.key,x=t.composite,R=e==null?void 0:e.sequence,V=d!==T.INSERT&&!ar(h);if(e!=null&&e.execute){const W=await e.execute(d,o,this.vimCore);typeof W=="boolean"&&(s=W)}else R?(o=this.vimCore.executeCommandSequence(R),o&&(this.updateVimState(o),($=n==null?void 0:n.hooks)!=null&&$.commandListener&&V&&n.hooks.commandListener({vimState:o,targetCommand:Q[(e==null?void 0:e.command)??"nothing"],targetCommandFull:e,keys:x}))):e!=null&&e.command&&(o=this.vimCore.executeCommand(Q[e.command],h),Ye.shouldLog([])&&console.log("(vimState)",o),o&&(this.updateVimState(o),(H=n==null?void 0:n.hooks)!=null&&H.commandListener&&V&&n.hooks.commandListener({vimState:o,targetCommand:Q[e.command],targetCommandFull:e,keys:x})));if(Ye.shouldLog([,,2])&&console.log("[] After command execution"),e!=null&&e.afterExecute){const W=this.vimCore.getVimState(),ne=await(e==null?void 0:e.afterExecute(d,W,this.vimCore));typeof ne=="boolean"&&(s=ne)}return{vimState:o,preventDefault:s}}updateVimState(e){this.vimUi.update(e)}debugLogMappings(e){e&&Object.entries(e).forEach(([,t])=>{})}};k(_t,"inject",[Ht,nn,Hn]);let bn=_t;export{sn as C,On as I,on as K,ln as R,un as S,T as V,bn as a,cn as b,Q as c,nn as d,Vr as g};
