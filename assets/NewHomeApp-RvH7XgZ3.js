import{j as t,r as x}from"./react-vendor-Byz07MLO.js";import{a as O}from"./ui-utils-BxIQ3qGg.js";import{a as w,aw as W,aJ as y,a2 as Y,b6 as E,b7 as H,b8 as z,b9 as L,ar as G,as as J,at as K,a7 as q,L as Q,ba as Z,bb as ee,aX as te,bc as se}from"./index-hTFRJyrx.js";import{t as T}from"./utils-G1l1U0hd.js";import{bf as oe,r as ae,D as ne,C as re,e as ie,b2 as le,O as ce,V as de}from"./icons-yhbeTEay.js";import{T as pe}from"./textarea-ZFIB_HyS.js";import{c as ue,s as he,u as k,E as U,C as me}from"./CanvasAppV2-B2VtvxhC.js";import{M as ge}from"./MobileLogViewer-CntKY_OW.js";import"./radix-ui-9f16WUVy.js";import"./VimInputHandlerV2-CJwq8Ehj.js";import"./logging-CYRX986s.js";import"./string-4WCj7OpV.js";import"./clipboardHtmlToMarkdown-km7b-PJ7.js";import"./UiButtonWithExpandOption-CPX53qLO.js";import"./TextareaPopoverAtCursor-DB-dMS5D.js";import"./cursorPosition-otMhJ5rZ.js";import"./definitionHelper-CZKT8hW2.js";import"./DraggableCrudTree-BWkC8K4c.js";import"./DragDropManager-CacIWg_Z.js";import"./treeHelpers-DUv_6quS.js";import"./globalFacadeRegistry-BlelMPVg.js";import"./WorkflowRowItem-D-fkRf8u.js";import"./UiDataTable-Dfde_OFA.js";import"./react-hooks-CNdHs55p.js";import"./SessionSidebar-CSfwOUNw.js";import"./tree-CNsSXVP0.js";import"./markdownToHtml-C-4HvgxL.js";import"./DraggableTree-h_RnWs_o.js";import"./useOcr-7vtWixZN.js";import"./alert-BYqYRHel.js";import"./JsonViewerApp-BHZpouoC.js";import"./context-menu-VDENXG3G.js";import"./easy-form-gMDj6oBZ.js";import"./forms-B7OAPNGv.js";import"./form-4XCOk2xb.js";import"./SlashCommandMenu-bphscUeq.js";const fe=({variant:e="ghost",size:n="icon",className:a,iconClassName:o="h-5 w-5",showTooltip:s=!0})=>{const r=()=>{W.toggle();const i=W.getState();T.success(`Element Inspector ${i?"activated":"deactivated"}`,{description:i?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};return t.jsx(w,{variant:e,size:n,onClick:r,className:a,title:s?"Toggle Element Inspector (Ctrl+Shift+I)":void 0,"aria-label":"Toggle Element Inspector","data-test":"element-inspector-button",children:t.jsx(oe,{className:o})})},xe=1,D="cs:",_={[y.RECT]:0,[y.TEXT]:1,[y.TEXTCARD]:2,[y.DRAWING]:3},ye={0:y.RECT,1:y.TEXT,2:y.TEXTCARD,3:y.DRAWING},P=e=>e.slice(0,8),ve=e=>{if(typeof e=="string")return e;if(typeof e=="number")return String(e);e!=null},Se=e=>{const n=_[e.type];if(n===void 0)return null;const a={i:P(e.id),x:Math.round(e.x),y:Math.round(e.y),t:n};e.width&&(a.w=Math.round(e.width)),e.height&&(a.h=Math.round(e.height));const o=ve(e.content);if(o&&(a.c=o),e.title&&(a.l=e.title),e.type===y.DRAWING&&e.data){const s=e.data,r=ue(s,30);a.d=we(r)}return a},we=e=>{var a;return(a=e.elements)!=null&&a.length?{el:e.elements.map(o=>{const s={t:o.type==="freehand"?"f":"s",c:o.style.strokeColor,w:o.style.strokeWidth};return o.type==="freehand"&&o.stroke?s.p=he(o.stroke.smoothedPath,0):o.type==="shape"&&o.shape&&(s.st={t:o.shape.shapeType,s:[Math.round(o.shape.startPoint.x),Math.round(o.shape.startPoint.y)],e:[Math.round(o.shape.endPoint.x),Math.round(o.shape.endPoint.y)]}),s}),iw:e.intrinsicWidth?Math.round(e.intrinsicWidth):void 0,ih:e.intrinsicHeight?Math.round(e.intrinsicHeight):void 0}:void 0},Ce=e=>({i:P(e.id),s:e.startNodeId?P(e.startNodeId):null,e:e.endNodeId?P(e.endNodeId):null,sp:[Math.round(e.startPoint.x),Math.round(e.startPoint.y)],ep:[Math.round(e.endPoint.x),Math.round(e.endPoint.y)],l:e.label||void 0}),be=(e,n)=>{const a=e.filter(r=>_[r.type]!==void 0).map(Se).filter(r=>r!==null),o=new Set(a.map(r=>r.i)),s=n.filter(r=>{const i=!r.startNodeId||o.has(P(r.startNodeId)),c=!r.endNodeId||o.has(P(r.endNodeId));return i&&c}).map(Ce);return{v:xe,n:a,a:s}},je=e=>btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),Ne=e=>{let n=e.replace(/-/g,"+").replace(/_/g,"/");const a=n.length%4;return a&&(n+="=".repeat(4-a)),atob(n)},Te=async(e,n)=>{const a=be(e,n),o=JSON.stringify(a),r=new TextEncoder().encode(o),i=new CompressionStream("gzip"),c=i.writable.getWriter();c.write(r),c.close();const g=[],p=i.readable.getReader();for(;;){const{done:m,value:N}=await p.read();if(m)break;g.push(N)}const l=g.reduce((m,N)=>m+N.length,0),u=new Uint8Array(l);let h=0;for(const m of g)u.set(m,h),h+=m.length;const v=Array.from(u,m=>String.fromCharCode(m)).join(""),C=D+je(v);return{url:C,stats:{nodeCount:a.n.length,arrowCount:a.a.length,rawSize:o.length,compressedSize:C.length,compressionRatio:Math.round((1-C.length/o.length)*100)}}},V=async e=>{if(!e.startsWith(D))return null;try{const n=e.slice(D.length),a=Ne(n),o=Uint8Array.from(a,h=>h.charCodeAt(0)),s=new DecompressionStream("gzip"),r=s.writable.getWriter();r.write(o),r.close();const i=[],c=s.readable.getReader();for(;;){const{done:h,value:v}=await c.read();if(h)break;i.push(v)}const g=i.reduce((h,v)=>h+v.length,0),p=new Uint8Array(g);let l=0;for(const h of i)p.set(h,l),l+=h.length;const u=new TextDecoder().decode(p);return JSON.parse(u)}catch{return null}},F=e=>{const n=new Map,a=e.n.map(s=>{const r=crypto.randomUUID();n.set(s.i,r);const i={id:r,x:s.x,y:s.y,type:ye[s.t]??y.RECT};return s.w&&(i.width=s.w),s.h&&(i.height=s.h),s.c&&(i.content=s.c),s.l&&(i.title=s.l),s.d&&(i.data=ze(s.d)),i}),o=e.a.map(s=>({id:crypto.randomUUID(),startNodeId:s.s?n.get(s.s)??null:null,endNodeId:s.e?n.get(s.e)??null:null,startPoint:{x:s.sp[0],y:s.sp[1]},endPoint:{x:s.ep[0],y:s.ep[1]},label:s.l}));return{nodes:a,arrows:o}},ze=e=>({elements:e.el.map(a=>a.t==="f"&&a.p?{type:"freehand",stroke:{points:[],smoothedPath:a.p},style:{strokeColor:a.c,strokeWidth:a.w,strokeStyle:"solid"}}:a.t==="s"&&a.st?{type:"shape",shape:{shapeType:a.st.t,startPoint:{x:a.st.s[0],y:a.st.s[1]},endPoint:{x:a.st.e[0],y:a.st.e[1]}},style:{strokeColor:a.c,strokeWidth:a.w,strokeStyle:"solid"}}:{type:"freehand",stroke:{points:[],smoothedPath:""},style:{strokeColor:a.c,strokeWidth:a.w,strokeStyle:"solid"}}),intrinsicWidth:e.iw,intrinsicHeight:e.ih}),Pe=({isOpen:e,onClose:n,triggerPosition:a})=>{const[o,s]=x.useState(""),[r,i]=x.useState(!1),[c,g]=x.useState(null),[p,l]=x.useState(null),u=k(d=>{var f;return((f=d.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??U}),h=k(d=>{var f;return((f=d.projectCanvas.getActive())==null?void 0:f.coreState.arrows)??U}),v=k(d=>d.setNodes),C=k(d=>d.arrow.setAll);x.useEffect(()=>{if(!o||!o.startsWith("cs:")){l(null);return}(async()=>{try{const f=await V(o);if(!f){l({textCount:0,drawingCount:0,arrowCount:0,isValid:!1});return}const{nodes:b,arrows:I}=F(f),R=b.filter(j=>j.type===y.RECT||j.type===y.TEXT||j.type===y.TEXTCARD).length,S=b.filter(j=>j.type===y.DRAWING).length;l({textCount:R,drawingCount:S,arrowCount:I.length,isValid:!0})}catch{l({textCount:0,drawingCount:0,arrowCount:0,isValid:!1})}})()},[o]);const m=x.useCallback(async()=>{try{const{url:d,stats:f}=await Te(u,h);await navigator.clipboard.writeText(d),g(f),i(!0),setTimeout(()=>i(!1),2e3),T.success("Canvas copied!",{description:`${f.nodeCount} nodes, ${f.arrowCount} arrows (${f.compressionRatio}% smaller)`})}catch(d){T.error("Failed to copy",{description:d instanceof Error?d.message:"Unknown error"})}},[u,h]),N=x.useCallback(async()=>{if(o.startsWith("cs:"))try{const d=await V(o);if(!d){T.error("Invalid share data");return}const{nodes:f,arrows:b}=F(d),I=f.filter(S=>S.type===y.RECT||S.type===y.TEXT||S.type===y.TEXTCARD).length,R=f.filter(S=>S.type===y.DRAWING).length;f.length>0&&v(S=>[...S,...f]),b.length>0&&C(S=>[...S,...b]),T.success("Canvas imported!",{description:`Added ${I} text, ${R} drawings, ${b.length} arrows`}),s(""),l(null),n()}catch(d){T.error("Failed to import",{description:d instanceof Error?d.message:"Invalid data"})}},[o,v,C,n]),A=t.jsx(w,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:m,title:"Copy canvas to clipboard","data-test":"canvas-share-copy-button",children:r?t.jsx(re,{size:14,className:"text-green-500"}):t.jsx(ie,{size:14})});return t.jsx(Y,{isVisible:e,onClose:n,title:"Share Canvas",triggerPosition:a,initialSize:{width:400,height:300},resizable:!0,headerActions:A,showPinButton:!1,showInspectorButton:!1,anchorOrigin:"top-right",children:t.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full","data-test":"canvas-share-content",children:[c&&t.jsxs("div",{className:"text-xs text-muted-foreground bg-muted/50 rounded p-2","data-test":"canvas-share-stats",children:["Last copy: ",c.nodeCount," nodes, ",c.arrowCount," arrows",t.jsx("br",{}),"Size: ",c.rawSize," â†’ ",c.compressedSize," bytes (",c.compressionRatio,"% reduction)"]}),t.jsxs("div",{className:"flex flex-col gap-1 flex-1 min-h-0",children:[t.jsx("label",{className:"text-xs font-medium",htmlFor:"paste-input",children:"Paste to import:"}),t.jsx(pe,{id:"paste-input",placeholder:"Paste cs:... data here",value:o,onChange:d=>s(d.target.value),className:"flex-1 min-h-[80px] text-xs font-mono resize-none","data-test":"canvas-share-paste-input"}),p&&t.jsx("div",{className:"flex items-center justify-between gap-2 mt-1","data-test":"canvas-share-import-preview",children:p.isValid?t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"text-xs text-muted-foreground",children:[p.textCount," text, ",p.drawingCount," drawings, ",p.arrowCount," arrows"]}),t.jsxs(w,{size:"sm",onClick:N,className:"gap-1","data-test":"canvas-share-import-button",children:[t.jsx(ne,{size:14}),"Import"]})]}):t.jsx("span",{className:"text-xs text-destructive",children:"Invalid share data"})})]})]})})},Ie=({onClick:e})=>{const n=a=>{const o=a.currentTarget.getBoundingClientRect();e({x:o.right,y:o.bottom+8})};return t.jsx(w,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5",onClick:n,title:"Share Canvas","data-test":"canvas-share-trigger",children:t.jsx(ae,{className:"h-5 w-5"})})};function B(e){return H(JSON.stringify(e))}function Re(e){return H(JSON.stringify(e))}function M(e){const n=Object.values(e.nodes),a=Re(e);let o=0,s=null;const r={},i={};for(const p of n){const l=B(p);l>o&&(o=l,s=p.id);const u=p.operation.type;r[u]=(r[u]||0)+1,i[u]=(i[u]||0)+l}const c=n.filter(p=>p.children.length>1).length,g=Ee(e);return{nodeCount:n.length,totalSizeBytes:a,totalSizeFormatted:E(a),avgNodeSizeBytes:n.length>0?Math.round(a/n.length):0,avgNodeSizeFormatted:E(n.length>0?a/n.length:0),largestNodeSizeBytes:o,largestNodeId:s,operationTypeCounts:r,operationTypeSizes:i,branchCount:c,maxDepth:g}}function ke(e,n){const o=Object.values(e.nodes).map(s=>({nodeId:s.id,operationType:s.operation.type,sizeBytes:B(s),sizeFormatted:E(B(s)),timestamp:s.timestamp,label:s.label||s.operation.type}));return o.sort((s,r)=>r.sizeBytes-s.sizeBytes),n?o.slice(0,n):o}function X(e){const n=M(e),a=[];for(const[o,s]of Object.entries(n.operationTypeSizes)){const r=n.operationTypeCounts[o]||0;a.push({type:o,count:r,totalSize:s,avgSize:r>0?Math.round(s/r):0,formatted:E(s)})}return a.sort((o,s)=>s.totalSize-o.totalSize),a}function Ee(e){if(!e.root)return 0;function n(a,o){if(o.has(a))return 0;o.add(a);const s=e.nodes[a];if(!s)return 0;if(s.children.length===0)return 1;let r=0;for(const i of s.children)r=Math.max(r,n(i,o));return 1+r}return n(e.root,new Set)}function Ae(e,n=1e4){return ke(e).filter(a=>a.sizeBytes>n)}function De(e){const n=M(e),a=X(e);let o=`# Undo Tree Summary

`;o+=`## Statistics
`,o+=`- Total nodes: ${n.nodeCount}
`,o+=`- Total size: ${n.totalSizeFormatted}
`,o+=`- Average node size: ${n.avgNodeSizeFormatted}
`,o+=`- Branches: ${n.branchCount}
`,o+=`- Max depth: ${n.maxDepth}

`,o+=`## Size by Operation Type
`;for(const s of a)o+=`- ${s.type}: ${s.count} ops, ${s.formatted}
`;return o}function Be(){const[e,n]=x.useState(null),[a,o]=x.useState(!1),[s,r]=x.useState(!1),i=async()=>{r(!0);try{const p=z.getState().undo.getTreeData()??L(),l=M(p),u=X(p),h=Ae(p,5e3),v=await z.getState().undo.getArchiveStats();n({stats:l,byType:u,bloated:h,archive:v})}finally{r(!1)}},c=()=>{const p=z.getState().undo.getTreeData()??L(),l=De(p);navigator.clipboard.writeText(l),o(!0),setTimeout(()=>o(!1),2e3)};return t.jsxs("div",{className:"flex flex-col gap-2","data-test":"undo-storage-analyzer",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(w,{variant:"outline",size:"sm",onClick:i,disabled:s,"data-test":"analyze-undo-storage-button",children:s?"Analyzing...":"Analyze Undo Storage"}),e&&t.jsx(w,{variant:"outline",size:"sm",onClick:c,"data-test":"copy-undo-summary-button",children:a?"Copied!":"Copy Summary"})]}),e&&t.jsxs("div",{className:"text-xs space-y-2 max-h-48 overflow-y-auto p-2 bg-muted rounded","data-test":"undo-analysis-results",children:[t.jsxs("div",{"data-test":"undo-stats-overview",children:[t.jsx("span",{className:"font-medium",children:"In Memory:"})," ",e.stats.totalSizeFormatted,t.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(",e.stats.nodeCount," nodes, avg ",e.stats.avgNodeSizeFormatted,")"]})]}),e.archive&&t.jsxs("div",{"data-test":"undo-stats-archive",children:[t.jsx("span",{className:"font-medium",children:"Archived:"})," ",t.jsxs("span",{className:"text-muted-foreground",children:[e.archive.archivedCount," / ",e.archive.archiveLimit," nodes"]}),t.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(limit: ",e.archive.historyLimit," in memory)"]})]}),e.byType.length>0&&t.jsxs("div",{"data-test":"undo-stats-by-type",children:[t.jsx("span",{className:"font-medium",children:"By Type:"}),t.jsx("ul",{className:"ml-2",children:e.byType.slice(0,5).map(g=>t.jsxs("li",{className:"text-muted-foreground",children:[g.type,": ",g.formatted," (",g.count,")"]},g.type))})]}),e.bloated.length>0&&t.jsxs("div",{className:"text-amber-600","data-test":"undo-stats-bloated",children:[t.jsxs("span",{className:"font-medium",children:["Bloated (",e.bloated.length,"):"]}),t.jsx("ul",{className:"ml-2",children:e.bloated.slice(0,3).map(g=>t.jsxs("li",{children:[g.label,": ",g.sizeFormatted]},g.nodeId))})]})]})]})}const $="debug-reset-canvas-on-reload";function Me(){const[e,n]=x.useState(!1),[a,o]=x.useState(!1),[s,r]=x.useState(!1);x.useEffect(()=>{localStorage.getItem($)==="true"&&(n(!0),z.getState().resetState())},[]);const i=c=>{n(c),localStorage.setItem($,String(c))};return t.jsxs(t.Fragment,{children:[t.jsxs(G,{open:s,onOpenChange:r,children:[t.jsx(J,{asChild:!0,children:t.jsx(w,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","data-test":"debug-popover-trigger",children:t.jsx(le,{className:"h-5 w-5"})})}),t.jsx(K,{className:"w-72","data-test":"debug-popover-content",children:t.jsxs("div",{className:"flex flex-col gap-3","data-test":"debug-popover-actions",children:[t.jsx("p",{className:"text-sm font-medium",children:"Debug Actions"}),t.jsx(w,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>z.getState().resetState(),"data-test":"reset-canvas-state-button",children:"Reset canvas state"}),t.jsx(w,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>z.getState().resetEverything(),"data-test":"reset-everything-button",children:"Reset everything"}),t.jsxs("div",{className:"flex items-center gap-2","data-test":"reset-on-reload-container",children:[t.jsx(q,{id:"reset-on-reload",checked:e,onCheckedChange:i,"data-test":"reset-on-reload-checkbox"}),t.jsx(Q,{htmlFor:"reset-on-reload",className:"text-sm cursor-pointer","data-test":"reset-on-reload-label",children:"Reset on reload"})]}),t.jsx("hr",{className:"border-border"}),t.jsx("p",{className:"text-sm font-medium",children:"Storage Analysis"}),t.jsx(Be,{}),t.jsx("hr",{className:"border-border"}),t.jsx("p",{className:"text-sm font-medium",children:"Mobile Logs"}),t.jsx(w,{variant:"outline",size:"sm",onClick:()=>{const c=!a;o(c),c&&r(!1)},"data-test":"toggle-mobile-logs-button",children:a?"Hide Mobile Logs":"Show Mobile Logs"})]})})]}),a&&t.jsx(ge,{defaultVisible:!0,autoRefresh:!0,refreshInterval:500,onClose:()=>o(!1)})]})}function Oe(){const[e,n]=x.useState(!1),[a,o]=x.useState(!1),[s,r]=x.useState(),i=()=>{n(!e)};return t.jsx("div",{className:"w-[98vw] pointer-events-none","data-test":"floating-header-wrapper",children:t.jsxs("header",{className:O("bg-card text-card-foreground top-0 flex items-center rounded-md p-2 shadow-md transition-all duration-250 ease-in-out pointer-events-auto",e?"w-[52px]":"w-full"),children:[t.jsx(w,{variant:"ghost",size:"icon",onClick:i,"aria-label":e?"Expand header":"Collapse header",children:e?t.jsx(ce,{className:"size-5"}):t.jsx(de,{className:"size-5"})}),t.jsxs("div",{className:O("flex flex-grow items-center justify-between overflow-hidden transition-all duration-300 ease-in-out",e?"ml-0 max-w-0 opacity-0":"ml-2 max-w-full opacity-100"),children:[t.jsx("h1",{className:"text-xl whitespace-nowrap",children:"Floating Header"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Z,{}),t.jsx(ee,{variant:"ghost",size:"icon",title:"Audio Recorder"}),t.jsx(fe,{}),t.jsx(te,{}),t.jsx(Ie,{onClick:c=>{r(c),o(!0)}}),t.jsx(Pe,{isOpen:a,onClose:()=>o(!1),triggerPosition:s}),t.jsx(Me,{}),t.jsx(se,{})]})]})]})})}function We(){const[e,n]=x.useState(!1),[a,o]=x.useState({top:0,left:0}),[s,r]=x.useState(null),i=l=>{const u=l.getBoundingClientRect(),h=window.getComputedStyle(l),v=parseInt(h.lineHeight||h.fontSize),C=l.selectionStart,m=document.createElement("div");["boxSizing","width","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontFamily","fontSize","fontWeight","lineHeight","letterSpacing"].forEach(j=>{m.style[j]=h[j]}),m.style.position="absolute",m.style.top=u.top+"px",m.style.left=u.left+"px",m.style.visibility="hidden",m.style.whiteSpace="pre-wrap",m.style.wordWrap="break-word",m.style.overflow="hidden";const A=l.value.substring(0,C);m.textContent=A;const d=document.createElement("span");d.textContent="|",m.appendChild(d),document.body.appendChild(m);const f=d.getBoundingClientRect();document.body.removeChild(m);const b=f.top-u.top,I=f.left-u.left,R=b+v+4-l.scrollTop,S=I-l.scrollLeft;return{top:R,left:S}};return{showPopover:e,popoverPosition:a,handleKeyDown:l=>{if(l.key==="/"&&!e){const u=l.currentTarget,h=u.selectionStart,v=i(u);o(v),r(h),n(!0)}else(l.key==="Escape"||l.key==="Backspace"&&e&&s!==null&&l.currentTarget.selectionStart===s)&&(n(!1),r(null))},handleChange:l=>{e&&s!==null&&(s>=l.length||l[s]!=="/")&&(n(!1),r(null))},closePopover:()=>{n(!1),r(null)}}}const wt=()=>{const[e,n]=x.useState("");return We(),t.jsxs("div",{className:"page-container w-screen h-screen relative bg-background text-foreground",children:[t.jsx("div",{className:"absolute top-10 left-1/2 -translate-x-1/2 z-50 pointer-events-none",children:t.jsx(Oe,{})}),t.jsx("main",{className:"content-area w-full h-full",children:t.jsx("div",{className:"demo-section h-full",children:t.jsx(me,{width:"100%",height:"100%"})})})]})};export{wt as NewHomeApp};
