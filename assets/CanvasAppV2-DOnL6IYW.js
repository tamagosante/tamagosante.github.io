var ba=Object.defineProperty;var ja=(e,t,n)=>t in e?ba(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var ze=(e,t,n)=>ja(e,typeof t!="symbol"?t+"":t,n);import{j as o,r as v,R as Be,b as yr}from"./react-vendor-CrhW4DYn.js";import{bU as un,bV as _,bW as Kt,bX as W,bY as Qe,aF as De,aE as ie,bZ as qt,b4 as Z,b_ as Es,aH as Q,aK as Mt,aG as ka,b$ as Ia,c0 as Vt,aJ as hn,c1 as At,c2 as Ra,c3 as _e,aM as Zt,_ as Aa,c4 as Vn,b5 as Oe,B as Y,W as je,a_ as Nt,a$ as Ct,b0 as bt,b1 as jt,aI as So,c5 as yo,as as Ea,c6 as Nr,bT as Cr,ah as Ta,aL as He,bz as Ma,bA as Da,bB as Pa,bC as _a,bD as Oa,w as dt,aC as $a,ao as _t,ap as Ot,aq as $t,c7 as Fa,S as es,a as ts,b as ns,c as ss,d as os,c8 as La,a8 as $e,c9 as mt,q as ct,b3 as ut,bJ as br,ca as Ha,y as rs,cb as za,ac as Wa,z as it,al as Un,cc as Ba,a4 as Ts,a5 as Ms,a6 as Ds,cd as Va,ce as Ua,cf as Ga,a7 as at,a1 as Ya,a2 as Xa,a3 as Ka,cg as qa,ch as gs,ci as Za,cj as Ja,ck as Qa,cl as ei,E as ti,Q as No,cm as yn}from"./index-CgyRe94A.js";import{a as ve}from"./ui-utils-BxIQ3qGg.js";import{aN as Co,e as jr,aM as ni,aw as _n,ba as Ps,aT as eo,a6 as Dt,Y as pn,v as si,I as oi,a5 as ri,u as On,W as mn,D as Ut,r as ai,bb as ii,H as li,bc as ci,aE as Et,n as di,h as ui,bd as gi,E as Pt,_ as Gt,b as Gn,be as fi,bf as hi,a$ as pi,O as Yt,bg as mi,ah as Yn,bh as xi,bi as kr,bj as wi,bk as vi,bl as Si,bm as yi,bn as Ni,a8 as Ir,L as Ci,bo as bi,bp as ji,M as ki,q as bo,bq as $n,br as _s,bs as Os,bt as $s,bu as Xn,k as Ii,bv as Rr,bw as jo,P as Ar,bx as Er,by as ko,bz as Tr,bA as Mr,bB as to,bC as no,bD as Ri,bE as Io,aW as Ai,bF as Ei,b6 as Ro,bG as Ti,bH as Mi,bI as Di,G as Pi,bJ as _i,bK as Oi,X as qe,a1 as Tt,av as xn,bL as $i,bM as Fi,a7 as so,ar as Li,bN as Hi,bO as zi,a2 as wn,aH as oo,J as Wi,y as as,bP as Bi,as as ro,ab as Dr,aq as zt,bQ as ao,aD as Vi,ad as Ui,V as vn,am as Fs,bR as Ao,bS as Eo,o as Gi,au as Fn,Q as Ln,aa as Yi,aQ as Xi,bT as Ki,bU as qi,bV as Zi,K as Ji,A as Qi,bW as To,al as el}from"./icons-6Gjq1X59.js";import{V as ot,E as tl,D as nl}from"./logging-3Ta40PMa.js";import{c as Le,V as an,I as Pr,K as sl,S as ol,C as rl,R as al,a as il,d as ll}from"./VimInputHandlerV2-B7glPzRj.js";import{T as cl}from"./TextareaPopoverAtCursor-D4YPM1uA.js";import{d as dl,t as Mo}from"./definitionHelper-B6GF8IZ1.js";import{T as ul}from"./textarea-DhMMW6X3.js";import{a as Do}from"./markdownToHtml-C-4HvgxL.js";import{W as Kn,S as gn,C as gl,a as fl,N as hl,I as pl}from"./WorkflowRowItem-BgEfflDF.js";import{t as ce}from"./utils-DPdF7W5J.js";import{D as ml}from"./DragDropManager-BCQ9eUTy.js";import{D as xl}from"./DraggableTree-DZBXXLrp.js";import{u as wl}from"./useOcr-D9MNhY6S.js";import{A as vl,a as Sl}from"./alert-OFiIdJW_.js";import{D as yl}from"./DraggableCrudTree-7toDmunK.js";import{a as Nl,b as Cl}from"./easy-form-VaGewJJh.js";import{JsonViewerApp as bl}from"./JsonViewerApp-BV6Qrni3.js";import{R as jl,a as fs}from"./radio-group-yyvGmlz8.js";import{M as kl}from"./MobileLogViewerButton-DhrY2Y3H.js";const _r=v.createContext(null),Il=({children:e,value:t})=>o.jsx(_r.Provider,{value:t,children:e}),io=()=>{const e=v.useContext(_r);if(e===null)throw new Error("useCanvasRef must be used within a CanvasRefProvider");return e},Rl=e=>{const t=io(),n=v.useRef(e);v.useEffect(()=>{n.current=e},[e]),v.useEffect(()=>{const s=t.current;if(!s)return;const r=j=>{var N,C;return(C=(N=n.current.pointer)==null?void 0:N.onPointerDown)==null?void 0:C.call(N,j)},a=j=>{var A,k;const N=['[data-prevent-canvas-click="true"]'],C=j.target;if(N.some(b=>C.closest(b)))return;const R=j;(k=(A=n.current.pointer)==null?void 0:A.onDblClick)==null||k.call(A,R)},i=j=>{var N,C;return(C=(N=n.current.pointer)==null?void 0:N.onPointerMove)==null?void 0:C.call(N,j)},l=j=>{var N,C;return(C=(N=n.current.pointer)==null?void 0:N.onPointerUp)==null?void 0:C.call(N,j)},c=j=>{var N,C;return(C=(N=n.current.pointer)==null?void 0:N.onPointerLeave)==null?void 0:C.call(N,j)},d=j=>{var R,A;const N=["#itemList"],C=j.target;N.some(k=>C.closest(k))||(A=(R=n.current).wheel)==null||A.call(R,j)},u=j=>{var N,C;return(C=(N=n.current.keyboard)==null?void 0:N.onKeyDown)==null?void 0:C.call(N,j)},h=j=>{var N,C;return(C=(N=n.current.keyboard)==null?void 0:N.onKeyUp)==null?void 0:C.call(N,j)},f=j=>{var N,C;return(C=(N=n.current.keyboard)==null?void 0:N.onCopy)==null?void 0:C.call(N,j)},g=j=>{var N,C;return(C=(N=n.current.touch)==null?void 0:N.onTouchStart)==null?void 0:C.call(N,j)},x=j=>{var N,C;return(C=(N=n.current.touch)==null?void 0:N.onTouchMove)==null?void 0:C.call(N,j)},p=j=>{var N,C;return(C=(N=n.current.touch)==null?void 0:N.onTouchEnd)==null?void 0:C.call(N,j)},{pointer:m,wheel:w,touch:S,keyboard:y}=e;return m!=null&&m.onPointerDown&&s.addEventListener("pointerdown",r),m!=null&&m.onDblClick&&s.addEventListener("dblclick",a),m!=null&&m.onPointerMove&&s.addEventListener("pointermove",i),m!=null&&m.onPointerUp&&window.addEventListener("pointerup",l),m!=null&&m.onPointerLeave&&s.addEventListener("pointerleave",c),w&&s.addEventListener("wheel",d,{passive:!1}),S!=null&&S.onTouchStart&&s.addEventListener("touchstart",g,{passive:!1}),S!=null&&S.onTouchMove&&s.addEventListener("touchmove",x,{passive:!1}),S!=null&&S.onTouchEnd&&s.addEventListener("touchend",p,{passive:!1}),y!=null&&y.onKeyDown&&window.addEventListener("keydown",u),y!=null&&y.onKeyUp&&window.addEventListener("keyup",h),y!=null&&y.onCopy&&window.addEventListener("copy",f),()=>{m!=null&&m.onPointerDown&&s.removeEventListener("pointerdown",r),m!=null&&m.onPointerMove&&s.removeEventListener("pointermove",i),m!=null&&m.onPointerUp&&window.removeEventListener("pointerup",l),m!=null&&m.onPointerLeave&&s.removeEventListener("pointerleave",c),w&&s.removeEventListener("wheel",d),S!=null&&S.onTouchStart&&s.removeEventListener("touchstart",g),S!=null&&S.onTouchMove&&s.removeEventListener("touchmove",x),S!=null&&S.onTouchEnd&&s.removeEventListener("touchend",p),y!=null&&y.onKeyDown&&window.removeEventListener("keydown",u),y!=null&&y.onKeyUp&&window.removeEventListener("keyup",h)}},[t])},lo=()=>{const e=io();return v.useCallback(t=>{const n=e.current;if(!n)return console.error("Canvas container ref not available in useGetRelativeMousePos"),{x:0,y:0};const s=n.getBoundingClientRect();return{x:t.clientX-s.left,y:t.clientY-s.top}},[e])},Al=e=>e;function is(e,t=Al){const n=Be.useSyncExternalStore(e.subscribe,Be.useCallback(()=>t(e.getState()),[e,t]),Be.useCallback(()=>t(e.getInitialState()),[e,t]));return Be.useDebugValue(n),n}const Or=[],B=e=>is(_,e),Xt=e=>is(un,e);function El(e){var n;const t=e;(t==null?void 0:t.tagName)!=="TEXTAREA"&&((n=window.getSelection())==null||n.removeAllRanges())}const lt=new Kt("useCanvasMouseEventsV2",qt.useCanvasMouseEventsV2),Tl=e=>{const t=e.target,n=t.closest("[data-canvas-container]");return!n||t.closest("[data-ui-panel]")?null:n},Ml=()=>{v.useEffect(()=>{const e=()=>{if(document.pointerLockElement===null){const t=_.getState().uiState.mode,n=_.getState().uiState.zoomSubMode;if(t===W.ZOOM&&n==="zoom:lock"){const s=_.getState().setZoomSubMode;s("zoom"),lt.log("Pointer lock released, reset to zoom mode")}}};return document.addEventListener("pointerlockchange",e),()=>{document.removeEventListener("pointerlockchange",e)}},[])},Dl=e=>{const t=lo(),n=Xt(i=>i.setMousePosition),s=_.getState(),r=s.uiState.mode,a=s.setIsPanning;return v.useCallback(i=>{const l=t(i);n(l),lt.log("Generic Pointer Down:",l.x,l.y),El(i.target);const c=_.getState().uiState.mode,d=_.getState().uiState.zoomSubMode;if(c===W.ZOOM&&i.button===0){const m=Tl(i);if(m){const w=_.getState().setZoomSubMode;d==="zoom:lock"?document.exitPointerLock():(m.requestPointerLock(),w("zoom:lock")),i.preventDefault();return}}if(!(i.button===1||i.button===0&&r===W.MOVE||i.button===-1))return;const h=i.target,f=h.closest("[data-node-id]"),g=h.id.includes("resize-handle-"),x=h.closest("[data-ui-panel]");if(g||x)return;let p=!1;r===W.MOVE?p=!0:f||(p=!0),p&&(lt.log("Starting Panning"),a(!0),e(l),i.preventDefault())},[t,n,a,e,r])},Pl=()=>{var i;const e=lo(),t=_.getState(),n=(i=t.uiState)==null?void 0:i.isPanning,s=Xt(l=>l.setMousePosition),r=t.setActiveCanvasViewState,a=Xt(l=>l.mousePosition);return v.useCallback(l=>{const c=_.getState().uiState.mode,d=_.getState().uiState.zoomSubMode,u=document.pointerLockElement!==null;if(c===W.ZOOM&&d==="zoom:lock"&&u){const g=l.movementX,x=l.movementY;r(p=>({...p,offset:{x:p.offset.x+g,y:p.offset.y+x}}));return}const f=e(l);if(n&&a){const g=f.x-a.x,x=f.y-a.y;r(p=>({...p,offset:{x:p.offset.x+g,y:p.offset.y+x}}))}s(f)},[e,s,n,a,r])},_l=e=>{var a;const t=lo(),n=_.getState(),s=(a=n.uiState)==null?void 0:a.isPanning,r=n.setIsPanning;return v.useCallback(i=>{const l=t(i);lt.log("Generic Pointer Up:",l.x,l.y),s&&(r(!1),e(null),lt.log("Stopped Panning"))},[t,s,r,e])},Ol=e=>{var a;const t=_.getState(),n=(a=t.uiState)==null?void 0:a.isPanning,s=t.setIsPanning,r=Xt(i=>i.setMousePosition);return v.useCallback(()=>{n&&(s(!1),e(null),lt.log("Stopped Panning (Mouse Leave)")),r(null)},[n,s,e,r])},Qt={current:null},hs={current:null},ps={current:0},$l=()=>{const e=_.getState(),t=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,s=Xt(r=>r.mousePosition);return v.useCallback(r=>{r.preventDefault();const a=t();if(!a)return;const{scale:i,offset:l}=a.viewState,d=_.getState().uiState.mode===W.ZOOM;if(r.ctrlKey||r.metaKey||d){if(!s)return;const{min:u,max:h,intensity:f}=Z.zoom,g=r.deltaY<0?1:-1;let x;if(i<=.1){const I=i+g*.01;x=Math.max(u,Math.min(h,I)),x=Math.round(x*100)/100}else{const I=i+g*f*i,R=Math.max(u,Math.min(h,I));x=(g>0?Math.ceil:Math.floor)(R*10)/10}if(x===i)return;const p=Qe(s,i,l),m=s.x-p.x*x,w=s.y-p.y*x,S=isNaN(m)?0:m,y=isNaN(w)?0:w,j=isNaN(x)?1:x,N=performance.now(),C=N-ps.current;Qt.current={newScale:j,newOffsetX:S,newOffsetY:y},C>=16?(n(I=>({...I,scale:j,offset:{x:S,y}})),ps.current=N,Qt.current=null):(hs.current&&clearTimeout(hs.current),hs.current=setTimeout(()=>{if(Qt.current){const{newScale:I,newOffsetX:R,newOffsetY:A}=Qt.current;n(k=>({...k,scale:I,offset:{x:R,y:A}})),ps.current=performance.now(),Qt.current=null}},16-C))}else n(u=>{var w,S;let h=r.deltaX,f=r.deltaY;r.shiftKey&&(h=f,f=0);const g=(((w=u.offset)==null?void 0:w.x)??0)-h,x=(((S=u.offset)==null?void 0:S.y)??0)-f,p=isNaN(g)?0:g,m=isNaN(x)?0:x;return{...u,offset:{x:p,y:m}}})},[t,n,s])},Fl=()=>{const e=_.getState(),t=e.uiState.mode,n=e.getCanvasMouseCoords,s=e.addNode,r=e.setNodeToFocusId;return v.useCallback(a=>{if(t!==W.SELECT){lt.log("Double Click ignored: Not in SELECT mode.");return}if(a.target.closest("[data-node-id], [data-arrow-id]")){lt.log("Double Click ignored: Clicked on existing element.");return}const l=n();if(!l){lt.log("Double Click ignored: Could not get canvas coordinates.");return}lt.log("Double Click on background: Adding node at",l);const c=De(10);s({id:c,x:l.x,y:l.y,content:"",type:ie.TEXT}),r(c),a.preventDefault(),a.stopPropagation()},[t,n,s])};class Ie{static buildTextNode(t,n,s){return{id:De(10),type:ie.TEXT,content:n,x:t.x,y:t.y,width:t.width,height:t.height,styles:s}}static buildTextNodeV2(t){return{id:De(10),type:ie.TEXT,content:t.content||"",x:t.x||0,y:t.y||0,width:t.width||100,height:t.height||100,styles:t.styles||{},options:t.options||{lockSize:!0},...t}}static buildTableNode(t){return{id:De(10),type:ie.TABLE,content:{data:[{id:"r1",col1:"Data1",col2:"Data2"},{id:"r2",col1:"Data3",col2:"Data4"}]},x:t.x,y:t.y,width:t.width||400,height:t.height||250,styles:{textAlign:"left"}}}static buildTextCardNode(t){return{id:De(10),type:ie.TEXTCARD,title:"",content:"",x:t.x,y:t.y,width:t.width||300,height:t.height||150,styles:{textAlign:"left"}}}static buildWorkflowOrchestrationNode(t){return{id:`wf-orchestration-${De(6)}`,type:ie.WORKFLOW_ORCHESTRATION,title:"Workflow",content:"",x:t.x,y:t.y,width:t.width||400,height:t.height||500,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:[{id:"row_1",label:"Step 1",order:1,stepType:"source",children:[]}]}}}}static buildWorkflowSourceNode(t){return{id:`wf-source-${De(6)}`,type:ie.WORKFLOW_SOURCE,title:"Source",content:"",x:t.x,y:t.y,width:t.width||300,height:t.height||200,data:{displayFormat:"raw"}}}static buildWorkflowDefinitionNode(t){return{id:`wf-def-${De(6)}`,type:ie.WORKFLOW_DEFINITION,title:"Workflow Runner",content:"",x:t.x,y:t.y,width:t.width||280,height:t.height||180,data:{definitionId:void 0,instanceId:void 0,lastExecutionStatus:"idle"}}}static buildOCRNode(t){return{id:`ocr-${De(6)}`,type:ie.OCR,title:"OCR",content:"",x:t.x,y:t.y,width:t.width||350,height:t.height||500,data:{image:void 0,extractedText:void 0,detectedLanguage:void 0,confidence:void 0}}}static buildImageNode(t){return{id:`img-${De(6)}`,type:ie.IMAGE,title:"Image",content:"",x:t.x,y:t.y,width:t.width||300,height:t.height||250,data:{image:void 0}}}}const Ll=Object.freeze(Object.defineProperty({__proto__:null,CanvasNodeBuilderV2:Ie},Symbol.toStringTag,{value:"Module"}));function co(e,t,n="right",s={}){var d;const{shouldFocus:r=!0}=s,a=_.getState();let i=e.width,l=e.height;if(!i||!l){const u=Z.nodeOptions.maxNodeWidth;i=Math.min(Es(e.content),u)+Q.NODE_X_PADDING*2,l=Math.min(Mt(e.content,u))+Q.NODE_Y_PADDING*2}switch((d=a.projectCanvas.getActive())==null||d.viewState.offset,n){case"left":e.x=t.x-i-Q.nodeSpacing*3,e.y=t.y;break;case"right":e.x=t.x+(t.width??0)+Q.nodeSpacing*3,e.y=t.y;break;case"above":e.y=t.y-Q.nodeSpacing*3;break;case"below":e.y=t.y+(t.height??0)+Q.nodeSpacing;break}const c={...e,width:i,height:l};a.addNode(c,void 0,{dontOverlap:!0,dontSelect:!0}),r&&a.setNodeToFocusId(t.id);{const u=()=>Math.random().toString(36).slice(2,10),h=f=>({x:(f.x??0)+(f.width??0)/2,y:(f.y??0)+(f.height??0)/2});window.setTimeout(()=>{a.arrow.add({id:u(),startNodeId:t.id,endNodeId:c.id,startPoint:h(t),endPoint:h(c)})},0)}}function $r(e,t,n){let s=e;for(;s&&!s.hasAttribute("data-text-position-container");)s=s.parentElement;if(!s)return null;const r=window.getComputedStyle(e),a=document.createElement("div");a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.visibility="hidden",a.style.font=r.font,a.style.fontSize=r.fontSize,a.style.fontFamily=r.fontFamily,a.style.fontWeight=r.fontWeight,a.style.lineHeight=r.lineHeight,a.style.letterSpacing=r.letterSpacing,a.style.wordSpacing=r.wordSpacing,a.style.padding=r.padding,a.style.width=`${e.clientWidth}px`,a.style.border="none",a.style.whiteSpace=r.whiteSpace,a.style.wordWrap=r.wordWrap,a.style.overflowWrap=r.overflowWrap,a.textContent=e.value,s?s.appendChild(a):document.body.appendChild(a);try{const i=document.createRange(),l=a.firstChild;if(!l||l.nodeType!==Node.TEXT_NODE)return null;i.setStart(l,t),i.setEnd(l,n);const c=i.getClientRects();if(c.length===0)return null;const d=c[0],u=s==null?void 0:s.getBoundingClientRect();if(!u)return null;const h={top:d.top-u.top,left:d.left-u.left},f=parseFloat(r.paddingTop)||0,g=parseFloat(r.paddingLeft)||0,x=h.top-f,p=h.left-g;return{top:x,left:p,width:d.width,height:d.height}}finally{s&&a.parentNode===s?s.removeChild(a):a.parentNode===document.body&&document.body.removeChild(a)}}const st=e=>/[\w\u00C0-\u024F]/.test(e);function Po(e,t){if(!e||t<0||t>e.length)return!1;const n=e[t]||"",s=e[t-1]||"",r=st(s),a=st(n);return r&&!a||!r&&a}function Hl(e,t){if(!e||t<0||t>e.length)return null;const n=e[t]||"",s=e[t-1]||"";if(!st(n)&&!st(s))return null;let r=t;for(;r>0&&st(e[r-1]);)r--;let a=t;for(;a<e.length&&st(e[a]);)a++;return r<a?{start:r,end:a,word:e.substring(r,a)}:null}function _o(e,t){const n=Hl(e,t);return n?{start:n.start,end:n.end}:null}function Oo(e,t){if(!e||t<0||t>e.length)return null;let n=t;for(;n>0&&!st(e[n-1]);)n--;if(n===0)return null;let s=n;for(;s>0&&st(e[s-1]);)s--;let r=t;for(;r<e.length&&!st(e[r]);)r++;if(r>=e.length)return null;let a=r;for(;a<e.length&&st(e[a]);)a++;return{start:s,end:a}}function $o(e,t){for(;t>0&&st(e[t-1]);)t--;return t}function Fo(e,t){for(;t<e.length&&st(e[t]);)t++;return t}function zl(e,t,n){var h;const s=document.createRange(),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let a=0,i=null,l=0,c=null,d=0,u;for(;u=r.nextNode();){const f=((h=u.textContent)==null?void 0:h.length)||0;if(!i&&a+f>=t&&(i=u,l=t-a),!c&&a+f>=n){c=u,d=n-a;break}a+=f}if(i&&c)try{return s.setStart(i,l),s.setEnd(c,d),s}catch(f){return console.warn("Failed to create text range:",f),null}return null}function Wl(e){const t=e.split(ka);if(t.length===2)try{return{isContentCapture:!0,data:JSON.parse(t[1])}}catch{return{isContentCapture:!1,content:e}}return console.log(">>>> _ >>>> ~ OnPasteContentService.ts:26 ~ parts:",t),{isContentCapture:!1,content:t[0]}}const We=class We{onMouseDown(t){const n=_.getState(),s=n.uiState,{mode:r,addNodeType:a}=s,i=n.getCanvasMouseCoords();if(r!==W.ADD||a!==ie.TEXT||!i)return!1;const l=Ie.buildTextNode(i,"");return n.addNode(l),n.setNodeToFocusId(l.id),!0}async onPaste(t){var g;const n=_.getState(),s=await Ia();if(!s)return!1;const r=Wl(s);if(r.isContentCapture){const x=n.getCanvasMouseCoords();if(x)return this.createNodesFromContentCapture(r.data,x),n.setNodeToFocusId(null),t.preventDefault(),!0}const a=r.isContentCapture?s:r.content,{mode:i,addNodeType:l,nodeToFocusId:c}=n.uiState,d=((g=n.projectCanvas.getActive())==null?void 0:g.coreState.selectedNodes)??[];if(c){const x=n.getNodeById(c);if(x&&typeof x.content=="string"&&d.length>0){const m=(x.content||"")+a;return n.updateNode(x.id,{...x,content:m}),t.preventDefault(),!0}}const u=n.getCanvasMouseCoords(),h=i===W.ADD&&l===ie.TEXT&&u,f=!c&&u;if(h){const x=Ie.buildTextNode(u,a);return n.addNode(x),n.setNodeToFocusId(x.id),n.setMode(W.SELECT),n.setAddNodeType(null),t.preventDefault(),!0}else if(f){const x=n.getSegmentedButtonAction("canvas-fit-width");let p=null;if(x){const j=/Set width to (\d+)px/.exec(x);j&&(p=parseInt(j[1],10))}let m,w,S;if(p)w=Vt(a,{containerWidth:p})+Q.NODE_Y_PADDING*2,m=p,S=!0;else{let j;const N=document.querySelector("textarea[data-node-textarea]");if(N){const R=window.getComputedStyle(N).lineHeight;if(R&&R!=="normal"){const A=parseFloat(R);isNaN(A)||(j=A)}}const C=hn(a,j);m=C.width,w=C.height,S=!1}const y=Ie.buildTextNodeV2({x:u.x,y:u.y,width:m,height:w,content:a,styles:{textAlign:"left"},options:{lockSize:S}});return n.addNode(y),n.setNodeToFocusId(y.id),t.preventDefault(),!0}return!1}createNodesFromContentCapture(t,n){const s=_.getState(),{pasteWidth:r,nodeGap:a}=Z.contentCapture,i=Math.min(...t.nodes.map(g=>g.x)),l=Math.min(...t.nodes.map(g=>g.y)),c=n.x-i,d=n.y-l,u=new Map,h=t.nodes.every(g=>g.width&&g.height);let f=n.y;for(const g of t.nodes){const x=g.content||"";let p,m,w;g.width&&g.height?(p=g.width,m=g.height,w=h?g.y+d:f):(p=r,m=Vt(x,{containerWidth:r})+Q.NODE_Y_PADDING*2,w=f);const S=Ie.buildTextNodeV2({x:g.x+c,y:w,width:p,height:m,content:x,title:g.title,styles:{textAlign:"left"},options:{lockSize:!h}});u.set(g.id,S.id),s.addNode(S),h||(f+=m+a)}for(const g of t.arrows??[]){const x=g.startNodeId?u.get(g.startNodeId):null,p=g.endNodeId?u.get(g.endNodeId):null;x&&p&&s.arrow.add({id:De(10),startNodeId:x,endNodeId:p,startPoint:{x:0,y:0},endPoint:{x:0,y:0}})}}onCopy(t){var h,f;const{focus:n,sourceNode:s,side:r="right"}=t||{focus:!0},a=_.getState(),{mode:i,nodeToFocusId:l}=a.uiState;if(!i)return null;const c=((h=a.projectCanvas.getActive())==null?void 0:h.coreState.selectedNodes)??[],d=Date.now();let u=!1;if(We.lastCopyTimestamp&&d-We.lastCopyTimestamp<We.DOUBLE_COPY_INTERVAL_MS&&(u=!0),We.lastCopyTimestamp=d,u)return null;{let g=s;return g||(g=c[0],g||(g=(((f=a.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??[]).find(w=>w.id===l))),Bl(g,n?l:null,n,r)}}highlightAndCreateNode(t,n="right"){var d;const s=_.getState(),r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let l=!1,c=null;if(a){const u=r,h=u.value;let f=u.selectionStart,g=u.selectionEnd;if(f===g)if(Po(h,f)){const x=Oo(h,f);x&&(f=x.start,g=x.end)}else{const x=_o(h,f);x&&(f=x.start,g=x.end)}else f=$o(h,f),g=Fo(h,g);(f!==u.selectionStart||g!==u.selectionEnd)&&u.setSelectionRange(f,g),l=f!==g}else if(i){const u=window.getSelection(),h=r.textContent||"";let f=!!(u&&!u.isCollapsed&&u.toString().trim());if(u&&u.rangeCount>0){const g=u.getRangeAt(0),x=document.createRange();x.setStart(r,0),x.setEnd(g.startContainer,g.startOffset);let p=x.toString().length;const m=document.createRange();m.setStart(r,0),m.setEnd(g.endContainer,g.endOffset);let w=m.toString().length;if(p===w)if(Po(h,p)){const S=Oo(h,p);S&&(p=S.start,w=S.end)}else{const S=_o(h,p);S&&(p=S.start,w=S.end)}else p=$o(h,p),w=Fo(h,w);if(p!==w){const S=zl(r,p,w);S&&(u.removeAllRanges(),u.addRange(S),c=S.cloneRange(),f=!0)}}l=f,l&&u&&u.rangeCount>0&&!c&&(c=u.getRangeAt(0).cloneRange())}if(l){t.preventDefault();const{nodeToFocusId:u}=s.uiState,h=s.projectCanvas.getActive();let g=((h==null?void 0:h.coreState.selectedNodes)??[])[0];!g&&u&&(g=((h==null?void 0:h.coreState.nodes)??[]).find(S=>S.id===u));const x=a?r.selectionStart:0,p=a?r.selectionEnd:0;We.dismissPopoverCallback&&We.dismissPopoverCallback();const m=this.onCopy({focus:!1,sourceNode:g,side:n});if(setTimeout(()=>{if(r.focus(),a)r.setSelectionRange(x,p);else if(i&&c){const w=window.getSelection();w&&(w.removeAllRanges(),w.addRange(c))}},0),g!=null&&g.highlights&&g.highlights.length>1&&m){const S=(((d=s.projectCanvas.getActive())==null?void 0:d.coreState.nodes)??[]).find(j=>j.id===g.id),y=window.__showLinkedNodesPopover;y&&S&&y(S,m)}}else{const{nodeToFocusId:u}=s.uiState,h=s.projectCanvas.getActive();let g=((h==null?void 0:h.coreState.selectedNodes)??[])[0];if(!g&&u&&(g=((h==null?void 0:h.coreState.nodes)??[]).find(p=>p.id===u)),g!=null&&g.highlights&&g.highlights.length>0){t.preventDefault();const x=window.__showLinkedNodesPopover;x&&x(g,null)}}}static registerSelectionCallback(t){We.selectionChangeCallback=t}static unregisterSelectionCallback(){We.selectionChangeCallback=null}static registerDismissPopoverCallback(t){We.dismissPopoverCallback=t}static unregisterDismissPopoverCallback(){We.dismissPopoverCallback=null}onTextSelect(t,n,s){const r=n!==s;We.selectionChangeCallback&&We.selectionChangeCallback(r)}};ze(We,"lastCopyTimestamp",null),ze(We,"DOUBLE_COPY_INTERVAL_MS",400),ze(We,"selectionChangeCallback",null),ze(We,"dismissPopoverCallback",null);let pt=We;function Bl(e,t,n=!0,s="right"){var R;if(!e)return console.warn("No target node found for copy action."),null;const r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let l="",c=null,d=0,u=0;if(a){const A=r;d=A.selectionStart,u=A.selectionEnd,l=A.value.substring(d,u);const k=$r(A,d,u);if(k)c=new DOMRect(0,k.top,k.width,k.height);else{const b=Q.LINE_HEIGHT,T=4,O=A.value.substring(0,d).split(`
`).length-1,M=T+O*b;c=new DOMRect(0,M,0,b)}}else if(i){const A=window.getSelection();if(l=(A==null?void 0:A.toString())||"",A&&A.rangeCount>0){const k=A.getRangeAt(0),b=r.getBoundingClientRect(),T=k.getClientRects();if(T.length>0){const D=T[0],O=D.top-b.top;c=new DOMRect(0,O,D.width,D.height)}const E=document.createRange();E.setStart(r,0),E.setEnd(k.startContainer,k.startOffset),d=E.toString().length,u=d+l.length}}else{const A=window.getSelection();if(l=(A==null?void 0:A.toString())||"",A&&A.rangeCount>0){const k=A.getRangeAt(0).cloneRange(),b=document.createElement("span");b.style.position="absolute",b.textContent="â€‹",k.insertNode(b),c=b.getBoundingClientRect(),(R=b.parentNode)==null||R.removeChild(b)}}const h=_.getState();let f;const g="rgb(198, 183, 0)";if((a||i)&&d!==u){const A=e.highlights||[],k=A.find(b=>b.start===d&&b.end===u);if(k)f=k.id;else{f=Math.random().toString(36).slice(2,10);const b={id:f,start:d,end:u,color:g,createdAt:Date.now()},T=[...A,b];h.updateNode(e.id,{highlights:T})}}const x=h.getSegmentedButtonAction("canvas-fit-width");let p=null;if(x){const A=x.match(/Set width to (\d+)px/);A&&(p=parseInt(A[1],10))}let m,w,S,y;const j=document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(j){const k=window.getComputedStyle(j).lineHeight;if(k&&k!=="normal"){const b=parseFloat(k);isNaN(b)||(y=b)}}if(p)w=Vt(l,{containerWidth:p})+Q.NODE_Y_PADDING*2,m=p,S=!0;else{const A=hn(l,y);m=A.width,w=A.height,S=!1}const N=Ie.buildTextNodeV2({content:l,width:m,height:w,linkedHighlightId:f,linkedSourceNodeId:e.id,options:{lockSize:S}});let C=e.y;if(c){const A=c.top;C=e.y+A,C-=Q.TEXT_MODE_ADJUST_Y}const I=t||e.id;if(co(N,{...e,y:C,id:I},s,{shouldFocus:n}),f){const A=h.getNodeById(e.id),b=((A==null?void 0:A.highlights)||[]).map(T=>T.id===f?{...T,linkedNodeId:N.id}:T);h.updateNode(e.id,{highlights:b})}return N.id}const Vl=1e3,Ul=500,Gl=500,Yl=250,Xl=2e3,Kl=1e3,ql=500;class Zl{handleArrowKey(t,n=!1,s=!1){const r=_.getState(),a=r.projectCanvas.getActive();if(!a)return!1;const i=a.coreState.selectedNodes??[];if(i.length===0)return!1;const l=a.coreState.nodes??[],c=new Set(i.map(g=>g.id)),d=l.filter(g=>c.has(g.id));let u=Vl,h=Ul;s?(u=Xl,h=Kl):n&&(u=Gl,h=Yl);const f=d.map(g=>{const x={id:g.id};switch(t.key){case"ArrowLeft":{const p=g.x,w=Math.round(p/u)-1;x.x=w*u;break}case"ArrowRight":{const p=g.x,w=Math.round(p/u)+1;x.x=w*u;break}case"ArrowUp":{const p=g.y,w=Math.round(p/h)-1;x.y=w*h;break}case"ArrowDown":{const p=g.y,w=Math.round(p/h)+1;x.y=w*h;break}}return x});return r.updateNodes(f),this.animateViewportToCenter(f,a),t.preventDefault(),!0}animateViewportToCenter(t,n){if(t.length===0||!n)return;const r=_.getState().setActiveCanvasViewState,a=n.viewState,i=a.scale,l=a.offset,c=n.coreState.nodes??[],d=new Map(c.map(C=>[C.id,C]));let u=0,h=0;t.forEach(C=>{const I=d.get(C.id);if(I){const R=C.x??I.x,A=C.y??I.y;u+=R,h+=A}});const f=u/t.length,g=h/t.length,x=window.innerWidth,p=window.innerHeight,m=x/2-f*i,w=p/2-g*i,S=performance.now(),y=l.x,j=l.y,N=C=>{const I=C-S,R=Math.min(I/ql,1),A=1-Math.pow(1-R,3),k=y+(m-y)*A,b=j+(w-j)*A;r(T=>({...T,offset:{x:k,y:b}})),R<1&&requestAnimationFrame(N)};requestAnimationFrame(N)}}const Lo=!0,Jl=1/3;function Ql(e,t){return new Promise(n=>{const s=new Image;s.onload=()=>{const r=Math.round(s.naturalWidth*t),a=Math.round(s.naturalHeight*t),i=document.createElement("canvas");i.width=r,i.height=a;const l=i.getContext("2d");if(!l){n({dataUrl:e,size:{width:s.naturalWidth,height:s.naturalHeight}});return}l.drawImage(s,0,0,r,a);const c=i.toDataURL("image/jpeg",.85);n({dataUrl:c,size:{width:r,height:a}})},s.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},s.src=e})}class ec{async onPaste(t){try{const n=await navigator.clipboard.read();for(const s of n){const r=s.types.find(h=>h.startsWith("image/"));if(!r)continue;const a=await s.getType(r);if(!a)continue;const i=Math.round(a.size/1024),l=await this.blobToDataUrl(a);let c,d;if(Lo){const h=await Ql(l,Jl);c=h.dataUrl,d=h.size}const u=Lo?Math.round(c.length*3/4/1024):i;return this.createImageNode(c,d,u),t.preventDefault(),!0}}catch(n){console.debug("ImageModeHandler: Clipboard read failed",n)}return!1}blobToDataUrl(t){return new Promise((n,s)=>{const r=new FileReader;r.onload=()=>n(r.result),r.onerror=s,r.readAsDataURL(t)})}createImageNode(t,n,s){const r=_.getState(),a=r.getCanvasMouseCoords();if(!a){console.warn("ImageModeHandler: No mouse position available");return}const i=300,l=n.height/n.width,c=Math.round(i*l),d=Ie.buildImageNode({x:a.x,y:a.y,width:i,height:Math.max(c,100)});d.data={image:t,imageSize:n,fileSizeKB:s},r.addNode(d),r.setNodeToFocusId(d.id)}}function tc(){const e=document.activeElement;if(!e)return null;const t=["INPUT","TEXTAREA"].includes(e.nodeName??""),n=e.contentEditable==="true";return t||n}class nc{constructor(){ze(this,"activeCallback",null)}registerCallback(t){this.activeCallback=t}unregisterCallback(t){this.activeCallback===t&&(this.activeCallback=null)}applyHighlight(t){return this.activeCallback?(this.activeCallback(t),!0):!1}hasActiveCallback(){return this.activeCallback!==null}}const ln=new nc,sc=new Kt("useCanvasKeyboardEventsV2",qt.useCanvasKeyboardEventsV2),oc=["q","Q","!","$","1","%","5"],rc=()=>{const e=_.getState(),t=e.uiState.mode,n=e.setMode,s=e.setZoomSubMode,r=e.setWriteSubMode,a=e.toggleWriteSubMode,i=e.setAddNodeType,l=e.setNodeToFocusId,c=e.copyNodes,d=e.setSelectedNodes,u=e.deleteSelectedNodes,h=e.deleteSelectedArrows,f=e.setActiveCanvasViewState,g=v.useRef(new pt),x=v.useRef(new Zl),p=v.useRef(new ec);return v.useCallback(m=>{var I;const w=_.getState().uiState.mode;if(w===W.VIM)return;if(m.key==="Escape"){w===W.SELECT&&d([]),n(W.SELECT),l(null),i(null);return}if((m.key==="h"||m.key==="H")&&(m.ctrlKey||m.metaKey)){m.preventDefault(),ln.applyHighlight();return}const S=m.key==="Enter"&&m.ctrlKey,y=m.key==="a"&&w===W.WRITE;if(w===W.WRITE&&!S&&!y)return;const j=tc(),N=oc.includes(m.key);if(j&&!N)return;if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(m.key)){const R=e.projectCanvas.getActive(),A=(R==null?void 0:R.coreState.selectedNodes)??[];if(w===W.GRID&&A.length>0){const k=m.ctrlKey,b=m.shiftKey;if(x.current.handleArrowKey(m,k,b))return}if(m.ctrlKey&&A.length>0&&w!==W.GRID){const k=e.uiState.lastUpdatedNodeId;if(!k)return;const b=(I=R==null?void 0:R.coreState.nodes)==null?void 0:I.find(E=>E.id===k);if(!b)return;const T=A.map(E=>{const D={id:E.id};switch(m.key){case"ArrowLeft":case"ArrowRight":D.x=b.x;break;case"ArrowUp":case"ArrowDown":D.y=b.y;break}return D});e.updateNodes(T),m.preventDefault();return}if(A.length===0){const k=m.shiftKey?100:30;f(b=>{let T=0,E=0;switch(m.key){case"ArrowUp":E=k;break;case"ArrowDown":E=-k;break;case"ArrowLeft":T=k;break;case"ArrowRight":T=-k;break}return{...b,offset:{x:b.offset.x+T,y:b.offset.y+E}}}),m.preventDefault();return}}switch(m.key){case"a":w===W.WRITE?a():n(W.DRAW_ARROW);break;case"c":if(m.ctrlKey){c();break}console.clear();break;case"v":if(m.ctrlKey){const R=e.projectCanvas.getActive();if(((R==null?void 0:R.coreState.selectedNodes)??[]).some(b=>b.type===ie.OCR||b.type===ie.IMAGE))break;(async()=>await p.current.onPaste(m)||g.current.onPaste(m))();break}n(W.SELECT);break;case"g":n(W.GRID);break;case"h":case"H":w===W.MOVE?(n(W.ZOOM),s("zoom")):w===W.ZOOM?n(W.MOVE):n(W.MOVE);break;case"i":n(W.VIM);break;case"n":{n(W.ADD),e.uiState.addNodeType||i(ie.TABLE);break}case"q":if(m.ctrlKey){g.current.onCopy();break}break;case"Q":if(m.ctrlKey&&m.shiftKey){g.current.onCopy();break}break;case"$":case"1":case"!":{g.current.highlightAndCreateNode(m,"right");break}case"%":case"5":{g.current.highlightAndCreateNode(m,"left");break}case"t":n(W.ADD),i(ie.TEXT);break;case"w":n(W.WRITE),r(At.WRITE);break;case"Delete":case"Backspace":u(),h(),m.preventDefault();break}},[t,n,s,r,a,i,u,h,f,e])},ac=()=>v.useCallback(e=>{sc.log("Key Up:",e.key)},[]),qn=(e,t)=>e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y,uo=e=>({x:e.x,y:e.y,width:e.width??100,height:e.height??50}),ic=(e,t,n)=>{const{x1:s,y1:r,x2:a,y2:i}=n,{x:l,y:c}=e,{x:d,y:u}=t,h=d-l,f=u-c;let g=-1/0,x=1/0;const p=(w,S,y,j)=>{if(Math.abs(S)<1e-6)return w>=y&&w<=j;let N=(y-w)/S,C=(j-w)/S;return N>C&&([N,C]=[C,N]),g=Math.max(g,N),x=Math.min(x,C),g<=x};if(!p(l,h,s,a)||!p(c,f,r,i)||g>1||x<0)return null;const m=Math.max(0,g);return m<=1?{x:l+m*h,y:c+m*f}:null},Ge=(e,t,n,s,r)=>{var d;if(!e)return t;const a=s.find(u=>u.id===e);if((a==null?void 0:a.width)===void 0||a.height===void 0)return t;if(r){const u=`[data-row-connector="${r}"][data-node-id="${e}"]`,h=document.querySelector(u);if(h){const f=h.getBoundingClientRect(),g=document.querySelector("[data-canvas-content]");if(g){const x=g.getBoundingClientRect(),p=f.left+f.width/2-x.left,m=f.top+f.height/2-x.top,S=(d=_.getState().projectCanvas.getActive())==null?void 0:d.viewState;return S?Qe({x:p,y:m},S.scale,S.offset):{x:p,y:m}}}else return t}const i=Ra(a),l=_e(a);return ic(n,l,i)??l},lc=(e,t,n,s,r)=>{if(r===0){const a=n/s;return Math.abs(e)*a>=Math.abs(t)}return Math.abs(e)*r>=Math.abs(t)},Wt=(e,t,n,s,r=0,a=Z.arrows.CUBIC_HORIZONTAL_BIAS)=>{if(!e)return t;const i=s.find(h=>h.id===e);if(!(i!=null&&i.width)||!i.height)return t;const l=_e(i),c=n.x-l.x,d=n.y-l.y;return lc(c,d,i.width,i.height,a)?c>0?{x:i.x+i.width-r,y:l.y}:{x:i.x+r,y:l.y}:d>0?{x:l.x,y:i.y+i.height-r}:{x:l.x,y:i.y+r}};function cc(e,t,n,s){const r=t.x-e.x,a=t.y-e.y,i=Math.abs(r),l=Math.abs(a),c=(s==null?void 0:s.dx)??r,d=(s==null?void 0:s.dy)??a,u=Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,h=Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED;let f,g;if(n==="horizontal"){const x=Math.max(i*.5,50)*u,p=c>0?1:-1,m=h?-1:1;f={x:e.x+p*x*m,y:e.y},g={x:t.x-p*x*m,y:t.y}}else{const x=Math.max(l*.5,50)*u,p=d>0?1:-1,m=h?-1:1;f={x:e.x,y:e.y+p*x*m},g={x:t.x,y:t.y-p*x*m}}return[f,g]}const Zn=(e,t,n,s,r=0)=>{if(!e)return t;const a=s.find(c=>c.id===e);if(!(a!=null&&a.width)||!a.height)return t;const i=_e(a);return n.x-i.x>0?{x:a.x+a.width-r,y:i.y}:{x:a.x+r,y:i.y}},Fr=(e,t,n)=>{if(!e)return t;const s=n.find(a=>a.id===e);return!(s!=null&&s.width)||!s.height?t:{x:_e(s).x,y:s.y+s.height}};function Lr(e,t,n){const s=e.type??Z.arrows.type,r=Z.arrows.CUBIC_HORIZONTAL_BIAS,a=-10,i=t.find(h=>h.id===e.startNodeId),l=t.find(h=>h.id===e.endNodeId),c=s==="TreeCubic"||s==="TreeLStep"||s==="TreeZShape";let d;if(c&&i&&l){const h=_e(i);d=Zn(e.endNodeId,e.endPoint,h,t,a)}else if((s==="Cubic"||s==="Orthogonal")&&i&&l){const h=_e(i);d=Wt(e.endNodeId,e.endPoint,h,t,a,r)}else if(s==="Step"&&i&&l){const h=_e(i),f=_e(l),g=f.x-h.x,x=f.y-h.y,m=Math.abs(g)*r>=Math.abs(x)?.001:1e3;d=Wt(e.endNodeId,e.endPoint,h,t,a,m)}else{const h=i?Ge(e.startNodeId,e.startPoint,e.endPoint,t,e.startRowId):e.startPoint;d=l?Ge(e.endNodeId,e.endPoint,h,t,e.endRowId):e.endPoint}let u;if(s==="TreeLStep"&&i)u=Fr(e.startNodeId,e.startPoint,t);else if((s==="TreeCubic"||s==="TreeZShape")&&i&&l){const h=_e(l);u=Zn(e.startNodeId,e.startPoint,h,t,0)}else if((s==="Cubic"||s==="Step"||s==="Orthogonal")&&i&&l){const h=_e(l);u=Wt(e.startNodeId,e.startPoint,h,t,0,r)}else{const h=l?Ge(e.endNodeId,e.endPoint,e.startPoint,t,e.endRowId):e.endPoint;u=i?Ge(e.startNodeId,e.startPoint,h,t,e.startRowId):e.startPoint}return{actualStartPoint:u,actualEndPoint:d}}function dc(e,t,n){const{actualStartPoint:s,actualEndPoint:r}=Lr(e,t),a=Math.min(s.x,r.x),i=Math.min(s.y,r.y),l=Math.max(s.x,r.x),c=Math.max(s.y,r.y);return{x:a,y:i,width:l-a,height:c-i}}const Ho={SELECTION_BOX_END:"selectionBoxEnd"};class uc{constructor(){ze(this,"listeners",{})}subscribe(t,n){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(n),()=>{this.unsubscribe(t,n)}}unsubscribe(t,n){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(s=>s!==n))}dispatch(t,n){this.listeners[t]&&this.listeners[t].forEach(s=>{try{s(n)}catch(r){console.error(`Error in event listener for ${t} event:`,r)}})}}const gc=new uc,It=new Kt("useSelectionHandler",qt.useSelectionHandler),fc=e=>e?Z.autoScroll.edgeThresholdMobile:Z.autoScroll.edgeThreshold,Nn=Z.autoScroll.scrollSpeed,go=e=>{const n=e.target.closest("[data-canvas-container]");if(!n)return console.warn("Canvas container not found, falling back to offsetX/Y"),{x:e.offsetX,y:e.offsetY};const s=n.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}},hc=()=>{var d;const e=_.getState(),t=e.uiState.mode,n=(d=e.uiState)==null?void 0:d.isPanning,s=e.setSelectionBox,r=e.setPendingSelectionStart,a=e.setSelectedNodes,i=e.setNodeToFocusId,l=e.arrow.setSelected,c=Zt();return v.useCallback(u=>{var y,j;const h=go(u);if(t===W.MOVE)return;const f=u.target,g=f.closest("[data-node-id]"),x=f.closest("[data-arrow-id]"),p=f.closest("[data-ui-panel]"),m=f.closest("[data-grid-svg]"),w=m&&m.getAttribute("data-grid-active")==="true",S=!!f.closest("foreignObject");if((t===W.SELECT||t===W.GRID||t===W.WRITE||t===W.VIM)&&(u.button===0||u.button===-1)&&!n){if(g||x||p||w||S)return;const N=u.shiftKey&&!u.ctrlKey&&!u.metaKey,C=e.projectCanvas.getActive(),I=(C==null?void 0:C.coreState.selectedNodes)??[],R=(C==null?void 0:C.coreState.nodes)??[],A=(C==null?void 0:C.viewState.scale)??1,k=(C==null?void 0:C.viewState.offset)??{x:0,y:0};if(N&&I.length>0){const D=Qe(h,A,k),O=I[I.length-1],M=[{x:O.x,y:O.y},{x:O.x+(O.width??0),y:O.y},{x:O.x,y:O.y+(O.height??0)},{x:O.x+(O.width??0),y:O.y+(O.height??0)}];let $=M[0],P=0;M.forEach(ee=>{const oe=Math.sqrt(Math.pow(ee.x-D.x,2)+Math.pow(ee.y-D.y,2));oe>P&&(P=oe,$=ee)});const F={x:Math.min($.x,D.x),y:Math.min($.y,D.y),width:Math.abs($.x-D.x),height:Math.abs($.y-D.y)},U=R.filter(ee=>{const oe=uo(ee);return qn(oe,F)}),L=new Set(I.map(ee=>ee.id)),G=U.filter(ee=>!L.has(ee.id)),q=[...I,...G];a(q);return}if(It.log("Selection Mouse Down on Background:",h.x,h.y),t===W.WRITE){const D=e.projectCanvas.getActive(),O=(D==null?void 0:D.viewState.scale)??1,M=(D==null?void 0:D.viewState.offset)??{x:0,y:0},$=Qe(h,O,M);Aa(async()=>{const{CanvasNodeBuilderV2:P}=await Promise.resolve().then(()=>Ll);return{CanvasNodeBuilderV2:P}},void 0).then(({CanvasNodeBuilderV2:P})=>{const F=P.buildTextNode($,"");F.isEditing=!0,e.addNode(F,""),e.setNodeToFocusId(F.id)});return}const b=(y=_.getState().uiState)==null?void 0:y.pendingSelectionStart,T=(j=_.getState().uiState)==null?void 0:j.selectionBox;if(b&&T){r(null);return}const E=Qe(h,A,k);r(E),a([]),l([]),i(null),(!c||u.pointerType!=="touch")&&s({start:h,end:h})}},[t,n,s,r,a,i,l,c,e])},pc=()=>{const e=_.getState(),t=e.setSelectionBox,n=e.setActiveCanvasViewState,s=B(u=>u.uiState),r=s==null?void 0:s.selectionBox,a=Zt(),i=v.useRef(null),l=v.useRef({x:0,y:0}),c=v.useRef(null),d=v.useCallback(()=>{var p,m;const u=_.getState().projectCanvas.getActive(),h=(p=_.getState().uiState)==null?void 0:p.selectionBox;if(!u||!h){i.current!==null&&(cancelAnimationFrame(i.current),i.current=null);return}const f=u.viewState.offset;let g=0,x=0;if(g=l.current.x,x=l.current.y,g!==0||x!==0){n(S=>({...S,offset:{x:f.x+g,y:f.y+x}}));const w=(m=_.getState().uiState)==null?void 0:m.selectionBox;if(w){const S={x:w.start.x+g,y:w.start.y+x};t({start:S,end:w.end})}}i.current=requestAnimationFrame(d)},[n,t]);return v.useEffect(()=>()=>{i.current!==null&&cancelAnimationFrame(i.current)},[]),v.useEffect(()=>{r||(c.current=null)},[r]),v.useCallback(u=>{var D,O,M;const h=go(u),f=(D=_.getState().uiState)==null?void 0:D.pendingSelectionStart,g=_.getState().projectCanvas.getActive(),x=(g==null?void 0:g.viewState.scale)??1,p=(g==null?void 0:g.viewState.offset)??{x:0,y:0},m=(u.buttons&1)!==0;if(f&&u.shiftKey&&!m){const $=f.x*x+p.x,P=f.y*x+p.y;t({start:{x:$,y:P},end:h});return}if(f&&!u.shiftKey&&!m){((O=_.getState().uiState)==null?void 0:O.selectionBox)&&t(null);return}if(!r)return;const w=(M=_.getState().uiState)==null?void 0:M.selectionBox;if(!w)return;const S=window.innerWidth,y=window.innerHeight;let j=0,N=0;c.current&&(j=h.x-c.current.x,N=h.y-c.current.y),c.current={x:h.x,y:h.y},t({start:w.start,end:h});const C=u.clientX,I=u.clientY,R=fc(a),A=I<R&&N<0,k=I>y-R&&N>0,b=C<R&&j<0,T=C>S-R&&j>0,E=A||k||b||T;if(E){let $=0,P=0;A&&(P=Nn),k&&(P=-Nn),b&&($=Nn),T&&($=-Nn),l.current={x:$,y:P},i.current===null&&(i.current=requestAnimationFrame(d))}else!E&&i.current!==null&&(cancelAnimationFrame(i.current),i.current=null,l.current={x:0,y:0})},[t,r,d,a])},mc=()=>{var l;const e=_.getState(),t=e.setSelectionBox,n=e.setPendingSelectionStart,s=(l=e.uiState)==null?void 0:l.selectionBox,r=e.projectCanvas.getActive,a=e.setSelectedNodes,i=e.arrow.setSelected;return v.useCallback(c=>{var w,S;const d=go(c),u=r(),h=(u==null?void 0:u.coreState.nodes)??[],f=(u==null?void 0:u.coreState.arrows)??[],g=(u==null?void 0:u.viewState.scale)??1,x=(u==null?void 0:u.viewState.offset)??{x:0,y:0},p=(w=_.getState().uiState)==null?void 0:w.selectionBox,m=(S=_.getState().uiState)==null?void 0:S.pendingSelectionStart;if(p){It.log("Selection Mouse Up:",d.x,d.y),It.log("Stopped Marquee Selection");const y={x:Math.min(p.start.x,d.x),y:Math.min(p.start.y,d.y),width:Math.abs(p.start.x-d.x),height:Math.abs(p.start.y-d.y)},j=Qe({x:y.x,y:y.y},g,x),N=Qe({x:y.x+y.width,y:y.y+y.height},g,x),C={x:j.x,y:j.y,width:N.x-j.x,height:N.y-j.y},I=5;if(y.width<I&&y.height<I){m||(t(null),a([]),i([]));return}const R=h.filter(k=>{const b=uo(k);return qn(b,C)});It.log("Selected Nodes by Marquee:",R.map(k=>k.content)),a(R);const A=f.filter(k=>{const b=dc(k,h),T=qn(b,C);return It.log(">>>> _ >>>> ~ useSelectionHandler.ts:164 ~ arrowBBox:",b),T});It.log("Selected Arrows by Marquee:",A.map(k=>k.id)),i(A),R.length>0&&(gc.dispatch(Ho.SELECTION_BOX_END,{selectedNodes:R}),It.log(`Dispatched ${Ho.SELECTION_BOX_END} event with nodes:`,R.map(k=>k.id))),t(null),n(null)}},[s,r,t,n,a,i])},xc=()=>{const e=un.getState().mousePosition??null,n=_.getState().projectCanvas.getActive,s=n(),r=(s==null?void 0:s.viewState.scale)??1,a=(s==null?void 0:s.viewState.offset)??{x:0,y:0},i=v.useMemo(()=>e?Qe(e,r,a):null,[e,r,a]);return{screenCoords:e,canvasCoords:i}},Je={"I am dragging a node near the <edge> edge":"I am dragging a node near the <edge> edge","I am dragging a node near the top edge":"I am dragging a node near the top edge","I am dragging a node toward the <edge> edge":"I am dragging a node toward the <edge> edge","I am in GRID mode":"I am in GRID mode","I am in MOVE mode":"I am in MOVE mode","I am in SELECT mode":"I am in SELECT mode","I am in WRITE mode":"I am in WRITE mode","I have a canvas with nodes":"I have a canvas with nodes","I have selected a node":"I have selected a node","auto-scroll is active":"auto-scroll is active"},xt={"I click on a node":"I click on a node","I hold Ctrl and click on another node":"I hold Ctrl and click on another node","I hold Ctrl and click on one of the selected nodes":"I hold Ctrl and click on one of the selected nodes","I hold Shift and click on a node":"I hold Shift and click on a node"},wc=e=>e?Z.autoScroll.edgeThresholdMobile:Z.autoScroll.edgeThreshold,Hn=Z.autoScroll.edgeThreshold;let Hr=!1;const vc=e=>{Hr=e};let Ls=0,zr=0;const zn={[Je["I have a canvas with nodes"]]:()=>{const e=_.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.nodes.length)??0)>0},[Je["I have selected a node"]]:()=>{const e=_.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.selectedNodes.length)??0)>0},[Je["I am dragging a node near the top edge"]]:(e,t=Hn)=>_.getState().uiState.dragInfo?(e??Ls)<t:!1,[Je["I am dragging a node near the <edge> edge"]]:(e,t,n,s=Hn)=>{if(!_.getState().uiState.dragInfo)return!1;const i=t??zr,l=n??Ls;switch(e){case"top":return l<s;case"bottom":return l>window.innerHeight-s;case"left":return i<s;case"right":return i>window.innerWidth-s;default:return!1}},[Je["auto-scroll is active"]]:()=>Hr,[Je["I am dragging a node toward the <edge> edge"]]:(e,t,n,s=Hn)=>{if(!_.getState().uiState.dragInfo)return!1;const i=zn[Je["I am dragging a node near the <edge> edge"]](e,void 0,void 0,s);if(!i)return!1;if(t===void 0&&n===void 0)return i;switch(e){case"top":return(n??0)<0;case"bottom":return(n??0)>0;case"left":return(t??0)<0;case"right":return(t??0)>0;default:return!1}}},Sc=(e,t)=>{zr=e,Ls=t},St=Z.autoScroll.scrollSpeed,Wr=(e,t,n=Hn)=>{if(e===null||t===null)return{x:0,y:0};let s=0,r=0;const a=window.innerWidth,i=window.innerHeight;return e<n?s=St:e>a-n&&(s=-St),t<n?r=St:t>i-n&&(r=-St),{x:s,y:r}},yc=(e,t)=>({x:-e.x/t,y:-e.y/t}),Cn={getScrollDeltaForMousePosition:(e,t)=>Wr(e,t),shouldScroll:e=>e.x!==0||e.y!==0,applyDeltaToPosition:(e,t,n)=>({x:Number((e+n.x).toFixed(2)),y:Number((t+n.y).toFixed(2))})},Ht={calculateScrollDelta:(e,t)=>{if(e){const n=Wr(e.x,e.y),s=Cn.shouldScroll(n);return{delta:n,shouldUpdateLastDelta:s}}return{delta:t,shouldUpdateLastDelta:!1}},calculateNewOffset:(e,t)=>({x:e.x+t.x,y:e.y+t.y}),updateNodesForScroll:(e,t,n)=>e.map(s=>{if(t.has(s.id)){const r=Cn.applyDeltaToPosition(s.x,s.y,n);return{...s,...r}}return s}),updateSelectedNodesForScroll:(e,t)=>e.map(n=>{const s=Cn.applyDeltaToPosition(n.x,n.y,t);return{...n,...s}}),updateArrowsForScroll:(e,t,n)=>e.map(s=>{let r=s.startPoint,a=s.endPoint;return s.startNodeId&&t.has(s.startNodeId)&&(r={x:Number((s.startPoint.x+n.x).toFixed(2)),y:Number((s.startPoint.y+n.y).toFixed(2))}),s.endNodeId&&t.has(s.endNodeId)&&(a={x:Number((s.endPoint.x+n.x).toFixed(2)),y:Number((s.endPoint.y+n.y).toFixed(2))}),r!==s.startPoint||a!==s.endPoint?{...s,startPoint:r,endPoint:a}:s}),processAutoScrollFrame:e=>{const{mousePosition:t,lastScrollDelta:n,currentOffset:s,scale:r,nodes:a,selectedNodes:i,arrows:l=[]}=e,{delta:c}=Ht.calculateScrollDelta(t,n);if(!Cn.shouldScroll(c))return{shouldScroll:!1,scrollDelta:c,newOffset:s,updatedNodes:a,updatedSelectedNodes:i,updatedArrows:l};const u=Ht.calculateNewOffset(s,c),h=yc(c,r),f=new Set(i.map(m=>m.id)),g=Ht.updateNodesForScroll(a,f,h),x=Ht.updateSelectedNodesForScroll(i,h),p=Ht.updateArrowsForScroll(l,f,h);return{shouldScroll:!0,scrollDelta:c,newOffset:u,updatedNodes:g,updatedSelectedNodes:x,updatedArrows:p}}},Hs={isShiftPressed:e=>e.shiftKey&&!e.ctrlKey&&!e.metaKey,isCtrlPressed:e=>e.ctrlKey||e.metaKey,noModifiersPressed:e=>!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey},Nc=e=>{const t=_.getState().projectCanvas.getActive();return(t==null?void 0:t.coreState.selectedNodes.some(n=>n.id===e))??!1},bn=()=>{const e=_.getState().projectCanvas.getActive();return(e==null?void 0:e.coreState.selectedNodes)??[]},zs={isClickOnEditingElement:e=>!!e.closest("[data-is-editing='true']"),hasActiveTextSelection:()=>{const e=window.getSelection();return e!==null&&!e.isCollapsed&&e.toString().length>0},getSelectedText:()=>{const e=window.getSelection();return(e==null?void 0:e.toString())??""},isInsideTextInput:e=>{const t=e.tagName.toLowerCase();return t==="textarea"||t==="input"?!0:!!e.closest('textarea, input, [contenteditable="true"]')}},Cc=(e,t)=>{const n=[];for(const s of t)s.startNodeId===e&&s.endNodeId&&n.push(s.endNodeId);return n},bc=(e,t)=>t.filter(n=>n.endNodeId===e).length,Br=(e,t,n,s=!1)=>{const r=new Set(e),a=new Set,i=[...e],l=new Set(e);for(;i.length>0;){const d=i.shift(),u=Cc(d,n);for(const h of u)l.has(h)||t.some(f=>f.id===h)&&(l.add(h),!(s&&bc(h,n)>1)&&(a.add(h),i.push(h)))}return t.filter(d=>a.has(d.id)&&!r.has(d.id))},jc=(e,t)=>{const n=new Set,s=e.filter(r=>r.isCollapsed);for(const r of s)Br([r.id],e,t,!0).forEach(i=>n.add(i.id));return n};let kc=!0;const zo={isDragInProgress:()=>{var t;const e=(t=_.getState().uiState)==null?void 0:t.dragInfo;return e!=null},isDragWithSelectedNodes:()=>{var s;const e=_.getState();if(!((s=e.uiState)==null?void 0:s.dragInfo))return!1;const n=e.projectCanvas.getActive();return((n==null?void 0:n.coreState.selectedNodes.length)??0)>0},isFirstMoveEvent:()=>kc,[Je["I am in SELECT mode"]]:()=>_.getState().uiState.mode===W.SELECT,[Je["I am in GRID mode"]]:()=>_.getState().uiState.mode===W.GRID,[Je["I am in MOVE mode"]]:()=>_.getState().uiState.mode===W.MOVE,[Je["I am in WRITE mode"]]:()=>_.getState().uiState.mode===W.WRITE,canDragInCurrentMode:()=>{const e=_.getState().uiState.mode;return e===W.SELECT||e===W.GRID||e===W.WRITE||e===W.VIM},isPrimaryButton:e=>e.button===0||e.button===-1},en={calculateScreenDelta:e=>{const{screenCoords:t,prevScreenPos:n}=e;if(!t&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:null,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!0};if(t&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:t,newDragDirection:null,isFirstMoveEvent:!0,shouldSkipFrame:!0};if(t&&n){const s={x:t.x-n.x,y:t.y-n.y},r=s.x!==0||s.y!==0?s:null;return{screenDelta:s,newPrevScreenPos:t,newDragDirection:r,isFirstMoveEvent:!1,shouldSkipFrame:!1}}return{screenDelta:{x:0,y:0},newPrevScreenPos:n,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!1}},screenDeltaToCanvasDelta:(e,t)=>({x:e.x/t,y:e.y/t}),checkAutoScrollEdges:e=>{const{screenCoords:t,dragDirection:n,draggedNode:s,scale:r,offset:a,edgeThreshold:i}=e;let l=!1;s&&(l=s.y*r+a.y<=0&&n.y<0);const c=l,d=zn[Je["I am dragging a node toward the <edge> edge"]]("bottom",n.x,n.y,i),u=zn[Je["I am dragging a node toward the <edge> edge"]]("left",n.x,n.y,i),h=zn[Je["I am dragging a node toward the <edge> edge"]]("right",n.x,n.y,i);return{shouldAutoScroll:c||d||u||h}},calculateMouseLeftWindowDelta:e=>{const{lastCoords:t,viewportWidth:n,viewportHeight:s}=e;if(!t)return{shouldStartAutoScroll:!1,scrollDelta:{x:0,y:0}};let r=0,a=0;return t.x<n/2?r=St:r=-St,t.y<s/2?a=St:a=-St,{shouldStartAutoScroll:!0,scrollDelta:{x:r,y:a}}},calculateNodeMoves:e=>{const{canvasDelta:t,draggedNodeId:n,selectedNodes:s,nodes:r,arrows:a,isCtrlPressed:i,isShiftPressed:l}=e,c=Math.round(t.x),d=Math.round(t.y);if(c===0&&d===0)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:s,updatedArrows:a};const u=new Set(s.map(p=>p.id));let h=new Set(u);if(i){const p=l??!1;Br(Array.from(u),r,a,p).forEach(w=>h.add(w.id))}if(h.size===0)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:s,updatedArrows:a};const f=r.map(p=>h.has(p.id)?{...p,x:Number((p.x+t.x).toFixed(2)),y:Number((p.y+t.y).toFixed(2))}:p),g=s.map(p=>h.has(p.id)?{...p,x:Number((p.x+t.x).toFixed(2)),y:Number((p.y+t.y).toFixed(2))}:p),x=a.map(p=>{let m=p.startPoint,w=p.endPoint;return p.startNodeId&&h.has(p.startNodeId)&&(m={x:Number((p.startPoint.x+t.x).toFixed(2)),y:Number((p.startPoint.y+t.y).toFixed(2))}),p.endNodeId&&h.has(p.endNodeId)&&(w={x:Number((p.endPoint.x+t.x).toFixed(2)),y:Number((p.endPoint.y+t.y).toFixed(2))}),m!==p.startPoint||w!==p.endPoint?{...p,startPoint:m,endPoint:w}:p});return{shouldUpdate:!0,updatedNodes:f,updatedSelectedNodes:g,updatedArrows:x}}},Ic=(e,t)=>{const n=[{x:e.x,y:e.y},{x:e.x+(e.width??0),y:e.y},{x:e.x,y:e.y+(e.height??0)},{x:e.x+(e.width??0),y:e.y+(e.height??0)}];let s=n[0],r=0;return n.forEach(a=>{const i=Math.sqrt(Math.pow(a.x-t.x,2)+Math.pow(a.y-t.y,2));i>r&&(r=i,s=a)}),s},Rc=(e,t)=>({x:Math.min(e.x,t.x),y:Math.min(e.y,t.y),width:Math.abs(e.x-t.x),height:Math.abs(e.y-t.y)}),Ac=(e,t)=>e.filter(n=>{const s=uo(n);return qn(s,t)}),Ec=(e,t)=>{const n=new Set(e.map(r=>r.id)),s=t.filter(r=>!n.has(r.id));return[...e,...s]},cn={[xt["I hold Shift and click on a node"]]:(e,t)=>{const s=_.getState().projectCanvas.getActive(),r=(s==null?void 0:s.coreState.selectedNodes)??[],a=(s==null?void 0:s.coreState.nodes)??[];if(r.length===0)return[e];const i=r[r.length-1],l=Ic(i,t),c=Rc(l,t),d=Ac(a,c);return Ec(r,d)},[xt["I hold Ctrl and click on one of the selected nodes"]]:e=>bn().filter(n=>n.id!==e.id),[xt["I hold Ctrl and click on another node"]]:e=>[...bn(),e],[xt["I click on a node"]]:(e,t)=>t?bn():[e],handleNodeMouseDown:e=>{const{node:t,event:n,canvasCoords:s}=e,r=bn(),a=Nc(t.id);if(Hs.isShiftPressed(n)&&r.length>0)return{action:"shift_select",shouldStartDrag:!1,newSelection:cn[xt["I hold Shift and click on a node"]](t,s)};if(Hs.isCtrlPressed(n))return a?{action:"ctrl_toggle_remove",shouldStartDrag:!1,newSelection:cn[xt["I hold Ctrl and click on one of the selected nodes"]](t)}:{action:"ctrl_toggle_add",shouldStartDrag:!0,newSelection:cn[xt["I hold Ctrl and click on another node"]](t),dragStartOffset:{x:s.x-t.x,y:s.y-t.y}};const i=cn[xt["I click on a node"]](t,a);return{action:a?"keep_selection":"replace_selection",shouldStartDrag:!0,newSelection:i,dragStartOffset:{x:s.x-t.x,y:s.y-t.y}}}},dn=new Kt("useNodeDragHandler",qt.useCanvasMouseEventsV2),Tc=e=>{const t=_.getState(),n=t.setDragInfo,s=t.setSelectedNodes;return v.useCallback(r=>{const a=_.getState().getCanvasMouseCoords();if(!zo.canDragInCurrentMode()||!zo.isPrimaryButton(r))return;r.stopPropagation();const i=r.target;if(zs.isClickOnEditingElement(i)){dn.log("Node Mouse Down: Clicked on editing node, skipping drag initialization");return}if(!a){dn.warn("Node Mouse Down: Canvas coordinates not available.");return}const l=cn.handleNodeMouseDown({node:e,event:r,canvasCoords:a});s(l.newSelection),dn.log(`Node Mouse Down: ${l.action}`,e.id,"Selection count:",l.newSelection.length),l.shouldStartDrag&&l.dragStartOffset&&(n({draggedNodeId:e.id,dragStartOffset:l.dragStartOffset}),dn.log("Node Drag Start on:",e.id))},[e,n,s])},Mc=()=>{var g,x;const e=_.getState(),t=(g=e.uiState)==null?void 0:g.dragInfo,n=e.setActiveCanvasCoreState,s=e.setActiveCanvasViewState,{canvasCoords:r}=xc(),a=Zt(),i=e.projectCanvas.getActive,l=((x=i())==null?void 0:x.coreState.selectedNodes)??[],c=v.useRef(null),d=v.useRef({x:0,y:0}),u=v.useRef(null),h=v.useRef({x:0,y:0});v.useEffect(()=>{t&&(u.current=null)},[t]);const f=v.useCallback(()=>{var S;const p=_.getState().projectCanvas.getActive(),m=(S=_.getState().uiState)==null?void 0:S.dragInfo;if(!p||!m){c.current!==null&&(cancelAnimationFrame(c.current),c.current=null);return}const w=Ht.processAutoScrollFrame({mousePosition:un.getState().mousePosition??null,lastScrollDelta:d.current,currentOffset:p.viewState.offset,scale:p.viewState.scale,nodes:p.coreState.nodes,selectedNodes:p.coreState.selectedNodes,arrows:p.coreState.arrows||[]});w.shouldScroll&&(d.current=w.scrollDelta,s(y=>({...y,offset:w.newOffset})),n(y=>({...y,nodes:w.updatedNodes,selectedNodes:w.updatedSelectedNodes,arrows:w.updatedArrows}))),c.current=requestAnimationFrame(f)},[s,n]);return v.useEffect(()=>()=>{c.current!==null&&cancelAnimationFrame(c.current)},[]),v.useCallback(p=>{if(!t||l.length===0)return;const m=un.getState().mousePosition??null,w=en.calculateScreenDelta({screenCoords:m,prevScreenPos:u.current});if(w.newPrevScreenPos!==null&&(u.current=w.newPrevScreenPos),w.newDragDirection&&(h.current=w.newDragDirection),w.shouldSkipFrame)return;const S=_.getState().projectCanvas.getActive();if(!S)return;const y=S.viewState.scale,j=en.screenDeltaToCanvasDelta(w.screenDelta,y);if(m){Sc(m.x,m.y);const I=S.coreState.nodes.find(k=>k.id===t.draggedNodeId),R=wc(a),A=en.checkAutoScrollEdges({screenCoords:m,dragDirection:h.current,draggedNode:I,scale:y,offset:S.viewState.offset,edgeThreshold:R});vc(A.shouldAutoScroll),A.shouldAutoScroll&&c.current===null?c.current=requestAnimationFrame(f):!A.shouldAutoScroll&&c.current!==null&&(cancelAnimationFrame(c.current),c.current=null)}else if(c.current===null){const I=en.calculateMouseLeftWindowDelta({lastCoords:un.getState().mousePosition??null,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight});I.shouldStartAutoScroll&&(d.current=I.scrollDelta,c.current=requestAnimationFrame(f))}const N=p.target;if(zs.isClickOnEditingElement(N)||zs.hasActiveTextSelection())return;const C=en.calculateNodeMoves({canvasDelta:j,draggedNodeId:t.draggedNodeId,selectedNodes:l,nodes:S.coreState.nodes,arrows:S.coreState.arrows||[],isCtrlPressed:Hs.isCtrlPressed(p),isShiftPressed:p.shiftKey});C.shouldUpdate&&(n(I=>({...I,nodes:C.updatedNodes,selectedNodes:C.updatedSelectedNodes,arrows:C.updatedArrows})),e.setUiState(I=>({...I,lastUpdatedNodeId:t.draggedNodeId})))},[t,r,n,l,f,a])},Dc=()=>{var s;const e=_.getState(),t=(s=e.uiState)==null?void 0:s.dragInfo,n=e.setDragInfo;return v.useCallback(r=>{if(t){dn.log("Node Drag End (Pointer Up on):",t.draggedNodeId);const a=_.getState().projectCanvas.getActive(),i=(a==null?void 0:a.coreState.arrows)??[];((a==null?void 0:a.coreState.nodes)??[]).find(c=>c.id===t.draggedNodeId),i.filter(c=>c.startNodeId===t.draggedNodeId||c.endNodeId===t.draggedNodeId),n(null)}},[t,n])},jn=20,wt=(e,t)=>{const n=_.getState(),s=n.uiState.mode,r=n.setResizingNode;return v.useCallback(a=>{if(s!==W.SELECT||a.button!==0&&a.button!==-1)return;a.stopPropagation();const i=n.projectCanvas.getActive(),l=(i==null?void 0:i.viewState.scale)??1,c=(i==null?void 0:i.viewState.offset)??{x:0,y:0},d={x:a.clientX,y:a.clientY},u=Qe(d,l,c),h=i==null?void 0:i.coreState.nodes.find(g=>g.id===e.id),f={x:(h==null?void 0:h.x)??e.x,y:(h==null?void 0:h.y)??e.y,width:(h==null?void 0:h.width)??e.width??100,height:(h==null?void 0:h.height)??e.height??50};console.log("Resize Start:",e.id,"Handle:",t),r({id:e.id,handle:t,startNodeRect:f,startPointerPos:u})},[e,t,s,r])},Pc=()=>{var s;const e=_.getState(),t=(s=e.uiState)==null?void 0:s.resizingNode,n=e.setActiveCanvasCoreState;return v.useCallback(r=>{if(!t)return;const{id:a,handle:i,startNodeRect:l,startPointerPos:c}=t,d=e.projectCanvas.getActive(),u=(d==null?void 0:d.viewState.scale)??1,h=(d==null?void 0:d.viewState.offset)??{x:0,y:0},f={x:r.clientX,y:r.clientY},g=Qe(f,u,h),x=g.x-c.x,p=g.y-c.y;let m=l.x,w=l.y,S=l.width,y=l.height;i.includes("left")&&(S=Math.round(Math.max(jn,l.width-x)),m=l.x+l.width-S),i.includes("right")&&(S=Math.round(Math.max(jn,l.width+x))),i.includes("top")&&(y=Math.round(Math.max(jn,l.height-p)),w=l.y+l.height-y),i.includes("bottom")&&(y=Math.round(Math.max(jn,l.height+p))),n(j=>{const N=j.nodes.findIndex(R=>R.id===a);if(N===-1)return j;const C=[...j.nodes];C[N]={...C[N],x:m,y:w,width:S,height:y};const I=j.selectedNodes.map(R=>R.id===a?{...R,x:m,y:w,width:S,height:y}:R);return{...j,nodes:C,selectedNodes:I}})},[t,n,e])},_c=()=>{var r;const e=_.getState(),t=(r=e.uiState)==null?void 0:r.resizingNode,n=e.setResizingNode,s=e.updateNode;return v.useCallback(a=>{var i;if(t){const{id:l,handle:c}=t,d=c.includes("top")||c.includes("bottom"),u=c.includes("left")||c.includes("right");if(d)s(l,{options:{lockSize:!0}});else if(u){const h=e.projectCanvas.getActive(),f=h==null?void 0:h.coreState.nodes.find(x=>x.id===l),g=((i=f==null?void 0:f.data)==null?void 0:i.nodeType)==="workflowOrchestration";if(f&&f.content&&f.width&&!g){const x=Mt(f.content,f.width)+Q.NODE_Y_PADDING*2;s(l,{height:x,options:{lockSize:!0}})}}n(null)}},[t,n,s,e])};class Vr{}ze(Vr,"arrows",{canDrawArrow:t=>t.length<=1});const Oc=30,Jn=(e,t)=>{const n=document.elementsFromPoint(e,t);for(const a of n){const i=a.getAttribute("data-row-connector"),l=a.getAttribute("data-node-id");if(i&&l)return{nodeId:l,rowId:i}}const s=document.querySelectorAll("[data-row-connector]");let r=null;return s.forEach(a=>{const i=a.getBoundingClientRect(),l=i.left+i.width/2,c=i.top+i.height/2,d=Math.sqrt(Math.pow(e-l,2)+Math.pow(t-c,2));if(d<=Oc){const u=a.getAttribute("data-row-connector")??"",h=a.getAttribute("data-node-id")??"";u&&h&&(!r||d<r.distance)&&(r={nodeId:h,rowId:u,distance:d})}}),r},$c=Z.arrows.reverseArrowOnMultipleConnect,Ue=new Kt("useArrowDrawingV2",qt.useArrowDrawingV2),Fc=()=>{const e=_.getState(),t=e.uiState.mode,n=e.projectCanvas.getActive(),s=e.arrow.setTemporary,r=e.getCanvasMouseCoords,a=(n==null?void 0:n.coreState.nodes)??[];return v.useCallback(i=>{if(t!==W.DRAW_ARROW)return;Ue.log("Fired in DRAW_ARROW mode.");const l=r();if(!l){Ue.log("No start point found.");return}const c=Vn(l,a),d=(c==null?void 0:c.id)??null;d?Ue.log(`Starting arrow draw from within node: ${d}`):Ue.log("Starting arrow draw from background."),Ue.log("Setting temporary arrow at",l,"with startNodeId:",d),s({startPoint:l,endPoint:l,startNodeId:d}),i.stopPropagation()},[t,r,s,a])},Lc=()=>{const e=_.getState(),t=e.uiState.mode,n=e.projectCanvas.getActive(),s=(n==null?void 0:n.coreState.nodes)??[],r=e.arrow.setTemporary,a=e.uiState.temporaryArrow,i=e.getCanvasMouseCoords;return v.useCallback(l=>{if(t!==W.DRAW_ARROW||!a)return;let c=i();if(!c)return;const d=Jn(l.clientX,l.clientY);d&&(c=Ge(d.nodeId,c,a.startPoint,s,d.rowId)),r({...a,endPoint:c}),l.stopPropagation()},[t,a,i,r,s])},kn=(e,t)=>{const n=_.getState(),s=n.setMode,r=n.arrow.setTemporary,a=n.uiState.mode;return v.useCallback(i=>{if(a!==W.SELECT)return;Ue.log(`useQuickArrowHandleMouseDownHandler: Fired on node ${e.id}, handle ${t}.`),i.stopPropagation();const l=e.width??100,c=e.height??50;let d;switch(t){case"top":d={x:e.x+l/2,y:e.y};break;case"bottom":d={x:e.x+l/2,y:e.y+c};break;case"left":d={x:e.x,y:e.y+c/2};break;case"right":d={x:e.x+l,y:e.y+c/2};break}Ue.log("Switching to DRAW_ARROW mode."),s(W.DRAW_ARROW),Ue.log("Setting temporary arrow from node",e.id),r({startPoint:d,endPoint:d,startNodeId:e.id})},[e,t,r,s,a])},Hc=()=>{const e=_.getState(),t=e.uiState.mode,n=e.projectCanvas.getActive(),s=e.arrow.setTemporary,r=e.arrow.add,a=e.uiState.temporaryArrow,i=e.setMode,l=(n==null?void 0:n.coreState.nodes)??[],c=(n==null?void 0:n.coreState.selectedNodes)??[],d=e.getCanvasMouseCoords;return v.useCallback(u=>{var N;if(t!==W.DRAW_ARROW||!a)return;Ue.log("useArrowMouseUpHandler: Fired.");const h=d();if(!h){Ue.log("No final mouse coords found, resetting."),j();return}const{startPoint:f,startNodeId:g}=a,x=l.find(C=>C.id===g);let p=null,m=null,w=h;const S=Jn(u.clientX,u.clientY);if(S)p=S.nodeId,m=S.rowId,Ue.log("Row connector found:",S);else{const C=Vn(h,l);C&&(((N=C.data)==null?void 0:N.nodeType)==="workflowOrchestration"||(p=C.id)),Ue.log("Target node found:",(C==null?void 0:C.id)??"None")}if(c.forEach(C=>{if(p&&p!==C.id)if(w=Ge(p,h,f,l,m),$c&&c.length>1){Ue.log(`Creating arrow from target node ${p} to selected node ${C.id}`);const R={id:De(10),startPoint:w,endPoint:f,startNodeId:p,endNodeId:C.id??null,startRowId:m,label:""};r(R)}else{Ue.log(`Creating arrow from selected node ${C.id} to target node ${p}`);const R={id:De(10),startPoint:f,endPoint:w,startNodeId:C.id??null,endNodeId:p,endRowId:m,label:""};r(R)}}),c.length===0&&!p){Ue.log("Creating naked arrow.");const C={id:De(10),startPoint:f,endPoint:w,startNodeId:g??null,endNodeId:null,label:""};r(C)}if(p&&p!==(x==null?void 0:x.id)&&c.length===0){w=Ge(p,h,f,l,m),Ue.log(`Creating arrow from selected node ${x==null?void 0:x.id} to target node ${p}`);const C={id:De(10),startPoint:f,endPoint:w,startNodeId:(x==null?void 0:x.id)??null,endNodeId:p,endRowId:m,label:""};Vr.arrows.canDrawArrow(c)&&r(C)}j();function j(){Ue.log("Resetting state."),s(null),i(W.SELECT),u.stopPropagation()}},[t,a,r,s,i,l,c,d])},Wo=(e,t)=>{const n=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(n*n+s*s)},Bo=(e,t)=>({x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}),zc=()=>{const e=_.getState(),t=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,s=e.setIsPanning,r=v.useRef(null),a=v.useRef(null),i=v.useCallback(d=>{const u=t();if(u)if(d.touches.length===1){const h=d.touches[0],f=d.target,g=f.closest("[data-node-id]"),x=f.id.includes("resize-handle-"),p=f.closest("[data-ui-panel]");if(g||x||p){a.current=null;return}a.current={startX:h.clientX,startY:h.clientY,initialOffsetX:u.viewState.offset.x,initialOffsetY:u.viewState.offset.y},s(!0),r.current=null}else if(d.touches.length===2){const h=d.touches[0],f=d.touches[1];r.current={initialDistance:Wo(h,f),initialScale:u.viewState.scale,center:Bo(h,f)},a.current=null,s(!1)}else r.current=null,a.current=null,s(!1)},[t,s]),l=v.useCallback(d=>{const u=t();if(u){if(d.touches.length===1&&a.current){d.preventDefault();const h=d.touches[0],f=h.clientX-a.current.startX,g=h.clientY-a.current.startY;n(x=>({...x,offset:{x:a.current.initialOffsetX+f,y:a.current.initialOffsetY+g}}))}else if(d.touches.length===2&&r.current){d.preventDefault();const{scale:h,offset:f}=u.viewState,g=d.touches[0],x=d.touches[1],p=Wo(g,x);Bo(g,x);const m=p/r.current.initialDistance;let w=r.current.initialScale*m;const{min:S,max:y}=Z.zoom;w=Math.max(S,Math.min(y,w)),w<=.1?w=Math.round(w*100)/100:w=Math.round(w*10)/10;const j=Qe(r.current.center,h,f),N=r.current.center.x-j.x*w,C=r.current.center.y-j.y*w;n(I=>({...I,scale:w,offset:{x:N,y:C}}))}}},[t,n]),c=v.useCallback(d=>{if(d.touches.length===0)r.current=null,a.current=null,s(!1);else if(d.touches.length===1){if(r.current=null,!a.current){const u=_.getState().projectCanvas.getActive();if(u){const h=d.touches[0];a.current={startX:h.clientX,startY:h.clientY,initialOffsetX:u.viewState.offset.x,initialOffsetY:u.viewState.offset.y},s(!0)}}}else d.touches.length>=2&&(a.current=null,s(!1))},[s]);return{handleTouchStart:i,handleTouchMove:l,handleTouchEnd:c}},Qn=new Map;let Ur={targetScreenYRatio:.8,animationDuration:300,stabilizationDelay:10,minKeyboardHeight:100,listenerTimeout:2e3};function Gr(e){var u;const{nodeId:t,nodeY:n,source:s}=e,r=Ur,a=document.querySelector(`[data-node-id="${t}"]`);a==null||a.getBoundingClientRect().top;let i=0,l=null;const c=()=>{var x;const h=window.innerHeight,f=((x=window.visualViewport)==null?void 0:x.height)||window.innerHeight,g=h-f;if(g>r.minKeyboardHeight&&g!==i){i=g,l&&clearTimeout(l),l=setTimeout(()=>{var p;(p=window.visualViewport)==null||p.removeEventListener("resize",c),d()},r.stabilizationDelay);return}},d=()=>{var N;const h=((N=window.visualViewport)==null?void 0:N.height)||window.innerHeight,f=_.getState(),g=f.projectCanvas.getActive(),x=(g==null?void 0:g.viewState.offset)||{x:0,y:0},p=(g==null?void 0:g.viewState.scale)||1,m=document.querySelector(`[data-node-id="${t}"]`),w=m==null?void 0:m.getBoundingClientRect(),S=(w==null?void 0:w.top)??n*p+x.y,j=h*r.targetScreenYRatio-S;f.setActiveCanvasViewState(C=>({...C,targetView:{targetOffset:{x:x.x,y:x.y+j},targetScale:p,animationStartTime:0,animationDuration:r.animationDuration}})),Qn.set(t,j)};(u=window.visualViewport)==null||u.addEventListener("resize",c),setTimeout(()=>{var h;(h=window.visualViewport)==null||h.removeEventListener("resize",c),l&&clearTimeout(l)},r.listenerTimeout)}function Wc(e){var i,l;const t=Ur,n=Qn.get(e);if(!n)return;Qn.delete(e);let s=window.innerHeight-(((i=window.visualViewport)==null?void 0:i.height)||window.innerHeight),r=null;const a=()=>{var h;const c=window.innerHeight,d=((h=window.visualViewport)==null?void 0:h.height)||window.innerHeight,u=c-d;u!==s&&(s=u,r&&clearTimeout(r),r=setTimeout(()=>{var f;if(u<t.minKeyboardHeight){(f=window.visualViewport)==null||f.removeEventListener("resize",a);const g=_.getState(),x=g.projectCanvas.getActive(),{scale:p,offset:m}=(x==null?void 0:x.viewState)||{scale:1,offset:{x:0,y:0}};g.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:{x:m.x,y:m.y-n},targetScale:p,animationStartTime:0,animationDuration:t.animationDuration}}))}},t.stabilizationDelay))};(l=window.visualViewport)==null||l.addEventListener("resize",a),setTimeout(()=>{var c;(c=window.visualViewport)==null||c.removeEventListener("resize",a),r&&clearTimeout(r)},t.listenerTimeout)}function Yr(e){var n;const t=((n=window.visualViewport)==null?void 0:n.height)||window.innerHeight;return e>t/2}const Bc=300,Vc=30,Uc=()=>{const e=v.useRef(null),t=io();return v.useCallback(n=>{const s=_.getState(),r=s.uiState.mode;s.getCanvasMouseCoords;const a=s.addNode,i=s.setNodeToFocusId;if(r!==W.SELECT){e.current=null;return}if(n.target.closest("[data-node-id], [data-arrow-id]")){e.current=null;return}if(n.touches.length===0&&n.changedTouches.length>0){const d=n.changedTouches[0],u={timestamp:Date.now(),x:d.clientX,y:d.clientY};if(e.current){const h=u.timestamp-e.current.timestamp,f=Math.sqrt(Math.pow(u.x-e.current.x,2)+Math.pow(u.y-e.current.y,2));if(h<Bc&&f<Vc){const g=s.projectCanvas.getActive();if(!g){e.current=null;return}const{scale:x,offset:p}=g.viewState,m=t.current;if(!m){e.current=null;return}const w=m.getBoundingClientRect(),S=u.x-w.left,y=u.y-w.top,j=Qe({x:S,y},x,p);if(!j){e.current=null;return}const N=De(10);a({id:N,x:j.x,y:j.y,content:"",type:ie.TEXT,isEditing:!0}),i(N),requestAnimationFrame(()=>{const C=document.querySelector(`#NodeContainerV2-${N} .markdown-textarea`);C&&(C.contentEditable="true",C.focus({preventScroll:!0}))}),Yr(u.y)&&Gr({nodeId:N,nodeY:j.y,source:"doubleTap"}),n.preventDefault(),n.stopPropagation(),e.current=null;return}}e.current=u}},[t])},Gc=e=>1-Math.pow(1-e,3),Yc={offset:{x:0,y:0},scale:1,targetView:null},Xc=()=>{const e=B(c=>{var d;return((d=c.projectCanvas.getActive())==null?void 0:d.viewState)??Yc}),t=_.getState(),n=t.projectCanvas.getActive,s=t.setActiveCanvasViewState,r=v.useRef(null),a=v.useRef({x:0,y:0}),i=v.useRef(1),l=v.useRef(!1);v.useEffect(()=>{const c=e.offset,d=e.scale,u=e.targetView;if(u){if(u.animationStartTime===0){const f=performance.now();s(g=>({...g,targetView:g.targetView?{...g.targetView,animationStartTime:f}:null}));return}l.current||(a.current=c,i.current=d,l.current=!0);const h=f=>{var N;const g=(N=n())==null?void 0:N.viewState,x=g==null?void 0:g.targetView;if(!x){r.current&&(cancelAnimationFrame(r.current),r.current=null);return}const p=f-x.animationStartTime,m=Math.min(p/x.animationDuration,1),w=Gc(m),S=a.current.x+(x.targetOffset.x-a.current.x)*w,y=a.current.y+(x.targetOffset.y-a.current.y)*w,j=i.current+(x.targetScale-i.current)*w;s(C=>({...C,offset:{x:S,y},scale:j})),m<1?r.current=requestAnimationFrame(h):(s(C=>({...C,offset:x.targetOffset,scale:x.targetScale,targetView:null})),l.current=!1,r.current=null)};r.current=requestAnimationFrame(h)}return()=>{r.current&&(cancelAnimationFrame(r.current),r.current=null)}},[e,n,s])};class Ws{static isInGivenAreaInCanvas(t,n,s){if(n.x===void 0||n.y===void 0)return!1;let r=!0,a=!0;if(s.xRatio!==void 0){const i=t.x+s.xRatio*t.width;r=n.x>=i}if(s.yRatio!==void 0){const i=t.y+s.yRatio*t.height;a=n.y>=i}return r&&a}static createGridForCanvas(t,n=3){const{width:s,height:r}=t,a=[],i=s/n,l=r/n;for(let c=0;c<=n;c++){const d=[];for(let u=0;u<=n;u++)d.push({x:u*i,y:c*l});a.push(d)}return a}static focusElementAndMoveCursorToEnd(t){if(!t)return;t.hasAttribute("tabindex")||t.setAttribute("tabindex","-1"),t.focus();const n=document.createRange(),s=window.getSelection();if(s)try{n.selectNodeContents(t),n.collapse(!1),s.removeAllRanges(),s.addRange(n)}catch(r){console.error("Failed to set cursor position:",r)}}}ze(Ws,"getCanvasCenter",(t,n,s)=>{if(!t)return console.warn("Container not available for center calculation."),{x:0,y:0};if(!n)return console.warn("Offset not available for center calculation."),{x:0,y:0};const{clientWidth:r,clientHeight:a}=t,i=r/2,l=a/2,c=(i-n.x)/s,d=(l-n.y)/s;return{x:c,y:d}});const In=new Kt("WriteModeHandlerV2",qt.WriteModeHandlerV2);class Kc{constructor(){ze(this,"s")}onKeyDown(t){const n=_.getState();this.s=n;const s=this.s.uiState,a=t.target.closest("#CanvasAppV2"),i=this.s.projectCanvas.getActive(),l=i==null?void 0:i.viewState,c=(l==null?void 0:l.offset)??{x:0,y:0},d=(l==null?void 0:l.scale)??1;if(!a||!l)return In.warn("Canvas or active canvas viewState not available."),!0;if(t.key==="Enter"&&t.ctrlKey){Oe.clientLogsApiClient.sendLogs("ctrl_enter_pressed",{v:1,step:"start"},"write-mode-debug.log");const p=this.s.getEditingNode();if(Oe.clientLogsApiClient.sendLogs("ctrl_enter_current_node",{hasEditingNode:!!p,nodeId:(p==null?void 0:p.id)??null,nodeIsEditing:(p==null?void 0:p.isEditing)??null},"write-mode-debug.log"),!p)return!0;this.s.unselectNodeById(p.id);const m={x:p.x,y:p.y+(p.height??30)+30},w=Ie.buildTextNode(m,"");Oe.clientLogsApiClient.sendLogs("ctrl_enter_next_node_built",{nextNodeId:w.id,nextNodeIsEditing:w.isEditing,position:m},"write-mode-debug.log");const S={x:(0-c.x)/d,y:(0-c.y)/d,width:a.clientWidth/d,height:a.clientHeight/d},y=Ws.isInGivenAreaInCanvas(S,w,{yRatio:Z.writeMode.scrollYRatio});Oe.clientLogsApiClient.sendLogs("ctrl_enter_before_add",{nextNodeId:w.id,willScroll:y},"write-mode-debug.log"),this.addNode(w);const j=_.getState(),N=j.getNodeById(w.id);return Oe.clientLogsApiClient.sendLogs("ctrl_enter_after_add",{nextNodeId:w.id,nodeToFocusId:j.uiState.nodeToFocusId,addedNodeIsEditing:(N==null?void 0:N.isEditing)??null},"write-mode-debug.log"),y&&setTimeout(()=>{n.scrollToNode(w,Z.writeMode.scrollDuration,{verticalOnly:!0})},50),!0}if(s.nodeToFocusId)return!0;const{mode:f}=s;if(f!==W.WRITE)return!1;const g=t.key,x=t.ctrlKey||t.metaKey;if(g.length===1&&!x&&g!=="Enter"){const p=_.getState(),m=p.uiState.writeModeStartPosition,w=m??Ws.getCanvasCenter(a,c,d),S=Ie.buildTextNode(w,"");return this.addNode(S),m&&p.setWriteModeStartPosition(null),In.log(`WRITE Mode: Key "${g}" pressed. Created node ${S.id} at position (${w.x}, ${w.y}) and requested focus.`),!0}return g==="Escape"?(In.log("WRITE Mode: Escape pressed. Global handler will switch mode."),!1):(In.log(`WRITE Mode: Key "${g}" ignored by WriteModeHandler.`),!0)}onKeyUp(t){return!0}addNode(t){Oe.clientLogsApiClient.sendLogs("addNode_start",{nodeId:t.id,isEditingBefore:t.isEditing},"write-mode-debug.log"),t.isEditing=!0,Oe.clientLogsApiClient.sendLogs("addNode_isEditing_set",{nodeId:t.id,isEditingAfter:t.isEditing},"write-mode-debug.log"),this.s.addNode(t,""),Oe.clientLogsApiClient.sendLogs("addNode_added_to_state",{nodeId:t.id},"write-mode-debug.log"),this.s.setNodeToFocusId(t.id),Oe.clientLogsApiClient.sendLogs("addNode_focus_set",{nodeId:t.id,nodeToFocusId:this.s.uiState.nodeToFocusId},"write-mode-debug.log")}}class qc{onMouseDown(t){const n=_.getState(),s=n.uiState,{mode:r,addNodeType:a}=s;if(r!==W.ADD)return!1;const i=n.getCanvasMouseCoords();if(!i)return!1;let l=!1;if(a===ie.TABLE){const c=Ie.buildTableNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(a===ie.TEXTCARD){const c=Ie.buildTextCardNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(a===ie.WORKFLOW_ORCHESTRATION){const c=Ie.buildWorkflowOrchestrationNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(a===ie.WORKFLOW_SOURCE){const c=Ie.buildWorkflowSourceNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(a===ie.WORKFLOW_DEFINITION){const c=Ie.buildWorkflowDefinitionNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(a===ie.OCR){const c=Ie.buildOCRNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(a===ie.IMAGE){const c=Ie.buildImageNode(i);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}return l?(n.setMode(W.SELECT),n.setAddNodeType(null),t.stopPropagation(),!0):!1}}const Zc=()=>{const[e,t]=v.useState(null),n=v.useRef(new Kc),s=v.useRef(new pt),r=v.useRef(new qc),a=Dl(t),i=Pl(),l=_l(t),c=Ol(t),d=$l(),u=Fl(),h=rc(),f=ac(),g=hc(),x=pc(),p=mc(),m=Mc(),w=Dc(),S=Pc(),y=_c(),j=Fc(),N=Lc(),C=Hc(),{handleTouchStart:I,handleTouchMove:R,handleTouchEnd:A}=zc(),k=Uc(),b=_.getState(),T=b.setMode,E=b.setAddNodeType,D=b.uiState,O=Be.useMemo(()=>({pointer:{onPointerDown:M=>{_.getState().uiState.mode===W.ADD&&r.current.onMouseDown(M)||(a(M),g(M),j(M),s.current.onMouseDown(M))},onPointerMove:M=>{i(M),x(M),m(M),S(M),N(M)},onPointerUp:M=>{l(M),p(M),w(M),y(M),C(M)},onPointerLeave:c,onDblClick:u},wheel:d,touch:{onTouchStart:I,onTouchMove:R,onTouchEnd:M=>{A(M),k(M)}},keyboard:{onKeyDown:M=>{n.current.onKeyDown(M),h(M)},onKeyUp:f}}),[a,g,j,i,x,m,S,N,l,p,w,y,C,c,d,I,R,A,h,f,u,k,T,E,D.mode,D.addNodeType,r]);return Rl(O),Xc(),Ml(),null},Jc=({top:e,bottom:t,left:n,right:s,topLeft:r,topRight:a,bottomLeft:i,bottomRight:l,alwaysVisibleBottomLeft:c,isContentVisible:d=!0})=>{const u=Zt(),[h,f]=v.useState({top:!1,bottom:!1,left:!1,right:!1,topLeft:!1,topRight:!1,bottomLeft:!1,bottomRight:!1,alwaysVisibleBottomLeft:!1}),g=p=>{f(m=>({...m,[p]:!m[p]}))},x=(p,m,w)=>o.jsx(Y,{variant:"ghost",size:"icon",onClick:()=>g(p),className:`h-11 w-11 bg-background/30 backdrop-blur-sm hover:bg-background/50 transition-colors ${w}`,"data-prevent-canvas-click":!0,"data-ui-panel":!0,title:`Toggle ${p}`,"data-test":`mobile-toggle-${p}`,children:o.jsx(m,{className:"h-5 w-5 opacity-70"})});return o.jsxs("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},"data-ui-panel":"canvas-overlay","data-test":"canvas-overlay-container",children:[e&&o.jsx("div",{className:"absolute top-2 left-1/2 transform -translate-x-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top",children:e}),d&&t&&o.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom",children:u?o.jsxs("div",{className:"flex flex-col items-center gap-2",children:[h.bottom&&o.jsx("div",{children:t}),x("bottom",Co,"")]}):t}),d&&n&&o.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-left",children:u?o.jsxs("div",{className:"flex flex-row items-center gap-2",children:[x("left",Co,""),h.left&&o.jsx("div",{children:n})]}):n}),d&&s&&o.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-right",children:u?o.jsxs("div",{className:"flex flex-row items-center gap-2",children:[h.right&&o.jsx("div",{children:s}),x("right",jr,"")]}):s}),d&&r&&o.jsx("div",{className:"absolute top-4 left-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-left",children:u?o.jsxs("div",{className:"flex flex-col items-start gap-1",children:[x("topLeft",ni,""),h.topLeft&&o.jsx("div",{children:r})]}):r}),d&&a&&o.jsx("div",{className:"absolute top-2 right-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-right",children:u?o.jsxs("div",{className:"flex flex-col items-end gap-1",children:[x("topRight",_n,""),h.topRight&&o.jsx("div",{children:a})]}):a}),d&&i&&o.jsx("div",{className:"absolute bottom-2 left-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-left",children:u?o.jsxs("div",{className:"flex flex-col items-start gap-1",children:[h.bottomLeft&&o.jsx("div",{children:i}),x("bottomLeft",Ps,"")]}):i}),c&&o.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:d&&i?"5rem":"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-always-visible-bottom-left",children:u?o.jsxs("div",{className:"flex flex-col items-start gap-1",children:[h.alwaysVisibleBottomLeft&&o.jsx("div",{children:c}),x("alwaysVisibleBottomLeft",Ps,"")]}):c}),d&&l&&o.jsx("div",{className:"absolute bottom-2 right-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-right",children:u?o.jsxs("div",{className:"flex flex-col items-end gap-1",children:[h.bottomRight&&o.jsx("div",{children:l}),x("bottomRight",eo,"")]}):l})]})},Qc={offset:{x:0,y:0},scale:1,targetView:null},ed=()=>{var u,h;const e=B(f=>{var g;return((g=f.projectCanvas.getActive())==null?void 0:g.viewState)??Qc}),t=B(f=>f.uiState),n=t==null?void 0:t.selectionBox,s=Xt(f=>f.mousePosition)??null,r=e.scale??1,a=e.offset??{x:0,y:0},i=f=>{const g=Math.max(.01,Math.min(4,f));_.getState().setActiveCanvasViewState(x=>({...x,scale:g}))},l=f=>{let g;f==="up"?r<.1?g=Math.round((r+.01)*100)/100:g=Math.round((r+.1)*10)/10:r<=.1?g=Math.round((r-.01)*100)/100:g=Math.round((r-.1)*10)/10,i(g)},c=f=>{f.key==="ArrowUp"?(f.preventDefault(),l("up")):f.key==="ArrowDown"&&(f.preventDefault(),l("down"))},d=()=>{_.getState().setActiveCanvasViewState(f=>({...f,offset:{x:0,y:0},scale:1,targetView:null}))};return o.jsxs("div",{className:"text-xs p-1 bg-background/30 backdrop-blur-sm rounded pointer-events-auto",children:[o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx("label",{className:"opacity-70",children:"Zoom:"}),o.jsx("input",{type:"number",value:r.toFixed(2),onChange:f=>i(parseFloat(f.target.value)||1),onKeyDown:c,min:"0.01",max:"4.0",step:"any",className:"w-16 px-1 py-0.5 text-xs border-0 rounded bg-background/50","data-test":"canvas-debug-zoom-input"}),o.jsx("button",{onClick:d,className:"px-1.5 py-0.5 text-xs border-0 rounded bg-background/50 hover:bg-background/70 transition-colors",title:"Reset view to 0,0","data-test":"canvas-debug-reset-button",children:"Reset"})]}),o.jsxs("div",{children:["Offset: X: ",((u=a==null?void 0:a.x)==null?void 0:u.toFixed(0))??0,", Y: ",((h=a==null?void 0:a.y)==null?void 0:h.toFixed(0))??0]}),o.jsxs("div",{children:["Mouse:"," ",s?`X: ${s.x.toFixed(0)}, Y: ${s.y.toFixed(0)}`:"N/A"]}),o.jsxs("div",{children:["M+O:"," ",s&&a?`X: ${(s.x-a.x).toFixed(0)}, Y: ${(s.y-a.y).toFixed(0)}`:"N/A"]}),o.jsxs("div",{children:["SelBox:",n?o.jsxs(o.Fragment,{children:[o.jsx("div",{children:`S:(${n.start.x.toFixed(0)},${n.start.y.toFixed(0)})`}),o.jsx("div",{children:` E:(${n.end.x.toFixed(0)},${n.end.y.toFixed(0)})`})]}):"N/A"]})]})},tt=e=>{const{className:t,mainAction:n,dropdownActions:s=[],dropdownColumns:r,variant:a,size:i,dropdownMenuClassName:l,dropdownTriggerButtonId:c="options-menu-button",dropdownPosition:d="bottom",dropdownHorizontalAlign:u="container-right",persistenceKey:h,...f}=e,g=r&&r.length>0,x=g?r.flatMap(P=>P.actions):s,[p,m]=v.useState(!1),w=v.useRef(null),S=v.useRef(null),[y,j]=v.useState(u),[N,C]=v.useState(d),[I,R]=v.useState(!1),A=()=>h?_.getState().getSegmentedButtonAction(h):null,[k,b]=v.useState(A),T=P=>{P.stopPropagation(),m(F=>(F||R(!1),!F))},E=()=>{if(k){const P=x.find(F=>F.label===k);P&&!P.disabled&&P.onClick?P.onClick():n.onClick()}else n.onClick()},D=(P,F)=>{P(),b(F),h&&_.getState().setSegmentedButtonAction(h,F),m(!1)};v.useEffect(()=>{if(p&&S.current&&w.current){const P=S.current,F=w.current,U=P.getBoundingClientRect();F.getBoundingClientRect();const L=window.innerWidth,G=window.innerHeight,q=16,ee=U.right>L-q,oe=U.left<q;j(ee&&!oe?"container-right":oe&&!ee?"container-edge-right":u);const ge=U.bottom>G-q,me=U.top<q;C(ge&&!me?"top":me&&!ge?"bottom":d),R(!0)}},[p,u,d]),v.useEffect(()=>{const P=F=>{const U=F.target;w.current&&w.current.contains(U)||U.closest("[data-radix-popper-content-wrapper]")||U.closest("[data-radix-select-viewport]")||U.closest('[role="listbox"]')||m(!1)};return p?document.addEventListener("pointerdown",P):document.removeEventListener("pointerdown",P),()=>{document.removeEventListener("pointerdown",P)}},[p]);const O=x&&x.length>0;let M=n.text||n.label;if(k){const P=x.find(F=>F.label===k);P&&(M=P.label)}const $=P=>{const F=P.target;F.closest("[data-radix-select-trigger]")||F.closest('[role="combobox"]')||P.stopPropagation()};return o.jsxs("div",{id:"UiSegmentedButton",ref:w,"data-prevent-canvas-click":!0,className:je("ui-segmented-button","relative inline-flex items-stretch",t),...f,children:[o.jsx(Nt,{delayDuration:300,children:o.jsxs(Ct,{children:[o.jsx(bt,{asChild:!0,children:o.jsxs(Y,{variant:a,size:i,onClick:P=>{P.stopPropagation(),E()},"aria-label":n.label,disabled:n.disabled,className:je("ui-segmented-button__main-action",{"rounded-r-none":O,"border-r-0":O&&a==="outline","focus:z-10":O}),children:[n.icon,n.text&&o.jsx("span",{children:n.text})]})}),o.jsx(jt,{children:o.jsx("p",{children:M})})]})}),O&&o.jsxs(o.Fragment,{children:[o.jsx(Y,{id:c,variant:a,size:i,onClick:T,"aria-haspopup":"true","aria-expanded":p,"aria-label":"Toggle dropdown options",disabled:n.disabled||!x.some(P=>!P.disabled),className:je("ui-segmented-button__dropdown-trigger","rounded-l-none",i!=="icon"&&"px-1",{"focus:z-10":O}),children:o.jsx(Dt,{className:"ui-segmented-button__caret-icon w-1.5 h-2.5"})}),p&&o.jsx("div",{ref:S,onPointerDown:$,onPointerUp:$,onClick:$,className:je("ui-segmented-button__dropdown-menu","absolute w-56 rounded-md shadow-lg z-10","bg-popover text-popover-foreground border","transition-opacity duration-75",{"opacity-0 pointer-events-none":!I,"opacity-100":I,"right-0":y==="container-right","left-full":y==="container-edge-right"||y==="middle-right","-translate-x-1/2":y==="middle-right"},N==="top"?`${y==="container-right"?"origin-bottom-right":"origin-bottom-left"} bottom-full mb-2`:`${y==="container-right"?"origin-top-right":"origin-top-left"} mt-[28px]`,l),role:"menu","aria-orientation":"vertical","aria-labelledby":c,children:g?o.jsx("div",{className:"grid gap-2 p-2",style:{gridTemplateColumns:r.some(P=>P.width)?r.map(P=>P.width||"1fr").join(" "):`repeat(${r.length}, 1fr)`},role:"none","data-test":"segmented-button-multi-column",children:r.map((P,F)=>o.jsxs("div",{className:"flex flex-col gap-1","data-test":`segmented-button-column-${F}`,children:[P.header&&o.jsx("span",{className:"text-xs font-medium text-muted-foreground px-1",children:P.header}),P.actions.map((U,L)=>U.customRender?o.jsx("div",{children:U.customRender()},L):o.jsxs(Y,{variant:"ghost",size:"sm",onClick:()=>D(U.onClick,U.label),disabled:U.disabled,className:"h-7 px-2 justify-start",role:"menuitem",title:U.label,"data-test":`segmented-button-action-${U.label.toLowerCase().replace(/\s+/g,"-")}`,children:[U.icon&&o.jsx("span",{className:"mr-1",children:U.icon}),o.jsx("span",{className:"text-xs",children:U.label}),U.selected&&o.jsx(pn,{className:"ml-auto h-3 w-3"})]},L))]},F))}):o.jsx("div",{className:"py-1",role:"none",children:s.map((P,F)=>P.customRender?o.jsx("div",{children:P.customRender()},F):o.jsxs(Y,{variant:"ghost",size:"sm",onClick:()=>D(P.onClick,P.label),disabled:P.disabled,className:je("ui-segmented-button__dropdown-item","w-full justify-start text-left font-normal"),role:"menuitem",children:[P.icon&&o.jsx("span",{className:"mr-2",children:P.icon})," ",P.label,P.selected&&o.jsx(pn,{className:"ml-auto h-4 w-4"})]},F))})})]})]})},td=e=>{const{className:t,variant:n}=e,s=_.getState(),r=s.setMode,a=s.setAddNodeType,i=s.setSelectionBox,l=()=>{r(W.ADD),a(ie.TABLE),i(null)},c=()=>{r(W.ADD),a(ie.TEXTCARD),i(null)},d=()=>{r(W.ADD),a(ie.WORKFLOW_ORCHESTRATION),i(null)},u=()=>{r(W.ADD),a(ie.WORKFLOW_SOURCE),i(null)},h=()=>{r(W.ADD),a(ie.WORKFLOW_DEFINITION),i(null)},f=()=>{r(W.ADD),a(ie.OCR),i(null)},g=()=>{r(W.ADD),a(ie.IMAGE),i(null)},x=[{label:"Table",icon:o.jsx(si,{className:"h-2.5 w-2.5"}),onClick:l},{label:"Text Card",icon:o.jsx(oi,{className:"h-2.5 w-2.5"}),onClick:c},{label:"Image",icon:o.jsx(ri,{className:"h-2.5 w-2.5"}),onClick:g},{label:"OCR",icon:o.jsx(On,{className:"h-2.5 w-2.5"}),onClick:f},{label:"Workflow",icon:o.jsx(mn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Source",icon:o.jsx(eo,{className:"h-2.5 w-2.5"}),onClick:u},{label:"WF Runner",icon:o.jsx(Ut,{className:"h-2.5 w-2.5"}),onClick:h}],[p,m]=v.useState(x[0]),w=y=>{m(y),y.onClick()},S=()=>{p.onClick()};return o.jsx("div",{id:"ToolbarAddCustomNode",className:ve("",t),"data-test":"toolbar-add-custom-node-button",children:o.jsx(tt,{size:"sm",variant:n??"default",mainAction:{icon:p.icon,onClick:S,text:"(n)",label:`Add ${p.label}`},dropdownActions:x.map(y=>({...y,onClick:()=>w(y)})),dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})};class nd{constructor(){ze(this,"currentNodeId",null);ze(this,"nodes",[]);ze(this,"yBandThreshold",100)}setNodes(t){this.nodes=t}setCurrentNode(t){this.currentNodeId=t}getCurrentNodeId(){return this.currentNodeId}getCurrentNode(){return this.currentNodeId?this.nodes.find(t=>t.id===this.currentNodeId)??null:null}getSortedNodes(){return[...this.nodes].sort((t,n)=>t.x!==n.x?t.x-n.x:t.y-n.y)}getCurrentIndex(){return this.getSortedNodes().findIndex(n=>n.id===this.currentNodeId)}getNodesInSameRow(t){return this.nodes.filter(n=>Math.abs(n.y-t.y)<=this.yBandThreshold)}moveLeft(){const t=this.getCurrentIndex();return t<=0?null:this.getSortedNodes()[t-1]??null}moveRight(){const t=this.getCurrentIndex(),n=this.getSortedNodes();return t<0||t>=n.length-1?null:n[t+1]??null}moveUp(){const t=this.getCurrentNode();if(!t)return null;const n=this.nodes.filter(s=>s.y<t.y-this.yBandThreshold);return n.length===0?null:(n.sort((s,r)=>s.y!==r.y?r.y-s.y:Math.abs(s.x-t.x)-Math.abs(r.x-t.x)),n[0]??null)}moveDown(){const t=this.getCurrentNode();if(!t)return null;const n=this.nodes.filter(s=>s.y>t.y+this.yBandThreshold);return n.length===0?null:(n.sort((s,r)=>s.y!==r.y?s.y-r.y:Math.abs(s.x-t.x)-Math.abs(r.x-t.x)),n[0]??null)}moveToLineStart(){const t=this.getCurrentNode();if(!t)return null;const n=this.getNodesInSameRow(t);return n.length===0?null:(n.sort((s,r)=>s.x-r.x),n[0]??null)}moveToLineEnd(){const t=this.getCurrentNode();if(!t)return null;const n=this.getNodesInSameRow(t);return n.length===0?null:(n.sort((s,r)=>r.x-s.x),n[0]??null)}moveToDocumentStart(){return this.getSortedNodes()[0]??null}moveToDocumentEnd(){const t=this.getSortedNodes();return t[t.length-1]??null}moveNext(){return this.moveRight()}movePrev(){return this.moveLeft()}}const Pe=new nd;function sd(e){const t=_.getState();t.setSelectedNodes([e]),Pe.setCurrentNode(e.id),t.scrollToNode(e.id,300)}function nt(e,t){Oe.clientLogsApiClient.sendLogs("vim_execute_navigation",{commandName:t},"vim-client.log");const n=e();return Oe.clientLogsApiClient.sendLogs("vim_navigation_result",{commandName:t,foundNode:!!n,nodeId:(n==null?void 0:n.id)??null},"vim-client.log"),n?(sd(n),!0):!1}let Wn=null;function Vo(e){Wn=e}function Uo(){return _.getState().setMode(W.SELECT),Wn==null||Wn.popIdIf(ot.canvasVim),!0}function od(e){const t=_.getState(),n=t.projectCanvas.getActive(),s=(n==null?void 0:n.coreState.selectedNodes)??[];return s.length>0&&t.setNodeToFocusId(s[0].id),e==null||e.executeCommand(Le.enterInsertMode,""),!0}function rd(e){return _.getState().setNodeToFocusId(null),e==null||e.executeCommand(Le.enterNormalMode,""),!0}const ad=[{key:"i",command:Le.enterInsertMode,desc:"Enter insert mode - edit selected node",execute:(e,t,n)=>od(n),preventUndoRedo:!0},{key:"h",command:Le.cursorLeft,desc:"Move to previous node (left in spatial order)",execute:()=>nt(()=>Pe.moveLeft(),"h"),preventUndoRedo:!0},{key:"l",command:Le.cursorRight,desc:"Move to next node (right in spatial order)",execute:()=>nt(()=>Pe.moveRight(),"l"),preventUndoRedo:!0},{key:"k",command:Le.cursorUp,desc:"Move to node above",execute:()=>nt(()=>Pe.moveUp(),"k"),preventUndoRedo:!0},{key:"j",command:Le.cursorDown,desc:"Move to node below",execute:()=>nt(()=>Pe.moveDown(),"j"),preventUndoRedo:!0},{key:"0",command:Le.cursorLineStart,desc:"Move to first node in row",execute:()=>nt(()=>Pe.moveToLineStart(),"0"),preventUndoRedo:!0},{key:"$",command:Le.cursorLineEnd,desc:"Move to last node in row",execute:()=>nt(()=>Pe.moveToLineEnd(),"$"),preventUndoRedo:!0},{key:"<Shift>$",command:Le.cursorLineEnd,desc:"Move to last node in row",execute:()=>nt(()=>Pe.moveToLineEnd(),"Shift+$"),preventUndoRedo:!0},{key:"gg",command:Le.goToFirstLine,desc:"Move to first node",execute:()=>nt(()=>Pe.moveToDocumentStart(),"gg"),preventUndoRedo:!0},{key:"<Shift>G",command:Le.goToLastLine,desc:"Move to last node",execute:()=>nt(()=>Pe.moveToDocumentEnd(),"Shift+G"),preventUndoRedo:!0},{key:"G",command:Le.goToLastLine,desc:"Move to last node",execute:()=>nt(()=>Pe.moveToDocumentEnd(),"G"),preventUndoRedo:!0},{key:"w",command:Le.cursorWordForwardStart,desc:"Move to next node",execute:()=>nt(()=>Pe.moveNext(),"w"),preventUndoRedo:!0},{key:"b",command:Le.cursorBackwordsStartWord,desc:"Move to previous node",execute:()=>nt(()=>Pe.movePrev(),"b"),preventUndoRedo:!0},{key:"q",command:Le.enterNormalMode,desc:"Exit vim mode",execute:()=>Uo(),preventUndoRedo:!0},{key:"<Escape>",command:Le.enterNormalMode,desc:"Exit vim mode",execute:()=>Uo(),preventUndoRedo:!0}],id=[{key:"<Escape>",command:Le.enterNormalMode,desc:"Exit insert mode - return to normal mode",execute:(e,t,n)=>rd(n),preventUndoRedo:!0}];function ld(){return{[an.NORMAL]:ad,[an.INSERT]:id,[an.VISUAL]:[],[an.ALL]:[]}}function tn(e){var l,c;const t=((l=e.state)==null?void 0:l.activeProjectId)??null,n=t?((c=e.state)==null?void 0:c.projects[t])??null:null,s=(n==null?void 0:n.activeWorkspaceId)??null,r=s?(n==null?void 0:n.workspaces[s])??null:null,a=(r==null?void 0:r.activeCanvasId)??null,i=a?(r==null?void 0:r.canvases[a])??null:null;return{project:n,workspace:r,canvas:i,path:{projectId:t,workspaceId:s,canvasId:a}}}const Go=[],Yo=[],Ce={selectMode:e=>e.uiState.mode,selectIsSelectMode:e=>e.uiState.mode===W.SELECT,selectIsMoveMode:e=>e.uiState.mode===W.MOVE,selectIsDrawArrowMode:e=>e.uiState.mode===W.DRAW_ARROW,selectIsAddTextMode:e=>e.uiState.mode===W.ADD,selectIsAddTableMode:e=>e.uiState.mode===W.ADD,selectIsWriteMode:e=>e.uiState.mode===W.WRITE,selectActiveCanvas:e=>{const{canvas:t}=tn(e);return t},selectActiveCanvasId:e=>{const{path:t}=tn(e);return t.canvasId},selectActiveProjectId:e=>{var t;return((t=e.state)==null?void 0:t.activeProjectId)??null},selectActiveWorkspaceId:e=>{const{path:t}=tn(e);return t.workspaceId},selectAllNodes:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.coreState.nodes)??Go},selectNode:e=>t=>Ce.selectAllNodes(t).find(s=>s.id===e)??null,selectSelectedNodes:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.coreState.selectedNodes)??Go},selectIsNodeSelected:e=>t=>Ce.selectSelectedNodes(t).some(s=>s.id===e),selectAllArrows:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.coreState.arrows)??Yo},selectArrow:e=>t=>Ce.selectAllArrows(t).find(s=>s.id===e)??null,selectSelectedArrows:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.coreState.selectedArrows)??Yo},selectIsArrowSelected:e=>t=>Ce.selectSelectedArrows(t).some(s=>s.id===e),selectArrowsConnectedToNode:e=>t=>Ce.selectAllArrows(t).filter(s=>s.startNodeId===e||s.endNodeId===e),selectCanvasOffset:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.viewState.offset)??{x:0,y:0}},selectCanvasScale:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.viewState.scale)??1},selectCanvasDimensions:e=>({width:e.uiState.canvasWidth??0,height:e.uiState.canvasHeight??0}),selectViewState:e=>{const t=Ce.selectActiveCanvas(e);return(t==null?void 0:t.viewState)??null},selectTemporaryArrow:e=>e.uiState.temporaryArrow,selectSelectionBox:e=>e.uiState.selectionBox,selectDragInfo:e=>e.uiState.dragInfo,selectResizingNode:e=>e.uiState.resizingNode,selectAddNodeType:e=>e.uiState.addNodeType,selectIsDragging:e=>e.uiState.dragInfo!==null,selectIsResizing:e=>e.uiState.resizingNode!==null,selectIsSelectionBoxActive:e=>e.uiState.selectionBox!==null,selectIsDrawingArrow:e=>e.uiState.temporaryArrow!==null,selectHasSelectedNodes:e=>Ce.selectSelectedNodes(e).length>0,selectHasSelectedArrows:e=>Ce.selectSelectedArrows(e).length>0,selectNodeCount:e=>Ce.selectAllNodes(e).length,selectArrowCount:e=>Ce.selectAllArrows(e).length,selectSelectedNodeCount:e=>Ce.selectSelectedNodes(e).length,selectSelectedArrowCount:e=>Ce.selectSelectedArrows(e).length,selectHasContent:e=>{const t=Ce.selectNodeCount(e),n=Ce.selectArrowCount(e);return t>0||n>0},selectIsCanvasEmpty:e=>!Ce.selectHasContent(e),selectCanvasStats:e=>({nodeCount:Ce.selectNodeCount(e),arrowCount:Ce.selectArrowCount(e),selectedNodeCount:Ce.selectSelectedNodeCount(e),selectedArrowCount:Ce.selectSelectedArrowCount(e),hasContent:Ce.selectHasContent(e)}),selectAllProjects:e=>{var t;return((t=e.state)==null?void 0:t.projects)??{}},selectActiveProject:e=>{const{project:t}=tn(e);return t},selectActiveWorkspace:e=>{const{workspace:t}=tn(e);return t}};let Xo=!1;function cd(){const e=window.__vimContainer;if(e)return e;const t=nl.createContainer();return tl.register(t),sl.register(t),ol.register(t),rl.register(t),al.register(t),il.register(t),window.__vimContainer=t,t}function dd(e){if(Xo)return;const t=e.get(ll),n=ld();t.registerCommands(ot.canvasVim,n),Xo=!0}function Ko(e){if(e.getInstanceMap(ot.canvasVim))return;const n={id:ot.canvasVim,mode:an.NORMAL,cursor:{line:0,col:0},lines:[]};e.registerAndInit({vimId:ot.canvasVim,vimState:n})}function ud(){const[e,t]=v.useState(!1),n=v.useRef(null),s=v.useRef(null),r=B(Ce.selectAllNodes),a=B(Ce.selectSelectedNodes),i=B(d=>d.uiState.mode);v.useEffect(()=>{Oe.clientLogsApiClient.sendLogs("vim_mode_init",{v:5},"vim-client.log");const d=cd();return n.current=d.get(Pr),dd(d),Vo(n.current),Oe.clientLogsApiClient.sendLogs("vim_mode_init_complete",{hasVimHandler:!!n.current},"vim-client.log"),()=>{Vo(null)}},[]),v.useEffect(()=>{Pe.setNodes(r)},[r]),v.useEffect(()=>{var u;const d=((u=a[0])==null?void 0:u.id)??null;Pe.setCurrentNode(d)},[a]),v.useEffect(()=>{var h;const d=n.current;if(Oe.clientLogsApiClient.sendLogs("vim_mode_sync_effect",{mode:i,vimEnabled:e,hasVimHandler:!!d,nodeCount:r.length,selectedNodeCount:a.length},"vim-client.log"),!d){Oe.clientLogsApiClient.sendLogs("vim_mode_sync_no_handler",{},"vim-client.log");return}const u=i===W.VIM;if(u&&!e){Oe.clientLogsApiClient.sendLogs("vim_mode_enabling",{activeId:d.activeId,idHistory:JSON.stringify(d.idHistory??[])},"vim-client.log"),Ko(d),d.setActiveId(ot.canvasVim);const f=_.getState();f.setNodeToFocusId(null);const g=f.getEditingNode();g&&f.updateNode(g.id,{isEditing:!1});const x=d.getVimCore(ot.canvasVim);if(x&&x.executeCommand(Le.enterNormalMode,""),Oe.clientLogsApiClient.sendLogs("vim_mode_enabled",{activeId:d.activeId,idHistory:JSON.stringify(d.idHistory??[]),vimModeAfterReset:(h=x==null?void 0:x.getVimState())==null?void 0:h.mode},"vim-client.log"),a.length===0&&r.length>0){const p=s.current,m=p?r.find(w=>w.id===p):null;if(m)_.getState().setSelectedNodes([m]),Pe.setCurrentNode(m.id),_.getState().scrollToNode(m.id,Z.writeMode.scrollDuration);else{const w=Pe.moveToDocumentStart();w&&(_.getState().setSelectedNodes([w]),Pe.setCurrentNode(w.id))}}t(!0)}else!u&&e&&(a.length>0&&(s.current=a[0].id),d.popIdIf(ot.canvasVim),t(!1))},[i,e,r,a]);const l=v.useCallback(d=>{const u=n.current;if(u){if(d){if(Ko(u),u.setActiveId(ot.canvasVim),a.length===0&&r.length>0){const h=Pe.moveToDocumentStart();h&&(_.getState().setSelectedNodes([h]),Pe.setCurrentNode(h.id))}}else u.popIdIf(ot.canvasVim);t(d)}},[r,a]),c=v.useCallback(()=>{l(!e)},[e,l]);return{vimEnabled:e,setVimEnabled:l,toggleVimMode:c}}const gd=e=>{const{className:t,style:n}=e,s=Zt(),r=B(S=>S.uiState.mode),a=B(S=>S.uiState.addNodeType),i=B(S=>S.uiState.zoomSubMode),l=B(S=>S.uiState.writeSubMode),{setVimEnabled:c}=ud(),d=_.getState(),u=d.setMode,h=d.setAddNodeType,f=d.setZoomSubMode,g=d.setWriteSubMode,x=d.toggleWriteSubMode,p=d.saveStateToLocalStorage,m=S=>{r===W.VIM&&S!==W.VIM&&c(!1),S===W.VIM&&c(!0),u(S)},w=()=>{u(W.ADD),h(ie.TEXT)};return o.jsxs("div",{className:ve("p-2 bg-background border shadow pointer-events-auto rounded flex items-center",s?"flex-wrap gap-2 w-full max-w-lg":"space-x-2",t),style:{...n},onMouseDown:S=>S.stopPropagation(),"data-ui-panel":"canvas-toolbar",children:[o.jsxs(Y,{variant:r===W.SELECT?"default":"secondary",size:s?"icon":"sm",onClick:()=>m(W.SELECT),title:"Select (v)","data-test":"canvas-toolbar-select-mode-button",children:[o.jsx(ai,{className:"h-4 w-4"}),!s&&o.jsx("span",{className:"ml-1",children:"(v)"})]}),o.jsxs("div",{className:"relative","data-test":"canvas-toolbar-move-mode-wrapper",children:[o.jsxs(Y,{variant:r===W.MOVE||r===W.ZOOM?"default":"secondary",size:s?"icon":"sm",className:ve(r===W.ZOOM&&i==="zoom:lock"&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{r===W.MOVE?(m(W.ZOOM),f("zoom")):r===W.ZOOM?(document.pointerLockElement&&document.exitPointerLock(),m(W.MOVE)):m(W.MOVE)},title:r===W.ZOOM&&i==="zoom:lock"?"Zoom:Lock Mode (click or Esc to exit)":r===W.ZOOM?"Zoom Mode (h to toggle Pan)":"Pan Mode (h to toggle Zoom)","data-test":"canvas-toolbar-move-mode-button",children:[r===W.ZOOM?o.jsx(ii,{className:"h-4 w-4"}):o.jsx(li,{className:"h-4 w-4"}),!s&&o.jsx("span",{className:"ml-1",children:"(h)"})]}),o.jsx(Nt,{children:o.jsxs(Ct,{delayDuration:200,children:[o.jsx(bt,{asChild:!0,children:o.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-move-mode-info-icon",children:o.jsx(_n,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),o.jsx(jt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-move-mode-info-tooltip",children:o.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-move-mode-info-content",children:[o.jsxs("p",{children:[o.jsx("strong",{children:"Pan Mode (h):"})," Drag to pan the canvas"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"Zoom Mode (h again):"})," Scroll or drag to zoom"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"Zoom:Lock:"})," Double-click canvas to lock zoom, move mouse to zoom"]}),o.jsx("p",{className:"text-muted-foreground",children:"Press 'h' to toggle between Pan and Zoom"})]})})]})})]}),o.jsxs(Y,{variant:r===W.GRID?"default":"secondary",size:s?"icon":"sm",onClick:()=>m(W.GRID),title:"Grid Mode (g)","data-test":"canvas-toolbar-grid-mode-button",children:[o.jsx(ci,{className:"h-4 w-4"}),!s&&o.jsx("span",{className:"ml-1",children:"(g)"})]}),o.jsxs("div",{className:"relative","data-test":"canvas-toolbar-vim-mode-wrapper",children:[o.jsxs(Y,{variant:r===W.VIM?"default":"secondary",size:s?"icon":"sm",onClick:()=>m(W.VIM),title:"Vim Navigation Mode (i)","data-test":"canvas-toolbar-vim-mode-button",children:[o.jsx("span",{className:"text-sm font-bold","data-test":"vim-mode-icon",children:"V"}),!s&&o.jsx("span",{className:"ml-1",children:"(i)"})]}),o.jsx(Nt,{children:o.jsxs(Ct,{delayDuration:200,children:[o.jsx(bt,{asChild:!0,children:o.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-vim-mode-info-icon",children:o.jsx(_n,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),o.jsx(jt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-vim-mode-info-tooltip",children:o.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-vim-mode-info-content",children:[o.jsxs("p",{children:[o.jsx("strong",{children:"Vim Mode:"})," Navigate nodes with vim keybindings"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"h/l:"})," Previous/next node (X-first order)"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"j/k:"})," Node below/above"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"0/$:"})," First/last node in row"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"gg/G:"})," First/last node"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"w/b:"})," Next/previous node"]})]})})]})})]}),o.jsxs(Y,{variant:r===W.DRAW_ARROW?"default":"secondary",size:s?"icon":"sm",onClick:()=>m(W.DRAW_ARROW),"data-test":"canvas-toolbar-draw-arrow-button",children:[o.jsx(Et,{className:"h-4 w-4"}),!s&&o.jsx("span",{className:"ml-1",children:"(a)"})]}),o.jsxs(Y,{variant:r===W.ADD&&a===ie.TEXT?"default":"secondary",size:s?"icon":"sm",onClick:w,title:"Text (t)","data-test":"canvas-toolbar-text-mode-button",children:[o.jsx(di,{className:"h-4 w-4"}),!s&&o.jsx("span",{className:"ml-1",children:"(T)"})]}),o.jsxs("div",{className:"relative","data-test":"canvas-toolbar-write-mode-wrapper",children:[o.jsxs(Y,{variant:r===W.WRITE?"default":"secondary",size:s?"icon":"sm",className:ve(r===W.WRITE&&l===At.AUDIO&&"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 text-white"),onClick:()=>{r===W.WRITE?x():(m(W.WRITE),g(At.WRITE))},title:r===W.WRITE&&l===At.AUDIO?"Write:Audio Mode (a to toggle)":"Write (w, then a for audio)","data-test":"canvas-toolbar-write-mode-button",children:[r===W.WRITE&&l===At.AUDIO?o.jsx(ui,{className:"h-4 w-4"}):o.jsx(gi,{className:"h-4 w-4"}),!s&&o.jsx("span",{className:"ml-1",children:"(w)"})]}),o.jsx(Nt,{children:o.jsxs(Ct,{delayDuration:200,children:[o.jsx(bt,{asChild:!0,children:o.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-write-mode-info-icon",children:o.jsx(_n,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),o.jsx(jt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-write-mode-info-tooltip",children:o.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-write-mode-info-content",children:[o.jsxs("p",{children:[o.jsx("strong",{children:"Write Mode (w):"})," Create nodes with Ctrl+Enter"]}),o.jsxs("p",{children:[o.jsx("strong",{children:"Write:Audio (w, then a):"})," Auto-starts voice recording when creating nodes"]}),o.jsx("p",{className:"text-muted-foreground",children:"Click button again or press 'a' to toggle audio mode"})]})})]})})]}),o.jsx(td,{variant:r===W.ADD&&(a===ie.TABLE||a===ie.TEXTCARD||a===ie.OCR||a===ie.WORKFLOW_ORCHESTRATION||a===ie.WORKFLOW_SOURCE||a===ie.WORKFLOW_DEFINITION)?"default":"secondary"}),o.jsx(Y,{variant:"secondary",size:s?"icon":"sm",onClick:p,title:"Save to Local Storage","data-test":"canvas-toolbar-save-button",children:o.jsx(Pt,{className:"h-4 w-4"})})]})},fd=({startX:e,startY:t,endX:n,endY:s})=>{const r=Math.min(e,n),a=Math.min(t,s),i=Math.abs(e-n),l=Math.abs(t-s);return i===0||l===0?null:o.jsx("div",{className:"absolute border border-ring bg-ring/20 pointer-events-none",style:{left:`${r}px`,top:`${a}px`,width:`${i}px`,height:`${l}px`,zIndex:20}})},hd=({node:e})=>o.jsxs("div",{className:ve("bg-background border border-foreground p-2",e.className),style:{width:e.width?`${e.width}px`:"100px",height:e.height?`${e.height}px`:"50px",whiteSpace:"pre-line"},children:[e.content||"Rect"," "]});class pd{createHighlight(t,n,s){return{id:n??De(),start:t.start,end:t.end,color:t.color,createdAt:s??Date.now()}}validateHighlight(t,n){return t.start<0?{valid:!1,error:"Highlight start cannot be negative"}:t.end>n?{valid:!1,error:`Highlight end (${t.end}) exceeds text length (${n})`}:t.start>=t.end?{valid:!1,error:"Highlight start must be less than end"}:{valid:!0}}findOverlapping(t,n,s,r){const a=(r==null?void 0:r.includeTouching)??!1;return t.filter(i=>a?!(i.end<n||i.start>s):!(i.end<=n||i.start>=s))}deleteHighlight(t,n){return t.filter(s=>s.id!==n)}sortHighlights(t){return[...t].sort((n,s)=>n.start!==s.start?n.start-s.start:n.end-s.end)}}function md(e){if(e instanceof HTMLTextAreaElement){const t=e.selectionStart,n=e.selectionEnd;return t===n?null:{start:t,end:n}}if(e.isContentEditable){const t=window.getSelection();if(!t||t.isCollapsed||t.rangeCount===0)return null;const n=t.getRangeAt(0),s=document.createRange();s.setStart(e,0),s.setEnd(n.startContainer,n.startOffset);const r=s.toString().length,a=r+t.toString().length;return r===a?null:{start:r,end:a}}return null}const xd="rgb(198, 183, 0)";function wd({textareaRef:e,node:t,updateNode:n,enabled:s=!0,defaultColor:r=xd}){const a=v.useRef(new pd),i=v.useCallback(d=>{if(!e.current||!s){console.warn("useTextHighlighting: Cannot apply highlight - textarea not available or disabled");return}const u=md(e.current);if(!u){console.warn("useTextHighlighting: No text selected");return}const h=t.highlights||[],f=a.current.findOverlapping(h,u.start,u.end);if(f.length>0){let S=h;for(const y of f)S=a.current.deleteHighlight(S,y.id);if(n(t.id,{highlights:S.length>0?S:void 0}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const y=window.getSelection();y&&y.collapseToEnd()}console.log("ðŸ—‘ï¸ Highlights removed:",f.length);return}const g=a.current.createHighlight({start:u.start,end:u.end,color:d||r}),x=t.content||"",p=a.current.validateHighlight(g,x.length);if(!p.valid){console.error("useTextHighlighting: Invalid highlight",p.error);return}const m=[...h,g],w=a.current.sortHighlights(m);if(n(t.id,{highlights:w}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const S=window.getSelection();S&&S.collapseToEnd()}console.log("âœ¨ Highlight applied:",{start:u.start,end:u.end,color:g.color})},[e,s,t,n,r]),l=d=>{const u=t.highlights||[],h=a.current.deleteHighlight(u,d);n(t.id,{highlights:h.length>0?h:void 0}),console.log("ðŸ—‘ï¸ Highlight removed:",d)},c=()=>{n(t.id,{highlights:void 0}),console.log("ðŸ§¹ All highlights cleared")};return v.useEffect(()=>{if(!s||!e.current)return;const d=()=>{ln.registerCallback(i)},u=()=>{ln.unregisterCallback(i)},h=e.current;return h.addEventListener("focus",d),h.addEventListener("blur",u),document.activeElement===h&&ln.registerCallback(i),()=>{h.removeEventListener("focus",d),h.removeEventListener("blur",u),ln.unregisterCallback(i)}},[s,e,i]),{applyHighlight:i,removeHighlight:l,clearAllHighlights:c}}function ls(e,t={}){var m;const{duration:n=500,targetScale:s,highlightYOffset:r}=t,a=_.getState(),i=(m=a.projectCanvas.getActive())==null?void 0:m.viewState;if(!i)return;const l=document.getElementById("CanvasAppV2");if(!l)return;const c=l.getBoundingClientRect(),d=c.width/2,u=c.height/2,h=s??i.scale,f=e.x*h,g=e.y*h,x=r!==void 0?g+r*h:g+(e.height||0)*h/2,p={x:d-f-(e.width||0)*h/2,y:u-x};a.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:p,targetScale:h,animationStartTime:performance.now(),animationDuration:n}})),a.setSelectedNodes([e]),a.setNodeToFocusId(e.id)}const vd=({text:e,highlights:t,className:n})=>{const s=v.useRef(null),r=v.useRef(null),[a,i]=v.useState([]),[l,c]=v.useState(0),[d,u]=v.useState(1);v.useEffect(()=>{var p;const f=_.subscribe(m=>{var y;const w=(y=m.projectCanvas.getActive())==null?void 0:y.viewState,S=(w==null?void 0:w.scale)??1;u(S)}),x=(p=_.getState().projectCanvas.getActive())==null?void 0:p.viewState;return u((x==null?void 0:x.scale)??1),f},[]);const h=f=>{var m;if(!f)return;const p=(((m=_.getState().projectCanvas.getActive())==null?void 0:m.coreState.nodes)??[]).find(w=>w.id===f);if(!p){console.warn(`Linked node ${f} not found`);return}ls(p,{duration:400})};return v.useEffect(()=>{var p,m;const f=s.current;if(!f)return;const g=((p=f.parentElement)==null?void 0:p.querySelector("textarea"))||((m=f.parentElement)==null?void 0:m.querySelector(".markdown-textarea"));if(!g)return;c(g.clientWidth);const x=new ResizeObserver(w=>{for(const S of w)S.target===g&&c(g.clientWidth)});return x.observe(g),()=>{x.disconnect()}},[]),v.useEffect(()=>{if(!s.current||!r.current||!t||t.length===0){i([]);return}const f=requestAnimationFrame(()=>{var C,I;if(!s.current||!r.current)return;const g=s.current,x=((C=g.parentElement)==null?void 0:C.querySelector("textarea"))||((I=g.parentElement)==null?void 0:I.querySelector(".markdown-textarea"));if(!x){i([]);return}const p=r.current,m=window.getComputedStyle(x);p.style.font=m.font,p.style.fontSize=m.fontSize,p.style.fontFamily=m.fontFamily,p.style.fontWeight=m.fontWeight,p.style.lineHeight=m.lineHeight,p.style.letterSpacing=m.letterSpacing,p.style.wordSpacing=m.wordSpacing,p.style.padding=m.padding,p.style.paddingLeft=m.paddingLeft,p.style.paddingRight=m.paddingRight,p.style.paddingTop=m.paddingTop,p.style.paddingBottom=m.paddingBottom,p.style.width=`${x.clientWidth}px`,p.style.border="none";const w=parseFloat(m.borderTopWidth)||0,S=parseFloat(m.borderLeftWidth)||0;p.style.top=`${w}px`,p.style.left=`${S}px`,p.style.wordWrap=m.wordWrap,p.style.whiteSpace=m.whiteSpace,p.style.overflowWrap=m.overflowWrap,p.style.boxSizing=m.boxSizing,p.style.textAlign=m.textAlign,p.style.direction=m.direction,p.style.wordBreak=m.wordBreak,p.textContent=e;const y=x.getBoundingClientRect(),j=g.getBoundingClientRect(),N=[];for(const R of t){const A=Math.min(R.start,e.length),k=Math.min(R.end,e.length);if(A>=k)continue;const b=e.substring(A,k);try{const T=document.createRange(),E=p.firstChild;if(!E||E.nodeType!==Node.TEXT_NODE)continue;T.setStart(E,A),T.setEnd(E,k);const D=T.getClientRects();for(let O=0;O<D.length;O++){const M=D[O],$={top:M.top-j.top,left:M.left-j.left},P={top:M.top-y.top,left:M.left-y.left},F=parseFloat(m.borderTopWidth)||0,U=$.top-F,L=parseFloat(m.paddingLeft)||0,G=P.left-L,q=M.width,ee=M.height,oe=U/d,ge=G/d,me=q/d+8,be=ee/d;N.push({id:`${R.id}-${O}`,top:oe,left:ge,width:me,height:be,color:R.color,linkedNodeId:R.linkedNodeId,highlightedText:b})}}catch(T){console.error("Error calculating highlight rect:",T)}}i(N)});return()=>{cancelAnimationFrame(f)}},[e,t,l,d]),!t||t.length===0?null:o.jsxs(o.Fragment,{children:[o.jsx("div",{ref:r,className:ve("mirror-div absolute inset-0 pointer-events-none whitespace-pre-wrap"),"aria-hidden":"true"}),o.jsx("div",{ref:s,className:ve("highlight-renderer","absolute inset-0","z-20","pointer-events-none",n),"aria-hidden":"true",children:a.map(f=>o.jsx("mark",{"data-test":"highlight-mark",className:ve("absolute",f.linkedNodeId?"cursor-pointer pointer-events-auto":"pointer-events-none"),onClick:f.linkedNodeId?()=>h(f.linkedNodeId):void 0,style:{top:`${f.top}px`,left:`${f.left}px`,width:`${f.width}px`,height:`${f.height}px`,backgroundColor:f.color,opacity:.4,borderRadius:"2px"}},f.id))})]})};function Sd(e,t){const n=e.split(`
`);let s=0;for(let r=0;r<n.length;r++){const a=n[r].length,i=s+a;if(t<=i)return r;s=i+1}return n.length-1}function yd(e,t,n=Q.DEFAULT_PADDING,s=Q.LINE_HEIGHT){const r=Sd(e,t.start);return n+r*s+s/2}function Nd({textareaRef:e,onCopy:t,onHighlight:n,onDelete:s,onLink:r,onHighlightAndCreateNode:a,onDefine:i}){const[l,c]=v.useState(!1),[d,u]=v.useState({start:0,end:0}),h=v.useRef({start:0,end:0}),f=v.useRef(null),g=v.useRef(!1);v.useEffect(()=>{const m=()=>{g.current=!0,c(!1)};return pt.registerDismissPopoverCallback(m),()=>{pt.unregisterDismissPopoverCallback()}},[]),v.useEffect(()=>(pt.registerSelectionCallback(m=>{c(m)}),f.current=setInterval(()=>{const m=e.current;if(!m)return;const w=m.selectionStart,S=m.selectionEnd,y=w!==S;y&&((w!==h.current.start||S!==h.current.end)&&(g.current=!1),h.current={start:w,end:S},u({start:w,end:S})),g.current||c(y)},100),()=>{pt.unregisterSelectionCallback(),f.current&&clearInterval(f.current)}),[e]);const x=()=>{const m=e.current;return m?(m.value??"").substring(d.start,d.end):""},p=(m,w)=>{m.preventDefault(),m.stopPropagation(),g.current=!0;const S=e.current;S&&(S.focus(),S.setSelectionRange(d.start,d.end)),w&&w(),setTimeout(()=>{c(!1)},20)};return o.jsx(cl,{inputRef:e,show:l,updateOn:d,offset:{top:4,left:0},children:o.jsxs("div",{className:"text-selection-popover bg-popover text-popover-foreground border border-border rounded-md shadow-lg p-1","data-test":"text-selection-popover",onPointerDown:m=>{m.preventDefault()},style:{touchAction:"none"},children:[o.jsxs("div",{className:"flex items-center gap-1",children:[t&&o.jsx("button",{"data-test":"text-selection-copy-button",onPointerDown:m=>p(m,t),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Create linked node",children:o.jsx(Gt,{className:"w-4 h-4"})}),a&&o.jsx("button",{"data-test":"text-selection-highlight-create-button",onPointerDown:m=>p(m,a),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight & create linked node",children:o.jsx(Gn,{className:"w-4 h-4"})}),i&&o.jsx("button",{"data-test":"text-selection-define-button",onPointerDown:m=>p(m,i),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Define word",children:o.jsx(fi,{className:"w-4 h-4"})}),n&&o.jsx("button",{"data-test":"text-selection-highlight-button",onPointerDown:m=>p(m,n),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight text",children:o.jsx(hi,{className:"w-4 h-4"})}),r&&o.jsx("button",{"data-test":"text-selection-link-button",onPointerDown:m=>p(m,r),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Link to node",children:o.jsx(pi,{className:"w-4 h-4"})}),s&&o.jsx("button",{"data-test":"text-selection-delete-button",onPointerDown:m=>p(m,s),className:"action-button p-2 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors",title:"Delete selection",children:o.jsx(Yt,{className:"w-4 h-4"})})]}),o.jsxs("div",{className:"selection-preview text-xs text-muted-foreground mt-1 px-2 py-1 max-w-[200px] truncate",children:['"',x(),'"']})]})})}const qo=(e,t)=>{const s=_.getState().projectCanvas.getActive();if(!s)return null;const a=(s.coreState.nodes||[]).filter(l=>l.linkedSourceNodeId===e&&Array.isArray(l.tags)&&l.tags.some(c=>c.title===t));return a.length===0?null:Math.max(...a.map(l=>(l.y??0)+(l.height??0)))},Cd=({node:e,isEditing:t,preventEdit:n})=>{const s=d=>({id:Math.random().toString(36).slice(2,10),title:d}),r=d=>({x:(d.x??0)+(d.width??0)/2,y:(d.y??0)+(d.height??0)/2}),a=(d,u)=>{const h=_.getState(),f=()=>Math.random().toString(36).slice(2,10);window.setTimeout(()=>{h.arrow.add({id:f(),startNodeId:d.id,endNodeId:u.id,startPoint:r(d),endPoint:r(u)})},0)},i=v.useCallback(()=>{const d=_.getState(),u=Q.DEFAULT_NODE_WIDTH,h=Q.DEFAULT_NODE_HEIGHT,f=40,g=e.x+(e.width??0)/3-u/2,x=qo(e.id,"left"),p=x!==null?x+f:e.y+(e.height??0)+f,m=Ie.buildTextNodeV2({content:"",linkedSourceNodeId:e.id});m.x=g,m.y=p,m.width=u,m.height=h,m.tags=[s("left")],d.addNode(m,void 0,{dontOverlap:!0}),d.setNodeToFocusId(m.id),a(e,m)},[e]),l=v.useCallback(()=>{const d=_.getState(),u=Q.DEFAULT_NODE_WIDTH,h=Q.DEFAULT_NODE_HEIGHT,f=40,g=e.x+2*(e.width??0)/3-u/2,x=qo(e.id,"right"),p=x!==null?x+f:e.y+(e.height??0)+f,m=Ie.buildTextNodeV2({content:"",linkedSourceNodeId:e.id});m.x=g,m.y=p,m.width=u,m.height=h,m.tags=[s("right")],d.addNode(m,void 0,{dontOverlap:!0}),d.setNodeToFocusId(m.id),a(e,m)},[e]);return!t||n||!(e.content&&e.content.trim().length>0)?null:o.jsxs(o.Fragment,{children:[o.jsx(Y,{"data-test":"create-left-child-node-button",size:"icon",variant:"ghost",className:"create-left-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:d=>{d.stopPropagation(),d.preventDefault(),i()},title:"Create linked node on the left",children:"+"}),o.jsx(Y,{"data-test":"create-right-child-node-button",size:"icon",variant:"ghost",className:"create-right-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${2*(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:d=>{d.stopPropagation(),d.preventDefault(),l()},title:"Create linked node on the right",children:"+"})]})},ms=[];function cs(){const e=B(c=>{var d;return((d=c.projectCanvas.getActive())==null?void 0:d.coreState.selectedNodes)??ms}),t=B(c=>c.updateNode),n=v.useRef(ms);e.length===0?n.current=ms:(e.length!==n.current.length||!e.every((c,d)=>{var u;return c.id===((u=n.current[d])==null?void 0:u.id)}))&&(n.current=e);const s=v.useCallback(c=>{const d=c||n.current;if(d.length===0)return;const u=So(),h=d.map(f=>{if(!(f!=null&&f.id)||!f.content||typeof f.content!="string")return null;const{width:g,height:x}=hn(f.content,u);return g>0?{id:f.id,payload:{...f,width:g,height:x}}:null}).filter(f=>f!==null);h.length>0&&h.forEach(f=>{t(f.id,{width:f.payload.width,height:f.payload.height,options:{...f.payload.options,lockSize:!1}})})},[t]),r=v.useCallback((c,d)=>{const h=(d||n.current).map(f=>{if(!(f!=null&&f.id))return null;const g=f.content||"",p=Vt(g,{containerWidth:c})+Q.NODE_Y_PADDING*2;return{id:f.id,payload:{...f,width:c,height:p,options:{...f.options,lockSize:!0}}}}).filter(f=>f!==null);h.length>0&&h.forEach(f=>{t(f.id,{width:f.payload.width,height:f.payload.height,options:f.payload.options})})},[t]),a=v.useCallback((c,d,u)=>{if(c.length===0)return;const h=u??Z.arrange.gap,f=So();c.map(x=>{if(!(x!=null&&x.id)||!x.content||typeof x.content!="string")return null;const{width:p,height:m}=hn(x.content,f);return p>0?{id:x.id,width:p,height:m}:null}).filter(x=>x!==null).forEach(x=>{t(x.id,{width:x.width,height:x.height,options:{lockSize:!1}})}),setTimeout(()=>{const x=_.getState();let p=d;c.forEach(m=>{const w=x.getNodeById(m.id);w&&(x.updateNode(m.id,{y:p}),p+=(w.height??0)+h)})},10)},[t]),i=v.useRef({fitNodeDimensions:null,setFixedWidth:null,stableSelectedNodes:null});return i.current={fitNodeDimensions:s,setFixedWidth:r,stableSelectedNodes:n.current},v.useMemo(()=>({fitNodeDimensions:s,setFixedWidth:r,fitAndRepositionNodes:a,selectedNodes:n.current}),[s,r,a])}function bd(e){const t=v.useCallback(()=>yo.has(e),[e]);return v.useSyncExternalStore(n=>yo.subscribe(n),t,t)}const jd="type here...",kd=[],Id=e=>{var t;return((t=e.ui)==null?void 0:t.keyboardLanguage)??"english"},Rd=({node:e})=>{var U;const t=v.useRef({}),n=v.useRef(null),s=v.useRef(null),[r,a]=v.useState(!1),[i,l]=v.useState(e.content||""),c=Zt(),d=Ea(Id),u=bd(e.id);v.useEffect(()=>{if(n.current){const L=n.current.getTextArea();L&&(s.current=L)}},[n.current]);const h=B(L=>L.updateNodeContent),f=B(L=>L.updateNode),g=B(L=>L.setMode),x=B(L=>L.uiState.nodeToFocusId),p=B(L=>L.uiState.mode),m=B(L=>L.uiState.writeSubMode),w=B(L=>L.uiState.dragInfo);w==null||w.draggedNodeId,e.id;const S=B(L=>{var G;return((G=L.projectCanvas.getActive())==null?void 0:G.coreState.selectedNodes)??kd}),y=v.useMemo(()=>!!S.some(L=>L.id===e.id),[S,e.id]),j=y&&x===e.id;t.current={updateNodeContent:h,updateNode:f,setMode:g,nodeToFocusId:x,mode:p,writeSubMode:m,dragInfo:w,selectedNodes:S};const{fitNodeDimensions:N}=cs(),C=L=>{const G=L.target.value;l(G),h(e.id,G)},I=v.useCallback(L=>{var Fe;L.preventDefault();const G=L.clipboardData.getData("text"),q=(Fe=n.current)==null?void 0:Fe.getTextArea();if(!q)return;const ee=q.selectionStart,oe=q.selectionEnd,ge=q.value,me=ge.substring(0,ee)+G+ge.substring(oe);q.value=me;const be=ee+G.length;q.setSelectionRange(be,be),l(me),h(e.id,me),setTimeout(()=>{const te=_.getState().getNodeById(e.id);te&&N([te])},10)},[e.id,h,N]),R=v.useCallback(()=>{setTimeout(()=>{const G=_.getState().getNodeById(e.id);G&&N([G])},10)},[e.id,N]);wd({textareaRef:s,node:e,updateNode:f,enabled:r,defaultColor:void 0});const A=v.useCallback(L=>{a(L),f(e.id,{isEditing:L})},[f,e.id]),k=v.useCallback(()=>{var L;h(e.id,i),A(!1),f(e.id,{isEditing:!1}),(L=window.getSelection())==null||L.removeAllRanges(),Qn.has(e.id)&&Wc(e.id)},[e.id,e.width,e.height,h,i,f]),b=v.useCallback(L=>{e.isEditing&&L.shiftKey},[e.isEditing]),T=v.useCallback(()=>{var G;if(!e.isEditing)return;const L=(G=n.current)==null?void 0:G.getTextArea();L&&L.focus()},[e.isEditing]),E=v.useCallback(L=>{if(!L)return"";if("value"in L&&typeof L.value=="string")return L.value;const G=oe=>{let ge="";for(const me of oe.childNodes)if(me.nodeType===Node.TEXT_NODE)ge+=me.textContent||"";else if(me.nodeType===Node.ELEMENT_NODE){const be=me;if(be.tagName==="BR")ge+=`
`;else if(be.tagName==="DIV"||be.tagName==="P"){const Fe=G(be);ge+=Fe+`
`}else ge+=G(be)}return ge};return G(L).replace(/\n+$/,"")},[]),D=v.useCallback(L=>{var H,te,de,xe,Se,z;if(L.key==="Escape"){k(),A(!1),_.getState().uiState.mode!==W.VIM&&g(W.SELECT),(te=(H=n.current)==null?void 0:H.getTextArea())==null||te.blur();return}if(L.key==="Enter"&&L.ctrlKey){const V=(de=n.current)==null?void 0:de.getTextArea(),K=E(V);h(e.id,K);return}const G=(xe=n.current)==null?void 0:xe.getTextArea(),q=E(G),ee=be(q),oe=Fe(q,L.key==="Enter"),ge=(Se=e.options)!=null&&Se.lockSize?e.width:ee,me=(z=e.options)!=null&&z.lockSize?e.height:oe;f(e.id,{width:ge,height:me,isEditing:!0});function be(V,K=Q.DEFAULT_NODE_WIDTH,J=Nr.textNodeXPadding){const we=V.split(/\n|&nbsp;/).map(ue=>Cr(ue)).reduce((ue,ye)=>Math.max(ue,ye),0)+J,Ne=Math.max(we,K);return Math.max(Ne,e.width??0)}function Fe(V,K=!1){var Ne;let se=V.split(/\n|&nbsp;/).length,X=Q.DEFAULT_NODE_HEIGHT;const ne=(Ne=n.current)==null?void 0:Ne.getTextArea();let we=Q.LINE_HEIGHT;if(ne){const ue=window.getComputedStyle(ne).lineHeight;if(ue&&ue!=="normal"){const ye=parseFloat(ue);isNaN(ye)||(we=ye)}}return se===1&&!K?(X=Math.max(X,e.height??0),X):(K&&(se+=1),X+=(se-1)*we,X=Math.max(X,e.height??0),X)}},[k,h,f,e.id,e.width,E]);v.useEffect(()=>{x||A(!1)},[x]),v.useEffect(()=>{!y&&r&&A(!1)},[y,r,A]),v.useEffect(()=>{var G,q;if(!j)return;A(!0),l(e.content||"");const L=(G=n.current)==null?void 0:G.getTextArea();if(L){L.readOnly=!1,L.focus({preventScroll:!0}),L.click();const ee=((q=L.value)==null?void 0:q.length)??0;L.selectionStart=L.selectionEnd=ee}window.setTimeout(()=>{var ge,me;const ee=(ge=n.current)==null?void 0:ge.getTextArea();if(ee&&document.activeElement!==ee){ee.readOnly=!1,ee.focus({preventScroll:!0}),ee.click();const be=((me=ee.value)==null?void 0:me.length)??0;ee.selectionStart=ee.selectionEnd=be}},50)},[j,e.content]),v.useEffect(()=>{var G;const L=(G=n.current)==null?void 0:G.getTextArea();if(L)return L.addEventListener("blur",k),()=>{L.removeEventListener("blur",k)}},[k,e.id]),v.useEffect(()=>{l(e.content||"")},[e.content]);const O=v.useCallback(()=>{const G=_.getState().TextModeHandler;if(G){const q=new G;q&&typeof q.onCopy=="function"&&q.onCopy()}},[]),M=v.useCallback(()=>{var G,q;const L=new KeyboardEvent("keydown",{key:"h",ctrlKey:!0,bubbles:!0});(q=(G=n.current)==null?void 0:G.getTextArea())==null||q.dispatchEvent(L)},[]),$=v.useCallback(()=>{var oe;const L=(oe=n.current)==null?void 0:oe.getTextArea();if(!L)return;const G=L.selectionStart,q=L.selectionEnd,ee=i.substring(0,G)+i.substring(q);l(ee),h(e.id,ee),setTimeout(()=>{var ge,me;(me=(ge=n.current)==null?void 0:ge.getTextArea())==null||me.setSelectionRange(G,G)},0)},[i,e.id,h]),P=v.useCallback(()=>{var ee;if(!((ee=n.current)==null?void 0:ee.getTextArea()))return;const G=new pt,q=new KeyboardEvent("keydown",{key:"!"});G.highlightAndCreateNode(q)},[]),F=v.useCallback(async()=>{var V,K;const L=(V=n.current)==null?void 0:V.getTextArea();if(!L)return;const G=L.selectionStart,q=L.selectionEnd,oe=L.value.substring(G,q);if(!oe.trim())return;const ge=_.getState(),me="rgb(198, 183, 0)",be=await dl(oe.trim(),"English");let Fe;if(G!==q){const J=e.highlights||[],se=J.find(X=>X.start===G&&X.end===q);if(se)Fe=se.id;else{Fe=Math.random().toString(36).slice(2,10);const X={id:Fe,start:G,end:q,color:me,createdAt:Date.now()},ne=[...J,X];ge.updateNode(e.id,{highlights:ne})}}const H=`${oe}

${be.definition}`,te=Ie.buildTextNodeV2({content:H,linkedHighlightId:Fe,linkedSourceNodeId:e.id}),de=$r(L,G,q),xe=(K=ge.projectCanvas.getActive())==null?void 0:K.viewState,Se=(xe==null?void 0:xe.scale)??1;let z=e.y;if(de){const J=de.top/Se;z=e.y+J}if(co(te,{...e,y:z,id:e.id}),Fe){const J=ge.getNodeById(e.id),X=((J==null?void 0:J.highlights)||[]).map(ne=>ne.id===Fe?{...ne,linkedNodeId:te.id}:ne);ge.updateNode(e.id,{highlights:X})}},[e]);return o.jsxs(o.Fragment,{children:[e.linkedHighlightId&&e.linkedSourceNodeId&&y&&S.length===1&&o.jsx("div",{className:"absolute z-50 cursor-pointer","data-test":`text-node-linked-highlight-indicator-${e.id}`,style:{left:`${(e.width||0)+8}px`,top:"4px"},onClick:L=>{var me;L.stopPropagation();const ee=(((me=_.getState().projectCanvas.getActive())==null?void 0:me.coreState.nodes)??[]).find(be=>be.id===e.linkedSourceNodeId);if(!ee)return;const oe=(ee.highlights||[]).find(be=>be.id===e.linkedHighlightId);let ge;oe&&typeof ee.content=="string"&&(ge=yd(ee.content,oe,4,Q.LINE_HEIGHT)),ls(ee,{duration:400,highlightYOffset:ge})},title:"Navigate to source highlight",children:o.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18","data-test":`text-node-linked-highlight-icon-${e.id}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-600 hover:text-yellow-700",children:[o.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),o.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}),o.jsx(Cd,{node:e,isEditing:!!r,preventEdit:!1}),u&&!r&&o.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 z-50",title:"Transcription in progress...","data-test":`text-node-transcription-indicator-${e.id}`}),o.jsxs("div",{className:"relative w-full h-full","data-text-position-container":"true","data-test":`text-node-position-container-${e.id}`,children:[!r&&y&&S.length<=1&&c&&o.jsx("div",{className:"absolute inset-0 z-20 cursor-pointer",onClick:T,onTouchEnd:L=>{L.preventDefault(),T()},"data-text-node-click-overlay":"true","data-test":`text-node-mobile-click-overlay-${e.id}`}),r&&o.jsx(Nd,{textareaRef:s,onCopy:O,onHighlight:M,onDelete:$,onHighlightAndCreateNode:P,onDefine:F,"data-test":`text-node-selection-popover-${e.id}`}),o.jsx(vd,{text:i,highlights:e.highlights,"data-test":`text-node-highlight-renderer-${e.id}`}),o.jsx(Ta,{ref:n,value:i,onChange:C,onPaste:I,onBlur:k,onKeyDown:D,onMouseDown:b,onClick:T,placeholder:jd,readOnly:!r,showFilePicker:!1,showAudioButton:r||u,audioButtonVariant:"muted",autoStartAudioRecording:j&&p===W.WRITE&&m===At.AUDIO,onAudioTranscriptionComplete:R,audioNodeId:e.id,useMarkdown:!0,showBuiltInPopover:!1,keyboard:d,"data-test":`text-node-textarea-${e.id}`,className:ve("relative","m-0 p-1 w-full h-full","min-h-0","resize-none","border",e.className,{"overflow-hidden":!c||!r,"overflow-y-auto":c&&r,"pointer-events-none":!r&&!y||S.length>1,"cursor-text":r,"cursor-default":!r,"select-text":r,"text-muted-foreground":!i&&!r}),style:{zIndex:He.nodeTextarea,textAlign:(U=e.styles)==null?void 0:U.textAlign}})]})]})},Ad=()=>{var a;const e=_.getState(),t=((a=e.projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],n=e.updateNodes,s=v.useMemo(()=>{var i;if(t.length===1)return(i=t[0].styles)==null?void 0:i.textAlign},[t]);return{handleAlignmentChange:v.useCallback(i=>{if(t.length===0)return;const l=t.map(c=>({...c,id:c.id,styles:{...c.styles,textAlign:i}}));n(l)},[t,n]),currentAlignment:s}},Sn=v.forwardRef((e,t)=>{const{className:n,children:s}=e;return o.jsx(Y,{ref:t,id:"ConfigurationButton",variant:"secondary",size:"icon","aria-label":"Configuration button",className:`h-6 w-6 p-0.5 rounded hover:bg-secondary/80 flex-shrink-0 flex items-center justify-center ${n||null}`,...e,children:s})});Sn.displayName="ConfigurationButton";function Ed(e,t,n=!1){let s=null;const r=function(...a){const i=this,l=()=>{s=null,n||e.apply(i,a)},c=n&&!s;s!==null&&clearTimeout(s),s=setTimeout(l,t),c&&e.apply(i,a)};return r.cancel=()=>{s!==null&&(clearTimeout(s),s=null)},r}const Td=Z.text.debounceInput,Md=e=>{const{className:t,content:n,onValueChange:s}=e,[r,a]=v.useState(n),i=v.useCallback(Ed(c=>{s==null||s(c)},Td),[s]),l=c=>{const d=c.target.value;a(d),i(d)};return o.jsx(ul,{id:"CanvasTextEditor",className:ve("h-[90%]","bg-background",t),style:{fontSize:Z.text.fontSize},value:r,onChange:l,"data-test":"canvas-text-editor-textarea"})},Xr=e=>{var u;const{className:t}=e,n=_.getState(),s=n.projectCanvas.getActive(),r=s==null?void 0:s.coreState,a=n.updateNodeSubContent,l=((r==null?void 0:r.selectedNodes)??[])[0],c=(u=l==null?void 0:l.content)==null?void 0:u.toString().slice(0,30),d=v.useCallback(h=>{l&&a(l.id,h)},[l,a]);return o.jsxs(Ma,{children:[o.jsx(Da,{asChild:!0,children:o.jsx(Sn,{id:"CanvasTextEditorButton",className:t,tooltip:"Open Text Editor",variant:"ghost","data-test":"canvas-text-editor-button",children:o.jsx(mi,{})})}),o.jsxs(Pa,{id:"canvas-text-editor-dialog",className:"sm:max-w-[70vw] h-[80vh] bg-secondary",style:{display:"unset"},"aria-describedby":"Text editor dialog",children:[o.jsx(_a,{children:o.jsx(Oa,{children:c})}),o.jsx(Md,{content:l==null?void 0:l.subContent,onValueChange:d})]})]})},Dd=(e=!1,t=!0)=>{const n=_.getState(),s=n.projectCanvas.getActive(),r=(s==null?void 0:s.coreState.selectedNodes)??[],a=n.addNode,i=n.deleteSelectedNodes,l=n.setSelectedNodes,c=n.updateNodes,d=n.arrow.add,{fitAndRepositionNodes:u}=cs(),h=v.useCallback(S=>{if(r.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const y=r[0];if(!y.content||typeof y.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}const j=S==="paragraph"?/(\n\n)/:S==="line"?/(\n)/:S==="comma"?/(,)/:S==="period"?/(\.)/:new RegExp(`([${Q.CUSTOM_CHARACTERS.join("")}])`),N=y.content.split(j),C=[];for(let D=0;D<N.length;D+=2){const O=N[D],M=N[D+1];(O||M)&&C.push(t?(O||"")+(M||""):O||"")}if(C.length===0){console.warn("useNodeSplitter: No segments found after split.");return}if(C.length===1&&C[0]===y.content){console.warn(`useNodeSplitter: No ${S==="paragraph"?"double":S==="line"?"single":S==="comma"?"comma":S==="period"?"period":"custom character"} found to split content. Original node not modified.`);return}const I=y.x,R=y.y;y.width;const A=y.id;e||i();let k=R,b=0;const T=[];let E=R;C.forEach((D,O)=>{const M=S==="comma"||S==="paragraph"||S==="period"||S==="custom"?D.trim():D;if((S==="paragraph"||S==="comma"||S==="period"||S==="custom")&&M===""&&C.length>1)return;const $=Math.min(Es(M),Z.nodeOptions.maxNodeWidth)+Q.NODE_X_PADDING*2,P=Mt(M,$)+Q.NODE_Y_PADDING*2;let F;if(O===0?F=R:F=k+b+Q.NEW_NODE_SEGMENT_SPACING,e&&O===0){c([{id:A,content:M,width:$,height:P}]),k=F,b=P+Q.nodeSpacing,E=F+P+Q.NEW_NODE_SEGMENT_SPACING;return}const L={...Ie.buildTextNodeV2({...y,id:A+"-split-"+O,x:I,y:F,width:$,height:P,content:M})};a(L),T.push(L),e&&d({id:De(10),startNodeId:A,endNodeId:L.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),k=F,b=P+Q.nodeSpacing}),T.length>0&&(l(T),u(T,E))},[r,a,i,l,u,e,t,c,d]),f=v.useCallback(()=>{h("paragraph")},[h]),g=v.useCallback(()=>{h("line")},[h]),x=v.useCallback(()=>{h("comma")},[h]),p=v.useCallback(()=>{h("period")},[h]),m=v.useCallback(()=>{h("custom")},[h]),w=v.useCallback(S=>{if(r.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const y=r[0];if(!y.content||typeof y.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}let j;try{j=new RegExp(`(${S})`,"g")}catch(D){console.error("useNodeSplitter: Invalid regex pattern",D);return}const N=y.content.split(j),C=[];for(let D=0;D<N.length;D+=2){const O=N[D]||"",M=N[D+1]||"",$=t?(O+M).trim():O.trim();$&&C.push($)}if(C.length===0){console.warn("useNodeSplitter: No segments found with regex pattern.");return}if(C.length===1&&C[0]===y.content.trim()){console.warn("useNodeSplitter: Regex pattern did not match content.");return}const I=y.x,R=y.y,A=y.id;e||i();let k=R,b=0;const T=[];let E=R;C.forEach((D,O)=>{if(D==="")return;const M=Math.min(Es(D),Z.nodeOptions.maxNodeWidth)+Q.NODE_X_PADDING*2,$=Mt(D,M)+Q.NODE_Y_PADDING*2;let P;if(O===0?P=R:P=k+b+Q.NEW_NODE_SEGMENT_SPACING,e&&O===0){c([{id:A,content:D,width:M,height:$}]),k=P,b=$+Q.nodeSpacing,E=P+$+Q.NEW_NODE_SEGMENT_SPACING;return}const U={...Ie.buildTextNodeV2({...y,id:A+"-split-"+O,x:I,y:P,width:M,height:$,content:D})};a(U),T.push(U),e&&d({id:De(10),startNodeId:A,endNodeId:U.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),k=P,b=$+Q.nodeSpacing}),T.length>0&&(l(T),u(T,E))},[r,a,i,l,e,t,c,d,u]);return{splitNodeContentByParagraph:f,splitNodeContentByLine:g,splitNodeContentByComma:x,splitNodeContentByPeriod:p,splitNodeContentByCustomCharacter:m,splitNodeContentByRegex:w}};function Pd(e){return!e||e.trim()===""?0:e.trim().split(/\s+/).filter(t=>t.length>0).length}const _d=[".","!","?",":",";"],Od=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","Ph.D","M.D","B.A","M.A","B.S","M.S","Inc","Ltd","Co","Corp","etc","vs","e.g","i.e","a.m","p.m","St","Ave","Blvd","Rd","vol","no"];function $d(e,t){if(t<=0||t>=e.length-1)return!1;let n=t-1;for(;n>=0&&/[a-zA-Z.]/.test(e[n]);)n--;n++;const s=e.substring(n,t);return!!(Od.includes(s)||s.length===1&&/[A-Z]/.test(s)||t>1&&e[t-2]===".")}function Fd(e,t){const n=[".","!","?",","];let s=e.length;for(const r of n){const a=e.indexOf(r,t);a!==-1&&a<s&&(s=a)}return s}function Ld(e,t){const n=[];for(let r=0;r<e.length;r++)e[r]===","&&n.push(r);const s=[];for(let r=0;r<n.length;r++){const a=n[r],i=Fd(e,a+1),l=e.substring(a+1,i).trim();Pd(l)>=t&&s.push(a)}return s}function Zo(e){if(!e)return e;let t="",n=0;for(;n<e.length;){const s=e[n];if(_d.includes(s)){if(s==="."&&$d(e,n)){t+=s,n++;continue}for(t+=s,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(t+=`
`)}else t+=s,n++}return t}function Jo(e,t=3){if(!e)return e;const n=Ld(e,t);if(n.length===0)return e;let s=e;for(let r=n.length-1;r>=0;r--){const a=n[r];let i=a+1;for(;i<s.length&&s[i]===" ";)i++;s=s.substring(0,a+1)+`
`+s.substring(i)}return s}const Kr=["&",";","-",":"];function Qo(e){if(!e)return e;let t="",n=0;for(;n<e.length;){const s=e[n];if(Kr.includes(s)){for(t+=s,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(t+=`
`)}else t+=s,n++}return t}const Hd=()=>{const e=_.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],s=e.updateNodeContent,r=v.useCallback((d,u=3)=>{if(n.length===0){console.warn("useNodeInsideSplitter: No nodes selected.");return}n.forEach(h=>{if(!h.content||typeof h.content!="string"){console.warn(`useNodeInsideSplitter: Node ${h.id} has no content to split.`);return}let f;if(d==="sentence")f=Zo(h.content);else if(d==="smartComma")f=Jo(h.content,u);else if(d==="smartCharacter")f=Qo(h.content);else if(d==="all")f=Zo(h.content),f=Jo(f,u),f=Qo(f);else{console.warn(`useNodeInsideSplitter: Unknown mode "${d}"`);return}if(f===h.content){console.warn(`useNodeInsideSplitter: No ${d==="sentence"?"sentence endings":"qualifying commas"} found in node ${h.id}. Content not modified.`);return}s(h.id,f);const g=e.getSegmentedButtonAction("canvas-fit-width");let x=null;if(g){const S=g.match(/Set width to (\d+)px/);S&&(x=parseInt(S[1],10))}let p,m,w;if(x)m=Vt(f,{containerWidth:x})+Q.NODE_Y_PADDING*2,p=x,w=!0;else{let S;const y=document.querySelector("textarea[data-node-textarea]");if(y){const C=window.getComputedStyle(y).lineHeight;if(C&&C!=="normal"){const I=parseFloat(C);isNaN(I)||(S=I)}}const j=hn(f,S);p=j.width,m=j.height,w=!1}e.updateNode(h.id,{content:f,width:p,height:m,options:{...h.options,lockSize:w}})})},[n,s,e]),a=v.useCallback(()=>{r("sentence")},[r]),i=v.useCallback((d=3)=>{r("smartComma",d)},[r]),l=v.useCallback(()=>{r("smartCharacter")},[r]),c=v.useCallback((d=3)=>{r("all",d)},[r]);return{splitInsideBySentence:a,splitInsideBySmartComma:i,splitInsideBySmartCharacter:l,splitInsideByAll:c}},er="canvas-split-regex-history",tr="canvas-split-before-enabled",zd=10,Wd=({onSplit:e,selectedNodeContent:t=""})=>{const n=v.useCallback(()=>{try{const p=localStorage.getItem(er);return p?JSON.parse(p):[]}catch{return[]}},[]),[s,r]=v.useState(()=>n()[0]||""),[a,i]=v.useState(()=>{try{return localStorage.getItem(tr)==="true"}catch{return!1}}),[l,c]=v.useState(null),[d,u]=v.useState(0);v.useEffect(()=>{try{localStorage.setItem(tr,String(a))}catch(p){console.warn("Failed to save split before preference",p)}},[a]);const h=v.useCallback((p,m)=>p?m?`\\n(?=${p})`:p:"",[]),f=v.useCallback(p=>{if(!p)return;const w=n().filter(y=>y!==p),S=[p,...w].slice(0,zd);try{localStorage.setItem(er,JSON.stringify(S))}catch(y){console.warn("Failed to save regex history",y)}},[n]);v.useEffect(()=>{if(!s){c(null),u(0);return}try{const p=h(s,a),m=new RegExp(`(${p})`,"g");if(c(!0),t){const w=t.match(m);u(w?w.length:0)}else u(0)}catch{c(!1),u(0)}},[s,t,a,h]);const g=v.useCallback(()=>{if(!s||!l)return;f(s);const p=h(s,a);e(p)},[s,l,e,f,a,h]),x=v.useCallback(p=>{p.key==="Enter"&&(p.preventDefault(),p.stopPropagation(),g())},[g]);return o.jsxs("div",{className:"regex-split-item px-3 py-2 space-y-2",onPointerDown:p=>{p.stopPropagation()},style:{touchAction:"none"},children:[o.jsx("div",{className:"text-sm font-medium text-foreground",children:"Split by regex:"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsxs("div",{className:"relative flex-1",children:[o.jsx("input",{type:"text",value:s,onChange:p=>r(p.target.value),onKeyDown:x,placeholder:"Art \\d+",className:je("w-full px-2 py-1 text-sm border rounded","bg-background text-foreground","focus:outline-none focus:ring-2 focus:ring-primary",l===!1&&"border-destructive focus:ring-destructive",l===!0&&"border-green-500 focus:ring-green-500"),onPointerDown:p=>{p.stopPropagation()},style:{touchAction:"auto"},"data-test":"regex-split-pattern-input"}),o.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none",children:[l===!0&&o.jsx(pn,{className:"h-2.5 w-2.5 text-green-500"}),l===!1&&o.jsx(Yn,{className:"h-2.5 w-2.5 text-destructive"})]})]}),o.jsx("button",{onPointerDown:p=>{p.stopPropagation(),g()},disabled:!l,className:je("p-1.5 rounded transition-colors",l?"hover:bg-accent text-accent-foreground cursor-pointer":"opacity-50 cursor-not-allowed"),title:"Execute split",style:{touchAction:"none"},"data-test":"regex-split-execute-button",children:o.jsx(Ut,{className:"h-2.5 w-2.5"})})]}),o.jsxs("div",{children:[o.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[o.jsx("input",{type:"checkbox",checked:a,onChange:p=>i(p.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:p=>{p.stopPropagation()},"data-test":"regex-split-before-checkbox"}),o.jsx("span",{className:"text-muted-foreground",children:"Split before pattern"})]}),a&&s&&o.jsxs("div",{className:"text-xs text-muted-foreground/70 font-mono ml-4 mt-0.5",children:["(\\n(?=",s,"))"]})]}),l&&d>0&&o.jsxs("div",{className:"text-xs text-muted-foreground",children:[d," match",d!==1?"es":""," found"]}),l===!1&&s&&o.jsx("div",{className:"text-xs text-destructive",children:"Invalid regex pattern"})]})},Bd=({onSplit:e})=>{const[t,n]=v.useState(3);return o.jsx("div",{className:"px-2 py-1.5 space-y-1","data-test":"split-smart-comma-config",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("label",{className:"text-[10px] text-muted-foreground whitespace-nowrap",children:"Min words:"}),o.jsx(dt,{type:"number",min:"1",max:"20",value:t,onChange:s=>n(Math.max(1,parseInt(s.target.value)||3)),className:"h-6 w-16 text-xs",onClick:s=>s.stopPropagation(),"data-test":"split-inside-min-words-input"}),o.jsx(Y,{size:"sm",variant:"secondary",className:"h-5 text-xs px-2",onClick:s=>{s.stopPropagation(),e(t)},"data-test":"split-inside-smart-comma-button",children:"Split"})]})})},Vd=({onSplit:e})=>o.jsx(Nt,{delayDuration:300,children:o.jsxs(Ct,{children:[o.jsx(bt,{asChild:!0,children:o.jsxs(Y,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),e()},className:"h-7 px-2 justify-start w-full",children:[o.jsx(Ir,{className:"h-3 w-3 mr-1"}),o.jsx("span",{className:"text-xs",children:"Smart char"})]})}),o.jsx(jt,{side:"right",children:o.jsxs("p",{className:"text-xs",children:["Split after: ",Kr.map(t=>`'${t}'`).join(", ")]})})]})}),Ud=e=>{const{className:t}=e,n=B(C=>{var I;return((I=C.preferences)==null?void 0:I.keepArrowsOnSplit)??!0}),s=B(C=>C.setKeepArrowsOnSplit),r=B(C=>{var I;return((I=C.preferences)==null?void 0:I.keepSplitMatch)??!1}),a=B(C=>C.setKeepSplitMatch),l=_.getState().projectCanvas.getActive(),c=(l==null?void 0:l.coreState.selectedNodes)??[],d=c.length===1&&typeof c[0].content=="string"?c[0].content:"",{splitNodeContentByParagraph:u,splitNodeContentByLine:h,splitNodeContentByComma:f,splitNodeContentByPeriod:g,splitNodeContentByCustomCharacter:x,splitNodeContentByRegex:p}=Dd(n,r),{splitInsideBySentence:m,splitInsideBySmartComma:w,splitInsideBySmartCharacter:S,splitInsideByAll:y}=Hd(),j={icon:o.jsx(bi,{}),onClick:u,label:"Split content by paragraph"},N=[{header:"Node",width:"200px",actions:[{label:"Node Paragraph",icon:o.jsx(xi,{className:"h-3 w-3"}),onClick:u},{label:"Node Line",icon:o.jsx(kr,{className:"h-3 w-3"}),onClick:h},{label:"Node Comma",icon:o.jsx(wi,{className:"h-3 w-3"}),onClick:f},{label:"Node Period",icon:o.jsx(vi,{className:"h-3 w-3"}),onClick:g},{label:"Node Special",icon:o.jsx(Gn,{className:"h-3 w-3"}),onClick:x},{label:"Node Regex",icon:o.jsx(Si,{className:"h-3 w-3"}),customRender:()=>o.jsx(Wd,{onSplit:p,selectedNodeContent:d})},{label:"Keep arrows",icon:null,customRender:()=>o.jsx("div",{className:"px-2 py-1",onPointerDown:C=>C.stopPropagation(),children:o.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[o.jsx("input",{type:"checkbox",checked:n,onChange:C=>s(C.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:C=>C.stopPropagation(),"data-test":"toolbar-split-keep-arrows-checkbox"}),o.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Keep arrows"})]})})},{label:"Keep split match",icon:null,customRender:()=>o.jsx("div",{className:"px-2 py-1",onPointerDown:C=>C.stopPropagation(),children:o.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[o.jsx("input",{type:"checkbox",checked:r,onChange:C=>a(C.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:C=>C.stopPropagation(),"data-test":"toolbar-split-keep-match-checkbox"}),o.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Keep split match"})]})})}]},{header:"Text",width:"200px",actions:[{label:"Text Sentence",icon:o.jsx(yi,{className:"h-3 w-3"}),onClick:m},{label:"Text Smart comma",icon:o.jsx(Ni,{className:"h-3 w-3"}),customRender:()=>o.jsx(Bd,{onSplit:w})},{label:"Text Smart char",icon:o.jsx(Ir,{className:"h-3 w-3"}),customRender:()=>o.jsx(Vd,{onSplit:S})},{label:"Text All",icon:o.jsx(Ci,{className:"h-3 w-3"}),onClick:()=>y(3)}]}];return o.jsx("div",{id:"CanvasTextSplitButtonContainer",className:je("flex items-center",t),"data-test":"toolbar-split-button",children:o.jsx(tt,{mainAction:j,dropdownColumns:N,variant:"outline",size:"compact",persistenceKey:"toolbar-split-button",dropdownMenuClassName:"w-auto min-w-0"})})},xs=e=>{let t="";if(typeof e.content=="string"&&(t+=e.content+`
`),e.subContent){if(typeof e.subContent=="string")t+=e.subContent+`
`;else if(typeof e.subContent=="object"&&"lines"in e.subContent){const{lines:n}=e.subContent;typeof n=="string"?t+=n+`
`:Array.isArray(n)&&n.forEach(s=>{typeof s=="string"?t+=s+`
`:s&&Array.isArray(s.words)&&(t+=s.words.join(" ")+`
`)})}}return t.trim()},Gd=e=>{const{className:t,variant:n}=e,s=_.getState(),r=s.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.selectedNodes)??[],i=s.addNode,l=s.setNodeToFocusId,c=async(p,m)=>{if(a.length===0){console.log(`AI ${p}: No nodes selected.`);return}let w=a.map(xs).join(`

---

`);if(m&&(w=`${m}:

${w}`),!w.trim()){console.log(`AI ${p}: Selected nodes have no text content.`);return}console.log(`AI ${p} - Prompt:`,w);try{const S=await $a.generateCompletion(w,void 0,{stream:!1});console.log(`AI ${p} - Response:`,S);const y=S==null?void 0:S.response;if(typeof y=="string"&&y.trim()){let j={x:100,y:100};if(a.length>0){const C=a[0];j={x:C.x,y:C.y+(C.height??Q.DEFAULT_NODE_HEIGHT)+Q.nodeSpacing}}const N=Ie.buildTextNode(j,y);i(N),l(N.id),console.log(`AI ${p}: Created new node ${N.id} with AI response.`)}else(typeof y!="string"||!y.trim())&&console.log(`AI ${p}: Received empty or invalid response from AI.`)}catch(S){console.error(`AI ${p} - Error:`,S)}},d=()=>{c("Generate Text","Continue writing based on the following text")},u=()=>{c("Summarize Selection","Summarize the following text")},h=()=>{c("Ask Question","Based on the following, answer any implied questions or provide information")},f=async()=>{if(a.length===0){console.log("Translate to VN: No nodes selected.");return}const p=a.map(xs).join(`

`);if(!p.trim()){console.log("Translate to VN: Selected nodes have no text content.");return}console.log("Translate to VN - Input:",p);try{const m=await Mo(p,"English","Vietnamese");console.log("Translate to VN - Response:",m);const w=m.output;if(w!=null&&w.trim()){let S={x:100,y:100};if(a.length>0){const j=a[0];S={x:j.x,y:j.y+(j.height??Q.DEFAULT_NODE_HEIGHT)+Q.nodeSpacing}}const y=Ie.buildTextNode(S,w);i(y),l(y.id),console.log(`Translate to VN: Created new node ${y.id} with Vietnamese translation.`)}else console.log("Translate to VN: Received empty translation.")}catch(m){console.error("Translate to VN - Error:",m)}},g=async()=>{if(a.length===0){console.log("Translate to EN: No nodes selected.");return}const p=a.map(xs).join(`

`);if(!p.trim()){console.log("Translate to EN: Selected nodes have no text content.");return}console.log("Translate to EN - Input:",p);try{const m=await Mo(p,"Vietnamese","English");console.log("Translate to EN - Response:",m);const w=m.output;if(w!=null&&w.trim()){let S={x:100,y:100};if(a.length>0){const j=a[0];S={x:j.x,y:j.y+(j.height??Q.DEFAULT_NODE_HEIGHT)+Q.nodeSpacing}}const y=Ie.buildTextNode(S,w);i(y),l(y.id),console.log(`Translate to EN: Created new node ${y.id} with English translation.`)}else console.log("Translate to EN: Received empty translation.")}catch(m){console.error("Translate to EN - Error:",m)}},x=[{label:"Generate Text",icon:o.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Summarize",icon:o.jsx(ji,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Ask Question",icon:o.jsx(ki,{className:"h-2.5 w-2.5"}),onClick:h},{label:"Translate to VN",icon:o.jsx(bo,{className:"h-2.5 w-2.5"}),onClick:f},{label:"Translate to EN",icon:o.jsx(bo,{className:"h-2.5 w-2.5"}),onClick:g}];return o.jsx("div",{id:"ToolbarAi",className:ve("ToolbarAi",t),"data-test":"toolbar-ai-button",children:o.jsx(tt,{size:"compact",variant:n??"secondary",mainAction:{icon:o.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:()=>{console.log("Main AI Action clicked")},text:"AI",label:"Trigger AI actions"},dropdownActions:x,dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})},Yd=()=>{const{fitNodeDimensions:e,setFixedWidth:t,selectedNodes:n}=cs(),s=n.length===0,r=[{label:"Set width to 700px",icon:o.jsx($n,{className:"h-2.5 w-2.5"}),onClick:()=>t(700),disabled:s},{label:"Set width to 550px",icon:o.jsx($n,{className:"h-2.5 w-2.5"}),onClick:()=>t(550),disabled:s},{label:"Set width to 850px",icon:o.jsx($n,{className:"h-2.5 w-2.5"}),onClick:()=>t(850),disabled:s},{label:"Fit node dimensions",icon:o.jsx(_s,{className:"h-2.5 w-2.5"}),onClick:()=>{e()},disabled:s}],a=r[0];return o.jsx(tt,{mainAction:a,dropdownActions:r,variant:"outline",size:"compact",persistenceKey:"canvas-fit-width","data-test":"canvas-fit-width-button"})},ft=50,Xd=()=>{const t=_.getState().projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],s=v.useCallback((f,g)=>{const x=_.getState(),p=x.projectCanvas.getActive(),m=(p==null?void 0:p.coreState.selectedNodes)??[],w=(p==null?void 0:p.coreState.nodes)??{},S=x.updateNode;if(m.length!==1){console.warn("useNodePusher: Exactly one node must be selected to push/pull other nodes.");return}const y=m[0],j=[],N=Object.values(w),C=g==="pull"?f==="up"?"down":f==="down"?"up":f==="left"?"right":"left":f;N.forEach(I=>{if(I.id===y.id)return;let R=!1;const A={id:I.id};switch(C){case"down":I.y>=y.y+(y.height??0)&&(A.y=I.y+(g==="push"?ft:-ft),R=!0);break;case"up":I.y+(I.height??0)<=(y.y??0)&&(A.y=I.y+(g==="push"?-ft:ft),R=!0);break;case"right":I.x>=y.x+(y.width??0)&&(A.x=I.x+(g==="push"?ft:-ft),R=!0);break;case"left":I.x+(I.width??0)<=y.x&&(A.x=I.x+(g==="push"?-ft:ft),R=!0);break}R&&j.push(A)}),j.length>0?(j.forEach(I=>S(I.id,I)),console.log(`${g==="push"?"Pushed":"Pulled"} ${j.length} nodes ${f} by ${ft}px.`)):console.warn(`No nodes found to ${g} ${f}.`)},[]),r=v.useCallback(()=>s("down","push"),[s]),a=v.useCallback(()=>s("up","push"),[s]),i=v.useCallback(()=>s("left","push"),[s]),l=v.useCallback(()=>s("right","push"),[s]),c=v.useCallback(()=>s("down","pull"),[s]),d=v.useCallback(()=>s("up","pull"),[s]),u=v.useCallback(()=>s("left","pull"),[s]),h=v.useCallback(()=>s("right","pull"),[s]);return{pushNodesDown:r,pushNodesUp:a,pushNodesLeft:i,pushNodesRight:l,pullNodesDown:c,pullNodesUp:d,pullNodesLeft:u,pullNodesRight:h,selectedNodes:n}},Kd=e=>{const{className:t}=e,{pushNodesDown:n,pushNodesUp:s,pushNodesLeft:r,pushNodesRight:a,pullNodesDown:i,pullNodesUp:l,pullNodesLeft:c,pullNodesRight:d,selectedNodes:u}=Xd(),h=u.length!==1,f={icon:o.jsx(Ii,{className:"h-4 w-4"}),onClick:n,label:"Push/Pull nodes",disabled:h},g=[{header:"Push",actions:[{label:"Push Up",icon:o.jsx(Os,{className:"h-3 w-3"}),onClick:s,disabled:h},{label:"Push Down",icon:o.jsx($s,{className:"h-3 w-3"}),onClick:n,disabled:h},{label:"Push Left",icon:o.jsx(Xn,{className:"h-3 w-3"}),onClick:r,disabled:h},{label:"Push Right",icon:o.jsx(Et,{className:"h-3 w-3"}),onClick:a,disabled:h}]},{header:"Pull",actions:[{label:"Pull Up",icon:o.jsx(Os,{className:"h-3 w-3"}),onClick:l,disabled:h},{label:"Pull Down",icon:o.jsx($s,{className:"h-3 w-3"}),onClick:i,disabled:h},{label:"Pull Left",icon:o.jsx(Xn,{className:"h-3 w-3"}),onClick:c,disabled:h},{label:"Pull Right",icon:o.jsx(Et,{className:"h-3 w-3"}),onClick:d,disabled:h}]}];return o.jsx("div",{id:"PushNodesButtonContainer",className:je("flex items-center",t),"data-test":"toolbar-push-pull-nodes-button",children:o.jsx(tt,{mainAction:f,dropdownColumns:g,variant:"outline",size:"compact",dropdownMenuClassName:"w-auto min-w-0"})})},qd=()=>{const e=_.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],s=(t==null?void 0:t.coreState.arrows)??[];e.addNode,e.deleteSelectedNodes;const r=e.deleteNodeById,a=e.setSelectedNodes,i=e.updateNodes,l=e.arrow.setAll,c=v.useCallback(h=>{if(n.length<2){console.warn("useNodeJoiner: At least two nodes must be selected to join.");return}const f=[...n].sort((y,j)=>y.y<j.y?-1:y.y>j.y?1:y.x<j.x?-1:y.x>j.x?1:0),g=f[0],x=f.slice(1),p=f.reduce((y,j)=>(j.width??0)>(y.width??0)?j:y,f[0]),m=f.map(y=>typeof y.content=="string"?y.content.trim():"").filter(y=>y.length>0).join(h);if(m.length===0&&f.every(y=>!(typeof y.content=="string"&&y.content.trim()))){console.warn("useNodeJoiner: All selected nodes have empty content. No node created.");return}const w=p.width??Q.DEFAULT_NODE_WIDTH,S=Mt(m,w)+Q.NODE_Y_PADDING*2;i([{id:g.id,content:m,width:p.width,height:S}]);{const y=new Set(x.map(C=>C.id)),N=s.map(C=>{const I=C.startNodeId&&y.has(C.startNodeId),R=C.endNodeId&&y.has(C.endNodeId);return I&&R||I&&C.endNodeId===g.id||R&&C.startNodeId===g.id?null:I||R?{...C,startNodeId:I?g.id:C.startNodeId,endNodeId:R?g.id:C.endNodeId}:C}).filter(C=>C!==null).filter((C,I,R)=>C?I===R.findIndex(A=>A&&A.startNodeId===C.startNodeId&&A.endNodeId===C.endNodeId):!1);l(N)}x.forEach(y=>{r(y.id)}),a([g]),console.log("Nodes joined into first node:",g.id)},[n,s,i,r,a,l]),d=v.useCallback(()=>{c(" ")},[c]),u=v.useCallback(()=>{c(`
`)},[c]);return{joinNodes:d,joinNodesWithNewline:u,selectedNodes:n}},Zd=()=>{const{joinNodes:e,joinNodesWithNewline:t,selectedNodes:n}=qd(),s=n.length<2,r=[{label:"Join with newline",icon:o.jsx(kr,{className:"h-2.5 w-2.5"}),onClick:t,disabled:s},{label:"Join with space",icon:o.jsx(Rr,{className:"h-2.5 w-2.5"}),onClick:e,disabled:s}],a={...r[0]};return o.jsx(tt,{mainAction:a,dropdownActions:r,variant:"outline",size:"compact","data-test":"canvas-join-nodes-button"})},qr=[{name:"Red",value:"#ef4444",twClass:"bg-red-500"},{name:"Orange",value:"#f97316",twClass:"bg-orange-500"},{name:"Yellow",value:"#eab308",twClass:"bg-yellow-500"},{name:"Green",value:"#22c55e",twClass:"bg-green-500"},{name:"Teal",value:"#14b8a6",twClass:"bg-teal-500"},{name:"Cyan",value:"#06b6d4",twClass:"bg-cyan-500"},{name:"Blue",value:"#3b82f6",twClass:"bg-blue-500"},{name:"Violet",value:"#8b5cf6",twClass:"bg-violet-500"},{name:"Purple",value:"#a855f7",twClass:"bg-purple-500"},{name:"Pink",value:"#ec4899",twClass:"bg-pink-500"},{name:"White",value:"#ffffff",twClass:"bg-white"},{name:"Border",value:"hsl(240 5.9% 90%)",twClass:"bg-border"},{name:"Muted",value:"hsl(var(--muted-light))",twClass:"bg-muted"},{name:"Black",value:"#000000",twClass:"bg-black"},{name:"Transparent",value:"transparent",twClass:"bg-transparent border-dashed border-neutral-400"}],Zr=e=>{if(e.startsWith("hsl(")){const t=/hsl\(\s*(\d+)\s*,\s*(\d+%)\s*,\s*(\d+%)\s*\)/.exec(e);if(t){const n=parseInt(t[1]),s=parseInt(t[2])/100,r=parseInt(t[3])/100;if(s===0){const d=Math.round(r*255).toString(16).padStart(2,"0");return`#${d}${d}${d}`}const a=d=>(d+n/30)%12,i=s*Math.min(r,1-r),l=d=>r-i*Math.max(-1,Math.min(a(d)-3,Math.min(9-a(d),1))),c=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${c(l(0))}${c(l(8))}${c(l(4))}`}}return console.warn(`convertHslToHex: Could not convert HSL string "${e}" to HEX. Returning as is or black.`),e.startsWith("#")?e:"#000000"},Jd=({currentColor:e,onColorSelect:t,currentBorderWidth:n,onBorderWidthChange:s})=>{const[r,a]=v.useState(e),[i,l]=v.useState(n);v.useEffect(()=>{a(e)},[e]),v.useEffect(()=>{l(n)},[n]);const c=u=>{a(u),t(u)},d=u=>{const h=parseInt(u.target.value,10);isNaN(h)||(l(h),s(h))};return o.jsxs("div",{className:"p-2 grid grid-cols-5 gap-2 bg-popover rounded-md shadow-md",children:[qr.map(u=>o.jsx("button",{type:"button",title:u.name,onClick:()=>c(u.value),className:je("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",u.twClass,u.value===r?"ring-2 ring-ring ring-offset-2":"border-muted",u.value==="white"&&"border-neutral-300"),style:u.value.startsWith("hsl(")?{backgroundColor:u.value}:{},"aria-label":`Select color ${u.name}`,"data-test":`color-picker-${u.name.toLowerCase().replace(/\s+/g,"-")}`},u.value)),o.jsx("input",{type:"color",value:r.startsWith("hsl")?Zr(r):r,onChange:u=>c(u.target.value),className:"mt-2 w-full col-span-5 h-8 bg-secondary","data-test":"color-picker-custom-color-input"}),o.jsxs("div",{className:"mt-3 pt-3 border-t border-border col-span-5",children:[o.jsx("label",{htmlFor:"border-width-input",className:"block text-sm font-medium text-foreground mb-1",children:"Border Width"}),o.jsx("input",{type:"number",id:"border-width-input",value:i,onChange:d,min:"0",max:"50",className:"mt-1 w-full col-span-5 h-8 p-2 rounded-md border border-input bg-background text-foreground focus:ring-ring focus:border-ring","data-test":"color-picker-border-width-input"})]})]})},Qd=()=>{var C,I,R,A;const e=B(k=>k.updateNode),t=B(k=>{var b;return((b=k.projectCanvas.getActive())==null?void 0:b.coreState.selectedNodes)??[]}),[n,s]=v.useState(!1),[r,a]=v.useState("hsl(var(--primary))"),[i,l]=v.useState("1px"),[c,d]=v.useState("solid"),u=_.getState().getLastUsedBorder(),h=u.lastUsedColor,f=u.lastUsedWidth,g=u.lastUsedStyle;v.useEffect(()=>{if(t.length===1){const b=t[0].styles,T=(b==null?void 0:b.borderColor)||"hsl(var(--primary))",E=(b==null?void 0:b.borderWidth)||"1px",D=(b==null?void 0:b.borderStyle)||"solid";a(T),l(E),d(D)}else t.length===0&&(a("hsl(var(--primary))"),l("1px"),d("solid"))},[t]);const x=(k,b,T)=>{t.forEach(E=>{const D={...E.styles,borderWidth:k,borderStyle:b,borderColor:T};k===void 0&&b===void 0&&T===void 0&&(D.border=void 0);const O={styles:D};e(E.id,O)})},p=()=>{x(f,g,h)},m=k=>{x(i,c,k),a(k),_.getState().setLastUsedBorder(k,i,c),_.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},w=k=>{const b=`${k}px`;x(b,c,r),l(b),_.getState().setLastUsedBorder(r,b,c),_.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},S=()=>{l(void 0),d(void 0),a(void 0),x(void 0,void 0,void 0)},y=[{label:"Apply last used border color",icon:o.jsx("span",{style:{color:h==="transparent"?void 0:h,display:"inline-flex"},children:o.jsx(jo,{className:"h-2.5 w-2.5"})}),onClick:()=>{p()},disabled:t.length===0},{label:"Set Border Color",icon:o.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:o.jsx(Ar,{className:"h-2.5 w-2.5"})}),onClick:()=>{s(!0)},disabled:t.length===0},{label:"Remove Border",icon:o.jsx(Er,{className:"h-2.5 w-2.5"}),onClick:()=>{S()},disabled:t.length===0||!((I=(C=t[0])==null?void 0:C.styles)!=null&&I.borderWidth)&&!((A=(R=t[0])==null?void 0:R.styles)!=null&&A.border)}],j={...y[0],icon:o.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:o.jsx(jo,{className:"h-2.5 w-2.5"})})},N=k=>{if(!k)return 1;const b=parseInt(k,10);return isNaN(b)?1:b};return o.jsxs(_t,{open:n,onOpenChange:s,children:[o.jsx(Ot,{asChild:!0,children:o.jsx("div",{style:{display:"inline-flex"},"data-test":"canvas-border-width-button",children:o.jsx(tt,{mainAction:j,dropdownActions:y,variant:"outline",size:"compact",persistenceKey:"canvas-border-width"})})}),o.jsx($t,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:k=>k.preventDefault(),"data-test":"canvas-border-width-popover",children:o.jsx(Jd,{currentColor:r,onColorSelect:m,currentBorderWidth:N(i),onBorderWidthChange:w})})]})},eu=()=>{const e=_.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],s=e.updateNode;return{removeExtraNewLines:v.useCallback(()=>{if(n.length!==1){console.warn("useNodeLineManipulation: Exactly one node must be selected.");return}const a=n[0];if(!a.content||typeof a.content!="string"){console.warn("useNodeLineManipulation: Selected node has no content to modify.");return}const i=a.content.replace(/\n\n+/g,`
`);if(i===a.content){console.warn("useNodeLineManipulation: No extra new lines found. Node content not changed.");return}const l=Mt(i,a.width??0-Q.NODE_X_PADDING)+Q.NODE_Y_PADDING*2,c={id:a.id,content:i,height:l};s(c.id,c),console.log("Action: Removed extra new lines from node content.")},[n,s])}},tu=e=>{const{className:t}=e,{removeExtraNewLines:n}=eu(),s={icon:o.jsx(ko,{}),onClick:n,label:"Remove extra new lines"},r=[{label:"Remove extra new lines",icon:o.jsx(ko,{className:"h-2.5 w-2.5"}),onClick:n}];return o.jsx("div",{id:"ToolbarLinesButtonContainer",className:je("flex items-center",t),"data-test":"toolbar-lines-button",children:o.jsx(tt,{mainAction:s,dropdownActions:r,variant:"outline",size:"compact"})})},nu=e=>{const{className:t,...n}=e,s=()=>{var i;const r=_.getState();(((i=r.projectCanvas.getActive())==null?void 0:i.coreState.selectedNodes)??[]).length>0&&r.deleteSelectedNodes()};return o.jsx(Sn,{id:"ToolbarDeleteNodesButton",className:t,type:"button",onClick:s,"data-test":"toolbar-delete-nodes-button",...n,children:o.jsx(Yt,{className:"h-2.5 w-2.5"})})},su=e=>{if(!e||e.length===0)return[];const t=[...e].sort((i,l)=>(i.y??0)-(l.y??0)),n=[];let s=[],r=0,a=0;for(const i of t){const l=i.y??0,c=i.height??0;if(s.length===0){s.push(i),r=l,a=l+c;continue}l>=r&&l<=a?(s.push(i),a=Math.max(a,l+c)):(n.push(s),s=[i],r=l,a=l+c)}return s.length>0&&n.push(s),n},ou=e=>{if(!e||e.length===0)return[];const t=[...e].sort((i,l)=>(i.x??0)-(l.x??0)),n=[];let s=[],r=0,a=0;for(const i of t){const l=i.x??0,c=i.width??0;if(s.length===0){s.push(i),r=l,a=l+c;continue}l>=r&&l<=a?(s.push(i),a=Math.max(a,l+c)):(n.push(s),s=[i],r=l,a=l+c)}return s.length>0&&n.push(s),n},ru=(e,t,n)=>{const s=new Map;if(!e||e.length===0)return s;if(t==="left"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const l=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(l!==0)return l}return(a.x??0)-(i.x??0)});for(let a=1;a<r.length;a++){const i=r[a-1],l=r[a],c=(i.x??0)+(i.width??0);if((l.x??0)<c+n){const u=c+n;s.set(l.id,{x:u}),r[a]={...l,x:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const l=(a.x??0)+(a.width??0);return(i.x??0)+(i.width??0)-l});for(let a=1;a<r.length;a++){const i=r[a-1],l=r[a],c=i.x??0;if((l.x??0)+(l.width??0)>c-n){const u=c-n-(l.width??0);s.set(l.id,{x:u}),r[a]={...l,x:u}}}}return s},au=(e,t,n)=>{const s=new Map;if(!e||e.length===0)return s;if(t==="top"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const l=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(l!==0)return l}return(a.y??0)-(i.y??0)});for(let a=1;a<r.length;a++){const i=r[a-1],l=r[a],c=(i.y??0)+(i.height??0);if((l.y??0)<c+n){const u=c+n;s.set(l.id,{y:u}),r[a]={...l,y:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const l=(a.y??0)+(a.height??0);return(i.y??0)+(i.height??0)-l});for(let a=1;a<r.length;a++){const i=r[a-1],l=r[a],c=i.y??0;if((l.y??0)+(l.height??0)>c-n){const u=c-n-(l.height??0);s.set(l.id,{y:u}),r[a]={...l,y:u}}}}return s},ws={left:o.jsx(no,{className:"h-3 w-3"}),right:o.jsx(to,{className:"h-3 w-3"}),top:o.jsx(Mr,{className:"h-3 w-3"}),bottom:o.jsx(Tr,{className:"h-3 w-3"})},nr={left:o.jsx(no,{className:"h-3 w-3"}),center:o.jsx(Ri,{className:"h-3 w-3"}),right:o.jsx(to,{className:"h-3 w-3"})},iu=e=>{var y;const{className:t,value:n,defaultValue:s="left",onAlignmentChange:r,textAlignValue:a,defaultTextAlignValue:i="left",onTextAlignmentChange:l}=e;(y=_.getState().projectCanvas.getActive())==null||y.coreState.selectedNodes;const[d,u]=v.useState(n??s),[h,f]=v.useState(a??i);v.useEffect(()=>{n!==void 0&&u(n)},[n]),v.useEffect(()=>{a!==void 0&&f(a)},[a]);const g=j=>{var T;const N=_.getState(),C=((T=N.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??[];if(!C||C.length===0)return;const I=C.filter(E=>typeof E.x=="number"&&typeof E.y=="number"&&typeof E.width=="number"&&typeof E.height=="number");if(I.length===0)return;const R=j==="left"||j==="right"?su(I):ou(I);let A;switch(j){case"left":A=Math.min(...I.map(E=>E.x));break;case"right":A=Math.max(...I.map(E=>(E.x??0)+(E.width??0)));break;case"top":A=Math.min(...I.map(E=>E.y));break;case"bottom":A=Math.max(...I.map(E=>(E.y??0)+(E.height??0)));break;default:return}const k=new Map;for(const E of I)switch(j){case"left":k.set(E.id,{x:A});break;case"right":k.set(E.id,{x:A-(E.width??0)});break;case"top":k.set(E.id,{y:A});break;case"bottom":k.set(E.id,{y:A-(E.height??0)});break}const b=Q.NODE_ALIGNMENT_PADDING;for(const E of R){const D=E.map(M=>{const $=k.get(M.id);return $?{...M,...$}:M});(j==="left"||j==="right"?ru(D,j,b):au(D,j,b)).forEach((M,$)=>{const P=k.get($)||{};k.set($,{...P,...M})})}k.forEach((E,D)=>{N.updateNode(D,E)})},x=j=>{var R;const N=_.getState(),C=((R=N.projectCanvas.getActive())==null?void 0:R.coreState.selectedNodes)??[];if(C.length===0)return;const I=C.map(A=>({...A,id:A.id,styles:{...A.styles,textAlign:j}}));N.updateNodes(I)},p=j=>{r==null||r(j),u(j),g(j)},m=j=>{l==null||l(j),f(j),x(j)},w={icon:o.jsx(o.Fragment,{children:ws[d]}),onClick:()=>p(d),label:`Align nodes ${d}`,text:""},S=[{header:"Node",width:"100px",actions:Object.keys(ws).map(j=>({label:`Node ${j}`,icon:ws[j],onClick:()=>p(j)}))},{header:"Text",width:"100px",actions:Object.keys(nr).map(j=>({label:`Text ${j}`,icon:nr[j],onClick:()=>m(j)}))}];return o.jsx("div",{id:"ToolbarNodesAlignmentButton",className:je("flex items-center",t),"data-test":"toolbar-nodes-alignment-button",children:o.jsx(tt,{mainAction:w,dropdownColumns:S,variant:"outline",size:"compact",dropdownMenuClassName:"w-auto min-w-0"})})},Ft=[];function lu(){const e=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.selectedNodes)??Ft}),t=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.nodes)??Ft}),n=B(N=>N.updateNode),[s,r]=v.useState("content"),a=v.useRef(Ft);e.length===0?a.current=Ft:(e.length!==a.current.length||!e.every((N,C)=>{var I;return N.id===((I=a.current[C])==null?void 0:I.id)}))&&(a.current=e);const i=v.useRef(Ft);t.length===0?i.current=Ft:(t.length!==i.current.length||!t.every((N,C)=>{var I;return N.id===((I=i.current[C])==null?void 0:I.id)}))&&(i.current=t);const l=N=>N||(a.current.length>=2?a.current:i.current),c=v.useCallback((N,C)=>{const I=l(N);if(I.length<2)return;const R=Z.arrange.gap,A=[...I].sort((T,E)=>T.y-E.y);let k;C==="left"?k=Math.min(...I.map(T=>T.x)):C==="right"&&(k=Math.max(...I.map(E=>E.x+(E.width||200))));let b=A[0].y;A.forEach((T,E)=>{const D={};E===0?b=T.y+(T.height||100)+R:(D.y=b,b=b+(T.height||100)+R),C==="left"&&k!==void 0?D.x=k:C==="right"&&k!==void 0&&(D.x=k-(T.width||200)),Object.keys(D).length>0&&n(T.id,D)})},[n]),d=v.useCallback(N=>{c(N,"left")},[c]),u=v.useCallback(N=>{c(N,"right")},[c]),h=v.useCallback((N,C)=>{const I=l(N);if(I.length<2)return;const R=Z.arrange.gap,A=[...I].sort((T,E)=>T.x-E.x);let k;C==="top"?k=Math.min(...I.map(T=>T.y)):C==="bottom"&&(k=Math.max(...I.map(E=>E.y+(E.height||100))));let b=A[0].x;A.forEach((T,E)=>{const D={};E===0?b=T.x+(T.width||200)+R:(D.x=b,b=b+(T.width||200)+R),C==="top"&&k!==void 0?D.y=k:C==="bottom"&&k!==void 0&&(D.y=k-(T.height||100)),Object.keys(D).length>0&&n(T.id,D)})},[n]),f=v.useCallback(N=>{h(N,"top")},[h]),g=v.useCallback(N=>{h(N,"bottom")},[h]),x=(N,C)=>{const I=N.content||"";return Vt(I,{containerWidth:C})+Q.NODE_Y_PADDING*2},p=v.useCallback(N=>{const C=l(N);if(C.length<2)return;const{gap:I,gridNodeWidth:R,gridColumns:A}=Z.arrange,k=[...C].sort((M,$)=>Math.abs(M.y-$.y)<50?M.x-$.x:M.y-$.y),b=k[0].x,T=k[0].y,E=k.map(M=>x(M,R)),D=Math.ceil(k.length/A),O=[];for(let M=0;M<D;M++){let $=0;for(let P=0;P<A;P++){const F=M*A+P;F<E.length&&($=Math.max($,E[F]))}O.push($)}k.forEach((M,$)=>{const P=$%A,F=Math.floor($/A),U=b+P*(R+I),L=F===0?T:T+O.slice(0,F).reduce((q,ee)=>q+ee+I,0),G=E[$];n(M.id,{x:U,y:L,width:R,height:G,options:{...M.options,lockSize:!0}})})},[n]),m=v.useCallback(N=>{const C=l(N);if(C.length<2)return;const{gap:I,gridNodeWidth:R,gridColumns:A}=Z.arrange,k=[...C].sort((O,M)=>Math.abs(O.y-M.y)<50?O.x-M.x:O.y-M.y),b=k[0].x,T=k[0].y,E=Array(A).fill(T),D=k.map(O=>x(O,R));k.forEach((O,M)=>{const $=E.indexOf(Math.min(...E)),P=b+$*(R+I),F=E[$],U=D[M];n(O.id,{x:P,y:F,width:R,height:U,options:{...O.options,lockSize:!0}}),E[$]=F+U+I})},[n]),w=(N,C)=>{switch(C){case"content":return String(N.content??"").toLowerCase();case"title":return String(N.title??"").toLowerCase();case"x":return N.x;case"y":return N.y;case"width":return N.width??0;case"height":return N.height??0;case"createdAt":return N.createdAt??"";case"updatedAt":return N.updatedAt??"";case"id":return N.id;case"type":return N.type;default:return""}},S=v.useCallback((N,C="asc",I)=>{const R=l(I);if(R.length<2)return;const A=[...R].sort((b,T)=>Math.abs(b.y-T.y)<50?b.x-T.x:b.y-T.y).map(b=>({x:b.x,y:b.y}));[...R].sort((b,T)=>{const E=w(b,N),D=w(T,N);let O;return typeof E=="number"&&typeof D=="number"?O=E-D:O=String(E).localeCompare(String(D)),C==="asc"?O:-O}).forEach((b,T)=>{const E=A[T];(b.x!==E.x||b.y!==E.y)&&n(b.id,{x:E.x,y:E.y})})},[n]),y=v.useCallback((N,C)=>{S(N??s,"asc",C)},[S,s]),j=v.useCallback((N,C)=>{S(N??s,"desc",C)},[S,s]);return{arrangeVertically:c,arrangeVerticallyAlignLeft:d,arrangeVerticallyAlignRight:u,arrangeHorizontally:h,arrangeHorizontallyAlignTop:f,arrangeHorizontallyAlignBottom:g,arrangeGrid:p,arrangeMasonry:m,sortNodes:S,sortNodesAsc:y,sortNodesDesc:j,sortKey:s,setSortKey:r,sortableKeys:Fa,selectedNodes:a.current}}const cu=()=>{const{arrangeVertically:e,arrangeVerticallyAlignLeft:t,arrangeVerticallyAlignRight:n,arrangeHorizontally:s,arrangeHorizontallyAlignTop:r,arrangeHorizontallyAlignBottom:a,arrangeGrid:i,arrangeMasonry:l,sortNodesAsc:c,sortNodesDesc:d,sortKey:u,setSortKey:h,sortableKeys:f}=lu(),g=B(C=>{var I,R;return(R=(I=C.preferences)==null?void 0:I.arrangeButton)==null?void 0:R.lastArrangeOption}),x=B(C=>C.setLastArrangeOption),p=B(C=>{var I,R;return((R=(I=C.preferences)==null?void 0:I.arrangeButton)==null?void 0:R.sortByLastArrange)??!1}),m=B(C=>C.setSortByLastArrange),w=(C,I)=>{x(C),I()},S={"Arrange vertically":e,"Arrange vertically (left)":t,"Arrange vertically (right)":n,"Arrange horizontally":s,"Arrange horizontally (top)":r,"Arrange horizontally (bottom)":a,Grid:i,Masonry:l},y=C=>{p&&g&&S[g]&&S[g](),C==="asc"?c():d()},j=[{label:"Arrange vertically",icon:o.jsx(Io,{className:"h-2.5 w-2.5"}),onClick:()=>w("Arrange vertically",e),customRender:()=>o.jsxs("div",{className:"flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent","data-test":"arrange-vertically-row",children:[o.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>w("Arrange vertically",e),"data-test":"arrange-vertically-button",children:[o.jsx(Io,{className:"h-3.5 w-3.5"}),o.jsx("span",{children:"Arrange vertically"})]}),o.jsxs("div",{className:"flex items-center gap-0.5 ml-2",children:[o.jsx(Y,{variant:"outline",size:"icon",className:"h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",onClick:C=>{C.stopPropagation(),w("Arrange vertically (left)",t)},title:"Align left","data-test":"arrange-vertically-align-left",children:o.jsx(no,{className:"h-3 w-3"})}),o.jsx(Y,{variant:"outline",size:"icon",className:"h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",onClick:C=>{C.stopPropagation(),w("Arrange vertically (right)",n)},title:"Align right","data-test":"arrange-vertically-align-right",children:o.jsx(to,{className:"h-3 w-3"})})]})]})},{label:"Arrange horizontally",icon:o.jsx(_s,{className:"h-2.5 w-2.5"}),onClick:()=>w("Arrange horizontally",s),customRender:()=>o.jsxs("div",{className:"flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent","data-test":"arrange-horizontally-row",children:[o.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>w("Arrange horizontally",s),"data-test":"arrange-horizontally-button",children:[o.jsx(_s,{className:"h-3.5 w-3.5"}),o.jsx("span",{children:"Arrange horizontally"})]}),o.jsxs("div",{className:"flex items-center gap-0.5 ml-2",children:[o.jsx(Y,{variant:"outline",size:"icon",className:"h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",onClick:C=>{C.stopPropagation(),w("Arrange horizontally (top)",r)},title:"Align top","data-test":"arrange-horizontally-align-top",children:o.jsx(Mr,{className:"h-3 w-3"})}),o.jsx(Y,{variant:"outline",size:"icon",className:"h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",onClick:C=>{C.stopPropagation(),w("Arrange horizontally (bottom)",a)},title:"Align bottom","data-test":"arrange-horizontally-align-bottom",children:o.jsx(Tr,{className:"h-3 w-3"})})]})]})},{label:"Grid",icon:o.jsx(Ai,{className:"h-2.5 w-2.5"}),onClick:()=>w("Grid",i)},{label:"Masonry",icon:o.jsx(Ei,{className:"h-2.5 w-2.5"}),onClick:()=>w("Masonry",l)},{label:"Sort",icon:o.jsx(Ro,{className:"h-2.5 w-2.5"}),onClick:()=>y("asc"),customRender:()=>o.jsxs("div",{"data-test":"sort-section",children:[o.jsxs("div",{className:"flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent","data-test":"sort-nodes-row",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[o.jsx(Ro,{className:"h-3.5 w-3.5"}),o.jsx("span",{children:"Sort"})]}),o.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[o.jsxs(es,{value:u,onValueChange:C=>h(C),children:[o.jsx(ts,{className:"h-6 w-[90px] text-xs px-2","data-test":"sort-key-selector",children:o.jsx(ns,{})}),o.jsx(ss,{children:f.map(C=>o.jsx(os,{value:C,"data-test":`sort-key-${C}`,children:La[C]},C))})]}),o.jsx(Y,{variant:"outline",size:"icon",className:"h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",onClick:C=>{C.stopPropagation(),y("asc")},title:"Sort ascending","data-test":"sort-nodes-asc",children:o.jsx(Os,{className:"h-3 w-3"})}),o.jsx(Y,{variant:"outline",size:"icon",className:"h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",onClick:C=>{C.stopPropagation(),y("desc")},title:"Sort descending","data-test":"sort-nodes-desc",children:o.jsx($s,{className:"h-3 w-3"})})]})]}),o.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 text-xs text-muted-foreground hover:bg-accent rounded-sm cursor-pointer","data-test":"sort-by-last-arrange-row",children:[o.jsx($e,{checked:p,onCheckedChange:C=>m(C===!0),className:"h-3.5 w-3.5","data-test":"sort-by-last-arrange-checkbox"}),o.jsxs("span",{children:["By last arranged: ",g||"none"]})]})]})}],N=j[0];return o.jsx(tt,{mainAction:N,dropdownActions:j,variant:"outline",size:"compact",persistenceKey:"canvas-arrange-nodes","data-test":"canvas-arrange-nodes-button"})},du=[],sr=[],Jr=()=>{const e=B(c=>c.arrow.update),t=B(c=>{var d;return((d=c.projectCanvas.getActive())==null?void 0:d.coreState.selectedNodes)??du}),n=B(c=>{var d;return((d=c.projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??sr}),s=B(c=>{var d;return((d=c.projectCanvas.getActive())==null?void 0:d.coreState.arrows)??sr}),r=v.useMemo(()=>{if(n.length>0){const c=n[0].type??Z.arrows.type;return n.every(u=>(u.type??Z.arrows.type)===c)?c:null}if(t.length>0){const c=new Set(t.map(f=>f.id)),d=s.filter(f=>f.startNodeId&&c.has(f.startNodeId)||f.endNodeId&&c.has(f.endNodeId));if(d.length===0)return Z.arrows.type;const u=d[0].type??Z.arrows.type;return d.every(f=>(f.type??Z.arrows.type)===u)?u:null}return Z.arrows.type},[n,t,s]),a=v.useCallback(c=>{const u=_.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.arrows??[],f=u.coreState.selectedArrows??[],g=u.coreState.selectedNodes??[];let x=h;if(f.length>0)x=f;else if(g.length>0){const p=new Set(g.map(m=>m.id));x=h.filter(m=>m.startNodeId&&p.has(m.startNodeId)||m.endNodeId&&p.has(m.endNodeId))}x.forEach(p=>{e(p.id,{type:c})})},[e]),i=[{label:"Straight",icon:o.jsx(Rr,{className:"h-2.5 w-2.5"}),onClick:()=>a("Straight"),selected:r==="Straight"},{label:"Quadratic",icon:o.jsx(Ti,{className:"h-2.5 w-2.5"}),onClick:()=>a("Quadratic"),selected:r==="Quadratic"},{label:"Cubic",icon:o.jsx(Mi,{className:"h-2.5 w-2.5"}),onClick:()=>a("Cubic"),selected:r==="Cubic"},{label:"Step",icon:o.jsx(Di,{className:"h-2.5 w-2.5"}),onClick:()=>a("Step"),selected:r==="Step"},{label:"Orthogonal",icon:o.jsx(mn,{className:"h-2.5 w-2.5"}),onClick:()=>a("Orthogonal"),selected:r==="Orthogonal"},{label:"Tree: Cubic",icon:o.jsx(Pi,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeCubic"),selected:r==="TreeCubic"},{label:"Tree: L-Step",icon:o.jsx(_i,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeLStep"),selected:r==="TreeLStep"},{label:"Tree: Z-Shape",icon:o.jsx(Oi,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeZShape"),selected:r==="TreeZShape"}],l=i[2];return o.jsx(tt,{mainAction:l,dropdownActions:i,variant:"outline",size:"compact",persistenceKey:"canvas-arrow-type","data-test":"canvas-arrow-type-button"})},uu=e=>{const{className:t}=e,{handleAlignmentChange:n,currentAlignment:s}=Ad();return o.jsxs("div",{className:ve("p-0.5 gap-0.5","bg-primary-foreground shadow","flex items-center flex-wrap","pointer-events-auto",t),"data-test":"canvas-node-configurations-toolbar",children:[o.jsx(Xr,{}),o.jsx(nu,{}),o.jsx(iu,{textAlignValue:s,onTextAlignmentChange:n}),o.jsx(Qd,{}),o.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),o.jsx(Ud,{}),o.jsx(tu,{}),o.jsx(Yd,{}),o.jsx(cu,{}),o.jsx(Zd,{}),o.jsx(Kd,{}),o.jsx(Jr,{}),o.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),o.jsx(Gd,{})]})},gu=({node:e})=>o.jsx("div",{className:ve("relative","bg-primary-foreground shadow flex items-center space-x-2 pointer-events-auto","opacity-10 hover:opacity-100 transition-opacity duration-200"),style:{zIndex:He.nodeQuickPanel},"data-test":"node-quick-panel-container","data-node-id":e.id,"data-node-type":e.type,children:o.jsx(uu,{})}),or=30,fu=({node:e,isOpen:t,children:n})=>{const[s,r]=v.useState({top:0,left:0}),a=v.useRef(null),i=B(u=>{var h;return((h=u.projectCanvas.getActive())==null?void 0:h.coreState.selectedNodes)??[]}),c=B(u=>u.uiState.mode)===W.DRAW_ARROW,d=i.length>0?i.reduce((u,h)=>h.y<u.y||h.y===u.y&&h.x<u.x?h:u,i[0]):e;return v.useEffect(()=>{if(!t)return;const u=()=>{var k,b;const f=d,g=document.getElementById(`NodeContainerV2-${f.id}`);if(!g)return;const x=g.getBoundingClientRect(),p=((k=a.current)==null?void 0:k.offsetHeight)||250,m=((b=a.current)==null?void 0:b.offsetWidth)||350,w=window.innerWidth,S=window.innerHeight,y=20;let j=x.left+x.width/2-m/2;const N=x.top-p-or,C=x.bottom+or,I=N>=y,R=C+p<=S-y;let A;!I&&R?A=C:I?A=N:R?A=C:A=y,j<y?j=y:j+m>w-y&&(j=w-m-y),r({top:A,left:j})};u();const h=setTimeout(u,100);return window.addEventListener("scroll",u,!0),window.addEventListener("resize",u),()=>{clearTimeout(h),window.removeEventListener("scroll",u,!0),window.removeEventListener("resize",u)}},[t,d.id,d.x,d.y]),o.jsxs(o.Fragment,{children:[n,t&&!c&&yr.createPortal(o.jsx("div",{ref:a,className:"fixed pointer-events-auto",style:{top:`${s.top}px`,left:`${s.left}px`,zIndex:He.popover,maxWidth:"90vw"},onPointerDown:u=>u.stopPropagation(),onTouchStart:u=>u.stopPropagation(),onWheel:u=>u.stopPropagation(),children:o.jsx(gu,{node:e})}),document.body)]})},hu=[{position:"top",cursor:"cursor-crosshair",classes:"top-0 left-1/2 -translate-x-1/2"},{position:"bottom",cursor:"cursor-crosshair",classes:"bottom-0 left-1/2 -translate-x-1/2"},{position:"left",cursor:"cursor-crosshair",classes:"left-0 top-1/2 -translate-y-1/2"},{position:"right",cursor:"cursor-crosshair",classes:"right-0 top-1/2 -translate-y-1/2"}],vt=8,Rn=Z.nodeOptions.resizeBorderWidth,Ee={corner:{width:vt,height:vt},edge:{horizontal:{height:Rn,width:`calc(100% - ${vt*2}px)`},vertical:{width:Rn,height:`calc(100% - ${vt*2}px)`}},position:{cornerTop:`-${vt}px`,cornerLeft:`-${vt}px`,cornerBottom:"100%",cornerRight:"100%",edgeTop:`-${Rn}px`,edgeLeft:`-${Rn}px`,topEdge:`${vt}px`,leftEdge:`${vt}px`},edgePosition:{bottom:"100%",left:"100%"}},pu=[{position:"top-left",cursor:"cursor-nwse-resize",classes:"z-10",style:{...Ee.corner,top:Ee.position.cornerTop,left:Ee.position.cornerLeft}},{position:"top-right",cursor:"cursor-nesw-resize",classes:"z-10",style:{...Ee.corner,top:Ee.position.cornerTop,left:Ee.position.cornerRight}},{position:"bottom-left",cursor:"cursor-nesw-resize",classes:"z-10",style:{...Ee.corner,top:Ee.position.cornerBottom,left:Ee.position.cornerLeft}},{position:"bottom-right",cursor:"cursor-nwse-resize",classes:"z-10",style:{...Ee.corner,top:Ee.position.cornerBottom,left:Ee.position.cornerRight}},{position:"top",cursor:"cursor-ns-resize",classes:"",style:{...Ee.edge.horizontal,top:Ee.position.edgeTop,left:Ee.position.leftEdge}},{position:"bottom",cursor:"cursor-ns-resize",classes:"",style:{...Ee.edge.horizontal,top:Ee.edgePosition.bottom,left:Ee.position.leftEdge}},{position:"left",cursor:"cursor-ew-resize",classes:"",style:{...Ee.edge.vertical,top:Ee.position.topEdge,left:Ee.position.edgeLeft}},{position:"right",cursor:"cursor-ew-resize",classes:"",style:{...Ee.edge.vertical,top:Ee.position.topEdge,left:Ee.edgePosition.left}}],mu=e=>{const t=wt(e,"top-left"),n=wt(e,"top-right"),s=wt(e,"bottom-left"),r=wt(e,"bottom-right"),a=wt(e,"top"),i=wt(e,"bottom"),l=wt(e,"left"),c=wt(e,"right");return{"top-left":t,"top-right":n,"bottom-left":s,"bottom-right":r,top:a,bottom:i,left:l,right:c}},{HANDLE_BG_COLOR:xu,HANDLE_BORDER_COLOR:wu}=Q,Bs=8,Vs=20,Lt=(Vs-Bs)/2,vu=({node:e,isSelected:t,mode:n})=>{const s=t&&n===W.SELECT,r=mu(e);return s?o.jsx(o.Fragment,{children:pu.map(({position:a,cursor:i,classes:l,style:c})=>{const d=r[a];return["top","right","bottom","left"].includes(a)?o.jsx("div",{"data-test":`resize-handle-${a}`,id:`resize-handle-${e.id}-${a}`,className:ve("absolute","hover:bg-primary/5 transition-colors",l,i),style:{...c,touchAction:"none",zIndex:He.canvasResizeHandles},onPointerDown:h=>{h.stopPropagation(),d(h)}},a):o.jsx("div",{"data-test":`resize-handle-${a}`,id:`resize-handle-${e.id}-${a}`,className:ve("absolute",l,i),style:{width:Vs,height:Vs,top:typeof(c==null?void 0:c.top)=="string"?`calc(${c.top} - ${Lt}px)`:(c==null?void 0:c.top)-Lt,left:typeof(c==null?void 0:c.left)=="string"?`calc(${c.left} - ${Lt}px)`:(c==null?void 0:c.left)-Lt,touchAction:"none",zIndex:He.canvasResizeHandles},onPointerDown:h=>{h.stopPropagation(),d(h)},children:o.jsx("div",{className:ve("absolute border",xu,wu),style:{width:Bs,height:Bs,top:Lt,left:Lt,pointerEvents:"none"}})},a)})}):null},Su=e=>{const t=kn(e,"top"),n=kn(e,"bottom"),s=kn(e,"left"),r=kn(e,"right");return v.useMemo(()=>({top:t,bottom:n,left:s,right:r}),[t,n,s,r])},An=-10,yu=({node:e,isSelected:t,mode:n})=>{const s=t&&n===W.SELECT,r=Su(e);return s?o.jsx(o.Fragment,{children:hu.map(({position:a,cursor:i,classes:l})=>{const c=r[a];return o.jsx("div",{"data-test":`quick-arrow-handle-${a}`,id:`arrow-handle-${e.id}-${a}`,className:ve("absolute border rounded-full z-10","bg-blue-500","border-blue-700",l.replace(/-translate-\w+-1\/2/g,"").trim(),i,"pointer-events-auto"),style:{width:`${mt}px`,height:`${mt}px`,top:l.includes("top-0")?`${An-mt}px`:l.includes("bottom-0")?`calc(100% + ${mt-An}px)`:`calc(50% - ${mt/2}px)`,left:l.includes("left-0")?`${An-mt}px`:l.includes("right-0")?`calc(100% + ${mt-An}px)`:`calc(50% - ${mt/2}px)`},onMouseDown:d=>{d.stopPropagation(),c(d)}},`arrow-${a}`)})}):null},Nu=e=>{const{node:t,mode:n,isPopoverOpen:s,setIsPopoverOpen:r}=e,a=Tc(t),l=_.getState().setSelectedNodes,c=v.useRef({x:NaN,y:NaN});return{handleMouseDown:v.useCallback(u=>{var R;const h={x:u.clientX,y:u.clientY};if(c.current=h,n===W.MOVE)return;const f=u.target,x=(R=_.getState().projectCanvas.getActive())==null?void 0:R.coreState.selectedNodes,p=x==null?void 0:x.some(A=>A.id===t.id),m=p&&(x==null?void 0:x.length)===1,w=f.closest(`[id^="resize-handle-${t.id}-"]`),S=f.closest(`[id^="arrow-handle-${t.id}-"]`),y=f.closest("[data-drag-handle]"),C=(f.tagName==="TEXTAREA"||f.closest("textarea")||f.closest("[contenteditable]")||f.closest("[data-node-textarea]")||f.closest(".markdown-textarea")||f.closest("[data-text-node-click-overlay]")||f.isContentEditable||f.closest("[data-text-position-container]"))&&!t.isEditing&&m,I=f.closest(".audio-button-wrapper")||f.closest(".voice-input-button")||f.closest(".nav-button")||f.closest(".chunk-counter");if(C){const A=_.getState(),k=u.clientX,b=u.clientY;r(!1);const T=document.querySelector(`#NodeContainerV2-${t.id} .markdown-textarea`);if(T){T.contentEditable="true",T.focus({preventScroll:!0});const E=document.querySelector(`#NodeContainerV2-${t.id} [data-text-node-click-overlay]`);E&&(E.style.display="none")}A.updateNode(t.id,{isEditing:!0}),A.setNodeToFocusId(t.id),Yr(b)&&Gr({nodeId:t.id,nodeY:t.y,source:"existingNode"}),requestAnimationFrame(()=>{try{let E=null;if(document.caretRangeFromPoint)E=document.caretRangeFromPoint(k,b);else if(document.caretPositionFromPoint){const D=document.caretPositionFromPoint(k,b);D&&(E=document.createRange(),E.setStart(D.offsetNode,D.offset),E.collapse(!0))}if(E){const D=window.getSelection();D&&(D.removeAllRanges(),D.addRange(E))}}catch{}});return}if(w||S||y||I){r(!1);return}p||r(!1),!t.isEditing&&!C&&a(u)},[t,l,a,n,s,r]),initialClickPoint:c}};/**
   * table-core
   *
   * Copyright (c) TanStack
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE.md file in the root directory of this source tree.
   *
   * @license MIT
   */function yt(e,t){return typeof e=="function"?e(t):e}function et(e,t){return n=>{t.setState(s=>({...s,[e]:yt(n,s[e])}))}}function ds(e){return e instanceof Function}function Cu(e){return Array.isArray(e)&&e.every(t=>typeof t=="number")}function bu(e,t){const n=[],s=r=>{r.forEach(a=>{n.push(a);const i=t(a);i!=null&&i.length&&s(i)})};return s(e),n}function re(e,t,n){let s=[],r;return a=>{let i;n.key&&n.debug&&(i=Date.now());const l=e(a);if(!(l.length!==s.length||l.some((u,h)=>s[h]!==u)))return r;s=l;let d;if(n.key&&n.debug&&(d=Date.now()),r=t(...l),n==null||n.onChange==null||n.onChange(r),n.key&&n.debug&&n!=null&&n.debug()){const u=Math.round((Date.now()-i)*100)/100,h=Math.round((Date.now()-d)*100)/100,f=h/16,g=(x,p)=>{for(x=String(x);x.length<p;)x=" "+x;return x};console.info(`%câ± ${g(h,5)} /${g(u,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*f,120))}deg 100% 31%);`,n==null?void 0:n.key)}return r}}function ae(e,t,n,s){return{debug:()=>{var r;return(r=e==null?void 0:e.debugAll)!=null?r:e[t]},key:!1,onChange:s}}function ju(e,t,n,s){const r=()=>{var i;return(i=a.getValue())!=null?i:e.options.renderFallbackValue},a={id:`${t.id}_${n.id}`,row:t,column:n,getValue:()=>t.getValue(s),renderValue:r,getContext:re(()=>[e,n,t,a],(i,l,c,d)=>({table:i,column:l,row:c,cell:d,getValue:d.getValue,renderValue:d.renderValue}),ae(e.options,"debugCells"))};return e._features.forEach(i=>{i.createCell==null||i.createCell(a,n,t,e)},{}),a}function ku(e,t,n,s){var r,a;const l={...e._getDefaultColumnDef(),...t},c=l.accessorKey;let d=(r=(a=l.id)!=null?a:c?typeof String.prototype.replaceAll=="function"?c.replaceAll(".","_"):c.replace(/\./g,"_"):void 0)!=null?r:typeof l.header=="string"?l.header:void 0,u;if(l.accessorFn?u=l.accessorFn:c&&(c.includes(".")?u=f=>{let g=f;for(const p of c.split(".")){var x;g=(x=g)==null?void 0:x[p]}return g}:u=f=>f[l.accessorKey]),!d)throw new Error;let h={id:`${String(d)}`,accessorFn:u,parent:s,depth:n,columnDef:l,columns:[],getFlatColumns:re(()=>[!0],()=>{var f;return[h,...(f=h.columns)==null?void 0:f.flatMap(g=>g.getFlatColumns())]},ae(e.options,"debugColumns")),getLeafColumns:re(()=>[e._getOrderColumnsFn()],f=>{var g;if((g=h.columns)!=null&&g.length){let x=h.columns.flatMap(p=>p.getLeafColumns());return f(x)}return[h]},ae(e.options,"debugColumns"))};for(const f of e._features)f.createColumn==null||f.createColumn(h,e);return h}const Xe="debugHeaders";function rr(e,t,n){var s;let a={id:(s=n.id)!=null?s:t.id,column:t,index:n.index,isPlaceholder:!!n.isPlaceholder,placeholderId:n.placeholderId,depth:n.depth,subHeaders:[],colSpan:0,rowSpan:0,headerGroup:null,getLeafHeaders:()=>{const i=[],l=c=>{c.subHeaders&&c.subHeaders.length&&c.subHeaders.map(l),i.push(c)};return l(a),i},getContext:()=>({table:e,header:a,column:t})};return e._features.forEach(i=>{i.createHeader==null||i.createHeader(a,e)}),a}const Iu={createTable:e=>{e.getHeaderGroups=re(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.left,e.getState().columnPinning.right],(t,n,s,r)=>{var a,i;const l=(a=s==null?void 0:s.map(h=>n.find(f=>f.id===h)).filter(Boolean))!=null?a:[],c=(i=r==null?void 0:r.map(h=>n.find(f=>f.id===h)).filter(Boolean))!=null?i:[],d=n.filter(h=>!(s!=null&&s.includes(h.id))&&!(r!=null&&r.includes(h.id)));return En(t,[...l,...d,...c],e)},ae(e.options,Xe)),e.getCenterHeaderGroups=re(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.left,e.getState().columnPinning.right],(t,n,s,r)=>(n=n.filter(a=>!(s!=null&&s.includes(a.id))&&!(r!=null&&r.includes(a.id))),En(t,n,e,"center")),ae(e.options,Xe)),e.getLeftHeaderGroups=re(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.left],(t,n,s)=>{var r;const a=(r=s==null?void 0:s.map(i=>n.find(l=>l.id===i)).filter(Boolean))!=null?r:[];return En(t,a,e,"left")},ae(e.options,Xe)),e.getRightHeaderGroups=re(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.right],(t,n,s)=>{var r;const a=(r=s==null?void 0:s.map(i=>n.find(l=>l.id===i)).filter(Boolean))!=null?r:[];return En(t,a,e,"right")},ae(e.options,Xe)),e.getFooterGroups=re(()=>[e.getHeaderGroups()],t=>[...t].reverse(),ae(e.options,Xe)),e.getLeftFooterGroups=re(()=>[e.getLeftHeaderGroups()],t=>[...t].reverse(),ae(e.options,Xe)),e.getCenterFooterGroups=re(()=>[e.getCenterHeaderGroups()],t=>[...t].reverse(),ae(e.options,Xe)),e.getRightFooterGroups=re(()=>[e.getRightHeaderGroups()],t=>[...t].reverse(),ae(e.options,Xe)),e.getFlatHeaders=re(()=>[e.getHeaderGroups()],t=>t.map(n=>n.headers).flat(),ae(e.options,Xe)),e.getLeftFlatHeaders=re(()=>[e.getLeftHeaderGroups()],t=>t.map(n=>n.headers).flat(),ae(e.options,Xe)),e.getCenterFlatHeaders=re(()=>[e.getCenterHeaderGroups()],t=>t.map(n=>n.headers).flat(),ae(e.options,Xe)),e.getRightFlatHeaders=re(()=>[e.getRightHeaderGroups()],t=>t.map(n=>n.headers).flat(),ae(e.options,Xe)),e.getCenterLeafHeaders=re(()=>[e.getCenterFlatHeaders()],t=>t.filter(n=>{var s;return!((s=n.subHeaders)!=null&&s.length)}),ae(e.options,Xe)),e.getLeftLeafHeaders=re(()=>[e.getLeftFlatHeaders()],t=>t.filter(n=>{var s;return!((s=n.subHeaders)!=null&&s.length)}),ae(e.options,Xe)),e.getRightLeafHeaders=re(()=>[e.getRightFlatHeaders()],t=>t.filter(n=>{var s;return!((s=n.subHeaders)!=null&&s.length)}),ae(e.options,Xe)),e.getLeafHeaders=re(()=>[e.getLeftHeaderGroups(),e.getCenterHeaderGroups(),e.getRightHeaderGroups()],(t,n,s)=>{var r,a,i,l,c,d;return[...(r=(a=t[0])==null?void 0:a.headers)!=null?r:[],...(i=(l=n[0])==null?void 0:l.headers)!=null?i:[],...(c=(d=s[0])==null?void 0:d.headers)!=null?c:[]].map(u=>u.getLeafHeaders()).flat()},ae(e.options,Xe))}};function En(e,t,n,s){var r,a;let i=0;const l=function(f,g){g===void 0&&(g=1),i=Math.max(i,g),f.filter(x=>x.getIsVisible()).forEach(x=>{var p;(p=x.columns)!=null&&p.length&&l(x.columns,g+1)},0)};l(e);let c=[];const d=(f,g)=>{const x={depth:g,id:[s,`${g}`].filter(Boolean).join("_"),headers:[]},p=[];f.forEach(m=>{const w=[...p].reverse()[0],S=m.column.depth===x.depth;let y,j=!1;if(S&&m.column.parent?y=m.column.parent:(y=m.column,j=!0),w&&(w==null?void 0:w.column)===y)w.subHeaders.push(m);else{const N=rr(n,y,{id:[s,g,y.id,m==null?void 0:m.id].filter(Boolean).join("_"),isPlaceholder:j,placeholderId:j?`${p.filter(C=>C.column===y).length}`:void 0,depth:g,index:p.length});N.subHeaders.push(m),p.push(N)}x.headers.push(m),m.headerGroup=x}),c.push(x),g>0&&d(p,g-1)},u=t.map((f,g)=>rr(n,f,{depth:i,index:g}));d(u,i-1),c.reverse();const h=f=>f.filter(x=>x.column.getIsVisible()).map(x=>{let p=0,m=0,w=[0];x.subHeaders&&x.subHeaders.length?(w=[],h(x.subHeaders).forEach(y=>{let{colSpan:j,rowSpan:N}=y;p+=j,w.push(N)})):p=1;const S=Math.min(...w);return m=m+S,x.colSpan=p,x.rowSpan=m,{colSpan:p,rowSpan:m}});return h((r=(a=c[0])==null?void 0:a.headers)!=null?r:[]),c}const fo=(e,t,n,s,r,a,i)=>{let l={id:t,index:s,original:n,depth:r,parentId:i,_valuesCache:{},_uniqueValuesCache:{},getValue:c=>{if(l._valuesCache.hasOwnProperty(c))return l._valuesCache[c];const d=e.getColumn(c);if(d!=null&&d.accessorFn)return l._valuesCache[c]=d.accessorFn(l.original,s),l._valuesCache[c]},getUniqueValues:c=>{if(l._uniqueValuesCache.hasOwnProperty(c))return l._uniqueValuesCache[c];const d=e.getColumn(c);if(d!=null&&d.accessorFn)return d.columnDef.getUniqueValues?(l._uniqueValuesCache[c]=d.columnDef.getUniqueValues(l.original,s),l._uniqueValuesCache[c]):(l._uniqueValuesCache[c]=[l.getValue(c)],l._uniqueValuesCache[c])},renderValue:c=>{var d;return(d=l.getValue(c))!=null?d:e.options.renderFallbackValue},subRows:[],getLeafRows:()=>bu(l.subRows,c=>c.subRows),getParentRow:()=>l.parentId?e.getRow(l.parentId,!0):void 0,getParentRows:()=>{let c=[],d=l;for(;;){const u=d.getParentRow();if(!u)break;c.push(u),d=u}return c.reverse()},getAllCells:re(()=>[e.getAllLeafColumns()],c=>c.map(d=>ju(e,l,d,d.id)),ae(e.options,"debugRows")),_getAllCellsByColumnId:re(()=>[l.getAllCells()],c=>c.reduce((d,u)=>(d[u.column.id]=u,d),{}),ae(e.options,"debugRows"))};for(let c=0;c<e._features.length;c++){const d=e._features[c];d==null||d.createRow==null||d.createRow(l,e)}return l},Ru={createColumn:(e,t)=>{e._getFacetedRowModel=t.options.getFacetedRowModel&&t.options.getFacetedRowModel(t,e.id),e.getFacetedRowModel=()=>e._getFacetedRowModel?e._getFacetedRowModel():t.getPreFilteredRowModel(),e._getFacetedUniqueValues=t.options.getFacetedUniqueValues&&t.options.getFacetedUniqueValues(t,e.id),e.getFacetedUniqueValues=()=>e._getFacetedUniqueValues?e._getFacetedUniqueValues():new Map,e._getFacetedMinMaxValues=t.options.getFacetedMinMaxValues&&t.options.getFacetedMinMaxValues(t,e.id),e.getFacetedMinMaxValues=()=>{if(e._getFacetedMinMaxValues)return e._getFacetedMinMaxValues()}}},Qr=(e,t,n)=>{var s,r;const a=n==null||(s=n.toString())==null?void 0:s.toLowerCase();return!!(!((r=e.getValue(t))==null||(r=r.toString())==null||(r=r.toLowerCase())==null)&&r.includes(a))};Qr.autoRemove=e=>rt(e);const ea=(e,t,n)=>{var s;return!!(!((s=e.getValue(t))==null||(s=s.toString())==null)&&s.includes(n))};ea.autoRemove=e=>rt(e);const ta=(e,t,n)=>{var s;return((s=e.getValue(t))==null||(s=s.toString())==null?void 0:s.toLowerCase())===(n==null?void 0:n.toLowerCase())};ta.autoRemove=e=>rt(e);const na=(e,t,n)=>{var s;return(s=e.getValue(t))==null?void 0:s.includes(n)};na.autoRemove=e=>rt(e);const sa=(e,t,n)=>!n.some(s=>{var r;return!((r=e.getValue(t))!=null&&r.includes(s))});sa.autoRemove=e=>rt(e)||!(e!=null&&e.length);const oa=(e,t,n)=>n.some(s=>{var r;return(r=e.getValue(t))==null?void 0:r.includes(s)});oa.autoRemove=e=>rt(e)||!(e!=null&&e.length);const ra=(e,t,n)=>e.getValue(t)===n;ra.autoRemove=e=>rt(e);const aa=(e,t,n)=>e.getValue(t)==n;aa.autoRemove=e=>rt(e);const ho=(e,t,n)=>{let[s,r]=n;const a=e.getValue(t);return a>=s&&a<=r};ho.resolveFilterValue=e=>{let[t,n]=e,s=typeof t!="number"?parseFloat(t):t,r=typeof n!="number"?parseFloat(n):n,a=t===null||Number.isNaN(s)?-1/0:s,i=n===null||Number.isNaN(r)?1/0:r;if(a>i){const l=a;a=i,i=l}return[a,i]};ho.autoRemove=e=>rt(e)||rt(e[0])&&rt(e[1]);const ht={includesString:Qr,includesStringSensitive:ea,equalsString:ta,arrIncludes:na,arrIncludesAll:sa,arrIncludesSome:oa,equals:ra,weakEquals:aa,inNumberRange:ho};function rt(e){return e==null||e===""}const Au={getDefaultColumnDef:()=>({filterFn:"auto"}),getInitialState:e=>({columnFilters:[],...e}),getDefaultOptions:e=>({onColumnFiltersChange:et("columnFilters",e),filterFromLeafRows:!1,maxLeafRowFilterDepth:100}),createColumn:(e,t)=>{e.getAutoFilterFn=()=>{const n=t.getCoreRowModel().flatRows[0],s=n==null?void 0:n.getValue(e.id);return typeof s=="string"?ht.includesString:typeof s=="number"?ht.inNumberRange:typeof s=="boolean"||s!==null&&typeof s=="object"?ht.equals:Array.isArray(s)?ht.arrIncludes:ht.weakEquals},e.getFilterFn=()=>{var n,s;return ds(e.columnDef.filterFn)?e.columnDef.filterFn:e.columnDef.filterFn==="auto"?e.getAutoFilterFn():(n=(s=t.options.filterFns)==null?void 0:s[e.columnDef.filterFn])!=null?n:ht[e.columnDef.filterFn]},e.getCanFilter=()=>{var n,s,r;return((n=e.columnDef.enableColumnFilter)!=null?n:!0)&&((s=t.options.enableColumnFilters)!=null?s:!0)&&((r=t.options.enableFilters)!=null?r:!0)&&!!e.accessorFn},e.getIsFiltered=()=>e.getFilterIndex()>-1,e.getFilterValue=()=>{var n;return(n=t.getState().columnFilters)==null||(n=n.find(s=>s.id===e.id))==null?void 0:n.value},e.getFilterIndex=()=>{var n,s;return(n=(s=t.getState().columnFilters)==null?void 0:s.findIndex(r=>r.id===e.id))!=null?n:-1},e.setFilterValue=n=>{t.setColumnFilters(s=>{const r=e.getFilterFn(),a=s==null?void 0:s.find(u=>u.id===e.id),i=yt(n,a?a.value:void 0);if(ar(r,i,e)){var l;return(l=s==null?void 0:s.filter(u=>u.id!==e.id))!=null?l:[]}const c={id:e.id,value:i};if(a){var d;return(d=s==null?void 0:s.map(u=>u.id===e.id?c:u))!=null?d:[]}return s!=null&&s.length?[...s,c]:[c]})}},createRow:(e,t)=>{e.columnFilters={},e.columnFiltersMeta={}},createTable:e=>{e.setColumnFilters=t=>{const n=e.getAllLeafColumns(),s=r=>{var a;return(a=yt(t,r))==null?void 0:a.filter(i=>{const l=n.find(c=>c.id===i.id);if(l){const c=l.getFilterFn();if(ar(c,i.value,l))return!1}return!0})};e.options.onColumnFiltersChange==null||e.options.onColumnFiltersChange(s)},e.resetColumnFilters=t=>{var n,s;e.setColumnFilters(t?[]:(n=(s=e.initialState)==null?void 0:s.columnFilters)!=null?n:[])},e.getPreFilteredRowModel=()=>e.getCoreRowModel(),e.getFilteredRowModel=()=>(!e._getFilteredRowModel&&e.options.getFilteredRowModel&&(e._getFilteredRowModel=e.options.getFilteredRowModel(e)),e.options.manualFiltering||!e._getFilteredRowModel?e.getPreFilteredRowModel():e._getFilteredRowModel())}};function ar(e,t,n){return(e&&e.autoRemove?e.autoRemove(t,n):!1)||typeof t>"u"||typeof t=="string"&&!t}const Eu=(e,t,n)=>n.reduce((s,r)=>{const a=r.getValue(e);return s+(typeof a=="number"?a:0)},0),Tu=(e,t,n)=>{let s;return n.forEach(r=>{const a=r.getValue(e);a!=null&&(s>a||s===void 0&&a>=a)&&(s=a)}),s},Mu=(e,t,n)=>{let s;return n.forEach(r=>{const a=r.getValue(e);a!=null&&(s<a||s===void 0&&a>=a)&&(s=a)}),s},Du=(e,t,n)=>{let s,r;return n.forEach(a=>{const i=a.getValue(e);i!=null&&(s===void 0?i>=i&&(s=r=i):(s>i&&(s=i),r<i&&(r=i)))}),[s,r]},Pu=(e,t)=>{let n=0,s=0;if(t.forEach(r=>{let a=r.getValue(e);a!=null&&(a=+a)>=a&&(++n,s+=a)}),n)return s/n},_u=(e,t)=>{if(!t.length)return;const n=t.map(a=>a.getValue(e));if(!Cu(n))return;if(n.length===1)return n[0];const s=Math.floor(n.length/2),r=n.sort((a,i)=>a-i);return n.length%2!==0?r[s]:(r[s-1]+r[s])/2},Ou=(e,t)=>Array.from(new Set(t.map(n=>n.getValue(e))).values()),$u=(e,t)=>new Set(t.map(n=>n.getValue(e))).size,Fu=(e,t)=>t.length,vs={sum:Eu,min:Tu,max:Mu,extent:Du,mean:Pu,median:_u,unique:Ou,uniqueCount:$u,count:Fu},Lu={getDefaultColumnDef:()=>({aggregatedCell:e=>{var t,n;return(t=(n=e.getValue())==null||n.toString==null?void 0:n.toString())!=null?t:null},aggregationFn:"auto"}),getInitialState:e=>({grouping:[],...e}),getDefaultOptions:e=>({onGroupingChange:et("grouping",e),groupedColumnMode:"reorder"}),createColumn:(e,t)=>{e.toggleGrouping=()=>{t.setGrouping(n=>n!=null&&n.includes(e.id)?n.filter(s=>s!==e.id):[...n??[],e.id])},e.getCanGroup=()=>{var n,s;return((n=e.columnDef.enableGrouping)!=null?n:!0)&&((s=t.options.enableGrouping)!=null?s:!0)&&(!!e.accessorFn||!!e.columnDef.getGroupingValue)},e.getIsGrouped=()=>{var n;return(n=t.getState().grouping)==null?void 0:n.includes(e.id)},e.getGroupedIndex=()=>{var n;return(n=t.getState().grouping)==null?void 0:n.indexOf(e.id)},e.getToggleGroupingHandler=()=>{const n=e.getCanGroup();return()=>{n&&e.toggleGrouping()}},e.getAutoAggregationFn=()=>{const n=t.getCoreRowModel().flatRows[0],s=n==null?void 0:n.getValue(e.id);if(typeof s=="number")return vs.sum;if(Object.prototype.toString.call(s)==="[object Date]")return vs.extent},e.getAggregationFn=()=>{var n,s;if(!e)throw new Error;return ds(e.columnDef.aggregationFn)?e.columnDef.aggregationFn:e.columnDef.aggregationFn==="auto"?e.getAutoAggregationFn():(n=(s=t.options.aggregationFns)==null?void 0:s[e.columnDef.aggregationFn])!=null?n:vs[e.columnDef.aggregationFn]}},createTable:e=>{e.setGrouping=t=>e.options.onGroupingChange==null?void 0:e.options.onGroupingChange(t),e.resetGrouping=t=>{var n,s;e.setGrouping(t?[]:(n=(s=e.initialState)==null?void 0:s.grouping)!=null?n:[])},e.getPreGroupedRowModel=()=>e.getFilteredRowModel(),e.getGroupedRowModel=()=>(!e._getGroupedRowModel&&e.options.getGroupedRowModel&&(e._getGroupedRowModel=e.options.getGroupedRowModel(e)),e.options.manualGrouping||!e._getGroupedRowModel?e.getPreGroupedRowModel():e._getGroupedRowModel())},createRow:(e,t)=>{e.getIsGrouped=()=>!!e.groupingColumnId,e.getGroupingValue=n=>{if(e._groupingValuesCache.hasOwnProperty(n))return e._groupingValuesCache[n];const s=t.getColumn(n);return s!=null&&s.columnDef.getGroupingValue?(e._groupingValuesCache[n]=s.columnDef.getGroupingValue(e.original),e._groupingValuesCache[n]):e.getValue(n)},e._groupingValuesCache={}},createCell:(e,t,n,s)=>{e.getIsGrouped=()=>t.getIsGrouped()&&t.id===n.groupingColumnId,e.getIsPlaceholder=()=>!e.getIsGrouped()&&t.getIsGrouped(),e.getIsAggregated=()=>{var r;return!e.getIsGrouped()&&!e.getIsPlaceholder()&&!!((r=n.subRows)!=null&&r.length)}}};function Hu(e,t,n){if(!(t!=null&&t.length)||!n)return e;const s=e.filter(a=>!t.includes(a.id));return n==="remove"?s:[...t.map(a=>e.find(i=>i.id===a)).filter(Boolean),...s]}const zu={getInitialState:e=>({columnOrder:[],...e}),getDefaultOptions:e=>({onColumnOrderChange:et("columnOrder",e)}),createColumn:(e,t)=>{e.getIndex=re(n=>[fn(t,n)],n=>n.findIndex(s=>s.id===e.id),ae(t.options,"debugColumns")),e.getIsFirstColumn=n=>{var s;return((s=fn(t,n)[0])==null?void 0:s.id)===e.id},e.getIsLastColumn=n=>{var s;const r=fn(t,n);return((s=r[r.length-1])==null?void 0:s.id)===e.id}},createTable:e=>{e.setColumnOrder=t=>e.options.onColumnOrderChange==null?void 0:e.options.onColumnOrderChange(t),e.resetColumnOrder=t=>{var n;e.setColumnOrder(t?[]:(n=e.initialState.columnOrder)!=null?n:[])},e._getOrderColumnsFn=re(()=>[e.getState().columnOrder,e.getState().grouping,e.options.groupedColumnMode],(t,n,s)=>r=>{let a=[];if(!(t!=null&&t.length))a=r;else{const i=[...t],l=[...r];for(;l.length&&i.length;){const c=i.shift(),d=l.findIndex(u=>u.id===c);d>-1&&a.push(l.splice(d,1)[0])}a=[...a,...l]}return Hu(a,n,s)},ae(e.options,"debugTable"))}},Ss=()=>({left:[],right:[]}),Wu={getInitialState:e=>({columnPinning:Ss(),...e}),getDefaultOptions:e=>({onColumnPinningChange:et("columnPinning",e)}),createColumn:(e,t)=>{e.pin=n=>{const s=e.getLeafColumns().map(r=>r.id).filter(Boolean);t.setColumnPinning(r=>{var a,i;if(n==="right"){var l,c;return{left:((l=r==null?void 0:r.left)!=null?l:[]).filter(h=>!(s!=null&&s.includes(h))),right:[...((c=r==null?void 0:r.right)!=null?c:[]).filter(h=>!(s!=null&&s.includes(h))),...s]}}if(n==="left"){var d,u;return{left:[...((d=r==null?void 0:r.left)!=null?d:[]).filter(h=>!(s!=null&&s.includes(h))),...s],right:((u=r==null?void 0:r.right)!=null?u:[]).filter(h=>!(s!=null&&s.includes(h)))}}return{left:((a=r==null?void 0:r.left)!=null?a:[]).filter(h=>!(s!=null&&s.includes(h))),right:((i=r==null?void 0:r.right)!=null?i:[]).filter(h=>!(s!=null&&s.includes(h)))}})},e.getCanPin=()=>e.getLeafColumns().some(s=>{var r,a,i;return((r=s.columnDef.enablePinning)!=null?r:!0)&&((a=(i=t.options.enableColumnPinning)!=null?i:t.options.enablePinning)!=null?a:!0)}),e.getIsPinned=()=>{const n=e.getLeafColumns().map(l=>l.id),{left:s,right:r}=t.getState().columnPinning,a=n.some(l=>s==null?void 0:s.includes(l)),i=n.some(l=>r==null?void 0:r.includes(l));return a?"left":i?"right":!1},e.getPinnedIndex=()=>{var n,s;const r=e.getIsPinned();return r?(n=(s=t.getState().columnPinning)==null||(s=s[r])==null?void 0:s.indexOf(e.id))!=null?n:-1:0}},createRow:(e,t)=>{e.getCenterVisibleCells=re(()=>[e._getAllVisibleCells(),t.getState().columnPinning.left,t.getState().columnPinning.right],(n,s,r)=>{const a=[...s??[],...r??[]];return n.filter(i=>!a.includes(i.column.id))},ae(t.options,"debugRows")),e.getLeftVisibleCells=re(()=>[e._getAllVisibleCells(),t.getState().columnPinning.left],(n,s)=>(s??[]).map(a=>n.find(i=>i.column.id===a)).filter(Boolean).map(a=>({...a,position:"left"})),ae(t.options,"debugRows")),e.getRightVisibleCells=re(()=>[e._getAllVisibleCells(),t.getState().columnPinning.right],(n,s)=>(s??[]).map(a=>n.find(i=>i.column.id===a)).filter(Boolean).map(a=>({...a,position:"right"})),ae(t.options,"debugRows"))},createTable:e=>{e.setColumnPinning=t=>e.options.onColumnPinningChange==null?void 0:e.options.onColumnPinningChange(t),e.resetColumnPinning=t=>{var n,s;return e.setColumnPinning(t?Ss():(n=(s=e.initialState)==null?void 0:s.columnPinning)!=null?n:Ss())},e.getIsSomeColumnsPinned=t=>{var n;const s=e.getState().columnPinning;if(!t){var r,a;return!!((r=s.left)!=null&&r.length||(a=s.right)!=null&&a.length)}return!!((n=s[t])!=null&&n.length)},e.getLeftLeafColumns=re(()=>[e.getAllLeafColumns(),e.getState().columnPinning.left],(t,n)=>(n??[]).map(s=>t.find(r=>r.id===s)).filter(Boolean),ae(e.options,"debugColumns")),e.getRightLeafColumns=re(()=>[e.getAllLeafColumns(),e.getState().columnPinning.right],(t,n)=>(n??[]).map(s=>t.find(r=>r.id===s)).filter(Boolean),ae(e.options,"debugColumns")),e.getCenterLeafColumns=re(()=>[e.getAllLeafColumns(),e.getState().columnPinning.left,e.getState().columnPinning.right],(t,n,s)=>{const r=[...n??[],...s??[]];return t.filter(a=>!r.includes(a.id))},ae(e.options,"debugColumns"))}};function Bu(e){return e||(typeof document<"u"?document:null)}const Tn={size:150,minSize:20,maxSize:Number.MAX_SAFE_INTEGER},ys=()=>({startOffset:null,startSize:null,deltaOffset:null,deltaPercentage:null,isResizingColumn:!1,columnSizingStart:[]}),Vu={getDefaultColumnDef:()=>Tn,getInitialState:e=>({columnSizing:{},columnSizingInfo:ys(),...e}),getDefaultOptions:e=>({columnResizeMode:"onEnd",columnResizeDirection:"ltr",onColumnSizingChange:et("columnSizing",e),onColumnSizingInfoChange:et("columnSizingInfo",e)}),createColumn:(e,t)=>{e.getSize=()=>{var n,s,r;const a=t.getState().columnSizing[e.id];return Math.min(Math.max((n=e.columnDef.minSize)!=null?n:Tn.minSize,(s=a??e.columnDef.size)!=null?s:Tn.size),(r=e.columnDef.maxSize)!=null?r:Tn.maxSize)},e.getStart=re(n=>[n,fn(t,n),t.getState().columnSizing],(n,s)=>s.slice(0,e.getIndex(n)).reduce((r,a)=>r+a.getSize(),0),ae(t.options,"debugColumns")),e.getAfter=re(n=>[n,fn(t,n),t.getState().columnSizing],(n,s)=>s.slice(e.getIndex(n)+1).reduce((r,a)=>r+a.getSize(),0),ae(t.options,"debugColumns")),e.resetSize=()=>{t.setColumnSizing(n=>{let{[e.id]:s,...r}=n;return r})},e.getCanResize=()=>{var n,s;return((n=e.columnDef.enableResizing)!=null?n:!0)&&((s=t.options.enableColumnResizing)!=null?s:!0)},e.getIsResizing=()=>t.getState().columnSizingInfo.isResizingColumn===e.id},createHeader:(e,t)=>{e.getSize=()=>{let n=0;const s=r=>{if(r.subHeaders.length)r.subHeaders.forEach(s);else{var a;n+=(a=r.column.getSize())!=null?a:0}};return s(e),n},e.getStart=()=>{if(e.index>0){const n=e.headerGroup.headers[e.index-1];return n.getStart()+n.getSize()}return 0},e.getResizeHandler=n=>{const s=t.getColumn(e.column.id),r=s==null?void 0:s.getCanResize();return a=>{if(!s||!r||(a.persist==null||a.persist(),Ns(a)&&a.touches&&a.touches.length>1))return;const i=e.getSize(),l=e?e.getLeafHeaders().map(w=>[w.column.id,w.column.getSize()]):[[s.id,s.getSize()]],c=Ns(a)?Math.round(a.touches[0].clientX):a.clientX,d={},u=(w,S)=>{typeof S=="number"&&(t.setColumnSizingInfo(y=>{var j,N;const C=t.options.columnResizeDirection==="rtl"?-1:1,I=(S-((j=y==null?void 0:y.startOffset)!=null?j:0))*C,R=Math.max(I/((N=y==null?void 0:y.startSize)!=null?N:0),-.999999);return y.columnSizingStart.forEach(A=>{let[k,b]=A;d[k]=Math.round(Math.max(b+b*R,0)*100)/100}),{...y,deltaOffset:I,deltaPercentage:R}}),(t.options.columnResizeMode==="onChange"||w==="end")&&t.setColumnSizing(y=>({...y,...d})))},h=w=>u("move",w),f=w=>{u("end",w),t.setColumnSizingInfo(S=>({...S,isResizingColumn:!1,startOffset:null,startSize:null,deltaOffset:null,deltaPercentage:null,columnSizingStart:[]}))},g=Bu(n),x={moveHandler:w=>h(w.clientX),upHandler:w=>{g==null||g.removeEventListener("mousemove",x.moveHandler),g==null||g.removeEventListener("mouseup",x.upHandler),f(w.clientX)}},p={moveHandler:w=>(w.cancelable&&(w.preventDefault(),w.stopPropagation()),h(w.touches[0].clientX),!1),upHandler:w=>{var S;g==null||g.removeEventListener("touchmove",p.moveHandler),g==null||g.removeEventListener("touchend",p.upHandler),w.cancelable&&(w.preventDefault(),w.stopPropagation()),f((S=w.touches[0])==null?void 0:S.clientX)}},m=Uu()?{passive:!1}:!1;Ns(a)?(g==null||g.addEventListener("touchmove",p.moveHandler,m),g==null||g.addEventListener("touchend",p.upHandler,m)):(g==null||g.addEventListener("mousemove",x.moveHandler,m),g==null||g.addEventListener("mouseup",x.upHandler,m)),t.setColumnSizingInfo(w=>({...w,startOffset:c,startSize:i,deltaOffset:0,deltaPercentage:0,columnSizingStart:l,isResizingColumn:s.id}))}}},createTable:e=>{e.setColumnSizing=t=>e.options.onColumnSizingChange==null?void 0:e.options.onColumnSizingChange(t),e.setColumnSizingInfo=t=>e.options.onColumnSizingInfoChange==null?void 0:e.options.onColumnSizingInfoChange(t),e.resetColumnSizing=t=>{var n;e.setColumnSizing(t?{}:(n=e.initialState.columnSizing)!=null?n:{})},e.resetHeaderSizeInfo=t=>{var n;e.setColumnSizingInfo(t?ys():(n=e.initialState.columnSizingInfo)!=null?n:ys())},e.getTotalSize=()=>{var t,n;return(t=(n=e.getHeaderGroups()[0])==null?void 0:n.headers.reduce((s,r)=>s+r.getSize(),0))!=null?t:0},e.getLeftTotalSize=()=>{var t,n;return(t=(n=e.getLeftHeaderGroups()[0])==null?void 0:n.headers.reduce((s,r)=>s+r.getSize(),0))!=null?t:0},e.getCenterTotalSize=()=>{var t,n;return(t=(n=e.getCenterHeaderGroups()[0])==null?void 0:n.headers.reduce((s,r)=>s+r.getSize(),0))!=null?t:0},e.getRightTotalSize=()=>{var t,n;return(t=(n=e.getRightHeaderGroups()[0])==null?void 0:n.headers.reduce((s,r)=>s+r.getSize(),0))!=null?t:0}}};let Mn=null;function Uu(){if(typeof Mn=="boolean")return Mn;let e=!1;try{const t={get passive(){return e=!0,!1}},n=()=>{};window.addEventListener("test",n,t),window.removeEventListener("test",n)}catch{e=!1}return Mn=e,Mn}function Ns(e){return e.type==="touchstart"}const Gu={getInitialState:e=>({columnVisibility:{},...e}),getDefaultOptions:e=>({onColumnVisibilityChange:et("columnVisibility",e)}),createColumn:(e,t)=>{e.toggleVisibility=n=>{e.getCanHide()&&t.setColumnVisibility(s=>({...s,[e.id]:n??!e.getIsVisible()}))},e.getIsVisible=()=>{var n,s;const r=e.columns;return(n=r.length?r.some(a=>a.getIsVisible()):(s=t.getState().columnVisibility)==null?void 0:s[e.id])!=null?n:!0},e.getCanHide=()=>{var n,s;return((n=e.columnDef.enableHiding)!=null?n:!0)&&((s=t.options.enableHiding)!=null?s:!0)},e.getToggleVisibilityHandler=()=>n=>{e.toggleVisibility==null||e.toggleVisibility(n.target.checked)}},createRow:(e,t)=>{e._getAllVisibleCells=re(()=>[e.getAllCells(),t.getState().columnVisibility],n=>n.filter(s=>s.column.getIsVisible()),ae(t.options,"debugRows")),e.getVisibleCells=re(()=>[e.getLeftVisibleCells(),e.getCenterVisibleCells(),e.getRightVisibleCells()],(n,s,r)=>[...n,...s,...r],ae(t.options,"debugRows"))},createTable:e=>{const t=(n,s)=>re(()=>[s(),s().filter(r=>r.getIsVisible()).map(r=>r.id).join("_")],r=>r.filter(a=>a.getIsVisible==null?void 0:a.getIsVisible()),ae(e.options,"debugColumns"));e.getVisibleFlatColumns=t("getVisibleFlatColumns",()=>e.getAllFlatColumns()),e.getVisibleLeafColumns=t("getVisibleLeafColumns",()=>e.getAllLeafColumns()),e.getLeftVisibleLeafColumns=t("getLeftVisibleLeafColumns",()=>e.getLeftLeafColumns()),e.getRightVisibleLeafColumns=t("getRightVisibleLeafColumns",()=>e.getRightLeafColumns()),e.getCenterVisibleLeafColumns=t("getCenterVisibleLeafColumns",()=>e.getCenterLeafColumns()),e.setColumnVisibility=n=>e.options.onColumnVisibilityChange==null?void 0:e.options.onColumnVisibilityChange(n),e.resetColumnVisibility=n=>{var s;e.setColumnVisibility(n?{}:(s=e.initialState.columnVisibility)!=null?s:{})},e.toggleAllColumnsVisible=n=>{var s;n=(s=n)!=null?s:!e.getIsAllColumnsVisible(),e.setColumnVisibility(e.getAllLeafColumns().reduce((r,a)=>({...r,[a.id]:n||!(a.getCanHide!=null&&a.getCanHide())}),{}))},e.getIsAllColumnsVisible=()=>!e.getAllLeafColumns().some(n=>!(n.getIsVisible!=null&&n.getIsVisible())),e.getIsSomeColumnsVisible=()=>e.getAllLeafColumns().some(n=>n.getIsVisible==null?void 0:n.getIsVisible()),e.getToggleAllColumnsVisibilityHandler=()=>n=>{var s;e.toggleAllColumnsVisible((s=n.target)==null?void 0:s.checked)}}};function fn(e,t){return t?t==="center"?e.getCenterVisibleLeafColumns():t==="left"?e.getLeftVisibleLeafColumns():e.getRightVisibleLeafColumns():e.getVisibleLeafColumns()}const Yu={createTable:e=>{e._getGlobalFacetedRowModel=e.options.getFacetedRowModel&&e.options.getFacetedRowModel(e,"__global__"),e.getGlobalFacetedRowModel=()=>e.options.manualFiltering||!e._getGlobalFacetedRowModel?e.getPreFilteredRowModel():e._getGlobalFacetedRowModel(),e._getGlobalFacetedUniqueValues=e.options.getFacetedUniqueValues&&e.options.getFacetedUniqueValues(e,"__global__"),e.getGlobalFacetedUniqueValues=()=>e._getGlobalFacetedUniqueValues?e._getGlobalFacetedUniqueValues():new Map,e._getGlobalFacetedMinMaxValues=e.options.getFacetedMinMaxValues&&e.options.getFacetedMinMaxValues(e,"__global__"),e.getGlobalFacetedMinMaxValues=()=>{if(e._getGlobalFacetedMinMaxValues)return e._getGlobalFacetedMinMaxValues()}}},Xu={getInitialState:e=>({globalFilter:void 0,...e}),getDefaultOptions:e=>({onGlobalFilterChange:et("globalFilter",e),globalFilterFn:"auto",getColumnCanGlobalFilter:t=>{var n;const s=(n=e.getCoreRowModel().flatRows[0])==null||(n=n._getAllCellsByColumnId()[t.id])==null?void 0:n.getValue();return typeof s=="string"||typeof s=="number"}}),createColumn:(e,t)=>{e.getCanGlobalFilter=()=>{var n,s,r,a;return((n=e.columnDef.enableGlobalFilter)!=null?n:!0)&&((s=t.options.enableGlobalFilter)!=null?s:!0)&&((r=t.options.enableFilters)!=null?r:!0)&&((a=t.options.getColumnCanGlobalFilter==null?void 0:t.options.getColumnCanGlobalFilter(e))!=null?a:!0)&&!!e.accessorFn}},createTable:e=>{e.getGlobalAutoFilterFn=()=>ht.includesString,e.getGlobalFilterFn=()=>{var t,n;const{globalFilterFn:s}=e.options;return ds(s)?s:s==="auto"?e.getGlobalAutoFilterFn():(t=(n=e.options.filterFns)==null?void 0:n[s])!=null?t:ht[s]},e.setGlobalFilter=t=>{e.options.onGlobalFilterChange==null||e.options.onGlobalFilterChange(t)},e.resetGlobalFilter=t=>{e.setGlobalFilter(t?void 0:e.initialState.globalFilter)}}},Ku={getInitialState:e=>({expanded:{},...e}),getDefaultOptions:e=>({onExpandedChange:et("expanded",e),paginateExpandedRows:!0}),createTable:e=>{let t=!1,n=!1;e._autoResetExpanded=()=>{var s,r;if(!t){e._queue(()=>{t=!0});return}if((s=(r=e.options.autoResetAll)!=null?r:e.options.autoResetExpanded)!=null?s:!e.options.manualExpanding){if(n)return;n=!0,e._queue(()=>{e.resetExpanded(),n=!1})}},e.setExpanded=s=>e.options.onExpandedChange==null?void 0:e.options.onExpandedChange(s),e.toggleAllRowsExpanded=s=>{s??!e.getIsAllRowsExpanded()?e.setExpanded(!0):e.setExpanded({})},e.resetExpanded=s=>{var r,a;e.setExpanded(s?{}:(r=(a=e.initialState)==null?void 0:a.expanded)!=null?r:{})},e.getCanSomeRowsExpand=()=>e.getPrePaginationRowModel().flatRows.some(s=>s.getCanExpand()),e.getToggleAllRowsExpandedHandler=()=>s=>{s.persist==null||s.persist(),e.toggleAllRowsExpanded()},e.getIsSomeRowsExpanded=()=>{const s=e.getState().expanded;return s===!0||Object.values(s).some(Boolean)},e.getIsAllRowsExpanded=()=>{const s=e.getState().expanded;return typeof s=="boolean"?s===!0:!(!Object.keys(s).length||e.getRowModel().flatRows.some(r=>!r.getIsExpanded()))},e.getExpandedDepth=()=>{let s=0;return(e.getState().expanded===!0?Object.keys(e.getRowModel().rowsById):Object.keys(e.getState().expanded)).forEach(a=>{const i=a.split(".");s=Math.max(s,i.length)}),s},e.getPreExpandedRowModel=()=>e.getSortedRowModel(),e.getExpandedRowModel=()=>(!e._getExpandedRowModel&&e.options.getExpandedRowModel&&(e._getExpandedRowModel=e.options.getExpandedRowModel(e)),e.options.manualExpanding||!e._getExpandedRowModel?e.getPreExpandedRowModel():e._getExpandedRowModel())},createRow:(e,t)=>{e.toggleExpanded=n=>{t.setExpanded(s=>{var r;const a=s===!0?!0:!!(s!=null&&s[e.id]);let i={};if(s===!0?Object.keys(t.getRowModel().rowsById).forEach(l=>{i[l]=!0}):i=s,n=(r=n)!=null?r:!a,!a&&n)return{...i,[e.id]:!0};if(a&&!n){const{[e.id]:l,...c}=i;return c}return s})},e.getIsExpanded=()=>{var n;const s=t.getState().expanded;return!!((n=t.options.getIsRowExpanded==null?void 0:t.options.getIsRowExpanded(e))!=null?n:s===!0||s!=null&&s[e.id])},e.getCanExpand=()=>{var n,s,r;return(n=t.options.getRowCanExpand==null?void 0:t.options.getRowCanExpand(e))!=null?n:((s=t.options.enableExpanding)!=null?s:!0)&&!!((r=e.subRows)!=null&&r.length)},e.getIsAllParentsExpanded=()=>{let n=!0,s=e;for(;n&&s.parentId;)s=t.getRow(s.parentId,!0),n=s.getIsExpanded();return n},e.getToggleExpandedHandler=()=>{const n=e.getCanExpand();return()=>{n&&e.toggleExpanded()}}}},Us=0,Gs=10,Cs=()=>({pageIndex:Us,pageSize:Gs}),qu={getInitialState:e=>({...e,pagination:{...Cs(),...e==null?void 0:e.pagination}}),getDefaultOptions:e=>({onPaginationChange:et("pagination",e)}),createTable:e=>{let t=!1,n=!1;e._autoResetPageIndex=()=>{var s,r;if(!t){e._queue(()=>{t=!0});return}if((s=(r=e.options.autoResetAll)!=null?r:e.options.autoResetPageIndex)!=null?s:!e.options.manualPagination){if(n)return;n=!0,e._queue(()=>{e.resetPageIndex(),n=!1})}},e.setPagination=s=>{const r=a=>yt(s,a);return e.options.onPaginationChange==null?void 0:e.options.onPaginationChange(r)},e.resetPagination=s=>{var r;e.setPagination(s?Cs():(r=e.initialState.pagination)!=null?r:Cs())},e.setPageIndex=s=>{e.setPagination(r=>{let a=yt(s,r.pageIndex);const i=typeof e.options.pageCount>"u"||e.options.pageCount===-1?Number.MAX_SAFE_INTEGER:e.options.pageCount-1;return a=Math.max(0,Math.min(a,i)),{...r,pageIndex:a}})},e.resetPageIndex=s=>{var r,a;e.setPageIndex(s?Us:(r=(a=e.initialState)==null||(a=a.pagination)==null?void 0:a.pageIndex)!=null?r:Us)},e.resetPageSize=s=>{var r,a;e.setPageSize(s?Gs:(r=(a=e.initialState)==null||(a=a.pagination)==null?void 0:a.pageSize)!=null?r:Gs)},e.setPageSize=s=>{e.setPagination(r=>{const a=Math.max(1,yt(s,r.pageSize)),i=r.pageSize*r.pageIndex,l=Math.floor(i/a);return{...r,pageIndex:l,pageSize:a}})},e.setPageCount=s=>e.setPagination(r=>{var a;let i=yt(s,(a=e.options.pageCount)!=null?a:-1);return typeof i=="number"&&(i=Math.max(-1,i)),{...r,pageCount:i}}),e.getPageOptions=re(()=>[e.getPageCount()],s=>{let r=[];return s&&s>0&&(r=[...new Array(s)].fill(null).map((a,i)=>i)),r},ae(e.options,"debugTable")),e.getCanPreviousPage=()=>e.getState().pagination.pageIndex>0,e.getCanNextPage=()=>{const{pageIndex:s}=e.getState().pagination,r=e.getPageCount();return r===-1?!0:r===0?!1:s<r-1},e.previousPage=()=>e.setPageIndex(s=>s-1),e.nextPage=()=>e.setPageIndex(s=>s+1),e.firstPage=()=>e.setPageIndex(0),e.lastPage=()=>e.setPageIndex(e.getPageCount()-1),e.getPrePaginationRowModel=()=>e.getExpandedRowModel(),e.getPaginationRowModel=()=>(!e._getPaginationRowModel&&e.options.getPaginationRowModel&&(e._getPaginationRowModel=e.options.getPaginationRowModel(e)),e.options.manualPagination||!e._getPaginationRowModel?e.getPrePaginationRowModel():e._getPaginationRowModel()),e.getPageCount=()=>{var s;return(s=e.options.pageCount)!=null?s:Math.ceil(e.getRowCount()/e.getState().pagination.pageSize)},e.getRowCount=()=>{var s;return(s=e.options.rowCount)!=null?s:e.getPrePaginationRowModel().rows.length}}},bs=()=>({top:[],bottom:[]}),Zu={getInitialState:e=>({rowPinning:bs(),...e}),getDefaultOptions:e=>({onRowPinningChange:et("rowPinning",e)}),createRow:(e,t)=>{e.pin=(n,s,r)=>{const a=s?e.getLeafRows().map(c=>{let{id:d}=c;return d}):[],i=r?e.getParentRows().map(c=>{let{id:d}=c;return d}):[],l=new Set([...i,e.id,...a]);t.setRowPinning(c=>{var d,u;if(n==="bottom"){var h,f;return{top:((h=c==null?void 0:c.top)!=null?h:[]).filter(p=>!(l!=null&&l.has(p))),bottom:[...((f=c==null?void 0:c.bottom)!=null?f:[]).filter(p=>!(l!=null&&l.has(p))),...Array.from(l)]}}if(n==="top"){var g,x;return{top:[...((g=c==null?void 0:c.top)!=null?g:[]).filter(p=>!(l!=null&&l.has(p))),...Array.from(l)],bottom:((x=c==null?void 0:c.bottom)!=null?x:[]).filter(p=>!(l!=null&&l.has(p)))}}return{top:((d=c==null?void 0:c.top)!=null?d:[]).filter(p=>!(l!=null&&l.has(p))),bottom:((u=c==null?void 0:c.bottom)!=null?u:[]).filter(p=>!(l!=null&&l.has(p)))}})},e.getCanPin=()=>{var n;const{enableRowPinning:s,enablePinning:r}=t.options;return typeof s=="function"?s(e):(n=s??r)!=null?n:!0},e.getIsPinned=()=>{const n=[e.id],{top:s,bottom:r}=t.getState().rowPinning,a=n.some(l=>s==null?void 0:s.includes(l)),i=n.some(l=>r==null?void 0:r.includes(l));return a?"top":i?"bottom":!1},e.getPinnedIndex=()=>{var n,s;const r=e.getIsPinned();if(!r)return-1;const a=(n=r==="top"?t.getTopRows():t.getBottomRows())==null?void 0:n.map(i=>{let{id:l}=i;return l});return(s=a==null?void 0:a.indexOf(e.id))!=null?s:-1}},createTable:e=>{e.setRowPinning=t=>e.options.onRowPinningChange==null?void 0:e.options.onRowPinningChange(t),e.resetRowPinning=t=>{var n,s;return e.setRowPinning(t?bs():(n=(s=e.initialState)==null?void 0:s.rowPinning)!=null?n:bs())},e.getIsSomeRowsPinned=t=>{var n;const s=e.getState().rowPinning;if(!t){var r,a;return!!((r=s.top)!=null&&r.length||(a=s.bottom)!=null&&a.length)}return!!((n=s[t])!=null&&n.length)},e._getPinnedRows=(t,n,s)=>{var r;return((r=e.options.keepPinnedRows)==null||r?(n??[]).map(i=>{const l=e.getRow(i,!0);return l.getIsAllParentsExpanded()?l:null}):(n??[]).map(i=>t.find(l=>l.id===i))).filter(Boolean).map(i=>({...i,position:s}))},e.getTopRows=re(()=>[e.getRowModel().rows,e.getState().rowPinning.top],(t,n)=>e._getPinnedRows(t,n,"top"),ae(e.options,"debugRows")),e.getBottomRows=re(()=>[e.getRowModel().rows,e.getState().rowPinning.bottom],(t,n)=>e._getPinnedRows(t,n,"bottom"),ae(e.options,"debugRows")),e.getCenterRows=re(()=>[e.getRowModel().rows,e.getState().rowPinning.top,e.getState().rowPinning.bottom],(t,n,s)=>{const r=new Set([...n??[],...s??[]]);return t.filter(a=>!r.has(a.id))},ae(e.options,"debugRows"))}},Ju={getInitialState:e=>({rowSelection:{},...e}),getDefaultOptions:e=>({onRowSelectionChange:et("rowSelection",e),enableRowSelection:!0,enableMultiRowSelection:!0,enableSubRowSelection:!0}),createTable:e=>{e.setRowSelection=t=>e.options.onRowSelectionChange==null?void 0:e.options.onRowSelectionChange(t),e.resetRowSelection=t=>{var n;return e.setRowSelection(t?{}:(n=e.initialState.rowSelection)!=null?n:{})},e.toggleAllRowsSelected=t=>{e.setRowSelection(n=>{t=typeof t<"u"?t:!e.getIsAllRowsSelected();const s={...n},r=e.getPreGroupedRowModel().flatRows;return t?r.forEach(a=>{a.getCanSelect()&&(s[a.id]=!0)}):r.forEach(a=>{delete s[a.id]}),s})},e.toggleAllPageRowsSelected=t=>e.setRowSelection(n=>{const s=typeof t<"u"?t:!e.getIsAllPageRowsSelected(),r={...n};return e.getRowModel().rows.forEach(a=>{Ys(r,a.id,s,!0,e)}),r}),e.getPreSelectedRowModel=()=>e.getCoreRowModel(),e.getSelectedRowModel=re(()=>[e.getState().rowSelection,e.getCoreRowModel()],(t,n)=>Object.keys(t).length?js(e,n):{rows:[],flatRows:[],rowsById:{}},ae(e.options,"debugTable")),e.getFilteredSelectedRowModel=re(()=>[e.getState().rowSelection,e.getFilteredRowModel()],(t,n)=>Object.keys(t).length?js(e,n):{rows:[],flatRows:[],rowsById:{}},ae(e.options,"debugTable")),e.getGroupedSelectedRowModel=re(()=>[e.getState().rowSelection,e.getSortedRowModel()],(t,n)=>Object.keys(t).length?js(e,n):{rows:[],flatRows:[],rowsById:{}},ae(e.options,"debugTable")),e.getIsAllRowsSelected=()=>{const t=e.getFilteredRowModel().flatRows,{rowSelection:n}=e.getState();let s=!!(t.length&&Object.keys(n).length);return s&&t.some(r=>r.getCanSelect()&&!n[r.id])&&(s=!1),s},e.getIsAllPageRowsSelected=()=>{const t=e.getPaginationRowModel().flatRows.filter(r=>r.getCanSelect()),{rowSelection:n}=e.getState();let s=!!t.length;return s&&t.some(r=>!n[r.id])&&(s=!1),s},e.getIsSomeRowsSelected=()=>{var t;const n=Object.keys((t=e.getState().rowSelection)!=null?t:{}).length;return n>0&&n<e.getFilteredRowModel().flatRows.length},e.getIsSomePageRowsSelected=()=>{const t=e.getPaginationRowModel().flatRows;return e.getIsAllPageRowsSelected()?!1:t.filter(n=>n.getCanSelect()).some(n=>n.getIsSelected()||n.getIsSomeSelected())},e.getToggleAllRowsSelectedHandler=()=>t=>{e.toggleAllRowsSelected(t.target.checked)},e.getToggleAllPageRowsSelectedHandler=()=>t=>{e.toggleAllPageRowsSelected(t.target.checked)}},createRow:(e,t)=>{e.toggleSelected=(n,s)=>{const r=e.getIsSelected();t.setRowSelection(a=>{var i;if(n=typeof n<"u"?n:!r,e.getCanSelect()&&r===n)return a;const l={...a};return Ys(l,e.id,n,(i=s==null?void 0:s.selectChildren)!=null?i:!0,t),l})},e.getIsSelected=()=>{const{rowSelection:n}=t.getState();return po(e,n)},e.getIsSomeSelected=()=>{const{rowSelection:n}=t.getState();return Xs(e,n)==="some"},e.getIsAllSubRowsSelected=()=>{const{rowSelection:n}=t.getState();return Xs(e,n)==="all"},e.getCanSelect=()=>{var n;return typeof t.options.enableRowSelection=="function"?t.options.enableRowSelection(e):(n=t.options.enableRowSelection)!=null?n:!0},e.getCanSelectSubRows=()=>{var n;return typeof t.options.enableSubRowSelection=="function"?t.options.enableSubRowSelection(e):(n=t.options.enableSubRowSelection)!=null?n:!0},e.getCanMultiSelect=()=>{var n;return typeof t.options.enableMultiRowSelection=="function"?t.options.enableMultiRowSelection(e):(n=t.options.enableMultiRowSelection)!=null?n:!0},e.getToggleSelectedHandler=()=>{const n=e.getCanSelect();return s=>{var r;n&&e.toggleSelected((r=s.target)==null?void 0:r.checked)}}}},Ys=(e,t,n,s,r)=>{var a;const i=r.getRow(t,!0);n?(i.getCanMultiSelect()||Object.keys(e).forEach(l=>delete e[l]),i.getCanSelect()&&(e[t]=!0)):delete e[t],s&&(a=i.subRows)!=null&&a.length&&i.getCanSelectSubRows()&&i.subRows.forEach(l=>Ys(e,l.id,n,s,r))};function js(e,t){const n=e.getState().rowSelection,s=[],r={},a=function(i,l){return i.map(c=>{var d;const u=po(c,n);if(u&&(s.push(c),r[c.id]=c),(d=c.subRows)!=null&&d.length&&(c={...c,subRows:a(c.subRows)}),u)return c}).filter(Boolean)};return{rows:a(t.rows),flatRows:s,rowsById:r}}function po(e,t){var n;return(n=t[e.id])!=null?n:!1}function Xs(e,t,n){var s;if(!((s=e.subRows)!=null&&s.length))return!1;let r=!0,a=!1;return e.subRows.forEach(i=>{if(!(a&&!r)&&(i.getCanSelect()&&(po(i,t)?a=!0:r=!1),i.subRows&&i.subRows.length)){const l=Xs(i,t);l==="all"?a=!0:(l==="some"&&(a=!0),r=!1)}}),r?"all":a?"some":!1}const Ks=/([0-9]+)/gm,Qu=(e,t,n)=>ia(kt(e.getValue(n)).toLowerCase(),kt(t.getValue(n)).toLowerCase()),eg=(e,t,n)=>ia(kt(e.getValue(n)),kt(t.getValue(n))),tg=(e,t,n)=>mo(kt(e.getValue(n)).toLowerCase(),kt(t.getValue(n)).toLowerCase()),ng=(e,t,n)=>mo(kt(e.getValue(n)),kt(t.getValue(n))),sg=(e,t,n)=>{const s=e.getValue(n),r=t.getValue(n);return s>r?1:s<r?-1:0},og=(e,t,n)=>mo(e.getValue(n),t.getValue(n));function mo(e,t){return e===t?0:e>t?1:-1}function kt(e){return typeof e=="number"?isNaN(e)||e===1/0||e===-1/0?"":String(e):typeof e=="string"?e:""}function ia(e,t){const n=e.split(Ks).filter(Boolean),s=t.split(Ks).filter(Boolean);for(;n.length&&s.length;){const r=n.shift(),a=s.shift(),i=parseInt(r,10),l=parseInt(a,10),c=[i,l].sort();if(isNaN(c[0])){if(r>a)return 1;if(a>r)return-1;continue}if(isNaN(c[1]))return isNaN(i)?-1:1;if(i>l)return 1;if(l>i)return-1}return n.length-s.length}const nn={alphanumeric:Qu,alphanumericCaseSensitive:eg,text:tg,textCaseSensitive:ng,datetime:sg,basic:og},rg={getInitialState:e=>({sorting:[],...e}),getDefaultColumnDef:()=>({sortingFn:"auto",sortUndefined:1}),getDefaultOptions:e=>({onSortingChange:et("sorting",e),isMultiSortEvent:t=>t.shiftKey}),createColumn:(e,t)=>{e.getAutoSortingFn=()=>{const n=t.getFilteredRowModel().flatRows.slice(10);let s=!1;for(const r of n){const a=r==null?void 0:r.getValue(e.id);if(Object.prototype.toString.call(a)==="[object Date]")return nn.datetime;if(typeof a=="string"&&(s=!0,a.split(Ks).length>1))return nn.alphanumeric}return s?nn.text:nn.basic},e.getAutoSortDir=()=>{const n=t.getFilteredRowModel().flatRows[0];return typeof(n==null?void 0:n.getValue(e.id))=="string"?"asc":"desc"},e.getSortingFn=()=>{var n,s;if(!e)throw new Error;return ds(e.columnDef.sortingFn)?e.columnDef.sortingFn:e.columnDef.sortingFn==="auto"?e.getAutoSortingFn():(n=(s=t.options.sortingFns)==null?void 0:s[e.columnDef.sortingFn])!=null?n:nn[e.columnDef.sortingFn]},e.toggleSorting=(n,s)=>{const r=e.getNextSortingOrder(),a=typeof n<"u"&&n!==null;t.setSorting(i=>{const l=i==null?void 0:i.find(g=>g.id===e.id),c=i==null?void 0:i.findIndex(g=>g.id===e.id);let d=[],u,h=a?n:r==="desc";if(i!=null&&i.length&&e.getCanMultiSort()&&s?l?u="toggle":u="add":i!=null&&i.length&&c!==i.length-1?u="replace":l?u="toggle":u="replace",u==="toggle"&&(a||r||(u="remove")),u==="add"){var f;d=[...i,{id:e.id,desc:h}],d.splice(0,d.length-((f=t.options.maxMultiSortColCount)!=null?f:Number.MAX_SAFE_INTEGER))}else u==="toggle"?d=i.map(g=>g.id===e.id?{...g,desc:h}:g):u==="remove"?d=i.filter(g=>g.id!==e.id):d=[{id:e.id,desc:h}];return d})},e.getFirstSortDir=()=>{var n,s;return((n=(s=e.columnDef.sortDescFirst)!=null?s:t.options.sortDescFirst)!=null?n:e.getAutoSortDir()==="desc")?"desc":"asc"},e.getNextSortingOrder=n=>{var s,r;const a=e.getFirstSortDir(),i=e.getIsSorted();return i?i!==a&&((s=t.options.enableSortingRemoval)==null||s)&&(!(n&&(r=t.options.enableMultiRemove)!=null)||r)?!1:i==="desc"?"asc":"desc":a},e.getCanSort=()=>{var n,s;return((n=e.columnDef.enableSorting)!=null?n:!0)&&((s=t.options.enableSorting)!=null?s:!0)&&!!e.accessorFn},e.getCanMultiSort=()=>{var n,s;return(n=(s=e.columnDef.enableMultiSort)!=null?s:t.options.enableMultiSort)!=null?n:!!e.accessorFn},e.getIsSorted=()=>{var n;const s=(n=t.getState().sorting)==null?void 0:n.find(r=>r.id===e.id);return s?s.desc?"desc":"asc":!1},e.getSortIndex=()=>{var n,s;return(n=(s=t.getState().sorting)==null?void 0:s.findIndex(r=>r.id===e.id))!=null?n:-1},e.clearSorting=()=>{t.setSorting(n=>n!=null&&n.length?n.filter(s=>s.id!==e.id):[])},e.getToggleSortingHandler=()=>{const n=e.getCanSort();return s=>{n&&(s.persist==null||s.persist(),e.toggleSorting==null||e.toggleSorting(void 0,e.getCanMultiSort()?t.options.isMultiSortEvent==null?void 0:t.options.isMultiSortEvent(s):!1))}}},createTable:e=>{e.setSorting=t=>e.options.onSortingChange==null?void 0:e.options.onSortingChange(t),e.resetSorting=t=>{var n,s;e.setSorting(t?[]:(n=(s=e.initialState)==null?void 0:s.sorting)!=null?n:[])},e.getPreSortedRowModel=()=>e.getGroupedRowModel(),e.getSortedRowModel=()=>(!e._getSortedRowModel&&e.options.getSortedRowModel&&(e._getSortedRowModel=e.options.getSortedRowModel(e)),e.options.manualSorting||!e._getSortedRowModel?e.getPreSortedRowModel():e._getSortedRowModel())}},ag=[Iu,Gu,zu,Wu,Ru,Au,Yu,Xu,rg,Lu,Ku,qu,Zu,Ju,Vu];function ig(e){var t,n;const s=[...ag,...(t=e._features)!=null?t:[]];let r={_features:s};const a=r._features.reduce((f,g)=>Object.assign(f,g.getDefaultOptions==null?void 0:g.getDefaultOptions(r)),{}),i=f=>r.options.mergeOptions?r.options.mergeOptions(a,f):{...a,...f};let c={...{},...(n=e.initialState)!=null?n:{}};r._features.forEach(f=>{var g;c=(g=f.getInitialState==null?void 0:f.getInitialState(c))!=null?g:c});const d=[];let u=!1;const h={_features:s,options:{...a,...e},initialState:c,_queue:f=>{d.push(f),u||(u=!0,Promise.resolve().then(()=>{for(;d.length;)d.shift()();u=!1}).catch(g=>setTimeout(()=>{throw g})))},reset:()=>{r.setState(r.initialState)},setOptions:f=>{const g=yt(f,r.options);r.options=i(g)},getState:()=>r.options.state,setState:f=>{r.options.onStateChange==null||r.options.onStateChange(f)},_getRowId:(f,g,x)=>{var p;return(p=r.options.getRowId==null?void 0:r.options.getRowId(f,g,x))!=null?p:`${x?[x.id,g].join("."):g}`},getCoreRowModel:()=>(r._getCoreRowModel||(r._getCoreRowModel=r.options.getCoreRowModel(r)),r._getCoreRowModel()),getRowModel:()=>r.getPaginationRowModel(),getRow:(f,g)=>{let x=(g?r.getPrePaginationRowModel():r.getRowModel()).rowsById[f];if(!x&&(x=r.getCoreRowModel().rowsById[f],!x))throw new Error;return x},_getDefaultColumnDef:re(()=>[r.options.defaultColumn],f=>{var g;return f=(g=f)!=null?g:{},{header:x=>{const p=x.header.column.columnDef;return p.accessorKey?p.accessorKey:p.accessorFn?p.id:null},cell:x=>{var p,m;return(p=(m=x.renderValue())==null||m.toString==null?void 0:m.toString())!=null?p:null},...r._features.reduce((x,p)=>Object.assign(x,p.getDefaultColumnDef==null?void 0:p.getDefaultColumnDef()),{}),...f}},ae(e,"debugColumns")),_getColumnDefs:()=>r.options.columns,getAllColumns:re(()=>[r._getColumnDefs()],f=>{const g=function(x,p,m){return m===void 0&&(m=0),x.map(w=>{const S=ku(r,w,m,p),y=w;return S.columns=y.columns?g(y.columns,S,m+1):[],S})};return g(f)},ae(e,"debugColumns")),getAllFlatColumns:re(()=>[r.getAllColumns()],f=>f.flatMap(g=>g.getFlatColumns()),ae(e,"debugColumns")),_getAllFlatColumnsById:re(()=>[r.getAllFlatColumns()],f=>f.reduce((g,x)=>(g[x.id]=x,g),{}),ae(e,"debugColumns")),getAllLeafColumns:re(()=>[r.getAllColumns(),r._getOrderColumnsFn()],(f,g)=>{let x=f.flatMap(p=>p.getLeafColumns());return g(x)},ae(e,"debugColumns")),getColumn:f=>r._getAllFlatColumnsById()[f]};Object.assign(r,h);for(let f=0;f<r._features.length;f++){const g=r._features[f];g==null||g.createTable==null||g.createTable(r)}return r}function lg(){return e=>re(()=>[e.options.data],t=>{const n={rows:[],flatRows:[],rowsById:{}},s=function(r,a,i){a===void 0&&(a=0);const l=[];for(let d=0;d<r.length;d++){const u=fo(e,e._getRowId(r[d],d,i),r[d],d,a,void 0,i==null?void 0:i.id);if(n.flatRows.push(u),n.rowsById[u.id]=u,l.push(u),e.options.getSubRows){var c;u.originalSubRows=e.options.getSubRows(r[d],d),(c=u.originalSubRows)!=null&&c.length&&(u.subRows=s(u.originalSubRows,a+1,u))}}return l};return n.rows=s(t),n},ae(e.options,"debugTable","getRowModel",()=>e._autoResetPageIndex()))}function cg(e){const t=[],n=s=>{var r;t.push(s),(r=s.subRows)!=null&&r.length&&s.getIsExpanded()&&s.subRows.forEach(n)};return e.rows.forEach(n),{rows:t,flatRows:e.flatRows,rowsById:e.rowsById}}function dg(e,t,n){return n.options.filterFromLeafRows?ug(e,t,n):gg(e,t,n)}function ug(e,t,n){var s;const r=[],a={},i=(s=n.options.maxLeafRowFilterDepth)!=null?s:100,l=function(c,d){d===void 0&&(d=0);const u=[];for(let f=0;f<c.length;f++){var h;let g=c[f];const x=fo(n,g.id,g.original,g.index,g.depth,void 0,g.parentId);if(x.columnFilters=g.columnFilters,(h=g.subRows)!=null&&h.length&&d<i){if(x.subRows=l(g.subRows,d+1),g=x,t(g)&&!x.subRows.length){u.push(g),a[g.id]=g,r.push(g);continue}if(t(g)||x.subRows.length){u.push(g),a[g.id]=g,r.push(g);continue}}else g=x,t(g)&&(u.push(g),a[g.id]=g,r.push(g))}return u};return{rows:l(e),flatRows:r,rowsById:a}}function gg(e,t,n){var s;const r=[],a={},i=(s=n.options.maxLeafRowFilterDepth)!=null?s:100,l=function(c,d){d===void 0&&(d=0);const u=[];for(let f=0;f<c.length;f++){let g=c[f];if(t(g)){var h;if((h=g.subRows)!=null&&h.length&&d<i){const p=fo(n,g.id,g.original,g.index,g.depth,void 0,g.parentId);p.subRows=l(g.subRows,d+1),g=p}u.push(g),r.push(g),a[g.id]=g}}return u};return{rows:l(e),flatRows:r,rowsById:a}}function fg(){return e=>re(()=>[e.getPreFilteredRowModel(),e.getState().columnFilters,e.getState().globalFilter],(t,n,s)=>{if(!t.rows.length||!(n!=null&&n.length)&&!s){for(let f=0;f<t.flatRows.length;f++)t.flatRows[f].columnFilters={},t.flatRows[f].columnFiltersMeta={};return t}const r=[],a=[];(n??[]).forEach(f=>{var g;const x=e.getColumn(f.id);if(!x)return;const p=x.getFilterFn();p&&r.push({id:f.id,filterFn:p,resolvedValue:(g=p.resolveFilterValue==null?void 0:p.resolveFilterValue(f.value))!=null?g:f.value})});const i=(n??[]).map(f=>f.id),l=e.getGlobalFilterFn(),c=e.getAllLeafColumns().filter(f=>f.getCanGlobalFilter());s&&l&&c.length&&(i.push("__global__"),c.forEach(f=>{var g;a.push({id:f.id,filterFn:l,resolvedValue:(g=l.resolveFilterValue==null?void 0:l.resolveFilterValue(s))!=null?g:s})}));let d,u;for(let f=0;f<t.flatRows.length;f++){const g=t.flatRows[f];if(g.columnFilters={},r.length)for(let x=0;x<r.length;x++){d=r[x];const p=d.id;g.columnFilters[p]=d.filterFn(g,p,d.resolvedValue,m=>{g.columnFiltersMeta[p]=m})}if(a.length){for(let x=0;x<a.length;x++){u=a[x];const p=u.id;if(u.filterFn(g,p,u.resolvedValue,m=>{g.columnFiltersMeta[p]=m})){g.columnFilters.__global__=!0;break}}g.columnFilters.__global__!==!0&&(g.columnFilters.__global__=!1)}}const h=f=>{for(let g=0;g<i.length;g++)if(f.columnFilters[i[g]]===!1)return!1;return!0};return dg(t.rows,h,e)},ae(e.options,"debugTable","getFilteredRowModel",()=>e._autoResetPageIndex()))}function hg(e){return t=>re(()=>[t.getState().pagination,t.getPrePaginationRowModel(),t.options.paginateExpandedRows?void 0:t.getState().expanded],(n,s)=>{if(!s.rows.length)return s;const{pageSize:r,pageIndex:a}=n;let{rows:i,flatRows:l,rowsById:c}=s;const d=r*a,u=d+r;i=i.slice(d,u);let h;t.options.paginateExpandedRows?h={rows:i,flatRows:l,rowsById:c}:h=cg({rows:i,flatRows:l,rowsById:c}),h.flatRows=[];const f=g=>{h.flatRows.push(g),g.subRows.length&&g.subRows.forEach(f)};return h.rows.forEach(f),h},ae(t.options,"debugTable"))}function pg(){return e=>re(()=>[e.getState().sorting,e.getPreSortedRowModel()],(t,n)=>{if(!n.rows.length||!(t!=null&&t.length))return n;const s=e.getState().sorting,r=[],a=s.filter(c=>{var d;return(d=e.getColumn(c.id))==null?void 0:d.getCanSort()}),i={};a.forEach(c=>{const d=e.getColumn(c.id);d&&(i[c.id]={sortUndefined:d.columnDef.sortUndefined,invertSorting:d.columnDef.invertSorting,sortingFn:d.getSortingFn()})});const l=c=>{const d=c.map(u=>({...u}));return d.sort((u,h)=>{for(let g=0;g<a.length;g+=1){var f;const x=a[g],p=i[x.id],m=p.sortUndefined,w=(f=x==null?void 0:x.desc)!=null?f:!1;let S=0;if(m){const y=u.getValue(x.id),j=h.getValue(x.id),N=y===void 0,C=j===void 0;if(N||C){if(m==="first")return N?-1:1;if(m==="last")return N?1:-1;S=N&&C?0:N?m:-m}}if(S===0&&(S=p.sortingFn(u,h,x.id)),S!==0)return w&&(S*=-1),p.invertSorting&&(S*=-1),S}return u.index-h.index}),d.forEach(u=>{var h;r.push(u),(h=u.subRows)!=null&&h.length&&(u.subRows=l(u.subRows))}),d};return{rows:l(n.rows),flatRows:r,rowsById:n.rowsById}},ae(e.options,"debugTable","getSortedRowModel",()=>e._autoResetPageIndex()))}/**
   * react-table
   *
   * Copyright (c) TanStack
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE.md file in the root directory of this source tree.
   *
   * @license MIT
   */function xo(e,t){return e?mg(e)?v.createElement(e,t):e:null}function mg(e){return xg(e)||typeof e=="function"||wg(e)}function xg(e){return typeof e=="function"&&(()=>{const t=Object.getPrototypeOf(e);return t.prototype&&t.prototype.isReactComponent})()}function wg(e){return typeof e=="object"&&typeof e.$$typeof=="symbol"&&["react.memo","react.forward_ref"].includes(e.$$typeof.description)}function vg(e){const t={state:{},onStateChange:()=>{},renderFallbackValue:null,...e},[n]=v.useState(()=>({current:ig(t)})),[s,r]=v.useState(()=>n.current.initialState);return n.current.setOptions(a=>({...a,...e,state:{...s,...e.state},onStateChange:i=>{r(i),e.onStateChange==null||e.onStateChange(i)}})),n.current}function Sg({table:e}){return o.jsxs("div",{className:"flex items-center justify-between space-x-2 py-4",children:[o.jsxs("div",{className:"flex-1 text-sm text-muted-foreground",children:[e.getFilteredSelectedRowModel().rows.length," of"," ",e.getFilteredRowModel().rows.length," row(s) selected."]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx("span",{className:"text-sm",children:"Rows per page:"}),o.jsxs(es,{value:`${e.getState().pagination.pageSize}`,onValueChange:t=>{e.setPageSize(Number(t))},children:[o.jsx(ts,{className:"h-8 w-[70px]",children:o.jsx(ns,{placeholder:e.getState().pagination.pageSize})}),o.jsx(ss,{side:"top",children:[10,20,30,40,50].map(t=>o.jsx(os,{value:`${t}`,children:t},t))})]})]}),o.jsxs("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium",children:["Page ",e.getState().pagination.pageIndex+1," of"," ",e.getPageCount()]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsxs(Y,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>e.setPageIndex(0),disabled:!e.getCanPreviousPage(),children:[o.jsx("span",{className:"sr-only",children:"Go to first page"}),"<<"]}),o.jsx(Y,{variant:"outline",size:"sm",onClick:()=>e.previousPage(),disabled:!e.getCanPreviousPage(),children:"Previous"}),o.jsx(Y,{variant:"outline",size:"sm",onClick:()=>e.nextPage(),disabled:!e.getCanNextPage(),children:"Next"}),o.jsxs(Y,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>e.setPageIndex(e.getPageCount()-1),disabled:!e.getCanNextPage(),children:[o.jsx("span",{className:"sr-only",children:"Go to last page"}),">>"]})]})]})}function yg({row:e,onRowClick:t}){return o.jsx("tr",{className:`${e.getIsSelected()?"bg-blue-50":""} cursor-pointer`,onClick:()=>t==null?void 0:t(e.original),children:e.getVisibleCells().map(n=>o.jsx("td",{className:"p-3 whitespace-nowrap text-sm border-b",style:{width:`calc(var(--col-${n.column.id}-size) * 1px)`},children:xo(n.column.columnDef.cell,n.getContext())},n.id))},e.id)}function ir({row:e,table:t,onRowClick:n}){const s=e.getIsPinned(),r=s==="top"?e.getPinnedIndex():0,a=s==="bottom"?e.getPinnedIndex():0,i=t.getBottomRows().length,l=33;return o.jsx("tr",{className:`${e.getIsSelected()?"bg-blue-100":"bg-blue-50"} sticky z-10`,style:{top:s==="top"?`${r*l+48}px`:void 0,bottom:s==="bottom"?`${(i-1-a)*l}px`:void 0},onClick:()=>n==null?void 0:n(e.original),children:e.getVisibleCells().map(d=>o.jsx("td",{className:"p-1 whitespace-nowrap text-sm border-b",style:{width:`calc(var(--col-${d.column.id}-size) * 1px)`},children:xo(d.column.columnDef.cell,d.getContext())},d.id))},e.id)}function Ng({table:e,columns:t,keepPinnedRows:n,columnSizeVars:s,onRowClick:r}){const a=n?e.getRowModel().rows:e.getCenterRows();return o.jsxs("tbody",{className:"bg- divide-y divide-gray-200",children:[e.getTopRows().map(i=>o.jsx(ir,{row:i,table:e,onRowClick:r},i.id)),a.length>0?a.map(i=>o.jsx(yg,{row:i,onRowClick:r},i.id)):e.getTopRows().length===0&&e.getBottomRows().length===0&&o.jsx("tr",{children:o.jsx("td",{colSpan:t.length,className:"px-4 py-1 text-center text-sm",children:"No results found"})}),e.getBottomRows().map(i=>o.jsx(ir,{row:i,table:e,onRowClick:r},i.id))]})}function Cg({table:e,columns:t,keepPinnedRows:n,columnSizeVars:s,onRowClick:r}){return o.jsx("div",{id:"UiDataTableTable",className:"rounded-md border overflow-x-auto",children:o.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border-separate border-spacing-0",style:{...s,width:e.getTotalSize(),tableLayout:"fixed"},children:[o.jsx("thead",{className:"background sticky top-0 z-20",children:e.getHeaderGroups().map(a=>o.jsx("tr",{children:a.headers.map(i=>o.jsxs("th",{className:"relative px-2 py-3 text-left text-xs font-medium uppercase tracking-wider bg-primary-foreground select-none border-b",style:{width:`calc(var(--header-${i.id}-size) * 1px)`},colSpan:i.colSpan,children:[o.jsxs("div",{className:"flex items-center space-x-1 cursor-pointer",onClick:i.column.getToggleSortingHandler(),children:[i.isPlaceholder?null:xo(i.column.columnDef.header,i.getContext()),o.jsx("span",{children:{asc:"â–²",desc:"â–¼"}[i.column.getIsSorted()]??null})]}),i.column.getCanResize()&&o.jsx("div",{onDoubleClick:()=>i.column.resetSize(),onMouseDown:i.getResizeHandler(),onTouchStart:i.getResizeHandler(),className:`resizer ${i.column.getIsResizing()?"isResizing":""}`})]},i.id))},a.id))}),o.jsx(Ng,{table:e,columns:t,onRowClick:r,keepPinnedRows:n,columnSizeVars:s})]})})}const bg=({value:e,onChange:t,debounce:n=200,...s})=>{const[r,a]=v.useState(e);return v.useEffect(()=>{a(e)},[e]),v.useEffect(()=>{const i=setTimeout(()=>{t(r)},n);return()=>clearTimeout(i)},[r,t,n]),o.jsx(dt,{...s,value:r,onChange:i=>a(i.target.value)})};function ks(e,t,n={}){const{renderDisplay:s=c=>c,width:r,inputType:a="text"}=n,i=r?parseInt(r.replace("px",""),10):void 0;return{accessorKey:e,header:()=>o.jsx("div",{children:t}),size:i,cell:({row:c,column:d,table:u,getValue:h})=>{const f=h(),{isEditing:g,updateData:x}=u.options.meta||{},[p,m]=v.useState(f);v.useEffect(()=>{m(f)},[f]);const w=()=>{x&&x(c.index,d.id,p)};if(g)return o.jsx("input",{type:a,value:p??"",onChange:y=>m(y.target.value),onBlur:w,className:"w-full p-1 border rounded bg-transparent"});const S=c.original;return o.jsx(o.Fragment,{children:s(f,S)})}}}function jg({data:e,columns:t,keepPinnedRows:n,filterField:s,filterPlaceholder:r,onRowClick:a,onAddNewRow:i,topRight:l,isEditing:c,onDataUpdate:d}){const[u,h]=v.useState(""),[f,g]=v.useState({}),[{pageIndex:x,pageSize:p},m]=v.useState({pageIndex:0,pageSize:10}),[w,S]=v.useState([]),[y,j]=v.useState({top:[],bottom:[]}),[N,C]=v.useState({}),I=vg({data:e,columns:t,keepPinnedRows:n,columnResizeMode:"onChange",state:{globalFilter:u,rowSelection:f,pagination:{pageIndex:x,pageSize:p},sorting:w,rowPinning:y,columnSizing:N},meta:{isEditing:c,updateData:d},initialState:{pagination:{pageIndex:0,pageSize:10}},onPaginationChange:m,onSortingChange:S,onRowPinningChange:j,onColumnSizingChange:C,onGlobalFilterChange:h,enableRowSelection:!0,onRowSelectionChange:g,getCoreRowModel:lg(),getFilteredRowModel:fg(),getPaginationRowModel:hg(),getSortedRowModel:pg(),globalFilterFn:(A,k,b)=>{const T=b.toLowerCase();if(s){const E=A.getValue(s);return String(E).toLowerCase().includes(T)}for(const E in A.original){const D=A.original[E];if(typeof D=="string"&&D.toLowerCase().includes(T))return!0}return!1}}),R=v.useMemo(()=>{const A=I.getFlatHeaders(),k={};for(let b=0;b<A.length;b++){const T=A[b];k[`--header-${T.id}-size`]=T.getSize(),k[`--col-${T.column.id}-size`]=T.column.getSize()}return k},[I.getState().columnSizing,I.getState().columnSizingInfo]);return o.jsxs("div",{className:"",children:[o.jsxs("div",{className:"flex items-center justify-between py-4 space-x-4",children:[o.jsx(bg,{placeholder:r||"Filter all columns...",value:u??"",onChange:A=>h(String(A)),className:"max-w-sm"}),o.jsxs("div",{className:"flex items-center space-x-2",children:[l," ",i&&o.jsx(Y,{onClick:i,size:"sm",children:"Add New Row"})]})]}),o.jsx(Cg,{table:I,columns:t,onRowClick:a,keepPinnedRows:n,columnSizeVars:R}),o.jsx(Sg,{table:I})]})}const kg=[ks("id","ID",{width:"50px"}),ks("name","Name",{width:"150px"}),ks("value","Value",{width:"100px"})],Ig=[{id:"1",name:"Item A",value:100},{id:"2",name:"Item B",value:200},{id:"3",name:"Item C",value:150}],Rg=({node:e})=>{const t=Ig,n=kg;return o.jsx("div",{style:{width:"100%",height:"100%",overflow:"auto"},children:o.jsx(jg,{data:t,columns:n})})},Ag=({node:e,preventEdit:t})=>{var I;const n=v.useRef(null),s=v.useRef(null),[r,a]=v.useState(!1),[i,l]=v.useState(e.title||""),[c,d]=v.useState(e.content||""),u=_.getState(),h=u.updateNode,f=u.setMode,g=u.uiState.nodeToFocusId,x=(I=u.projectCanvas.getActive())==null?void 0:I.coreState,p=(x==null?void 0:x.selectedNodes)??[],m=p.some(R=>R.id===e.id),w=m&&g===e.id,S=R=>{l(R.target.value)},y=R=>{d(R.target.value)},j=v.useCallback(()=>{var R;h(e.id,{title:i,content:c,isEditing:!1}),a(!1),(R=window.getSelection())==null||R.removeAllRanges()},[e.id,h,i,c]),N=v.useCallback(()=>{m&&p.length<=1&&!t&&(a(!0),h(e.id,{isEditing:!0}))},[m,p.length,t,h,e.id]),C=v.useCallback(R=>{var A,k;if(R.key==="Escape"){j(),_.getState().uiState.mode!==W.VIM&&f(W.SELECT),(A=n.current)==null||A.blur(),(k=s.current)==null||k.blur();return}},[j,f]);return v.useEffect(()=>{w&&r&&n.current&&n.current.focus()},[w,r]),v.useEffect(()=>{l(e.title||""),d(e.content||"")},[e.title,e.content]),o.jsxs("div",{className:"w-full h-full flex flex-col",children:[o.jsx("div",{className:"title-section border-b",children:o.jsx("input",{ref:n,type:"text",value:i,onChange:S,onBlur:j,onMouseDown:N,onKeyDown:C,placeholder:"Title...",className:ve("w-full px-2 py-1","text-sm font-semibold","border-none focus:outline-none","bg-transparent",{"pointer-events-none":t,"cursor-text":r,"cursor-default":!r}),readOnly:!r})}),o.jsx("div",{className:"content-section flex-1",children:o.jsx("textarea",{ref:s,value:c,onChange:y,onBlur:j,onMouseDown:N,onKeyDown:C,placeholder:"Content...",className:ve("w-full h-full","px-2 py-1","text-sm","border-none focus:outline-none","bg-transparent","resize-none","overflow-hidden",{"pointer-events-none":t,"cursor-text":r,"cursor-default":!r}),readOnly:!r})})]})};function la({tags:e,onAddTag:t,onRemoveTag:n,quickTags:s=["left","right","todo","important"],canvasTags:r=[],className:a}){const[i,l]=v.useState(""),c=r.filter(u=>{const h=!i.trim()||u.toLowerCase().includes(i.toLowerCase()),f=!e.includes(u);return h&&f}),d=()=>{const u=i.trim();u&&(t(u),l(""))};return o.jsxs("div",{className:je("tag-management-ui space-y-3",a),"data-test":"tag-management-ui-container",children:[e.length>0&&o.jsxs("div",{className:"current-tags space-y-2","data-test":"tag-management-current-tags-section",children:[o.jsx("div",{className:"tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-current-tags-label",children:"Current Tags"}),o.jsx("div",{className:"tags-list flex flex-wrap gap-1","data-test":"tag-management-current-tags-list",children:e.map(u=>o.jsxs(ct,{variant:"secondary",className:"tag-badge text-xs flex items-center gap-1","data-test":`tag-management-tag-${u}`,children:[u,o.jsx("button",{onClick:()=>n(u),className:"tag-remove-button ml-1 hover:text-destructive",title:"Remove tag","data-test":`tag-management-remove-tag-${u}-button`,children:o.jsx(qe,{className:"h-3 w-3"})})]},u))})]}),o.jsxs("div",{className:"add-tag-section space-y-2","data-test":"tag-management-add-tag-section",children:[o.jsx("div",{className:"add-tag-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-add-tag-label",children:"Add Tag"}),o.jsxs("div",{className:"add-tag-input-group flex gap-2","data-test":"tag-management-add-tag-input-group",children:[o.jsx(dt,{placeholder:"Enter tag name...",value:i,onChange:u=>l(u.target.value),onKeyDown:u=>{u.key==="Enter"&&i.trim()&&(u.preventDefault(),d())},className:"tag-input h-8 text-sm",autoFocus:!0,"data-test":"tag-management-tag-input"}),o.jsx(Y,{variant:"default",size:"sm",className:"add-tag-button h-8",onClick:d,disabled:!i.trim(),"data-test":"tag-management-add-tag-button",children:o.jsx(Tt,{className:"h-4 w-4"})})]})]}),c.length>0&&o.jsxs("div",{className:"canvas-tags-section space-y-2","data-test":"tag-management-canvas-tags-section",children:[o.jsx("div",{className:"canvas-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-canvas-tags-label",children:"Tags in Canvas"}),o.jsx("div",{className:"canvas-tags-list flex flex-wrap gap-1 max-h-14 overflow-y-auto","data-test":"tag-management-canvas-tags-list",children:c.map(u=>o.jsx(ct,{variant:"outline",className:"canvas-tag cursor-pointer hover:opacity-80 hover:bg-accent",onClick:()=>t(u),"data-test":`tag-management-canvas-tag-${u}`,children:u},u))})]}),s.length>0&&o.jsxs("div",{className:"quick-tags-section space-y-2","data-test":"tag-management-quick-tags-section",children:[o.jsx("div",{className:"quick-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-quick-tags-label",children:"Quick Add"}),o.jsx("div",{className:"quick-tags-list flex flex-wrap gap-1","data-test":"tag-management-quick-tags-list",children:s.map(u=>{const h=e.includes(u);return o.jsx(ct,{variant:h?"default":"outline",className:je("quick-tag cursor-pointer hover:opacity-80",h&&"opacity-50 cursor-not-allowed"),onClick:()=>{h||t(u)},"data-test":`tag-management-quick-tag-${u}`,children:u},u)})})]})]})}const Eg=[];function Tg({nodeId:e,tags:t,className:n}){const[s,r]=v.useState(!1),a=B(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??Eg}),i=Array.isArray(t)?t:[],l=v.useMemo(()=>i.map(h=>h.title),[i]),c=v.useMemo(()=>{const h=new Set;for(const f of a)if(Array.isArray(f.tags))for(const g of f.tags)h.add(g.title);return Array.from(h).sort()},[a]),d=v.useCallback(h=>{const f=_.getState(),g={id:Math.random().toString(36).slice(2,10),title:h};f.addTagToNode(e,g)},[e]),u=v.useCallback(h=>{const f=_.getState(),g=i.find(x=>x.title===h);g&&f.removeTagFromNode(e,g.id)},[e,i]);return o.jsxs(_t,{open:s,onOpenChange:r,"data-test":"tag-selector-popover",children:[o.jsx(Ot,{asChild:!0,children:o.jsx(Sn,{className:n,onClick:h=>{h.stopPropagation()},title:"Manage tags",variant:"ghost","data-test":"tag-selector-trigger-button",children:o.jsx(xn,{})})}),o.jsx($t,{className:"tag-selector-popover w-64 p-3",align:"start","data-test":"tag-selector-popover-content",children:o.jsx(la,{tags:l,onAddTag:d,onRemoveTag:u,canvasTags:c})})]})}function Mg({node:e,className:t}){const n=s=>{var d;s.stopPropagation();const r=_.getState(),a=(d=r.projectCanvas.getActive())==null?void 0:d.viewState,i=r.updateNode;if(!a)return;const{scale:l,offset:c}=a;if(e.isPinned){const u=(e.x-c.x)/l,h=(e.y-c.y)/l;i(e.id,{isPinned:!1,x:u,y:h})}else{const u=e.x*l+c.x,h=e.y*l+c.y;i(e.id,{isPinned:!0,x:u,y:h})}};return o.jsx(Sn,{className:t,onClick:n,title:e.isPinned?"Unpin from viewport":"Pin to viewport",variant:"ghost",children:e.isPinned?o.jsx($i,{className:"h-4 w-4 text-blue-500"}):o.jsx(Fi,{className:"h-4 w-4"})})}const Dg=({node:e,isSingleNodeSelected:t,isCollapsed:n=!1})=>{const[s,r]=v.useState(!1),[a,i]=v.useState(e.title||""),l=v.useRef(null);v.useEffect(()=>{i(e.title||"")},[e.title]),v.useEffect(()=>()=>{const m=a.trim();m&&m!==e.title&&_.getState().updateNodeTitle(e.id,m)},[e.id,a]),v.useEffect(()=>{s&&l.current&&(l.current.focus(),l.current.select())},[s]);const c=v.useCallback(()=>{const m=a.trim();m&&m!==e.title&&_.getState().updateNodeTitle(e.id,m),r(!1)},[e.id,a,e.title]),d=v.useCallback(m=>{m.key==="Enter"?(m.preventDefault(),c()):m.key==="Escape"&&(m.preventDefault(),i(e.title||""),r(!1))},[c,e.title]),u=()=>{if(e.title)return e.title;if(typeof e.content=="string"){const m=e.content.split(`
`)[0];return m.length>50?m.substring(0,50)+"...":m}return"(empty)"},h=v.useMemo(()=>e.title?Do(e.title):"",[e.title]),f=v.useMemo(()=>{const m=u();return Do(m)},[e.title,e.content]),g=B(m=>{var y;const S=(((y=m.projectCanvas.getActive())==null?void 0:y.coreState.nodes)??[]).find(j=>j.id===e.id);return(S==null?void 0:S.isCollapsed)??!1}),x=v.useCallback(m=>{m.stopPropagation(),m.preventDefault(),_.getState().updateNode(e.id,{isCollapsed:!g})},[e.id,g]),p=o.jsx(Y,{title:g?"Expand node":"Collapse node",variant:"ghost",size:"icon",onClick:x,className:"absolute h-6 w-6 flex-shrink-0",style:{left:-43},"data-test":"node-title-collapse-button",children:g?o.jsx(so,{className:"h-3.5 w-3.5 text-muted-foreground"}):o.jsx(Dt,{className:"h-3.5 w-3.5"})});return n?o.jsxs("div",{className:"markdown-textarea absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-collapsed",children:[p,o.jsx("div",{className:"px-2 py-0.5 bg-background/90 truncate border border-dashed border-muted-foreground rounded [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:f}})]}):!e.title&&!t?null:o.jsxs("div",{className:"absolute flex gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-container",children:[t&&p,t?o.jsx("input",{ref:l,type:"text",value:a,onChange:m=>i(m.target.value),onBlur:c,onKeyDown:d,placeholder:"Add title...",className:"relative left-0 text-xs px-2 py-0.5 bg-background/90 w-full",onClick:m=>{m.stopPropagation(),r(!0)}}):e.title?o.jsx("div",{className:"text-xs px-2 py-0.5 bg-background/90 truncate [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:h}}):null]})};function Pg(e,t){return e.node.title===t.node.title&&e.node.width===t.node.width&&e.node.content===t.node.content&&e.isSingleNodeSelected===t.isSingleNodeSelected&&e.isCollapsed===t.isCollapsed}const _g=Be.memo(Dg,Pg),wo=e=>{const{header:t,itemList:n,maxHeight:s,selectedIndices:r,selectedValues:a,getItemValue:i=(P,F)=>F,onSelectionChange:l,searchable:c=!1,searchPlaceholder:d="Search...",filterItem:u=(P,F)=>String(P).toLowerCase().includes(F.toLowerCase()),showAllOption:h=c,allOptionLabel:f="All",enableDelete:g=!1,onItemDelete:x,itemStyles:p="",moreOptions:m,initiallyCollapsed:w=!1,...S}=e,y=v.useRef({}),j=v.useRef(!1),[N,C]=v.useState(new Set(r)),[I,R]=v.useState(r==null?void 0:r[r.length-1]),[A,k]=v.useState(""),[b,T]=v.useState(w);v.useEffect(()=>{const P=Array.from(N),F=r||[];if(P.length!==F.length||!P.every((U,L)=>U===F[L])){j.current=!0,C(new Set(r));const U=r==null?void 0:r[r.length-1];R(U)}},[r]),v.useEffect(()=>{if(a===void 0)return;const P=new Set,F=new Set(a);if(n.forEach((U,L)=>{F.has(i(U,L))&&P.add(L)}),P.size!==N.size||!Array.from(P).every(U=>N.has(U))){j.current=!0,C(P);const U=a[a.length-1],L=n.findIndex((G,q)=>i(G,q)===U);R(L!==-1?L:void 0)}},[a,n,i]),v.useEffect(()=>{if(j.current){const P=I;if(P!==void 0&&N.has(P)){const F=y.current[P];F&&F.scrollIntoView({behavior:"smooth",block:"nearest"})}j.current=!1}},[N,I]);const E=(P,F)=>{const U=$[P],L=n.findIndex(q=>q===U);if(L===-1)return;let G=new Set(N);if(F.shiftKey&&I!==void 0){const q=Math.min(I,L),ee=Math.max(I,L);for(let oe=q;oe<=ee;oe++)$.some(me=>n[oe]===me)&&G.add(oe)}else F.ctrlKey||F.metaKey?(G.has(L)?G.delete(L):G.add(L),R(L)):(G=new Set([L]),R(L));if(C(G),l){const q=Array.from(G),ee=q.map(oe=>i(n[oe],oe));l(q,ee)}},D=(P,F)=>{if(F.stopPropagation(),x){const U=i(n[P],P);x(P,U)}},O=()=>{k(""),C(new Set),R(void 0),l&&l([],[])},M=()=>{T(!b)},$=A&&c?n.filter((P,F)=>u(P,A,F)):n;return o.jsxs("div",{id:"UiList","data-test":"ui-list-container",className:"bg-background text-foreground select-none",...S,children:[t?o.jsxs("div",{id:"header-container","data-test":"ui-list-header-container",className:"flex justify-between items-center sticky top-0 bg-background z-10 py-2 px-2 border-b border-border",children:[o.jsx("div",{"data-test":"ui-list-header-content",className:`flex-grow ${typeof t=="string"?"font-bold":""}`,children:t}),m&&o.jsx("div",{className:"flex items-center ml-2 flex-shrink-0","data-test":"ui-list-more-options",children:m}),o.jsx(Y,{variant:"ghost",size:"sm",onClick:M,className:"p-1 h-auto flex-shrink-0","aria-label":b?"Expand list":"Collapse list","data-test":"ui-list-collapse-toggle",children:b?o.jsx(Dt,{size:16}):o.jsx(Li,{size:16})})]}):null,!b&&o.jsxs(o.Fragment,{children:[c&&o.jsx("div",{className:"sticky top-0 bg-background z-10 py-2 px-2 border-b border-border","data-test":"ui-list-search-container",children:o.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:d,value:A,onChange:P=>k(P.target.value),"data-test":"ui-list-search-input"})}),o.jsxs("div",{id:"itemList","data-test":"ui-list-items-container",className:ve("space-y-1 py-1 p-2 overflow-auto"),style:{maxHeight:s},children:[c&&h&&o.jsx("div",{className:`p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${!A&&N.size===0?"bg-accent text-accent-foreground font-semibold":""} select-none ${p}`,onClick:O,"data-test":"ui-list-all-option",children:f}),$.map((P,F)=>{const U=P,L=n.findIndex(q=>q===U),G=N.has(L);return o.jsxs("div",{ref:q=>y.current[L]=q,className:`flex justify-between items-center p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${G?"bg-accent text-accent-foreground font-semibold":""} select-none ${p}`,onClick:q=>E(F,q),"data-test":`ui-list-item-${L}`,children:[o.jsx("span",{className:"flex-grow","data-test":`ui-list-item-content-${L}`,children:P}),g&&o.jsx(Hi,{onClick:q=>D(L,q),className:"ml-2 px-1 py-0 text-xs text-destructive-foreground rounded hover:bg-destructive/80 focus:outline-none focus:ring-1 focus:ring-destructive","aria-label":`Delete item ${L+1}`,"data-test":`ui-list-item-delete-${L}`})]},L)})]})]})]})},Og=(e,t)=>v.useMemo(()=>{if(t.length!==1)return-1;const n=t[0].id;return e.findIndex(s=>s.id===n)},[e,t]),$g={[ie.RECT]:o.jsx($n,{className:"w-4 h-4"}),[ie.TEXT]:o.jsx(zi,{className:"w-4 h-4"})},vo=e=>$g[e]??null,Jt=v.forwardRef(({tooltip:e,children:t,...n},s)=>o.jsx(Nt,{children:o.jsxs(Ct,{children:[o.jsx(bt,{asChild:!0,children:o.jsx(Y,{ref:s,...n,children:t})}),o.jsx(jt,{children:typeof e=="string"?o.jsx("p",{children:e}):e})]})}));Jt.displayName="ButtonWithTooltip";const Fg=({nodes:e,selectedNodes:t,updateNodes:n,saveStateToLocalStorage:s})=>{const[r,a]=v.useState(!1),[i,l]=v.useState(null),[c,d]=v.useState(!1),u=v.useRef(null),h=v.useCallback(p=>{const w=(c?e:t).map(S=>{const y=Array.isArray(S.tags)?S.tags:[];if(y.some(C=>C.title===p))return S;const N={id:Math.random().toString(36).slice(2,10),title:p};return{...S,tags:[...y,N]}});n(w),s()},[c,e,t,n,s]),f=v.useCallback(p=>{const w=(c?e:t).map(S=>{const y=Array.isArray(S.tags)?S.tags:[];return y.some(N=>N.title===p)?{...S,tags:y.filter(N=>N.title!==p)}:S});n(w),s()},[c,e,t,n,s]),g=Be.useMemo(()=>{const p=c?e:t,m=new Set;return p.forEach(w=>{(Array.isArray(w.tags)?w.tags:[]).forEach(y=>m.add(y.title))}),Array.from(m).sort()},[c,e,t]),x=Be.useMemo(()=>{const p=new Set;return e.forEach(m=>{(Array.isArray(m.tags)?m.tags:[]).forEach(S=>p.add(S.title))}),Array.from(p).sort()},[e]);return o.jsxs(o.Fragment,{children:[o.jsx(Jt,{ref:u,onMouseDown:p=>p.stopPropagation(),onClick:p=>{if(p.stopPropagation(),u.current){const m=u.current.getBoundingClientRect();l({x:m.left,y:m.bottom+4})}a(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Tag nodes","data-test":"nodes-info-tag-button",children:o.jsx(xn,{})}),o.jsx(ut,{isVisible:r,onClose:()=>a(!1),title:"Tag Nodes",triggerPosition:i??void 0,children:o.jsxs("div",{className:"p-3 space-y-3",children:[o.jsxs("div",{className:"apply-to-section space-y-2 pb-2 border-b",children:[o.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[o.jsx("input",{type:"checkbox",checked:c,onChange:p=>d(p.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"tag-apply-to-all-checkbox"}),o.jsx("span",{children:"Apply to all nodes"})]}),o.jsx("div",{className:"text-xs text-muted-foreground ml-6",children:c?`Will apply to all ${e.length} nodes`:`Will apply to ${t.length} selected node${t.length!==1?"s":""}`})]}),o.jsx(la,{tags:g,onAddTag:h,onRemoveTag:f,canvasTags:x})]})})]})},Lg={content:!0,title:!1,id:!1,type:!1,tags:!1},sn=(e,t,n,s,r=!1)=>{const a=n?t:t.toLowerCase(),i=[];if(r){const l=e.split(`
`);l.forEach((c,d)=>{const u=n?c:c.toLowerCase();let h=0,f=u.indexOf(a,h);for(;f!==-1;){const g=Math.max(0,f-40),x=Math.min(c.length,f+a.length+40);let p=c.substring(g,x);g>0&&(p="..."+p),x<c.length&&(p=p+"..."),i.push({lineNumber:l.length>1?d+1:void 0,context:p,startIndex:f,field:s}),h=f+1,f=u.indexOf(a,h)}})}else{const l=n?e:e.toLowerCase();let c=0,d=l.indexOf(a,c);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let f=e.substring(u,h);u>0&&(f="..."+f),h<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:s}),c=d+1,d=l.indexOf(a,c)}}return i},Hg=(e,t,n,s)=>{const r=[];if(s.content&&typeof e.content=="string"&&r.push(...sn(e.content,t,n,"content",!0)),s.title&&e.title&&r.push(...sn(e.title,t,n,"title")),s.id&&e.id&&r.push(...sn(e.id,t,n,"id")),s.type&&e.type&&r.push(...sn(e.type,t,n,"type")),s.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...sn(a,t,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},zg=e=>{const{node:t,matches:n}=e,s=vo(t.type),r=t.id.substring(0,6),a=typeof t.content=="string"?t.content:"",i=t.title?`${t.title.substring(0,30)}${t.title.length>30?"...":""}`:a?`${a.substring(0,30)}${a.length>30?"...":""}`:"(No Content)",l=t.title&&a?`${a.substring(0,50)}${a.length>50?"...":""}`:null;return o.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[o.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[s&&o.jsx("span",{className:"flex-shrink-0",children:s}),o.jsx("span",{className:"truncate",children:i}),t.isEditing&&o.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),o.jsxs(ct,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[n.length," ",n.length===1?"match":"matches"]})]}),o.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:r})]}),l&&o.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:l})]})},Wg=(e,t,n,s)=>{const r=n?t:t.toLowerCase(),i=(n?e.context:e.context.toLowerCase()).indexOf(r);if(i===-1)return o.jsxs("div",{className:"text-xs font-mono flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&o.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),o.jsx("span",{className:"flex-1",children:e.context})]});const l=e.context.substring(0,i),c=e.context.substring(i,i+t.length),d=e.context.substring(i+t.length);return o.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&o.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),o.jsxs("span",{className:"flex-1",children:[l,o.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:c}),d]})]})},Bg=({nodes:e,setSelectedNodes:t})=>{const[n,s]=v.useState(!1),[r,a]=v.useState(null),[i,l]=v.useState(""),[c,d]=v.useState(!1),[u,h]=v.useState(Lg),f=v.useRef(null),[g,x]=v.useState(new Set),[p,m]=v.useState(!1),w=c||u.title||u.id||u.type||u.tags||!u.content,S=v.useMemo(()=>{if(!i.trim())return[];if(!Object.values(u).some(k=>k))return[];const A=[];return e.forEach(k=>{if(g.has(k.id))return;const b=Hg(k,i,c,u);b&&A.push(b)}),A},[e,i,c,u,g]),y=v.useMemo(()=>S.reduce((R,A)=>R+A.matches.length,0),[S]),j=v.useCallback(()=>{if(S.length>0){const R=S.map(A=>A.node);t(R)}},[S,t]),N=v.useCallback(R=>{x(A=>new Set(A).add(R))},[]),C=v.useCallback(R=>{const A=R.node;t([A]),_.getState().scrollToNode(A.id)},[t]),I=v.useCallback((R,A)=>{const k=R.node;t([k]);const b=Q.LINE_HEIGHT_FIND,T=A?(A-1)*b:0;ls(k,{highlightYOffset:T})},[t]);return o.jsxs(o.Fragment,{children:[o.jsx(Jt,{ref:f,onMouseDown:R=>R.stopPropagation(),onClick:R=>{if(R.stopPropagation(),f.current){const A=f.current.getBoundingClientRect();a({x:A.left,y:A.bottom+4})}s(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Find nodes","data-test":"nodes-info-find-button",children:o.jsx(wn,{})}),o.jsx(ut,{isVisible:n,onClose:()=>{s(!1)},title:"Find Nodes",triggerPosition:r??void 0,shouldCloseManually:!0,children:o.jsxs("div",{className:"p-3 space-y-3","data-test":"find-nodes-popover-content",children:[o.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"find-nodes-search-section",children:[o.jsx(wn,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"find-nodes-search-icon"}),o.jsx(dt,{type:"text",placeholder:"Search nodes...",value:i,onChange:R=>l(R.target.value),onKeyDown:R=>{R.key==="Enter"&&i.trim()&&(R.preventDefault(),j())},className:je("h-8 text-sm pl-8",i?"pr-16":"pr-10"),autoFocus:!0,"data-test":"find-nodes-search-input"}),i&&o.jsx(Y,{variant:"ghost",size:"icon",onClick:()=>l(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"find-nodes-clear-button",children:o.jsx(qe,{className:"h-3 w-3"})}),w&&o.jsx("div",{className:je("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",i?"right-16":"right-11"),"data-test":"find-nodes-filter-indicator"}),o.jsxs(_t,{open:p,onOpenChange:m,children:[o.jsx(Ot,{asChild:!0,children:o.jsx(Y,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"find-nodes-settings-button",children:o.jsx(oo,{className:"h-3.5 w-3.5"})})}),o.jsx($t,{align:"end",side:"bottom",className:"w-52",style:{zIndex:He.draggablePopoverDropdown},"data-test":"find-nodes-settings-panel",children:o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"find-case-sensitive",checked:c,onCheckedChange:R=>d(!!R),"data-test":"find-nodes-case-sensitive-checkbox"}),o.jsx("label",{htmlFor:"find-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),o.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[o.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),o.jsxs("div",{className:"space-y-1.5",children:[o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"find-node-content",checked:u.content,onCheckedChange:R=>h(A=>({...A,content:!!R})),"data-test":"find-nodes-content-checkbox"}),o.jsx("label",{htmlFor:"find-node-content",className:"text-sm cursor-pointer",children:"Content"})]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"find-node-title",checked:u.title,onCheckedChange:R=>h(A=>({...A,title:!!R})),"data-test":"find-nodes-title-checkbox"}),o.jsx("label",{htmlFor:"find-node-title",className:"text-sm cursor-pointer",children:"Title"})]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"find-node-id",checked:u.id,onCheckedChange:R=>h(A=>({...A,id:!!R})),"data-test":"find-nodes-id-checkbox"}),o.jsx("label",{htmlFor:"find-node-id",className:"text-sm cursor-pointer",children:"ID"})]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"find-node-type",checked:u.type,onCheckedChange:R=>h(A=>({...A,type:!!R})),"data-test":"find-nodes-type-checkbox"}),o.jsx("label",{htmlFor:"find-node-type",className:"text-sm cursor-pointer",children:"Type"})]}),o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"find-node-tags",checked:u.tags,onCheckedChange:R=>h(A=>({...A,tags:!!R})),"data-test":"find-nodes-tags-checkbox"}),o.jsx("label",{htmlFor:"find-node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]})]})})]})]}),i.trim()&&o.jsx("div",{className:"results-section space-y-2","data-test":"find-nodes-results-section",children:o.jsx("div",{className:"results-info flex items-center justify-between","data-test":"find-nodes-results-info",children:o.jsx("span",{className:"text-xs text-muted-foreground","data-test":S.length===0?"find-nodes-no-matches":"find-nodes-match-count",children:S.length===0?"No matches found":o.jsxs(o.Fragment,{children:["Found ",o.jsx(ct,{variant:"secondary",className:"mx-1","data-test":"find-nodes-total-matches-badge",children:y}),y===1?"match":"matches"," in"," ",o.jsx(ct,{variant:"secondary",className:"mx-1","data-test":"find-nodes-nodes-count-badge",children:S.length}),S.length===1?"node":"nodes"]})})})}),S.length>0&&o.jsx("div",{className:"nodes-list-section space-y-2 max-h-[400px] overflow-y-auto","data-test":"find-nodes-list-section",children:S.map(R=>o.jsx("div",{className:"node-matches-container border border-border rounded-md overflow-hidden","data-test":`find-nodes-result-${R.nodeId}`,children:o.jsxs("div",{className:"relative",children:[o.jsx("button",{onClick:()=>N(R.nodeId),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":`find-nodes-remove-result-button-${R.nodeId}`,children:o.jsx(qe,{className:"w-4 h-4 text-destructive"})}),o.jsxs("div",{className:"bg-background text-foreground select-none","data-test":`find-nodes-result-content-${R.nodeId}`,children:[o.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:()=>C(R),"data-test":`find-nodes-result-header-${R.nodeId}`,children:zg(R)}),o.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":`find-nodes-result-matches-${R.nodeId}`,children:R.matches.map((A,k)=>o.jsx("div",{onClick:b=>{b.stopPropagation(),I(R,A.lineNumber)},"data-test":`find-nodes-match-${R.nodeId}-${k}`,children:Wg(A,i,c)},k))})]})]})},R.nodeId))})]})})]})},Vg=({nodes:e,selectedNodes:t,updateNodes:n,saveStateToLocalStorage:s})=>{var y;const r=_.getState(),a=r.setNodeUpdateSettings,i=((y=r.uiState)==null?void 0:y.nodeUpdateSettings)??{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},[l,c]=v.useState(!1),[d,u]=v.useState(i.searchHistory[0]??""),[h,f]=v.useState(null),g=Be.useRef(null),[x,p]=v.useState(i.deleteInAllNodes),[m,w]=v.useState(i.deleteWholeLine),S=v.useCallback(()=>{if(!d)return;const N=(x?e:t).map(I=>{if(typeof I.content!="string")return I;let R=I.content;m?R=R.split(`
`).filter(E=>!E.includes(d)).join(`
`):R=R.split(d).join("");const A=I.width??Q.DEFAULT_NODE_WIDTH,k=Mt(R,A)+Q.NODE_Y_PADDING*2;return{...I,content:R,height:k}});n(N);const C=[d,...i.searchHistory.filter(I=>I!==d)].slice(0,10);a({deleteInAllNodes:x,deleteWholeLine:m,searchHistory:C}),s(),console.log(`Deleted "${d}" from ${N.length} nodes (wholeLine: ${m})`)},[d,x,m,e,t,n,i.searchHistory,a,s]);return o.jsxs(o.Fragment,{children:[o.jsx(Jt,{ref:g,onMouseDown:j=>j.stopPropagation(),onClick:j=>{if(j.stopPropagation(),g.current){const N=g.current.getBoundingClientRect();f({x:N.left,y:N.bottom+4})}c(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Update nodes","data-test":"nodes-info-update-button",children:o.jsx(Wi,{})}),o.jsx(ut,{isVisible:l,onClose:()=>c(!1),title:"Update Nodes",triggerPosition:h??void 0,children:o.jsxs("div",{className:"p-3 space-y-3",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("input",{type:"text",value:d,onChange:j=>u(j.target.value),placeholder:"Text to delete...",className:"flex-1 px-2 py-1 text-sm border rounded bg-background","data-test":"update-nodes-search-input"}),o.jsxs("button",{onClick:S,disabled:!d,className:"flex items-center gap-1 px-2 py-1 text-sm rounded bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors","data-test":"update-nodes-delete-button",children:[o.jsx(Yt,{className:"w-3 h-3"}),"Delete"]})]}),o.jsxs("div",{className:"space-y-2",children:[o.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[o.jsx("input",{type:"checkbox",checked:x,onChange:j=>{const N=j.target.checked;p(N),a({deleteInAllNodes:N}),s()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-all-nodes-checkbox"}),o.jsx("span",{children:"Delete in all nodes"})]}),o.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[o.jsx("input",{type:"checkbox",checked:m,onChange:j=>{const N=j.target.checked;w(N),a({deleteWholeLine:N}),s()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-whole-line-checkbox"}),o.jsx("span",{children:"Delete whole line"})]})]}),o.jsx("div",{className:"text-xs text-muted-foreground",children:x?`Will update all ${e.length} nodes`:`Will update ${t.length} selected node${t.length!==1?"s":""}`})]})})]})},Ug=e=>{const t=vo(e.type),n=String(e.content??""),s=n?`${n.substring(0,15)}${n.length>15?"...":""}`:"(No Content)",r=e.id.substring(0,6),a=`[x:${Math.round(e.x)},y:${Math.round(e.y)}]`,i=`[w:${Math.round(e.width??0)},h:${Math.round(e.height??0)}]`;return o.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"node-display-element",children:[o.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"node-display-top-row",children:[o.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"node-display-content",children:[t&&o.jsx("span",{className:"flex-shrink-0","data-test":"node-display-icon",children:t}),o.jsx("span",{className:"truncate","data-test":"node-display-text",children:s}),e.isEditing&&o.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0","data-test":"node-display-editing-indicator",children:"[E]"})]}),o.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"node-display-id",children:r})]}),o.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1","data-test":"node-display-coords",children:[a," ",i]})]})},ca=e=>{const{className:t,style:n,nodes:s,headerText:r,initiallyExpanded:a}=e,i=_.getState(),l=i.projectCanvas.getActive(),c=s??(l==null?void 0:l.coreState.nodes)??[],d=(l==null?void 0:l.coreState.selectedNodes)??[],u=i.setSelectedNodes,h=i.scrollToNode,f=i.updateNodes,g=i.saveStateToLocalStorage,x=v.useCallback((w,S)=>{const y=w.length>0?w[0]:-1;if(y>=0&&y<c.length){const j=c[y];u([j]),h(j.id)}else u([])},[c,u,h]),p=Og(c,d),m=p!==-1?[p]:[];return o.jsx("div",{"data-ui-panel":"canvas-node-infos","data-test":"canvas-node-infos-container",className:ve("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded p-1 pointer-events-auto border",t),style:{...n},onMouseDown:w=>w.stopPropagation(),children:o.jsx(wo,{header:o.jsx("span",{className:"text-xs","data-test":"canvas-node-infos-header",children:r??"Nodes"}),itemList:c.map(Ug),onSelectionChange:x,selectedIndices:m,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!a,moreOptions:o.jsxs(o.Fragment,{children:[o.jsx(Bg,{nodes:c,setSelectedNodes:u}),o.jsx(Fg,{nodes:c,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:g}),o.jsx(Vg,{nodes:c,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:g})]})})})},Gg=({tag:e})=>{const[t,n]=v.useState(!1),s=v.useMemo(()=>{if(!t)return[];const i=_.getState().projectCanvas.getActive();return((i==null?void 0:i.coreState.nodes)??[]).filter(c=>Array.isArray(c.tags)&&c.tags.some(d=>d.title===e.title))},[t,e.title]),r=v.useCallback(a=>{a.stopPropagation()},[]);return o.jsxs(_t,{open:t,onOpenChange:n,children:[o.jsx(Ot,{asChild:!0,children:o.jsxs(ct,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-5 bg-background/90 text-muted-foreground font-normal italic cursor-pointer hover:bg-accent","data-test":`node-tag-${e.id}`,onClick:r,children:["#",e.title]})}),o.jsx($t,{className:"p-0 w-auto",align:"end",onPointerDownOutside:a=>a.stopPropagation(),onClick:a=>a.stopPropagation(),children:o.jsx(ca,{nodes:s,headerText:`#${e.title}`,className:"border-0",initiallyExpanded:!0})})]})},Yg=({node:e})=>!e.tags||!Array.isArray(e.tags)||e.tags.length===0?null:o.jsx("div",{className:"absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",right:"0px"},"data-test":"node-tags-container",children:e.tags.map(t=>o.jsx(Gg,{tag:t},t.id))});function Xg(e,t){const n=e.node.tags,s=t.node.tags;if(n===s)return!0;const r=Array.isArray(n),a=Array.isArray(s);return!r&&!a?!0:!r||!a||n.length!==s.length?!1:n.every((i,l)=>{var c,d;return i.id===((c=s[l])==null?void 0:c.id)&&i.title===((d=s[l])==null?void 0:d.title)})}const Kg=Be.memo(Yg,Xg);function qg({node:e,isSelected:t,scale:n}){const r=(typeof e.content=="string"?e.content:"").split(`

`).filter(u=>u.trim().length>0),a=e.width??Q.DEFAULT_NODE_WIDTH;e.height??Q.DEFAULT_NODE_HEIGHT;const l=document.createElement("canvas").getContext("2d"),c=[];if(l){l.font=getComputedStyle(document.body).font;for(const u of r){const h=u.split(`
`);let f=0;for(const p of h){if(p.trim()===""){f++;continue}const m=p.split(" ");let w="",S=1;for(let y=0;y<m.length;y++){const j=m[y],N=w+(w?" ":"")+j;l.measureText(N).width>a&&w!==""?(S++,w=j):w=N}f+=S}const g=u.length;let x;g<100?x=40+g/100*20:g<300?x=60+(g-100)/200*25:x=Math.min(95,85+(g-300)/500*10),c.push({lines:f,widthPercent:Math.round(x),charCount:g})}}return{jsx:o.jsx("div",{className:"w-full h-full flex flex-col gap-2 p-2",children:c.map((u,h)=>o.jsx("div",{className:"rounded flex flex-col gap-[2px]",style:{height:`${u.lines*Q.LINE_HEIGHT}px`,width:`${u.widthPercent}%`,backgroundColor:"transparent"},children:Array.from({length:u.lines}).map((f,g)=>o.jsx("div",{className:"rounded",style:{height:`${Q.LINE_HEIGHT-4}px`,width:"100%",backgroundColor:t?"#93c5fd":"hsl(var(--foreground))"}},g))},h))}),blockMetrics:c}}const da=v.createContext(null),ua=()=>{const e=v.useContext(da);if(!e)throw new Error("useWorkflowExecution must be used within a WorkflowExecutionProvider. Make sure CanvasAppV2 wraps its content with the provider.");return e},Zg=({children:e,value:t})=>o.jsx(da.Provider,{value:t,children:e}),ga=({nodeId:e,label:t="Execute Workflow",className:n})=>{const[s,r]=v.useState(!1),[a,i]=v.useState(null),l=ua(),{executeWorkflow:c}=l,d=h=>{h.stopPropagation()},u=async h=>{h.stopPropagation(),r(!0),i(null);try{await c(!1,e)}catch(f){const g=f instanceof Error?f.message:String(f);i(g)}finally{r(!1)}};return o.jsxs("div",{className:"w-full",children:[o.jsx(Y,{"data-test":"workflow-execute-button",onPointerDown:d,onClick:u,disabled:s,className:je("w-full bg-primary hover:bg-primary/70 text-primary-foreground","disabled:bg-muted disabled:text-muted-foreground disabled:cursor-not-allowed",n),size:"sm",children:s?o.jsxs(o.Fragment,{children:[o.jsx(as,{className:"w-4 h-4 animate-spin"}),"Executing..."]}):o.jsxs(o.Fragment,{children:[o.jsx(Ut,{className:"w-4 h-4"}),t]})}),a&&o.jsxs("div",{className:"text-xs text-destructive mt-1",children:["Error: ",a]})]})},Jg=({executionState:e,duration:t,className:n})=>{if(!e||e==="idle")return null;const r={pending:{color:"bg-gray-500",textColor:"text-white",icon:null,label:"Pending"},running:{color:"bg-blue-500",textColor:"text-white",icon:o.jsx(as,{className:"w-3 h-3 animate-spin"}),label:"Running"},success:{color:"bg-green-500",textColor:"text-white",icon:o.jsx(pn,{className:"w-3 h-3"}),label:"Success"},error:{color:"bg-red-500",textColor:"text-white",icon:o.jsx(qe,{className:"w-3 h-3"}),label:"Error"}}[e];return o.jsxs("div",{"data-test":`workflow-execution-badge-${e}`,className:je("absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium","flex items-center gap-1",r.color,r.textColor,n),children:[r.icon&&o.jsx("span",{"data-test":`workflow-execution-badge-icon-${e}`,children:r.icon}),o.jsx("span",{"data-test":"workflow-execution-badge-label",children:r.label}),t&&o.jsxs("span",{"data-test":"workflow-execution-badge-duration",className:"ml-1",children:["(",t,"ms)"]})]})};class Dn{static convertOrchestrationNode(t,n){var l;const s=t.data,r=((l=s==null?void 0:s.parameters)==null?void 0:l.rows)||[],a=this.convertRowsToNodes(r),i=[...this.createConnectionsFromRowHierarchy(r),...this.createConnectionsFromArrows(t.id,n)];return{nodes:a,connections:i}}static convertRowsToNodes(t){const n=[];for(const s of t){const r={id:s.id,type:s.stepType||"unknown",parameters:{label:s.label,order:s.order,...s.config||{}},inputHandles:this.createHandlesForStepType(s.stepType,"input",s.id),outputHandles:this.createHandlesForStepType(s.stepType,"output",s.id)};if(n.push(r),s.children&&s.children.length>0){const a=this.convertRowsToNodes(s.children);n.push(...a)}}return n}static createHandlesForStepType(t,n,s){const r=["source","transform","nodeUpdate","condition","if"],a=["source","transform","nodeUpdate","condition","if","loop"];return n==="input"&&r.includes(t)?[{id:`input_${s}`,name:"Input",type:"input",dataType:"any"}]:n==="output"&&a.includes(t)?[{id:`output_${s}`,name:"Output",type:"output",dataType:"any"}]:[]}static createConnectionsFromRowHierarchy(t,n){const s=[];for(const r of t)if(n&&s.push({id:`conn_${n}_to_${r.id}`,sourceNodeId:n,sourceHandleId:`output_${n}`,targetNodeId:r.id,targetHandleId:`input_${r.id}`}),r.children&&r.children.length>0){const a=this.createConnectionsFromRowHierarchy(r.children,r.id);s.push(...a)}return s}static createConnectionsFromArrows(t,n){const s=[],r=n.filter(a=>a.endNodeId===t&&a.endRowId);for(const a of r){const i={id:a.id,sourceNodeId:a.startNodeId||"",sourceHandleId:a.startRowId||`output_${a.startNodeId}`,targetNodeId:a.endRowId||"",targetHandleId:a.endRowId||`input_${a.endRowId}`};s.push(i)}return s}static getWorkflowName(t){return t.title||"Untitled Workflow"}static getWorkflowDescription(t){var r,a;const n=t.data,s=((a=(r=n==null?void 0:n.parameters)==null?void 0:r.rows)==null?void 0:a.length)||0;return`Workflow with ${s} step${s!==1?"s":""}`}}class Qg{constructor(t=[]){ze(this,"crudService");this.crudService=new br(t)}create(t){const n=new Date().toISOString(),s=this.crudService.create({name:t.name,description:t.description,tags:t.tags||[],nodes:t.nodes||[],connections:t.connections||[],version:1,createdAt:n,updatedAt:n});if(!s)throw new Error("Failed to create workflow definition");return s}getAll(){return this.crudService.readAll()}getById(t){return this.crudService.readById(t)}update(t,n){const s=this.crudService.readById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);const r={...s,...n,id:s.id,createdAt:s.createdAt,updatedAt:new Date().toISOString(),version:(s.version||1)+1};return this.crudService.update(r),r}delete(t){this.crudService.delete(t)}findByTag(t){return this.crudService.readAll().filter(n=>{var s;return(s=n.tags)==null?void 0:s.includes(t)})}findByName(t){const n=t.toLowerCase();return this.crudService.readAll().filter(s=>s.name.toLowerCase().includes(n))}count(){return this.crudService.count()}clear(){this.crudService.clear()}updateNodes(t,n){return this.update(t,{nodes:n})}updateConnections(t,n){return this.update(t,{connections:n})}addNode(t,n){const s=this.getById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);const r=[...s.nodes,n];return this.updateNodes(t,r)}removeNode(t,n){const s=this.getById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);const r=s.nodes.filter(i=>i.id!==n),a=s.connections.filter(i=>i.sourceNodeId!==n&&i.targetNodeId!==n);return this.update(t,{nodes:r,connections:a})}addConnection(t,n){const s=this.getById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);const r=[...s.connections,n];return this.updateConnections(t,r)}removeConnection(t,n){const s=this.getById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);const r=s.connections.filter(a=>a.id!==n);return this.updateConnections(t,r)}duplicate(t,n){const s=this.getById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);return this.create({name:n,description:s.description,tags:s.tags?[...s.tags]:void 0,nodes:s.nodes.map(r=>({...r})),connections:s.connections.map(r=>({...r}))})}}class qs{constructor(t=[],n=[]){ze(this,"definitionService");ze(this,"instanceService");ze(this,"executionFacade");this.definitionService=new Qg(t),this.instanceService=new br(n),this.executionFacade=new Kn}createDefinition(t){return this.definitionService.create(t)}getAllDefinitions(){return this.definitionService.getAll()}getDefinitionById(t){return this.definitionService.getById(t)}updateDefinition(t,n){return this.definitionService.update(t,n)}deleteDefinition(t){this.instanceService.filterByKey("definitionId",t).forEach(s=>this.instanceService.delete(s.id)),this.definitionService.delete(t)}findDefinitionsByTag(t){return this.definitionService.findByTag(t)}findDefinitionsByName(t){return this.definitionService.findByName(t)}duplicateDefinition(t,n){return this.definitionService.duplicate(t,n)}createInstance(t,n){const s=this.definitionService.getById(t);if(!s)throw new Error(`Workflow definition not found: ${t}`);const r=new Date().toISOString(),a=this.instanceService.create({definitionId:t,name:n||s.name,status:"idle",createdAt:r,executionHistory:[]});if(!a)throw new Error("Failed to create workflow instance");return a}getAllInstances(){return this.instanceService.readAll()}getInstanceById(t){return this.instanceService.readById(t)}getInstancesByDefinitionId(t){return this.instanceService.filterByKey("definitionId",t)}updateInstance(t,n){const s=this.instanceService.readById(t);if(!s)throw new Error(`Workflow instance not found: ${t}`);const r={...s,...n,id:s.id,createdAt:s.createdAt};this.instanceService.update(r)}deleteInstance(t){this.instanceService.delete(t)}async executeInstance(t,n={}){var a;const s=this.instanceService.readById(t);if(!s)throw new Error(`Workflow instance not found: ${t}`);const r=this.definitionService.getById(s.definitionId);if(!r)throw new Error(`Workflow definition not found: ${s.definitionId}`);this.updateInstance(t,{status:"running"});try{const i=this.convertWorkflowNodesToCanvas(r.nodes),l=this.convertWorkflowConnectionsToCanvas(r.connections);this.executionFacade.loadWorkflow(i,l);const c=await this.executionFacade.executeWorkflow(n.triggerNodeId||((a=i[0])==null?void 0:a.id)||""),d=c.executionId?await this.executionFacade.getExecution(c.executionId):null;if(d){const h=[...s.executionHistory,d];this.updateInstance(t,{status:c.success?"completed":"failed",lastExecutedAt:new Date().toISOString(),executionHistory:h})}return{success:c.success,executionId:c.executionId||"",instanceId:t,definitionId:s.definitionId,duration:c.duration||0,executedNodeCount:c.executedNodeCount||0,errors:c.errors||[],nodeUpdates:c.nodeUpdates}}catch(i){throw this.updateInstance(t,{status:"failed"}),i}}getExecutionHistory(t){const n=this.instanceService.readById(t);if(!n)throw new Error(`Workflow instance not found: ${t}`);return n.executionHistory}clearExecutionHistory(t){this.updateInstance(t,{executionHistory:[]})}convertWorkflowNodesToCanvas(t){return t.map(n=>({id:n.id,x:0,y:0,type:"workflow",data:{nodeType:n.type,parameters:n.parameters,inputHandles:n.inputHandles,outputHandles:n.outputHandles},width:200,height:100}))}convertWorkflowConnectionsToCanvas(t){return t.map(n=>({id:n.id,startNodeId:n.sourceNodeId,endNodeId:n.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0},startRowId:n.sourceHandleId,endRowId:n.targetHandleId}))}getStats(){const t=this.instanceService.readAll(),n=t.reduce((s,r)=>(s[r.status]=(s[r.status]||0)+1,s),{});return{totalDefinitions:this.definitionService.count(),totalInstances:t.length,instancesByStatus:n}}clearAll(){this.definitionService.clear(),this.instanceService.clear()}}class Zs{constructor(t,n){ze(this,"workflowManager");this.getCanvasState=n,this.workflowManager=t||new qs}saveWorkflow(t){const{nodeId:n,name:s,description:r,tags:a}=t,{node:i,arrows:l}=this.getNodeAndArrows(n),{nodes:c,connections:d}=Dn.convertOrchestrationNode(i,l),u=s||Dn.getWorkflowName(i),h=r||Dn.getWorkflowDescription(i),g=this.workflowManager.getAllDefinitions().find(x=>x.name===u);return g?this.workflowManager.updateDefinition(g.id,{nodes:c,connections:d,description:h,tags:a||g.tags}):this.workflowManager.createDefinition({name:u,description:h,tags:a||[],nodes:c,connections:d})}loadWorkflow(t){const{definitionId:n,position:s={x:100,y:100},existingNodeId:r}=t,a=this.workflowManager.getDefinitionById(n);if(!a)throw new Error(`Workflow definition not found: ${n}`);const i=this.convertWorkflowNodesToRows(a.nodes,a.connections);return{id:r||`workflow-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:a.name,content:a.description||"",x:s.x,y:s.y,width:400,height:600,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:i},inputHandles:this.createInputHandlesFromRows(i),outputHandles:[]}}}validateWorkflow(t){var r;const n=[],s=[];try{const{node:a,arrows:i}=this.getNodeAndArrows(t),l=a.data,c=((r=l==null?void 0:l.parameters)==null?void 0:r.rows)||[];c.length===0&&n.push("Workflow must have at least one step");const d=c.filter(g=>!g.stepType||g.stepType==="empty");d.length>0&&s.push(`${d.length} step(s) have no type configured`);const u=new Set(i.filter(g=>g.endNodeId===t&&g.endRowId).map(g=>g.endRowId)),f=c.filter(g=>g.stepType==="source").filter(g=>!u.has(g.id));return f.length>0&&s.push(`${f.length} source step(s) have no input connections`),{valid:n.length===0,errors:n,warnings:s}}catch(a){return{valid:!1,errors:[`Validation failed: ${String(a)}`],warnings:s}}}canSave(t){const n=this.validateWorkflow(t);return{valid:n.valid,errors:n.errors}}previewDefinition(t){const{node:n,arrows:s}=this.getNodeAndArrows(t),{nodes:r,connections:a}=Dn.convertOrchestrationNode(n,s);return{nodes:r,connections:a,nodeCount:r.length,connectionCount:a.length}}addRow(t){var f;const{nodeId:n,stepType:s,label:r,parentRowId:a,config:i}=t,{node:l}=this.getNodeAndArrows(n),c=l.data,d=((f=c==null?void 0:c.parameters)==null?void 0:f.rows)||[],u=d.length+1,h={id:De(),label:r||`Step ${u}`,order:u,stepType:s,config:i||{}};if(a){const g=this.addRowToParent(d,a,h);this.updateNodeRows(n,g)}else{const g=[...d,h];this.updateNodeRows(n,g)}return h}updateRow(t){var d;const{nodeId:n,rowId:s,updates:r}=t,{node:a}=this.getNodeAndArrows(n),i=a.data,l=((d=i==null?void 0:i.parameters)==null?void 0:d.rows)||[],c=this.updateRowRecursive(l,s,r);this.updateNodeRows(n,c)}deleteRow(t){var c;const{nodeId:n,rowId:s}=t,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((c=a==null?void 0:a.parameters)==null?void 0:c.rows)||[],l=this.deleteRowRecursive(i,s);this.updateNodeRows(n,l)}reorderRows(t){var d;const{nodeId:n,rowOrders:s}=t,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((d=a==null?void 0:a.parameters)==null?void 0:d.rows)||[],l=new Map(s.map(u=>[u.rowId,u.order])),c=this.updateRowOrders(i,l);this.updateNodeRows(n,c)}getTemplates(){return[{id:"simple-transform",name:"Simple Transform",description:"Data input â†’ transformation â†’ output"},{id:"conditional-flow",name:"Conditional Flow",description:"Data input â†’ condition check â†’ branching logic"},{id:"loop-process",name:"Loop Processing",description:"Data input â†’ loop over items â†’ process each"}]}createFromTemplate(t){const{templateId:n,name:s}=t,a={"simple-transform":{name:s||"Simple Transform Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"transform-1",type:"transform",parameters:{label:"Transform Data"},inputHandles:[{id:"input_transform-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_transform-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"transform-1",targetHandleId:"input_transform-1"}]},"conditional-flow":{name:s||"Conditional Flow Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"condition-1",type:"if",parameters:{label:"Check Condition"},inputHandles:[{id:"input_condition-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_condition-1_true",name:"True",type:"output",dataType:"any"},{id:"output_condition-1_false",name:"False",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"condition-1",targetHandleId:"input_condition-1"}]},"loop-process":{name:s||"Loop Processing Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"loop-1",type:"loop",parameters:{label:"Process Each Item"},inputHandles:[{id:"input_loop-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_loop-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"loop-1",targetHandleId:"input_loop-1"}]}}[n];if(!a)throw new Error(`Template not found: ${n}`);return this.workflowManager.createDefinition({name:a.name,description:`Created from ${n} template`,tags:["template",n],nodes:a.nodes,connections:a.connections})}exportWorkflow(t){const n=this.workflowManager.getDefinitionById(t);if(!n)throw new Error(`Workflow definition not found: ${t}`);return JSON.stringify(n,null,2)}exportWorkflows(t){const n=t.map(s=>this.workflowManager.getDefinitionById(s)).filter(s=>s!==void 0);return JSON.stringify(n,null,2)}exportAllWorkflows(){const t=this.workflowManager.getAllDefinitions();return JSON.stringify(t,null,2)}importWorkflow(t){try{const n=JSON.parse(t);if(!n.name||!Array.isArray(n.nodes)||!Array.isArray(n.connections))throw new Error("Invalid workflow format: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:n.name,description:n.description,tags:n.tags||[],nodes:n.nodes,connections:n.connections})}catch(n){throw new Error(`Failed to import workflow: ${n instanceof Error?n.message:String(n)}`)}}importWorkflows(t){try{const n=JSON.parse(t);if(!Array.isArray(n))throw new Error("Invalid format: expected array of workflows");return n.map(s=>{if(!s.name||!Array.isArray(s.nodes)||!Array.isArray(s.connections))throw new Error("Invalid workflow format in array: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:s.name,description:s.description,tags:s.tags||[],nodes:s.nodes,connections:s.connections})})}catch(n){throw new Error(`Failed to import workflows: ${n instanceof Error?n.message:String(n)}`)}}downloadWorkflow(t){const n=this.exportWorkflow(t),s=this.workflowManager.getDefinitionById(t);if(!s)return;const r=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`${s.name.replace(/[^a-z0-9]/gi,"_")}.workflow.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}downloadWorkflows(t){const n=this.exportWorkflows(t),s=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(s),a=document.createElement("a");a.href=r,a.download=`workflows_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}bulkDeleteDefinitions(t){t.forEach(n=>{this.workflowManager.deleteDefinition(n)})}bulkDuplicateDefinitions(t){return t.map((n,s)=>{const r=this.workflowManager.getDefinitionById(n);if(!r)throw new Error(`Definition not found: ${n}`);return this.workflowManager.duplicateDefinition(n,`${r.name} (Copy ${s+1})`)})}bulkAddTags(t,n){t.forEach(s=>{const r=this.workflowManager.getDefinitionById(s);if(!r)return;const a=r.tags||[],i=[...new Set([...a,...n])];this.workflowManager.updateDefinition(s,{tags:i})})}bulkRemoveTags(t,n){t.forEach(s=>{const r=this.workflowManager.getDefinitionById(s);if(!r)return;const i=(r.tags||[]).filter(l=>!n.includes(l));this.workflowManager.updateDefinition(s,{tags:i})})}getBulkStats(t){const n=t.map(i=>this.workflowManager.getDefinitionById(i)).filter(i=>i!==void 0),s=new Set;let r=0,a=0;return n.forEach(i=>{r+=i.nodes.length,a+=i.connections.length,(i.tags||[]).forEach(l=>s.add(l))}),{count:n.length,totalNodes:r,totalConnections:a,tags:Array.from(s)}}getNodeAndArrows(t){if(!this.getCanvasState)throw new Error("Canvas state getter not provided");const{nodes:n,arrows:s}=this.getCanvasState(),r=n.find(a=>a.id===t);if(!r)throw new Error(`Node not found: ${t}`);return{node:r,arrows:s}}convertWorkflowNodesToRows(t,n){const s=new Map;for(const l of n)if(l.sourceHandleId.startsWith("output_")&&l.targetHandleId.startsWith("input_")){const c=l.sourceNodeId,d=l.targetNodeId;s.has(c)||s.set(c,[]),s.get(c).push(d)}const r=new Set,a=(l,c)=>{r.add(l.id);const u=(s.get(l.id)||[]).filter(h=>!r.has(h)).map((h,f)=>{const g=t.find(x=>x.id===h);return g?a(g,f+1):null}).filter(Boolean);return{id:l.id,label:l.parameters.label||`Step ${c}`,order:c,stepType:l.type,config:l.parameters,children:u.length>0?u:void 0}};return t.filter(l=>!n.some(c=>c.targetNodeId===l.id)).map((l,c)=>a(l,c+1))}createInputHandlesFromRows(t){const n=[],s=r=>{r.stepType==="source"&&n.push({id:`input_${r.id}`,name:r.label,type:"input",dataType:"any"}),r.children&&r.children.forEach(a=>s(a))};return t.forEach(s),n}updateNodeRows(t,n){if(!this.getCanvasState)throw new Error("Cannot update rows without canvas state");const s=this.createInputHandlesFromRows(n);return{rows:n,inputHandles:s}}addRowToParent(t,n,s){return t.map(r=>{if(r.id===n){const a=r.children||[];return{...r,children:[...a,s]}}return r.children?{...r,children:this.addRowToParent(r.children,n,s)}:r})}updateRowRecursive(t,n,s){return t.map(r=>r.id===n?{...r,...s}:r.children?{...r,children:this.updateRowRecursive(r.children,n,s)}:r)}deleteRowRecursive(t,n){return t.filter(s=>s.id!==n).map(s=>s.children?{...s,children:this.deleteRowRecursive(s.children,n)}:s)}updateRowOrders(t,n){return t.map(s=>{const r=n.get(s.id),a=r!==void 0?{...s,order:r}:s;return a.children?{...a,children:this.updateRowOrders(a.children,n)}:a}).sort((s,r)=>s.order-r.order)}}const Bn="workflow-manager-storage",fa=()=>{try{const e=localStorage.getItem(Bn);if(e)return JSON.parse(e)}catch(e){console.error("[WorkflowManager] Failed to load from localStorage:",e)}return null},ef=e=>{try{Oe.clientLogsApiClient.sendLogs("wfm_save_to_storage",{key:Bn,definitionCount:e.definitions.length,instanceCount:e.instances.length,definitionNames:e.definitions.map(n=>n.name)},"workflow-client.log");const t=JSON.stringify(e);localStorage.setItem(Bn,t),Oe.clientLogsApiClient.sendLogs("wfm_save_success",{key:Bn,serializedLength:t.length},"workflow-client.log")}catch(t){Oe.clientLogsApiClient.sendLogs("wfm_save_error",{error:String(t)},"workflow-client.log"),console.error("[WorkflowManager] Failed to save to localStorage:",t)}},Bt=fa(),lr=(Bt==null?void 0:Bt.definitions)||[],cr=(Bt==null?void 0:Bt.instances)||[],Rt=Ha((e,t)=>{const n=new qs(lr,cr);return{definitions:lr,instances:cr,facade:n,selectedDefinitionId:null,selectedInstanceId:null,isExecuting:!1,lastExecutionResult:null,createDefinition:s=>{const r=n.createDefinition(s),a=n.getAllDefinitions();return e({definitions:a}),t().saveToStorage(),r},updateDefinition:(s,r)=>{const a=n.updateDefinition(s,r),i=n.getAllDefinitions();return e({definitions:i}),t().saveToStorage(),a},deleteDefinition:s=>{n.deleteDefinition(s);const r=n.getAllDefinitions(),a=n.getAllInstances();e({definitions:r,instances:a,selectedDefinitionId:t().selectedDefinitionId===s?null:t().selectedDefinitionId}),t().saveToStorage()},duplicateDefinition:(s,r)=>{const a=n.duplicateDefinition(s,r),i=n.getAllDefinitions();return e({definitions:i}),t().saveToStorage(),a},findDefinitionsByTag:s=>n.findDefinitionsByTag(s),findDefinitionsByName:s=>n.findDefinitionsByName(s),createInstance:(s,r)=>{const a=n.createInstance(s,r),i=n.getAllInstances();return e({instances:i}),t().saveToStorage(),a},updateInstance:(s,r)=>{n.updateInstance(s,r);const a=n.getAllInstances();e({instances:a}),t().saveToStorage()},deleteInstance:s=>{n.deleteInstance(s);const r=n.getAllInstances();e({instances:r,selectedInstanceId:t().selectedInstanceId===s?null:t().selectedInstanceId}),t().saveToStorage()},getInstancesByDefinitionId:s=>n.getInstancesByDefinitionId(s),executeInstance:async(s,r)=>{e({isExecuting:!0});try{const a=await n.executeInstance(s,r),i=n.getAllInstances();return e({instances:i,isExecuting:!1,lastExecutionResult:a}),t().saveToStorage(),a}catch(a){throw e({isExecuting:!1}),a}},selectDefinition:s=>{e({selectedDefinitionId:s})},selectInstance:s=>{e({selectedInstanceId:s})},getStats:()=>n.getStats(),clearAll:()=>{n.clearAll(),e({definitions:[],instances:[],selectedDefinitionId:null,selectedInstanceId:null,lastExecutionResult:null}),t().saveToStorage()},loadFromStorage:()=>{const s=fa();if(s){const r=new qs(s.definitions,s.instances);e({definitions:s.definitions,instances:s.instances,facade:r})}},saveToStorage:()=>{ef({definitions:t().definitions,instances:t().instances})}}}),tf=({node:e,nodes:t,arrows:n,updateNode:s})=>{var d;const r=e.data,a=((d=r==null?void 0:r.parameters)==null?void 0:d.rows)||[],i=Rt.getState().definitions,l=()=>{try{const h=new Zs(Rt.getState().facade,()=>({nodes:t,arrows:n})).previewDefinition(e.id),f=typeof e.title=="string"?e.title:`Workflow ${e.id}`,g=typeof e.content=="string"?e.content:"",p=Rt.getState().definitions.find(w=>w.name===f);let m;p?m=Rt.getState().updateDefinition(p.id,{nodes:h.nodes,connections:h.connections,description:g}):m=Rt.getState().createDefinition({name:f,description:g,tags:[],nodes:h.nodes,connections:h.connections}),ce.success("Workflow saved",{description:`"${m.name}" saved successfully (v${m.version})`})}catch(u){ce.error("Failed to save workflow",{description:u instanceof Error?u.message:String(u)})}},c=u=>{if(!u){ce.error("No workflow selected",{description:"Please select a workflow to load"});return}try{const f=new Zs(Rt.getState().facade,()=>({nodes:t,arrows:n})).loadWorkflow({definitionId:u,existingNodeId:e.id});s(e.id,{title:f.title,content:f.content,data:f.data}),ce.success("Workflow loaded",{description:`"${f.title}" loaded successfully`})}catch(h){ce.error("Failed to load workflow",{description:h instanceof Error?h.message:String(h)})}};return o.jsx(rs,{storageKey:`workflow-more-options-${e.id}`,initialConfig:{autoSaveEnabled:!1,selectedDefinitionId:""},children:(u,h,f)=>(v.useEffect(()=>{if(!u.autoSaveEnabled||a.length===0)return;const g=setTimeout(()=>{l()},3e3);return()=>clearTimeout(g)},[a,u.autoSaveEnabled]),o.jsx(f,{icon:o.jsx(Dr,{className:"h-4 w-4"}),variant:"ghost",size:"icon",buttonClassName:"workflow-more-options-button",contentClassName:"w-80",title:"Workflow Options",children:o.jsxs("div",{className:"workflow-options-panel space-y-4",children:[o.jsxs("div",{className:"save-section space-y-2",children:[o.jsx("h4",{className:"text-sm font-semibold",children:"Save Workflow"}),o.jsxs("button",{"data-test":"workflow-save-to-manager-button",onClick:g=>{g.stopPropagation(),l()},className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:[o.jsx(Pt,{className:"h-4 w-4"}),"Save to Workflow Manager"]})]}),o.jsxs("div",{className:"load-section space-y-2",children:[o.jsx("h4",{className:"text-sm font-semibold",children:"Load Workflow"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Select a workflow to load into this node"}),o.jsxs(es,{"data-test":"workflow-load-select",value:u.selectedDefinitionId,onValueChange:g=>{h({...u,selectedDefinitionId:g})},children:[o.jsx(ts,{"data-test":"workflow-load-select-trigger",children:o.jsx(ns,{placeholder:"Select workflow..."})}),o.jsx(ss,{children:i.length===0?o.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No saved workflows found"}):i.map(g=>o.jsxs(os,{value:g.id,children:[g.name," (v",g.version,")"]},g.id))})]}),o.jsxs("button",{"data-test":"workflow-load-confirm-button",onClick:g=>{g.stopPropagation(),c(u.selectedDefinitionId),h({...u,selectedDefinitionId:""})},disabled:!u.selectedDefinitionId,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm border rounded hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[o.jsx(Bi,{className:"h-4 w-4"}),"Load"]})]}),o.jsx("div",{className:"auto-save-section space-y-2 pt-2 border-t",children:o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsxs("div",{className:"space-y-0.5",children:[o.jsx("h4",{className:"text-sm font-semibold",children:"Auto-Save"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically save after changes (3s delay)"})]}),o.jsx("button",{"data-test":"workflow-auto-save-toggle",onClick:g=>{g.stopPropagation();const x=!u.autoSaveEnabled;h({...u,autoSaveEnabled:x}),ce.info(x?"Auto-save enabled":"Auto-save disabled",{description:x?"Workflow will save automatically after changes":"Manual save required"})},className:`w-10 h-10 flex items-center justify-center rounded transition-colors border ${u.autoSaveEnabled?"bg-primary text-primary-foreground border-primary":"hover:bg-accent border-border"}`,title:u.autoSaveEnabled?"Disable auto-save":"Enable auto-save",children:o.jsx(ro,{className:"h-4 w-4"})})]})})]})}))})},nf=({node:e,nodes:t,arrows:n,showTextConfig:s,rows:r,updateNode:a,onToggleTextConfig:i,onSetJsonConfigText:l,onSetJsonError:c})=>{const d=e.data,{executeWorkflow:u,showDryRunResults:h}=ua(),f=x=>{if(x.stopPropagation(),!s){const p={nodeId:e.id,nodeType:d==null?void 0:d.nodeType,rows:r,connections:n.filter(m=>m.endNodeId===e.id||m.startNodeId===e.id)};l(JSON.stringify(p,null,2)),c(null)}i()},g=async x=>{x.stopPropagation();const p=await u(!0,e.id);h(p)};return o.jsxs("div",{className:"workflow-header font-semibold mb-2 text-sm border-b pb-1 flex justify-between items-center",children:[o.jsx("span",{children:s?"JSON Config":"Orchestration Rows"}),(d==null?void 0:d.showExecuteButton)&&o.jsxs("div",{className:"execute-button-container flex items-center gap-1.5",children:[o.jsx(Y,{"data-test":"workflow-toggle-json-button",onClick:f,variant:s?"default":"outline",size:"icon",className:"h-8 w-8",title:s?"View visual steps":"View workflow as JSON",children:s?o.jsx(zt,{className:"h-4 w-4"}):o.jsx(ao,{className:"h-4 w-4"})}),o.jsx(Y,{"data-test":"workflow-dry-run-button",onClick:g,variant:"outline",size:"icon",className:"h-8 w-8",title:"Dry Run (preview changes without applying)",children:o.jsx(wn,{className:"h-4 w-4"})}),o.jsx(ga,{nodeId:e.id,label:"",className:"h-8 w-8"}),o.jsx(tf,{node:e,nodes:t,arrows:n,updateNode:a})]})]})},sf=({node:e,jsonConfigText:t,jsonError:n,onJsonConfigTextChange:s,onJsonErrorChange:r,onClose:a,updateNode:i})=>{const l=e.data,c=f=>{f.stopPropagation();try{const g=JSON.parse(t);if(!g.rows||!Array.isArray(g.rows)){r('Invalid JSON: "rows" must be an array');return}i(e.id,{data:{...l,parameters:{...l.parameters,rows:g.rows}}}),r(null),a()}catch(g){r(`Invalid JSON: ${g.message}`)}},d=f=>{f.stopPropagation(),navigator.clipboard.writeText(t)},u=f=>{s(f.target.value),r(null)},h=f=>{f.preventDefault(),f.stopPropagation();const g=f.currentTarget,x=g.scrollTop<g.scrollHeight-g.clientHeight,p=g.scrollTop>0,m=f.deltaY>0;(m&&x||!m&&p)&&(g.scrollTop+=f.deltaY)};return o.jsxs("div",{className:"workflow-json-wrapper h-full w-full flex flex-col gap-1",onWheel:f=>{f.stopPropagation()},children:[o.jsx("div",{className:"workflow-textarea-parent flex-1 w-full min-h-0",onWheel:f=>{f.stopPropagation()},children:o.jsx("textarea",{value:t,onChange:u,onClick:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onWheel:h,className:"workflow-textarea w-full h-full text-[10px] font-mono bg-background border-0 p-1 resize-none focus:outline-none overflow-auto",spellCheck:!1})}),n&&o.jsx("div",{className:"text-[10px] text-destructive bg-destructive/10 border-t border-destructive/20 px-1 py-1",children:n}),o.jsxs("div",{className:"flex gap-1 border-t pt-1",children:[o.jsx("button",{"data-test":"workflow-json-save-button",onClick:c,className:"flex-1 px-2 py-1 text-[10px] bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:"Save"}),o.jsx("button",{"data-test":"workflow-json-copy-button",onClick:d,className:"px-2 py-1 text-[10px] border border-border rounded hover:bg-accent transition-colors",children:"Copy"})]})]})},of=({node:e,rows:t,rowElementsRef:n,connectorOffsetLeft:s,stepTypesWithConnectors:r})=>o.jsx("div",{"data-test":"workflow-connector-layer-container",className:"workflow-connector-layer absolute top-0 bottom-0 pointer-events-none",style:{left:`${s}px`},children:t.map(a=>{if(!r.includes(a.stepType))return null;const i=a.id.replace("row_",""),l=a.label||`Step ${i}`,c=n.current.get(a.id);if(!c)return null;const d=c.getBoundingClientRect(),u=c.closest(".bg-background.border.p-3");if(!u)return null;const h=u.getBoundingClientRect(),f=d.top+d.height/2-h.top;return o.jsx("div",{"data-test":`workflow-connector-${a.id}`,"data-row-connector":a.id,"data-node-id":e.id,className:"absolute w-3 h-3 rounded-full border-2 border bg-background cursor-crosshair hover:bg-accent transition-colors pointer-events-auto",style:{left:"0",top:`${f}px`,transform:"translateY(-50%)"},title:`Connect to ${l}`,onClick:g=>{g.stopPropagation()}},`connector-${a.id}`)})}),rf=({node:e,rows:t,updateNode:n})=>{const s=e.data,[r,a]=v.useState(null),[i,l]=v.useState(!1),[c,d]=v.useState(!1),[u,h]=v.useState(!1),[f,g]=v.useState(null),[x,p]=v.useState(null),m=(A,k)=>{for(const b of A){if(b.id===k)return b;if(b.children){const T=m(b.children,k);if(T)return T}}return null},w=(A,k,b)=>A.map(T=>T.id===k?{...T,...b}:T.children?{...T,children:w(T.children,k,b)}:T),S=(A,k)=>A.filter(b=>b.id!==k).map(b=>b.children?{...b,children:S(b.children,k)}:b);return{selectedRowId:r,setSelectedRowId:a,configPopoverOpen:i,setConfigPopoverOpen:l,showNodeUpdateConfig:c,setShowNodeUpdateConfig:d,showIfStepConfig:u,setShowIfStepConfig:h,popoverPosition:f,popoverSize:x,handleAddRow:()=>{const A=t.length+1,k={id:De(),label:`Step ${A}`,order:A,stepType:"empty"},b=[...t,k];b.sort((D,O)=>D.order-O.order);const E=b.filter(D=>gn.includes(D.stepType)).map(D=>({id:`input_${D.id}`,name:D.label,type:"input",dataType:"any"}));n(e.id,{data:{...s,parameters:{...s.parameters,rows:b},inputHandles:E}})},handleRowClick:(A,k,b)=>{const T=m(t,A);a(A);const E=window.innerWidth,D=window.innerHeight,O=k.clientX,M=k.clientY,P=O<E/2?O+100:O-100;g({x:P,y:M});const F=Math.min(450,Math.floor(D*.6));if(p({width:500,height:F}),b==="badge")l(!0);else if(b==="gear"){const L=T==null?void 0:T.stepType;L==="nodeUpdate"?d(!0):L==="if"&&h(!0)}},handleConfigureRow:(A,k)=>{const b=w(t,A,{stepType:k});n(e.id,{data:{...s,parameters:{...s.parameters,rows:b}}}),a(null)},handleDeleteRow:A=>{const k=S(t,A),T=k.filter(E=>gn.includes(E.stepType)).map((E,D)=>({id:E.id,position:"left",offsetY:96+D*32}));n(e.id,{data:{...s,parameters:{...s.parameters,rows:k},inputHandles:T}})},handleSaveNodeUpdateConfig:A=>{if(!r)return;const k=w(t,r,{stepType:"nodeUpdate",config:A});n(e.id,{data:{...s,parameters:{...s.parameters,rows:k}}}),d(!1),a(null)},handleSaveIfStepConfig:A=>{if(!r)return;const k=w(t,r,{stepType:"if",config:A});n(e.id,{data:{...s,parameters:{...s.parameters,rows:k}}}),h(!1),a(null)},findRowRecursive:m}},dr=({node:e})=>{var I,R,A;const t=e.data,n=((I=t==null?void 0:t.parameters)==null?void 0:I.rows)||[],[s,r]=v.useState(!1),[a,i]=v.useState(""),[l,c]=v.useState(null);v.useEffect(()=>{if(!s)return;const k=b=>{var E;const T=b.target;if(T.closest(".workflow-json-wrapper")){const D=(E=T.closest(".workflow-json-wrapper"))==null?void 0:E.querySelector("textarea");if(D){b.stopPropagation(),b.preventDefault();const O=D.scrollTop<D.scrollHeight-D.clientHeight,M=D.scrollTop>0,$=b.deltaY>0;($&&O||!$&&M)&&(D.scrollTop+=b.deltaY)}}};return document.addEventListener("wheel",k,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",k,{capture:!0})}},[s]);const[d,u]=v.useState(()=>new Set(n.filter(k=>k.children&&k.children.length>0).map(k=>k.id))),h=v.useRef(null),f=v.useRef(new Map),[g,x]=v.useState(null),p=B(k=>{var b;return((b=k.projectCanvas.getActive())==null?void 0:b.coreState.arrows)??[]}),m=B(k=>{var b;return((b=k.projectCanvas.getActive())==null?void 0:b.coreState.nodes)??[]}),S=B(k=>{var b;return((b=k.projectCanvas.getActive())==null?void 0:b.coreState.selectedNodes)??[]}).some(k=>k.id===e.id),y=B(k=>k.updateNode),j=rf({node:e,rows:n,updateNode:y}),N=p.filter(k=>k.endNodeId===e.id&&k.endRowId);v.useEffect(()=>{let k=[...n],b=!1;const T=new Set;N.forEach(D=>{D.endRowId&&T.add(D.endRowId)});const E=k.length;if(k=k.filter(D=>{const O=D.stepType&&D.stepType!=="empty";return T.has(D.id)||O}),k.length!==E&&(b=!0),b){k.sort((M,$)=>M.order-$.order);const O=k.filter(M=>gn.includes(M.stepType)).map(M=>({id:`input_${M.id}`,name:M.label,type:"input",dataType:"any"}));y(e.id,{data:{...t,parameters:{...t.parameters,rows:k},inputHandles:O}})}},[N.length,e.id,y]),v.useEffect(()=>(h.current=new ml({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:()=>!0,onDragMove:({sortIndex:k})=>{k!==null&&x(k)},onDrop:({item:k,sortIndex:b})=>{if(b==null)return;const T=k.data.rowId,E=[...n],D=E.findIndex(P=>P.id===T);if(D===-1)return;const[O]=E.splice(D,1);E.splice(b,0,O),E.forEach((P,F)=>{P.order=F+1});const $=E.filter(P=>gn.includes(P.stepType)).map((P,F)=>({id:P.id,position:"left",offsetY:96+F*32}));y(e.id,{data:{...t,parameters:{...t.parameters,rows:E},inputHandles:$}})},onDragEnd:()=>{x(null)}}),()=>{var k;(k=h.current)==null||k.destroy(),f.current.clear()}),[e.id]),v.useEffect(()=>{if(!h.current)return;const k=document.querySelector(`[data-workflow-rows="${e.id}"]`);k&&!k.dataset.dropZoneRegistered&&(h.current.registerDropZone(`workflow-rows-${e.id}`,k,void 0,{nodeId:e.id}),k.dataset.dropZoneRegistered="true"),n.forEach(T=>{const E=document.querySelector(`[data-drag-handle="${T.id}"]`);E&&!E.dataset.dndRegistered&&(h.current.registerDraggable(T.id,E,{rowId:T.id}),E.dataset.dndRegistered="true")});const b=new Set(n.map(T=>T.id));f.current.forEach((T,E)=>{b.has(E)||(h.current.unregisterDraggable(E),f.current.delete(E))})},[n,e.id]);const C=k=>{const T=k.target.closest("[data-drag-handle]"),E=document.querySelector(`[data-node-id="${e.id}"]`);E==null||E.getBoundingClientRect(),n.map(D=>{const O=document.querySelector(`[data-workflow-row="${e.id}:${D.id}"]`);if(O){const M=O.getBoundingClientRect();return{rowId:D.id,screenY:M.top+M.height/2,top:M.top,bottom:M.bottom,height:M.height}}return{rowId:D.id,error:"element not found"}}),S&&!T&&k.stopPropagation()};return o.jsxs("div",{"data-test":`workflow-orchestration-node-${e.id}`,className:"workflow-node-container bg-background border p-3 w-full h-full flex flex-col relative overflow-visible",onPointerDown:C,children:[o.jsx(of,{node:e,rows:n,rowElementsRef:f,connectorOffsetLeft:gl,stepTypesWithConnectors:gn}),o.jsx(nf,{node:e,nodes:m,arrows:p,showTextConfig:s,rows:n,updateNode:y,onToggleTextConfig:()=>r(!s),onSetJsonConfigText:i,onSetJsonError:c}),o.jsx("div",{"data-test":`workflow-content-area-${e.id}`,className:"workflow-content-area flex-1 w-full text-xs overflow-y-auto relative","data-workflow-rows":e.id,onWheel:k=>{s&&k.stopPropagation()},children:s?o.jsx(sf,{node:e,jsonConfigText:a,jsonError:l,onJsonConfigTextChange:i,onJsonErrorChange:c,onClose:()=>r(!1),updateNode:y}):o.jsx(xl,{data:n,defaultExpandedIds:d,onReorder:k=>{const b=(O,M=1)=>O.map(($,P)=>{const F=M+P;return{...$,order:F,children:$.children?b($.children,F*10):$.children}}),T=b(k),E=new Set(T.filter(O=>O.children&&O.children.length>0).map(O=>O.id)),D=new Set(d);E.forEach(O=>{d.has(O)||D.add(O)}),u(D),y(e.id,{data:{...t,parameters:{...t.parameters,rows:T}}})},renderCustomContent:k=>o.jsx(fl,{row:k,node:e,nodes:m,incomingArrows:N,selectedRowId:j.selectedRowId,configPopoverOpen:j.configPopoverOpen,rowElementsRef:f,onRowClick:j.handleRowClick,onConfigureRow:j.handleConfigureRow,onDeleteRow:j.handleDeleteRow,onSelectedRowIdChange:j.setSelectedRowId})})}),o.jsx("button",{"data-test":"workflow-add-row-button",onClick:j.handleAddRow,className:"mt-2 w-full py-1 text-xs border bg-background hover:bg-accent rounded",children:"+ Add Row"}),j.showNodeUpdateConfig&&j.selectedRowId&&o.jsx(hl,{isVisible:j.showNodeUpdateConfig,onClose:()=>{j.setShowNodeUpdateConfig(!1),j.setSelectedRowId(null)},allNodes:m,currentConfig:(R=j.findRowRecursive(n,j.selectedRowId))==null?void 0:R.config,onSave:j.handleSaveNodeUpdateConfig,initialPosition:j.popoverPosition||void 0,initialSize:j.popoverSize||void 0}),j.showIfStepConfig&&j.selectedRowId&&o.jsx(pl,{isVisible:j.showIfStepConfig,onClose:()=>{j.setShowIfStepConfig(!1),j.setSelectedRowId(null)},currentConfig:(A=j.findRowRecursive(n,j.selectedRowId))==null?void 0:A.config,onSave:j.handleSaveIfStepConfig,initialPosition:j.popoverPosition||void 0,initialSize:j.popoverSize||void 0})]})},af="type here...",lf=[],ur=({node:e,preventEdit:t})=>{var k;const n=v.useRef(null),[s,r]=v.useState(t),[a,i]=v.useState(e.content||""),l=e.data,c=(l==null?void 0:l.displayFormat)||"raw",d=B(b=>b.updateNodeContent),u=B(b=>b.updateNode),h=B(b=>b.setMode),f=B(b=>b.uiState.nodeToFocusId),g=B(b=>b.uiState.dragInfo);g==null||g.draggedNodeId,e.id;const x=B(b=>{var T;return((T=b.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??lf}),p=v.useMemo(()=>!!x.some(b=>b.id===e.id),[x,e.id]),m=p&&f===e.id,{fitNodeDimensions:w}=cs(),S=v.useMemo(()=>{if(c==="json")try{const b=JSON.parse(a);return JSON.stringify(b,null,2)}catch{return a}return a},[a,c]),y=b=>{i(b.target.value)},j=v.useCallback(b=>{b.preventDefault();const T=b.clipboardData.getData("text"),E=n.current;if(!E)return;const D=E.selectionStart,O=E.selectionEnd,M=E.value,$=M.substring(0,D)+T+M.substring(O);E.value=$;const P=D+T.length;E.setSelectionRange(P,P),i($),d(e.id,$)},[e.id,d]),N=v.useCallback(b=>{r(b),u(e.id,{isEditing:b})},[u,e.id]),C=v.useCallback(()=>{var b;d(e.id,a),N(!1),u(e.id,{isEditing:!1}),(b=window.getSelection())==null||b.removeAllRanges()},[e.id,d,a,u]),I=v.useCallback(b=>{if(b.shiftKey){!s&&p&&x.length<=1&&(N(!0),setTimeout(()=>{var E;return(E=n.current)==null?void 0:E.focus()},0));return}const T=p&&x.length<=1;T&&N(T)},[s,p,x.length]),R=v.useCallback(b=>{var P,F,U,L;if(b.key==="Escape"){C(),N(!1),_.getState().uiState.mode!==W.VIM&&h(W.SELECT),(P=n.current)==null||P.blur();return}if(b.key==="Enter"&&b.ctrlKey){const G=((F=n.current)==null?void 0:F.value)||"";d(e.id,G);return}const T=((U=n.current)==null?void 0:U.value)??"",E=M(T),D=$(T,b.key==="Enter"),O=(L=e.options)!=null&&L.lockSize?e.width:E;u(e.id,{width:O,height:D,isEditing:!0});function M(G,q=Q.DEFAULT_NODE_WIDTH,ee=Nr.textNodeXPadding){const me=G.split(/\n/).map(H=>Cr(H)).reduce((H,te)=>Math.max(H,te),0)+ee,be=Math.max(me,q);return Math.max(be,e.width??0)}function $(G,q=!1){let oe=G.split(/\n/).length,ge=Q.DEFAULT_NODE_HEIGHT;return oe===1&&!q?(ge=Math.max(ge,e.height??0),ge):(q&&(oe+=1),ge+=(oe-1)*Q.LINE_HEIGHT,ge=Math.max(ge,e.height??0),ge)}},[C,d,u,e.id,e.width]);v.useEffect(()=>{f||N(!1)},[f]),v.useEffect(()=>{m&&(N(!0),i(e.content||""),window.setTimeout(()=>{const b=n.current;b&&(b.focus(),b.selectionStart=b.selectionEnd=b.value.length)},0))},[m,e.content]),v.useEffect(()=>{i(e.content||"")},[e.content]);const A=v.useCallback(()=>{const b=c==="raw"?"json":"raw";u(e.id,{data:{...l,displayFormat:b}})},[c,e.id,l,u]);return o.jsxs("div",{className:"relative w-full h-full",children:[p&&o.jsx("button",{onClick:A,className:"absolute -top-7 right-0 z-50 px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",title:`Switch to ${c==="raw"?"JSON":"raw"} format`,children:c==="raw"?"Raw":"JSON"}),o.jsx("textarea",{spellCheck:!1,ref:n,id:`WorkflowSourceNode-${e.id}`,value:s?a:S,onChange:y,onPaste:j,onBlur:C,onKeyDown:R,onMouseDown:I,placeholder:af,"data-is-editing":t?!1:s,className:ve("relative z-10","m-0 p-1 w-full h-full","resize-none","overflow-hidden","border","font-mono",e.className,{"pointer-events-none":t,"cursor-text":s,"cursor-default":!s,"select-text":s,"text-muted-foreground":!a&&!s}),style:{textAlign:(k=e.styles)==null?void 0:k.textAlign,fontSize:c==="json"?`${Q.FONT_SIZE_XXS}px`:Z.text.fontSize,lineHeight:c==="json"?"1.4":"1.5"},readOnly:!s})]})},Ke=e=>is(Rt,e),cf=[],df=({node:e,preventEdit:t})=>{const n=B(S=>S.updateNode),s=B(S=>{var y;return((y=S.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??cf}),r=Ke(S=>S.definitions),a=Ke(S=>S.createInstance),i=Ke(S=>S.executeInstance),l=Ke(S=>S.isExecuting),c=v.useMemo(()=>!!s.some(S=>S.id===e.id),[s,e.id]),d=e.data||{},{definitionId:u,instanceId:h,lastExecutionStatus:f="idle"}=d,g=v.useMemo(()=>r.find(S=>S.id===u),[r,u]),x=v.useCallback(S=>{const y=a(S,`${(g==null?void 0:g.name)||"Workflow"} Instance`);n(e.id,{data:{...d,definitionId:S,instanceId:y.id,lastExecutionStatus:"idle"},title:(g==null?void 0:g.name)||"Workflow"})},[e.id,d,n,a,g]),p=v.useCallback(async()=>{if(!h){console.warn("No instance selected");return}try{n(e.id,{data:{...d,lastExecutionStatus:"running"}});const S=await i(h);n(e.id,{data:{...d,lastExecutionStatus:S.success?"completed":"failed"}})}catch{n(e.id,{data:{...d,lastExecutionStatus:"failed"}})}},[h,d,e.id,n,i]),m=v.useMemo(()=>{switch(f){case"running":return o.jsx(as,{className:"h-4 w-4 animate-spin text-blue-500"});case"completed":return o.jsx(Ui,{className:"h-4 w-4 text-green-500"});case"failed":return o.jsx(Vi,{className:"h-4 w-4 text-red-500"});default:return o.jsx(mn,{className:"h-4 w-4 text-gray-400"})}},[f]),w=v.useMemo(()=>{switch(f){case"running":return"border-blue-500";case"completed":return"border-green-500";case"failed":return"border-red-500";default:return"border-border"}},[f]);return o.jsxs("div",{className:ve("workflow-definition-node w-full h-full p-3 bg-background border-2 rounded flex flex-col gap-2",w,{"ring-2 ring-primary":c}),children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(mn,{className:"h-5 w-5 text-primary"}),o.jsx("span",{className:"text-sm font-semibold",children:"Workflow"})]}),m]}),o.jsxs(es,{value:u||"",onValueChange:x,disabled:t,children:[o.jsx(ts,{className:"w-full h-8 text-xs",children:o.jsx(ns,{placeholder:"Select workflow..."})}),o.jsx(ss,{children:r.length===0?o.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"No workflows available"}):r.map(S=>o.jsx(os,{value:S.id,className:"text-xs",children:S.name},S.id))})]}),u&&o.jsx("div",{className:"flex gap-1",children:o.jsxs(Y,{size:"sm",variant:"default",className:"flex-1 h-7 text-xs",onClick:p,disabled:!u||l||t,children:[o.jsx(Ut,{className:"h-3 w-3 mr-1"}),"Execute"]})}),g&&c&&o.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[o.jsxs("div",{children:["Nodes: ",g.nodes.length]}),o.jsxs("div",{children:["Connections: ",g.connections.length]}),g.tags&&g.tags.length>0&&o.jsx("div",{className:"flex gap-1 flex-wrap",children:g.tags.map(S=>o.jsx("span",{className:"px-1 py-0.5 bg-primary/10 text-primary rounded text-[10px]",children:S},S))})]})]})},uf=({node:e})=>{const t=B(b=>b.updateNode),n=v.useRef(null),s=v.useRef(null),[r,a]=v.useState(!1),i=v.useRef(null),c=B(b=>{const T=b.projectCanvas.getActive();return(T==null?void 0:T.coreState.selectedNodes)??[]}).some(b=>b.id===e.id),d=B(b=>{const T=b.projectCanvas.getActive();return(T==null?void 0:T.coreState.nodes)??[]}),u=e.data||{},[h,f]=v.useState(u.image||null),{result:g,isProcessing:x,error:p,processBlob:m,cancel:w,reset:S}=wl();v.useEffect(()=>{s.current&&c&&s.current.focus()},[c]),v.useEffect(()=>{if(!c)return;const b=async T=>{var D;T.preventDefault(),T.stopPropagation();const E=(D=T.clipboardData)==null?void 0:D.items;if(E){for(const O of E)if(O.type.startsWith("image/")){const M=O.getAsFile();if(M){const $=new FileReader;$.onload=()=>{const P=$.result;f(P),S(),t(e.id,{data:{...u,image:P}})},$.readAsDataURL(M)}break}}};return document.addEventListener("paste",b),()=>{document.removeEventListener("paste",b)}},[c,e.id,u,t,S]),v.useEffect(()=>{if(!g)return;const b=g.timestamp.toISOString();if(i.current===b)return;const T=g.extractedText||"[No text detected in image]",E={image:h||void 0,extractedText:g.extractedText,detectedLanguage:g.detectedLanguage,confidence:g.confidence,processingTime:g.processingTime,timestamp:g.timestamp.toISOString()};t(e.id,{data:E,content:g.extractedText});const D=Ie.buildTextNodeV2({content:T});co(D,e,"right",{shouldFocus:!1}),i.current=b},[g,h,e.id,e,t,d.length]);const y=v.useCallback(async b=>{var E;const T=(E=b.target.files)==null?void 0:E[0];if(T&&T.type.startsWith("image/")){const D=new FileReader;D.onload=()=>{const O=D.result;f(O),S(),t(e.id,{data:{...u,image:O}})},D.readAsDataURL(T)}},[S,e.id,u,t]),j=v.useCallback(async()=>{if(!h)return;const T=await(await fetch(h)).blob();await m(T)},[h,m]),N=v.useCallback(async()=>{if(!h)return;const T=await(await fetch(h)).blob();await m(T,{downscale:!0,downscaleFactor:.5})},[h,m]),C=v.useCallback(()=>{w()},[w]),I=v.useCallback(()=>{f(null),S(),n.current&&(n.current.value=""),t(e.id,{data:{},content:""})},[S,e.id,t]),R=v.useCallback(async()=>{const b=(g==null?void 0:g.extractedText)||u.extractedText;if(b)try{await navigator.clipboard.writeText(b),a(!0),setTimeout(()=>a(!1),2e3)}catch(T){console.error("Failed to copy:",T)}},[g,u]),A=v.useCallback(b=>{var E;b.preventDefault(),b.stopPropagation();const T=(E=b.clipboardData)==null?void 0:E.items;if(T){for(const D of T)if(D.type.startsWith("image/")){const O=D.getAsFile();if(O){const M=new FileReader;M.onload=()=>{const $=M.result;f($),S(),t(e.id,{data:{...u,image:$}})},M.readAsDataURL(O)}break}}},[e.id,u,S,t]),k=g||(u.extractedText?{extractedText:u.extractedText,detectedLanguage:u.detectedLanguage,confidence:u.confidence,processingTime:u.processingTime}:null);return o.jsxs("div",{className:"canvas-ocr-node w-full h-full p-4 flex flex-col gap-3 overflow-auto",children:[o.jsxs("div",{className:"ocr-header flex items-center justify-between pb-2 border-b border-border",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(On,{className:"h-4 w-4 text-primary"}),o.jsx("h3",{className:"text-sm font-semibold",children:"OCR Node"})]}),h&&o.jsx(Y,{"data-test":"ocr-clear-button",variant:"ghost",size:"sm",onClick:I,className:"h-6 px-2",children:o.jsx(qe,{className:"h-3 w-3"})})]}),o.jsx("div",{ref:s,className:"image-input-area border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onPaste:A,tabIndex:0,role:"button","aria-label":"Paste image area",children:h?o.jsxs("div",{className:"image-preview-container space-y-2",children:[o.jsx("img",{src:h,alt:"OCR preview",className:"image-preview max-w-full max-h-32 mx-auto rounded-lg shadow-sm"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for OCR"})]}):o.jsxs("div",{className:"empty-state space-y-2",children:[o.jsx(vn,{className:"w-6 h-6 mx-auto text-muted-foreground"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Paste image (Ctrl+V) or upload"})]})}),o.jsxs("div",{className:"upload-controls",children:[o.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:y,className:"hidden"}),o.jsxs(Y,{"data-test":"ocr-upload-button",variant:"outline",size:"sm",onClick:()=>{var b;return(b=n.current)==null?void 0:b.click()},className:"w-full",children:[o.jsx(vn,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]}),p&&!x&&o.jsxs(vl,{variant:"destructive",children:[o.jsx(Yn,{className:"h-4 w-4"}),o.jsx(Sl,{className:"text-xs",children:p})]}),o.jsx("div",{className:"ocr-controls flex flex-col gap-2",children:x?o.jsxs(Y,{"data-test":"ocr-cancel-button",variant:"destructive",onClick:C,className:"w-full",size:"sm",children:[o.jsx(as,{className:"w-3 h-3 mr-2 animate-spin"}),"Cancel"]}):o.jsxs(o.Fragment,{children:[o.jsxs(Y,{"data-test":"ocr-extract-button",onClick:j,disabled:!h,className:"w-full",size:"sm",children:[o.jsx(On,{className:"w-3 h-3 mr-2"}),"Extract Text"]}),o.jsxs(Y,{"data-test":"ocr-extract-downscale-button",onClick:N,disabled:!h,variant:"outline",className:"w-full",size:"sm",children:[o.jsx(On,{className:"w-3 h-3 mr-2"}),"Downscale and Extract"]})]})}),k&&o.jsxs("div",{className:"ocr-results space-y-2 flex-1 flex flex-col",children:[o.jsxs("div",{className:"results-header flex items-center justify-between",children:[o.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[o.jsx(Fs,{className:"w-3 h-3 text-green-600"}),o.jsx("span",{children:"Extracted"})]}),o.jsx(Y,{"data-test":"ocr-copy-result-button",variant:"ghost",size:"sm",onClick:R,className:"h-6 px-2",children:r?o.jsxs(o.Fragment,{children:[o.jsx(Fs,{className:"w-3 h-3 mr-1 text-green-600"}),o.jsx("span",{className:"text-xs",children:"Copied!"})]}):o.jsxs(o.Fragment,{children:[o.jsx(Gt,{className:"w-3 h-3 mr-1"}),o.jsx("span",{className:"text-xs",children:"Copy"})]})})]}),(k.detectedLanguage||k.confidence||k.processingTime)&&o.jsxs("div",{className:"results-metadata text-xs text-muted-foreground space-y-1",children:[k.detectedLanguage&&o.jsxs("div",{children:["Language: ",k.detectedLanguage]}),k.confidence&&o.jsxs("div",{children:["Confidence: ",k.confidence]}),k.processingTime&&o.jsxs("div",{children:["Time: ",k.processingTime,"ms"]})]}),o.jsx("div",{className:"results-text flex-1 p-3 bg-muted rounded-lg font-mono text-xs whitespace-pre-wrap break-words overflow-y-auto",children:k.extractedText})]})]})},Is=1/3;function Rs(e,t){return new Promise(n=>{const s=new Image;s.onload=()=>{const r=Math.round(s.naturalWidth*t),a=Math.round(s.naturalHeight*t),i=document.createElement("canvas");i.width=r,i.height=a;const l=i.getContext("2d");if(!l){n({dataUrl:e,size:{width:s.naturalWidth,height:s.naturalHeight}});return}l.drawImage(s,0,0,r,a);const c=i.toDataURL("image/jpeg",.85);n({dataUrl:c,size:{width:r,height:a}})},s.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},s.src=e})}const gf=({node:e})=>{const t=B(h=>h.updateNode),n=v.useRef(null),s=v.useRef(null),a=B(h=>{const f=h.projectCanvas.getActive();return(f==null?void 0:f.coreState.selectedNodes)??[]}).some(h=>h.id===e.id),i=e.data||{},[l,c]=v.useState(i.image||null);v.useEffect(()=>{s.current&&a&&s.current.focus()},[a]),v.useEffect(()=>{if(!a)return;const h=async f=>{var x;f.preventDefault(),f.stopPropagation();const g=(x=f.clipboardData)==null?void 0:x.items;if(g){for(const p of g)if(p.type.startsWith("image/")){const m=p.getAsFile();if(m){Math.round(m.size/1024);const w=new FileReader;w.onload=async()=>{let S=w.result,y;{const N=await Rs(S,Is);S=N.dataUrl,y=N.size}c(S);const j=Math.round(S.length*3/4/1024);t(e.id,{data:{...i,imageSize:y,fileSizeKB:j,image:S}})},w.readAsDataURL(m)}break}}};return document.addEventListener("paste",h),()=>{document.removeEventListener("paste",h)}},[a,e.id,i,t]);const d=v.useCallback(async h=>{var g;const f=(g=h.target.files)==null?void 0:g[0];if(f&&f.type.startsWith("image/")){Math.round(f.size/1024);const x=new FileReader;x.onload=async()=>{let p=x.result,m;{const S=await Rs(p,Is);p=S.dataUrl,m=S.size}c(p);const w=Math.round(p.length*3/4/1024);t(e.id,{data:{...i,imageSize:m,fileSizeKB:w,image:p}})},x.readAsDataURL(f)}},[e.id,i,t]),u=v.useCallback(h=>{var g;h.preventDefault(),h.stopPropagation();const f=(g=h.clipboardData)==null?void 0:g.items;if(f){for(const x of f)if(x.type.startsWith("image/")){const p=x.getAsFile();if(p){Math.round(p.size/1024);const m=new FileReader;m.onload=async()=>{let w=m.result,S;{const j=await Rs(w,Is);w=j.dataUrl,S=j.size}c(w);const y=Math.round(w.length*3/4/1024);t(e.id,{data:{...i,imageSize:S,fileSizeKB:y,image:w}})},m.readAsDataURL(p)}break}}},[e.id,i,t]);return o.jsx("div",{ref:s,className:"canvas-image-node w-full h-full overflow-hidden",onPaste:u,tabIndex:0,role:"button","aria-label":"Paste image area","data-test":"canvas-image-node",children:l?o.jsx("img",{src:l,alt:"Image",className:"w-full h-full object-contain pointer-events-none select-none",draggable:!1,"data-test":"image-preview"}):o.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center gap-3 border-2 border-dashed rounded-lg hover:border-primary transition-colors","data-test":"image-empty-state",children:[o.jsx(vn,{className:"w-8 h-8 text-muted-foreground"}),o.jsx("p",{className:"text-sm text-muted-foreground",children:"Paste image (Ctrl+V) or upload"}),o.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:d,className:"hidden","data-test":"image-file-input"}),o.jsxs(Y,{"data-test":"image-upload-button",variant:"outline",size:"sm",onClick:()=>{var h;return(h=n.current)==null?void 0:h.click()},children:[o.jsx(vn,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]})})},{DEFAULT_NODE_WIDTH:ff,DEFAULT_NODE_HEIGHT:hf}=Q,pf=[],mf=({node:e,isSelected:t,selectedNodesCount:n,useSimplifiedRendering:s=!1})=>{var C;const r=v.useRef({}),[a,i]=v.useState(!1),l=B(I=>I.uiState.mode),c=B(I=>{var R;return((R=I.projectCanvas.getActive())==null?void 0:R.coreState.selectedNodes)??pf}),d=B(I=>{var R;return((R=I.projectCanvas.getActive())==null?void 0:R.viewState.scale)??1}),u=B(I=>!!I.uiState.dragInfo),h=B(I=>!!I.uiState.resizingNode);r.current={mode:l,selectedNodes:c,scale:d};const f=n??c.length,g=c.some(I=>I.id===e.id),x=t&&f===1,p=c.length>0&&((C=c[c.length-1])==null?void 0:C.id)===e.id,{handleMouseDown:m,initialClickPoint:w}=Nu({node:e,mode:l,isPopoverOpen:a,setIsPopoverOpen:i}),S=v.useCallback(I=>{const R={x:I.clientX,y:I.clientY};if(!za(w.current,R))return;const k=!e.isEditing&&p;return i(k),k},[e,x,g,p,c.length,a]);v.useEffect(()=>{if(!g){i(!1);return}if(e.isEditing){i(!1);return}u||h||(p?i(!0):g&&!p&&i(!1))},[c,e.isEditing,g,x,p,e.id,u,h]),v.useEffect(()=>{(u||h)&&i(!1)},[u,h]);const y=()=>{if(s){const{jsx:k}=qg({node:e,isSelected:t,scale:d});return k}const I=e.data,R=(I==null?void 0:I.nodeType)==="workflowOrchestration",A=(I==null?void 0:I.nodeType)==="workflowSource";if(R)return o.jsx(dr,{node:e});if(A)return o.jsx(ur,{node:e,preventEdit:!g});switch(e.type){case ie.RECT:return o.jsx(hd,{node:e});case ie.TEXT:return o.jsx(Rd,{node:e});case ie.TABLE:return o.jsx(Rg,{node:e});case ie.TEXTCARD:return o.jsx(Ag,{node:e});case ie.WORKFLOW_ORCHESTRATION:return o.jsx(dr,{node:e});case ie.WORKFLOW_SOURCE:return o.jsx(ur,{node:e,preventEdit:!g});case ie.WORKFLOW_DEFINITION:return o.jsx(df,{node:e,preventEdit:!g});case ie.OCR:return o.jsx(uf,{node:e});case ie.IMAGE:return o.jsx(gf,{node:e});default:return o.jsx("div",{children:"Unknown Node Type"})}},j=Z.getSelectionRingClass(t),N=e.styles;return o.jsx(fu,{node:e,isOpen:a,children:o.jsxs("div",{id:`NodeContainerV2-${e.id}`,className:ve("node-container-main","absolute group","cursor-grab","select-none","rounded","overflow-visible",t&&j),style:{left:`${e.x}px`,top:`${e.y}px`,width:e.isCollapsed?"auto":`${e.width??ff}px`,height:e.isCollapsed?"0px":`${e.height??hf}px`,minWidth:e.isCollapsed?"100px":void 0,transformOrigin:"0 0",border:e.isCollapsed?"none":N==null?void 0:N.border,borderWidth:e.isCollapsed||N==null?void 0:N.borderWidth,borderColor:e.isCollapsed||N==null?void 0:N.borderColor,borderStyle:e.isCollapsed?void 0:N!=null&&N.borderWidth?(N==null?void 0:N.borderStyle)||"solid":N==null?void 0:N.borderStyle,willChange:"transform",backfaceVisibility:"hidden"},onPointerDown:m,onPointerUp:S,"data-node-id":e.id,children:[o.jsx(_g,{node:e,isSingleNodeSelected:x,isCollapsed:e.isCollapsed}),!e.isCollapsed&&o.jsx(Kg,{node:e}),e.isPinned&&o.jsx("div",{className:"pin-indicator-border absolute pointer-events-none rounded border-[3px] border-primary",style:{top:"-6px",left:"-6px",right:"-6px",bottom:"-6px",zIndex:1e3}}),(()=>{var b;const I=e.data,R=I==null?void 0:I.nodeType,A=I==null?void 0:I.executionState,k=(b=I==null?void 0:I.executionData)==null?void 0:b.duration;return R&&A?o.jsx(Jg,{executionState:A,duration:k}):null})(),x&&o.jsxs("div",{className:ve("node-actions-sidebar absolute","gap-1","items-center"),style:{left:-50},children:[o.jsx("div",{className:"pin-button-wrapper",children:o.jsx(Mg,{node:e})}),o.jsx("div",{className:"text-editor-button-wrapper",children:e.subContent?o.jsx(Xr,{className:"my-2"}):null}),o.jsx("div",{className:"tag-selector-wrapper",children:o.jsx(Tg,{nodeId:e.id,tags:e.tags})})]}),!e.isCollapsed&&o.jsxs("section",{className:"node-content-section h-[100%] overflow-visible",children:[o.jsx("div",{id:`node-content-${e.id}`,className:ve("node-content-inner relative w-full h-full overflow-visible","flex",{}),children:y()}),(()=>{var k;const I=e.data,R=(I==null?void 0:I.nodeType)==="manualTrigger",A=(k=I==null?void 0:I.parameters)==null?void 0:k.label;return R?o.jsx("div",{className:"manual-trigger-button-container absolute bottom-2 left-2 right-2 px-2",children:o.jsx(ga,{nodeId:e.id,label:A})}):null})(),o.jsxs(o.Fragment,{children:[o.jsx(vu,{node:e,isSelected:x,mode:l}),o.jsx(yu,{node:e,isSelected:x,mode:l})]})]})]})})};function xf(e,t){if(e.node===t.node&&e.isSelected===t.isSelected&&e.selectedNodesCount===t.selectedNodesCount&&e.useSimplifiedRendering===t.useSimplifiedRendering)return!0;const n=e.node.x===t.node.x,s=e.node.y===t.node.y,r=n&&s,a=e.node.width===t.node.width,i=e.node.height===t.node.height,l=a&&i,c=e.isSelected===t.isSelected,d=e.node.content===t.node.content,u=e.node.title===t.node.title,h=e.node.type===t.node.type,f=e.node.isEditing===t.node.isEditing,g=e.node.styles===t.node.styles,x=e.node.tags,p=t.node.tags,m=Array.isArray(x),w=Array.isArray(p),S=x===p||!m&&!w||m&&w&&x.length===p.length&&x.every((R,A)=>R===p[A]),y=e.node.isPinned===t.node.isPinned,j=e.node.isCollapsed===t.node.isCollapsed,N=e.selectedNodesCount===t.selectedNodesCount,C=e.useSimplifiedRendering===t.useSimplifiedRendering;return!!(r&&l&&c&&d&&u&&h&&f&&g&&S&&y&&j&&N&&C)}const Js=Be.memo(({node:e,isSelected:t,selectedNodesCount:n,useSimplifiedRendering:s})=>o.jsx(mf,{node:e,isSelected:t,selectedNodesCount:n,useSimplifiedRendering:s}),xf),wf=e=>{const{className:t,style:n}=e,s=B(d=>d.uiState.mode),r=B(d=>d.uiState.zoomSubMode),a=B(d=>d.uiState.writeSubMode),[i,l]=v.useState(null);v.useEffect(()=>{if(s!==W.VIM){l(null);return}const d=()=>{const h=window.__vimContainer;if(!h)return null;try{const f=h.get(Pr),g=f==null?void 0:f.getVimCore(ot.canvasVim),x=g==null?void 0:g.getVimState();return(x==null?void 0:x.mode)??null}catch{return null}};l(d());const u=setInterval(()=>{l(d())},100);return()=>clearInterval(u)},[s]);let c=s;return s===W.ZOOM&&r==="zoom:lock"?c="zoom:lock":s===W.WRITE&&a===At.AUDIO?c="write:audio":s===W.VIM&&i&&(c=`vim: ${i.charAt(0)+i.slice(1).toLowerCase()}`),o.jsxs("div",{className:`text-xs p-1 bg-background/50 rounded pointer-events-auto ${t}`,style:{...n},"data-test":"canvas-mode-info",children:["Mode: ",c||"N/A"]})},vf=e=>{const{className:t,style:n}=e,[s,r]=v.useState(1),[a,i]=v.useState([]);v.useEffect(()=>{const m=_.subscribe(y=>{const j=y.projectCanvas.getActive();j&&r(j.viewState.scale),i(y.uiState.zoomMarks||[])}),w=_.getState(),S=w.projectCanvas.getActive();return S&&r(S.viewState.scale),i(w.uiState.zoomMarks||[]),m},[]);const l=m=>{const w=m[0],S=_.getState(),y=S.projectCanvas.getActive();if(!y)return;const{scale:j,offset:N}=y.viewState,C=document.getElementById("CanvasAppV2");if(!C)return;const I=C.getBoundingClientRect(),R={x:I.width/2,y:I.height/2},A=Qe(R,j,N),k=R.x-A.x*w,b=R.y-A.y*w,T=isNaN(k)?0:k,E=isNaN(b)?0:b,D=isNaN(w)?1:w;S.setActiveCanvasViewState(O=>({...O,scale:D,offset:{x:T,y:E}}))},{min:c,max:d,marks:u}=Z.zoom,h=Math.round(s*100),f=Array.from(new Set([...u,...a])).sort((m,w)=>m-w),g=()=>{const m=Math.round(s*100)/100;_.getState().addZoomMark(m)},x=m=>{_.getState().removeZoomMark(m)},p=m=>a.includes(m);return o.jsxs("div",{"data-ui-panel":"zoom-slider","data-test":"canvas-zoom-slider",className:`flex flex-col gap-2 p-2 bg-background/50 rounded pointer-events-auto min-w-[200px] ${t}`,style:{...n},children:[o.jsxs("div",{className:"flex items-center justify-between text-xs",children:[o.jsx("span",{children:"Zoom"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsxs("span",{className:"font-mono",children:[h,"%"]}),o.jsx(Y,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:g,title:"Save current zoom level","data-test":"canvas-zoom-save-button",children:o.jsx(Tt,{className:"h-3 w-3"})})]})]}),o.jsxs("div",{className:"relative",children:[o.jsx(Wa,{value:[s],onValueChange:l,min:c,max:d,step:.01,className:"cursor-pointer","data-test":"canvas-zoom-slider"}),o.jsx("div",{className:"relative h-4 mt-1 px-3",children:f.map(m=>{const w=(m-c)/(d-c)*100,S=p(m);return o.jsxs("div",{className:"absolute flex flex-col items-center group",style:{left:`${w}%`,transform:"translateX(-50%)"},children:[o.jsxs("div",{className:"cursor-pointer hover:opacity-70 transition-opacity flex flex-col items-center",onClick:()=>l([m]),title:`Zoom to ${Math.round(m*100)}%`,children:[o.jsx("div",{className:`w-px h-2 ${S?"bg-primary/60":"bg-muted-foreground/40"}`}),o.jsx("span",{className:`text-[10px] mt-0.5 ${S?"text-primary":"text-muted-foreground"}`,children:m===1?"1Ã—":`${m}Ã—`})]}),S&&o.jsx("button",{className:"opacity-0 group-hover:opacity-100 absolute -top-2 right-0 h-3 w-3 rounded-full bg-destructive/80 hover:bg-destructive flex items-center justify-center transition-opacity",onClick:y=>{y.stopPropagation(),x(m)},title:"Remove mark","data-test":"canvas-zoom-remove-mark-button",children:o.jsx(qe,{className:"h-2 w-2 text-destructive-foreground"})})]},m)})})]})]})},As=({position:e,onMouseDown:t,onDoubleClick:n,variant:s="end",size:r=4,className:a})=>o.jsx("circle",{"data-test":`arrow-handle-${s}`,cx:e.x,cy:e.y,r,fill:"hsl(var(--primary))",stroke:"hsl(var(--primary-foreground))",strokeWidth:1,onPointerDown:t,onDoubleClick:n,className:ve("cursor-move",a),style:{pointerEvents:"all",touchAction:"none"}}),gr=Z.arrows.REVERSE_CURVE,Sf=(e,t)=>{const n=(e.x+t.x)/2,s=(e.y+t.y)/2,r=t.x-e.x,a=t.y-e.y,i=Math.sqrt(r*r+a*a);if(i===0)return{path:`M ${e.x} ${e.y}`,controlPoint:e};const l=-a/i,c=r/i;let d=i*.2;(!gr&&e.x<t.x||gr&&e.x>t.x)&&(d=-d);const u=n+l*d,h=s+c*d,f={x:u,y:h};return{path:`M ${e.x} ${e.y} Q ${u} ${h}, ${t.x} ${t.y}`,controlPoint:f}},yf=(e,t,n)=>{let s=t.x-e.x;const r=t.y-e.y,a=Math.sqrt(s*s+r*r),i=Math.max(20,a*.15);if(a===0)return{x:0,y:i};let l=-r,c=s;n||(s=-s),s<0&&(l=-l,c=-c);const d=l/a,u=c/a;return{x:d*i,y:u*i}},Nf=(e,t,n)=>{is(_,x=>{var p,m;return(m=(p=x.preferences)==null?void 0:p.canvasConfig)==null?void 0:m.arrows});const s=e.type??Z.arrows.type,r=Z.arrows.REVERSE_CURVE,a=Z.arrows.CUBIC_HORIZONTAL_BIAS,i=-10,l=s==="TreeCubic"||s==="TreeLStep"||s==="TreeZShape",c=v.useMemo(()=>{const x=t.find(S=>S.id===e.startNodeId),p=t.find(S=>S.id===e.endNodeId);if(l&&x&&p){const S=_e(x);return Zn(e.endNodeId,e.endPoint,S,t,i)}if((s==="Cubic"||s==="Orthogonal")&&x&&p){const S=_e(x);return Wt(e.endNodeId,e.endPoint,S,t,i,a)}if(s==="Step"&&x&&p){const S=_e(x),y=_e(p),j=y.x-S.x,N=y.y-S.y,I=Math.abs(j)*a>=Math.abs(N)?.001:1e3;return Wt(e.endNodeId,e.endPoint,S,t,i,I)}const m=x?Ge(e.startNodeId,e.startPoint,e.endPoint,t,e.startRowId):e.startPoint;return p?Ge(e.endNodeId,e.endPoint,m,t,e.endRowId):e.endPoint},[t,e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,s,a]),d=v.useMemo(()=>{const x=t.find(w=>w.id===e.startNodeId),p=t.find(w=>w.id===e.endNodeId);if(s==="TreeLStep"&&x)return Fr(e.startNodeId,e.startPoint,t);if((s==="TreeCubic"||s==="TreeZShape")&&x&&p){const w=_e(p);return Zn(e.startNodeId,e.startPoint,w,t,0)}if((s==="Cubic"||s==="Step"||s==="Orthogonal")&&x&&p){const w=_e(p);return Wt(e.startNodeId,e.startPoint,w,t,0,a)}const m=p?Ge(e.endNodeId,e.endPoint,e.startPoint,t,e.endRowId):e.endPoint;return x?Ge(e.startNodeId,e.startPoint,m,t,e.startRowId):e.startPoint},[t,e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,s,a]),u=v.useMemo(()=>{const x=(d.x+c.x)/2,p=(d.y+c.y)/2;if(e.controlPointOffset)return{x:x+e.controlPointOffset.x,y:p+e.controlPointOffset.y};{const m=yf(d,c,r),w=c.x-d.x,S=c.y-d.y,y=w>0?x-m.x:x+m.x,j=S<0?p-m.y:p+m.y;return{x:y,y:j}}},[e.controlPointOffset,d,c,n,r]),h=v.useMemo(()=>{if(s!=="Cubic"&&s!=="TreeCubic")return null;const x=t.find(S=>S.id===e.startNodeId),p=t.find(S=>S.id===e.endNodeId);let m="horizontal",w;if(x&&p){const S=_e(x),y=_e(p),j=y.x-S.x,N=y.y-S.y;s==="TreeCubic"?m="horizontal":m=Math.abs(j)*a>=Math.abs(N)?"horizontal":"vertical",w={dx:j,dy:N}}return cc(d,c,m,w)},[d,c,s,t,e.startNodeId,e.endNodeId,a]),{path:f}=v.useMemo(()=>Sf(d,c),[d,c,n]),g=v.useMemo(()=>{if(!(s==="Step"||s==="Orthogonal"||s==="TreeLStep"||s==="TreeZShape"))return null;if(s==="TreeLStep")return[d,{x:d.x,y:c.y},c];if(s==="TreeZShape"){const S=(d.x+c.x)/2;return[d,{x:S,y:d.y},{x:S,y:c.y},c]}const p=t.find(S=>S.id===e.startNodeId),m=t.find(S=>S.id===e.endNodeId);let w=!0;if(p&&m){const S=_e(p),y=_e(m),j=y.x-S.x,N=y.y-S.y;w=Math.abs(j)*a>=Math.abs(N)}if(s==="Step")return w?[d,{x:c.x,y:d.y},c]:[d,{x:d.x,y:c.y},c];{const S=(d.x+c.x)/2,y=(d.y+c.y)/2;return w?[d,{x:S,y:d.y},{x:S,y:c.y},c]:[d,{x:d.x,y},{x:c.x,y},c]}},[d,c,s,t,e.startNodeId,e.endNodeId,a]);return{actualStartPoint:d,actualEndPoint:c,bezierPath:f,controlPoint:u,cubicControlPoints:h,stepPoints:g,arrowType:s}},Cf=(e,t,n,s,r)=>{const a=_.getState();a.scrollToArrow;const i=a.uiState.mode,l=a.projectCanvas.getActive(),c=(l==null?void 0:l.viewState.scale)??1,d=(l==null?void 0:l.coreState.nodes)??[],u=a.arrow.setAll,h=a.arrow.setSelected,f=a.setSelectedNodes,[g,x]=v.useState(null),[p,m]=v.useState(null),[w,S]=v.useState(null),y=v.useRef(null),j=v.useCallback((N,C)=>{i!==W.SELECT||N.button!==0&&N.button!==-1||(N.stopPropagation(),x(C),m({x:N.clientX,y:N.clientY}),S({...e,startPoint:t,endPoint:n,controlPointOffset:s}),y.current=C==="start"?t:C==="end"?n:s,r||(f([]),h([e])))},[i,e,t,n,s,r,h,f]);return v.useEffect(()=>{const N=I=>{var $;if(!g||!p||!w)return;const R=I.clientX-p.x,A=I.clientY-p.y,k=R/c,b=A/c,T=g==="start"?w.startPoint:g==="end"?w.endPoint:w.controlPointOffset;let E={x:T.x+k,y:T.y+b};const D=Jn(I.clientX,I.clientY);let O=null,M=null;if(D){O=D.nodeId,M=D.rowId;const P=g==="start"?w.endPoint:g==="end"?w.startPoint:w.controlPointOffset;E=Ge(O,E,P,d,M)}else{const P=Vn(E,d);if(P&&!((($=P.data)==null?void 0:$.nodeType)==="workflowOrchestration")){O=P.id;const U=g==="start"?w.endPoint:g==="end"?w.startPoint:w.controlPointOffset;E=Ge(O,E,U,d)}}y.current=E,u(P=>P.map(F=>{if(F.id===w.id){const U={...F};if(g==="start")U.startPoint=E,U.startNodeId=O,U.startRowId=M;else if(g==="end")U.endPoint=E,U.endNodeId=O,U.endRowId=M;else if(g==="control"){const L=F.startNodeId?Ge(F.startNodeId,F.startPoint,F.endPoint,d,F.startRowId):F.startPoint,G=F.endNodeId?Ge(F.endNodeId,F.endPoint,F.startPoint,d,F.endRowId):F.endPoint,q=(L.x+G.x)/2,ee=(L.y+G.y)/2,oe={x:E.x-q,y:E.y-ee};U.controlPointOffset=oe}return U}return F}))},C=I=>{var A;if(!g||!w)return;const R=y.current;if(R){const k=Jn(I.clientX,I.clientY);let b=null,T=null;const E=g==="start"?w.endPoint:g==="end"?w.startPoint:w.controlPointOffset;let D;if(k)b=k.nodeId,T=k.rowId,D=Ge(b,R,E,d,T);else{const O=Vn(R,d);O?((A=O.data)==null?void 0:A.nodeType)==="workflowOrchestration"?D=R:(b=O.id,D=Ge(b,R,E,d)):D=R}u(O=>O.map(M=>{if(M.id===w.id){const $={...M};return g==="start"?($.startPoint=D,$.startNodeId=b,$.startRowId=T):g==="end"&&($.endPoint=D,$.endNodeId=b,$.endRowId=T),$}return M}))}x(null),m(null),S(null),y.current=null};return g&&(window.addEventListener("pointermove",N),window.addEventListener("pointerup",C)),()=>{window.removeEventListener("pointermove",N),window.removeEventListener("pointerup",C)}},[g,p,w,c,u,d]),{handleMouseDownOnHandle:j}},bf=(e,t,n)=>`M ${e.x} ${e.y} Q ${t.x} ${t.y} ${n.x} ${n.y}`,jf=(e,t,n,s)=>`M ${e.x} ${e.y} C ${t.x} ${t.y} ${n.x} ${n.y} ${s.x} ${s.y}`,kf=e=>{if(e.length<2)return"";const[t,...n]=e;return`M ${t.x} ${t.y} `+n.map(s=>`L ${s.x} ${s.y}`).join(" ")},Qs=({startPoint:e,endPoint:t,controlPoint:n,cubicControlPoints:s,stepPoints:r,useCurvedArrows:a,stroke:i,strokeWidth:l,markerEndId:c,strokeDasharray:d,isHitbox:u=!1,onPointerDown:h})=>{const f={stroke:i,strokeWidth:l,fill:"none",strokeDasharray:d,markerEnd:!u&&c?`url(#${c})`:void 0,onPointerDown:h,style:{pointerEvents:"auto"}};if(r&&r.length>=2){const g=kf(r);return o.jsx("path",{d:g,...f})}if(a&&s&&s.length===2){const[g,x]=s,p=jf(e,g,x,t);return o.jsx("path",{d:p,...f})}if(a&&n){const g=bf(e,n,t);return o.jsx("path",{d:g,...f})}return o.jsx("line",{x1:e.x,y1:e.y,x2:t.x,y2:t.y,...f})},If=({isSelected:e,label:t,labelPosition:n,labelInput:s,setLabelInput:r,onLabelChange:a,onLabelBlur:i,onLabelKeyDown:l})=>{const c=Q.FONT_SIZE_XXS,d=6,u=4,h=c*.6,g=t.length*h+2*d,x=c+2*u;return e?o.jsx("foreignObject",{x:n.x-50,y:n.y-15,width:"100",height:"30",style:{pointerEvents:"auto"},children:o.jsx(dt,{"data-test":"arrow-label-input",type:"text",value:s,onChange:a,onBlur:i,onKeyDown:l,onMouseDown:p=>p.stopPropagation(),placeholder:"Label",className:"w-full h-full text-[12px]! text-center p-0.5 bg-background border border-border rounded-sm focus:ring-1 focus:ring-ring focus:outline-none"})}):t?o.jsxs(o.Fragment,{children:[o.jsx("rect",{x:n.x-g/2,y:n.y-x/2,width:g,height:x,fill:"hsl(var(--background))",rx:"3",ry:"3",style:{pointerEvents:"none"}}),o.jsx("text",{x:n.x,y:n.y,fill:"hsl(var(--foreground))",fontSize:c,textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:t})]}):null},Rf=({markerId:e,strokeColor:t,markerOrientation:n})=>o.jsx("defs",{children:o.jsx("marker",{id:e,markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:n,markerUnits:"strokeWidth",children:o.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:t})})}),Af=[],Ef=({arrow:e})=>{const t=B(F=>{var U,L;return((L=(U=F.projectCanvas.getActive())==null?void 0:U.coreState.selectedArrows)==null?void 0:L.some(G=>G.id===e.id))??!1}),n=B(F=>{var U;return((U=F.projectCanvas.getActive())==null?void 0:U.coreState.selectedArrows)??Af}),s=B(F=>F.uiState.mode),r=B(F=>F.arrow.setSelected),a=B(F=>F.setSelectedNodes),i=B(F=>{var U;return((U=F.projectCanvas.getActive())==null?void 0:U.coreState.nodes)??[]}),l=B(F=>F.arrow.update);B(F=>{var U,L;return(L=(U=F.preferences)==null?void 0:U.canvasConfig)==null?void 0:L.arrows});const{actualStartPoint:c,actualEndPoint:d,controlPoint:u,cubicControlPoints:h,stepPoints:f,arrowType:g}=Nf(e,i,!0),x=g!=="Straight",{handleMouseDownOnHandle:p}=Cf(e,c,d,u,t),m=F=>{if(s!==W.SELECT||F.button!==0&&F.button!==-1)return;if(F.stopPropagation(),F.ctrlKey||F.metaKey){r(t?n.filter(L=>L.id!==e.id):[...n,e]);return}if(F.shiftKey){t||r([...n,e]);return}a([]),r([e])},w=F=>{F.stopPropagation(),l(e.id,{controlPointOffset:null})},[S,y]=v.useState(e.label||"");v.useEffect(()=>{y(e.label||"")},[e.label]);const j=F=>{y(F.target.value),l(e.id,{label:F.target.value})},N=()=>{e.label!==S&&l(e.id,{label:S})},C=F=>{F.key==="Enter"&&F.currentTarget.blur(),F.stopPropagation()},I=0,R=v.useMemo(()=>{if(x&&u){const F=(c.x+d.x)/2,U=(c.y+d.y)/2;return{x:F-(u.x-F),y:U-(u.y-U)+I}}return{x:(c.x+d.x)/2,y:(c.y+d.y)/2+I}},[c,d,u,x]),A=e.strokeColor??Z.arrows.styles.line,k=t&&!e.strokeColor?Z.arrows.styles.lineSelected:A,b=e.strokeWidth??1,T=t?b+.5:b,D=(F=>{switch(F){case"dashed":return"8,4";case"dotted":return"2,4";default:return}})(e.strokeStyle),O=t&&s===W.SELECT,M=x?"auto-start-reverse":"auto",$=`arrowhead-${e.id}`,P=e.strokeColor??k;return o.jsxs("g",{"data-arrow-id":e.id,style:{cursor:s===W.SELECT?"pointer":"default"},children:[o.jsx(Rf,{markerId:$,strokeColor:P,markerOrientation:M}),o.jsx(Qs,{startPoint:c,endPoint:d,controlPoint:u,cubicControlPoints:h,stepPoints:f,useCurvedArrows:x,stroke:k,strokeWidth:T,strokeDasharray:D,markerEndId:$}),o.jsx(Qs,{startPoint:c,endPoint:d,controlPoint:u,cubicControlPoints:h,stepPoints:f,useCurvedArrows:x,stroke:"transparent",strokeWidth:15,isHitbox:!0,onPointerDown:m}),O&&o.jsxs(o.Fragment,{children:[o.jsx(As,{position:c,onMouseDown:F=>p(F,"start")}),o.jsx(As,{position:d,onMouseDown:F=>p(F,"end")}),x&&u&&o.jsx(As,{position:u,onMouseDown:F=>p(F,"control"),onDoubleClick:w,variant:"control"})]}),o.jsx(If,{isSelected:t,label:e.label||"",labelPosition:R,labelInput:S,setLabelInput:y,onLabelChange:j,onLabelBlur:N,onLabelKeyDown:C})]})};function Tf(e,t){const n=e.arrow,s=t.arrow,r=n.startPoint.x===s.startPoint.x&&n.startPoint.y===s.startPoint.y,a=n.endPoint.x===s.endPoint.x&&n.endPoint.y===s.endPoint.y,i=n.label===s.label,l=n.type===s.type,c=n.controlPointOffset==null&&s.controlPointOffset==null||n.controlPointOffset!=null&&s.controlPointOffset!=null&&n.controlPointOffset.x===s.controlPointOffset.x&&n.controlPointOffset.y===s.controlPointOffset.y,d=n.strokeColor===s.strokeColor,u=n.strokeWidth===s.strokeWidth,h=n.strokeStyle===s.strokeStyle;return r&&a&&i&&l&&c&&d&&u&&h}const ha=Be.memo(Ef,Tf),Mf=[{value:"solid",label:"Solid",dashArray:"none"},{value:"dashed",label:"Dashed",dashArray:"8,4"},{value:"dotted",label:"Dotted",dashArray:"2,4"}],Df=({currentColor:e,currentWidth:t,currentStyle:n,onColorSelect:s,onWidthChange:r,onStyleChange:a})=>{const[i,l]=v.useState(e),[c,d]=v.useState(t),[u,h]=v.useState(n);v.useEffect(()=>{l(e)},[e]),v.useEffect(()=>{d(t)},[t]),v.useEffect(()=>{h(n)},[n]);const f=p=>{l(p),s(p)},g=p=>{const m=parseFloat(p.target.value);!isNaN(m)&&m>=.5&&m<=10&&(d(m),r(m))},x=p=>{h(p),a(p)};return o.jsxs("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"arrow-style-picker-content",children:[o.jsxs("div",{"data-test":"arrow-style-color-section",children:[o.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Color"}),o.jsx("div",{className:"grid grid-cols-5 gap-2",children:qr.filter(p=>p.value!=="transparent").map(p=>o.jsx("button",{type:"button",title:p.name,onClick:()=>f(p.value),className:je("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1",p.twClass,p.value===i?"ring-2 ring-ring ring-offset-1":"border-muted",p.value==="#ffffff"&&"border-neutral-300"),style:p.value.startsWith("hsl(")?{backgroundColor:p.value}:{},"aria-label":`Select color ${p.name}`,"data-test":`arrow-color-${p.name.toLowerCase().replace(/\s+/g,"-")}`},p.value))}),o.jsx("input",{type:"color",value:i.startsWith("hsl")?Zr(i):i.startsWith("#")?i:"#000000",onChange:p=>f(p.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"arrow-color-custom-input"})]}),o.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-width-section",children:[o.jsxs("label",{htmlFor:"arrow-stroke-width-input",className:"block text-xs text-muted-foreground font-medium mb-1",children:["Stroke Width: ",c,"px"]}),o.jsx("input",{type:"range",id:"arrow-stroke-width-input",value:c,onChange:g,min:"0.5",max:"10",step:"0.5",className:"w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer","data-test":"arrow-stroke-width-input"})]}),o.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-style-section",children:[o.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Style"}),o.jsx("div",{className:"flex gap-2",children:Mf.map(p=>o.jsx("button",{type:"button",onClick:()=>x(p.value),className:je("flex-1 px-2 py-1.5 rounded border text-xs",u===p.value?"border-primary bg-primary/10":"border-muted hover:border-muted-foreground"),title:p.label,"data-test":`arrow-style-${p.value}`,children:o.jsx("svg",{width:"100%",height:"12",viewBox:"0 0 40 12",className:"stroke-current",children:o.jsx("line",{x1:"2",y1:"6",x2:"38",y2:"6",strokeWidth:"2",strokeDasharray:p.dashArray,fill:"none"})})},p.value))})]})]})},Pf=[],_f=({className:e})=>{const[t,n]=v.useState(!1),s=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.selectedArrows)??Pf}),r=B(N=>N.arrow.update),a=s.length>0?s[0]:null,[i,l]=v.useState((a==null?void 0:a.strokeColor)??"hsl(var(--muted-light))"),[c,d]=v.useState((a==null?void 0:a.strokeWidth)??1),[u,h]=v.useState((a==null?void 0:a.strokeStyle)??"solid"),f=_.getState().getLastUsedArrowStyle();v.useEffect(()=>{a?(l(a.strokeColor??"hsl(var(--muted-light))"),d(a.strokeWidth??1),h(a.strokeStyle??"solid")):(l("hsl(var(--muted-light))"),d(1),h("solid"))},[a]);const g=(N,C,I)=>{s.forEach(R=>{r(R.id,{strokeColor:N,strokeWidth:C,strokeStyle:I})})},x=()=>{g(f.lastUsedColor,f.lastUsedWidth,f.lastUsedStyle)},p=N=>{g(N,c,u),l(N),_.getState().setLastUsedArrowStyle(N,c,u),_.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},m=N=>{g(i,N,u),d(N),_.getState().setLastUsedArrowStyle(i,N,u),_.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},w=N=>{g(i,c,N),h(N),_.getState().setLastUsedArrowStyle(i,c,N),_.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},S=()=>{l("hsl(var(--muted-light))"),d(1),h("solid"),g(void 0,void 0,void 0)},y=[{label:"Apply last used style",icon:o.jsx("span",{style:{color:f.lastUsedColor,display:"inline-flex"},children:o.jsx(Ao,{className:"h-2.5 w-2.5"})}),onClick:x,disabled:s.length===0},{label:"Set Arrow Style",icon:o.jsx("span",{style:{color:i,display:"inline-flex"},children:o.jsx(Ar,{className:"h-2.5 w-2.5"})}),onClick:()=>{n(!0)},disabled:s.length===0},{label:"Reset Style",icon:o.jsx(Er,{className:"h-2.5 w-2.5"}),onClick:S,disabled:s.length===0}],j={...y[0],icon:o.jsx("span",{style:{color:i,display:"inline-flex"},children:o.jsx(Ao,{className:"h-2.5 w-2.5"})})};return o.jsxs(_t,{open:t,onOpenChange:n,children:[o.jsx(Ot,{asChild:!0,children:o.jsx("div",{style:{display:"inline-flex"},"data-test":"arrow-style-picker-button",children:o.jsx(tt,{mainAction:j,dropdownActions:y,variant:"outline",size:"compact",persistenceKey:"arrow-style-picker",className:e})})}),o.jsx($t,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"arrow-style-picker-popover",children:o.jsx(Df,{currentColor:i,currentWidth:c,currentStyle:u,onColorSelect:p,onWidthChange:m,onStyleChange:w})})]})},fr=[],Of=[],$f=()=>{const e=B(d=>d.setSelectedNodes),t=B(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??fr}),n=B(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedArrows)??Of});B(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.nodes)??fr});const s=t.length>0,r=v.useMemo(()=>{const d=new Set;return n.forEach(u=>{u.startNodeId&&d.add(u.startNodeId),u.endNodeId&&d.add(u.endNodeId)}),d},[n]),a=v.useCallback(()=>{const u=_.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.selectedArrows??[],f=u.coreState.nodes??[],g=new Set;h.forEach(p=>{p.startNodeId&&g.add(p.startNodeId),p.endNodeId&&g.add(p.endNodeId)});const x=f.filter(p=>g.has(p.id));e(x)},[e]),i=v.useCallback(()=>{e([])},[e]),l=[{label:"Select connected nodes",icon:o.jsx(Eo,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0},{label:"Deselect all nodes",icon:o.jsx(qe,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!s}],c=s?{label:"Deselect all nodes",icon:o.jsx(qe,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!1}:{label:"Select connected nodes",icon:o.jsx(Eo,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0};return o.jsx(tt,{mainAction:c,dropdownActions:l,variant:"outline",size:"compact",persistenceKey:"arrow-connected-nodes","data-test":"arrow-connected-nodes-button"})},Ff=({arrows:e})=>o.jsxs("div",{className:ve("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:He.nodeQuickPanel},"data-test":"arrow-quick-panel-container","data-arrow-ids":e.map(t=>t.id).join(","),children:[o.jsx(_f,{}),o.jsx(Jr,{}),o.jsx($f,{})]}),Pn=30,Lf=[],Hf=[],zf=()=>{const[e,t]=v.useState({top:0,left:0}),n=v.useRef(null),s=B(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedArrows)??Lf}),r=B(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.nodes)??Hf}),a=B(d=>d.uiState.mode),i=B(d=>{var u;return(u=d.projectCanvas.getActive())==null?void 0:u.viewState}),l=s.length>=1,c=a===W.DRAW_ARROW;return v.useEffect(()=>{if(!l||s.length===0||!i)return;const d=()=>{var k,b;let h=0,f=0,g=0,x=0,p=0;if(s.forEach((T,E)=>{const D=document.querySelector(`[data-arrow-id="${T.id}"]`);if(!D)return;const O=D.getBoundingClientRect(),M=O.left+O.width/2,$=O.top+O.height/2,{actualStartPoint:P,actualEndPoint:F}=Lr(T,r),U=F.x-P.x,L=F.y-P.y;h+=M,f+=$,g+=U,x+=L,p++}),p===0)return;const m=h/p,w=f/p,S=Math.abs(x)>Math.abs(g),y=((k=n.current)==null?void 0:k.offsetHeight)||40,j=((b=n.current)==null?void 0:b.offsetWidth)||100,N=window.innerWidth,C=window.innerHeight,I=20;let R,A;if(S){const T=m-j-Pn,E=m+Pn,D=T>=I,O=E+j<=N-I;A=D?T:O?E:I,R=w-y/2}else{const T=w-y-Pn,E=w+Pn,D=T>=I,O=E+y<=C-I;R=D?T:O?E:I,A=m-j/2}R=Math.max(I,Math.min(R,C-y-I)),A=Math.max(I,Math.min(A,N-j-I)),t({top:R,left:A})};d();const u=setTimeout(d,100);return window.addEventListener("scroll",d,!0),window.addEventListener("resize",d),()=>{clearTimeout(u),window.removeEventListener("scroll",d,!0),window.removeEventListener("resize",d)}},[l,s,r,i]),!l||s.length===0||c?null:yr.createPortal(o.jsx("div",{ref:n,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:He.popover},onPointerDown:d=>d.stopPropagation(),onTouchStart:d=>d.stopPropagation(),onWheel:d=>d.stopPropagation(),"data-test":"arrow-quick-panel-portal",children:o.jsx(Ff,{arrows:s})}),document.body)},Wf=e=>{const t=o.jsx(Et,{className:"h-3 w-3"}),n=e.startNodeId?`Node ${e.startNodeId.substring(0,4)}`:`(${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)})`,s=e.endNodeId?`Node ${e.endNodeId.substring(0,4)}`:`(${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)})`,r=`${n} -> ${s}`,a=e.id.substring(0,6),i=`S: [${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)}]`,l=`E: [${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)}]`;return o.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"arrow-display-element",children:[o.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"arrow-display-top-row",children:[o.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"arrow-display-content",children:[t&&o.jsx("span",{className:"flex-shrink-0","data-test":"arrow-display-icon",children:t}),o.jsx("span",{className:"truncate","data-test":"arrow-display-text",children:r})]}),o.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"arrow-display-id",children:a})]}),o.jsxs("div",{className:"text-muted-foreground text-[10px] w-full flex justify-between pr-1","data-test":"arrow-display-coords",children:[o.jsx("span",{"data-test":"arrow-display-start-coords",children:i}),o.jsx("span",{"data-test":"arrow-display-end-coords",children:l})]})]})},Bf=(e,t)=>t.length!==1?-1:e.findIndex(n=>n.id===t[0].id),Vf=e=>{const{className:t,style:n}=e,s=_.getState(),r=s.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.arrows)??[],i=(r==null?void 0:r.coreState.selectedArrows)??[],l=s.arrow.setSelected,c=s.scrollToArrow,d=v.useCallback((f,g)=>{const x=f.length>0?f[0]:-1;if(x>=0&&x<a.length){const p=a[x];l([p]),c(p),console.log("Selected arrow from list:",p.id)}else l([])},[a,l]),u=Bf(a,i),h=u!==-1?[u]:[];return o.jsx("div",{"data-test":"canvas-arrow-infos-container",className:ve("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded p-1 pointer-events-auto border",t),style:{...n},onMouseDown:f=>f.stopPropagation(),children:o.jsx(wo,{header:o.jsx("span",{className:"text-xs","data-test":"canvas-arrow-infos-header",children:"Arrows"}),itemList:a.map(Wf),onSelectionChange:d,selectedIndices:h,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0})})},Uf=()=>{const e=B(i=>i.uiState.temporaryArrow),t=B(i=>{var l;return((l=i.uiState)==null?void 0:l.useCurvedArrows)??!1}),{startPoint:n,endPoint:s}=e??{};if(!n||!s)return null;const r=t?"auto-start-reverse":"auto",a="temporary-arrowhead";return o.jsxs("g",{children:[o.jsx("defs",{children:o.jsx("marker",{id:a,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:r,markerUnits:"strokeWidth",children:o.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"grey"})})}),o.jsx(Qs,{startPoint:n,endPoint:s,useCurvedArrows:t,stroke:"grey",strokeWidth:1,strokeDasharray:"4 2",markerEndId:a})]})},Gf=30,Yf=2e3,Xf=()=>{const[e,t]=v.useState(0),n=v.useRef(0),s=v.useRef(performance.now()),r=v.useRef(performance.now()),a=v.useRef([]);return v.useEffect(()=>{let i=!0;function l(){n.current+=1;const c=performance.now();if(c-s.current>=1e3){const d=n.current;t(d),a.current.push(d),a.current.length>10&&a.current.shift(),c-r.current>=Yf&&(r.current=c),n.current=0,s.current=c}i&&requestAnimationFrame(l)}return requestAnimationFrame(l),()=>{i=!1}},[]),o.jsxs("div",{className:"text-xs pl-1",style:{color:e<Gf?"red":"inherit"},children:["FPS: ",e]})},on=1e3,rn=500,Kf=({scale:e,offset:t})=>{const n=B(b=>b.uiState.mode),[s,r]=v.useState(null),[a,i]=v.useState(null),l=B(b=>{var T;return((T=b.projectCanvas.getActive())==null?void 0:T.coreState.nodes)??Or}),c=B(b=>b.setSelectedNodes),d=window.innerWidth,u=window.innerHeight,h=-t.x/e,f=-t.y/e,g=h+d/e,x=f+u/e,p=Math.floor(h/on)*on,m=Math.ceil(g/on)*on,w=Math.floor(f/rn)*rn,S=Math.ceil(x/rn)*rn,y=[];for(let b=p;b<=m;b+=on)y.push(b);const j=[];for(let b=w;b<=S;b+=rn)j.push(b);const N=v.useCallback(b=>{const E=b.currentTarget.getBoundingClientRect(),D=b.clientX-E.left,O=b.clientY-E.top,M=(D-t.x)/e,$=(O-t.y)/e,P=D,F=E.width-D,U=O,L=E.height-O,G=50,q=P<G||F<G,ee=U<G||L<G;r({canvasX:M,canvasY:$,showVertical:ee,showHorizontal:q})},[e,t]),C=v.useCallback(()=>{r(null),i(null)},[]),I=v.useCallback(b=>{if(s&&(s.showVertical||s.showHorizontal)){b.stopPropagation(),b.preventDefault();const T=s.showVertical?"vertical":"horizontal";i({isDragging:!0,startX:s.canvasX,startY:s.canvasY,currentX:s.canvasX,currentY:s.canvasY,dragType:T})}},[s]),R=v.useCallback(b=>{if(!a||!a.isDragging)return;b.stopPropagation(),b.preventDefault();const T=Math.min(a.startX,a.currentX),E=Math.max(a.startX,a.currentX),D=Math.min(a.startY,a.currentY),O=Math.max(a.startY,a.currentY),M=l.filter($=>{const P=$.width??200,F=$.height??100,U=$.x+P,L=$.y+F;return a.dragType==="vertical"?$.x<=E&&U>=T:$.y<=O&&L>=D});M.length>0&&c(M),i(null)},[a,l,c]),A=N,k=v.useCallback(b=>{if(A(b),a!=null&&a.isDragging){b.stopPropagation(),b.preventDefault();const E=b.currentTarget.getBoundingClientRect(),D=b.clientX-E.left,O=b.clientY-E.top,M=(D-t.x)/e,$=(O-t.y)/e;i({...a,currentX:M,currentY:$})}},[A,a,t,e]);return n!==W.GRID?null:o.jsx("svg",{"data-grid-svg":"true","data-grid-active":s!=null&&s.showVertical||s!=null&&s.showHorizontal?"true":"false",className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{zIndex:s!=null&&s.showVertical||s!=null&&s.showHorizontal?999:0,pointerEvents:"auto",cursor:s?a!=null&&a.isDragging?"grabbing":"grab":"default"},onMouseMove:k,onMouseLeave:C,onMouseDown:I,onMouseUp:R,children:o.jsxs("g",{transform:`translate(${t.x}, ${t.y}) scale(${e})`,children:[y.map(b=>o.jsx("line",{x1:b,y1:f,x2:b,y2:x,stroke:b===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:b===0?2/e:1/e,style:{pointerEvents:"none"}},`v-${b}`)),j.map(b=>o.jsx("line",{x1:h,y1:b,x2:g,y2:b,stroke:b===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:b===0?2/e:1/e,style:{pointerEvents:"none"}},`h-${b}`)),s&&s.showVertical&&o.jsx("line",{x1:s.canvasX,y1:f,x2:s.canvasX,y2:x,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-vertical"),s&&s.showHorizontal&&o.jsx("line",{x1:h,y1:s.canvasY,x2:g,y2:s.canvasY,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-horizontal"),a&&a.isDragging&&(()=>{const b=Math.min(a.startX,a.currentX),T=Math.max(a.startX,a.currentX),E=Math.min(a.startY,a.currentY),D=Math.max(a.startY,a.currentY);return a.dragType==="vertical"?o.jsx("rect",{x:b,y:f,width:T-b,height:x-f,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range"):o.jsx("rect",{x:h,y:E,width:g-h,height:D-E,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range")})(),y.map(b=>o.jsx("text",{x:b,y:f+20/e,fill:"rgba(100, 116, 139, 0.6)",fontSize:Q.FONT_SIZE_XXS/e,textAnchor:"middle",style:{pointerEvents:"none"},children:b},`label-v-${b}`)),j.map(b=>o.jsx("text",{x:h+20/e,y:b,fill:"rgba(100, 116, 139, 0.6)",fontSize:Q.FONT_SIZE_XXS/e,textAnchor:"start",dominantBaseline:"middle",style:{pointerEvents:"none"},children:b},`label-h-${b}`)),s&&(s.showVertical||s.showHorizontal)&&(()=>{let b=l,T="",E=s.canvasX,D=s.canvasY-30/e;if(a!=null&&a.isDragging){const O=Math.min(a.startX,a.currentX),M=Math.max(a.startX,a.currentX),$=Math.min(a.startY,a.currentY),P=Math.max(a.startY,a.currentY);b=l.filter(F=>{const U=F.width??200,L=F.height??100,G=F.x+U,q=F.y+L;return a.dragType==="vertical"?F.x<=M&&G>=O:F.y<=P&&q>=$}),T=`Release to select ${b.length} node${b.length!==1?"s":""}`,E=(O+M)/2,D=a.dragType==="vertical"?f+30/e:($+P)/2}else s.showVertical&&(b=b.filter(O=>{const M=O.width??200,$=O.x+M;return O.x<=s.canvasX&&$>=s.canvasX})),s.showHorizontal&&(b=b.filter(O=>{const M=O.height??100,$=O.y+M;return O.y<=s.canvasY&&$>=s.canvasY})),T=`Click/drag to select ${b.length} node${b.length!==1?"s":""}`;return o.jsxs("g",{children:[o.jsx("rect",{x:E-70/e,y:D-12/e,width:140/e,height:24/e,fill:"rgba(0, 0, 0, 0.9)",rx:4/e,style:{pointerEvents:"none"}}),o.jsx("text",{x:E,y:D,fill:"white",fontSize:Q.FONT_SIZE_XXS/e,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:T})]},"tooltip")})()]})})},pa={projectScope:{projects:!0,workspaces:!0,canvases:!0},nodeFields:{content:!1,title:!1,id:!1,type:!1,tags:!1}},ma=e=>Object.values(e.nodeFields).some(t=>t),qf=e=>{const t=!e.projectScope.projects||!e.projectScope.workspaces||!e.projectScope.canvases,n=ma(e);return t||n},Zf=({searchQuery:e,onSearchQueryChange:t,searchFilters:n,onSearchFiltersChange:s})=>{const[r,a]=v.useState(!1);return o.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"projects-search-section",children:[o.jsx(wn,{className:"search-icon absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"projects-search-icon"}),o.jsx(dt,{type:"text",placeholder:"Search...",value:e,onChange:i=>t(i.target.value),className:je("search-input h-7 text-sm pl-8",e?"pr-14":"pr-8"),"data-test":"projects-search-input"}),e&&o.jsx(Y,{variant:"ghost",size:"icon",onClick:()=>t(""),className:"clear-button absolute right-8 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"projects-search-clear-button",children:o.jsx(qe,{className:"h-3 w-3"})}),qf(n)&&o.jsx("div",{className:je("filter-indicator absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",e?"right-14":"right-9"),"data-test":"projects-search-filter-indicator"}),o.jsxs(_t,{open:r,onOpenChange:a,children:[o.jsx(Ot,{asChild:!0,children:o.jsx(Y,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0","aria-label":r?"Collapse advanced search":"Expand advanced search","data-test":"projects-search-expand-button",children:o.jsx(oo,{className:"h-3 w-3"})})}),o.jsxs($t,{align:"start",side:"bottom",className:"advanced-search-panel w-72",style:{zIndex:He.draggablePopoverDropdown},"data-test":"projects-advanced-search-panel",children:[o.jsxs("div",{className:"panel-header flex items-center justify-between pb-2 border-b","data-test":"projects-panel-header",children:[o.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),o.jsx(Y,{variant:"ghost",size:"sm",onClick:()=>s(pa),className:"h-6 text-xs px-2","data-test":"projects-clear-filters-button",children:"Clear All"})]}),o.jsxs("div",{className:"project-scope-section space-y-2 mt-3","data-test":"projects-scope-section",children:[o.jsx(it,{className:"text-sm font-medium",children:"Project"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in names of:"}),o.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"scope-projects",checked:n.projectScope.projects,onCheckedChange:i=>s({...n,projectScope:{...n.projectScope,projects:!!i}}),"data-test":"projects-scope-projects-checkbox"}),o.jsx("label",{htmlFor:"scope-projects",className:"text-sm cursor-pointer",children:"Projects"})]}),o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"scope-workspaces",checked:n.projectScope.workspaces,onCheckedChange:i=>s({...n,projectScope:{...n.projectScope,workspaces:!!i}}),"data-test":"projects-scope-workspaces-checkbox"}),o.jsx("label",{htmlFor:"scope-workspaces",className:"text-sm cursor-pointer",children:"Workspaces"})]}),o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"scope-canvases",checked:n.projectScope.canvases,onCheckedChange:i=>s({...n,projectScope:{...n.projectScope,canvases:!!i}}),"data-test":"projects-scope-canvases-checkbox"}),o.jsx("label",{htmlFor:"scope-canvases",className:"text-sm cursor-pointer",children:"Canvases"})]})]})]}),o.jsxs("div",{className:"node-fields-section space-y-2 mt-4","data-test":"projects-node-fields-section",children:[o.jsx(it,{className:"text-sm font-medium",children:"Node Content"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),o.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"node-content",checked:n.nodeFields.content,onCheckedChange:i=>s({...n,nodeFields:{...n.nodeFields,content:!!i}}),"data-test":"projects-node-content-checkbox"}),o.jsx("label",{htmlFor:"node-content",className:"text-sm cursor-pointer",children:"Content"})]}),o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"node-title",checked:n.nodeFields.title,onCheckedChange:i=>s({...n,nodeFields:{...n.nodeFields,title:!!i}}),"data-test":"projects-node-title-checkbox"}),o.jsx("label",{htmlFor:"node-title",className:"text-sm cursor-pointer",children:"Title"})]}),o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"node-id",checked:n.nodeFields.id,onCheckedChange:i=>s({...n,nodeFields:{...n.nodeFields,id:!!i}}),"data-test":"projects-node-id-checkbox"}),o.jsx("label",{htmlFor:"node-id",className:"text-sm cursor-pointer",children:"ID"})]}),o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"node-type",checked:n.nodeFields.type,onCheckedChange:i=>s({...n,nodeFields:{...n.nodeFields,type:!!i}}),"data-test":"projects-node-type-checkbox"}),o.jsx("label",{htmlFor:"node-type",className:"text-sm cursor-pointer",children:"Type"})]}),o.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[o.jsx($e,{id:"node-tags",checked:n.nodeFields.tags,onCheckedChange:i=>s({...n,nodeFields:{...n.nodeFields,tags:!!i}}),"data-test":"projects-node-tags-checkbox"}),o.jsx("label",{htmlFor:"node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]}),o.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 mt-4 border-t","data-test":"projects-panel-footer",children:[o.jsx(Y,{onClick:()=>a(!1),className:"flex-1",size:"sm","data-test":"projects-apply-search-button",children:"Apply"}),o.jsx(Y,{onClick:()=>a(!1),variant:"outline",size:"sm","data-test":"projects-cancel-button",children:"Cancel"})]})]})]})]})},Jf=()=>{const e=B(a=>{var i,l;return(l=(i=a.preferences)==null?void 0:i.projectsManagerSearch)==null?void 0:l.filters}),[t,n]=v.useState(""),[s,r]=v.useState(e??pa);return v.useEffect(()=>{_.setState(a=>({...a,preferences:{...a.preferences,projectsManagerSearch:{filters:s}}}))},[s]),{searchQuery:t,setSearchQuery:n,searchFilters:s,setSearchFilters:r}},Qf=180,eh=[],xa=e=>{const{onCanvasSelected:t,excludeCanvasId:n,selectionModeTitle:s,isOpen:r,onClose:a,popoverPosition:i}=e,l=!!t,c=B(z=>{var V;return((V=z.state)==null?void 0:V.projects)??{}}),d=B(z=>{var V;return((V=z.state)==null?void 0:V.activeProjectId)??""}),u=B(z=>z.project),h=B(z=>z.workspace),f=B(z=>z.projectCanvas),g=B(z=>z.exportSingleCanvas),x=B(z=>z.exportSingleWorkspace),p=B(z=>z.exportSingleProject),{searchQuery:m,setSearchQuery:w,searchFilters:S,setSearchFilters:y}=Jf(),j=B(z=>{var V;return((V=z.preferences)==null?void 0:V.recentCanvases)??eh}),[N,C]=v.useState("projects"),I=v.useMemo(()=>d?c[d]??null:null,[c,d]),R=v.useMemo(()=>I!=null&&I.activeWorkspaceId?I.workspaces[I.activeWorkspaceId]??null:null,[I]),[A,k]=v.useState(""),[b,T]=v.useState(null),[E,D]=v.useState(!1),[O,M]=v.useState(null),$=v.useRef(null),P=r!==void 0,F=P?r:E,U=P?z=>{!z&&a&&a()}:D,L=P?i:O,G=v.useMemo(()=>{const z=m.toLowerCase().trim(),V=z.length>0,K=ma(S),J=X=>X?X.toLowerCase().includes(z):!1,se=X=>{if(!V||!K)return!1;const{nodeFields:ne}=S,we=typeof X.content=="string"?X.content:"";return!!(ne.content&&J(we)||ne.title&&J(X.title)||ne.id&&J(X.id)||ne.type&&J(X.type)||ne.tags&&Array.isArray(X.tags)&&X.tags.some(le=>{const ue=typeof le=="string"?le:(le==null?void 0:le.value)||(le==null?void 0:le.label)||"";return J(ue)}))};return Object.values(c).sort((X,ne)=>(X.sortOrder??0)-(ne.sortOrder??0)).map(X=>{if(V&&X.hideFromSearch)return null;const ne=V&&S.projectScope.projects&&J(X.name),we=Object.values(X.workspaces).sort((le,ue)=>(le.sortOrder??0)-(ue.sortOrder??0)).map(le=>{if(V&&le.hideFromSearch)return null;const ue=V&&S.projectScope.workspaces&&J(le.name),ye=Object.values(le.canvases).sort((fe,pe)=>(fe.sortOrder??0)-(pe.sortOrder??0)).map(fe=>{var Te;if(n&&fe.id===n||V&&fe.hideFromSearch)return null;const pe=V&&S.projectScope.canvases&&J(fe.name);let he=[];V&&K&&((Te=fe.coreState)!=null&&Te.nodes)&&(he=fe.coreState.nodes.filter(se).map(Ae=>{const Me=typeof Ae.content=="string"?Ae.content:"",Ye=Ae.title||Me.substring(0,40)||Ae.id,Ve=Ye.length>40?Ye.substring(0,40)+"...":Ye;return{id:`node-${Ae.id}`,label:Ve,data:{type:"node",id:Ae.id,name:Ve,isActive:!1,projectId:X.id,workspaceId:le.id,canvasId:fe.id,nodeType:Ae.type}}}));const Re=he.length>0;return!V||pe||Re?{id:fe.id,label:fe.name,data:{type:"canvas",id:fe.id,name:fe.name,isActive:fe.id===le.activeCanvasId,projectId:X.id,workspaceId:le.id},children:he.length>0?he:void 0}:null}).filter(Boolean),ke=ye.length>0;return!V||ue||ke?{id:le.id,label:le.name,data:{type:"workspace",id:le.id,name:le.name,isActive:le.id===X.activeWorkspaceId,projectId:X.id},children:ye}:null}).filter(Boolean),Ne=we.length>0;return!V||ne||Ne?{id:X.id,label:X.name,data:{type:"project",id:X.id,name:X.name,isActive:X.id===d},children:we}:null}).filter(Boolean)},[c,d,m,S,n]),q=v.useMemo(()=>{const z=new Set;if(d&&z.add(d),I!=null&&I.activeWorkspaceId&&z.add(I.activeWorkspaceId),m.trim()){const V=K=>{for(const J of K)z.add(J.id),J.children&&V(J.children)};V(G)}return z},[d,I,m,G]),ee=z=>{const V=A.trim()||`New ${z}`;z==="project"?u.create(V):z==="workspace"?h.create(V):z==="canvas"&&f.create(V),k(""),T(null)},oe=z=>o.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5","data-test":`projects-add-${z}-input-container`,children:[o.jsx(dt,{"data-test":`projects-new-${z}-input`,type:"text",placeholder:`New ${z} name...`,value:A,onChange:V=>k(V.target.value),onKeyDown:V=>V.key==="Enter"&&ee(z),autoFocus:!0,className:"h-6 text-sm flex-grow"}),o.jsx(Y,{"data-test":`projects-save-${z}-button`,variant:"ghost",size:"sm",onClick:()=>ee(z),children:o.jsx(Pt,{className:"h-3 w-3"})}),o.jsx(Y,{"data-test":`projects-cancel-${z}-button`,variant:"ghost",size:"sm",onClick:()=>{T(null),k("")},children:o.jsx(qe,{className:"h-3 w-3"})})]}),ge=z=>{var K;const V=(K=z.data)==null?void 0:K.type;if(V==="canvas"){if(l&&t){const{id:J,workspaceId:se,projectId:X,name:ne}=z.data||{};J&&se&&X&&t({canvasId:J,workspaceId:se,projectId:X,canvasName:ne||""});return}f.switch(z.id)}else if(V==="node"){const{canvasId:J,id:se}=z.data||{};J&&se&&(f.switch(J),setTimeout(()=>{const X=_.getState().getNodeById(se);X&&(_.getState().setSelectedNodes([X]),_.getState().scrollToNode(se,300))},100))}},me=z=>{if(l&&t){if(n&&z.canvasId===n)return;t({canvasId:z.canvasId,workspaceId:z.workspaceId,projectId:z.projectId,canvasName:z.canvasName});return}f.switch(z.canvasId),C("projects")},be=(z,V)=>{z.stopPropagation(),f.removeRecentCanvas(V)},Fe=(z,V)=>{const K=se=>{var X;for(const ne of se){if(ne.id===z)return(X=ne.data)==null?void 0:X.type;if(ne.children){const we=K(ne.children);if(we)return we}}return null},J=K(G);J==="project"?u.updateMetadata(z,{name:V}):J==="workspace"?h.updateMetadata(z,{name:V}):J==="canvas"&&f.updateMetadata(z,{name:V})},H=z=>{const V=J=>{var se;for(const X of J){if(X.id===z)return(se=X.data)==null?void 0:se.type;if(X.children){const ne=V(X.children);if(ne)return ne}}return null},K=V(G);K==="project"?u.delete(z):K==="workspace"?h.delete(z):K==="canvas"&&f.delete(z)},te=z=>{var K;return`Are you sure you want to delete this ${((K=z.data)==null?void 0:K.type)??"item"}: "${z.label}"?`},de=z=>{const V=_.getState().setState;V(Ba(K=>{if(!K)return;const J=Date.now();z.forEach((se,X)=>{var le;const ne=K.projects[se.id];if(!ne)return;ne.sortOrder=X,ne.lastModified=J;const we=new Set,Ne=new Map;(le=se.children)==null||le.forEach((ue,ye)=>{var fe;let ke=ne.workspaces[ue.id];if(ke)ke.sortOrder=ye,ke.lastModified=J,we.add(ue.id);else{let pe=null,he=null;for(const[Re,Te]of Object.entries(K.projects))if(Re!==se.id&&Te.workspaces[ue.id]){pe=Te.workspaces[ue.id],he=Re;break}if(pe&&he){if(delete K.projects[he].workspaces[ue.id],K.projects[he].lastModified=J,K.projects[he].activeWorkspaceId===ue.id){const Re=Object.keys(K.projects[he].workspaces);K.projects[he].activeWorkspaceId=Re[0]||""}ne.workspaces[ue.id]=pe,pe.sortOrder=ye,pe.lastModified=J,we.add(ue.id),ke=pe}}if(ke){const pe=new Set;Ne.set(ue.id,pe),(fe=ue.children)==null||fe.forEach((he,Re)=>{const Te=ke.canvases[he.id];if(Te)Te.sortOrder=Re,Te.lastModified=J,pe.add(he.id);else{let Ae=null,Me=null;for(const[Ye,Ve]of Object.entries(ne.workspaces))if(Ve.canvases[he.id]){Ae=Ve.canvases[he.id],Me=Ye;break}if(Ae)Me&&Me!==ue.id&&(delete ne.workspaces[Me].canvases[he.id],ne.workspaces[Me].lastModified=J);else for(const[Ye,Ve]of Object.entries(K.projects))if(Ye!==se.id){for(const[gt,Ze]of Object.entries(Ve.workspaces))if(Ze.canvases[he.id]){Ae=Ze.canvases[he.id],Me=gt,delete Ze.canvases[he.id],Ze.lastModified=J,Ve.lastModified=J;break}if(Ae)break}Ae&&(ke.canvases[he.id]=Ae,Ae.sortOrder=Re,Ae.lastModified=J,pe.add(he.id))}})}})})}))},xe=z=>{var K,J,se,X,ne,we,Ne;const V=(K=z.data)==null?void 0:K.type;if(V==="project"){const le=(J=z.data)==null?void 0:J.id,ue=le?c[le]:null,ye=(ue==null?void 0:ue.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:ye?"Include in search":"Hide from search",icon:ye?o.jsx(zt,{className:"h-4 w-4 mr-2"}):o.jsx(Fn,{className:"h-4 w-4 mr-2"}),onClick:ke=>{const{id:fe}=ke.data||{};fe&&u.updateMetadata(fe,{hideFromSearch:!ye})}},{id:"export",label:"Export",icon:o.jsx(Ln,{className:"h-4 w-4 mr-2"}),onClick:ke=>{const{id:fe}=ke.data||{};fe&&p({projectId:fe})}}]}if(V==="workspace"){const le=(se=z.data)==null?void 0:se.id,ue=(X=z.data)==null?void 0:X.projectId,ye=ue?c[ue]:null,ke=ye&&le?ye.workspaces[le]:null,fe=(ke==null?void 0:ke.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:fe?"Include in search":"Hide from search",icon:fe?o.jsx(zt,{className:"h-4 w-4 mr-2"}):o.jsx(Fn,{className:"h-4 w-4 mr-2"}),onClick:pe=>{const{id:he}=pe.data||{};he&&h.updateMetadata(he,{hideFromSearch:!fe})}},{id:"export",label:"Export",icon:o.jsx(Ln,{className:"h-4 w-4 mr-2"}),onClick:pe=>{const{projectId:he,id:Re}=pe.data||{};he&&Re&&x({projectId:he,workspaceId:Re})}}]}if(V==="canvas"){const le=(ne=z.data)==null?void 0:ne.id,ue=(we=z.data)==null?void 0:we.projectId,ye=(Ne=z.data)==null?void 0:Ne.workspaceId,ke=ue?c[ue]:null,fe=ke&&ye?ke.workspaces[ye]:null,pe=fe&&le?fe.canvases[le]:null,he=(pe==null?void 0:pe.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:he?"Include in search":"Hide from search",icon:he?o.jsx(zt,{className:"h-4 w-4 mr-2"}):o.jsx(Fn,{className:"h-4 w-4 mr-2"}),onClick:Re=>{const{id:Te}=Re.data||{};Te&&f.updateMetadata(Te,{hideFromSearch:!he})}},{id:"duplicate",label:"Duplicate",icon:o.jsx(Gt,{className:"h-4 w-4 mr-2"}),onClick:Re=>{const{projectId:Te,workspaceId:Ae,id:Me}=Re.data||{};Te&&Ae&&Me&&f.duplicate(Me,Te,Ae)}},{id:"export",label:"Export",icon:o.jsx(Ln,{className:"h-4 w-4 mr-2"}),onClick:Re=>{const{projectId:Te,workspaceId:Ae,id:Me}=Re.data||{};Te&&Ae&&Me&&g({projectId:Te,workspaceId:Ae,canvasId:Me})}}]}return null},Se=()=>{if(F){U(!1),T(null),k("");return}if($.current){const z=$.current.getBoundingClientRect(),V=320,K=400,J=z.left+z.width/2,se=z.top+z.height/2;M({x:J-V/2+Qf,y:se-K/2})}D(!0)};return o.jsxs(o.Fragment,{children:[!P&&o.jsx(Jt,{ref:$,variant:"secondary",size:"sm",tooltip:"Manage projects",onClick:Se,className:"canvas-projects-manager-button","data-test":"canvas-projects-manager-button",children:o.jsx(Gi,{className:"h-4 w-4"})}),o.jsx(ut,{isVisible:F,onClose:()=>{U(!1),T(null),k(""),C("projects")},title:l?s??"Select Canvas":N==="recent"?"Recent Canvases":"Projects",resizable:!0,initialSize:{width:320,height:400},triggerPosition:L??void 0,shouldCloseManually:l,headerActions:N==="recent"?o.jsx(Y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>C("projects"),title:"Back to Projects","data-test":"projects-back-button",children:o.jsx(Xn,{className:"h-3.5 w-3.5"})}):o.jsx(Y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>C("recent"),title:"Recent Canvases","data-test":"projects-recent-button",children:o.jsx(ro,{className:"h-3.5 w-3.5"})}),children:o.jsx("div",{className:"manager-content flex flex-col space-y-2 p-2 h-full overflow-hidden","data-test":"projects-manager-content",children:N==="projects"?o.jsxs(o.Fragment,{children:[o.jsx(Zf,{searchQuery:m,onSearchQueryChange:w,searchFilters:S,onSearchFiltersChange:y}),o.jsx(Un,{className:"tree-scroll-area flex-1 min-h-0","data-test":"projects-tree-scroll-area",children:o.jsx("div",{className:"tree-container space-y-1 pr-2","data-test":"projects-tree-container",children:o.jsx(yl,{data:G,onItemClick:ge,onUpdate:l?void 0:Fe,onDelete:l?void 0:H,onReorder:l?void 0:de,defaultExpandedIds:q,selectedId:(R==null?void 0:R.activeCanvasId)??null,deleteConfirmMessage:l?void 0:te,enableEdit:!l,enableDelete:!l,enableDrag:!l,moreOptionsItems:l?void 0:xe,dropdownZIndex:He.draggablePopoverDropdown})})}),!l&&(b?oe(b):o.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t","data-test":"projects-add-buttons-row",children:[o.jsxs(Y,{"data-test":"projects-add-project-button",variant:"outline",size:"sm",className:"add-project-button flex-1",onClick:()=>T("project"),title:"Add Project",children:[o.jsx(Tt,{className:"h-3 w-3 mr-1"})," Pr"]}),I&&o.jsxs(Y,{"data-test":"projects-add-workspace-button",variant:"outline",size:"sm",className:"add-workspace-button flex-1",onClick:()=>T("workspace"),title:"Add Workspace",children:[o.jsx(Tt,{className:"h-3 w-3 mr-1"})," Wo"]}),R&&o.jsxs(Y,{"data-test":"projects-add-canvas-button",variant:"outline",size:"sm",className:"add-canvas-button flex-1",onClick:()=>T("canvas"),title:"Add Canvas",children:[o.jsx(Tt,{className:"h-3 w-3 mr-1"})," Ca"]})]}))]}):o.jsx(Un,{className:"recent-canvases-scroll flex-1 min-h-0","data-test":"projects-recent-scroll-area",children:o.jsx("div",{className:"recent-canvases-list space-y-1 pr-2","data-test":"recent-canvases-list",children:(()=>{const z=n?j.filter(V=>V.canvasId!==n):j;return z.length===0?o.jsx("div",{className:"empty-state text-center text-muted-foreground text-sm py-8","data-test":"recent-canvases-empty",children:"No recently visited canvases"}):z.map(V=>o.jsxs("div",{className:"recent-canvas-item group flex items-center w-full text-left px-2 py-1.5 rounded hover:bg-accent transition-colors cursor-pointer",onClick:()=>me(V),"data-test":`recent-canvas-item-${V.canvasId}`,children:[o.jsxs("div",{className:"flex-1 min-w-0",children:[o.jsx("div",{className:"canvas-name text-sm font-medium truncate","data-test":"recent-canvas-name",children:V.canvasName}),o.jsxs("div",{className:"canvas-path text-xs text-muted-foreground truncate","data-test":"recent-canvas-path",children:[V.projectName," / ",V.workspaceName]})]}),!l&&o.jsx(Y,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",onClick:K=>be(K,V.canvasId),title:"Remove from recent","data-test":`recent-canvas-delete-${V.canvasId}`,children:o.jsx(qe,{className:"h-3.5 w-3.5"})})]},`${V.projectId}-${V.workspaceId}-${V.canvasId}`))})()})})})})]})};function wa({node:e,onItemClick:t,onUpdate:n,onDelete:s,level:r=0,defaultExpandedIds:a,selectedId:i,enableEdit:l=!0,enableDelete:c=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f}){var O;const[g,x]=v.useState((a==null?void 0:a.has(e.id))??!1),[p,m]=v.useState(!1),[w,S]=v.useState(e.label),y=e.children&&e.children.length>0,j=i===e.id,N=v.useRef(null),C=v.useRef(e.label);v.useEffect(()=>{e.label!==C.current&&(C.current=e.label,p||S(e.label))},[e.label,p]),v.useEffect(()=>{j&&N.current&&N.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[j]);const I=M=>{M.stopPropagation(),p||(y&&x(!g),t==null||t(e))},R=()=>{w.trim()&&w!==e.label&&(n==null||n(e.id,w.trim())),m(!1)},A=()=>{S(e.label),m(!1)},k=M=>{M.stopPropagation();const $=(d==null?void 0:d(e))??`Are you sure you want to delete "${e.label}"?`;window.confirm($)&&(s==null||s(e.id))},b={paddingLeft:`${r*1.5}rem`},T=y?o.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:g?o.jsx(Dt,{className:"h-4 w-4"}):o.jsx(so,{className:"h-4 w-4"})}):o.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),E=o.jsxs("div",{ref:N,className:je("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",j&&"bg-primary/10 border border-primary"),style:b,onClick:I,children:[T,e.icon&&o.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:e.icon}),p?o.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[o.jsx(dt,{type:"text",value:w,onChange:M=>S(M.target.value),onKeyDown:M=>{M.key==="Enter"&&R(),M.key==="Escape"&&A()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:M=>M.stopPropagation()}),o.jsx(Y,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),R()},className:"h-6 w-6 p-0",children:o.jsx(Pt,{className:"h-3 w-3"})}),o.jsx(Y,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),A()},className:"h-6 w-6 p-0",children:o.jsx(qe,{className:"h-3 w-3"})})]}):o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"tree-item-label flex-grow truncate",title:e.label,children:e.label}),o.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[l&&n&&o.jsx(Y,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),m(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:o.jsx(Yi,{className:"h-3 w-3"})}),(()=>{const M=h==null?void 0:h(e);return M&&M.length>0?o.jsxs(Ts,{children:[o.jsx(Ms,{asChild:!0,children:o.jsx(Y,{variant:"ghost",size:"sm",onClick:$=>$.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:o.jsx(Dr,{className:"h-3 w-3"})})}),o.jsxs(Ds,{align:"end",style:f?{zIndex:f}:void 0,"data-test":"tree-item-more-options-content",children:[M.map($=>$.subItems?o.jsxs(Va,{children:[o.jsxs(Ua,{className:$.className,"data-test":`tree-item-menu-${$.id}`,children:[$.icon,$.label]}),o.jsx(Ga,{children:$.subItems.map(P=>o.jsxs(at,{onClick:F=>{F.stopPropagation(),P.onClick(e)},className:P.className,"data-test":`tree-item-menu-${$.id}-${P.id}`,children:[P.icon,P.label]},P.id))})]},$.id):o.jsxs(at,{onClick:P=>{var F;P.stopPropagation(),(F=$.onClick)==null||F.call($,e)},className:$.className,"data-test":`tree-item-menu-${$.id}`,children:[$.icon,$.label]},$.id)),c&&s&&o.jsxs(at,{onClick:$=>{$.stopPropagation(),k($)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[o.jsx(Yt,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):c&&s?o.jsx(Y,{variant:"ghost",size:"sm",onClick:k,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:o.jsx(Yt,{className:"h-3 w-3"})}):null})()]})]})]}),D=u?u(e,j,!!y,E):E;return y?o.jsxs(Ya,{open:g,onOpenChange:x,children:[o.jsx(Xa,{asChild:!0,children:o.jsx("div",{children:D})}),o.jsx(Ka,{children:o.jsx("div",{className:"tree-item-children",children:(O=e.children)==null?void 0:O.map(M=>o.jsx(wa,{node:M,onItemClick:t,onUpdate:n,onDelete:s,level:r+1,defaultExpandedIds:a,selectedId:i,enableEdit:l,enableDelete:c,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f},M.id))})})]}):o.jsx(o.Fragment,{children:D})}function th({data:e,onItemClick:t,onUpdate:n,onDelete:s,className:r,defaultExpandedIds:a,selectedId:i,enableEdit:l=!0,enableDelete:c=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f}){return o.jsx("div",{className:je("crud-tree-root",r),children:e.map(g=>o.jsx(wa,{node:g,onItemClick:t,onUpdate:n,onDelete:s,defaultExpandedIds:a,selectedId:i,enableEdit:l,enableDelete:c,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f},g.id))})}const nh=180,sh=()=>{const e=Ke(H=>H.definitions),t=Ke(H=>H.instances),n=Ke(H=>H.selectedDefinitionId),s=Ke(H=>H.createDefinition),r=Ke(H=>H.updateDefinition),a=Ke(H=>H.deleteDefinition);Ke(H=>H.duplicateDefinition);const i=Ke(H=>H.createInstance),l=Ke(H=>H.deleteInstance),c=Ke(H=>H.selectDefinition),d=B(H=>{var te;return((te=H.projectCanvas.getActive())==null?void 0:te.coreState.nodes)??Or}),u=B(H=>{var te;return((te=H.state)==null?void 0:te.projects)??{}}),[h,f]=v.useState(""),[g,x]=v.useState(null),[p,m]=v.useState(!1),[w,S]=v.useState(null),[y,j]=v.useState(new Set),N=v.useRef(null),C=v.useRef(null),I=Ke(H=>H.facade),R=v.useMemo(()=>new Zs(I),[I]),A=v.useMemo(()=>{const H=u["workflow-templates-project"],te=[];H&&Object.values(H.workspaces).forEach(K=>{Object.values(K.canvases).forEach(J=>{J.coreState.nodes.filter(X=>{var ne;return((ne=X.data)==null?void 0:ne.nodeType)==="workflowOrchestration"}).forEach(X=>{var ue,ye;const ne=X.data,we=((ye=(ue=ne==null?void 0:ne.parameters)==null?void 0:ue.rows)==null?void 0:ye.length)||0,Ne=typeof X.title=="string"?X.title:"",le=typeof X.content=="string"?X.content:"";te.push({id:`preset-${X.id}`,label:Ne||le||`Preset (${we} steps)`,data:{type:"preset-workflow",id:X.id,nodeId:X.id,rowCount:we,canvasId:J.id,canvasName:J.name}})})})});const de=new Set(te.map(K=>{var J;return(J=K.data)==null?void 0:J.nodeId})),Se=d.filter(K=>{var J;return((J=K.data)==null?void 0:J.nodeType)==="workflowOrchestration"&&!de.has(K.id)}).map(K=>{var we,Ne;const J=K.data,se=((Ne=(we=J==null?void 0:J.parameters)==null?void 0:we.rows)==null?void 0:Ne.length)||0,X=typeof K.title=="string"?K.title:"",ne=typeof K.content=="string"?K.content:"";return{id:K.id,label:X||ne||`Workflow (${se} steps)`,data:{type:"canvas-workflow",id:K.id,nodeId:K.id,rowCount:se}}}),z=e.map(K=>{const J=t.filter(se=>se.definitionId===K.id);return{id:K.id,label:K.name,data:{type:"definition",id:K.id,name:K.name,isActive:K.id===n,description:K.description,tags:K.tags},children:J.map(se=>({id:se.id,label:se.name,data:{type:"instance",id:se.id,name:se.name,status:se.status,definitionId:se.definitionId}}))}}),V=[];return te.length>0&&V.push({id:"section-presets",label:`ðŸ“š Workflow Presets (${te.length})`,data:{type:"section",section:"presets"},children:te}),Se.length>0&&V.push({id:"section-canvas",label:`ðŸŽ¨ Current Canvas (${Se.length})`,data:{type:"section",section:"canvas"},children:Se}),z.length>0&&V.push({id:"section-saved",label:`ðŸ’¾ Saved Workflows (${z.length})`,data:{type:"section",section:"saved"},children:z}),V},[d,e,t,n,u]),k=v.useMemo(()=>{const H=new Set;return H.add("section-presets"),H.add("section-canvas"),H.add("section-saved"),n&&H.add(n),H},[n]),b=H=>{const te=h.trim()||`New ${H}`;H==="definition"?s({name:te}):H==="instance"&&n&&i(n,te),f(""),x(null)},T=H=>o.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[o.jsx(dt,{"data-test":`workflow-new-${H}-input`,type:"text",placeholder:`New ${H} name...`,value:h,onChange:te=>f(te.target.value),onKeyDown:te=>te.key==="Enter"&&b(H),autoFocus:!0,className:"h-6 text-sm flex-grow"}),o.jsx(Y,{"data-test":`workflow-save-${H}-button`,variant:"ghost",size:"sm",onClick:()=>b(H),children:o.jsx(Pt,{className:"h-3 w-3"})}),o.jsx(Y,{"data-test":`workflow-cancel-${H}-button`,variant:"ghost",size:"sm",onClick:()=>{x(null),f("")},children:o.jsx(qe,{className:"h-3 w-3"})})]}),E=H=>{var de;((de=H.data)==null?void 0:de.type)==="definition"&&c(H.id)},D=(H,te)=>{const de=Se=>{var z;for(const V of Se){if(V.id===H)return(z=V.data)==null?void 0:z.type;if(V.children){const K=de(V.children);if(K)return K}}return null},xe=de(A);xe==="section"||xe==="preset-workflow"||(xe==="canvas-workflow"?_.getState().updateNode(H,{title:te}):xe==="definition"?r(H,{name:te}):xe==="instance"&&console.warn("Instance rename not yet implemented"))},O=H=>{const te=xe=>{var Se;for(const z of xe){if(z.id===H)return(Se=z.data)==null?void 0:Se.type;if(z.children){const V=te(z.children);if(V)return V}}return null},de=te(A);de==="section"||de==="preset-workflow"||de==="canvas-workflow"||(de==="definition"?a(H):de==="instance"&&l(H))},M=H=>{var de;return`Are you sure you want to delete this ${((de=H.data)==null?void 0:de.type)??"item"}: "${H.label}"?`},$=()=>{if(p){m(!1),x(null),f("");return}if(N.current){const H=N.current.getBoundingClientRect(),te=320,de=400,xe=H.left+H.width/2,Se=H.top+H.height/2;S({x:xe-te/2+nh,y:Se-de/2})}m(!0)},P=()=>{if(y.size===0){ce.error("No workflows selected");return}try{const H=Array.from(y);R.downloadWorkflows(H),ce.success(`Exported ${y.size} workflow(s)`,{description:"Workflows downloaded as JSON file"})}catch(H){ce.error("Export failed",{description:H instanceof Error?H.message:"Unknown error"})}},F=()=>{try{const H=R.exportAllWorkflows(),te=new Blob([H],{type:"application/json"}),de=URL.createObjectURL(te),xe=document.createElement("a");xe.href=de,xe.download=`all-workflows-${Date.now()}.json`,xe.click(),URL.revokeObjectURL(de),ce.success("Exported all workflows",{description:`${e.length} workflow(s) downloaded`})}catch(H){ce.error("Export failed",{description:H instanceof Error?H.message:"Unknown error"})}},U=()=>{var H;(H=C.current)==null||H.click()},L=H=>{var xe;const te=(xe=H.target.files)==null?void 0:xe[0];if(!te)return;const de=new FileReader;de.onload=Se=>{var z;try{const V=(z=Se.target)==null?void 0:z.result,K=R.importWorkflows(V);ce.success(`Imported ${K.length} workflow(s)`,{description:"Workflows added to manager"})}catch(V){ce.error("Import failed",{description:V instanceof Error?V.message:"Invalid JSON"})}},de.readAsText(te),H.target.value=""},G=H=>{const te=new Set(y);te.has(H)?te.delete(H):te.add(H),j(te)},q=()=>{y.size===e.length?j(new Set):j(new Set(e.map(H=>H.id)))},ee=()=>{if(y.size!==0&&window.confirm(`Are you sure you want to delete ${y.size} workflow(s)?`))try{R.bulkDeleteDefinitions(Array.from(y)),j(new Set),ce.success(`Deleted ${y.size} workflow(s)`)}catch(H){ce.error("Bulk delete failed",{description:H instanceof Error?H.message:"Unknown error"})}},oe=()=>{if(y.size!==0)try{const H=R.bulkDuplicateDefinitions(Array.from(y));j(new Set),ce.success(`Duplicated ${H.length} workflow(s)`,{description:'New workflows created with " (copy)" suffix'})}catch(H){ce.error("Bulk duplicate failed",{description:H instanceof Error?H.message:"Unknown error"})}},ge=()=>{if(y.size===0)return;const H=window.prompt("Enter tags (comma-separated):");if(!H)return;const te=H.split(",").map(de=>de.trim()).filter(Boolean);if(te.length===0){ce.error("No valid tags provided");return}try{R.bulkAddTags(Array.from(y),te),ce.success(`Added tags to ${y.size} workflow(s)`,{description:`Tags: ${te.join(", ")}`})}catch(de){ce.error("Bulk add tags failed",{description:de instanceof Error?de.message:"Unknown error"})}},me=()=>{if(y.size===0)return;const H=window.prompt("Enter tags to remove (comma-separated):");if(!H)return;const te=H.split(",").map(de=>de.trim()).filter(Boolean);if(te.length===0){ce.error("No valid tags provided");return}try{R.bulkRemoveTags(Array.from(y),te),ce.success(`Removed tags from ${y.size} workflow(s)`,{description:`Tags: ${te.join(", ")}`})}catch(de){ce.error("Bulk remove tags failed",{description:de instanceof Error?de.message:"Unknown error"})}},be=()=>{if(y.size!==0)try{const H=R.getBulkStats(Array.from(y));ce.info("Bulk Statistics",{description:`Workflows: ${H.count} | Nodes: ${H.totalNodes} | Connections: ${H.totalConnections} | Tags: ${H.tags.length}`})}catch(H){ce.error("Failed to get statistics",{description:H instanceof Error?H.message:"Unknown error"})}},Fe=y.size===e.length&&e.length>0;return y.size>0&&y.size<e.length,o.jsxs(o.Fragment,{children:[o.jsx(Jt,{ref:N,variant:"secondary",size:"sm",tooltip:"Manage workflows",onClick:$,className:"workflow-manager-button","data-test":"workflow-manager-button",children:o.jsx(mn,{className:"h-4 w-4"})}),o.jsx(ut,{isVisible:p,onClose:()=>{m(!1),x(null),f("")},title:"Workflow Manager",resizable:!0,initialSize:{width:420,height:450},triggerPosition:w??void 0,children:o.jsxs("div",{className:"flex flex-col space-y-2 p-2 flex-1 h-full overflow-scroll","data-test":"manager-content ",children:[o.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b","data-test":"toolbar-row",children:[o.jsxs(Ts,{children:[o.jsx(Ms,{asChild:!0,children:o.jsxs(Y,{"data-test":"workflow-export-dropdown",variant:"outline",size:"sm",className:"flex-1",children:[o.jsx(Ln,{className:"h-3 w-3 mr-1"}),"Export",o.jsx(Dt,{className:"h-3 w-3 ml-1"})]})}),o.jsxs(Ds,{style:{zIndex:He.skipLink},children:[o.jsxs(at,{"data-test":"workflow-export-selected",onClick:P,children:["Export Selected (",y.size,")"]}),o.jsxs(at,{"data-test":"workflow-export-all",onClick:F,children:["Export All (",e.length,")"]})]})]}),o.jsxs(Y,{"data-test":"workflow-import-button",variant:"outline",size:"sm",className:"flex-1",onClick:U,title:"Import workflows from JSON",children:[o.jsx(vn,{className:"h-3 w-3 mr-1"}),"Import"]}),o.jsx("input",{"data-test":"workflow-import-file-input",ref:C,type:"file",accept:".json",onChange:L,className:"hidden"})]}),y.size>0&&o.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b bg-primary/5 p-1.5 rounded","data-test":"bulk-toolbar",children:[o.jsxs("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:[y.size," selected"]}),o.jsxs(Ts,{children:[o.jsx(Ms,{asChild:!0,children:o.jsxs(Y,{"data-test":"workflow-bulk-actions-dropdown",variant:"ghost",size:"sm",className:"flex-1",children:[o.jsx(Dt,{className:"h-3 w-3 mr-1"}),"Bulk Actions"]})}),o.jsxs(Ds,{style:{zIndex:He.skipLink},children:[o.jsx(qa,{children:"Bulk Operations"}),o.jsx(gs,{}),o.jsxs(at,{"data-test":"workflow-bulk-duplicate",onClick:oe,children:[o.jsx(Gt,{className:"h-3 w-3 mr-2"}),"Duplicate"]}),o.jsxs(at,{"data-test":"workflow-bulk-delete",onClick:ee,children:[o.jsx(Yt,{className:"h-3 w-3 mr-2"}),"Delete"]}),o.jsx(gs,{}),o.jsxs(at,{"data-test":"workflow-bulk-add-tags",onClick:ge,children:[o.jsx(xn,{className:"h-3 w-3 mr-2"}),"Add Tags"]}),o.jsxs(at,{"data-test":"workflow-bulk-remove-tags",onClick:me,children:[o.jsx(xn,{className:"h-3 w-3 mr-2"}),"Remove Tags"]}),o.jsx(gs,{}),o.jsxs(at,{"data-test":"workflow-bulk-stats",onClick:be,children:[o.jsx(Xi,{className:"h-3 w-3 mr-2"}),"Show Statistics"]})]})]})]}),e.length>0&&o.jsxs("div",{className:"flex items-center gap-2 px-2 py-1","data-test":"select-all-row",children:[o.jsx($e,{"data-test":"workflow-select-all-checkbox",checked:Fe,onCheckedChange:q,className:"h-4 w-4","aria-label":"Select all workflows"}),o.jsx("span",{className:"text-xs text-muted-foreground",children:Fe?"Deselect All":"Select All"})]}),o.jsx(Un,{className:"tree-scroll-area flex-1",children:o.jsx("div",{className:"space-y-1 pr-2","data-test":"tree-container",children:o.jsx(th,{data:A,onItemClick:E,onUpdate:D,onDelete:O,defaultExpandedIds:k,selectedId:n,deleteConfirmMessage:M,dropdownZIndex:He.skipLink,moreOptionsItems:H=>{var te,de,xe;if(((te=H.data)==null?void 0:te.type)==="canvas-workflow")return[{id:"save",label:"Save Workflow",icon:o.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:Se=>{try{const z=R.saveWorkflow({nodeId:Se.data.nodeId});ce.success("Workflow saved",{description:`"${z.name}" saved as version ${z.version}`})}catch(z){ce.error("Failed to save workflow",{description:z instanceof Error?z.message:"Unknown error"})}}}];if(((de=H.data)==null?void 0:de.type)==="preset-workflow"){const Se=async(z,V)=>{var K,J,se,X,ne,we;try{const Ne=u["workflow-templates-project"];if(!Ne)throw new Error("Workflow Templates project not found");let le=null,ue=[];if(Object.values(Ne.workspaces).forEach(Ye=>{Object.values(Ye.canvases).forEach(Ve=>{const gt=Ve.coreState.nodes.find(Ze=>Ze.id===z.data.nodeId);gt&&(le=JSON.parse(JSON.stringify(gt)),ue=Ve.coreState.arrows||[])})}),!le)throw new Error("Preset workflow not found");(J=(K=le.data)==null?void 0:K.parameters)!=null&&J.rows&&le.data.parameters.rows.forEach(Ye=>{Ye.children&&Ye.children.forEach(Ve=>{var gt;Ve.stepType==="nodeUpdate"&&((gt=Ve.config)!=null&&gt.simpleFieldUpdates)&&Ve.config.simpleFieldUpdates.forEach(Ze=>{const Ca=Ze.field;Ze.field=V,Ze.template&&(Ze.template=Ze.template.replace(new RegExp(`loop\\.current\\.${Ca}`,"g"),`loop.current.${V}`))})})});const ye=_.getState(),ke=((se=ye.projectCanvas.getActive())==null?void 0:se.coreState.nodes)||[],fe=((X=ye.projectCanvas.getActive())==null?void 0:X.coreState.selectedNodes)||[],pe=((ne=ye.projectCanvas.getActive())==null?void 0:ne.coreState.arrows)||[],he=fe.length>0?fe:ke,Re=new Kn,Te=[...he,le],Ae=[...pe,...ue];Re.loadWorkflow(Te,Ae);const Me=await Re.executeWorkflow(le.id);if(Me.success){if(Me.nodeUpdates&&Me.nodeUpdates.length>0){const Ve=Me.nodeUpdates.map(({nodeId:gt,updates:Ze})=>({id:gt,...Ze}));ye.updateNodes(Ve)}const Ye=fe.length>0?"selected":"all";ce.success("Workflow applied",{description:`Applied "${le.title||"workflow"}" to ${V} of ${((we=Me.nodeUpdates)==null?void 0:we.length)||0} ${Ye} nodes`})}else ce.error("Workflow execution failed",{description:Me.errors.map(Ye=>Ye.message).join(", ")||"Unknown error"})}catch(Ne){ce.error("Failed to apply workflow",{description:Ne instanceof Error?Ne.message:"Unknown error"})}};return[{id:"apply",label:"Apply Workflow",icon:o.jsx(Ut,{className:"h-4 w-4 mr-2"}),subItems:Za.map(z=>({id:z,label:Ja[z],onClick:async V=>Se(V,z)}))},{id:"copy",label:"Copy to Canvas",icon:o.jsx(Gt,{className:"h-4 w-4 mr-2"}),onClick:z=>{try{const V=u["workflow-templates-project"];if(!V)throw new Error("Workflow Templates project not found");let K=null;if(Object.values(V.workspaces).forEach(X=>{Object.values(X.canvases).forEach(ne=>{const we=ne.coreState.nodes.find(Ne=>Ne.id===z.data.nodeId);we&&(K=we)})}),!K)throw new Error("Preset workflow not found");const J=_.getState(),se={...K,id:`copied-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,x:150,y:150};J.addNode(se),ce.success("Preset copied",{description:"Workflow preset copied to current canvas"})}catch(V){ce.error("Failed to copy preset",{description:V instanceof Error?V.message:"Unknown error"})}}}]}return((xe=H.data)==null?void 0:xe.type)==="definition"?[{id:"apply",label:"Apply Workflow",icon:o.jsx(Ut,{className:"h-4 w-4 mr-2"}),onClick:async Se=>{var z,V,K,J,se;try{const X=e.find(pe=>pe.id===Se.id);if(!X)throw new Error("Workflow definition not found");const ne=_.getState(),we=((z=ne.projectCanvas.getActive())==null?void 0:z.coreState.nodes)||[],Ne=((V=ne.projectCanvas.getActive())==null?void 0:V.coreState.selectedNodes)||[],le=Ne.length>0?Ne:we;if(le.length===0){ce.error("No nodes to apply workflow to");return}const ue=new Kn,ye=((K=X.nodes)==null?void 0:K.map((pe,he)=>{var Re,Te;return{id:pe.id,label:((Re=pe.parameters)==null?void 0:Re.label)||`Step ${he+1}`,order:((Te=pe.parameters)==null?void 0:Te.order)||he+1,stepType:pe.type,config:pe.parameters||{}}}))||[],ke={id:`temp-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:X.name,content:"",x:0,y:0,width:400,height:300,data:{nodeType:"workflowOrchestration",parameters:{rows:ye}}};ue.loadWorkflow([...le,ke],[]);const fe=await ue.executeWorkflow(ke.id);if(fe.success){if(fe.nodeUpdates&&fe.nodeUpdates.length>0)for(const{nodeId:pe,updates:he}of fe.nodeUpdates)ne.updateNode(pe,he);ce.success("Workflow applied",{description:`Applied "${X.name}" to ${((J=fe.nodeUpdates)==null?void 0:J.length)||0} nodes`})}else ce.error("Workflow execution failed",{description:((se=fe.errors)==null?void 0:se.map(pe=>pe.message).join(", "))||"Unknown error"})}catch(X){ce.error("Failed to apply workflow",{description:X instanceof Error?X.message:"Unknown error"})}}},{id:"load",label:"Load to Canvas",icon:o.jsx(Ki,{className:"h-4 w-4 mr-2"}),onClick:Se=>{try{R.loadWorkflow({definitionId:Se.id,position:{x:100,y:100}}),ce.success("Workflow loaded",{description:"Loaded workflow to canvas at position (100, 100)"})}catch(z){ce.error("Failed to load workflow",{description:z instanceof Error?z.message:"Unknown error"})}}}]:null},renderNode:(H,te,de,xe)=>{var Se,z;return((Se=H.data)==null?void 0:Se.type)==="section"?o.jsx("div",{className:"flex items-center gap-2 w-full",children:o.jsx("div",{className:"flex-1 font-semibold",children:xe})}):((z=H.data)==null?void 0:z.type)==="definition"?o.jsxs("div",{className:"flex items-center gap-2 w-full",children:[o.jsx($e,{"data-test":"workflow-definition-checkbox",checked:y.has(H.id),onCheckedChange:()=>G(H.id),className:"h-4 w-4 flex-shrink-0",onClick:V=>V.stopPropagation()}),o.jsx("div",{className:"flex-1",children:xe})]}):xe}})})}),g?T(g):o.jsxs("div",{className:"flex items-center gap-1 pt-2 border-t","data-test":"add-buttons-row",children:[o.jsxs(Y,{"data-test":"workflow-add-definition-button",variant:"outline",size:"sm",className:"add-definition-button flex-1",onClick:()=>x("definition"),title:"Add Workflow Definition",children:[o.jsx(Tt,{className:"h-3 w-3 mr-1"})," Workflow"]}),n&&o.jsxs(Y,{"data-test":"workflow-add-instance-button",variant:"outline",size:"sm",className:"add-instance-button flex-1",onClick:()=>x("instance"),title:"Add Workflow Instance",children:[o.jsx(Tt,{className:"h-3 w-3 mr-1"})," Instance"]})]})]})})]})},va=e=>{const{className:t,style:n,children:s,position:r="left"}=e;return o.jsx("div",{className:ve("p-2 bg-background border shadow flex flex-col items-center space-y-2 pointer-events-auto rounded",t),style:{...n},onMouseDown:a=>a.stopPropagation(),"data-test":`canvas-vertical-toolbar-${r}`,children:s})},oh=e=>{const{className:t,style:n}=e;return o.jsxs(va,{className:t,style:n,position:"left",children:[o.jsx(xa,{}),o.jsx(sh,{})]})};function rh({title:e}){return o.jsx("div",{"data-test":`section-${e.toLowerCase().replace(/\s+/g,"-")}`,className:"border-b pb-1 mb-3",children:o.jsx("h3",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:e})})}function ah(){const e=async s=>{Z.persistState=!!s.persistState,Z.autosave=!!s.autosave,Z.hideOverlay=!!s.hideOverlay,Z.hideToolbar=!!s.hideToolbar,Z.arrows.type=s.arrowType,Z.arrows.REVERSE_CURVE=!!s.arrowReverseCurve,Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=Number(s.arrowSShapeFactor),Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=!!s.arrowSShapeReversed,Z.arrows.CUBIC_HORIZONTAL_BIAS=Number(s.arrowHorizontalBias),Z.arrows.reverseArrowOnMultipleConnect=!!s.arrowReverseOnMultipleConnect,Z.nodeOptions.maxNodeWidth=Number(s.nodeMaxWidth),Z.nodeOptions.resizeBorderWidth=Number(s.nodeResizeBorderWidth),Z.zoom.min=Number(s.zoomMin),Z.zoom.max=Number(s.zoomMax),Z.zoom.intensity=Number(s.zoomIntensity),_.setState(r=>{var a;return{...r,preferences:{...r.preferences,canvasConfig:{...(a=r.preferences)==null?void 0:a.canvasConfig,persistState:!!s.persistState,autosave:!!s.autosave,hideOverlay:!!s.hideOverlay,hideToolbar:!!s.hideToolbar,arrows:{type:s.arrowType,REVERSE_CURVE:!!s.arrowReverseCurve,CUBIC_ARROW_S_SHAPE_FACTOR:Number(s.arrowSShapeFactor),CUBIC_ARROW_S_SHAPE_REVERSED:!!s.arrowSShapeReversed,CUBIC_HORIZONTAL_BIAS:Number(s.arrowHorizontalBias),reverseArrowOnMultipleConnect:!!s.arrowReverseOnMultipleConnect},nodeOptions:{maxNodeWidth:Number(s.nodeMaxWidth),resizeBorderWidth:Number(s.nodeResizeBorderWidth)},zoom:{min:Number(s.zoomMin),max:Number(s.zoomMax),intensity:Number(s.zoomIntensity)}}},uiState:{...r.uiState,isOverlayVisible:!s.hideOverlay,toolbar:{...r.uiState.toolbar,isVisible:!s.hideToolbar}}}}),ce.success("Settings saved!",{description:"Canvas configuration has been updated.",duration:3e3})},t=[{title:"Persistence",fields:[{name:"persistState",label:"Persist State",type:"checkbox"},{name:"autosave",label:"Autosave",type:"checkbox"}]},{title:"UI",fields:[{name:"hideOverlay",label:"Hide Overlay",type:"checkbox"},{name:"hideToolbar",label:"Hide Toolbar",type:"checkbox"}]},{title:"Arrows",fields:[{name:"arrowType",label:"Type",type:"select",options:Qa.map(s=>({value:s,label:ei[s]}))},{name:"arrowSShapeFactor",label:"S-Shape Factor",type:"number",placeholder:"0-2",step:.1},{name:"arrowHorizontalBias",label:"Horizontal Bias",type:"number",placeholder:"0=auto, 1=none",step:.1},{name:"arrowReverseCurve",label:"Reverse Curve",type:"checkbox"},{name:"arrowSShapeReversed",label:"S-Shape Reversed",type:"checkbox"},{name:"arrowReverseOnMultipleConnect",label:"Reverse on Multiple Connect",type:"checkbox"}]},{title:"Nodes",fields:[{name:"nodeMaxWidth",label:"Max Width (px)",type:"number",placeholder:"100-2000"},{name:"nodeResizeBorderWidth",label:"Resize Border Width (px)",type:"number",placeholder:"1-50"}]},{title:"Zoom",fields:[{name:"zoomMin",label:"Min",type:"number",placeholder:"0.01-1"},{name:"zoomMax",label:"Max",type:"number",placeholder:"1-10"},{name:"zoomIntensity",label:"Intensity",type:"number",placeholder:"0.01-1"}]}],n={persistState:Z.persistState,autosave:Z.autosave,hideOverlay:Z.hideOverlay,hideToolbar:Z.hideToolbar,arrowType:Z.arrows.type,arrowReverseCurve:Z.arrows.REVERSE_CURVE,arrowSShapeFactor:Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,arrowSShapeReversed:Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,arrowHorizontalBias:Z.arrows.CUBIC_HORIZONTAL_BIAS,arrowReverseOnMultipleConnect:Z.arrows.reverseArrowOnMultipleConnect,nodeMaxWidth:Z.nodeOptions.maxNodeWidth,nodeResizeBorderWidth:Z.nodeOptions.resizeBorderWidth,zoomMin:Z.zoom.min,zoomMax:Z.zoom.max,zoomIntensity:Z.zoom.intensity};return o.jsx(Un,{className:"h-full",children:o.jsx(Nl,{onSubmit:e,defaultValues:n,className:"p-3 space-y-4",formId:"canvas-settings-form",children:t.map(s=>o.jsxs("div",{"data-test":`settings-section-${s.title.toLowerCase()}`,children:[o.jsx(rh,{title:s.title}),o.jsx(Cl,{fields:s.fields,layout:"two-column",className:"space-y-2",labelClassName:"text-xs"})]},s.title))})})}const hr=[],ih=[],lh=({isVisible:e,onClose:t})=>{const n=B(x=>{var p;return((p=x.projectCanvas.getActive())==null?void 0:p.coreState.selectedNodes)??hr}),s=B(x=>{var p;return((p=x.projectCanvas.getActive())==null?void 0:p.coreState.nodes)??hr}),r=B(x=>{var p;return((p=x.projectCanvas.getActive())==null?void 0:p.coreState.arrows)??ih}),a=B(x=>{var p;return(p=x.preferences)==null?void 0:p.canvasConfig}),i=B(x=>x.updateNode),l=n.length>0,c=v.useMemo(()=>{if(!l)return r;const x=new Set(n.map(p=>p.id));return r.filter(p=>p.startNodeId&&p.endNodeId&&x.has(p.startNodeId)&&x.has(p.endNodeId))},[l,n,r]),d=v.useCallback(x=>{const p=l?n:s,m=c,w={nodes:p};return m.length>0&&(w.arrows=m),x&&a&&(w.canvasConfig=a),w},[l,n,s,c,a]),u=v.useMemo(()=>{const x=Math.round(window.innerWidth*.85),p=Math.round(window.innerHeight*.85),m=Math.round((window.innerWidth-x)/2),w=Math.round((window.innerHeight-p)/2);return{initialSize:{width:x,height:p},triggerPosition:{x:m,y:w}}},[]),h=v.useCallback(x=>{const p=Array.isArray(x)?x:x.nodes;Array.isArray(p)&&p.forEach(m=>{m&&m.id&&i(m.id,m)})},[i]),f=c.length,g=l?`Selected Nodes (${n.length})${f>0?` + Arrows (${f})`:""}`:`All Canvas (${s.length} nodes, ${r.length} arrows)`;return o.jsx(rs,{storageKey:"json-viewer-config",initialConfig:{includeCanvasConfig:!1},children:(x,p,m)=>{const w=d(x.includeCanvasConfig),S=()=>{navigator.clipboard.writeText(JSON.stringify(w,null,2)),ce.success("Copied to clipboard")};return o.jsx(ut,{isVisible:e,onClose:t,title:g,resizable:!0,initialSize:u.initialSize,shouldCloseManually:!0,triggerPosition:u.triggerPosition,headerActions:o.jsxs("div",{className:"flex items-center gap-1","data-test":"json-viewer-header-actions",children:[o.jsx(m,{title:"JSON Viewer Settings",contentClassName:"w-64",contentStyle:{zIndex:He.draggablePopoverDropdown},children:o.jsxs("div",{className:"flex items-center space-x-2","data-test":"include-canvas-config-option",children:[o.jsx($e,{id:"includeCanvasConfig",checked:x.includeCanvasConfig,onCheckedChange:y=>p(j=>({...j,includeCanvasConfig:!!y})),"data-test":"include-canvas-config-checkbox"}),o.jsx(it,{htmlFor:"includeCanvasConfig",className:"text-xs cursor-pointer",children:"Include Canvas configuration"})]})}),o.jsx("button",{type:"button",className:"p-1 rounded hover:bg-accent transition-colors",onClick:y=>{y.stopPropagation(),S()},onMouseDown:y=>y.stopPropagation(),"aria-label":"Copy JSON",title:"Copy","data-test":"json-viewer-copy-button",children:o.jsx(Gt,{size:14})})]}),children:o.jsx(bl,{data:w,onDataChange:h})})}})},ch=()=>{const e=_.getState(),t=e.exportCanvasData,n=e.importCanvasData,s=v.useRef(null),[r,a]=v.useState(!1),[i,l]=v.useState(!1),[c,d]=v.useState(null),u=()=>{var f;(f=s.current)==null||f.click()},h=f=>{var p;const g=(p=f.target.files)==null?void 0:p[0];if(!g)return;a(!0),d(null);const x=new FileReader;x.onload=m=>{var S;const w=(S=m.target)==null?void 0:S.result;if(typeof w=="string"){const y=n(w,{replace:i});d(y),y.projectsImported>0&&ce.success(`Successfully imported ${y.projectsImported} project${y.projectsImported>1?"s":""}`),y.projectsSkipped>0&&ce.warning(`Skipped ${y.projectsSkipped} project${y.projectsSkipped>1?"s":""} (already exist)`),y.projectsImported===0&&y.projectsSkipped===0&&ce.error("No projects found in the import file")}else console.error("Failed to read file content."),ce.error("Failed to read file content");a(!1),s.current&&(s.current.value="")},x.onerror=m=>{console.error("Error reading file:",m),ce.error("Error reading file"),a(!1),s.current&&(s.current.value="")},x.readAsText(g)};return o.jsxs("div",{className:"space-y-4","data-test":"data-io-panel",children:[o.jsxs("div",{"data-test":"data-export-section",children:[o.jsx(it,{className:"text-sm font-medium",children:"Export"}),o.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download all canvas projects as JSON"}),o.jsxs(Y,{variant:"outline",size:"sm",onClick:t,className:"w-full","data-test":"canvas-export-button",children:[o.jsx(qi,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),o.jsxs("div",{"data-test":"data-import-section",children:[o.jsx(it,{className:"text-sm font-medium",children:"Import"}),o.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import canvas projects from a JSON file"}),o.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"canvas-replace-mode-control",children:[o.jsxs("div",{children:[o.jsx(it,{htmlFor:"canvas-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),o.jsx(ti,{id:"canvas-replace-mode",checked:i,onCheckedChange:l,disabled:r,"data-test":"canvas-replace-mode-switch"})]}),o.jsxs(Y,{variant:"outline",size:"sm",onClick:u,disabled:r,className:"w-full","data-test":"canvas-import-select-file-button",children:[o.jsx(Zi,{className:"h-4 w-4 mr-2"}),r?"Importing...":"Select File"]}),o.jsx("input",{type:"file",ref:s,accept:".json",style:{display:"none"},onChange:h,"data-test":"canvas-import-file-input"})]}),c&&o.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"canvas-import-result",children:[c.projectsImported>0&&o.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"canvas-imported-count",children:[o.jsx(Fs,{className:"h-3 w-3"}),o.jsxs("span",{children:["Imported: ",c.projectsImported]})]}),c.projectsSkipped>0&&o.jsxs("div",{className:"flex items-center gap-2 text-xs text-yellow-600","data-test":"canvas-skipped-count",children:[o.jsx(Yn,{className:"h-3 w-3"}),o.jsxs("span",{children:["Skipped: ",c.projectsSkipped]})]}),c.projectsImported===0&&c.projectsSkipped===0&&o.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"canvas-no-projects",children:[o.jsx(Yn,{className:"h-3 w-3"}),o.jsx("span",{children:"No projects found"})]})]})]})},dh=()=>o.jsx(rs,{storageKey:"canvas-data-io",title:"Data Import/Export",icon:o.jsx(eo,{className:"h-5 w-5"}),variant:"outline",size:"icon",buttonClassName:"h-10 w-10",contentClassName:"w-72",side:"left",align:"end",children:o.jsx(ch,{})}),uh=()=>{const[e,t]=v.useState(()=>{var s;return((s=No.getState().ui)==null?void 0:s.keyboardLanguage)??"english"}),n=s=>{t(s),No.update("ui",{keyboardLanguage:s})};return o.jsxs("div",{className:"space-y-3","data-test":"keyboard-language-panel",children:[o.jsx(it,{className:"text-sm font-medium",children:"Keyboard Language"}),o.jsxs(jl,{value:e,onValueChange:n,className:"space-y-2",children:[o.jsxs("div",{className:"flex items-center space-x-2","data-test":"keyboard-lang-english",children:[o.jsx(fs,{value:"english",id:"lang-english"}),o.jsx(it,{htmlFor:"lang-english",className:"cursor-pointer",children:"English"})]}),o.jsxs("div",{className:"flex items-center space-x-2","data-test":"keyboard-lang-viet",children:[o.jsx(fs,{value:"viet",id:"lang-viet"}),o.jsx(it,{htmlFor:"lang-viet",className:"cursor-pointer",children:"Viet"})]}),o.jsxs("div",{className:"flex items-center space-x-2","data-test":"keyboard-lang-german",children:[o.jsx(fs,{value:"german",id:"lang-german"}),o.jsx(it,{htmlFor:"lang-german",className:"cursor-pointer",children:"German"})]})]})]})},gh=()=>o.jsx(rs,{storageKey:"canvas-keyboard-lang",title:"Keyboard Language",icon:o.jsx(Ji,{className:"h-5 w-5"}),variant:"outline",size:"icon",buttonClassName:"h-10 w-10",contentClassName:"w-48",side:"left",align:"end",children:o.jsx(uh,{})}),fh=[],hh=()=>{const[e,t]=v.useState(!1),[n,s]=v.useState("move"),[r,a]=v.useState(null),i=v.useRef(null),l=B(m=>{var w;return((w=m.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??fh}),c=B(m=>{var w;return(w=m.projectCanvas.getActive())==null?void 0:w.id}),d=B(m=>m.copyNodesToCanvas),u=B(m=>m.moveNodesToCanvas),h=l.length===0,f=()=>{if(!h){if(i.current){const m=i.current.getBoundingClientRect();a({x:m.left-320-16,y:Math.max(16,m.top+m.height/2-400/2)})}t(!0)}},g=m=>{const w=l.map(y=>y.id),S={nodeIds:w,targetCanvasId:m.canvasId,targetWorkspaceId:m.workspaceId,targetProjectId:m.projectId};n==="copy"?(d(S),ce.success(`Copied ${w.length} node${w.length>1?"s":""} to "${m.canvasName}"`)):(u(S),ce.success(`Moved ${w.length} node${w.length>1?"s":""} to "${m.canvasName}"`)),t(!1)},x=()=>{t(!1)},p=o.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-move-nodes-title",children:[o.jsx(Y,{variant:n==="move"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>s("move"),"data-test":"canvas-move-nodes-move-option",children:"Move"}),o.jsx(Y,{variant:n==="copy"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>s("copy"),"data-test":"canvas-move-nodes-copy-option",children:"Copy"}),o.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:[l.length," node",l.length!==1?"s":""]})]});return o.jsxs(o.Fragment,{children:[o.jsx(Nt,{delayDuration:300,children:o.jsxs(Ct,{children:[o.jsx(bt,{asChild:!0,children:o.jsx(Y,{ref:i,variant:"outline",size:"icon",disabled:h,className:"h-10 w-10",onClick:f,"data-test":"canvas-move-nodes-button",title:"Move/copy nodes",children:o.jsx(Qi,{className:"h-5 w-5"})})}),o.jsx(jt,{children:o.jsx("p",{children:h?"Select nodes to move/copy":"Move/copy nodes to canvas"})})]})}),o.jsx(xa,{onCanvasSelected:g,excludeCanvasId:c,selectionModeTitle:p,isOpen:e,onClose:x,popoverPosition:r})]})},ph=[],mh=10,xh={content:!0,title:!0,id:!1,type:!1,tags:!1},wh=e=>{if(e.title)return e.title;if(typeof e.content=="string"){const t=e.content.split(`
`)[0];return t.length>50?t.substring(0,50)+"...":t||"(empty)"}return"(empty)"},vh=(e,t,n,s)=>{if(!t.trim())return!0;const r=n?t:t.toLowerCase(),a=i=>i?(n?i:i.toLowerCase()).includes(r):!1;if(s.content&&typeof e.content=="string"&&a(e.content)||s.title&&a(e.title)||s.id&&a(e.id)||s.type&&a(e.type))return!0;if(s.tags&&e.tags&&e.tags.length>0){const i=e.tags.map(l=>typeof l=="string"?l:l.title).join(", ");if(a(i))return!0}return!1},Sh=()=>{const[e,t]=v.useState(!1),[n,s]=v.useState(null),[r,a]=v.useState(""),[i,l]=v.useState(!1),[c,d]=v.useState(xh),[u,h]=v.useState(!1),[f,g]=v.useState([]),[x,p]=v.useState("nodes"),m=v.useRef(null),w=B(M=>{var $;return(($=M.projectCanvas.getActive())==null?void 0:$.coreState.nodes)??ph}),S=i||c.id||c.type||c.tags||!c.content||!c.title,y=v.useMemo(()=>r.trim()?Object.values(c).some($=>$)?w.filter($=>vh($,r,i,c)):[]:w,[w,r,i,c]),j=v.useMemo(()=>w.filter(M=>M.isCollapsed).length,[w]),N=v.useMemo(()=>w.filter(M=>!M.isCollapsed).length,[w]),C=v.useMemo(()=>f.map(M=>w.find($=>$.id===M)).filter(M=>M!==void 0).slice(0,5),[f,w]),I=()=>{if(m.current){const M=m.current.getBoundingClientRect();s({x:M.left-360-16,y:Math.max(16,M.top+M.height/2-450/2)})}t(!0)},R=()=>{t(!1),p("nodes")},A=v.useCallback(M=>{g($=>{const P=$.filter(F=>F!==M);return[M,...P].slice(0,mh)})},[]),k=v.useCallback(M=>{const $=_.getState(),P=w.find(F=>F.id===M);P&&($.updateNode(M,{isCollapsed:!P.isCollapsed}),A(M))},[w,A]),b=v.useCallback(()=>{const M=_.getState();(r.trim()?y:w).forEach(P=>{P.isCollapsed||(M.updateNode(P.id,{isCollapsed:!0}),A(P.id))})},[w,y,r,A]),T=v.useCallback(()=>{const M=_.getState();(r.trim()?y:w).forEach(P=>{P.isCollapsed&&(M.updateNode(P.id,{isCollapsed:!1}),A(P.id))})},[w,y,r,A]),E=v.useCallback(M=>{ls(M)},[]),D=x==="recent"?"Recent":o.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-collapse-title",children:[o.jsxs(Y,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:b,"data-test":"canvas-collapse-all-button",children:[o.jsx(To,{className:"h-3 w-3 mr-1"}),"Collapse ",r.trim()?`(${y.length})`:"All"]}),o.jsxs(Y,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:T,"data-test":"canvas-expand-all-button",children:[o.jsx(Ps,{className:"h-3 w-3 mr-1"}),"Expand ",r.trim()?`(${y.length})`:"All"]})]}),O=x==="recent"?o.jsx(Y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>p("nodes"),title:"Back to Nodes","data-test":"canvas-collapse-back-button",children:o.jsx(Xn,{className:"h-3.5 w-3.5"})}):o.jsx(Y,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>p("recent"),title:"Recent Collapse/Expand History","data-test":"canvas-collapse-recent-button",children:o.jsx(ro,{className:"h-3.5 w-3.5"})});return o.jsxs(o.Fragment,{children:[o.jsx(Nt,{delayDuration:300,children:o.jsxs(Ct,{children:[o.jsx(bt,{asChild:!0,children:o.jsx(Y,{ref:m,variant:"outline",size:"icon",className:"h-10 w-10",onClick:I,"data-test":"canvas-collapse-button",title:"Collapse/expand nodes",children:o.jsx(To,{className:"h-5 w-5"})})}),o.jsx(jt,{children:o.jsxs("p",{children:["Collapse/expand nodes (",j," collapsed, ",N," expanded)"]})})]})}),o.jsx(ut,{isVisible:e,onClose:R,title:D,triggerPosition:n??void 0,shouldCloseManually:!0,resizable:!0,initialSize:{width:360,height:450},headerActions:O,children:o.jsx("div",{className:"p-3 space-y-3","data-test":"canvas-collapse-popover-content",children:x==="nodes"?o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"canvas-collapse-search-section",children:[o.jsx(wn,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"canvas-collapse-search-icon"}),o.jsx(dt,{type:"text",placeholder:"Search nodes...",value:r,onChange:M=>a(M.target.value),className:je("h-8 text-sm pl-8",r?"pr-16":"pr-10"),autoFocus:!0,"data-test":"canvas-collapse-search-input"}),r&&o.jsx(Y,{variant:"ghost",size:"icon",onClick:()=>a(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"canvas-collapse-clear-button",children:o.jsx(qe,{className:"h-3 w-3"})}),S&&o.jsx("div",{className:je("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",r?"right-16":"right-11"),"data-test":"canvas-collapse-filter-indicator"}),o.jsxs(_t,{open:u,onOpenChange:h,children:[o.jsx(Ot,{asChild:!0,children:o.jsx(Y,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"canvas-collapse-settings-button",children:o.jsx(oo,{className:"h-3.5 w-3.5"})})}),o.jsx($t,{align:"end",side:"bottom",className:"w-52",style:{zIndex:He.draggablePopoverDropdown},"data-test":"canvas-collapse-settings-panel",children:o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:"collapse-case-sensitive",checked:i,onCheckedChange:M=>l(!!M),"data-test":"canvas-collapse-case-sensitive-checkbox"}),o.jsx("label",{htmlFor:"collapse-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),o.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[o.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),o.jsx("div",{className:"space-y-1.5",children:Object.entries({content:"Content",title:"Title",id:"ID",type:"Type",tags:"Tags"}).map(([M,$])=>o.jsxs("div",{className:"flex items-center space-x-2",children:[o.jsx($e,{id:`collapse-node-${M}`,checked:c[M],onCheckedChange:P=>d(F=>({...F,[M]:!!P})),"data-test":`canvas-collapse-${M}-checkbox`}),o.jsx("label",{htmlFor:`collapse-node-${M}`,className:"text-sm cursor-pointer",children:$})]},M))})]})]})})]})]}),o.jsxs("div",{className:"stats-section flex items-center gap-2 text-xs text-muted-foreground","data-test":"canvas-collapse-stats",children:[o.jsxs(ct,{variant:"secondary","data-test":"canvas-collapse-collapsed-count",children:[j," collapsed"]}),o.jsxs(ct,{variant:"outline","data-test":"canvas-collapse-expanded-count",children:[N," expanded"]}),r.trim()&&o.jsxs("span",{"data-test":"canvas-collapse-filtered-count",children:["(",y.length," matching)"]})]}),o.jsxs("div",{className:"nodes-list-section space-y-1","data-test":"canvas-collapse-nodes-section",children:[o.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:r.trim()?`Results (${y.length})`:`All Nodes (${w.length})`}),o.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1","data-test":"canvas-collapse-nodes-list",children:[y.map(M=>o.jsx(pr,{node:M,onToggle:()=>k(M.id),onClick:()=>E(M)},M.id)),y.length===0&&r.trim()&&o.jsx("p",{className:"text-xs text-muted-foreground py-2 text-center","data-test":"canvas-collapse-no-results",children:"No nodes found"})]})]})]}):o.jsx("div",{className:"recent-view-section space-y-1","data-test":"canvas-collapse-recent-view",children:C.length>0?o.jsx("div",{className:"max-h-[350px] overflow-y-auto space-y-1","data-test":"canvas-collapse-recent-list",children:C.map(M=>o.jsx(pr,{node:M,onToggle:()=>k(M.id),onClick:()=>E(M)},M.id))}):o.jsx("p",{className:"text-xs text-muted-foreground py-8 text-center","data-test":"canvas-collapse-recent-empty",children:"No recent collapse/expand history"})})})})]})},pr=({node:e,onToggle:t,onClick:n})=>{const s=vo(e.type),r=wh(e),a=e.id.substring(0,6);return o.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded hover:bg-accent/50 group","data-test":`canvas-collapse-node-item-${e.id}`,children:[o.jsx(Y,{variant:"ghost",size:"icon",className:"h-5 w-5 flex-shrink-0",onClick:i=>{i.stopPropagation(),t()},title:e.isCollapsed?"Expand":"Collapse","data-test":`canvas-collapse-toggle-${e.id}`,children:e.isCollapsed?o.jsx(so,{className:"h-3.5 w-3.5 text-muted-foreground"}):o.jsx(Dt,{className:"h-3.5 w-3.5"})}),o.jsxs("div",{className:"flex-1 flex items-center gap-1.5 cursor-pointer min-w-0",onClick:n,"data-test":`canvas-collapse-node-info-${e.id}`,children:[s&&o.jsx("span",{className:"flex-shrink-0 text-muted-foreground",children:s}),o.jsx("span",{className:"text-xs truncate flex-1",children:r}),o.jsx("span",{className:"text-[10px] text-muted-foreground flex-shrink-0",children:a})]}),e.isCollapsed&&o.jsx(ct,{variant:"secondary",className:"text-[9px] px-1 py-0 h-4","data-test":`canvas-collapse-badge-${e.id}`,children:"collapsed"})]})},mr=380,xr=360,yh=e=>{const{className:t}=e,[n,s]=v.useState(!1),[r,a]=v.useState(!1),[i,l]=v.useState(void 0),c=d=>{const u=d.currentTarget.getBoundingClientRect();l({x:u.left-xr-16,y:(window.innerHeight-mr)/2}),s(!0)};return o.jsxs(o.Fragment,{children:[o.jsxs(va,{position:"right",className:t,children:[o.jsx(gh,{}),o.jsx(Y,{variant:"outline",size:"icon",onClick:()=>a(!0),className:"h-10 w-10","data-test":"mobile-right-toolbar-json-viewer",title:"View JSON Data",children:o.jsx(ao,{className:"h-5 w-5"})}),o.jsx(hh,{}),o.jsx(Sh,{}),o.jsx(dh,{}),o.jsx(Y,{variant:"outline",size:"icon",onClick:c,className:"h-10 w-10","data-test":"mobile-right-toolbar-settings",title:"Settings",children:o.jsx(jr,{className:"h-5 w-5"})})]}),o.jsx(ut,{isVisible:n,onClose:()=>s(!1),title:"Canvas Settings",resizable:!0,initialSize:{width:xr,height:mr},shouldCloseManually:!0,triggerPosition:i,headerActions:o.jsx("button",{type:"submit",form:"canvas-settings-form",className:"p-1 rounded hover:bg-accent transition-colors",onClick:d=>d.stopPropagation(),onMouseDown:d=>d.stopPropagation(),"aria-label":"Save settings",title:"Save","data-test":"canvas-settings-save-button",children:o.jsx(Pt,{size:14})}),children:o.jsx(ah,{})}),o.jsx(lh,{isVisible:r,onClose:()=>a(!1)})]})},Nh=2e3,wr=[],vr=[],us={offset:{x:0,y:0},scale:1,targetView:null},Ch=Be.memo(({node:e,isSelected:t})=>{const a=(typeof e.content=="string"?e.content:"").split(`
`).filter(x=>x.trim().length>0),i=e.width??200,l=e.height??100,c=Math.max(a.length,1),d=Math.min(20,l/c),u=8,h="hsl(var(--muted))",f=t?"2px solid #2563eb":"1px solid hsl(var(--border))",g="hsl(var(--foreground))";return o.jsx("div",{style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${i}px`,height:`${l}px`,backgroundColor:h,border:f,borderRadius:"4px",padding:`${u}px`,display:"flex",flexDirection:"column",gap:`${Math.min(4,d*.2)}px`,overflow:"hidden",willChange:"transform",backfaceVisibility:"hidden"},children:a.slice(0,Math.floor(l/d)).map((x,p)=>{const m=x.length,w=Math.max(...a.map(y=>y.length),1),S=Math.max(20,m/w*90);return o.jsx("div",{style:{height:`${Math.max(2,d-4)}px`,width:`${S}%`,backgroundColor:t?"#93c5fd":g,borderRadius:"2px"}},p)})})});Ch.displayName="SimplifiedNode";const Sa=Be.memo(({nodes:e,selectedNodeIds:t,selectedNodesCount:n,scale:s,offset:r})=>{const a=s<yn,i=v.useMemo(()=>{if(s>=yn)return e;const l=window.innerWidth,c=window.innerHeight,d=-r.x/s,u=-r.y/s,h=d+l/s,f=u+c/s,g=500/s;return e.filter(p=>{const m=p.x+(p.width??200),w=p.y+(p.height??100);return p.x<h+g&&m>d-g&&p.y<f+g&&w>u-g})},[e,s,r]);return a?o.jsx(o.Fragment,{children:i.map(l=>o.jsx(Js,{node:l,isSelected:t.has(l.id),selectedNodesCount:n,useSimplifiedRendering:!0},l.id))}):o.jsx(o.Fragment,{children:e.map(l=>o.jsx(Js,{node:l,isSelected:t.has(l.id),selectedNodesCount:n},l.id))})},(e,t)=>{const n=e.scale<yn,s=t.scale<yn;return!(n!==s||s&&(e.scale!==t.scale||e.offset.x!==t.offset.x||e.offset.y!==t.offset.y)||e.nodes!==t.nodes||e.selectedNodeIds!==t.selectedNodeIds||e.selectedNodesCount!==t.selectedNodesCount)});Sa.displayName="CanvasNodesRenderer";const ya=Be.memo(({nodes:e,selectedNodeIds:t})=>{const n=B(f=>{var g;return((g=f.projectCanvas.getActive())==null?void 0:g.viewState)??us}),{scale:s,offset:r}=n,a=v.useRef(0),i=v.useRef(s),[l,c]=v.useState(!1),d=v.useRef(null),u=v.useMemo(()=>e.filter(f=>!f.isPinned),[e]),h=v.useMemo(()=>e.filter(f=>f.isPinned),[e]);return v.useEffect(()=>{a.current+=1,i.current!==s&&(c(!0),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{c(!1)},200)),i.current=s},[s,l,e.length]),o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"absolute top-0 left-0 w-full h-full origin-top-left",style:{transform:`translate3d(${r.x}px, ${r.y}px, 0) scale(${s})`,zIndex:He.canvasNodes,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3},children:[o.jsx(Rh,{scale:s,offset:r}),o.jsx("div",{style:{...l&&{willChange:"transform, contents"}},children:o.jsx(Sa,{nodes:u,selectedNodeIds:t,selectedNodesCount:t.size,scale:s,offset:r})})]}),h.length>0&&o.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:He.canvasNodes+1},children:o.jsx("div",{style:{pointerEvents:"auto"},children:h.map(f=>o.jsx(Js,{node:f,isSelected:t.has(f.id),selectedNodesCount:t.size},f.id))})})]})});ya.displayName="CanvasTransformLayer";const bh=({arrows:e,selectedArrows:t})=>{const n=B(l=>{var c;return((c=l.projectCanvas.getActive())==null?void 0:c.viewState)??us}),{scale:s,offset:r}=n,a=l=>!t.some(d=>d.id===l.id)||t.length>1,i=e.filter(a);return o.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:He.canvasArrows,willChange:"transform"},children:o.jsxs("g",{transform:`translate(${r.x}, ${r.y}) scale(${s})`,style:{touchAction:"none"},children:[i.map(l=>o.jsx(ha,{arrow:l},l.id)),o.jsx(Uf,{})]})})},jh=Be.memo(bh,(e,t)=>e.arrows.length!==t.arrows.length||e.selectedArrows.length!==t.selectedArrows.length?!1:e.arrows===t.arrows&&e.selectedArrows===t.selectedArrows),kh=({selectedArrows:e})=>{const t=B(r=>{var a;return((a=r.projectCanvas.getActive())==null?void 0:a.viewState)??us}),{scale:n,offset:s}=t;return e.length!==1?null:o.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:He.canvasNodes+1,willChange:"transform"},children:o.jsx("g",{transform:`translate(${s.x}, ${s.y}) scale(${n})`,style:{touchAction:"none"},children:o.jsx(ha,{arrow:e[0]},e[0].id)})})},Ih=Be.memo(kh,(e,t)=>e.selectedArrows.length!==t.selectedArrows.length?!1:e.selectedArrows===t.selectedArrows),Na=Be.memo(()=>{const e=B(s=>{var r;return((r=s.projectCanvas.getActive())==null?void 0:r.viewState)??us}),{scale:t,offset:n}=e;return o.jsx(Kf,{scale:t,offset:n})});Na.displayName="CanvasGridLayer";const Rh=({scale:e,offset:t,x:n=0,y:s=0})=>o.jsx("div",{style:{position:"absolute",left:n*e,top:s*e,width:12,height:12,background:"darkred",borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 2px #0008",cursor:"pointer",zIndex:10,transform:"translate(-50%, -50%)",userSelect:"none"},title:`Canvas origin (${n.toFixed(1)}, ${s.toFixed(1)})`}),Ah=()=>{const e=B(N=>N.uiState),t=e==null?void 0:e.selectionBox,n=(e==null?void 0:e.isOverlayVisible)??!0;e==null||e.addNodeType;const s=e==null?void 0:e.mode,r=e==null?void 0:e.isPanning,a=v.useRef(0),i=v.useRef(performance.now());v.useEffect(()=>{a.current+=1;const N=performance.now();N-i.current>=2e3&&(a.current=0,i.current=N)});const l=B(N=>N.toggleOverlayVisibility),c=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.nodes)??wr}),d=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.selectedNodes)??wr}),u=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.arrows)??vr}),h=B(N=>{var C;return((C=N.projectCanvas.getActive())==null?void 0:C.coreState.selectedArrows)??vr}),f=B(N=>N.saveStateToLocalStorage);v.useEffect(()=>{Z.autosave&&setInterval(()=>{typeof f=="function"&&f()},Nh)},[]);const g=v.useMemo(()=>new Set(d.map(N=>N.id)),[d]),x=v.useMemo(()=>jc(c,u),[c,u]),p=v.useMemo(()=>c.filter(N=>!x.has(N.id)),[c,x]),m=v.useMemo(()=>u.filter(N=>{const C=N.startNodeId!==null&&x.has(N.startNodeId),I=N.endNodeId!==null&&x.has(N.endNodeId);return!C&&!I}),[u,x]),w=v.useMemo(()=>h.filter(N=>{const C=N.startNodeId!==null&&x.has(N.startNodeId),I=N.endNodeId!==null&&x.has(N.endNodeId);return!C&&!I}),[h,x]),S=o.jsx(Y,{variant:"outline",size:"icon",onClick:l,className:"h-7 w-7","data-prevent-canvas-click":!0,title:n?"Hide Overlay":"Show Overlay","data-test":"canvas-toggle-overlay-button",children:n?o.jsx(Fn,{className:"h-4 w-4"}):o.jsx(zt,{className:"h-4 w-4"})}),y=o.jsx("div",{className:"flex items-center space-x-2",children:S}),j=v.useMemo(()=>s===W.MOVE?r?"grabbing":"grab":"default",[s,r]);return o.jsxs("div",{className:ve("relative w-full h-full select-none"),"data-canvas-content":!0,style:{cursor:j},children:[o.jsx(Na,{}),o.jsx(jh,{arrows:m,selectedArrows:w}),o.jsx(ya,{nodes:p,selectedNodeIds:g}),o.jsx(Ih,{selectedArrows:w}),o.jsx(zf,{}),t&&o.jsx(fd,{startX:t.start.x,startY:t.start.y,endX:t.end.x,endY:t.end.y}),o.jsx(Xf,{}),o.jsx(Jc,{isContentVisible:n,topLeft:o.jsx(o.Fragment,{children:o.jsx(ed,{})}),top:y,topRight:o.jsxs(o.Fragment,{children:[o.jsx(ca,{}),o.jsx(Vf,{})]}),right:o.jsx(yh,{}),bottomRight:o.jsx("div",{className:"flex flex-col gap-2",children:o.jsx(kl,{})}),bottom:o.jsx(gd,{}),bottomLeft:n&&o.jsxs("div",{className:"flex flex-col gap-2",children:[o.jsx(wf,{}),o.jsx(vf,{})]}),left:o.jsx(oh,{})})]})},Eh=({sourceNode:e,allNodes:t,onNodeSelect:n,onClose:s,isVisible:r})=>{const[a,i]=v.useState(""),l=v.useMemo(()=>{const h=(e.highlights||[]).map(f=>f.linkedNodeId).filter(f=>f!==void 0);return t.filter(f=>h.includes(f.id))},[e.highlights,t]),c=v.useMemo(()=>{if(!a)return l;const u=a.toLowerCase();return l.filter(h=>(typeof h.content=="string"?h.content:"").toLowerCase().includes(u))},[l,a]),d=v.useMemo(()=>c.map(u=>{const h=typeof u.content=="string"?u.content:"[Complex content]",f=h.length>50?h.substring(0,50)+"...":h;return o.jsx("div",{className:"text-sm",children:f},u.id)}),[c]);return o.jsxs(ut,{isVisible:r,onClose:s,title:`Linked Nodes (${l.length})`,initialPosition:"bottom-right","data-test":"linked-nodes-popover",children:[o.jsx("div",{className:"search-field px-3 py-2 border-b border-border",children:o.jsx("input",{type:"text",className:"w-full px-2 py-1 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:"Search linked nodes...",value:a,onChange:u=>i(u.target.value)})}),o.jsx("div",{className:"linked-nodes-list overflow-hidden",children:d.length>0?o.jsx(wo,{itemList:d,maxHeight:"200px",itemStyles:"border border-border",onSelectionChange:u=>{if(u.length>0){const h=c[u[0]];h&&(n(h),s())}}}):o.jsx("div",{className:"empty-state px-3 py-4 text-sm text-muted-foreground text-center",children:a?"No matching nodes found":"No linked nodes yet"})})]})},Sr=({node:e,isChanged:t})=>{const n=e.title||e.id,s=typeof e.content=="string"?e.content:"";return o.jsxs("div",{className:`absolute border-2 ${t?"border-green-500 ring-2 ring-green-500/30":"border-black"} bg-white rounded p-1`,style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:`${Q.FONT_SIZE_MINI}px`},children:[o.jsx("div",{className:"font-semibold text-[10px] truncate",children:n}),o.jsx("div",{className:"text-[8px] text-muted-foreground truncate",children:s.substring(0,50)})]})},Th=({isVisible:e,changes:t,previewNodes:n,currentNodes:s,arrows:r,executionResult:a,onApply:i,onCancel:l})=>{const c=t.length>0,[d,u]=v.useState("canvas"),h=new Set(t.map(g=>g.nodeId)),f=v.useMemo(()=>{if(!a)return null;const g={workflow:{success:a.success,duration:`${a.duration}ms`,executedNodes:a.executedNodeCount,errors:a.errors.length},steps:[],changes:{totalNodes:t.length,updates:t.map(x=>({nodeId:x.nodeId,before:x.before,after:x.after}))}};return a.nodeStates&&a.nodeStates.forEach((x,p)=>{var m;(m=x.executionData)!=null&&m.steps&&x.executionData.steps.forEach(w=>{var y,j,N,C;const S={type:w.stepType,label:w.label,order:w.order};w.stepType==="source"?S.sourceData=x.executionData.sourceData:w.stepType==="loop"?S.items=((y=x.executionData.sourceData)==null?void 0:y.length)||0:w.stepType==="if"?(S.config=w.config,S.conditionResult=w.conditionResult,S.checkedNodes=((j=w.checkedNodes)==null?void 0:j.length)||0,S.matchedNodes=((N=w.checkedNodes)==null?void 0:N.filter(I=>I.matches).map(I=>I.nodeId))||[]):w.stepType==="nodeUpdate"&&(S.targets=((C=x.executionData.nodeUpdates)==null?void 0:C.length)||0),g.steps.push(S)})}),g},[a,t]);return o.jsx(ut,{isVisible:e,onClose:l,title:"Workflow Dry Run Results",shouldCloseManually:!0,resizable:!0,initialSize:{width:1200,height:700},children:o.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[o.jsxs("div",{className:"p-4 bg-muted border-b border-border flex items-center justify-between",children:[o.jsx("div",{className:"text-sm",children:c?o.jsxs(o.Fragment,{children:[o.jsx("strong",{children:t.length})," node",t.length!==1?"s":""," will be updated"]}):o.jsx("span",{className:"text-muted-foreground",children:"No changes to apply"})}),c&&o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsxs("button",{"data-test":"dry-run-view-canvas-button",onClick:()=>u("canvas"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="canvas"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[o.jsx(zt,{size:14}),"Canvas Preview"]}),o.jsxs("button",{"data-test":"dry-run-view-list-button",onClick:()=>u("list"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="list"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[o.jsx(el,{size:14}),"Details"]}),o.jsxs("button",{"data-test":"dry-run-view-json-button",onClick:()=>u("json"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="json"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[o.jsx(ao,{size:14}),"JSON"]})]})]}),o.jsx("div",{className:"flex-1 overflow-hidden",children:c?d==="json"?o.jsx("div",{className:"h-full overflow-auto p-4 bg-gray-50","data-test":"dry-run-json-view",children:o.jsx("pre",{className:"text-xs font-mono bg-background border border-border rounded p-4 whitespace-pre-wrap break-words",children:JSON.stringify(f,null,2)})}):d==="canvas"?o.jsxs("div",{className:"h-full flex gap-2 p-2",children:[o.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[o.jsx("div",{className:"bg-muted px-2 py-1 text-xs font-semibold border-b border-border",children:"Current State"}),o.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:s.map(g=>o.jsx(Sr,{node:g,isChanged:h.has(g.id)},g.id))})]}),o.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[o.jsx("div",{className:"bg-green-500/10 px-2 py-1 text-xs font-semibold border-b border-green-500/30 text-green-700 dark:text-green-400",children:"Preview (After Apply)"}),o.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:n.map(g=>o.jsx(Sr,{node:g,isChanged:h.has(g.id)},g.id))})]})]}):o.jsx("div",{className:"h-full overflow-y-auto p-4 space-y-4",children:t.map((g,x)=>o.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-2 bg-background",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:g.nodeId}),o.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",x+1]})]}),g.before.title!==g.after.title&&o.jsxs("div",{className:"space-y-1",children:[o.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Title"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:g.before.title||o.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),o.jsx(Et,{size:16,className:"text-muted-foreground flex-shrink-0"}),o.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:g.after.title||o.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),g.before.content!==g.after.content&&o.jsxs("div",{className:"space-y-1",children:[o.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Content"}),o.jsxs("div",{className:"flex items-start gap-2",children:[o.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20 font-mono max-h-24 overflow-y-auto",children:g.before.content?o.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:g.before.content}):o.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),o.jsx(Et,{size:16,className:"text-muted-foreground flex-shrink-0 mt-1"}),o.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20 font-mono max-h-24 overflow-y-auto",children:g.after.content?o.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:g.after.content}):o.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),(()=>{const p=Array.isArray(g.before.tags)?g.before.tags:[],m=Array.isArray(g.after.tags)?g.after.tags:[],w=p.map(j=>j.title).sort().join(", "),S=m.map(j=>j.title).sort().join(", ");return w!==S?o.jsxs("div",{className:"space-y-1","data-test":"dry-run-tags-change",children:[o.jsxs("div",{className:"text-xs font-semibold text-muted-foreground flex items-center gap-1",children:[o.jsx(xn,{size:12}),"Tags"]}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:p.length>0?o.jsx("div",{className:"flex flex-wrap gap-1",children:p.map(j=>o.jsxs("span",{className:"px-1.5 py-0.5 bg-destructive/20 rounded text-xs",children:["#",j.title]},j.id))}):o.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})}),o.jsx(Et,{size:16,className:"text-muted-foreground flex-shrink-0"}),o.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:m.length>0?o.jsx("div",{className:"flex flex-wrap gap-1",children:m.map(j=>o.jsxs("span",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-xs",children:["#",j.title]},j.id))}):o.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})})]})]}):null})()]},g.nodeId))}):o.jsx("div",{className:"text-center text-muted-foreground py-8",children:"The workflow executed successfully but made no changes to the canvas nodes."})}),o.jsxs("div",{className:"p-4 border-t border-border flex items-center justify-end gap-2",children:[o.jsxs("button",{"data-test":"dry-run-cancel-button",onClick:l,className:"px-4 py-2 text-sm border border-border rounded hover:bg-accent transition-colors flex items-center gap-2",children:[o.jsx(qe,{size:16}),"Cancel"]}),c&&o.jsxs("button",{"data-test":"dry-run-apply-button",onClick:i,className:"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors flex items-center gap-2",children:[o.jsx(pn,{size:16}),"Apply Changes"]})]})]})})},ep=({width:e,height:t,className:n,style:s})=>{var m;const r=v.useRef(null),a="cursor-default",i=v.useRef(_.getState().setCanvasDimensions),l=v.useRef(async(w=!1,S)=>{var b,T;const y=_.getState(),j=((b=y.projectCanvas.getActive())==null?void 0:b.coreState.nodes)??[],N=((T=y.projectCanvas.getActive())==null?void 0:T.coreState.arrows)??[];let C=S;if(!C){const E=j.find(D=>{var O;return((O=D.data)==null?void 0:O.nodeType)==="workflowOrchestration"});C=(E==null?void 0:E.id)||"wf-orchestration-001"}const I=new Kn;I.loadWorkflow(j,N);const R=await I.executeWorkflow(C),A=[],k=w?j.map(E=>({...E})):[];return R.nodeStates&&(R.nodeUpdates&&R.nodeUpdates.length>0&&R.nodeUpdates.forEach(E=>{const D=j.find(O=>O.id===E.nodeId);if(D){const O=Array.isArray(D.tags)?D.tags:[],M=E.updates.tags!==void 0?Array.isArray(E.updates.tags)?E.updates.tags:[]:O;if(A.push({nodeId:E.nodeId,before:{title:D.title,content:typeof D.content=="string"?D.content:void 0,tags:O},after:{title:E.updates.title!==void 0?E.updates.title:D.title,content:E.updates.content!==void 0?E.updates.content:typeof D.content=="string"?D.content:void 0,tags:M}}),w){const $=k.find(P=>P.id===E.nodeId);$&&(E.updates.title!==void 0&&($.title=E.updates.title),E.updates.content!==void 0&&($.content=E.updates.content),E.updates.tags!==void 0&&($.tags=E.updates.tags))}}w||y.updateNode(E.nodeId,E.updates)}),R.nodeStates.forEach((E,D)=>{var G,q,ee;const O=j.find(oe=>oe.id===D);if(!O)return;const M=(G=O.data)==null?void 0:G.nodeType,$=O.type,U=M==="workflowSource"||$==="WORKFLOW_SOURCE"||(M==="workflowOrchestration"||$==="WORKFLOW_ORCHESTRATION");let L=((q=E.executionData)==null?void 0:q.formattedOutput)||((ee=E.executionData)==null?void 0:ee.output)||O.content;if(L!=null&&typeof L=="object"&&(L=JSON.stringify(L,null,2)),!w){const oe={content:U?O.content:L,data:{...O.data||{},executionState:E.executionState}};y.updateNode(D,oe)}})),{...R,success:R.success,errors:R.errors||[],changes:A,previewNodes:k,currentNodes:j,arrows:N}}),[c,d]=v.useState({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null}),[u,h]=v.useState({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]});v.useEffect(()=>{const w=r.current;if(!w)return;i.current(w.offsetWidth,w.offsetHeight);const S=new ResizeObserver(y=>{for(const j of y){const{width:N,height:C}=j.contentRect;i.current(N,C)}});return S.observe(w),()=>{S.disconnect()}},[]),v.useEffect(()=>{var w;(w=r.current)==null||w.focus()},[]);const f=v.useMemo(()=>({executeWorkflow:(w,S)=>l.current(w,S),showDryRunResults:w=>{h({isVisible:!0,changes:w.changes||[],previewNodes:w.previewNodes||[],currentNodes:w.currentNodes||[],arrows:w.arrows||[],executionResult:w})},showLinkedNodesPopover:(w,S)=>{d({isVisible:!0,sourceNode:w,newlyCreatedNodeId:S||null})}}),[]),g=w=>{const{newlyCreatedNodeId:S}=c;if(S){const y=_.getState(),j=y.getNodeById(S);if(j&&typeof j.content=="string"){const C=(typeof w.content=="string"?w.content:"")+`

`+j.content;y.updateNode(w.id,{content:C}),y.deleteNodeById(S)}}},x=()=>{d({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null})},p=((m=_.getState().projectCanvas.getActive())==null?void 0:m.coreState.nodes)??[];return o.jsx(Zg,{value:f,children:o.jsx(Il,{value:r,children:o.jsxs("div",{ref:r,id:"CanvasAppV2","data-canvas-container":!0,className:ve("relative","overflow-hidden","focus:outline-none",a,n),style:{width:e,height:t,touchAction:"none",...s},tabIndex:0,children:[o.jsx(Zc,{}),o.jsx(Ah,{}),c.sourceNode&&o.jsx(Eh,{sourceNode:c.sourceNode,allNodes:p,onNodeSelect:g,onClose:x,isVisible:c.isVisible}),o.jsx(Th,{isVisible:u.isVisible,changes:u.changes,previewNodes:u.previewNodes,currentNodes:u.currentNodes,arrows:u.arrows,executionResult:u.executionResult,onApply:async()=>{h({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]}),await l.current(!1)},onCancel:()=>{h({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]})}})]})})})};export{ep as C};
