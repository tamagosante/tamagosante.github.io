const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DPqC4dt9.js","assets/react-vendor-Byz07MLO.js","assets/utils-CsrmMPoT.js","assets/radix-ui-CdiC0DQF.js","assets/ui-utils-BxIQ3qGg.js","assets/icons-Ce2OFwrV.js","assets/index-CL2k40Kh.css"])))=>i.map(i=>d[i]);
var Hd=Object.defineProperty;var Bd=(e,s,n)=>s in e?Hd(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n;var Fe=(e,s,n)=>Bd(e,typeof s!="symbol"?s+"":s,n);import{R as Ie,j as t,r as p,b as tn}from"./react-vendor-Byz07MLO.js";import{c8 as Pc,c9 as An,O as E,ca as Cs,cb as Q,cc as wt,N as Pe,K as ce,cd as js,ai as J,ce as Tt,cf as Se,cg as ys,ch as vs,ci as ht,aS as Ne,aR as Fd,aU as bs,cj as Vs,ck as Rn,cl as In,cm as qe,cn as tr,co as pt,aJ as Dc,ah as _n,cp as Oc,cq as $d,cr as xo,cs as Us,ay as Ee,a as ee,V as ve,bb as Jt,aY as Wt,aZ as Ht,a_ as Bt,ct as zd,aT as Lr,cu as Wr,z as wo,F as sr,c6 as yo,E as Lc,T as nr,bP as Wc,bQ as _d,bR as Hc,bS as Bc,bT as Fc,ac as _e,I as Re,aV as Vd,aP as Ud,az as ct,aA as lt,aB as dt,cv as Gd,cw as $c,S as gt,h as ft,i as mt,j as xt,k as Ke,aj as We,ad as vo,ae as bo,af as No,ag as Rt,L as Te,m as Yd,n as Kd,o as Hr,p as Br,cx as ts,B as tt,l as So,aX as Xd,cy as qd,bJ as Fr,bK as Zd,cz as Jd,b0 as Qd,g as Uo,b1 as eu,b2 as $r,aw as or,bc as zc,cA as vn,P as ps,$ as gs,Q as fs,cB as tu,cC as su,cD as ms,R as Kt,al as zr,av as Gs,cE as nu,cF as ou,cG as au,cH as ru,cI as iu,cJ as ra,cK as cu,cL as lu,cM as Da,cN as du,cO as _c,cP as Vc,cQ as co,cR as Uc,cS as uu,cT as hu,y as ln,cU as pu,aq as gu,cV as ia,cW as fu,cX as mu,cY as xu,cZ as Gc,u as wu,r as yu,s as vu,M as bu,w as Oa,c_ as Nu,c$ as Su,b9 as _r,d0 as Cu,d1 as ju,bD as ku,bE as Au,bF as ca,bG as la,d2 as da,d3 as Iu,aD as Tu,bU as Eu,bV as Ru,d4 as Mu,b7 as Pu,b8 as Du,d5 as Ou,d6 as Lu}from"./index-DPqC4dt9.js";import{g as Wu,c as Qe,V as bn,I as Yc,K as Hu,S as Bu,C as Fu,R as $u,a as zu,d as _u}from"./VimInputHandlerV2-CkxNomCQ.js";import{t as be}from"./utils-CsrmMPoT.js";import{a as je}from"./ui-utils-BxIQ3qGg.js";import{b5 as Vr,y as Vn,b4 as ar,as as Co,c2 as Mn,g as jt,C as Ys,az as Vu,b as Uu,I as Gu,aS as lo,bT as Go,aJ as Ns,bb as Kc,a as st,ac as Yu,N as Ku,c6 as Xu,af as Rs,T as vt,c7 as qu,c8 as Zu,a7 as Xc,Z as Ju,aR as Qu,c9 as eh,aX as Vt,c as Ks,M as rr,bs as ir,ca as qc,S as Qt,e as Pt,h as Pn,cb as Zc,br as th,cc as sh,aY as Bs,bt as Jc,a2 as yt,cd as nh,ce as cr,cf as oh,cg as ah,ch as rh,ci as ih,cj as ch,ck as lh,Q as dh,aG as sn,ab as jo,cl as lr,cm as uh,B as Qc,o as el,cn as tl,co as sl,cp as nl,cq as ol,ag as dr,cr as Dn,cs as al,ct as rl,cu as hh,L as Ur,cv as $t,cw as xs,bf as On,bg as Ln,b0 as Xs,cx as Yo,cy as La,aL as ph,cz as Gr,ae as il,bv as Un,A as Wn,J as Hn,cA as ur,cB as hr,H as cl,cC as uo,bi as Bn,cD as ll,aM as pr,l as gr,bD as gh,cE as fh,W as Ko,bu as fr,ao as rs,R as Xo,cF as mh,cG as xh,cH as wh,bL as yh,cI as vh,cJ as bh,cK as dl,cL as mr,X as $e,ar as Fn,bX as ul,cM as hl,G as Nh,aZ as Sh,bQ as Ch,O as nn,c5 as jh,a3 as Ss,b1 as qo,d as Gn,q as kh,$ as pl,E as Zt,cN as Zo,aW as Ah,a4 as Ih,U as $n,ai as Wa,bE as Th,c3 as Eh,cO as Rh,cP as gl,cQ as ko,F as Mh,cR as Yr,cS as Kr,cT as Ao,aO as Ph,z as ws,D as ho,_ as fl,b8 as Dh,cU as Oh,aa as ml,aH as Lh,b2 as Wh,cV as Hh,cW as Bh,cX as Fh,cY as $h,cZ as zh,bj as _h,bk as Vh,b_ as Uh,c_ as Gh,bV as Yh,bW as Kh,a1 as Xh,am as qh,c$ as Zh,d0 as Jh,a$ as Qh,d1 as ep,V as tp,d2 as sp,bl as np}from"./icons-Ce2OFwrV.js";import{V as Lt,E as op,D as ap}from"./logging-O1kyNMYs.js";import{U as zn}from"./UiButtonWithExpandOption-B7V__5JV.js";import{T as rp}from"./TextareaPopoverAtCursor-BhwkV6wH.js";import{d as ip,t as Xr}from"./definitionHelper-Dgu1Fu0f.js";import{D as qs}from"./DraggableCrudTree-DERsg6bO.js";import{globalFacadeRegistry as rt}from"./globalFacadeRegistry-BlelMPVg.js";import{W as Zs,S as Tn,C as cp,a as lp,N as dp,I as up,e as qr}from"./WorkflowRowItem-ZekMpZ5R.js";import{a as hp,U as pp}from"./UiDataTable-CjbthiFV.js";import{a as Zr}from"./markdownToHtml-C-4HvgxL.js";import{D as gp}from"./DragDropManager-CacIWg_Z.js";import{D as fp}from"./DraggableTree-Ccu8jD7S.js";import{u as mp}from"./useOcr-DpY88bL9.js";import{A as xp,a as wp}from"./alert-DO2xCAYp.js";import{J as xl}from"./JsonViewerApp-BHZpouoC.js";import{b as yp,c as As,e as ua,h as ha,i as pa,j as ga,C as vp,a as bp}from"./context-menu-DLQswWDd.js";import{a as Np,b as Sp}from"./easy-form-DbOekutc.js";import{S as Cp}from"./SessionSidebar-DZrJ4Dp-.js";import{u as jp,S as kp}from"./SlashCommandMenu-CxSbmk5Q.js";import{g as Ap}from"./cursorPosition-otMhJ5rZ.js";import{a as Jr}from"./string-4WCj7OpV.js";import{u as Ip,b as Tp,a as Ep}from"./react-hooks-CNdHs55p.js";const Rp=e=>e;function kt(e,s=Rp){const n=Ie.useSyncExternalStore(e.subscribe,Ie.useCallback(()=>s(e.getState()),[e,s]),Ie.useCallback(()=>s(e.getInitialState()),[e,s]));return Ie.useDebugValue(n),n}const Qr=e=>{const s=Pc(e),n=o=>kt(s,o);return Object.assign(n,s),n},nC=(e=>e?Qr(e):Qr),ks=[],F=e=>kt(E,e),Js=e=>kt(An,e),Mp=(e,s)=>e.replace(/(\d+\.\d+)/g,n=>parseFloat(n).toFixed(s)),Pp=(e,s,n)=>{var a,i;if(s===0&&n===0)return e;let o="",r=0;for(;r<e.length;){const c=e[r];if(/[A-Za-z]/.test(c)){o+=c,r++;continue}if(/[\s,]/.test(c)){o+=c,r++;continue}let l="";for(;r<e.length&&/[\d.\-+eE]/.test(e[r]);)l+=e[r],r++;if(l){const d=((i=(a=o.match(/[A-Za-z](?=[^A-Za-z]*$)/))==null?void 0:a[0])==null?void 0:i.toUpperCase())||"M",h=(o.slice(o.lastIndexOf(d)+1).match(/-?\d+\.?\d*/g)||[]).length,f=parseFloat(l);let g=f;if(d==="H")g=f+s;else if(d==="V")g=f+n;else if(d==="A"){const w=h%7;w===5?g=f+s:w===6&&(g=f+n)}else h%2===0?g=f+s:g=f+n;o+=g}}return o},Dp=(e,s)=>{if(s>=1||e.length<=2)return e;const n=Math.max(1,Math.floor(1/s)),o=[];o.push(e[0]);for(let r=n;r<e.length-1;r+=n)o.push(e[r]);return e.length>1&&o.push(e[e.length-1]),o},wl=(e,s)=>{const n=s/100,o=Math.max(0,Math.floor(s/100*4));return{points:Dp(e.points,n),smoothedPath:Mp(e.smoothedPath,o)}},yl=(e,s)=>e.type==="freehand"&&e.stroke?{...e,stroke:wl(e.stroke,s)}:e,vl=(e,s)=>{if(s>=100)return e;const n={...e};return e.stroke&&(n.stroke=wl(e.stroke,s)),e.elements&&(n.elements=e.elements.map(o=>yl(o,s))),n},bl=p.createContext(null),Op=({children:e,value:s})=>t.jsx(bl.Provider,{value:s,children:e}),xr=()=>{const e=p.useContext(bl);if(e===null)throw new Error("useCanvasRef must be used within a CanvasRefProvider");return e},Lp=e=>{const s=xr(),n=p.useRef(e);p.useEffect(()=>{n.current=e},[e]),p.useEffect(()=>{const o=s.current;if(!o)return;const r=b=>{var k,R;const S=["[data-prevent-canvas-click]"],I=b.target;S.some(A=>I.closest(A))||(R=(k=n.current.pointer)==null?void 0:k.onPointerDown)==null||R.call(k,b)},a=b=>{var R,A;const S=['[data-prevent-canvas-click="true"]'],I=b.target;if(S.some(T=>I.closest(T)))return;const k=b;(A=(R=n.current.pointer)==null?void 0:R.onDblClick)==null||A.call(R,k)},i=b=>{var S,I;return(I=(S=n.current.pointer)==null?void 0:S.onPointerMove)==null?void 0:I.call(S,b)},c=b=>{var S,I;return(I=(S=n.current.pointer)==null?void 0:S.onPointerUp)==null?void 0:I.call(S,b)},l=b=>{var S,I;return(I=(S=n.current.pointer)==null?void 0:S.onPointerLeave)==null?void 0:I.call(S,b)},d=b=>{var k,R;const S=["#itemList"],I=b.target;S.some(A=>I.closest(A))||(R=(k=n.current).wheel)==null||R.call(k,b)},u=b=>{var S,I;return(I=(S=n.current.keyboard)==null?void 0:S.onKeyDown)==null?void 0:I.call(S,b)},h=b=>{var S,I;return(I=(S=n.current.keyboard)==null?void 0:S.onKeyUp)==null?void 0:I.call(S,b)},f=b=>{var S,I;return(I=(S=n.current.keyboard)==null?void 0:S.onCopy)==null?void 0:I.call(S,b)},g=b=>{var S,I;return(I=(S=n.current.touch)==null?void 0:S.onTouchStart)==null?void 0:I.call(S,b)},w=b=>{var S,I;return(I=(S=n.current.touch)==null?void 0:S.onTouchMove)==null?void 0:I.call(S,b)},m=b=>{var S,I;return(I=(S=n.current.touch)==null?void 0:S.onTouchEnd)==null?void 0:I.call(S,b)},{pointer:x,wheel:y,touch:v,keyboard:N}=e;return x!=null&&x.onPointerDown&&o.addEventListener("pointerdown",r),x!=null&&x.onDblClick&&o.addEventListener("dblclick",a),x!=null&&x.onPointerMove&&o.addEventListener("pointermove",i),x!=null&&x.onPointerUp&&window.addEventListener("pointerup",c),x!=null&&x.onPointerLeave&&o.addEventListener("pointerleave",l),y&&o.addEventListener("wheel",d,{passive:!1}),v!=null&&v.onTouchStart&&o.addEventListener("touchstart",g,{passive:!1}),v!=null&&v.onTouchMove&&o.addEventListener("touchmove",w,{passive:!1}),v!=null&&v.onTouchEnd&&o.addEventListener("touchend",m,{passive:!1}),N!=null&&N.onKeyDown&&window.addEventListener("keydown",u),N!=null&&N.onKeyUp&&window.addEventListener("keyup",h),N!=null&&N.onCopy&&window.addEventListener("copy",f),()=>{x!=null&&x.onPointerDown&&o.removeEventListener("pointerdown",r),x!=null&&x.onPointerMove&&o.removeEventListener("pointermove",i),x!=null&&x.onPointerUp&&window.removeEventListener("pointerup",c),x!=null&&x.onPointerLeave&&o.removeEventListener("pointerleave",l),y&&o.removeEventListener("wheel",d),v!=null&&v.onTouchStart&&o.removeEventListener("touchstart",g),v!=null&&v.onTouchMove&&o.removeEventListener("touchmove",w),v!=null&&v.onTouchEnd&&o.removeEventListener("touchend",m),N!=null&&N.onKeyDown&&window.removeEventListener("keydown",u),N!=null&&N.onKeyUp&&window.removeEventListener("keyup",h)}},[s])},wr=()=>{const e=xr();return p.useCallback(s=>{const n=e.current;if(!n)return console.error("Canvas container ref not available in useGetRelativeMousePos"),{x:0,y:0};const o=n.getBoundingClientRect();return{x:s.clientX-o.left,y:s.clientY-o.top}},[e])};function Wp(e){var a,i;const s=e;if(!s){(a=window.getSelection())==null||a.removeAllRanges();return}const n=s.tagName==="TEXTAREA",o=s.tagName==="INPUT",r=s.isContentEditable||!!s.closest('[contenteditable="true"]');n||o||r||(i=window.getSelection())==null||i.removeAllRanges()}const zt=new Cs("useCanvasMouseEventsV2",js.useCanvasMouseEventsV2),Hp=e=>{const s=e.target,n=s.closest("[data-canvas-container]");return!n||s.closest("[data-ui-panel]")?null:n},Bp=()=>{p.useEffect(()=>{const e=()=>{if(document.pointerLockElement===null){const s=E.getState().uiState.mode,n=E.getState().uiState.zoomSubMode;if(s===Q.ZOOM&&n==="zoom:lock"){const o=E.getState().setZoomSubMode;o("zoom"),zt.log("Pointer lock released, reset to zoom mode")}}};return document.addEventListener("pointerlockchange",e),()=>{document.removeEventListener("pointerlockchange",e)}},[])},Fp=e=>{const s=wr(),n=Js(i=>i.setMousePosition),o=E.getState(),r=o.uiState.mode,a=o.setIsPanning;return p.useCallback(i=>{const c=s(i);n(c),zt.log("Generic Pointer Down:",c.x,c.y),Wp(i.target);const l=E.getState().uiState.mode,d=E.getState().uiState.zoomSubMode;if(l===Q.ZOOM&&i.button===0){const x=Hp(i);if(x){const y=E.getState().setZoomSubMode;d==="zoom:lock"?document.exitPointerLock():(x.requestPointerLock(),y("zoom:lock")),i.preventDefault();return}}if(!(i.button===1||i.button===0&&r===Q.MOVE||i.button===-1))return;const h=i.target,f=h.closest("[data-node-id]"),g=h.id.includes("resize-handle-"),w=h.closest("[data-ui-panel]");if(g||w)return;let m=!1;r===Q.MOVE?m=!0:f||(m=!0),m&&(zt.log("Starting Panning"),a(!0),e(c),i.preventDefault())},[s,n,a,e,r])},$p=()=>{var i;const e=wr(),s=E.getState(),n=(i=s.uiState)==null?void 0:i.isPanning,o=Js(c=>c.setMousePosition),r=s.setActiveCanvasViewState,a=Js(c=>c.mousePosition);return p.useCallback(c=>{const l=E.getState().uiState.mode,d=E.getState().uiState.zoomSubMode,u=document.pointerLockElement!==null;if(l===Q.ZOOM&&d==="zoom:lock"&&u){const g=c.movementX,w=c.movementY;r(m=>({...m,offset:{x:m.offset.x+g,y:m.offset.y+w}}));return}const f=e(c);if(n&&a){const g=f.x-a.x,w=f.y-a.y;if(c.pointerType==="touch"){o(f);return}r(m=>({...m,offset:{x:m.offset.x+g,y:m.offset.y+w}}))}o(f)},[e,o,n,a,r])},zp=e=>{var a;const s=wr(),n=E.getState(),o=(a=n.uiState)==null?void 0:a.isPanning,r=n.setIsPanning;return p.useCallback(i=>{const c=s(i);zt.log("Generic Pointer Up:",c.x,c.y),o&&(r(!1),e(null),zt.log("Stopped Panning"))},[s,o,r,e])},_p=e=>{var a;const s=E.getState(),n=(a=s.uiState)==null?void 0:a.isPanning,o=s.setIsPanning,r=Js(i=>i.setMousePosition);return p.useCallback(()=>{n&&(o(!1),e(null),zt.log("Stopped Panning (Mouse Leave)")),r(null)},[n,o,e,r])},dn={current:null},fa={current:null},ma={current:0},Vp=()=>{const e=E.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=Js(r=>r.mousePosition);return p.useCallback(r=>{r.preventDefault();const a=s();if(!a)return;const{scale:i,offset:c}=a.viewState,d=E.getState().uiState.mode===Q.ZOOM;if(r.ctrlKey||r.metaKey||d){if(!o)return;const{min:u,max:h,intensity:f}=J.zoom,g=r.deltaY<0?1:-1;let w;if(i<=.1){const C=i+g*.01;w=Math.max(u,Math.min(h,C)),w=Math.round(w*100)/100}else{const C=i+g*f*i,k=Math.max(u,Math.min(h,C));w=(g>0?Math.ceil:Math.floor)(k*10)/10}if(w===i)return;const m=wt(o,i,c),x=o.x-m.x*w,y=o.y-m.y*w,v=isNaN(x)?0:x,N=isNaN(y)?0:y,b=isNaN(w)?1:w,S=performance.now(),I=S-ma.current;dn.current={newScale:b,newOffsetX:v,newOffsetY:N},I>=16?(n(C=>({...C,scale:b,offset:{x:v,y:N}})),ma.current=S,dn.current=null):(fa.current&&clearTimeout(fa.current),fa.current=setTimeout(()=>{if(dn.current){const{newScale:C,newOffsetX:k,newOffsetY:R}=dn.current;n(A=>({...A,scale:C,offset:{x:k,y:R}})),ma.current=performance.now(),dn.current=null}},16-I))}else n(u=>{var y,v;let h=r.deltaX,f=r.deltaY;r.shiftKey&&(h=f,f=0);const g=(((y=u.offset)==null?void 0:y.x)??0)-h,w=(((v=u.offset)==null?void 0:v.y)??0)-f,m=isNaN(g)?0:g,x=isNaN(w)?0:w;return{...u,offset:{x:m,y:x}}})},[s,n,o])},Up=()=>{const e=E.getState(),s=e.uiState.mode,n=e.getCanvasMouseCoords,o=e.addNode,r=e.setNodeToFocusId;return p.useCallback(a=>{if(s!==Q.SELECT){zt.log("Double Click ignored: Not in SELECT mode.");return}if(a.target.closest("[data-node-id], [data-arrow-id], [data-test='canvas-chat-input-container'], [data-prevent-canvas-click]")){zt.log("Double Click ignored: Clicked on existing element or UI component.");return}const c=n();if(!c){zt.log("Double Click ignored: Could not get canvas coordinates.");return}zt.log("Double Click on background: Adding node at",c);const l=Pe(10);o({id:l,x:c.x,y:c.y,content:"",type:ce.TEXT}),r(l),a.preventDefault(),a.stopPropagation()},[s,n,o])},Ye={createTemporaryDrawing:(e,s,n=Tt)=>{const o=e===Se.FREEHAND;return{subMode:e,points:o?[s]:[],startPoint:o?void 0:s,endPoint:o?void 0:s,style:n}},updateFreehandPoints:(e,s)=>({...e,points:[...e.points,s]}),updateShapeEndPoint:(e,s)=>({...e,endPoint:s}),canFinalizeDraw:e=>e.subMode===Se.FREEHAND?e.points.length>=2:!e.startPoint||!e.endPoint?!1:Math.hypot(e.endPoint.x-e.startPoint.x,e.endPoint.y-e.startPoint.y)>=5,simplifyPoints:(e,s=2)=>{if(e.length<=2)return e;const n=s*s,o=(i,c,l)=>{let d=0,u=c;const h=i[c],f=i[l],g=f.x-h.x,w=f.y-h.y,m=g*g+w*w;for(let x=c+1;x<l;x++){const y=i[x];let v;if(m===0)v=(y.x-h.x)**2+(y.y-h.y)**2;else{const N=Math.max(0,Math.min(1,((y.x-h.x)*g+(y.y-h.y)*w)/m)),b=h.x+N*g,S=h.y+N*w;v=(y.x-b)**2+(y.y-S)**2}v>d&&(d=v,u=x)}return{index:u,distance:d}},r=(i,c,l,d)=>{const{index:u,distance:h}=o(i,c,l);h>n&&(d[u]=!0,r(i,c,u,d),r(i,u,l,d))},a=new Array(e.length).fill(!1);return a[0]=!0,a[e.length-1]=!0,r(e,0,e.length-1,a),e.filter((i,c)=>a[c])},smoothToSVGPath:(e,s=.5)=>{if(e.length===0)return"";if(e.length===1)return`M ${e[0].x} ${e[0].y}`;if(e.length===2)return`M ${e[0].x} ${e[0].y} L ${e[1].x} ${e[1].y}`;const n=(r,a,i,c)=>{const l=s,d=a.x+(i.x-r.x)*l/6,u=a.y+(i.y-r.y)*l/6,h=i.x-(c.x-a.x)*l/6,f=i.y-(c.y-a.y)*l/6;return`C ${d} ${u}, ${h} ${f}, ${i.x} ${i.y}`};let o=`M ${e[0].x} ${e[0].y}`;o+=" "+n(e[0],e[0],e[1],e[2]||e[1]);for(let r=1;r<e.length-2;r++)o+=" "+n(e[r-1],e[r],e[r+1],e[r+2]);if(e.length>2){const r=e.length-1;o+=" "+n(e[r-2],e[r-1],e[r],e[r])}return o},pointsToPolylinePath:e=>e.length===0?"":e.length===1?`M ${e[0].x} ${e[0].y}`:`M ${e[0].x} ${e[0].y} `+e.slice(1).map(s=>`L ${s.x} ${s.y}`).join(" "),generateShapeSVGPath:e=>{const{shapeType:s,startPoint:n,endPoint:o}=e;switch(s){case"line":return`M ${n.x} ${n.y} L ${o.x} ${o.y}`;case"rectangle":{const r=Math.min(n.x,o.x),a=Math.min(n.y,o.y),i=Math.abs(o.x-n.x),c=Math.abs(o.y-n.y);return`M ${r} ${a} h ${i} v ${c} h ${-i} Z`}case"square":{const r=Math.min(Math.abs(o.x-n.x),Math.abs(o.y-n.y)),a=o.x>=n.x?n.x:n.x-r,i=o.y>=n.y?n.y:n.y-r;return`M ${a} ${i} h ${r} v ${r} h ${-r} Z`}case"circle":{const r=(n.x+o.x)/2,a=(n.y+o.y)/2,i=Math.hypot(o.x-n.x,o.y-n.y)/2;return`M ${r-i} ${a} A ${i} ${i} 0 1 0 ${r+i} ${a} A ${i} ${i} 0 1 0 ${r-i} ${a}`}case"ellipse":{const r=Math.abs(o.x-n.x),a=Math.abs(o.y-n.y),i=o.x>=n.x?1:-1,c=o.y>=n.y?1:-1,l=n.x+i*r/2,d=n.y+c*a/2,u=r/2,h=a/2;return`M ${l-u} ${d} A ${u} ${h} 0 1 0 ${l+u} ${d} A ${u} ${h} 0 1 0 ${l-u} ${d}`}case"arrow":{const r=o.x-n.x,a=o.y-n.y,i=Math.hypot(r,a);if(i<1)return"";const c=r/i,l=a/i,d=Math.min(20,Math.max(8,i*.2)),u=d*.6,h=o.x-c*d,f=o.y-l*d,g=-l,w=c,m=h+g*u,x=f+w*u,y=h-g*u,v=f-w*u;return`M ${n.x} ${n.y} L ${h} ${f} M ${o.x} ${o.y} L ${m} ${x} L ${y} ${v} Z`}default:return""}},calculateFreehandBounds:e=>{if(e.length===0)return{x:0,y:0,width:0,height:0};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e)a.x<s&&(s=a.x),a.y<n&&(n=a.y),a.x>o&&(o=a.x),a.y>r&&(r=a.y);return{x:s,y:n,width:o-s,height:r-n}},calculateShapeBounds:(e,s,n)=>{if(n==="circle"){const c=(e.x+s.x)/2,l=(e.y+s.y)/2,d=Math.hypot(s.x-e.x,s.y-e.y)/2;return{x:c-d,y:l-d,width:d*2,height:d*2}}if(n==="square"){const c=Math.min(Math.abs(s.x-e.x),Math.abs(s.y-e.y)),l=s.x>=e.x?e.x:e.x-c,d=s.y>=e.y?e.y:e.y-c;return{x:l,y:d,width:c,height:c}}const o=Math.min(e.x,s.x),r=Math.min(e.y,s.y),a=Math.abs(s.x-e.x),i=Math.abs(s.y-e.y);return{x:o,y:r,width:a,height:i}},calculateBounds:e=>e.drawType==="freehand"&&e.stroke?Ye.calculateFreehandBounds(e.stroke.points):e.drawType==="shape"&&e.shape?Ye.calculateShapeBounds(e.shape.startPoint,e.shape.endPoint,e.shape.shapeType):{x:0,y:0,width:0,height:0},normalizePoints:(e,s)=>e.map(n=>({x:n.x-s.x,y:n.y-s.y})),finalizeDrawing:e=>{if(!Ye.canFinalizeDraw(e))return null;const s=(e.style.strokeWidth??2)/2;if(e.subMode===Se.FREEHAND){const c=Ye.calculateFreehandBounds(e.points),l={x:c.x-s,y:c.y-s},u=e.points.length>20?Ye.simplifyPoints(e.points,2):e.points,h=Ye.normalizePoints(u,l),f=Ye.smoothToSVGPath(h);return{drawType:"freehand",stroke:{points:Ye.normalizePoints(e.points,l),smoothedPath:f},style:e.style}}if(!e.startPoint||!e.endPoint)return null;const o={[Se.RECTANGLE]:"rectangle",[Se.SQUARE]:"square",[Se.CIRCLE]:"circle",[Se.ELLIPSE]:"ellipse",[Se.LINE]:"line",[Se.ARROW]:"arrow",[Se.FREEHAND]:"rectangle"}[e.subMode],r=Ye.calculateShapeBounds(e.startPoint,e.endPoint,o),a={x:r.x-s,y:r.y-s};return{drawType:"shape",shape:{shapeType:o,startPoint:{x:e.startPoint.x-a.x,y:e.startPoint.y-a.y},endPoint:{x:e.endPoint.x-a.x,y:e.endPoint.y-a.y}},style:e.style}},getSubModeFromKey:e=>{switch(e){case"1":return Se.FREEHAND;case"2":return Se.RECTANGLE;case"3":return Se.SQUARE;case"4":return Se.CIRCLE;case"5":return Se.ELLIPSE;case"6":return Se.LINE;case"7":return Se.ARROW;default:return null}},getSubModeLabel:e=>{switch(e){case Se.FREEHAND:return"Freehand";case Se.RECTANGLE:return"Rectangle";case Se.SQUARE:return"Square";case Se.CIRCLE:return"Circle";case Se.ELLIPSE:return"Ellipse";case Se.LINE:return"Line";case Se.ARROW:return"Arrow";default:return"Draw"}}};class Le{static buildTextNode(s,n,o){return{id:Pe(10),type:ce.TEXT,content:n,x:s.x,y:s.y,width:s.width,height:s.height,styles:o}}static buildTextNodeV2(s){return{id:Pe(10),type:ce.TEXT,content:s.content||"",x:s.x||0,y:s.y||0,width:s.width||100,height:s.height||100,styles:s.styles||{},options:s.options||{lockSize:!0},...s}}static buildTableNode(s){return{id:Pe(10),type:ce.TABLE,content:null,data:{columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},x:s.x,y:s.y,width:s.width||400,height:s.height||250,styles:{textAlign:"left"}}}static buildTextCardNode(s){return{id:Pe(10),type:ce.TEXTCARD,title:"",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||150,styles:{textAlign:"left"}}}static buildWorkflowOrchestrationNode(s){return{id:`wf-orchestration-${Pe(6)}`,type:ce.WORKFLOW_ORCHESTRATION,title:"Workflow",content:"",x:s.x,y:s.y,width:s.width||400,height:s.height||500,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:[{id:"row_1",label:"Step 1",order:1,stepType:"source",children:[]}]}}}}static buildWorkflowSourceNode(s){return{id:`wf-source-${Pe(6)}`,type:ce.WORKFLOW_SOURCE,title:"Source",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||200,data:{displayFormat:"raw"}}}static buildWorkflowDefinitionNode(s){return{id:`wf-def-${Pe(6)}`,type:ce.WORKFLOW_DEFINITION,title:"Workflow Runner",content:"",x:s.x,y:s.y,width:s.width||280,height:s.height||180,data:{definitionId:void 0,instanceId:void 0,lastExecutionStatus:"idle"}}}static buildOCRNode(s){return{id:`ocr-${Pe(6)}`,type:ce.OCR,title:"OCR",content:"",x:s.x,y:s.y,width:s.width||350,height:s.height||500,data:{image:void 0,extractedText:void 0,detectedLanguage:void 0,confidence:void 0}}}static buildImageNode(s){return{id:`img-${Pe(6)}`,type:ce.IMAGE,title:"Image",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||250,data:{image:void 0}}}static buildWorkflowStepNode(s){return{id:`wf-step-${Pe(6)}`,type:ce.WORKFLOW_STEP,title:"Workflow Step",content:"",x:s.x,y:s.y,width:s.width||260,height:s.height||180,data:{stepType:void 0,config:{}}}}static buildVocabularyNode(s){return{id:`vocab-${Pe(6)}`,type:ce.VOCABULARY,title:"Vocabulary",content:"",x:s.x,y:s.y,width:s.width||320,height:s.height||280,data:{vocabType:"vocabulary",term:"",definition:"",sourceWord:"",translationWord:""}}}static buildDrawingNode(s,n){return{id:`draw-${Pe(6)}`,type:ce.DRAWING,content:"",x:s.x,y:s.y,width:s.width||100,height:s.height||100,data:n}}}const Gp=Object.freeze(Object.defineProperty({__proto__:null,CanvasNodeBuilderV2:Le},Symbol.toStringTag,{value:"Module"}));function Jo(e,s,n="right",o={}){var u;const{shouldFocus:r=!0,createArrow:a=!0}=o,i=E.getState();let c=e.width,l=e.height;if(!c||!l){const h=J.nodeOptions.maxNodeWidth;c=Math.min(ys(e.content),h)+vs.textNodeXPadding,l=ht(e.content,c,e)}switch((u=i.projectCanvas.getActive())==null||u.viewState.offset,n){case"left":e.x=s.x-c-Ne.nodeSpacing*3,e.y=s.y;break;case"right":e.x=s.x+(s.width??0)+Ne.nodeSpacing*3,e.y=s.y;break;case"above":e.y=s.y-Ne.nodeSpacing*3;break;case"below":e.y=s.y+(s.height??0)+Ne.nodeSpacing;break}const d={...e,width:c,height:l};if(i.addNode(d,void 0,{dontOverlap:!0,dontSelect:!0}),r&&i.setNodeToFocusId(s.id),a){const h=()=>Math.random().toString(36).slice(2,10),f=g=>({x:(g.x??0)+(g.width??0)/2,y:(g.y??0)+(g.height??0)/2});window.setTimeout(()=>{i.arrow.add({id:h(),startNodeId:s.id,endNodeId:d.id,startPoint:f(s),endPoint:f(d)})},0)}}function Nl(e,s,n){let o=e;for(;o&&!o.hasAttribute("data-text-position-container");)o=o.parentElement;if(!o)return null;const r=window.getComputedStyle(e),a=document.createElement("div");a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.visibility="hidden",a.style.font=r.font,a.style.fontSize=r.fontSize,a.style.fontFamily=r.fontFamily,a.style.fontWeight=r.fontWeight,a.style.lineHeight=r.lineHeight,a.style.letterSpacing=r.letterSpacing,a.style.wordSpacing=r.wordSpacing,a.style.padding=r.padding,a.style.width=`${e.clientWidth}px`,a.style.border="none",a.style.whiteSpace=r.whiteSpace,a.style.wordWrap=r.wordWrap,a.style.overflowWrap=r.overflowWrap,a.textContent=e.value,o?o.appendChild(a):document.body.appendChild(a);try{const i=document.createRange(),c=a.firstChild;if(!c||c.nodeType!==Node.TEXT_NODE)return null;i.setStart(c,s),i.setEnd(c,n);const l=i.getClientRects();if(l.length===0)return null;const d=l[0],u=o==null?void 0:o.getBoundingClientRect();if(!u)return null;const h={top:d.top-u.top,left:d.left-u.left},f=parseFloat(r.paddingTop)||0,g=parseFloat(r.paddingLeft)||0,w=h.top-f,m=h.left-g;return{top:w,left:m,width:d.width,height:d.height}}finally{o&&a.parentNode===o?o.removeChild(a):a.parentNode===document.body&&document.body.removeChild(a)}}const Mt=e=>/[\w\u00C0-\u024F]/.test(e);function ei(e,s){if(!e||s<0||s>e.length)return!1;const n=e[s]||"",o=e[s-1]||"",r=Mt(o),a=Mt(n);return r&&!a||!r&&a}function Yp(e,s){if(!e||s<0||s>e.length)return null;const n=e[s]||"",o=e[s-1]||"";if(!Mt(n)&&!Mt(o))return null;let r=s;for(;r>0&&Mt(e[r-1]);)r--;let a=s;for(;a<e.length&&Mt(e[a]);)a++;return r<a?{start:r,end:a,word:e.substring(r,a)}:null}function ti(e,s){const n=Yp(e,s);return n?{start:n.start,end:n.end}:null}function si(e,s){if(!e||s<0||s>e.length)return null;let n=s;for(;n>0&&!Mt(e[n-1]);)n--;if(n===0)return null;let o=n;for(;o>0&&Mt(e[o-1]);)o--;let r=s;for(;r<e.length&&!Mt(e[r]);)r++;if(r>=e.length)return null;let a=r;for(;a<e.length&&Mt(e[a]);)a++;return{start:o,end:a}}function ni(e,s){for(;s>0&&Mt(e[s-1]);)s--;return s}function oi(e,s){for(;s<e.length&&Mt(e[s]);)s++;return s}function Kp(e,s,n){var h;const o=document.createRange(),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let a=0,i=null,c=0,l=null,d=0,u;for(;u=r.nextNode();){const f=((h=u.textContent)==null?void 0:h.length)||0;if(!i&&a+f>=s&&(i=u,c=s-a),!l&&a+f>=n){l=u,d=n-a;break}a+=f}if(i&&l)try{return o.setStart(i,c),o.setEnd(l,d),o}catch(f){return console.warn("Failed to create text range:",f),null}return null}var Ha=(e=>(e.CONTENT_CAPTURE="content-capture",e.REGULAR="regular",e))(Ha||{});const Sl=(e,s)=>{const n=new Set(s.map(o=>o.id));return e.filter(o=>o.startNodeId&&o.endNodeId&&n.has(o.startNodeId)&&n.has(o.endNodeId))},Xp=e=>e.type===ce.GROUP||e.type==="GROUP",qp=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=[...e];for(const r of e)if(Xp(r)){const a=r.data,i=(a==null?void 0:a.childNodeIds)??[];for(const c of i)if(!n.has(c)){const l=s.find(d=>d.id===c);l&&(o.push(l),n.add(c))}}return o},Zp=(e,s,n)=>{const o=Sl(s,e),r={nodes:e};return o.length>0&&(r.arrows=o),n!=null&&n.canvasConfig&&(r.canvasConfig=n.canvasConfig),r},Cl=e=>{var l;const s=E.getState(),n=s.projectCanvas.getActive();if(!n)return null;const{nodes:o,arrows:r,selectedNodes:a}=n.coreState,i=a.length>0?qp(a,o):o;if(i.length===0)return null;const c=e!=null&&e.includeConfig?(l=s.preferences)==null?void 0:l.canvasConfig:void 0;return Zp(i,r,{canvasConfig:c})},jl=async(e,s)=>{var n;try{if(await navigator.clipboard.writeText(JSON.stringify(e,null,2)),(s==null?void 0:s.showToast)!==!1){const o=(n=e.arrows)!=null&&n.length?` and ${e.arrows.length} arrow(s)`:"";be.success(`Copied ${e.nodes.length} node(s)${o}`)}return!0}catch(o){return console.error("Failed to copy to clipboard:",o),(s==null?void 0:s.showToast)!==!1&&be.error("Failed to copy to clipboard"),!1}},kl=async e=>{const s=Cl({includeConfig:e==null?void 0:e.includeConfig});return s?jl(s,{showToast:e==null?void 0:e.showToast}):(be.info("No nodes to copy"),!1)},Jp=e=>{try{const s=JSON.parse(e);if(!s)return null;const n=Array.isArray(s.nodes)&&s.nodes.length>0,o=Array.isArray(s.arrows)&&s.arrows.length>0;return n||o?s:null}catch{return null}};function Qp(e){const s=e.split(Fd);if(s.length===2)try{return{type:"content-capture",data:JSON.parse(s[1])}}catch{}const n=Jp(e);return n?{type:"content-capture",data:n}:{type:"regular",content:s[0]}}const eg={id:"noDuplicateHeaders",name:"No Duplicate Headers",description:"Warn when same header text appears multiple times",defaultSeverity:"warning",check:(e,s)=>{const n=[],o=new Map;for(let r=0;r<s.length;r++){const a=s[r].match(/^#{1,6}\s+(.+)$/);if(a){const i=a[1].trim().toLowerCase(),c=o.get(i);c!==void 0?n.push({ruleId:"no-duplicate-headers",severity:"warning",message:`Duplicate header "${a[1].trim()}" (first seen on line ${c})`,line:r+1}):o.set(i,r+1)}}return n}},tg={id:"headerIncrement",name:"Header Increment",description:"Headers should only increment by one level",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=0;r<s.length;r++){const a=s[r].match(/^(#{1,6})\s+/);if(a){const i=a[1].length;o>0&&i>o+1&&n.push({ruleId:"header-increment",severity:"warning",message:`Header level jumped from H${o} to H${i} (should be H${o+1})`,line:r+1}),o=i}}return n}},sg={id:"noEmptyHeaders",name:"No Empty Headers",description:"Headers must have content after the # markers",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^#{1,6}\s*$/.test(r)&&n.push({ruleId:"no-empty-headers",severity:"error",message:"Header has no content",line:o+1})}return n}},ng={id:"firstHeaderH1",name:"First Header H1",description:"Document should start with H1",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].match(/^(#{1,6})\s+/);if(r){const a=r[1].length;a!==1&&n.push({ruleId:"first-header-h1",severity:"info",message:`First header should be H1, found H${a}`,line:o+1});break}}return n}},og={id:"noTrailingSpaces",name:"No Trailing Spaces",description:"Lines shouldn't end with trailing spaces",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];r.endsWith(" ")&&!r.endsWith("  ")&&n.push({ruleId:"no-trailing-spaces",severity:"warning",message:"Line has trailing spaces",line:o+1,column:r.trimEnd().length+1})}return n}},ag={id:"noMultipleBlanks",name:"No Multiple Blanks",description:"No more than 1 consecutive blank line",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0,r=0;for(let a=0;a<s.length;a++)s[a].trim()===""?(o===0&&(r=a+1),o++):(o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:a}),o=0);return o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:s.length}),n}},rg={id:"noLeadingWhitespace",name:"No Leading Whitespace",description:"Content shouldn't start with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let a=0;a<s.length&&s[a].trim()==="";a++)o++;o>0&&n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`Content starts with ${o} blank line(s)`,line:1,endLine:o});const r=s.find(a=>a.trim()!=="");if(r&&/^\s+/.test(r)){const a=r.match(/^(\s+)/),i=a?a[1].length:0;n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`First content line starts with ${i} whitespace character(s)`,line:o+1,column:1})}return n}},ig={id:"noTrailingWhitespace",name:"No Trailing Whitespace",description:"Content shouldn't end with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=s.length-1;r>=0&&s[r].trim()==="";r--)o++;return o>0&&n.push({ruleId:"no-trailing-whitespace",severity:"warning",message:`Content ends with ${o} blank line(s)`,line:s.length-o+1,endLine:s.length}),n}},cg={id:"consistentEmphasis",name:"Consistent Emphasis",description:"Use same style for emphasis (* vs _)",defaultSeverity:"info",check:e=>{const s=[],n=e.match(new RegExp("(?<!\\*)\\*(?!\\*)([^*]+)(?<!\\*)\\*(?!\\*)","g")),o=e.match(new RegExp("(?<!_)_(?!_)([^_]+)(?<!_)_(?!_)","g"));n&&o&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both *italic* and _italic_",line:1});const r=e.match(/\*\*([^*]+)\*\*/g),a=e.match(/__([^_]+)__/g);return r&&a&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both **bold** and __bold__",line:1}),s}},lg={id:"noSpaceInEmphasis",name:"No Space in Emphasis",description:"No spaces inside emphasis markers",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\*\*\s+[^*]+\*\*|\*\*[^*]+\s+\*\*/);a&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside bold markers: ** text ** should be **text**",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(new RegExp("(?<!\\*)\\*\\s+[^*]+\\*(?!\\*)|\\*[^*]+\\s+\\*(?!\\*)"));i&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside italic markers: * text * should be *text*",line:o+1,column:r.indexOf(i[0])+1})}return n}},dg={id:"noEmptyLinks",name:"No Empty Links",description:"Links must have both text and URL",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\[\]\([^)]+\)/);a&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no text: [](url)",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(/\[[^\]]+\]\(\s*\)/);i&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no URL: [text]()",line:o+1,column:r.indexOf(i[0])+1})}return n}},ug={id:"noBareUrls",name:"No Bare URLs",description:"URLs should be wrapped in link syntax [text](url)",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=new RegExp("(?<!\\]\\()https?:\\/\\/[^\\s\\)]+","g");let i;for(;(i=a.exec(r))!==null;)r.substring(0,i.index).endsWith("](")||n.push({ruleId:"no-bare-urls",severity:"info",message:`Bare URL found: ${i[0].substring(0,30)}...`,line:o+1,column:i.index+1})}return n}},hg={id:"consistentListMarker",name:"Consistent List Marker",description:"Use same marker for unordered lists (- vs * vs +)",defaultSeverity:"info",check:(e,s)=>{const n=[],o=new Set;let r=0,a="";for(let i=0;i<s.length;i++){const c=s[i].match(/^(\s*)([*+-])\s+/);if(c){const l=c[2];o.size===0&&(r=i+1,a=l),o.add(l)}}return o.size>1&&n.push({ruleId:"consistent-list-marker",severity:"info",message:`Mixed list markers: using ${Array.from(o).join(", ")} (first "${a}" on line ${r})`,line:1}),n}},pg={id:"noEmptyListItems",name:"No Empty List Items",description:"List items must have content",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^\s*[*+-]\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty list item",line:o+1}),/^\s*\d+\.\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty ordered list item",line:o+1})}return n}},gg={id:"orderedListPrefix",name:"Ordered List Prefix",description:"Ordered lists should use 1. or sequential numbering",defaultSeverity:"info",check:(e,s)=>{const n=[];let o=1,r=!1;for(let a=0;a<s.length;a++){const i=s[a].match(/^(\s*)(\d+)\.\s+/);if(i){const c=parseInt(i[2],10);r||(r=!0,o=1),c!==1&&c!==o&&n.push({ruleId:"ordered-list-prefix",severity:"info",message:`Ordered list item ${c}. should be ${o}. (or use 1. for all)`,line:a+1}),o++}else s[a].trim()===""&&(r=!1,o=1)}return n}},fg={id:"tableColumnCount",name:"Table Column Count",description:"All table rows should have the same column count",defaultSeverity:"error",check:(e,s)=>{const n=[];let o=-1,r=0;for(let a=0;a<s.length;a++){const i=s[a].trim();if(i.startsWith("|")||i.includes("|")&&/\|.+\|/.test(i)){const c=i.split("|").filter(l=>l.trim()!=="").length;o===-1?(o=a+1,r=c):c!==r&&(/^[\s|:-]+$/.test(i)||n.push({ruleId:"table-column-count",severity:"error",message:`Table row has ${c} columns, expected ${r}`,line:a+1}))}else o!==-1&&i===""&&(o=-1,r=0)}return n}},mg={id:"noEmptyTableCells",name:"No Empty Table Cells",description:"Warn on empty table cells",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].trim();if(!/^[\s|:-]+$/.test(r)&&(r.startsWith("|")||r.includes("|")&&/\|.+\|/.test(r))){const a=r.split("|");for(let i=1;i<a.length-1;i++)a[i].trim()===""&&n.push({ruleId:"no-empty-table-cells",severity:"info",message:`Empty table cell in column ${i}`,line:o+1})}}return n}},xg=[eg,tg,sg,ng,og,ag,rg,ig,cg,lg,dg,ug,hg,pg,gg,fg,mg],wg=Object.fromEntries(xg.map(e=>[e.id,e]));function yg(e,s){const n=[],o=e.split(`
`);for(const[r,a]of Object.entries(s)){if(!(a!=null&&a.enabled))continue;const i=wg[r];if(!i){console.warn(`Unknown lint rule: ${r}`);continue}const c=i.check(e,o),l=a.severity??i.defaultSeverity;for(const d of c)n.push({...d,severity:l})}return n.sort((r,a)=>r.line!==a.line?r.line-a.line:(r.column??0)-(a.column??0)),n}function vg(e){return{total:e.length,errors:e.filter(s=>s.severity==="error").length,warnings:e.filter(s=>s.severity==="warning").length,infos:e.filter(s=>s.severity==="info").length}}function bg(e){if(e.length===0)return"No issues found.";const s=e.map(o=>{const r=o.column?`${o.line}:${o.column}`:`${o.line}`,a=o.severity.toUpperCase().padEnd(7);return`  ${r.padEnd(8)} ${a} ${o.message} (${o.ruleId})`}),n=vg(e);return s.push(""),s.push(`Found ${n.total} issue(s): ${n.errors} error(s), ${n.warnings} warning(s), ${n.infos} info(s)`),s.join(`
`)}function Ng(e){let s=e.split(`
`);for(;s.length>0&&s[0].trim()==="";)s.shift();for(s.length>0&&(s[0]=s[0].trimStart());s.length>0&&s[s.length-1].trim()==="";)s.pop();const n=[];let o=!1;for(const r of s)if(r.trim()==="")o||n.push(r),o=!0;else{const i=o?r.trimStart():r;n.push(i),o=!1}return n.join(`
`)}const ai={noEmptyHeaders:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},noEmptyLinks:{enabled:!0},noEmptyListItems:{enabled:!0},tableColumnCount:{enabled:!0}},Sg={noDuplicateHeaders:{enabled:!0},headerIncrement:{enabled:!0},noEmptyHeaders:{enabled:!0},firstHeaderH1:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},consistentEmphasis:{enabled:!0},noSpaceInEmphasis:{enabled:!0},noEmptyLinks:{enabled:!0},noBareUrls:{enabled:!0},consistentListMarker:{enabled:!0},noEmptyListItems:{enabled:!0},orderedListPrefix:{enabled:!0},tableColumnCount:{enabled:!0},noEmptyTableCells:{enabled:!0}};function Cg(e){switch(e){case"disabled":return null;case"simple":return{...ai};case"comprehensive":return{...Sg};default:return{...ai}}}function ri(e,s,n){let o=0,r=!1;const a=[];function i(c){var l,d,u,h,f,g,w;if(r)return!0;if(c===s)return c.nodeType===Node.TEXT_NODE?(a.push(`FOUND target text node "${(l=c.textContent)==null?void 0:l.substring(0,20)}", adding targetOffset ${n}`),o+=n):a.push(`FOUND target element node, type=${c.tagName}`),r=!0,!0;if(c.nodeType===Node.TEXT_NODE){const m=((d=c.textContent)==null?void 0:d.length)||0;a.push(`text "${(u=c.textContent)==null?void 0:u.substring(0,20)}" +${m} → ${o+m}`),o+=m}else if(c.nodeType===Node.ELEMENT_NODE){const m=c,x=m.tagName;if(x==="BR")return a.push(`BR +1 → ${o+1}`),o+=1,!1;let y=0,v=!1,N=!1;if(x==="H1")y=2;else if(x==="H2")y=3;else if(x==="H3")y=4;else if(x==="BLOCKQUOTE")y=2;else if(m.classList.contains("list-item-ul"))y=2,v=!0,((h=m.previousElementSibling)!=null&&h.classList.contains("list-item-ul")||(f=m.previousElementSibling)!=null&&f.classList.contains("list-item-ol"))&&(N=!0);else if(m.classList.contains("list-item-ol")){const S=m.querySelector("span:first-child");y=((S==null?void 0:S.textContent)||"1.").length+1,v=!0,((g=m.previousElementSibling)!=null&&g.classList.contains("list-item-ul")||(w=m.previousElementSibling)!=null&&w.classList.contains("list-item-ol"))&&(N=!0)}else if(m.classList.contains("empty-line"))return a.push(`empty-line +1 → ${o+1}`),o+=1,!1;N&&(a.push(`newline before block +1 → ${o+1}`),o+=1),y>0&&a.push(`${x} prefix +${y} → ${o+y}`),o+=y;const b=Array.from(c.childNodes);for(let S=0;S<b.length;S++)if(!(v&&S===0&&b[S].nodeName==="SPAN")&&i(b[S]))return!0}return!1}return i(e),o}let Je=null,xa=!1;typeof window<"u"&&(window.addEventListener("keydown",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(xa=!0)},!0),window.addEventListener("keyup",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(xa=!1)},!0),document.addEventListener("selectionchange",()=>{const e=window.getSelection();xa||!e||e.isCollapsed||(Je={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,text:e.toString(),timestamp:Date.now()})}));const Ge=class Ge{static lintPastedContent(s){const n=J.lint.onPastePreset,o=Cg(n);if(!o)return;const r=yg(s,o);r.length>0&&(console.warn(`[Markdown Linter] Found ${r.length} issue(s) in pasted content:`),console.warn(bg(r)))}onMouseDown(s){const n=E.getState(),o=n.uiState,{mode:r,addNodeType:a}=o,i=n.getCanvasMouseCoords();if(r!==Q.ADD||a!==ce.TEXT||!i)return!1;const c=Le.buildTextNode(i,"");return n.addNode(c),n.setNodeToFocusId(c.id),!0}async onPaste(s){var w,m;const n=E.getState(),o=await Wu();if(!o)return!1;const r=Qp(o);if(r.type===Ha.CONTENT_CAPTURE){const x=n.getCanvasMouseCoords();if(x)return this.createNodesFromContentCapture(r.data,x),n.setNodeToFocusId(null),s.preventDefault(),!0}const a=r.type===Ha.REGULAR?r.content:o,i=Ng(a),{mode:c,addNodeType:l,nodeToFocusId:d}=n.uiState,u=((w=n.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??[];if(d){const x=n.getNodeById(d);if(x&&typeof x.content=="string"&&u.length>0){const v=(x.content||"")+i;if(!((m=x.options)!=null&&m.lockSize)){let b;const S=document.querySelector("textarea[data-node-textarea]");if(S){const A=window.getComputedStyle(S).lineHeight;if(A&&A!=="normal"){const T=parseFloat(A);isNaN(T)||(b=T)}}const I=bs(v,b,x),C=Math.min(I.width,J.paste.maxWidth);let k=I.height;C<I.width&&(k=ht(v,C,x)),n.updateNode(x.id,{...x,content:v,width:C,height:k})}else n.updateNode(x.id,{...x,content:v});return s.preventDefault(),Ge.lintPastedContent(i),!0}}const h=n.getCanvasMouseCoords(),f=c===Q.ADD&&l===ce.TEXT&&h,g=!d&&h;if(f){const x=Le.buildTextNode(h,i);return n.addNode(x),n.setNodeToFocusId(null),n.setMode(Q.SELECT),n.setAddNodeType(null),s.preventDefault(),Ge.lintPastedContent(i),!0}else if(g){const x=n.getSegmentedButtonAction("canvas-fit-width");let y=null;if(x){const I=/Set width to (\d+)px/.exec(x);I&&(y=parseInt(I[1],10))}let v,N,b;if(y)N=ht(i,y),v=y,b=!0;else{const I=document.querySelector("textarea[data-node-textarea]");I&&window.getComputedStyle(I).lineHeight;const C=bs(i);v=Math.min(C.width,J.paste.maxWidth),v<C.width?N=ht(i,v):N=C.height,b=!1}const S=Le.buildTextNodeV2({x:h.x,y:h.y,width:v,height:N,content:i,styles:{textAlign:"left"},options:{lockSize:b}});return n.addNode(S),n.setNodeToFocusId(null),s.preventDefault(),Ge.lintPastedContent(i),!0}return!1}isGroupNodeType(s){return s.type===ce.GROUP||s.type==="GROUP"}createNodesFromContentCapture(s,n){const o=E.getState(),{pasteWidth:r,nodeGap:a}=J.contentCapture,i=Math.min(...s.nodes.map(y=>y.x)),c=Math.min(...s.nodes.map(y=>y.y)),l=n.x-i,d=n.y-c,u=new Map,h=s.nodes.every(y=>y.width&&y.height);let f=n.y;const g=[];for(const y of s.nodes){const v=y.content||"",N=this.isGroupNodeType(y);let b,S,I;y.width&&y.height?(b=y.width,S=y.height,I=h?y.y+d:f):(b=r,S=ht(v,r),I=f);let C;if(N){const k=new Date().toISOString();C={...y,id:Pe(10),type:ce.GROUP,x:y.x+l,y:I,width:b,height:S,createdAt:k,updatedAt:k}}else C={...y,id:Pe(10),x:y.x+l,y:I,width:b,height:S,content:v,styles:y.styles??{textAlign:"left"},options:y.options??{lockSize:!h},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};u.set(y.id,C.id),g.push({oldNode:y,newNode:C}),h||(f+=S+a)}for(const{oldNode:y,newNode:v}of g){if(y.groupId){const N=u.get(y.groupId);N?v.groupId=N:delete v.groupId}else delete v.groupId;if(this.isGroupNodeType(y)){const N=y.data,S=((N==null?void 0:N.childNodeIds)??[]).map(I=>u.get(I)).filter(I=>I!==void 0);v.data={...N??{},childNodeIds:S}}o.addNode(v,void 0,{skipUndo:!0})}const w=g.map(({newNode:y})=>({type:"node:create",node:y})),m=[];for(const y of s.arrows??[]){const v=y.startNodeId?u.get(y.startNodeId):null,N=y.endNodeId?u.get(y.endNodeId):null;if(v&&N){const b={id:Pe(10),startNodeId:v,endNodeId:N,startPoint:{x:0,y:0},endPoint:{x:0,y:0}};o.arrow.add(b),m.push(b),w.push({type:"arrow:create",arrow:b})}}w.length>0&&o.undo.commit({type:"batch",label:`Paste ${g.length} node${g.length!==1?"s":""}${m.length>0?` and ${m.length} arrow${m.length!==1?"s":""}`:""}`,operations:w});const x=g.map(y=>y.newNode);o.setSelectedNodes(x),m.length>0&&o.arrow.setSelected(m)}onCopy(s){var h,f;const{focus:n,sourceNode:o,side:r="right"}=s||{focus:!0},a=E.getState(),{mode:i,nodeToFocusId:c}=a.uiState;if(!i)return null;const l=((h=a.projectCanvas.getActive())==null?void 0:h.coreState.selectedNodes)??[],d=Date.now();let u=!1;if(Ge.lastCopyTimestamp&&d-Ge.lastCopyTimestamp<Ge.DOUBLE_COPY_INTERVAL_MS&&(u=!0),Ge.lastCopyTimestamp=d,u)return null;{let g=o;return g||(g=l[0],g||(g=(((f=a.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??[]).find(y=>y.id===c))),jg(g,n?c:null,n,r)}}highlightAndCreateNode(s,n="right"){var d;const o=E.getState(),r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c=!1,l=null;if(a){const u=r,h=u.value;let f=u.selectionStart,g=u.selectionEnd;if(f===g)if(ei(h,f)){const w=si(h,f);w&&(f=w.start,g=w.end)}else{const w=ti(h,f);w&&(f=w.start,g=w.end)}else f=ni(h,f),g=oi(h,g);(f!==u.selectionStart||g!==u.selectionEnd)&&u.setSelectionRange(f,g),c=f!==g}else if(i){const u=window.getSelection(),h=r.textContent||"";let f=!!(u&&!u.isCollapsed&&u.toString().trim());if(u&&u.rangeCount>0){const g=u.getRangeAt(0),w=document.createRange();w.setStart(r,0),w.setEnd(g.startContainer,g.startOffset);let m=w.toString().length;const x=document.createRange();x.setStart(r,0),x.setEnd(g.endContainer,g.endOffset);let y=x.toString().length;if(m===y)if(ei(h,m)){const v=si(h,m);v&&(m=v.start,y=v.end)}else{const v=ti(h,m);v&&(m=v.start,y=v.end)}else m=ni(h,m),y=oi(h,y);if(m!==y){const v=Kp(r,m,y);v&&(u.removeAllRanges(),u.addRange(v),l=v.cloneRange(),f=!0)}}c=f,c&&u&&u.rangeCount>0&&!l&&(l=u.getRangeAt(0).cloneRange())}if(c){s.preventDefault();const{nodeToFocusId:u}=o.uiState,h=o.projectCanvas.getActive();let g=((h==null?void 0:h.coreState.selectedNodes)??[])[0];!g&&u&&(g=((h==null?void 0:h.coreState.nodes)??[]).find(v=>v.id===u));const w=a?r.selectionStart:0,m=a?r.selectionEnd:0;Ge.dismissPopoverCallback&&Ge.dismissPopoverCallback();const x=this.onCopy({focus:!1,sourceNode:g,side:n});if(setTimeout(()=>{if(r.focus(),a)r.setSelectionRange(w,m);else if(i&&l){const y=window.getSelection();y&&(y.removeAllRanges(),y.addRange(l))}},0),g!=null&&g.highlights&&g.highlights.length>1&&x){const v=(((d=o.projectCanvas.getActive())==null?void 0:d.coreState.nodes)??[]).find(b=>b.id===g.id),N=window.__showLinkedNodesPopover;N&&v&&N(v,x)}}else{const{nodeToFocusId:u}=o.uiState,h=o.projectCanvas.getActive();let g=((h==null?void 0:h.coreState.selectedNodes)??[])[0];if(!g&&u&&(g=((h==null?void 0:h.coreState.nodes)??[]).find(m=>m.id===u)),g!=null&&g.highlights&&g.highlights.length>0){s.preventDefault();const w=window.__showLinkedNodesPopover;w&&w(g,null)}}}static registerSelectionCallback(s){Ge.selectionChangeCallback=s}static unregisterSelectionCallback(){Ge.selectionChangeCallback=null}static registerDismissPopoverCallback(s){Ge.dismissPopoverCallback=s}static unregisterDismissPopoverCallback(){Ge.dismissPopoverCallback=null}onTextSelect(s,n,o){const r=n!==o;Ge.selectionChangeCallback&&Ge.selectionChangeCallback(r)}};Fe(Ge,"lastCopyTimestamp",null),Fe(Ge,"DOUBLE_COPY_INTERVAL_MS",400),Fe(Ge,"selectionChangeCallback",null),Fe(Ge,"dismissPopoverCallback",null);let Xt=Ge;function jg(e,s,n=!0,o="right"){var T,O,$,B;if(!e)return console.warn("No target node found for copy action."),null;const r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c="",l=null,d=0,u=0;if(a){const H=r;d=H.selectionStart,u=H.selectionEnd,c=H.value.substring(d,u);const M=Nl(H,d,u);if(M)l=new DOMRect(0,M.top,M.width,M.height);else{const j=Ne.LINE_HEIGHT,P=4,z=H.value.substring(0,d).split(`
`).length-1,_=P+z*j;l=new DOMRect(0,_,0,j)}}else if(i){const H=window.getSelection(),M=5e3,j=Je&&((T=Je.anchorNode)==null?void 0:T.nodeType)===Node.TEXT_NODE&&Je.text.length>0,P=Je&&j&&Date.now()-Je.timestamp<M;let W,L,z;if(P&&Je)W=Je.anchorNode,L=Je.focusNode,z=Je.focusOffset,c=Je.text;else if(H)W=H.anchorNode,L=H.focusNode,z=H.focusOffset,c=H.toString();else return null;const _=H;if(_&&_.rangeCount>0){const G=_.getRangeAt(0),V=r.getBoundingClientRect(),D=G.getClientRects();if(D.length>0){const pe=D[0],ue=pe.top-V.top;l=new DOMRect(0,ue,pe.width,pe.height)}const K=e.content||"",te=pe=>{let ue=pe;for(;ue&&ue!==r;){if(ue.nodeType===Node.ELEMENT_NODE){const re=ue.parentElement;if(re&&(re.classList.contains("list-item-ul")||re.classList.contains("list-item-ol"))){const xe=re.querySelector("span:first-child");if(xe&&(ue===xe||xe.contains(pe)))return!0}}ue=ue.parentNode}return!1},ie=pe=>{let ue=pe;for(;ue&&ue!==r;){const oe=ue.parentElement;if(oe&&(oe.classList.contains("list-item-ul")||oe.classList.contains("list-item-ol"))){const re=oe.querySelector("span:nth-child(2)");if(re!=null&&re.firstChild)return re.firstChild}ue=ue.parentNode}return null};let ye,ge,q,le;if(P&&(Je!=null&&Je.anchorNode)?(ye=Je.anchorNode,ge=Je.anchorOffset,q=Je.anchorNode,le=Je.anchorOffset+Je.text.length):(ye=G.startContainer,ge=G.startOffset,q=G.endContainer,le=G.endOffset),te(ye)){const pe=ie(ye);pe&&(ye=pe,ge=0)}const de=pe=>{let ue=pe;for(;ue&&ue!==r;){if(ue.nodeType===Node.ELEMENT_NODE){const oe=ue,re=oe.tagName;if(re==="H1"||re==="H2"||re==="H3"||re==="DIV"||re==="P"||re==="BLOCKQUOTE"||oe.classList.contains("list-item-ul")||oe.classList.contains("list-item-ol"))return oe}ue=ue.parentNode}return null},U=de(ye),Y=de(q),X=L?de(L):null,Z=W?de(W):null,ne=c.includes(`
`);if(U&&U!==Y&&ne&&!(W===L)){const pe=Z!==X;if(pe&&Z&&!X){const ue=(L==null?void 0:L.textContent)||"",oe=z;let re=oe,xe=oe;for(;re>0&&/\S/.test(ue[re-1]);)re--;for(;xe<ue.length&&/\S/.test(ue[xe]);)xe++;if(re===xe&&oe>0)for(xe=oe,re=oe-1;re>0&&/\S/.test(ue[re-1]);)re--;re<xe&&L&&(ye=L,ge=re,q=L,le=xe)}else if(pe&&!Z&&X){const oe=document.createTreeWalker(X,NodeFilter.SHOW_TEXT).nextNode();oe&&(ye=oe,ge=0)}else if(pe&&X&&Z){const ue=document.createTreeWalker(U,NodeFilter.SHOW_TEXT);let oe=null,re;for(;re=ue.nextNode();)oe=re;oe&&(q=oe,le=((O=oe.textContent)==null?void 0:O.length)||0)}else{const ue=document.createTreeWalker(U,NodeFilter.SHOW_TEXT);let oe=null,re;for(;re=ue.nextNode();)oe=re;oe&&(q=oe,le=(($=oe.textContent)==null?void 0:$.length)||0)}}const ae=ri(r,ye,ge),me=ri(r,q,le);d=Math.min(ae,me),u=Math.max(ae,me),c=K.substring(d,u)}}else{const H=window.getSelection();if(c=(H==null?void 0:H.toString())||"",H&&H.rangeCount>0){const M=H.getRangeAt(0).cloneRange(),j=document.createElement("span");j.style.position="absolute",j.textContent="​",M.insertNode(j),l=j.getBoundingClientRect(),(B=j.parentNode)==null||B.removeChild(j)}}const h=E.getState();let f;const g="rgb(198, 183, 0)";if(J.highlightAndCreate.createHighlight&&(a||i)&&d!==u){const H=e.highlights||[],M=H.find(j=>j.start===d&&j.end===u);if(M)f=M.id;else{f=Math.random().toString(36).slice(2,10);const j={id:f,start:d,end:u,color:g,createdAt:Date.now()},P=[...H,j];h.updateNode(e.id,{highlights:P})}}const m=h.getSegmentedButtonAction("canvas-fit-width");let x=null;if(m){const H=/Set width to (\d+)px/.exec(m);H&&(x=parseInt(H[1],10))}let y,v,N;const b=document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(b&&window.getComputedStyle(b).lineHeight,x)v=ht(c,x),y=x,N=!0;else{const H=bs(c);y=H.width,v=H.height,N=!1}const S=Le.buildTextNodeV2({content:c,width:y,height:v,linkedHighlightId:f,linkedSourceNodeId:e.id,options:{lockSize:N}});let I=e.y;if(l){const H=l.top;I=e.y+H,l.height&&(I+=l.height/2)}const C=S.height??v,k=I-C/2,R=s||e.id,A=J.highlightAndCreate.createConnectingArrow;if(Jo(S,{...e,y:k,id:R},o,{shouldFocus:n,createArrow:A}),f){const H=h.getNodeById(e.id),j=((H==null?void 0:H.highlights)||[]).map(P=>P.id===f?{...P,linkedNodeId:S.id}:P);h.updateNode(e.id,{highlights:j})}return S.id}const kg=1e3,Ag=500,Ig=500,Tg=250,Eg=2e3,Rg=1e3,Mg=500;class Pg{handleArrowKey(s,n=!1,o=!1){const r=E.getState(),a=r.projectCanvas.getActive();if(!a)return!1;const i=a.coreState.selectedNodes??[];if(i.length===0)return!1;const c=a.coreState.nodes??[],l=new Set(i.map(g=>g.id)),d=c.filter(g=>l.has(g.id));let u=kg,h=Ag;o?(u=Eg,h=Rg):n&&(u=Ig,h=Tg);const f=d.map(g=>{const w={id:g.id};switch(s.key){case"ArrowLeft":{const m=g.x,y=Math.round(m/u)-1;w.x=y*u;break}case"ArrowRight":{const m=g.x,y=Math.round(m/u)+1;w.x=y*u;break}case"ArrowUp":{const m=g.y,y=Math.round(m/h)-1;w.y=y*h;break}case"ArrowDown":{const m=g.y,y=Math.round(m/h)+1;w.y=y*h;break}}return w});return r.updateNodes(f),this.animateViewportToCenter(f,a),s.preventDefault(),!0}animateViewportToCenter(s,n){if(s.length===0||!n)return;const r=E.getState().setActiveCanvasViewState,a=n.viewState,i=a.scale,c=a.offset,l=n.coreState.nodes??[],d=new Map(l.map(I=>[I.id,I]));let u=0,h=0;s.forEach(I=>{const C=d.get(I.id);if(C){const k=I.x??C.x,R=I.y??C.y;u+=k,h+=R}});const f=u/s.length,g=h/s.length,w=window.innerWidth,m=window.innerHeight,x=w/2-f*i,y=m/2-g*i,v=performance.now(),N=c.x,b=c.y,S=I=>{const C=I-v,k=Math.min(C/Mg,1),R=1-Math.pow(1-k,3),A=N+(x-N)*R,T=b+(y-b)*R;r(O=>({...O,offset:{x:A,y:T}})),k<1&&requestAnimationFrame(S)};requestAnimationFrame(S)}}const ii=!0,Dg=1/3;function Og(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}class Lg{async onPaste(s){try{const n=await navigator.clipboard.read();for(const o of n){const r=o.types.find(h=>h.startsWith("image/"));if(!r)continue;const a=await o.getType(r);if(!a)continue;const i=Math.round(a.size/1024),c=await this.blobToDataUrl(a);let l,d;if(ii){const h=await Og(c,Dg);l=h.dataUrl,d=h.size}const u=ii?Math.round(l.length*3/4/1024):i;return this.createImageNode(l,d,u),s.preventDefault(),!0}}catch(n){console.debug("ImageModeHandler: Clipboard read failed",n)}return!1}blobToDataUrl(s){return new Promise((n,o)=>{const r=new FileReader;r.onload=()=>n(r.result),r.onerror=o,r.readAsDataURL(s)})}createImageNode(s,n,o){const r=E.getState(),a=r.getCanvasMouseCoords();if(!a){console.warn("ImageModeHandler: No mouse position available");return}const i=300,c=n.height/n.width,l=Math.round(i*c),d=Le.buildImageNode({x:a.x,y:a.y,width:i,height:Math.max(l,100)});d.data={image:s,imageSize:n,fileSizeKB:o},r.addNode(d),r.setNodeToFocusId(d.id)}}function Wg(){const e=document.activeElement;if(!e)return null;const s=["INPUT","TEXTAREA"].includes(e.nodeName??""),n=e.contentEditable==="true";return s||n}class Hg{constructor(){Fe(this,"activeCallback",null)}registerCallback(s){this.activeCallback=s}unregisterCallback(s){this.activeCallback===s&&(this.activeCallback=null)}applyHighlight(s){return this.activeCallback?(this.activeCallback(s),!0):!1}hasActiveCallback(){return this.activeCallback!==null}}const Nn=new Hg,Bg=new Cs("useCanvasKeyboardEventsV2",js.useCanvasKeyboardEventsV2),Fg=["q","Q","$","%","5"],$g=()=>{const e=E.getState(),s=e.uiState.mode,n=e.setMode,o=e.setZoomSubMode,r=e.setWriteSubMode,a=e.toggleWriteSubMode,i=e.setArrowSubMode,c=e.toggleArrowSubMode,l=e.setDrawSubMode,d=e.toggleDrawSubMode,u=e.setAddNodeType,h=e.setNodeToFocusId,f=e.duplicateNodes,g=e.setSelectedNodes,w=e.arrow.setSelected,m=e.deleteSelectedNodes,x=e.deleteSelectedArrows,y=e.setActiveCanvasViewState,v=e.toggleOverlayVisibility,N=p.useRef(new Xt),b=p.useRef(new Pg),S=p.useRef(new Lg),I=p.useRef(0);return p.useCallback(C=>{var B;const k=E.getState().uiState.mode;if(k===Q.VIM)return;if(C.key==="Escape"){const H=Date.now(),j=H-I.current<400;if(I.current=H,j){const W=document.querySelector('[data-test="canvas-chat-input-container"] textarea');W==null||W.focus();return}if(E.getState().uiState.activeGroupId){E.getState().group.setActiveGroupId(null);return}k===Q.SELECT&&g([]),n(Q.SELECT),h(null),u(null);return}if((C.key==="h"||C.key==="H")&&(C.ctrlKey||C.metaKey)){C.preventDefault(),Nn.applyHighlight();return}const R=C.key==="Enter"&&C.ctrlKey,A=C.key==="a"&&k===Q.WRITE;if(k===Q.WRITE&&!R&&!A)return;const T=Wg(),O=Fg.includes(C.key);if(T&&!O)return;if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(C.key)){const H=e.projectCanvas.getActive(),M=(H==null?void 0:H.coreState.selectedNodes)??[];if(k===Q.GRID&&M.length>0){const j=C.ctrlKey,P=C.shiftKey;if(b.current.handleArrowKey(C,j,P))return}if(C.ctrlKey&&M.length>0&&k!==Q.GRID){const j=e.uiState.lastUpdatedNodeId;if(!j)return;const P=(B=H==null?void 0:H.coreState.nodes)==null?void 0:B.find(L=>L.id===j);if(!P)return;const W=M.map(L=>{const z={id:L.id};switch(C.key){case"ArrowLeft":case"ArrowRight":z.x=P.x;break;case"ArrowUp":case"ArrowDown":z.y=P.y;break}return z});e.updateNodes(W),C.preventDefault();return}if(M.length===0){const j=C.shiftKey?100:30;y(P=>{let W=0,L=0;switch(C.key){case"ArrowUp":L=j;break;case"ArrowDown":L=-j;break;case"ArrowLeft":W=j;break;case"ArrowRight":W=-j;break}return{...P,offset:{x:P.offset.x+W,y:P.offset.y+L}}}),C.preventDefault();return}}switch(C.key){case".":{C.preventDefault();break}case"a":{if(C.preventDefault(),C.ctrlKey||C.metaKey){const j=e.projectCanvas.getActive(),P=(j==null?void 0:j.coreState.nodes)??[];g(P);break}const H=e.uiState.addNodeType;k===Q.ADD&&H===ce.TEXT?(n(Q.WRITE),r(Vs.AUDIO)):k===Q.WRITE?a():k===Q.DRAW_ARROW?c():(n(Q.DRAW_ARROW),i(Rn.DEFAULT));break}case"c":if(C.ctrlKey||C.metaKey){const H=window.getSelection();if(H&&H.toString().trim().length>0)break;C.preventDefault(),kl();break}C.preventDefault(),console.clear();break;case"d":if(C.preventDefault(),C.ctrlKey){f();break}g([]),w([]),n(Q.DRAW);break;case"v":if(C.ctrlKey){const H=e.projectCanvas.getActive();if(((H==null?void 0:H.coreState.selectedNodes)??[]).some(P=>P.type===ce.OCR||P.type===ce.IMAGE))break;(async()=>await S.current.onPaste(C)||N.current.onPaste(C))();break}n(Q.SELECT);break;case"g":if(C.ctrlKey){E.getState().group.createFromSelected()&&C.preventDefault();break}n(Q.GRID);break;case"h":case"H":k===Q.MOVE?(n(Q.ZOOM),o("zoom")):k===Q.ZOOM?n(Q.MOVE):n(Q.MOVE);break;case"i":n(Q.VIM);break;case"m":n(Q.ADD),u(ce.CHAT);break;case"n":{E.getState().setCustomNodeDropdownOpen(!0);break}case"q":if(C.ctrlKey){N.current.onCopy();break}break;case"r":C.altKey&&(C.preventDefault(),E.getState().executeGlobalLastAction());break;case"s":(C.ctrlKey||C.metaKey)&&(C.preventDefault(),E.getState().saveStateToLocalStorage());break;case"Q":if(C.ctrlKey&&C.shiftKey){N.current.onCopy();break}break;case"$":{N.current.highlightAndCreateNode(C,"right");break}case"%":case"5":{N.current.highlightAndCreateNode(C,"left");break}case"t":n(Q.ADD),u(ce.TEXT);break;case"w":{const H=e.uiState.addNodeType;k===Q.ADD&&H===ce.TEXT&&(n(Q.WRITE),r(Vs.WRITE));break}case"u":case"U":(C.ctrlKey||C.metaKey)&&C.shiftKey&&(C.preventDefault(),E.getState().setUiState(H=>({...H,undoTreeExplorerOpen:!H.undoTreeExplorerOpen})));break;case"y":(C.ctrlKey||C.metaKey)&&(C.preventDefault(),E.getState().undo.redo());break;case"z":if(C.ctrlKey||C.metaKey){C.preventDefault(),C.shiftKey?E.getState().undo.redo():E.getState().undo.undo();break}v();break;case"1":case"2":case"3":case"4":if(k===Q.DRAW){C.preventDefault();const H=Ye.getSubModeFromKey(C.key);H&&l(H)}break;case"Tab":k===Q.DRAW&&(C.preventDefault(),d());break;case"Delete":case"Backspace":m(),x(),C.preventDefault();break}},[s,n,o,r,a,i,c,l,d,u,m,x,y,v,e])},zg=()=>p.useCallback(e=>{Bg.log("Key Up:",e.key)},[]),Io=(e,s)=>e.x<s.x+s.width&&e.x+e.width>s.x&&e.y<s.y+s.height&&e.y+e.height>s.y,To=e=>({x:e.x,y:e.y,width:e.width??100,height:e.height??50}),_g=(e,s,n)=>{const{x1:o,y1:r,x2:a,y2:i}=n,{x:c,y:l}=e,{x:d,y:u}=s,h=d-c,f=u-l;let g=-1/0,w=1/0;const m=(y,v,N,b)=>{if(Math.abs(v)<1e-6)return y>=N&&y<=b;let S=(N-y)/v,I=(b-y)/v;return S>I&&([S,I]=[I,S]),g=Math.max(g,S),w=Math.min(w,I),g<=w};if(!m(c,h,o,a)||!m(l,f,r,i)||g>1||w<0)return null;const x=Math.max(0,g);return x<=1?{x:c+x*h,y:l+x*f}:null},et=(e,s,n,o,r)=>{var d;if(!e)return s;const a=o.find(u=>u.id===e);if((a==null?void 0:a.width)===void 0||a.height===void 0)return s;if(r){const u=`[data-row-connector="${r}"][data-node-id="${e}"]`,h=document.querySelector(u);if(h){const f=h.getBoundingClientRect(),g=document.querySelector("[data-canvas-content]");if(g){const w=g.getBoundingClientRect(),m=f.left+f.width/2-w.left,x=f.top+f.height/2-w.top,v=(d=E.getState().projectCanvas.getActive())==null?void 0:d.viewState;return v?wt({x:m,y:x},v.scale,v.offset):{x:m,y:x}}}else return s}const i=In(a),c=qe(a);return _g(n,c,i)??c},Vg=(e,s,n,o,r)=>{if(r===0){const a=n/o;return Math.abs(e)*a>=Math.abs(s)}return Math.abs(e)*r>=Math.abs(s)},Fs=(e,s,n,o,r=0,a=J.arrows.CUBIC_HORIZONTAL_BIAS)=>{if(!e)return s;const i=o.find(h=>h.id===e);if(!(i!=null&&i.width)||!i.height)return s;const c=qe(i),l=n.x-c.x,d=n.y-c.y;return Vg(l,d,i.width,i.height,a)?l>0?{x:i.x+i.width-r,y:c.y}:{x:i.x+r,y:c.y}:d>0?{x:c.x,y:i.y+i.height-r}:{x:c.x,y:i.y+r}};function ci(e,s,n){switch(s){case"fixed-minimum":return Math.max(e*.5,50)*n;case"no-minimum":return e*.5*n;case"scaled-minimum":const o=Math.min(e*.3,50);return Math.max(e*.5,o)*n;case"proportional":return Math.max(e*.4,10)*n;default:return Math.max(e*.5,50)*n}}function Ug(e,s,n,o){const r=s.x-e.x,a=s.y-e.y,i=Math.abs(r),c=Math.abs(a),l=(o==null?void 0:o.dx)??r,d=(o==null?void 0:o.dy)??a,u=J.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,h=J.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,f=J.arrows.CUBIC_CONTROL_DISTANCE_MODE;let g,w;if(n==="horizontal"){const m=ci(i,f,u),x=l>0?1:-1,y=h?-1:1;g={x:e.x+x*m*y,y:e.y},w={x:s.x-x*m*y,y:s.y}}else{const m=ci(c,f,u),x=d>0?1:-1,y=h?-1:1;g={x:e.x,y:e.y+x*m*y},w={x:s.x,y:s.y-x*m*y}}return[g,w]}const Eo=(e,s,n,o,r=0)=>{if(!e)return s;const a=o.find(l=>l.id===e);if(!(a!=null&&a.width)||!a.height)return s;const i=qe(a);return n.x-i.x>0?{x:a.x+a.width-r,y:i.y}:{x:a.x+r,y:i.y}},Al=(e,s,n)=>{if(!e)return s;const o=n.find(a=>a.id===e);return!(o!=null&&o.width)||!o.height?s:{x:qe(o).x,y:o.y+o.height}};function Il(e,s,n){const o=e.type??J.arrows.type,r=J.arrows.CUBIC_HORIZONTAL_BIAS,a=-10,i=s.find(h=>h.id===e.startNodeId),c=s.find(h=>h.id===e.endNodeId),l=o==="TreeCubic"||o==="TreeLStep"||o==="TreeZShape";let d;if(l&&i&&c){const h=qe(i);d=Eo(e.endNodeId,e.endPoint,h,s,a)}else if((o==="Cubic"||o==="Orthogonal")&&i&&c){const h=qe(i);d=Fs(e.endNodeId,e.endPoint,h,s,a,r)}else if(o==="Step"&&i&&c){const h=qe(i),f=qe(c),g=f.x-h.x,w=f.y-h.y,x=Math.abs(g)*r>=Math.abs(w)?.001:1e3;d=Fs(e.endNodeId,e.endPoint,h,s,a,x)}else{const h=i?et(e.startNodeId,e.startPoint,e.endPoint,s,e.startRowId):e.startPoint;d=c?et(e.endNodeId,e.endPoint,h,s,e.endRowId):e.endPoint}let u;if(o==="TreeLStep"&&i)u=Al(e.startNodeId,e.startPoint,s);else if((o==="TreeCubic"||o==="TreeZShape")&&i&&c){const h=qe(c);u=Eo(e.startNodeId,e.startPoint,h,s,0)}else if((o==="Cubic"||o==="Step"||o==="Orthogonal")&&i&&c){const h=qe(c);u=Fs(e.startNodeId,e.startPoint,h,s,0,r)}else{const h=c?et(e.endNodeId,e.endPoint,e.startPoint,s,e.endRowId):e.endPoint;u=i?et(e.startNodeId,e.startPoint,h,s,e.startRowId):e.startPoint}return{actualStartPoint:u,actualEndPoint:d}}function Gg(e,s,n){const{actualStartPoint:o,actualEndPoint:r}=Il(e,s),a=Math.min(o.x,r.x),i=Math.min(o.y,r.y),c=Math.max(o.x,r.x),l=Math.max(o.y,r.y);return{x:a,y:i,width:c-a,height:l-i}}const li={SELECTION_BOX_END:"selectionBoxEnd"};class Yg{constructor(){Fe(this,"listeners",{})}subscribe(s,n){return this.listeners[s]||(this.listeners[s]=[]),this.listeners[s].push(n),()=>{this.unsubscribe(s,n)}}unsubscribe(s,n){this.listeners[s]&&(this.listeners[s]=this.listeners[s].filter(o=>o!==n))}dispatch(s,n){this.listeners[s]&&this.listeners[s].forEach(o=>{try{o(n)}catch(r){console.error(`Error in event listener for ${s} event:`,r)}})}}const Kg=new Yg,us=new Cs("useSelectionHandler",js.useSelectionHandler),Xg=e=>e?J.autoScroll.edgeThresholdMobile:J.autoScroll.edgeThreshold,Kn=J.autoScroll.scrollSpeed,yr=e=>{const n=e.target.closest("[data-canvas-container]");if(!n)return console.warn("Canvas container not found, falling back to offsetX/Y"),{x:e.offsetX,y:e.offsetY};const o=n.getBoundingClientRect();return{x:e.clientX-o.left,y:e.clientY-o.top}},qg=()=>{var d;const e=E.getState(),s=e.uiState.mode,n=(d=e.uiState)==null?void 0:d.isPanning,o=e.setSelectionBox,r=e.setPendingSelectionStart,a=e.setSelectedNodes,i=e.setNodeToFocusId,c=e.arrow.setSelected,l=tr();return p.useCallback(u=>{var S,I,C,k;const h=yr(u);if(s===Q.MOVE||((S=E.getState().uiState)==null?void 0:S.dragInfo))return;const g=u.target,w=g.closest("[data-node-id]"),m=g.closest("[data-arrow-id]"),x=g.closest("[data-group-id]"),y=g.closest("[data-ui-panel]"),v=g.closest("[data-grid-svg]"),N=v&&v.getAttribute("data-grid-active")==="true",b=!!g.closest("foreignObject");if((s===Q.SELECT||s===Q.GRID||s===Q.WRITE||s===Q.VIM)&&(u.button===0||u.button===-1)&&!n){if(w||m||x||y||N||b)return;const R=u.shiftKey&&!u.ctrlKey&&!u.metaKey,A=e.projectCanvas.getActive();if((I=A==null?void 0:A.coreState.nodes)==null?void 0:I.some(L=>L.isEditing))return;const O=(A==null?void 0:A.coreState.selectedNodes)??[],$=(A==null?void 0:A.coreState.nodes)??[],B=(A==null?void 0:A.viewState.scale)??1,H=(A==null?void 0:A.viewState.offset)??{x:0,y:0};if(R&&O.length>0){const L=wt(h,B,H),z=O[O.length-1],_=[{x:z.x,y:z.y},{x:z.x+(z.width??0),y:z.y},{x:z.x,y:z.y+(z.height??0)},{x:z.x+(z.width??0),y:z.y+(z.height??0)}];let G=_[0],V=0;_.forEach(q=>{const le=Math.sqrt(Math.pow(q.x-L.x,2)+Math.pow(q.y-L.y,2));le>V&&(V=le,G=q)});const D={x:Math.min(G.x,L.x),y:Math.min(G.y,L.y),width:Math.abs(G.x-L.x),height:Math.abs(G.y-L.y)},K=(A==null?void 0:A.coreState.activeLayerId)??pt,te=$.filter(q=>{if((q.layerId??pt)!==K)return!1;const de=To(q);return Io(de,D)}),ie=new Set(O.map(q=>q.id)),ye=te.filter(q=>!ie.has(q.id)),ge=[...O,...ye];a(ge);return}if(us.log("Selection Mouse Down on Background:",h.x,h.y),s===Q.WRITE){const L=e.projectCanvas.getActive(),z=(L==null?void 0:L.viewState.scale)??1,_=(L==null?void 0:L.viewState.offset)??{x:0,y:0},G=wt(h,z,_);Dc(async()=>{const{CanvasNodeBuilderV2:V}=await Promise.resolve().then(()=>Gp);return{CanvasNodeBuilderV2:V}},void 0).then(({CanvasNodeBuilderV2:V})=>{const D=V.buildTextNode(G,"");D.isEditing=!0,e.addNode(D,""),e.setNodeToFocusId(D.id)});return}const M=(C=E.getState().uiState)==null?void 0:C.pendingSelectionStart,j=(k=E.getState().uiState)==null?void 0:k.selectionBox;if(M&&j){r(null);return}const P=wt(h,B,H);r(P),a([]),c([]),i(null);const W=u.pointerType==="touch";if(l&&W)return;o({start:h,end:h})}},[s,n,o,r,a,i,c,e,l])},Zg=()=>{const e=E.getState(),s=e.setSelectionBox,n=e.setActiveCanvasViewState,o=F(d=>d.uiState.selectionBox),r=_n(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useCallback(()=>{var w,m;const d=E.getState().projectCanvas.getActive(),u=(w=E.getState().uiState)==null?void 0:w.selectionBox;if(!d||!u){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const h=d.viewState.offset;let f=0,g=0;if(f=i.current.x,g=i.current.y,f!==0||g!==0){n(y=>({...y,offset:{x:h.x+f,y:h.y+g}}));const x=(m=E.getState().uiState)==null?void 0:m.selectionBox;if(x){const y={x:x.start.x+f,y:x.start.y+g};s({start:y,end:x.end})}}a.current=requestAnimationFrame(l)},[n,s]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useEffect(()=>{o||(c.current=null)},[o]),p.useCallback(d=>{var H,M,j,P,W;if((H=E.getState().uiState)==null?void 0:H.dragInfo)return;const h=yr(d),f=(M=E.getState().uiState)==null?void 0:M.pendingSelectionStart,g=E.getState().projectCanvas.getActive(),w=(g==null?void 0:g.viewState.scale)??1,m=(g==null?void 0:g.viewState.offset)??{x:0,y:0};if((j=g==null?void 0:g.coreState.nodes)==null?void 0:j.some(L=>L.isEditing))return;const y=(d.buttons&1)!==0;if(f&&d.shiftKey&&!y){const L=f.x*w+m.x,z=f.y*w+m.y;s({start:{x:L,y:z},end:h});return}if(f&&!d.shiftKey&&!y){((P=E.getState().uiState)==null?void 0:P.selectionBox)&&s(null);return}if(!o)return;const v=(W=E.getState().uiState)==null?void 0:W.selectionBox;if(!v)return;const N=window.innerWidth,b=window.innerHeight;let S=0,I=0;c.current&&(S=h.x-c.current.x,I=h.y-c.current.y),c.current={x:h.x,y:h.y},s({start:v.start,end:h});const C=d.clientX,k=d.clientY,R=Xg(r),A=k<R&&I<0,T=k>b-R&&I>0,O=C<R&&S<0,$=C>N-R&&S>0,B=A||T||O||$;if(B){let L=0,z=0;A&&(z=Kn),T&&(z=-Kn),O&&(L=Kn),$&&(L=-Kn),i.current={x:L,y:z},a.current===null&&(a.current=requestAnimationFrame(l))}else!B&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null,i.current={x:0,y:0})},[s,o,l,r])},Jg=()=>{var c;const e=E.getState(),s=e.setSelectionBox,n=e.setPendingSelectionStart,o=(c=e.uiState)==null?void 0:c.selectionBox,r=e.projectCanvas.getActive,a=e.setSelectedNodes,i=e.arrow.setSelected;return p.useCallback(l=>{var v,N,b;if((v=E.getState().uiState)==null?void 0:v.dragInfo)return;const u=yr(l),h=r(),f=(h==null?void 0:h.coreState.nodes)??[],g=(h==null?void 0:h.coreState.arrows)??[],w=(h==null?void 0:h.viewState.scale)??1,m=(h==null?void 0:h.viewState.offset)??{x:0,y:0},x=(N=E.getState().uiState)==null?void 0:N.selectionBox,y=(b=E.getState().uiState)==null?void 0:b.pendingSelectionStart;if(x){us.log("Selection Mouse Up:",u.x,u.y),us.log("Stopped Marquee Selection");const S={x:Math.min(x.start.x,u.x),y:Math.min(x.start.y,u.y),width:Math.abs(x.start.x-u.x),height:Math.abs(x.start.y-u.y)},I=wt({x:S.x,y:S.y},w,m),C=wt({x:S.x+S.width,y:S.y+S.height},w,m),k={x:I.x,y:I.y,width:C.x-I.x,height:C.y-I.y},R=5;if(S.width<R&&S.height<R){const B=E.getState().uiState.activeGroupId;if(B){const H=f.find(M=>M.id===B);if(H){const M=To(H),j=wt(u,w,m);j.x>=M.x&&j.x<=M.x+M.width&&j.y>=M.y&&j.y<=M.y+M.height||E.getState().group.setActiveGroupId(null)}else E.getState().group.setActiveGroupId(null)}y||(s(null),a([]),i([]));return}const A=E.getState().uiState.activeGroupId,T=(h==null?void 0:h.coreState.activeLayerId)??pt,O=f.filter(B=>{if(A&&B.id===A||(B.layerId??pt)!==T)return!1;const M=To(B);return Io(M,k)});us.log("Selected Nodes by Marquee:",O.map(B=>B.content)),a(O);const $=g.filter(B=>{const H=Gg(B,f),M=Io(H,k);return us.log(">>>> _ >>>> ~ useSelectionHandler.ts:164 ~ arrowBBox:",H),M});us.log("Selected Arrows by Marquee:",$.map(B=>B.id)),i($),O.length>0&&(Kg.dispatch(li.SELECTION_BOX_END,{selectedNodes:O}),us.log(`Dispatched ${li.SELECTION_BOX_END} event with nodes:`,O.map(B=>B.id))),s(null),n(null)}},[o,r,s,n,a,i])},Qg=()=>{const e=An.getState().mousePosition??null,n=E.getState().projectCanvas.getActive,o=n(),r=(o==null?void 0:o.viewState.scale)??1,a=(o==null?void 0:o.viewState.offset)??{x:0,y:0},i=p.useMemo(()=>e?wt(e,r,a):null,[e,r,a]);return{screenCoords:e,canvasCoords:i}},Nt={"I am dragging a node near the <edge> edge":"I am dragging a node near the <edge> edge","I am dragging a node near the top edge":"I am dragging a node near the top edge","I am dragging a node toward the <edge> edge":"I am dragging a node toward the <edge> edge","I am in GRID mode":"I am in GRID mode","I am in MOVE mode":"I am in MOVE mode","I am in SELECT mode":"I am in SELECT mode","I am in WRITE mode":"I am in WRITE mode","I have a canvas with nodes":"I have a canvas with nodes","I have selected a node":"I have selected a node","auto-scroll is active":"auto-scroll is active"},Gt={"I click on a node":"I click on a node","I hold Ctrl and click on another node":"I hold Ctrl and click on another node","I hold Ctrl and click on one of the selected nodes":"I hold Ctrl and click on one of the selected nodes","I hold Shift and click on a node":"I hold Shift and click on a node"},ef=e=>e?J.autoScroll.edgeThresholdMobile:J.autoScroll.edgeThreshold,po=J.autoScroll.edgeThreshold;let Tl=!1;const tf=e=>{Tl=e};let Ba=0,El=0;const go={[Nt["I have a canvas with nodes"]]:()=>{const e=E.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.nodes.length)??0)>0},[Nt["I have selected a node"]]:()=>{const e=E.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.selectedNodes.length)??0)>0},[Nt["I am dragging a node near the top edge"]]:(e,s=po)=>E.getState().uiState.dragInfo?(e??Ba)<s:!1,[Nt["I am dragging a node near the <edge> edge"]]:(e,s,n,o=po)=>{if(!E.getState().uiState.dragInfo)return!1;const i=s??El,c=n??Ba;switch(e){case"top":return c<o;case"bottom":return c>window.innerHeight-o;case"left":return i<o;case"right":return i>window.innerWidth-o;default:return!1}},[Nt["auto-scroll is active"]]:()=>Tl,[Nt["I am dragging a node toward the <edge> edge"]]:(e,s,n,o=po)=>{if(!E.getState().uiState.dragInfo)return!1;const i=go[Nt["I am dragging a node near the <edge> edge"]](e,void 0,void 0,o);if(!i)return!1;if(s===void 0&&n===void 0)return i;switch(e){case"top":return(n??0)<0;case"bottom":return(n??0)>0;case"left":return(s??0)<0;case"right":return(s??0)>0;default:return!1}}},sf=(e,s)=>{El=e,Ba=s},os=J.autoScroll.scrollSpeed,Rl=(e,s,n=po)=>{if(e===null||s===null)return{x:0,y:0};let o=0,r=0;const a=window.innerWidth,i=window.innerHeight;return e<n?o=os:e>a-n&&(o=-os),s<n?r=os:s>i-n&&(r=-os),{x:o,y:r}},nf=(e,s)=>({x:-e.x/s,y:-e.y/s}),Xn={getScrollDeltaForMousePosition:(e,s)=>Rl(e,s),shouldScroll:e=>e.x!==0||e.y!==0,applyDeltaToPosition:(e,s,n)=>({x:Number((e+n.x).toFixed(2)),y:Number((s+n.y).toFixed(2))})},Ms={calculateScrollDelta:(e,s)=>{if(e){const n=Rl(e.x,e.y),o=Xn.shouldScroll(n);return{delta:n,shouldUpdateLastDelta:o}}return{delta:s,shouldUpdateLastDelta:!1}},calculateNewOffset:(e,s)=>({x:e.x+s.x,y:e.y+s.y}),updateNodesForScroll:(e,s,n)=>e.map(o=>{if(s.has(o.id)){const r=Xn.applyDeltaToPosition(o.x,o.y,n);return{...o,...r}}return o}),updateSelectedNodesForScroll:(e,s)=>e.map(n=>{const o=Xn.applyDeltaToPosition(n.x,n.y,s);return{...n,...o}}),updateArrowsForScroll:(e,s,n)=>e.map(o=>{let r=o.startPoint,a=o.endPoint;return o.startNodeId&&s.has(o.startNodeId)&&(r={x:Number((o.startPoint.x+n.x).toFixed(2)),y:Number((o.startPoint.y+n.y).toFixed(2))}),o.endNodeId&&s.has(o.endNodeId)&&(a={x:Number((o.endPoint.x+n.x).toFixed(2)),y:Number((o.endPoint.y+n.y).toFixed(2))}),r!==o.startPoint||a!==o.endPoint?{...o,startPoint:r,endPoint:a}:o}),processAutoScrollFrame:e=>{const{mousePosition:s,lastScrollDelta:n,currentOffset:o,scale:r,nodes:a,selectedNodes:i,arrows:c=[]}=e,{delta:l}=Ms.calculateScrollDelta(s,n);if(!Xn.shouldScroll(l))return{shouldScroll:!1,scrollDelta:l,newOffset:o,updatedNodes:a,updatedSelectedNodes:i,updatedArrows:c};const u=Ms.calculateNewOffset(o,l),h=nf(l,r),f=new Set(i.map(x=>x.id)),g=Ms.updateNodesForScroll(a,f,h),w=Ms.updateSelectedNodesForScroll(i,h),m=Ms.updateArrowsForScroll(c,f,h);return{shouldScroll:!0,scrollDelta:l,newOffset:u,updatedNodes:g,updatedSelectedNodes:w,updatedArrows:m}}},Fa={isShiftPressed:e=>e.shiftKey&&!e.ctrlKey&&!e.metaKey,isCtrlPressed:e=>e.ctrlKey||e.metaKey,noModifiersPressed:e=>!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey},of=e=>{const s=E.getState().projectCanvas.getActive();return(s==null?void 0:s.coreState.selectedNodes.some(n=>n.id===e))??!1},qn=()=>{const e=E.getState().projectCanvas.getActive();return(e==null?void 0:e.coreState.selectedNodes)??[]},$a={isClickOnEditingElement:e=>!!e.closest("[data-is-editing='true']"),hasActiveTextSelection:()=>{const e=window.getSelection();return e!==null&&!e.isCollapsed&&e.toString().length>0},getSelectedText:()=>{const e=window.getSelection();return(e==null?void 0:e.toString())??""},isInsideTextInput:e=>{const s=e.tagName.toLowerCase();return s==="textarea"||s==="input"?!0:!!e.closest('textarea, input, [contenteditable="true"]')}},af=(e,s)=>{const n=[];for(const o of s)o.startNodeId===e&&o.endNodeId&&n.push(o.endNodeId);return n},rf=(e,s)=>s.filter(n=>n.endNodeId===e).length,Ml=(e,s,n,o=!1)=>{const r=new Set(e),a=new Set,i=[...e],c=new Set(e);for(;i.length>0;){const d=i.shift(),u=af(d,n);for(const h of u)c.has(h)||s.some(f=>f.id===h)&&(c.add(h),!(o&&rf(h,n)>1)&&(a.add(h),i.push(h)))}return s.filter(d=>a.has(d.id)&&!r.has(d.id))},cf=(e,s)=>{const n=new Set,o=e.filter(r=>r.isCollapsed);for(const r of o)Ml([r.id],e,s,!0).forEach(i=>n.add(i.id));return n};let lf=!0;const di={isDragInProgress:()=>{var s;const e=(s=E.getState().uiState)==null?void 0:s.dragInfo;return e!=null},isDragWithSelectedNodes:()=>{var o;const e=E.getState();if(!((o=e.uiState)==null?void 0:o.dragInfo))return!1;const n=e.projectCanvas.getActive();return((n==null?void 0:n.coreState.selectedNodes.length)??0)>0},isFirstMoveEvent:()=>lf,[Nt["I am in SELECT mode"]]:()=>E.getState().uiState.mode===Q.SELECT,[Nt["I am in GRID mode"]]:()=>E.getState().uiState.mode===Q.GRID,[Nt["I am in MOVE mode"]]:()=>E.getState().uiState.mode===Q.MOVE,[Nt["I am in WRITE mode"]]:()=>E.getState().uiState.mode===Q.WRITE,canDragInCurrentMode:()=>{const e=E.getState().uiState.mode;return e===Q.SELECT||e===Q.GRID||e===Q.WRITE||e===Q.VIM},isPrimaryButton:e=>e.button===0||e.button===-1},un={calculateScreenDelta:e=>{const{screenCoords:s,prevScreenPos:n}=e;if(!s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:null,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!0};if(s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:s,newDragDirection:null,isFirstMoveEvent:!0,shouldSkipFrame:!0};if(s&&n){const o={x:s.x-n.x,y:s.y-n.y},r=o.x!==0||o.y!==0?o:null;return{screenDelta:o,newPrevScreenPos:s,newDragDirection:r,isFirstMoveEvent:!1,shouldSkipFrame:!1}}return{screenDelta:{x:0,y:0},newPrevScreenPos:n,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!1}},screenDeltaToCanvasDelta:(e,s)=>({x:e.x/s,y:e.y/s}),checkAutoScrollEdges:e=>{const{screenCoords:s,dragDirection:n,draggedNode:o,scale:r,offset:a,edgeThreshold:i}=e;let c=!1;o&&(c=o.y*r+a.y<=0&&n.y<0);const l=c,d=go[Nt["I am dragging a node toward the <edge> edge"]]("bottom",n.x,n.y,i),u=go[Nt["I am dragging a node toward the <edge> edge"]]("left",n.x,n.y,i),h=go[Nt["I am dragging a node toward the <edge> edge"]]("right",n.x,n.y,i);return{shouldAutoScroll:l||d||u||h}},calculateMouseLeftWindowDelta:e=>{const{lastCoords:s,viewportWidth:n,viewportHeight:o}=e;if(!s)return{shouldStartAutoScroll:!1,scrollDelta:{x:0,y:0}};let r=0,a=0;return s.x<n/2?r=os:r=-os,s.y<o/2?a=os:a=-os,{shouldStartAutoScroll:!0,scrollDelta:{x:r,y:a}}},calculateNodeMoves:e=>{const{canvasDelta:s,draggedNodeId:n,selectedNodes:o,nodes:r,arrows:a,isCtrlPressed:i,isShiftPressed:c}=e;if(Math.abs(s.x)<.1&&Math.abs(s.y)<.1)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const l=new Set(o.map(m=>m.id));let d=new Set(l);if(i){const m=c??!1;Ml(Array.from(l),r,a,m).forEach(y=>d.add(y.id))}for(const m of o)if(m.type===ce.GROUP){const x=m.data,y=x==null?void 0:x.childNodeIds;if(y)for(const v of y)d.add(v)}if(d.size===0)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const u=s.x,h=s.y;let f=null;for(let m=0;m<r.length;m++){const x=r[m];d.has(x.id)&&(f||(f=r.slice()),f[m]={...x,x:x.x+u,y:x.y+h})}let g=null;for(let m=0;m<o.length;m++){const x=o[m];d.has(x.id)&&(g||(g=o.slice()),g[m]={...x,x:x.x+u,y:x.y+h})}let w=null;for(let m=0;m<a.length;m++){const x=a[m],y=x.startNodeId&&d.has(x.startNodeId),v=x.endNodeId&&d.has(x.endNodeId);(y||v)&&(w||(w=a.slice()),w[m]={...x,startPoint:y?{x:x.startPoint.x+u,y:x.startPoint.y+h}:x.startPoint,endPoint:v?{x:x.endPoint.x+u,y:x.endPoint.y+h}:x.endPoint})}return{shouldUpdate:!0,updatedNodes:f??r,updatedSelectedNodes:g??o,updatedArrows:w??a}}},df=(e,s)=>{const n=[{x:e.x,y:e.y},{x:e.x+(e.width??0),y:e.y},{x:e.x,y:e.y+(e.height??0)},{x:e.x+(e.width??0),y:e.y+(e.height??0)}];let o=n[0],r=0;return n.forEach(a=>{const i=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2));i>r&&(r=i,o=a)}),o},uf=(e,s)=>({x:Math.min(e.x,s.x),y:Math.min(e.y,s.y),width:Math.abs(e.x-s.x),height:Math.abs(e.y-s.y)}),hf=(e,s)=>e.filter(n=>{const o=To(n);return Io(o,s)}),pf=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=s.filter(r=>!n.has(r.id));return[...e,...o]},Ps={[Gt["I hold Shift and click on a node"]]:(e,s)=>{const o=E.getState().projectCanvas.getActive(),r=(o==null?void 0:o.coreState.selectedNodes)??[],a=(o==null?void 0:o.coreState.nodes)??[];if(r.length===0)return[e];const i=r[r.length-1],c=df(i,s),l=uf(c,s),d=hf(a,l);return pf(r,d)},[Gt["I hold Ctrl and click on one of the selected nodes"]]:e=>qn().filter(n=>n.id!==e.id),[Gt["I hold Ctrl and click on another node"]]:e=>[...qn(),e],[Gt["I click on a node"]]:(e,s)=>s?qn():[e],handleNodeMouseDown:e=>{const{node:s,event:n,canvasCoords:o}=e,r=E.getState(),a=r.projectCanvas.getActive(),i=qn(),c=of(s.id),l=(a==null?void 0:a.coreState.activeLayerId)??pt,d=s.layerId??pt;if(d!==l)return{action:"wrong_layer",shouldStartDrag:!1,newSelection:i,targetLayerId:d,clickedNode:s};const u=s.groupId,h=r.uiState.activeGroupId,f=(a==null?void 0:a.coreState.nodes)??[];if(s.type===ce.GROUP&&c&&i.length===1&&h!==s.id)return r.group.setActiveGroupId(s.id),{action:"keep_selection",shouldStartDrag:!0,newSelection:i,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};if(u&&u!==h){const m=f.find(x=>x.id===u&&x.type===ce.GROUP);if(m)return i.length===1&&i[0].id===m.id?(r.group.setActiveGroupId(u),{action:"replace_selection",shouldStartDrag:!0,newSelection:Ps[Gt["I click on a node"]](s,c),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}):{action:"select_group",shouldStartDrag:!1,newSelection:[m],selectedGroup:m}}if(Fa.isShiftPressed(n)&&i.length>0)return{action:"shift_select",shouldStartDrag:!1,newSelection:Ps[Gt["I hold Shift and click on a node"]](s,o)};if(Fa.isCtrlPressed(n))return c?{action:"ctrl_toggle_remove",shouldStartDrag:!1,newSelection:Ps[Gt["I hold Ctrl and click on one of the selected nodes"]](s)}:{action:"ctrl_toggle_add",shouldStartDrag:!0,newSelection:Ps[Gt["I hold Ctrl and click on another node"]](s),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};h&&u!==h&&r.group.setActiveGroupId(null);const w=Ps[Gt["I click on a node"]](s,c);return{action:c?"keep_selection":"replace_selection",shouldStartDrag:!0,newSelection:w,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}}},At={isNodeInsideGroup:(e,s)=>Oc(e,s),isNodeInGroup:e=>e.groupId!==void 0&&e.groupId!==null,isGroupNode:e=>e.type===ce.GROUP,canBeAddedToGroup:e=>!At.isGroupNode(e)&&!At.isNodeInGroup(e),isValidDropCandidate:e=>!At.isGroupNode(e)},wa={filterValidDropCandidates:e=>e.filter(At.canBeAddedToGroup),filterNodesInGroups:e=>e.filter(At.isNodeInGroup),filterGroupNodes:e=>e.filter(At.isGroupNode),getCurrentGroupForNode:(e,s)=>{if(e.groupId)return s.find(n=>n.id===e.groupId)},findGroupDropTargets:(e,s)=>e.filter(n=>n.type===ce.GROUP&&!s.has(n.id))},Pl={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Set(s.map(i=>i.id)),a=wa.findGroupDropTargets(n,r);for(const i of s){if(At.isGroupNode(i)||At.isNodeInGroup(i))continue;const c=a.find(l=>l.id===o?!1:At.isNodeInsideGroup(i,l));if(c)return{hoveredGroupId:c.id,hasValidDropTarget:!0}}return{hoveredGroupId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Map,a=[],i=new Set(s.map(d=>d.id)),c=wa.findGroupDropTargets(n,i);for(const d of s){if(At.isGroupNode(d))continue;if(At.isNodeInGroup(d)){const h=wa.getCurrentGroupForNode(d,c);h&&!At.isNodeInsideGroup(d,h)&&a.push(d.id);continue}const u=c.find(h=>h.id===o?!1:At.isNodeInsideGroup(d,h));if(u){const h=r.get(u.id)||[];h.push(d.id),r.set(u.id,h)}}const l=r.size>0||a.length>0;return{nodesToAddToGroups:r,nodesToRemoveFromGroups:a,hasChanges:l}}},gf=69,ff=41,mf=45,za={isTableNode:e=>e.type===ce.TABLE,isPointInsideNode:(e,s)=>{const n=In(s);return e.x>=n.x1&&e.x<=n.x2&&e.y>=n.y1&&e.y<=n.y2},hasValidTableData:e=>{const s=e.data;return!!(s!=null&&s.columns)&&Array.isArray(s.columns)&&s.columns.length>0}},Sn={getNodeCenter:e=>{const s=In(e);return{x:(s.x1+s.x2)/2,y:(s.y1+s.y2)/2}},findTableDropTargets:(e,s)=>e.filter(n=>za.isTableNode(n)&&!s.has(n.id)),calculateTargetColumn:(e,s)=>{const n=s.data;if(!(n!=null&&n.columns)||n.columns.length===0)return null;const o=In(s),r=o.x2-o.x1,a=e-o.x1,i=n.columnOrder&&n.columnOrder.length>0?n.columnOrder.map(f=>n.columns.find(g=>g.key===f)).filter(f=>f!==void 0):n.columns;let c=0;for(const f of i)c+=f.width?parseInt(f.width,10):150;const l=r/c;let d=0;const u=[];for(let f=0;f<i.length;f++){const g=i[f],m=(g.width?parseInt(g.width,10):150)*l,x=d;d+=m,u.push({key:g.key,relStart:Math.round(x),relEnd:Math.round(d),absStart:Math.round(o.x1+x),absEnd:Math.round(o.x1+d)})}for(let f=0;f<u.length;f++){const g=u[f];if(a<g.relEnd)return{columnIndex:f,columnKey:g.key}}const h=i[i.length-1];return{columnIndex:i.length-1,columnKey:h.key}},calculateTargetRow:(e,s)=>{const n=s.data;if(!(n!=null&&n.rows)||n.rows.length===0)return null;const o=In(s),r=e-o.y1,a=gf+ff;if(r<a)return null;const i=Math.floor((r-a)/mf);if(i<0)return null;if(i>=n.rows.length){const c=n.rows[n.rows.length-1];return{rowIndex:n.rows.length-1,rowId:c.id}}return{rowIndex:i,rowId:n.rows[i].id}},extractNodeContent:e=>e.content===null||e.content===void 0?"":String(e.content)},Dl={calculateTableDropTarget:e=>{const{droppedNode:s,allNodes:n,mousePosition:o}=e,r=o??Sn.getNodeCenter(s),a=new Set([s.id]),i=Sn.findTableDropTargets(n,a);for(const c of i){if(!za.isPointInsideNode(r,c)||!za.hasValidTableData(c))continue;const l=Sn.calculateTargetColumn(r.x,c);if(!l)continue;const d=Sn.calculateTargetRow(r.y,c);return{targetTableId:c.id,columnIndex:l.columnIndex,columnKey:l.columnKey,rowIndex:(d==null?void 0:d.rowIndex)??null,rowId:(d==null?void 0:d.rowId)??null}}return{targetTableId:null,columnIndex:null,columnKey:null,rowIndex:null,rowId:null}}};var Ue=(e=>(e.DICTIONARY="dictionary",e.FLASHCARD="flashcard",e.WORD_LIST="word_list",e.ETYMOLOGY="etymology",e.VOCABULARY="vocabulary",e))(Ue||{});const $s={isVocabularyNode:e=>e.type===ce.VOCABULARY,isVocabularyMode:e=>{if(!$s.isVocabularyNode(e))return!1;const s=e.data;return(s==null?void 0:s.vocabType)===Ue.VOCABULARY},isTextNode:e=>e.type===ce.TEXT,canBeDroppedOnVocab:e=>$s.isTextNode(e),isNodeInsideVocabNode:(e,s)=>Oc(e,s)},hn={findVocabularyDropTargets:(e,s)=>e.filter(n=>$s.isVocabularyMode(n)&&!s.has(n.id)),extractNodeContent:e=>typeof e.content=="string"?e.content.trim():"",sortNodesByPosition:e=>[...e].sort((s,n)=>s.x+s.y-(n.x+n.y))},Ol={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n}=e,o=new Set(s.map(a=>a.id)),r=hn.findVocabularyDropTargets(n,o);for(const a of s){if(!$s.canBeDroppedOnVocab(a))continue;const i=r.find(c=>$s.isNodeInsideVocabNode(a,c));if(i)return{hoveredVocabNodeId:i.id,hasValidDropTarget:!0}}return{hoveredVocabNodeId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,targetVocabNode:n}=e,o=s.filter($s.canBeDroppedOnVocab);if(o.length===0)return{sourceWord:"",translationWord:"",nodeIdsToDelete:[],hasChanges:!1};const r=n.data,a=(r==null?void 0:r.sourceWord)||"",i=(r==null?void 0:r.translationWord)||"";let c=a,l=i;const d=[];if(o.length>=2){const h=hn.sortNodesByPosition(o);c=hn.extractNodeContent(h[0]),l=hn.extractNodeContent(h[h.length-1]),d.push(...o.map(f=>f.id))}else{const h=hn.extractNodeContent(o[0]);a?l=h:c=h,d.push(o[0].id)}return{sourceWord:c,translationWord:l,nodeIdsToDelete:d,hasChanges:c!==a||l!==i}}},at=new Cs("useNodeDragHandler",js.useCanvasMouseEventsV2),xf=e=>{const s=e.target,n=s.closest('[data-test="chat-messages-container"]'),o=s.closest('[data-test="chat-header"]');return n!==null&&o===null};let En=null,Cn=null;const ya=()=>{En&&(clearTimeout(En),En=null),Cn=null},_t=new Map,ui=(e,s,n,o,r)=>{const a=E.getState(),i=Ps.handleNodeMouseDown({node:e,event:s,canvasCoords:n});if(i.action==="wrong_layer"&&i.targetLayerId&&i.clickedNode){a.setUiState(c=>({...c,switchLayerDialog:{isOpen:!0,targetLayerId:i.targetLayerId,clickedNodeId:i.clickedNode.id}})),at.log(`Node Mouse Down: Node ${e.id} is on layer ${i.targetLayerId}, not current layer`);return}if(i.action==="select_group"&&i.selectedGroup){r([i.selectedGroup]),at.log("Node Mouse Down: Selected parent group node",i.selectedGroup.id,"instead of node",e.id);return}if(r(i.newSelection),at.log(`Node Mouse Down: ${i.action}`,e.id,"Selection count:",i.newSelection.length),i.shouldStartDrag&&i.dragStartOffset){const c={};for(const l of i.newSelection)c[l.id]={x:l.x,y:l.y};c[e.id]||(c[e.id]={x:e.x,y:e.y}),o({draggedNodeId:e.id,dragStartOffset:i.dragStartOffset,initialNodePosition:{x:e.x,y:e.y},initialPositions:c}),at.log("Node Drag Start on:",e.id,"tracking",Object.keys(c).length,"nodes")}},wf=e=>{const s=E.getState(),n=s.setDragInfo,o=s.setSelectedNodes;return p.useCallback(r=>{const a=E.getState().getCanvasMouseCoords();if(!di.canDragInCurrentMode()||!di.isPrimaryButton(r))return;r.stopPropagation();const i=r.target;if($a.isClickOnEditingElement(i)){at.log("Node Mouse Down: Clicked on editing node, skipping drag initialization");return}if(!a){at.warn("Node Mouse Down: Canvas coordinates not available.");return}if(xf(r)){at.log("Node Mouse Down: Inside ChatNode scroll area, starting hold-to-drag timer"),ya(),Cn={x:r.clientX,y:r.clientY},E.getState().setChatNodeHoldToDrag({nodeId:e.id,isHolding:!0,isReady:!1});let c=!1;const l=u=>{if(!c&&Cn){const h=u.clientX-Cn.x,f=u.clientY-Cn.y;Math.sqrt(h*h+f*f)>J.holdToDrag.movementThresholdPx&&(at.log("Node Mouse Down: Movement exceeded threshold, cancelling hold"),ya(),E.getState().setChatNodeHoldToDrag(null),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d))}},d=()=>{c||(at.log("Node Mouse Down: Pointer up before hold complete, cancelling hold"),ya(),E.getState().setChatNodeHoldToDrag(null),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d))};document.addEventListener("pointermove",l),document.addEventListener("pointerup",d),En=setTimeout(()=>{at.log("Node Mouse Down: Hold timer complete, starting drag"),En=null,c=!0,document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d),E.getState().setChatNodeHoldToDrag({nodeId:e.id,isHolding:!1,isReady:!0}),a&&ui(e,r,a,n,o)},J.holdToDrag.holdDelayMs);return}ui(e,r,a,n,o)},[e,n,o])},yf=()=>{const e=E.getState(),s=F(u=>u.uiState.dragInfo),n=e.setActiveCanvasCoreState,o=e.setActiveCanvasViewState;Qg();const r=_n(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useRef({x:0,y:0});p.useEffect(()=>{s&&(c.current=null)},[s]);const d=p.useCallback(()=>{var g;const u=E.getState().projectCanvas.getActive(),h=(g=E.getState().uiState)==null?void 0:g.dragInfo;if(!u||!h){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const f=Ms.processAutoScrollFrame({mousePosition:An.getState().mousePosition??null,lastScrollDelta:i.current,currentOffset:u.viewState.offset,scale:u.viewState.scale,nodes:u.coreState.nodes,selectedNodes:u.coreState.selectedNodes,arrows:u.coreState.arrows||[]});f.shouldScroll&&(i.current=f.scrollDelta,o(w=>({...w,offset:f.newOffset})),n(w=>({...w,nodes:f.updatedNodes,selectedNodes:f.updatedSelectedNodes,arrows:f.updatedArrows}))),a.current=requestAnimationFrame(d)},[o,n]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useCallback(u=>{var R,A,T;const h=(R=E.getState().uiState)==null?void 0:R.dragInfo;if(!h)return;const f=E.getState().viewLayer.getActiveId();let g;if(f){const O=((A=E.getState().projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes)??[],$=E.getState().viewLayer.getNodesWithEffectivePositions();if(O.length>0)g=O.map(B=>$.find(M=>M.id===B.id)??B);else if(h.draggedNodeId){const B=$.find(H=>H.id===h.draggedNodeId);g=B?[B]:[]}else g=[]}else g=((T=E.getState().projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??[];if(g.length===0)return;const w=An.getState().mousePosition??null,m=un.calculateScreenDelta({screenCoords:w,prevScreenPos:c.current});if(m.newPrevScreenPos!==null&&(c.current=m.newPrevScreenPos),m.newDragDirection&&(l.current=m.newDragDirection),m.shouldSkipFrame)return;const x=E.getState().projectCanvas.getActive();if(!x)return;const y=x.viewState.scale,v=un.screenDeltaToCanvasDelta(m.screenDelta,y);if(w){sf(w.x,w.y);const O=x.coreState.nodes.find(H=>H.id===h.draggedNodeId),$=ef(r),B=un.checkAutoScrollEdges({screenCoords:w,dragDirection:l.current,draggedNode:O,scale:y,offset:x.viewState.offset,edgeThreshold:$});tf(B.shouldAutoScroll),B.shouldAutoScroll&&a.current===null?a.current=requestAnimationFrame(d):!B.shouldAutoScroll&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null)}else if(a.current===null){const O=un.calculateMouseLeftWindowDelta({lastCoords:An.getState().mousePosition??null,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight});O.shouldStartAutoScroll&&(i.current=O.scrollDelta,a.current=requestAnimationFrame(d))}const N=u.target;if($a.isClickOnEditingElement(N)||$a.hasActiveTextSelection())return;const b=E.getState().viewLayer.getActiveId(),S=b?E.getState().viewLayer.getNodesWithEffectivePositions():x.coreState.nodes,I=b?S:S.map(O=>{const $=_t.get(O.id);return $?{...O,x:O.x+$.dx,y:O.y+$.dy}:O}),C=b?g:g.map(O=>{const $=_t.get(O.id);return $?{...O,x:O.x+$.dx,y:O.y+$.dy}:O}),k=un.calculateNodeMoves({canvasDelta:v,draggedNodeId:h.draggedNodeId,selectedNodes:C,nodes:I,arrows:x.coreState.arrows||[],isCtrlPressed:Fa.isCtrlPressed(u),isShiftPressed:u.shiftKey});if(k.shouldUpdate){if(b){const j=[],P=[];for(const L of k.updatedSelectedNodes)L.type===ce.GROUP?P.push({id:L.id,x:L.x,y:L.y}):j.push({id:L.id,x:L.x,y:L.y});const W=new Set(k.updatedSelectedNodes.map(L=>L.id));for(const L of k.updatedNodes){if(W.has(L.id)||L.type===ce.GROUP)continue;const z=S.find(_=>_.id===L.id);z&&(z.x!==L.x||z.y!==L.y)&&j.push({id:L.id,x:L.x,y:L.y})}j.length>0&&E.getState().viewLayer.updateNodePositions(j);for(const L of P)E.getState().viewLayer.updateGroupNode(b,L.id,{x:L.x,y:L.y});n(L=>({...L,selectedNodes:k.updatedSelectedNodes,arrows:k.updatedArrows}))}else{for(const j of k.updatedSelectedNodes){const P=S.find(W=>W.id===j.id);if(P){const W=j.x-P.x,L=j.y-P.y;_t.set(j.id,{dx:W,dy:L});const z=document.getElementById(`NodeContainerV2-${j.id}`);z&&(z.style.transform=`translate(${j.x}px, ${j.y}px)`)}}E.getState().incrementDragVersion()}const O=Pl.calculateHoveredDropTarget({draggedNodes:k.updatedSelectedNodes,allNodes:k.updatedNodes,activeGroupId:E.getState().uiState.activeGroupId??null}),$=E.getState().uiState.hoveredDropTargetGroupId;O.hoveredGroupId!==$&&E.getState().setHoveredDropTargetGroupId(O.hoveredGroupId);const B=Ol.calculateHoveredDropTarget({draggedNodes:k.updatedSelectedNodes,allNodes:k.updatedNodes}),H=E.getState().uiState.hoveredDropTargetVocabNodeId;B.hoveredVocabNodeId!==H&&E.getState().setHoveredDropTargetVocabNodeId(B.hoveredVocabNodeId);const M=k.updatedSelectedNodes.length===1?k.updatedSelectedNodes[0]:null;if(M){const j=document.querySelector("[data-canvas-container]"),P=j==null?void 0:j.getBoundingClientRect(),W=P?{x:u.clientX-P.left,y:u.clientY-P.top}:null,L=(x==null?void 0:x.viewState.scale)??1,z=(x==null?void 0:x.viewState.offset)??{x:0,y:0},_=W?{x:(W.x-z.x)/L,y:(W.y-z.y)/L}:null,G=Dl.calculateTableDropTarget({droppedNode:M,allNodes:k.updatedNodes,mousePosition:_??void 0}),V=E.getState().uiState.tableDropTarget,D=G.targetTableId&&G.columnKey?{tableId:G.targetTableId,columnKey:G.columnKey,rowId:G.rowId,rowIndex:G.rowIndex}:null;((V==null?void 0:V.tableId)!==(D==null?void 0:D.tableId)||(V==null?void 0:V.columnKey)!==(D==null?void 0:D.columnKey)||(V==null?void 0:V.rowId)!==(D==null?void 0:D.rowId))&&E.getState().setTableDropTarget(D)}else E.getState().uiState.tableDropTarget&&E.getState().setTableDropTarget(null)}},[n,d,r])},vf=()=>{const e=E.getState(),s=F(o=>o.uiState.dragInfo),n=e.setDragInfo;return p.useCallback(o=>{var r,a,i;if(s){at.log("Node Drag End (Pointer Up on):",s.draggedNodeId);const c=E.getState().projectCanvas.getActive(),l=(c==null?void 0:c.coreState.nodes)??[],d=l.find(h=>h.id===s.draggedNodeId);if(d){const f=E.getState().viewLayer.getActiveId()?E.getState().viewLayer.getNodesWithEffectivePositions():l,g=f.find(S=>S.id===d.id)??d,w=document.querySelector("[data-canvas-container]"),m=w==null?void 0:w.getBoundingClientRect(),x=(c==null?void 0:c.viewState.scale)??1,y=(c==null?void 0:c.viewState.offset)??{x:0,y:0},v=m?{x:o.clientX-m.left,y:o.clientY-m.top}:null,N=v?{x:(v.x-y.x)/x,y:(v.y-y.y)/x}:null,b=Dl.calculateTableDropTarget({droppedNode:g,allNodes:f,mousePosition:N??void 0});if(b.targetTableId&&b.columnKey){const S=Sn.extractNodeContent(d);let I=!1;if(b.rowId!==null?(I=E.getState().table.updateCellFromDrop(b.targetTableId,b.rowId,b.columnKey,S),I&&at.log(`Updated cell in table ${b.targetTableId}, row: ${b.rowId}, column: ${b.columnKey}`)):(I=E.getState().table.addRowFromDrop(b.targetTableId,b.columnKey,S),I&&at.log(`Dropped node ${d.id} onto table ${b.targetTableId}, column: ${b.columnKey}`)),I){let C=J.canvasTable.dropBehavior;try{const k=localStorage.getItem("watcher-table-node-drop-config");k&&(C=JSON.parse(k).dropBehavior)}catch{}C==="delete"?(E.getState().deleteNodeById(d.id),E.getState().setSelectedNodes([])):C==="copy"&&s.initialNodePosition&&E.getState().updateNode(d.id,{x:s.initialNodePosition.x,y:s.initialNodePosition.y}),E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),n(null);return}}}const u=E.getState().uiState.hoveredDropTargetVocabNodeId;if(u&&d){const h=(c==null?void 0:c.coreState.selectedNodes)??[],f=h.length>0?h:[d],g=l.find(w=>w.id===u);if(g){const w=Ol.calculateDropResult({droppedNodes:f,targetVocabNode:g});if(w.hasChanges){const m=g.data??{};E.getState().updateNode(u,{data:{...m,sourceWord:w.sourceWord,translationWord:w.translationWord}});for(const x of w.nodeIdsToDelete)E.getState().deleteNodeById(x);E.getState().setSelectedNodes([]),at.log(`Dropped nodes onto vocab node ${u}: source="${w.sourceWord}", translation="${w.translationWord}"`),E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),E.getState().setTableDropTarget(null),n(null);return}}}if(d){const h=(c==null?void 0:c.coreState.selectedNodes)??[],f=h.length>0?h:[d],g=Pl.calculateDropResult({droppedNodes:f,allNodes:l,activeGroupId:E.getState().uiState.activeGroupId??null});if(g.hasChanges){for(const[w,m]of g.nodesToAddToGroups)at.log(`Adding nodes ${m.join(", ")} to group ${w}`),E.getState().group.addNodesToGroup(w,m);g.nodesToRemoveFromGroups.length>0&&(at.log(`Removing nodes ${g.nodesToRemoveFromGroups.join(", ")} from their groups`),E.getState().group.removeNodesFromGroup(g.nodesToRemoveFromGroups))}}if(E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),E.getState().setTableDropTarget(null),_t.size>0){const h=((r=E.getState().projectCanvas.getActive())==null?void 0:r.coreState.nodes)??[],f=((a=E.getState().projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],g=h.map(m=>{const x=_t.get(m.id);return x?{...m,x:m.x+x.dx,y:m.y+x.dy}:m}),w=f.map(m=>{const x=_t.get(m.id);return x?{...m,x:m.x+x.dx,y:m.y+x.dy}:m});E.getState().setActiveCanvasCoreState(m=>({...m,nodes:g,selectedNodes:w})),_t.clear()}if(s.initialPositions){const h=((i=E.getState().projectCanvas.getActive())==null?void 0:i.coreState.nodes)??[],f=[];for(const[g,w]of Object.entries(s.initialPositions)){const m=h.find(x=>x.id===g);m&&(m.x!==w.x||m.y!==w.y)&&f.push({nodeId:g,from:w,to:{x:m.x,y:m.y}})}if(f.length>0){const g=$d(f);E.getState().undo.commit(g),at.log("Committed move operation for",f.length,"nodes")}}E.getState().setChatNodeHoldToDrag(null),n(null)}},[s,n])},_a=new Map,Zn=20,bf=300,ss=(e,s)=>{const n=tr(),o=p.useRef(null),r=p.useCallback(()=>{o.current&&(clearTimeout(o.current),o.current=null),E.getState().setNodeHoldToResize(null)},[]);return p.useCallback(a=>{const i=E.getState(),c=i.uiState.mode,l=i.setResizingNode;if(c!==Q.SELECT||a.button!==0&&a.button!==-1)return;a.stopPropagation();const d=i.projectCanvas.getActive(),u=(d==null?void 0:d.viewState.scale)??1,h=(d==null?void 0:d.viewState.offset)??{x:0,y:0},f={x:a.clientX,y:a.clientY},g=wt(f,u,h),w=d==null?void 0:d.coreState.nodes.find(x=>x.id===e.id),m={x:(w==null?void 0:w.x)??e.x,y:(w==null?void 0:w.y)??e.y,width:(w==null?void 0:w.width)??e.width??100,height:(w==null?void 0:w.height)??e.height??50};if(n){r(),i.setNodeHoldToResize({nodeId:e.id,edge:s,isHolding:!0,isReady:!1,touchX:a.clientX,touchY:a.clientY}),o.current=setTimeout(()=>{var y;(y=navigator.vibrate)==null||y.call(navigator,50),i.setNodeHoldToResize({nodeId:e.id,edge:s,isHolding:!1,isReady:!0,touchX:a.clientX,touchY:a.clientY}),l({id:e.id,handle:s,startNodeRect:m,startPointerPos:g})},bf);const x=()=>{r(),document.removeEventListener("pointerup",x),document.removeEventListener("pointercancel",x)};document.addEventListener("pointerup",x),document.addEventListener("pointercancel",x);return}l({id:e.id,handle:s,startNodeRect:m,startPointerPos:g})},[e,s,n,r])},Nf=()=>{var n;const e=E.getState(),s=(n=e.uiState)==null?void 0:n.resizingNode;return p.useCallback(o=>{if(!s)return;const{id:r,handle:a,startNodeRect:i,startPointerPos:c}=s,l=e.projectCanvas.getActive(),d=(l==null?void 0:l.viewState.scale)??1,u=(l==null?void 0:l.viewState.offset)??{x:0,y:0},h={x:o.clientX,y:o.clientY},f=wt(h,d,u),g=f.x-c.x,w=f.y-c.y;let m=i.x,x=i.y,y=i.width,v=i.height;a.includes("left")&&(y=Math.round(Math.max(Zn,i.width-g)),m=i.x+i.width-y),a.includes("right")&&(y=Math.round(Math.max(Zn,i.width+g))),a.includes("top")&&(v=Math.round(Math.max(Zn,i.height-w)),x=i.y+i.height-v),a.includes("bottom")&&(v=Math.round(Math.max(Zn,i.height+w))),_a.set(r,{x:m,y:x,width:y,height:v});const N=document.getElementById(`NodeContainerV2-${r}`);if(N){N.style.transform=`translate(${m}px, ${x}px)`,N.style.width=`${y}px`,N.style.height=`${v}px`;const b=N.querySelector('[data-test="draw-node-svg"]');b&&(b.style.width=`${y}px`,b.style.height=`${v}px`)}},[s,e])};function Sf(e,s){const n=e.x+(e.width??100),o=e.y+(e.height??50),r=s.x+s.width,a=s.y+s.height;return e.x>=s.x&&e.y>=s.y&&n<=r&&o<=a}const Cf=()=>{var r;const e=E.getState(),s=(r=e.uiState)==null?void 0:r.resizingNode,n=e.setResizingNode,o=e.updateNode;return p.useCallback(a=>{var i;if(s){const{id:c,handle:l,startNodeRect:d}=s,u=_a.get(c),h=l.includes("top")||l.includes("bottom"),f=l.includes("left")||l.includes("right"),g=e.projectCanvas.getActive(),w=g==null?void 0:g.coreState.nodes.find(m=>m.id===c);if(u)if(h)o(c,{x:u.x,y:u.y,width:u.width,height:u.height,options:{lockSize:!0}});else if(f){const m=((i=w==null?void 0:w.data)==null?void 0:i.nodeType)==="workflowOrchestration";if(w&&w.content&&!m){const x=ht(w.content,u.width,w);o(c,{x:u.x,y:u.y,width:u.width,height:x,options:{lockSize:!0}})}else o(c,{x:u.x,y:u.y,width:u.width,height:u.height})}else o(c,{x:u.x,y:u.y,width:u.width,height:u.height});if(w&&w.type===ce.GROUP&&J.groups.autoAddNodesOnExpand){const m=w.data,x=new Set((m==null?void 0:m.childNodeIds)??[]),y=(g==null?void 0:g.coreState.nodes)??[],v=u??{x:w.x,y:w.y,width:w.width??100,height:w.height??50},N=y.filter(b=>b.id===c||b.type===ce.GROUP||x.has(b.id)||b.groupId&&b.groupId!==c?!1:Sf(b,v));if(N.length>0){const b=N.map(S=>S.id);e.group.addNodesToGroup(c,b)}}if(u&&(u.x!==d.x||u.y!==d.y||u.width!==d.width||u.height!==d.height)){const x={type:"node:resize",nodeId:c,from:d,to:u};E.getState().undo.commit(x)}_a.delete(c),n(null),e.setNodeHoldToResize(null)}},[s,n,o,e])},jf=30,Ro=(e,s)=>{const n=document.elementsFromPoint(e,s);for(const a of n){const i=a.getAttribute("data-row-connector"),c=a.getAttribute("data-node-id");if(i&&c)return{nodeId:c,rowId:i}}const o=document.querySelectorAll("[data-row-connector]");let r=null;return o.forEach(a=>{const i=a.getBoundingClientRect(),c=i.left+i.width/2,l=i.top+i.height/2,d=Math.sqrt(Math.pow(e-c,2)+Math.pow(s-l,2));if(d<=jf){const u=a.getAttribute("data-row-connector")??"",h=a.getAttribute("data-node-id")??"";u&&h&&(!r||d<r.distance)&&(r={nodeId:h,rowId:u,distance:d})}}),r},kf=J.arrows.reverseArrowOnMultipleConnect,Ct=new Cs("useArrowDrawingV2",js.useArrowDrawingV2),Af=()=>p.useCallback(e=>{const s=E.getState(),n=s.uiState.mode,o=s.uiState.arrowSubMode,r=s.uiState.temporaryArrow,a=s.projectCanvas.getActive(),i=s.arrow.setTemporary,c=s.arrow.add,l=s.getCanvasMouseCoords,d=(a==null?void 0:a.coreState.nodes)??[],u=o===Rn.STAY;if(n!==Q.DRAW_ARROW)return;Ct.log("Fired in DRAW_ARROW mode.");const h=l();if(!h){Ct.log("No click point found.");return}const f=E.getState().uiState.activeGroupId,w=xo(h,d,f?[f]:void 0),m=(w==null?void 0:w.id)??null;if(r!=null&&r.startNodeId&&m&&m!==r.startNodeId){Ct.log(`Click-click: Creating arrow from ${r.startNodeId} to ${m}`);const x=et(m,h,r.startPoint,d,null),y={id:Pe(10),startPoint:r.startPoint,endPoint:x,startNodeId:r.startNodeId,endNodeId:m,label:""};c(y),u?i({startPoint:h,endPoint:h,startNodeId:m}):(i(null),s.setMode(Q.SELECT)),e.stopPropagation();return}if(!m){r?(Ct.log("Clicked on background - cancelling temporary arrow."),i(null)):Ct.log("Clicked on background - ignoring (arrows must start from a node)."),e.stopPropagation();return}Ct.log(`Starting arrow draw from node: ${m}`),i({startPoint:h,endPoint:h,startNodeId:m}),e.stopPropagation()},[]),If=Af,Tf=()=>p.useCallback(e=>{const s=E.getState(),n=s.uiState.mode,o=s.uiState.temporaryArrow,r=s.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.nodes)??[],i=s.arrow.setTemporary,c=s.getCanvasMouseCoords;if(n!==Q.DRAW_ARROW||!o)return;let l=c();if(!l)return;const d=Ro(e.clientX,e.clientY);d&&(l=et(d.nodeId,l,o.startPoint,a,d.rowId)),i({...o,endPoint:l}),e.stopPropagation()},[]),Ef=Tf,Jn=(e,s)=>{const n=E.getState(),o=n.setMode,r=n.arrow.setTemporary,a=n.uiState.mode;return p.useCallback(i=>{if(a!==Q.SELECT)return;Ct.log(`useQuickArrowHandleMouseDownHandler: Fired on node ${e.id}, handle ${s}.`),i.stopPropagation();const c=e.width??100,l=e.height??50;let d;switch(s){case"top":d={x:e.x+c/2,y:e.y};break;case"bottom":d={x:e.x+c/2,y:e.y+l};break;case"left":d={x:e.x,y:e.y+l/2};break;case"right":d={x:e.x+c,y:e.y+l/2};break}Ct.log("Switching to DRAW_ARROW mode."),o(Q.DRAW_ARROW),Ct.log("Setting temporary arrow from node",e.id),r({startPoint:d,endPoint:d,startNodeId:e.id})},[e,s,r,o,a])},Rf=()=>p.useCallback(e=>{var C;const s=E.getState(),n=s.uiState.mode,o=s.uiState.arrowSubMode,r=s.uiState.temporaryArrow,a=s.projectCanvas.getActive(),i=s.arrow.setTemporary,c=s.arrow.add,l=s.setMode,d=(a==null?void 0:a.coreState.nodes)??[],u=(a==null?void 0:a.coreState.selectedNodes)??[],h=s.getCanvasMouseCoords,f=o===Rn.STAY;if(n!==Q.DRAW_ARROW||!r)return;Ct.log("useArrowPointerUpHandler: Fired.");const g=h();if(!g){Ct.log("No final mouse coords found.");return}const{startPoint:w,startNodeId:m}=r,y=Math.sqrt(Math.pow(g.x-w.x,2)+Math.pow(g.y-w.y,2))>10,v=E.getState().uiState.activeGroupId,N=v?[v]:void 0;let b=null,S=null;const I=Ro(e.clientX,e.clientY);if(I)b=I.nodeId,S=I.rowId;else{const k=xo(g,d,N);k&&(((C=k.data)==null?void 0:C.nodeType)==="workflowOrchestration"||(b=k.id))}if(y&&b&&b!==m&&u.length===0){Ct.log(`Drag mode: Creating arrow from ${m} to ${b}`);const k=et(b,g,w,d,S),R={id:Pe(10),startPoint:w,endPoint:k,startNodeId:m??null,endNodeId:b,endRowId:S,label:""};c(R),f?i(null):(i(null),l(Q.SELECT)),e.stopPropagation();return}if(y&&u.length>0&&b){u.forEach(k=>{if(b&&b!==k.id){const R=et(b,g,w,d,S),A=kf&&u.length>1,T={id:Pe(10),startPoint:A?R:w,endPoint:A?w:R,startNodeId:A?b:k.id??null,endNodeId:A?k.id??null:b,startRowId:A?S:void 0,endRowId:A?void 0:S,label:""};c(T)}}),i(null),f||l(Q.SELECT),e.stopPropagation();return}if(!y&&b===m){Ct.log("Click on start node - waiting for second click on target node"),e.stopPropagation();return}if(!b){Ct.log("Released on empty space - canceling arrow"),i(null),e.stopPropagation();return}e.stopPropagation()},[]),Mf=Rf;let fo=null;const vr=()=>fo,Ll=()=>{const e=p.useRef(null),s=p.useRef([]),n=p.useRef(null),o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),i=p.useRef(!1),c=F(u=>u.uiState.canvasWidth??0),l=F(u=>u.uiState.canvasHeight??0),d=F(u=>u.uiState.mode);return p.useEffect(()=>{const u=e.current;if(!u)return;const h=u.getBoundingClientRect();if(h.width===0||h.height===0)return;const f=window.devicePixelRatio||1;u.width=h.width*f,u.height=h.height*f;const g=u.getContext("2d");g&&g.scale(f,f)},[c,l,d]),p.useEffect(()=>{const u=e.current;if(!u){fo=null;return}const h=()=>{const m=E.getState().projectCanvas.getActive();return(m==null?void 0:m.viewState)??{offset:{x:0,y:0},scale:1}},f=(m,x)=>{const y=u.getBoundingClientRect();return{x:m-y.left,y:x-y.top}},g=m=>{if(!a.current||s.current.length<2)return;const{scale:x}=h(),y=window.devicePixelRatio||1;m.clearRect(0,0,u.width/y,u.height/y);const v=(a.current.opacity??1)<1;m.beginPath(),m.strokeStyle=a.current.strokeColor,m.lineWidth=a.current.strokeWidth*x,m.globalAlpha=a.current.opacity??1,m.lineCap=v?"butt":"round",m.lineJoin=v?"bevel":"round";const N=s.current;m.moveTo(N[0].x,N[0].y);for(let b=1;b<N.length;b++)m.lineTo(N[b].x,N[b].y);m.stroke(),m.globalAlpha=1},w=m=>{if(!a.current||s.current.length<2)return;const{scale:x}=h(),y=s.current,v=y[y.length-2],N=y[y.length-1];m.beginPath(),m.strokeStyle=a.current.strokeColor,m.lineWidth=a.current.strokeWidth*x,m.globalAlpha=a.current.opacity??1,m.lineCap="round",m.lineJoin="round",m.moveTo(v.x,v.y),m.lineTo(N.x,N.y),m.stroke(),m.globalAlpha=1};return fo={startStroke:(m,x,y)=>{const v=u==null?void 0:u.getContext("2d");if(!v||!u)return;const N=window.devicePixelRatio||1;v.clearRect(0,0,u.width/N,u.height/N),a.current=y;const b=f(m,x);s.current=[b],n.current=b,o.current=b,r.current=b,i.current=!0},addPoint:(m,x)=>{var R;if(!i.current||!o.current||!r.current)return;const y=u==null?void 0:u.getContext("2d");if(!y)return;let v=f(m,x);const N=(((R=a.current)==null?void 0:R.opacity)??1)<1;if(N){const A=E.getState().getDrawAxisLock();A==="horizontal"?v={x:v.x,y:r.current.y}:A==="vertical"&&(v={x:r.current.x,y:v.y})}const b=J.drawing.minPointDistance,S=v,I=S.x-o.current.x,C=S.y-o.current.y;Math.sqrt(I*I+C*C)>=b&&(s.current.push({...S}),o.current=S,N?g(y):w(y))},endStroke:()=>{if(!i.current)return null;const m=u==null?void 0:u.getContext("2d");if(m&&u){const N=window.devicePixelRatio||1;m.clearRect(0,0,u.width/N,u.height/N)}const{offset:x,scale:y}=h(),v=s.current.map(N=>({x:(N.x-x.x)/y,y:(N.y-x.y)/y}));return s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1,v.length>1?v:null},clear:()=>{const m=u==null?void 0:u.getContext("2d");if(m&&u){const x=window.devicePixelRatio||1;m.clearRect(0,0,u.width/x,u.height/x)}s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1}},()=>{fo=null}},[d]),d!==Q.DRAW?null:t.jsx("canvas",{ref:e,"data-test":"temporary-drawing-canvas","data-temporary-drawing-canvas":!0,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",touchAction:"none",zIndex:9999}})};Ll.displayName="TemporaryDrawingCanvas";const St=new Cs("useDrawingV2",js.useDrawingV2);let jn=null,Ws=null,Mo=null,Hs=null,Po=[],Do=!1,Oo=0;const Pf=3;let va=null,hi=null,ba=null,pi=null;const Qs=new Map,Wl=()=>{Do||(Hs=document.querySelector("[data-temporary-drawing-canvas]"),Po=Array.from(document.querySelectorAll(".markdown-textarea")),Po.forEach(e=>{const s=e;Qs.has(e)||Qs.set(e,s.getAttribute("contenteditable")||""),s.style.setProperty("pointer-events","auto","important"),s.style.setProperty("user-select","text","important"),s.setAttribute("contenteditable","true"),s.setAttribute("inputmode","none")}),Do=!0,Oo=0)},Df=()=>{Po.forEach(e=>{const s=e;s.style.removeProperty("pointer-events"),s.style.removeProperty("user-select")}),Hs=null,Po=[],Do=!1,Oo=0},Of=(e,s)=>{var o;if(Oo++,Oo%Pf!==1)return;Do||Wl(),Hs&&(Hs.style.visibility="hidden");let n=null;if(typeof document.caretRangeFromPoint=="function")n=document.caretRangeFromPoint(e,s);else{const r=(o=document.caretPositionFromPoint)==null?void 0:o.call(document,e,s);r!=null&&r.offsetNode&&(n=document.createRange(),n.setStart(r.offsetNode,r.offset),n.setEnd(r.offsetNode,r.offset))}if(n&&n.startContainer.nodeType===Node.TEXT_NODE){const r=n.startContainer.parentElement;if((r==null?void 0:r.closest("[data-node-id]"))!==null){const i=window.getSelection();if(i)if(jn){const c=jn.screenX,l=jn.screenY,d=Va(c,l);if(!d)return;const u=document.createRange(),h=d.node,f=d.offset,g=n.startContainer,w=n.startOffset,m=h.compareDocumentPosition(g);(h===g?f<=w:!(m&Node.DOCUMENT_POSITION_PRECEDING))?(u.setStart(h,f),u.setEnd(g,w)):(u.setStart(g,w),u.setEnd(h,f)),i.removeAllRanges(),i.addRange(u)}else{jn={node:n.startContainer,offset:n.startOffset,screenX:e,screenY:s},i.removeAllRanges();const c=document.createRange();c.setStart(n.startContainer,n.startOffset),c.setEnd(n.startContainer,n.startOffset),i.addRange(c)}}}Hs&&(Hs.style.visibility="")},Hl=()=>{jn=null,Ws=null,Mo=null,Df(),Qs.forEach((e,s)=>{const n=s;e?n.setAttribute("contenteditable",e):n.removeAttribute("contenteditable"),n.removeAttribute("inputmode")}),Qs.clear()},Va=(e,s)=>{const n=typeof document.caretRangeFromPoint=="function",o=typeof document.caretPositionFromPoint=="function";if(n){const r=document.caretRangeFromPoint(e,s);if(r&&r.startContainer.nodeType===Node.TEXT_NODE)return{node:r.startContainer,offset:r.startOffset}}else if(o){const r=document.caretPositionFromPoint(e,s);if(r!=null&&r.offsetNode&&r.offsetNode.nodeType===Node.TEXT_NODE)return{node:r.offsetNode,offset:r.offset}}return null},Lf=(e,s,n,o)=>{const r=document.querySelector("[data-temporary-drawing-canvas]"),a=r==null?void 0:r.style.visibility;r&&(r.style.visibility="hidden"),document.querySelectorAll(".markdown-textarea").forEach(d=>{const u=d;Qs.has(d)||Qs.set(d,u.getAttribute("contenteditable")||""),u.setAttribute("contenteditable","true"),u.setAttribute("inputmode","none")});const c=Va(e,s),l=Va(n,o);if(r&&(r.style.visibility=a||""),c&&l){const d=window.getSelection();if(d){d.removeAllRanges();const u=document.createRange(),h=c.node.compareDocumentPosition(l.node);(c.node===l.node?c.offset<=l.offset:!(h&Node.DOCUMENT_POSITION_PRECEDING))?(u.setStart(c.node,c.offset),u.setEnd(l.node,l.offset)):(u.setStart(l.node,l.offset),u.setEnd(c.node,c.offset)),d.addRange(u)}}},Wf=(e,s)=>{var k,R,A;const n=window.getSelection();if(!n||n.isCollapsed)return;const o=n.toString().trim();if(!o)return;const r=((k=n.anchorNode)==null?void 0:k.nodeType)===Node.TEXT_NODE?n.anchorNode.parentElement:n.anchorNode,a=((R=n.focusNode)==null?void 0:R.nodeType)===Node.TEXT_NODE?n.focusNode.parentElement:n.focusNode,i=(r==null?void 0:r.closest("[data-node-id]"))??(a==null?void 0:a.closest("[data-node-id]"));if(!i)return;const c=i.getAttribute("data-node-id");if(!c)return;const l=E.getState(),d=l.getNodeById(c);if(!d)return;const u=bs(o,void 0,d),h=Le.buildTextNodeV2({content:o,width:u.width,height:u.height,linkedSourceNodeId:d.id,options:{lockSize:!1}});let f=d;if(e==="left"&&hi===d.id&&va){const T=l.getNodeById(va);T&&(f=T)}else if(e==="right"&&pi===d.id&&ba){const T=l.getNodeById(ba);T&&(f=T)}const g=(A=l.projectCanvas.getActive())==null?void 0:A.viewState,w=(g==null?void 0:g.offset)??{y:0},m=(g==null?void 0:g.scale)??1,x=document.querySelector("[data-canvas-container]"),y=x==null?void 0:x.getBoundingClientRect(),v=(y==null?void 0:y.top)??0,b=(s-v-w.y)/m,S=J.highlightAndCreate.createConnectingArrow,I=h.height??u.height,C=b-I/2;Jo(h,{...f,y:C},e,{shouldFocus:!1,createArrow:S}),e==="left"?(va=h.id,hi=d.id):(ba=h.id,pi=d.id)};let Na=null,Sa=0;const Hf=e=>{const{level:s}=J.drawing.compression;return vl(e,s)},Bf=e=>{const{level:s}=J.drawing.compression;return yl(e,s)};let qt=null,Lo=!1;const Ff=()=>{const e=E.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getDrawSubMode,r=e.getDrawStyle;return p.useCallback(a=>{if(a.pointerType==="pen"&&a.button===1&&(Lo=!0),E.getState().uiState.mode!==Q.DRAW||a.button!==0&&a.button!==-1||a.buttons&4||a.pointerType==="pen"&&Lo)return;a.preventDefault(),St.log("Fired in DRAW mode.");const c=vr();if(a.pointerType==="touch"&&qt!==null&&a.pointerId!==qt){St.log("Second touch detected, canceling drawing."),c==null||c.clear(),n(null),qt=null;return}const l=s();if(!l){St.log("No start point found.");return}const d=o(),u=r();St.log(`Starting draw with sub-mode: ${d}, pointerId: ${a.pointerId}`),qt=a.pointerId;const h=Ye.createTemporaryDrawing(d,l,u);n(h),d===Se.FREEHAND&&(St.log(`canvasAPI available: ${!!c}`),c?(c.startStroke(a.clientX,a.clientY,u),Hl(),Ws=a.clientX,Mo=a.clientY,(u.opacity??1)<1&&Wl()):St.log("WARNING: canvasAPI is null in mouseDown!")),a.stopPropagation()},[s,n,o,r])},$f=()=>{const e=E.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getTemporaryDrawing;return p.useCallback(r=>{var c;if(E.getState().uiState.mode!==Q.DRAW)return;const i=o();if(i&&!(qt!==null&&r.pointerId!==qt)){if(i.subMode===Se.FREEHAND){const l=vr();if(l){const d=((c=r.getCoalescedEvents)==null?void 0:c.call(r))??[r];for(const h of d)l.addPoint(h.clientX,h.clientY);(i.style.opacity??1)<1&&Of(r.clientX,r.clientY)}else St.log("WARNING: canvasAPI is null in mouseMove!")}else{const l=s();if(!l)return;const d=Ye.updateShapeEndPoint(i,l);n(d)}r.stopPropagation()}},[s,n,o])},zf=e=>e.elements&&e.elements.length>0?e.elements:e.drawType&&e.style?[{type:e.drawType,stroke:e.stroke,shape:e.shape,style:e.style}]:[],_f=(e,s)=>{const n=Math.min(e.x,s.x),o=Math.min(e.y,s.y),r=Math.max(e.x+(e.width??0),s.x+s.width),a=Math.max(e.y+(e.height??0),s.y+s.height);return{x:n,y:o,width:r-n,height:a-o}},Vf=(e,s,n)=>e.map(o=>({x:o.x+s,y:o.y+n})),Uf=()=>{const e=E.getState(),s=e.addNode,n=e.updateNode,o=e.getNodeById,r=e.setTemporaryDrawing,a=e.getTemporaryDrawing,i=e.undo.commit;return p.useCallback(c=>{var A;if(c.pointerType==="pen"&&Lo&&(c.buttons&4||(Lo=!1)),E.getState().uiState.mode!==Q.DRAW)return;const d=a();if(!d||qt!==null&&c.pointerId!==qt)return;const u=Ws!==null&&c.clientX<Ws?"left":"right",h=window.getSelection(),f=(h==null?void 0:h.toString().trim())||"";Ws!==null&&Mo!==null&&f.length===0&&Lf(Ws,Mo,c.clientX,c.clientY),Wf(u,c.clientY),(A=window.getSelection())==null||A.removeAllRanges(),Hl(),St.log("useDrawMouseUpHandler: Fired.");const g=vr(),w=(g==null?void 0:g.endStroke())??null;if(d.subMode===Se.FREEHAND&&(!w||w.length<2)){St.log("Freehand drawing too short, discarding."),R();return}const x={[Se.RECTANGLE]:"rectangle",[Se.SQUARE]:"square",[Se.CIRCLE]:"circle",[Se.ELLIPSE]:"ellipse",[Se.LINE]:"line",[Se.ARROW]:"arrow",[Se.FREEHAND]:"line"}[d.subMode],y=d.subMode===Se.FREEHAND?Ye.calculateFreehandBounds(w):Ye.calculateShapeBounds(d.startPoint,d.endPoint,x),v=d.style.strokeWidth??2,N={x:y.x-v,y:y.y-v,width:y.width+v*2,height:y.height+v*2};if(d.subMode!==Se.FREEHAND&&!Ye.canFinalizeDraw(d)){St.log("Shape too small or invalid, discarding."),R();return}const b=Date.now(),S=J.drawing.strokeGroupingTimeoutMs,I=Na?o(Na):void 0;if(b-Sa<S&&I&&I.type===ce.DRAWING&&I){St.log("Grouping with existing node:",I.id);const T=I.data,O=zf(T),$=_f(I,N),B=I.x-$.x,H=I.y-$.y,M=O.map(_=>{if(_.type==="freehand"&&_.stroke){const G=Vf(_.stroke.points,B,H),V=Pp(_.stroke.smoothedPath,B,H);return{..._,stroke:{points:G,smoothedPath:V}}}return _.type==="shape"&&_.shape?{..._,shape:{..._.shape,startPoint:{x:_.shape.startPoint.x+B,y:_.shape.startPoint.y+H},endPoint:{x:_.shape.endPoint.x+B,y:_.shape.endPoint.y+H}}}:_}),j=gi(d,N,$,w),P=Bf(j),W={elements:[...M,P],intrinsicWidth:$.width,intrinsicHeight:$.height},L={x:I.x,y:I.y,width:I.width,height:I.height,data:T},z={x:$.x,y:$.y,width:$.width,height:$.height,data:W};n(I.id,z),i({type:"node:update",nodeId:I.id,from:L,to:z}),Sa=b,St.log("Merged into node:",I.id)}else{const T=gi(d,N,N,w),O=Hf({elements:[T],intrinsicWidth:N.width,intrinsicHeight:N.height}),$={id:Pe(10),x:N.x,y:N.y,width:N.width,height:N.height,type:ce.DRAWING,data:O,content:""};s($,void 0,{dontSelect:!0}),Na=$.id,Sa=b,St.log("Created DRAWING node:",$.id)}R();function R(){St.log("Resetting temporary drawing state."),r(null),qt=null,c.stopPropagation()}},[s,n,o,r,a,i])};function gi(e,s,n,o=null){if(s.x-n.x,s.y-n.y,e.subMode===Se.FREEHAND){const d=(o??e.points).map(h=>({x:h.x-n.x,y:h.y-n.y})),u=Ye.smoothToSVGPath(d);return{type:"freehand",stroke:{points:d,smoothedPath:u},style:e.style}}const r=e.startPoint,a=e.endPoint;return{type:"shape",shape:{shapeType:{[Se.RECTANGLE]:"rectangle",[Se.SQUARE]:"square",[Se.CIRCLE]:"circle",[Se.ELLIPSE]:"ellipse",[Se.LINE]:"line",[Se.ARROW]:"arrow",[Se.FREEHAND]:"line"}[e.subMode],startPoint:{x:r.x-n.x,y:r.y-n.y},endPoint:{x:a.x-n.x,y:a.y-n.y}},style:e.style}}const fi=(e,s)=>{const n=e.clientX-s.clientX,o=e.clientY-s.clientY;return Math.sqrt(n*n+o*o)},mi=(e,s)=>({x:(e.clientX+s.clientX)/2,y:(e.clientY+s.clientY)/2}),xi=()=>J.holdToSelect,Gf=()=>{const e=E.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=e.setIsPanning,r=e.setSelectionBox,a=e.setPendingSelectionStart,i=e.setIsHoldSelectActive,c=e.setHoldSelectProgress,l=tr(),d=F(B=>B.uiState.isHoldSelectActive??!1),u=p.useRef(null),h=20,f=10,g=B=>Number.isFinite(B)&&Math.abs(B)<1e10,w=(B,H)=>!g(B)||!g(H.x)||!g(H.y)?(I.current=null,C.current=null,k.current=null,u.current=null,null):{scale:B,offset:H},m=p.useRef(null),x=p.useRef(null),y=p.useRef(null),v=p.useRef(null),N=p.useRef(null),b=p.useRef(null),S=p.useRef(null),I=p.useRef(null),C=p.useRef(null),k=p.useRef(null),R=p.useCallback(()=>{x.current&&(clearTimeout(x.current),x.current=null),y.current&&(clearTimeout(y.current),y.current=null),N.current=null,c(null)},[c]),A=p.useCallback((B,H)=>{if(!H)return{x:B.clientX,y:B.clientY};const M=H.getBoundingClientRect();return{x:B.clientX-M.left,y:B.clientY-M.top}},[]),T=p.useCallback(B=>{var P;const H=E.getState().projectCanvas.getActive();if(!H)return;const M=E.getState().uiState.mode,j=B.target;if(b.current=j.closest("[data-canvas-container]"),B.touches.length===1){const W=B.touches[0],L=j.closest("[data-node-id]"),z=j.id.includes("resize-handle-"),_=j.closest("[data-ui-panel]");if(L||z||_){m.current=null,R();return}if(l){const G=xi();R(),v.current={x:W.clientX,y:W.clientY},N.current=Date.now(),y.current=setTimeout(()=>{const V=N.current?Date.now()-N.current:0,K=G.holdDurationMs-V-100;K>0&&c({touchX:W.clientX,touchY:W.clientY,durationMs:K})},G.indicatorDelayMs),x.current=setTimeout(()=>{var D;c(null),i(!0),(D=navigator.vibrate)==null||D.call(navigator,50);const V=A(W,b.current);r({start:V,end:V}),o(!1),m.current=null},G.holdDurationMs),m.current={startX:W.clientX,startY:W.clientY,initialOffsetX:H.viewState.offset.x,initialOffsetY:H.viewState.offset.y},o(!0),u.current=null;return}if(M===Q.DRAW||M===Q.SELECT){m.current=null;return}m.current={startX:W.clientX,startY:W.clientY,initialOffsetX:H.viewState.offset.x,initialOffsetY:H.viewState.offset.y},o(!0),u.current=null}else if(B.touches.length===2){S.current&&(clearTimeout(S.current),S.current=null),r(null),a(null),l&&(R(),i(!1),v.current=null);const W=B.touches[0],L=B.touches[1],z=fi(W,L),_=mi(W,L);if(u.current){const G=((P=C.current)==null?void 0:P.scale)??H.viewState.scale;if(!g(G)){u.current=null,I.current=null,C.current=null;return}u.current={...u.current,initialDistance:z,initialScale:G}}else{const G=H.viewState.scale,V=H.viewState.offset;if(!g(G)||!g(V.x)||!g(V.y))return;const D=wt(_,G,V);u.current={initialDistance:z,initialScale:G,initialOffsetX:V.x,initialOffsetY:V.y,center:_,anchorInCanvas:D,gestureType:"undetermined"},I.current=G}m.current=null,o(!1)}else u.current=null,m.current=null,o(!1),l&&(R(),i(!1),v.current=null)},[s,o,r,a,l,R,A]),O=p.useCallback(B=>{var M,j,P,W;if(s()){if(B.touches.length===1){const L=B.touches[0];if(l&&d){B.preventDefault();const z=A(L,b.current),_=(M=E.getState().uiState)==null?void 0:M.selectionBox;_&&r({start:_.start,end:z});return}if(l&&v.current&&x.current){const z=xi(),_=L.clientX-v.current.x,G=L.clientY-v.current.y;Math.hypot(_,G)>z.movementThresholdPx&&(R(),v.current=null)}if(m.current){B.preventDefault();const z=L.clientX-m.current.startX,_=L.clientY-m.current.startY;n(G=>({...G,offset:{x:m.current.initialOffsetX+z,y:m.current.initialOffsetY+_}}))}}else if(B.touches.length===2&&u.current){B.preventDefault();const L=B.touches[0],z=B.touches[1],_=fi(L,z),G=mi(L,z),V=Math.abs(_-u.current.initialDistance);if(u.current.gestureType==="undetermined")if(V>h){u.current.gestureType="zoom",k.current=null;const D=(j=E.getState().projectCanvas.getActive())==null?void 0:j.viewState,K=(D==null?void 0:D.scale)??u.current.initialScale,te=(D==null?void 0:D.offset)??{x:u.current.initialOffsetX,y:u.current.initialOffsetY},ie=wt(u.current.center,K,te);I.current=K,C.current={scale:K,offset:te},u.current.initialDistance=_,u.current.initialScale=K,u.current.initialOffsetX=te.x,u.current.initialOffsetY=te.y,u.current.anchorInCanvas=ie}else{const D=Math.abs(G.x-u.current.center.x),K=Math.abs(G.y-u.current.center.y);(D>h||K>h)&&(u.current.gestureType="pan",o(!0))}if(u.current.gestureType==="zoom"){if(k.current===null){const U=((P=s())==null?void 0:P.coreState.nodes)??[],Y=(W=E.getState().projectCanvas.getActive())==null?void 0:W.viewState;if(U.length>0&&Y){const X=U[0],Z=Math.round(X.x*Y.scale+Y.offset.x),ne=Math.round(X.y*Y.scale+Y.offset.y);k.current={x:Z,y:ne,scale:Y.scale,anchor:{x:Math.round(u.current.anchorInCanvas.x),y:Math.round(u.current.anchorInCanvas.y)},center:{x:Math.round(u.current.center.x),y:Math.round(u.current.center.y)}}}return}if(_<f||u.current.initialDistance<f)return;const D=_/u.current.initialDistance;let K=u.current.initialScale*D;if(!g(D)||!g(K))return;const{min:te,max:ie}=J.zoom;K=Math.max(te,Math.min(ie,K)),I.current!==null&&(K=I.current+(K-I.current)*.4),I.current=K;const ye=u.current.anchorInCanvas,ge=u.current.center,q=ge.x-ye.x*K,le=ge.y-ye.y*K,de=w(K,{x:q,y:le});if(!de)return;C.current={scale:de.scale,offset:de.offset},n(U=>({...U,scale:de.scale,offset:de.offset})),k.current={x:0,y:0,scale:K,anchor:{x:Math.round(ye.x),y:Math.round(ye.y)},center:{x:Math.round(ge.x),y:Math.round(ge.y)}}}else if(u.current.gestureType==="pan"){const D=G.x-u.current.center.x,K=G.y-u.current.center.y,te=u.current.initialOffsetX+D,ie=u.current.initialOffsetY+K;n(ye=>({...ye,offset:{x:te,y:ie}}))}}}},[s,n,o,l,d,R,A,r]),$=p.useCallback(B=>{const H=E.getState().uiState.mode;if(B.touches.length===0)S.current&&(clearTimeout(S.current),S.current=null),u.current=null,m.current=null,I.current=null,C.current=null,k.current=null,o(!1),l&&(R(),v.current=null,d&&i(!1));else if(B.touches.length===1){if(S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{u.current=null,S.current=null},150),l&&(R(),i(!1),v.current=null),!l&&(H===Q.DRAW||H===Q.SELECT)){m.current=null,o(!1);return}if(!m.current){const M=E.getState().projectCanvas.getActive();if(M){const j=B.touches[0];m.current={startX:j.clientX,startY:j.clientY,initialOffsetX:M.viewState.offset.x,initialOffsetY:M.viewState.offset.y},o(!0)}}}else B.touches.length>=2&&(m.current=null,o(!1),l&&(R(),i(!1),v.current=null))},[o,l,d,R]);return{handleTouchStart:T,handleTouchMove:O,handleTouchEnd:$}},Wo=new Map;let Bl={targetScreenYRatio:.8,animationDuration:300,stabilizationDelay:10,minKeyboardHeight:100,listenerTimeout:2e3};function Fl(e){var u;const{nodeId:s,nodeY:n,source:o}=e,r=Bl,a=document.querySelector(`[data-node-id="${s}"]`);a==null||a.getBoundingClientRect().top;let i=0,c=null;const l=()=>{var w;const h=window.innerHeight,f=((w=window.visualViewport)==null?void 0:w.height)||window.innerHeight,g=h-f;if(g>r.minKeyboardHeight&&g!==i){i=g,c&&clearTimeout(c),c=setTimeout(()=>{var m;(m=window.visualViewport)==null||m.removeEventListener("resize",l),d()},r.stabilizationDelay);return}},d=()=>{var S;const h=((S=window.visualViewport)==null?void 0:S.height)||window.innerHeight,f=E.getState(),g=f.projectCanvas.getActive(),w=(g==null?void 0:g.viewState.offset)||{x:0,y:0},m=(g==null?void 0:g.viewState.scale)||1,x=document.querySelector(`[data-node-id="${s}"]`),y=x==null?void 0:x.getBoundingClientRect(),v=(y==null?void 0:y.top)??n*m+w.y,b=h*r.targetScreenYRatio-v;f.setActiveCanvasViewState(I=>({...I,targetView:{targetOffset:{x:w.x,y:w.y+b},targetScale:m,animationStartTime:0,animationDuration:r.animationDuration}})),Wo.set(s,b)};(u=window.visualViewport)==null||u.addEventListener("resize",l),setTimeout(()=>{var h;(h=window.visualViewport)==null||h.removeEventListener("resize",l),c&&clearTimeout(c)},r.listenerTimeout)}function Yf(e){var i,c;const s=Bl,n=Wo.get(e);if(!n)return;Wo.delete(e);let o=window.innerHeight-(((i=window.visualViewport)==null?void 0:i.height)||window.innerHeight),r=null;const a=()=>{var h;const l=window.innerHeight,d=((h=window.visualViewport)==null?void 0:h.height)||window.innerHeight,u=l-d;u!==o&&(o=u,r&&clearTimeout(r),r=setTimeout(()=>{var f;if(u<s.minKeyboardHeight){(f=window.visualViewport)==null||f.removeEventListener("resize",a);const g=E.getState(),w=g.projectCanvas.getActive(),{scale:m,offset:x}=(w==null?void 0:w.viewState)||{scale:1,offset:{x:0,y:0}};g.setActiveCanvasViewState(y=>({...y,targetView:{targetOffset:{x:x.x,y:x.y-n},targetScale:m,animationStartTime:0,animationDuration:s.animationDuration}}))}},s.stabilizationDelay))};(c=window.visualViewport)==null||c.addEventListener("resize",a),setTimeout(()=>{var l;(l=window.visualViewport)==null||l.removeEventListener("resize",a),r&&clearTimeout(r)},s.listenerTimeout)}function $l(e){var n;const s=((n=window.visualViewport)==null?void 0:n.height)||window.innerHeight;return e>s/2}const Kf=300,Xf=30,qf=()=>{const e=p.useRef(null),s=xr();return p.useCallback(n=>{const o=E.getState(),r=o.uiState.mode;o.getCanvasMouseCoords;const a=o.addNode,i=o.setNodeToFocusId;if(r!==Q.SELECT){e.current=null;return}if(n.target.closest("[data-node-id], [data-arrow-id]")){e.current=null;return}if(n.touches.length===0&&n.changedTouches.length>0){const d=n.changedTouches[0],u={timestamp:Date.now(),x:d.clientX,y:d.clientY};if(e.current){const h=u.timestamp-e.current.timestamp,f=Math.sqrt(Math.pow(u.x-e.current.x,2)+Math.pow(u.y-e.current.y,2));if(h<Kf&&f<Xf){const g=o.projectCanvas.getActive();if(!g){e.current=null;return}const{scale:w,offset:m}=g.viewState,x=s.current;if(!x){e.current=null;return}const y=x.getBoundingClientRect(),v=u.x-y.left,N=u.y-y.top,b=wt({x:v,y:N},w,m);if(!b){e.current=null;return}const S=Pe(10);a({id:S,x:b.x,y:b.y,content:"",type:ce.TEXT,isEditing:!0}),i(S),requestAnimationFrame(()=>{const I=document.querySelector(`#NodeContainerV2-${S} .markdown-textarea`);I&&(I.contentEditable="true",I.focus({preventScroll:!0}))}),$l(u.y)&&Fl({nodeId:S,nodeY:b.y,source:"doubleTap"}),n.preventDefault(),n.stopPropagation(),e.current=null;return}}e.current=u}},[s])},Zf=e=>1-Math.pow(1-e,3),Jf={offset:{x:0,y:0},scale:1,targetView:null},Qf=()=>{const e=F(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.viewState)??Jf}),s=E.getState(),n=s.projectCanvas.getActive,o=s.setActiveCanvasViewState,r=p.useRef(null),a=p.useRef({x:0,y:0}),i=p.useRef(1),c=p.useRef(!1);p.useEffect(()=>{const l=e.offset,d=e.scale,u=e.targetView;if(u){if(u.animationStartTime===0){const f=performance.now();o(g=>({...g,targetView:g.targetView?{...g.targetView,animationStartTime:f}:null}));return}c.current||(a.current=l,i.current=d,c.current=!0);const h=f=>{var S;const g=(S=n())==null?void 0:S.viewState,w=g==null?void 0:g.targetView;if(!w){r.current&&(cancelAnimationFrame(r.current),r.current=null);return}const m=f-w.animationStartTime,x=Math.min(m/w.animationDuration,1),y=Zf(x),v=a.current.x+(w.targetOffset.x-a.current.x)*y,N=a.current.y+(w.targetOffset.y-a.current.y)*y,b=i.current+(w.targetScale-i.current)*y;o(I=>({...I,offset:{x:v,y:N},scale:b})),x<1?r.current=requestAnimationFrame(h):(o(I=>({...I,offset:w.targetOffset,scale:w.targetScale,targetView:null})),c.current=!1,r.current=null)};r.current=requestAnimationFrame(h)}return()=>{r.current&&(cancelAnimationFrame(r.current),r.current=null)}},[e,n,o])};class Ua{static isInGivenAreaInCanvas(s,n,o){if(n.x===void 0||n.y===void 0)return!1;let r=!0,a=!0;if(o.xRatio!==void 0){const i=s.x+o.xRatio*s.width;r=n.x>=i}if(o.yRatio!==void 0){const i=s.y+o.yRatio*s.height;a=n.y>=i}return r&&a}static createGridForCanvas(s,n=3){const{width:o,height:r}=s,a=[],i=o/n,c=r/n;for(let l=0;l<=n;l++){const d=[];for(let u=0;u<=n;u++)d.push({x:u*i,y:l*c});a.push(d)}return a}static focusElementAndMoveCursorToEnd(s){if(!s)return;s.hasAttribute("tabindex")||s.setAttribute("tabindex","-1"),s.focus();const n=document.createRange(),o=window.getSelection();if(o)try{n.selectNodeContents(s),n.collapse(!1),o.removeAllRanges(),o.addRange(n)}catch(r){console.error("Failed to set cursor position:",r)}}}Fe(Ua,"getCanvasCenter",(s,n,o)=>{if(!s)return console.warn("Container not available for center calculation."),{x:0,y:0};if(!n)return console.warn("Offset not available for center calculation."),{x:0,y:0};const{clientWidth:r,clientHeight:a}=s,i=r/2,c=a/2,l=(i-n.x)/o,d=(c-n.y)/o;return{x:l,y:d}});const Qn=new Cs("WriteModeHandlerV2",js.WriteModeHandlerV2);class em{constructor(){Fe(this,"s")}onKeyDown(s){const n=E.getState();this.s=n;const o=this.s.uiState,a=s.target.closest("#CanvasAppV2"),i=this.s.projectCanvas.getActive(),c=i==null?void 0:i.viewState,l=(c==null?void 0:c.offset)??{x:0,y:0},d=(c==null?void 0:c.scale)??1;if(!a||!c)return Qn.warn("Canvas or active canvas viewState not available."),!0;if(s.key==="Enter"&&s.ctrlKey){const m=this.s.getEditingNode();if(!m)return!0;this.s.unselectNodeById(m.id);const x={x:m.x,y:m.y+(m.height??30)+30},y=Le.buildTextNode(x,""),v={x:(0-l.x)/d,y:(0-l.y)/d,width:a.clientWidth/d,height:a.clientHeight/d},N=Ua.isInGivenAreaInCanvas(v,y,{yRatio:J.writeMode.scrollYRatio});return this.addNode(y),N&&setTimeout(()=>{n.scrollToNode(y,J.writeMode.scrollDuration,{verticalOnly:!0})},50),!0}if(o.nodeToFocusId)return!0;const{mode:f}=o;if(f!==Q.WRITE)return!1;const g=s.key,w=s.ctrlKey||s.metaKey;if(g.length===1&&!w&&g!=="Enter"){const m=E.getState(),x=m.uiState.writeModeStartPosition,y=x??Ua.getCanvasCenter(a,l,d),v=Le.buildTextNode(y,"");return this.addNode(v),x&&m.setWriteModeStartPosition(null),Qn.log(`WRITE Mode: Key "${g}" pressed. Created node ${v.id} at position (${y.x}, ${y.y}) and requested focus.`),!0}return g==="Escape"?(Qn.log("WRITE Mode: Escape pressed. Global handler will switch mode."),!1):(Qn.log(`WRITE Mode: Key "${g}" ignored by WriteModeHandler.`),!0)}onKeyUp(s){return!0}addNode(s){s.isEditing=!0,this.s.addNode(s,""),this.s.setNodeToFocusId(s.id)}}class tm{onMouseDown(s){const n=E.getState(),o=n.uiState,{mode:r,addNodeType:a}=o;if(r!==Q.ADD)return!1;const i=n.getCanvasMouseCoords();if(!i)return!1;let c=!1;if(a===ce.TABLE){const l=Le.buildTableNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.TEXTCARD){const l=Le.buildTextCardNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.WORKFLOW_ORCHESTRATION){const l=Le.buildWorkflowOrchestrationNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.WORKFLOW_SOURCE){const l=Le.buildWorkflowSourceNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.WORKFLOW_DEFINITION){const l=Le.buildWorkflowDefinitionNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.OCR){const l=Le.buildOCRNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.IMAGE){const l=Le.buildImageNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.WORKFLOW_STEP){const l=Le.buildWorkflowStepNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===ce.VOCABULARY){const l=Le.buildVocabularyNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}return c?(n.setMode(Q.SELECT),n.setAddNodeType(null),s.stopPropagation(),!0):!1}}const sm=()=>{const[e,s]=p.useState(null),n=p.useRef(new em),o=p.useRef(new Xt),r=p.useRef(new tm),a=Fp(s),i=$p(),c=zp(s),l=_p(s),d=Vp(),u=Up(),h=$g(),f=zg(),g=qg(),w=Zg(),m=Jg(),x=yf(),y=vf(),v=Nf(),N=Cf(),b=If(),S=Ef(),I=Mf(),C=Ff(),k=$f(),R=Uf(),{handleTouchStart:A,handleTouchMove:T,handleTouchEnd:O}=Gf(),$=qf(),B=E.getState(),H=B.setMode,M=B.setAddNodeType,j=B.uiState,P=Ie.useMemo(()=>({pointer:{onPointerDown:W=>{const L=E.getState().uiState.mode;L===Q.DRAW&&W.preventDefault(),!(L===Q.ADD&&r.current.onMouseDown(W))&&(a(W),g(W),b(W),C(W),o.current.onMouseDown(W))},onPointerMove:W=>{i(W),w(W),x(W),v(W),S(W),k(W)},onPointerUp:W=>{c(W),m(W),y(W),N(W),I(W),R(W)},onPointerLeave:l,onDblClick:u},wheel:d,touch:{onTouchStart:A,onTouchMove:T,onTouchEnd:W=>{O(W),$(W)}},keyboard:{onKeyDown:W=>{n.current.onKeyDown(W),h(W)},onKeyUp:f}}),[a,g,b,C,i,w,x,v,S,k,c,m,y,N,I,R,l,d,A,T,O,h,f,u,$,H,M,j.mode,j.addNodeType,r]);return Lp(P),Qf(),Bp(),null},wi=1280,nm=({top:e,bottom:s,left:n,right:o,topLeft:r,topRight:a,bottomLeft:i,bottomRight:c,alwaysVisibleBottomLeft:l,footer:d,isContentVisible:u=!0,topMargin:h})=>{const[f,g]=p.useState(()=>typeof window<"u"?window.innerWidth<Us:!1),[w,m]=p.useState(()=>typeof window<"u"?window.innerWidth<wi:!1);p.useEffect(()=>{const k=()=>{g(window.innerWidth<Us),m(window.innerWidth<wi)};return window.addEventListener("resize",k),()=>window.removeEventListener("resize",k)},[]);const x=p.useRef(null),[y,v]=p.useState(50);p.useEffect(()=>{if(!x.current)return;const k=new ResizeObserver(R=>{var T;const A=((T=R[0])==null?void 0:T.contentRect.height)??50;v(A)});return k.observe(x.current),()=>k.disconnect()},[]);const N=f?y+8:8,[b,S]=p.useState({top:!1,bottom:!1,left:!1,right:!1,topLeft:!1,topRight:!1,bottomLeft:!1,alwaysVisibleBottomLeft:!1}),I=k=>{S(R=>({...R,[k]:!R[k]}))},C=(k,R,A)=>t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>I(k),className:`h-11 w-11 bg-background/30 backdrop-blur-sm hover:bg-background/50 transition-colors ${A}`,"data-prevent-canvas-click":!0,"data-ui-panel":!0,title:`Toggle ${k}`,"data-test":"mobile-toggle",children:t.jsx(R,{className:"h-5 w-5 opacity-70"})});return t.jsxs("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:Ee.canvasOverlay},"data-ui-panel":"canvas-overlay","data-test":"canvas-overlay-container",children:[e&&t.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{top:h||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top",children:e}),u&&s&&t.jsxs("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom",children:[t.jsx("div",{className:"hidden md:block","data-test":"canvas-overlay-bottom-desktop",children:s}),t.jsxs("div",{className:"flex flex-col items-center gap-2 md:hidden","data-test":"canvas-overlay-bottom-mobile",children:[b.bottom&&t.jsx("div",{children:s}),C("bottom",Vr,"")]})]}),u&&n&&t.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-left",children:f?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[C("left",Vr,""),b.left&&t.jsx("div",{children:n})]}):n}),u&&o&&t.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-right",children:f?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[b.right&&t.jsx("div",{children:o}),C("right",Vn,"")]}):o}),u&&r&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{top:h||"1rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-left",children:f?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[C("topLeft",ar,""),b.topLeft&&t.jsx("div",{children:r})]}):r}),u&&a&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{top:h||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-right",children:f?t.jsxs("div",{className:"flex flex-col items-end gap-1",children:[C("topRight",Co,""),b.topRight&&t.jsx("div",{children:a})]}):a}),u&&i&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-left",children:f?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[b.bottomLeft&&t.jsx("div",{children:i}),C("bottomLeft",Mn,"")]}):i}),l&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:u&&i?`${N+60}px`:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-always-visible-bottom-left",children:f?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[b.alwaysVisibleBottomLeft&&t.jsx("div",{children:l}),C("alwaysVisibleBottomLeft",Mn,"")]}):l}),c&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-right",children:c}),d&&t.jsx("div",{ref:x,className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{bottom:f?0:u?Ne.chatInput.BOTTOM_VISIBLE:Ne.chatInput.BOTTOM_HIDDEN},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-footer",children:d})]})},om={offset:{x:0,y:0},scale:1,targetView:null},am=()=>{var d,u;const e=F(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.viewState)??om}),s=F(h=>h.uiState.selectionBox),n=Js(h=>h.mousePosition)??null,o=e.scale??1,r=e.offset??{x:0,y:0},a=h=>{const f=Math.max(.01,Math.min(4,h));E.getState().setActiveCanvasViewState(g=>({...g,scale:f}))},i=h=>{let f;h==="up"?o<.1?f=Math.round((o+.01)*100)/100:f=Math.round((o+.1)*10)/10:o<=.1?f=Math.round((o-.01)*100)/100:f=Math.round((o-.1)*10)/10,a(f)},c=h=>{h.key==="ArrowUp"?(h.preventDefault(),i("up")):h.key==="ArrowDown"&&(h.preventDefault(),i("down"))},l=()=>{E.getState().setActiveCanvasViewState(h=>({...h,offset:{x:0,y:0},scale:1,targetView:null}))};return t.jsxs("div",{className:"text-xs p-1 bg-background/30 backdrop-blur-sm rounded pointer-events-auto",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("label",{className:"opacity-70",children:"Zoom:"}),t.jsx("input",{type:"number",value:o.toFixed(2),onChange:h=>a(parseFloat(h.target.value)||1),onKeyDown:c,min:"0.01",max:"4.0",step:"any",className:"w-16 px-1 py-0.5 text-xs border-0 rounded bg-background/50","data-test":"canvas-debug-zoom-input"}),t.jsx("button",{onClick:l,className:"px-1.5 py-0.5 text-xs border-0 rounded bg-background/50 hover:bg-background/70 transition-colors",title:"Reset view to 0,0","data-test":"canvas-debug-reset-button",children:"Reset"})]}),t.jsxs("div",{children:["Offset: X: ",((d=r==null?void 0:r.x)==null?void 0:d.toFixed(0))??0,", Y: ",((u=r==null?void 0:r.y)==null?void 0:u.toFixed(0))??0]}),t.jsxs("div",{children:["Mouse:"," ",n?`X: ${n.x.toFixed(0)}, Y: ${n.y.toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["M+O:"," ",n&&r?`X: ${(n.x-r.x).toFixed(0)}, Y: ${(n.y-r.y).toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["SelBox:",s?t.jsxs(t.Fragment,{children:[t.jsx("div",{children:`S:(${s.start.x.toFixed(0)},${s.start.y.toFixed(0)})`}),t.jsx("div",{children:` E:(${s.end.x.toFixed(0)},${s.end.y.toFixed(0)})`})]}):"N/A"]})]})},Ze=e=>{const{className:s,mainAction:n,dropdownActions:o=[],dropdownColumns:r,variant:a,size:i,dropdownMenuClassName:c,dropdownTriggerButtonId:l="options-menu-button",dropdownPosition:d="bottom",dropdownHorizontalAlign:u="container-right",persistenceKey:h,isOpen:f,onOpenChange:g,dropdownVerticalOffset:w=0,restoreRepeatAction:m,facade:x,...y}=e,v=r&&r.length>0,N=v?r.flatMap(X=>X.actions):o,[b,S]=p.useState(!1),I=f!==void 0,C=I?f:b,k=X=>{const Z=typeof X=="function"?X(C):X;I||S(Z),g==null||g(Z)},R=p.useRef(null),A=p.useRef(null),[T,O]=p.useState(u),[$,B]=p.useState(d),[H,M]=p.useState(!1),[j,P]=p.useState({top:0,left:0}),W=()=>h?E.getState().getSegmentedButtonAction(h):null,[L,z]=p.useState(W),[_,G]=p.useState(null),V=p.useRef(null),D=p.useRef(!1);p.useEffect(()=>{var se,ae,me;if(D.current||!h)return;const X=E.getState().getSegmentedButtonAction(h),ne=(((ae=(se=E.getState().actions)==null?void 0:se.history)==null?void 0:ae.entries)??[]).filter(he=>he.source===h);for(const he of ne){const pe=N.find(ue=>ue.label===he.label&&ue.onClick);if(pe){E.getState().setSegmentedButtonAction(h,he.label,()=>pe.onClick,{skipHistoryUpdate:!0});continue}if(x){const ue=x.getActions();let oe=!1;const re=ue.find(xe=>xe.label===he.label);if(re&&(E.getState().setSegmentedButtonAction(h,he.label,()=>()=>x.execute(re.id),{skipHistoryUpdate:!0,actionId:re.id}),oe=!0),!oe)for(const xe of ue){const we=(me=xe.subActions)==null?void 0:me.find(fe=>fe.title===he.label);if(we){E.getState().setSegmentedButtonAction(h,he.label,()=>()=>x.execute(we.id),{skipHistoryUpdate:!0,actionId:we.id}),oe=!0;break}}if(oe)continue}if(m){const ue=m(he.label);ue&&E.getState().setSegmentedButtonAction(h,he.label,()=>ue,{skipHistoryUpdate:!0})}}if(X){const he=N.find(pe=>pe.label===X&&pe.onClick);if(he)V.current=he.onClick,z(X);else if(m){const pe=m(X);pe&&(G({label:X,execute:pe}),z(null),V.current=pe,E.getState().setSegmentedButtonAction(h,X,()=>V.current,{skipHistoryUpdate:!0}))}}D.current=!0},[h,m,N]);const K=X=>{X.stopPropagation(),k(Z=>(Z||M(!1),!Z))},te=X=>{var se;if(!x)return;const Z=x.getActions(),ne=Z.find(ae=>ae.label===X);if(ne)return ne.id;for(const ae of Z){const me=(se=ae.subActions)==null?void 0:se.find(he=>he.title===X);if(me)return me.id}},ie=()=>{if(_){if(_.execute(),h){const X=te(_.label);E.getState().setSegmentedButtonAction(h,_.label,()=>V.current,{actionId:X})}return}if(L){const X=N.find(Z=>Z.label===L);if(X&&!X.disabled&&X.onClick){if(X.onClick(),V.current=X.onClick,h){const Z=te(L);E.getState().setSegmentedButtonAction(h,L,()=>V.current,{actionId:Z})}}else n.onClick()}else n.onClick()},ye=(X,Z)=>{if(X(),z(Z),G(null),V.current=X,h){const ne=te(Z);E.getState().setSegmentedButtonAction(h,Z,()=>V.current,{actionId:ne})}k(!1)},q={registerRepeatAction:(X,Z)=>{if(G({label:X,execute:Z}),z(null),V.current=Z,h){const ne=te(X);E.getState().setSegmentedButtonAction(h,X,()=>V.current,{actionId:ne})}k(!1)},closeDropdown:()=>k(!1)};p.useEffect(()=>{if(C&&R.current){const X=R.current.getBoundingClientRect(),Z=window.innerWidth,ne=window.innerHeight,se=16,ae=224,me=200;let he=0,pe=0;d==="top"?he=X.top-me-8+w:he=X.bottom+4+w,u==="container-right"?pe=X.right-ae:(u==="container-edge-right"||u==="middle-right")&&(pe=X.right,u==="middle-right"&&(pe-=ae/2)),pe+ae>Z-se?(pe=Z-se-ae,O("container-right")):pe<se?(pe=se,O("container-edge-right")):O(u),he+me>ne-se?(he=X.top-me-8,B("top")):he<se?(he=X.bottom+4,B("bottom")):B(d),P({top:he,left:pe}),M(!0)}},[C,u,d,w]);const le=p.useRef(!1);p.useEffect(()=>{const X=ne=>{var ae,me;const se=ne.target;le.current||(ae=R.current)!=null&&ae.contains(se)||(me=A.current)!=null&&me.contains(se)||se.closest("[data-radix-popper-content-wrapper]")||se.closest("[data-radix-select-viewport]")||se.closest('[role="listbox"]')||se.closest('[data-test="draggable-popover-wrapper"]')||se.closest("[data-radix-select-trigger]")||se.closest('[role="combobox"]')||k(!1)},Z=new MutationObserver(ne=>{for(const se of ne)if(se.type==="childList"){const ae=Array.from(se.addedNodes),me=Array.from(se.removedNodes);ae.some(he=>he instanceof HTMLElement&&he.hasAttribute("data-radix-popper-content-wrapper"))&&(le.current=!0),me.some(he=>he instanceof HTMLElement&&he.hasAttribute("data-radix-popper-content-wrapper"))&&setTimeout(()=>{le.current=!1},100)}});return C&&(document.addEventListener("pointerdown",X,!0),Z.observe(document.body,{childList:!0})),()=>{document.removeEventListener("pointerdown",X,!0),Z.disconnect()}},[C]);const de=N&&N.length>0;let U=n.text||n.label;if(n.disabled&&n.disabledTooltip)U=n.disabledTooltip;else if(_)U=_.label;else if(L){const X=N.find(Z=>Z.label===L);X&&(U=X.label)}const Y=X=>{const Z=X.target;Z.closest("[data-radix-select-trigger]")||Z.closest('[role="combobox"]')||X.stopPropagation()};return t.jsxs("div",{id:"UiSegmentedButton",ref:R,"data-prevent-canvas-click":!0,className:ve("ui-segmented-button","relative inline-flex items-stretch",s),...y,children:[t.jsx(Jt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"main-action-tooltip-wrapper",children:t.jsxs(ee,{variant:a,size:i,onClick:X=>{X.stopPropagation(),ie()},"aria-label":n.label,disabled:n.disabled,className:ve("ui-segmented-button__main-action",{"rounded-r-none":de,"border-r-0":de&&a==="outline","focus:z-10":de,"!opacity-40":n.disabled}),children:[n.icon,n.text&&t.jsx("span",{children:n.text})]})})}),t.jsx(Bt,{children:t.jsx("p",{children:U})})]})}),de&&t.jsxs(t.Fragment,{children:[t.jsx(ee,{id:l,variant:a,size:i,onClick:K,"aria-haspopup":"true","aria-expanded":C,"aria-label":"Toggle dropdown options",disabled:n.disabled||!N.some(X=>!X.disabled),className:ve("ui-segmented-button__dropdown-trigger","rounded-l-none",i!=="icon"&&"px-1",{"focus:z-10":de}),children:t.jsx(jt,{className:"ui-segmented-button__caret-icon w-1.5 h-2.5"})}),C&&tn.createPortal(t.jsx("div",{ref:A,onPointerDown:Y,onPointerUp:Y,onClick:Y,className:ve("ui-segmented-button__dropdown-menu","fixed rounded-md shadow-lg",v?"w-auto":"w-56","bg-popover text-popover-foreground border","transition-opacity duration-75",{"opacity-0 pointer-events-none":!H,"opacity-100":H},c),style:{zIndex:Ee.toolbarDropdown,top:j.top,left:j.left},role:"menu","aria-orientation":"vertical","aria-labelledby":l,"data-test":"segmented-button-dropdown-portal",children:v?t.jsx("div",{className:"grid gap-2 p-2",style:{gridTemplateColumns:r.some(X=>X.width)?r.map(X=>X.width||"1fr").join(" "):`repeat(${r.length}, 1fr)`},role:"none","data-test":"segmented-button-multi-column",children:r.map((X,Z)=>t.jsxs("div",{className:"flex flex-col gap-1","data-test":"segmented-button-column",children:[X.header&&t.jsx("span",{className:"text-xs font-medium text-muted-foreground px-1",children:X.header}),X.actions.map((ne,se)=>ne.customRender?t.jsx("div",{children:ne.customRender(q)},se):t.jsxs(ee,{variant:"ghost",size:"sm",onClick:()=>ye(ne.onClick,ne.label),disabled:ne.disabled,className:"h-7 px-2 justify-start",role:"menuitem",title:ne.label,"data-test":"segmented-button-action",children:[ne.icon&&t.jsx("span",{className:"mr-1",children:ne.icon}),t.jsx("span",{className:"text-xs",children:ne.label}),ne.selected&&t.jsx(Ys,{className:"ml-auto h-3 w-3"})]},se))]},Z))}):t.jsx("div",{className:"py-1",role:"none",children:o.map((X,Z)=>X.customRender?t.jsx("div",{children:X.customRender(q)},Z):t.jsxs(ee,{variant:"ghost",size:"sm",onClick:()=>ye(X.onClick,X.label),disabled:X.disabled,className:ve("ui-segmented-button__dropdown-item","w-full justify-start text-left font-normal"),role:"menuitem",children:[X.icon&&t.jsx("span",{className:"mr-2",children:X.icon})," ",X.label,X.selected&&t.jsx(Ys,{className:"ml-auto h-4 w-4"})]},Z))})}),document.body)]})]})},rm={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8},im=e=>{const{className:s,variant:n}=e,o=E.getState(),r=o.setMode,a=o.setAddNodeType,i=o.setSelectionBox,c=F(C=>C.uiState.customNodeDropdownOpen??!1),l=C=>{E.getState().setCustomNodeDropdownOpen(C)},d=()=>{r(Q.ADD),a(ce.TABLE),i(null)},u=()=>{r(Q.ADD),a(ce.TEXTCARD),i(null)},h=()=>{r(Q.ADD),a(ce.WORKFLOW_ORCHESTRATION),i(null)},f=()=>{r(Q.ADD),a(ce.WORKFLOW_SOURCE),i(null)},g=()=>{r(Q.ADD),a(ce.WORKFLOW_DEFINITION),i(null)},w=()=>{r(Q.ADD),a(ce.OCR),i(null)},m=()=>{r(Q.ADD),a(ce.IMAGE),i(null)},x=()=>{r(Q.ADD),a(ce.WORKFLOW_STEP),i(null)},y=()=>{r(Q.ADD),a(ce.VOCABULARY),i(null)},v=[{label:"1: Table",icon:t.jsx(Vu,{className:"h-2.5 w-2.5"}),onClick:d},{label:"2: Text Card",icon:t.jsx(Uu,{className:"h-2.5 w-2.5"}),onClick:u},{label:"3: Image",icon:t.jsx(Gu,{className:"h-2.5 w-2.5"}),onClick:m},{label:"4: OCR",icon:t.jsx(lo,{className:"h-2.5 w-2.5"}),onClick:w},{label:"5: Vocabulary",icon:t.jsx(Go,{className:"h-2.5 w-2.5"}),onClick:y},{label:"6: Workflow",icon:t.jsx(Ns,{className:"h-2.5 w-2.5"}),onClick:h},{label:"7: Source",icon:t.jsx(Kc,{className:"h-2.5 w-2.5"}),onClick:f},{label:"8: WF Runner",icon:t.jsx(st,{className:"h-2.5 w-2.5"}),onClick:g},{label:"9: WF Step",icon:t.jsx(Yu,{className:"h-2.5 w-2.5"}),onClick:x}],[N,b]=p.useState(v[0]),S=C=>{b(C),C.onClick(),l(!1)},I=()=>{N.onClick()};return p.useEffect(()=>{if(!c)return;const C=k=>{const R=rm[k.key];R!==void 0&&R<v.length?(k.preventDefault(),S(v[R])):k.key==="Escape"&&l(!1)};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[c,v]),t.jsx("div",{id:"ToolbarAddCustomNode",className:je("",s),"data-test":"toolbar-add-custom-node-button",children:t.jsx(Ze,{size:"sm",variant:n??"default",mainAction:{icon:N.icon,onClick:I,text:"(n)",label:`Add ${N.label}`},dropdownActions:v.map(C=>({...C,onClick:()=>S(C)})),dropdownPosition:"top",dropdownHorizontalAlign:"middle-right",dropdownVerticalOffset:-30,isOpen:c,onOpenChange:l})})},cm=()=>{const e=F(h=>h.uiState.mode),s=F(h=>h.uiState.addNodeType),n=F(h=>h.uiState.writeSubMode),o=e===Q.ADD&&s===ce.TEXT,r=e===Q.WRITE,a=r&&n===Vs.AUDIO,i=()=>{const h=E.getState();r?h.toggleWriteSubMode():o?(h.setMode(Q.WRITE),h.setWriteSubMode(Vs.WRITE)):(h.setMode(Q.ADD),h.setAddNodeType(ce.TEXT))},c=o||r,l=()=>a?t.jsx(Ku,{className:"h-4 w-4"}):r?t.jsx(Xu,{className:"h-4 w-4"}):t.jsx(Rs,{className:"h-4 w-4"}),d=()=>a?"Audio Mode (click to toggle)":r?"Write Mode (click for audio)":o?"Text Mode (click for write, or w/a)":"Text (t)",u=()=>a?"(a)":r?"(w)":"(T)";return t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-text-mode-wrapper",children:[t.jsxs(ee,{variant:c?"default":"secondary",size:"sm",className:je(a&&"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 text-white"),onClick:i,title:d(),"data-test":"canvas-toolbar-text-mode-button",children:[l(),t.jsx("span",{className:"hidden md:inline ml-1",children:u()})]}),t.jsx(Jt,{children:t.jsxs(Wt,{delayDuration:200,children:[t.jsx(Ht,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-text-mode-info-icon",children:t.jsx(Co,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Bt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-text-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-text-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Text Mode (t):"})," Click to add text nodes"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Write Mode (t→w):"})," Create nodes with Ctrl+Enter"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Audio Mode (t→a):"})," Auto-starts voice recording"]}),t.jsx("p",{className:"text-muted-foreground",children:"Click button to cycle through modes"})]})})]})})]})};class lm{constructor(){Fe(this,"currentNodeId",null);Fe(this,"nodes",[]);Fe(this,"yBandThreshold",100)}setNodes(s){this.nodes=s}setCurrentNode(s){this.currentNodeId=s}getCurrentNodeId(){return this.currentNodeId}getCurrentNode(){return this.currentNodeId?this.nodes.find(s=>s.id===this.currentNodeId)??null:null}getSortedNodes(){return[...this.nodes].sort((s,n)=>s.x!==n.x?s.x-n.x:s.y-n.y)}getCurrentIndex(){return this.getSortedNodes().findIndex(n=>n.id===this.currentNodeId)}getNodesInSameRow(s){return this.nodes.filter(n=>Math.abs(n.y-s.y)<=this.yBandThreshold)}moveLeft(){const s=this.getCurrentIndex();return s<=0?null:this.getSortedNodes()[s-1]??null}moveRight(){const s=this.getCurrentIndex(),n=this.getSortedNodes();return s<0||s>=n.length-1?null:n[s+1]??null}moveUp(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y<s.y-this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?r.y-o.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveDown(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y>s.y+this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?o.y-r.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveToLineStart(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>o.x-r.x),n[0]??null)}moveToLineEnd(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>r.x-o.x),n[0]??null)}moveToDocumentStart(){return this.getSortedNodes()[0]??null}moveToDocumentEnd(){const s=this.getSortedNodes();return s[s.length-1]??null}moveNext(){return this.moveRight()}movePrev(){return this.moveLeft()}}const Xe=new lm;function dm(e){const s=E.getState();s.setSelectedNodes([e]),Xe.setCurrentNode(e.id),s.scrollToNode(e.id,300)}function Et(e,s){const n=e();return n?(dm(n),!0):!1}let mo=null;function yi(e){mo=e}function vi(){return E.getState().setMode(Q.SELECT),mo==null||mo.popIdIf(Lt.canvasVim),!0}function um(e){const s=E.getState(),n=s.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.selectedNodes)??[];return o.length>0&&s.setNodeToFocusId(o[0].id),e==null||e.executeCommand(Qe.enterInsertMode,""),!0}function hm(e){return E.getState().setNodeToFocusId(null),e==null||e.executeCommand(Qe.enterNormalMode,""),!0}const pm=[{key:"i",command:Qe.enterInsertMode,desc:"Enter insert mode - edit selected node",execute:(e,s,n)=>um(n),preventUndoRedo:!0},{key:"h",command:Qe.cursorLeft,desc:"Move to previous node (left in spatial order)",execute:()=>Et(()=>Xe.moveLeft()),preventUndoRedo:!0},{key:"l",command:Qe.cursorRight,desc:"Move to next node (right in spatial order)",execute:()=>Et(()=>Xe.moveRight()),preventUndoRedo:!0},{key:"k",command:Qe.cursorUp,desc:"Move to node above",execute:()=>Et(()=>Xe.moveUp()),preventUndoRedo:!0},{key:"j",command:Qe.cursorDown,desc:"Move to node below",execute:()=>Et(()=>Xe.moveDown()),preventUndoRedo:!0},{key:"0",command:Qe.cursorLineStart,desc:"Move to first node in row",execute:()=>Et(()=>Xe.moveToLineStart()),preventUndoRedo:!0},{key:"$",command:Qe.cursorLineEnd,desc:"Move to last node in row",execute:()=>Et(()=>Xe.moveToLineEnd()),preventUndoRedo:!0},{key:"<Shift>$",command:Qe.cursorLineEnd,desc:"Move to last node in row",execute:()=>Et(()=>Xe.moveToLineEnd()),preventUndoRedo:!0},{key:"gg",command:Qe.goToFirstLine,desc:"Move to first node",execute:()=>Et(()=>Xe.moveToDocumentStart()),preventUndoRedo:!0},{key:"<Shift>G",command:Qe.goToLastLine,desc:"Move to last node",execute:()=>Et(()=>Xe.moveToDocumentEnd()),preventUndoRedo:!0},{key:"G",command:Qe.goToLastLine,desc:"Move to last node",execute:()=>Et(()=>Xe.moveToDocumentEnd()),preventUndoRedo:!0},{key:"w",command:Qe.cursorWordForwardStart,desc:"Move to next node",execute:()=>Et(()=>Xe.moveNext()),preventUndoRedo:!0},{key:"b",command:Qe.cursorBackwordsStartWord,desc:"Move to previous node",execute:()=>Et(()=>Xe.movePrev()),preventUndoRedo:!0},{key:"q",command:Qe.enterNormalMode,desc:"Exit vim mode",execute:()=>vi(),preventUndoRedo:!0},{key:"<Escape>",command:Qe.enterNormalMode,desc:"Exit vim mode",execute:()=>vi(),preventUndoRedo:!0}],gm=[{key:"<Escape>",command:Qe.enterNormalMode,desc:"Exit insert mode - return to normal mode",execute:(e,s,n)=>hm(n),preventUndoRedo:!0}];function fm(){return{[bn.NORMAL]:pm,[bn.INSERT]:gm,[bn.VISUAL]:[],[bn.ALL]:[]}}function Ds(e){var c,l;const s=((c=e.state)==null?void 0:c.activeProjectId)??null,n=s?((l=e.state)==null?void 0:l.projects[s])??null:null,o=(n==null?void 0:n.activeWorkspaceId)??null,r=o?(n==null?void 0:n.workspaces[o])??null:null,a=(r==null?void 0:r.activeCanvasId)??null,i=a?(r==null?void 0:r.canvases[a])??null:null;return{project:n,workspace:r,canvas:i,path:{projectId:s,workspaceId:o,canvasId:a}}}const bi=[],Ni=[],De={selectMode:e=>e.uiState.mode,selectIsSelectMode:e=>e.uiState.mode===Q.SELECT,selectIsMoveMode:e=>e.uiState.mode===Q.MOVE,selectIsDrawArrowMode:e=>e.uiState.mode===Q.DRAW_ARROW,selectIsAddTextMode:e=>e.uiState.mode===Q.ADD,selectIsAddTableMode:e=>e.uiState.mode===Q.ADD,selectIsWriteMode:e=>e.uiState.mode===Q.WRITE,selectActiveCanvas:e=>{const{canvas:s}=Ds(e);return s},selectActiveCanvasId:e=>{const{path:s}=Ds(e);return s.canvasId},selectActiveProjectId:e=>{var s;return((s=e.state)==null?void 0:s.activeProjectId)??null},selectActiveWorkspaceId:e=>{const{path:s}=Ds(e);return s.workspaceId},selectAllNodes:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.coreState.nodes)??bi},selectNode:e=>s=>De.selectAllNodes(s).find(o=>o.id===e)??null,selectSelectedNodes:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedNodes)??bi},selectIsNodeSelected:e=>s=>De.selectSelectedNodes(s).some(o=>o.id===e),selectAllArrows:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.coreState.arrows)??Ni},selectArrow:e=>s=>De.selectAllArrows(s).find(o=>o.id===e)??null,selectSelectedArrows:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedArrows)??Ni},selectIsArrowSelected:e=>s=>De.selectSelectedArrows(s).some(o=>o.id===e),selectArrowsConnectedToNode:e=>s=>De.selectAllArrows(s).filter(o=>o.startNodeId===e||o.endNodeId===e),selectCanvasOffset:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.viewState.offset)??{x:0,y:0}},selectCanvasScale:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.viewState.scale)??1},selectCanvasDimensions:e=>({width:e.uiState.canvasWidth??0,height:e.uiState.canvasHeight??0}),selectViewState:e=>{const s=De.selectActiveCanvas(e);return(s==null?void 0:s.viewState)??null},selectTemporaryArrow:e=>e.uiState.temporaryArrow,selectSelectionBox:e=>e.uiState.selectionBox,selectDragInfo:e=>e.uiState.dragInfo,selectResizingNode:e=>e.uiState.resizingNode,selectAddNodeType:e=>e.uiState.addNodeType,selectIsDragging:e=>e.uiState.dragInfo!==null,selectIsResizing:e=>e.uiState.resizingNode!==null,selectIsSelectionBoxActive:e=>e.uiState.selectionBox!==null,selectIsDrawingArrow:e=>e.uiState.temporaryArrow!==null,selectHasSelectedNodes:e=>De.selectSelectedNodes(e).length>0,selectHasSelectedArrows:e=>De.selectSelectedArrows(e).length>0,selectNodeCount:e=>De.selectAllNodes(e).length,selectArrowCount:e=>De.selectAllArrows(e).length,selectSelectedNodeCount:e=>De.selectSelectedNodes(e).length,selectSelectedArrowCount:e=>De.selectSelectedArrows(e).length,selectHasContent:e=>{const s=De.selectNodeCount(e),n=De.selectArrowCount(e);return s>0||n>0},selectIsCanvasEmpty:e=>!De.selectHasContent(e),selectCanvasStats:e=>({nodeCount:De.selectNodeCount(e),arrowCount:De.selectArrowCount(e),selectedNodeCount:De.selectSelectedNodeCount(e),selectedArrowCount:De.selectSelectedArrowCount(e),hasContent:De.selectHasContent(e)}),selectAllProjects:e=>{var s;return((s=e.state)==null?void 0:s.projects)??{}},selectActiveProject:e=>{const{project:s}=Ds(e);return s},selectActiveWorkspace:e=>{const{workspace:s}=Ds(e);return s}};let Si=!1;function mm(){const e=window.__vimContainer;if(e)return e;const s=ap.createContainer();return op.register(s),Hu.register(s),Bu.register(s),Fu.register(s),$u.register(s),zu.register(s),window.__vimContainer=s,s}function xm(e){if(Si)return;const s=e.get(_u),n=fm();s.registerCommands(Lt.canvasVim,n),Si=!0}function Ci(e){if(e.getInstanceMap(Lt.canvasVim))return;const n={id:Lt.canvasVim,mode:bn.NORMAL,cursor:{line:0,col:0},lines:[]};e.registerAndInit({vimId:Lt.canvasVim,vimState:n})}function wm(){const[e,s]=p.useState(!1),n=p.useRef(null),o=p.useRef(null),r=F(De.selectAllNodes),a=F(De.selectSelectedNodes),i=F(d=>d.uiState.mode);p.useEffect(()=>{const d=mm();return n.current=d.get(Yc),xm(d),yi(n.current),()=>{yi(null)}},[]),p.useEffect(()=>{Xe.setNodes(r)},[r]),p.useEffect(()=>{var u;const d=((u=a[0])==null?void 0:u.id)??null;Xe.setCurrentNode(d)},[a]),p.useEffect(()=>{const d=n.current;if(!d)return;const u=i===Q.VIM;if(u&&!e){Ci(d),d.setActiveId(Lt.canvasVim);const h=E.getState();h.setNodeToFocusId(null);const f=h.getEditingNode();f&&h.updateNode(f.id,{isEditing:!1});const g=d.getVimCore(Lt.canvasVim);if(g&&g.executeCommand(Qe.enterNormalMode,""),a.length===0&&r.length>0){const w=o.current,m=w?r.find(x=>x.id===w):null;if(m)E.getState().setSelectedNodes([m]),Xe.setCurrentNode(m.id),E.getState().scrollToNode(m.id,J.writeMode.scrollDuration);else{const x=Xe.moveToDocumentStart();x&&(E.getState().setSelectedNodes([x]),Xe.setCurrentNode(x.id))}}s(!0)}else!u&&e&&(a.length>0&&(o.current=a[0].id),d.popIdIf(Lt.canvasVim),s(!1))},[i,e,r,a]);const c=p.useCallback(d=>{const u=n.current;if(u){if(d){if(Ci(u),u.setActiveId(Lt.canvasVim),a.length===0&&r.length>0){const h=Xe.moveToDocumentStart();h&&(E.getState().setSelectedNodes([h]),Xe.setCurrentNode(h.id))}}else u.popIdIf(Lt.canvasVim);s(d)}},[r,a]),l=p.useCallback(()=>{c(!e)},[e,c]);return{vimEnabled:e,setVimEnabled:c,toggleVimMode:l}}const Ho=({onSelect:e})=>{const s=F(c=>{var l;return(l=c.undo.getCurrent())==null?void 0:l.id}),{undoPath:n,redoPath:o}=p.useMemo(()=>{const c=E.getState();return{undoPath:c.undo.getPath(),redoPath:c.undo.getRedoPath()}},[s]),r=p.useMemo(()=>{const c=[...o].reverse(),l=[...n].reverse();return[...c,...l]},[n,o]);if(r.length===0)return t.jsx("div",{className:"p-3 text-sm text-muted-foreground","data-test":"unified-history-empty",children:"No history available"});const a=c=>new Date(c).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=o.length;return t.jsx("div",{className:"flex flex-col h-full overflow-y-auto","data-test":"unified-history-list",children:r.map((c,l)=>{const d=l<i,u=c.id===s;return t.jsxs("button",{type:"button",onClick:()=>e(c.id),className:je("flex items-center gap-2 px-3 py-2 text-left transition-colors border-b border-border last:border-b-0",u&&"bg-accent/50",d&&"opacity-50",!d&&"hover:bg-accent",d&&"hover:bg-accent/30"),"data-test":"unified-history-item","data-redo":d,"data-current":u,children:[t.jsx("span",{className:"text-xs text-muted-foreground w-16 shrink-0",children:a(c.timestamp)}),t.jsx("span",{className:"text-sm truncate flex-1",children:c.label??zd(c.operation)}),u&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"●"})]},c.id)})})},Bo=({size:e="icon"})=>{const s=()=>{window.confirm("Clear all undo/redo history? This cannot be undone.")&&E.getState().undo.clear()};return t.jsx(ee,{variant:"ghost",size:e,onClick:s,title:"Clear history",className:"h-6 w-6 p-0","data-test":"clear-history-button",children:t.jsx(vt,{className:"h-3.5 w-3.5 text-muted-foreground hover:text-destructive"})})},Fo=({size:e="icon"})=>{const s=()=>{const n=E.getState().undo.getPath();n.length>0&&E.getState().undo.jumpTo(n[0].id)};return t.jsx(ee,{variant:"ghost",size:e,onClick:s,title:"Jump to start",className:"h-6 w-6 p-0","data-test":"jump-to-start-button",children:t.jsx(qu,{className:"h-3.5 w-3.5 text-muted-foreground"})})},$o=({size:e="icon"})=>{const s=()=>{const n=E.getState().undo.getRedoPath();n.length>0&&E.getState().undo.jumpTo(n[n.length-1].id)};return t.jsx(ee,{variant:"ghost",size:e,onClick:s,title:"Jump to end",className:"h-6 w-6 p-0","data-test":"jump-to-end-button",children:t.jsx(Zu,{className:"h-3.5 w-3.5 text-muted-foreground"})})},ym=e=>{const{className:s,style:n}=e;_n();const o=F(y=>y.uiState.mode),r=F(y=>y.uiState.addNodeType),a=F(y=>y.uiState.zoomSubMode),i=F(y=>y.uiState.arrowSubMode),c=F(y=>y.undo.canUndo()),l=F(y=>y.undo.canRedo()),{setVimEnabled:d}=wm(),u=E.getState(),h=u.setMode,f=u.setZoomSubMode,g=u.saveStateToLocalStorage,w=()=>{E.getState().undo.undo()},m=()=>{E.getState().undo.redo()},x=y=>{o===Q.VIM&&y!==Q.VIM&&d(!1),y===Q.VIM&&d(!0),h(y)};return t.jsxs("div",{className:je("p-2 bg-background border shadow pointer-events-auto rounded flex items-center","max-md:flex-wrap max-md:gap-2 max-md:w-full max-md:max-w-lg md:space-x-2",s),style:{...n},onMouseDown:y=>y.stopPropagation(),"data-ui-panel":"canvas-toolbar",children:[t.jsxs(ee,{variant:o===Q.SELECT?"default":"secondary",size:"sm",onClick:()=>x(Q.SELECT),title:"Select (v)","data-test":"canvas-toolbar-select-mode-button",children:[t.jsx(Xc,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(v)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-move-mode-wrapper",children:[t.jsxs(ee,{variant:o===Q.MOVE||o===Q.ZOOM?"default":"secondary",size:"sm",className:je(o===Q.ZOOM&&a==="zoom:lock"&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{o===Q.MOVE?(x(Q.ZOOM),f("zoom")):o===Q.ZOOM?(document.pointerLockElement&&document.exitPointerLock(),x(Q.MOVE)):x(Q.MOVE)},title:o===Q.ZOOM&&a==="zoom:lock"?"Zoom:Lock Mode (click or Esc to exit)":o===Q.ZOOM?"Zoom Mode (h to toggle Pan)":"Pan Mode (h to toggle Zoom)","data-test":"canvas-toolbar-move-mode-button",children:[o===Q.ZOOM?t.jsx(Ju,{className:"h-4 w-4"}):t.jsx(Qu,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(h)"})]}),t.jsx(Jt,{children:t.jsxs(Wt,{delayDuration:200,children:[t.jsx(Ht,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-move-mode-info-icon",children:t.jsx(Co,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Bt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-move-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-move-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Pan Mode (h):"})," Drag to pan the canvas"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom Mode (h again):"})," Scroll or drag to zoom"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom:Lock:"})," Double-click canvas to lock zoom, move mouse to zoom"]}),t.jsx("p",{className:"text-muted-foreground",children:"Press 'h' to toggle between Pan and Zoom"})]})})]})})]}),t.jsxs(ee,{variant:o===Q.GRID?"default":"secondary",size:"sm",onClick:()=>x(Q.GRID),title:"Grid Mode (g)","data-test":"canvas-toolbar-grid-mode-button",children:[t.jsx(eh,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(g)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-vim-mode-wrapper",children:[t.jsxs(ee,{variant:o===Q.VIM?"default":"secondary",size:"sm",onClick:()=>x(Q.VIM),title:"Vim Navigation Mode (i)","data-test":"canvas-toolbar-vim-mode-button",children:[t.jsx("span",{className:"text-sm font-bold","data-test":"vim-mode-icon",children:"V"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(i)"})]}),t.jsx(Jt,{children:t.jsxs(Wt,{delayDuration:200,children:[t.jsx(Ht,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-vim-mode-info-icon",children:t.jsx(Co,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Bt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-vim-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-vim-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Vim Mode:"})," Navigate nodes with vim keybindings"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"h/l:"})," Previous/next node (X-first order)"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"j/k:"})," Node below/above"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"0/$:"})," First/last node in row"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"gg/G:"})," First/last node"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"w/b:"})," Next/previous node"]})]})})]})})]}),t.jsxs(ee,{variant:o===Q.DRAW_ARROW?"default":"secondary",size:"sm",className:je(o===Q.DRAW_ARROW&&i===Rn.STAY&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>x(Q.DRAW_ARROW),title:o===Q.DRAW_ARROW&&i===Rn.STAY?"Draw Arrow: Stay Mode (a to toggle, Esc to exit)":"Draw Arrow (a)","data-test":"canvas-toolbar-draw-arrow-button",children:[t.jsx(Vt,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(a)"})]}),t.jsxs(ee,{variant:o===Q.DRAW?"default":"secondary",size:"sm",onClick:()=>x(Q.DRAW),title:"Draw Mode (d) - Freehand, Rectangle, Circle, Line","data-test":"canvas-toolbar-draw-mode-button",children:[t.jsx(Ks,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(d)"})]}),t.jsxs(ee,{variant:o===Q.ADD&&r===ce.CHAT?"default":"secondary",size:"sm",onClick:()=>{x(Q.ADD),u.setAddNodeType(ce.CHAT)},title:"Message Mode (m) - Add chat node","data-test":"canvas-toolbar-message-mode-button",children:[t.jsx(rr,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(m)"})]}),t.jsx(cm,{}),t.jsx(im,{variant:o===Q.ADD&&(r===ce.TABLE||r===ce.TEXTCARD||r===ce.OCR||r===ce.VOCABULARY||r===ce.WORKFLOW_ORCHESTRATION||r===ce.WORKFLOW_SOURCE||r===ce.WORKFLOW_DEFINITION)?"default":"secondary"}),t.jsx(zn,{expandContent:t.jsx(Ho,{onSelect:y=>E.getState().undo.jumpTo(y)}),expandTitle:"History",onClick:w,onHoldRepeat:w,holdRepeatInterval:J.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!c,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"canvas-toolbar-undo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(ir,{className:"h-4 w-4"})}),t.jsx(zn,{expandContent:t.jsx(Ho,{onSelect:y=>E.getState().undo.jumpTo(y)}),expandTitle:"History",onClick:m,onHoldRepeat:m,holdRepeatInterval:J.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!l,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"canvas-toolbar-redo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(qc,{className:"h-4 w-4"})}),t.jsx(ee,{variant:"secondary",size:"sm",onClick:g,title:"Save to Local Storage","data-test":"canvas-toolbar-save-button",children:t.jsx(Qt,{className:"h-4 w-4"})})]})},vm=({startX:e,startY:s,endX:n,endY:o})=>{const r=Math.min(e,n),a=Math.min(s,o),i=Math.abs(e-n),c=Math.abs(s-o);return i===0||c===0?null:t.jsx("div",{className:"absolute border border-ring bg-ring/20 pointer-events-none",style:{left:`${r}px`,top:`${a}px`,width:`${i}px`,height:`${c}px`,zIndex:20}})},bm=Ie.memo(vm),Nm=()=>{const e=F(s=>s.uiState.selectionBox);return e?t.jsx(bm,{startX:e.start.x,startY:e.start.y,endX:e.end.x,endY:e.end.y}):null},Sm=({node:e})=>t.jsxs("div",{className:je("bg-background border border-foreground p-2",e.className),style:{width:e.width?`${e.width}px`:"100px",height:e.height?`${e.height}px`:"50px",whiteSpace:"pre-line"},children:[e.content||"Rect"," "]});class Cm{createHighlight(s,n,o){return{id:n??Pe(),start:s.start,end:s.end,color:s.color,createdAt:o??Date.now()}}validateHighlight(s,n){return s.start<0?{valid:!1,error:"Highlight start cannot be negative"}:s.end>n?{valid:!1,error:`Highlight end (${s.end}) exceeds text length (${n})`}:s.start>=s.end?{valid:!1,error:"Highlight start must be less than end"}:{valid:!0}}findOverlapping(s,n,o,r){const a=(r==null?void 0:r.includeTouching)??!1;return s.filter(i=>a?!(i.end<n||i.start>o):!(i.end<=n||i.start>=o))}deleteHighlight(s,n){return s.filter(o=>o.id!==n)}sortHighlights(s){return[...s].sort((n,o)=>n.start!==o.start?n.start-o.start:n.end-o.end)}}function ji(e,s,n){let o=0,r=!1;function a(i){var c;if(r)return!0;if(i===s)return i.nodeType===Node.TEXT_NODE&&(o+=n),r=!0,!0;if(i.nodeType===Node.TEXT_NODE)o+=((c=i.textContent)==null?void 0:c.length)||0;else if(i.nodeType===Node.ELEMENT_NODE){const l=i,d=l.tagName;if(d==="BR")return o+=1,!1;let u=0,h=!1;if(d==="H1")u=2;else if(d==="H2")u=3;else if(d==="H3")u=4;else if(d==="BLOCKQUOTE")u=2;else if(l.classList.contains("list-item-ul"))u=2,h=!0;else if(l.classList.contains("list-item-ol")){const g=l.querySelector("span:first-child");u=((g==null?void 0:g.textContent)||"1.").length+1,h=!0}else if(l.classList.contains("empty-line"))return o+=1,!1;o+=u;const f=Array.from(i.childNodes);for(let g=0;g<f.length;g++)if(!(h&&g===0&&f[g].nodeName==="SPAN")&&a(f[g]))return!0}return!1}return a(e),o}function jm(e){if(e instanceof HTMLTextAreaElement){const s=e.selectionStart,n=e.selectionEnd;return s===n?null:{start:s,end:n}}if(e.isContentEditable){const s=window.getSelection();if(!s||s.isCollapsed||s.rangeCount===0)return null;const n=s.getRangeAt(0),o=ji(e,n.startContainer,n.startOffset),r=ji(e,n.endContainer,n.endOffset);return o===r?null:{start:o,end:r}}return null}const km="rgb(198, 183, 0)";function Am({textareaRef:e,node:s,updateNode:n,enabled:o=!0,defaultColor:r=km}){const a=p.useRef(new Cm),i=p.useCallback(d=>{if(!e.current||!o)return;const u=jm(e.current);if(!u)return;const h=s.highlights||[],f=a.current.findOverlapping(h,u.start,u.end);if(f.length>0){let v=h;for(const N of f)v=a.current.deleteHighlight(v,N.id);if(n(s.id,{highlights:v.length>0?v:void 0}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const N=window.getSelection();N&&N.collapseToEnd()}console.log("🗑️ Highlights removed:",f.length);return}const g=a.current.createHighlight({start:u.start,end:u.end,color:d||r}),w=s.content||"",m=a.current.validateHighlight(g,w.length);if(!m.valid){console.error("useTextHighlighting: Invalid highlight",m.error);return}const x=[...h,g],y=a.current.sortHighlights(x);if(n(s.id,{highlights:y}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const v=window.getSelection();v&&v.collapseToEnd()}console.log("✨ Highlight applied:",{start:u.start,end:u.end,color:g.color})},[e,o,s,n,r]),c=d=>{const u=s.highlights||[],h=a.current.deleteHighlight(u,d);n(s.id,{highlights:h.length>0?h:void 0}),console.log("🗑️ Highlight removed:",d)},l=()=>{n(s.id,{highlights:void 0}),console.log("🧹 All highlights cleared")};return p.useEffect(()=>{if(!o||!e.current)return;const d=()=>{Nn.registerCallback(i)},u=()=>{Nn.unregisterCallback(i)},h=e.current;return h.addEventListener("focus",d),h.addEventListener("blur",u),document.activeElement===h&&Nn.registerCallback(i),()=>{h.removeEventListener("focus",d),h.removeEventListener("blur",u),Nn.unregisterCallback(i)}},[o,e,i]),{applyHighlight:i,removeHighlight:c,clearAllHighlights:l}}function en(e,s="content"){const n=p.useRef(null),o=p.useCallback(a=>{n.current=a},[]),r=p.useCallback(a=>{const i=n.current;i!==null&&i!==a&&E.getState().undo.commit({type:"node:update",nodeId:e,from:{[s]:i},to:{[s]:a}}),n.current=null},[e,s]);return{onEditStart:o,onEditEnd:r}}function Yn(e,s={}){var x;const{duration:n=500,targetScale:o,highlightYOffset:r}=s,a=E.getState(),i=(x=a.projectCanvas.getActive())==null?void 0:x.viewState;if(!i)return;const c=document.getElementById("CanvasAppV2");if(!c)return;const l=c.getBoundingClientRect(),d=l.width/2,u=l.height/2,h=o??i.scale,f=e.x*h,g=e.y*h,w=r!==void 0?g+r*h:g+(e.height||0)*h/2,m={x:d-f-(e.width||0)*h/2,y:u-w};a.setActiveCanvasViewState(y=>({...y,targetView:{targetOffset:m,targetScale:h,animationStartTime:performance.now(),animationDuration:n}})),a.setSelectedNodes([e]),a.setNodeToFocusId(e.id)}function ki(e,s){let n=0;function o(r){var a,i,c,l,d;if(r.nodeType===Node.TEXT_NODE){const u=((a=r.textContent)==null?void 0:a.length)||0;if(n+u>=s){const h=s-n,f=Math.min(h,u);return{node:r,offset:f}}return n+=u,null}if(r.nodeType===Node.ELEMENT_NODE){const u=r,h=u.tagName;if(h==="BR")return n+1>s?{node:r.parentNode,offset:Array.from(r.parentNode.childNodes).indexOf(r)}:(n+=1,null);let f=0,g=!1,w=!1;if(h==="H1")f=2;else if(h==="H2")f=3;else if(h==="H3")f=4;else if(h==="BLOCKQUOTE")f=2;else if(u.classList.contains("list-item-ul"))f=2,g=!0,((i=u.previousElementSibling)!=null&&i.classList.contains("list-item-ul")||(c=u.previousElementSibling)!=null&&c.classList.contains("list-item-ol"))&&(w=!0);else if(u.classList.contains("list-item-ol")){const x=u.querySelector("span:first-child");f=((x==null?void 0:x.textContent)||"1.").length+1,g=!0,((l=u.previousElementSibling)!=null&&l.classList.contains("list-item-ul")||(d=u.previousElementSibling)!=null&&d.classList.contains("list-item-ol"))&&(w=!0)}else if(u.classList.contains("empty-line"))return n+1>s?{node:u,offset:0}:(n+=1,null);w&&(n+=1),n+=f;const m=Array.from(r.childNodes);for(let x=0;x<m.length;x++){if(g&&x===0&&m[x].nodeName==="SPAN")continue;const y=o(m[x]);if(y)return y}}return null}return o(e)}const Im=({text:e,highlights:s,className:n})=>!s||s.length===0?null:t.jsx(Tm,{text:e,highlights:s,className:n}),Tm=({text:e,highlights:s,className:n})=>{const o=p.useRef(null),r=p.useRef(null),[a,i]=p.useState([]),[c,l]=p.useState(0),[d,u]=p.useState(1);p.useEffect(()=>{var m;const f=E.subscribe(x=>{var N;const y=(N=x.projectCanvas.getActive())==null?void 0:N.viewState,v=(y==null?void 0:y.scale)??1;u(v)}),w=(m=E.getState().projectCanvas.getActive())==null?void 0:m.viewState;return u((w==null?void 0:w.scale)??1),f},[]);const h=f=>{var x;if(!f)return;const m=(((x=E.getState().projectCanvas.getActive())==null?void 0:x.coreState.nodes)??[]).find(y=>y.id===f);if(!m){console.warn(`Linked node ${f} not found`);return}Yn(m,{duration:400})};return p.useEffect(()=>{var m,x;const f=o.current;if(!f)return;const g=((m=f.parentElement)==null?void 0:m.querySelector("textarea"))||((x=f.parentElement)==null?void 0:x.querySelector(".markdown-textarea"));if(!g)return;l(g.clientWidth);const w=new ResizeObserver(y=>{for(const v of y)v.target===g&&l(g.clientWidth)});return w.observe(g),()=>{w.disconnect()}},[]),p.useEffect(()=>{if(!o.current||!r.current||!s||s.length===0){i([]);return}const f=requestAnimationFrame(()=>{var C,k,R,A;if(!o.current||!r.current)return;const g=o.current,w=((C=g.parentElement)==null?void 0:C.querySelector("textarea"))||((k=g.parentElement)==null?void 0:k.querySelector(".markdown-textarea"));if(!w){i([]);return}const m=r.current,x=window.getComputedStyle(w);m.style.font=x.font,m.style.fontSize=x.fontSize,m.style.fontFamily=x.fontFamily,m.style.fontWeight=x.fontWeight,m.style.lineHeight=x.lineHeight,m.style.letterSpacing=x.letterSpacing,m.style.wordSpacing=x.wordSpacing,m.style.padding=x.padding,m.style.paddingLeft=x.paddingLeft,m.style.paddingRight=x.paddingRight,m.style.paddingTop=x.paddingTop,m.style.paddingBottom=x.paddingBottom,m.style.width=`${w.clientWidth}px`,m.style.border="none";const y=parseFloat(x.borderTopWidth)||0,v=parseFloat(x.borderLeftWidth)||0;m.style.top=`${y}px`,m.style.left=`${v}px`,m.style.wordWrap=x.wordWrap,m.style.whiteSpace=x.whiteSpace,m.style.overflowWrap=x.overflowWrap,m.style.boxSizing=x.boxSizing,m.style.textAlign=x.textAlign,m.style.direction=x.direction,m.style.wordBreak=x.wordBreak,m.textContent=e;const N=w.getBoundingClientRect(),b=g.getBoundingClientRect(),S=w.classList.contains("markdown-textarea"),I=[];for(const T of s){const O=Math.min(T.start,e.length),$=Math.min(T.end,e.length);if(O>=$)continue;const B=e.substring(O,$);try{let H;if(S){const M=ki(w,O),j=ki(w,$),P=((R=M==null?void 0:M.node.textContent)==null?void 0:R.length)??0,W=((A=j==null?void 0:j.node.textContent)==null?void 0:A.length)??0,L=M&&M.offset>=0&&M.offset<=P,z=j&&j.offset>=0&&j.offset<=W;if(!M||!j||!L||!z)continue;const _=document.createRange();_.setStart(M.node,M.offset),_.setEnd(j.node,j.offset),H=_.getClientRects()}else{const M=document.createRange(),j=m.firstChild;if(!j||j.nodeType!==Node.TEXT_NODE)continue;M.setStart(j,O),M.setEnd(j,$),H=M.getClientRects()}for(let M=0;M<H.length;M++){const j=H[M],P={top:j.top-b.top,left:j.left-b.left},W={top:j.top-N.top,left:j.left-N.left},L=parseFloat(x.borderTopWidth)||0,z=P.top-L,_=parseFloat(x.paddingLeft)||0,G=S?W.left:W.left-_,V=j.width,D=j.height;if(V<1)continue;const K=z/d,te=G/d,ie=V/d+8,ye=D/d;I.push({id:`${T.id}-${M}`,top:K,left:te,width:ie,height:ye,color:T.color,linkedNodeId:T.linkedNodeId,highlightedText:B})}}catch(H){console.error("Error calculating highlight rect:",H)}}i(I)});return()=>{cancelAnimationFrame(f)}},[e,s,c,d]),t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:r,className:je("mirror-div absolute inset-0 pointer-events-none whitespace-pre-wrap"),"aria-hidden":"true"}),t.jsx("div",{ref:o,className:je("highlight-renderer","absolute inset-0","z-20","pointer-events-none",n),"aria-hidden":"true",children:a.map(f=>t.jsx("mark",{"data-test":"highlight-mark",className:je("absolute",f.linkedNodeId?"cursor-pointer pointer-events-auto":"pointer-events-none"),onClick:f.linkedNodeId?()=>h(f.linkedNodeId):void 0,style:{top:`${f.top}px`,left:`${f.left}px`,width:`${f.width}px`,height:`${f.height}px`,backgroundColor:f.color,opacity:.4,borderRadius:"2px"}},f.id))})]})};function Em(e,s){const n=e.split(`
`);let o=0;for(let r=0;r<n.length;r++){const a=n[r].length,i=o+a;if(s<=i)return r;o=i+1}return n.length-1}function Rm(e,s,n=Ne.DEFAULT_PADDING,o=Ne.LINE_HEIGHT){const r=Em(e,s.start);return n+r*o+o/2}function Mm({textareaRef:e,onCopy:s,onHighlight:n,onDelete:o,onLink:r,onHighlightAndCreateNode:a,onDefine:i}){const[c,l]=p.useState(!1),[d,u]=p.useState({start:0,end:0}),h=p.useRef({start:0,end:0}),f=p.useRef(null),g=p.useRef(!1);p.useEffect(()=>{const x=()=>{g.current=!0,l(!1)};return Xt.registerDismissPopoverCallback(x),()=>{Xt.unregisterDismissPopoverCallback()}},[]),p.useEffect(()=>(Xt.registerSelectionCallback(x=>{l(x)}),f.current=setInterval(()=>{const x=e.current;if(!x)return;const y=x.selectionStart,v=x.selectionEnd,N=y!==v;N&&((y!==h.current.start||v!==h.current.end)&&(g.current=!1),h.current={start:y,end:v},u({start:y,end:v})),g.current||l(N)},100),()=>{Xt.unregisterSelectionCallback(),f.current&&clearInterval(f.current)}),[e]);const w=()=>{const x=e.current;return x?(x.value??"").substring(d.start,d.end):""},m=(x,y)=>{x.preventDefault(),x.stopPropagation(),g.current=!0;const v=e.current;v&&(v.focus(),v.setSelectionRange(d.start,d.end)),y&&y(),setTimeout(()=>{l(!1)},20)};return t.jsx(rp,{inputRef:e,show:c,updateOn:d,offset:{top:4,left:0},children:t.jsxs("div",{className:"text-selection-popover bg-popover text-popover-foreground border border-border rounded-md shadow-lg p-1","data-test":"text-selection-popover",onPointerDown:x=>{x.preventDefault()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center gap-1",children:[s&&t.jsx("button",{"data-test":"text-selection-copy-button",onPointerDown:x=>m(x,s),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Create linked node",children:t.jsx(Pt,{className:"w-4 h-4"})}),a&&t.jsx("button",{"data-test":"text-selection-highlight-create-button",onPointerDown:x=>m(x,a),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight & create linked node",children:t.jsx(Pn,{className:"w-4 h-4"})}),i&&t.jsx("button",{"data-test":"text-selection-define-button",onPointerDown:x=>m(x,i),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Define word",children:t.jsx(Go,{className:"w-4 h-4"})}),n&&t.jsx("button",{"data-test":"text-selection-highlight-button",onPointerDown:x=>m(x,n),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight text",children:t.jsx(Zc,{className:"w-4 h-4"})}),r&&t.jsx("button",{"data-test":"text-selection-link-button",onPointerDown:x=>m(x,r),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Link to node",children:t.jsx(th,{className:"w-4 h-4"})}),o&&t.jsx("button",{"data-test":"text-selection-delete-button",onPointerDown:x=>m(x,o),className:"action-button p-2 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors",title:"Delete selection",children:t.jsx(vt,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"selection-preview text-xs text-muted-foreground mt-1 px-2 py-1 max-w-[200px] truncate",children:['"',w(),'"']})]})})}function Pm({input:e,lastKeyWasEnter:s=!1,pendingNewlines:n=0,computedLineHeight:o=Ne.LINE_HEIGHT,currentNodeHeight:r=0}){const a=e.split(/\n|&nbsp;/);let i=a.length,c=Ne.DEFAULT_NODE_HEIGHT;if(i===1&&!s&&n===0)return c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:0,headerExtraLines:0};i+=n;let l=0,d=!1,u=!0;const h=n>0;let f=0;for(let g=0;g<a.length;g++){const m=a[g].trimStart(),x=m.startsWith("- ")||/^\d+\.\s/.test(m),y=g===a.length-1;x&&!d&&!u&&(!y||h)&&(l+=1),(!y||h)&&(m.startsWith("# ")?f+=.5:m.startsWith("## ")?f+=.3:m.startsWith("### ")&&(f+=.1)),d=x,u=!1}return i+=l+f,c+=(i-1)*o,c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:l,headerExtraLines:f}}const Ai=(e,s)=>{const o=E.getState().projectCanvas.getActive();if(!o)return null;const a=(o.coreState.nodes||[]).filter(c=>c.linkedSourceNodeId===e&&Array.isArray(c.tags)&&c.tags.some(l=>l.title===s));return a.length===0?null:Math.max(...a.map(c=>(c.y??0)+(c.height??0)))},Ii=e=>({id:Math.random().toString(36).slice(2,10),title:e}),Ti=e=>({x:(e.x??0)+(e.width??0)/2,y:(e.y??0)+(e.height??0)/2}),Ei=(e,s)=>{const n=E.getState(),o=()=>Math.random().toString(36).slice(2,10);window.setTimeout(()=>{n.arrow.add({id:o(),startNodeId:e.id,endNodeId:s.id,startPoint:Ti(e),endPoint:Ti(s),type:"TreeLStep"})},0)},Dm=Ie.memo(({node:e,isEditing:s,preventEdit:n})=>{const o=p.useCallback(()=>{const i=E.getState(),c=i.getNodeById(e.id);if(!c)return;const l=Ne.DEFAULT_NODE_WIDTH,d=Ne.DEFAULT_NODE_HEIGHT,u=40,h=c.x-l/2,f=Ai(c.id,"left"),g=f!==null?f+u:c.y+(c.height??0)+u,w=Le.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});w.x=h,w.y=g,w.width=l,w.height=d,w.tags=[Ii("left")],i.addNode(w,void 0,{dontOverlap:!0}),i.setNodeToFocusId(w.id),Ei(c,w)},[e.id]),r=p.useCallback(()=>{const i=E.getState(),c=i.getNodeById(e.id);if(!c)return;const l=Ne.DEFAULT_NODE_WIDTH,d=Ne.DEFAULT_NODE_HEIGHT,u=40,h=c.x+(c.width??0)-l/2,f=Ai(c.id,"right"),g=f!==null?f+u:c.y+(c.height??0)+u,w=Le.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});w.x=h,w.y=g,w.width=l,w.height=d,w.tags=[Ii("right")],i.addNode(w,void 0,{dontOverlap:!0}),i.setNodeToFocusId(w.id),Ei(c,w)},[e.id]);return!s||n||!(e.content&&e.content.trim().length>0)?null:t.jsxs(t.Fragment,{children:[t.jsx(ee,{"data-test":"create-left-child-node-button",size:"icon",variant:"ghost",className:"create-left-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),o()},title:"Create linked node on the left",children:"+"}),t.jsx(ee,{"data-test":"create-right-child-node-button",size:"icon",variant:"ghost",className:"create-right-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${2*(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),r()},title:"Create linked node on the right",children:"+"})]})}),zl=new Map;function Om(e){const s=e.data;if((s==null?void 0:s.vocabType)!==Ue.VOCABULARY)return null;const n=s.sourceWord||"",o=s.translationWord||"",r=ys(n),a=ys(o),i=Math.max(r,a);return{width:Math.max(i+vs.textNodeXPadding,Ne.VOCAB_NODE_MIN_WIDTH),height:null}}zl.set(ce.VOCABULARY,Om);function Ri(e){const s=zl.get(e.type);return s?s(e):null}const Ca=()=>{var e;return((e=E.getState().projectCanvas.getActive())==null?void 0:e.coreState.selectedNodes)??[]},ja=()=>E.getState().updateNode;function on(){const e=p.useCallback(r=>{const a=r||Ca(),i=ja();if(a.length===0)return;const c=Lr(),l=a.map(d=>{if(!(d!=null&&d.id))return null;const u=Ri(d);if(u){const g={...d,width:u.width};return u.height!==null&&(g.height=u.height),{id:d.id,payload:g}}if(!d.content||typeof d.content!="string")return null;const{width:h,height:f}=bs(d.content,c,d);return h>0?{id:d.id,payload:{...d,width:h,height:f}}:null}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const u={width:d.payload.width,options:{...d.payload.options,lockSize:!0}};d.payload.height!==void 0&&(u.height=d.payload.height),i(d.id,u)})},[]),s=p.useCallback((r,a)=>{const i=a||Ca(),c=ja(),l=i.map(d=>{if(!(d!=null&&d.id))return null;const u=Ri(d);if(u){const g={...d,width:r,options:{...d.options,lockSize:!0}};return u.height!==null&&(g.height=u.height),{id:d.id,payload:g}}const h=d.content||"",f=ht(h,r,d);return{id:d.id,payload:{...d,width:r,height:f,options:{...d.options,lockSize:!0}}}}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const u={width:d.payload.width,options:d.payload.options};d.payload.height!==void 0&&(u.height=d.payload.height),c(d.id,u)})},[]),n=p.useCallback((r,a,i)=>{if(r.length===0)return;const c=ja(),l=i??J.arrange.gap,d=Lr();r.map(h=>{if(!(h!=null&&h.id)||!h.content||typeof h.content!="string")return null;const{width:f,height:g}=bs(h.content,d,h);return f>0?{id:h.id,width:f,height:g}:null}).filter(h=>h!==null).forEach(h=>{c(h.id,{width:h.width,height:h.height,options:{lockSize:!1}})}),setTimeout(()=>{const h=E.getState();let f=a;r.forEach(g=>{const w=h.getNodeById(g.id);w&&(h.updateNode(g.id,{y:f}),f+=(w.height??0)+l)})},10)},[]);return p.useMemo(()=>({fitNodeDimensions:e,setFixedWidth:s,fitAndRepositionNodes:n,get selectedNodes(){return Ca()}}),[e,s,n])}const _l=p.createContext({inChat:!1});function Lm(){return p.useContext(_l)}function Wm(e){const s=p.useCallback(()=>Wr.has(e),[e]);return p.useSyncExternalStore(n=>Wr.subscribe(n),s,s)}const Hm="type here...",Bm=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??sr},Vl=Ie.memo(({node:e})=>{var ie,ye,ge,q,le,de;const s=p.useRef(null),n=p.useRef(null),[o,r]=p.useState(!1),[a,i]=p.useState(e.content||""),c=p.useRef(0),l=_n(),d=wo(Bm),u=Wm(e.id),{inChat:h,containerWidth:f,onSendMessage:g}=Lm(),{onEditStart:w,onEditEnd:m}=en(e.id,"content");p.useEffect(()=>{if(s.current){const U=s.current.getTextArea();U&&(n.current=U)}},[s.current]);const{updateNodeContent:x,updateNode:y,setMode:v,deleteNodeById:N}=E.getState(),b=F(U=>U.uiState.nodeToFocusId),S=F(U=>U.uiState.mode),I=F(U=>U.uiState.writeSubMode);F(U=>{var Y;return((Y=U.uiState.dragInfo)==null?void 0:Y.draggedNodeId)===e.id});const C=F(U=>{var Y,X;return((X=(Y=U.projectCanvas.getActive())==null?void 0:Y.coreState.selectedNodes)==null?void 0:X.some(Z=>Z.id===e.id))??!1}),k=F(U=>{var Y,X;return((X=(Y=U.projectCanvas.getActive())==null?void 0:Y.coreState.selectedNodes)==null?void 0:X.length)??0}),R=C&&b===e.id,{fitNodeDimensions:A,setFixedWidth:T}=on(),O=U=>{const Y=U.target.value,X=(a.match(/\n/g)||[]).length,ne=(Y.match(/\n/g)||[]).length-X;ne>0&&(c.current=Math.max(0,c.current-ne)),i(Y),x(e.id,Y)},$=p.useCallback(U=>{var he;U.preventDefault();const Y=U.clipboardData.getData("text"),X=(he=s.current)==null?void 0:he.getTextArea();if(!X)return;const Z=X.selectionStart,ne=X.selectionEnd,se=X.value;if(!se)return;const ae=se.substring(0,Z)+Y+se.substring(ne);X.value=ae;const me=Z+Y.length;X.setSelectionRange(me,me),i(ae),x(e.id,ae),setTimeout(()=>{const ue=E.getState().getNodeById(e.id);ue!=null&&ue.width&&T(ue.width,[ue])},10)},[e.id,x,T]),B=p.useCallback(()=>{setTimeout(()=>{const Y=E.getState().getNodeById(e.id);Y!=null&&Y.width&&T(Y.width,[Y])},10)},[e.id,T]),H=p.useCallback(()=>{setTimeout(()=>{const Y=E.getState().getNodeById(e.id);Y&&A([Y])},10)},[e.id,A]),M=p.useCallback(()=>{setTimeout(()=>{const Y=E.getState().getNodeById(e.id);Y!=null&&Y.width&&T(Y.width,[Y])},10)},[e.id,T]);Am({textareaRef:n,node:e,updateNode:y,enabled:o,defaultColor:void 0});const j=p.useCallback(U=>{r(U),y(e.id,{isEditing:U})},[y,e.id]),P=p.useCallback(()=>{var U,Y;if(!document.querySelector("[data-radix-popper-content-wrapper]")){if(!a.trim()){N(e.id);return}c.current=0,x(e.id,a),m(a),j(!1),y(e.id,{isEditing:!1}),(U=window.getSelection())==null||U.removeAllRanges(),(Y=e.options)!=null&&Y.lockSize||setTimeout(()=>{const Z=E.getState().getNodeById(e.id);Z!=null&&Z.width&&T(Z.width,[Z])},10),Wo.has(e.id)&&Yf(e.id)}},[e.id,e.width,e.height,(ie=e.options)==null?void 0:ie.lockSize,x,a,y,T,m,N]),W=p.useCallback(U=>{var ne,se,ae;const Y=window.getSelection();Y==null||Y.rangeCount,(ne=Y==null?void 0:Y.anchorNode)==null||ne.nodeName,Y==null||Y.anchorOffset,(se=Y==null?void 0:Y.focusNode)==null||se.nodeName,Y==null||Y.focusOffset,Y==null||Y.isCollapsed,(ae=Y==null?void 0:Y.toString())==null||ae.substring(0,30);const Z=U.currentTarget.getBoundingClientRect();U.clientX,U.clientY,Math.round(Z.left),Math.round(Z.top),Math.round(Z.right),Math.round(Z.bottom),U.clientX>=Z.left&&U.clientX<=Z.right&&U.clientY>=Z.top&&U.clientY<=Z.bottom,e.isEditing&&U.shiftKey},[e.isEditing,e.id]),L=p.useCallback(()=>{var Y;if(!e.isEditing)return;const U=(Y=s.current)==null?void 0:Y.getTextArea();U&&U.focus()},[e.isEditing]),z=p.useCallback(U=>{if(!U)return"";if("value"in U&&typeof U.value=="string")return U.value;const Y=ne=>{let se="";for(const ae of ne.childNodes)if(ae.nodeType===Node.TEXT_NODE)se+=ae.textContent||"";else if(ae.nodeType===Node.ELEMENT_NODE){const me=ae;if(me.tagName==="BR")se+=`
`;else if(me.tagName==="DIV"||me.tagName==="P"){const he=Y(me);se+=he+`
`}else se+=Y(me)}return se};return Y(U).replace(/\n+$/,"")},[]),_=p.useCallback(U=>{var pe,ue,oe,re,xe;if(U.key==="Escape"){P(),j(!1),E.getState().uiState.mode!==Q.VIM&&v(Q.SELECT),(ue=(pe=s.current)==null?void 0:pe.getTextArea())==null||ue.blur();return}if(U.key==="Enter"&&U.ctrlKey){const we=(oe=s.current)==null?void 0:oe.getTextArea(),fe=z(we);x(e.id,fe);return}if(h&&U.key==="Enter"&&!U.shiftKey&&!l){U.preventDefault(),x(e.id,a),g==null||g();return}let Y=a;if(U.key==="Backspace"||U.key==="Delete"){const we=(re=s.current)==null?void 0:re.getTextArea();if(we){const fe=we.selectionStart,Ce=we.selectionEnd;fe!==Ce?Y=a.substring(0,fe)+a.substring(Ce):U.key==="Backspace"&&fe>0?Y=a.substring(0,fe-1)+a.substring(fe):U.key==="Delete"&&fe<a.length&&(Y=a.substring(0,fe)+a.substring(fe+1))}}if(U.key==="Enter"){const we=Y.split(`
`),fe=we[we.length-1].replace(/\u200B/g,"");/^(\s*)-\s*$/.test(fe)||/^(\s*)(\d+)\.\s*$/.test(fe)?c.current=0:c.current+=1}else c.current=0;const X=ae();let Z=me(Y,U.key==="Enter",c.current,X);const ne=he(Y);let se=(xe=e.options)!=null&&xe.lockSize?e.width:ne;if(h&&f&&se!==void 0&&se>f&&(se=f),U.key==="Enter"&&c.current>0){const we=(e.height??0)+X;Z=Math.max(Z,we)}y(e.id,{width:se,height:Z,isEditing:!0});function ae(){var fe;const we=(fe=s.current)==null?void 0:fe.getTextArea();if(we){const ke=window.getComputedStyle(we).lineHeight;if(ke&&ke!=="normal"){const Ae=parseFloat(ke);if(!isNaN(Ae))return Ae}}return Ne.LINE_HEIGHT}function me(we,fe=!1,Ce=0,ke=Ne.LINE_HEIGHT){return Pm({input:we,lastKeyWasEnter:fe,pendingNewlines:Ce,computedLineHeight:ke,currentNodeHeight:e.height??0}).finalHeight}function he(we,fe=Ne.DEFAULT_NODE_WIDTH,Ce=vs.textNodeXPadding){const Me=we.split(/\n/).map(Oe=>yo(Oe)).reduce((Oe,nt)=>Math.max(Oe,nt),0)+Ce,He=Math.max(Me,fe);return U.key==="Backspace"||U.key==="Delete"?Math.min(He,e.width??He):Math.max(He,e.width??0)}},[P,x,y,e.id,e.width,e.height,(ye=e.options)==null?void 0:ye.lockSize,a,v,h,f,g,l]);p.useEffect(()=>{b||j(!1)},[b]),p.useEffect(()=>{!C&&o&&j(!1)},[C,o,j]),p.useEffect(()=>{var Z,ne;if(!R)return;const U=!o,Y=e.content||"";if(j(!0),i(Y),U&&w(Y),!U)return;const X=(Z=s.current)==null?void 0:Z.getTextArea();if(X){X.readOnly=!1,X.focus({preventScroll:!0}),X.click();const se=((ne=X.value)==null?void 0:ne.length)??0;X.selectionStart=X.selectionEnd=se}window.setTimeout(()=>{var me,he;const se=(me=s.current)==null?void 0:me.getTextArea();if(se&&document.activeElement!==se){se.readOnly=!1,se.focus({preventScroll:!0}),se.click();const pe=((he=se.value)==null?void 0:he.length)??0;se.selectionStart=se.selectionEnd=pe}},50)},[R,e.content,o,w]),p.useEffect(()=>{var Y;const U=(Y=s.current)==null?void 0:Y.getTextArea();if(U)return U.addEventListener("blur",P),()=>{U.removeEventListener("blur",P)}},[P,e.id,e.width,e.height,(ge=e.options)==null?void 0:ge.lockSize]),p.useEffect(()=>{i(e.content||"")},[e.content]);const G=p.useCallback(()=>{const Y=E.getState().TextModeHandler;if(Y){const X=new Y;X&&typeof X.onCopy=="function"&&X.onCopy()}},[]),V=p.useCallback(()=>{var Y,X;const U=new KeyboardEvent("keydown",{key:"h",ctrlKey:!0,bubbles:!0});(X=(Y=s.current)==null?void 0:Y.getTextArea())==null||X.dispatchEvent(U)},[]),D=p.useCallback(()=>{var ne;const U=(ne=s.current)==null?void 0:ne.getTextArea();if(!U)return;const Y=U.selectionStart,X=U.selectionEnd,Z=a.substring(0,Y)+a.substring(X);i(Z),x(e.id,Z),setTimeout(()=>{var se,ae;(ae=(se=s.current)==null?void 0:se.getTextArea())==null||ae.setSelectionRange(Y,Y)},0)},[a,e.id,x]),K=p.useCallback(()=>{var Z;if(!((Z=s.current)==null?void 0:Z.getTextArea()))return;const Y=new Xt,X=new KeyboardEvent("keydown",{key:"!"});Y.highlightAndCreateNode(X)},[]),te=p.useCallback(async()=>{var fe,Ce;const U=(fe=s.current)==null?void 0:fe.getTextArea();if(!U)return;const Y=U.selectionStart,X=U.selectionEnd,ne=U.value.substring(Y,X);if(!ne.trim())return;const se=E.getState(),ae="rgb(198, 183, 0)",me=await ip(ne.trim(),"English");let he;if(Y!==X){const ke=e.highlights||[],Ae=ke.find(Me=>Me.start===Y&&Me.end===X);if(Ae)he=Ae.id;else{he=Math.random().toString(36).slice(2,10);const Me={id:he,start:Y,end:X,color:ae,createdAt:Date.now()},He=[...ke,Me];se.updateNode(e.id,{highlights:He})}}const pe=`${ne}

${me.definition}`,ue=Le.buildTextNodeV2({content:pe,linkedHighlightId:he,linkedSourceNodeId:e.id}),oe=Nl(U,Y,X),re=(Ce=se.projectCanvas.getActive())==null?void 0:Ce.viewState,xe=(re==null?void 0:re.scale)??1;let we=e.y;if(oe){const ke=oe.top/xe;we=e.y+ke}if(Jo(ue,{...e,y:we,id:e.id}),he){const ke=se.getNodeById(e.id),Me=((ke==null?void 0:ke.highlights)||[]).map(He=>He.id===he?{...He,linkedNodeId:ue.id}:He);se.updateNode(e.id,{highlights:Me})}},[e]);return t.jsxs(t.Fragment,{children:[e.linkedHighlightId&&e.linkedSourceNodeId&&C&&k===1&&t.jsx("div",{className:"absolute z-50 cursor-pointer","data-test":"text-node-linked-highlight-indicator",style:{left:`${(e.width||0)+8}px`,top:"4px"},onClick:U=>{var ae;U.stopPropagation();const Z=(((ae=E.getState().projectCanvas.getActive())==null?void 0:ae.coreState.nodes)??[]).find(me=>me.id===e.linkedSourceNodeId);if(!Z)return;const ne=(Z.highlights||[]).find(me=>me.id===e.linkedHighlightId);let se;ne&&typeof Z.content=="string"&&(se=Rm(Z.content,ne,4,Ne.LINE_HEIGHT)),Yn(Z,{duration:400,highlightYOffset:se})},title:"Navigate to source highlight",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18","data-test":"text-node-linked-highlight-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-600 hover:text-yellow-700",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}),t.jsx(Dm,{node:e,isEditing:!!o,preventEdit:!1}),u&&!o&&t.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 z-50",title:"Transcription in progress...","data-test":"text-node-transcription-indicator"}),t.jsxs("div",{className:"relative w-full h-full","data-text-position-container":"true","data-test":"text-node-position-container",children:[!o&&C&&k<=1&&l&&t.jsx("div",{className:"absolute inset-0 z-20 cursor-pointer",onClick:L,onTouchEnd:U=>{U.preventDefault(),L()},"data-text-node-click-overlay":"true","data-test":"text-node-mobile-click-overlay"}),o&&t.jsx(Mm,{textareaRef:n,onCopy:G,onHighlight:V,onDelete:D,onHighlightAndCreateNode:K,onDefine:te,"data-test":"text-node-selection-popover"}),t.jsx(Im,{text:a,highlights:e.highlights,"data-test":"text-node-highlight-renderer"}),t.jsx(Lc,{ref:s,value:a,onChange:O,onPaste:$,onPasteComplete:B,onBlur:P,onKeyDown:_,onMouseDown:W,onClick:L,placeholder:Hm,readOnly:!o,showFilePicker:!1,showAudioButton:o||u,showConfigButton:o||u,audioButtonVariant:"muted",autoStartAudioRecording:R&&S===Q.WRITE&&I===Vs.AUDIO,onAudioTranscriptionComplete:H,audioNodeId:e.id,useMarkdown:!0,showBuiltInPopover:!1,keyboard:d,onModeChange:M,"data-test":"text-node-textarea",className:je("relative","m-0 p-1 w-full h-full","min-h-0","resize-none","border","rounded-[3px]",e.className,{"overflow-hidden":!l||!o,"overflow-y-auto":l&&o,"pointer-events-none":!o&&!C||k>1,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!a&&!o},"bg-primary/1"),style:{zIndex:Ee.nodeTextarea,textAlign:(q=e.styles)==null?void 0:q.textAlign,fontSize:(le=e.styles)==null?void 0:le.fontSize,lineHeight:(de=e.styles)!=null&&de.fontSize?`${Math.round(parseFloat(e.styles.fontSize)*1.5)}px`:void 0,border:h?"none":void 0}})]})]})}),Fm=()=>{var a;const e=E.getState(),s=((a=e.projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],n=e.updateNodes,o=p.useMemo(()=>{var i;if(s.length===1)return(i=s[0].styles)==null?void 0:i.textAlign},[s]);return{handleAlignmentChange:p.useCallback(i=>{if(s.length===0)return;const c=s.map(l=>({...l,id:l.id,styles:{...l.styles,textAlign:i}}));n(c)},[s,n]),currentAlignment:o}},an=p.forwardRef((e,s)=>{const{className:n,children:o}=e;return t.jsx(ee,{ref:s,id:"ConfigurationButton",variant:"secondary",size:"icon","aria-label":"Configuration button",className:`h-6 w-6 p-0.5 rounded hover:bg-secondary/80 flex-shrink-0 flex items-center justify-center ${n||null}`,...e,children:o})});an.displayName="ConfigurationButton";function $m(e,s,n=!1){let o=null;const r=function(...a){const i=this,c=()=>{o=null,n||e.apply(i,a)},l=n&&!o;o!==null&&clearTimeout(o),o=setTimeout(c,s),l&&e.apply(i,a)};return r.cancel=()=>{o!==null&&(clearTimeout(o),o=null)},r}const zm=J.text.debounceInput,_m=e=>{const{className:s,content:n,onValueChange:o}=e,[r,a]=p.useState(n),i=p.useCallback($m(l=>{o==null||o(l)},zm),[o]),c=l=>{const d=l.target.value;a(d),i(d)};return t.jsx(nr,{id:"CanvasTextEditor",className:je("h-[90%]","bg-background",s),style:{fontSize:J.text.fontSize},value:r,onChange:c,"data-test":"canvas-text-editor-textarea"})},Ul=e=>{var u;const{className:s}=e,n=E.getState(),o=n.projectCanvas.getActive(),r=o==null?void 0:o.coreState,a=n.updateNodeSubContent,c=((r==null?void 0:r.selectedNodes)??[])[0],l=(u=c==null?void 0:c.content)==null?void 0:u.toString().slice(0,30),d=p.useCallback(h=>{c&&a(c.id,h)},[c,a]);return t.jsxs(Wc,{children:[t.jsx(_d,{asChild:!0,children:t.jsx(an,{id:"CanvasTextEditorButton",className:s,tooltip:"Open Text Editor",variant:"ghost","data-test":"canvas-text-editor-button",children:t.jsx(sh,{})})}),t.jsxs(Hc,{id:"canvas-text-editor-dialog",className:"sm:max-w-[70vw] h-[80vh] bg-secondary",style:{display:"unset"},"aria-describedby":"Text editor dialog",children:[t.jsx(Bc,{children:t.jsx(Fc,{children:l})}),t.jsx(_m,{content:c==null?void 0:c.subContent,onValueChange:d})]})]})},Vm={width:380,height:500},Um="Presets",Gm="No presets yet. Create one from current settings.";function Gl({isVisible:e,onClose:s,triggerPosition:n,renderConfigSection:o,getCurrentConfig:r,presetActions:a,onApplyPreset:i,title:c=Um,initialSize:l=Vm,emptyMessage:d=Gm,headerActions:u}){const[h,f]=p.useState(null),[g,w]=p.useState(""),[m,x]=p.useState(null),[y,v]=p.useState(!1),N=a.getAll(),b=a.getFavoriteIds(),S=a.getActiveId(),I=h?a.getById(h):null,C=m??r(),k=p.useMemo(()=>{const V=N.filter(K=>b.includes(K.id)),D=N.filter(K=>!b.includes(K.id));return[...V,...D]},[N,b]),R=p.useMemo(()=>k.map(V=>({id:V.id,label:V.name,icon:b.includes(V.id)?t.jsx(Bs,{className:"h-3 w-3 fill-yellow-400 text-yellow-400"}):void 0,data:V})),[k,b]),A=p.useCallback(V=>{x(D=>({...D??r(),...V}))},[r]),T=p.useCallback(()=>{v(!0),f(null),w("New Preset"),x(r())},[r]),O=p.useCallback(()=>{if(!g.trim()||!m)return;const V=a.create(g.trim(),m);v(!1),w(""),x(null),a.apply(V);const D=a.getById(V);D&&i&&i(D)},[g,m,a,i]),$=p.useCallback(()=>{v(!1),w(""),x(null)},[]),B=p.useCallback(V=>{f(V.id),v(!1),x(V.config)},[]),H=p.useCallback(()=>{!h||!m||(a.updateConfig(h,m),f(null),x(null))},[h,m,a]),M=p.useCallback(()=>{f(null),x(null)},[]),j=p.useCallback(V=>{const D=V.data;a.apply(D.id),i&&i(D)},[a,i]),P=p.useCallback((V,D)=>{a.rename(V,D)},[a]),W=p.useCallback(V=>{a.delete(V),h===V&&(f(null),x(null))},[a,h]),L=p.useCallback(V=>{const D=V.map(K=>K.id);a.reorder(D)},[a]),z=p.useCallback(V=>{const D=V.data;return[{id:"apply-execute",icon:t.jsx(st,{className:"h-3 w-3"}),title:"Apply & Execute",onClick:()=>{a.apply(D.id),i&&i(D)}}]},[a,i]),_=p.useCallback(V=>{const D=V.data,K=b.includes(D.id);return[{id:"toggle-favorite",label:K?"Remove from favorites":"Add to favorites",icon:t.jsx(Bs,{className:`h-4 w-4 mr-2 ${K?"fill-yellow-400 text-yellow-400":""}`}),onClick:()=>a.toggleFavorite(D.id)},{id:"rename",label:"Rename",icon:t.jsx(Ks,{className:"h-4 w-4 mr-2"}),onClick:()=>{const te=window.prompt("Rename preset:",D.name);te&&te.trim()&&te!==D.name&&a.rename(D.id,te.trim())}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>a.duplicate(D.id)},{id:"edit-settings",label:"Edit settings",icon:t.jsx(Jc,{className:"h-4 w-4 mr-2"}),onClick:()=>B(D)}]},[b,a,B]),G=y||h!==null;return t.jsx(_e,{isVisible:e,onClose:s,title:c,triggerPosition:n,initialSize:l,resizable:!0,shouldCloseManually:!0,headerActions:u,children:t.jsxs("div",{className:"flex flex-col h-full overflow-hidden","data-test":"preset-manager-popover",children:[t.jsx("div",{className:"px-3 py-2 border-b border-border","data-test":"preset-create-section",children:y?t.jsx("div",{className:"space-y-2","data-test":"preset-create-form",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx(Re,{value:g,onChange:V=>w(V.target.value),placeholder:"Preset name",className:"flex-1 h-8 text-sm",autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(ee,{size:"sm",onClick:O,disabled:!g.trim(),"data-test":"preset-save-button",children:"Save"}),t.jsx(ee,{size:"sm",variant:"ghost",onClick:$,"data-test":"preset-cancel-button",children:"Cancel"})]})}):I?t.jsx("div",{className:"space-y-2","data-test":"preset-edit-form",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-sm font-medium truncate",children:["Editing: ",I.name]}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx(ee,{size:"sm",onClick:H,"data-test":"preset-update-button",children:"Update"}),t.jsx(ee,{size:"sm",variant:"ghost",onClick:M,"data-test":"preset-cancel-edit-button",children:"Cancel"})]})]})}):t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:T,"data-test":"preset-create-button",children:[t.jsx(yt,{className:"h-4 w-4 mr-2"}),"New from current settings"]})}),G&&t.jsx("div",{className:"px-3 py-2 border-b border-border overflow-auto max-h-[75%] shrink-0","data-test":"preset-config-section",children:o({currentConfig:C,onConfigChange:A,isEditingPreset:h!==null,editingPresetName:I==null?void 0:I.name})}),t.jsx("div",{className:"flex-1 overflow-auto px-1 py-2","data-test":"preset-list-section",children:R.length===0?t.jsx("div",{className:"text-center text-muted-foreground text-sm py-8 px-4","data-test":"preset-empty-message",children:d}):t.jsx(qs,{data:R,selectedId:S,onItemClick:j,onUpdate:P,onDelete:W,onReorder:L,quickActions:z,moreOptionsItems:_,dropdownZIndex:Ee.draggablePopoverDropdown,enableEdit:!1,enableDelete:!0,enableDrag:!0,deleteConfirmMessage:V=>`Delete preset "${V.label}"? This cannot be undone.`})})]})})}const{animation:Mi}=J,Ym=(e=!1,s=!0,n=!1,o=20)=>{const{fitAndRepositionNodes:r}=on(),a=p.useCallback(g=>{const w=E.getState(),m=w.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],y=w.addNode,v=w.deleteSelectedNodes,N=w.setSelectedNodes,b=w.updateNodes,S=w.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const I=x[0];if(!I.content||typeof I.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}const C=g==="paragraph"?/(\n\n)/:g==="line"?/(\n)/:g==="comma"?/(,)/:g==="period"?/(\.)/:g==="whitespace"?/(\s+)/:new RegExp(`([${Ne.CUSTOM_CHARACTERS.join("")}])`),k=I.content.split(C),R=[];for(let P=0;P<k.length;P+=2){const W=k[P],L=k[P+1];(W||L)&&R.push(s?(W||"")+(L||""):W||"")}if(R.length===0){console.warn("useNodeSplitter: No segments found after split.");return}if(R.length===1&&R[0]===I.content){console.warn(`useNodeSplitter: No ${g==="paragraph"?"double newline":g==="line"?"single newline":g==="comma"?"comma":g==="period"?"period":g==="whitespace"?"whitespace":"custom character"} found to split content. Original node not modified.`);return}const A=I.x,T=I.y;I.width;const O=I.id;e||v();let $=n?A:T,B=0;const H=[],M=new Map;let j=n?A:T;R.forEach((P,W)=>{const L=g==="comma"||g==="paragraph"||g==="period"||g==="custom"||g==="whitespace"?P.trim():P;if((g==="paragraph"||g==="comma"||g==="period"||g==="custom"||g==="whitespace")&&L===""&&R.length>1)return;const z=Math.min(ys(L),J.nodeOptions.maxNodeWidth)+vs.textNodeXPadding,_=ht(L,z,I);let G,V;if(n?(V=T,W===0?G=A:G=$+B+o):(G=A,W===0?V=T:V=$+B+o),e&&W===0){b([{id:O,content:L,width:z,height:_}]),$=n?G:V,B=n?z:_,j=(n?G+z:V+_)+o;return}const D=O+"-split-"+W,K=Le.buildTextNodeV2({...I,id:D,title:"",x:A,y:T,width:z,height:_,content:L});M.set(D,{x:G,y:V}),y(K),H.push(K),e&&S({id:Pe(10),startNodeId:O,endNodeId:K.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),$=n?G:V,B=n?z:_}),H.length>0&&(N(H),setTimeout(()=>{const W=E.getState().updateNodes,L=[];M.forEach((z,_)=>{L.push({id:_,x:z.x,y:z.y})}),L.length>0&&W(L),n||r(H,j,o)},Mi.splitDelayMs))},[r,e,s,n,o]),i=p.useCallback(()=>{a("paragraph")},[a]),c=p.useCallback(()=>{a("line")},[a]),l=p.useCallback(()=>{a("comma")},[a]),d=p.useCallback(()=>{a("period")},[a]),u=p.useCallback(()=>{a("custom")},[a]),h=p.useCallback(()=>{a("whitespace")},[a]),f=p.useCallback(g=>{const w=E.getState(),m=w.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],y=w.addNode,v=w.deleteSelectedNodes,N=w.setSelectedNodes,b=w.updateNodes,S=w.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const I=x[0];if(!I.content||typeof I.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}let C;try{C=new RegExp(`(${g})`,"g")}catch(P){console.error("useNodeSplitter: Invalid regex pattern",P);return}const k=I.content.split(C),R=[];for(let P=0;P<k.length;P+=2){const W=k[P]||"",L=k[P+1]||"",z=s?(W+L).trim():W.trim();z&&R.push(z)}if(R.length===0){console.warn("useNodeSplitter: No segments found with regex pattern.");return}if(R.length===1&&R[0]===I.content.trim()){console.warn("useNodeSplitter: Regex pattern did not match content.");return}const A=I.x,T=I.y,O=I.id;e||v();let $=n?A:T,B=0;const H=[],M=new Map;let j=n?A:T;R.forEach((P,W)=>{if(P==="")return;const L=Math.min(ys(P),J.nodeOptions.maxNodeWidth)+vs.textNodeXPadding,z=ht(P,L,I);let _,G;if(n?(G=T,W===0?_=A:_=$+B+o):(_=A,W===0?G=T:G=$+B+o),e&&W===0){b([{id:O,content:P,width:L,height:z}]),$=n?_:G,B=n?L:z,j=(n?_+L:G+z)+o;return}const V=O+"-split-"+W,D=Le.buildTextNodeV2({...I,id:V,title:"",x:A,y:T,width:L,height:z,content:P});M.set(V,{x:_,y:G}),y(D),H.push(D),e&&S({id:Pe(10),startNodeId:O,endNodeId:D.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),$=n?_:G,B=n?L:z}),H.length>0&&(N(H),setTimeout(()=>{const W=E.getState().updateNodes,L=[];M.forEach((z,_)=>{L.push({id:_,x:z.x,y:z.y})}),L.length>0&&W(L),n||r(H,j,o)},Mi.splitDelayMs))},[e,s,n,o,r]);return{splitNodeContentByParagraph:i,splitNodeContentByLine:c,splitNodeContentByComma:l,splitNodeContentByPeriod:d,splitNodeContentByCustomCharacter:u,splitNodeContentByWhitespace:h,splitNodeContentByRegex:f}};function Km(e){return!e||e.trim()===""?0:e.trim().split(/\s+/).filter(s=>s.length>0).length}const Xm=[".","!","?",":",";"],qm=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","Ph.D","M.D","B.A","M.A","B.S","M.S","Inc","Ltd","Co","Corp","etc","vs","e.g","i.e","a.m","p.m","St","Ave","Blvd","Rd","vol","no"];function Zm(e,s){if(s<=0||s>=e.length-1)return!1;let n=s-1;for(;n>=0&&/[a-zA-Z.]/.test(e[n]);)n--;n++;const o=e.substring(n,s);return!!(qm.includes(o)||o.length===1&&/[A-Z]/.test(o)||s>1&&e[s-2]===".")}function Jm(e,s){const n=[".","!","?",","];let o=e.length;for(const r of n){const a=e.indexOf(r,s);a!==-1&&a<o&&(o=a)}return o}function Qm(e,s){const n=[];for(let r=0;r<e.length;r++)e[r]===","&&n.push(r);const o=[];for(let r=0;r<n.length;r++){const a=n[r],i=Jm(e,a+1),c=e.substring(a+1,i).trim();Km(c)>=s&&o.push(a)}return o}function Pi(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(Xm.includes(o)){if(o==="."&&Zm(e,n)){s+=o,n++;continue}for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}function Di(e,s=3){if(!e)return e;const n=Qm(e,s);if(n.length===0)return e;let o=e;for(let r=n.length-1;r>=0;r--){const a=n[r];let i=a+1;for(;i<o.length&&o[i]===" ";)i++;o=o.substring(0,a+1)+`
`+o.substring(i)}return o}const ex=["&",";","-",":"];function Oi(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(ex.includes(o)){for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}const tx=()=>{const e=p.useCallback((a,i=3)=>{const c=E.getState(),l=c.projectCanvas.getActive(),d=(l==null?void 0:l.coreState.selectedNodes)??[],u=c.updateNodeContent;if(d.length===0){console.warn("useNodeInsideSplitter: No nodes selected.");return}d.forEach(h=>{if(!h.content||typeof h.content!="string"){console.warn(`useNodeInsideSplitter: Node ${h.id} has no content to split.`);return}let f;if(a==="sentence")f=Pi(h.content);else if(a==="smartComma")f=Di(h.content,i);else if(a==="smartCharacter")f=Oi(h.content);else if(a==="all")f=Pi(h.content),f=Di(f,i),f=Oi(f);else{console.warn(`useNodeInsideSplitter: Unknown mode "${a}"`);return}if(f===h.content){console.warn(`useNodeInsideSplitter: No ${a==="sentence"?"sentence endings":"qualifying commas"} found in node ${h.id}. Content not modified.`);return}u(h.id,f);const g=c.getSegmentedButtonAction("canvas-fit-width");let w=null;if(g){const v=g.match(/Set width to (\d+)px/);v&&(w=parseInt(v[1],10))}let m,x,y;if(w)x=ht(f,w,h),m=w,y=!0;else{let v;const N=document.querySelector("textarea[data-node-textarea]");if(N){const I=window.getComputedStyle(N).lineHeight;if(I&&I!=="normal"){const C=parseFloat(I);isNaN(C)||(v=C)}}const b=bs(f,v,h);m=b.width,x=b.height,y=!1}c.updateNode(h.id,{content:f,width:m,height:x,options:{...h.options,lockSize:y}})})},[]),s=p.useCallback(()=>{e("sentence")},[e]),n=p.useCallback((a=3)=>{e("smartComma",a)},[e]),o=p.useCallback(()=>{e("smartCharacter")},[e]),r=p.useCallback((a=3)=>{e("all",a)},[e]);return{splitInsideBySentence:s,splitInsideBySmartComma:n,splitInsideBySmartCharacter:o,splitInsideByAll:r}};function sx({action:e,mode:s,isSelected:n,onSelect:o,onSplitRegex:r,selectedNodeContent:a}){const[i,c]=p.useState(""),[l,d]=p.useState([]),u=s==="record",h=g=>{if(c(g),g&&a)try{const w=new RegExp(g,"g"),m=a.match(w)||[];d(m.slice(0,3))}catch{d([])}else d([])},f=()=>{i&&(u?o(e.id,{pattern:i}):r(i))};return t.jsxs("div",{"data-test":"regex-action-section",children:[t.jsx("div",{className:ve("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",u&&n&&"bg-primary/10 border border-primary",!u&&"hover:bg-accent"),"data-test":"regex-action-row",children:t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]})}),t.jsxs("div",{className:"px-3 py-1.5 space-y-1","data-test":"regex-input-section",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Re,{type:"text",value:i,onChange:g=>h(g.target.value),placeholder:"Enter regex pattern...",className:"h-6 text-xs flex-1",onClick:g=>g.stopPropagation(),"data-test":"regex-pattern-input"}),t.jsx(ee,{size:"sm",variant:"secondary",className:"h-6 text-xs px-2",onClick:g=>{g.stopPropagation(),f()},disabled:!i,"data-test":"regex-split-button",children:"Split"})]}),l.length>0&&t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:["Matches: ",l.map(g=>`"${g}"`).join(", "),l.length===3&&"..."]})]})]})}function nx({action:e,mode:s,isSelected:n,onSelect:o,onSplitSmartComma:r}){const[a,i]=p.useState(3),c=s==="record",l=()=>{c?o(e.id,{minWords:a}):r(a)};return t.jsxs("div",{"data-test":"smart-comma-action-section",className:"px-3 py-1.5",children:[t.jsxs("div",{className:ve("flex items-center gap-2 text-sm",c&&n&&"text-primary"),"data-test":"smart-comma-action-row",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 mt-1",onPointerDown:d=>d.stopPropagation(),children:[t.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Min words:"}),t.jsx(Re,{type:"number",min:"1",max:"20",value:a,onChange:d=>i(Math.max(1,parseInt(d.target.value)||3)),className:"h-5 w-10 text-xs px-1",onClick:d=>d.stopPropagation(),"data-test":"smart-comma-min-words-input"}),t.jsx(ee,{size:"sm",variant:"secondary",className:"h-5 text-[10px] px-2",onClick:d=>{d.stopPropagation(),l()},"data-test":"smart-comma-split-button",children:"Split"})]})]})}class ox{constructor(s,n,o=""){Fe(this,"namespace","canvas.split");this.hooks=s,this.storeActions=n,this.selectedNodeContent=o}getActions(){return[{id:"byParagraph",label:"Paragraph",category:"Node Split",icon:t.jsx(nh,{className:"h-3.5 w-3.5"})},{id:"byLine",label:"Line",category:"Node Split",icon:t.jsx(cr,{className:"h-3.5 w-3.5"})},{id:"byComma",label:"Comma",category:"Node Split",icon:t.jsx(oh,{className:"h-3.5 w-3.5"})},{id:"byPeriod",label:"Period",category:"Node Split",icon:t.jsx(ah,{className:"h-3.5 w-3.5"})},{id:"bySpecial",label:"Special",category:"Node Split",icon:t.jsx(Pn,{className:"h-3.5 w-3.5"})},{id:"byWhitespace",label:"Whitespace",category:"Node Split",icon:t.jsx(rh,{className:"h-3.5 w-3.5"})},{id:"byRegex",label:"Regex",category:"Node Split",icon:t.jsx(ih,{className:"h-3.5 w-3.5"}),params:[{name:"pattern",type:"string",label:"Regex Pattern",default:""}],customRender:s=>t.jsx(sx,{...s,onSplitRegex:this.hooks.splitByRegex,selectedNodeContent:this.selectedNodeContent})},{id:"textBySentence",label:"Sentence",category:"Text Split",icon:t.jsx(ch,{className:"h-3.5 w-3.5"})},{id:"textBySmartComma",label:"Smart Comma",category:"Text Split",icon:t.jsx(lh,{className:"h-3.5 w-3.5"}),params:[{name:"minWords",type:"number",label:"Minimum Words",default:3}],customRender:s=>t.jsx(nx,{...s,onSplitSmartComma:this.hooks.textSplitBySmartComma})},{id:"textBySmartChar",label:"Smart Char",category:"Text Split",icon:t.jsx(dh,{className:"h-3.5 w-3.5"})},{id:"textByAll",label:"All",category:"Text Split",icon:t.jsx(sn,{className:"h-3.5 w-3.5"})}]}getConfig(){return{keepArrows:this.storeActions.getKeepArrows(),keepMatch:this.storeActions.getKeepMatch(),horizontal:this.storeActions.getHorizontal(),gap:this.storeActions.getGap()}}setConfig(s){s.keepArrows!==void 0&&this.storeActions.setKeepArrows(s.keepArrows),s.keepMatch!==void 0&&this.storeActions.setKeepMatch(s.keepMatch),s.horizontal!==void 0&&this.storeActions.setHorizontal(s.horizontal),s.gap!==void 0&&this.storeActions.setGap(s.gap)}execute(s,n){switch(s){case"byParagraph":this.hooks.splitByParagraph();break;case"byLine":this.hooks.splitByLine();break;case"byComma":this.hooks.splitByComma();break;case"byPeriod":this.hooks.splitByPeriod();break;case"byWhitespace":this.hooks.splitByWhitespace();break;case"bySpecial":this.hooks.splitBySpecial();break;case"byRegex":n!=null&&n.pattern&&this.hooks.splitByRegex(n.pattern);break;case"textBySentence":this.hooks.textSplitBySentence();break;case"textBySmartComma":this.hooks.textSplitBySmartComma((n==null?void 0:n.minWords)??3);break;case"textBySmartChar":this.hooks.textSplitBySmartChar();break;case"textByAll":this.hooks.textSplitByAll(3);break;default:console.warn(`Unknown split action: ${s}`)}}}class ax{constructor(){Fe(this,"sources",new Map)}register(s,n){this.sources.set(s,n)}unregister(s){this.sources.delete(s)}has(s){return this.sources.has(s)}getAllActions(){return Array.from(this.sources.values()).map(s=>({source:s.name,actions:s.getActions()}))}get size(){return this.sources.size}getKeys(){return Array.from(this.sources.keys())}}const it=new ax;function Yl(){const e=F(y=>{var v;return((v=y.preferences)==null?void 0:v.keepArrowsOnSplit)??!1}),s=F(y=>{var v;return((v=y.preferences)==null?void 0:v.keepSplitMatch)??!1}),n=F(y=>{var v;return((v=y.preferences)==null?void 0:v.splitHorizontally)??!1}),o=F(y=>{var v;return((v=y.preferences)==null?void 0:v.splitNodeGap)??15}),r=F(y=>y.setKeepArrowsOnSplit),a=F(y=>y.setKeepSplitMatch),i=F(y=>y.setSplitHorizontally),c=F(y=>y.setSplitNodeGap),l=Ym(e,s,n,o),d=tx(),h=E.getState().projectCanvas.getActive(),f=(h==null?void 0:h.coreState.selectedNodes)??[],g=f.length===1&&typeof f[0].content=="string"?f[0].content:"",w=p.useMemo(()=>({splitByParagraph:l.splitNodeContentByParagraph,splitByLine:l.splitNodeContentByLine,splitByComma:l.splitNodeContentByComma,splitByPeriod:l.splitNodeContentByPeriod,splitByWhitespace:l.splitNodeContentByWhitespace,splitBySpecial:l.splitNodeContentByCustomCharacter,splitByRegex:l.splitNodeContentByRegex,textSplitBySentence:d.splitInsideBySentence,textSplitBySmartComma:d.splitInsideBySmartComma,textSplitBySmartChar:d.splitInsideBySmartCharacter,textSplitByAll:d.splitInsideByAll}),[l.splitNodeContentByParagraph,l.splitNodeContentByLine,l.splitNodeContentByComma,l.splitNodeContentByPeriod,l.splitNodeContentByWhitespace,l.splitNodeContentByCustomCharacter,l.splitNodeContentByRegex,d.splitInsideBySentence,d.splitInsideBySmartComma,d.splitInsideBySmartCharacter,d.splitInsideByAll]),m=p.useMemo(()=>({getKeepArrows:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.keepArrowsOnSplit)??!1},setKeepArrows:r,getKeepMatch:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.keepSplitMatch)??!1},setKeepMatch:a,getHorizontal:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.splitHorizontally)??!1},setHorizontal:i,getGap:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.splitNodeGap)??15},setGap:c}),[r,a,i,c]),x=p.useMemo(()=>new ox(w,m,g),[w,m,g]);return p.useEffect(()=>(it.register("split",{name:"Split",getActions:()=>x.getActions()}),rt.register("split",x),()=>{it.unregister("split"),rt.unregister("split")}),[x]),x}function rx({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a}){const i=s==="record",c=e.subActions&&e.subActions.length>0;return t.jsxs("div",{className:ve("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",i&&n&&"bg-primary/10 border border-primary",!i&&"hover:bg-accent"),"data-test":"toolbar-action-row",children:[t.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>o(e.id),"data-test":"toolbar-action-button",children:[e.icon,t.jsx("span",{children:e.label})]}),c&&t.jsx("div",{className:"flex items-center gap-0.5 ml-2",children:e.subActions.map(l=>t.jsx(ee,{variant:"outline",size:"icon",className:ve("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",i&&n&&l.id===e.id&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),o(l.id)},title:l.title,"data-test":"toolbar-sub-action",children:l.icon},l.id))})]})}function zo({facade:e,mode:s,selectedActionId:n,selectedActionParams:o,onActionSelect:r,onActionExecuted:a,showConfig:i=!1,configOverride:c,onConfigChange:l,categories:d,className:u}){const h=e.getActions(),f=d?h.filter(N=>d.includes(N.category||"Other")):h,g=e.getConfig(),w=c??g,m=(N,b)=>{var S,I;if(s==="execute"){if(e.execute(N,b),a){const C=f.find(R=>{var A;return R.id===N||((A=R.subActions)==null?void 0:A.some(T=>T.id===N))}),k=((I=(S=C==null?void 0:C.subActions)==null?void 0:S.find(R=>R.id===N))==null?void 0:I.title)??(C==null?void 0:C.label)??N;a(k,()=>e.execute(N,b))}}else r==null||r(N,b)},x=N=>{l?l(N):e.setConfig(N)},y=f.reduce((N,b)=>{const S=b.category||"Other";return N[S]||(N[S]=[]),N[S].push(b),N},{}),v=Object.keys(y);return t.jsx("div",{className:ve("flex flex-col",u),"data-test":"toolbar-actions-panel",children:v.map((N,b)=>t.jsxs("div",{"data-test":"action-category",children:[b>0&&t.jsx("div",{className:"h-px bg-border my-1"}),v.length>1&&t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:N}),y[N].map(S=>{var C;const I=n===S.id||(((C=S.subActions)==null?void 0:C.some(k=>k.id===n))??!1);return S.customRender?t.jsx(Ie.Fragment,{children:S.customRender({action:S,mode:s,isSelected:I,onSelect:m,config:w,onConfigChange:x})},S.id):t.jsx(rx,{action:S,mode:s,isSelected:I,onSelect:m,config:w,onConfigChange:x},S.id)})]},N))})}const ix=[],cx=[];function lx({currentConfig:e,onConfigChange:s,facade:n,onExecuteSplit:o,canExecute:r}){const a=p.useCallback((l,d)=>{const h={byParagraph:"paragraph",byLine:"line",byComma:"comma",byPeriod:"period",bySpecial:"custom",byWhitespace:"whitespace",byRegex:"regex"}[l];h&&(s({splitMode:h}),d!=null&&d.pattern&&s({regexPattern:d.pattern}))},[s]),i=p.useMemo(()=>({keepArrows:e.keepArrowsOnSplit,keepMatch:e.keepSplitMatch,horizontal:e.splitHorizontally,gap:e.splitNodeGap}),[e]),c={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex"};return t.jsxs("div",{className:"space-y-2","data-test":"split-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"split-action-selector",children:t.jsx(zo,{facade:n,mode:"record",selectedActionId:c[e.splitMode],onActionSelect:a,configOverride:i,onConfigChange:l=>{l.keepArrows!==void 0&&s({keepArrowsOnSplit:l.keepArrows}),l.keepMatch!==void 0&&s({keepSplitMatch:l.keepMatch}),l.horizontal!==void 0&&s({splitHorizontally:l.horizontal}),l.gap!==void 0&&s({splitNodeGap:l.gap})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepArrowsOnSplit,onChange:l=>s({keepArrowsOnSplit:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Arrows"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepSplitMatch,onChange:l=>s({keepSplitMatch:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Match"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.splitHorizontally,onChange:l=>s({splitHorizontally:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Horiz"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"100",value:e.splitNodeGap,onChange:l=>s({splitNodeGap:Math.max(0,parseInt(l.target.value)||15)}),className:"h-5 w-12 text-[10px] px-1","data-test":"split-config-gap"})]})]}),t.jsxs(ee,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(c[e.splitMode]),disabled:!r,"data-test":"split-execute-button",children:[t.jsx(st,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function dx({isVisible:e,onClose:s,triggerPosition:n,currentSplitMode:o,currentRegexPattern:r,onSplitAction:a}){const i=Yl(),c=p.useCallback(M=>{var j,P;return((P=(j=M.preferences)==null?void 0:j.splitPresets)==null?void 0:P.presets)??ix},[]),l=F(c),d=F(M=>{var j,P;return((P=(j=M.preferences)==null?void 0:j.splitPresets)==null?void 0:P.favoriteIds)??cx}),u=F(M=>{var j,P;return((P=(j=M.preferences)==null?void 0:j.splitPresets)==null?void 0:P.activePresetId)??null}),h=F(M=>{var j;return((j=M.preferences)==null?void 0:j.keepArrowsOnSplit)??!1}),f=F(M=>{var j;return((j=M.preferences)==null?void 0:j.keepSplitMatch)??!1}),g=F(M=>{var j;return((j=M.preferences)==null?void 0:j.splitHorizontally)??!1}),w=F(M=>{var j;return((j=M.preferences)==null?void 0:j.splitNodeGap)??15}),m=F(M=>M.setKeepArrowsOnSplit),x=F(M=>M.setKeepSplitMatch),y=F(M=>M.setSplitHorizontally),v=F(M=>M.setSplitNodeGap),N=F(M=>M.createSplitPreset),b=F(M=>M.updateSplitPreset),S=F(M=>M.duplicateSplitPreset),I=F(M=>M.deleteSplitPreset),C=F(M=>M.renameSplitPreset),k=F(M=>M.applySplitPreset),R=F(M=>M.toggleSplitPresetFavorite),A=F(M=>M.setActiveSplitPresetId),T=p.useMemo(()=>({getAll:()=>l,getById:M=>l.find(j=>j.id===M),getFavorites:()=>l.filter(M=>d.includes(M.id)),getFavoriteIds:()=>d,getActiveId:()=>u,create:(M,j)=>N(M,j),update:(M,j)=>{b(M,j)},updateConfig:(M,j)=>{const P=l.find(W=>W.id===M);P&&b(M,{config:{...P.config,...j}})},duplicate:M=>S(M),delete:M=>{I(M)},rename:(M,j)=>{C(M,j)},reorder:M=>{},apply:M=>{k(M)},setActive:M=>{A(M)},toggleFavorite:M=>{R(M)},isFavorite:M=>d.includes(M)}),[l,d,u,N,b,S,I,C,k,A,R]),O=p.useCallback(()=>({splitMode:o,regexPattern:o==="regex"?r:void 0,keepArrowsOnSplit:h,keepSplitMatch:f,splitHorizontally:g,splitNodeGap:w}),[o,r,h,f,g,w]),$=p.useCallback(M=>{a&&(a(M),be.success("Executed split action"))},[a]),B=p.useCallback(M=>{a?(requestAnimationFrame(()=>{a(M.config.splitMode)}),be.success(`Applied and executed "${M.name}" (${M.config.splitMode})`)):be.success(`Applied preset "${M.name}" settings`)},[a]),H=p.useCallback(M=>{const j=P=>{M.onConfigChange(P),P.keepArrowsOnSplit!==void 0&&m(P.keepArrowsOnSplit),P.keepSplitMatch!==void 0&&x(P.keepSplitMatch),P.splitHorizontally!==void 0&&y(P.splitHorizontally),P.splitNodeGap!==void 0&&v(P.splitNodeGap)};return t.jsx(lx,{...M,onConfigChange:j,facade:i,onExecuteSplit:$,canExecute:!!a})},[i,$,a,m,x,y,v]);return t.jsx(Gl,{isVisible:e,onClose:s,triggerPosition:n,title:"Split Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:H,getCurrentConfig:O,presetActions:T,onApplyPreset:B})}const Li="canvas-split-regex-history",Wi="canvas-split-before-enabled",ux=10,hx=({onSplit:e,selectedNodeContent:s=""})=>{const n=p.useCallback(()=>{try{const m=localStorage.getItem(Li);return m?JSON.parse(m):[]}catch{return[]}},[]),[o,r]=p.useState(()=>n()[0]||""),[a,i]=p.useState(()=>{try{return localStorage.getItem(Wi)==="true"}catch{return!1}}),[c,l]=p.useState(null),[d,u]=p.useState(0);p.useEffect(()=>{try{localStorage.setItem(Wi,String(a))}catch(m){console.warn("Failed to save split before preference",m)}},[a]);const h=p.useCallback((m,x)=>m?x?`\\n(?=${m})`:m:"",[]),f=p.useCallback(m=>{if(!m)return;const y=n().filter(N=>N!==m),v=[m,...y].slice(0,ux);try{localStorage.setItem(Li,JSON.stringify(v))}catch(N){console.warn("Failed to save regex history",N)}},[n]);p.useEffect(()=>{if(!o){l(null),u(0);return}try{const m=h(o,a),x=new RegExp(`(${m})`,"g");if(l(!0),s){const y=s.match(x);u(y?y.length:0)}else u(0)}catch{l(!1),u(0)}},[o,s,a,h]);const g=p.useCallback(()=>{if(!o||!c)return;f(o);const m=h(o,a);e(m)},[o,c,e,f,a,h]),w=p.useCallback(m=>{m.key==="Enter"&&(m.preventDefault(),m.stopPropagation(),g())},[g]);return t.jsxs("div",{className:"regex-split-item px-1 py-1 space-y-0.5",onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsx("span",{className:"text-xs text-foreground",children:"Regex"}),t.jsx("button",{onPointerDown:m=>{m.stopPropagation(),g()},disabled:!c,className:ve("p-0.5 rounded transition-colors",c?"hover:bg-accent text-accent-foreground cursor-pointer":"opacity-50 cursor-not-allowed"),title:"Execute split",style:{touchAction:"none"},"data-test":"regex-split-execute-button",children:t.jsx(st,{className:"h-2.5 w-2.5"})})]}),t.jsxs("div",{className:"relative px-1",children:[t.jsx("input",{type:"text",value:o,onChange:m=>r(m.target.value),onKeyDown:w,placeholder:"Art \\d+",className:ve("w-full px-1.5 py-0.5 text-[10px] border rounded h-5","bg-background text-foreground","focus:outline-none focus:ring-1 focus:ring-primary",c===!1&&"border-destructive focus:ring-destructive",c===!0&&"border-green-500 focus:ring-green-500"),onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"auto"},"data-test":"regex-split-pattern-input"}),t.jsxs("div",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none",children:[c===!0&&t.jsx(Ys,{className:"h-2 w-2 text-green-500"}),c===!1&&t.jsx(jo,{className:"h-2 w-2 text-destructive"})]})]}),t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsxs("label",{className:"flex items-center gap-1 text-[9px] cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:m=>i(m.target.checked),className:"w-2 h-2 cursor-pointer",onPointerDown:m=>{m.stopPropagation()},"data-test":"regex-split-before-checkbox"}),t.jsx("span",{className:"text-muted-foreground",children:"Before"})]}),c&&d>0&&t.jsx("span",{className:"text-[9px] text-muted-foreground",children:d}),c===!1&&o&&t.jsx("span",{className:"text-[9px] text-destructive",children:"!"})]})]})},px=[],gx=[],fx=e=>{const{className:s}=e,n=Yl(),o=F(j=>{var P;return((P=j.preferences)==null?void 0:P.keepArrowsOnSplit)??!1}),r=F(j=>j.setKeepArrowsOnSplit),a=F(j=>{var P;return((P=j.preferences)==null?void 0:P.keepSplitMatch)??!1}),i=F(j=>j.setKeepSplitMatch),c=F(j=>{var P;return((P=j.preferences)==null?void 0:P.splitHorizontally)??!1}),l=F(j=>j.setSplitHorizontally),d=F(j=>{var P;return((P=j.preferences)==null?void 0:P.splitNodeGap)??15}),u=F(j=>j.setSplitNodeGap),h=F(j=>{var P,W;return((W=(P=j.preferences)==null?void 0:P.splitPresets)==null?void 0:W.presets)??px}),f=F(j=>{var P,W;return((W=(P=j.preferences)==null?void 0:P.splitPresets)==null?void 0:W.favoriteIds)??gx}),g=F(j=>j.applySplitPreset),w=p.useMemo(()=>h.filter(j=>f.includes(j.id)),[h,f]),[m,x]=p.useState(!1),[y,v]=p.useState(),N=p.useRef(null),b=p.useCallback(()=>{if(N.current){const j=N.current.getBoundingClientRect();v({x:j.left,y:j.bottom+4})}x(!0)},[]),S=p.useCallback(()=>{x(!1)},[]),I=p.useCallback(j=>{const W={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex","text:sentence":"textBySentence","text:smartComma":"textBySmartComma","text:smartChar":"textBySmartChar","text:all":"textByAll"}[j]||j;n.execute(W)},[n]),C=p.useCallback(j=>{const P=h.find(W=>W.name===j);return P?()=>{g(P.id),I(P.config.splitMode)}:null},[h,g,I]),R=E.getState().projectCanvas.getActive(),A=(R==null?void 0:R.coreState.selectedNodes)??[],T=A.length===1&&typeof A[0].content=="string"?A[0].content:"",O=n.getActions(),$=O.filter(j=>j.category==="Node Split"&&j.id!=="byRegex"),B=O.filter(j=>j.category==="Text Split"),H=[{header:"Node",width:"150px",actions:[...$.map(j=>({label:j.label,icon:j.icon,onClick:()=>n.execute(j.id)})),{label:"Regex",customRender:()=>t.jsx(hx,{onSplit:j=>n.execute("byRegex",{pattern:j}),selectedNodeContent:T})}]},{header:"Text",width:"150px",actions:B.map(j=>j.customRender?{label:j.label,customRender:()=>j.customRender({action:j,mode:"execute",isSelected:!1,onSelect:(P,W)=>n.execute(P,W),config:{},onConfigChange:()=>{}})}:{label:j.label,icon:j.icon,onClick:()=>n.execute(j.id)})},{header:"Config",width:"150px",actions:[{label:"Presets",customRender:({registerRepeatAction:j})=>t.jsxs("div",{"data-test":"split-presets-section",className:"mt-1 pt-1",children:[t.jsxs("button",{ref:N,className:"flex items-center gap-2 w-full px-1 py-1 text-sm rounded-sm hover:bg-accent text-left",onClick:b,"data-test":"split-presets-button",children:[t.jsx(lr,{className:"h-3 w-3"}),t.jsx("span",{className:"text-xs",children:"Presets"})]}),w.length>0&&t.jsxs("div",{className:"px-1 py-1","data-test":"split-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"split-favorite-presets-grid",children:w.map(P=>t.jsxs(ee,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:W=>{W.stopPropagation(),g(P.id),I(P.config.splitMode),j(P.name,()=>{g(P.id),I(P.config.splitMode)})},title:`Apply & Execute: ${P.name}`,"data-test":"split-favorite-preset-button",children:[t.jsx(st,{className:"h-2 w-2 mr-1"}),P.name]},P.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},{label:"Keep arrows",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:j=>r(j.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-[10px]",children:"Keep arrows"})]})},{label:"Keep match",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:j=>i(j.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-[10px]",children:"Keep match"})]})},{label:"Horizontal",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:j=>l(j.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-[10px]",children:"Horizontal"})]})},{label:"Gap",customRender:()=>t.jsxs("div",{className:"flex items-center gap-1 px-1 py-0.5",children:[t.jsx("span",{className:"text-[10px]",children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"100",value:d,onChange:j=>u(Math.max(0,parseInt(j.target.value)||15)),className:"h-5 w-12 text-[10px] px-1",onClick:j=>j.stopPropagation(),"data-test":"split-config-gap"}),t.jsx("span",{className:"text-[10px]",children:"px"})]})}]}],M={label:"Split",icon:t.jsx(uh,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("byParagraph")};return t.jsxs(t.Fragment,{children:[t.jsx("div",{id:"CanvasTextSplitButtonContainer",className:ve("flex items-center",s),"data-test":"toolbar-split-button",children:t.jsx(Ze,{mainAction:M,dropdownColumns:H,variant:"outline",size:"compact",persistenceKey:"toolbar-split-button",facade:n,restoreRepeatAction:C,"data-test":"canvas-split-nodes-button"})}),t.jsx(dx,{isVisible:m,onClose:S,triggerPosition:y,currentSplitMode:"paragraph",onSplitAction:I})]})};class mx{constructor(s,n){Fe(this,"namespace","canvas.textFormatting");this.hooks=s,this.storeActions=n}getActions(){return[{id:"style:bold",label:"Bold",category:"Style",icon:t.jsx(Qc,{className:"h-3 w-3"})},{id:"style:italic",label:"Italic",category:"Style",icon:t.jsx(el,{className:"h-3 w-3"})},{id:"style:strikethrough",label:"Strikethrough",category:"Style",icon:t.jsx(tl,{className:"h-3 w-3"})},{id:"heading:h1",label:"Heading 1",category:"Headings",icon:t.jsx(sl,{className:"h-3 w-3"})},{id:"heading:h2",label:"Heading 2",category:"Headings",icon:t.jsx(nl,{className:"h-3 w-3"})},{id:"heading:h3",label:"Heading 3",category:"Headings",icon:t.jsx(ol,{className:"h-3 w-3"})},{id:"list:bullet",label:"Bullet list",category:"Lists",icon:t.jsx(dr,{className:"h-3 w-3"})},{id:"list:numbered",label:"Numbered list",category:"Lists",icon:t.jsx(Dn,{className:"h-3 w-3"})},{id:"list:indent",label:"Indent",category:"Lists",icon:t.jsx(al,{className:"h-3 w-3"})},{id:"list:outdent",label:"Outdent",category:"Lists",icon:t.jsx(rl,{className:"h-3 w-3"})}]}getConfig(){return{firstLineOnly:this.storeActions.getFirstLineOnly()}}setConfig(s){s.firstLineOnly!==void 0&&this.storeActions.setFirstLineOnly(s.firstLineOnly)}execute(s,n){switch(s){case"style:bold":this.hooks.applyBold();break;case"style:italic":this.hooks.applyItalic();break;case"style:strikethrough":this.hooks.applyStrikethrough();break;case"heading:h1":this.hooks.applyH1();break;case"heading:h2":this.hooks.applyH2();break;case"heading:h3":this.hooks.applyH3();break;case"list:bullet":this.hooks.applyUnorderedList();break;case"list:numbered":this.hooks.applyOrderedList();break;case"list:indent":this.hooks.applyIndent();break;case"list:outdent":this.hooks.applyOutdent();break;case"style:fontSize:small":this.hooks.applyFontSize("small");break;case"style:fontSize:normal":this.hooks.applyFontSize("normal");break;case"style:fontSize:large":this.hooks.applyFontSize("large");break;case"style:fontSize:xlarge":this.hooks.applyFontSize("xlarge");break;default:console.warn(`TextFormattingFacade: Unknown action "${s}"`)}}}function ka(e,s,n,o,r){const a=e.substring(0,s),i=e.substring(s,n),c=e.substring(n),l=o.length,d=r.length;return s>=l&&a.endsWith(o)&&c.startsWith(r)?{newText:a.substring(0,a.length-l)+i+c.substring(d),newStart:s-l,newEnd:n-l}:{newText:a+o+i+r+c,newStart:s+l,newEnd:n+l}}function xx(e,s,n){const o=s==="1. "&&n!==void 0?`${n}. `:s;if(s==="1. "){const i=e.match(/^\d+\.\s/);if(i)return e.substring(i[0].length)}else if(e.startsWith(s))return e.substring(s.length);const r=e.match(/^(#{1,3}\s)/);if(r&&s.startsWith("#"))return o+e.substring(r[1].length);const a=e.match(/^(\s*[-*]\s|\s*\d+\.\s)/);return a&&(s==="- "||s.match(/^\d+\.\s/))?o+e.substring(a[1].length):o+e}function pn(e,s,n,o=!1){const r=e.split(`
`);if(o){const h=n==="1. ",f=r.every(w=>h?/^\d+\.\s/.test(w):w.startsWith(n));return{newText:r.map((w,m)=>{if(f){if(h){const x=w.match(/^\d+\.\s/);return x?w.substring(x[0].length):w}return w.startsWith(n)?w.substring(n.length):w}return xx(w,n,h?m+1:void 0)}).join(`
`),newCursorPos:0}}let a=0,i=0;for(let h=0;h<r.length;h++){if(a+r[h].length>=s){i=h;break}a+=r[h].length+1}const c=r[i],l=a;if(c.startsWith(n)){r[i]=c.substring(n.length);const h=Math.max(l,s-n.length);return{newText:r.join(`
`),newCursorPos:h}}const d=c.match(/^(#{1,3}\s)/);if(d&&n.startsWith("#")){r[i]=n+c.substring(d[1].length);const h=n.length-d[1].length;return{newText:r.join(`
`),newCursorPos:s+h}}const u=c.match(/^(\s*[-*]\s|\s*\d+\.\s)/);if(u&&(n==="- "||n.match(/^\d+\.\s/))){r[i]=n+c.substring(u[1].length);const h=n.length-u[1].length;return{newText:r.join(`
`),newCursorPos:s+h}}return r[i]=n+c,{newText:r.join(`
`),newCursorPos:s+n.length}}function wx(e,s){if(s)return"  "+e;{let n=0;for(let o=0;o<Math.min(2,e.length)&&e[o]===" ";o++)n++;return n>0?e.substring(n):e}}function Hi(e,s,n,o=!1){const r=e.split(`
`);if(o)return{newText:r.map(d=>wx(d,n)).join(`
`),newCursorPos:0};let a=0,i=0;for(let l=0;l<r.length;l++){if(a+r[l].length>=s){i=l;break}a+=r[l].length+1}const c=r[i];if(n)return r[i]="  "+c,{newText:r.join(`
`),newCursorPos:s+2};{let l=0;for(let d=0;d<Math.min(2,c.length)&&c[d]===" ";d++)l++;return l>0?(r[i]=c.substring(l),{newText:r.join(`
`),newCursorPos:Math.max(a,s-l)}):{newText:e,newCursorPos:s}}}const yx=(e=!0)=>{const{fitNodeDimensions:s}=on(),n=p.useCallback(r=>{const a=E.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length!==1){console.warn("useTextFormatting: Expected exactly one selected node");return}const l=c[0],d=typeof l.content=="string"?l.content:"",u=0,h=d.length,f=!e;let g;switch(r){case"bold":g=ka(d,u,h,"**","**");break;case"italic":g=ka(d,u,h,"_","_");break;case"strikethrough":g=ka(d,u,h,"~~","~~");break;case"h1":{const w=pn(d,u,"# ",f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}case"h2":{const w=pn(d,u,"## ",f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}case"h3":{const w=pn(d,u,"### ",f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}case"unorderedList":{const w=pn(d,u,"- ",f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}case"orderedList":{const w=pn(d,u,"1. ",f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}case"indent":{const w=Hi(d,u,!0,f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}case"outdent":{const w=Hi(d,u,!1,f);g={newText:w.newText,newCursorPos:w.newCursorPos};break}default:return}a.updateNodeContent(l.id,g.newText),setTimeout(()=>{const w=E.getState().getNodeById(l.id);w&&s([w])},10)},[s,e]),o=p.useCallback(r=>{const a=E.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length===0){console.warn("useTextFormatting: No nodes selected for font size change");return}const l=Ne.FONT_SIZE_PRESETS[r],d=`${l}px`,u=Math.round(l*1.5),h=[];for(const f of c){const g=f.styles??{},w=f.height,m={...g,fontSize:d},x=(typeof f.content=="string"?f.content:"").replace(/\n+$/,""),y=window.getComputedStyle(document.body),v=y.fontFamily,b=`${y.fontWeight} ${l}px ${v}`,S=ys(x,b)+vs.textNodeXPadding,I=Math.max(f.width??Ne.DEFAULT_NODE_WIDTH,S),k=Vd(x,I,b,u)+Ne.NODE_Y_PADDING;h.push({type:"node:update",nodeId:f.id,from:{styles:g,height:w,width:f.width},to:{styles:m,height:k,width:I}}),a.updateNode(f.id,{styles:m,height:k,width:I})}h.length===1?a.undo.commit(h[0]):h.length>1&&a.undo.commit({type:"batch",label:`Apply ${r} font size to ${h.length} nodes`,operations:h})},[]);return{applyBold:p.useCallback(()=>n("bold"),[n]),applyItalic:p.useCallback(()=>n("italic"),[n]),applyStrikethrough:p.useCallback(()=>n("strikethrough"),[n]),applyH1:p.useCallback(()=>n("h1"),[n]),applyH2:p.useCallback(()=>n("h2"),[n]),applyH3:p.useCallback(()=>n("h3"),[n]),applyUnorderedList:p.useCallback(()=>n("unorderedList"),[n]),applyOrderedList:p.useCallback(()=>n("orderedList"),[n]),applyIndent:p.useCallback(()=>n("indent"),[n]),applyOutdent:p.useCallback(()=>n("outdent"),[n]),applyFontSize:o}};function vx(){const[e,s]=p.useState(!1),{applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:u,applyOutdent:h,applyFontSize:f}=yx(e),g=p.useMemo(()=>({applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:u,applyOutdent:h,applyFontSize:f}),[n,o,r,a,i,c,l,d,u,h,f]),w=p.useCallback(()=>e,[e]),m=p.useMemo(()=>({getFirstLineOnly:w,setFirstLineOnly:s}),[w]),x=p.useMemo(()=>new mx(g,m),[g,m]);return p.useEffect(()=>(it.register("textFormatting",{name:"Text Formatting",getActions:()=>x.getActions()}),rt.register("textFormatting",x),()=>{it.unregister("textFormatting"),rt.unregister("textFormatting")}),[x]),{facade:x,firstLineOnly:e,setFirstLineOnly:s}}const bx=e=>{const{className:s}=e,{facade:n,firstLineOnly:o,setFirstLineOnly:r}=vx(),a={icon:t.jsx(Rs,{className:"h-4 w-4"}),onClick:()=>n.execute("style:bold"),label:"Text formatting"},i=[{header:"Style",width:"120px",actions:[{label:"Bold",icon:t.jsx(Qc,{className:"h-3 w-3"}),onClick:()=>n.execute("style:bold")},{label:"Italic",icon:t.jsx(el,{className:"h-3 w-3"}),onClick:()=>n.execute("style:italic")},{label:"Strikethrough",icon:t.jsx(tl,{className:"h-3 w-3"}),onClick:()=>n.execute("style:strikethrough")}]},{header:"Headings",width:"120px",actions:[{label:"Heading 1",icon:t.jsx(sl,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h1")},{label:"Heading 2",icon:t.jsx(nl,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h2")},{label:"Heading 3",icon:t.jsx(ol,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h3")}]},{header:"Lists",width:"130px",actions:[{label:"Bullet list",icon:t.jsx(dr,{className:"h-3 w-3"}),onClick:()=>n.execute("list:bullet")},{label:"Numbered list",icon:t.jsx(Dn,{className:"h-3 w-3"}),onClick:()=>n.execute("list:numbered")},{label:"Indent",icon:t.jsx(al,{className:"h-3 w-3"}),onClick:()=>n.execute("list:indent")},{label:"Outdent",icon:t.jsx(rl,{className:"h-3 w-3"}),onClick:()=>n.execute("list:outdent")},{label:"First line only",icon:null,customRender:()=>t.jsx("div",{className:"px-2 py-1",onPointerDown:c=>c.stopPropagation(),children:t.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:c=>r(c.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:c=>c.stopPropagation(),"data-test":"toolbar-formatting-first-line-only-checkbox"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"First line only"})]})})}]},{header:"Size",width:"100px",actions:[{label:"Small",icon:t.jsx(Rs,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("style:fontSize:small")},{label:"Normal",icon:t.jsx(Rs,{className:"h-3 w-3"}),onClick:()=>n.execute("style:fontSize:normal")},{label:"Large",icon:t.jsx(Rs,{className:"h-3.5 w-3.5"}),onClick:()=>n.execute("style:fontSize:large")},{label:"X-Large",icon:t.jsx(Rs,{className:"h-4 w-4"}),onClick:()=>n.execute("style:fontSize:xlarge")}]}];return t.jsx("div",{className:ve("flex items-center",s),"data-test":"toolbar-text-formatting-button",children:t.jsx(Ze,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-text-formatting",facade:n,dropdownMenuClassName:"w-auto min-w-0"})})},Aa=e=>{let s="";if(typeof e.content=="string"&&(s+=e.content+`
`),e.subContent){if(typeof e.subContent=="string")s+=e.subContent+`
`;else if(typeof e.subContent=="object"&&"lines"in e.subContent){const{lines:n}=e.subContent;typeof n=="string"?s+=n+`
`:Array.isArray(n)&&n.forEach(o=>{typeof o=="string"?s+=o+`
`:o&&Array.isArray(o.words)&&(s+=o.words.join(" ")+`
`)})}}return s.trim()},Nx=e=>{const{className:s,variant:n}=e,o=E.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.selectedNodes)??[],i=o.addNode,c=o.setNodeToFocusId,l=async(m,x)=>{if(a.length===0){console.log(`AI ${m}: No nodes selected.`);return}let y=a.map(Aa).join(`

---

`);if(x&&(y=`${x}:

${y}`),!y.trim()){console.log(`AI ${m}: Selected nodes have no text content.`);return}console.log(`AI ${m} - Prompt:`,y);try{const v=await Ud.generateCompletion(y,void 0,{stream:!1});console.log(`AI ${m} - Response:`,v);const N=v==null?void 0:v.response;if(typeof N=="string"&&N.trim()){let b={x:100,y:100};if(a.length>0){const I=a[0];b={x:I.x,y:I.y+(I.height??Ne.DEFAULT_NODE_HEIGHT)+Ne.nodeSpacing}}const S=Le.buildTextNode(b,N);i(S),c(S.id),console.log(`AI ${m}: Created new node ${S.id} with AI response.`)}else(typeof N!="string"||!N.trim())&&console.log(`AI ${m}: Received empty or invalid response from AI.`)}catch(v){console.error(`AI ${m} - Error:`,v)}},d=()=>{l("Generate Text","Continue writing based on the following text")},u=()=>{l("Summarize Selection","Summarize the following text")},h=()=>{l("Ask Question","Based on the following, answer any implied questions or provide information")},f=async()=>{if(a.length===0){console.log("Translate to VN: No nodes selected.");return}const m=a.map(Aa).join(`

`);if(!m.trim()){console.log("Translate to VN: Selected nodes have no text content.");return}console.log("Translate to VN - Input:",m);try{const x=await Xr(m,"English","Vietnamese");console.log("Translate to VN - Response:",x);const y=x.output;if(y!=null&&y.trim()){let v={x:100,y:100};if(a.length>0){const b=a[0];v={x:b.x,y:b.y+(b.height??Ne.DEFAULT_NODE_HEIGHT)+Ne.nodeSpacing}}const N=Le.buildTextNode(v,y);i(N),c(N.id),console.log(`Translate to VN: Created new node ${N.id} with Vietnamese translation.`)}else console.log("Translate to VN: Received empty translation.")}catch(x){console.error("Translate to VN - Error:",x)}},g=async()=>{if(a.length===0){console.log("Translate to EN: No nodes selected.");return}const m=a.map(Aa).join(`

`);if(!m.trim()){console.log("Translate to EN: Selected nodes have no text content.");return}console.log("Translate to EN - Input:",m);try{const x=await Xr(m,"Vietnamese","English");console.log("Translate to EN - Response:",x);const y=x.output;if(y!=null&&y.trim()){let v={x:100,y:100};if(a.length>0){const b=a[0];v={x:b.x,y:b.y+(b.height??Ne.DEFAULT_NODE_HEIGHT)+Ne.nodeSpacing}}const N=Le.buildTextNode(v,y);i(N),c(N.id),console.log(`Translate to EN: Created new node ${N.id} with English translation.`)}else console.log("Translate to EN: Received empty translation.")}catch(x){console.error("Translate to EN - Error:",x)}},w=[{label:"Generate Text",icon:t.jsx(Pn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Summarize",icon:t.jsx(hh,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Ask Question",icon:t.jsx(rr,{className:"h-2.5 w-2.5"}),onClick:h},{label:"Translate to VN",icon:t.jsx(Ur,{className:"h-2.5 w-2.5"}),onClick:f},{label:"Translate to EN",icon:t.jsx(Ur,{className:"h-2.5 w-2.5"}),onClick:g}];return t.jsx("div",{id:"ToolbarAi",className:je("ToolbarAi",s),"data-test":"toolbar-ai-button",children:t.jsx(Ze,{size:"compact",variant:n??"secondary",mainAction:{icon:t.jsx(Pn,{className:"h-2.5 w-2.5"}),onClick:()=>{console.log("Main AI Action clicked")},text:"AI",label:"Trigger AI actions"},dropdownActions:w,dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})};class Sx{constructor(s){Fe(this,"namespace","canvas.fitWidth");this.hooks=s}getActions(){return[{id:"width:350",label:"Set width to 350px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"width:550",label:"Set width to 550px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"width:700",label:"Set width to 700px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"width:850",label:"Set width to 850px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"fit:dimensions",label:"Fit node dimensions",category:"Fit",icon:t.jsx(xs,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"width:350":this.hooks.setWidth350();break;case"width:550":this.hooks.setWidth550();break;case"width:700":this.hooks.setWidth700();break;case"width:850":this.hooks.setWidth850();break;case"fit:dimensions":this.hooks.fitDimensions();break;default:console.warn(`FitWidthFacade: Unknown action "${s}"`)}}}function Cx(){const{setFixedWidth:e,fitNodeDimensions:s}=on(),n=p.useCallback(()=>e(350),[e]),o=p.useCallback(()=>e(550),[e]),r=p.useCallback(()=>e(700),[e]),a=p.useCallback(()=>e(850),[e]),i=p.useCallback(()=>s(),[s]),c=p.useMemo(()=>({setWidth350:n,setWidth550:o,setWidth700:r,setWidth850:a,fitDimensions:i}),[n,o,r,a,i]),l=p.useMemo(()=>new Sx(c),[c]);return p.useEffect(()=>(it.register("fitWidth",{name:"Fit Width",getActions:()=>l.getActions()}),rt.register("fitWidth",l),()=>{it.unregister("fitWidth"),rt.unregister("fitWidth")}),[l]),l}const jx=()=>{const{selectedNodes:e}=on(),s=Cx(),n=e.length===0,o=[{label:"Set width to 350px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:350"),disabled:n},{label:"Set width to 550px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:550"),disabled:n},{label:"Set width to 700px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:700"),disabled:n},{label:"Set width to 850px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:850"),disabled:n},{label:"Fit node dimensions",icon:t.jsx(xs,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("fit:dimensions"),disabled:n}],r=o[0];return t.jsx(Ze,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"canvas-fit-width",facade:s,"data-test":"canvas-fit-width-button"})},Yt=50,Kl=()=>{const s=E.getState().projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=p.useCallback((f,g)=>{const w=E.getState(),m=w.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],y=(m==null?void 0:m.coreState.nodes)??{},v=w.updateNode;if(x.length!==1){console.warn("useNodePusher: Exactly one node must be selected to push/pull other nodes.");return}const N=x[0],b=[],S=Object.values(y),I=g==="pull"?f==="up"?"down":f==="down"?"up":f==="left"?"right":"left":f;S.forEach(C=>{if(C.id===N.id)return;let k=!1;const R={id:C.id};switch(I){case"down":C.y>=N.y+(N.height??0)&&(R.y=C.y+(g==="push"?Yt:-Yt),k=!0);break;case"up":C.y+(C.height??0)<=(N.y??0)&&(R.y=C.y+(g==="push"?-Yt:Yt),k=!0);break;case"right":C.x>=N.x+(N.width??0)&&(R.x=C.x+(g==="push"?Yt:-Yt),k=!0);break;case"left":C.x+(C.width??0)<=N.x&&(R.x=C.x+(g==="push"?-Yt:Yt),k=!0);break}k&&b.push(R)}),b.length>0?(b.forEach(C=>v(C.id,C)),console.log(`${g==="push"?"Pushed":"Pulled"} ${b.length} nodes ${f} by ${Yt}px.`)):console.warn(`No nodes found to ${g} ${f}.`)},[]),r=p.useCallback(()=>o("down","push"),[o]),a=p.useCallback(()=>o("up","push"),[o]),i=p.useCallback(()=>o("left","push"),[o]),c=p.useCallback(()=>o("right","push"),[o]),l=p.useCallback(()=>o("down","pull"),[o]),d=p.useCallback(()=>o("up","pull"),[o]),u=p.useCallback(()=>o("left","pull"),[o]),h=p.useCallback(()=>o("right","pull"),[o]);return{pushNodesDown:r,pushNodesUp:a,pushNodesLeft:i,pushNodesRight:c,pullNodesDown:l,pullNodesUp:d,pullNodesLeft:u,pullNodesRight:h,selectedNodes:n}};class kx{constructor(s){Fe(this,"namespace","canvas.nodeOperations");this.hooks=s}getActions(){return[{id:"push:up",label:"Push up",category:"Push",icon:t.jsx(On,{className:"h-3 w-3"})},{id:"push:down",label:"Push down",category:"Push",icon:t.jsx(Ln,{className:"h-3 w-3"})},{id:"push:left",label:"Push left",category:"Push",icon:t.jsx(Xs,{className:"h-3 w-3"})},{id:"push:right",label:"Push right",category:"Push",icon:t.jsx(Vt,{className:"h-3 w-3"})},{id:"pull:up",label:"Pull up",category:"Pull",icon:t.jsx(On,{className:"h-3 w-3"})},{id:"pull:down",label:"Pull down",category:"Pull",icon:t.jsx(Ln,{className:"h-3 w-3"})},{id:"pull:left",label:"Pull left",category:"Pull",icon:t.jsx(Xs,{className:"h-3 w-3"})},{id:"pull:right",label:"Pull right",category:"Pull",icon:t.jsx(Vt,{className:"h-3 w-3"})},{id:"join:newline",label:"Join with newline",category:"Join",icon:t.jsx(cr,{className:"h-3 w-3"})},{id:"join:space",label:"Join with space",category:"Join",icon:t.jsx(Yo,{className:"h-3 w-3"})},{id:"lines:remove-extra",label:"Remove extra lines",category:"Lines",icon:t.jsx(La,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"push:up":this.hooks.pushUp();break;case"push:down":this.hooks.pushDown();break;case"push:left":this.hooks.pushLeft();break;case"push:right":this.hooks.pushRight();break;case"pull:up":this.hooks.pullUp();break;case"pull:down":this.hooks.pullDown();break;case"pull:left":this.hooks.pullLeft();break;case"pull:right":this.hooks.pullRight();break;case"join:newline":this.hooks.joinWithNewline();break;case"join:space":this.hooks.joinWithSpace();break;case"lines:remove-extra":this.hooks.removeExtraLines();break;default:console.warn(`NodeOperationsFacade: Unknown action "${s}"`)}}}const Xl=()=>{const e=E.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=(s==null?void 0:s.coreState.arrows)??[];e.addNode,e.deleteSelectedNodes;const r=e.deleteNodeById,a=e.setSelectedNodes,i=e.updateNodes,c=e.arrow.setAll,l=p.useCallback(h=>{if(n.length<2){console.warn("useNodeJoiner: At least two nodes must be selected to join.");return}const f=[...n].sort((N,b)=>N.y<b.y?-1:N.y>b.y?1:N.x<b.x?-1:N.x>b.x?1:0),g=f[0],w=f.slice(1),m=f.reduce((N,b)=>(b.width??0)>(N.width??0)?b:N,f[0]),x=f.map(N=>typeof N.content=="string"?N.content.trim():"").filter(N=>N.length>0).join(h);if(x.length===0&&f.every(N=>!(typeof N.content=="string"&&N.content.trim()))){console.warn("useNodeJoiner: All selected nodes have empty content. No node created.");return}const y=m.width??Ne.DEFAULT_NODE_WIDTH,v=ht(x,y,g);i([{id:g.id,content:x,width:m.width,height:v}]);{const N=new Set(w.map(I=>I.id)),S=o.map(I=>{const C=I.startNodeId&&N.has(I.startNodeId),k=I.endNodeId&&N.has(I.endNodeId);return C&&k||C&&I.endNodeId===g.id||k&&I.startNodeId===g.id?null:C||k?{...I,startNodeId:C?g.id:I.startNodeId,endNodeId:k?g.id:I.endNodeId}:I}).filter(I=>I!==null).filter((I,C,k)=>I?C===k.findIndex(R=>R&&R.startNodeId===I.startNodeId&&R.endNodeId===I.endNodeId):!1);c(S)}w.forEach(N=>{r(N.id)}),a([g]),console.log("Nodes joined into first node:",g.id)},[n,o,i,r,a,c]),d=p.useCallback(()=>{l(" ")},[l]),u=p.useCallback(()=>{l(`
`)},[l]);return{joinNodes:d,joinNodesWithNewline:u,selectedNodes:n}},Ax=()=>{const e=E.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=e.updateNode;return{removeExtraNewLines:p.useCallback(()=>{if(n.length!==1){console.warn("useNodeLineManipulation: Exactly one node must be selected.");return}const a=n[0];if(!a.content||typeof a.content!="string"){console.warn("useNodeLineManipulation: Selected node has no content to modify.");return}const i=a.content.replace(/\n\n+/g,`
`);if(i===a.content){console.warn("useNodeLineManipulation: No extra new lines found. Node content not changed.");return}const c=ht(i,a.width??0,a),l={id:a.id,content:i,height:c};o(l.id,l),console.log("Action: Removed extra new lines from node content.")},[n,o])}};function br(){const{pushNodesUp:e,pushNodesDown:s,pushNodesLeft:n,pushNodesRight:o,pullNodesUp:r,pullNodesDown:a,pullNodesLeft:i,pullNodesRight:c}=Kl(),{joinNodes:l,joinNodesWithNewline:d}=Xl(),{removeExtraNewLines:u}=Ax(),h=p.useMemo(()=>({pushUp:e,pushDown:s,pushLeft:n,pushRight:o,pullUp:r,pullDown:a,pullLeft:i,pullRight:c,joinWithNewline:d,joinWithSpace:l,removeExtraLines:u}),[e,s,n,o,r,a,i,c,d,l,u]),f=p.useMemo(()=>new kx(h),[h]);return p.useEffect(()=>(it.register("nodeOperations",{name:"Node Operations",getActions:()=>f.getActions()}),rt.register("nodeOperations",f),()=>{it.unregister("nodeOperations"),rt.unregister("nodeOperations")}),[f]),f}const Ix=e=>{const{className:s}=e,{selectedNodes:n}=Kl(),o=br(),r=n.length!==1,a={icon:t.jsx(ph,{className:"h-4 w-4"}),onClick:()=>o.execute("push:down"),label:"Push/Pull nodes",disabled:r},i=[{header:"Push",actions:[{label:"Push Up",icon:t.jsx(On,{className:"h-3 w-3"}),onClick:()=>o.execute("push:up"),disabled:r},{label:"Push Down",icon:t.jsx(Ln,{className:"h-3 w-3"}),onClick:()=>o.execute("push:down"),disabled:r},{label:"Push Left",icon:t.jsx(Xs,{className:"h-3 w-3"}),onClick:()=>o.execute("push:left"),disabled:r},{label:"Push Right",icon:t.jsx(Vt,{className:"h-3 w-3"}),onClick:()=>o.execute("push:right"),disabled:r}]},{header:"Pull",actions:[{label:"Pull Up",icon:t.jsx(On,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:up"),disabled:r},{label:"Pull Down",icon:t.jsx(Ln,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:down"),disabled:r},{label:"Pull Left",icon:t.jsx(Xs,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:left"),disabled:r},{label:"Pull Right",icon:t.jsx(Vt,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:right"),disabled:r}]}];return t.jsx("div",{id:"PushNodesButtonContainer",className:ve("flex items-center",s),"data-test":"toolbar-push-pull-nodes-button",children:t.jsx(Ze,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-push-nodes",facade:o,dropdownMenuClassName:"w-auto min-w-0"})})},Tx=()=>{const{selectedNodes:e}=Xl(),s=br(),n=e.length<2,o=[{label:"Join with newline",icon:t.jsx(cr,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:newline"),disabled:n},{label:"Join with space",icon:t.jsx(Yo,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:space"),disabled:n}],r={...o[0]};return t.jsx(Ze,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"toolbar-join-nodes",facade:s,"data-test":"canvas-join-nodes-button"})},Qo=[{name:"Red",value:"#ef4444",twClass:"bg-red-500"},{name:"Orange",value:"#f97316",twClass:"bg-orange-500"},{name:"Yellow",value:"#eab308",twClass:"bg-yellow-500"},{name:"Green",value:"#22c55e",twClass:"bg-green-500"},{name:"Teal",value:"#14b8a6",twClass:"bg-teal-500"},{name:"Cyan",value:"#06b6d4",twClass:"bg-cyan-500"},{name:"Blue",value:"#3b82f6",twClass:"bg-blue-500"},{name:"Violet",value:"#8b5cf6",twClass:"bg-violet-500"},{name:"Purple",value:"#a855f7",twClass:"bg-purple-500"},{name:"Pink",value:"#ec4899",twClass:"bg-pink-500"},{name:"White",value:"#ffffff",twClass:"bg-white"},{name:"Border",value:"hsl(240 5.9% 90%)",twClass:"bg-border"},{name:"Muted",value:"hsl(var(--muted-light))",twClass:"bg-muted"},{name:"Black",value:"#000000",twClass:"bg-black"},{name:"Transparent",value:"transparent",twClass:"bg-transparent border-dashed border-neutral-400"}],ea=e=>{if(e.startsWith("hsl(")){const s=/hsl\(\s*(\d+)\s*,\s*(\d+%)\s*,\s*(\d+%)\s*\)/.exec(e);if(s){const n=parseInt(s[1]),o=parseInt(s[2])/100,r=parseInt(s[3])/100;if(o===0){const d=Math.round(r*255).toString(16).padStart(2,"0");return`#${d}${d}${d}`}const a=d=>(d+n/30)%12,i=o*Math.min(r,1-r),c=d=>r-i*Math.max(-1,Math.min(a(d)-3,Math.min(9-a(d),1))),l=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${l(c(0))}${l(c(8))}${l(c(4))}`}}return console.warn(`convertHslToHex: Could not convert HSL string "${e}" to HEX. Returning as is or black.`),e.startsWith("#")?e:"#000000"},Ex=({currentColor:e,onColorSelect:s,currentBorderWidth:n,onBorderWidthChange:o})=>{const[r,a]=p.useState(e),[i,c]=p.useState(n);p.useEffect(()=>{a(e)},[e]),p.useEffect(()=>{c(n)},[n]);const l=u=>{a(u),s(u)},d=u=>{const h=parseInt(u.target.value,10);isNaN(h)||(c(h),o(h))};return t.jsxs("div",{className:"p-2 grid grid-cols-5 gap-2 bg-popover rounded-md shadow-md",children:[Qo.map(u=>t.jsx("button",{type:"button",title:u.name,onClick:()=>l(u.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",u.twClass,u.value===r?"ring-2 ring-ring ring-offset-2":"border-muted ring-0",u.value==="white"&&"border-neutral-300"),style:u.value.startsWith("hsl(")?{backgroundColor:u.value}:{},"aria-label":`Select color ${u.name}`,"data-test":"color-picker-option"},u.value)),t.jsx("input",{type:"color",value:r.startsWith("hsl")?ea(r):r,onChange:u=>l(u.target.value),className:"mt-2 w-full col-span-5 h-8 bg-secondary","data-test":"color-picker-custom-color-input"}),t.jsxs("div",{className:"mt-3 pt-3 border-t border-border col-span-5",children:[t.jsx("label",{htmlFor:"border-width-input",className:"block text-sm font-medium text-foreground mb-1",children:"Border Width"}),t.jsx("input",{type:"number",id:"border-width-input",value:i,onChange:d,min:"0",max:"50",className:"mt-1 w-full col-span-5 h-8 p-2 rounded-md border border-input bg-background text-foreground focus:ring-ring focus:border-ring","data-test":"color-picker-border-width-input"})]})]})},Rx=()=>{var I,C,k,R;const e=F(A=>A.updateNode),s=F(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??[]}),[n,o]=p.useState(!1),[r,a]=p.useState("hsl(var(--primary))"),[i,c]=p.useState("1px"),[l,d]=p.useState("solid"),u=E.getState().getLastUsedBorder(),h=u.lastUsedColor,f=u.lastUsedWidth,g=u.lastUsedStyle;p.useEffect(()=>{if(s.length===1){const T=s[0].styles,O=(T==null?void 0:T.borderColor)||"hsl(var(--primary))",$=(T==null?void 0:T.borderWidth)||"1px",B=(T==null?void 0:T.borderStyle)||"solid";a(O),c($),d(B)}else s.length===0&&(a("hsl(var(--primary))"),c("1px"),d("solid"))},[s]);const w=(A,T,O)=>{s.forEach($=>{const B={...$.styles,borderWidth:A,borderStyle:T,borderColor:O};A===void 0&&T===void 0&&O===void 0&&(B.border=void 0);const H={styles:B};e($.id,H)})},m=()=>{w(f,g,h)},x=A=>{w(i,l,A),a(A),E.getState().setLastUsedBorder(A,i,l),E.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},y=A=>{const T=`${A}px`;w(T,l,r),c(T),E.getState().setLastUsedBorder(r,T,l),E.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},v=()=>{c(void 0),d(void 0),a(void 0),w(void 0,void 0,void 0)},N=[{label:"Apply last used border color",icon:t.jsx("span",{style:{color:h==="transparent"?void 0:h,display:"inline-flex"},children:t.jsx(Gr,{className:"h-2.5 w-2.5"})}),onClick:()=>{m()},disabled:s.length===0},{label:"Set Border Color",icon:t.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:t.jsx(il,{className:"h-2.5 w-2.5"})}),onClick:()=>{o(!0)},disabled:s.length===0},{label:"Remove Border",icon:t.jsx(Un,{className:"h-2.5 w-2.5"}),onClick:()=>{v()},disabled:s.length===0||!((C=(I=s[0])==null?void 0:I.styles)!=null&&C.borderWidth)&&!((R=(k=s[0])==null?void 0:k.styles)!=null&&R.border)}],b={...N[0],icon:t.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:t.jsx(Gr,{className:"h-2.5 w-2.5"})})},S=A=>{if(!A)return 1;const T=parseInt(A,10);return isNaN(T)?1:T};return t.jsxs(ct,{open:n,onOpenChange:o,children:[t.jsx(lt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"canvas-border-width-button",children:t.jsx(Ze,{mainAction:b,dropdownActions:N,variant:"outline",size:"compact",persistenceKey:"canvas-border-width"})})}),t.jsx(dt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:A=>A.preventDefault(),"data-test":"canvas-border-width-popover",children:t.jsx(Ex,{currentColor:r,onColorSelect:x,currentBorderWidth:S(i),onBorderWidthChange:y})})]})},Mx=e=>{const{className:s}=e,n=br(),o={icon:t.jsx(La,{}),onClick:()=>n.execute("lines:remove-extra"),label:"Remove extra new lines"},r=[{label:"Remove extra new lines",icon:t.jsx(La,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("lines:remove-extra")}];return t.jsx("div",{id:"ToolbarLinesButtonContainer",className:ve("flex items-center",s),"data-test":"toolbar-lines-button",children:t.jsx(Ze,{mainAction:o,dropdownActions:r,variant:"outline",size:"compact",persistenceKey:"toolbar-lines",facade:n})})},Px=e=>{const{className:s,...n}=e,o=()=>{var i;const r=E.getState();(((i=r.projectCanvas.getActive())==null?void 0:i.coreState.selectedNodes)??[]).length>0&&r.deleteSelectedNodes()};return t.jsx(an,{id:"ToolbarDeleteNodesButton",className:s,type:"button",onClick:o,"data-test":"toolbar-delete-nodes-button",...n,children:t.jsx(vt,{className:"h-2.5 w-2.5"})})};class Dx{constructor(s){Fe(this,"namespace","canvas.alignment");this.hooks=s}getActions(){return[{id:"node:left",label:"Align left",category:"Node",icon:t.jsx(Wn,{className:"h-3 w-3"})},{id:"node:right",label:"Align right",category:"Node",icon:t.jsx(Hn,{className:"h-3 w-3"})},{id:"node:top",label:"Align top",category:"Node",icon:t.jsx(ur,{className:"h-3 w-3"})},{id:"node:bottom",label:"Align bottom",category:"Node",icon:t.jsx(hr,{className:"h-3 w-3"})},{id:"text:left",label:"Text left",category:"Text",icon:t.jsx(Wn,{className:"h-3 w-3"})},{id:"text:center",label:"Text center",category:"Text",icon:t.jsx(cl,{className:"h-3 w-3"})},{id:"text:right",label:"Text right",category:"Text",icon:t.jsx(Hn,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"node:left":this.hooks.alignNodesLeft();break;case"node:right":this.hooks.alignNodesRight();break;case"node:top":this.hooks.alignNodesTop();break;case"node:bottom":this.hooks.alignNodesBottom();break;case"text:left":this.hooks.alignTextLeft();break;case"text:center":this.hooks.alignTextCenter();break;case"text:right":this.hooks.alignTextRight();break;default:console.warn(`AlignmentFacade: Unknown action "${s}"`)}}}const Ox=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.y??0)-(c.y??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.y??0,l=i.height??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},Lx=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.x??0)-(c.x??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.x??0,l=i.width??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},Wx=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="left"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.x??0)-(i.x??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.x??0)+(i.width??0);if((c.x??0)<l+n){const u=l+n;o.set(c.id,{x:u}),r[a]={...c,x:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.x??0)+(a.width??0);return(i.x??0)+(i.width??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.x??0;if((c.x??0)+(c.width??0)>l-n){const u=l-n-(c.width??0);o.set(c.id,{x:u}),r[a]={...c,x:u}}}}return o},Hx=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="top"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.y??0)-(i.y??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.y??0)+(i.height??0);if((c.y??0)<l+n){const u=l+n;o.set(c.id,{y:u}),r[a]={...c,y:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.y??0)+(a.height??0);return(i.y??0)+(i.height??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.y??0;if((c.y??0)+(c.height??0)>l-n){const u=l-n-(c.height??0);o.set(c.id,{y:u}),r[a]={...c,y:u}}}}return o};function Bx(){const e=p.useCallback(r=>{var f;const a=E.getState(),i=((f=a.projectCanvas.getActive())==null?void 0:f.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.filter(g=>typeof g.x=="number"&&typeof g.y=="number"&&typeof g.width=="number"&&typeof g.height=="number");if(c.length===0)return;const l=r==="left"||r==="right"?Ox(c):Lx(c);let d;switch(r){case"left":d=Math.min(...c.map(g=>g.x));break;case"right":d=Math.max(...c.map(g=>(g.x??0)+(g.width??0)));break;case"top":d=Math.min(...c.map(g=>g.y));break;case"bottom":d=Math.max(...c.map(g=>(g.y??0)+(g.height??0)));break;default:return}const u=new Map;for(const g of c)switch(r){case"left":u.set(g.id,{x:d});break;case"right":u.set(g.id,{x:d-(g.width??0)});break;case"top":u.set(g.id,{y:d});break;case"bottom":u.set(g.id,{y:d-(g.height??0)});break}const h=Ne.NODE_ALIGNMENT_PADDING;for(const g of l){const w=g.map(x=>{const y=u.get(x.id);return y?{...x,...y}:x});(r==="left"||r==="right"?Wx(w,r,h):Hx(w,r,h)).forEach((x,y)=>{const v=u.get(y)||{};u.set(y,{...v,...x})})}u.forEach((g,w)=>{a.updateNode(w,g)})},[]),s=p.useCallback(r=>{var l;const a=E.getState(),i=((l=a.projectCanvas.getActive())==null?void 0:l.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.map(d=>({...d,id:d.id,styles:{...d.styles,textAlign:r}}));a.updateNodes(c)},[]),n=p.useMemo(()=>({alignNodesLeft:()=>e("left"),alignNodesRight:()=>e("right"),alignNodesTop:()=>e("top"),alignNodesBottom:()=>e("bottom"),alignTextLeft:()=>s("left"),alignTextCenter:()=>s("center"),alignTextRight:()=>s("right")}),[e,s]),o=p.useMemo(()=>new Dx(n),[n]);return p.useEffect(()=>(it.register("alignment",{name:"Alignment",getActions:()=>o.getActions()}),rt.register("alignment",o),()=>{it.unregister("alignment"),rt.unregister("alignment")}),[o]),o}const Ia={left:t.jsx(Wn,{className:"h-3 w-3"}),right:t.jsx(Hn,{className:"h-3 w-3"}),top:t.jsx(ur,{className:"h-3 w-3"}),bottom:t.jsx(hr,{className:"h-3 w-3"})},Bi={left:t.jsx(Wn,{className:"h-3 w-3"}),center:t.jsx(cl,{className:"h-3 w-3"}),right:t.jsx(Hn,{className:"h-3 w-3"})},Fx=e=>{const{className:s,value:n,defaultValue:o="left",onAlignmentChange:r,textAlignValue:a,defaultTextAlignValue:i="left",onTextAlignmentChange:c}=e,l=Bx(),[d,u]=p.useState(n??o),[h,f]=p.useState(a??i);p.useEffect(()=>{n!==void 0&&u(n)},[n]),p.useEffect(()=>{a!==void 0&&f(a)},[a]);const g=y=>{r==null||r(y),u(y),l.execute(`node:${y}`)},w=y=>{c==null||c(y),f(y),l.execute(`text:${y}`)},m={icon:t.jsx(t.Fragment,{children:Ia[d]}),onClick:()=>g(d),label:`Align nodes ${d}`,text:""},x=[{header:"Node",width:"100px",actions:Object.keys(Ia).map(y=>({label:`Node ${y}`,icon:Ia[y],onClick:()=>g(y)}))},{header:"Text",width:"100px",actions:Object.keys(Bi).map(y=>({label:`Text ${y}`,icon:Bi[y],onClick:()=>w(y)}))}];return t.jsx("div",{id:"ToolbarNodesAlignmentButton",className:ve("flex items-center",s),"data-test":"toolbar-nodes-alignment-button",children:t.jsx(Ze,{mainAction:m,dropdownColumns:x,variant:"outline",size:"compact",persistenceKey:"toolbar-alignment",facade:l,dropdownMenuClassName:"w-auto min-w-0"})})};function Nr({nodeGap:e,gridColumns:s,gridRows:n,onNodeGapChange:o,onGridColumnsChange:r,onGridRowsChange:a,showFavorites:i=!1,isGapFavorite:c=!1,isColumnsFavorite:l=!1,isRowsFavorite:d=!1,onToggleGapFavorite:u,onToggleColumnsFavorite:h,onToggleRowsFavorite:f,compact:g=!1,showRows:w=!0,className:m}){const x=g?"h-5 w-12 text-[10px] px-1":"h-7 w-20 text-xs",y=g?"text-muted-foreground text-[10px]":"text-xs text-muted-foreground min-w-[60px]",v=g?"flex items-center gap-3":"space-y-3",N=g?"flex items-center gap-1":"flex items-center gap-2";return t.jsxs("div",{className:ve(v,m),"data-test":"arrange-config-form",children:[t.jsxs("div",{className:N,"data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:y,children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"200",value:e,onChange:b=>o(Math.max(0,Math.min(200,parseInt(b.target.value)||0))),className:x,"data-test":"arrange-config-gap-input"}),!g&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"px"}),g&&t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"px"}),i&&t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:u,title:c?"Remove from favorites":"Add to favorites","data-test":"arrange-config-gap-favorite-button",children:t.jsx(Bs,{className:ve("h-3.5 w-3.5",c&&"fill-yellow-400 text-yellow-400")})})]}),t.jsxs("div",{className:N,"data-test":"arrange-config-columns-row",children:[t.jsx("span",{className:y,children:"Cols:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:s,onChange:b=>r(Math.max(1,Math.min(10,parseInt(b.target.value)||3))),className:x,"data-test":"arrange-config-columns-input"}),!g&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:h,title:l?"Remove from favorites":"Add to favorites","data-test":"arrange-config-columns-favorite-button",children:t.jsx(Bs,{className:ve("h-3.5 w-3.5",l&&"fill-yellow-400 text-yellow-400")})})]}),w&&n!==void 0&&a&&t.jsxs("div",{className:N,"data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:y,children:"Rows:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:n,onChange:b=>a(Math.max(1,Math.min(10,parseInt(b.target.value)||3))),className:x,"data-test":"arrange-config-rows-input"}),!g&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:f,title:d?"Remove from favorites":"Add to favorites","data-test":"arrange-config-rows-favorite-button",children:t.jsx(Bs,{className:ve("h-3.5 w-3.5",d&&"fill-yellow-400 text-yellow-400")})})]})]})}function $x(e){if(e.length<2)return[...e];const n=e.reduce((o,r)=>o+(r.height??100),0)/e.length*.5;return[...e].sort((o,r)=>Math.abs(o.y-r.y)<n?o.x-r.x:o.y-r.y)}const Ta=$x;function ql(e){return e.map(s=>({...s,width:s.width??100,height:s.height??31}))}function zx(e,s){if(e.length===0)return[];if(e.length===1)return[[...e]];const n=ql(e),r=n.reduce((d,u)=>d+u.height,0)/n.length*s,a=[...e].sort((d,u)=>d.y-u.y),i=[];let c=[a[0]],l=a[0].y;for(let d=1;d<a.length;d++){const u=a[d];Math.abs(u.y-l)<=r?c.push(u):(i.push(c),c=[u],l=u.y)}return c.length>0&&i.push(c),i}function _x(e,s){if(e.length===0)return[];if(e.length===1)return[...e];const{cleanUpGap:n,rowThreshold:o}=s,r=ql(e),a=new Map;r.forEach(u=>{a.set(u.id,{width:u.width,height:u.height})});const i=zx(e,o),l=[...i[0]].sort((u,h)=>u.x-h.x)[0].x,d=[];for(const u of i){const h=[...u].sort((m,x)=>m.x-x.x),g=h[0].y;let w=l;for(const m of h){const x=a.get(m.id);d.push({...m,x:w,y:g}),w+=x.width+n}}return d}const Is=[];function Vx(){const e=F(j=>{var P;return((P=j.projectCanvas.getActive())==null?void 0:P.coreState.selectedNodes)??Is}),s=F(j=>{var P;return((P=j.projectCanvas.getActive())==null?void 0:P.coreState.nodes)??Is}),{updateNode:n}=E.getState(),[o,r]=p.useState("content"),a=p.useRef(Is);e.length===0?a.current=Is:(e.length!==a.current.length||!e.every((j,P)=>{var W;return j.id===((W=a.current[P])==null?void 0:W.id)}))&&(a.current=e);const i=p.useRef(Is);s.length===0?i.current=Is:(s.length!==i.current.length||!s.every((j,P)=>{var W;return j.id===((W=i.current[P])==null?void 0:W.id)}))&&(i.current=s);const c=j=>{if(j)return j;const W=E.getState().projectCanvas.getActive(),L=(W==null?void 0:W.coreState.selectedNodes)??[],z=(W==null?void 0:W.coreState.nodes)??[];return L.length>=2?L:z},l=j=>{const P={timestamp:Date.now(),nodePositions:Object.fromEntries(j.map(W=>[W.id,{x:W.x,y:W.y,width:W.width,height:W.height}]))};E.getState().setArrangeSnapshot(P)},d=p.useCallback((j,P)=>{const W=c(j);if(W.length<2)return;l(W);const L=E.getState().getArrangeNodeGap(),z=[...W].sort((V,D)=>V.y-D.y);let _;P==="left"?_=Math.min(...W.map(V=>V.x)):P==="right"&&(_=Math.max(...W.map(D=>D.x+(D.width||200))));let G=z[0].y;z.forEach((V,D)=>{const K={};D===0?G=V.y+(V.height||100)+L:(K.y=G,G=G+(V.height||100)+L),P==="left"&&_!==void 0?K.x=_:P==="right"&&_!==void 0&&(K.x=_-(V.width||200)),Object.keys(K).length>0&&n(V.id,K)})},[n]),u=p.useCallback(j=>{d(j,"left")},[d]),h=p.useCallback(j=>{d(j,"right")},[d]),f=p.useCallback((j,P)=>{const W=c(j),L=E.getState().getArrangeNodeGap();if(W.length<2)return;l(W);const z=[...W].sort((V,D)=>V.x-D.x);let _;P==="top"?_=Math.min(...W.map(V=>V.y)):P==="bottom"&&(_=Math.max(...W.map(D=>D.y+(D.height||100))));let G=z[0].x;z.forEach((V,D)=>{const K={},te=V.width||200;D===0?G=V.x+te+L:(K.x=G,G=G+te+L),P==="top"&&_!==void 0?K.y=_:P==="bottom"&&_!==void 0&&(K.y=_-(V.height||100)),Object.keys(K).length>0&&n(V.id,K)})},[n]),g=p.useCallback(j=>{f(j,"top")},[f]),w=p.useCallback(j=>{f(j,"bottom")},[f]),m=(j,P)=>{const W=j.content||"";return ht(W,P,j)},x=j=>{const P=E.getState().group.createFromSelected(`[Arrange] ${j}`);P&&E.getState().addTagToNode(P,{id:Pe(8),title:"action:arrange"})},y=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W=E.getState().getArrangeNodeGap(),L=E.getState().getArrangeGridColumns(),z=Math.max(...P.map(ie=>ie.width??Ne.DEFAULT_NODE_WIDTH)),_=Ta(P),G=_[0].x,V=_[0].y,D=_.map(ie=>m(ie,z)),K=Math.ceil(_.length/L),te=[];for(let ie=0;ie<K;ie++){let ye=0;for(let ge=0;ge<L;ge++){const q=ie*L+ge;q<D.length&&(ye=Math.max(ye,D[q]))}te.push(ye)}_.forEach((ie,ye)=>{const ge=ye%L,q=Math.floor(ye/L),le=G+ge*(z+W),de=q===0?V:V+te.slice(0,q).reduce((Y,X)=>Y+X+W,0),U=D[ye];n(ie.id,{x:le,y:de,width:z,height:U,options:{...ie.options,lockSize:!0}})}),x("Grid")},[n]),v=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W=E.getState().getArrangeNodeGap(),L=E.getState().getArrangeGridColumns(),z=Math.max(...P.map(te=>te.width??Ne.DEFAULT_NODE_WIDTH)),_=Ta(P),G=_[0].x,V=_[0].y,D=Array(L).fill(V),K=_.map(te=>m(te,z));_.forEach((te,ie)=>{const ye=D.indexOf(Math.min(...D)),ge=G+ye*(z+W),q=D[ye],le=K[ie];n(te.id,{x:ge,y:q,width:z,height:le,options:{...te.options,lockSize:!0}}),D[ye]=q+le+W}),x("Masonry")},[n]),N=(j,P)=>{switch(P){case"content":return String(j.content??"").toLowerCase();case"title":return String(j.title??"").toLowerCase();case"x":return j.x;case"y":return j.y;case"width":return j.width??0;case"height":return j.height??0;case"createdAt":return j.createdAt??"";case"updatedAt":return j.updatedAt??"";case"id":return j.id;case"type":return j.type;default:return""}},b=p.useCallback((j,P="asc",W)=>{const L=c(W);if(L.length<2)return;const z=Ta(L).map(G=>({x:G.x,y:G.y}));[...L].sort((G,V)=>{const D=N(G,j),K=N(V,j);let te;return typeof D=="number"&&typeof K=="number"?te=D-K:te=String(D).localeCompare(String(K)),P==="asc"?te:-te}).forEach((G,V)=>{const D=z[V];(G.x!==D.x||G.y!==D.y)&&n(G.id,{x:D.x,y:D.y})})},[n]),S=p.useCallback((j,P)=>{b(j??o,"asc",P)},[b,o]),I=p.useCallback((j,P)=>{b(j??o,"desc",P)},[b,o]),C=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W={cleanUpGap:J.arrange.cleanUpGap,rowThreshold:J.arrange.cleanUpRowThreshold};_x(P,W).forEach(z=>{const _=P.find(G=>G.id===z.id);_&&(_.x!==z.x||_.y!==z.y)&&n(z.id,{x:z.x,y:z.y})})},[n]),k=j=>{const W=E.getState().projectCanvas.getActive(),L=(W==null?void 0:W.coreState.arrows)??[],z=new Set(j.map(_=>_.id));return L.filter(_=>_.startNodeId&&_.endNodeId&&z.has(_.startNodeId)&&z.has(_.endNodeId))},R=j=>{const P=j.width??Ne.DEFAULT_NODE_WIDTH,W=j.height??100;return{x:j.x+P/2,y:j.y+W/2}},A=(j,P,W)=>{const{arrow:L}=E.getState();for(const z of j){if(!z.startNodeId||!z.endNodeId)continue;const _=P.get(z.startNodeId),G=P.get(z.endNodeId);if(!_||!G)continue;const D=E.getState().projectCanvas.getActive(),K=(D==null?void 0:D.coreState.nodes)??[],te=K.find(q=>q.id===z.startNodeId),ie=K.find(q=>q.id===z.endNodeId);if(!te||!ie)continue;const ye=R(te),ge=R(ie);L.update(z.id,{type:W,startPoint:ye,endPoint:ge})}},T=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W=E.getState().getArrangeNodeGap(),L=k(P),z=new Map(P.map(ge=>[ge.id,ge])),_=P.filter(ge=>!L.some(le=>le.endNodeId===ge.id)),G=_.reduce((ge,q)=>q.x<ge.x||q.x===ge.x&&q.y<ge.y?q:ge,_[0]),V=[..._].sort((ge,q)=>ge.x!==q.x?ge.x-q.x:ge.y-q.y),D=new Set,K=(G==null?void 0:G.x)??P[0].x,te=(G==null?void 0:G.y)??P[0].y,ie=(ge,q,le)=>{if(D.has(ge.id))return{width:0,height:0};D.add(ge.id);const de=L.filter(ae=>ae.startNodeId===ge.id&&ae.endNodeId&&!D.has(ae.endNodeId)).map(ae=>z.get(ae.endNodeId)).filter(ae=>ae!==void 0);n(ge.id,{x:q,y:le});const U=ge.width??Ne.DEFAULT_NODE_WIDTH,Y=ge.height??100;if(de.length===0)return{width:U,height:Y};const X=q+U+W;let Z=le,ne=0;for(const ae of de){const me=ie(ae,X,Z),he=ae.height??100;Z+=Math.max(he,me.height)+W,ne=Math.max(ne,me.width)}const se=Z-le-W;return{width:U+W+ne,height:Math.max(Y,se)}};let ye=te;for(const ge of V){const q=ie(ge,K,ye),le=ge.height??100;ye+=Math.max(le,q.height)+W}A(L,z,"TreeZShape")},[n]),O=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W=E.getState().getArrangeNodeGap(),L=k(P),z=new Map(P.map(ge=>[ge.id,ge])),_=P.filter(ge=>!L.some(le=>le.endNodeId===ge.id)),G=_.reduce((ge,q)=>q.x<ge.x||q.x===ge.x&&q.y<ge.y?q:ge,_[0]),V=[..._].sort((ge,q)=>ge.x!==q.x?ge.x-q.x:ge.y-q.y),D=new Set,K=(G==null?void 0:G.x)??P[0].x,te=(G==null?void 0:G.y)??P[0].y,ie=(ge,q,le)=>{if(D.has(ge.id))return{width:0,height:0};D.add(ge.id);const de=L.filter(ae=>ae.startNodeId===ge.id&&ae.endNodeId&&!D.has(ae.endNodeId)).map(ae=>z.get(ae.endNodeId)).filter(ae=>ae!==void 0);n(ge.id,{x:q,y:le});const U=ge.width??Ne.DEFAULT_NODE_WIDTH,Y=ge.height??100;if(de.length===0)return{width:U,height:Y};const X=le+Y+W;let Z=q,ne=0;for(const ae of de){const me=ie(ae,Z,X),he=ae.width??Ne.DEFAULT_NODE_WIDTH;Z+=Math.max(he,me.width)+W,ne=Math.max(ne,me.height)}const se=Z-q-W;return{width:Math.max(U,se),height:Y+W+ne}};let ye=K;for(const ge of V){const q=ie(ge,ye,te),le=ge.width??Ne.DEFAULT_NODE_WIDTH;ye+=Math.max(le,q.width)+W}A(L,z,"TreeLStep")},[n]),$=(j,P)=>{const W=[...j].sort((G,V)=>G.y-V.y),L=[];let z=[],_=null;for(const G of W)_===null||Math.abs(G.y-_)<=P?(z.push(G),_===null&&(_=G.y)):(L.push(z),z=[G],_=G.y);return z.length>0&&L.push(z),L},B=(j,P)=>{const W=[...j].sort((G,V)=>G.x-V.x),L=[];let z=[],_=null;for(const G of W)_===null||Math.abs(G.x-_)<=P?(z.push(G),_===null&&(_=G.x)):(L.push(z),z=[G],_=G.x);return z.length>0&&L.push(z),L},H=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W=E.getState().getCycleRowBuffer(),L=$(P,W);if(L.length<2)return;const z=L.map(G=>Math.min(...G.map(V=>V.y)));[L[L.length-1],...L.slice(0,-1)].forEach((G,V)=>{const D=z[V],K=Math.min(...G.map(ie=>ie.y)),te=D-K;for(const ie of G)n(ie.id,{y:ie.y+te})})},[n]),M=p.useCallback(j=>{const P=c(j);if(P.length<2)return;l(P);const W=E.getState().getCycleRowBuffer(),L=B(P,W);if(L.length<2)return;const z=L.map(G=>Math.min(...G.map(V=>V.x)));[L[L.length-1],...L.slice(0,-1)].forEach((G,V)=>{const D=z[V],K=Math.min(...G.map(ie=>ie.x)),te=D-K;for(const ie of G)n(ie.id,{x:ie.x+te})})},[n]);return{arrangeVertically:d,arrangeVerticallyAlignLeft:u,arrangeVerticallyAlignRight:h,arrangeHorizontally:f,arrangeHorizontallyAlignTop:g,arrangeHorizontallyAlignBottom:w,arrangeGrid:y,arrangeMasonry:v,cleanUp:C,arrangeByArrowsVertical:T,arrangeByArrowsHorizontal:O,cycleRowsHorizontal:H,cycleColumnsVertical:M,sortNodes:b,sortNodesAsc:S,sortNodesDesc:I,sortKey:o,setSortKey:r,sortableKeys:Gd,selectedNodes:a.current}}function Ux({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a,sortableKeys:i}){const c=s==="record",l=d=>{o(d==="asc"?"sort:asc":"sort:desc",{sortKey:r.sortKey})};return t.jsxs("div",{"data-test":"sort-action-section",children:[t.jsxs("div",{className:ve("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",c&&n&&"bg-primary/10 border border-primary",!c&&"hover:bg-accent"),"data-test":"sort-action-row",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[t.jsxs(gt,{value:r.sortKey,onValueChange:d=>a({sortKey:d}),children:[t.jsx(ft,{className:"h-6 w-[90px] text-xs px-2","data-test":"sort-key-selector",children:t.jsx(mt,{})}),t.jsx(xt,{children:i.map(d=>t.jsx(Ke,{value:d,"data-test":"sort-key-option",children:$c[d]},d))})]}),t.jsx(ee,{variant:"outline",size:"icon",className:ve("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:asc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("asc")},title:"Sort ascending","data-test":"sort-asc-button",children:t.jsx(On,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"outline",size:"icon",className:ve("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:desc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("desc")},title:"Sort descending","data-test":"sort-desc-button",children:t.jsx(Ln,{className:"h-3 w-3"})})]})]}),t.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 text-xs text-muted-foreground hover:bg-accent rounded-sm cursor-pointer","data-test":"sort-by-last-arrange-row",children:[t.jsx(We,{checked:r.sortByLastArrange,onCheckedChange:d=>a({sortByLastArrange:d===!0}),className:"h-3.5 w-3.5","data-test":"sort-by-last-arrange-checkbox"}),t.jsxs("span",{children:["By last arranged: ",r.lastArrangeOption||"none"]})]})]})}class Gx{constructor(s,n){Fe(this,"namespace","canvas.arrange");this.hooks=s,this.storeActions=n}getActions(){const s=this.hooks.sortableKeys;return[{id:"vertical",label:"Arrange vertically",category:"Vertical",icon:t.jsx(uo,{className:"h-3.5 w-3.5"}),subActions:[{id:"vertical:left",icon:t.jsx(Wn,{className:"h-3 w-3"}),title:"Align left"},{id:"vertical:right",icon:t.jsx(Hn,{className:"h-3 w-3"}),title:"Align right"}]},{id:"horizontal",label:"Arrange horizontally",category:"Horizontal",icon:t.jsx(xs,{className:"h-3.5 w-3.5"}),subActions:[{id:"horizontal:top",icon:t.jsx(ur,{className:"h-3 w-3"}),title:"Align top"},{id:"horizontal:bottom",icon:t.jsx(hr,{className:"h-3 w-3"}),title:"Align bottom"}]},{id:"grid",label:"Grid",category:"Layout",icon:t.jsx(Bn,{className:"h-3.5 w-3.5"})},{id:"masonry",label:"Masonry",category:"Layout",icon:t.jsx(ll,{className:"h-3.5 w-3.5"})},{id:"cleanup",label:"Clean up",category:"Layout",icon:t.jsx(Pn,{className:"h-3.5 w-3.5"})},{id:"groupByArrows",label:"Group by Arrows",category:"Layout",icon:t.jsx(pr,{className:"h-3.5 w-3.5"}),subActions:[{id:"groupByArrows:vertical",icon:t.jsx(uo,{className:"h-3 w-3"}),title:"Vertical"},{id:"groupByArrows:horizontal",icon:t.jsx(xs,{className:"h-3 w-3"}),title:"Horizontal"}]},{id:"cycle",label:"Cycle",category:"Layout",icon:t.jsx(gr,{className:"h-3.5 w-3.5"}),subActions:[{id:"cycle:horizontal",icon:t.jsx(uo,{className:"h-3 w-3"}),title:"Cycle Rows"},{id:"cycle:vertical",icon:t.jsx(xs,{className:"h-3 w-3"}),title:"Cycle Columns"}]},{id:"sort:asc",label:"Sort",category:"Sort",icon:t.jsx(gh,{className:"h-3.5 w-3.5"}),params:[{name:"sortKey",type:"select",label:"Sort by",default:"createdAt",options:Object.entries($c).map(([n,o])=>({value:n,label:o}))}],customRender:n=>t.jsx(Ux,{...n,sortableKeys:s})}]}getConfig(){return{nodeGap:this.storeActions.getArrangeNodeGap(),gridColumns:this.storeActions.getArrangeGridColumns(),gridRows:this.storeActions.getArrangeGridRows(),sortByLastArrange:this.storeActions.getSortByLastArrange(),sortKey:this.hooks.sortKey,lastArrangeOption:this.storeActions.getLastArrangeOption()}}setConfig(s){s.nodeGap!==void 0&&this.storeActions.setArrangeNodeGap(s.nodeGap),s.gridColumns!==void 0&&this.storeActions.setArrangeGridColumns(s.gridColumns),s.gridRows!==void 0&&this.storeActions.setArrangeGridRows(s.gridRows),s.sortByLastArrange!==void 0&&this.storeActions.setSortByLastArrange(s.sortByLastArrange),s.sortKey!==void 0&&this.hooks.setSortKey(s.sortKey)}execute(s,n){n!=null&&n.sortKey&&this.hooks.setSortKey(n.sortKey);const o={vertical:"Arrange vertically","vertical:left":"Arrange vertically (left)","vertical:right":"Arrange vertically (right)",horizontal:"Arrange horizontally","horizontal:top":"Arrange horizontally (top)","horizontal:bottom":"Arrange horizontally (bottom)",grid:"Grid",masonry:"Masonry",cleanup:"Clean up",groupByArrows:"Group by Arrows (vertical)","groupByArrows:vertical":"Group by Arrows (vertical)","groupByArrows:horizontal":"Group by Arrows (horizontal)",cycle:"Cycle (horizontal)","cycle:horizontal":"Cycle (horizontal)","cycle:vertical":"Cycle (vertical)"};o[s]&&this.storeActions.setLastArrangeOption(o[s]);const r=a=>{var i;if(this.storeActions.getSortByLastArrange()){const c=this.storeActions.getLastArrangeOption();if(c){const l={"Arrange vertically":this.hooks.arrangeVertically,"Arrange vertically (left)":this.hooks.arrangeVerticallyAlignLeft,"Arrange vertically (right)":this.hooks.arrangeVerticallyAlignRight,"Arrange horizontally":this.hooks.arrangeHorizontally,"Arrange horizontally (top)":this.hooks.arrangeHorizontallyAlignTop,"Arrange horizontally (bottom)":this.hooks.arrangeHorizontallyAlignBottom,Grid:this.hooks.arrangeGrid,Masonry:this.hooks.arrangeMasonry,"Clean up":this.hooks.cleanUp,"Group by Arrows (vertical)":this.hooks.arrangeByArrowsVertical,"Group by Arrows (horizontal)":this.hooks.arrangeByArrowsHorizontal,"Cycle (horizontal)":this.hooks.cycleRowsHorizontal,"Cycle (vertical)":this.hooks.cycleColumnsVertical};(i=l[c])==null||i.call(l)}}a==="asc"?this.hooks.sortNodesAsc():this.hooks.sortNodesDesc()};switch(s){case"vertical":this.hooks.arrangeVertically();break;case"vertical:left":this.hooks.arrangeVerticallyAlignLeft();break;case"vertical:right":this.hooks.arrangeVerticallyAlignRight();break;case"horizontal":this.hooks.arrangeHorizontally();break;case"horizontal:top":this.hooks.arrangeHorizontallyAlignTop();break;case"horizontal:bottom":this.hooks.arrangeHorizontallyAlignBottom();break;case"grid":this.hooks.arrangeGrid();break;case"masonry":this.hooks.arrangeMasonry();break;case"cleanup":this.hooks.cleanUp();break;case"groupByArrows":case"groupByArrows:vertical":this.hooks.arrangeByArrowsVertical();break;case"groupByArrows:horizontal":this.hooks.arrangeByArrowsHorizontal();break;case"cycle":case"cycle:horizontal":this.hooks.cycleRowsHorizontal();break;case"cycle:vertical":this.hooks.cycleColumnsVertical();break;case"sort:asc":r("asc");break;case"sort:desc":r("desc");break;default:console.warn(`Unknown action: ${s}`)}}executePreset(s){const o=this.storeActions.getArrangePresets().find(r=>r.id===s);o&&(this.storeActions.applyArrangePreset(s),this.execute(o.config.arrangeMode))}}function Zl(){const e=Vx(),s=F(v=>v.getArrangeNodeGap),n=F(v=>v.setArrangeNodeGap),o=F(v=>v.getArrangeGridColumns),r=F(v=>v.setArrangeGridColumns),a=F(v=>v.getArrangeGridRows),i=F(v=>v.setArrangeGridRows),c=F(v=>v.getSortByLastArrange),l=F(v=>v.setSortByLastArrange),d=F(v=>v.getLastArrangeOption),u=F(v=>v.setLastArrangeOption),h=F(v=>v.getCycleRowBuffer),f=F(v=>v.setCycleRowBuffer),g=F(v=>v.getArrangePresets),w=F(v=>v.applyArrangePreset),m=p.useMemo(()=>({arrangeVertically:e.arrangeVertically,arrangeVerticallyAlignLeft:e.arrangeVerticallyAlignLeft,arrangeVerticallyAlignRight:e.arrangeVerticallyAlignRight,arrangeHorizontally:e.arrangeHorizontally,arrangeHorizontallyAlignTop:e.arrangeHorizontallyAlignTop,arrangeHorizontallyAlignBottom:e.arrangeHorizontallyAlignBottom,arrangeGrid:e.arrangeGrid,arrangeMasonry:e.arrangeMasonry,cleanUp:e.cleanUp,arrangeByArrowsVertical:e.arrangeByArrowsVertical,arrangeByArrowsHorizontal:e.arrangeByArrowsHorizontal,cycleRowsHorizontal:e.cycleRowsHorizontal,cycleColumnsVertical:e.cycleColumnsVertical,sortNodesAsc:e.sortNodesAsc,sortNodesDesc:e.sortNodesDesc,sortKey:e.sortKey,setSortKey:e.setSortKey,sortableKeys:e.sortableKeys}),[e.arrangeVertically,e.arrangeVerticallyAlignLeft,e.arrangeVerticallyAlignRight,e.arrangeHorizontally,e.arrangeHorizontallyAlignTop,e.arrangeHorizontallyAlignBottom,e.arrangeGrid,e.arrangeMasonry,e.cleanUp,e.arrangeByArrowsVertical,e.arrangeByArrowsHorizontal,e.cycleRowsHorizontal,e.cycleColumnsVertical,e.sortNodesAsc,e.sortNodesDesc,e.sortKey,e.setSortKey,e.sortableKeys]),x=p.useMemo(()=>({getArrangeNodeGap:s,setArrangeNodeGap:n,getArrangeGridColumns:o,setArrangeGridColumns:r,getArrangeGridRows:a,setArrangeGridRows:i,getSortByLastArrange:c,setSortByLastArrange:l,getLastArrangeOption:()=>d()??void 0,setLastArrangeOption:u,getCycleRowBuffer:h,setCycleRowBuffer:f,getArrangePresets:g,applyArrangePreset:w}),[s,n,o,r,a,i,c,l,d,u,h,f,g,w]),y=p.useMemo(()=>new Gx(m,x),[m,x]);return p.useEffect(()=>(it.register("arrange",{name:"Arrange",getActions:()=>y.getActions()}),rt.register("arrange",y),()=>{it.unregister("arrange"),rt.unregister("arrange")}),[y]),y}const Yx=[],Kx=[];function Xx({currentConfig:e,onConfigChange:s,facade:n,onExecuteArrange:o,canExecute:r}){const a=p.useCallback((c,l)=>{s({arrangeMode:c}),l!=null&&l.sortKey},[s]),i=p.useMemo(()=>({nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,sortByLastArrange:e.sortByLastArrange,sortKey:n.getConfig().sortKey,lastArrangeOption:n.getConfig().lastArrangeOption}),[e,n]);return t.jsxs("div",{className:"space-y-2","data-test":"arrange-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"arrange-action-selector",children:t.jsx(zo,{facade:n,mode:"record",selectedActionId:e.arrangeMode,onActionSelect:a,configOverride:i,onConfigChange:c=>{c.nodeGap!==void 0&&s({nodeGap:c.nodeGap}),c.gridColumns!==void 0&&s({gridColumns:c.gridColumns}),c.sortByLastArrange!==void 0&&s({sortByLastArrange:c.sortByLastArrange})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1","data-test":"arrange-config-section",children:[t.jsx(Nr,{nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,onNodeGapChange:c=>s({nodeGap:c}),onGridColumnsChange:c=>s({gridColumns:c}),onGridRowsChange:c=>s({gridRows:c}),compact:!0,showRows:!0}),t.jsxs(ee,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(e.arrangeMode),disabled:!r,"data-test":"arrange-execute-button",children:[t.jsx(st,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function qx({isVisible:e,onClose:s,triggerPosition:n,onArrangeAction:o,onPresetApplied:r}){const[a,i]=p.useState(!1),[c,l]=p.useState(0),d=p.useRef({currentConfig:null,isEditingPreset:!1}),u=Zl(),h=p.useCallback(D=>{var K,te;return((te=(K=D.preferences)==null?void 0:K.arrangePresets)==null?void 0:te.presets)??Yx},[]),f=F(h),g=F(D=>{var K,te;return((te=(K=D.preferences)==null?void 0:K.arrangePresets)==null?void 0:te.favoriteIds)??Kx}),w=F(D=>{var K,te;return((te=(K=D.preferences)==null?void 0:K.arrangePresets)==null?void 0:te.activePresetId)??null}),m=F(D=>{var K,te;return((te=(K=D.preferences)==null?void 0:K.arrangeButton)==null?void 0:te.nodeGap)??Ne.ARRANGE_NODE_GAP}),x=F(D=>{var K,te;return((te=(K=D.preferences)==null?void 0:K.arrangeButton)==null?void 0:te.gridColumns)??Ne.ARRANGE_GRID_COLUMNS}),y=F(D=>D.getArrangeGridRows()),v=F(D=>{var K,te;return((te=(K=D.preferences)==null?void 0:K.arrangeButton)==null?void 0:te.sortByLastArrange)??!1}),N=F(D=>D.setArrangeNodeGap),b=F(D=>D.setArrangeGridColumns);F(D=>D.setArrangeGridRows);const S=F(D=>D.setSortByLastArrange),I=F(D=>D.createArrangePreset),C=F(D=>D.updateArrangePreset),k=F(D=>D.duplicateArrangePreset),R=F(D=>D.deleteArrangePreset),A=F(D=>D.renameArrangePreset),T=F(D=>D.applyArrangePreset),O=F(D=>D.toggleArrangePresetFavorite),$=F(D=>D.setActiveArrangePresetId),B=p.useMemo(()=>({getAll:()=>f,getById:D=>f.find(K=>K.id===D),getFavorites:()=>f.filter(D=>g.includes(D.id)),getFavoriteIds:()=>g,getActiveId:()=>w,create:(D,K)=>I(D,K),update:(D,K)=>{C(D,K)},updateConfig:(D,K)=>{const te=f.find(ie=>ie.id===D);te&&C(D,{config:{...te.config,...K}})},duplicate:D=>k(D),delete:D=>{R(D)},rename:(D,K)=>{A(D,K)},reorder:D=>{},apply:D=>{T(D)},setActive:D=>{$(D)},toggleFavorite:D=>{O(D)},isFavorite:D=>g.includes(D)}),[f,g,w,I,C,k,R,A,T,$,O]),H=p.useCallback(()=>({arrangeMode:"vertical",nodeGap:m,gridColumns:x,gridRows:y,sortByLastArrange:v}),[m,x,y,v]),M=p.useCallback(D=>{o&&(o(D),be.success(`Executed ${D} arrange`))},[o]),j=p.useCallback(D=>{o?(requestAnimationFrame(()=>{o(D.config.arrangeMode)}),be.success(`Applied and executed "${D.name}" (${D.config.arrangeMode})`),r&&r(D.id,D.name,()=>{T(D.id),o(D.config.arrangeMode)})):be.success(`Applied preset "${D.name}" settings`)},[o,r,T]),P=p.useCallback(D=>{d.current={currentConfig:D.currentConfig,isEditingPreset:D.isEditingPreset,editingPresetName:D.editingPresetName};const K=te=>{D.onConfigChange(te),d.current.currentConfig&&(d.current={...d.current,currentConfig:{...d.current.currentConfig,...te}}),a&&requestAnimationFrame(()=>{l(ie=>ie+1)}),te.nodeGap!==void 0&&N(te.nodeGap),te.gridColumns!==void 0&&b(te.gridColumns),te.sortByLastArrange!==void 0&&S(te.sortByLastArrange)};return t.jsx(Xx,{...D,onConfigChange:K,facade:u,onExecuteArrange:M,canExecute:!!o})},[u,M,o,N,b,S,a]),W=p.useCallback(()=>{a||l(D=>D+1),i(!a)},[a]),L=p.useCallback(()=>{l(D=>D+1)},[]),z=p.useMemo(()=>t.jsx("button",{className:`p-1 rounded hover:bg-accent transition-colors ${a?"bg-accent text-accent-foreground":""}`,onClick:W,"aria-label":a?"Hide debug panel":"Show debug panel",title:a?"Hide debug panel":"Show debug panel","data-test":"preset-debug-toggle",children:t.jsx(ar,{size:14})}),[a,W]),_=["activePreset","allPresets"],G=p.useMemo(()=>{const D=d.current,K=w?f.find(ie=>ie.id===w):null,te={mode:D.isEditingPreset?"editing":"creating",editingPresetName:D.editingPresetName||null,currentConfig:D.currentConfig,activePreset:K?{id:K.id,name:K.name,config:K.config}:null,allPresets:f.map(ie=>({id:ie.id,name:ie.name,isFavorite:g.includes(ie.id),config:ie.config}))};return Object.fromEntries(Object.entries(te).filter(([ie])=>!_.includes(ie)))},[c,w,f,g]),V=p.useMemo(()=>n?{x:n.x+400,y:n.y}:{x:500,y:100},[n]);return t.jsxs(t.Fragment,{children:[t.jsx(Gl,{isVisible:e,onClose:s,triggerPosition:n,title:"Arrange Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:P,getCurrentConfig:H,presetActions:B,onApplyPreset:j,headerActions:z}),t.jsx(_e,{isVisible:e&&a,onClose:()=>i(!1),title:"Preset Debug",triggerPosition:V,initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:L,"aria-label":"Refresh debug data",title:"Refresh debug data","data-test":"preset-debug-refresh",children:t.jsx(gr,{size:14})}),children:t.jsx("div",{className:"p-3 overflow-auto h-full font-mono text-xs","data-test":"preset-debug-content",children:t.jsx("pre",{className:"whitespace-pre-wrap break-words",children:JSON.stringify(G,null,2)})})})]})}function Zx({isVisible:e,onClose:s,triggerPosition:n}){const o=F(m=>{var x,y;return((y=(x=m.preferences)==null?void 0:x.arrangeButton)==null?void 0:y.nodeGap)??Ne.ARRANGE_NODE_GAP}),r=F(m=>{var x,y;return((y=(x=m.preferences)==null?void 0:x.arrangeButton)==null?void 0:y.gridColumns)??Ne.ARRANGE_GRID_COLUMNS}),a=F(m=>m.getArrangeGridRows()),i=F(m=>m.setArrangeNodeGap),c=F(m=>m.setArrangeGridColumns),l=F(m=>m.setArrangeGridRows),d=F(m=>m.toggleArrangeConfigFavorite),u=F(m=>m.isArrangeConfigFavorite),h=p.useCallback((m,x)=>{const y=u(m,x);d(m,x),be.success(y?"Removed from favorites":"Added to favorites")},[d,u]),f=u("gap",o),g=u("columns",r),w=u("rows",a);return t.jsx(_e,{isVisible:e,onClose:s,title:"Arrange Config",triggerPosition:n,initialSize:{width:280,height:200},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3","data-test":"arrange-config-content",children:t.jsx(Nr,{nodeGap:o,gridColumns:r,gridRows:a,onNodeGapChange:i,onGridColumnsChange:c,onGridRowsChange:l,showFavorites:!0,showRows:!0,isGapFavorite:f,isColumnsFavorite:g,isRowsFavorite:w,onToggleGapFavorite:()=>h("gap",o),onToggleColumnsFavorite:()=>h("columns",r),onToggleRowsFavorite:()=>h("rows",a)})})})}const Jx=[],Qx=[],ew=[],Fi="canvas-arrange-nodes",tw=()=>{const e=Zl(),n=F(P=>De.selectSelectedNodes(P).length)<2,o=F(P=>{var W,L;return((L=(W=P.preferences)==null?void 0:W.arrangePresets)==null?void 0:L.presets)??Jx}),r=F(P=>{var W,L;return((L=(W=P.preferences)==null?void 0:W.arrangePresets)==null?void 0:L.favoriteIds)??ew}),a=p.useMemo(()=>o.filter(P=>r.includes(P.id)),[o,r]),i=F(P=>{var W;return((W=P.preferences)==null?void 0:W.arrangeConfigFavorites)??Qx}),c=F(P=>{var W,L;return((L=(W=P.preferences)==null?void 0:W.arrangeButton)==null?void 0:L.nodeGap)??Ne.ARRANGE_NODE_GAP}),l=F(P=>{var W,L;return((L=(W=P.preferences)==null?void 0:W.arrangeButton)==null?void 0:L.gridColumns)??Ne.ARRANGE_GRID_COLUMNS}),d=F(P=>P.getArrangeGridRows()),u=F(P=>P.setArrangeNodeGap),h=F(P=>P.setArrangeGridColumns),f=F(P=>P.setArrangeGridRows),[g,w]=p.useState(!1),[m,x]=p.useState(),y=p.useRef(null),v=p.useRef(null),[N,b]=p.useState(!1),[S,I]=p.useState(),C=p.useRef(null),k=p.useCallback(()=>{if(y.current){const P=y.current.getBoundingClientRect();x({x:P.left,y:P.bottom+4})}w(!0)},[]),R=p.useCallback(()=>{w(!1)},[]),A=p.useCallback(()=>{if(N)b(!1);else{if(C.current){const P=C.current.getBoundingClientRect();I({x:P.left,y:P.bottom+4})}b(!0)}},[N]),T=p.useCallback(()=>{b(!1)},[]),O=p.useCallback((P,W,L)=>{v.current=L,E.getState().setSegmentedButtonAction(Fi,W,()=>v.current)},[]),$=p.useCallback(P=>{e.execute(P)},[e]),B=p.useCallback(P=>{var z;const W=o.find(_=>_.name===P);if(W)return()=>e.executePreset(W.id);const L=e.getActions();for(const _ of L){if(_.label===P)return()=>e.execute(_.id);const G=(z=_.subActions)==null?void 0:z.find(V=>V.title===P);if(G)return()=>e.execute(G.id)}return null},[o,e]),H=p.useCallback((P,W,L)=>{e.executePreset(P),L(W,()=>e.executePreset(P))},[e]),M=[{width:"180px",actions:[{label:"Arrange Actions",customRender:({registerRepeatAction:P})=>t.jsx(zo,{facade:e,mode:"execute",onActionExecuted:P,categories:["Vertical","Horizontal","Layout"]})}]},{width:"230px",actions:[{label:"Presets",customRender:({registerRepeatAction:P})=>t.jsxs("div",{"data-test":"arrange-presets-section",children:[t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Presets"}),t.jsxs("button",{ref:y,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:k,"data-test":"arrange-presets-button",children:[t.jsx(lr,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),a.length>0&&t.jsxs("div",{className:"px-3 py-1","data-test":"arrange-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"arrange-favorite-presets-grid",children:a.map(W=>t.jsxs(ee,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:L=>{L.stopPropagation(),H(W.id,W.name,P)},title:`Apply & Execute: ${W.name}`,"data-test":"arrange-favorite-preset-button",children:[t.jsx(st,{className:"h-2 w-2 mr-1"}),W.name]},W.id))})]})]})},{label:"Sort Actions",customRender:({registerRepeatAction:P})=>t.jsxs("div",{"data-test":"arrange-sort-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Sort"}),t.jsx(zo,{facade:e,mode:"execute",onActionExecuted:P,categories:["Sort"]})]})},{label:"Config",customRender:()=>{const P=i.filter(_=>_.type==="gap"),W=i.filter(_=>_.type==="columns"),L=i.filter(_=>_.type==="rows"),z=i.length>0;return t.jsxs("div",{"data-test":"arrange-config-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsxs("div",{className:"px-3 py-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Config"}),t.jsx("button",{ref:C,className:"p-0.5 rounded hover:bg-accent",onClick:A,title:"Toggle config popover","data-test":"arrange-config-button",children:t.jsx(Vn,{className:"h-3 w-3 text-muted-foreground"})})]}),z&&t.jsxs("div",{className:"px-3 py-1 space-y-1.5","data-test":"arrange-config-quick-access-section",children:[P.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"200",value:c,onChange:_=>u(Math.max(0,Math.min(200,parseInt(_.target.value)||0))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-gap-input"})]}),W.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-cols-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Cols:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:l,onChange:_=>h(Math.max(1,Math.min(10,parseInt(_.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-cols-input"})]}),L.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Rows:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:d,onChange:_=>f(Math.max(1,Math.min(10,parseInt(_.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-rows-input"})]})]})]})}}]}],j={label:"Arrange",icon:t.jsx(fh,{className:"h-2.5 w-2.5"}),onClick:()=>e.execute("vertical"),disabled:n,disabledTooltip:"Select at least 2 nodes to arrange"};return t.jsxs(t.Fragment,{children:[t.jsx(Ze,{mainAction:j,dropdownColumns:M,variant:"outline",size:"compact",persistenceKey:Fi,facade:e,restoreRepeatAction:B,"data-test":"canvas-arrange-nodes-button"}),t.jsx(qx,{isVisible:g,onClose:R,triggerPosition:m,onArrangeAction:$,onPresetApplied:O}),t.jsx(Zx,{isVisible:N,onClose:T,triggerPosition:S})]})};function Sr(){const e=F(d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.entries)??ks}),s=F(d=>{var u,h;return(h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.lastAction}),n=F(d=>d.getGlobalActionHistory),o=F(d=>d.getGlobalLastAction),r=F(d=>d.clearGlobalActionHistory),a=F(d=>d.executeGlobalLastAction),i=F(d=>d.executeActionById),c=F(d=>d.hasExecutor),l=p.useCallback(d=>i(d.executorId),[i]);return{history:e,lastAction:s,getHistory:n,getLastAction:o,clearHistory:r,executeLastAction:a,executeAction:l,hasExecutor:c}}class sw{fromHistoryEntry(s){if(!s.actionId)return console.warn("ActionReferenceResolver: Cannot create reference without actionId"),null;const n=this.extractFacadeKeyFromSource(s.source);return n?{facadeKey:n,actionId:s.actionId,params:s.params,label:s.label}:(console.warn(`ActionReferenceResolver: Cannot derive facadeKey from source "${s.source}"`),null)}extractFacadeKeyFromSource(s){const n={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(n[s])return n[s];const o=s.split("-");return o.length>=2?o[1]:null}execute(s){const n=rt.get(s.facadeKey);if(!n)return{success:!1,error:`Facade "${s.facadeKey}" not found in registry`};try{return n.execute(s.actionId,s.params),{success:!0}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async executeSequence(s,n){const o=[];for(let r=0;r<s.length;r++){const{action:a,delayMs:i}=s[r],c=Math.max(i,Ne.PRESET_STEP_DELAY_MS);r>0&&await new Promise(d=>setTimeout(d,c));const l=this.execute(a);o.push(l),n==null||n(r,l),l.success||console.warn(`ActionReferenceResolver: Step ${r} failed for "${a.label}": ${l.error}`)}return o}}const nw=new sw,ow=[],aw=[];function Cr(){const e=kt(E,u=>{var h,f;return((f=(h=u.actions)==null?void 0:h.sequencePresets)==null?void 0:f.presets)??ow}),s=kt(E,u=>{var h,f;return((f=(h=u.actions)==null?void 0:h.sequencePresets)==null?void 0:f.favoriteIds)??aw}),n=p.useCallback(u=>E.getState().getSequencePresetById(u),[]),o=p.useCallback((u,h)=>E.getState().createSequencePreset(u,h),[]),r=p.useCallback((u,h)=>{E.getState().updateSequencePreset(u,h)},[]),a=p.useCallback(u=>E.getState().duplicateSequencePreset(u),[]),i=p.useCallback(u=>{E.getState().deleteSequencePreset(u)},[]),c=p.useCallback(u=>{E.getState().toggleSequencePresetFavorite(u)},[]),l=p.useCallback(u=>s.includes(u),[s]),d=p.useCallback(async u=>{const h=E.getState().getSequencePresetById(u);if(!h){console.warn(`useSequencePresets: Preset "${u}" not found`);return}const f=h.steps.map(g=>({action:g.action,delayMs:g.delayMs}));await nw.executeSequence(f)},[]);return{presets:e,favoriteIds:s,getPresetById:n,createPreset:o,updatePreset:r,duplicatePreset:a,deletePreset:i,toggleFavorite:c,isFavorite:l,executePreset:d}}const rw=({presetsButtonRef:e,onOpenPresetsPopover:s,closeDropdown:n,favoritePresets:o,onExecutePreset:r,dataTestPrefix:a,maxFavorites:i=6})=>{const c=()=>{n==null||n(),s()};return t.jsxs("div",{"data-test":"preset-and-quick-access-section",children:[t.jsxs("button",{ref:e,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:c,"data-test":"preset-and-quick-access-presets-button",children:[t.jsx(lr,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),o.length>0&&t.jsxs("div",{className:"px-3 py-1.5 border-t border-border/50 mt-1","data-test":"preset-quick-access-section",children:[t.jsx("div",{className:"text-[10px] text-muted-foreground mb-1.5",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-1","data-test":"preset-favorite-presets-grid",children:o.slice(0,i).map(l=>t.jsxs(ee,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:d=>{d.stopPropagation(),r(l.id,l.name)},title:`Execute: ${l.name}`,"data-test":"preset-favorite-preset-button",children:[t.jsx(st,{className:"h-2.5 w-2.5 mr-1"}),l.name]},l.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},iw=[];function cw(){const e=kt(E,a=>{var i,c;return((c=(i=a.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)??iw}),s=p.useCallback(a=>E.getState().getVisualWorkflowPresetById(a),[]),n=p.useCallback((a,i,c)=>E.getState().createVisualWorkflowPreset(a,i,c),[]),o=p.useCallback((a,i)=>{E.getState().updateVisualWorkflowPreset(a,i)},[]),r=p.useCallback(a=>{E.getState().deleteVisualWorkflowPreset(a)},[]);return{visualWorkflows:e,getPresetById:s,createPreset:n,updatePreset:o,deletePreset:r}}const lw={content:!0,title:!1,id:!1,type:!1,tags:!1},dw={horizontal:"Horizontal",vertical:"Vertical",grid:"Grid",masonry:"Masonry"},uw={GAP:J.arrange.gap,LANE_GAP:J.slice.laneGap,LANE_HEADER_OFFSET:J.slice.laneHeaderOffset,GRID_COLUMNS:J.arrange.gridColumns},{GAP:It,LANE_GAP:hw,LANE_HEADER_OFFSET:kn,GRID_COLUMNS:Ot}=uw,pw=e=>{const s=new Map;for(const n of e)if(n.tags)for(const o of n.tags)s.has(o.title)||s.set(o.title,o);return Array.from(s.values()).sort((n,o)=>n.title.localeCompare(o.title))},jr=(e,s)=>{var n;return((n=e.tags)==null?void 0:n.some(o=>o.title===s))??!1},Jl=(e,s)=>e.filter(n=>jr(n,s)),Ql=100,ed=200,as=e=>e.height??Ql,zs=e=>e.width??ed,gw=(e,s)=>{if(e.length===0)return Ql;switch(s){case"horizontal":return Math.max(...e.map(as));case"vertical":return e.reduce((o,r)=>o+as(r),0)+(e.length-1)*It;case"grid":{const n=Math.ceil(e.length/Ot);let o=0;for(let r=0;r<n;r++){const a=r*Ot,i=Math.min(a+Ot,e.length),c=e.slice(a,i),l=Math.max(...c.map(as));o+=l}return o+(n-1)*It}case"masonry":{const n=Array(Ot).fill(0);return e.forEach(o=>{const r=n.indexOf(Math.min(...n));n[r]+=as(o)+It}),Math.max(...n)-It}}},fw=(e,s,n,o)=>{const r=[];switch(o){case"horizontal":{let a=s;e.forEach(i=>{r.push({id:i.id,x:a,y:n+kn}),a+=zs(i)+It});break}case"vertical":{let a=n+kn;e.forEach(i=>{r.push({id:i.id,x:s,y:a}),a+=as(i)+It});break}case"grid":{const a=Math.ceil(e.length/Ot),i=[n+kn];for(let l=0;l<a-1;l++){const d=l*Ot,u=Math.min(d+Ot,e.length),h=e.slice(d,u),f=Math.max(...h.map(as));i.push(i[l]+f+It)}const c=Math.max(...e.map(zs));e.forEach((l,d)=>{const u=Math.floor(d/Ot);r.push({id:l.id,x:s+d%Ot*(c+It),y:i[u]})});break}case"masonry":{const a=Math.max(...e.map(zs)),i=Array(Ot).fill(0);e.forEach(c=>{const l=i.indexOf(Math.min(...i));r.push({id:c.id,x:s+l*(a+It),y:n+kn+i[l]}),i[l]+=as(c)+It});break}}return r},mw=(e,s)=>{if(e.length===0)return ed;switch(s){case"horizontal":return e.reduce((o,r)=>o+zs(r),0)+(e.length-1)*It;case"vertical":return Math.max(...e.map(zs));case"grid":case"masonry":{const n=Math.max(...e.map(zs)),o=Math.min(e.length,Ot);return o*n+(o-1)*It}}},xw=(e,s,n="horizontal")=>{if(s.length===0)return{updates:[],laneCount:0,nodesPerLane:new Map,lanes:[]};const o=[...s].sort(),r=[],a=new Map,i=[],c=new Set,l=Math.min(...e.map(h=>h.x));let d=0;o.forEach(h=>{const f=Jl(e,h).filter(x=>!c.has(x.id));if(f.length===0)return;const g=fw(f,l,d,n);r.push(...g),f.forEach(x=>c.add(x.id)),a.set(h,f.length);const w=gw(f,n),m=mw(f,n);i.push({tagTitle:h,nodeIds:f.map(x=>x.id),bounds:{x:l,y:d,width:m,height:w+kn}}),d+=w+hw});const u=e.filter(h=>!c.has(h.id));if(u.length>0){const h=[...u].sort((g,w)=>g.y-w.y);let f=d;for(const g of h)r.push({id:g.id,x:l,y:f}),f+=as(g)+It}return{updates:r,laneCount:o.length,nodesPerLane:a,lanes:i}},ww=(e,s)=>{const n=new Map;for(const o of s){const r=e.filter(a=>jr(a,o.title)).length;n.set(o.title,r)}return n},yw={split:{whitespace:{facadeKey:"split",actionId:"byWhitespace"},line:{facadeKey:"split",actionId:"byLine"},paragraph:{facadeKey:"split",actionId:"byParagraph"},comma:{facadeKey:"split",actionId:"byComma"},period:{facadeKey:"split",actionId:"byPeriod"}},arrange:{horizontal:{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:top":{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:center":{facadeKey:"arrange",actionId:"horizontal:center"},"horizontal:bottom":{facadeKey:"arrange",actionId:"horizontal:bottom"},vertical:{facadeKey:"arrange",actionId:"vertical:left"},"vertical:left":{facadeKey:"arrange",actionId:"vertical:left"},"vertical:center":{facadeKey:"arrange",actionId:"vertical:center"},"vertical:right":{facadeKey:"arrange",actionId:"vertical:right"},grid:{facadeKey:"arrange",actionId:"grid"},masonry:{facadeKey:"arrange",actionId:"masonry"}},align:{left:{facadeKey:"alignment",actionId:"left"},center:{facadeKey:"alignment",actionId:"center"},right:{facadeKey:"alignment",actionId:"right"},top:{facadeKey:"alignment",actionId:"top"},middle:{facadeKey:"alignment",actionId:"middle"},bottom:{facadeKey:"alignment",actionId:"bottom"}},group:{create:{facadeKey:"grouping",actionId:"group"},ungroup:{facadeKey:"grouping",actionId:"ungroup"}},collapse:{collapse:{facadeKey:"collapse",actionId:"collapse"},expand:{facadeKey:"collapse",actionId:"expand"}}};function vw(e,s){const n=yw[e];if(!n)return null;const o=n[s];return o||null}function bw(e){return e.type==="GROUP"&&jr(e,"workflow")}function Nw(e){if(e.type===ce.WORKFLOW_STEP){const o=e.data;if(!(o!=null&&o.stepType))return console.warn(`VisualWorkflowParser: WORKFLOW_STEP node ${e.id} has no stepType configured`),null;const a={toolbarAction:"toolbarAction",if:"if",tagUpdate:"nodeUpdate",loop:"loop",source:"source"}[o.stepType];if(!a)return console.warn(`VisualWorkflowParser: Unknown stepType "${o.stepType}" in node ${e.id}`),null;let i=o.config;return{nodeId:e.id,order:0,stepType:a,config:i||{},label:e.title||o.stepType}}const s=(e.title||"").trim().toLowerCase();if(!s)return null;const n=s.match(/^([^:]+):\s*(.+)$/);if(n){const[,o,r]=n,a=o.trim(),i=r.trim();if(a==="if")return{nodeId:e.id,order:0,stepType:"if",config:{condition:i},label:`If: ${i}`};if(a==="tag")return{nodeId:e.id,order:0,stepType:"nodeUpdate",config:{simpleFieldUpdates:[{field:"tags",template:i}]},label:`Tag: ${i}`};const c=vw(a,i);return c?{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:c.facadeKey,actionId:c.actionId,params:c.params||{}},label:`${a}: ${i}`}:{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:a,actionId:i,params:{}},label:`${a}: ${i}`}}return s==="loop"?{nodeId:e.id,order:0,stepType:"loop",config:{},label:"Loop"}:s==="source"?{nodeId:e.id,order:0,stepType:"source",config:{},label:"Source"}:(console.warn(`VisualWorkflowParser: Unknown step pattern "${s}"`),null)}function Sw(e,s){const n=new Map,o=new Map;e.forEach(c=>{n.set(c.id,[]),o.set(c.id,0)}),s.forEach(c=>{if(c.startNodeId&&c.endNodeId){const l=n.get(c.startNodeId)||[];l.push(c.endNodeId),n.set(c.startNodeId,l),o.set(c.endNodeId,(o.get(c.endNodeId)||0)+1)}});const r=[];o.forEach((c,l)=>{c===0&&r.push(l)});const a=[],i=new Map(e.map(c=>[c.id,c]));for(;r.length>0;){const c=r.shift(),l=i.get(c);l&&a.push(l),(n.get(c)||[]).forEach(u=>{const h=(o.get(u)||0)-1;o.set(u,h),h===0&&r.push(u)})}return a.length!==e.length?(console.warn("VisualWorkflowParser: Cycle detected in workflow graph"),e):a}function Ga(e,s,n){const o=e.data,r=(o==null?void 0:o.childNodeIds)||[];if(r.length===0)return[];const a=s.filter(d=>r.includes(d.id)),i=n.filter(d=>d.startNodeId&&d.endNodeId&&r.includes(d.startNodeId)&&r.includes(d.endNodeId)),c=Sw(a,i),l=[];return c.forEach((d,u)=>{const h=Nw(d);h&&(h.order=u+1,l.push(h))}),l}function Cw(e){return e.map(s=>({id:`visual_step_${s.nodeId}`,label:s.label,order:s.order,stepType:s.stepType,config:s.config}))}function td(e,s){return{id:`${e}_orchestration`,type:ce.WORKFLOW_ORCHESTRATION,x:0,y:0,width:200,height:100,title:"Visual Workflow",content:"",data:{nodeType:"workflowOrchestration",parameters:{rows:s}}}}async function jw(e,s,n,o=[]){try{const r=Ga(e,s,n);if(r.length===0)return{success:!1,error:"No workflow steps found in group",nodeUpdates:[]};const a=Cw(r),i=td(e.id,a),c=[i,...s],l=n,d=new Zs;d.loadWorkflow(c,l);const u=await d.executeWorkflow(i.id,o),h=u.nodeUpdates||[];return{success:u.success,error:u.error,nodeUpdates:h,executionId:u.executionId,duration:u.duration}}catch(r){return console.error("VisualWorkflowAdapter: Execution error:",r),{success:!1,error:r instanceof Error?r.message:String(r),nodeUpdates:[]}}}function kw(e){return e.map((s,n)=>({id:`preset_step_${s.id}`,label:s.label,order:n,stepType:s.stepType,config:s.config}))}async function Aw(e){try{const s=E.getState(),n=s.projectCanvas.getActive();if(!n)return{success:!1,error:"No active canvas",nodeUpdates:[]};const o=n.coreState.selectedNodes,r=n.coreState.nodes,a=n.coreState.arrows;if(e.steps.length===0)return{success:!1,error:"No workflow steps in preset",nodeUpdates:[]};const i=kw(e.steps),c=td(`preset_${e.id}`,i),l=[c,...r],d=a,u=new Zs;u.loadWorkflow(l,d);const h=await u.executeWorkflow(c.id,o),f=h.nodeUpdates||[];return h.success&&f.length>0&&f.forEach(({nodeId:g,updates:w})=>{s.updateNode(g,w)}),{success:h.success,error:h.error,nodeUpdates:f,executionId:h.executionId,duration:h.duration}}catch(s){return console.error("VisualWorkflowAdapter: Preset execution error:",s),{success:!1,error:s instanceof Error?s.message:String(s),nodeUpdates:[]}}}const Iw=({onStartRecording:e,onStartSelection:s,isRecording:n=!1,capturedStepsCount:o=0,onStopRecording:r,onCancelRecording:a,className:i})=>{const{presets:c,executePreset:l,deletePreset:d,duplicatePreset:u,updatePreset:h,toggleFavorite:f,isFavorite:g}=Cr(),{visualWorkflows:w,deletePreset:m,updatePreset:x}=cw(),[y,v]=p.useState(null),[N,b]=p.useState([]),[S,I]=p.useState(void 0),C=p.useRef({x:0,y:0});p.useEffect(()=>{const D=K=>{C.current={x:K.clientX,y:K.clientY}};return window.addEventListener("mousemove",D),()=>window.removeEventListener("mousemove",D)},[]);const k=p.useCallback(async D=>{const K=c.find(te=>te.id===D);K&&(await l(D),E.getState().setSegmentedButtonAction("sequence-presets-panel",K.name,()=>()=>{l(D)}))},[l,c]),R=p.useCallback(D=>{I({...C.current}),v(D),b(D.steps.map(K=>({...K})))},[]),A=p.useCallback(()=>{y&&h(y.id,{steps:N}),v(null),b([])},[y,N,h]),T=p.useCallback(()=>{v(null),b([])},[]),O=p.useCallback(D=>{u(D)},[u]),$=p.useCallback(D=>{const K=E.getState();K.projectCanvas.switch(D.canvasId),setTimeout(()=>{K.scrollToNode(D.groupNodeId,500)},100)},[]),[B,H]=p.useState(null),M=p.useCallback(async D=>{if(!B){H(D.id);try{const K=await Aw(D);K.success?be.success(`Executed: ${D.name}`,{description:`${K.nodeUpdates.length} node${K.nodeUpdates.length!==1?"s":""} updated`,duration:3e3}):be.error(`Failed: ${D.name}`,{description:K.error||"Unknown error",duration:4e3})}catch(K){be.error("Execution failed",{description:K instanceof Error?K.message:"Unknown error",duration:4e3})}finally{H(null)}}},[B]),j=p.useMemo(()=>c.map(D=>({id:D.id,label:D.name,data:D})),[c]),P=p.useCallback(D=>{console.log("Preset reorder:",D.map(K=>K.id))},[]),W=p.useCallback(D=>[{id:"execute",icon:t.jsx(st,{className:"h-3 w-3"}),title:"Execute preset",onClick:()=>k(D.id)}],[k]),L=p.useCallback(D=>{const K=D.data,te=g(K.id);return[{id:"toggle-favorite",label:te?"Remove from favorites":"Add to favorites",icon:t.jsx(Bs,{className:ve("h-4 w-4 mr-2",te&&"fill-yellow-400 text-yellow-400")}),onClick:()=>f(K.id)},{id:"rename",label:"Rename",icon:t.jsx(Ks,{className:"h-4 w-4 mr-2"}),onClick:()=>{const ie=window.prompt("Rename preset:",K.name);ie&&ie.trim()&&ie!==K.name&&h(K.id,{name:ie.trim()})}},{id:"edit-steps",label:"Edit steps",icon:t.jsx(Jc,{className:"h-4 w-4 mr-2"}),onClick:()=>R(K)},{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>O(D.id)}]},[O,R,h,f,g]),z=p.useMemo(()=>N.map((D,K)=>({id:D.id,label:`${K+1}. ${D.action.label}`,data:D})),[N]),_=p.useCallback(D=>{const K=D.map(te=>te.data);b(K)},[]),G=p.useCallback(D=>{b(K=>K.filter(te=>te.id!==D))},[]),V=p.useCallback((D,K,te,ie)=>{const ye=D.data;return t.jsxs("div",{"data-test":"edit-step-item",children:[ie,t.jsxs("div",{className:"pl-8 -mt-1 mb-1 text-[10px] text-muted-foreground",children:[ye.action.facadeKey," → ",ye.action.actionId]})]})},[]);return t.jsxs("div",{className:ve("flex flex-col h-full",i),"data-test":"sequence-presets-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"presets-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:n?t.jsxs(t.Fragment,{children:[t.jsx(Ko,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",o,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(Dn,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[c.length+w.length," preset",c.length+w.length!==1?"s":""]})]})}),n?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ee,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:D=>r==null?void 0:r({x:D.clientX,y:D.clientY}),"data-test":"presets-stop-recording",children:"Stop"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:a,"data-test":"presets-cancel-recording",children:"Cancel"})]}):t.jsxs(vo,{children:[t.jsx(bo,{asChild:!0,children:t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs","data-test":"presets-create-button",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"}),"New"]})}),t.jsxs(No,{align:"end",style:{zIndex:Ee.draggablePopoverDropdown},children:[t.jsx(Rt,{onClick:e,"data-test":"presets-create-from-recording",children:"Record actions"}),t.jsx(Rt,{onClick:s,"data-test":"presets-create-from-selection",children:"Select from history"})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"presets-list",children:c.length===0&&w.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(Dn,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No presets yet"}),t.jsx("span",{className:"text-xs text-center",children:"Create a preset to save action sequences"})]}):t.jsxs(t.Fragment,{children:[c.length>0&&t.jsx(qs,{data:j,onDelete:d,onReorder:P,enableEdit:!1,enableDelete:!0,enableDrag:!0,quickActions:W,moreOptionsItems:L,dropdownZIndex:Ee.draggablePopoverDropdown,className:"py-1"}),w.length>0&&t.jsxs("div",{"data-test":"visual-workflow-presets",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-muted/50 border-y border-border/50",children:[t.jsx(Ns,{className:"h-3 w-3 text-muted-foreground"}),t.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wider",children:["Visual Workflows (",w.length,")"]})]}),t.jsx("div",{className:"py-1",children:w.map(D=>t.jsxs("div",{className:ve("group flex items-center gap-2 px-3 py-2 hover:bg-muted/50 transition-colors",D.sourceLocation&&"cursor-pointer"),onClick:()=>{D.sourceLocation&&$(D.sourceLocation)},"data-test":"visual-workflow-item",children:[t.jsx(Ns,{className:"h-3.5 w-3.5 text-primary/70 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm font-medium truncate",children:D.name}),t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:[D.steps.length," step",D.steps.length!==1?"s":""," • ",D.steps.map(K=>K.stepType).filter((K,te,ie)=>ie.indexOf(K)===te).join(", ")]})]}),t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx(ee,{variant:"ghost",size:"sm",className:ve("h-6 w-6 p-0",B===D.id&&"text-primary animate-pulse"),onClick:K=>{K.stopPropagation(),M(D)},disabled:B!==null,title:B===D.id?"Executing...":"Execute workflow","data-test":"visual-workflow-execute-button",children:t.jsx(st,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:K=>{K.stopPropagation();const te=window.prompt("Rename workflow:",D.name);te&&te.trim()&&te!==D.name&&x(D.id,{name:te.trim()})},title:"Rename","data-test":"visual-workflow-rename-button",children:t.jsx(Ks,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:text-destructive",onClick:K=>{K.stopPropagation(),m(D.id)},title:"Delete","data-test":"visual-workflow-delete-button",children:t.jsx(vt,{className:"h-3 w-3"})})]})]},D.id))})]})]})}),t.jsx(_e,{isVisible:!!y,onClose:T,title:`Edit Steps: ${(y==null?void 0:y.name)??""}`,initialSize:{width:360,height:380},triggerPosition:S,resizable:!0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"edit-steps-popover",children:[t.jsxs("div",{className:"flex-1 px-4 py-2 overflow-y-auto",children:[t.jsxs(Te,{className:"text-xs text-muted-foreground mb-2 block",children:["Steps (",N.length,") - drag to reorder"]}),N.length===0?t.jsx("div",{className:"text-xs text-muted-foreground text-center py-4",children:"No steps in this preset"}):t.jsx(qs,{data:z,onDelete:G,onReorder:_,enableEdit:!1,enableDelete:!0,enableDrag:!0,renderNode:V,dropdownZIndex:Ee.draggablePopoverDropdown+10,className:"text-xs"})]}),t.jsxs("div",{className:"px-4 py-3 border-t bg-muted/20 flex justify-end gap-2",children:[t.jsx(ee,{variant:"outline",size:"sm",onClick:T,"data-test":"edit-steps-cancel",children:"Cancel"}),t.jsx(ee,{size:"sm",onClick:A,disabled:N.length===0,"data-test":"edit-steps-save",children:"Save"})]})]})})]})},Tw=[];function Ew(){const e=kt(E,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.isRecording)??!1}),s=kt(E,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.capturedSteps)??Tw}),n=kt(E,c=>{var l,d;return(d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.startedAt}),o=p.useCallback(()=>{E.getState().startRecording()},[]),r=p.useCallback(()=>E.getState().stopRecording(),[]),a=p.useCallback(()=>{E.getState().cancelRecording()},[]),i=p.useMemo(()=>n?Date.now()-n:0,[n]);return{isRecording:e,capturedSteps:s,startedAt:n,startRecording:o,stopRecording:r,cancelRecording:a,recordingDuration:i}}const Rw=[],Mw=[],Pw=e=>{const s={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(s[e])return s[e];const n=e.split("-");return n.length>=2?n[1]:null};function Dw(){const e=kt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.historySelection)==null?void 0:h.isSelecting)??!1}),s=kt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.historySelection)==null?void 0:h.selectedIds)??Rw}),n=kt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.entries)??Mw}),o=p.useCallback(()=>{E.getState().toggleHistorySelectionMode()},[]),r=p.useCallback(d=>{E.getState().toggleHistoryItemSelection(d)},[n,s]),a=p.useCallback(d=>s.includes(d),[s]),i=p.useCallback(()=>{E.getState().clearHistorySelection()},[]),c=p.useCallback(()=>{const d=new Map;n.forEach(h=>{d.set(h.executorId,h)});const u=[];for(const h of s){const f=d.get(h);if(!f)continue;const g=Pw(f.source);if(!g||!f.actionId)continue;const w={facadeKey:g,actionId:f.actionId,params:f.params,label:f.label};u.push({id:Pe(8),action:w,delayMs:0})}return u},[s,n]),l=p.useMemo(()=>s.length,[s]);return{isSelecting:e,selectedIds:s,toggleSelectionMode:o,toggleItemSelection:r,isSelected:a,clearSelection:i,getSelectedAsSteps:c,selectionCount:l}}const sd=({initialTab:e="history",onTabChange:s})=>{const{history:n,executeAction:o,hasExecutor:r,clearHistory:a}=Sr(),[i,c]=p.useState(e),{isRecording:l,capturedSteps:d,startRecording:u,stopRecording:h,cancelRecording:f}=Ew(),{isSelecting:g,toggleSelectionMode:w,toggleItemSelection:m,isSelected:x,clearSelection:y,getSelectedAsSteps:v,selectionCount:N}=Dw(),{createPreset:b}=Cr(),[S,I]=p.useState(!1),[C,k]=p.useState(""),[R,A]=p.useState([]),[T,O]=p.useState(void 0),$=p.useCallback(D=>{const K=D;c(K),s==null||s(K)},[s]),B=D=>new Date(D).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),H=D=>D.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(K=>K.charAt(0).toUpperCase()+K.slice(1)).join(" "),M=p.useCallback(D=>{o(D)},[o]),j=p.useCallback(()=>{u()},[u]),P=p.useCallback(D=>{const K=h();K.length>0&&(A(K),k(`Preset ${new Date().toLocaleTimeString()}`),O(D),I(!0))},[h]),W=p.useCallback(()=>{w(),c("history")},[w]),L=p.useCallback(()=>{const D=v();D.length>0&&(A(D),k(`Preset ${new Date().toLocaleTimeString()}`),I(!0),y())},[v,y]),z=p.useCallback(()=>{C.trim()&&R.length>0&&(b(C.trim(),R),I(!1),k(""),A([]),c("presets"))},[C,R,b]),_=p.useCallback(()=>{I(!1),k(""),A([])},[]),G=(D,K)=>{const te=K===0,ie=r(D.executorId),ye=x(D.executorId);return t.jsxs("div",{className:ve("group flex items-center gap-2 px-3 py-2 text-sm","border-b border-border/50 last:border-b-0",te&&"bg-primary/5",!ie&&"opacity-50",ye&&"bg-primary/10"),"data-test":"action-history-item",children:[g?t.jsx(We,{checked:ye,onCheckedChange:()=>m(D.executorId),className:"h-4 w-4","data-test":"action-history-select"}):t.jsx("div",{className:ve("flex-shrink-0 w-5 h-5 rounded text-[10px] font-medium flex items-center justify-center",te?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:K+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:ve("font-medium truncate",te&&"text-primary"),"data-test":"action-history-item-label",children:D.label}),te&&!g&&t.jsx("span",{className:"text-[9px] px-1 py-0.5 rounded bg-primary/10 text-primary font-medium",children:"Latest"})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[t.jsx("span",{"data-test":"action-history-item-source",children:H(D.source)}),t.jsx("span",{children:"•"}),t.jsx("span",{"data-test":"action-history-item-time",children:B(D.timestamp)})]})]}),!g&&(ie?t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 hover:opacity-100 transition-opacity",onClick:()=>M(D),title:"Execute this action","data-test":"action-history-execute",children:t.jsx(st,{className:"h-3 w-3"})}):t.jsx("div",{className:"h-6 w-6 flex items-center justify-center text-muted-foreground/50",children:t.jsx(rs,{className:"h-3 w-3"})}))]},`${D.executorId}-${K}`)},V=t.jsxs("div",{className:"flex flex-col h-full","data-test":"action-history-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"action-history-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:g?t.jsxs(t.Fragment,{children:[t.jsx(fr,{className:"h-3.5 w-3.5 text-primary"}),t.jsxs("span",{className:"text-xs font-medium text-primary",children:[N," selected"]})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(Ko,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",d.length,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(rs,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[n.length," action",n.length!==1?"s":""]})]})}),t.jsx("div",{className:"flex items-center gap-1","data-test":"action-history-header-actions",children:g?t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:L,disabled:N===0,"data-test":"action-history-save-selection",children:"Save Preset"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:y,"data-test":"action-history-cancel-selection",children:"Cancel"})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:D=>P({x:D.clientX,y:D.clientY}),"data-test":"action-history-stop-recording",children:"Stop"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:f,"data-test":"action-history-cancel-recording",children:"Cancel"})]}):t.jsx(t.Fragment,{children:n.length>0&&t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-destructive",onClick:a,"data-test":"action-history-clear-button",children:[t.jsx(vt,{className:"h-3 w-3 mr-1"}),"Clear"]})})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"action-history-list",children:n.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(Xo,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No actions yet"}),t.jsx("span",{className:"text-xs text-center",children:"Actions you perform will appear here"})]}):t.jsx("div",{"data-test":"action-history-items",children:n.map((D,K)=>G(D,K))})}),n.length>0&&!g&&!l&&t.jsxs("div",{className:"px-3 py-2 border-t bg-muted/30 text-[10px] text-muted-foreground","data-test":"action-history-footer",children:["Click ",t.jsx(st,{className:"h-2.5 w-2.5 inline mx-0.5"})," to repeat an action"]})]});return t.jsxs(t.Fragment,{children:[t.jsxs(Yd,{value:i,onValueChange:$,className:"flex flex-col h-full",children:[t.jsxs(Kd,{className:"grid w-full grid-cols-2 h-8","data-test":"repeat-action-tabs",children:[t.jsxs(Hr,{value:"history",className:"text-xs","data-test":"tab-history",children:[t.jsx(rs,{className:"h-3 w-3 mr-1"}),"History"]}),t.jsxs(Hr,{value:"presets",className:"text-xs","data-test":"tab-presets",children:[t.jsx(Dn,{className:"h-3 w-3 mr-1"}),"Presets"]})]}),t.jsx(Br,{value:"history",className:"flex-1 mt-0 overflow-hidden",children:V}),t.jsx(Br,{value:"presets",className:"flex-1 mt-0 overflow-hidden",children:t.jsx(Iw,{onStartRecording:j,onStartSelection:W,isRecording:l,capturedStepsCount:d.length,onStopRecording:P,onCancelRecording:f})})]}),t.jsx(_e,{isVisible:S,onClose:_,title:"Save as Preset",initialSize:{width:320,height:200},triggerPosition:T,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-4 flex flex-col gap-3","data-test":"save-preset-popover-content",children:[t.jsxs("div",{children:[t.jsx(Te,{htmlFor:"new-preset-name",className:"text-sm",children:"Preset Name"}),t.jsx(Re,{id:"new-preset-name",value:C,onChange:D=>k(D.target.value),placeholder:"Enter preset name",className:"mt-2",autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&z()},"data-test":"save-preset-name-input"}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[R.length," step",R.length!==1?"s":""," will be saved"]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(ee,{variant:"outline",size:"sm",onClick:_,"data-test":"save-preset-cancel",children:"Cancel"}),t.jsx(ee,{size:"sm",onClick:z,disabled:!C.trim(),"data-test":"save-preset-confirm",children:"Save Preset"})]})]})})]})},nd=()=>{const[e,s]=p.useState(!1),n=it.getAllActions().map(({source:o,actions:r})=>({facade:o,actions:r}));return t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:o=>{o.stopPropagation(),s(!0)},onMouseDown:o=>o.stopPropagation(),title:"Debug: Show all available actions","data-test":"action-history-debug-button",children:t.jsx(ar,{className:"h-3.5 w-3.5"})}),t.jsx(_e,{isVisible:e,onClose:()=>s(!1),title:"Available Actions (Debug)",initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3 overflow-y-auto h-full","data-test":"debug-actions-panel",children:n.map(({facade:o,actions:r})=>t.jsxs("div",{className:"mb-4","data-test":"debug-facade-section",children:[t.jsxs("h4",{className:"text-sm font-semibold mb-2 text-primary",children:[o," Actions"]}),t.jsx("ol",{className:"list-decimal list-inside space-y-1 text-xs",children:r.map(a=>t.jsxs("li",{className:"ml-2","data-test":"debug-action-item",children:[t.jsx("span",{className:"font-medium",children:a.label}),t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",a.id,")"]}),a.subActions&&a.subActions.length>0&&t.jsx("ol",{className:"list-[lower-alpha] list-inside ml-4 mt-1 space-y-0.5",children:a.subActions.map(i=>t.jsxs("li",{className:"text-muted-foreground","data-test":"debug-subaction-item",children:[t.jsx("span",{children:i.title}),t.jsxs("span",{className:"ml-1 opacity-60",children:["(",i.id,")"]})]},i.id))})]},a.id))})]},o))})})]})},Ow=({className:e})=>{const{history:s,lastAction:n,executeLastAction:o,executeAction:r,hasExecutor:a}=Sr(),{presets:i,executePreset:c,favoriteIds:l}=Cr(),[d,u]=p.useState(!1),[h,f]=p.useState(),g=p.useRef(null),w=p.useCallback(()=>{if(g.current){const R=g.current.getBoundingClientRect();f({x:R.left,y:R.bottom+4})}u(!0)},[]),m=p.useMemo(()=>i.filter(R=>l.includes(R.id)),[i,l]),x=p.useCallback(R=>R.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(A=>A.charAt(0).toUpperCase()+A.slice(1)).join(" "),[]),y=p.useCallback(R=>new Date(R).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[]),v=p.useCallback(R=>{r(R)},[r]),N=p.useCallback((R,A,T)=>{c(R),T(A,()=>c(R))},[c]),b=p.useCallback(()=>{n&&a(n.executorId)&&o()},[n,a,o]),S=p.useCallback(R=>{const A=i.find(T=>T.name===R);return A?()=>{c(A.id)}:null},[i,c]),I=p.useCallback((R,A)=>{const T=A===0,O=a(R.executorId);return t.jsxs("div",{className:ve("group flex items-center gap-2 px-2 py-1.5 text-xs rounded-sm","hover:bg-accent cursor-pointer transition-colors",T&&"bg-primary/5",!O&&"opacity-50 cursor-not-allowed"),onClick:()=>O&&v(R),"data-test":"history-item",children:[t.jsx("div",{className:ve("flex-shrink-0 w-4 h-4 rounded text-[9px] font-medium flex items-center justify-center",T?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:A+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:ve("font-medium truncate text-[11px]",T&&"text-primary"),children:R.label}),t.jsxs("div",{className:"text-[9px] text-muted-foreground truncate",children:[x(R.source)," • ",y(R.timestamp)]})]}),O&&t.jsx(st,{className:"h-2.5 w-2.5 opacity-0 group-hover:opacity-100 transition-opacity text-primary"})]},`${R.executorId}-${A}`)},[a,v,x,y]),C=p.useMemo(()=>[{header:"Recent Actions",width:"200px",actions:[{label:"History",onClick:()=>{},customRender:({registerRepeatAction:R})=>t.jsx("div",{className:"flex flex-col","data-test":"history-column",children:t.jsx("div",{className:"max-h-[200px] overflow-y-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},"data-test":"history-list",children:s.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-muted-foreground",children:[t.jsx(rs,{className:"h-6 w-6 opacity-30 mb-2"}),t.jsx("span",{className:"text-[10px]",children:"No actions yet"})]}):s.map((A,T)=>t.jsx("div",{onClick:()=>{a(A.executorId)&&(v(A),R(A.label,()=>r(A)))},children:I(A,T)},`${A.executorId}-${T}`))})})}]},{header:"Presets",width:"180px",actions:[{label:"Presets",onClick:()=>{},customRender:({registerRepeatAction:R,closeDropdown:A})=>t.jsx(rw,{presetsButtonRef:g,onOpenPresetsPopover:w,closeDropdown:A,favoritePresets:m,onExecutePreset:(T,O)=>N(T,O,R),dataTestPrefix:"sequence"})}]}],[s,m,a,v,N,w,r,I]),k=n?`Repeat: ${n.label}`:"Actions & Presets";return t.jsxs(t.Fragment,{children:[t.jsx(Ze,{mainAction:{icon:t.jsx(mh,{className:"h-4 w-4"}),onClick:b,label:k},dropdownColumns:C,variant:"outline",size:"compact",persistenceKey:"canvas-actions-presets",restoreRepeatAction:S,className:e,"data-test":"canvas-actions-presets-button"}),t.jsx(_e,{isVisible:d,onClose:()=>u(!1),title:"Actions & Presets",initialSize:{width:300,height:380},triggerPosition:h,resizable:!0,headerActions:t.jsx(nd,{}),children:t.jsx(sd,{initialTab:"presets"})})]})},Lw=[],$i=[],od=()=>{const e=F(l=>l.arrow.update),s=F(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedNodes)??Lw}),n=F(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??$i}),o=F(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.arrows)??$i}),r=p.useMemo(()=>{if(n.length>0){const l=n[0].type??J.arrows.type;return n.every(u=>(u.type??J.arrows.type)===l)?l:null}if(s.length>0){const l=new Set(s.map(f=>f.id)),d=o.filter(f=>f.startNodeId&&l.has(f.startNodeId)||f.endNodeId&&l.has(f.endNodeId));if(d.length===0)return J.arrows.type;const u=d[0].type??J.arrows.type;return d.every(f=>(f.type??J.arrows.type)===u)?u:null}return J.arrows.type},[n,s,o]),a=p.useCallback(l=>{const u=E.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.arrows??[],f=u.coreState.selectedArrows??[],g=u.coreState.selectedNodes??[];let w=h;if(f.length>0)w=f;else if(g.length>0){const m=new Set(g.map(x=>x.id));w=h.filter(x=>x.startNodeId&&m.has(x.startNodeId)||x.endNodeId&&m.has(x.endNodeId))}w.forEach(m=>{e(m.id,{type:l})})},[e]),i=[{label:"Straight",icon:t.jsx(Yo,{className:"h-2.5 w-2.5"}),onClick:()=>a("Straight"),selected:r==="Straight"},{label:"Quadratic",icon:t.jsx(xh,{className:"h-2.5 w-2.5"}),onClick:()=>a("Quadratic"),selected:r==="Quadratic"},{label:"Cubic",icon:t.jsx(wh,{className:"h-2.5 w-2.5"}),onClick:()=>a("Cubic"),selected:r==="Cubic"},{label:"Step",icon:t.jsx(yh,{className:"h-2.5 w-2.5"}),onClick:()=>a("Step"),selected:r==="Step"},{label:"Orthogonal",icon:t.jsx(Ns,{className:"h-2.5 w-2.5"}),onClick:()=>a("Orthogonal"),selected:r==="Orthogonal"},{label:"Tree: Cubic",icon:t.jsx(pr,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeCubic"),selected:r==="TreeCubic"},{label:"Tree: L-Step",icon:t.jsx(vh,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeLStep"),selected:r==="TreeLStep"},{label:"Tree: Z-Shape",icon:t.jsx(bh,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeZShape"),selected:r==="TreeZShape"}],c=i[2];return t.jsx(Ze,{mainAction:c,dropdownActions:i,variant:"outline",size:"compact",persistenceKey:"canvas-arrow-type","data-test":"canvas-arrow-type-button"})};class Ww{constructor(s){Fe(this,"namespace","canvas.grouping");this.hooks=s}getActions(){return[{id:"group",label:"Group nodes",category:"Grouping",icon:t.jsx(dl,{className:"h-3 w-3"})},{id:"ungroup",label:"Ungroup nodes",category:"Grouping",icon:t.jsx(mr,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"group":this.hooks.group();break;case"ungroup":this.hooks.ungroup();break;default:console.warn(`GroupingFacade: Unknown action "${s}"`)}}}function Hw(){const e=p.useCallback(()=>{E.getState().group.createFromSelected()},[]),s=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],c=new Set;i.forEach(l=>{l.type===ce.GROUP?c.add(l.id):l.groupId&&c.add(l.groupId)}),c.forEach(l=>{r.group.ungroup(l)})},[]),n=p.useMemo(()=>({group:e,ungroup:s}),[e,s]),o=p.useMemo(()=>new Ww(n),[n]);return p.useEffect(()=>(it.register("grouping",{name:"Grouping",getActions:()=>o.getActions()}),rt.register("grouping",o),()=>{it.unregister("grouping"),rt.unregister("grouping")}),[o]),o}const Bw=e=>{const{className:s,...n}=e,o=Hw();F(w=>{var m,x;return((x=(m=w.projectCanvas.getActive())==null?void 0:m.coreState.selectedNodes)==null?void 0:x.length)??0});const a=E.getState().projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],l=i.filter(w=>w.type===ce.GROUP).length>0,d=i.filter(w=>w.type!==ce.GROUP),u=d.some(w=>w.groupId),h=d.some(w=>!w.groupId),f=l||u&&!h&&d.length>0,g=d.length>=2&&h;return!f&&!g?null:t.jsx(an,{id:"ToolbarGroupButton",className:s,type:"button",onClick:()=>o.execute(f?"ungroup":"group"),title:f?"Ungroup (remove from group)":"Group selected nodes (Ctrl+G)","data-test":f?"toolbar-ungroup-button":"toolbar-group-button",...n,children:f?t.jsx(mr,{className:"h-2.5 w-2.5"}):t.jsx(dl,{className:"h-2.5 w-2.5"})})},Fw=e=>{const{className:s}=e,{handleAlignmentChange:n,currentAlignment:o}=Fm();return t.jsxs("div",{className:je("p-0.5 gap-0.5","bg-primary-foreground shadow","flex items-center flex-wrap","pointer-events-auto",s),"data-test":"canvas-node-configurations-toolbar",children:[t.jsx(Ul,{}),t.jsx(Px,{}),t.jsx(Fx,{textAlignValue:o,onTextAlignmentChange:n}),t.jsx(Rx,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(fx,{}),t.jsx(Mx,{}),t.jsx(bx,{}),t.jsx(jx,{}),t.jsx(tw,{}),t.jsx(Ow,{}),t.jsx(Tx,{}),t.jsx(Ix,{}),t.jsx(od,{}),t.jsx(Bw,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(Nx,{})]})},ad=({children:e,className:s,dataTest:n,dataAttributes:o={}})=>{const r=J.nodeUI.idleOpacity;return t.jsx("div",{className:je("relative","bg-primary-foreground shadow rounded flex items-center pointer-events-auto","hover:opacity-100 transition-opacity duration-200",s),style:{zIndex:Ee.nodeQuickPanel,opacity:r},onMouseEnter:a=>{a.currentTarget.style.opacity="1"},onMouseLeave:a=>{a.currentTarget.style.opacity=String(r)},"data-test":n,...Object.fromEntries(Object.entries(o).map(([a,i])=>[`data-${a}`,i])),children:e})},$w=({node:e})=>t.jsx(ad,{className:"space-x-2",dataTest:"node-quick-panel-container",dataAttributes:{"node-id":e.id,"node-type":e.type},children:t.jsx(Fw,{})}),zw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??ks;return s.length===0?null:s.reduce((r,a)=>a.y<r.y||a.y===r.y&&a.x<r.x?a:r,s[0]).id},rd=e=>e.length===0?null:e.reduce((s,n)=>n.y<s.y||n.y===s.y&&n.x<s.x?n:s,e[0]),_w=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??ks,n=rd(s);return(n==null?void 0:n.x)??null},Vw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??ks,n=rd(s);return(n==null?void 0:n.y)??null},Uw=e=>{var s,n;return((n=(s=e.projectCanvas.getActive())==null?void 0:s.coreState.selectedNodes)==null?void 0:n.length)??0},Gw=Ie.memo(({node:e,isOpen:s,children:n})=>{const[o,r]=p.useState({top:0,left:0}),a=p.useRef(null),i=F(Uw),c=F(zw),l=F(_w),d=F(Vw),h=F(g=>g.uiState.mode)===Q.DRAW_ARROW,f=i>0&&c&&l!==null&&d!==null?{...e,id:c}:e;return p.useEffect(()=>{if(!s)return;const g=()=>{var B,H;const m=f,x=document.getElementById(`NodeContainerV2-${m.id}`);if(!x)return;const y=x.getBoundingClientRect(),v=((B=a.current)==null?void 0:B.offsetHeight)||250,N=((H=a.current)==null?void 0:H.offsetWidth)||350,b=window.innerWidth,S=window.innerHeight,I=20;let C=y.left+y.width/2-N/2;const k=J.nodeUI.quickPanelGap,R=y.top-v-k,A=y.bottom+k,T=R>=I,O=A+v<=S-I;let $;!T&&O?$=A:T?$=R:O?$=A:$=I,C<I?C=I:C+N>b-I&&(C=b-N-I),r({top:$,left:C})};g();const w=setTimeout(g,100);return window.addEventListener("scroll",g,!0),window.addEventListener("resize",g),()=>{clearTimeout(w),window.removeEventListener("scroll",g,!0),window.removeEventListener("resize",g)}},[s,c,l,d]),t.jsxs(t.Fragment,{children:[n,s&&!h&&e.type!==ce.DRAWING&&tn.createPortal(t.jsx("div",{ref:a,className:"fixed pointer-events-auto",style:{top:`${o.top}px`,left:`${o.left}px`,zIndex:Ee.popover,maxWidth:"90vw"},onPointerDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),onWheel:g=>g.stopPropagation(),children:t.jsx($w,{node:e})}),document.body)]})}),Yw=[{position:"top",cursor:"cursor-crosshair",classes:"top-0 left-1/2 -translate-x-1/2"},{position:"bottom",cursor:"cursor-crosshair",classes:"bottom-0 left-1/2 -translate-x-1/2"},{position:"left",cursor:"cursor-crosshair",classes:"left-0 top-1/2 -translate-y-1/2"},{position:"right",cursor:"cursor-crosshair",classes:"right-0 top-1/2 -translate-y-1/2"}],ns=8,eo=J.nodeOptions.resizeBorderWidth,ze={corner:{width:ns,height:ns},edge:{horizontal:{height:eo,width:`calc(100% - ${ns*2}px)`},vertical:{width:eo,height:`calc(100% - ${ns*2}px)`}},position:{cornerTop:`-${ns}px`,cornerLeft:`-${ns}px`,cornerBottom:"100%",cornerRight:"100%",edgeTop:`-${eo}px`,edgeLeft:`-${eo}px`,topEdge:`${ns}px`,leftEdge:`${ns}px`},edgePosition:{bottom:"100%",left:"100%"}},Kw=[{position:"top-left",cursor:"cursor-nwse-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerTop,left:ze.position.cornerLeft}},{position:"top-right",cursor:"cursor-nesw-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerTop,left:ze.position.cornerRight}},{position:"bottom-left",cursor:"cursor-nesw-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerBottom,left:ze.position.cornerLeft}},{position:"bottom-right",cursor:"cursor-nwse-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerBottom,left:ze.position.cornerRight}},{position:"top",cursor:"cursor-ns-resize",classes:"",style:{...ze.edge.horizontal,top:ze.position.edgeTop,left:ze.position.leftEdge}},{position:"bottom",cursor:"cursor-ns-resize",classes:"",style:{...ze.edge.horizontal,top:ze.edgePosition.bottom,left:ze.position.leftEdge}},{position:"left",cursor:"cursor-ew-resize",classes:"",style:{...ze.edge.vertical,top:ze.position.topEdge,left:ze.position.edgeLeft}},{position:"right",cursor:"cursor-ew-resize",classes:"",style:{...ze.edge.vertical,top:ze.position.topEdge,left:ze.edgePosition.left}}],Xw=e=>{const s=ss(e,"top-left"),n=ss(e,"top-right"),o=ss(e,"bottom-left"),r=ss(e,"bottom-right"),a=ss(e,"top"),i=ss(e,"bottom"),c=ss(e,"left"),l=ss(e,"right");return{"top-left":s,"top-right":n,"bottom-left":o,"bottom-right":r,top:a,bottom:i,left:c,right:l}},{HANDLE_BG_COLOR:qw,HANDLE_BORDER_COLOR:Zw}=Ne,Ya=8,Ka=20,Ts=(Ka-Ya)/2,Jw=({node:e,isSelected:s,mode:n})=>{const o=s&&n===Q.SELECT,r=Xw(e),a=F(h=>h.uiState.nodeHoldToResize),i=(a==null?void 0:a.nodeId)===e.id,c=i?a.edge:null,l=i&&a.isReady,d=i&&a.isHolding,u=J.nodeUI.resizeHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:Kw.map(({position:h,cursor:f,classes:g,style:w})=>{const m=r[h],x=!["top","right","bottom","left"].includes(h),y=c===h,v=y&&l,N=y&&d;return x?t.jsx("div",{"data-test":"resize-handle",id:`resize-handle-${e.id}-${h}`,className:je("absolute transition-opacity duration-200",g,f),style:{width:Ka,height:Ka,top:typeof(w==null?void 0:w.top)=="string"?`calc(${w.top} - ${Ts}px)`:(w==null?void 0:w.top)-Ts,left:typeof(w==null?void 0:w.left)=="string"?`calc(${w.left} - ${Ts}px)`:(w==null?void 0:w.left)-Ts,touchAction:"none",zIndex:Ee.canvasResizeHandles,opacity:y?1:u},onMouseEnter:b=>{b.currentTarget.style.opacity="1"},onMouseLeave:b=>{y||(b.currentTarget.style.opacity=String(u))},onPointerDown:b=>{b.stopPropagation(),m(b)},children:t.jsx("div",{className:je("absolute border transition-all duration-150",v?"bg-emerald-500 border-emerald-500 scale-125":N?"bg-amber-500 border-amber-500":je(qw,Zw)),style:{width:Ya,height:Ya,top:Ts,left:Ts,pointerEvents:"none"}})},h):t.jsx("div",{"data-test":"resize-handle",id:`resize-handle-${e.id}-${h}`,className:je("absolute transition-all duration-150",v?"bg-emerald-500/30":N?"bg-amber-500/20":"hover:bg-primary/5",g,f),style:{...w,touchAction:"none",zIndex:Ee.canvasResizeHandles},onPointerDown:b=>{b.stopPropagation(),m(b)}},h)})}):null},Qw=e=>{const s=Jn(e,"top"),n=Jn(e,"bottom"),o=Jn(e,"left"),r=Jn(e,"right");return p.useMemo(()=>({top:s,bottom:n,left:o,right:r}),[s,n,o,r])},to=-10,ey=({node:e,isSelected:s,mode:n})=>{const o=s&&n===Q.SELECT,r=Qw(e),a=J.nodeUI.quickArrowHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:Yw.map(({position:i,cursor:c,classes:l})=>{const d=r[i];return t.jsx("div",{"data-test":"quick-arrow-handle",id:`arrow-handle-${e.id}-${i}`,className:je("absolute border rounded-full z-10","bg-blue-500","border-blue-700",l.replace(/-translate-\w+-1\/2/g,"").trim(),c,"pointer-events-auto","transition-opacity duration-200"),style:{width:`${ts}px`,height:`${ts}px`,top:l.includes("top-0")?`${to-ts}px`:l.includes("bottom-0")?`calc(100% + ${ts-to}px)`:`calc(50% - ${ts/2}px)`,left:l.includes("left-0")?`${to-ts}px`:l.includes("right-0")?`calc(100% + ${ts-to}px)`:`calc(50% - ${ts/2}px)`,opacity:a},onMouseEnter:u=>{u.currentTarget.style.opacity="1"},onMouseLeave:u=>{u.currentTarget.style.opacity=String(a)},onMouseDown:u=>{u.stopPropagation(),d(u)}},`arrow-${i}`)})}):null},ty=e=>{const{node:s,mode:n,isPopoverOpen:o,setIsPopoverOpen:r}=e,a=wf(s),c=E.getState().setSelectedNodes,l=p.useRef({x:NaN,y:NaN});return{handleMouseDown:p.useCallback(u=>{var A;const h={x:u.clientX,y:u.clientY};l.current=h;const f=u.target;if(n===Q.MOVE)return;const w=(A=E.getState().projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes,m=w==null?void 0:w.some(T=>T.id===s.id),x=m&&(w==null?void 0:w.length)===1,y=f.closest(`[id^="resize-handle-${s.id}-"]`),v=f.closest(`[id^="arrow-handle-${s.id}-"]`),N=f.closest("[data-drag-handle]"),I=(f.tagName==="TEXTAREA"||f.closest("textarea")||f.closest("[contenteditable]")||f.closest("[data-node-textarea]")||f.closest(".markdown-textarea")||f.closest("[data-text-node-click-overlay]")||f.isContentEditable||f.closest("[data-text-position-container]"))&&!s.isEditing&&x,C=f.closest(".audio-button-wrapper")||f.closest(".voice-input-button")||f.closest(".nav-button")||f.closest(".chunk-counter"),k=f.closest('[data-test="group-header"] button'),R=f.closest(".node-actions-sidebar button");if(I){const T=E.getState(),O=u.clientX,$=u.clientY;r(!1);const B=document.querySelector(`#NodeContainerV2-${s.id} .markdown-textarea`);if(B){B.contentEditable="true",B.focus({preventScroll:!0});const H=document.querySelector(`#NodeContainerV2-${s.id} [data-text-node-click-overlay]`);H&&(H.style.display="none")}T.updateNode(s.id,{isEditing:!0}),T.setNodeToFocusId(s.id),$l($)&&Fl({nodeId:s.id,nodeY:s.y,source:"existingNode"}),requestAnimationFrame(()=>{try{let H=null;if(document.caretRangeFromPoint)H=document.caretRangeFromPoint(O,$);else if(document.caretPositionFromPoint){const M=document.caretPositionFromPoint(O,$);M&&(H=document.createRange(),H.setStart(M.offsetNode,M.offset),H.collapse(!0))}if(H){const M=window.getSelection();M&&(M.removeAllRanges(),M.addRange(H))}}catch{}});return}if(y||v||N||C||k||R){r(!1);return}m||r(!1),!s.isEditing&&!I&&a(u)},[s,c,a,n,o,r]),initialClickPoint:l}};function _o({tags:e,onAddTag:s,onRemoveTag:n,quickTags:o=["left","right","todo","important"],canvasTags:r=[],className:a}){const[i,c]=p.useState(""),l=r.filter(u=>{const h=!i.trim()||u.toLowerCase().includes(i.toLowerCase()),f=!e.includes(u);return h&&f}),d=()=>{const u=i.trim();u&&(s(u),c(""))};return t.jsxs("div",{className:ve("tag-management-ui space-y-3",a),"data-test":"tag-management-ui-container",children:[e.length>0&&t.jsxs("div",{className:"current-tags space-y-2","data-test":"tag-management-current-tags-section",children:[t.jsx("div",{className:"tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-current-tags-label",children:"Current Tags"}),t.jsx("div",{className:"tags-list flex flex-wrap gap-1","data-test":"tag-management-current-tags-list",children:e.map(u=>t.jsxs(tt,{variant:"secondary",className:"tag-badge text-xs flex items-center gap-1","data-test":"tag-management-tag",children:[u,t.jsx("button",{onClick:()=>n(u),className:"tag-remove-button ml-1 hover:text-destructive",title:"Remove tag","data-test":"tag-management-remove-tag-button",children:t.jsx($e,{className:"h-3 w-3"})})]},u))})]}),t.jsxs("div",{className:"add-tag-section space-y-2","data-test":"tag-management-add-tag-section",children:[t.jsx("div",{className:"add-tag-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-add-tag-label",children:"Add Tag"}),t.jsxs("div",{className:"add-tag-input-group flex gap-2","data-test":"tag-management-add-tag-input-group",children:[t.jsx(Re,{placeholder:"Enter tag name...",value:i,onChange:u=>c(u.target.value),onKeyDown:u=>{u.key==="Enter"&&i.trim()&&(u.preventDefault(),d())},className:"tag-input h-8 text-sm",autoFocus:!0,"data-test":"tag-management-tag-input"}),t.jsx(ee,{variant:"default",size:"sm",className:"add-tag-button h-8",onClick:d,disabled:!i.trim(),"data-test":"tag-management-add-tag-button",children:t.jsx(yt,{className:"h-4 w-4"})})]})]}),l.length>0&&t.jsxs("div",{className:"canvas-tags-section space-y-2","data-test":"tag-management-canvas-tags-section",children:[t.jsx("div",{className:"canvas-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-canvas-tags-label",children:"Tags in Canvas"}),t.jsx("div",{className:"canvas-tags-list flex flex-wrap gap-1 max-h-14 overflow-y-auto","data-test":"tag-management-canvas-tags-list",children:l.map(u=>t.jsx(tt,{variant:"outline",className:"canvas-tag cursor-pointer hover:opacity-80 hover:bg-accent",onClick:()=>s(u),"data-test":"tag-management-canvas-tag",children:u},u))})]}),o.length>0&&t.jsxs("div",{className:"quick-tags-section space-y-2","data-test":"tag-management-quick-tags-section",children:[t.jsx("div",{className:"quick-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-quick-tags-label",children:"Quick Add"}),t.jsx("div",{className:"quick-tags-list flex flex-wrap gap-1","data-test":"tag-management-quick-tags-list",children:o.map(u=>{const h=e.includes(u);return t.jsx(tt,{variant:h?"default":"outline",className:ve("quick-tag cursor-pointer hover:opacity-80",h&&"opacity-50 cursor-not-allowed"),onClick:()=>{h||s(u)},"data-test":"tag-management-quick-tag",children:u},u)})})]})]})}const sy=[];function ny({nodeId:e,tags:s,className:n}){const[o,r]=p.useState(!1),a=F(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??sy}),i=Array.isArray(s)?s:[],c=p.useMemo(()=>i.map(h=>h.title),[i]),l=p.useMemo(()=>{const h=new Set;for(const f of a)if(Array.isArray(f.tags))for(const g of f.tags)h.add(g.title);return Array.from(h).sort()},[a]),d=p.useCallback(h=>{const f=E.getState(),g={id:Math.random().toString(36).slice(2,10),title:h};f.addTagToNode(e,g)},[e]),u=p.useCallback(h=>{const f=E.getState(),g=i.find(w=>w.title===h);g&&f.removeTagFromNode(e,g.id)},[e,i]);return t.jsxs(ct,{open:o,onOpenChange:r,"data-test":"tag-selector-popover",children:[t.jsx(lt,{asChild:!0,children:t.jsx(an,{className:n,onClick:h=>{h.stopPropagation()},title:"Manage tags",variant:"ghost","data-test":"tag-selector-trigger-button",children:t.jsx(Fn,{})})}),t.jsx(dt,{className:"tag-selector-popover w-64 p-3",align:"start","data-test":"tag-selector-popover-content",children:t.jsx(_o,{tags:c,onAddTag:d,onRemoveTag:u,canvasTags:l})})]})}function oy({node:e,className:s}){const n=o=>{var d;o.stopPropagation();const r=E.getState(),a=(d=r.projectCanvas.getActive())==null?void 0:d.viewState,i=r.updateNode;if(!a)return;const{scale:c,offset:l}=a;if(e.isPinned){const u=(e.x-l.x)/c,h=(e.y-l.y)/c;i(e.id,{isPinned:!1,x:u,y:h})}else{const u=e.x*c+l.x,h=e.y*c+l.y;i(e.id,{isPinned:!0,x:u,y:h})}};return t.jsx(an,{className:s,onClick:n,title:e.isPinned?"Unpin from viewport":"Pin to viewport",variant:"ghost",children:e.isPinned?t.jsx(ul,{className:"h-4 w-4 text-blue-500"}):t.jsx(hl,{className:"h-4 w-4"})})}const is=p.forwardRef(({tooltip:e,children:s,...n},o)=>t.jsx(Jt,{children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(ee,{ref:o,...n,children:s})}),t.jsx(Bt,{children:typeof e=="string"?t.jsx("p",{children:e}):e})]})}));is.displayName="ButtonWithTooltip";const id=p.createContext(null),ay=({children:e})=>{const[s,n]=p.useState(null),o=p.useRef(null),r=p.useCallback(c=>{n(c)},[s]),a=p.useCallback(c=>{n(l=>l===c?null:l)},[s]),i=p.useCallback(c=>s===c,[s]);return p.useEffect(()=>{if(!s)return;const c=l=>{var u;const d=l.target;(u=o.current)!=null&&u.contains(d)||d.closest('[data-test^="draggable-popover"]')||n(null)};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[s]),t.jsx(id.Provider,{value:{activePopoverId:s,openPopover:r,closePopover:a,isPopoverOpen:i},children:t.jsx("div",{ref:o,children:e})})},kr=e=>{const s=p.useContext(id),[n,o]=p.useState(!1);if(!s)return{isOpen:n,open:()=>o(!0),close:()=>o(!1),toggle:()=>o(c=>!c)};const{isPopoverOpen:r,openPopover:a,closePopover:i}=s;return{isOpen:r(e),open:()=>a(e),close:()=>i(e),toggle:()=>{r(e)?i(e):a(e)}}},rn=({popoverId:e,icon:s,tooltip:n,popoverContent:o,popoverTitle:r,leftOffset:a=180,initialSize:i={width:320,height:400},resizable:c=!0,headerActions:l,buttonVariant:d="secondary",buttonSize:u="sm",dataTest:h})=>{const f=p.useRef(null),[g,w]=p.useState(null),{isOpen:m,open:x,close:y}=kr(e),v=()=>{if(m){y();return}if(f.current){const N=f.current.getBoundingClientRect(),{width:b,height:S}=i,I=N.left+N.width/2,C=N.top+N.height/2;w({x:I-b/2+a,y:C-S/2})}x()};return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:f,variant:d,size:u,tooltip:n,onClick:v,"data-test":h,children:t.jsx(s,{className:"h-4 w-4"})}),t.jsx(_e,{isVisible:m,onClose:y,title:r,triggerPosition:g??void 0,initialSize:i,resizable:c,shouldCloseManually:!0,headerActions:l,children:o})]})};function ry(e){const n=Date.now()-e,o=Math.floor(n/1e3),r=Math.floor(o/60),a=Math.floor(r/60);return o<60?"just now":r<60?`${r} min ago`:a<24?`${a} hour${a>1?"s":""} ago`:"over a day ago"}const iy=[],cy=({node:e})=>{var x,y,v,N,b,S,I,C;const s=F(k=>k.uiState.arrangeSnapshot),n=F(k=>k.revertArrangeSnapshot),o=F(k=>{var R;return((R=k.projectCanvas.getActive())==null?void 0:R.coreState.nodes)??iy}),r=e.data,a=r==null?void 0:r.automation,i=p.useMemo(()=>{const k=new Set;for(const R of o)if(Array.isArray(R.tags))for(const A of R.tags)k.add(A.title);return Array.from(k).sort()},[o]),c=p.useMemo(()=>{if(!s)return null;const k=Object.keys(s.nodePositions).length,R=ry(s.timestamp);return{nodeCount:k,relativeTime:R}},[s]),l=()=>{n()},d=p.useCallback(k=>{const R=e.data??{childNodeIds:[]},A={...R.automation,...k};E.getState().updateNode(e.id,{data:{...R,automation:A}})},[e.id,e.data]),u=p.useCallback(k=>{var R;d({onEnter:{enabled:k,tags:((R=a==null?void 0:a.onEnter)==null?void 0:R.tags)??[]}})},[d,(x=a==null?void 0:a.onEnter)==null?void 0:x.tags]),h=p.useCallback(k=>{var A,T;const R=((A=a==null?void 0:a.onEnter)==null?void 0:A.tags)??[];R.includes(k)||d({onEnter:{enabled:((T=a==null?void 0:a.onEnter)==null?void 0:T.enabled)??!0,tags:[...R,k]}})},[d,a==null?void 0:a.onEnter]),f=p.useCallback(k=>{var A,T;const R=((A=a==null?void 0:a.onEnter)==null?void 0:A.tags)??[];d({onEnter:{enabled:((T=a==null?void 0:a.onEnter)==null?void 0:T.enabled)??!1,tags:R.filter(O=>O!==k)}})},[d,a==null?void 0:a.onEnter]),g=p.useCallback(k=>{var R;d({onLeave:{enabled:k,tags:((R=a==null?void 0:a.onLeave)==null?void 0:R.tags)??[]}})},[d,(y=a==null?void 0:a.onLeave)==null?void 0:y.tags]),w=p.useCallback(k=>{var A,T;const R=((A=a==null?void 0:a.onLeave)==null?void 0:A.tags)??[];R.includes(k)||d({onLeave:{enabled:((T=a==null?void 0:a.onLeave)==null?void 0:T.enabled)??!0,tags:[...R,k]}})},[d,a==null?void 0:a.onLeave]),m=p.useCallback(k=>{var A,T;const R=((A=a==null?void 0:a.onLeave)==null?void 0:A.tags)??[];d({onLeave:{enabled:((T=a==null?void 0:a.onLeave)==null?void 0:T.enabled)??!1,tags:R.filter(O=>O!==k)}})},[d,a==null?void 0:a.onLeave]);return t.jsx(rn,{popoverId:`action-settings-${e.id}`,icon:Vn,tooltip:"Group Settings",popoverTitle:"Group Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"group-settings-content",children:[t.jsxs("div",{"data-test":"group-settings-automation-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-3",children:"Automation"}),t.jsxs("div",{className:"space-y-2 mb-4","data-test":"group-settings-on-enter",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(Te,{htmlFor:"on-enter-switch",className:"text-sm",children:"Add tags when node enters"}),t.jsx(So,{id:"on-enter-switch",checked:((v=a==null?void 0:a.onEnter)==null?void 0:v.enabled)??!1,onCheckedChange:u,"data-test":"group-settings-on-enter-switch"})]}),((N=a==null?void 0:a.onEnter)==null?void 0:N.enabled)&&t.jsx(_o,{tags:((b=a==null?void 0:a.onEnter)==null?void 0:b.tags)??[],onAddTag:h,onRemoveTag:f,canvasTags:i,quickTags:[],className:"mt-2"})]}),t.jsxs("div",{className:"space-y-2","data-test":"group-settings-on-leave",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(Te,{htmlFor:"on-leave-switch",className:"text-sm",children:"Remove tags when node leaves"}),t.jsx(So,{id:"on-leave-switch",checked:((S=a==null?void 0:a.onLeave)==null?void 0:S.enabled)??!1,onCheckedChange:g,"data-test":"group-settings-on-leave-switch"})]}),((I=a==null?void 0:a.onLeave)==null?void 0:I.enabled)&&t.jsx(_o,{tags:((C=a==null?void 0:a.onLeave)==null?void 0:C.tags)??[],onAddTag:w,onRemoveTag:m,canvasTags:i,quickTags:[],className:"mt-2"})]})]}),t.jsx("div",{className:"border-t border-border"}),t.jsxs("div",{"data-test":"group-settings-arrangement-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Arrangement"}),c?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-xs text-muted-foreground",children:[c.nodeCount," node",c.nodeCount!==1?"s":""," • ",c.relativeTime]}),t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:l,"data-test":"group-settings-revert-button",children:[t.jsx(ir,{className:"h-4 w-4 mr-2"}),"Revert to Initial Positions"]})]}):t.jsx("div",{className:"text-xs text-muted-foreground italic",children:"No arrangement to revert"})]})]}),initialSize:{width:320,height:400},buttonVariant:"ghost",buttonSize:"icon",dataTest:"group-settings-button"})},ly=({node:e})=>{const s=e.data,n=(s==null?void 0:s.vocabType)??Ue.DICTIONARY,o=p.useCallback(i=>{const c=i,l=e.data??{vocabType:Ue.DICTIONARY,term:"",definition:""};E.getState().updateNode(e.id,{data:{...l,vocabType:c}})},[e.id,e.data]),r=p.useCallback(()=>{const i=e.data??{vocabType:Ue.VOCABULARY,term:"",definition:""};E.getState().updateNode(e.id,{data:{...i,sourceWord:i.translationWord||"",translationWord:i.sourceWord||""}})},[e.id,e.data]),a=n===Ue.VOCABULARY;return t.jsx(rn,{popoverId:`vocab-settings-${e.id}`,icon:Vn,tooltip:"Vocabulary Settings",popoverTitle:"Vocabulary Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"vocab-settings-content",children:[t.jsxs("div",{"data-test":"vocab-settings-type-section",children:[t.jsx(Te,{htmlFor:"vocab-type-select",className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Vocabulary Type"}),t.jsxs(gt,{value:n,onValueChange:o,children:[t.jsx(ft,{id:"vocab-type-select","data-test":"vocab-type-select",className:"w-full",children:t.jsx(mt,{})}),t.jsxs(xt,{children:[t.jsx(Ke,{value:Ue.DICTIONARY,children:"Dictionary"}),t.jsx(Ke,{value:Ue.FLASHCARD,children:"Flashcard"}),t.jsx(Ke,{value:Ue.WORD_LIST,children:"Word List"}),t.jsx(Ke,{value:Ue.ETYMOLOGY,children:"Etymology"}),t.jsx(Ke,{value:Ue.VOCABULARY,children:"Vocabulary"})]})]})]}),a&&t.jsx("div",{"data-test":"vocab-settings-swap-section",children:t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full",onClick:r,"data-test":"vocab-swap-words-button",children:[t.jsx(xs,{className:"h-4 w-4 mr-2"}),"Swap Words"]})})]}),initialSize:{width:280,height:a?180:120},buttonVariant:"ghost",buttonSize:"icon",dataTest:"vocab-settings-button"})};function dy({value:e,onChange:s,showLabel:n=!0,label:o="Fork From",placeholder:r="No fork (new session)",className:a="",disabled:i=!1}){const{forks:c,loading:l}=Xd({loadOnMount:!0}),d=u=>{s==null||s(u==="none"?null:u)};return t.jsxs("div",{className:"fork-session-selector space-y-2","data-test":"fork-session-selector",children:[n&&t.jsxs(Te,{className:"flex items-center gap-1","data-test":"fork-session-selector-label",children:[t.jsx(Nh,{className:"h-3 w-3"}),o]}),t.jsxs(gt,{value:e??"none",onValueChange:d,disabled:i,children:[t.jsx(ft,{className:`fork-selector ${a}`,"data-test":"fork-session-selector-trigger",children:t.jsx(mt,{placeholder:r})}),t.jsxs(xt,{"data-test":"fork-session-selector-options",style:{zIndex:Ee.draggablePopoverDropdown},children:[t.jsx(Ke,{value:"none","data-test":"fork-option-none",children:t.jsx("span",{className:"text-muted-foreground",children:r})}),l?t.jsx(Ke,{value:"loading",disabled:!0,children:"Loading forks..."}):c.map(u=>t.jsx(Ke,{value:u.sessionId,"data-test":"fork-option-item",children:t.jsxs("div",{className:"flex flex-col items-start",children:[t.jsx("span",{className:"font-medium",children:u.sessionName??u.description??`Fork ${u.sessionId.slice(0,8)}`}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[u.messageCount??0," messages"]})]})},u.id))]})]})]})}const uy=[{value:"low",label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"medium",label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"high",label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:"urgent",label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],hy=[{value:"freezer",label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:"backlog",label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"selected",label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:"doing",label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"done",label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:"archive",label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],py=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.data)==null?void 0:o.projects)??[]},gy=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.ui)==null?void 0:o.loadingProjects)??!1};function fy({status:e="backlog",priority:s="medium",category:n="",dueDate:o="",claudeProject:r,forkSessionId:a,sessionIds:i=[],tags:c=[],onStatusChange:l,onPriorityChange:d,onCategoryChange:u,onDueDateChange:h,onClaudeProjectChange:f,onForkSessionIdChange:g,onSessionIdsChange:w,onTagsChange:m,showForkSelector:x=!1,showSessionSelector:y=!1,showTags:v=!0,compact:N=!1}){const b=wo(py),S=wo(gy),I=p.useMemo(()=>b.map(T=>({value:T.path,label:T.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[b]),C=p.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...I],[I]),k=p.useCallback(T=>{const O=T.trim();O&&!c.includes(O)&&(m==null||m([...c,O]))},[c,m]),R=p.useCallback(T=>{m==null||m(c.filter(O=>O!==T))},[c,m]),A=p.useCallback(T=>{const O=Array.isArray(T)?T:[T];w==null||w(O)},[w]);return t.jsxs("div",{className:`todo-metadata-form space-y-4 ${N?"text-sm":""}`,"data-test":"todo-metadata-form",children:[t.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-metadata-status-selector",children:[t.jsx(Te,{"data-test":"todo-metadata-status-label",children:"Status"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(qd,{value:e,options:hy,onChange:T=>l==null?void 0:l(T),placeholder:"Search status...","data-test":"todo-metadata-status-select"})})]}),t.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-metadata-priority-selector",children:[t.jsx(Te,{"data-test":"todo-metadata-priority-label",children:"Priority"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(Fr,{value:s,options:uy,onChange:T=>d==null?void 0:d(T),placeholder:"Search priorities...",contentStyle:{zIndex:Ee.draggablePopoverDropdown},"data-test":"todo-metadata-priority-badge"})})]}),t.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-metadata-category-selector",children:[t.jsx(Te,{"data-test":"todo-metadata-category-label",children:"Category"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(Zd,{value:n||"personal",onChange:T=>u==null?void 0:u(T),placeholder:"Search categories...","data-test":"todo-metadata-category-select"})})]}),!S&&C.length>1&&t.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-metadata-project-selector",children:[t.jsx(Te,{"data-test":"todo-metadata-project-label",children:"Claude Project"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(Fr,{value:r??"__no_project__",options:C,onChange:T=>f==null?void 0:f(T),placeholder:"Search projects...",contentStyle:{zIndex:Ee.draggablePopoverDropdown},"data-test":"todo-metadata-project-badge"})})]}),x&&t.jsx(dy,{value:a,onChange:g,showLabel:!0,className:"w-full"}),y&&t.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-metadata-session-selector",children:[t.jsx(Te,{"data-test":"todo-metadata-session-selector-label",children:"Claude Sessions"}),t.jsx(Jd,{value:i,onChange:A,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-metadata-session-select"})]}),v&&t.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-metadata-tags-selector",children:[t.jsx(Te,{"data-test":"todo-metadata-tags-label",children:"Tags"}),t.jsx(my,{tags:c,onAddTag:k,onRemoveTag:R})]}),t.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-metadata-due-date-field",children:[t.jsx(Te,{htmlFor:"dueDate","data-test":"todo-metadata-due-date-label",children:"Due Date"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Sh,{className:"w-4 h-4 text-gray-400"}),t.jsx(Re,{id:"dueDate",type:"date",value:o,onChange:T=>h==null?void 0:h(T.target.value),"data-test":"todo-metadata-due-date-input"})]})]})]})}function my({tags:e,onAddTag:s,onRemoveTag:n}){const o=p.useCallback(a=>{if(a.key==="Enter"){a.preventDefault();const i=a.currentTarget;s(i.value),i.value=""}},[s]),r=p.useCallback(()=>{const a=document.querySelector('[data-test="todo-metadata-tag-input"]');a&&(s(a.value),a.value="")},[s]);return t.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-metadata-tags-container",children:[t.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-metadata-tags-list",children:e.map(a=>t.jsxs(tt,{variant:"outline",className:"tag-badge gap-1","data-test":"todo-metadata-tag",children:[a,t.jsx("button",{onClick:()=>n(a),className:"tag-remove ml-1 hover:text-red-500","data-test":"todo-metadata-tag-remove",children:t.jsx($e,{className:"w-3 h-3"})})]},a))}),t.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-metadata-tag-input-container",children:[t.jsx(Re,{onKeyDown:o,placeholder:"Add a tag...","data-test":"todo-metadata-tag-input"}),t.jsx(ee,{onClick:r,size:"sm",className:"tag-add-button","data-test":"todo-metadata-tag-add-button",children:t.jsx(yt,{className:"w-4 h-4"})})]})]})}const xy=({node:e})=>{const[s,n]=p.useState(!1),o=p.useRef(null),r=e.data,a=r==null?void 0:r.todo,i=p.useCallback(()=>{if(!o.current)return{x:100,y:100};const x=o.current.getBoundingClientRect();return{x:x.right+8,y:x.top}},[]),c=p.useCallback(x=>{const y=e.data??{},v=y.todo??{};E.getState().updateNode(e.id,{data:{...y,todo:{...v,...x}}})},[e.id,e.data]),l=p.useCallback(x=>{c({status:x})},[c]),d=p.useCallback(x=>{c({priority:x})},[c]),u=p.useCallback(x=>{c({category:x})},[c]),h=p.useCallback(x=>{c({dueDate:x||void 0})},[c]),f=p.useCallback(x=>{c({claudeProjectPath:x==="__no_project__"?void 0:x})},[c]),g=p.useCallback(x=>{c({sessionIds:x})},[c]),w=p.useCallback(x=>{c({forkSessionId:x??void 0})},[c]),m=a&&(a.status||a.priority||a.category||a.dueDate||a.claudeProjectPath||a.forkSessionId||a.sessionIds&&a.sessionIds.length>0);return t.jsxs(t.Fragment,{children:[t.jsx(ee,{ref:o,variant:"ghost",size:"icon",className:`todo-metadata-button h-8 w-8 ${m?"text-blue-500":"text-muted-foreground"}`,onClick:()=>n(!0),title:"Todo Metadata","data-test":"node-todo-metadata-button",children:t.jsx(Ch,{className:"h-4 w-4"})}),t.jsx(_e,{isVisible:s,onClose:()=>n(!1),title:"Todo Metadata",triggerPosition:i(),initialSize:{width:300,height:450},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx(Qd,{variant:"ghost",size:"icon",buttonTitle:"Create Claude Session",projectPath:a==null?void 0:a.claudeProjectPath,initialForkSessionId:a==null?void 0:a.forkSessionId,initialMessage:typeof e.content=="string"?e.content:"",useModal:!0}),children:t.jsx("div",{className:"p-4",children:t.jsx(fy,{status:a==null?void 0:a.status,priority:a==null?void 0:a.priority,category:a==null?void 0:a.category,dueDate:a==null?void 0:a.dueDate,claudeProject:a==null?void 0:a.claudeProjectPath,forkSessionId:a==null?void 0:a.forkSessionId,sessionIds:a==null?void 0:a.sessionIds,onStatusChange:l,onPriorityChange:d,onCategoryChange:u,onDueDateChange:h,onClaudeProjectChange:f,onForkSessionIdChange:w,onSessionIdsChange:g,showForkSelector:!0,showSessionSelector:!0,showTags:!1,compact:!0})})})]})},wy=({node:e})=>{const s=e.type===ce.GROUP,n=e.type===ce.VOCABULARY,o=J.nodeUI.idleOpacity;return t.jsxs("div",{className:je("node-actions-sidebar absolute","gap-1","items-center","hover:opacity-100 transition-opacity duration-200"),style:{left:-50,opacity:o},onMouseEnter:r=>{r.currentTarget.style.opacity="1"},onMouseLeave:r=>{r.currentTarget.style.opacity=String(o)},"data-test":"node-container-extra",children:[t.jsx("div",{className:"pin-button-wrapper",children:t.jsx(oy,{node:e})}),t.jsx("div",{className:"text-editor-button-wrapper",children:e.subContent?t.jsx(Ul,{className:"my-2"}):null}),t.jsx("div",{className:"tag-selector-wrapper",children:t.jsx(ny,{nodeId:e.id,tags:e.tags})}),t.jsx("div",{className:"todo-metadata-wrapper",children:t.jsx(xy,{node:e})}),s&&t.jsx("div",{className:"group-settings-button-wrapper","data-test":"group-settings-wrapper",children:t.jsx(cy,{node:e})}),n&&t.jsx("div",{className:"vocab-settings-button-wrapper","data-test":"vocab-settings-wrapper",children:t.jsx(ly,{node:e})})]})},yy={columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},vy=({node:e})=>{const{updateNode:s}=E.getState(),n=F(S=>{var I,C;return((I=S.uiState.tableDropTarget)==null?void 0:I.tableId)===e.id?((C=S.uiState.tableDropTarget)==null?void 0:C.columnKey)??null:null}),o=F(S=>{var I,C;return((I=S.uiState.tableDropTarget)==null?void 0:I.tableId)===e.id?((C=S.uiState.tableDropTarget)==null?void 0:C.rowIndex)??null:null}),[r,a]=p.useState(!1),i=p.useRef(null);p.useEffect(()=>{e.isEditing!==void 0&&e.isEditing!==r&&a(e.isEditing)},[e.isEditing]),p.useEffect(()=>{if(!r)return;const S=I=>{const C=I.target,k=i.current;k&&C.closest('[data-test="table-node-container"]')===k&&(I.stopPropagation(),I.preventDefault(),k.scrollTop+=I.deltaY,k.scrollLeft+=I.deltaX)};return document.addEventListener("wheel",S,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",S,{capture:!0})}},[r,e.id]);const c=e.data,l=c!=null&&c.rows&&(c!=null&&c.columns)?c:yy,d=p.useCallback((S,I)=>{const C=l.columns.map(k=>k.key===S?{...k,header:I}:k);s(e.id,{data:{...l,columns:C}})},[e.id,l,s]),u=p.useCallback(S=>{const I=l.rows.filter(C=>C.id!==S);s(e.id,{data:{...l,rows:I}})},[e.id,l,s]),h=p.useMemo(()=>{const S=l.columns.map(I=>hp(I.key,I.header,{width:I.width}));return S.push({id:"actions",header:()=>t.jsx("div",{"data-test":"actions-header"}),size:40,cell:({row:I})=>r?t.jsx(ee,{"data-test":"delete-row-button",variant:"ghost",size:"sm",onClick:()=>u(I.original.id),className:"h-6 w-6 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",children:t.jsx(vt,{className:"h-3 w-3"})}):null}),S},[l.columns,r,u]),f=p.useCallback((S,I,C)=>{const k=l.rows.map((R,A)=>A===S?{...R,[I]:C}:R);s(e.id,{data:{...l,rows:k}})},[e.id,l,s]),g=p.useCallback(()=>{const S={id:`row-${Date.now()}`};l.columns.forEach(I=>{S[I.key]=""}),s(e.id,{data:{...l,rows:[...l.rows,S]}})},[e.id,l,s]),w=p.useCallback(S=>{const I={id:`row-${Date.now()}`};l.columns.forEach(k=>{I[k.key]=""});const C=[...l.rows.slice(0,S),I,...l.rows.slice(S)];s(e.id,{data:{...l,rows:C}})},[e.id,l,s]),m=p.useCallback((S,I)=>{const C=[...l.rows],[k]=C.splice(S,1);C.splice(I,0,k),s(e.id,{data:{...l,rows:C}})},[e.id,l,s]),x=p.useCallback(S=>{s(e.id,{data:{...l,columnOrder:S}})},[e.id,l,s]),y=p.useCallback(()=>{const S=!r;a(S),s(e.id,{isEditing:S})},[r,e.id,s]),v=p.useCallback(()=>{r||(a(!0),s(e.id,{isEditing:!0}))},[r,e.id,s]),N=p.useCallback(S=>{r&&(S.stopPropagation(),S.nativeEvent.stopPropagation(),S.nativeEvent.stopImmediatePropagation())},[r,e.id]),b=p.useCallback(()=>{const S=i.current;if(!S)return;const I=document.querySelector("[data-canvas-container]"),C=I==null?void 0:I.getBoundingClientRect();Dc(async()=>{const{canvasStoreV2:k}=await import("./index-DPqC4dt9.js").then(R=>R.d9);return{canvasStoreV2:k}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({canvasStoreV2:k})=>{const R=k.getState().projectCanvas.getActive(),A=(R==null?void 0:R.viewState.scale)??1,T=(R==null?void 0:R.viewState.offset)??{x:0,y:0},O=H=>{if(!C)return null;const M=H.x-C.left,j=H.y-C.top;return{x:Math.round((M-T.x)/A),y:Math.round((j-T.y)/A),w:Math.round(H.width/A),h:Math.round(H.height/A)}};S.getBoundingClientRect();const $=S.querySelector("thead tr");$==null||$.getBoundingClientRect();const B=S.querySelectorAll("tbody tr");Array.from(B).map((H,M)=>({index:M,canvas:O(H.getBoundingClientRect())}))})},[e.id,e.x,e.y]);return t.jsx("div",{ref:i,"data-test":"table-node-container",style:{width:"100%",height:"100%",overflow:r?"auto":"hidden"},onDoubleClick:v,onWheel:N,onClick:b,children:t.jsx(pp,{data:l.rows,columns:h,isEditing:r,onDataUpdate:f,onHeaderUpdate:d,onAddNewRow:r?g:void 0,onInsertRow:r?w:void 0,enableColumnReorder:r,onColumnOrderChange:x,enableRowReorder:r,onRowOrderChange:m,highlightColumnKey:n,highlightRowIndex:o,topRight:t.jsxs("div",{className:"flex items-center gap-1","data-test":"table-header-actions",children:[t.jsx(ee,{"data-test":"table-edit-toggle",onClick:y,size:"sm",variant:"outline",className:"h-6 text-xs",children:r?"Done":"Edit"}),t.jsx(Uo,{storageKey:"table-node-drop-config",initialConfig:{dropBehavior:J.canvasTable.dropBehavior},children:(S,I,C)=>t.jsx(C,{size:"smIconCompact",variant:"ghost",title:"Table Drop Settings",contentClassName:"w-48",children:t.jsxs("div",{className:"space-y-3","data-test":"table-drop-config",children:[t.jsx("div",{className:"text-sm font-medium","data-test":"config-title",children:"On node drop"}),t.jsxs(eu,{value:S.dropBehavior,onValueChange:k=>I({dropBehavior:k}),"data-test":"drop-behavior-radio",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx($r,{value:"copy",id:"copy","data-test":"radio-copy"}),t.jsx(Te,{htmlFor:"copy",className:"text-sm cursor-pointer","data-test":"label-copy",children:"Copy nodes"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx($r,{value:"delete",id:"delete","data-test":"radio-delete"}),t.jsx(Te,{htmlFor:"delete",className:"text-sm cursor-pointer","data-test":"label-delete",children:"Delete nodes"})]})]})]})})})]})})})},by=({node:e,preventEdit:s})=>{var T;const n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(e.title||""),[l,d]=p.useState(e.content||""),{onEditStart:u,onEditEnd:h}=en(e.id,"title"),{onEditStart:f,onEditEnd:g}=en(e.id,"content"),w=E.getState(),m=w.updateNode,x=w.setMode,y=w.uiState.nodeToFocusId,v=(T=w.projectCanvas.getActive())==null?void 0:T.coreState,N=(v==null?void 0:v.selectedNodes)??[],b=N.some(O=>O.id===e.id),S=b&&y===e.id,I=O=>{c(O.target.value)},C=O=>{d(O.target.value)},k=p.useCallback(()=>{var O;m(e.id,{title:i,content:l,isEditing:!1}),h(i),g(l),a(!1),(O=window.getSelection())==null||O.removeAllRanges()},[e.id,m,i,l,h,g]),R=p.useCallback(()=>{b&&N.length<=1&&!s&&(r||(u(e.title||""),f(e.content||"")),a(!0),m(e.id,{isEditing:!0}))},[b,N.length,s,m,e.id,r,e.title,e.content,u,f]),A=p.useCallback(O=>{var $,B;if(O.key==="Escape"){k(),E.getState().uiState.mode!==Q.VIM&&x(Q.SELECT),($=n.current)==null||$.blur(),(B=o.current)==null||B.blur();return}},[k,x]);return p.useEffect(()=>{S&&r&&n.current&&n.current.focus()},[S,r]),p.useEffect(()=>{c(e.title||""),d(e.content||"")},[e.title,e.content]),t.jsxs("div",{className:"w-full h-full flex flex-col",children:[t.jsx("div",{className:"title-section border-b",children:t.jsx("input",{ref:n,type:"text",value:i,onChange:I,onBlur:k,onMouseDown:R,onKeyDown:A,placeholder:"Title...",className:je("w-full px-2 py-1","text-sm font-semibold","border-none focus:outline-none","bg-transparent",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})}),t.jsx("div",{className:"content-section flex-1",children:t.jsx("textarea",{ref:o,value:l,onChange:C,onBlur:k,onMouseDown:R,onKeyDown:A,placeholder:"Content...",className:je("w-full h-full","px-2 py-1","text-sm","border-none focus:outline-none","bg-transparent","resize-none","overflow-hidden",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})})]})},Ny=({node:e,isSingleNodeSelected:s,isCollapsed:n=!1})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(e.title||""),c=p.useRef(null),l=p.useRef(e.title||""),{onEditStart:d,onEditEnd:u}=en(e.id,"title");p.useEffect(()=>{i(e.title||""),l.current=e.title||""},[e.title]),p.useEffect(()=>{l.current=a},[a]),p.useEffect(()=>{o&&c.current&&(c.current.focus(),c.current.select())},[o]),p.useEffect(()=>{if(s)return()=>{const b=l.current.trim();b!==e.title&&E.getState().updateNodeTitle(e.id,b)}},[s,e.id,e.title]);const h=p.useCallback(()=>{const b=a.trim();b!==e.title&&E.getState().updateNodeTitle(e.id,b),u(b),r(!1)},[e.id,a,e.title,u]),f=p.useCallback(b=>{b.key==="Enter"?(b.preventDefault(),h()):b.key==="Escape"&&(b.preventDefault(),i(e.title||""),r(!1))},[h,e.title]),g=()=>{if(e.title)return e.title;if(typeof e.content=="string"){const b=e.content.split(`
`)[0];return b.length>50?b.substring(0,50)+"...":b}return"(empty)"},w=p.useMemo(()=>e.title?Zr(e.title):"",[e.title]),m=p.useMemo(()=>{const b=g();return Zr(b)},[e.title,e.content]),x=F(b=>{var C;const I=(((C=b.projectCanvas.getActive())==null?void 0:C.coreState.nodes)??[]).find(k=>k.id===e.id);return(I==null?void 0:I.isCollapsed)??!1}),y=p.useCallback(b=>{b.stopPropagation(),b.preventDefault(),E.getState().updateNode(e.id,{isCollapsed:!x})},[e.id,x]),v=J.nodeUI.idleOpacity,N=t.jsx(ee,{title:x?"Expand node":"Collapse node",variant:"ghost",size:"icon",onClick:y,className:"absolute h-6 w-6 flex-shrink-0 transition-opacity duration-200",style:{left:-43,opacity:v},onMouseEnter:b=>{b.currentTarget.style.opacity="1"},onMouseLeave:b=>{b.currentTarget.style.opacity=String(v)},"data-test":"node-title-collapse-button",children:x?t.jsx(nn,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(jt,{className:"h-3.5 w-3.5"})});return n?t.jsxs("div",{className:"markdown-textarea absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-collapsed",children:[N,t.jsx("div",{className:"px-2 py-0.5 bg-background/90 truncate border border-dashed border-muted-foreground rounded [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:m}})]}):!e.title&&!s?null:t.jsxs("div",{className:"absolute flex gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-container",children:[s&&N,s?t.jsx("input",{ref:c,type:"text",value:a,onChange:b=>i(b.target.value),onBlur:h,onKeyDown:f,placeholder:"Add title...",className:"relative left-0 text-xs px-2 py-0.5 bg-background/90 w-full",onClick:b=>{b.stopPropagation(),o||d(e.title||""),r(!0)}}):e.title?t.jsx("div",{className:"text-xs px-2 py-0.5 bg-background/90 truncate [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:w}}):null]})};function Sy(e,s){return e.node.title===s.node.title&&e.node.width===s.node.width&&e.node.content===s.node.content&&e.isSingleNodeSelected===s.isSingleNodeSelected&&e.isCollapsed===s.isCollapsed}const Cy=Ie.memo(Ny,Sy),jy=(e,s)=>p.useMemo(()=>{if(s.length!==1)return-1;const n=s[0].id;return e.findIndex(o=>o.id===n)},[e,s]),ky={[ce.RECT]:t.jsx($t,{className:"w-4 h-4"}),[ce.TEXT]:t.jsx(jh,{className:"w-4 h-4"})},ta=e=>ky[e]??null,Ay=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{const[r,a]=p.useState(!1),[i,c]=p.useState(null),[l,d]=p.useState(!1),u=p.useRef(null),h=p.useCallback(m=>{const y=(l?e:s).map(v=>{const N=Array.isArray(v.tags)?v.tags:[];if(N.some(I=>I.title===m))return v;const S={id:Math.random().toString(36).slice(2,10),title:m};return{...v,tags:[...N,S]}});n(y),o()},[l,e,s,n,o]),f=p.useCallback(m=>{const y=(l?e:s).map(v=>{const N=Array.isArray(v.tags)?v.tags:[];return N.some(S=>S.title===m)?{...v,tags:N.filter(S=>S.title!==m)}:v});n(y),o()},[l,e,s,n,o]),g=Ie.useMemo(()=>{const m=l?e:s,x=new Set;return m.forEach(y=>{(Array.isArray(y.tags)?y.tags:[]).forEach(N=>x.add(N.title))}),Array.from(x).sort()},[l,e,s]),w=Ie.useMemo(()=>{const m=new Set;return e.forEach(x=>{(Array.isArray(x.tags)?x.tags:[]).forEach(v=>m.add(v.title))}),Array.from(m).sort()},[e]);return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:u,onMouseDown:m=>m.stopPropagation(),onClick:m=>{if(m.stopPropagation(),u.current){const x=u.current.getBoundingClientRect();c({x:x.left,y:x.bottom+4})}a(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Tag nodes","data-test":"nodes-info-tag-button",children:t.jsx(Fn,{})}),t.jsx(_e,{isVisible:r,onClose:()=>a(!1),title:"Tag Nodes",triggerPosition:i??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"apply-to-section space-y-2 pb-2 border-b",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:m=>d(m.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"tag-apply-to-all-checkbox"}),t.jsx("span",{children:"Apply to all nodes"})]}),t.jsx("div",{className:"text-xs text-muted-foreground ml-6",children:l?`Will apply to all ${e.length} nodes`:`Will apply to ${s.length} selected node${s.length!==1?"s":""}`})]}),t.jsx(_o,{tags:g,onAddTag:h,onRemoveTag:f,canvasTags:w})]})})]})},Iy={content:!0,title:!1,id:!1,type:!1,tags:!1},gn=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const u=n?l:l.toLowerCase();let h=0,f=u.indexOf(a,h);for(;f!==-1;){const g=Math.max(0,f-40),w=Math.min(l.length,f+a.length+40);let m=l.substring(g,w);g>0&&(m="..."+m),w<l.length&&(m=m+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:m,startIndex:f,field:o}),h=f+1,f=u.indexOf(a,h)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let f=e.substring(u,h);u>0&&(f="..."+f),h<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},Ty=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...gn(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...gn(e.title,s,n,"title")),o.id&&e.id&&r.push(...gn(e.id,s,n,"id")),o.type&&e.type&&r.push(...gn(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...gn(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},Ey=e=>{const{node:s,matches:n}=e,o=ta(s.type),r=s.id.substring(0,6),a=typeof s.content=="string"?s.content:"",i=s.title?`${s.title.substring(0,30)}${s.title.length>30?"...":""}`:a?`${a.substring(0,30)}${a.length>30?"...":""}`:"(No Content)",c=s.title&&a?`${a.substring(0,50)}${a.length>50?"...":""}`:null;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[o&&t.jsx("span",{className:"flex-shrink-0",children:o}),t.jsx("span",{className:"truncate",children:i}),s.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(tt,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[n.length," ",n.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:r})]}),c&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:c})]})},Ry=(e,s,n,o)=>{const r=n?s:s.toLowerCase(),i=(n?e.context:e.context.toLowerCase()).indexOf(r);if(i===-1)return t.jsxs("div",{className:"text-xs font-mono flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:e.context})]});const c=e.context.substring(0,i),l=e.context.substring(i,i+s.length),d=e.context.substring(i+s.length);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsxs("span",{className:"flex-1",children:[c,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:l}),d]})]})},My=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(!1),[r,a]=p.useState(null),[i,c]=p.useState(""),[l,d]=p.useState(!1),[u,h]=p.useState(Iy),f=p.useRef(null),[g,w]=p.useState(new Set),[m,x]=p.useState(!1),y=l||u.title||u.id||u.type||u.tags||!u.content,v=p.useMemo(()=>{if(!i.trim())return[];if(!Object.values(u).some(A=>A))return[];const R=[];return e.forEach(A=>{if(g.has(A.id))return;const T=Ty(A,i,l,u);T&&R.push(T)}),R},[e,i,l,u,g]),N=p.useMemo(()=>v.reduce((k,R)=>k+R.matches.length,0),[v]),b=p.useCallback(()=>{if(v.length>0){const k=v.map(R=>R.node);s(k)}},[v,s]),S=p.useCallback(k=>{w(R=>new Set(R).add(k))},[]),I=p.useCallback(k=>{const R=k.node;s([R]),E.getState().scrollToNode(R.id)},[s]),C=p.useCallback((k,R)=>{const A=k.node;s([A]);const T=Ne.LINE_HEIGHT_FIND,O=R?(R-1)*T:0;Yn(A,{highlightYOffset:O})},[s]);return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:f,onMouseDown:k=>k.stopPropagation(),onClick:k=>{if(k.stopPropagation(),f.current){const R=f.current.getBoundingClientRect();a({x:R.left,y:R.bottom+4})}o(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Find nodes","data-test":"nodes-info-find-button",children:t.jsx(Ss,{})}),t.jsx(_e,{isVisible:n,onClose:()=>{o(!1)},title:"Find Nodes",triggerPosition:r??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-3 space-y-3","data-test":"find-nodes-popover-content",children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"find-nodes-search-section",children:[t.jsx(Ss,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"find-nodes-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search nodes...",value:i,onChange:k=>c(k.target.value),onKeyDown:k=>{k.key==="Enter"&&i.trim()&&(k.preventDefault(),b())},className:ve("h-8 text-sm pl-8",i?"pr-16":"pr-10"),autoFocus:!0,"data-test":"find-nodes-search-input"}),i&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>c(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"find-nodes-clear-button",children:t.jsx($e,{className:"h-3 w-3"})}),y&&t.jsx("div",{className:ve("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",i?"right-16":"right-11"),"data-test":"find-nodes-filter-indicator"}),t.jsxs(ct,{open:m,onOpenChange:x,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"find-nodes-settings-button",children:t.jsx(qo,{className:"h-3.5 w-3.5"})})}),t.jsx(dt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:Ee.draggablePopoverDropdown},"data-test":"find-nodes-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-case-sensitive",checked:l,onCheckedChange:k=>d(!!k),"data-test":"find-nodes-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"find-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-content",checked:u.content,onCheckedChange:k=>h(R=>({...R,content:!!k})),"data-test":"find-nodes-content-checkbox"}),t.jsx("label",{htmlFor:"find-node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-title",checked:u.title,onCheckedChange:k=>h(R=>({...R,title:!!k})),"data-test":"find-nodes-title-checkbox"}),t.jsx("label",{htmlFor:"find-node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-id",checked:u.id,onCheckedChange:k=>h(R=>({...R,id:!!k})),"data-test":"find-nodes-id-checkbox"}),t.jsx("label",{htmlFor:"find-node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-type",checked:u.type,onCheckedChange:k=>h(R=>({...R,type:!!k})),"data-test":"find-nodes-type-checkbox"}),t.jsx("label",{htmlFor:"find-node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-tags",checked:u.tags,onCheckedChange:k=>h(R=>({...R,tags:!!k})),"data-test":"find-nodes-tags-checkbox"}),t.jsx("label",{htmlFor:"find-node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]})]})})]})]}),i.trim()&&t.jsx("div",{className:"results-section space-y-2","data-test":"find-nodes-results-section",children:t.jsx("div",{className:"results-info flex items-center justify-between","data-test":"find-nodes-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground","data-test":v.length===0?"find-nodes-no-matches":"find-nodes-match-count",children:v.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found ",t.jsx(tt,{variant:"secondary",className:"mx-1","data-test":"find-nodes-total-matches-badge",children:N}),N===1?"match":"matches"," in"," ",t.jsx(tt,{variant:"secondary",className:"mx-1","data-test":"find-nodes-nodes-count-badge",children:v.length}),v.length===1?"node":"nodes"]})})})}),v.length>0&&t.jsx("div",{className:"nodes-list-section space-y-2 max-h-[400px] overflow-y-auto","data-test":"find-nodes-list-section",children:v.map(k=>t.jsx("div",{className:"node-matches-container border border-border rounded-md overflow-hidden","data-test":"find-nodes-result",children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>S(k.nodeId),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"find-nodes-remove-result-button",children:t.jsx($e,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none","data-test":"find-nodes-result-content",children:[t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:()=>I(k),"data-test":"find-nodes-result-header",children:Ey(k)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":"find-nodes-result-matches",children:k.matches.map((R,A)=>t.jsx("div",{onClick:T=>{T.stopPropagation(),C(k,R.lineNumber)},"data-test":"find-nodes-match",children:Ry(R,i,l)},A))})]})]})},k.nodeId))})]})})]})},Py=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{var N;const r=E.getState(),a=r.setNodeUpdateSettings,i=((N=r.uiState)==null?void 0:N.nodeUpdateSettings)??{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},[c,l]=p.useState(!1),[d,u]=p.useState(i.searchHistory[0]??""),[h,f]=p.useState(null),g=Ie.useRef(null),[w,m]=p.useState(i.deleteInAllNodes),[x,y]=p.useState(i.deleteWholeLine),v=p.useCallback(()=>{if(!d)return;const S=(w?e:s).map(C=>{if(typeof C.content!="string")return C;let k=C.content;x?k=k.split(`
`).filter($=>!$.includes(d)).join(`
`):k=k.split(d).join("");const R=C.width??Ne.DEFAULT_NODE_WIDTH,A=ht(k,R,C);return{...C,content:k,height:A}});n(S);const I=[d,...i.searchHistory.filter(C=>C!==d)].slice(0,10);a({deleteInAllNodes:w,deleteWholeLine:x,searchHistory:I}),o(),console.log(`Deleted "${d}" from ${S.length} nodes (wholeLine: ${x})`)},[d,w,x,e,s,n,i.searchHistory,a,o]);return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:g,onMouseDown:b=>b.stopPropagation(),onClick:b=>{if(b.stopPropagation(),g.current){const S=g.current.getBoundingClientRect();f({x:S.left,y:S.bottom+4})}l(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Update nodes","data-test":"nodes-info-update-button",children:t.jsx(Ks,{})}),t.jsx(_e,{isVisible:c,onClose:()=>l(!1),title:"Update Nodes",triggerPosition:h??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:d,onChange:b=>u(b.target.value),placeholder:"Text to delete...",className:"flex-1 px-2 py-1 text-sm border rounded bg-background","data-test":"update-nodes-search-input"}),t.jsxs("button",{onClick:v,disabled:!d,className:"flex items-center gap-1 px-2 py-1 text-sm rounded bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors","data-test":"update-nodes-delete-button",children:[t.jsx(vt,{className:"w-3 h-3"}),"Delete"]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:w,onChange:b=>{const S=b.target.checked;m(S),a({deleteInAllNodes:S}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-all-nodes-checkbox"}),t.jsx("span",{children:"Delete in all nodes"})]}),t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:x,onChange:b=>{const S=b.target.checked;y(S),a({deleteWholeLine:S}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-whole-line-checkbox"}),t.jsx("span",{children:"Delete whole line"})]})]}),t.jsx("div",{className:"text-xs text-muted-foreground",children:w?`Will update all ${e.length} nodes`:`Will update ${s.length} selected node${s.length!==1?"s":""}`})]})})]})},Dy=e=>{const s=ta(e.type),n=String(e.content??""),o=n?`${n.substring(0,15)}${n.length>15?"...":""}`:"(No Content)",r=e.id.substring(0,6),a=`[x:${Math.round(e.x)},y:${Math.round(e.y)}]`,i=`[w:${Math.round(e.width??0)},h:${Math.round(e.height??0)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"node-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"node-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"node-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"node-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"node-display-text",children:o}),e.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0","data-test":"node-display-editing-indicator",children:"[E]"})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"node-display-id",children:r})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1","data-test":"node-display-coords",children:[a," ",i]})]})},cd=e=>{const{className:s,style:n,nodes:o,headerText:r,initiallyExpanded:a}=e,i=E.getState(),c=i.projectCanvas.getActive(),l=o??(c==null?void 0:c.coreState.nodes)??[],d=(c==null?void 0:c.coreState.selectedNodes)??[],u=i.setSelectedNodes,h=i.scrollToNode,f=i.updateNodes,g=i.saveStateToLocalStorage,w=p.useCallback((y,v)=>{const N=y.length>0?y[0]:-1;if(N>=0&&N<l.length){const b=l[N];u([b]),h(b.id)}else u([])},[l,u,h]),m=jy(l,d),x=m!==-1?[m]:[];return t.jsx("div",{"data-ui-panel":"canvas-node-infos","data-test":"canvas-node-infos-container",className:je("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:y=>y.stopPropagation(),children:t.jsx(or,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-node-infos-header",children:r??"Nodes"}),itemList:l.map(Dy),onSelectionChange:w,selectedIndices:x,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!a,moreOptions:t.jsxs(t.Fragment,{children:[t.jsx(My,{nodes:l,setSelectedNodes:u}),t.jsx(Ay,{nodes:l,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:g}),t.jsx(Py,{nodes:l,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:g})]})})})},Oy=({tag:e})=>{const[s,n]=p.useState(!1),o=p.useMemo(()=>{if(!s)return[];const i=E.getState().projectCanvas.getActive();return((i==null?void 0:i.coreState.nodes)??[]).filter(l=>Array.isArray(l.tags)&&l.tags.some(d=>d.title===e.title))},[s,e.title]),r=p.useCallback(a=>{a.stopPropagation()},[]);return t.jsxs(ct,{open:s,onOpenChange:n,children:[t.jsx(lt,{asChild:!0,children:t.jsxs(tt,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-5 bg-background/90 text-muted-foreground font-normal italic cursor-pointer hover:bg-accent","data-test":"node-tag",onClick:r,children:["#",e.title]})}),t.jsx(dt,{className:"p-0 w-auto",align:"end",onPointerDownOutside:a=>a.stopPropagation(),onClick:a=>a.stopPropagation(),children:t.jsx(cd,{nodes:o,headerText:`#${e.title}`,className:"border-0",initiallyExpanded:!0})})]})},Ly=({node:e})=>!e.tags||!Array.isArray(e.tags)||e.tags.length===0?null:t.jsx("div",{className:"absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",right:"0px"},"data-test":"node-tags-container",children:e.tags.map(s=>t.jsx(Oy,{tag:s},s.id))});function Wy(e,s){const n=e.node.tags,o=s.node.tags;if(n===o)return!0;const r=Array.isArray(n),a=Array.isArray(o);return!r&&!a?!0:!r||!a||n.length!==o.length?!1:n.every((i,c)=>{var l,d;return i.id===((l=o[c])==null?void 0:l.id)&&i.title===((d=o[c])==null?void 0:d.title)})}const Hy=Ie.memo(Ly,Wy),ld=p.createContext(null),dd=()=>{const e=p.useContext(ld);if(!e)throw new Error("useWorkflowExecution must be used within a WorkflowExecutionProvider. Make sure CanvasAppV2 wraps its content with the provider.");return e},By=({children:e,value:s})=>t.jsx(ld.Provider,{value:s,children:e}),ud=({nodeId:e,label:s="Execute Workflow",className:n})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(null),c=dd(),{executeWorkflow:l}=c,d=h=>{h.stopPropagation()},u=async h=>{h.stopPropagation(),r(!0),i(null);try{await l(!1,e)}catch(f){const g=f instanceof Error?f.message:String(f);i(g)}finally{r(!1)}};return t.jsxs("div",{className:"w-full",children:[t.jsx(ee,{"data-test":"workflow-execute-button",onPointerDown:d,onClick:u,disabled:o,className:ve("w-full bg-primary hover:bg-primary/70 text-primary-foreground","disabled:bg-muted disabled:text-muted-foreground disabled:cursor-not-allowed",n),size:"sm",children:o?t.jsxs(t.Fragment,{children:[t.jsx(Gn,{className:"w-4 h-4 animate-spin"}),"Executing..."]}):t.jsxs(t.Fragment,{children:[t.jsx(st,{className:"w-4 h-4"}),s]})}),a&&t.jsxs("div",{className:"text-xs text-destructive mt-1",children:["Error: ",a]})]})},Fy=({executionState:e,duration:s,className:n})=>{if(!e||e==="idle")return null;const r={pending:{color:"bg-gray-500",textColor:"text-white",icon:null,label:"Pending"},running:{color:"bg-blue-500",textColor:"text-white",icon:t.jsx(Gn,{className:"w-3 h-3 animate-spin"}),label:"Running"},success:{color:"bg-green-500",textColor:"text-white",icon:t.jsx(Ys,{className:"w-3 h-3"}),label:"Success"},error:{color:"bg-red-500",textColor:"text-white",icon:t.jsx($e,{className:"w-3 h-3"}),label:"Error"}}[e];return t.jsxs("div",{"data-test":"workflow-execution-badge",className:ve("absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium","flex items-center gap-1",r.color,r.textColor,n),children:[r.icon&&t.jsx("span",{"data-test":"workflow-execution-badge-icon",children:r.icon}),t.jsx("span",{"data-test":"workflow-execution-badge-label",children:r.label}),s&&t.jsxs("span",{"data-test":"workflow-execution-badge-duration",className:"ml-1",children:["(",s,"ms)"]})]})};class so{static convertOrchestrationNode(s,n){var c;const o=s.data,r=((c=o==null?void 0:o.parameters)==null?void 0:c.rows)||[],a=this.convertRowsToNodes(r),i=[...this.createConnectionsFromRowHierarchy(r),...this.createConnectionsFromArrows(s.id,n)];return{nodes:a,connections:i}}static convertRowsToNodes(s){const n=[];for(const o of s){const r={id:o.id,type:o.stepType||"unknown",parameters:{label:o.label,order:o.order,...o.config||{}},inputHandles:this.createHandlesForStepType(o.stepType,"input",o.id),outputHandles:this.createHandlesForStepType(o.stepType,"output",o.id)};if(n.push(r),o.children&&o.children.length>0){const a=this.convertRowsToNodes(o.children);n.push(...a)}}return n}static createHandlesForStepType(s,n,o){const r=["source","transform","nodeUpdate","condition","if"],a=["source","transform","nodeUpdate","condition","if","loop"];return n==="input"&&r.includes(s)?[{id:`input_${o}`,name:"Input",type:"input",dataType:"any"}]:n==="output"&&a.includes(s)?[{id:`output_${o}`,name:"Output",type:"output",dataType:"any"}]:[]}static createConnectionsFromRowHierarchy(s,n){const o=[];for(const r of s)if(n&&o.push({id:`conn_${n}_to_${r.id}`,sourceNodeId:n,sourceHandleId:`output_${n}`,targetNodeId:r.id,targetHandleId:`input_${r.id}`}),r.children&&r.children.length>0){const a=this.createConnectionsFromRowHierarchy(r.children,r.id);o.push(...a)}return o}static createConnectionsFromArrows(s,n){const o=[],r=n.filter(a=>a.endNodeId===s&&a.endRowId);for(const a of r){const i={id:a.id,sourceNodeId:a.startNodeId||"",sourceHandleId:a.startRowId||`output_${a.startNodeId}`,targetNodeId:a.endRowId||"",targetHandleId:a.endRowId||`input_${a.endRowId}`};o.push(i)}return o}static getWorkflowName(s){return s.title||"Untitled Workflow"}static getWorkflowDescription(s){var r,a;const n=s.data,o=((a=(r=n==null?void 0:n.parameters)==null?void 0:r.rows)==null?void 0:a.length)||0;return`Workflow with ${o} step${o!==1?"s":""}`}}class $y{constructor(s=[]){Fe(this,"crudService");this.crudService=new zc(s)}create(s){const n=new Date().toISOString(),o=this.crudService.create({name:s.name,description:s.description,tags:s.tags||[],nodes:s.nodes||[],connections:s.connections||[],version:1,createdAt:n,updatedAt:n});if(!o)throw new Error("Failed to create workflow definition");return o}getAll(){return this.crudService.readAll()}getById(s){return this.crudService.readById(s)}update(s,n){const o=this.crudService.readById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt,updatedAt:new Date().toISOString(),version:(o.version||1)+1};return this.crudService.update(r),r}delete(s){this.crudService.delete(s)}findByTag(s){return this.crudService.readAll().filter(n=>{var o;return(o=n.tags)==null?void 0:o.includes(s)})}findByName(s){const n=s.toLowerCase();return this.crudService.readAll().filter(o=>o.name.toLowerCase().includes(n))}count(){return this.crudService.count()}clear(){this.crudService.clear()}updateNodes(s,n){return this.update(s,{nodes:n})}updateConnections(s,n){return this.update(s,{connections:n})}addNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.nodes,n];return this.updateNodes(s,r)}removeNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.nodes.filter(i=>i.id!==n),a=o.connections.filter(i=>i.sourceNodeId!==n&&i.targetNodeId!==n);return this.update(s,{nodes:r,connections:a})}addConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.connections,n];return this.updateConnections(s,r)}removeConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.connections.filter(a=>a.id!==n);return this.updateConnections(s,r)}duplicate(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);return this.create({name:n,description:o.description,tags:o.tags?[...o.tags]:void 0,nodes:o.nodes.map(r=>({...r})),connections:o.connections.map(r=>({...r}))})}}class Xa{constructor(s=[],n=[]){Fe(this,"definitionService");Fe(this,"instanceService");Fe(this,"executionFacade");this.definitionService=new $y(s),this.instanceService=new zc(n),this.executionFacade=new Zs}createDefinition(s){return this.definitionService.create(s)}getAllDefinitions(){return this.definitionService.getAll()}getDefinitionById(s){return this.definitionService.getById(s)}updateDefinition(s,n){return this.definitionService.update(s,n)}deleteDefinition(s){this.instanceService.filterByKey("definitionId",s).forEach(o=>this.instanceService.delete(o.id)),this.definitionService.delete(s)}findDefinitionsByTag(s){return this.definitionService.findByTag(s)}findDefinitionsByName(s){return this.definitionService.findByName(s)}duplicateDefinition(s,n){return this.definitionService.duplicate(s,n)}createInstance(s,n){const o=this.definitionService.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=new Date().toISOString(),a=this.instanceService.create({definitionId:s,name:n||o.name,status:"idle",createdAt:r,executionHistory:[]});if(!a)throw new Error("Failed to create workflow instance");return a}getAllInstances(){return this.instanceService.readAll()}getInstanceById(s){return this.instanceService.readById(s)}getInstancesByDefinitionId(s){return this.instanceService.filterByKey("definitionId",s)}updateInstance(s,n){const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt};this.instanceService.update(r)}deleteInstance(s){this.instanceService.delete(s)}async executeInstance(s,n={}){var a;const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r=this.definitionService.getById(o.definitionId);if(!r)throw new Error(`Workflow definition not found: ${o.definitionId}`);this.updateInstance(s,{status:"running"});try{const i=this.convertWorkflowNodesToCanvas(r.nodes),c=this.convertWorkflowConnectionsToCanvas(r.connections);this.executionFacade.loadWorkflow(i,c);const l=await this.executionFacade.executeWorkflow(n.triggerNodeId||((a=i[0])==null?void 0:a.id)||""),d=l.executionId?await this.executionFacade.getExecution(l.executionId):null;if(d){const h=[...o.executionHistory,d];this.updateInstance(s,{status:l.success?"completed":"failed",lastExecutedAt:new Date().toISOString(),executionHistory:h})}return{success:l.success,executionId:l.executionId||"",instanceId:s,definitionId:o.definitionId,duration:l.duration||0,executedNodeCount:l.executedNodeCount||0,errors:l.errors||[],nodeUpdates:l.nodeUpdates}}catch(i){throw this.updateInstance(s,{status:"failed"}),i}}getExecutionHistory(s){const n=this.instanceService.readById(s);if(!n)throw new Error(`Workflow instance not found: ${s}`);return n.executionHistory}clearExecutionHistory(s){this.updateInstance(s,{executionHistory:[]})}convertWorkflowNodesToCanvas(s){return s.map(n=>({id:n.id,x:0,y:0,type:"workflow",data:{nodeType:n.type,parameters:n.parameters,inputHandles:n.inputHandles,outputHandles:n.outputHandles},width:200,height:100}))}convertWorkflowConnectionsToCanvas(s){return s.map(n=>({id:n.id,startNodeId:n.sourceNodeId,endNodeId:n.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0},startRowId:n.sourceHandleId,endRowId:n.targetHandleId}))}getStats(){const s=this.instanceService.readAll(),n=s.reduce((o,r)=>(o[r.status]=(o[r.status]||0)+1,o),{});return{totalDefinitions:this.definitionService.count(),totalInstances:s.length,instancesByStatus:n}}clearAll(){this.definitionService.clear(),this.instanceService.clear()}}class qa{constructor(s,n){Fe(this,"workflowManager");this.getCanvasState=n,this.workflowManager=s||new Xa}saveWorkflow(s){const{nodeId:n,name:o,description:r,tags:a}=s,{node:i,arrows:c}=this.getNodeAndArrows(n),{nodes:l,connections:d}=so.convertOrchestrationNode(i,c),u=o||so.getWorkflowName(i),h=r||so.getWorkflowDescription(i),g=this.workflowManager.getAllDefinitions().find(w=>w.name===u);return g?this.workflowManager.updateDefinition(g.id,{nodes:l,connections:d,description:h,tags:a||g.tags}):this.workflowManager.createDefinition({name:u,description:h,tags:a||[],nodes:l,connections:d})}loadWorkflow(s){const{definitionId:n,position:o={x:100,y:100},existingNodeId:r}=s,a=this.workflowManager.getDefinitionById(n);if(!a)throw new Error(`Workflow definition not found: ${n}`);const i=this.convertWorkflowNodesToRows(a.nodes,a.connections);return{id:r||`workflow-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:a.name,content:a.description||"",x:o.x,y:o.y,width:400,height:600,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:i},inputHandles:this.createInputHandlesFromRows(i),outputHandles:[]}}}validateWorkflow(s){var r;const n=[],o=[];try{const{node:a,arrows:i}=this.getNodeAndArrows(s),c=a.data,l=((r=c==null?void 0:c.parameters)==null?void 0:r.rows)||[];l.length===0&&n.push("Workflow must have at least one step");const d=l.filter(g=>!g.stepType||g.stepType==="empty");d.length>0&&o.push(`${d.length} step(s) have no type configured`);const u=new Set(i.filter(g=>g.endNodeId===s&&g.endRowId).map(g=>g.endRowId)),f=l.filter(g=>g.stepType==="source").filter(g=>!u.has(g.id));return f.length>0&&o.push(`${f.length} source step(s) have no input connections`),{valid:n.length===0,errors:n,warnings:o}}catch(a){return{valid:!1,errors:[`Validation failed: ${String(a)}`],warnings:o}}}canSave(s){const n=this.validateWorkflow(s);return{valid:n.valid,errors:n.errors}}previewDefinition(s){const{node:n,arrows:o}=this.getNodeAndArrows(s),{nodes:r,connections:a}=so.convertOrchestrationNode(n,o);return{nodes:r,connections:a,nodeCount:r.length,connectionCount:a.length}}addRow(s){var f;const{nodeId:n,stepType:o,label:r,parentRowId:a,config:i}=s,{node:c}=this.getNodeAndArrows(n),l=c.data,d=((f=l==null?void 0:l.parameters)==null?void 0:f.rows)||[],u=d.length+1,h={id:Pe(),label:r||`Step ${u}`,order:u,stepType:o,config:i||{}};if(a){const g=this.addRowToParent(d,a,h);this.updateNodeRows(n,g)}else{const g=[...d,h];this.updateNodeRows(n,g)}return h}updateRow(s){var d;const{nodeId:n,rowId:o,updates:r}=s,{node:a}=this.getNodeAndArrows(n),i=a.data,c=((d=i==null?void 0:i.parameters)==null?void 0:d.rows)||[],l=this.updateRowRecursive(c,o,r);this.updateNodeRows(n,l)}deleteRow(s){var l;const{nodeId:n,rowId:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((l=a==null?void 0:a.parameters)==null?void 0:l.rows)||[],c=this.deleteRowRecursive(i,o);this.updateNodeRows(n,c)}reorderRows(s){var d;const{nodeId:n,rowOrders:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((d=a==null?void 0:a.parameters)==null?void 0:d.rows)||[],c=new Map(o.map(u=>[u.rowId,u.order])),l=this.updateRowOrders(i,c);this.updateNodeRows(n,l)}getTemplates(){return[{id:"simple-transform",name:"Simple Transform",description:"Data input → transformation → output"},{id:"conditional-flow",name:"Conditional Flow",description:"Data input → condition check → branching logic"},{id:"loop-process",name:"Loop Processing",description:"Data input → loop over items → process each"}]}createFromTemplate(s){const{templateId:n,name:o}=s,a={"simple-transform":{name:o||"Simple Transform Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"transform-1",type:"transform",parameters:{label:"Transform Data"},inputHandles:[{id:"input_transform-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_transform-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"transform-1",targetHandleId:"input_transform-1"}]},"conditional-flow":{name:o||"Conditional Flow Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"condition-1",type:"if",parameters:{label:"Check Condition"},inputHandles:[{id:"input_condition-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_condition-1_true",name:"True",type:"output",dataType:"any"},{id:"output_condition-1_false",name:"False",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"condition-1",targetHandleId:"input_condition-1"}]},"loop-process":{name:o||"Loop Processing Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"loop-1",type:"loop",parameters:{label:"Process Each Item"},inputHandles:[{id:"input_loop-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_loop-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"loop-1",targetHandleId:"input_loop-1"}]}}[n];if(!a)throw new Error(`Template not found: ${n}`);return this.workflowManager.createDefinition({name:a.name,description:`Created from ${n} template`,tags:["template",n],nodes:a.nodes,connections:a.connections})}exportWorkflow(s){const n=this.workflowManager.getDefinitionById(s);if(!n)throw new Error(`Workflow definition not found: ${s}`);return JSON.stringify(n,null,2)}exportWorkflows(s){const n=s.map(o=>this.workflowManager.getDefinitionById(o)).filter(o=>o!==void 0);return JSON.stringify(n,null,2)}exportAllWorkflows(){const s=this.workflowManager.getAllDefinitions();return JSON.stringify(s,null,2)}importWorkflow(s){try{const n=JSON.parse(s);if(!n.name||!Array.isArray(n.nodes)||!Array.isArray(n.connections))throw new Error("Invalid workflow format: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:n.name,description:n.description,tags:n.tags||[],nodes:n.nodes,connections:n.connections})}catch(n){throw new Error(`Failed to import workflow: ${n instanceof Error?n.message:String(n)}`)}}importWorkflows(s){try{const n=JSON.parse(s);if(!Array.isArray(n))throw new Error("Invalid format: expected array of workflows");return n.map(o=>{if(!o.name||!Array.isArray(o.nodes)||!Array.isArray(o.connections))throw new Error("Invalid workflow format in array: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:o.name,description:o.description,tags:o.tags||[],nodes:o.nodes,connections:o.connections})})}catch(n){throw new Error(`Failed to import workflows: ${n instanceof Error?n.message:String(n)}`)}}downloadWorkflow(s){const n=this.exportWorkflow(s),o=this.workflowManager.getDefinitionById(s);if(!o)return;const r=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`${o.name.replace(/[^a-z0-9]/gi,"_")}.workflow.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}downloadWorkflows(s){const n=this.exportWorkflows(s),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download=`workflows_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}bulkDeleteDefinitions(s){s.forEach(n=>{this.workflowManager.deleteDefinition(n)})}bulkDuplicateDefinitions(s){return s.map((n,o)=>{const r=this.workflowManager.getDefinitionById(n);if(!r)throw new Error(`Definition not found: ${n}`);return this.workflowManager.duplicateDefinition(n,`${r.name} (Copy ${o+1})`)})}bulkAddTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const a=r.tags||[],i=[...new Set([...a,...n])];this.workflowManager.updateDefinition(o,{tags:i})})}bulkRemoveTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const i=(r.tags||[]).filter(c=>!n.includes(c));this.workflowManager.updateDefinition(o,{tags:i})})}getBulkStats(s){const n=s.map(i=>this.workflowManager.getDefinitionById(i)).filter(i=>i!==void 0),o=new Set;let r=0,a=0;return n.forEach(i=>{r+=i.nodes.length,a+=i.connections.length,(i.tags||[]).forEach(c=>o.add(c))}),{count:n.length,totalNodes:r,totalConnections:a,tags:Array.from(o)}}getNodeAndArrows(s){if(!this.getCanvasState)throw new Error("Canvas state getter not provided");const{nodes:n,arrows:o}=this.getCanvasState(),r=n.find(a=>a.id===s);if(!r)throw new Error(`Node not found: ${s}`);return{node:r,arrows:o}}convertWorkflowNodesToRows(s,n){const o=new Map;for(const c of n)if(c.sourceHandleId.startsWith("output_")&&c.targetHandleId.startsWith("input_")){const l=c.sourceNodeId,d=c.targetNodeId;o.has(l)||o.set(l,[]),o.get(l).push(d)}const r=new Set,a=(c,l)=>{r.add(c.id);const u=(o.get(c.id)||[]).filter(h=>!r.has(h)).map((h,f)=>{const g=s.find(w=>w.id===h);return g?a(g,f+1):null}).filter(Boolean);return{id:c.id,label:c.parameters.label||`Step ${l}`,order:l,stepType:c.type,config:c.parameters,children:u.length>0?u:void 0}};return s.filter(c=>!n.some(l=>l.targetNodeId===c.id)).map((c,l)=>a(c,l+1))}createInputHandlesFromRows(s){const n=[],o=r=>{r.stepType==="source"&&n.push({id:`input_${r.id}`,name:r.label,type:"input",dataType:"any"}),r.children&&r.children.forEach(a=>o(a))};return s.forEach(o),n}updateNodeRows(s,n){if(!this.getCanvasState)throw new Error("Cannot update rows without canvas state");const o=this.createInputHandlesFromRows(n);return{rows:n,inputHandles:o}}addRowToParent(s,n,o){return s.map(r=>{if(r.id===n){const a=r.children||[];return{...r,children:[...a,o]}}return r.children?{...r,children:this.addRowToParent(r.children,n,o)}:r})}updateRowRecursive(s,n,o){return s.map(r=>r.id===n?{...r,...o}:r.children?{...r,children:this.updateRowRecursive(r.children,n,o)}:r)}deleteRowRecursive(s,n){return s.filter(o=>o.id!==n).map(o=>o.children?{...o,children:this.deleteRowRecursive(o.children,n)}:o)}updateRowOrders(s,n){return s.map(o=>{const r=n.get(o.id),a=r!==void 0?{...o,order:r}:o;return a.children?{...a,children:this.updateRowOrders(a.children,n)}:a}).sort((o,r)=>o.order-r.order)}}const hd="workflow-manager-storage",pd=()=>{try{const e=localStorage.getItem(hd);if(e)return JSON.parse(e)}catch(e){console.error("[WorkflowManager] Failed to load from localStorage:",e)}return null},zy=e=>{try{const s=JSON.stringify(e);localStorage.setItem(hd,s)}catch(s){console.error("[WorkflowManager] Failed to save to localStorage:",s)}},_s=pd(),zi=(_s==null?void 0:_s.definitions)||[],_i=(_s==null?void 0:_s.instances)||[],hs=Pc((e,s)=>{const n=new Xa(zi,_i);return{definitions:zi,instances:_i,facade:n,selectedDefinitionId:null,selectedInstanceId:null,isExecuting:!1,lastExecutionResult:null,createDefinition:o=>{const r=n.createDefinition(o),a=n.getAllDefinitions();return e({definitions:a}),s().saveToStorage(),r},updateDefinition:(o,r)=>{const a=n.updateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},deleteDefinition:o=>{n.deleteDefinition(o);const r=n.getAllDefinitions(),a=n.getAllInstances();e({definitions:r,instances:a,selectedDefinitionId:s().selectedDefinitionId===o?null:s().selectedDefinitionId}),s().saveToStorage()},duplicateDefinition:(o,r)=>{const a=n.duplicateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},findDefinitionsByTag:o=>n.findDefinitionsByTag(o),findDefinitionsByName:o=>n.findDefinitionsByName(o),createInstance:(o,r)=>{const a=n.createInstance(o,r),i=n.getAllInstances();return e({instances:i}),s().saveToStorage(),a},updateInstance:(o,r)=>{n.updateInstance(o,r);const a=n.getAllInstances();e({instances:a}),s().saveToStorage()},deleteInstance:o=>{n.deleteInstance(o);const r=n.getAllInstances();e({instances:r,selectedInstanceId:s().selectedInstanceId===o?null:s().selectedInstanceId}),s().saveToStorage()},getInstancesByDefinitionId:o=>n.getInstancesByDefinitionId(o),executeInstance:async(o,r)=>{e({isExecuting:!0});try{const a=await n.executeInstance(o,r),i=n.getAllInstances();return e({instances:i,isExecuting:!1,lastExecutionResult:a}),s().saveToStorage(),a}catch(a){throw e({isExecuting:!1}),a}},selectDefinition:o=>{e({selectedDefinitionId:o})},selectInstance:o=>{e({selectedInstanceId:o})},getStats:()=>n.getStats(),clearAll:()=>{n.clearAll(),e({definitions:[],instances:[],selectedDefinitionId:null,selectedInstanceId:null,lastExecutionResult:null}),s().saveToStorage()},loadFromStorage:()=>{const o=pd();if(o){const r=new Xa(o.definitions,o.instances);e({definitions:o.definitions,instances:o.instances,facade:r})}},saveToStorage:()=>{zy({definitions:s().definitions,instances:s().instances})}}}),_y=({node:e,nodes:s,arrows:n,updateNode:o})=>{var d;const r=e.data,a=((d=r==null?void 0:r.parameters)==null?void 0:d.rows)||[],i=hs.getState().definitions,c=()=>{try{const h=new qa(hs.getState().facade,()=>({nodes:s,arrows:n})).previewDefinition(e.id),f=typeof e.title=="string"?e.title:`Workflow ${e.id}`,g=typeof e.content=="string"?e.content:"",m=hs.getState().definitions.find(y=>y.name===f);let x;m?x=hs.getState().updateDefinition(m.id,{nodes:h.nodes,connections:h.connections,description:g}):x=hs.getState().createDefinition({name:f,description:g,tags:[],nodes:h.nodes,connections:h.connections}),be.success("Workflow saved",{description:`"${x.name}" saved successfully (v${x.version})`})}catch(u){be.error("Failed to save workflow",{description:u instanceof Error?u.message:String(u)})}},l=u=>{if(!u){be.error("No workflow selected",{description:"Please select a workflow to load"});return}try{const f=new qa(hs.getState().facade,()=>({nodes:s,arrows:n})).loadWorkflow({definitionId:u,existingNodeId:e.id});o(e.id,{title:f.title,content:f.content,data:f.data}),be.success("Workflow loaded",{description:`"${f.title}" loaded successfully`})}catch(h){be.error("Failed to load workflow",{description:h instanceof Error?h.message:String(h)})}};return t.jsx(Uo,{storageKey:`workflow-more-options-${e.id}`,initialConfig:{autoSaveEnabled:!1,selectedDefinitionId:""},children:(u,h,f)=>(p.useEffect(()=>{if(!u.autoSaveEnabled||a.length===0)return;const g=setTimeout(()=>{c()},3e3);return()=>clearTimeout(g)},[a,u.autoSaveEnabled]),t.jsx(f,{icon:t.jsx(pl,{className:"h-4 w-4"}),variant:"ghost",size:"icon",buttonClassName:"workflow-more-options-button",contentClassName:"w-80",title:"Workflow Options",children:t.jsxs("div",{className:"workflow-options-panel space-y-4",children:[t.jsxs("div",{className:"save-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Save Workflow"}),t.jsxs("button",{"data-test":"workflow-save-to-manager-button",onClick:g=>{g.stopPropagation(),c()},className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:[t.jsx(Qt,{className:"h-4 w-4"}),"Save to Workflow Manager"]})]}),t.jsxs("div",{className:"load-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Load Workflow"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Select a workflow to load into this node"}),t.jsxs(gt,{"data-test":"workflow-load-select",value:u.selectedDefinitionId,onValueChange:g=>{h({...u,selectedDefinitionId:g})},children:[t.jsx(ft,{"data-test":"workflow-load-select-trigger",children:t.jsx(mt,{placeholder:"Select workflow..."})}),t.jsx(xt,{children:i.length===0?t.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No saved workflows found"}):i.map(g=>t.jsxs(Ke,{value:g.id,children:[g.name," (v",g.version,")"]},g.id))})]}),t.jsxs("button",{"data-test":"workflow-load-confirm-button",onClick:g=>{g.stopPropagation(),l(u.selectedDefinitionId),h({...u,selectedDefinitionId:""})},disabled:!u.selectedDefinitionId,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm border rounded hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[t.jsx(kh,{className:"h-4 w-4"}),"Load"]})]}),t.jsx("div",{className:"auto-save-section space-y-2 pt-2 border-t",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"space-y-0.5",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Auto-Save"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically save after changes (3s delay)"})]}),t.jsx("button",{"data-test":"workflow-auto-save-toggle",onClick:g=>{g.stopPropagation();const w=!u.autoSaveEnabled;h({...u,autoSaveEnabled:w}),be.info(w?"Auto-save enabled":"Auto-save disabled",{description:w?"Workflow will save automatically after changes":"Manual save required"})},className:`w-10 h-10 flex items-center justify-center rounded transition-colors border ${u.autoSaveEnabled?"bg-primary text-primary-foreground border-primary":"hover:bg-accent border-border"}`,title:u.autoSaveEnabled?"Disable auto-save":"Enable auto-save",children:t.jsx(rs,{className:"h-4 w-4"})})]})})]})}))})},Vy=({node:e,nodes:s,arrows:n,showTextConfig:o,rows:r,updateNode:a,onToggleTextConfig:i,onSetJsonConfigText:c,onSetJsonError:l})=>{const d=e.data,{executeWorkflow:u,showDryRunResults:h}=dd(),f=w=>{if(w.stopPropagation(),!o){const m={nodeId:e.id,nodeType:d==null?void 0:d.nodeType,rows:r,connections:n.filter(x=>x.endNodeId===e.id||x.startNodeId===e.id)};c(JSON.stringify(m,null,2)),l(null)}i()},g=async w=>{w.stopPropagation();const m=await u(!0,e.id);h(m)};return t.jsxs("div",{className:"workflow-header font-semibold mb-2 text-sm border-b pb-1 flex justify-between items-center",children:[t.jsx("span",{children:o?"JSON Config":"Orchestration Rows"}),(d==null?void 0:d.showExecuteButton)&&t.jsxs("div",{className:"execute-button-container flex items-center gap-1.5",children:[t.jsx(ee,{"data-test":"workflow-toggle-json-button",onClick:f,variant:o?"default":"outline",size:"icon",className:"h-8 w-8",title:o?"View visual steps":"View workflow as JSON",children:o?t.jsx(Zt,{className:"h-4 w-4"}):t.jsx(Zo,{className:"h-4 w-4"})}),t.jsx(ee,{"data-test":"workflow-dry-run-button",onClick:g,variant:"outline",size:"icon",className:"h-8 w-8",title:"Dry Run (preview changes without applying)",children:t.jsx(Ss,{className:"h-4 w-4"})}),t.jsx(ud,{nodeId:e.id,label:"",className:"h-8 w-8"}),t.jsx(_y,{node:e,nodes:s,arrows:n,updateNode:a})]})]})},Uy=({node:e,jsonConfigText:s,jsonError:n,onJsonConfigTextChange:o,onJsonErrorChange:r,onClose:a,updateNode:i})=>{const c=e.data,l=f=>{f.stopPropagation();try{const g=JSON.parse(s);if(!g.rows||!Array.isArray(g.rows)){r('Invalid JSON: "rows" must be an array');return}i(e.id,{data:{...c,parameters:{...c.parameters,rows:g.rows}}}),r(null),a()}catch(g){r(`Invalid JSON: ${g.message}`)}},d=f=>{f.stopPropagation(),navigator.clipboard.writeText(s)},u=f=>{o(f.target.value),r(null)},h=f=>{f.preventDefault(),f.stopPropagation();const g=f.currentTarget,w=g.scrollTop<g.scrollHeight-g.clientHeight,m=g.scrollTop>0,x=f.deltaY>0;(x&&w||!x&&m)&&(g.scrollTop+=f.deltaY)};return t.jsxs("div",{className:"workflow-json-wrapper h-full w-full flex flex-col gap-1",onWheel:f=>{f.stopPropagation()},children:[t.jsx("div",{className:"workflow-textarea-parent flex-1 w-full min-h-0",onWheel:f=>{f.stopPropagation()},children:t.jsx("textarea",{value:s,onChange:u,onClick:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onWheel:h,className:"workflow-textarea w-full h-full text-[10px] font-mono bg-background border-0 p-1 resize-none focus:outline-none overflow-auto",spellCheck:!1})}),n&&t.jsx("div",{className:"text-[10px] text-destructive bg-destructive/10 border-t border-destructive/20 px-1 py-1",children:n}),t.jsxs("div",{className:"flex gap-1 border-t pt-1",children:[t.jsx("button",{"data-test":"workflow-json-save-button",onClick:l,className:"flex-1 px-2 py-1 text-[10px] bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:"Save"}),t.jsx("button",{"data-test":"workflow-json-copy-button",onClick:d,className:"px-2 py-1 text-[10px] border border-border rounded hover:bg-accent transition-colors",children:"Copy"})]})]})},Gy=({node:e,rows:s,rowElementsRef:n,connectorOffsetLeft:o,stepTypesWithConnectors:r})=>t.jsx("div",{"data-test":"workflow-connector-layer-container",className:"workflow-connector-layer absolute top-0 bottom-0 pointer-events-none",style:{left:`${o}px`},children:s.map(a=>{if(!r.includes(a.stepType))return null;const i=a.id.replace("row_",""),c=a.label||`Step ${i}`,l=n.current.get(a.id);if(!l)return null;const d=l.getBoundingClientRect(),u=l.closest(".bg-background.border.p-3");if(!u)return null;const h=u.getBoundingClientRect(),f=d.top+d.height/2-h.top;return t.jsx("div",{"data-test":"workflow-connector","data-row-connector":a.id,"data-node-id":e.id,className:"absolute w-3 h-3 rounded-full border-2 border bg-background cursor-crosshair hover:bg-accent transition-colors pointer-events-auto",style:{left:"0",top:`${f}px`,transform:"translateY(-50%)"},title:`Connect to ${c}`,onClick:g=>{g.stopPropagation()}},`connector-${a.id}`)})}),Yy=({node:e,rows:s,updateNode:n})=>{const o=e.data,[r,a]=p.useState(null),[i,c]=p.useState(!1),[l,d]=p.useState(!1),[u,h]=p.useState(!1),[f,g]=p.useState(null),[w,m]=p.useState(null),x=(R,A)=>{for(const T of R){if(T.id===A)return T;if(T.children){const O=x(T.children,A);if(O)return O}}return null},y=(R,A,T)=>R.map(O=>O.id===A?{...O,...T}:O.children?{...O,children:y(O.children,A,T)}:O),v=(R,A)=>R.filter(T=>T.id!==A).map(T=>T.children?{...T,children:v(T.children,A)}:T);return{selectedRowId:r,setSelectedRowId:a,configPopoverOpen:i,setConfigPopoverOpen:c,showNodeUpdateConfig:l,setShowNodeUpdateConfig:d,showIfStepConfig:u,setShowIfStepConfig:h,popoverPosition:f,popoverSize:w,handleAddRow:()=>{const R=s.length+1,A={id:Pe(),label:`Step ${R}`,order:R,stepType:"empty"},T=[...s,A];T.sort((B,H)=>B.order-H.order);const $=T.filter(B=>Tn.includes(B.stepType)).map(B=>({id:`input_${B.id}`,name:B.label,type:"input",dataType:"any"}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:T},inputHandles:$}})},handleRowClick:(R,A,T)=>{const O=x(s,R);a(R);const $=window.innerWidth,B=window.innerHeight,H=A.clientX,M=A.clientY,P=H<$/2?H+100:H-100;g({x:P,y:M});const W=Math.min(450,Math.floor(B*.6));if(m({width:500,height:W}),T==="badge")c(!0);else if(T==="gear"){const z=O==null?void 0:O.stepType;z==="nodeUpdate"?d(!0):z==="if"&&h(!0)}},handleConfigureRow:(R,A)=>{const T=y(s,R,{stepType:A});n(e.id,{data:{...o,parameters:{...o.parameters,rows:T}}}),a(null)},handleDeleteRow:R=>{const A=v(s,R),O=A.filter($=>Tn.includes($.stepType)).map(($,B)=>({id:$.id,position:"left",offsetY:96+B*32}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:A},inputHandles:O}})},handleSaveNodeUpdateConfig:R=>{if(!r)return;const A=y(s,r,{stepType:"nodeUpdate",config:R});n(e.id,{data:{...o,parameters:{...o.parameters,rows:A}}}),d(!1),a(null)},handleSaveIfStepConfig:R=>{if(!r)return;const A=y(s,r,{stepType:"if",config:R});n(e.id,{data:{...o,parameters:{...o.parameters,rows:A}}}),h(!1),a(null)},findRowRecursive:x}},Vi=({node:e})=>{var C,k,R;const s=e.data,n=((C=s==null?void 0:s.parameters)==null?void 0:C.rows)||[],[o,r]=p.useState(!1),[a,i]=p.useState(""),[c,l]=p.useState(null);p.useEffect(()=>{if(!o)return;const A=T=>{var $;const O=T.target;if(O.closest(".workflow-json-wrapper")){const B=($=O.closest(".workflow-json-wrapper"))==null?void 0:$.querySelector("textarea");if(B){T.stopPropagation(),T.preventDefault();const H=B.scrollTop<B.scrollHeight-B.clientHeight,M=B.scrollTop>0,j=T.deltaY>0;(j&&H||!j&&M)&&(B.scrollTop+=T.deltaY)}}};return document.addEventListener("wheel",A,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",A,{capture:!0})}},[o]);const[d,u]=p.useState(()=>new Set(n.filter(A=>A.children&&A.children.length>0).map(A=>A.id))),h=p.useRef(null),f=p.useRef(new Map),[g,w]=p.useState(null),m=F(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.arrows)??[]}),x=F(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.nodes)??[]}),v=F(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??[]}).some(A=>A.id===e.id),{updateNode:N}=E.getState(),b=Yy({node:e,rows:n,updateNode:N}),S=m.filter(A=>A.endNodeId===e.id&&A.endRowId);p.useEffect(()=>{let A=[...n],T=!1;const O=new Set;S.forEach(B=>{B.endRowId&&O.add(B.endRowId)});const $=A.length;if(A=A.filter(B=>{const H=B.stepType&&B.stepType!=="empty";return O.has(B.id)||H}),A.length!==$&&(T=!0),T){A.sort((M,j)=>M.order-j.order);const H=A.filter(M=>Tn.includes(M.stepType)).map(M=>({id:`input_${M.id}`,name:M.label,type:"input",dataType:"any"}));N(e.id,{data:{...s,parameters:{...s.parameters,rows:A},inputHandles:H}})}},[S.length,e.id,N]),p.useEffect(()=>(h.current=new gp({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:()=>!0,onDragMove:({sortIndex:A})=>{A!==null&&w(A)},onDrop:({item:A,sortIndex:T})=>{if(T==null)return;const O=A.data.rowId,$=[...n],B=$.findIndex(P=>P.id===O);if(B===-1)return;const[H]=$.splice(B,1);$.splice(T,0,H),$.forEach((P,W)=>{P.order=W+1});const j=$.filter(P=>Tn.includes(P.stepType)).map((P,W)=>({id:P.id,position:"left",offsetY:96+W*32}));N(e.id,{data:{...s,parameters:{...s.parameters,rows:$},inputHandles:j}})},onDragEnd:()=>{w(null)}}),()=>{var A;(A=h.current)==null||A.destroy(),f.current.clear()}),[e.id]),p.useEffect(()=>{if(!h.current)return;const A=document.querySelector(`[data-workflow-rows="${e.id}"]`);A&&!A.dataset.dropZoneRegistered&&(h.current.registerDropZone(`workflow-rows-${e.id}`,A,void 0,{nodeId:e.id}),A.dataset.dropZoneRegistered="true"),n.forEach(O=>{const $=document.querySelector(`[data-drag-handle="${O.id}"]`);$&&!$.dataset.dndRegistered&&(h.current.registerDraggable(O.id,$,{rowId:O.id}),$.dataset.dndRegistered="true")});const T=new Set(n.map(O=>O.id));f.current.forEach((O,$)=>{T.has($)||(h.current.unregisterDraggable($),f.current.delete($))})},[n,e.id]);const I=A=>{const O=A.target.closest("[data-drag-handle]"),$=document.querySelector(`[data-node-id="${e.id}"]`);$==null||$.getBoundingClientRect(),n.map(B=>{const H=document.querySelector(`[data-workflow-row="${e.id}:${B.id}"]`);if(H){const M=H.getBoundingClientRect();return{rowId:B.id,screenY:M.top+M.height/2,top:M.top,bottom:M.bottom,height:M.height}}return{rowId:B.id,error:"element not found"}}),v&&!O&&A.stopPropagation()};return t.jsxs("div",{"data-test":"workflow-orchestration-node",className:"workflow-node-container bg-background border p-3 w-full h-full flex flex-col relative overflow-visible",onPointerDown:I,children:[t.jsx(Gy,{node:e,rows:n,rowElementsRef:f,connectorOffsetLeft:cp,stepTypesWithConnectors:Tn}),t.jsx(Vy,{node:e,nodes:x,arrows:m,showTextConfig:o,rows:n,updateNode:N,onToggleTextConfig:()=>r(!o),onSetJsonConfigText:i,onSetJsonError:l}),t.jsx("div",{"data-test":"workflow-content-area",className:"workflow-content-area flex-1 w-full text-xs overflow-y-auto relative","data-workflow-rows":e.id,onWheel:A=>{o&&A.stopPropagation()},children:o?t.jsx(Uy,{node:e,jsonConfigText:a,jsonError:c,onJsonConfigTextChange:i,onJsonErrorChange:l,onClose:()=>r(!1),updateNode:N}):t.jsx(fp,{data:n,defaultExpandedIds:d,onReorder:A=>{const T=(H,M=1)=>H.map((j,P)=>{const W=M+P;return{...j,order:W,children:j.children?T(j.children,W*10):j.children}}),O=T(A),$=new Set(O.filter(H=>H.children&&H.children.length>0).map(H=>H.id)),B=new Set(d);$.forEach(H=>{d.has(H)||B.add(H)}),u(B),N(e.id,{data:{...s,parameters:{...s.parameters,rows:O}}})},renderCustomContent:A=>t.jsx(lp,{row:A,node:e,nodes:x,incomingArrows:S,selectedRowId:b.selectedRowId,configPopoverOpen:b.configPopoverOpen,rowElementsRef:f,onRowClick:b.handleRowClick,onConfigureRow:b.handleConfigureRow,onDeleteRow:b.handleDeleteRow,onSelectedRowIdChange:b.setSelectedRowId})})}),t.jsx("button",{"data-test":"workflow-add-row-button",onClick:b.handleAddRow,className:"mt-2 w-full py-1 text-xs border bg-background hover:bg-accent rounded",children:"+ Add Row"}),b.showNodeUpdateConfig&&b.selectedRowId&&t.jsx(dp,{isVisible:b.showNodeUpdateConfig,onClose:()=>{b.setShowNodeUpdateConfig(!1),b.setSelectedRowId(null)},allNodes:x,currentConfig:(k=b.findRowRecursive(n,b.selectedRowId))==null?void 0:k.config,onSave:b.handleSaveNodeUpdateConfig,initialPosition:b.popoverPosition||void 0,initialSize:b.popoverSize||void 0}),b.showIfStepConfig&&b.selectedRowId&&t.jsx(up,{isVisible:b.showIfStepConfig,onClose:()=>{b.setShowIfStepConfig(!1),b.setSelectedRowId(null)},currentConfig:(R=b.findRowRecursive(n,b.selectedRowId))==null?void 0:R.config,onSave:b.handleSaveIfStepConfig,initialPosition:b.popoverPosition||void 0,initialSize:b.popoverSize||void 0})]})},Ky="type here...",Xy=({node:e,preventEdit:s})=>{var R;const n=p.useRef(null),[o,r]=p.useState(s),[a,i]=p.useState(e.content||""),c=e.data,l=(c==null?void 0:c.displayFormat)||"raw",{updateNodeContent:d,updateNode:u,setMode:h}=E.getState(),f=F(A=>A.uiState.nodeToFocusId);F(A=>{var T;return((T=A.uiState.dragInfo)==null?void 0:T.draggedNodeId)===e.id});const g=F(A=>{var T,O;return((O=(T=A.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)==null?void 0:O.some($=>$.id===e.id))??!1}),w=g&&f===e.id,m=F(A=>{var T,O;return((O=(T=A.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)==null?void 0:O.length)??0}),{fitNodeDimensions:x}=on(),y=p.useMemo(()=>{if(l==="json")try{const A=JSON.parse(a);return JSON.stringify(A,null,2)}catch{return a}return a},[a,l]),v=A=>{i(A.target.value)},N=p.useCallback(A=>{A.preventDefault();const T=A.clipboardData.getData("text"),O=n.current;if(!O)return;const $=O.selectionStart,B=O.selectionEnd,H=O.value,M=H.substring(0,$)+T+H.substring(B);O.value=M;const j=$+T.length;O.setSelectionRange(j,j),i(M),d(e.id,M)},[e.id,d]),b=p.useCallback(A=>{r(A),u(e.id,{isEditing:A})},[u,e.id]),S=p.useCallback(()=>{var A;d(e.id,a),b(!1),u(e.id,{isEditing:!1}),(A=window.getSelection())==null||A.removeAllRanges()},[e.id,d,a,u]),I=p.useCallback(A=>{if(A.shiftKey){!o&&g&&m<=1&&(b(!0),setTimeout(()=>{var O;return(O=n.current)==null?void 0:O.focus()},0));return}const T=g&&m<=1;T&&b(T)},[o,g,m]),C=p.useCallback(A=>{var W,L,z,_;if(A.key==="Escape"){S(),b(!1),E.getState().uiState.mode!==Q.VIM&&h(Q.SELECT),(W=n.current)==null||W.blur();return}if(A.key==="Enter"&&A.ctrlKey){const G=((L=n.current)==null?void 0:L.value)||"";d(e.id,G);return}const T=((z=n.current)==null?void 0:z.value)??"",O=j(T),$=M(),B=P(T,A.key==="Enter",$),H=(_=e.options)!=null&&_.lockSize?e.width:O;u(e.id,{width:H,height:B,isEditing:!0});function M(){const G=n.current;if(G){const D=window.getComputedStyle(G).lineHeight;if(D&&D!=="normal"){const K=parseFloat(D);if(!isNaN(K))return K}}return Ne.LINE_HEIGHT}function j(G,V=Ne.DEFAULT_NODE_WIDTH,D=vs.textNodeXPadding){const ie=G.split(/\n/).map(q=>yo(q)).reduce((q,le)=>Math.max(q,le),0)+D,ye=Math.max(ie,V);return Math.max(ye,e.width??0)}function P(G,V=!1,D=Ne.LINE_HEIGHT){let te=G.split(/\n/).length,ie=Ne.DEFAULT_NODE_HEIGHT;return te===1&&!V?(ie=Math.max(ie,e.height??0),ie):(V&&(te+=1),ie+=(te-1)*D,ie=Math.max(ie,e.height??0),ie)}},[S,d,u,e.id,e.width]);p.useEffect(()=>{f||b(!1)},[f]),p.useEffect(()=>{w&&(b(!0),i(e.content||""),window.setTimeout(()=>{const A=n.current;A&&(A.focus(),A.selectionStart=A.selectionEnd=A.value.length)},0))},[w,e.content]),p.useEffect(()=>{i(e.content||"")},[e.content]);const k=p.useCallback(()=>{const A=l==="raw"?"json":"raw";u(e.id,{data:{...c,displayFormat:A}})},[l,e.id,c,u]);return t.jsxs("div",{className:"relative w-full h-full",children:[g&&t.jsx("button",{onClick:k,className:"absolute -top-7 right-0 z-50 px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",title:`Switch to ${l==="raw"?"JSON":"raw"} format`,children:l==="raw"?"Raw":"JSON"}),t.jsx("textarea",{spellCheck:!1,ref:n,id:`WorkflowSourceNode-${e.id}`,value:o?a:y,onChange:v,onPaste:N,onBlur:S,onKeyDown:C,onMouseDown:I,placeholder:Ky,"data-is-editing":s?!1:o,className:je("relative z-10","m-0 p-1 w-full h-full","resize-none","overflow-hidden","border","font-mono",e.className,{"pointer-events-none":s,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!a&&!o}),style:{textAlign:(R=e.styles)==null?void 0:R.textAlign,fontSize:l==="json"?`${Ne.FONT_SIZE_XXS}px`:J.text.fontSize,lineHeight:l==="json"?"1.4":"1.5"},readOnly:!o})]})},Ui=Ie.memo(Xy),ut=e=>kt(hs,e),qy=({node:e,preventEdit:s})=>{const{updateNode:n}=E.getState(),o=F(y=>{var v,N;return((N=(v=y.projectCanvas.getActive())==null?void 0:v.coreState.selectedNodes)==null?void 0:N.some(b=>b.id===e.id))??!1}),r=ut(y=>y.definitions),a=ut(y=>y.createInstance),i=ut(y=>y.executeInstance),c=ut(y=>y.isExecuting),l=e.data||{},{definitionId:d,instanceId:u,lastExecutionStatus:h="idle"}=l,f=p.useMemo(()=>r.find(y=>y.id===d),[r,d]),g=p.useCallback(y=>{const v=a(y,`${(f==null?void 0:f.name)||"Workflow"} Instance`);n(e.id,{data:{...l,definitionId:y,instanceId:v.id,lastExecutionStatus:"idle"},title:(f==null?void 0:f.name)||"Workflow"})},[e.id,l,n,a,f]),w=p.useCallback(async()=>{if(!u){console.warn("No instance selected");return}try{n(e.id,{data:{...l,lastExecutionStatus:"running"}});const y=await i(u);n(e.id,{data:{...l,lastExecutionStatus:y.success?"completed":"failed"}})}catch{n(e.id,{data:{...l,lastExecutionStatus:"failed"}})}},[u,l,e.id,n,i]),m=p.useMemo(()=>{switch(h){case"running":return t.jsx(Gn,{className:"h-4 w-4 animate-spin text-blue-500"});case"completed":return t.jsx(Ih,{className:"h-4 w-4 text-green-500"});case"failed":return t.jsx(Ah,{className:"h-4 w-4 text-red-500"});default:return t.jsx(Ns,{className:"h-4 w-4 text-gray-400"})}},[h]),x=p.useMemo(()=>{switch(h){case"running":return"border-blue-500";case"completed":return"border-green-500";case"failed":return"border-red-500";default:return"border-border"}},[h]);return t.jsxs("div",{className:je("workflow-definition-node w-full h-full p-3 bg-background border-2 rounded flex flex-col gap-2",x,{"ring-2 ring-primary":o}),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ns,{className:"h-5 w-5 text-primary"}),t.jsx("span",{className:"text-sm font-semibold",children:"Workflow"})]}),m]}),t.jsxs(gt,{value:d||"",onValueChange:g,disabled:s,children:[t.jsx(ft,{className:"w-full h-8 text-xs",children:t.jsx(mt,{placeholder:"Select workflow..."})}),t.jsx(xt,{children:r.length===0?t.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"No workflows available"}):r.map(y=>t.jsx(Ke,{value:y.id,className:"text-xs",children:y.name},y.id))})]}),d&&t.jsx("div",{className:"flex gap-1",children:t.jsxs(ee,{size:"sm",variant:"default",className:"flex-1 h-7 text-xs",onClick:w,disabled:!d||c||s,children:[t.jsx(st,{className:"h-3 w-3 mr-1"}),"Execute"]})}),f&&o&&t.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[t.jsxs("div",{children:["Nodes: ",f.nodes.length]}),t.jsxs("div",{children:["Connections: ",f.connections.length]}),f.tags&&f.tags.length>0&&t.jsx("div",{className:"flex gap-1 flex-wrap",children:f.tags.map(y=>t.jsx("span",{className:"px-1 py-0.5 bg-primary/10 text-primary rounded text-[10px]",children:y},y))})]})]})},Zy=Ie.memo(qy),Jy=({node:e})=>{const{updateNode:s}=E.getState(),n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),i=p.useRef(null),c=F(A=>{var O;const T=A.projectCanvas.getActive();return((O=T==null?void 0:T.coreState.selectedNodes)==null?void 0:O.some($=>$.id===e.id))??!1}),l=F(A=>{var O;const T=A.projectCanvas.getActive();return((O=T==null?void 0:T.coreState.nodes)==null?void 0:O.length)??0}),d=e.data||{},[u,h]=p.useState(d.image||null),{result:f,isProcessing:g,error:w,processBlob:m,cancel:x,reset:y}=mp();p.useEffect(()=>{o.current&&c&&o.current.focus()},[c]),p.useEffect(()=>{if(!c)return;const A=async T=>{var $;T.preventDefault(),T.stopPropagation();const O=($=T.clipboardData)==null?void 0:$.items;if(O){for(const B of O)if(B.type.startsWith("image/")){const H=B.getAsFile();if(H){const M=new FileReader;M.onload=()=>{const j=M.result;h(j),y(),s(e.id,{data:{...d,image:j}})},M.readAsDataURL(H)}break}}};return document.addEventListener("paste",A),()=>{document.removeEventListener("paste",A)}},[c,e.id,d,s,y]),p.useEffect(()=>{if(!f)return;const A=f.timestamp.toISOString();if(i.current===A)return;const T=f.extractedText||"[No text detected in image]",O={image:u||void 0,extractedText:f.extractedText,detectedLanguage:f.detectedLanguage,confidence:f.confidence,processingTime:f.processingTime,timestamp:f.timestamp.toISOString()};s(e.id,{data:O,content:f.extractedText});const $=Le.buildTextNodeV2({content:T});Jo($,e,"right",{shouldFocus:!1}),i.current=A},[f,u,e.id,e,s,l]);const v=p.useCallback(async A=>{var O;const T=(O=A.target.files)==null?void 0:O[0];if(T&&T.type.startsWith("image/")){const $=new FileReader;$.onload=()=>{const B=$.result;h(B),y(),s(e.id,{data:{...d,image:B}})},$.readAsDataURL(T)}},[y,e.id,d,s]),N=p.useCallback(async()=>{if(!u)return;const T=await(await fetch(u)).blob();await m(T)},[u,m]),b=p.useCallback(async()=>{if(!u)return;const T=await(await fetch(u)).blob();await m(T,{downscale:!0,downscaleFactor:.5})},[u,m]),S=p.useCallback(()=>{x()},[x]),I=p.useCallback(()=>{h(null),y(),n.current&&(n.current.value=""),s(e.id,{data:{},content:""})},[y,e.id,s]),C=p.useCallback(async()=>{const A=(f==null?void 0:f.extractedText)||d.extractedText;if(A)try{await navigator.clipboard.writeText(A),a(!0),setTimeout(()=>a(!1),2e3)}catch(T){console.error("Failed to copy:",T)}},[f,d]),k=p.useCallback(A=>{var O;A.preventDefault(),A.stopPropagation();const T=(O=A.clipboardData)==null?void 0:O.items;if(T){for(const $ of T)if($.type.startsWith("image/")){const B=$.getAsFile();if(B){const H=new FileReader;H.onload=()=>{const M=H.result;h(M),y(),s(e.id,{data:{...d,image:M}})},H.readAsDataURL(B)}break}}},[e.id,d,y,s]),R=f||(d.extractedText?{extractedText:d.extractedText,detectedLanguage:d.detectedLanguage,confidence:d.confidence,processingTime:d.processingTime}:null);return t.jsxs("div",{className:"canvas-ocr-node w-full h-full p-4 flex flex-col gap-3 overflow-auto",children:[t.jsxs("div",{className:"ocr-header flex items-center justify-between pb-2 border-b border-border",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(lo,{className:"h-4 w-4 text-primary"}),t.jsx("h3",{className:"text-sm font-semibold",children:"OCR Node"})]}),u&&t.jsx(ee,{"data-test":"ocr-clear-button",variant:"ghost",size:"sm",onClick:I,className:"h-6 px-2",children:t.jsx($e,{className:"h-3 w-3"})})]}),t.jsx("div",{ref:o,className:"image-input-area border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onPaste:k,tabIndex:0,role:"button","aria-label":"Paste image area",children:u?t.jsxs("div",{className:"image-preview-container space-y-2",children:[t.jsx("img",{src:u,alt:"OCR preview",className:"image-preview max-w-full max-h-32 mx-auto rounded-lg shadow-sm"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for OCR"})]}):t.jsxs("div",{className:"empty-state space-y-2",children:[t.jsx($n,{className:"w-6 h-6 mx-auto text-muted-foreground"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Paste image (Ctrl+V) or upload"})]})}),t.jsxs("div",{className:"upload-controls",children:[t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:v,className:"hidden"}),t.jsxs(ee,{"data-test":"ocr-upload-button",variant:"outline",size:"sm",onClick:()=>{var A;return(A=n.current)==null?void 0:A.click()},className:"w-full",children:[t.jsx($n,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]}),w&&!g&&t.jsxs(xp,{variant:"destructive",children:[t.jsx(jo,{className:"h-4 w-4"}),t.jsx(wp,{className:"text-xs",children:w})]}),t.jsx("div",{className:"ocr-controls flex flex-col gap-2",children:g?t.jsxs(ee,{"data-test":"ocr-cancel-button",variant:"destructive",onClick:S,className:"w-full",size:"sm",children:[t.jsx(Gn,{className:"w-3 h-3 mr-2 animate-spin"}),"Cancel"]}):t.jsxs(t.Fragment,{children:[t.jsxs(ee,{"data-test":"ocr-extract-button",onClick:N,disabled:!u,className:"w-full",size:"sm",children:[t.jsx(lo,{className:"w-3 h-3 mr-2"}),"Extract Text"]}),t.jsxs(ee,{"data-test":"ocr-extract-downscale-button",onClick:b,disabled:!u,variant:"outline",className:"w-full",size:"sm",children:[t.jsx(lo,{className:"w-3 h-3 mr-2"}),"Downscale and Extract"]})]})}),R&&t.jsxs("div",{className:"ocr-results space-y-2 flex-1 flex flex-col",children:[t.jsxs("div",{className:"results-header flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[t.jsx(Wa,{className:"w-3 h-3 text-green-600"}),t.jsx("span",{children:"Extracted"})]}),t.jsx(ee,{"data-test":"ocr-copy-result-button",variant:"ghost",size:"sm",onClick:C,className:"h-6 px-2",children:r?t.jsxs(t.Fragment,{children:[t.jsx(Wa,{className:"w-3 h-3 mr-1 text-green-600"}),t.jsx("span",{className:"text-xs",children:"Copied!"})]}):t.jsxs(t.Fragment,{children:[t.jsx(Pt,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"text-xs",children:"Copy"})]})})]}),(R.detectedLanguage||R.confidence||R.processingTime)&&t.jsxs("div",{className:"results-metadata text-xs text-muted-foreground space-y-1",children:[R.detectedLanguage&&t.jsxs("div",{children:["Language: ",R.detectedLanguage]}),R.confidence&&t.jsxs("div",{children:["Confidence: ",R.confidence]}),R.processingTime&&t.jsxs("div",{children:["Time: ",R.processingTime,"ms"]})]}),t.jsx("div",{className:"results-text flex-1 p-3 bg-muted rounded-lg font-mono text-xs whitespace-pre-wrap break-words overflow-y-auto",children:R.extractedText})]})]})},Qy=Ie.memo(Jy),Ea=1/3;function Ra(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}const ev=({node:e})=>{const{updateNode:s}=E.getState(),n=p.useRef(null),o=p.useRef(null),r=F(u=>{var f;const h=u.projectCanvas.getActive();return((f=h==null?void 0:h.coreState.selectedNodes)==null?void 0:f.some(g=>g.id===e.id))??!1}),a=e.data||{},[i,c]=p.useState(a.image||null);p.useEffect(()=>{o.current&&r&&o.current.focus()},[r]),p.useEffect(()=>{if(!r)return;const u=async h=>{var g;h.preventDefault(),h.stopPropagation();const f=(g=h.clipboardData)==null?void 0:g.items;if(f){for(const w of f)if(w.type.startsWith("image/")){const m=w.getAsFile();if(m){Math.round(m.size/1024);const x=new FileReader;x.onload=async()=>{let y=x.result,v;{const b=await Ra(y,Ea);y=b.dataUrl,v=b.size}c(y);const N=Math.round(y.length*3/4/1024);s(e.id,{data:{...a,imageSize:v,fileSizeKB:N,image:y}})},x.readAsDataURL(m)}break}}};return document.addEventListener("paste",u),()=>{document.removeEventListener("paste",u)}},[r,e.id,a,s]);const l=p.useCallback(async u=>{var f;const h=(f=u.target.files)==null?void 0:f[0];if(h&&h.type.startsWith("image/")){Math.round(h.size/1024);const g=new FileReader;g.onload=async()=>{let w=g.result,m;{const y=await Ra(w,Ea);w=y.dataUrl,m=y.size}c(w);const x=Math.round(w.length*3/4/1024);s(e.id,{data:{...a,imageSize:m,fileSizeKB:x,image:w}})},g.readAsDataURL(h)}},[e.id,a,s]),d=p.useCallback(u=>{var f;u.preventDefault(),u.stopPropagation();const h=(f=u.clipboardData)==null?void 0:f.items;if(h){for(const g of h)if(g.type.startsWith("image/")){const w=g.getAsFile();if(w){Math.round(w.size/1024);const m=new FileReader;m.onload=async()=>{let x=m.result,y;{const N=await Ra(x,Ea);x=N.dataUrl,y=N.size}c(x);const v=Math.round(x.length*3/4/1024);s(e.id,{data:{...a,imageSize:y,fileSizeKB:v,image:x}})},m.readAsDataURL(w)}break}}},[e.id,a,s]);return t.jsx("div",{ref:o,className:"canvas-image-node w-full h-full overflow-hidden",onPaste:d,tabIndex:0,role:"button","aria-label":"Paste image area","data-test":"canvas-image-node",children:i?t.jsx("img",{src:i,alt:"Image",className:"w-full h-full object-contain pointer-events-none select-none",draggable:!1,"data-test":"image-preview"}):t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center gap-3 border-2 border-dashed rounded-lg hover:border-primary transition-colors","data-test":"image-empty-state",children:[t.jsx($n,{className:"w-8 h-8 text-muted-foreground"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Paste image (Ctrl+V) or upload"}),t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:l,className:"hidden","data-test":"image-file-input"}),t.jsxs(ee,{"data-test":"image-upload-button",variant:"outline",size:"sm",onClick:()=>{var u;return(u=n.current)==null?void 0:u.click()},children:[t.jsx($n,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]})})},tv=Ie.memo(ev),gd=({node:e})=>{var B;const s=E.getState().updateNode,n=E.getState().deleteNodeById,o=E.getState().setSelectedNodes,a=F(H=>H.uiState.activeGroupId)===e.id,c=F(H=>H.uiState.hoveredDropTargetGroupId)===e.id,l=e.data,d=(l==null?void 0:l.childNodeIds)??[],u=e.isCollapsed??!1,h=bw(e),[f,g]=p.useState(!1),[w,m]=p.useState(!1),[x,y]=p.useState(!1),[v,N]=p.useState(null),b=p.useCallback(H=>{H.stopPropagation(),s(e.id,{isCollapsed:!u})},[e.id,u,s]),S=p.useCallback(H=>{H.stopPropagation();const M=E.getState(),j=M.projectCanvas.getActive();if(!j)return;const W=j.coreState.nodes.filter(L=>d.includes(L.id));W.forEach(L=>{M.updateNode(L.id,{groupId:void 0})}),o(W),n(e.id)},[e.id,d,n,o]),I=p.useCallback(H=>{H.stopPropagation(),H.preventDefault();const M=E.getState(),j=M.projectCanvas.getActive();if(!j)return;const W=j.coreState.nodes.filter(L=>d.includes(L.id));W.length!==0&&(M.setSelectedNodes(W),M.arrow.setSelected([]))},[d]),C=p.useCallback(async H=>{if(H.stopPropagation(),!f){g(!0);try{const M=E.getState(),j=M.projectCanvas.getActive();if(!j)return;const P=j.coreState.nodes,W=j.coreState.arrows,L=j.coreState.selectedNodes,z=await jw(e,P,W,L);z.success?z.nodeUpdates.forEach(({nodeId:_,updates:G})=>{M.updateNode(_,G)}):console.error("Workflow execution failed:",z.error)}catch(M){console.error("Error executing workflow:",M)}finally{g(!1)}}},[e,f]),k=p.useCallback(H=>{if(H.stopPropagation(),!w){m(!0);try{const M=E.getState(),j=M.projectCanvas.getActive();if(!j)return;const W=M.getVisualWorkflowPresets().find(ie=>{var ye;return((ye=ie.sourceLocation)==null?void 0:ye.groupNodeId)===e.id});if(W){be.info(`Workflow "${W.name}" already saved`,{description:"This workflow group is already in presets",duration:3e3});return}const L=j.coreState.nodes,z=j.coreState.arrows,_=Ga(e,L,z);if(_.length===0){be.warning("No workflow steps found",{description:"Add workflow step nodes to save this workflow",duration:3e3});return}const G=_.map(ie=>({id:ie.nodeId,stepType:ie.stepType,config:ie.config,label:ie.label})),V=e.title||"Untitled Workflow",{path:D}=Ds(M);if(!D.projectId||!D.workspaceId||!D.canvasId)throw new Error("Could not determine canvas location for workflow preset");const K={projectId:D.projectId,workspaceId:D.workspaceId,canvasId:D.canvasId,groupNodeId:e.id},te=M.createVisualWorkflowPreset(V,G,K);be.success(`Workflow saved: ${V}`,{description:`${G.length} step${G.length!==1?"s":""} saved to presets`,duration:3e3}),console.log(`Workflow saved as preset: ${V} (${te})`)}catch(M){console.error("Error saving workflow:",M),be.error("Failed to save workflow",{description:M instanceof Error?M.message:"Unknown error",duration:4e3})}finally{m(!1)}}},[e,w]),R=p.useCallback(H=>{H.stopPropagation();const j=E.getState().projectCanvas.getActive();if(!j)return;const P=j.coreState.nodes,W=j.coreState.arrows,z=Ga(e,P,W).map(G=>({id:G.nodeId,stepType:G.stepType,config:G.config,label:G.label})),_={name:e.title||"Untitled Workflow",groupNodeId:e.id,stepCount:z.length,stepTypes:[...new Set(z.map(G=>G.stepType))],steps:z};N(_),y(!0)},[e]),A=(B=l==null?void 0:l.styles)==null?void 0:B.backgroundColor,T=!A,O={};A&&(O.backgroundColor=`color-mix(in srgb, ${A} 20%, transparent)`),!a&&!c&&(O.border="1px solid hsl(var(--muted-foreground) / 0.3)"),c&&(O.border="2px dashed hsl(var(--primary))",O.boxShadow="0 0 0 4px hsl(var(--primary) / 0.2)");const $=A?`color-mix(in srgb, ${A} 60%, transparent)`:void 0;return t.jsxs("div",{className:je("w-full h-full rounded-lg","flex flex-col","pointer-events-none",T&&"bg-background",a&&"ring-2 ring-dashed ring-primary/50"),style:O,"data-test":"group-node-content",children:[t.jsxs("div",{className:je("flex items-center gap-1 px-2 py-1","border-b border-border/50","select-none",!a&&"pointer-events-auto",!$&&"bg-muted/70"),style:$?{backgroundColor:$}:void 0,"data-test":"group-header",children:[t.jsx("button",{className:"p-0.5 rounded hover:bg-muted transition-colors",onPointerDown:H=>{H.stopPropagation()},onClick:b,title:u?"Expand group":"Collapse group","data-test":"group-collapse-toggle",children:u?t.jsx(nn,{className:"h-4 w-4 text-muted-foreground"}):t.jsx(jt,{className:"h-4 w-4 text-muted-foreground"})}),t.jsx("span",{className:"flex-1 text-sm font-medium text-foreground truncate",title:e.title||"Group","data-test":"group-name",children:e.title||"Group"}),h&&t.jsxs("div",{className:"flex items-center gap-0.5 border-r border-border/50 pr-1 mr-1","data-test":"group-workflow-actions",children:[t.jsx("button",{className:je("p-0.5 rounded transition-colors",f?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:H=>H.stopPropagation(),onClick:C,disabled:f,title:f?"Executing workflow...":"Execute workflow","data-test":"group-execute-workflow-button",children:t.jsx(st,{className:je("h-4 w-4",f?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:je("p-0.5 rounded transition-colors",w?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:H=>H.stopPropagation(),onClick:k,disabled:w,title:w?"Saving workflow...":"Save workflow to presets","data-test":"group-save-workflow-button",children:t.jsx(Qt,{className:je("h-4 w-4",w?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:H=>H.stopPropagation(),onClick:R,title:"View workflow JSON","data-test":"group-json-viewer-button",children:t.jsx(Zo,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})]}),t.jsxs("div",{className:"flex items-center gap-0.5","data-test":"group-node-actions",children:[t.jsx("span",{className:"text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded",title:`${d.length} nodes in group`,"data-test":"group-child-count",children:d.length}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:I,title:"Select all nodes in group","data-test":"group-select-all-button",children:t.jsx(fr,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:H=>{H.stopPropagation()},onClick:S,title:"Ungroup","data-test":"group-ungroup-button",children:t.jsx(mr,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]})]}),!u&&t.jsx("div",{className:"flex-1 min-h-[20px] pointer-events-none","data-test":"group-body"}),a&&t.jsxs("div",{className:"flex items-center justify-center gap-1 px-2 py-1 border-t border-primary/30 bg-primary/5","data-test":"group-edit-mode-footer",children:[t.jsx(Ks,{className:"h-3 w-3 text-primary"}),t.jsx("span",{className:"text-xs text-primary font-medium",children:"Editing - click outside to exit"})]}),t.jsx(_e,{isVisible:x,onClose:()=>y(!1),title:`Workflow: ${e.title||"Untitled"}`,initialSize:{width:1200,height:1e3},triggerPosition:{x:(typeof window<"u"?window.innerWidth:1920)/2-600,y:(typeof window<"u"?window.innerHeight:1080)/2-500},resizable:!0,"data-test":"workflow-json-viewer-popover",children:v&&t.jsx("div",{className:"h-full overflow-auto","data-test":"workflow-json-content",children:t.jsx(xl,{data:v,onDataChange:()=>{}})})})]})};gd.displayName="GroupNodeV2";const Za=({node:e})=>{const s=p.useRef(null),n=p.useRef(null),o=p.useRef(0),r=_n(),a=F(M=>{var j;return((j=M.projectCanvas.getActive())==null?void 0:j.viewState.scale)??1}),i=F(M=>{var j;return((j=M.projectCanvas.getActive())==null?void 0:j.coreState.nodes)??[]}),l=F(M=>M.uiState.activeChatNodeId)===e.id,d=F(M=>M.uiState.chatNodeHoldToDrag);(d==null?void 0:d.nodeId)===e.id&&(d==null||d.isHolding),(d==null?void 0:d.nodeId)===e.id&&(d==null||d.isReady);const u=e.data,h=(u==null?void 0:u.childNodeIds)??[],f=(u==null?void 0:u.viewMode)??"chat",g=p.useRef(null),w=p.useRef(null),m=p.useRef(f),x=p.useRef(Date.now()+J.claudeChat.alignScrollDuration+100),[y,v]=p.useState(null);p.useEffect(()=>{f==="chat"&&m.current!=="chat"&&(x.current=Date.now()+J.claudeChat.alignScrollDuration+100),m.current=f},[f]),p.useEffect(()=>{f==="chat"&&(g.current===null&&(g.current=a),w.current===null&&(w.current={x:e.x,y:e.y}))},[f,a,e.x,e.y]),p.useEffect(()=>{if(f!=="chat")return;if(Date.now()<x.current){g.current=a,w.current={x:e.x,y:e.y};return}const M=g.current!==null&&Math.abs(a-g.current)>.01,j=w.current!==null&&(Math.abs(e.x-w.current.x)>1||Math.abs(e.y-w.current.y)>1);(M||j)&&(E.getState().updateNode(e.id,{data:{...u,viewMode:"canvas"}}),g.current=null,w.current=null)},[f,a,e.x,e.y,e.id,u]);const N=p.useMemo(()=>h.map(M=>i.find(j=>j.id===M)).filter(M=>M!==void 0),[h,i]);p.useEffect(()=>{const M=N.length;if(M>o.current&&s.current){const j=s.current;requestAnimationFrame(()=>{j.scrollTop=j.scrollHeight})}o.current=M},[N.length]),p.useEffect(()=>{const M=s.current;if(!M)return;const j=P=>{P.stopPropagation()};return M.addEventListener("wheel",j,{capture:!0}),()=>M.removeEventListener("wheel",j,{capture:!0})},[]),p.useEffect(()=>{if(!r||f!=="chat"){v(null);return}const M=()=>{const j=document.querySelector('[data-test="canvas-chat-input-container"]'),P=document.querySelector("[data-canvas-container]"),W=n.current;if(!j||!P||!W)return;const L=j.getBoundingClientRect().top,z=P.getBoundingClientRect().top,_=W.getBoundingClientRect(),G=44,V=Math.max(_.top,z),K=Math.min(_.bottom,L)-V-G;K>0&&v(K)};return M(),window.addEventListener("resize",M),()=>window.removeEventListener("resize",M)},[r,f,e.width,e.height]);const b=p.useCallback(()=>{const M=E.getState(),j=Le.buildTextNodeV2({content:"",x:e.x,y:e.y});M.addNode(j);const P=e.data||{childNodeIds:[]};M.updateNode(e.id,{data:{...P,childNodeIds:[...P.childNodeIds,j.id]}}),M.setSelectedNodes([j]),M.setNodeToFocusId(j.id)},[e.id,e.x,e.y,e.data]),S=p.useCallback(()=>{E.getState().deleteNodeById(e.id)},[e.id]),I=p.useCallback(M=>{M.stopPropagation(),E.getState().setActiveChatNodeId(e.id,!0);const j=document.querySelector('[data-test="canvas-chat-input-textarea-container"] textarea');j==null||j.focus()},[e.id]),C=p.useRef(0),k=300,R=p.useCallback(()=>{l||E.getState().setActiveChatNodeId(e.id,!0)},[l,e.id]),A=p.useCallback(M=>{M.stopPropagation(),R()},[R]),T=p.useCallback(M=>{const j=Date.now();j-C.current<k?(M.stopPropagation(),R(),C.current=0):C.current=j},[R]),O=J.chatInput.mobile.nodeFontSize,$=r?parseInt(O):16,B=p.useMemo(()=>({inChat:!0,containerWidth:(e.width??400)-32,chatNodeId:e.id,onSendMessage:b}),[e.id,b,e.width]),H=r&&f==="chat";return t.jsxs("div",{ref:n,className:je("w-full h-full","flex flex-col","bg-background","transition-all duration-200","overflow-hidden",H?"":"rounded-lg shadow-lg",!H&&(l?"border-4 border-primary":"border-2 border-primary/30")),style:{},onDoubleClick:A,onTouchEnd:T,"data-test":"chat-node-content",children:[t.jsxs("div",{className:je("flex items-center gap-2 px-3 py-2","border-b border-border/50","bg-muted/50","select-none","flex-shrink-0"),"data-test":"chat-header",children:[t.jsx(rr,{className:"h-5 w-5 text-muted-foreground"}),t.jsx("span",{className:"flex-1 text-base font-medium text-foreground truncate",title:e.title||"Chat","data-test":"chat-name",children:e.title||"Chat"}),t.jsx("span",{className:"text-sm text-muted-foreground bg-muted px-2 py-0.5 rounded",title:`${N.length} messages`,"data-test":"chat-message-count",children:N.length}),t.jsx("button",{className:je("p-1.5 rounded transition-colors",l?"bg-primary/20 text-primary":"hover:bg-primary/10 text-muted-foreground hover:text-primary"),onPointerDown:M=>M.stopPropagation(),onClick:M=>{M.stopPropagation(),l?E.getState().setActiveChatNodeId(null,!0):E.getState().setActiveChatNodeId(e.id,!0)},title:l?"Active chat target":"Set as active chat target","data-test":"chat-pin-active-button",children:t.jsx(Th,{className:"h-5 w-5"})}),t.jsx("button",{className:"p-1.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:M=>M.stopPropagation(),onClick:I,title:"Focus chat input","data-test":"chat-focus-input-button",children:t.jsx(Eh,{className:"h-5 w-5 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-1.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:M=>M.stopPropagation(),onClick:S,title:"Close chat","data-test":"chat-close-button",children:t.jsx($e,{className:"h-5 w-5 text-muted-foreground hover:text-destructive"})})]}),t.jsx("div",{ref:s,className:je("flex-1 overflow-y-auto overflow-x-hidden","flex flex-col-reverse items-end","py-3"),style:{gap:`${J.chatNode.messageGap*(r?2:1)}px`,touchAction:"pan-y",paddingLeft:r&&J.chatNode.viewMode==="fullwidth"?`${J.chatNode.fullwidth.contentPadding}px`:"12px",paddingRight:r&&J.chatNode.viewMode==="fullwidth"?`${J.chatNode.fullwidth.contentPadding}px`:"12px"},"data-test":"chat-messages-container",children:t.jsx(_l.Provider,{value:B,children:N.length===0?t.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-base w-full","data-test":"chat-empty-state",children:"No messages yet. Click + to add one."}):a<vn?[...N].reverse().map(M=>t.jsx("div",{className:"bg-primary rounded",style:{width:M.width??100,height:M.height??30},"data-test":"chat-message-simplified"},M.id)):[...N].reverse().map(M=>{const j={...M,styles:{...M.styles,fontSize:`${$}px`}};return t.jsx("div",{className:"relative bg-muted/30 rounded-lg",style:{width:"auto",minWidth:50,maxWidth:"85%",padding:`${J.chatNode.messagePadding}px`},"data-test":"chat-message",children:t.jsx(Vl,{node:j})},M.id)})})})]})};Za.displayName="ChatNodeV2";const Gi=[{type:"if",label:"If Condition",icon:"🔀",description:"Conditional logic based on field values"},{type:"toolbarAction",label:"Toolbar Action",icon:"⚡",description:"Execute canvas toolbar actions"},{type:"tagUpdate",label:"Tag Update",icon:"🏷️",description:"Add, remove, or set node tags"},{type:"loop",label:"Loop",icon:"🔄",description:"Iterate over nodes or data"},{type:"source",label:"Source",icon:"📥",description:"Define data source for workflow"}],sv=[{value:"selection.count",label:"Selection Count",description:"Number of selected nodes"},{value:"node.title",label:"Node Title",description:"Title of the node"},{value:"node.content",label:"Node Content",description:"Content of the node"},{value:"node.tags",label:"Node Tags",description:"Tags array of the node"},{value:"loop.index",label:"Loop Index",description:"Current loop iteration (1-based)"},{value:"loop.current",label:"Loop Current",description:"Current loop value"},{value:"loop.total",label:"Loop Total",description:"Total loop iterations"}],nv=[{value:"==",label:"Equals",symbol:"=="},{value:"!=",label:"Not Equals",symbol:"!="},{value:">",label:"Greater Than",symbol:">"},{value:">=",label:"Greater or Equal",symbol:">="},{value:"<",label:"Less Than",symbol:"<"},{value:"<=",label:"Less or Equal",symbol:"<="},{value:"contains",label:"Contains",symbol:"contains"},{value:"matches",label:"Matches (regex)",symbol:"matches"}],Yi=[{value:"addTags",label:"Add Tags"},{value:"removeTags",label:"Remove Tags"},{value:"setTags",label:"Set Tags"},{value:"updateTitle",label:"Update Title"},{value:"updateContent",label:"Update Content"},{value:"setStyle",label:"Set Background"},{value:"toolbarAction",label:"Run Toolbar Action"}],ov=({config:e,onChange:s})=>{const n=h=>{s({...e,condition:{...e.condition,field:h}})},o=h=>{s({...e,condition:{...e.condition,operator:h}})},r=h=>{s({...e,condition:{...e.condition,value:h}})},a=h=>{s({...e,then:{type:h,value:h==="addTags"||h==="removeTags"||h==="setTags"?[]:""}})},i=h=>{const f=e.then.type,g=f==="addTags"||f==="removeTags"||f==="setTags"?h.split(",").map(w=>w.trim()).filter(Boolean):h;s({...e,then:{...e.then,value:g}})},c=h=>{s({...e,else:{type:h,value:h==="addTags"||h==="removeTags"||h==="setTags"?[]:""}})},l=h=>{if(!e.else)return;const f=e.else.type,g=f==="addTags"||f==="removeTags"||f==="setTags"?h.split(",").map(w=>w.trim()).filter(Boolean):h;s({...e,else:{...e.else,value:g}})},d=h=>Array.isArray(h.value)?h.value.join(", "):String(h.value||""),u=h=>h==="addTags"||h==="removeTags"||h==="setTags"?"tag1, tag2":"value";return t.jsxs("div",{"data-test":"if-condition-config",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"if-condition-section",className:"space-y-1 p-1.5 bg-muted/30 rounded border border-border",children:[t.jsx("span",{"data-test":"if-condition-section-label",className:"text-[10px] font-semibold text-muted-foreground uppercase",children:"If"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(gt,{value:e.condition.field,onValueChange:h=>n(h),children:[t.jsx(ft,{"data-test":"if-condition-field-trigger",className:"h-6 text-[11px] flex-1",onClick:h=>h.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"if-condition-field-content",children:sv.map(h=>t.jsx(Ke,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsxs(gt,{value:e.condition.operator,onValueChange:h=>o(h),children:[t.jsx(ft,{"data-test":"if-condition-operator-trigger",className:"h-6 text-[11px] w-16",onClick:h=>h.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"if-condition-operator-content",children:nv.map(h=>t.jsx(Ke,{value:h.value,className:"text-xs",children:h.symbol},h.value))})]}),t.jsx(Re,{"data-test":"if-condition-value-input",value:e.condition.value,onChange:h=>r(h.target.value),onClick:h=>h.stopPropagation(),placeholder:"value",className:"h-6 text-[11px] w-16"})]})]}),t.jsxs("div",{"data-test":"if-then-section",className:"space-y-1 p-1.5 bg-green-500/10 rounded border border-green-500/30",children:[t.jsx("span",{"data-test":"if-then-section-label",className:"text-[10px] font-semibold text-green-700 dark:text-green-400 uppercase",children:"Then"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(gt,{value:e.then.type,onValueChange:h=>a(h),children:[t.jsx(ft,{"data-test":"if-then-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:h=>h.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"if-then-action-type-content",children:Yi.map(h=>t.jsx(Ke,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsx(Re,{"data-test":"if-then-action-value-input",value:d(e.then),onChange:h=>i(h.target.value),onClick:h=>h.stopPropagation(),placeholder:u(e.then.type),className:"h-6 text-[11px] flex-1"})]})]}),t.jsxs("div",{"data-test":"if-else-section",className:"space-y-1 p-1.5 bg-orange-500/10 rounded border border-orange-500/30",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{"data-test":"if-else-section-label",className:"text-[10px] font-semibold text-orange-700 dark:text-orange-400 uppercase",children:"Else"}),e.else&&t.jsx("button",{"data-test":"if-else-remove-button",onClick:h=>{h.stopPropagation(),s({...e,else:void 0})},className:"text-[10px] text-muted-foreground hover:text-destructive",children:"✕"})]}),e.else?t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(gt,{value:e.else.type,onValueChange:h=>c(h),children:[t.jsx(ft,{"data-test":"if-else-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:h=>h.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"if-else-action-type-content",children:Yi.map(h=>t.jsx(Ke,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsx(Re,{"data-test":"if-else-action-value-input",value:d(e.else),onChange:h=>l(h.target.value),onClick:h=>h.stopPropagation(),placeholder:u(e.else.type),className:"h-6 text-[11px] flex-1"})]}):t.jsx("button",{"data-test":"if-else-add-button",onClick:h=>{h.stopPropagation(),s({...e,else:{type:"addTags",value:[]}})},className:"text-[10px] text-primary hover:underline",children:"+ Add else"})]})]})},av=[{value:"split",label:"Split"},{value:"arrange",label:"Arrange"},{value:"align",label:"Align"},{value:"group",label:"Group"},{value:"collapse",label:"Collapse"}],Ki={split:[{value:"byWhitespace",label:"By Whitespace"},{value:"byLine",label:"By Line"},{value:"byParagraph",label:"By Paragraph"},{value:"byComma",label:"By Comma"},{value:"byPeriod",label:"By Period"},{value:"byRegex",label:"By Regex"}],arrange:[{value:"horizontal:top",label:"Horizontal (Top)"},{value:"horizontal:bottom",label:"Horizontal (Bottom)"},{value:"vertical:left",label:"Vertical (Left)"},{value:"vertical:right",label:"Vertical (Right)"},{value:"grid",label:"Grid"},{value:"masonry",label:"Masonry"}],align:[{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"},{value:"top",label:"Top"},{value:"middle",label:"Middle"},{value:"bottom",label:"Bottom"}],group:[{value:"create",label:"Create Group"},{value:"ungroup",label:"Ungroup"}],collapse:[{value:"collapse",label:"Collapse"},{value:"expand",label:"Expand"}]},rv=({config:e,onChange:s})=>{var l,d,u,h;const n=f=>{var w;const g=((w=Ki[f][0])==null?void 0:w.value)||"";s({facadeKey:f,actionId:g,params:{}})},o=f=>{s({...e,actionId:f})},r=(f,g)=>{s({...e,params:{...e.params,[f]:g}})},a=e.facadeKey==="split",i=e.facadeKey==="arrange",c=e.facadeKey==="arrange"&&e.actionId==="grid";return t.jsxs("div",{"data-test":"toolbar-action-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"toolbar-action-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:"Execute canvas toolbar actions on selected nodes"}),t.jsxs("div",{"data-test":"toolbar-action-category",children:[t.jsx("label",{"data-test":"toolbar-action-category-label",className:"text-xs font-medium",children:"Category"}),t.jsxs(gt,{value:e.facadeKey,onValueChange:f=>n(f),children:[t.jsx(ft,{"data-test":"toolbar-action-category-trigger",className:"h-7 text-xs mt-1",onClick:f=>f.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"toolbar-action-category-content",children:av.map(f=>t.jsx(Ke,{value:f.value,"data-test":"toolbar-action-category-option",className:"text-xs",children:f.label},f.value))})]})]}),t.jsxs("div",{"data-test":"toolbar-action-action",children:[t.jsx("label",{"data-test":"toolbar-action-action-label",className:"text-xs font-medium",children:"Action"}),t.jsxs(gt,{value:e.actionId,onValueChange:o,children:[t.jsx(ft,{"data-test":"toolbar-action-action-trigger",className:"h-7 text-xs mt-1",onClick:f=>f.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"toolbar-action-action-content",children:Ki[e.facadeKey].map(f=>t.jsx(Ke,{value:f.value,"data-test":"toolbar-action-action-option",className:"text-xs",children:f.label},f.value))})]})]}),(a||i)&&t.jsxs("div",{"data-test":"toolbar-action-options",className:"space-y-2 p-2 bg-muted/30 rounded border border-border",children:[t.jsx("label",{"data-test":"toolbar-action-options-label",className:"text-xs font-semibold",children:"Options"}),a&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{"data-test":"toolbar-action-keep-arrows",className:"flex items-center gap-2",children:[t.jsx(We,{"data-test":"toolbar-action-keep-arrows-checkbox",checked:((l=e.params)==null?void 0:l.keepArrows)||!1,onCheckedChange:f=>r("keepArrows",f),onClick:f=>f.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-arrows-label",className:"text-xs",children:"Keep Arrows"})]}),t.jsxs("div",{"data-test":"toolbar-action-keep-match",className:"flex items-center gap-2",children:[t.jsx(We,{"data-test":"toolbar-action-keep-match-checkbox",checked:((d=e.params)==null?void 0:d.keepMatch)||!1,onCheckedChange:f=>r("keepMatch",f),onClick:f=>f.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-match-label",className:"text-xs",children:"Keep Match"})]})]}),t.jsxs("div",{"data-test":"toolbar-action-gap",children:[t.jsx("label",{"data-test":"toolbar-action-gap-label",className:"text-xs text-muted-foreground",children:"Gap"}),t.jsx(Re,{"data-test":"toolbar-action-gap-input",type:"number",value:((u=e.params)==null?void 0:u.gap)||20,onChange:f=>r("gap",parseInt(f.target.value,10)),onClick:f=>f.stopPropagation(),className:"h-7 text-xs mt-1",min:0})]}),c&&t.jsxs("div",{"data-test":"toolbar-action-columns",children:[t.jsx("label",{"data-test":"toolbar-action-columns-label",className:"text-xs text-muted-foreground",children:"Columns"}),t.jsx(Re,{"data-test":"toolbar-action-columns-input",type:"number",value:((h=e.params)==null?void 0:h.columns)||3,onChange:f=>r("columns",parseInt(f.target.value,10)),onClick:f=>f.stopPropagation(),className:"h-7 text-xs mt-1",min:1})]})]})]})},Xi=[{value:"add",label:"Add Tags",description:"Add tags to existing tags"},{value:"remove",label:"Remove Tags",description:"Remove specific tags"},{value:"set",label:"Set Tags",description:"Replace all tags with new ones"},{value:"clear",label:"Clear All Tags",description:"Remove all tags from nodes"}],iv=({config:e,onChange:s})=>{var u;const[n,o]=p.useState(""),r=h=>{s({...e,mode:h})},a=()=>{const h=n.trim();h&&(e.tags.includes(h)||s({...e,tags:[...e.tags,h]}),o(""))},i=h=>{s({...e,tags:e.tags.filter(f=>f!==h)})},c=h=>{h.key==="Enter"&&(h.preventDefault(),h.stopPropagation(),a())},l=h=>{s({...e,useTemplate:h})},d=((u=Xi.find(h=>h.value===e.mode))==null?void 0:u.description)||"";return t.jsxs("div",{"data-test":"tag-update-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"tag-update-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:d}),t.jsxs("div",{"data-test":"tag-update-mode",children:[t.jsx("label",{"data-test":"tag-update-mode-label",className:"text-xs font-medium",children:"Mode"}),t.jsxs(gt,{value:e.mode,onValueChange:h=>r(h),children:[t.jsx(ft,{"data-test":"tag-update-mode-trigger",className:"h-7 text-xs mt-1",onClick:h=>h.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"tag-update-mode-content",children:Xi.map(h=>t.jsx(Ke,{value:h.value,"data-test":"tag-update-mode-option",className:"text-xs",children:h.label},h.value))})]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-tags",className:"space-y-2",children:[t.jsx("label",{"data-test":"tag-update-tags-label",className:"text-xs font-medium",children:"Tags"}),e.tags.length>0&&t.jsx("div",{"data-test":"tag-update-tags-chips",className:"flex flex-wrap gap-1 p-2 bg-muted/30 rounded border border-border",children:e.tags.map((h,f)=>t.jsxs("div",{"data-test":"tag-update-tag-chip",className:"flex items-center gap-1 px-2 py-0.5 bg-primary/10 text-primary rounded-full text-xs",children:[t.jsx("span",{"data-test":"tag-update-tag-text",children:h}),t.jsx("button",{"data-test":"tag-update-tag-remove",onClick:g=>{g.stopPropagation(),i(h)},className:"hover:text-destructive",children:t.jsx($e,{size:12})})]},`${h}-${f}`))}),t.jsx(Re,{"data-test":"tag-update-tags-input",value:n,onChange:h=>o(h.target.value),onKeyDown:c,onClick:h=>h.stopPropagation(),placeholder:"Type tag and press Enter...",className:"h-7 text-xs"}),t.jsxs("p",{"data-test":"tag-update-tags-hint",className:"text-xs text-muted-foreground",children:["Press Enter to add tag. Supports templates like ","{","{","loop.current","}","."]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-template",className:"flex items-center gap-2 p-2 bg-muted/30 rounded",children:[t.jsx(We,{"data-test":"tag-update-template-checkbox",checked:e.useTemplate||!1,onCheckedChange:l,onClick:h=>h.stopPropagation()}),t.jsxs("label",{"data-test":"tag-update-template-label",className:"text-xs",children:["Use template variables (e.g., ","{","{","loop.current","}",")"]})]}),e.useTemplate&&t.jsxs("div",{"data-test":"tag-update-template-help",className:"text-xs text-muted-foreground bg-blue-500/10 p-2 rounded border border-blue-500/30",children:[t.jsx("strong",{children:"Available variables:"}),t.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-0.5",children:[t.jsxs("li",{children:["{","{","loop.current","}"," - Current item in loop"]}),t.jsxs("li",{children:["{","{","loop.index","}"," - Loop index (1-based)"]}),t.jsxs("li",{children:["{","{","loop.total","}"," - Total iterations"]})]})]})]})},qi=[{value:"connectedNode",label:"Connected Node",description:"Iterate over data from incoming arrow connection"},{value:"selectedNodes",label:"Selected Nodes",description:"Iterate over currently selected nodes on canvas"},{value:"allNodes",label:"All Canvas Nodes",description:"Iterate over all nodes on the canvas"}],cv=({config:e,onChange:s})=>{var r;const n=a=>{s({...e,source:a})},o=((r=qi.find(a=>a.value===e.source))==null?void 0:r.description)||"";return t.jsxs("div",{"data-test":"loop-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"loop-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:o}),t.jsxs("div",{"data-test":"loop-config-source",children:[t.jsx("label",{"data-test":"loop-config-source-label",className:"text-xs font-medium",children:"Data Source"}),t.jsxs(gt,{value:e.source,onValueChange:a=>n(a),children:[t.jsx(ft,{"data-test":"loop-config-source-trigger",className:"h-7 text-xs mt-1",onClick:a=>a.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"loop-config-source-content",children:qi.map(a=>t.jsx(Ke,{value:a.value,"data-test":"loop-config-source-option",className:"text-xs",children:a.label},a.value))})]})]}),t.jsxs("div",{"data-test":"loop-config-variables",className:"p-2 bg-blue-500/10 rounded border border-blue-500/30 space-y-2",children:[t.jsx("label",{"data-test":"loop-config-variables-label",className:"text-xs font-semibold text-blue-700 dark:text-blue-300",children:"Available Variables"}),t.jsxs("div",{"data-test":"loop-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"loop-config-variable-current",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.current","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current item being processed"})]}),t.jsxs("div",{"data-test":"loop-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.index","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current iteration (1-based)"})]}),t.jsxs("div",{"data-test":"loop-config-variable-total",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.total","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Total number of iterations"})]})]}),t.jsxs("div",{"data-test":"loop-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-blue-500/30",children:[t.jsx("strong",{children:"Example:"})," Use"," ",t.jsxs("code",{className:"px-1 bg-blue-500/20 rounded",children:["{","{","loop.current","}"]})," ","in subsequent steps to reference the current item."]})]}),t.jsxs("div",{"data-test":"loop-config-tips",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Tip:"})," Steps connected after this loop will execute once per item. Use loop variables in those steps to access iteration data."]})]})},Zi=[{value:"connectedNode",label:"Connected Node",description:"Read data from incoming arrow connection"},{value:"inline",label:"Inline Data",description:"Define data directly in this node"}],lv=({config:e,onChange:s})=>{var c;const n=l=>{s({...e,dataFrom:l,inlineData:l==="inline"?e.inlineData||"{}":void 0})},o=l=>{s({...e,inlineData:l})};let r=null,a=null;if(e.dataFrom==="inline"&&e.inlineData)try{r=JSON.parse(e.inlineData)}catch(l){a=l.message}const i=((c=Zi.find(l=>l.value===e.dataFrom))==null?void 0:c.description)||"";return t.jsxs("div",{"data-test":"source-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"source-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:i}),t.jsxs("div",{"data-test":"source-config-data-from",children:[t.jsx("label",{"data-test":"source-config-data-from-label",className:"text-xs font-medium",children:"Data From"}),t.jsxs(gt,{value:e.dataFrom,onValueChange:l=>n(l),children:[t.jsx(ft,{"data-test":"source-config-data-from-trigger",className:"h-7 text-xs mt-1",onClick:l=>l.stopPropagation(),children:t.jsx(mt,{})}),t.jsx(xt,{"data-test":"source-config-data-from-content",children:Zi.map(l=>t.jsx(Ke,{value:l.value,"data-test":"source-config-data-from-option",className:"text-xs",children:l.label},l.value))})]})]}),e.dataFrom==="inline"&&t.jsxs("div",{"data-test":"source-config-inline-data",className:"space-y-2",children:[t.jsx("label",{"data-test":"source-config-inline-data-label",className:"text-xs font-medium",children:"Inline Data (JSON)"}),t.jsx("textarea",{"data-test":"source-config-inline-data-textarea",value:e.inlineData||"",onChange:l=>o(l.target.value),onClick:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),placeholder:'{"key": "value"}',className:"w-full h-24 text-xs font-mono border border-border rounded px-2 py-1 bg-background resize-none"}),a&&t.jsxs("div",{"data-test":"source-config-parse-error",className:"text-xs text-destructive bg-destructive/10 p-2 rounded border border-destructive/30",children:[t.jsx("strong",{children:"Invalid JSON:"})," ",a]}),!a&&r&&t.jsxs("div",{"data-test":"source-config-preview",className:"space-y-1",children:[t.jsx("label",{"data-test":"source-config-preview-label",className:"text-xs font-medium text-muted-foreground",children:"Preview"}),t.jsx("div",{"data-test":"source-config-preview-content",className:"text-xs font-mono bg-muted/30 p-2 rounded border border-border max-h-32 overflow-auto",children:t.jsx("pre",{children:JSON.stringify(r,null,2)})})]})]}),t.jsxs("div",{"data-test":"source-config-variables",className:"p-2 bg-green-500/10 rounded border border-green-500/30 space-y-2",children:[t.jsx("label",{"data-test":"source-config-variables-label",className:"text-xs font-semibold text-green-700 dark:text-green-300",children:"Access Data"}),t.jsxs("div",{"data-test":"source-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"source-config-variable-key",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.key","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access object property by key"})]}),t.jsxs("div",{"data-test":"source-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source[0]","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access array element by index"})]}),t.jsxs("div",{"data-test":"source-config-variable-nested",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.user.name","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access nested properties"})]})]}),t.jsxs("div",{"data-test":"source-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-green-500/30",children:[t.jsx("strong",{children:"Example:"})," If source data is"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{",'"',"users",'"',": [",'"',"name",'"',": ",'"',"Alice",'"',"}","}"," "]}),", use"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{","{","source.users[0].name","}"]})," ","to get ",'"',"Alice",'"',"."]})]}),e.dataFrom==="connectedNode"&&t.jsxs("div",{"data-test":"source-config-connected-info",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Note:"})," Connect an arrow from another node to provide data. The connected node's content or output will be available via ",t.jsx("code",{children:"{{source}}"})," variables."]})]})},dv=({nodeId:e,data:s,onDataChange:n})=>{var l;const[o,r]=p.useState(s.stepType),a=d=>{r(d);let u;switch(d){case"if":u={condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}};break;case"toolbarAction":u={facadeKey:"split",actionId:"byWhitespace",params:{}};break;case"tagUpdate":u={mode:"add",tags:[]};break;case"loop":u={source:"connectedNode"};break;case"source":u={dataFrom:"connectedNode"};break;default:u={}}n({stepType:d,config:u})},i=d=>{o&&n({stepType:o,config:d})},c=o?((l=Gi.find(d=>d.type===o))==null?void 0:l.icon)||"⚡":"❓";return t.jsxs("div",{"data-test":"workflow-step-node",className:"flex flex-col gap-1 p-1.5 bg-background border border-border rounded-md min-w-[240px]",onMouseDown:d=>d.stopPropagation(),onClick:d=>d.stopPropagation(),children:[t.jsxs("div",{"data-test":"workflow-step-header",className:"flex items-center gap-1.5",children:[t.jsx("span",{"data-test":"workflow-step-icon",className:"text-sm",children:c}),t.jsxs(gt,{value:o??"",onValueChange:d=>a(d),children:[t.jsx(ft,{"data-test":"workflow-step-type-trigger",className:"h-6 text-[11px] flex-1",onClick:d=>d.stopPropagation(),children:t.jsx(mt,{placeholder:"Select step type..."})}),t.jsx(xt,{"data-test":"workflow-step-type-content",children:Gi.map(d=>t.jsx(Ke,{value:d.type,"data-test":"workflow-step-type-option",className:"text-xs",children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{children:d.icon}),t.jsx("span",{children:d.label})]})},d.type))})]})]}),o?t.jsxs("div",{"data-test":"workflow-step-config-panel",children:[o==="if"&&t.jsx(ov,{config:s.config,onChange:d=>i(d)}),o==="toolbarAction"&&t.jsx(rv,{config:s.config,onChange:d=>i(d)}),o==="tagUpdate"&&t.jsx(iv,{config:s.config,onChange:d=>i(d)}),o==="loop"&&t.jsx(cv,{config:s.config,onChange:d=>i(d)}),o==="source"&&t.jsx(lv,{config:s.config,onChange:d=>i(d)})]}):t.jsx("div",{"data-test":"workflow-step-placeholder",className:"text-[10px] text-muted-foreground text-center py-2",children:"Select a step type to configure"})]})},uv=({node:e})=>{const o=e.data||{stepType:"if",config:{condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}}},r=p.useCallback(a=>{E.getState().updateNode(e.id,{data:a})},[e.id]);return t.jsx("div",{"data-test":"canvas-workflow-step-node",className:"w-full h-full",children:t.jsx(dv,{nodeId:e.id,data:o,onDataChange:r})})};function fd({nodeId:e,preventEdit:s=!1,onEditStart:n,onEditEnd:o,inputRefs:r,clearSelectionOnBlur:a=!1}){const[i,c]=p.useState(!1),l=F(v=>v.uiState.nodeToFocusId),d=F(v=>{var N,b;return((b=(N=v.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)==null?void 0:b.some(S=>S.id===e))??!1}),u=F(v=>{var N,b;return((b=(N=v.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)==null?void 0:b.length)??0}),h=d&&l===e,{updateNode:f,setMode:g}=E.getState(),w=p.useCallback(v=>{c(v),f(e,{isEditing:v})},[e,f]),m=p.useCallback(v=>{var N;if(!document.querySelector("[data-radix-popper-content-wrapper]")){if(r&&r.length>0&&(v!=null&&v.relatedTarget)){const b=v.relatedTarget;if(r.some(I=>I.current===b))return}o==null||o(),w(!1),a&&(E.getState().setNodeToFocusId(null),E.getState().setSelectedNodes([])),(N=window.getSelection())==null||N.removeAllRanges()}},[o,w,r,a]),x=p.useCallback(()=>{d&&u<=1&&!s&&(i||n==null||n(),w(!0))},[d,u,s,i,n,w]),y=p.useCallback(v=>{v.key==="Escape"&&(m(),E.getState().uiState.mode!==Q.VIM&&g(Q.SELECT))},[m,g]);return p.useEffect(()=>{l||w(!1)},[l,w]),p.useEffect(()=>{!d&&i&&w(!1)},[d,i,w]),p.useEffect(()=>{if(!h||s)return;!i&&(n==null||n()),w(!0)},[h,s,i,n,w]),p.useEffect(()=>{if(!r||r.length===0)return;const v=[];return r.forEach(N=>{if(N.current){const b=S=>m(S);N.current.addEventListener("blur",b),v.push({el:N.current,handler:b})}}),()=>{v.forEach(({el:N,handler:b})=>{N.removeEventListener("blur",b)})}},[m,r]),{isEditing:i,shouldFocus:h,isSelected:d,selectedNodesCount:u,handleMouseDown:x,handleBlur:m,handleKeyDown:y,setIsEditing:w}}const hv=({nodeId:e,nodeData:s,preventEdit:n})=>{const o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),[i,c]=p.useState(s.sourceWord||""),[l,d]=p.useState(s.translationWord||""),[u,h]=p.useState(null),{isEditing:f,isSelected:g,selectedNodesCount:w,handleKeyDown:m}=fd({nodeId:e,preventEdit:n,inputRefs:[r,a],clearSelectionOnBlur:!0,onEditEnd:()=>{x({sourceWord:i,translationWord:l})}});p.useEffect(()=>{c(s.sourceWord||""),d(s.translationWord||"")},[s.sourceWord,s.translationWord]),p.useEffect(()=>{requestAnimationFrame(()=>{var O,$;const R=((O=E.getState().projectCanvas.getActive())==null?void 0:O.viewState.scale)??1,T=((($=o.current)==null?void 0:$.getBoundingClientRect().height)??0)/R;T>0&&E.getState().updateNode(e,{height:T})})},[e,i,l]);const x=p.useCallback(k=>{const R=s;E.getState().updateNode(e,{data:{...R,...k}})},[e,s]),y=k=>{c(k.target.value)},v=k=>{d(k.target.value)},N=k=>{const A=E.getState().getNodeById(k);return A&&typeof A.content=="string"?A.content.trim():""},b=p.useCallback(k=>{k.preventDefault(),h(null);const R=k.dataTransfer.getData("application/json");if(R)try{const A=JSON.parse(R);if(A.nodeIds&&Array.isArray(A.nodeIds)&&A.nodeIds.length>=1){const T=A.nodeIds.map(O=>{const $=E.getState().getNodeById(O);return $?{id:O,x:$.x,y:$.y,content:N(O)}:null}).filter(Boolean);if(T.length>=2){T.sort((B,H)=>B.x+B.y-(H.x+H.y));const O=T[0].content,$=T[T.length-1].content;c(O),d($),x({sourceWord:O,translationWord:$})}else if(T.length===1){const O=T[0].content;i?(d(O),x({translationWord:O})):(c(O),x({sourceWord:O}))}}else if(A.nodeId){const T=N(A.nodeId);c(T),x({sourceWord:T})}}catch(A){console.error("Failed to parse drop data:",A)}},[i,x]),S=p.useCallback(k=>{k.preventDefault(),h(null);const R=k.dataTransfer.getData("application/json");if(R)try{const A=JSON.parse(R);if(A.nodeIds&&Array.isArray(A.nodeIds)&&A.nodeIds.length>=1){const T=A.nodeIds.map(O=>{const $=E.getState().getNodeById(O);return $?{id:O,x:$.x,y:$.y,content:N(O)}:null}).filter(Boolean);if(T.length>=2){T.sort((B,H)=>B.x+B.y-(H.x+H.y));const O=T[0].content,$=T[T.length-1].content;c(O),d($),x({sourceWord:O,translationWord:$})}else if(T.length===1){const O=T[0].content;l?(c(O),x({sourceWord:O})):(d(O),x({translationWord:O}))}}else if(A.nodeId){const T=N(A.nodeId);d(T),x({translationWord:T})}}catch(A){console.error("Failed to parse drop data:",A)}},[l,x]),I=(k,R)=>{k.preventDefault(),h(R)},C=()=>{h(null)};return t.jsxs("div",{ref:o,className:"w-full flex flex-col","data-text-position-container":"true","data-test":"vocab-vocabulary-view",children:[t.jsx("div",{className:je("flex items-center justify-center transition-colors rounded-t-md",u==="source"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:b,onDragOver:k=>I(k,"source"),onDragLeave:C,"data-test":"vocab-source-drop-zone",children:t.jsx(Re,{ref:r,type:"text",value:i,onChange:y,onKeyDown:m,placeholder:"Source word...","data-test":"vocab-source-input",className:je("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!f&&!g||w>1||n,"cursor-text":f,"cursor-default":!f}),readOnly:!f})}),t.jsx("div",{className:"py-1","data-test":"vocab-divider",children:t.jsx("div",{className:"border-t border-border"})}),t.jsx("div",{className:je("flex items-center justify-center transition-colors rounded-b-md",u==="translation"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:S,onDragOver:k=>I(k,"translation"),onDragLeave:C,"data-test":"vocab-translation-drop-zone",children:t.jsx(Re,{ref:a,type:"text",value:l,onChange:v,onKeyDown:m,placeholder:"Translation...","data-test":"vocab-translation-input",className:je("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!f&&!g||w>1||n,"cursor-text":f,"cursor-default":!f}),readOnly:!f})})]})},pv={noun:"bg-blue-100 text-blue-800",verb:"bg-green-100 text-green-800",adjective:"bg-purple-100 text-purple-800",adverb:"bg-orange-100 text-orange-800",pronoun:"bg-pink-100 text-pink-800",preposition:"bg-indigo-100 text-indigo-800",conjunction:"bg-yellow-100 text-yellow-800",interjection:"bg-red-100 text-red-800"},gv=({node:e,preventEdit:s})=>{var q,le;const n=p.useRef(null),o=p.useRef(null),r=e.data||{vocabType:Ue.DICTIONARY,term:"",definition:""},i=F(de=>de.uiState.hoveredDropTargetVocabNodeId)===e.id,[c,l]=p.useState(r.vocabType||Ue.DICTIONARY),[d,u]=p.useState(r.term||""),[h,f]=p.useState(r.pronunciation||""),[g,w]=p.useState(r.partOfSpeech||""),[m,x]=p.useState(r.definition||""),[y,v]=p.useState(r.flashcardBack||""),[N,b]=p.useState((r.wordListItems||[]).join(`
`)),[S,I]=p.useState(r.isFlipped||!1),[C,k]=p.useState(r.expandedSections||["definition"]),{onEditStart:R,onEditEnd:A}=en(e.id,"title"),{onEditStart:T,onEditEnd:O}=en(e.id,"content"),$=E.getState().updateNode,{isEditing:B,shouldFocus:H,handleMouseDown:M,handleBlur:j,handleKeyDown:P}=fd({nodeId:e.id,preventEdit:s,onEditStart:()=>{R(d),T(m)},onEditEnd:()=>{const de=N.split(`
`).map(U=>U.trim()).filter(U=>U.length>0);$(e.id,{data:{...r,vocabType:c,term:d,pronunciation:h,partOfSpeech:g,definition:m,flashcardBack:y,wordListItems:de,isFlipped:S,expandedSections:C},title:d,content:m}),A(d),O(m)}});p.useEffect(()=>{u(r.term||""),f(r.pronunciation||""),w(r.partOfSpeech||""),x(r.definition||""),v(r.flashcardBack||""),b((r.wordListItems||[]).join(`
`)),I(r.isFlipped||!1),l(r.vocabType||Ue.DICTIONARY),k(r.expandedSections||["definition"])},[r]),p.useEffect(()=>{H&&B&&n.current&&n.current.focus()},[H,B]);const W=p.useCallback(()=>{j()},[j]),L=p.useCallback(de=>{var U,Y;P(de),de.key==="Escape"&&((U=n.current)==null||U.blur(),(Y=o.current)==null||Y.blur())},[P]),z=de=>{k(U=>U.includes(de)?U.filter(Y=>Y!==de):[...U,de])},_=r.examples&&r.examples.length>0,G=(q=r.relatedWords)==null?void 0:q.some(de=>de.type==="synonym"),V=(le=r.relatedWords)==null?void 0:le.some(de=>de.type==="antonym"),D=r.etymology&&(r.etymology.origin||r.etymology.language),K=()=>{var de,U,Y,X,Z,ne,se,ae,me;return t.jsxs("div",{className:"w-full h-full flex flex-col overflow-auto",children:[t.jsx("div",{className:"border-b pb-3 mb-3",children:t.jsx(Re,{ref:n,type:"text",value:d,onChange:he=>u(he.target.value),onBlur:W,onMouseDown:M,onKeyDown:L,placeholder:"Term...","data-test":"vocab-term-input",className:je("text-lg font-semibold",{"pointer-events-none":s,"cursor-text":B,"cursor-default":!B}),readOnly:!B})}),(h||g)&&t.jsxs("div",{className:"flex gap-2 mb-3 flex-wrap",children:[h&&t.jsxs(tt,{"data-test":"vocab-pronunciation-badge",variant:"secondary",className:"text-xs",children:["/",h,"/"]}),g&&t.jsx(tt,{"data-test":"vocab-pos-badge",className:je("text-xs",pv[g]||"bg-gray-100 text-gray-800"),children:g})]}),t.jsxs(ps,{open:C.includes("definition"),onOpenChange:()=>z("definition"),className:"mb-2 border rounded",children:[t.jsxs(gs,{"data-test":"vocab-definition-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(jt,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Definition"})]}),t.jsx(fs,{className:"border-t",children:t.jsx(nr,{ref:o,value:m,onChange:he=>x(he.target.value),onBlur:W,onMouseDown:M,onKeyDown:L,placeholder:"Enter definition...","data-test":"vocab-definition-textarea",className:je("min-h-20 resize-none border-none focus:outline-none bg-transparent text-sm p-3",{"pointer-events-none":s,"cursor-text":B,"cursor-default":!B}),readOnly:!B})})]}),_&&t.jsxs(ps,{open:C.includes("examples"),onOpenChange:()=>z("examples"),className:"mb-2 border rounded",children:[t.jsxs(gs,{"data-test":"vocab-examples-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(jt,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Examples (",((de=r.examples)==null?void 0:de.length)||0,")"]})]}),t.jsx(fs,{className:"border-t p-3 space-y-2",children:(U=r.examples)==null?void 0:U.map(he=>t.jsxs("div",{"data-test":"vocab-example-item",className:"text-sm p-2 bg-muted rounded",children:[t.jsx("p",{className:"italic",children:he.text}),he.translation&&t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:he.translation})]},he.id))})]}),(G||V)&&t.jsxs(ps,{open:C.includes("related"),onOpenChange:()=>z("related"),className:"mb-2 border rounded",children:[t.jsxs(gs,{"data-test":"vocab-related-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(jt,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Related Words",G&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Synonyms (",((Y=r.relatedWords)==null?void 0:Y.filter(he=>he.type==="synonym").length)||0,")"]}),V&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Antonyms (",((X=r.relatedWords)==null?void 0:X.filter(he=>he.type==="antonym").length)||0,")"]})]})]}),t.jsx(fs,{className:"border-t p-3 space-y-2",children:(Z=r.relatedWords)==null?void 0:Z.map(he=>t.jsxs("div",{"data-test":"vocab-related-word",className:"flex items-center gap-2",children:[t.jsx(tt,{variant:"outline",className:"text-xs",children:he.type}),t.jsx("span",{className:"text-sm",children:he.word})]},he.id))})]}),D&&t.jsxs(ps,{open:C.includes("etymology"),onOpenChange:()=>z("etymology"),className:"mb-2 border rounded",children:[t.jsxs(gs,{"data-test":"vocab-etymology-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(jt,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Etymology"})]}),t.jsx(fs,{className:"border-t p-3 space-y-2",children:t.jsxs("div",{"data-test":"vocab-etymology-content",className:"text-sm space-y-2",children:[((ne=r.etymology)==null?void 0:ne.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((se=r.etymology)==null?void 0:se.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((ae=r.etymology)==null?void 0:ae.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((me=r.etymology)==null?void 0:me.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})})]})]})},te=()=>t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-4",children:[t.jsx("div",{"data-test":"vocab-flashcard-container",className:"relative w-full flex-1 flex items-center justify-center cursor-pointer",onClick:()=>I(!S),style:{perspective:"1000px"},children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center rounded-lg border-2 border-primary bg-card shadow-lg transition-transform",style:{transformStyle:"preserve-3d",transform:S?"rotateY(180deg)":"rotateY(0deg)",transitionDuration:"0.6s"},children:[t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden"},children:t.jsxs("div",{"data-test":"vocab-flashcard-front",className:"text-center",children:[h&&t.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["/",h,"/"]}),t.jsx("p",{className:"text-3xl font-bold",children:d}),g&&t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:g})]})}),t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden",transform:"rotateY(180deg)"},children:t.jsx("div",{"data-test":"vocab-flashcard-back",className:"text-center",children:t.jsx("p",{className:"text-lg",children:y||m})})})]})}),t.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"Click to flip"})]}),ie=()=>t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-wordlist-container",className:"grid grid-cols-2 gap-2 flex-1",children:(r.wordListItems||[]).map((de,U)=>t.jsx("div",{"data-test":"vocab-wordlist-item",className:"p-3 bg-muted rounded-lg border border-border hover:border-primary transition-colors",children:t.jsx("p",{className:"text-sm font-medium",children:de})},U))})}),ye=()=>{var de,U,Y,X;return t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-etymology-view",className:"space-y-4",children:t.jsxs("div",{className:"p-4 bg-muted rounded-lg border border-border",children:[t.jsxs("h3",{className:"font-semibold text-sm flex items-center gap-2 mb-3",children:[t.jsx(Rh,{className:"h-4 w-4"}),'Etymology of "',d,'"']}),t.jsxs("div",{className:"space-y-2 text-sm",children:[((de=r.etymology)==null?void 0:de.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((U=r.etymology)==null?void 0:U.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((Y=r.etymology)==null?void 0:Y.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((X=r.etymology)==null?void 0:X.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})]})})})},ge=i?{border:"2px dashed hsl(var(--primary))",boxShadow:"0 0 0 4px hsl(var(--primary) / 0.2)"}:{};return t.jsxs("div",{className:je("w-full h-full rounded-lg transition-all",i&&"ring-2 ring-primary/50"),style:ge,"data-test":"vocabulary-node-content",children:[c===Ue.DICTIONARY&&K(),c===Ue.FLASHCARD&&te(),c===Ue.WORD_LIST&&ie(),c===Ue.ETYMOLOGY&&ye(),c===Ue.VOCABULARY&&t.jsx(hv,{nodeId:e.id,nodeData:r,preventEdit:s})]})},md=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},fv=({element:e,index:s})=>{const{type:n,stroke:o,shape:r,style:a}=e,i=md(a),c=a.opacity??1;if(n==="freehand"&&o){const l=c<1;return t.jsx("path",{"data-test":"draw-freehand-path",d:o.smoothedPath,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:"none",strokeLinecap:l?"butt":"round",strokeLinejoin:l?"bevel":"round"},s)}if(n==="shape"&&r){const l=Ye.generateShapeSVGPath(r);return t.jsx("path",{"data-test":"draw-shape-path",d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:a.fillColor||"none",fillOpacity:a.fillColor?c:void 0,strokeLinecap:"round",strokeLinejoin:"round"},s)}return null},mv=p.memo(fv),xv=({drawData:e})=>{if(e.elements&&e.elements.length>0)return t.jsx(t.Fragment,{children:e.elements.map((c,l)=>t.jsx(mv,{element:c,index:l},l))});const{drawType:s,stroke:n,shape:o,style:r}=e;if(!r)return null;const a=md(r),i=r.opacity??1;if(s==="freehand"&&n)return t.jsx("path",{"data-test":"draw-freehand-path",d:n.smoothedPath,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:"none",strokeLinecap:"round",strokeLinejoin:"round"});if(s==="shape"&&o){const c=Ye.generateShapeSVGPath(o);return t.jsx("path",{"data-test":"draw-shape-path",d:c,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:r.fillColor||"none",fillOpacity:r.fillColor?i:void 0,strokeLinecap:"round",strokeLinejoin:"round"})}return null},wv=p.memo(xv),Ji=new Set(["circle","square"]),yv=e=>{var n;const s=e.elements??[];return s.length===0?(n=e.shape)!=null&&n.shapeType?Ji.has(e.shape.shapeType):!1:s.every(o=>{var r;return o.type==="shape"&&((r=o.shape)==null?void 0:r.shapeType)&&Ji.has(o.shape.shapeType)})},vv=({node:e})=>{const s=e.data;if(!s)return null;const n=s.intrinsicWidth??e.width??100,o=s.intrinsicHeight??e.height??100,r=yv(s);return t.jsx("svg",{"data-test":"draw-node-svg",viewBox:`0 0 ${n} ${o}`,preserveAspectRatio:r?"xMidYMid meet":"none",style:{width:e.width?`${e.width}px`:"100%",height:e.height?`${e.height}px`:"100%",overflow:"visible"},children:t.jsx(wv,{drawData:s})})},bv=p.memo(vv),Nv=[],xd="turn-to-vocabulary";function Qi(e,s){const n=yo(e),o=yo(s),a=Math.max(n,o)+40;return Math.max(a,Ne.VOCAB_NODE_MIN_WIDTH)}function wd(){var o;const e=E.getState(),n=(((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??[]).filter(r=>r.type===ce.TEXT).sort((r,a)=>r.x+r.y-(a.x+a.y));if(n.length!==0)if(n.length===1){const a=(typeof n[0].content=="string"?n[0].content:"").trim(),i={vocabType:Ue.VOCABULARY,term:"",definition:"",sourceWord:a,translationWord:""};e.updateNode(n[0].id,{type:ce.VOCABULARY,data:i,content:"",width:Qi(a,"")})}else{const r=n[0],a=n[n.length-1],i=typeof r.content=="string"?r.content:"",c=typeof a.content=="string"?a.content:"",l=i.trim(),d=c.trim(),u={vocabType:Ue.VOCABULARY,term:"",definition:"",sourceWord:l,translationWord:d};e.updateNode(r.id,{type:ce.VOCABULARY,data:u,content:"",width:Qi(l,d)});for(let f=1;f<n.length;f++)e.deleteNodeById(n[f].id);const h=e.getNodeById(r.id);h&&e.setSelectedNodes([h])}}tu(xd,()=>{wd()});function Sv({node:e,isLockSize:s,onLockSizeToggle:n}){const o=F(p.useCallback(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.coreState.layers)??Nv},[])),r=e.layerId??pt,a=o.filter(g=>g.id!==r),i=a.length>0,c=g=>{var x;const m=(((x=E.getState().projectCanvas.getActive())==null?void 0:x.coreState.selectedNodes)??[]).map(y=>y.id);E.getState().layer.moveNodesToLayer(m,g)},l=()=>{E.getState().deleteSelectedNodes(),E.getState().setSegmentedButtonAction("node-context-menu","Delete",()=>()=>E.getState().deleteSelectedNodes())},d=()=>{kl()},u=()=>{var m;const w=(((m=E.getState().projectCanvas.getActive())==null?void 0:m.coreState.selectedNodes)??[]).map(x=>typeof x.content=="string"?x.content:"").filter(x=>x.length>0);navigator.clipboard.writeText(w.join(`
`))},h=()=>{wd(),E.getState().setSegmentedButtonAction("node-context-menu","Turn to Vocabulary",void 0,{actionId:xd})},f=e.type===ce.TEXT;return t.jsxs(yp,{className:"w-48","data-test":"node-context-menu",children:[t.jsx(As,{onClick:()=>n(!s),"data-test":"lock-size-item",children:s?t.jsxs(t.Fragment,{children:[t.jsx(gl,{className:"mr-2 h-4 w-4"}),"Unlock Size"]}):t.jsxs(t.Fragment,{children:[t.jsx(ko,{className:"mr-2 h-4 w-4"}),"Lock Size"]})}),t.jsx(ua,{}),t.jsxs(As,{onClick:d,"data-test":"copy-item",children:[t.jsx(Pt,{className:"mr-2 h-4 w-4"}),"Copy"]}),t.jsxs(As,{onClick:u,"data-test":"copy-content-item",children:[t.jsx(Mh,{className:"mr-2 h-4 w-4"}),"Copy content"]}),i&&t.jsxs(ha,{children:[t.jsxs(pa,{"data-test":"move-to-trigger",children:[t.jsx(Vt,{className:"mr-2 h-4 w-4"}),"Move to"]}),t.jsx(ga,{"data-test":"move-to-submenu",children:t.jsxs(ha,{children:[t.jsxs(pa,{"data-test":"move-to-layer-trigger",children:[t.jsx(sn,{className:"mr-2 h-4 w-4"}),"Layer"]}),t.jsx(ga,{"data-test":"move-to-layer-submenu",children:a.map(g=>t.jsxs(As,{onClick:()=>c(g.id),disabled:g.isLocked,"data-test":"move-to-layer-option",children:[g.isLocked&&t.jsx(ko,{className:"mr-2 h-4 w-4"}),g.name]},g.id))})]})})]}),f&&t.jsxs(t.Fragment,{children:[t.jsx(ua,{}),t.jsxs(ha,{children:[t.jsxs(pa,{"data-test":"turn-to-trigger",children:[t.jsx(gr,{className:"mr-2 h-4 w-4"}),"Turn to"]}),t.jsx(ga,{"data-test":"turn-to-submenu",children:t.jsxs(As,{onClick:h,"data-test":"turn-to-vocabulary-item",children:[t.jsx(Go,{className:"mr-2 h-4 w-4"}),"Vocabulary"]})})]})]}),t.jsx(ua,{}),t.jsxs(As,{onClick:l,className:"text-destructive focus:text-destructive","data-test":"delete-item",children:[t.jsx(vt,{className:"mr-2 h-4 w-4"}),"Delete"]})]})}function Cv(){const[e,s]=p.useState(0),n=p.useRef(!1),o=p.useRef(0),r=p.useCallback(a=>{const i=Date.now(),c=i-o.current;if(a){const l=c<50;if(l&&(n.current=!0),n.current&&!l){n.current=!1,s(d=>d+1);return}}else o.current=i,s(l=>l+1)},[e]);return{menuKey:e,handleOpenChange:r}}const{DEFAULT_NODE_WIDTH:jv,DEFAULT_NODE_HEIGHT:kv}=Ne,Av=({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o=!1})=>{var O,$;const[r,a]=p.useState(!1),i=F(B=>B.uiState.mode),c=F(B=>!!B.uiState.dragInfo),l=F(B=>!!B.uiState.resizingNode),d=F(B=>B.uiState.activeGroupId),h=e.type===ce.GROUP&&d===e.id,f=()=>{var P,W;const B=(P=E.getState().projectCanvas.getActive())==null?void 0:P.coreState.selectedNodes,H=(B==null?void 0:B.some(L=>L.id===e.id))??!1,M=B&&B.length>0?((W=B[B.length-1])==null?void 0:W.id)===e.id:!1,j=(B==null?void 0:B.length)??0;return{isNodeAlreadySelected:H,isLastSelectedNode:M,selectedNodeIdsLength:j}},{isNodeAlreadySelected:g,isLastSelectedNode:w,selectedNodeIdsLength:m}=f();(O=E.getState().projectCanvas.getActive())==null||O.viewState.scale;const y=s&&(n??m)===1,{handleMouseDown:v,initialClickPoint:N}=ty({node:e,mode:i,isPopoverOpen:r,setIsPopoverOpen:a}),{menuKey:b,handleOpenChange:S}=Cv(),I=p.useCallback(B=>{var H;B&&(((H=E.getState().projectCanvas.getActive())==null?void 0:H.coreState.selectedNodes)??[]).length===0&&E.getState().setSelectedNodes([e]),S(B)},[e,S]),C=p.useCallback(B=>{E.getState().updateNode(e.id,{options:{...e.options,lockSize:B}})},[e.id,e.options]),k=p.useCallback(B=>{const H={x:B.clientX,y:B.clientY};if(!su(N.current,H))return;const j=!e.isEditing&&w;return a(j),j},[e,y,g,w,m,r]);p.useEffect(()=>{if(!g){a(!1);return}if(e.isEditing){a(!1);return}c||l||(w?a(!0):g&&!w&&a(!1))},[m,e.isEditing,g,y,w,e.id,c,l]),p.useEffect(()=>{(c||l)&&a(!1)},[c,l]);const R=()=>{if(o)return e.type===ce.CHAT?t.jsx(Za,{node:e}):null;const B=e.data,H=(B==null?void 0:B.nodeType)==="workflowOrchestration",M=(B==null?void 0:B.nodeType)==="workflowSource";if(H)return t.jsx(Vi,{node:e});if(M)return t.jsx(Ui,{node:e,preventEdit:!g});switch(e.type){case ce.RECT:return t.jsx(Sm,{node:e});case ce.TEXT:return t.jsx(Vl,{node:e});case ce.TABLE:return t.jsx(vy,{node:e});case ce.TEXTCARD:return t.jsx(by,{node:e});case ce.WORKFLOW_ORCHESTRATION:return t.jsx(Vi,{node:e});case ce.WORKFLOW_SOURCE:return t.jsx(Ui,{node:e,preventEdit:!g});case ce.WORKFLOW_DEFINITION:return t.jsx(Zy,{node:e,preventEdit:!g});case ce.OCR:return t.jsx(Qy,{node:e});case ce.IMAGE:return t.jsx(tv,{node:e});case ce.GROUP:return t.jsx(gd,{node:e});case ce.CHAT:return t.jsx(Za,{node:e});case ce.VOCABULARY:return t.jsx(gv,{node:e});case ce.WORKFLOW_STEP:return t.jsx(uv,{node:e});case ce.DRAWING:return t.jsx(bv,{node:e});default:return t.jsx("div",{children:"Unknown Node Type"})}},A=J.getSelectionRingClass(s),T=e.styles;return t.jsx(Gw,{node:e,isOpen:r,children:t.jsxs(vp,{onOpenChange:I,children:[t.jsx(bp,{asChild:!0,children:t.jsxs("div",{id:`NodeContainerV2-${e.id}`,"data-test":"node-container-v2",className:je("node-container-main","absolute group",i===Q.DRAW?"cursor-crosshair":"cursor-grab","select-none","rounded","overflow-visible",s&&A),style:{transform:(()=>{const B=_t.get(e.id),H=B?e.x+B.dx:e.x,M=B?e.y+B.dy:e.y;return`translate(${H}px, ${M}px)`})(),transition:c||l||i===Q.DRAW?"none":`transform ${J.animation.durationMs}ms ${J.animation.easing}`,width:e.isCollapsed?"auto":`${e.width??jv}px`,height:e.isCollapsed?"0px":`${e.height??kv}px`,minWidth:e.isCollapsed?"100px":void 0,transformOrigin:"0 0",border:e.isCollapsed?"none":T==null?void 0:T.border,borderWidth:e.isCollapsed||T==null?void 0:T.borderWidth,borderColor:e.isCollapsed||T==null?void 0:T.borderColor,borderStyle:e.isCollapsed?void 0:T!=null&&T.borderWidth?(T==null?void 0:T.borderStyle)||"solid":T==null?void 0:T.borderStyle,willChange:"transform",backfaceVisibility:"hidden",pointerEvents:h?"none":"auto"},onPointerDown:h?void 0:v,onPointerUp:h?void 0:k,"data-node-id":e.id,children:[t.jsx(Cy,{node:e,isSingleNodeSelected:y,isCollapsed:e.isCollapsed}),!e.isCollapsed&&t.jsx(Hy,{node:e}),e.isPinned&&t.jsx("div",{className:"pin-indicator-border absolute pointer-events-none rounded border-[3px] border-primary",style:{top:"-6px",left:"-6px",right:"-6px",bottom:"-6px",zIndex:1e3}}),(()=>{var P;const B=e.data,H=B==null?void 0:B.nodeType,M=B==null?void 0:B.executionState,j=(P=B==null?void 0:B.executionData)==null?void 0:P.duration;return H&&M?t.jsx(Fy,{executionState:M,duration:j}):null})(),y&&t.jsx(wy,{node:e}),!e.isCollapsed&&t.jsxs("section",{className:"node-content-section h-[100%] overflow-visible",children:[t.jsx("div",{id:`node-content-${e.id}`,className:je("node-content-inner relative w-full h-full overflow-visible","flex",{}),children:R()}),(()=>{var j;const B=e.data,H=(B==null?void 0:B.nodeType)==="manualTrigger",M=(j=B==null?void 0:B.parameters)==null?void 0:j.label;return H?t.jsx("div",{className:"manual-trigger-button-container absolute bottom-2 left-2 right-2 px-2",children:t.jsx(ud,{nodeId:e.id,label:M})}):null})()]}),!e.isCollapsed&&t.jsxs(t.Fragment,{children:[t.jsx(Jw,{node:e,isSelected:y,mode:i}),t.jsx(ey,{node:e,isSelected:y,mode:i})]})]})}),t.jsx(Sv,{node:e,isLockSize:(($=e.options)==null?void 0:$.lockSize)??!1,onLockSizeToggle:C})]},b)})};function Iv(e,s){if(e.node===s.node&&e.isSelected===s.isSelected&&e.selectedNodesCount===s.selectedNodesCount&&e.useSimplifiedRendering===s.useSimplifiedRendering)return!0;if(s.node.type===ce.GROUP){const A=[];e.node!==s.node&&A.push("node ref"),e.node.x!==s.node.x&&A.push(`x: ${e.node.x} -> ${s.node.x}`),e.node.y!==s.node.y&&A.push(`y: ${e.node.y} -> ${s.node.y}`),e.isSelected!==s.isSelected&&A.push("isSelected"),e.selectedNodesCount!==s.selectedNodesCount&&A.push(`selectedNodesCount: ${e.selectedNodesCount} -> ${s.selectedNodesCount}`)}const n=e.node.x===s.node.x,o=e.node.y===s.node.y,r=n&&o,a=e.node.width===s.node.width,i=e.node.height===s.node.height,c=a&&i,l=e.isSelected===s.isSelected,d=e.node.content===s.node.content,u=e.node.title===s.node.title,h=e.node.type===s.node.type,f=e.node.isEditing===s.node.isEditing,g=e.node.styles===s.node.styles,w=e.node.tags,m=s.node.tags,x=Array.isArray(w),y=Array.isArray(m),v=w===m||!x&&!y||x&&y&&w.length===m.length&&w.every((A,T)=>A===m[T]),N=e.node.isPinned===s.node.isPinned,b=e.node.isCollapsed===s.node.isCollapsed,S=e.node.data===s.node.data,I=e.node.options===s.node.options,C=e.selectedNodesCount===s.selectedNodesCount,k=e.useSimplifiedRendering===s.useSimplifiedRendering;return!!(r&&c&&l&&d&&u&&h&&f&&g&&v&&N&&b&&S&&I&&C&&k)}const Vo=Ie.memo(({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o})=>t.jsx(Av,{node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o}),Iv),Tv=e=>{const{className:s,style:n}=e,o=F(g=>g.uiState.mode),r=F(g=>g.uiState.zoomSubMode),a=F(g=>g.uiState.writeSubMode),i=F(g=>g.uiState.drawSubMode),c=F(g=>g.uiState.activeGlobalOverlay),[l,d]=p.useState(null);p.useEffect(()=>{if(o!==Q.VIM){d(null);return}const g=()=>{const m=window.__vimContainer;if(!m)return null;try{const x=m.get(Yc),y=x==null?void 0:x.getVimCore(Lt.canvasVim),v=y==null?void 0:y.getVimState();return(v==null?void 0:v.mode)??null}catch{return null}};d(g());const w=setInterval(()=>{d(g())},100);return()=>clearInterval(w)},[o]);let u=o;o===Q.ZOOM&&r==="zoom:lock"?u="zoom:lock":o===Q.WRITE&&a===Vs.AUDIO?u="write:audio":o===Q.DRAW?u=`draw: ${Ye.getSubModeLabel(i??Se.FREEHAND)}`:o===Q.VIM&&l&&(u=`vim: ${l.charAt(0)+l.slice(1).toLowerCase()}`);const f=(g=>!g||g===ms.NONE?null:g.charAt(0).toUpperCase()+g.slice(1))(c);return t.jsxs("div",{className:`text-xs p-1 bg-background/50 rounded pointer-events-auto ${s}`,style:{...n},"data-test":"canvas-mode-info",children:[t.jsxs("div",{"data-test":"canvas-mode-info-mode",children:["Mode: ",u||"N/A"]}),f&&t.jsxs("div",{"data-test":"canvas-mode-info-overlay",className:"text-primary",children:["Overlay: ",f]})]})},Ev=e=>{const{className:s,style:n}=e,[o,r]=p.useState(1),[a,i]=p.useState([]);p.useEffect(()=>{const x=E.subscribe(N=>{const b=N.projectCanvas.getActive();b&&r(b.viewState.scale),i(N.uiState.zoomMarks||[])}),y=E.getState(),v=y.projectCanvas.getActive();return v&&r(v.viewState.scale),i(y.uiState.zoomMarks||[]),x},[]);const c=x=>{const y=x[0],v=E.getState(),N=v.projectCanvas.getActive();if(!N)return;const{scale:b,offset:S}=N.viewState,I=document.getElementById("CanvasAppV2");if(!I)return;const C=I.getBoundingClientRect(),k={x:C.width/2,y:C.height/2},R=wt(k,b,S),A=k.x-R.x*y,T=k.y-R.y*y,O=isNaN(A)?0:A,$=isNaN(T)?0:T,B=isNaN(y)?1:y;v.setActiveCanvasViewState(H=>({...H,scale:B,offset:{x:O,y:$}}))},{min:l,max:d,marks:u}=J.zoom,h=Math.round(o*100),f=Array.from(new Set([...u,...a])).sort((x,y)=>x-y),g=()=>{const x=Math.round(o*100)/100;E.getState().addZoomMark(x)},w=x=>{E.getState().removeZoomMark(x)},m=x=>a.includes(x);return t.jsxs("div",{"data-ui-panel":"zoom-slider","data-test":"canvas-zoom-slider",className:`flex flex-col gap-2 p-2 bg-background/50 rounded pointer-events-auto min-w-[200px] ${s}`,style:{...n},children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{children:"Zoom"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"font-mono",children:[h,"%"]}),t.jsx(ee,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:g,title:"Save current zoom level","data-test":"canvas-zoom-save-button",children:t.jsx(yt,{className:"h-3 w-3"})})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(Kt,{value:[o],onValueChange:c,min:l,max:d,step:.01,className:"cursor-pointer","data-test":"canvas-zoom-slider"}),t.jsx("div",{className:"relative h-4 mt-1 px-3",children:f.map(x=>{const y=(x-l)/(d-l)*100,v=m(x);return t.jsxs("div",{className:"absolute flex flex-col items-center group",style:{left:`${y}%`,transform:"translateX(-50%)"},children:[t.jsxs("div",{className:"cursor-pointer hover:opacity-70 transition-opacity flex flex-col items-center",onClick:()=>c([x]),title:`Zoom to ${Math.round(x*100)}%`,children:[t.jsx("div",{className:`w-px h-2 ${v?"bg-primary/60":"bg-muted-foreground/40"}`}),t.jsx("span",{className:`text-[10px] mt-0.5 ${v?"text-primary":"text-muted-foreground"}`,children:x===1?"1×":`${x}×`})]}),v&&t.jsx("button",{className:"opacity-0 group-hover:opacity-100 absolute -top-2 right-0 h-3 w-3 rounded-full bg-destructive/80 hover:bg-destructive flex items-center justify-center transition-opacity",onClick:N=>{N.stopPropagation(),w(x)},title:"Remove mark","data-test":"canvas-zoom-remove-mark-button",children:t.jsx($e,{className:"h-2 w-2 text-destructive-foreground"})})]},x)})})]})]})},Ma=({position:e,onMouseDown:s,onDoubleClick:n,variant:o="end",size:r=4,className:a})=>t.jsx("circle",{"data-test":"arrow-handle",cx:e.x,cy:e.y,r,fill:"hsl(var(--primary))",stroke:"hsl(var(--primary-foreground))",strokeWidth:1,onPointerDown:s,onDoubleClick:n,className:je("cursor-move",a),style:{pointerEvents:"all",touchAction:"none"}}),ec=J.arrows.REVERSE_CURVE,Rv=(e,s)=>{const n=(e.x+s.x)/2,o=(e.y+s.y)/2,r=s.x-e.x,a=s.y-e.y,i=Math.sqrt(r*r+a*a);if(i===0)return{path:`M ${e.x} ${e.y}`,controlPoint:e};const c=-a/i,l=r/i;let d=i*.2;(!ec&&e.x<s.x||ec&&e.x>s.x)&&(d=-d);const u=n+c*d,h=o+l*d,f={x:u,y:h};return{path:`M ${e.x} ${e.y} Q ${u} ${h}, ${s.x} ${s.y}`,controlPoint:f}},Mv=(e,s,n)=>{let o=s.x-e.x;const r=s.y-e.y,a=Math.sqrt(o*o+r*r),i=Math.max(20,a*.15);if(a===0)return{x:0,y:i};let c=-r,l=o;n||(o=-o),o<0&&(c=-c,l=-l);const d=c/a,u=l/a;return{x:d*i,y:u*i}},no=()=>{var s;const e=((s=E.getState().projectCanvas.getActive())==null?void 0:s.coreState.nodes)??[];return _t.size>0?e.map(n=>{const o=_t.get(n.id);return o?{...n,x:n.x+o.dx,y:n.y+o.dy}:n}):e},Pv=(e,s,n,o,r)=>{kt(E,x=>{var y,v;return(v=(y=x.preferences)==null?void 0:y.canvasConfig)==null?void 0:v.arrows});const a=e.type??J.arrows.type,i=J.arrows.REVERSE_CURVE,c=J.arrows.CUBIC_HORIZONTAL_BIAS,l=-10,d=a==="TreeCubic"||a==="TreeLStep"||a==="TreeZShape",u=p.useMemo(()=>{const x=no(),y=x.find(S=>S.id===e.startNodeId),v=x.find(S=>S.id===e.endNodeId);if(d&&y&&v){const S=qe(y);return Eo(e.endNodeId,e.endPoint,S,x,l)}if((a==="Cubic"||a==="Orthogonal")&&y&&v){const S=qe(y);return Fs(e.endNodeId,e.endPoint,S,x,l,c)}if(a==="Step"&&y&&v){const S=qe(y),I=qe(v),C=I.x-S.x,k=I.y-S.y,A=Math.abs(C)*c>=Math.abs(k)?.001:1e3;return Fs(e.endNodeId,e.endPoint,S,x,l,A)}const N=y?et(e.startNodeId,e.startPoint,e.endPoint,x,e.startRowId):e.startPoint;return v?et(e.endNodeId,e.endPoint,N,x,e.endRowId):e.endPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,a,c,n,o,r]),h=p.useMemo(()=>{const x=no(),y=x.find(b=>b.id===e.startNodeId),v=x.find(b=>b.id===e.endNodeId);if(a==="TreeLStep"&&y)return Al(e.startNodeId,e.startPoint,x);if((a==="TreeCubic"||a==="TreeZShape")&&y&&v){const b=qe(v);return Eo(e.startNodeId,e.startPoint,b,x,0)}if((a==="Cubic"||a==="Step"||a==="Orthogonal")&&y&&v){const b=qe(v);return Fs(e.startNodeId,e.startPoint,b,x,0,c)}const N=v?et(e.endNodeId,e.endPoint,e.startPoint,x,e.endRowId):e.endPoint;return y?et(e.startNodeId,e.startPoint,N,x,e.startRowId):e.startPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,a,c,n,o,r]),f=p.useMemo(()=>{const x=(h.x+u.x)/2,y=(h.y+u.y)/2;if(e.controlPointOffset)return{x:x+e.controlPointOffset.x,y:y+e.controlPointOffset.y};{const v=Mv(h,u,i),N=u.x-h.x,b=u.y-h.y,S=N>0?x-v.x:x+v.x,I=b<0?y-v.y:y+v.y;return{x:S,y:I}}},[e.controlPointOffset,h,u,s,i]),g=p.useMemo(()=>{if(a!=="Cubic"&&a!=="TreeCubic")return null;const x=no(),y=x.find(S=>S.id===e.startNodeId),v=x.find(S=>S.id===e.endNodeId);let N="horizontal",b;if(y&&v){const S=qe(y),I=qe(v),C=I.x-S.x,k=I.y-S.y;a==="TreeCubic"?N="horizontal":N=Math.abs(C)*c>=Math.abs(k)?"horizontal":"vertical",b={dx:C,dy:k}}return Ug(h,u,N,b)},[h,u,a,e.startNodeId,e.endNodeId,c,n,o,r]),{path:w}=p.useMemo(()=>Rv(h,u),[h,u,s]),m=p.useMemo(()=>{if(!(a==="Step"||a==="Orthogonal"||a==="TreeLStep"||a==="TreeZShape"))return null;if(a==="TreeLStep")return[h,{x:h.x,y:u.y},u];if(a==="TreeZShape"){const S=(h.x+u.x)/2;return[h,{x:S,y:h.y},{x:S,y:u.y},u]}const y=no(),v=y.find(S=>S.id===e.startNodeId),N=y.find(S=>S.id===e.endNodeId);let b=!0;if(v&&N){const S=qe(v),I=qe(N),C=I.x-S.x,k=I.y-S.y;b=Math.abs(C)*c>=Math.abs(k)}if(a==="Step")return b?[h,{x:u.x,y:h.y},u]:[h,{x:h.x,y:u.y},u];{const S=(h.x+u.x)/2,I=(h.y+u.y)/2;return b?[h,{x:S,y:h.y},{x:S,y:u.y},u]:[h,{x:h.x,y:I},{x:u.x,y:I},u]}},[h,u,a,e.startNodeId,e.endNodeId,c,n,o,r]);return{actualStartPoint:h,actualEndPoint:u,bezierPath:w,controlPoint:f,cubicControlPoints:g,stepPoints:m,arrowType:a}},Dv=(e,s,n,o,r)=>{const a=E.getState();a.scrollToArrow;const i=a.uiState.mode,c=a.projectCanvas.getActive(),l=(c==null?void 0:c.viewState.scale)??1,d=(c==null?void 0:c.coreState.nodes)??[],u=a.arrow.setAll,h=a.arrow.setSelected,f=a.setSelectedNodes,[g,w]=p.useState(null),[m,x]=p.useState(null),[y,v]=p.useState(null),N=p.useRef(null),b=p.useCallback((S,I)=>{i!==Q.SELECT||S.button!==0&&S.button!==-1||(S.stopPropagation(),w(I),x({x:S.clientX,y:S.clientY}),v({...e,startPoint:s,endPoint:n,controlPointOffset:o}),N.current=I==="start"?s:I==="end"?n:o,r||(f([]),h([e])))},[i,e,s,n,o,r,h,f]);return p.useEffect(()=>{const S=C=>{var j;if(!g||!m||!y)return;const k=C.clientX-m.x,R=C.clientY-m.y,A=k/l,T=R/l,O=g==="start"?y.startPoint:g==="end"?y.endPoint:y.controlPointOffset;let $={x:O.x+A,y:O.y+T};const B=Ro(C.clientX,C.clientY);let H=null,M=null;if(B){H=B.nodeId,M=B.rowId;const P=g==="start"?y.endPoint:g==="end"?y.startPoint:y.controlPointOffset;$=et(H,$,P,d,M)}else{const P=xo($,d);if(P&&!(((j=P.data)==null?void 0:j.nodeType)==="workflowOrchestration")){H=P.id;const L=g==="start"?y.endPoint:g==="end"?y.startPoint:y.controlPointOffset;$=et(H,$,L,d)}}N.current=$,u(P=>P.map(W=>{if(W.id===y.id){const L={...W};if(g==="start")L.startPoint=$,L.startNodeId=H,L.startRowId=M;else if(g==="end")L.endPoint=$,L.endNodeId=H,L.endRowId=M;else if(g==="control"){const z=W.startNodeId?et(W.startNodeId,W.startPoint,W.endPoint,d,W.startRowId):W.startPoint,_=W.endNodeId?et(W.endNodeId,W.endPoint,W.startPoint,d,W.endRowId):W.endPoint,G=(z.x+_.x)/2,V=(z.y+_.y)/2,D={x:$.x-G,y:$.y-V};L.controlPointOffset=D}return L}return W}))},I=C=>{var R;if(!g||!y)return;const k=N.current;if(k){const A=Ro(C.clientX,C.clientY);let T=null,O=null;const $=g==="start"?y.endPoint:g==="end"?y.startPoint:y.controlPointOffset;let B;if(A)T=A.nodeId,O=A.rowId,B=et(T,k,$,d,O);else{const H=xo(k,d);H?((R=H.data)==null?void 0:R.nodeType)==="workflowOrchestration"?B=k:(T=H.id,B=et(T,k,$,d)):B=k}u(H=>H.map(M=>{if(M.id===y.id){const j={...M};return g==="start"?(j.startPoint=B,j.startNodeId=T,j.startRowId=O):g==="end"&&(j.endPoint=B,j.endNodeId=T,j.endRowId=O),j}return M}))}w(null),x(null),v(null),N.current=null};return g&&(window.addEventListener("pointermove",S),window.addEventListener("pointerup",I)),()=>{window.removeEventListener("pointermove",S),window.removeEventListener("pointerup",I)}},[g,m,y,l,u,d]),{handleMouseDownOnHandle:b}},Ov=(e,s,n)=>`M ${e.x} ${e.y} Q ${s.x} ${s.y} ${n.x} ${n.y}`,Lv=(e,s,n,o)=>`M ${e.x} ${e.y} C ${s.x} ${s.y} ${n.x} ${n.y} ${o.x} ${o.y}`,Wv=e=>{if(e.length<2)return"";const[s,...n]=e;return`M ${s.x} ${s.y} `+n.map(o=>`L ${o.x} ${o.y}`).join(" ")},Ja=({startPoint:e,endPoint:s,controlPoint:n,cubicControlPoints:o,stepPoints:r,useCurvedArrows:a,stroke:i,strokeWidth:c,markerEndId:l,strokeDasharray:d,isHitbox:u=!1,onPointerDown:h})=>{const f={stroke:i,strokeWidth:c,fill:"none",strokeDasharray:d,markerEnd:!u&&l?`url(#${l})`:void 0,onPointerDown:h,style:{pointerEvents:"auto"}};if(r&&r.length>=2){const g=Wv(r);return t.jsx("path",{d:g,...f})}if(a&&o&&o.length===2){const[g,w]=o,m=Lv(e,g,w,s);return t.jsx("path",{d:m,...f})}if(a&&n){const g=Ov(e,n,s);return t.jsx("path",{d:g,...f})}return t.jsx("line",{x1:e.x,y1:e.y,x2:s.x,y2:s.y,...f})},Hv=({isSelected:e,label:s,labelPosition:n,labelInput:o,setLabelInput:r,onLabelChange:a,onLabelBlur:i,onLabelKeyDown:c})=>{const l=Ne.FONT_SIZE_XXS,d=6,u=4,h=l*.6,g=s.length*h+2*d,w=l+2*u;return e?t.jsx("foreignObject",{x:n.x-50,y:n.y-15,width:"100",height:"30",style:{pointerEvents:"auto"},children:t.jsx(Re,{"data-test":"arrow-label-input",type:"text",value:o,onChange:a,onBlur:i,onKeyDown:c,onMouseDown:m=>m.stopPropagation(),placeholder:"Label",className:"w-full h-full text-[12px]! text-center p-0.5 bg-background border border-border rounded-sm focus:ring-1 focus:ring-ring focus:outline-none"})}):s?t.jsxs(t.Fragment,{children:[t.jsx("rect",{x:n.x-g/2,y:n.y-w/2,width:g,height:w,fill:"hsl(var(--background))",rx:"3",ry:"3",style:{pointerEvents:"none"}}),t.jsx("text",{x:n.x,y:n.y,fill:"hsl(var(--foreground))",fontSize:l,textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:s})]}):null},Bv=({markerId:e,strokeColor:s,markerOrientation:n})=>t.jsx("defs",{children:t.jsx("marker",{id:e,markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:n,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:s})})}),Fv=({arrow:e})=>{const s=F(z=>{var _,G;return((G=(_=z.projectCanvas.getActive())==null?void 0:_.coreState.selectedArrows)==null?void 0:G.some(V=>V.id===e.id))??!1}),n=F(z=>z.uiState.mode),{setSelectedNodes:o}=E.getState(),{setSelected:r,update:a}=E.getState().arrow;F(z=>{var _,G;return(G=(_=z.preferences)==null?void 0:_.canvasConfig)==null?void 0:G.arrows});const i=F(z=>{var G,V;const _=(V=(G=z.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:V.find(D=>D.id===e.startNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),c=F(z=>{var G,V;const _=(V=(G=z.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:V.find(D=>D.id===e.endNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),l=F(z=>z.uiState.dragVersion??0),{actualStartPoint:d,actualEndPoint:u,controlPoint:h,cubicControlPoints:f,stepPoints:g,arrowType:w}=Pv(e,!0,i,c,l),m=w!=="Straight",{handleMouseDownOnHandle:x}=Dv(e,d,u,h,s),y=z=>{var V;if(n!==Q.SELECT||z.button!==0&&z.button!==-1)return;z.stopPropagation();const _=((V=E.getState().projectCanvas.getActive())==null?void 0:V.coreState.selectedArrows)??[];if(z.ctrlKey||z.metaKey){r(s?_.filter(D=>D.id!==e.id):[..._,e]);return}if(z.shiftKey){s||r([..._,e]);return}o([]),r([e])},v=z=>{z.stopPropagation(),a(e.id,{controlPointOffset:null})},[N,b]=p.useState(e.label||""),S=p.useRef(null);p.useEffect(()=>{s&&S.current===null?S.current=e.label||"":s||(S.current=null)},[s,e.label]),p.useEffect(()=>{b(e.label||"")},[e.label]);const I=z=>{b(z.target.value),a(e.id,{label:z.target.value})},C=()=>{e.label!==N&&a(e.id,{label:N});const z=S.current;z!==null&&z!==N&&E.getState().undo.commit({type:"arrow:update",arrowId:e.id,from:{label:z},to:{label:N}})},k=z=>{z.key==="Enter"&&z.currentTarget.blur(),z.stopPropagation()},R=0,A=p.useMemo(()=>{if(m&&h){const z=(d.x+u.x)/2,_=(d.y+u.y)/2;return{x:z-(h.x-z),y:_-(h.y-_)+R}}return{x:(d.x+u.x)/2,y:(d.y+u.y)/2+R}},[d,u,h,m]),T=e.strokeColor??J.arrows.styles.line,O=s&&!e.strokeColor?J.arrows.styles.lineSelected:T,$=e.strokeWidth??1,B=s?$+.5:$,M=(z=>{switch(z){case"dashed":return"8,4";case"dotted":return"2,4";default:return}})(e.strokeStyle),j=s&&n===Q.SELECT,P=m?"auto-start-reverse":"auto",W=`arrowhead-${e.id}`,L=e.strokeColor??O;return t.jsxs("g",{"data-arrow-id":e.id,style:{cursor:n===Q.SELECT?"pointer":"default"},children:[t.jsx(Bv,{markerId:W,strokeColor:L,markerOrientation:P}),t.jsx(Ja,{startPoint:d,endPoint:u,controlPoint:h,cubicControlPoints:f,stepPoints:g,useCurvedArrows:m,stroke:O,strokeWidth:B,strokeDasharray:M,markerEndId:W}),t.jsx(Ja,{startPoint:d,endPoint:u,controlPoint:h,cubicControlPoints:f,stepPoints:g,useCurvedArrows:m,stroke:"transparent",strokeWidth:15,isHitbox:!0,onPointerDown:y}),j&&t.jsxs(t.Fragment,{children:[t.jsx(Ma,{position:d,onMouseDown:z=>x(z,"start")}),t.jsx(Ma,{position:u,onMouseDown:z=>x(z,"end")}),m&&h&&t.jsx(Ma,{position:h,onMouseDown:z=>x(z,"control"),onDoubleClick:v,variant:"control"})]}),t.jsx(Hv,{isSelected:s,label:e.label||"",labelPosition:A,labelInput:N,setLabelInput:b,onLabelChange:I,onLabelBlur:C,onLabelKeyDown:k})]})};function $v(e,s){const n=e.arrow,o=s.arrow,r=n.startPoint.x===o.startPoint.x&&n.startPoint.y===o.startPoint.y,a=n.endPoint.x===o.endPoint.x&&n.endPoint.y===o.endPoint.y,i=n.label===o.label,c=n.type===o.type,l=n.controlPointOffset==null&&o.controlPointOffset==null||n.controlPointOffset!=null&&o.controlPointOffset!=null&&n.controlPointOffset.x===o.controlPointOffset.x&&n.controlPointOffset.y===o.controlPointOffset.y,d=n.strokeColor===o.strokeColor,u=n.strokeWidth===o.strokeWidth,h=n.strokeStyle===o.strokeStyle;return r&&a&&i&&c&&l&&d&&u&&h}const yd=Ie.memo(Fv,$v),zv=[{value:"solid",label:"Solid",dashArray:"none"},{value:"dashed",label:"Dashed",dashArray:"8,4"},{value:"dotted",label:"Dotted",dashArray:"2,4"}],_v=({currentColor:e,currentWidth:s,currentStyle:n,onColorSelect:o,onWidthChange:r,onStyleChange:a})=>{const[i,c]=p.useState(e),[l,d]=p.useState(s),[u,h]=p.useState(n);p.useEffect(()=>{c(e)},[e]),p.useEffect(()=>{d(s)},[s]),p.useEffect(()=>{h(n)},[n]);const f=m=>{c(m),o(m)},g=m=>{const x=parseFloat(m.target.value);!isNaN(x)&&x>=.5&&x<=10&&(d(x),r(x))},w=m=>{h(m),a(m)};return t.jsxs("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"arrow-style-picker-content",children:[t.jsxs("div",{"data-test":"arrow-style-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:Qo.filter(m=>m.value!=="transparent").map(m=>t.jsx("button",{type:"button",title:m.name,onClick:()=>f(m.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",m.twClass,m.value===i?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",m.value==="#ffffff"&&"border-neutral-300"),style:m.value.startsWith("hsl(")?{backgroundColor:m.value}:{},"aria-label":`Select color ${m.name}`,"data-test":"arrow-color-option"},m.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?ea(i):i.startsWith("#")?i:"#000000",onChange:m=>f(m.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"arrow-color-custom-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-width-section",children:[t.jsxs("label",{htmlFor:"arrow-stroke-width-input",className:"block text-xs text-muted-foreground font-medium mb-1",children:["Stroke Width: ",l,"px"]}),t.jsx("input",{type:"range",id:"arrow-stroke-width-input",value:l,onChange:g,min:"0.5",max:"10",step:"0.5",className:"w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer","data-test":"arrow-stroke-width-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-style-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Style"}),t.jsx("div",{className:"flex gap-2",children:zv.map(m=>t.jsx("button",{type:"button",onClick:()=>w(m.value),className:ve("flex-1 px-2 py-1.5 rounded border text-xs",u===m.value?"border-primary bg-primary/10":"border-muted hover:border-muted-foreground"),title:m.label,"data-test":"arrow-style-option",children:t.jsx("svg",{width:"100%",height:"12",viewBox:"0 0 40 12",className:"stroke-current",children:t.jsx("line",{x1:"2",y1:"6",x2:"38",y2:"6",strokeWidth:"2",strokeDasharray:m.dashArray,fill:"none"})})},m.value))})]})]})},Vv=[],Uv=({className:e})=>{const[s,n]=p.useState(!1),o=F(S=>{var I;return((I=S.projectCanvas.getActive())==null?void 0:I.coreState.selectedArrows)??Vv}),r=F(S=>S.arrow.update),a=o.length>0?o[0]:null,[i,c]=p.useState((a==null?void 0:a.strokeColor)??"hsl(var(--muted-light))"),[l,d]=p.useState((a==null?void 0:a.strokeWidth)??1),[u,h]=p.useState((a==null?void 0:a.strokeStyle)??"solid"),f=E.getState().getLastUsedArrowStyle();p.useEffect(()=>{a?(c(a.strokeColor??"hsl(var(--muted-light))"),d(a.strokeWidth??1),h(a.strokeStyle??"solid")):(c("hsl(var(--muted-light))"),d(1),h("solid"))},[a]);const g=(S,I,C)=>{o.forEach(k=>{r(k.id,{strokeColor:S,strokeWidth:I,strokeStyle:C})})},w=()=>{g(f.lastUsedColor,f.lastUsedWidth,f.lastUsedStyle)},m=S=>{g(S,l,u),c(S),E.getState().setLastUsedArrowStyle(S,l,u),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},x=S=>{g(i,S,u),d(S),E.getState().setLastUsedArrowStyle(i,S,u),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},y=S=>{g(i,l,S),h(S),E.getState().setLastUsedArrowStyle(i,l,S),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},v=()=>{c("hsl(var(--muted-light))"),d(1),h("solid"),g(void 0,void 0,void 0)},N=[{label:"Apply last used style",icon:t.jsx("span",{style:{color:f.lastUsedColor,display:"inline-flex"},children:t.jsx(Yr,{className:"h-2.5 w-2.5"})}),onClick:w,disabled:o.length===0},{label:"Set Arrow Style",icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(il,{className:"h-2.5 w-2.5"})}),onClick:()=>{n(!0)},disabled:o.length===0},{label:"Reset Style",icon:t.jsx(Un,{className:"h-2.5 w-2.5"}),onClick:v,disabled:o.length===0}],b={...N[0],icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(Yr,{className:"h-2.5 w-2.5"})})};return t.jsxs(ct,{open:s,onOpenChange:n,children:[t.jsx(lt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"arrow-style-picker-button",children:t.jsx(Ze,{mainAction:b,dropdownActions:N,variant:"outline",size:"compact",persistenceKey:"arrow-style-picker",className:e})})}),t.jsx(dt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:S=>S.preventDefault(),"data-test":"arrow-style-picker-popover",children:t.jsx(_v,{currentColor:i,currentWidth:l,currentStyle:u,onColorSelect:m,onWidthChange:x,onStyleChange:y})})]})},tc=[],Gv=[],Yv=()=>{const e=F(d=>d.setSelectedNodes),s=F(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??tc}),n=F(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedArrows)??Gv});F(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.nodes)??tc});const o=s.length>0,r=p.useMemo(()=>{const d=new Set;return n.forEach(u=>{u.startNodeId&&d.add(u.startNodeId),u.endNodeId&&d.add(u.endNodeId)}),d},[n]),a=p.useCallback(()=>{const u=E.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.selectedArrows??[],f=u.coreState.nodes??[],g=new Set;h.forEach(m=>{m.startNodeId&&g.add(m.startNodeId),m.endNodeId&&g.add(m.endNodeId)});const w=f.filter(m=>g.has(m.id));e(w)},[e]),i=p.useCallback(()=>{e([])},[e]),c=[{label:"Select connected nodes",icon:t.jsx(Kr,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0},{label:"Deselect all nodes",icon:t.jsx($e,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!o}],l=o?{label:"Deselect all nodes",icon:t.jsx($e,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!1}:{label:"Select connected nodes",icon:t.jsx(Kr,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0};return t.jsx(Ze,{mainAction:l,dropdownActions:c,variant:"outline",size:"compact",persistenceKey:"arrow-connected-nodes","data-test":"arrow-connected-nodes-button"})},Kv=({arrows:e})=>{const s=p.useCallback(()=>{E.getState().deleteSelectedArrows()},[]);return t.jsxs("div",{className:je("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:Ee.nodeQuickPanel},"data-test":"arrow-quick-panel-container","data-arrow-ids":e.map(n=>n.id).join(","),children:[t.jsx(Uv,{}),t.jsx(od,{}),t.jsx(Yv,{}),t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:s,title:"Delete selected arrows","data-test":"arrow-delete-button",children:t.jsx(vt,{className:"h-3.5 w-3.5"})})]})},oo=30,Xv=[],qv=()=>{var d;const[e,s]=p.useState({top:0,left:0}),n=p.useRef(null),o=F(u=>{var h,f;return(((f=(h=u.projectCanvas.getActive())==null?void 0:h.coreState.selectedArrows)==null?void 0:f.length)??0)>0}),r=F(u=>u.uiState.mode),a=F(u=>{var h;return(h=u.projectCanvas.getActive())==null?void 0:h.viewState}),i=o,c=r===Q.DRAW_ARROW;if(p.useEffect(()=>{if(!i||!a)return;const u=()=>{var $,B,H,M;const f=(($=E.getState().projectCanvas.getActive())==null?void 0:$.coreState.selectedArrows)??[],g=((B=E.getState().projectCanvas.getActive())==null?void 0:B.coreState.nodes)??[];if(f.length===0)return;let w=0,m=0,x=0,y=0,v=0;if(f.forEach(j=>{const P=document.querySelector(`[data-arrow-id="${j.id}"]`);if(!P)return;const W=P.getBoundingClientRect(),L=W.left+W.width/2,z=W.top+W.height/2,{actualStartPoint:_,actualEndPoint:G}=Il(j,g),V=G.x-_.x,D=G.y-_.y;w+=L,m+=z,x+=V,y+=D,v++}),v===0)return;const N=w/v,b=m/v,S=Math.abs(y)>Math.abs(x),I=((H=n.current)==null?void 0:H.offsetHeight)||40,C=((M=n.current)==null?void 0:M.offsetWidth)||100,k=window.innerWidth,R=window.innerHeight,A=20;let T,O;if(S){const j=N-C-oo,P=N+oo,W=j>=A,L=P+C<=k-A;O=W?j:L?P:A,T=b-I/2}else{const j=b-I-oo,P=b+oo,W=j>=A,L=P+I<=R-A;T=W?j:L?P:A,O=N-C/2}T=Math.max(A,Math.min(T,R-I-A)),O=Math.max(A,Math.min(O,k-C-A)),s({top:T,left:O})};u();const h=setTimeout(u,100);return window.addEventListener("scroll",u,!0),window.addEventListener("resize",u),()=>{clearTimeout(h),window.removeEventListener("scroll",u,!0),window.removeEventListener("resize",u)}},[i,a]),!i||c)return null;const l=((d=E.getState().projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??Xv;return tn.createPortal(t.jsx("div",{ref:n,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:Ee.quickPanelPortal},onPointerDown:u=>u.stopPropagation(),onTouchStart:u=>u.stopPropagation(),onWheel:u=>u.stopPropagation(),"data-test":"arrow-quick-panel-portal",children:t.jsx(Kv,{arrows:l})}),document.body)},Zv=({currentColor:e,onColorSelect:s})=>{const[n,o]=p.useState(e);p.useEffect(()=>{o(e)},[e]);const r=a=>{o(a),s(a)};return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"group-background-picker-content",children:t.jsxs("div",{"data-test":"group-background-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Background Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:Qo.map(a=>t.jsx("button",{type:"button",title:a.name,onClick:()=>r(a.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",a.twClass,a.value===n?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",a.value==="#ffffff"&&"border-neutral-300",a.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:a.value.startsWith("hsl(")?{backgroundColor:a.value}:{},"aria-label":`Select color ${a.name}`,"data-test":"group-background-color-option"},a.value))}),t.jsx("input",{type:"color",value:n.startsWith("hsl")?ea(n):n.startsWith("#")?n:"#000000",onChange:a=>r(a.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"group-background-color-custom-input"})]})})},fn="hsl(var(--background))",sc=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),Jv=({groups:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e,i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.styles)==null?void 0:v.backgroundColor)??fn),[u,h]=p.useState(fn);p.useEffect(()=>{var N;d(c?((N=c.styles)==null?void 0:N.backgroundColor)??fn:fn)},[c]);const f=N=>{a.forEach(b=>{const S=b.data,I={...S,childNodeIds:(S==null?void 0:S.childNodeIds)??[],styles:{...S==null?void 0:S.styles,backgroundColor:N}};r(b.id,{data:I})})},g=()=>{f(u)},w=N=>{f(N),d(N),h(N),E.getState().setSegmentedButtonAction("group-background-picker","Apply last used style")},m=()=>{d(fn),f(void 0)},x=[{label:"Apply last used style",icon:t.jsx(sc,{color:u}),onClick:g,disabled:a.length===0},{label:"Set Background Color",icon:t.jsx(sc,{color:l}),onClick:()=>{o(!0)},disabled:a.length===0},{label:"Reset Style",icon:t.jsx(Un,{className:"h-2.5 w-2.5"}),onClick:m,disabled:a.length===0}],y={...x[0]};return t.jsxs(ct,{open:n,onOpenChange:o,children:[t.jsx(lt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"group-background-picker-button",children:t.jsx(Ze,{mainAction:y,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"group-background-picker",className:s})})}),t.jsx(dt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"group-background-picker-popover",children:t.jsx(Zv,{currentColor:l,onColorSelect:w})})]})},Qv=({groups:e})=>t.jsx("div",{className:je("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:Ee.nodeQuickPanel},"data-test":"group-quick-panel-container","data-group-ids":e.map(s=>s.id).join(","),children:t.jsx(Jv,{groups:e})}),nc=10,eb=100,tb=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(Q.SELECT),l=p.useRef(null),d=p.useRef(""),u=p.useRef(!1),h=p.useRef(Q.SELECT);p.useEffect(()=>{const m=()=>{var C;const y=E.getState(),v=(C=y.projectCanvas.getActive())==null?void 0:C.coreState.selectedNodes,N=!!y.uiState.dragInfo,b=y.uiState.mode;if(N!==u.current&&(u.current=N,a(N)),b!==h.current&&(h.current=b??Q.SELECT,c(b??Q.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let S="";const I=[];for(const k of v)k.type===ce.GROUP&&(S+=(S?",":"")+k.id,I.push(k));S!==d.current&&(d.current=S,o(I))};m();const x=setInterval(m,eb);return()=>clearInterval(x)},[]);const f=n.length>=1&&!r,g=i===Q.DRAW_ARROW,w=Ie.useMemo(()=>n.map(m=>m.id),[n]);return p.useEffect(()=>{if(!f||w.length===0)return;const m=()=>{var $,B;let y=0,v=0,N=0;if(w.forEach(H=>{const M=document.querySelector(`[data-node-id="${H}"]`);if(!M)return;const j=M.getBoundingClientRect(),P=j.left+j.width/2,W=j.top;y+=P,v+=W,N++}),N===0)return;const b=y/N,S=v/N,I=(($=l.current)==null?void 0:$.offsetHeight)||40,C=((B=l.current)==null?void 0:B.offsetWidth)||100,k=window.innerWidth,R=window.innerHeight,A=20;let T=S-I-nc,O=b-C/2;if(T<A){let H=0;w.forEach(M=>{const j=document.querySelector(`[data-node-id="${M}"]`);if(j){const P=j.getBoundingClientRect();H=Math.max(H,P.bottom)}}),T=H+nc}T=Math.max(A,Math.min(T,R-I-A)),O=Math.max(A,Math.min(O,k-C-A)),s({top:T,left:O})};m();const x=setTimeout(m,100);return()=>{clearTimeout(x)}},[f,w]),!f||w.length===0||g?null:tn.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:Ee.popover},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),"data-test":"group-quick-panel-portal",children:t.jsx(Qv,{groups:n})}),document.body)},sb=Ie.memo(tb),Ar=({label:e,currentColor:s,onColorSelect:n})=>{const[o,r]=p.useState(s);p.useEffect(()=>{r(s)},[s]);const a=c=>{r(c),n(c)},i=s==="currentColor"?"hsl(var(--foreground))":s;return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"draw-color-picker-content",children:t.jsxs("div",{"data-test":"draw-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:e}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:Qo.map(c=>t.jsx("button",{type:"button",title:c.name,onClick:()=>a(c.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",c.twClass,c.value===o?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",c.value==="#ffffff"&&"border-neutral-300",c.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:c.value.startsWith("hsl(")?{backgroundColor:c.value}:{},"aria-label":`Select color ${c.name}`,"data-test":"draw-color-option"},c.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?ea(i):i.startsWith("#")?i:"#000000",onChange:c=>a(c.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"draw-color-custom-input"})]})})},Os="currentColor";let oc=Os;const ac=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-color-swatch-icon",children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e==="currentColor"?"hsl(var(--foreground))":e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),nb=({drawings:e,className:s})=>{var y;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((y=i==null?void 0:i.style)==null?void 0:y.strokeColor)??Os),[d,u]=p.useState(oc);p.useEffect(()=>{var v;l(i?((v=i.style)==null?void 0:v.strokeColor)??Os:Os)},[i]);const h=v=>{e.forEach(N=>{const b=N.data;if(!b)return;if(b.elements&&b.elements.length>0){const I=b.elements.map(C=>({...C,style:{...C.style,strokeColor:v}}));r(N.id,{data:{...b,elements:I}});return}const S={...b,drawType:(b==null?void 0:b.drawType)??"freehand",style:{...Tt,...b==null?void 0:b.style,strokeColor:v}};r(N.id,{data:S})})},f=()=>{h(d)},g=v=>{h(v),l(v),u(v),oc=v,E.getState().setSegmentedButtonAction("draw-stroke-color","Apply last used color")},w=()=>{l(Os),h(Os)},m=[{label:"Apply last used color",icon:t.jsx(ac,{color:d}),onClick:f,disabled:e.length===0},{label:"Set Stroke Color",icon:t.jsx(ac,{color:c}),onClick:()=>o(!0),disabled:e.length===0},{label:"Reset Color",icon:t.jsx(Un,{className:"h-2.5 w-2.5"}),onClick:w,disabled:e.length===0}],x={...m[0]};return t.jsxs(ct,{open:n,onOpenChange:o,children:[t.jsx(lt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-color-button",children:t.jsx(Ze,{mainAction:x,dropdownActions:m,variant:"outline",size:"compact",persistenceKey:"draw-stroke-color",className:s})})}),t.jsx(dt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:v=>v.preventDefault(),"data-test":"draw-stroke-color-popover",children:t.jsx(Ar,{label:"Stroke Color",currentColor:c,onColorSelect:g})})]})},ob=[1,2,3,4,5,6,8,10];let rc=Tt.strokeWidth;const ab=({width:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-width-icon",children:t.jsx("span",{style:{width:"12px",height:`${Math.min(e,6)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})}),rb=({drawings:e,className:s})=>{var x;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((x=i==null?void 0:i.style)==null?void 0:x.strokeWidth)??Tt.strokeWidth),[d,u]=p.useState(rc);p.useEffect(()=>{var y;l(i?((y=i.style)==null?void 0:y.strokeWidth)??Tt.strokeWidth:Tt.strokeWidth)},[i]);const h=y=>{e.forEach(v=>{const N=v.data;if(!N)return;if(N.elements&&N.elements.length>0){const S=N.elements.map(I=>({...I,style:{...I.style,strokeWidth:y}}));r(v.id,{data:{...N,elements:S}});return}const b={...N,drawType:(N==null?void 0:N.drawType)??"freehand",style:{...Tt,...N==null?void 0:N.style,strokeWidth:y}};r(v.id,{data:b})})},f=()=>{h(d)},g=y=>{h(y),l(y),u(y),rc=y,o(!1),E.getState().setSegmentedButtonAction("draw-stroke-width","Apply last used width")},w=[{label:"Apply last used width",icon:t.jsx(ab,{width:d}),onClick:f,disabled:e.length===0},{label:"Set Stroke Width",icon:t.jsx(Yo,{className:"h-2.5 w-2.5"}),onClick:()=>o(!0),disabled:e.length===0}],m={...w[0]};return t.jsxs(ct,{open:n,onOpenChange:o,children:[t.jsx(lt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-width-button",children:t.jsx(Ze,{mainAction:m,dropdownActions:w,variant:"outline",size:"compact",persistenceKey:"draw-stroke-width",className:s})})}),t.jsx(dt,{className:"w-auto p-3",sideOffset:5,onCloseAutoFocus:y=>y.preventDefault(),"data-test":"draw-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1",children:ob.map(y=>t.jsx("button",{type:"button",title:`${y}px`,onClick:()=>g(y),className:`w-8 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${c===y?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-stroke-width-option",children:t.jsx("span",{style:{width:"16px",height:`${Math.min(y,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})},y))}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Current: ",c,"px"]})]})})]})},ib=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}];let ic=Tt.strokeStyle;const cc=({style:e,className:s})=>{const n=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-style-icon",children:t.jsx("svg",{width:"14",height:"6",viewBox:"0 0 14 6",children:t.jsx("line",{x1:"0",y1:"3",x2:"14",y2:"3",stroke:"currentColor",strokeWidth:"2",strokeDasharray:n,strokeLinecap:"round"})})})},cb=({drawings:e,className:s})=>{var g;const n=E.getState().updateNode,o=e.length>0?e[0]:null,r=o==null?void 0:o.data,[a,i]=p.useState(((g=r==null?void 0:r.style)==null?void 0:g.strokeStyle)??Tt.strokeStyle),[c,l]=p.useState(ic);p.useEffect(()=>{var w;i(r?((w=r.style)==null?void 0:w.strokeStyle)??Tt.strokeStyle:Tt.strokeStyle)},[r]);const d=w=>{e.forEach(m=>{const x=m.data;if(!x)return;if(x.elements&&x.elements.length>0){const v=x.elements.map(N=>({...N,style:{...N.style,strokeStyle:w}}));n(m.id,{data:{...x,elements:v}});return}const y={...x,drawType:(x==null?void 0:x.drawType)??"freehand",style:{...Tt,...x==null?void 0:x.style,strokeStyle:w}};n(m.id,{data:y})}),i(w),l(w),ic=w},u=()=>{d(c)},h=[{label:"Apply last used style",icon:t.jsx(cc,{style:c}),onClick:u,disabled:e.length===0},...ib.map(w=>({label:w.label,icon:t.jsx(cc,{style:w.value}),onClick:()=>{d(w.value),E.getState().setSegmentedButtonAction("draw-stroke-style",w.label)},disabled:e.length===0,selected:a===w.value}))],f={...h[0]};return t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-style-button",children:t.jsx(Ze,{mainAction:f,dropdownActions:h,variant:"outline",size:"compact",persistenceKey:"draw-stroke-style",className:s})})},Ls="transparent";let lc=Ls;const dc=({color:e,className:s})=>{const n=e&&e!=="transparent"?e:void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"fill-color-swatch-icon",children:n?t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:n,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}}):t.jsx(Ko,{className:"h-2.5 w-2.5"})})},lb=({drawings:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.filter(N=>{const b=N.data;return b?b.elements&&b.elements.length>0?b.elements.some(S=>S.type==="shape"):b.drawType==="shape":!1}),i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.style)==null?void 0:v.fillColor)??Ls),[u,h]=p.useState(lc);p.useEffect(()=>{var N;d(c?((N=c.style)==null?void 0:N.fillColor)??Ls:Ls)},[c]);const f=N=>{const b=N===Ls?void 0:N;a.forEach(S=>{const I=S.data;if(!I)return;if(I.elements&&I.elements.length>0){const k=I.elements.map(R=>R.type==="shape"?{...R,style:{...R.style,fillColor:b}}:R);r(S.id,{data:{...I,elements:k}});return}const C={...I,drawType:(I==null?void 0:I.drawType)??"shape",style:{...Tt,...I==null?void 0:I.style,fillColor:b}};r(S.id,{data:C})})},g=()=>{f(u)},w=N=>{f(N),d(N),h(N),lc=N,E.getState().setSegmentedButtonAction("draw-fill-color","Apply last used fill")},m=()=>{d(Ls),f(void 0)},x=[{label:"Apply last used fill",icon:t.jsx(dc,{color:u}),onClick:g,disabled:a.length===0},{label:"Set Fill Color",icon:t.jsx(dc,{color:l}),onClick:()=>o(!0),disabled:a.length===0},{label:"Remove Fill",icon:t.jsx(Un,{className:"h-2.5 w-2.5"}),onClick:m,disabled:a.length===0}],y={...x[0]};return a.length===0?null:t.jsxs(ct,{open:n,onOpenChange:o,children:[t.jsx(lt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-fill-color-button",children:t.jsx(Ze,{mainAction:y,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"draw-fill-color",className:s})})}),t.jsx(dt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"draw-fill-color-popover",children:t.jsx(Ar,{label:"Fill Color",currentColor:l,onColorSelect:w})})]})},db=({drawings:e,className:s})=>{const n=()=>{const r=E.getState().setSelectedNodes,a=E.getState().duplicateNodes;r(e),a()},o=e.length===0;return t.jsx(Jt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-duplicate-tooltip-wrapper",children:t.jsx(ee,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-duplicate-button",children:t.jsx(Pt,{className:"h-3.5 w-3.5"})})})}),t.jsx(Bt,{children:t.jsxs("p",{children:["Duplicate ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},ub=({drawings:e,className:s})=>{const n=()=>{const r=E.getState().deleteNodeById;e.forEach(a=>{r(a.id)})},o=e.length===0;return t.jsx(Jt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-delete-tooltip-wrapper",children:t.jsx(ee,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-delete-button",children:t.jsx(vt,{className:"h-3.5 w-3.5"})})})}),t.jsx(Bt,{children:t.jsxs("p",{children:["Delete ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},Ft=[100,90,80,70,60,50,40,30,20,10],vd=e=>(e==null?void 0:e._compressionLevel)??100,hb=e=>{const s=Ft.indexOf(e);if(s===-1||s>=Ft.length-1){for(let n=0;n<Ft.length;n++)if(Ft[n]<e)return Ft[n];return Ft[Ft.length-1]}return Ft[s+1]},pb=({drawings:e})=>{var r;const s=vd((r=e[0])==null?void 0:r.data),n=s>Ft[Ft.length-1],o=()=>{for(const a of e){const i=a.data;if(!i)continue;const c=i._original??{...i,_original:void 0,_compressionLevel:void 0},l=hb(s),d=vl(c,l);E.getState().updateNode(a.id,{data:{...d,_original:c,_compressionLevel:l}})}};return t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-compress-button",children:t.jsx(Ao,{className:"h-4 w-4"})})}),t.jsx(Bt,{children:t.jsx("p",{children:"Compress drawing (reduce quality)"})})]})},gb=({drawings:e})=>{var r;const s=(r=e[0])==null?void 0:r.data,n=!!(s!=null&&s._original),o=()=>{for(const a of e){const i=a.data;if(!(i!=null&&i._original))continue;const{_original:c,_compressionLevel:l,...d}=i._original;E.getState().updateNode(a.id,{data:d})}};return t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-restore-button",children:t.jsx(Mn,{className:"h-4 w-4"})})}),t.jsx(Bt,{children:t.jsx("p",{children:"Restore original quality"})})]})},fb=({drawings:e})=>{var n;const s=vd((n=e[0])==null?void 0:n.data);return t.jsxs("span",{className:je("text-xs px-1 tabular-nums",s===100?"text-muted-foreground":"text-orange-500 font-medium"),"data-test":"draw-compression-level",title:"Current compression level (% of original quality)",children:[s,"%"]})},mb=e=>{if(!e)return 0;if(e._original)return JSON.stringify(e._original).length;const{_original:s,_compressionLevel:n,...o}=e;return JSON.stringify(o).length},xb=e=>{if(!e)return 0;const{_original:s,...n}=e;return JSON.stringify(n).length},uc=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`;let hc=[],mn=[];const wb=({drawings:e})=>{e.map(i=>i.id).join(",");const s=p.useSyncExternalStore(E.subscribe,()=>{var h;const i=(h=E.getState().projectCanvas.getActive())==null?void 0:h.coreState.nodes;if(!i)return mn;const c=e.map(f=>f.id),l=i.filter(f=>c.includes(f.id)),d=c.join(","),u=l.some((f,g)=>{const w=mn[g];return!w||w.id!==f.id||w.data!==f.data})||l.length!==mn.length;return(d!==hc.join(",")||u)&&(hc=c,mn=l),mn}),n=s.length>0?s:e,{currentSize:o,originalSize:r}=p.useMemo(()=>{let i=0,c=0;for(const l of n)l.data&&(i+=xb(l.data),c+=mb(l.data));return{currentSize:i,originalSize:c}},[n]),a=o<r;return t.jsxs(ad,{className:"gap-0.5 p-0.5",dataTest:"draw-quick-panel-container",dataAttributes:{"drawing-ids":e.map(i=>i.id).join(",")},children:[t.jsx(nb,{drawings:e}),t.jsx(rb,{drawings:e}),t.jsx(cb,{drawings:e}),t.jsx(lb,{drawings:e}),t.jsx(zr,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(db,{drawings:e}),t.jsx(ub,{drawings:e}),t.jsx(zr,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(pb,{drawings:n}),t.jsx(gb,{drawings:n}),t.jsx(fb,{drawings:n}),t.jsxs("span",{className:je("text-xs px-1.5 ml-1 tabular-nums",o>500*1024?"text-red-500 font-medium":"text-muted-foreground"),"data-test":"draw-size-indicator",title:`Current: ${o.toLocaleString()} bytes${a?` | Original: ${r.toLocaleString()} bytes`:""}`,children:[uc(o),a&&t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",uc(r),")"]})]})]})},yb=100,vb=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(Q.SELECT),l=p.useRef(null),d=p.useRef(""),u=p.useRef(!1),h=p.useRef(Q.SELECT);p.useEffect(()=>{const m=()=>{var C;const y=E.getState(),v=(C=y.projectCanvas.getActive())==null?void 0:C.coreState.selectedNodes,N=!!y.uiState.dragInfo,b=y.uiState.mode;if(N!==u.current&&(u.current=N,a(N)),b!==h.current&&(h.current=b??Q.SELECT,c(b??Q.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let S="";const I=[];for(const k of v)k.type===ce.DRAWING&&(S+=(S?",":"")+k.id,I.push(k));S!==d.current&&(d.current=S,o(I))};m();const x=setInterval(m,yb);return()=>clearInterval(x)},[]);const f=n.length>=1&&!r,g=i===Q.DRAW_ARROW,w=Ie.useMemo(()=>n.map(m=>m.id),[n]);return p.useEffect(()=>{if(!f||w.length===0)return;const m=()=>{var B,H;let y=0,v=0,N=0;if(w.forEach(M=>{const j=document.querySelector(`[data-node-id="${M}"]`);if(!j)return;const P=j.getBoundingClientRect(),W=P.left+P.width/2,L=P.top;y+=W,v+=L,N++}),N===0)return;const b=y/N,S=v/N,I=((B=l.current)==null?void 0:B.offsetHeight)||40,C=((H=l.current)==null?void 0:H.offsetWidth)||100,k=window.innerWidth,R=window.innerHeight,A=20,T=J.nodeUI.quickPanelGap;let O=S-I-T,$=b-C/2;if(O<A){let M=0;w.forEach(j=>{const P=document.querySelector(`[data-node-id="${j}"]`);if(P){const W=P.getBoundingClientRect();M=Math.max(M,W.bottom)}}),O=M+T}O=Math.max(A,Math.min(O,R-I-A)),$=Math.max(A,Math.min($,k-C-A)),s({top:O,left:$})};m();const x=setTimeout(m,100);return()=>{clearTimeout(x)}},[f,w]),!f||w.length===0||g?null:tn.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:Ee.popover},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),"data-test":"draw-quick-panel-portal",children:t.jsx(wb,{drawings:n})}),document.body)},bb=Ie.memo(vb),Nb=e=>{const s=t.jsx(Vt,{className:"h-3 w-3"}),n=e.startNodeId?`Node ${e.startNodeId.substring(0,4)}`:`(${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)})`,o=e.endNodeId?`Node ${e.endNodeId.substring(0,4)}`:`(${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)})`,r=`${n} -> ${o}`,a=e.id.substring(0,6),i=`S: [${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)}]`,c=`E: [${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"arrow-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"arrow-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"arrow-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"arrow-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"arrow-display-text",children:r})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"arrow-display-id",children:a})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full flex justify-between pr-1","data-test":"arrow-display-coords",children:[t.jsx("span",{"data-test":"arrow-display-start-coords",children:i}),t.jsx("span",{"data-test":"arrow-display-end-coords",children:c})]})]})},Sb=(e,s)=>s.length!==1?-1:e.findIndex(n=>n.id===s[0].id),Cb=e=>{const{className:s,style:n}=e,o=E.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.arrows)??[],i=(r==null?void 0:r.coreState.selectedArrows)??[],c=o.arrow.setSelected,l=o.scrollToArrow,d=p.useCallback((f,g)=>{const w=f.length>0?f[0]:-1;if(w>=0&&w<a.length){const m=a[w];c([m]),l(m),console.log("Selected arrow from list:",m.id)}else c([])},[a,c]),u=Sb(a,i),h=u!==-1?[u]:[];return t.jsx("div",{"data-test":"canvas-arrow-infos-container",className:je("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:f=>f.stopPropagation(),children:t.jsx(or,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-arrow-infos-header",children:"Arrows"}),itemList:a.map(Nb),onSelectionChange:d,selectedIndices:h,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0})})},jb=()=>{const e=F(i=>i.uiState.temporaryArrow),s=F(i=>{var c;return((c=i.uiState)==null?void 0:c.useCurvedArrows)??!1}),{startPoint:n,endPoint:o}=e??{};if(!n||!o)return null;const r=s?"auto-start-reverse":"auto",a="temporary-arrowhead";return t.jsxs("g",{children:[t.jsx("defs",{children:t.jsx("marker",{id:a,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:r,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"grey"})})}),t.jsx(Ja,{startPoint:n,endPoint:o,useCurvedArrows:s,stroke:"grey",strokeWidth:1,strokeDasharray:"4 2",markerEndId:a})]})},pc=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},kb=()=>{const e=F(i=>i.uiState.temporaryDrawing??null);if(!e)return null;const{subMode:s,points:n,startPoint:o,endPoint:r,style:a}=e;if(s===Se.FREEHAND&&n.length>0){const i=Ye.smoothToSVGPath(n),c=pc(a),l=a.opacity??1,d=l<1;return t.jsx("g",{"data-test":"temporary-drawing-freehand",children:t.jsx("path",{d:i,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:c,strokeOpacity:l,fill:"none",strokeLinecap:d?"butt":"round",strokeLinejoin:d?"bevel":"round"})})}if(o&&r){const c={[Se.RECTANGLE]:"rectangle",[Se.SQUARE]:"square",[Se.CIRCLE]:"circle",[Se.ELLIPSE]:"ellipse",[Se.LINE]:"line",[Se.ARROW]:"arrow",[Se.FREEHAND]:"line"}[s],l=Ye.generateShapeSVGPath({shapeType:c,startPoint:o,endPoint:r}),d=pc(a),u=a.opacity??1;return t.jsx("g",{"data-test":"temporary-drawing-shape",children:t.jsx("path",{d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:d,strokeOpacity:u,fill:a.fillColor?`${a.fillColor}40`:"none",strokeLinecap:"round",strokeLinejoin:"round"})})}return null},Ab=30,Ib=()=>{const[e,s]=p.useState(0),n=p.useRef(0),o=p.useRef(performance.now());return p.useEffect(()=>{let r=!0;function a(){n.current+=1;const i=performance.now();if(i-o.current>=1e3){const c=n.current;s(c),n.current=0,o.current=i}r&&requestAnimationFrame(a)}return requestAnimationFrame(a),()=>{r=!1}},[]),t.jsxs("div",{className:"text-xs pl-1",style:{color:e<Ab?"red":"inherit"},children:["FPS: ",e]})},xn=1e3,wn=500,Tb=({scale:e,offset:s})=>{const n=F(T=>T.uiState.mode),[o,r]=p.useState(null),[a,i]=p.useState(null),c=F(T=>{var O;return((O=T.projectCanvas.getActive())==null?void 0:O.coreState.nodes)??ks}),l=F(T=>T.setSelectedNodes),d=window.innerWidth,u=window.innerHeight,h=-s.x/e,f=-s.y/e,g=h+d/e,w=f+u/e,m=Math.floor(h/xn)*xn,x=Math.ceil(g/xn)*xn,y=Math.floor(f/wn)*wn,v=Math.ceil(w/wn)*wn,N=[];for(let T=m;T<=x;T+=xn)N.push(T);const b=[];for(let T=y;T<=v;T+=wn)b.push(T);const S=p.useCallback(T=>{const $=T.currentTarget.getBoundingClientRect(),B=T.clientX-$.left,H=T.clientY-$.top,M=(B-s.x)/e,j=(H-s.y)/e,P=B,W=$.width-B,L=H,z=$.height-H,_=50,G=P<_||W<_,V=L<_||z<_;r({canvasX:M,canvasY:j,showVertical:V,showHorizontal:G})},[e,s]),I=p.useCallback(()=>{r(null),i(null)},[]),C=p.useCallback(T=>{if(o&&(o.showVertical||o.showHorizontal)){T.stopPropagation(),T.preventDefault();const O=o.showVertical?"vertical":"horizontal";i({isDragging:!0,startX:o.canvasX,startY:o.canvasY,currentX:o.canvasX,currentY:o.canvasY,dragType:O})}},[o]),k=p.useCallback(T=>{if(!a||!a.isDragging)return;T.stopPropagation(),T.preventDefault();const O=Math.min(a.startX,a.currentX),$=Math.max(a.startX,a.currentX),B=Math.min(a.startY,a.currentY),H=Math.max(a.startY,a.currentY),M=c.filter(j=>{const P=j.width??200,W=j.height??100,L=j.x+P,z=j.y+W;return a.dragType==="vertical"?j.x<=$&&L>=O:j.y<=H&&z>=B});M.length>0&&l(M),i(null)},[a,c,l]),R=S,A=p.useCallback(T=>{if(R(T),a!=null&&a.isDragging){T.stopPropagation(),T.preventDefault();const $=T.currentTarget.getBoundingClientRect(),B=T.clientX-$.left,H=T.clientY-$.top,M=(B-s.x)/e,j=(H-s.y)/e;i({...a,currentX:M,currentY:j})}},[R,a,s,e]);return n!==Q.GRID?null:t.jsx("svg",{"data-grid-svg":"true","data-grid-active":o!=null&&o.showVertical||o!=null&&o.showHorizontal?"true":"false",className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{zIndex:o!=null&&o.showVertical||o!=null&&o.showHorizontal?999:0,pointerEvents:"auto",touchAction:"none",cursor:o?a!=null&&a.isDragging?"grabbing":"grab":"default"},onPointerMove:A,onPointerLeave:I,onPointerDown:C,onPointerUp:k,children:t.jsxs("g",{transform:`translate(${s.x}, ${s.y}) scale(${e})`,children:[N.map(T=>t.jsx("line",{x1:T,y1:f,x2:T,y2:w,stroke:T===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:T===0?2/e:1/e,style:{pointerEvents:"none"}},`v-${T}`)),b.map(T=>t.jsx("line",{x1:h,y1:T,x2:g,y2:T,stroke:T===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:T===0?2/e:1/e,style:{pointerEvents:"none"}},`h-${T}`)),o&&o.showVertical&&t.jsx("line",{x1:o.canvasX,y1:f,x2:o.canvasX,y2:w,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-vertical"),o&&o.showHorizontal&&t.jsx("line",{x1:h,y1:o.canvasY,x2:g,y2:o.canvasY,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-horizontal"),a&&a.isDragging&&(()=>{const T=Math.min(a.startX,a.currentX),O=Math.max(a.startX,a.currentX),$=Math.min(a.startY,a.currentY),B=Math.max(a.startY,a.currentY);return a.dragType==="vertical"?t.jsx("rect",{x:T,y:f,width:O-T,height:w-f,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range"):t.jsx("rect",{x:h,y:$,width:g-h,height:B-$,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range")})(),N.map(T=>t.jsx("text",{x:T,y:f+20/e,fill:"rgba(100, 116, 139, 0.6)",fontSize:Ne.FONT_SIZE_XXS/e,textAnchor:"middle",style:{pointerEvents:"none"},children:T},`label-v-${T}`)),b.map(T=>t.jsx("text",{x:h+20/e,y:T,fill:"rgba(100, 116, 139, 0.6)",fontSize:Ne.FONT_SIZE_XXS/e,textAnchor:"start",dominantBaseline:"middle",style:{pointerEvents:"none"},children:T},`label-h-${T}`)),o&&(o.showVertical||o.showHorizontal)&&(()=>{let T=c,O="",$=o.canvasX,B=o.canvasY-30/e;if(a!=null&&a.isDragging){const H=Math.min(a.startX,a.currentX),M=Math.max(a.startX,a.currentX),j=Math.min(a.startY,a.currentY),P=Math.max(a.startY,a.currentY);T=c.filter(W=>{const L=W.width??200,z=W.height??100,_=W.x+L,G=W.y+z;return a.dragType==="vertical"?W.x<=M&&_>=H:W.y<=P&&G>=j}),O=`Release to select ${T.length} node${T.length!==1?"s":""}`,$=(H+M)/2,B=a.dragType==="vertical"?f+30/e:(j+P)/2}else o.showVertical&&(T=T.filter(H=>{const M=H.width??200,j=H.x+M;return H.x<=o.canvasX&&j>=o.canvasX})),o.showHorizontal&&(T=T.filter(H=>{const M=H.height??100,j=H.y+M;return H.y<=o.canvasY&&j>=o.canvasY})),O=`Click/drag to select ${T.length} node${T.length!==1?"s":""}`;return t.jsxs("g",{children:[t.jsx("rect",{x:$-70/e,y:B-12/e,width:140/e,height:24/e,fill:"rgba(0, 0, 0, 0.9)",rx:4/e,style:{pointerEvents:"none"}}),t.jsx("text",{x:$,y:B,fill:"white",fontSize:Ne.FONT_SIZE_XXS/e,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:O})]},"tooltip")})()]})})},bd={projectScope:{projects:!0,workspaces:!0,canvases:!0},nodeFields:{content:!1,title:!1,id:!1,type:!1,tags:!1}},Nd=e=>Object.values(e.nodeFields).some(s=>s),Eb=e=>{const s=!e.projectScope.projects||!e.projectScope.workspaces||!e.projectScope.canvases,n=Nd(e);return s||n},Rb=({searchQuery:e,onSearchQueryChange:s,searchFilters:n,onSearchFiltersChange:o})=>{const[r,a]=p.useState(!1);return t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"projects-search-section",children:[t.jsx(Ss,{className:"search-icon absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"projects-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search...",value:e,onChange:i=>s(i.target.value),className:ve("search-input h-7 text-sm pl-8",e?"pr-14":"pr-8"),"data-test":"projects-search-input"}),e&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>s(""),className:"clear-button absolute right-8 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"projects-search-clear-button",children:t.jsx($e,{className:"h-3 w-3"})}),Eb(n)&&t.jsx("div",{className:ve("filter-indicator absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",e?"right-14":"right-9"),"data-test":"projects-search-filter-indicator"}),t.jsxs(ct,{open:r,onOpenChange:a,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0","aria-label":r?"Collapse advanced search":"Expand advanced search","data-test":"projects-search-expand-button",children:t.jsx(qo,{className:"h-3 w-3"})})}),t.jsxs(dt,{align:"start",side:"bottom",className:"advanced-search-panel w-72",style:{zIndex:Ee.draggablePopoverDropdown},"data-test":"projects-advanced-search-panel",children:[t.jsxs("div",{className:"panel-header flex items-center justify-between pb-2 border-b","data-test":"projects-panel-header",children:[t.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:()=>o(bd),className:"h-6 text-xs px-2","data-test":"projects-clear-filters-button",children:"Clear All"})]}),t.jsxs("div",{className:"project-scope-section space-y-2 mt-3","data-test":"projects-scope-section",children:[t.jsx(Te,{className:"text-sm font-medium",children:"Project"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in names of:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"scope-projects",checked:n.projectScope.projects,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,projects:!!i}}),"data-test":"projects-scope-projects-checkbox"}),t.jsx("label",{htmlFor:"scope-projects",className:"text-sm cursor-pointer",children:"Projects"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"scope-workspaces",checked:n.projectScope.workspaces,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,workspaces:!!i}}),"data-test":"projects-scope-workspaces-checkbox"}),t.jsx("label",{htmlFor:"scope-workspaces",className:"text-sm cursor-pointer",children:"Workspaces"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"scope-canvases",checked:n.projectScope.canvases,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,canvases:!!i}}),"data-test":"projects-scope-canvases-checkbox"}),t.jsx("label",{htmlFor:"scope-canvases",className:"text-sm cursor-pointer",children:"Canvases"})]})]})]}),t.jsxs("div",{className:"node-fields-section space-y-2 mt-4","data-test":"projects-node-fields-section",children:[t.jsx(Te,{className:"text-sm font-medium",children:"Node Content"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-content",checked:n.nodeFields.content,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,content:!!i}}),"data-test":"projects-node-content-checkbox"}),t.jsx("label",{htmlFor:"node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-title",checked:n.nodeFields.title,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,title:!!i}}),"data-test":"projects-node-title-checkbox"}),t.jsx("label",{htmlFor:"node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-id",checked:n.nodeFields.id,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,id:!!i}}),"data-test":"projects-node-id-checkbox"}),t.jsx("label",{htmlFor:"node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-type",checked:n.nodeFields.type,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,type:!!i}}),"data-test":"projects-node-type-checkbox"}),t.jsx("label",{htmlFor:"node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-tags",checked:n.nodeFields.tags,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,tags:!!i}}),"data-test":"projects-node-tags-checkbox"}),t.jsx("label",{htmlFor:"node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]}),t.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 mt-4 border-t","data-test":"projects-panel-footer",children:[t.jsx(ee,{onClick:()=>a(!1),className:"flex-1",size:"sm","data-test":"projects-apply-search-button",children:"Apply"}),t.jsx(ee,{onClick:()=>a(!1),variant:"outline",size:"sm","data-test":"projects-cancel-button",children:"Cancel"})]})]})]})]})},Mb=()=>{const e=F(a=>{var i,c;return(c=(i=a.preferences)==null?void 0:i.projectsManagerSearch)==null?void 0:c.filters}),[s,n]=p.useState(""),[o,r]=p.useState(e??bd);return p.useEffect(()=>{E.setState(a=>({...a,preferences:{...a.preferences,projectsManagerSearch:{filters:o}}}))},[o]),{searchQuery:s,setSearchQuery:n,searchFilters:o,setSearchFilters:r}},Pb=180,Db=[],Sd=e=>{const{onCanvasSelected:s,excludeCanvasId:n,selectionModeTitle:o,isOpen:r,onClose:a,popoverPosition:i}=e,c=!!s,l=F(U=>{var Y;return((Y=U.state)==null?void 0:Y.projects)??{}}),d=F(U=>{var Y;return((Y=U.state)==null?void 0:Y.activeProjectId)??""}),u=F(U=>U.project),h=F(U=>U.workspace),f=F(U=>U.projectCanvas),g=F(U=>U.exportSingleCanvas),w=F(U=>U.exportSingleWorkspace),m=F(U=>U.exportSingleProject),{searchQuery:x,setSearchQuery:y,searchFilters:v,setSearchFilters:N}=Mb(),b=F(U=>{var Y;return((Y=U.preferences)==null?void 0:Y.recentCanvases)??Db}),[S,I]=p.useState("projects"),C=p.useMemo(()=>d?l[d]??null:null,[l,d]),k=p.useMemo(()=>C!=null&&C.activeWorkspaceId?C.workspaces[C.activeWorkspaceId]??null:null,[C]),[R,A]=p.useState(""),[T,O]=p.useState(null),[$,B]=p.useState(null),H=p.useRef(null),M=kr("projects-manager"),j=r!==void 0,P=j?r:M.isOpen,W=j?U=>{!U&&a&&a()}:U=>{U?M.open():M.close()},L=j?i:$,z=p.useMemo(()=>{const U=x.toLowerCase().trim(),Y=U.length>0,X=Nd(v),Z=se=>se?se.toLowerCase().includes(U):!1,ne=se=>{if(!Y||!X)return!1;const{nodeFields:ae}=v,me=typeof se.content=="string"?se.content:"";return!!(ae.content&&Z(me)||ae.title&&Z(se.title)||ae.id&&Z(se.id)||ae.type&&Z(se.type)||ae.tags&&Array.isArray(se.tags)&&se.tags.some(pe=>{const ue=typeof pe=="string"?pe:(pe==null?void 0:pe.value)||(pe==null?void 0:pe.label)||"";return Z(ue)}))};return Object.values(l).sort((se,ae)=>(se.sortOrder??0)-(ae.sortOrder??0)).map(se=>{if(Y&&se.hideFromSearch)return null;const ae=Y&&v.projectScope.projects&&Z(se.name),me=Object.values(se.workspaces).sort((pe,ue)=>(pe.sortOrder??0)-(ue.sortOrder??0)).map(pe=>{if(Y&&pe.hideFromSearch)return null;const ue=Y&&v.projectScope.workspaces&&Z(pe.name),oe=Object.values(pe.canvases).sort((xe,we)=>(xe.sortOrder??0)-(we.sortOrder??0)).map(xe=>{var ke;if(n&&xe.id===n||Y&&xe.hideFromSearch)return null;const we=Y&&v.projectScope.canvases&&Z(xe.name);let fe=[];Y&&X&&((ke=xe.coreState)!=null&&ke.nodes)&&(fe=xe.coreState.nodes.filter(ne).map(Ae=>{const Me=typeof Ae.content=="string"?Ae.content:"",He=Ae.title||Me.substring(0,40)||Ae.id,Be=He.length>40?He.substring(0,40)+"...":He;return{id:`node-${Ae.id}`,label:Be,data:{type:"node",id:Ae.id,name:Be,isActive:!1,projectId:se.id,workspaceId:pe.id,canvasId:xe.id,nodeType:Ae.type}}}));const Ce=fe.length>0;return!Y||we||Ce?{id:xe.id,label:xe.name,data:{type:"canvas",id:xe.id,name:xe.name,isActive:xe.id===pe.activeCanvasId,projectId:se.id,workspaceId:pe.id},children:fe.length>0?fe:void 0}:null}).filter(Boolean),re=oe.length>0;return!Y||ue||re?{id:pe.id,label:pe.name,data:{type:"workspace",id:pe.id,name:pe.name,isActive:pe.id===se.activeWorkspaceId,projectId:se.id},children:oe}:null}).filter(Boolean),he=me.length>0;return!Y||ae||he?{id:se.id,label:se.name,data:{type:"project",id:se.id,name:se.name,isActive:se.id===d},children:me}:null}).filter(Boolean)},[l,d,x,v,n]),_=p.useMemo(()=>{const U=new Set;if(d&&U.add(d),C!=null&&C.activeWorkspaceId&&U.add(C.activeWorkspaceId),x.trim()){const Y=X=>{for(const Z of X)U.add(Z.id),Z.children&&Y(Z.children)};Y(z)}return U},[d,C,x,z]),G=U=>{const Y=R.trim()||`New ${U}`;U==="project"?u.create(Y):U==="workspace"?h.create(Y):U==="canvas"&&f.create(Y),A(""),O(null)},V=U=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5","data-test":"projects-add-input-container",children:[t.jsx(Re,{"data-test":"projects-new-input",type:"text",placeholder:`New ${U} name...`,value:R,onChange:Y=>A(Y.target.value),onKeyDown:Y=>Y.key==="Enter"&&G(U),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(ee,{"data-test":"projects-save-button",variant:"ghost",size:"sm",onClick:()=>G(U),children:t.jsx(Qt,{className:"h-3 w-3"})}),t.jsx(ee,{"data-test":"projects-cancel-button",variant:"ghost",size:"sm",onClick:()=>{O(null),A("")},children:t.jsx($e,{className:"h-3 w-3"})})]}),D=U=>{var X;const Y=(X=U.data)==null?void 0:X.type;if(Y==="canvas"){if(c&&s){const{id:Z,workspaceId:ne,projectId:se,name:ae}=U.data||{};Z&&ne&&se&&s({canvasId:Z,workspaceId:ne,projectId:se,canvasName:ae||""});return}f.switch(U.id)}else if(Y==="node"){const{canvasId:Z,id:ne}=U.data||{};Z&&ne&&(f.switch(Z),setTimeout(()=>{const se=E.getState().getNodeById(ne);se&&(E.getState().setSelectedNodes([se]),E.getState().scrollToNode(ne,300))},100))}},K=U=>{if(c&&s){if(n&&U.canvasId===n)return;s({canvasId:U.canvasId,workspaceId:U.workspaceId,projectId:U.projectId,canvasName:U.canvasName});return}f.switch(U.canvasId),I("projects")},te=(U,Y)=>{U.stopPropagation(),f.removeRecentCanvas(Y)},ie=(U,Y)=>{const X=ne=>{var se;for(const ae of ne){if(ae.id===U)return(se=ae.data)==null?void 0:se.type;if(ae.children){const me=X(ae.children);if(me)return me}}return null},Z=X(z);Z==="project"?u.updateMetadata(U,{name:Y}):Z==="workspace"?h.updateMetadata(U,{name:Y}):Z==="canvas"&&f.updateMetadata(U,{name:Y})},ye=U=>{const Y=Z=>{var ne;for(const se of Z){if(se.id===U)return(ne=se.data)==null?void 0:ne.type;if(se.children){const ae=Y(se.children);if(ae)return ae}}return null},X=Y(z);X==="project"?u.delete(U):X==="workspace"?h.delete(U):X==="canvas"&&f.delete(U)},ge=U=>{var X;return`Are you sure you want to delete this ${((X=U.data)==null?void 0:X.type)??"item"}: "${U.label}"?`},q=U=>{const Y=E.getState().setState;Y(nu(X=>{if(!X)return;const Z=Date.now();U.forEach((ne,se)=>{var pe;const ae=X.projects[ne.id];if(!ae)return;ae.sortOrder=se,ae.lastModified=Z;const me=new Set,he=new Map;(pe=ne.children)==null||pe.forEach((ue,oe)=>{var xe;let re=ae.workspaces[ue.id];if(re)re.sortOrder=oe,re.lastModified=Z,me.add(ue.id);else{let we=null,fe=null;for(const[Ce,ke]of Object.entries(X.projects))if(Ce!==ne.id&&ke.workspaces[ue.id]){we=ke.workspaces[ue.id],fe=Ce;break}if(we&&fe){if(delete X.projects[fe].workspaces[ue.id],X.projects[fe].lastModified=Z,X.projects[fe].activeWorkspaceId===ue.id){const Ce=Object.keys(X.projects[fe].workspaces);X.projects[fe].activeWorkspaceId=Ce[0]||""}ae.workspaces[ue.id]=we,we.sortOrder=oe,we.lastModified=Z,me.add(ue.id),re=we}}if(re){const we=new Set;he.set(ue.id,we),(xe=ue.children)==null||xe.forEach((fe,Ce)=>{const ke=re.canvases[fe.id];if(ke)ke.sortOrder=Ce,ke.lastModified=Z,we.add(fe.id);else{let Ae=null,Me=null;for(const[He,Be]of Object.entries(ae.workspaces))if(Be.canvases[fe.id]){Ae=Be.canvases[fe.id],Me=He;break}if(Ae)Me&&Me!==ue.id&&(delete ae.workspaces[Me].canvases[fe.id],ae.workspaces[Me].lastModified=Z);else for(const[He,Be]of Object.entries(X.projects))if(He!==ne.id){for(const[Ve,Oe]of Object.entries(Be.workspaces))if(Oe.canvases[fe.id]){Ae=Oe.canvases[fe.id],Me=Ve,delete Oe.canvases[fe.id],Oe.lastModified=Z,Be.lastModified=Z;break}if(Ae)break}Ae&&(re.canvases[fe.id]=Ae,Ae.sortOrder=Ce,Ae.lastModified=Z,we.add(fe.id))}})}})})}))},le=U=>{var X,Z,ne,se,ae,me,he;const Y=(X=U.data)==null?void 0:X.type;if(Y==="project"){const pe=(Z=U.data)==null?void 0:Z.id,ue=pe?l[pe]:null,oe=(ue==null?void 0:ue.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:oe?"Include in search":"Hide from search",icon:oe?t.jsx(Zt,{className:"h-4 w-4 mr-2"}):t.jsx(ws,{className:"h-4 w-4 mr-2"}),onClick:re=>{const{id:xe}=re.data||{};xe&&u.updateMetadata(xe,{hideFromSearch:!oe})}},{id:"export",label:"Export",icon:t.jsx(ho,{className:"h-4 w-4 mr-2"}),onClick:re=>{const{id:xe}=re.data||{};xe&&m({projectId:xe})}}]}if(Y==="workspace"){const pe=(ne=U.data)==null?void 0:ne.id,ue=(se=U.data)==null?void 0:se.projectId,oe=ue?l[ue]:null,re=oe&&pe?oe.workspaces[pe]:null,xe=(re==null?void 0:re.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:xe?"Include in search":"Hide from search",icon:xe?t.jsx(Zt,{className:"h-4 w-4 mr-2"}):t.jsx(ws,{className:"h-4 w-4 mr-2"}),onClick:we=>{const{id:fe}=we.data||{};fe&&h.updateMetadata(fe,{hideFromSearch:!xe})}},{id:"export",label:"Export",icon:t.jsx(ho,{className:"h-4 w-4 mr-2"}),onClick:we=>{const{projectId:fe,id:Ce}=we.data||{};fe&&Ce&&w({projectId:fe,workspaceId:Ce})}}]}if(Y==="canvas"){const pe=(ae=U.data)==null?void 0:ae.id,ue=(me=U.data)==null?void 0:me.projectId,oe=(he=U.data)==null?void 0:he.workspaceId,re=ue?l[ue]:null,xe=re&&oe?re.workspaces[oe]:null,we=xe&&pe?xe.canvases[pe]:null,fe=(we==null?void 0:we.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:fe?"Include in search":"Hide from search",icon:fe?t.jsx(Zt,{className:"h-4 w-4 mr-2"}):t.jsx(ws,{className:"h-4 w-4 mr-2"}),onClick:Ce=>{const{id:ke}=Ce.data||{};ke&&f.updateMetadata(ke,{hideFromSearch:!fe})}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:Ce=>{const{projectId:ke,workspaceId:Ae,id:Me}=Ce.data||{};ke&&Ae&&Me&&f.duplicate(Me,ke,Ae)}},{id:"export",label:"Export",icon:t.jsx(ho,{className:"h-4 w-4 mr-2"}),onClick:Ce=>{const{projectId:ke,workspaceId:Ae,id:Me}=Ce.data||{};ke&&Ae&&Me&&g({projectId:ke,workspaceId:Ae,canvasId:Me})}}]}return null},de=()=>{if(P){W(!1),O(null),A("");return}if(H.current){const U=H.current.getBoundingClientRect(),Y=320,X=400,Z=U.left+U.width/2,ne=U.top+U.height/2;B({x:Z-Y/2+Pb,y:ne-X/2})}W(!0)};return t.jsxs(t.Fragment,{children:[!j&&t.jsx(is,{ref:H,variant:"secondary",size:"sm",tooltip:"Manage projects",onClick:de,className:"canvas-projects-manager-button","data-test":"canvas-projects-manager-button",children:t.jsx(Ph,{className:"h-4 w-4"})}),t.jsx(_e,{isVisible:P,onClose:()=>{W(!1),O(null),A(""),I("projects")},title:c?o??"Select Canvas":S==="recent"?"Recent Canvases":"Projects",resizable:!0,initialSize:{width:320,height:400},triggerPosition:L??void 0,shouldCloseManually:!0,headerActions:S==="recent"?t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>I("projects"),title:"Back to Projects","data-test":"projects-back-button",children:t.jsx(Xs,{className:"h-3.5 w-3.5"})}):t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>I("recent"),title:"Recent Canvases","data-test":"projects-recent-button",children:t.jsx(rs,{className:"h-3.5 w-3.5"})}),children:t.jsx("div",{className:"manager-content flex flex-col space-y-2 p-2 h-full overflow-hidden","data-test":"projects-manager-content",children:S==="projects"?t.jsxs(t.Fragment,{children:[t.jsx(Rb,{searchQuery:x,onSearchQueryChange:y,searchFilters:v,onSearchFiltersChange:N}),t.jsx(Gs,{className:"tree-scroll-area flex-1 min-h-0","data-test":"projects-tree-scroll-area",children:t.jsx("div",{className:"tree-container space-y-1 pr-2","data-test":"projects-tree-container",children:t.jsx(qs,{data:z,onItemClick:D,onUpdate:c?void 0:ie,onDelete:c?void 0:ye,onReorder:c?void 0:q,defaultExpandedIds:_,selectedId:(k==null?void 0:k.activeCanvasId)??null,deleteConfirmMessage:c?void 0:ge,enableEdit:!c,enableDelete:!c,enableDrag:!c,moreOptionsItems:c?void 0:le,dropdownZIndex:Ee.draggablePopoverDropdown})})}),!c&&(T?V(T):t.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t","data-test":"projects-add-buttons-row",children:[t.jsxs(ee,{"data-test":"projects-add-project-button",variant:"outline",size:"sm",className:"add-project-button flex-1",onClick:()=>O("project"),title:"Add Project",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"})," Pr"]}),C&&t.jsxs(ee,{"data-test":"projects-add-workspace-button",variant:"outline",size:"sm",className:"add-workspace-button flex-1",onClick:()=>O("workspace"),title:"Add Workspace",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"})," Wo"]}),k&&t.jsxs(ee,{"data-test":"projects-add-canvas-button",variant:"outline",size:"sm",className:"add-canvas-button flex-1",onClick:()=>O("canvas"),title:"Add Canvas",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"})," Ca"]})]}))]}):t.jsx(Gs,{className:"recent-canvases-scroll flex-1 min-h-0","data-test":"projects-recent-scroll-area",children:t.jsx("div",{className:"recent-canvases-list space-y-1 pr-2","data-test":"recent-canvases-list",children:(()=>{const U=n?b.filter(Y=>Y.canvasId!==n):b;return U.length===0?t.jsx("div",{className:"empty-state text-center text-muted-foreground text-sm py-8","data-test":"recent-canvases-empty",children:"No recently visited canvases"}):U.map(Y=>t.jsxs("div",{className:"recent-canvas-item group flex items-center w-full text-left px-2 py-1.5 rounded hover:bg-accent transition-colors cursor-pointer",onClick:()=>K(Y),"data-test":"recent-canvas-item",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"canvas-name text-sm font-medium truncate","data-test":"recent-canvas-name",children:Y.canvasName}),t.jsxs("div",{className:"canvas-path text-xs text-muted-foreground truncate","data-test":"recent-canvas-path",children:[Y.projectName," / ",Y.workspaceName]})]}),!c&&t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",onClick:X=>te(X,Y.canvasId),title:"Remove from recent","data-test":"recent-canvas-delete",children:t.jsx($e,{className:"h-3.5 w-3.5"})})]},`${Y.projectId}-${Y.workspaceId}-${Y.canvasId}`))})()})})})})]})};function Cd({node:e,onItemClick:s,onUpdate:n,onDelete:o,level:r=0,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f}){var H;const[g,w]=p.useState((a==null?void 0:a.has(e.id))??!1),[m,x]=p.useState(!1),[y,v]=p.useState(e.label),N=e.children&&e.children.length>0,b=i===e.id,S=p.useRef(null),I=p.useRef(e.label);p.useEffect(()=>{e.label!==I.current&&(I.current=e.label,m||v(e.label))},[e.label,m]),p.useEffect(()=>{b&&S.current&&S.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[b]);const C=M=>{M.stopPropagation(),m||(N&&w(!g),s==null||s(e))},k=()=>{y.trim()&&y!==e.label&&(n==null||n(e.id,y.trim())),x(!1)},R=()=>{v(e.label),x(!1)},A=M=>{M.stopPropagation();const j=(d==null?void 0:d(e))??`Are you sure you want to delete "${e.label}"?`;window.confirm(j)&&(o==null||o(e.id))},T={paddingLeft:`${r*1.5}rem`},O=N?t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:g?t.jsx(jt,{className:"h-4 w-4"}):t.jsx(nn,{className:"h-4 w-4"})}):t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),$=t.jsxs("div",{ref:S,className:ve("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",b&&"bg-primary/10 border border-primary"),style:T,onClick:C,children:[O,e.icon&&t.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:e.icon}),m?t.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[t.jsx(Re,{type:"text",value:y,onChange:M=>v(M.target.value),onKeyDown:M=>{M.key==="Enter"&&k(),M.key==="Escape"&&R()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:M=>M.stopPropagation()}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),k()},className:"h-6 w-6 p-0",children:t.jsx(Qt,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),R()},className:"h-6 w-6 p-0",children:t.jsx($e,{className:"h-3 w-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"tree-item-label flex-grow truncate",title:e.label,children:e.label}),t.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[c&&n&&t.jsx(ee,{variant:"ghost",size:"sm",onClick:M=>{M.stopPropagation(),x(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:t.jsx(fl,{className:"h-3 w-3"})}),(()=>{const M=h==null?void 0:h(e);return M&&M.length>0?t.jsxs(vo,{children:[t.jsx(bo,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"sm",onClick:j=>j.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:t.jsx(pl,{className:"h-3 w-3"})})}),t.jsxs(No,{align:"end",style:f?{zIndex:f}:void 0,"data-test":"tree-item-more-options-content",children:[M.map(j=>j.subItems?t.jsxs(ou,{children:[t.jsxs(au,{className:j.className,"data-test":"tree-item-menu-trigger",children:[j.icon,j.label]}),t.jsx(ru,{children:j.subItems.map(P=>t.jsxs(Rt,{onClick:W=>{W.stopPropagation(),P.onClick(e)},className:P.className,"data-test":"tree-item-menu-subitem",children:[P.icon,P.label]},P.id))})]},j.id):t.jsxs(Rt,{onClick:P=>{var W;P.stopPropagation(),(W=j.onClick)==null||W.call(j,e)},className:j.className,"data-test":"tree-item-menu-item",children:[j.icon,j.label]},j.id)),l&&o&&t.jsxs(Rt,{onClick:j=>{j.stopPropagation(),A(j)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[t.jsx(vt,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):l&&o?t.jsx(ee,{variant:"ghost",size:"sm",onClick:A,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:t.jsx(vt,{className:"h-3 w-3"})}):null})()]})]})]}),B=u?u(e,b,!!N,$):$;return N?t.jsxs(ps,{open:g,onOpenChange:w,children:[t.jsx(gs,{asChild:!0,children:t.jsx("div",{children:B})}),t.jsx(fs,{children:t.jsx("div",{className:"tree-item-children",children:(H=e.children)==null?void 0:H.map(M=>t.jsx(Cd,{node:M,onItemClick:s,onUpdate:n,onDelete:o,level:r+1,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f},M.id))})})]}):t.jsx(t.Fragment,{children:B})}function Ob({data:e,onItemClick:s,onUpdate:n,onDelete:o,className:r,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f}){return t.jsx("div",{className:ve("crud-tree-root",r),children:e.map(g=>t.jsx(Cd,{node:g,onItemClick:s,onUpdate:n,onDelete:o,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f},g.id))})}const Lb=180,Wb=()=>{const e=ut(q=>q.definitions),s=ut(q=>q.instances),n=ut(q=>q.selectedDefinitionId),o=ut(q=>q.createDefinition),r=ut(q=>q.updateDefinition),a=ut(q=>q.deleteDefinition);ut(q=>q.duplicateDefinition);const i=ut(q=>q.createInstance),c=ut(q=>q.deleteInstance),l=ut(q=>q.selectDefinition),d=F(q=>{var le;return((le=q.projectCanvas.getActive())==null?void 0:le.coreState.nodes)??ks}),u=F(q=>{var le;return((le=q.state)==null?void 0:le.projects)??{}}),[h,f]=p.useState(""),[g,w]=p.useState(null),[m,x]=p.useState(null),[y,v]=p.useState(new Set),N=p.useRef(null),b=p.useRef(null),{isOpen:S,open:I,close:C}=kr("workflow-manager"),k=ut(q=>q.facade),R=p.useMemo(()=>new qa(k),[k]),A=p.useMemo(()=>{const q=u["workflow-templates-project"],le=[];q&&Object.values(q.workspaces).forEach(ne=>{Object.values(ne.canvases).forEach(se=>{se.coreState.nodes.filter(me=>{var he;return((he=me.data)==null?void 0:he.nodeType)==="workflowOrchestration"}).forEach(me=>{var re,xe;const he=me.data,pe=((xe=(re=he==null?void 0:he.parameters)==null?void 0:re.rows)==null?void 0:xe.length)||0,ue=typeof me.title=="string"?me.title:"",oe=typeof me.content=="string"?me.content:"";le.push({id:`preset-${me.id}`,label:ue||oe||`Preset (${pe} steps)`,data:{type:"preset-workflow",id:me.id,nodeId:me.id,rowCount:pe,canvasId:se.id,canvasName:se.name}})})})});const de=new Set(le.map(ne=>{var se;return(se=ne.data)==null?void 0:se.nodeId})),Y=d.filter(ne=>{var se;return((se=ne.data)==null?void 0:se.nodeType)==="workflowOrchestration"&&!de.has(ne.id)}).map(ne=>{var pe,ue;const se=ne.data,ae=((ue=(pe=se==null?void 0:se.parameters)==null?void 0:pe.rows)==null?void 0:ue.length)||0,me=typeof ne.title=="string"?ne.title:"",he=typeof ne.content=="string"?ne.content:"";return{id:ne.id,label:me||he||`Workflow (${ae} steps)`,data:{type:"canvas-workflow",id:ne.id,nodeId:ne.id,rowCount:ae}}}),X=e.map(ne=>{const se=s.filter(ae=>ae.definitionId===ne.id);return{id:ne.id,label:ne.name,data:{type:"definition",id:ne.id,name:ne.name,isActive:ne.id===n,description:ne.description,tags:ne.tags},children:se.map(ae=>({id:ae.id,label:ae.name,data:{type:"instance",id:ae.id,name:ae.name,status:ae.status,definitionId:ae.definitionId}}))}}),Z=[];return le.length>0&&Z.push({id:"section-presets",label:`📚 Workflow Presets (${le.length})`,data:{type:"section",section:"presets"},children:le}),Y.length>0&&Z.push({id:"section-canvas",label:`🎨 Current Canvas (${Y.length})`,data:{type:"section",section:"canvas"},children:Y}),X.length>0&&Z.push({id:"section-saved",label:`💾 Saved Workflows (${X.length})`,data:{type:"section",section:"saved"},children:X}),Z},[d,e,s,n,u]),T=p.useMemo(()=>{const q=new Set;return q.add("section-presets"),q.add("section-canvas"),q.add("section-saved"),n&&q.add(n),q},[n]),O=q=>{const le=h.trim()||`New ${q}`;q==="definition"?o({name:le}):q==="instance"&&n&&i(n,le),f(""),w(null)},$=q=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[t.jsx(Re,{"data-test":"workflow-new-input",type:"text",placeholder:`New ${q} name...`,value:h,onChange:le=>f(le.target.value),onKeyDown:le=>le.key==="Enter"&&O(q),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(ee,{"data-test":"workflow-save-button",variant:"ghost",size:"sm",onClick:()=>O(q),children:t.jsx(Qt,{className:"h-3 w-3"})}),t.jsx(ee,{"data-test":"workflow-cancel-button",variant:"ghost",size:"sm",onClick:()=>{w(null),f("")},children:t.jsx($e,{className:"h-3 w-3"})})]}),B=q=>{var de;((de=q.data)==null?void 0:de.type)==="definition"&&l(q.id)},H=(q,le)=>{const de=Y=>{var X;for(const Z of Y){if(Z.id===q)return(X=Z.data)==null?void 0:X.type;if(Z.children){const ne=de(Z.children);if(ne)return ne}}return null},U=de(A);U==="section"||U==="preset-workflow"||(U==="canvas-workflow"?E.getState().updateNode(q,{title:le}):U==="definition"?r(q,{name:le}):U==="instance"&&console.warn("Instance rename not yet implemented"))},M=q=>{const le=U=>{var Y;for(const X of U){if(X.id===q)return(Y=X.data)==null?void 0:Y.type;if(X.children){const Z=le(X.children);if(Z)return Z}}return null},de=le(A);de==="section"||de==="preset-workflow"||de==="canvas-workflow"||(de==="definition"?a(q):de==="instance"&&c(q))},j=q=>{var de;return`Are you sure you want to delete this ${((de=q.data)==null?void 0:de.type)??"item"}: "${q.label}"?`},P=()=>{if(S){C(),w(null),f("");return}if(N.current){const q=N.current.getBoundingClientRect(),le=320,de=400,U=q.left+q.width/2,Y=q.top+q.height/2;x({x:U-le/2+Lb,y:Y-de/2})}I()},W=()=>{if(y.size===0){be.error("No workflows selected");return}try{const q=Array.from(y);R.downloadWorkflows(q),be.success(`Exported ${y.size} workflow(s)`,{description:"Workflows downloaded as JSON file"})}catch(q){be.error("Export failed",{description:q instanceof Error?q.message:"Unknown error"})}},L=()=>{try{const q=R.exportAllWorkflows(),le=new Blob([q],{type:"application/json"}),de=URL.createObjectURL(le),U=document.createElement("a");U.href=de,U.download=`all-workflows-${Date.now()}.json`,U.click(),URL.revokeObjectURL(de),be.success("Exported all workflows",{description:`${e.length} workflow(s) downloaded`})}catch(q){be.error("Export failed",{description:q instanceof Error?q.message:"Unknown error"})}},z=()=>{var q;(q=b.current)==null||q.click()},_=q=>{var U;const le=(U=q.target.files)==null?void 0:U[0];if(!le)return;const de=new FileReader;de.onload=Y=>{var X;try{const Z=(X=Y.target)==null?void 0:X.result,ne=R.importWorkflows(Z);be.success(`Imported ${ne.length} workflow(s)`,{description:"Workflows added to manager"})}catch(Z){be.error("Import failed",{description:Z instanceof Error?Z.message:"Invalid JSON"})}},de.readAsText(le),q.target.value=""},G=q=>{const le=new Set(y);le.has(q)?le.delete(q):le.add(q),v(le)},V=()=>{y.size===e.length?v(new Set):v(new Set(e.map(q=>q.id)))},D=()=>{if(y.size!==0&&window.confirm(`Are you sure you want to delete ${y.size} workflow(s)?`))try{R.bulkDeleteDefinitions(Array.from(y)),v(new Set),be.success(`Deleted ${y.size} workflow(s)`)}catch(q){be.error("Bulk delete failed",{description:q instanceof Error?q.message:"Unknown error"})}},K=()=>{if(y.size!==0)try{const q=R.bulkDuplicateDefinitions(Array.from(y));v(new Set),be.success(`Duplicated ${q.length} workflow(s)`,{description:'New workflows created with " (copy)" suffix'})}catch(q){be.error("Bulk duplicate failed",{description:q instanceof Error?q.message:"Unknown error"})}},te=()=>{if(y.size===0)return;const q=window.prompt("Enter tags (comma-separated):");if(!q)return;const le=q.split(",").map(de=>de.trim()).filter(Boolean);if(le.length===0){be.error("No valid tags provided");return}try{R.bulkAddTags(Array.from(y),le),be.success(`Added tags to ${y.size} workflow(s)`,{description:`Tags: ${le.join(", ")}`})}catch(de){be.error("Bulk add tags failed",{description:de instanceof Error?de.message:"Unknown error"})}},ie=()=>{if(y.size===0)return;const q=window.prompt("Enter tags to remove (comma-separated):");if(!q)return;const le=q.split(",").map(de=>de.trim()).filter(Boolean);if(le.length===0){be.error("No valid tags provided");return}try{R.bulkRemoveTags(Array.from(y),le),be.success(`Removed tags from ${y.size} workflow(s)`,{description:`Tags: ${le.join(", ")}`})}catch(de){be.error("Bulk remove tags failed",{description:de instanceof Error?de.message:"Unknown error"})}},ye=()=>{if(y.size!==0)try{const q=R.getBulkStats(Array.from(y));be.info("Bulk Statistics",{description:`Workflows: ${q.count} | Nodes: ${q.totalNodes} | Connections: ${q.totalConnections} | Tags: ${q.tags.length}`})}catch(q){be.error("Failed to get statistics",{description:q instanceof Error?q.message:"Unknown error"})}},ge=y.size===e.length&&e.length>0;return y.size>0&&y.size<e.length,t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:N,variant:"secondary",size:"sm",tooltip:"Manage workflows",onClick:P,className:"workflow-manager-button","data-test":"workflow-manager-button",children:t.jsx(Ns,{className:"h-4 w-4"})}),t.jsx(_e,{isVisible:S,onClose:()=>{C(),w(null),f("")},title:"Workflow Manager",resizable:!0,initialSize:{width:420,height:450},triggerPosition:m??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col space-y-2 p-2 flex-1 h-full overflow-scroll","data-test":"manager-content ",children:[t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b","data-test":"toolbar-row",children:[t.jsxs(vo,{children:[t.jsx(bo,{asChild:!0,children:t.jsxs(ee,{"data-test":"workflow-export-dropdown",variant:"outline",size:"sm",className:"flex-1",children:[t.jsx(ho,{className:"h-3 w-3 mr-1"}),"Export",t.jsx(jt,{className:"h-3 w-3 ml-1"})]})}),t.jsxs(No,{style:{zIndex:Ee.skipLink},children:[t.jsxs(Rt,{"data-test":"workflow-export-selected",onClick:W,children:["Export Selected (",y.size,")"]}),t.jsxs(Rt,{"data-test":"workflow-export-all",onClick:L,children:["Export All (",e.length,")"]})]})]}),t.jsxs(ee,{"data-test":"workflow-import-button",variant:"outline",size:"sm",className:"flex-1",onClick:z,title:"Import workflows from JSON",children:[t.jsx($n,{className:"h-3 w-3 mr-1"}),"Import"]}),t.jsx("input",{"data-test":"workflow-import-file-input",ref:b,type:"file",accept:".json",onChange:_,className:"hidden"})]}),y.size>0&&t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b bg-primary/5 p-1.5 rounded","data-test":"bulk-toolbar",children:[t.jsxs("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:[y.size," selected"]}),t.jsxs(vo,{children:[t.jsx(bo,{asChild:!0,children:t.jsxs(ee,{"data-test":"workflow-bulk-actions-dropdown",variant:"ghost",size:"sm",className:"flex-1",children:[t.jsx(jt,{className:"h-3 w-3 mr-1"}),"Bulk Actions"]})}),t.jsxs(No,{style:{zIndex:Ee.skipLink},children:[t.jsx(iu,{children:"Bulk Operations"}),t.jsx(ra,{}),t.jsxs(Rt,{"data-test":"workflow-bulk-duplicate",onClick:K,children:[t.jsx(Pt,{className:"h-3 w-3 mr-2"}),"Duplicate"]}),t.jsxs(Rt,{"data-test":"workflow-bulk-delete",onClick:D,children:[t.jsx(vt,{className:"h-3 w-3 mr-2"}),"Delete"]}),t.jsx(ra,{}),t.jsxs(Rt,{"data-test":"workflow-bulk-add-tags",onClick:te,children:[t.jsx(Fn,{className:"h-3 w-3 mr-2"}),"Add Tags"]}),t.jsxs(Rt,{"data-test":"workflow-bulk-remove-tags",onClick:ie,children:[t.jsx(Fn,{className:"h-3 w-3 mr-2"}),"Remove Tags"]}),t.jsx(ra,{}),t.jsxs(Rt,{"data-test":"workflow-bulk-stats",onClick:ye,children:[t.jsx(Dh,{className:"h-3 w-3 mr-2"}),"Show Statistics"]})]})]})]}),e.length>0&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1","data-test":"select-all-row",children:[t.jsx(We,{"data-test":"workflow-select-all-checkbox",checked:ge,onCheckedChange:V,className:"h-4 w-4","aria-label":"Select all workflows"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:ge?"Deselect All":"Select All"})]}),t.jsx(Gs,{className:"tree-scroll-area flex-1",children:t.jsx("div",{className:"space-y-1 pr-2","data-test":"tree-container",children:t.jsx(Ob,{data:A,onItemClick:B,onUpdate:H,onDelete:M,defaultExpandedIds:T,selectedId:n,deleteConfirmMessage:j,dropdownZIndex:Ee.skipLink,moreOptionsItems:q=>{var le,de,U;if(((le=q.data)==null?void 0:le.type)==="canvas-workflow")return[{id:"save",label:"Save Workflow",icon:t.jsx(Qt,{className:"h-4 w-4 mr-2"}),onClick:Y=>{try{const X=R.saveWorkflow({nodeId:Y.data.nodeId});be.success("Workflow saved",{description:`"${X.name}" saved as version ${X.version}`})}catch(X){be.error("Failed to save workflow",{description:X instanceof Error?X.message:"Unknown error"})}}}];if(((de=q.data)==null?void 0:de.type)==="preset-workflow"){const Y=async(X,Z)=>{var ne,se,ae,me,he,pe;try{const ue=u["workflow-templates-project"];if(!ue)throw new Error("Workflow Templates project not found");let oe=null,re=[];if(Object.values(ue.workspaces).forEach(Ve=>{Object.values(Ve.canvases).forEach(Oe=>{const nt=Oe.coreState.nodes.find(ot=>ot.id===X.data.nodeId);nt&&(oe=JSON.parse(JSON.stringify(nt)),re=Oe.coreState.arrows||[])})}),!oe)throw new Error("Preset workflow not found");(se=(ne=oe.data)==null?void 0:ne.parameters)!=null&&se.rows&&oe.data.parameters.rows.forEach(Ve=>{Ve.children&&Ve.children.forEach(Oe=>{var nt;Oe.stepType==="nodeUpdate"&&((nt=Oe.config)!=null&&nt.simpleFieldUpdates)&&Oe.config.simpleFieldUpdates.forEach(ot=>{const bt=ot.field;ot.field=Z,ot.template&&(ot.template=ot.template.replace(new RegExp(`loop\\.current\\.${bt}`,"g"),`loop.current.${Z}`))})})});const xe=E.getState(),we=((ae=xe.projectCanvas.getActive())==null?void 0:ae.coreState.nodes)||[],fe=((me=xe.projectCanvas.getActive())==null?void 0:me.coreState.selectedNodes)||[],Ce=((he=xe.projectCanvas.getActive())==null?void 0:he.coreState.arrows)||[],ke=fe.length>0?fe:we,Ae=new Zs,Me=[...ke,oe],He=[...Ce,...re];Ae.loadWorkflow(Me,He);const Be=await Ae.executeWorkflow(oe.id);if(Be.success){if(Be.nodeUpdates&&Be.nodeUpdates.length>0){const Oe=Be.nodeUpdates.map(({nodeId:nt,updates:ot})=>({id:nt,...ot}));xe.updateNodes(Oe)}const Ve=fe.length>0?"selected":"all";be.success("Workflow applied",{description:`Applied "${oe.title||"workflow"}" to ${Z} of ${((pe=Be.nodeUpdates)==null?void 0:pe.length)||0} ${Ve} nodes`})}else be.error("Workflow execution failed",{description:Be.errors.map(Ve=>Ve.message).join(", ")||"Unknown error"})}catch(ue){be.error("Failed to apply workflow",{description:ue instanceof Error?ue.message:"Unknown error"})}};return[{id:"apply",label:"Apply Workflow",icon:t.jsx(st,{className:"h-4 w-4 mr-2"}),subItems:cu.map(X=>({id:X,label:lu[X],onClick:async Z=>Y(Z,X)}))},{id:"copy",label:"Copy to Canvas",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:X=>{try{const Z=u["workflow-templates-project"];if(!Z)throw new Error("Workflow Templates project not found");let ne=null;if(Object.values(Z.workspaces).forEach(me=>{Object.values(me.canvases).forEach(he=>{const pe=he.coreState.nodes.find(ue=>ue.id===X.data.nodeId);pe&&(ne=pe)})}),!ne)throw new Error("Preset workflow not found");const se=E.getState(),ae={...ne,id:`copied-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,x:150,y:150};se.addNode(ae),be.success("Preset copied",{description:"Workflow preset copied to current canvas"})}catch(Z){be.error("Failed to copy preset",{description:Z instanceof Error?Z.message:"Unknown error"})}}}]}return((U=q.data)==null?void 0:U.type)==="definition"?[{id:"apply",label:"Apply Workflow",icon:t.jsx(st,{className:"h-4 w-4 mr-2"}),onClick:async Y=>{var X,Z,ne,se,ae;try{const me=e.find(Ce=>Ce.id===Y.id);if(!me)throw new Error("Workflow definition not found");const he=E.getState(),pe=((X=he.projectCanvas.getActive())==null?void 0:X.coreState.nodes)||[],ue=((Z=he.projectCanvas.getActive())==null?void 0:Z.coreState.selectedNodes)||[],oe=ue.length>0?ue:pe;if(oe.length===0){be.error("No nodes to apply workflow to");return}const re=new Zs,xe=((ne=me.nodes)==null?void 0:ne.map((Ce,ke)=>{var Ae,Me;return{id:Ce.id,label:((Ae=Ce.parameters)==null?void 0:Ae.label)||`Step ${ke+1}`,order:((Me=Ce.parameters)==null?void 0:Me.order)||ke+1,stepType:Ce.type,config:Ce.parameters||{}}}))||[],we={id:`temp-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:me.name,content:"",x:0,y:0,width:400,height:300,data:{nodeType:"workflowOrchestration",parameters:{rows:xe}}};re.loadWorkflow([...oe,we],[]);const fe=await re.executeWorkflow(we.id);if(fe.success){if(fe.nodeUpdates&&fe.nodeUpdates.length>0)for(const{nodeId:Ce,updates:ke}of fe.nodeUpdates)he.updateNode(Ce,ke);be.success("Workflow applied",{description:`Applied "${me.name}" to ${((se=fe.nodeUpdates)==null?void 0:se.length)||0} nodes`})}else be.error("Workflow execution failed",{description:((ae=fe.errors)==null?void 0:ae.map(Ce=>Ce.message).join(", "))||"Unknown error"})}catch(me){be.error("Failed to apply workflow",{description:me instanceof Error?me.message:"Unknown error"})}}},{id:"load",label:"Load to Canvas",icon:t.jsx(Oh,{className:"h-4 w-4 mr-2"}),onClick:Y=>{try{R.loadWorkflow({definitionId:Y.id,position:{x:100,y:100}}),be.success("Workflow loaded",{description:"Loaded workflow to canvas at position (100, 100)"})}catch(X){be.error("Failed to load workflow",{description:X instanceof Error?X.message:"Unknown error"})}}}]:null},renderNode:(q,le,de,U)=>{var Y,X;return((Y=q.data)==null?void 0:Y.type)==="section"?t.jsx("div",{className:"flex items-center gap-2 w-full",children:t.jsx("div",{className:"flex-1 font-semibold",children:U})}):((X=q.data)==null?void 0:X.type)==="definition"?t.jsxs("div",{className:"flex items-center gap-2 w-full",children:[t.jsx(We,{"data-test":"workflow-definition-checkbox",checked:y.has(q.id),onCheckedChange:()=>G(q.id),className:"h-4 w-4 flex-shrink-0",onClick:Z=>Z.stopPropagation()}),t.jsx("div",{className:"flex-1",children:U})]}):U}})})}),g?$(g):t.jsxs("div",{className:"flex items-center gap-1 pt-2 border-t","data-test":"add-buttons-row",children:[t.jsxs(ee,{"data-test":"workflow-add-definition-button",variant:"outline",size:"sm",className:"add-definition-button flex-1",onClick:()=>w("definition"),title:"Add Workflow Definition",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"})," Workflow"]}),n&&t.jsxs(ee,{"data-test":"workflow-add-instance-button",variant:"outline",size:"sm",className:"add-instance-button flex-1",onClick:()=>w("instance"),title:"Add Workflow Instance",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"})," Instance"]})]})]})})]})},sa=e=>{const{className:s,style:n,children:o,position:r="left"}=e;return t.jsx("div",{className:je("p-2 bg-background border shadow flex flex-col items-center space-y-2 pointer-events-auto rounded",s),style:{...n},onMouseDown:a=>a.stopPropagation(),onPointerDown:a=>a.stopPropagation(),"data-test":"canvas-vertical-toolbar","data-prevent-canvas-click":!0,children:o})},Hb=({extension:e})=>{const s=F(i=>{var c,l;return((l=(c=i.extensions)==null?void 0:c.settings)==null?void 0:l[e.id])??e.defaultSettings}),n=i=>{var l,d;(d=(l=E.getState().ext)==null?void 0:l.setSettings)==null||d.call(l,e.id,i)},o=i=>typeof i=="boolean"?i:typeof i=="function"?i(s):!1,r=async i=>{try{await i(s)}catch(c){console.error(`Error executing extension action for ${e.id}:`,c)}},a=t.jsxs("div",{className:"flex flex-col h-full","data-test":"extension-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-y-auto border-b border-border p-3","data-test":"extension-settings-container",children:Ie.createElement(e.settingsComponent,{settings:s,onSettingsChange:n})}),Object.entries(e.actions).length>0&&t.jsx("div",{className:"flex flex-col gap-2 p-3","data-test":"extension-actions-container",children:Object.entries(e.actions).map(([i,c])=>{const l=o(c.disabled),d=c.icon;return t.jsxs("button",{onClick:()=>r(c.execute),disabled:l,className:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow-xs hover:bg-primary/90 h-8 px-3 py-1.5",title:c.label,"data-test":"extension-action-button",children:[d&&t.jsx(d,{className:"h-4 w-4"}),t.jsx("span",{children:c.label})]},i)})})]});return t.jsx(rn,{popoverId:`extension-${e.id}`,icon:e.icon,tooltip:e.description||e.name,popoverTitle:e.name,popoverContent:a,leftOffset:120,dataTest:"extension-button"})},Bb=({settings:e,onSettingsChange:s})=>{p.useEffect(()=>{Qa("1_settings_load",e)},[e]);const n=p.useCallback((o,r)=>{s({...e,[o]:r})},[e,s]);return t.jsxs("div",{className:"flex flex-col gap-4 p-2","data-test":"journal-settings",children:[t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-project-field",children:[t.jsx(Te,{htmlFor:"journal-project",className:"text-xs text-muted-foreground",children:"Project Name"}),t.jsx(Re,{id:"journal-project",value:e.projectName,onChange:o=>n("projectName",o.target.value),placeholder:"Journal",className:"h-8 text-sm","data-test":"journal-settings-project-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-workspace-field",children:[t.jsx(Te,{htmlFor:"journal-workspace",className:"text-xs text-muted-foreground",children:"Workspace Name"}),t.jsx(Re,{id:"journal-workspace",value:e.workspaceName,onChange:o=>n("workspaceName",o.target.value),placeholder:Ir(),className:"h-8 text-sm","data-test":"journal-settings-workspace-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-canvas-field",children:[t.jsx(Te,{htmlFor:"journal-canvas",className:"text-xs text-muted-foreground",children:"Canvas Name"}),t.jsx(Re,{id:"journal-canvas",value:e.canvasName,onChange:o=>n("canvasName",o.target.value),placeholder:Tr(),className:"h-8 text-sm","data-test":"journal-settings-canvas-input"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 py-1","data-test":"journal-settings-autocreate-field",children:[t.jsx(Te,{htmlFor:"journal-autocreate",className:"text-xs text-muted-foreground",children:"Create if missing"}),t.jsx(So,{id:"journal-autocreate",checked:e.autoCreateIfMissing,onCheckedChange:o=>n("autoCreateIfMissing",o),"data-test":"journal-settings-autocreate-switch"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-template-field",children:[t.jsx(Te,{htmlFor:"journal-template",className:"text-xs text-muted-foreground",children:"Note Template (optional)"}),t.jsx(nr,{id:"journal-template",value:e.noteTemplate??"",onChange:o=>n("noteTemplate",o.target.value),placeholder:"Enter default note content...",className:"min-h-[60px] resize-none text-sm","data-test":"journal-settings-template-input"}),t.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Text to include after the timestamp header"})]})]})};function Ir(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0");return`${s}-${n}`}function Tr(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${o}`}const Fb={projectName:"Journal",workspaceName:Ir(),canvasName:Tr(),autoCreateIfMissing:!0,noteTemplate:""};function Qa(e,s){var a;const o=((a=E.getState().state)==null?void 0:a.projects)??{};Object.keys(o).find(i=>o[i].name===s.projectName)}function $b(){const e=new Date,s={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0};return e.toLocaleString(void 0,s)}function zb(e){var h,f,g,w;const s=E.getState(),n=((h=s.state)==null?void 0:h.projects)??{},o=e.workspaceName||Ir(),r=e.canvasName||Tr();let a=Object.keys(n).find(m=>n[m].name===e.projectName),i=!1;if(!a&&e.autoCreateIfMissing){if(a=s.project.create(e.projectName),!a)return null;i=!0}if(!a)return null;const c=(f=E.getState().state)==null?void 0:f.projects[a];if(!c)return null;let l=Object.keys(c.workspaces).find(m=>c.workspaces[m].name===o);if(!l&&i&&e.autoCreateIfMissing){const m=Object.keys(c.workspaces).find(x=>c.workspaces[x].name==="Default Workspace");m&&(s.workspace.updateMetadata(m,{name:o}),l=m)}if(!l&&e.autoCreateIfMissing&&(s.project.switch(a),l=s.workspace.create(o)??void 0,!l)||!l)return null;const d=(w=(g=E.getState().state)==null?void 0:g.projects[a])==null?void 0:w.workspaces[l];if(!d)return null;let u=Object.keys(d.canvases).find(m=>d.canvases[m].name===r);if(!u&&i&&e.autoCreateIfMissing){const m=Object.keys(d.canvases).find(x=>d.canvases[x].name==="Default Canvas");m&&(s.projectCanvas.updateMetadata(m,{name:r}),u=m)}return!u&&e.autoCreateIfMissing&&(s.project.switch(a),s.workspace.switch(l),u=s.projectCanvas.create(r)??void 0,!u)?null:u??null}function _b(e){Qa("2_create_note_before",e);const s=E.getState(),n=zb(e);if(!n){console.error("[JournalExtension] Could not find or create target canvas");return}s.projectCanvas.switch(n);const r=`## ${$b()}`,a=e.noteTemplate?`${r}

${e.noteTemplate}`:r,i=`journal-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,c={id:i,type:ce.TEXT,x:100,y:100,width:300,height:150,content:"",isSelected:!0,isEditing:!0};s.addNode(c,a,{dontOverlap:!0}),s.setNodeToFocusId(i),Qa("2_create_note_after",e)}const Vb={id:"journal",name:"Journal",icon:Go,description:"Create timestamped notes in a dedicated canvas",settingsComponent:Bb,defaultSettings:Fb,version:"1.0.0",actions:{createNote:{label:"Create Note",execute:_b}}},yn=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const u=n?l:l.toLowerCase();let h=0,f=u.indexOf(a,h);for(;f!==-1;){const g=Math.max(0,f-40),w=Math.min(l.length,f+a.length+40);let m=l.substring(g,w);g>0&&(m="..."+m),w<l.length&&(m=m+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:m,startIndex:f,field:o}),h=f+1,f=u.indexOf(a,h)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let f=e.substring(u,h);u>0&&(f="..."+f),h<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},Ub=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...yn(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...yn(e.title,s,n,"title")),o.id&&e.id&&r.push(...yn(e.id,s,n,"id")),o.type&&e.type&&r.push(...yn(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...yn(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},Gb=(e,s,n=new Set)=>{if(!s.query.trim())return[];if(!Object.values(s.nodeFields).some(a=>a))return[];const r=[];for(const a of e){if(n.has(a.id))continue;const i=Ub(a,s.query,s.caseSensitive,s.nodeFields);i&&r.push(i)}return r},Yb=e=>e.reduce((s,n)=>s+n.matches.length,0),Kb=(e,s,n)=>{const o=n?s:s.toLowerCase(),a=(n?e:e.toLowerCase()).indexOf(o);return a===-1?null:{before:e.substring(0,a),matched:e.substring(a,a+s.length),after:e.substring(a+s.length)}},Xb=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(""),[r,a]=p.useState(!1),[i,c]=p.useState(lw),[l,d]=p.useState(new Set),[u,h]=p.useState(!1),f=p.useMemo(()=>({query:n,caseSensitive:r,nodeFields:i}),[n,r,i]),g=p.useMemo(()=>Gb(e,f,l),[e,f,l]),w=p.useMemo(()=>Yb(g),[g]),m=p.useCallback(b=>{d(S=>new Set(S).add(b))},[]),x=p.useCallback(()=>{d(new Set)},[]),y=p.useCallback(()=>{if(g.length>0){const b=g.map(S=>S.node);s(b)}},[g,s]),v=p.useCallback(b=>{const S=b.node;s([S]),E.getState().scrollToNode(S.id)},[s]),N=p.useCallback((b,S)=>{const I=b.node;s([I]);const C=Ne.LINE_HEIGHT_FIND,k=S?(S-1)*C:0;Yn(I,{highlightYOffset:k})},[s]);return{searchConfig:f,nodesWithMatches:g,totalMatchCount:w,excludedNodeIds:l,showSettings:u,setQuery:o,setCaseSensitive:a,setNodeFields:c,setShowSettings:h,removeNodeFromResults:m,clearExcludedNodes:x,handleSelectAllMatches:y,handleNodeClick:v,handleMatchClick:N}},ao=20,gc=40,fc=200,mc=100;function xc(e){if(e.length===0)return{x:0,y:0,width:fc,height:mc};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e){const i=a.width??fc,c=a.height??mc;s=Math.min(s,a.x),n=Math.min(n,a.y),o=Math.max(o,a.x+i),r=Math.max(r,a.y+c)}return{x:s-ao,y:n-ao-gc,width:o-s+ao*2,height:r-n+ao*2+gc}}const qb=({nodes:e})=>{const[s,n]=p.useState(null),[o,r]=p.useState([]),[a,i]=p.useState("horizontal"),[c,l]=p.useState(null),d=p.useMemo(()=>pw(e),[e]),u=p.useMemo(()=>ww(e,d),[e,d]),h=p.useMemo(()=>({mode:s,selectedTagIds:o,sliceArrangement:a}),[s,o,a]),f=p.useCallback(x=>{r(y=>y.includes(x)?y.filter(v=>v!==x):[...y,x])},[]),g=p.useCallback(x=>{const y=E.getState(),v=Jl(e,x);if(v.length<2)return;c&&y.viewLayer.delete(c);const N=`(Unsaved) Group: ${x}`,b=y.viewLayer.create(N,{tagTitles:[x],arrangementStyle:"group"});if(!b)return;l(b);const S=xc(v),I={id:Pe(10),name:x,x:S.x,y:S.y,width:S.width,height:S.height,childNodeIds:v.map(C=>C.id)};y.viewLayer.addGroupNode(b,I),n("group"),r([x])},[e,c]),w=p.useCallback(()=>{if(o.length===0)return;const x=E.getState(),y=xw(e,o,a);if(y.updates.length===0)return;e.map(C=>({id:C.id.slice(0,6),content:typeof C.content=="string"?C.content.slice(0,20):C.type,x:C.x,y:C.y,w:C.width,h:C.height,type:C.type,groupId:C.groupId})),c&&x.viewLayer.delete(c);const v=`(Unsaved) Slice: ${o.join(", ")}`,N=x.viewLayer.create(v,{tagTitles:o,arrangementStyle:"slice",sliceArrangement:a});if(!N)return;l(N),x.viewLayer.updateNodePositions(y.updates.map(C=>({id:C.id,x:C.x,y:C.y})));const b=[];y.lanes.forEach(C=>{if(C.nodeIds.length<2)return;const R=e.filter(O=>C.nodeIds.includes(O.id)).map(O=>{const $=y.updates.find(B=>B.id===O.id);return $?{...O,x:$.x,y:$.y}:O}),A=xc(R),T={id:Pe(10),name:C.tagTitle,x:A.x,y:A.y,width:A.width,height:A.height,childNodeIds:C.nodeIds};x.viewLayer.addGroupNode(N,T),b.push({tagTitle:C.tagTitle,nodeIds:C.nodeIds})});const I=E.getState().viewLayer.getNodesWithEffectivePositions();I.map(C=>({id:C.id.slice(0,6),content:typeof C.content=="string"?C.content.slice(0,20):C.type,x:C.x,y:C.y,w:C.width,h:C.height,type:C.type,groupId:C.groupId})),I.filter(C=>C.type===ce.GROUP).map(C=>{var k;return{id:C.id.slice(0,6),content:C.content,x:C.x,y:C.y,w:C.width,h:C.height,childNodeIds:(k=C.data)==null?void 0:k.childNodeIds}}),n("slice")},[e,o,a,c]),m=p.useCallback(()=>{const x=E.getState();c&&(x.viewLayer.delete(c),l(null)),x.viewLayer.setActive(null),n(null),r([])},[c]);return{availableTags:d,nodesCountPerTag:u,config:h,canReset:s!==null,setMode:n,setSelectedTagIds:r,toggleTagSelection:f,setSliceArrangement:i,handleGroup:g,handleSlice:w,handleReset:m}},Zb=({nodesWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemoveNode:a})=>t.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto","data-test":"search-results-list",children:e.map(i=>t.jsx(Jb,{nodeWithMatches:i,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a},i.nodeId))}),Jb=({nodeWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a})=>{const{node:i,matches:c,nodeId:l}=e;return t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"search-result",children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>a(l),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"search-result-remove",children:t.jsx($e,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none",children:[t.jsx(Qb,{nodeWithMatches:e,onClick:()=>o(e)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":"search-result-matches",children:c.map((d,u)=>t.jsx(eN,{match:d,query:s,caseSensitive:n,onClick:()=>r(e,d.lineNumber),dataTest:"search-match"},u))})]})]})})},Qb=({nodeWithMatches:e,onClick:s})=>{const{node:n,matches:o}=e,r=ta(n.type),a=n.id.substring(0,6),i=typeof n.content=="string"?n.content:"",c=n.title?`${n.title.substring(0,30)}${n.title.length>30?"...":""}`:i?`${i.substring(0,30)}${i.length>30?"...":""}`:"(No Content)",l=n.title&&i?`${i.substring(0,50)}${i.length>50?"...":""}`:null;return t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:s,"data-test":"search-result-header",children:t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[r&&t.jsx("span",{className:"flex-shrink-0",children:r}),t.jsx("span",{className:"truncate",children:c}),n.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(tt,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[o.length," ",o.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:a})]}),l&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:l})]})})},eN=({match:e,query:s,caseSensitive:n,onClick:o,dataTest:r})=>{const a=Kb(e.context,s,n);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",onClick:o,"data-test":r,children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:a?t.jsxs(t.Fragment,{children:[a.before,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:a.matched}),a.after]}):e.context})]})},tN=({searchConfig:e,nodesWithMatches:s,totalMatchCount:n,showSettings:o,onQueryChange:r,onCaseSensitiveChange:a,onNodeFieldsChange:i,onShowSettingsChange:c,onNodeClick:l,onMatchClick:d,onRemoveNode:u,onSelectAllMatches:h})=>{const{query:f,caseSensitive:g,nodeFields:w}=e,m=g||w.title||w.id||w.type||w.tags||!w.content,x=(y,v)=>{i({...w,[y]:v})};return t.jsxs("div",{className:"space-y-3","data-test":"filter-search-section",children:[t.jsxs("div",{className:"relative flex items-center gap-1","data-test":"filter-search-input-container",children:[t.jsx(Ss,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"filter-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search nodes...",value:f,onChange:y=>r(y.target.value),onKeyDown:y=>{y.key==="Enter"&&f.trim()&&(y.preventDefault(),h())},className:ve("h-8 text-sm pl-8",f?"pr-16":"pr-10"),autoFocus:!0,"data-test":"filter-search-input"}),f&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>r(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"filter-search-clear-button",children:t.jsx($e,{className:"h-3 w-3"})}),m&&t.jsx("div",{className:ve("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",f?"right-16":"right-11"),"data-test":"filter-search-filter-indicator"}),t.jsx(sN,{showSettings:o,onShowSettingsChange:c,caseSensitive:g,onCaseSensitiveChange:a,nodeFields:w,onFieldChange:x})]}),f.trim()&&t.jsx(nN,{nodesWithMatches:s,totalMatchCount:n}),s.length>0&&t.jsx(Zb,{nodesWithMatches:s,query:f,caseSensitive:g,onNodeClick:l,onMatchClick:d,onRemoveNode:u})]})},sN=({showSettings:e,onShowSettingsChange:s,caseSensitive:n,onCaseSensitiveChange:o,nodeFields:r,onFieldChange:a})=>t.jsxs(ct,{open:e,onOpenChange:s,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"filter-search-settings-button",children:t.jsx(qo,{className:"h-3.5 w-3.5"})})}),t.jsx(dt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:Ee.draggablePopoverDropdown},"data-test":"filter-search-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(Es,{id:"filter-case-sensitive",label:"Case sensitive",checked:n,onChange:o,dataTest:"filter-case-sensitive-checkbox"}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx(Es,{id:"filter-content",label:"Content",checked:r.content,onChange:i=>a("content",i),dataTest:"filter-content-checkbox"}),t.jsx(Es,{id:"filter-title",label:"Title",checked:r.title,onChange:i=>a("title",i),dataTest:"filter-title-checkbox"}),t.jsx(Es,{id:"filter-id",label:"ID",checked:r.id,onChange:i=>a("id",i),dataTest:"filter-id-checkbox"}),t.jsx(Es,{id:"filter-type",label:"Type",checked:r.type,onChange:i=>a("type",i),dataTest:"filter-type-checkbox"}),t.jsx(Es,{id:"filter-tags",label:"Tags",checked:r.tags,onChange:i=>a("tags",i),dataTest:"filter-tags-checkbox"})]})]})]})})]}),Es=({id:e,label:s,checked:n,onChange:o,dataTest:r})=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:e,checked:n,onCheckedChange:a=>o(!!a),"data-test":r}),t.jsx("label",{htmlFor:e,className:"text-sm cursor-pointer",children:s})]}),nN=({nodesWithMatches:e,totalMatchCount:s})=>t.jsx("div",{className:"flex items-center justify-between","data-test":"filter-search-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground",children:e.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found"," ",t.jsx(tt,{variant:"secondary",className:"mx-1",children:s}),s===1?"match":"matches"," in"," ",t.jsx(tt,{variant:"secondary",className:"mx-1",children:e.length}),e.length===1?"node":"nodes"]})})}),oN=({availableTags:e,nodesCountPerTag:s,selectedTagIds:n,showToggle:o,onToggleTag:r,onSetSelectedTags:a})=>{const i=n.length===e.length&&e.length>0;return t.jsxs("div",{className:"space-y-2","data-test":"tags-list-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Available Tags:"}),o&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>{a(i?[]:e.map(c=>c.title))},className:"h-5 w-5",title:i?"Unselect all":"Select all","data-test":"tag-toggle-all-button",children:i?t.jsx(fr,{className:"h-3 w-3"}):t.jsx(ml,{className:"h-3 w-3"})})]}),t.jsx("div",{className:"flex flex-wrap gap-1.5","data-test":"tags-list",children:e.map(c=>{const l=s.get(c.title)??0,d=n.includes(c.title);return t.jsxs(tt,{variant:d?"default":"secondary",className:ve("text-xs transition-colors cursor-pointer hover:bg-primary/80"),onClick:()=>r(c.title),"data-test":"tag-badge",children:[c.title,t.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",l,")"]})]},c.id)})})]})},aN=({availableTags:e,nodesCountPerTag:s,config:n,canReset:o,onModeChange:r,onToggleTag:a,onSetSelectedTags:i,onArrangementChange:c,onGroup:l,onSlice:d,onReset:u})=>{const{mode:h,selectedTagIds:f,sliceArrangement:g}=n;return e.length===0?t.jsx("div",{className:"text-xs text-muted-foreground py-2","data-test":"tag-organize-no-tags",children:"No tags found. Add tags to nodes to organize them."}):t.jsxs("div",{className:"space-y-3","data-test":"tag-organize-section",children:[t.jsxs("div",{className:"flex items-center gap-2","data-test":"tag-organize-actions",children:[t.jsx(wc,{mode:"group",currentMode:h,icon:t.jsx(Bn,{className:"h-3.5 w-3.5"}),label:"Group",onClick:()=>r(h==="group"?null:"group")}),t.jsx(wc,{mode:"slice",currentMode:h,icon:t.jsx(sn,{className:"h-3.5 w-3.5"}),label:"Slice",onClick:()=>r(h==="slice"?null:"slice")}),o&&t.jsxs(ee,{variant:"ghost",size:"sm",onClick:u,className:"h-7 text-xs","data-test":"tag-organize-reset-button",children:[t.jsx(Xo,{className:"h-3.5 w-3.5 mr-1"}),"Reset"]})]}),h&&t.jsx("div",{className:"text-xs text-muted-foreground","data-test":"tag-organize-mode-description",children:h==="group"?"Select tags, then click Apply to create groups.":"Select tags, then click Apply to create swimlanes."}),h==="slice"&&t.jsxs("div",{className:"space-y-1.5","data-test":"slice-arrangement-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lane Layout:"}),t.jsxs("div",{className:"flex gap-1","data-test":"slice-arrangement-buttons",children:[t.jsx(ro,{arrangement:"horizontal",currentArrangement:g,icon:t.jsx(xs,{className:"h-3.5 w-3.5"}),onClick:()=>c("horizontal")}),t.jsx(ro,{arrangement:"vertical",currentArrangement:g,icon:t.jsx(uo,{className:"h-3.5 w-3.5"}),onClick:()=>c("vertical")}),t.jsx(ro,{arrangement:"grid",currentArrangement:g,icon:t.jsx(Bn,{className:"h-3.5 w-3.5"}),onClick:()=>c("grid")}),t.jsx(ro,{arrangement:"masonry",currentArrangement:g,icon:t.jsx(ll,{className:"h-3.5 w-3.5"}),onClick:()=>c("masonry")})]})]}),t.jsx(oN,{availableTags:e,nodesCountPerTag:s,selectedTagIds:f,showToggle:h!==null,onToggleTag:a,onSetSelectedTags:i}),h==="group"&&f.length>0&&t.jsxs(ee,{variant:"default",size:"sm",onClick:()=>{f.forEach(w=>l(w))},className:"w-full h-8","data-test":"tag-organize-apply-group-button",children:["Apply Groups (",f.length," tags)"]}),h==="slice"&&f.length>0&&t.jsxs(ee,{variant:"default",size:"sm",onClick:d,className:"w-full h-8","data-test":"tag-organize-apply-slice-button",children:["Apply Swimlanes (",f.length," tags)"]})]})},wc=({mode:e,currentMode:s,icon:n,label:o,onClick:r})=>{const a=s===e;return t.jsxs(ee,{variant:a?"default":"outline",size:"sm",onClick:r,className:"h-7 text-xs","data-test":"tag-organize-mode-button",children:[n,t.jsx("span",{className:"ml-1",children:o})]})},ro=({arrangement:e,currentArrangement:s,icon:n,onClick:o})=>{const r=s===e;return t.jsx(ee,{variant:r?"default":"outline",size:"icon",onClick:o,className:"h-7 w-7",title:dw[e],"data-test":"slice-arrangement-button",children:n})},rN=[],iN=()=>{const e=F(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.coreState.nodes)??rN}),s=F(o=>{var a;const r=o.projectCanvas.getActive();return r!=null&&r.activeViewLayerId?((a=r.viewLayers)==null?void 0:a.find(i=>i.id===r.activeViewLayerId))??null:null});return p.useMemo(()=>{if(!s)return e;const o=new Map(s.nodePositions.map(i=>[i.nodeId,i])),r=e.map(i=>{const c=o.get(i.id);return c?{...i,x:c.x,y:c.y}:i}),a=s.groupNodes.map(i=>({id:i.id,type:ce.GROUP,x:i.x,y:i.y,width:i.width,height:i.height,content:i.name,data:{childNodeIds:i.childNodeIds}}));return[...r,...a]},[e,s])},cN=()=>F(s=>{var n;return((n=s.projectCanvas.getActive())==null?void 0:n.activeViewLayerId)??null})!==null,lN=[],dN=()=>{const e=F(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.viewLayers)??lN}),s=F(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.activeViewLayerId)??null}),n=F(g=>g.viewLayer),o=p.useMemo(()=>[...e].sort((g,w)=>new Date(w.createdAt).getTime()-new Date(g.createdAt).getTime()),[e]),r=p.useMemo(()=>o.map(g=>({id:g.id,label:g.name,icon:t.jsx(Bn,{className:"h-3 w-3 text-muted-foreground"}),data:{type:"view-layer",...g}})),[o]),a=p.useCallback(g=>{n.setActive(g.id)},[n]),i=p.useCallback(()=>{n.setActive(null)},[n]),c=p.useCallback((g,w)=>{n.rename(g,w)},[n]),l=p.useCallback(g=>{n.delete(g)},[n]),d=p.useCallback(g=>`Delete view "${g.label}"? This cannot be undone.`,[]),u=p.useCallback(g=>[{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(g.id)}}],[n]),h=p.useCallback(()=>{const g=s?e.find(x=>x.id===s):null,w=g==null?void 0:g.name.startsWith("(Unsaved) ");let m;w&&g?m=g.name.replace("(Unsaved) ",""):m=`View ${e.filter(y=>!y.name.startsWith("(Unsaved)")).length+1}`,w&&s?n.rename(s,m):n.create(m)},[e,n,s]),f=s===null;return t.jsxs("div",{className:"view-layer-manager flex flex-col h-full w-full overflow-hidden","data-test":"view-layer-manager",children:[t.jsxs("div",{className:"view-list flex-1 min-h-0 w-full overflow-y-auto overflow-x-hidden p-2","data-test":"view-list-scroll-area",children:[t.jsxs("div",{className:ve("flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",f&&"bg-primary/10 border border-primary"),onClick:i,"data-test":"base-view-item",children:[t.jsx("div",{className:"w-4 h-4 mr-2 flex-shrink-0"}),t.jsx(Lh,{className:"h-3 w-3 text-muted-foreground mr-2 flex-shrink-0"}),t.jsx("span",{className:"text-sm truncate flex-grow",children:"Base View"})]}),r.length>0&&t.jsx("div",{className:"mt-1","data-test":"saved-views-list",children:t.jsx(qs,{data:r,onItemClick:a,onUpdate:c,onDelete:l,selectedId:s,deleteConfirmMessage:d,enableEdit:!0,enableDelete:!0,enableDrag:!1,moreOptionsItems:u,dropdownZIndex:Ee.draggablePopoverDropdown})})]}),t.jsx("div",{className:"border-t p-2","data-test":"view-actions",children:t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full",onClick:h,"data-test":"view-save-button",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"}),"Save Current View"]})})]})},uN=()=>{const e=F(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.coreState.nodes)??[]}),s=F(g=>g.setSelectedNodes),n=cN(),[o,r]=p.useState(!1),[a,i]=p.useState(null),c=p.useRef(null),l=Xb({nodes:e,setSelectedNodes:s}),d=qb({nodes:e}),u=g=>{if(g.stopPropagation(),o){r(!1);return}if(c.current){const w=c.current.getBoundingClientRect();i({x:w.left-280-16,y:w.top})}r(!0)},h=t.jsx("button",{ref:c,onClick:u,onMouseDown:g=>g.stopPropagation(),className:ve("p-1 rounded hover:bg-accent transition-colors",n&&"text-blue-500 bg-blue-500/10"),title:"Manage Views","data-test":"canvas-filter-views-button",children:t.jsx(Bn,{className:"h-3.5 w-3.5"})}),f=t.jsxs("div",{className:"flex flex-col h-full","data-test":"canvas-filter-popover-content",children:[t.jsx("div",{className:"border-b border-border p-3","data-test":"canvas-filter-search-container",children:t.jsx(tN,{searchConfig:l.searchConfig,nodesWithMatches:l.nodesWithMatches,totalMatchCount:l.totalMatchCount,showSettings:l.showSettings,onQueryChange:l.setQuery,onCaseSensitiveChange:l.setCaseSensitive,onNodeFieldsChange:l.setNodeFields,onShowSettingsChange:l.setShowSettings,onNodeClick:l.handleNodeClick,onMatchClick:l.handleMatchClick,onRemoveNode:l.removeNodeFromResults,onSelectAllMatches:l.handleSelectAllMatches})}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3","data-test":"canvas-filter-organize-container",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Organize by Tags"}),n&&t.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded","data-test":"view-layer-active-badge",children:[t.jsx(sn,{className:"h-3 w-3"}),"View Active"]})]}),t.jsx(aN,{availableTags:d.availableTags,nodesCountPerTag:d.nodesCountPerTag,config:d.config,canReset:d.canReset,onModeChange:d.setMode,onToggleTag:d.toggleTagSelection,onSetSelectedTags:d.setSelectedTagIds,onArrangementChange:d.setSliceArrangement,onGroup:d.handleGroup,onSlice:d.handleSlice,onReset:d.handleReset})]})]});return t.jsxs(t.Fragment,{children:[t.jsx(rn,{popoverId:"canvas-filter",icon:Wh,tooltip:"Filter & Organize",popoverTitle:"Filter & Organize",popoverContent:f,leftOffset:120,initialSize:{width:360,height:500},dataTest:"canvas-filter-button",headerActions:h}),t.jsx(_e,{isVisible:o,onClose:()=>r(!1),title:"Views",resizable:!0,initialSize:{width:280,height:350},triggerPosition:a??void 0,children:t.jsx(dN,{})})]})},hN=e=>{const{className:s,style:n}=e;return t.jsx(ay,{children:t.jsxs(sa,{className:s,style:n,position:"left",children:[t.jsx(Sd,{}),t.jsx(Wb,{}),t.jsx(uN,{}),t.jsx(Hb,{extension:Vb})]})})},pN=()=>{const e=F(i=>i.uiState.mode),s=F(i=>i.uiState.selectFromDrawMode),{setMode:n,setUiState:o}=E.getState(),r=e===Q.SELECT&&s,a=()=>{r?(o(i=>({...i,selectFromDrawMode:!1})),E.getState().setSelectedNodes([]),E.getState().arrow.setSelected([]),n(Q.DRAW)):(o(i=>({...i,selectFromDrawMode:!0})),n(Q.SELECT))};return t.jsx(ee,{variant:r?"default":"outline",size:"icon",onPointerUp:a,title:r?"Back to Draw Mode":"Select Mode (select/drag nodes)","data-test":"draw-mode-select-button",children:t.jsx(Xc,{className:"h-4 w-4"})})},na=()=>"right",gN=()=>{const[e,s]=p.useState(!1),n=F(h=>h.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=E.getState(),a=(n==null?void 0:n.strokeColor)??"currentColor",i=a==="currentColor"?"hsl(var(--foreground))":a,c=(n==null?void 0:n.opacity)??1,l=c<1,d=h=>{o({strokeColor:h}),r(l?f=>({...f,markerStrokeColor:h}):f=>({...f,penStrokeColor:h}))},u=h=>{o({opacity:h[0]})};return t.jsxs(ct,{open:e,onOpenChange:s,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"outline",size:"icon",title:`Stroke Color (${Math.round(c*100)}% opacity)`,"data-test":"draw-mode-stroke-color-button",children:t.jsx("span",{style:{width:"16px",height:"16px",borderRadius:"3px",backgroundColor:i,opacity:c,border:"1px solid hsl(var(--border))"}})})}),t.jsx(dt,{className:"w-auto p-0",side:na(),sideOffset:8,onCloseAutoFocus:h=>h.preventDefault(),"data-test":"draw-mode-stroke-color-popover",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(Ar,{label:"Stroke Color",currentColor:a,onColorSelect:d}),t.jsxs("div",{className:"px-3 pb-3 space-y-2","data-test":"draw-mode-opacity-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(c*100),"%"]})]}),t.jsx(Kt,{value:[c],min:.1,max:1,step:.05,onValueChange:u,className:"w-full","data-test":"draw-mode-opacity-slider"})]})]})})]})},fN=[1,2,3,4,5,6,8,10,12,16,20,28,40,60],mN=()=>{const[e,s]=p.useState(!1),n=F(l=>l.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=E.getState(),a=(n==null?void 0:n.strokeWidth)??Da,i=((n==null?void 0:n.opacity)??1)<1,c=l=>{o({strokeWidth:l}),r(i?d=>({...d,markerStrokeWidth:l}):d=>({...d,penStrokeWidth:l})),s(!1)};return t.jsxs(ct,{open:e,onOpenChange:s,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"outline",size:"icon",title:`Stroke Width: ${a}px`,"data-test":"draw-mode-stroke-width-button",children:t.jsxs("div",{className:"flex flex-col gap-[2px] items-center",children:[t.jsx("span",{style:{width:"14px",height:"1px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"2px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"4px",backgroundColor:"currentColor",borderRadius:"1px"}})]})})}),t.jsx(dt,{className:"w-auto p-3",side:na(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1 flex-wrap max-w-[200px]",children:fN.map(l=>t.jsxs("button",{type:"button",title:`${l}px`,onClick:()=>c(l),className:`w-10 h-8 flex items-center justify-center gap-1 rounded border cursor-pointer hover:bg-accent ${a===l?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-stroke-width-button",children:[t.jsx("span",{style:{width:"12px",height:`${Math.min(l,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}}),t.jsx("span",{className:"text-[10px] text-muted-foreground",children:l})]},l))})]})})]})},xN=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}],yc=({style:e})=>{const s=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("svg",{width:"16",height:"8",viewBox:"0 0 16 8",children:t.jsx("line",{x1:"0",y1:"4",x2:"16",y2:"4",stroke:"currentColor",strokeWidth:"2",strokeDasharray:s,strokeLinecap:"round"})})},wN=()=>{const[e,s]=p.useState(!1),n=F(c=>c.uiState.drawStyle),{setDrawStyle:o}=E.getState(),r=(n==null?void 0:n.strokeStyle)??"solid",a=c=>{o({strokeStyle:c}),s(!1)},i=c=>{s(c)};return t.jsxs(ct,{open:e,onOpenChange:i,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"outline",size:"icon",title:`Stroke Style: ${r}`,"data-test":"draw-mode-stroke-style-button",onPointerDown:c=>{c.stopPropagation()},onPointerUp:c=>{c.stopPropagation()},children:t.jsx(yc,{style:r})})}),t.jsx(dt,{className:"w-auto p-3",side:na(),sideOffset:8,onCloseAutoFocus:c=>c.preventDefault(),"data-test":"draw-mode-stroke-style-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-style-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Style"}),t.jsx("div",{className:"flex gap-1",children:xN.map(c=>t.jsx("button",{type:"button",title:c.label,onClick:()=>a(c.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${r===c.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-stroke-style-option",children:t.jsx(yc,{style:c.value})},c.value))})]})})]})},yN=()=>t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:t.jsx("ellipse",{cx:"8",cy:"8",rx:"7",ry:"4"})}),vc=[{value:Se.SQUARE,label:"Square",icon:t.jsx(ml,{className:"h-4 w-4"})},{value:Se.RECTANGLE,label:"Rectangle",icon:t.jsx($t,{className:"h-4 w-4"})},{value:Se.CIRCLE,label:"Circle",icon:t.jsx(Ko,{className:"h-4 w-4"})},{value:Se.ELLIPSE,label:"Ellipse",icon:t.jsx(yN,{})},{value:Se.ARROW,label:"Arrow",icon:t.jsx($h,{className:"h-4 w-4"})}],vN=()=>{const[e,s]=p.useState(!1),n=F(l=>l.uiState.drawSubMode),{setDrawSubMode:o,setDrawStyle:r}=E.getState(),a=n&&[Se.SQUARE,Se.RECTANGLE,Se.CIRCLE,Se.ELLIPSE,Se.ARROW].includes(n),i=vc.find(l=>l.value===n),c=l=>{o(l),r({opacity:1}),s(!1)};return t.jsxs(ct,{open:e,onOpenChange:s,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:a?"default":"outline",size:"icon",title:i?`Shape: ${i.label}`:"Shapes","data-test":"draw-mode-shape-button",children:a&&i?i.icon:t.jsx(Fh,{className:"h-4 w-4"})})}),t.jsx(dt,{className:"w-auto p-3",side:na(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-shape-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-shape-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Shapes"}),t.jsx("div",{className:"flex gap-1",children:vc.map(l=>t.jsx("button",{type:"button",title:l.label,onClick:()=>c(l.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${n===l.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-shape-button",children:l.icon},l.value))}),t.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Click to switch to shape mode. Drag to draw."})]})})]})},bN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=F(I=>I.uiState.drawStyle),i=F(I=>I.uiState.penStrokeWidth)??Da,c=F(I=>I.uiState.markerStrokeWidth)??du,l=F(I=>I.uiState.penStrokeColor)??"currentColor",d=F(I=>I.uiState.markerStrokeColor)??J.drawing.markerColor,u=F(I=>I.uiState.drawAxisLock)??"none",{setDrawStyle:h,setDrawAxisLock:f,setUiState:g,setDrawSubMode:w}=E.getState(),m=((a==null?void 0:a.opacity)??1)<1,x=(a==null?void 0:a.strokeWidth)??Da,y=(a==null?void 0:a.strokeColor)??"currentColor",v=()=>{m?(g(I=>({...I,markerStrokeWidth:x,markerStrokeColor:y})),h({opacity:1,strokeWidth:i,strokeColor:l})):(g(I=>({...I,penStrokeWidth:x,penStrokeColor:y})),h({opacity:J.drawing.markerOpacity,strokeWidth:c,strokeColor:d}),w(Se.FREEHAND))},N=I=>{if(I.stopPropagation(),e){s(!1);return}if(r.current){const C=r.current.getBoundingClientRect();o({x:C.right+8,y:C.top})}s(!0)},b=I=>{f(I?"horizontal":"none")},S=I=>{f(I?"vertical":"none")};return t.jsxs("div",{ref:r,className:"relative inline-flex group","data-test":"draw-mode-marker-container",children:[t.jsx(ee,{variant:m?"default":"outline",size:"icon",onPointerUp:v,title:m?"Marker Mode (On)":"Marker Mode (Off)","data-test":"draw-mode-marker-toggle",children:t.jsx(Zc,{className:"h-4 w-4"})}),t.jsxs("div",{className:ve("absolute right-0 top-0 bottom-0 translate-x-full","flex items-stretch","opacity-0 group-hover:opacity-100 transition-opacity duration-150","pointer-events-none group-hover:pointer-events-auto"),"data-test":"draw-mode-marker-caret-trigger",children:[t.jsx("div",{className:"w-[3px] bg-foreground/10"}),t.jsx("button",{type:"button",onClick:N,className:ve("flex items-center justify-center","px-1 rounded-r-md","bg-foreground/5 hover:bg-foreground/10","transition-colors duration-150","cursor-pointer"),"aria-label":"Drawing options",title:"Drawing options","data-test":"draw-mode-marker-caret-button",children:t.jsx(nn,{className:"h-3 w-3 text-foreground/60"})})]}),t.jsx(_e,{isVisible:e,onClose:()=>s(!1),title:"Drawing Options",initialPosition:n??{x:100,y:100},showPinButton:!1,showInspectorButton:!1,children:t.jsx("div",{className:"p-3 space-y-4","data-test":"draw-mode-options-popover-content",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Axis Lock"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lock drawing to a straight line"}),t.jsxs("div",{className:"space-y-2 mt-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"lock-horizontal",checked:u==="horizontal",onCheckedChange:b,"data-test":"draw-mode-lock-horizontal-checkbox"}),t.jsx(Te,{htmlFor:"lock-horizontal",className:"text-sm font-normal cursor-pointer",children:"Lock Horizontal (constant Y)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"lock-vertical",checked:u==="vertical",onCheckedChange:S,"data-test":"draw-mode-lock-vertical-checkbox"}),t.jsx(Te,{htmlFor:"lock-vertical",className:"text-sm font-normal cursor-pointer",children:"Lock Vertical (constant X)"})]})]})]})})})]})},NN=e=>{const{className:s}=e,{setMode:n,undo:o}=E.getState(),r=F(u=>u.undo.canUndo()),a=F(u=>u.undo.canRedo()),i=()=>{E.getState().setUiState(u=>({...u,selectFromDrawMode:!1})),n(Q.SELECT)},c=()=>{o.undo()},l=()=>{o.redo()};return t.jsxs(sa,{position:"left",className:s,children:[t.jsx(ee,{variant:"outline",size:"icon",onPointerUp:i,title:"Exit Draw Mode (Esc)","data-test":"draw-mode-exit-button",children:t.jsx($e,{className:"h-5 w-5"})}),t.jsx(pN,{}),t.jsx(gN,{}),t.jsx(mN,{}),t.jsx(wN,{}),t.jsx(vN,{}),t.jsx(bN,{}),t.jsx(zn,{expandContent:t.jsx(Ho,{onSelect:u=>o.jumpTo(u)}),expandTitle:"History",onClick:c,onHoldRepeat:c,holdRepeatInterval:J.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!r,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"draw-mode-undo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(Hh,{className:"h-5 w-5"})}),t.jsx(zn,{expandContent:t.jsx(Ho,{onSelect:u=>o.jumpTo(u)}),expandTitle:"History",onClick:l,onHoldRepeat:l,holdRepeatInterval:J.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!a,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"draw-mode-redo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(Bh,{className:"h-5 w-5"})})]})},SN=Ie.memo(NN),bc="paper-texture-live-config",CN="paper-texture-saved-presets";function jN({onTextureChange:e}){return t.jsx(rn,{popoverId:"paper-texture-config",icon:zh,tooltip:"Paper Texture Live Preview",popoverTitle:"Paper Texture",initialSize:{width:320,height:420},leftOffset:120,buttonVariant:"ghost",buttonSize:"icon",dataTest:"paper-texture-config-button",popoverContent:t.jsx(kN,{onTextureChange:e})})}function kN({onTextureChange:e}){const[s,n]=p.useState(()=>{try{const a=localStorage.getItem(bc);if(a)return JSON.parse(a)}catch{}return{params:_c.medium,activePreset:"medium"}}),[o,r]=p.useState(()=>{var i,c,l;const a=(l=(c=(i=E.getState().preferences)==null?void 0:i.canvasConfig)==null?void 0:c.background)==null?void 0:l.savedPresets;if(a&&a.length>0)return a;try{const d=localStorage.getItem(CN);if(d){const u=JSON.parse(d);return u.length>0&&E.setState(h=>{var f,g,w;return{...h,preferences:{...h.preferences,canvasConfig:{...(f=h.preferences)==null?void 0:f.canvasConfig,background:{...(w=(g=h.preferences)==null?void 0:g.canvasConfig)==null?void 0:w.background,savedPresets:u}}}}}),u}}catch{}return J.background.savedPresets});return p.useEffect(()=>{localStorage.setItem(bc,JSON.stringify(s))},[s]),p.useEffect(()=>{E.setState(a=>{var i,c,l;return{...a,preferences:{...a.preferences,canvasConfig:{...(i=a.preferences)==null?void 0:i.canvasConfig,background:{...(l=(c=a.preferences)==null?void 0:c.canvasConfig)==null?void 0:l.background,savedPresets:o}}}}}),J.background.savedPresets=o},[o]),t.jsx(AN,{config:s,setConfig:n,savedPresets:o,setSavedPresets:r,onTextureChange:e})}function AN({config:e,setConfig:s,savedPresets:n,setSavedPresets:o,onTextureChange:r}){const{params:a,activePreset:i}=e,[c,l]=p.useState(null),[d,u]=p.useState(""),{theme:h}=Vc(),f=p.useMemo(()=>h==="dark"?!0:h==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[h]),g=100-a.bgLightness;p.useEffect(()=>{E.setState(C=>{var k;return{...C,preferences:{...C.preferences,canvasConfig:{...(k=C.preferences)==null?void 0:k.canvasConfig,background:{paperTexture:typeof i=="string"&&!co.includes(i)?"custom":i,customParams:a}}}}}),J.background.paperTexture=typeof i=="string"&&!co.includes(i)?"custom":i,J.background.customParams=a},[a,i]);const w=(C,k)=>{s(R=>({...R,params:{...R.params,[C]:k},activePreset:"custom"}))},m=C=>{C!=="custom"&&(s({params:_c[C],activePreset:C}),r==null||r(C))},x=C=>{s({params:C.params,activePreset:C.id})},y=()=>{m("none")},v=()=>{const C={id:`preset-${Date.now()}`,name:`Preset ${n.length+1}`,params:{...a}};o(k=>[...k,C]),s(k=>({...k,activePreset:C.id}))},N=C=>{o(k=>k.filter(R=>R.id!==C)),i===C&&m("none")},b=C=>{l(C.id),u(C.name)},S=()=>{c&&d.trim()&&o(C=>C.map(k=>k.id===c?{...k,name:d.trim()}:k)),l(null),u("")},I=()=>{l(null),u("")};return t.jsxs("div",{className:"texture-config space-y-4 p-4","data-test":"texture-config",children:[t.jsxs("div",{className:"presets","data-test":"texture-presets",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx(Te,{className:"text-xs text-muted-foreground uppercase",children:"Presets"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:v,"data-test":"save-preset",children:[t.jsx(Qt,{className:"w-3 h-3 mr-1"}),"Save"]}),t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:y,"data-test":"reset-texture",children:[t.jsx(Xo,{className:"w-3 h-3 mr-1"}),"Reset"]})]})]}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:co.filter(C=>C!=="custom").map(C=>t.jsx(ee,{variant:i===C?"default":"outline",size:"sm",className:"h-7 text-xs",onClick:()=>m(C),"data-test":"paper-texture-preset-button",children:Uc[C]},C))})]}),n.length>0&&t.jsxs("div",{className:"saved-presets","data-test":"saved-presets",children:[t.jsx(Te,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Saved"}),t.jsx("div",{className:"space-y-1",children:n.map(C=>t.jsx("div",{className:"flex items-center gap-1","data-test":"paper-texture-saved-preset",children:c===C.id?t.jsxs(t.Fragment,{children:[t.jsx(Re,{value:d,onChange:k=>u(k.target.value),className:"h-7 text-xs flex-1",onKeyDown:k=>{k.key==="Enter"&&S(),k.key==="Escape"&&I()},autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:S,"data-test":"save-preset-name",children:t.jsx(Ys,{className:"w-3 h-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:I,"data-test":"cancel-edit",children:t.jsx($e,{className:"w-3 h-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:i===C.id?"default":"outline",size:"sm",className:"h-7 text-xs flex-1 justify-start",onClick:()=>x(C),"data-test":"load-saved-preset",children:C.name}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>b(C),"data-test":"edit-preset",children:t.jsx(fl,{className:"w-3 h-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:()=>N(C.id),"data-test":"delete-preset",children:t.jsx(vt,{className:"w-3 h-3"})})]})},C.id))})]}),t.jsxs("div",{className:"controls space-y-3","data-test":"texture-controls",children:[t.jsx(Te,{className:"text-xs text-muted-foreground uppercase",children:"Texture"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-frequency",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Te,{className:"text-xs",children:"Frequency"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.baseFrequency.toFixed(2)})]}),t.jsx(Kt,{value:[a.baseFrequency],onValueChange:([C])=>w("baseFrequency",C),min:.1,max:2,step:.05})]}),t.jsxs("div",{className:"control-group","data-test":"control-octaves",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Te,{className:"text-xs",children:"Octaves"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.numOctaves})]}),t.jsx(Kt,{value:[a.numOctaves],onValueChange:([C])=>w("numOctaves",C),min:1,max:6,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-opacity",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Te,{className:"text-xs",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[(a.opacity*100).toFixed(0),"%"]})]}),t.jsx(Kt,{value:[a.opacity],onValueChange:([C])=>w("opacity",C),min:0,max:.8,step:.05})]})]})]}),t.jsxs("div",{className:"bg-controls space-y-3","data-test":"bg-controls",children:[t.jsx(Te,{className:"text-xs text-muted-foreground uppercase",children:"Background"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-hue",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Te,{className:"text-xs",children:"Hue"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgHue,"°"]})]}),t.jsx(Kt,{value:[a.bgHue],onValueChange:([C])=>w("bgHue",C),min:0,max:360,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-saturation",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Te,{className:"text-xs",children:"Saturation"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgSaturation,"%"]})]}),t.jsx(Kt,{value:[a.bgSaturation],onValueChange:([C])=>w("bgSaturation",C),min:0,max:100,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-lightness",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Te,{className:"text-xs",children:"Lightness"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgLightness,"%"]})]}),t.jsx(Kt,{value:[a.bgLightness],onValueChange:([C])=>w("bgLightness",C),min:0,max:100,step:1})]})]})]}),t.jsxs("div",{className:"preview","data-test":"texture-preview",children:[t.jsx(Te,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Preview"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{className:"relative","data-test":"preview-light",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(_h,{className:`w-3 h-3 ${f?"text-muted-foreground":"text-primary"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${f?"":"ring-2 ring-primary"}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${a.bgLightness}%)`},"data-test":"preview-swatch-light",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-light"})})]}),t.jsxs("div",{className:"relative","data-test":"preview-dark",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(Vh,{className:`w-3 h-3 ${f?"text-primary":"text-muted-foreground"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${f?"ring-2 ring-primary":""}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${g}%)`},"data-test":"preview-swatch-dark",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-dark"})})]})]})]})]})}function Nc({title:e,action:s,isOpen:n}){return t.jsxs("div",{"data-test":"settings-section-header",className:"border-b pb-1 mb-3 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(jt,{className:ve("h-3 w-3 text-muted-foreground transition-transform",!n&&"-rotate-90")}),t.jsx("h3",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:e})]}),s]})}function IN(){var C;const[e,s]=p.useState(""),[n,o]=p.useState(new Set),r=k=>{o(R=>{const A=new Set(R);return A.has(k)?A.delete(k):A.add(k),A})},a=F(k=>{var R,A;return((A=(R=k.preferences)==null?void 0:R.arrangeButton)==null?void 0:A.nodeGap)??Ne.ARRANGE_NODE_GAP}),i=F(k=>{var R,A;return((A=(R=k.preferences)==null?void 0:R.arrangeButton)==null?void 0:A.gridColumns)??Ne.ARRANGE_GRID_COLUMNS}),c=F(k=>k.getArrangeGridRows()),l=F(k=>k.setArrangeNodeGap),d=F(k=>k.setArrangeGridColumns),u=F(k=>k.setArrangeGridRows),h=async k=>{J.persistState=!!k.persistState,J.autosave=!!k.autosave,J.hideOverlay=!!k.hideOverlay,J.hideToolbar=!!k.hideToolbar,J.background.paperTexture=k.backgroundPaperTexture,J.arrows.type=k.arrowType,J.arrows.REVERSE_CURVE=!!k.arrowReverseCurve,J.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=Number(k.arrowSShapeFactor),J.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=!!k.arrowSShapeReversed,J.arrows.CUBIC_HORIZONTAL_BIAS=Number(k.arrowHorizontalBias),J.arrows.reverseArrowOnMultipleConnect=!!k.arrowReverseOnMultipleConnect,J.highlightAndCreate.createConnectingArrow=!!k.highlightCreateArrow,J.highlightAndCreate.createHighlight=!!k.highlightCreateHighlight,J.nodeOptions.maxNodeWidth=Number(k.nodeMaxWidth),J.nodeOptions.resizeBorderWidth=Number(k.nodeResizeBorderWidth),J.zoom.min=Number(k.zoomMin),J.zoom.max=Number(k.zoomMax),J.zoom.intensity=Number(k.zoomIntensity),J.history.historyLimit=Number(k.historyLimit),J.history.tabletHistoryLimit=Number(k.tabletHistoryLimit),J.history.archiveLimit=Number(k.archiveLimit),J.history.tabletArchiveLimit=Number(k.tabletArchiveLimit),J.holdToSelect.holdDurationMs=Number(k.holdDurationMs),J.holdToSelect.movementThresholdPx=Number(k.holdMovementThresholdPx),J.holdToSelect.indicatorDelayMs=Number(k.holdIndicatorDelayMs),J.holdToSelect.indicatorTopOffset=Number(k.holdIndicatorTopOffset),J.holdToSelect.indicatorBottomOffset=Number(k.holdIndicatorBottomOffset),E.setState(R=>{var A,T,O;return{...R,preferences:{...R.preferences,splitNodeGap:Number(k.splitNodeGap),canvasConfig:{...(A=R.preferences)==null?void 0:A.canvasConfig,persistState:!!k.persistState,autosave:!!k.autosave,hideOverlay:!!k.hideOverlay,hideToolbar:!!k.hideToolbar,background:{...(O=(T=R.preferences)==null?void 0:T.canvasConfig)==null?void 0:O.background,paperTexture:k.backgroundPaperTexture},arrows:{type:k.arrowType,REVERSE_CURVE:!!k.arrowReverseCurve,CUBIC_ARROW_S_SHAPE_FACTOR:Number(k.arrowSShapeFactor),CUBIC_ARROW_S_SHAPE_REVERSED:!!k.arrowSShapeReversed,CUBIC_HORIZONTAL_BIAS:Number(k.arrowHorizontalBias),reverseArrowOnMultipleConnect:!!k.arrowReverseOnMultipleConnect},nodeOptions:{maxNodeWidth:Number(k.nodeMaxWidth),resizeBorderWidth:Number(k.nodeResizeBorderWidth)},zoom:{min:Number(k.zoomMin),max:Number(k.zoomMax),intensity:Number(k.zoomIntensity)}}},uiState:{...R.uiState,isOverlayVisible:!k.hideOverlay,toolbar:{...R.uiState.toolbar,isVisible:!k.hideToolbar}}}}),be.success("Settings saved!",{description:"Canvas configuration has been updated.",duration:3e3})},f=[{title:"Persistence",fields:[{name:"persistState",label:"Persist State",type:"checkbox"},{name:"autosave",label:"Autosave",type:"checkbox"}]},{title:"UI",fields:[{name:"hideOverlay",label:"Hide Overlay",type:"checkbox"},{name:"hideToolbar",label:"Hide Toolbar",type:"checkbox"}]},{title:"Background",fields:[{name:"backgroundPaperTexture",label:"Paper Texture",type:"select",options:co.map(k=>({value:k,label:Uc[k]}))}]},{title:"Highlight & Create ($)",fields:[{name:"highlightCreateArrow",label:"Create Connecting Arrow",type:"checkbox"},{name:"highlightCreateHighlight",label:"Create Highlight",type:"checkbox"}]},{title:"Arrows",fields:[{name:"arrowType",label:"Type",type:"select",options:uu.map(k=>({value:k,label:hu[k]}))},{name:"arrowSShapeFactor",label:"S-Shape Factor",type:"number",placeholder:"0-2",step:.1},{name:"arrowHorizontalBias",label:"Horizontal Bias",type:"number",placeholder:"0=auto, 1=none",step:.1},{name:"arrowReverseCurve",label:"Reverse Curve",type:"checkbox"},{name:"arrowSShapeReversed",label:"S-Shape Reversed",type:"checkbox"},{name:"arrowReverseOnMultipleConnect",label:"Reverse on Multiple Connect",type:"checkbox"}]},{title:"Nodes",fields:[{name:"nodeMaxWidth",label:"Max Width (px)",type:"number",placeholder:"100-2000"},{name:"nodeResizeBorderWidth",label:"Resize Border Width (px)",type:"number",placeholder:"1-50"},{name:"splitNodeGap",label:"Split Node Gap (px)",type:"number",placeholder:"0-100"}]},{title:"Zoom",fields:[{name:"zoomMin",label:"Min",type:"number",placeholder:"0.01-1"},{name:"zoomMax",label:"Max",type:"number",placeholder:"1-10"},{name:"zoomIntensity",label:"Intensity",type:"number",placeholder:"0.01-1"}]},{title:"Hold-to-Select (Phone)",fields:[{name:"holdDurationMs",label:"Hold Duration (ms)",type:"number",placeholder:"500-3000"},{name:"holdMovementThresholdPx",label:"Movement Threshold (px)",type:"number",placeholder:"5-50"},{name:"holdIndicatorDelayMs",label:"Indicator Delay (ms)",type:"number",placeholder:"0-500"},{name:"holdIndicatorTopOffset",label:"Indicator Top Offset (px)",type:"number",placeholder:"0-100"},{name:"holdIndicatorBottomOffset",label:"Indicator Bottom Offset (px)",type:"number",placeholder:"0-150"}]}],[g,w]=p.useState(!1);p.useEffect(()=>{const k=()=>w(window.innerWidth<1280);return k(),window.addEventListener("resize",k),()=>window.removeEventListener("resize",k)},[]);const m={title:"History",fields:g?[{name:"tabletHistoryLimit",label:"In-Memory Limit",type:"number",placeholder:"10-200"},{name:"tabletArchiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-1000"}]:[{name:"historyLimit",label:"In-Memory Limit",type:"number",placeholder:"10-500"},{name:"archiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-2000"}]},x=[...f,m],y=p.useMemo(()=>{const k=x.map(R=>R.title);return k.push("Arrange"),k},[x]),v=()=>o(new Set(y)),N=()=>o(new Set),b=p.useMemo(()=>{if(!e.trim())return x;const k=e.toLowerCase();return x.filter(R=>R.title.toLowerCase().includes(k))},[x,e]),S=p.useMemo(()=>e.trim()?"arrange".includes(e.toLowerCase()):!0,[e]),I={persistState:J.persistState,autosave:J.autosave,hideOverlay:J.hideOverlay,hideToolbar:J.hideToolbar,backgroundPaperTexture:J.background.paperTexture,highlightCreateArrow:J.highlightAndCreate.createConnectingArrow,highlightCreateHighlight:J.highlightAndCreate.createHighlight,arrowType:J.arrows.type,arrowReverseCurve:J.arrows.REVERSE_CURVE,arrowSShapeFactor:J.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,arrowSShapeReversed:J.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,arrowHorizontalBias:J.arrows.CUBIC_HORIZONTAL_BIAS,arrowReverseOnMultipleConnect:J.arrows.reverseArrowOnMultipleConnect,nodeMaxWidth:J.nodeOptions.maxNodeWidth,nodeResizeBorderWidth:J.nodeOptions.resizeBorderWidth,splitNodeGap:((C=E.getState().preferences)==null?void 0:C.splitNodeGap)??Ne.NEW_NODE_SEGMENT_SPACING,zoomMin:J.zoom.min,zoomMax:J.zoom.max,zoomIntensity:J.zoom.intensity,historyLimit:J.history.historyLimit,tabletHistoryLimit:J.history.tabletHistoryLimit,archiveLimit:J.history.archiveLimit,tabletArchiveLimit:J.history.tabletArchiveLimit,holdDurationMs:J.holdToSelect.holdDurationMs,holdMovementThresholdPx:J.holdToSelect.movementThresholdPx,holdIndicatorDelayMs:J.holdToSelect.indicatorDelayMs,holdIndicatorTopOffset:J.holdToSelect.indicatorTopOffset,holdIndicatorBottomOffset:J.holdToSelect.indicatorBottomOffset};return t.jsxs(Gs,{className:"h-full",children:[t.jsx("div",{className:"sticky top-0 z-10 bg-background p-3 pb-2 border-b","data-test":"settings-search-header",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(Ss,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),t.jsx(Re,{type:"text",placeholder:"Search settings...",value:e,onChange:k=>s(k.target.value),className:"h-7 pl-7 text-xs","data-test":"settings-search-input"})]}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:N,title:"Expand all sections","data-test":"settings-expand-all-button",children:t.jsx(Uh,{className:"h-4 w-4"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:v,title:"Collapse all sections","data-test":"settings-collapse-all-button",children:t.jsx(Gh,{className:"h-4 w-4"})})]})}),t.jsxs(Np,{onSubmit:h,defaultValues:I,className:"p-3 space-y-4",formId:"canvas-settings-form",children:[b.map(k=>{const R=!n.has(k.title);return t.jsxs(ps,{open:R,onOpenChange:()=>r(k.title),"data-test":"settings-section-collapsible",children:[t.jsx(gs,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:A=>{A.altKey&&(A.preventDefault(),v())},children:t.jsx(Nc,{title:k.title,action:k.title==="Background"?t.jsx(jN,{}):void 0,isOpen:R})})}),t.jsx(fs,{children:t.jsx(Sp,{fields:k.fields,layout:"two-column",className:"space-y-2",labelClassName:"text-xs"})})]},k.title)}),S&&t.jsxs(ps,{open:!n.has("Arrange"),onOpenChange:()=>r("Arrange"),"data-test":"settings-section-arrange",children:[t.jsx(gs,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:k=>{k.altKey&&(k.preventDefault(),v())},children:t.jsx(Nc,{title:"Arrange",isOpen:!n.has("Arrange")})})}),t.jsx(fs,{children:t.jsx(Nr,{nodeGap:a,gridColumns:i,gridRows:c,onNodeGapChange:l,onGridColumnsChange:d,onGridRowsChange:u,showRows:!0})})]})]})]})}const TN=()=>{const e=E.getState(),s=e.exportCanvasData,n=e.importCanvasData,o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(!1),[l,d]=p.useState(null),u=()=>{var f;(f=o.current)==null||f.click()},h=f=>{var m;const g=(m=f.target.files)==null?void 0:m[0];if(!g)return;a(!0),d(null);const w=new FileReader;w.onload=x=>{var v;const y=(v=x.target)==null?void 0:v.result;if(typeof y=="string"){const N=n(y,{replace:i});d(N),N.projectsImported>0&&be.success(`Successfully imported ${N.projectsImported} project${N.projectsImported>1?"s":""}`),N.projectsSkipped>0&&be.warning(`Skipped ${N.projectsSkipped} project${N.projectsSkipped>1?"s":""} (already exist)`),N.projectsImported===0&&N.projectsSkipped===0&&be.error("No projects found in the import file")}else console.error("Failed to read file content."),be.error("Failed to read file content");a(!1),o.current&&(o.current.value="")},w.onerror=x=>{console.error("Error reading file:",x),be.error("Error reading file"),a(!1),o.current&&(o.current.value="")},w.readAsText(g)};return t.jsxs("div",{className:"space-y-4","data-test":"data-io-panel",children:[t.jsxs("div",{"data-test":"data-export-section",children:[t.jsx(Te,{className:"text-sm font-medium",children:"Export"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download all canvas projects as JSON"}),t.jsxs(ee,{variant:"outline",size:"sm",onClick:s,className:"w-full","data-test":"canvas-export-button",children:[t.jsx(Yh,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),t.jsxs("div",{"data-test":"data-import-section",children:[t.jsx(Te,{className:"text-sm font-medium",children:"Import"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import canvas projects from a JSON file"}),t.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"canvas-replace-mode-control",children:[t.jsxs("div",{children:[t.jsx(Te,{htmlFor:"canvas-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),t.jsx(So,{id:"canvas-replace-mode",checked:i,onCheckedChange:c,disabled:r,"data-test":"canvas-replace-mode-switch"})]}),t.jsxs(ee,{variant:"outline",size:"sm",onClick:u,disabled:r,className:"w-full","data-test":"canvas-import-select-file-button",children:[t.jsx(Kh,{className:"h-4 w-4 mr-2"}),r?"Importing...":"Select File"]}),t.jsx("input",{type:"file",ref:o,accept:".json",style:{display:"none"},onChange:h,"data-test":"canvas-import-file-input"})]}),l&&t.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"canvas-import-result",children:[l.projectsImported>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"canvas-imported-count",children:[t.jsx(Wa,{className:"h-3 w-3"}),t.jsxs("span",{children:["Imported: ",l.projectsImported]})]}),l.projectsSkipped>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-yellow-600","data-test":"canvas-skipped-count",children:[t.jsx(jo,{className:"h-3 w-3"}),t.jsxs("span",{children:["Skipped: ",l.projectsSkipped]})]}),l.projectsImported===0&&l.projectsSkipped===0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"canvas-no-projects",children:[t.jsx(jo,{className:"h-3 w-3"}),t.jsx("span",{children:"No projects found"})]})]})]})},EN=()=>t.jsx(Uo,{storageKey:"canvas-data-io",title:"Data Import/Export",icon:t.jsx(Kc,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end",children:t.jsx(TN,{})}),Pa=Object.values(mu).map(e=>({value:e,label:xu[e]})),RN=()=>{const[e,s]=p.useState(()=>{var i;return((i=ln.getState().ui)==null?void 0:i.keyboardLanguage)??sr}),[n,o]=p.useState(()=>{var c;const i=(c=ln.getState().ui)==null?void 0:c.enabledKeyboardLanguages;return Array.isArray(i)&&i.length>0?i:pu}),r=()=>{var u;if(n.length<=1)return;const i=n.indexOf(e),c=i===-1?0:(i+1)%n.length,l=n[c];s(l),ln.update("ui",{keyboardLanguage:l});const d=((u=Pa.find(h=>h.value===l))==null?void 0:u.label)??l;be(`${fu[l]} Keyboard: ${d}`,{duration:1500})},a=(i,c)=>{let l;if(c)l=Pa.map(d=>d.value).filter(d=>n.includes(d)||d===i);else{if(n.length<=1)return;l=n.filter(d=>d!==i)}if(o(l),ln.update("ui",{enabledKeyboardLanguages:l}),!l.includes(e)){const d=l[0];s(d),ln.update("ui",{keyboardLanguage:d})}};return t.jsx(gu,{label:t.jsx(Xh,{className:"h-5 w-5"}),onAction:r,variant:"outline",size:"icon",tooltipText:`${ia[e]} - Click to cycle, hold for settings`,popoverContent:t.jsxs("div",{className:"space-y-3 p-1","data-test":"keyboard-language-panel",children:[t.jsx(Te,{className:"text-sm font-medium",children:"Languages to cycle"}),t.jsx("div",{className:"space-y-2",children:Pa.map(i=>{const c=n.includes(i.value),l=n.length===1&&c;return t.jsxs("div",{className:"flex items-center space-x-2","data-test":"keyboard-language-option",children:[t.jsx(We,{id:`lang-${i.value}`,checked:c,onCheckedChange:d=>a(i.value,!!d),disabled:l}),t.jsx(Te,{htmlFor:`lang-${i.value}`,className:`cursor-pointer ${l?"opacity-50":""}`,children:i.label})]},i.value)})}),t.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t","data-test":"current-language-indicator",children:["Current: ",t.jsx("span",{className:"font-medium",children:ia[e]}),n.length>1&&t.jsxs("span",{className:"ml-1",children:["(cycling ",n.map(i=>ia[i]).join(" → "),")"]})]})]})})},MN=[],PN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState("move"),[r,a]=p.useState(null),i=p.useRef(null),c=F(x=>{var y;return((y=x.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??MN}),l=F(x=>{var y;return(y=x.projectCanvas.getActive())==null?void 0:y.id}),d=F(x=>x.copyNodesToCanvas),u=F(x=>x.moveNodesToCanvas),h=c.length===0,f=()=>{if(!h){if(i.current){const x=i.current.getBoundingClientRect();a({x:x.left-320-16,y:Math.max(16,x.top+x.height/2-400/2)})}s(!0)}},g=x=>{const y=c.map(N=>N.id),v={nodeIds:y,targetCanvasId:x.canvasId,targetWorkspaceId:x.workspaceId,targetProjectId:x.projectId};n==="copy"?(d(v),be.success(`Copied ${y.length} node${y.length>1?"s":""} to "${x.canvasName}"`)):(u(v),be.success(`Moved ${y.length} node${y.length>1?"s":""} to "${x.canvasName}"`)),s(!1)},w=()=>{s(!1)},m=t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-move-nodes-title",children:[t.jsx(ee,{variant:n==="move"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("move"),"data-test":"canvas-move-nodes-move-option",children:"Move"}),t.jsx(ee,{variant:n==="copy"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("copy"),"data-test":"canvas-move-nodes-copy-option",children:"Copy"}),t.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:[c.length," node",c.length!==1?"s":""]})]});return t.jsxs(t.Fragment,{children:[t.jsx(Jt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(ee,{ref:i,variant:"outline",size:"icon",disabled:h,onClick:f,"data-test":"canvas-move-nodes-button",title:"Move/copy nodes",children:t.jsx(qh,{className:"h-5 w-5"})})}),t.jsx(Bt,{children:t.jsx("p",{children:h?"Select nodes to move/copy":"Move/copy nodes to canvas"})})]})}),t.jsx(Sd,{onCanvasSelected:g,excludeCanvasId:l,selectionModeTitle:m,isOpen:e,onClose:w,popoverPosition:r})]})};class DN{constructor(s){Fe(this,"namespace","canvas.collapse");this.hooks=s}getActions(){return[{id:"collapse:all",label:"Collapse all nodes",category:"Collapse",icon:t.jsx(Ao,{className:"h-3 w-3"})},{id:"expand:all",label:"Expand all nodes",category:"Collapse",icon:t.jsx(Mn,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"collapse:all":this.hooks.collapseAll();break;case"expand:all":this.hooks.expandAll();break;default:console.warn(`CollapseFacade: Unknown action "${s}"`)}}}function ON(){const e=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed||r.updateNode(c.id,{isCollapsed:!0})})},[]),s=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed&&r.updateNode(c.id,{isCollapsed:!1})})},[]),n=p.useMemo(()=>({collapseAll:e,expandAll:s}),[e,s]),o=p.useMemo(()=>new DN(n),[n]);return p.useEffect(()=>(it.register("collapse",{name:"Collapse",getActions:()=>o.getActions()}),rt.register("collapse",o),()=>{it.unregister("collapse"),rt.unregister("collapse")}),[o]),o}const LN=[],WN=10,HN={content:!0,title:!0,id:!1,type:!1,tags:!1},BN=e=>{if(e.title)return e.title;if(typeof e.content=="string"){const s=e.content.split(`
`)[0];return s.length>50?s.substring(0,50)+"...":s||"(empty)"}return"(empty)"},FN=(e,s,n,o)=>{if(!s.trim())return!0;const r=n?s:s.toLowerCase(),a=i=>i?(n?i:i.toLowerCase()).includes(r):!1;if(o.content&&typeof e.content=="string"&&a(e.content)||o.title&&a(e.title)||o.id&&a(e.id)||o.type&&a(e.type))return!0;if(o.tags&&e.tags&&e.tags.length>0){const i=e.tags.map(c=>typeof c=="string"?c:c.title).join(", ");if(a(i))return!0}return!1},$N=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),[r,a]=p.useState(""),[i,c]=p.useState(!1),[l,d]=p.useState(HN),[u,h]=p.useState(!1),[f,g]=p.useState([]),[w,m]=p.useState("nodes"),x=p.useRef(null),y=ON(),v=F(j=>{var P;return((P=j.projectCanvas.getActive())==null?void 0:P.coreState.nodes)??LN}),N=i||l.id||l.type||l.tags||!l.content||!l.title,b=p.useMemo(()=>r.trim()?Object.values(l).some(P=>P)?v.filter(P=>FN(P,r,i,l)):[]:v,[v,r,i,l]),S=p.useMemo(()=>v.filter(j=>j.isCollapsed).length,[v]),I=p.useMemo(()=>v.filter(j=>!j.isCollapsed).length,[v]),C=p.useMemo(()=>f.map(j=>v.find(P=>P.id===j)).filter(j=>j!==void 0).slice(0,5),[f,v]),k=()=>{if(x.current){const j=x.current.getBoundingClientRect();o({x:j.left-360-16,y:Math.max(16,j.top+j.height/2-450/2)})}s(!0)},R=()=>{s(!1),m("nodes")},A=p.useCallback(j=>{g(P=>{const W=P.filter(L=>L!==j);return[j,...W].slice(0,WN)})},[]),T=p.useCallback(j=>{const P=E.getState(),W=v.find(L=>L.id===j);W&&(P.updateNode(j,{isCollapsed:!W.isCollapsed}),A(j))},[v,A]),O=p.useCallback(()=>{if(r.trim()){const j=E.getState();b.forEach(P=>{P.isCollapsed||(j.updateNode(P.id,{isCollapsed:!0}),A(P.id))})}else y.execute("collapse:all")},[b,r,A,y]),$=p.useCallback(()=>{if(r.trim()){const j=E.getState();b.forEach(P=>{P.isCollapsed&&(j.updateNode(P.id,{isCollapsed:!1}),A(P.id))})}else y.execute("expand:all")},[b,r,A,y]),B=p.useCallback(j=>{Yn(j)},[]),H=w==="recent"?"Recent":t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-collapse-title",children:[t.jsxs(ee,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:O,"data-test":"canvas-collapse-all-button",children:[t.jsx(Ao,{className:"h-3 w-3 mr-1"}),"Collapse ",r.trim()?`(${b.length})`:"All"]}),t.jsxs(ee,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:$,"data-test":"canvas-expand-all-button",children:[t.jsx(Mn,{className:"h-3 w-3 mr-1"}),"Expand ",r.trim()?`(${b.length})`:"All"]})]}),M=w==="recent"?t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>m("nodes"),title:"Back to Nodes","data-test":"canvas-collapse-back-button",children:t.jsx(Xs,{className:"h-3.5 w-3.5"})}):t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>m("recent"),title:"Recent Collapse/Expand History","data-test":"canvas-collapse-recent-button",children:t.jsx(rs,{className:"h-3.5 w-3.5"})});return t.jsxs(t.Fragment,{children:[t.jsx(Jt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(ee,{ref:x,variant:"outline",size:"icon",onClick:k,"data-test":"canvas-collapse-button",title:"Collapse/expand nodes",children:t.jsx(Ao,{className:"h-5 w-5"})})}),t.jsx(Bt,{children:t.jsxs("p",{children:["Collapse/expand nodes (",S," collapsed, ",I," expanded)"]})})]})}),t.jsx(_e,{isVisible:e,onClose:R,title:H,triggerPosition:n??void 0,shouldCloseManually:!0,resizable:!0,initialSize:{width:360,height:450},headerActions:M,children:t.jsx("div",{className:"p-3 space-y-3","data-test":"canvas-collapse-popover-content",children:w==="nodes"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"canvas-collapse-search-section",children:[t.jsx(Ss,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"canvas-collapse-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search nodes...",value:r,onChange:j=>a(j.target.value),className:ve("h-8 text-sm pl-8",r?"pr-16":"pr-10"),autoFocus:!0,"data-test":"canvas-collapse-search-input"}),r&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>a(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"canvas-collapse-clear-button",children:t.jsx($e,{className:"h-3 w-3"})}),N&&t.jsx("div",{className:ve("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",r?"right-16":"right-11"),"data-test":"canvas-collapse-filter-indicator"}),t.jsxs(ct,{open:u,onOpenChange:h,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"canvas-collapse-settings-button",children:t.jsx(qo,{className:"h-3.5 w-3.5"})})}),t.jsx(dt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:Ee.draggablePopoverDropdown},"data-test":"canvas-collapse-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"collapse-case-sensitive",checked:i,onCheckedChange:j=>c(!!j),"data-test":"canvas-collapse-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"collapse-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsx("div",{className:"space-y-1.5",children:Object.entries({content:"Content",title:"Title",id:"ID",type:"Type",tags:"Tags"}).map(([j,P])=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:`collapse-node-${j}`,checked:l[j],onCheckedChange:W=>d(L=>({...L,[j]:!!W})),"data-test":"canvas-collapse-field-checkbox"}),t.jsx("label",{htmlFor:`collapse-node-${j}`,className:"text-sm cursor-pointer",children:P})]},j))})]})]})})]})]}),t.jsxs("div",{className:"stats-section flex items-center gap-2 text-xs text-muted-foreground","data-test":"canvas-collapse-stats",children:[t.jsxs(tt,{variant:"secondary","data-test":"canvas-collapse-collapsed-count",children:[S," collapsed"]}),t.jsxs(tt,{variant:"outline","data-test":"canvas-collapse-expanded-count",children:[I," expanded"]}),r.trim()&&t.jsxs("span",{"data-test":"canvas-collapse-filtered-count",children:["(",b.length," matching)"]})]}),t.jsxs("div",{className:"nodes-list-section space-y-1","data-test":"canvas-collapse-nodes-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:r.trim()?`Results (${b.length})`:`All Nodes (${v.length})`}),t.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1","data-test":"canvas-collapse-nodes-list",children:[b.map(j=>t.jsx(Sc,{node:j,onToggle:()=>T(j.id),onClick:()=>B(j)},j.id)),b.length===0&&r.trim()&&t.jsx("p",{className:"text-xs text-muted-foreground py-2 text-center","data-test":"canvas-collapse-no-results",children:"No nodes found"})]})]})]}):t.jsx("div",{className:"recent-view-section space-y-1","data-test":"canvas-collapse-recent-view",children:C.length>0?t.jsx("div",{className:"max-h-[350px] overflow-y-auto space-y-1","data-test":"canvas-collapse-recent-list",children:C.map(j=>t.jsx(Sc,{node:j,onToggle:()=>T(j.id),onClick:()=>B(j)},j.id))}):t.jsx("p",{className:"text-xs text-muted-foreground py-8 text-center","data-test":"canvas-collapse-recent-empty",children:"No recent collapse/expand history"})})})})]})},Sc=({node:e,onToggle:s,onClick:n})=>{const o=ta(e.type),r=BN(e),a=e.id.substring(0,6);return t.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded hover:bg-accent/50 group","data-test":"canvas-collapse-node-item",children:[t.jsx(ee,{variant:"ghost",size:"icon",className:"h-4 w-4 flex-shrink-0",onClick:i=>{i.stopPropagation(),s()},title:e.isCollapsed?"Expand":"Collapse","data-test":"canvas-collapse-toggle-button",children:e.isCollapsed?t.jsx(nn,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(jt,{className:"h-3.5 w-3.5"})}),t.jsxs("div",{className:"flex-1 flex items-center gap-1.5 cursor-pointer min-w-0",onClick:n,"data-test":"canvas-collapse-node-info",children:[o&&t.jsx("span",{className:"flex-shrink-0 text-muted-foreground",children:o}),t.jsx("span",{className:"text-xs truncate flex-1",children:r}),t.jsx("span",{className:"text-[10px] text-muted-foreground flex-shrink-0",children:a})]}),e.isCollapsed&&t.jsx(tt,{variant:"secondary",className:"text-[9px] px-1 py-0 h-4","data-test":"canvas-collapse-badge",children:"collapsed"})]})},Cc=[],zN=[],_N=({isVisible:e,onClose:s})=>{const n=F(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??Cc}),o=F(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.coreState.nodes)??Cc}),r=F(g=>{var w;return((w=g.projectCanvas.getActive())==null?void 0:w.coreState.arrows)??zN});F(g=>{var w;return(w=g.preferences)==null?void 0:w.canvasConfig});const a=F(g=>g.updateNode),i=n.length>0,c=p.useMemo(()=>i?Sl(r,n):r,[i,n,r]),l=p.useCallback(g=>Cl({includeConfig:g}),[]),d=p.useMemo(()=>{const g=Math.round(window.innerWidth*.85),w=Math.round(window.innerHeight*.85),m=Math.round((window.innerWidth-g)/2),x=Math.round((window.innerHeight-w)/2);return{initialSize:{width:g,height:w},triggerPosition:{x:m,y:x}}},[]),u=p.useCallback(g=>{const w=Array.isArray(g)?g:g.nodes;Array.isArray(w)&&w.forEach(m=>{m&&m.id&&a(m.id,m)})},[a]),h=c.length,f=i?`Selected Nodes (${n.length})${h>0?` + Arrows (${h})`:""}`:`All Canvas (${o.length} nodes, ${r.length} arrows)`;return t.jsx(Uo,{storageKey:"json-viewer-config",initialConfig:{includeCanvasConfig:!1},children:(g,w,m)=>{const x=l(g.includeCanvasConfig),y={nodes:[]},v=()=>{x&&jl(x)};return t.jsx(_e,{isVisible:e,onClose:s,title:f,resizable:!0,initialSize:d.initialSize,shouldCloseManually:!0,triggerPosition:d.triggerPosition,headerActions:t.jsxs("div",{className:"flex items-center gap-1","data-test":"json-viewer-header-actions",children:[t.jsx(m,{title:"JSON Viewer Settings",contentClassName:"w-64",contentStyle:{zIndex:Ee.draggablePopoverDropdown},children:t.jsxs("div",{className:"flex items-center space-x-2","data-test":"include-canvas-config-option",children:[t.jsx(We,{id:"includeCanvasConfig",checked:g.includeCanvasConfig,onCheckedChange:N=>w(b=>({...b,includeCanvasConfig:!!N})),"data-test":"include-canvas-config-checkbox"}),t.jsx(Te,{htmlFor:"includeCanvasConfig",className:"text-xs cursor-pointer",children:"Include Canvas configuration"})]})}),t.jsx("button",{type:"button",className:"p-1 rounded hover:bg-accent transition-colors",onClick:N=>{N.stopPropagation(),v()},onMouseDown:N=>N.stopPropagation(),"aria-label":"Copy JSON",title:"Copy","data-test":"json-viewer-copy-button",children:t.jsx(Pt,{size:14})})]}),children:t.jsx(xl,{data:x??y,onDataChange:u})})}})},VN=()=>{const[e,s]=p.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:"outline",size:"icon",onClick:()=>s(!0),"data-test":"canvas-json-viewer-button",title:"View JSON Data",children:t.jsx(Zo,{className:"h-5 w-5"})}),t.jsx(_N,{isVisible:e,onClose:()=>s(!1)})]})},UN=[],GN=()=>{const e=F(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.coreState.layers)??UN}),s=F(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.coreState.activeLayerId)??null}),n=F(m=>m.layer),o=p.useMemo(()=>e.length===0?[Gc()]:[...e].sort((m,x)=>x.order-m.order),[e]),r=p.useCallback((m,x,y)=>{m.stopPropagation(),n.setVisibility(x,!y)},[n]),a=p.useMemo(()=>o.map(m=>({id:m.id,label:m.name,icon:m.isLocked?t.jsx(ko,{className:"h-3 w-3 text-muted-foreground"}):t.jsx("button",{onClick:x=>r(x,m.id,m.isVisible),className:"hover:text-foreground transition-colors","data-test":"layer-visibility-toggle",title:m.isVisible?"Hide layer":"Show layer",children:m.isVisible?t.jsx(Zt,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"}):t.jsx(ws,{className:"h-3 w-3 text-muted-foreground/50 hover:text-foreground"})}),data:{type:"layer",...m}})),[o,r]),i=m=>{n.setActive(m.id)},c=(m,x)=>{n.rename(m,x)},l=m=>{n.delete(m)},d=m=>{const x=m.length;m.forEach((y,v)=>{const N=x-1-v;n.reorder(y.id,N)})},u=m=>`Delete layer "${m.label}"? Nodes will be moved to the layer below.`,h=m=>{const x=m.data;return x?[{id:"toggle-visibility",label:x.isVisible?"Hide Layer":"Show Layer",icon:x.isVisible?t.jsx(ws,{className:"h-4 w-4 mr-2"}):t.jsx(Zt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setVisibility(x.id,!x.isVisible)}},{id:"toggle-lock",label:x.isLocked?"Unlock Layer":"Lock Layer",icon:x.isLocked?t.jsx(gl,{className:"h-4 w-4 mr-2"}):t.jsx(ko,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setLocked(x.id,!x.isLocked)}},{id:"duplicate",label:"Duplicate Layer",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(x.id)}},{id:"merge-down",label:"Merge Down",icon:t.jsx(Jh,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.mergeDown(x.id)}}]:null},f=()=>{n.create()},g=p.useCallback((m,x)=>{n.setOpacity(m,x)},[n]),w=p.useCallback((m,x,y,v)=>{const N=m.data;return N?t.jsxs("div",{"data-test":"layer-item-with-opacity",children:[v,t.jsxs("div",{className:"flex items-center gap-1 px-2 py-0 mt-1 ml-8 opacity-50 hover:opacity-100 transition-opacity","data-test":"layer-opacity-row",children:[t.jsx(Zh,{className:"h-2 w-2 text-muted-foreground/60 flex-shrink-0"}),t.jsx(Kt,{value:[N.opacity],onValueChange:([b])=>g(m.id,b),min:0,max:100,step:1,className:"flex-1 [&>span:first-child]:h-0.5 [&>span:first-child>span]:bg-muted-foreground/40 [&_[role=slider]]:h-2 [&_[role=slider]]:w-2","data-test":"layer-opacity-slider"}),t.jsxs("span",{className:"text-[9px] text-muted-foreground/60 w-6 text-right","data-test":"layer-opacity-value",children:[N.opacity,"%"]})]})]}):v},[g]);return t.jsxs("div",{className:"layer-manager flex flex-col h-full","data-test":"canvas-layer-manager",children:[t.jsx(Gs,{className:"layer-list flex-1 min-h-0","data-test":"layer-list-scroll-area",children:t.jsx("div",{className:"layer-tree-container p-2","data-test":"layer-tree-container",children:t.jsx(qs,{data:a,onItemClick:i,onUpdate:c,onDelete:e.length>1?l:void 0,onReorder:d,selectedId:s,deleteConfirmMessage:u,enableEdit:!0,enableDelete:e.length>1,enableDrag:!0,moreOptionsItems:h,dropdownZIndex:Ee.draggablePopoverDropdown,renderNode:w})})}),t.jsx("div",{className:"layer-actions border-t p-2","data-test":"layer-actions",children:t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full",onClick:f,"data-test":"layer-add-button",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"}),"Add Layer"]})})]})},YN=180,KN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=()=>{if(e){s(!1);return}if(r.current){const i=r.current.getBoundingClientRect(),c=280,l=350,d=i.left+i.width/2,u=i.top+i.height/2;o({x:d-c/2-YN,y:u-l/2})}s(!0)};return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:r,variant:"secondary",size:"sm",tooltip:"Manage layers",onClick:a,className:"canvas-layer-button","data-test":"canvas-layer-button",children:t.jsx(sn,{className:"h-4 w-4"})}),t.jsx(_e,{isVisible:e,onClose:()=>s(!1),title:"Layers",resizable:!0,initialSize:{width:280,height:350},triggerPosition:n??void 0,children:t.jsx(GN,{})})]})},XN=({onSessionSelect:e})=>{const{sessions:s,loadingSessions:n,sessionsError:o,pagination:r,currentPage:a,searchSessions:i,refreshSessions:c,handlePageChange:l,handleLoadMore:d}=wu({loadOnMount:!1,subscribeToSSE:!1}),[u,h]=p.useState(null),[f,g]=p.useState(!1),{messages:w,sessionDetails:m,metadata:x,loading:y,pagination:v,loadOlderMessages:N,searchMessages:b,refreshSession:S,addOptimisticMessage:I,removeOptimisticMessage:C}=yu(u,{loadOnMount:!0,subscribeToSSE:!0}),k=400,R=-240,A=p.useMemo(()=>{const M=Math.round(window.innerWidth*.6),j=Math.round(window.innerHeight*.8),L=window.innerWidth-30+R-M,z=Math.round((window.innerHeight-j)/2);return{size:{width:M,height:j},position:{x:L,y:z}}},[R]),T=M=>{h(M),g(!0),e==null||e(M)},O=()=>{g(!1)},$=async(M,j)=>{try{const P=await Oa.searchMessages(M,j);console.log("Message search results:",P)}catch(P){console.error("Message search failed:",P)}},B=async(M,j)=>{await b(M,j)},H=t.jsx(Cp,{sessions:s,loading:n,error:o,onSessionSelect:T,selectedSessionId:u,onRefresh:c,pagination:r,currentPage:a,onPageChange:l,onLoadMore:d,onSearch:i,onMessageSearch:$});return t.jsxs(t.Fragment,{children:[t.jsx(rn,{popoverId:"claude-sessions",icon:Qh,tooltip:"Claude Sessions",popoverTitle:"Claude Sessions",popoverContent:H,initialSize:{width:k,height:600},leftOffset:R,resizable:!0,dataTest:"canvas-claude-session-button"}),t.jsx(_e,{isVisible:f,onClose:O,title:(m==null?void 0:m.customName)??(m==null?void 0:m.name)??"Chat",shouldCloseManually:!0,resizable:!0,initialSize:A.size,initialPosition:A.position,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"claude-chat-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-auto","data-test":"claude-chat-messages-area",children:t.jsx(vu,{messages:w,sessionDetails:m,metadata:x,loading:y,pagination:v,onLoadOlder:N,onSearch:B,onNameUpdated:S})}),u&&t.jsx("div",{className:"border-t p-2","data-test":"claude-chat-input-area",children:t.jsx(bu,{sessionId:u,onSendSuccess:()=>{S()},onAddOptimisticMessage:I,onRemoveOptimisticMessage:C})})]})})]})},qN=e=>{const{className:s}=e,{history:n,lastAction:o,executeLastAction:r,hasExecutor:a}=Sr(),i=o&&a(o.executorId),c=p.useCallback(()=>{i&&r()},[i,r]),l=n.length>0;return t.jsx(zn,{expandTitle:"Actions & Presets",expandContent:t.jsx(sd,{}),onClick:c,disabled:!l,variant:"outline",size:"icon",className:s,popoverSize:{width:300,height:380},title:o?`Repeat: ${o.label}`:"No action to repeat",dataTest:"canvas-repeat-action-button",headerActions:t.jsx(nd,{}),children:t.jsx(Xo,{className:"h-5 w-5"})})},jc=380,kc=360,Ac=e=>{const{className:s}=e,[n,o]=p.useState(!1),[r,a]=p.useState(void 0),i=F(d=>d.setActiveGlobalOverlay),c=()=>{i(ms.STUDY)},l=d=>{const u=d.currentTarget.getBoundingClientRect();a({x:u.left-kc-16,y:(window.innerHeight-jc)/2}),o(!0)};return t.jsxs(t.Fragment,{children:[t.jsxs(sa,{position:"right",className:s,children:[t.jsx(RN,{}),t.jsx(VN,{}),t.jsx(PN,{}),t.jsx($N,{}),t.jsx(KN,{}),t.jsx(XN,{}),t.jsx(EN,{}),t.jsx(qN,{}),t.jsx(ee,{variant:"outline",size:"icon",onClick:c,title:"Enter Study Mode","data-test":"mobile-right-toolbar-study-mode",children:t.jsx(ep,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:l,"data-test":"mobile-right-toolbar-settings",title:"Settings",children:t.jsx(Vn,{className:"h-5 w-5"})})]}),t.jsx(_e,{isVisible:n,onClose:()=>o(!1),title:"Canvas Settings",resizable:!0,initialSize:{width:kc,height:jc},shouldCloseManually:!0,triggerPosition:r,headerActions:t.jsx("button",{type:"submit",form:"canvas-settings-form",className:"p-1 rounded hover:bg-accent transition-colors",onClick:d=>d.stopPropagation(),onMouseDown:d=>d.stopPropagation(),"aria-label":"Save settings",title:"Save","data-test":"canvas-settings-save-button",children:t.jsx(Qt,{size:14})}),children:t.jsx(IN,{})})]})},ZN=e=>{const{className:s}=e,n=F(c=>c.setActiveGlobalOverlay),o=()=>{n(ms.NONE)},r=()=>{console.log("Previous card")},a=()=>{console.log("Next card")},i=()=>{console.log("Flip card")};return t.jsxs(sa,{position:"right",className:s,children:[t.jsx(ee,{variant:"outline",size:"icon",onClick:o,title:"Exit Study Mode","data-test":"study-mode-exit-button",children:t.jsx($e,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:r,title:"Previous Card","data-test":"study-mode-prev-button",children:t.jsx(tp,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:a,title:"Next Card","data-test":"study-mode-next-button",children:t.jsx(nn,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:i,title:"Flip Card","data-test":"study-mode-flip-button",children:t.jsx(sp,{className:"h-5 w-5"})})]})},JN=()=>{switch(F(s=>s.uiState.activeGlobalOverlay)){case ms.STUDY:return{right:t.jsx(ZN,{})};case ms.PAIRING:return{right:t.jsx(Ac,{})};case ms.NONE:default:return{right:t.jsx(Ac,{})}}},QN=5,Ic=[];function eS({items:e,onSelect:s,placeholder:n="Search...",getGroup:o,storageKey:r,maxRecentItems:a=QN,enablePinning:i=!1,openShortcut:c,repeatLastShortcut:l,renderItem:d,renderEmpty:u,open:h,onOpenChange:f}){const[g,w]=p.useState(!1),m=h!==void 0,x=m?h:g,y=p.useCallback(V=>{m||w(V),f==null||f(V)},[m,f]),[v,N]=p.useState(""),[b,S]=p.useState(""),I=`${r}-recently-used`,C=`${r}-search-options`,[k,R]=p.useState(()=>{try{const V=localStorage.getItem(I);return V?JSON.parse(V):[]}catch{return[]}}),[A,T]=p.useState(()=>{try{const V=localStorage.getItem(C);return V?JSON.parse(V):{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}catch{return{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}}),O=p.useCallback(V=>{T(V);try{localStorage.setItem(C,JSON.stringify(V))}catch{}},[C]),$=F(p.useCallback(V=>{var D,K;return i?((K=(D=V.preferences)==null?void 0:D.pinnedPaletteItems)==null?void 0:K[r])??Ic:Ic},[i,r])),B=p.useMemo(()=>i?$.map(V=>e.find(D=>D.id===V)).filter(V=>V!==void 0):[],[i,$,e]),H=p.useCallback(V=>i?$.includes(V):!1,[i,$]),M=p.useCallback((V,D)=>{D&&(D.stopPropagation(),D.preventDefault()),i&&E.getState().togglePinPaletteItem(r,V)},[i,r]),j=p.useMemo(()=>Nu(A),[A]),{navigateResults:P}=Su(v,N),W=p.useMemo(()=>{const V={};return e.forEach(D=>{const K=o?o(D):D.group??"General";V[K]||(V[K]=[]),V[K].push(D)}),V},[e,o]),L=p.useMemo(()=>k.filter(V=>!$.includes(V)).map(V=>e.find(D=>D.id===V)).filter(V=>V!==void 0),[k,e,$]),z=p.useCallback(V=>{y(!1),S(""),s(V),R(D=>{const K=D.filter(ie=>ie!==V.id),te=[V.id,...K].slice(0,a);try{localStorage.setItem(I,JSON.stringify(te))}catch{}return te})},[y,s,a,I]);p.useEffect(()=>{const V=[];if(c){const D=_r.register({key:c.key,ctrlKey:c.ctrl,altKey:c.alt,metaKey:c.meta,preventDefault:!0,callback:()=>y(!x)});V.push(D)}if(l&&k.length>0){const D=_r.register({key:l.key,ctrlKey:l.ctrl,altKey:l.alt,metaKey:l.meta,preventDefault:!0,callback:()=>{const K=k[0],te=e.find(ie=>ie.id===K);te&&s(te)}});V.push(D)}return()=>{V.forEach(D=>D())}},[c,l,x,y,k,e,s]),p.useEffect(()=>{if(!x)return;const V=D=>{if(i&&D.key==="Enter"&&D.ctrlKey){D.preventDefault(),D.stopPropagation();const ye=v.split("-");let ge;ye[0]==="recent"||ye[0]==="pinned"?ge=ye[1]:ge=ye[0],ge&&M(ge);return}if(D.key!=="ArrowUp"&&D.key!=="ArrowDown")return;const K=Array.from(document.querySelectorAll("[cmdk-item]")).filter(ye=>ye.getAttribute("data-disabled")!=="true");if(K.length===0)return;const te=K.map(ye=>ye.getAttribute("data-value")||""),ie=te.indexOf(v);D.key==="ArrowUp"&&ie<=0?(D.preventDefault(),D.stopPropagation(),N(te[K.length-1])):D.key==="ArrowDown"&&ie>=K.length-1&&(D.preventDefault(),D.stopPropagation(),N(te[0]))};return document.addEventListener("keydown",V,{capture:!0}),()=>document.removeEventListener("keydown",V,{capture:!0})},[x,v,i,M]);const _=V=>t.jsxs("div",{className:"flex justify-between items-center w-full","data-test":"command-palette-item-content",children:[t.jsxs("div",{className:"flex flex-col","data-test":"command-palette-item-text",children:[t.jsx("span",{"data-test":"command-palette-item-label",children:V.label}),V.description&&t.jsx("span",{className:"text-xs text-muted-foreground","data-test":"command-palette-item-description",children:V.description})]}),V.shortcut&&t.jsx("kbd",{className:"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground","data-test":"command-palette-item-shortcut",children:V.shortcut})]}),G=V=>{const D=H(V.id),K=d?d(V):_(V);return i?t.jsxs("div",{className:"flex items-center w-full group","data-test":"command-palette-item-wrapper",children:[t.jsx("div",{className:"flex-1 min-w-0",children:K}),t.jsx(ee,{type:"button",variant:"ghost",size:"smIcon",onClick:te=>M(V.id,te),className:`shrink-0 ${D?"opacity-100":"opacity-0 group-hover:opacity-100"}`,title:D?"Unpin (Ctrl+Enter)":"Pin (Ctrl+Enter)","data-test":"command-palette-pin-button",children:D?t.jsx(hl,{className:"text-muted-foreground","data-test":"command-palette-pin-icon-off"}):t.jsx(ul,{className:"text-muted-foreground","data-test":"command-palette-pin-icon"})})]}):K};return t.jsxs(Cu,{open:x,onOpenChange:y,value:v,onValueChange:N,filter:j,"data-test":"command-palette-dialog",children:[t.jsx(ju,{placeholder:n,initialOptions:A,onSearchOptionsChange:O,onSearchChange:S,onNavigate:P}),t.jsxs(ku,{"data-test":"command-palette-list",children:[t.jsx(Au,{"data-test":"command-palette-empty",children:u?u():"No results found."}),i&&B.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(ca,{heading:"Pinned","data-test":"command-palette-group-pinned",children:B.map(V=>t.jsx(la,{value:`pinned-${V.id}-${V.label}`,onSelect:()=>z(V),"data-test":"command-palette-item-pinned",children:G(V)},`pinned-${V.id}`))}),t.jsx(da,{"data-test":"command-palette-separator-pinned"})]}),L.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(ca,{heading:"Recently Used","data-test":"command-palette-group-recent",children:L.map(V=>t.jsx(la,{value:`recent-${V.id}-${V.label}`,onSelect:()=>z(V),"data-test":"command-palette-item-recent",children:G(V)},`recent-${V.id}`))}),t.jsx(da,{"data-test":"command-palette-separator-recent"})]}),Object.entries(W).map(([V,D],K)=>t.jsxs("div",{"data-test":"command-palette-group-container",children:[K>0&&t.jsx(da,{"data-test":"command-palette-separator"}),t.jsx(ca,{heading:V,"data-test":"command-palette-group",children:D.map(te=>t.jsx(la,{value:`${te.id}-${te.label}-${te.description||""}`,onSelect:()=>z(te),"data-test":"command-palette-item",children:G(te)},te.id))})]},V))]})]})}const tS=({open:e,onOpenChange:s})=>{const n=F(l=>{var d;return((d=l.state)==null?void 0:d.projects)??{}}),o=F(l=>{var d;return(d=l.state)==null?void 0:d.activeProjectId}),r=p.useMemo(()=>{const l=[];for(const[d,u]of Object.entries(n))for(const[h,f]of Object.entries(u.workspaces))for(const[g,w]of Object.entries(f.canvases))w.hideFromSearch||l.push({id:g,label:w.name,description:`${u.name} / ${f.name}`,projectId:d,workspaceId:h,canvasId:g,projectName:u.name,workspaceName:f.name});return l.sort((d,u)=>{if(d.projectId===o&&u.projectId!==o)return-1;if(u.projectId===o&&d.projectId!==o)return 1;const h=d.projectName.localeCompare(u.projectName);if(h!==0)return h;const f=d.workspaceName.localeCompare(u.workspaceName);return f!==0?f:d.label.localeCompare(u.label)}),l},[n,o]),a=p.useCallback(l=>{E.getState().projectCanvas.switch(l.canvasId)},[]),i=p.useCallback(l=>t.jsxs("div",{className:"flex items-center gap-1.5 w-full min-w-0","data-test":"canvas-picker-item",children:[t.jsx(sn,{className:"!h-3 !w-3 text-muted-foreground shrink-0"}),t.jsx("span",{className:"shrink-0 font-medium","data-test":"canvas-picker-item-label",children:l.label}),t.jsxs("span",{className:"text-xs text-muted-foreground truncate",title:`${l.projectName} / ${l.workspaceName} / ${l.label}`,"data-test":"canvas-picker-item-path",children:[l.projectName," / ",l.workspaceName," / ",l.label]})]}),[]),c=p.useCallback(()=>t.jsxs("div",{className:"text-center py-4","data-test":"canvas-picker-empty",children:[t.jsx("p",{className:"text-muted-foreground",children:"No canvases found."}),t.jsx("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Create a canvas to get started."})]}),[]);return t.jsx(eS,{items:r,onSelect:a,placeholder:"Search canvases...",storageKey:"canvas-picker-palette",maxRecentItems:10,enablePinning:!0,openShortcut:{key:"p",ctrl:!0},renderItem:i,renderEmpty:c,open:e,onOpenChange:s,"data-test":"canvas-picker-palette"})};function Tc(e,s){const{selected:n}=s;if(e==="selected")return n.map(o=>o.content??"").filter(o=>String(o).trim()).join(`
`);if(e.startsWith("selected[")){const o=qr(e,{selected:n});return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}if(e.startsWith("selected.")){const o=e.slice(9);return n.map(r=>{const a={node:r},i=qr(`node.${o}`,a);return i==null?"":typeof i=="object"?JSON.stringify(i):String(i)}).filter(r=>String(r).trim()).join(`
`)}return""}function sS({formulas:e,inputRef:s,onFormulaExecute:n,getSelectedNodes:o,fieldCompletions:r=[]}){const[a,i]=p.useState(!1),[c,l]=p.useState(""),[d,u]=p.useState(0),[h,f]=p.useState(null),[g,w]=p.useState({top:0,left:0}),[m,x]=p.useState("formula"),[y,v]=p.useState(null),N=p.useMemo(()=>{if(m==="field"){const A=c.toLowerCase();return r.filter(T=>!A||T.field.toLowerCase().startsWith(A)||T.name.toLowerCase().includes(A)).map(T=>({id:T.id,name:T.name,trigger:T.field,description:T.description}))}if(!c)return e;const R=c.toLowerCase();return e.filter(A=>A.trigger.toLowerCase().startsWith(R)||A.name.toLowerCase().includes(R))},[e,r,c,m]);p.useMemo(()=>{u(0)},[N.length]);const b=p.useCallback(()=>{i(!1),l(""),f(null),u(0),x("formula"),v(null)},[]),S=p.useCallback(R=>{const A=Ap(R);if(A){const T=R.getBoundingClientRect(),O=window.getComputedStyle(R),$=parseInt(O.lineHeight||O.fontSize)||20;w({top:T.top+A.top-$-J.slashCommand.menuGapAboveInput,left:T.left+A.left})}},[]),I=p.useCallback(R=>{var z,_,G,V,D,K;const A=s.current;if(!A||h===null)return;const T=A.selectionStart??0,O=A.value,$={query:c,fullText:O,cursorPosition:T,equalPosition:h};if(m==="field"&&y){const te=`${y}.${R.trigger}`;let ie;if(o){const Y=o();ie=Tc(te,{selected:Y})}else ie="";const ye=ie??"",ge=O.substring(0,h),q=O.substring(T),le=ge+ye+q,de=((z=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:z.set)||((_=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:_.set);de&&(de.call(A,le),A.dispatchEvent(new Event("input",{bubbles:!0})));const U=h+ye.length;A.setSelectionRange(U,U),n==null||n({...R,trigger:te},ie),b();return}if(R.insertTrigger){const te=`=${R.trigger}`,ie=O.substring(0,h),ye=O.substring(T),ge=ie+te+ye,q=((G=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:G.set)||((V=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:V.set);q&&(q.call(A,ge),A.dispatchEvent(new Event("input",{bubbles:!0})));const le=h+te.length;A.setSelectionRange(le,le),b();return}let B;if(R.onSelect)B=R.onSelect($);else if(o){const te=o();B=Tc(R.trigger,{selected:te})}else B="";const H=B??"",M=O.substring(0,h),j=O.substring(T),P=M+H+j,W=((D=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:D.set)||((K=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:K.set);W&&(W.call(A,P),A.dispatchEvent(new Event("input",{bubbles:!0})));const L=h+H.length;A.setSelectionRange(L,L),n==null||n(R,B),b()},[s,h,c,m,y,n,o,b]),C=p.useCallback(R=>{const A=R.currentTarget,T=A.selectionStart??0,O=A.value;if(R.key==="="&&!a){const $=T>0?O[T-1]:"";(T===0||/\s/.test($))&&(S(A),f(T),i(!0),l(""),u(0),x("formula"),v(null));return}if(R.key==="."&&!a&&r.length>0){let $=-1;for(let B=T-1;B>=0;B--){if(O[B]==="="){const H=B>0?O[B-1]:"";if(B===0||/\s/.test(H)){$=B;break}}if(/\s/.test(O[B]))break}if($>=0){const B=O.substring($+1,T);e.find(M=>M.insertTrigger&&M.trigger===B)&&(S(A),f($),i(!0),l(""),u(0),x("field"),v(B))}return}a&&(R.key==="ArrowDown"?(R.preventDefault(),u($=>$<N.length-1?$+1:0)):R.key==="ArrowUp"?(R.preventDefault(),u($=>$>0?$-1:N.length-1)):R.key==="Enter"||R.key==="Tab"?N.length>0&&(R.preventDefault(),I(N[d])):R.key==="Escape"&&(R.preventDefault(),b()))},[a,N,d,I,b,S,e,r.length]),k=p.useCallback(R=>{if(!a||h===null)return;if(h>=R.length||R[h]!=="="){b();return}const A=s.current,T=(A==null?void 0:A.selectionStart)??R.length;if(m==="field"){const O=h+1+((y==null?void 0:y.length)??0);if(T<=O||R[O]!=="."){b();return}const $=R.substring(O+1,T);if($.includes(" ")){b();return}l($)}else{const O=R.substring(h+1,T);if(O.includes(" ")){b();return}l(O)}},[a,h,m,y,s,b]);return{isOpen:a,query:c,filteredFormulas:N,selectedIndex:d,handleKeyDown:C,handleChange:k,selectFormula:I,close:b,menuPosition:g,isFieldMode:m==="field"}}const jd=({formulas:e,selectedIndex:s,position:n,onSelect:o,onClose:r,triggerPrefix:a="="})=>{const i=p.useRef(null),c=p.useRef(null);p.useEffect(()=>{var d;(d=c.current)==null||d.scrollIntoView({block:"nearest"})},[s]),p.useEffect(()=>{const d=u=>{i.current&&!i.current.contains(u.target)&&r()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[r]);const l=t.jsx("div",{ref:i,"data-test":"formula-menu",className:ve("fixed min-w-[200px] max-w-[300px]","rounded-md border bg-popover p-1 shadow-md",e.length>0&&"max-h-[200px] overflow-y-auto"),style:{top:n.top,left:n.left,zIndex:Ee.slashCommandMenu,transform:"translateY(-100%)"},children:e.length===0?t.jsx("div",{"data-test":"formula-menu-empty",className:"py-2 px-2 text-sm text-muted-foreground text-center",children:"No formulas found"}):e.map((d,u)=>t.jsxs("div",{ref:u===s?c:void 0,"data-test":"formula-item",className:ve("flex items-center gap-2 rounded-sm px-2 py-1.5 text-sm cursor-pointer","select-none outline-none",u===s?"bg-accent text-accent-foreground":"hover:bg-accent/50"),onClick:()=>o(d),children:[d.icon&&t.jsx("span",{"data-test":"formula-icon",className:"flex-shrink-0 w-4 h-4",children:d.icon}),t.jsxs("div",{"data-test":"formula-content",className:"flex flex-col flex-1 min-w-0",children:[t.jsxs("span",{"data-test":"formula-name",className:"font-medium truncate",children:[a,d.trigger]}),d.description&&t.jsx("span",{"data-test":"formula-description",className:"text-xs text-muted-foreground truncate",children:d.description})]})]},d.id))});return tn.createPortal(l,document.body)};jd.displayName="FormulaMenu";const nS=[{id:"selected",name:"Selected Nodes",trigger:"selected",description:"Access selected nodes",insertTrigger:!0}],oS=[{id:"content",name:"content",field:"content",description:"Node content text"},{id:"title",name:"title",field:"title",description:"Node title"},{id:"id",name:"id",field:"id",description:"Node ID"}];var Dt=(e=>(e.DEFAULT="default",e.CLAUDE="claude",e))(Dt||{});const aS={default:"",claude:"Claude"};function rS({content:e,srcLang:s,toLang:n}){return`Translate the following text from ${s} to ${n}: \`${e}\``}const Ec={ENGLISH:"English",VIETNAMESE:"Vietnamese"},iS=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??sr},cS=({onSend:e,placeholder:s="Type a message...",disabled:n=!1})=>{const[o,r]=p.useState(""),[a,i]=p.useState(Dt.DEFAULT),[c,l]=p.useState(null),[d,u]=p.useState(!1),[h,f]=p.useState(!0),[g,w]=p.useState(!1),[m,x]=p.useState(!1),[y,v]=p.useState(null),N=p.useRef(null),b=p.useRef(null),S=p.useRef(null),I=p.useRef(null),C=F(oe=>{var re;return((re=oe.uiState)==null?void 0:re.isOverlayVisible)??!0}),k=F(oe=>oe.toggleOverlayVisibility),R=F(De.selectSelectedNodes),A=F(oe=>{var re;return((re=oe.uiState)==null?void 0:re.dragInfo)!==null}),T=wo(iS),O=F(oe=>oe.uiState.activeChatNodeId),[$,B]=p.useState(()=>typeof window<"u"?window.innerWidth<Us:!1),[H,M]=p.useState(()=>typeof window<"u"?window.innerWidth<J.chatInput.tabletBreakpoint:!1);p.useEffect(()=>{const oe=()=>{B(window.innerWidth<Us),M(window.innerWidth<J.chatInput.tabletBreakpoint)};return window.addEventListener("resize",oe),()=>window.removeEventListener("resize",oe)},[]),p.useEffect(()=>{if(R.length===1){const re=R[0].data;if(re!=null&&re.sessionId){i(Dt.CLAUDE),l(re.sessionId);const xe=re.role!=="assistant";f(xe);return}}else I.current=null},[R,A]),p.useEffect(()=>{var oe;b.current=((oe=N.current)==null?void 0:oe.getTextArea())??null}),p.useEffect(()=>{const oe=()=>{var re,xe;(xe=(re=N.current)==null?void 0:re.getTextArea())==null||xe.focus()};return window.addEventListener("focus",oe),()=>window.removeEventListener("focus",oe)},[]);const j=p.useCallback(()=>{var ds;if(!O||!$)return;const oe=E.getState(),re=oe.getNodeById(O);if(!re||re.type!==ce.CHAT||!((ds=oe.projectCanvas.getActive())==null?void 0:ds.viewState))return;const we=S.current;if(!we)return;const fe=document.querySelector("[data-canvas-container]"),Ce=(fe==null?void 0:fe.getBoundingClientRect().top)??0,ke=(fe==null?void 0:fe.getBoundingClientRect().left)??0,Me=we.getBoundingClientRect().top,He=window.innerWidth,Be=oe.getNodeById(re.id),Ve=(Be==null?void 0:Be.data)??{},Oe=re.width??0,nt=re.height??0,ot=re.y+nt,bt=re.x+Oe,cs=Me-Ce-ot,ls=He-ke-bt;oe.setActiveCanvasViewState(es=>({...es,targetView:{targetOffset:{x:ls,y:cs},targetScale:1,animationStartTime:0,animationDuration:J.claudeChat.alignScrollDuration}})),oe.updateNode(re.id,{data:{...Ve,viewMode:"chat"}})},[O,$]),P=p.useCallback(()=>{j()},[j]),W=p.useCallback(()=>{var oe;return((oe=E.getState().projectCanvas.getActive())==null?void 0:oe.coreState.selectedNodes)??[]},[]),L=p.useMemo(()=>[{id:"claude",name:"Claude",trigger:"claude",description:"Send to Claude AI",onSelect:()=>(i(Dt.CLAUDE),"")},{id:"claude-project-select",name:"Claude Project Select",trigger:"claude project select",description:"Select Claude project for next message",onSelect:()=>(w(!0),i(Dt.CLAUDE),"")},{id:"translate-selected",name:"Translate Selected",trigger:"translate selected",description:"Translate selected node content",onSelect:()=>{var we;const re=((we=W()[0])==null?void 0:we.content)??"";return re?rS({content:re,srcLang:Ec.ENGLISH,toLang:Ec.VIETNAMESE}):(be.warning("No content selected",{description:"Select a node with content first"}),"")}}],[c,g,y,W]),{isOpen:z,filteredCommands:_,selectedIndex:G,handleKeyDown:V,handleChange:D,selectCommand:K,close:te,menuPosition:ie}=jp({commands:L,inputRef:b}),{isOpen:ye,filteredFormulas:ge,selectedIndex:q,handleKeyDown:le,handleChange:de,selectFormula:U,close:Y,menuPosition:X,isFieldMode:Z}=sS({formulas:nS,inputRef:b,getSelectedNodes:W,fieldCompletions:oS}),ne=p.useCallback(oe=>{const re=oe.target.value;r(re),D(re),de(re);const xe=H?J.chatInput.maxRows*24+16:200,we=oe.target;we.style.height="auto",we.style.height=`${Math.min(we.scrollHeight,xe)}px`},[D,de,H]),se=p.useCallback(()=>{var Dr,Or;const oe=E.getState();if(O){const Ut=oe.getNodeById(O);if(Ut&&Ut.type===ce.CHAT)return Ut}const re=S.current;if(!re)return null;const xe=(Dr=oe.projectCanvas.getActive())==null?void 0:Dr.viewState;if(!xe)return null;const{scale:we,offset:fe}=xe,Ce=re.getBoundingClientRect(),{viewMode:ke,windowed:Ae,desktopWidth:Me,desktopHeight:He}=J.chatNode,Be=((Or=window.visualViewport)==null?void 0:Or.width)??window.innerWidth,Ve=document.querySelector("[data-canvas-container]"),Oe=(Ve==null?void 0:Ve.getBoundingClientRect().top)??0,nt=Ce.top,ot=document.querySelector('[data-test="canvas-chat-input-textarea-container"]'),bt=ot==null?void 0:ot.getBoundingClientRect();let cs,ls;if($&&ke==="fullwidth")cs=Be,ls=Oe;else{const Ut=$?Ae.mobileViewportGap:Ae.desktopViewportGap;cs=$?Be-Ut*2:Math.min((bt==null?void 0:bt.width)??Ce.width,Me),$||((bt==null?void 0:bt.right)??Ce.right)-cs,ls=Oe+Ut}const ds=$?nt-ls:He,es=cs,oa=ds,Er=(Ve==null?void 0:Ve.getBoundingClientRect().left)??0,Rr=$?Be:(bt==null?void 0:bt.right)??Be,Mr=(Rr-Er-fe.x)/we-es,Pr=(nt-Oe-fe.y)/we-oa,aa={id:Pe(),type:ce.CHAT,x:Mr,y:Pr,width:es,height:oa,title:"Chat",data:{childNodeIds:[],maxHeight:J.chatNode.defaultMaxHeight,viewMode:"chat"}};oe.addNode(aa,void 0,{dontSelect:!0}),oe.setActiveChatNodeId(aa.id,!1);const Dd=Pr+oa,Od=Mr+es,Ld=Rr-Er-Od,Wd=nt-Oe-Dd;return oe.setActiveCanvasViewState(Ut=>({...Ut,targetView:{targetOffset:{x:Ld,y:Wd},targetScale:1,animationStartTime:0,animationDuration:J.claudeChat.alignScrollDuration}})),aa},[O,$,C]),ae=p.useCallback((oe,re)=>{var es;const xe=se();if(!xe)return null;const we=E.getState(),fe=$?J.chatInput.mobile.nodeFontSize:void 0,Ce=xe.data,ke=(xe.width??400)-16,Me=ys(oe)+16,He=Math.min(Me,ke),Ve=Iu(oe,{containerWidth:He,fontSize:fe,skipPaddingSubtraction:!0})+Ne.NODE_Y_PADDING,Oe={id:Pe(),type:ce.TEXT,x:xe.x,y:xe.y,width:He,height:Ve,content:oe,...re&&{data:re},...fe&&{styles:{fontSize:fe}}};we.addNode(Oe,void 0,{dontSelect:!0}),we.updateNode(xe.id,{data:{...Ce,childNodeIds:[...Ce.childNodeIds||[],Oe.id]}});const nt=40,ot=16,ls=((((es=Ce.childNodeIds)==null?void 0:es.length)??0)+1)*(Ve+8),ds=Math.min(nt+ot+ls,J.chatNode.defaultMaxHeight);return ds>(xe.height??0)&&we.updateNode(xe.id,{height:ds}),Oe},[se,$]),me=p.useCallback(async()=>{var xe;const oe=o.trim();if(!oe)return;const re=(xe=N.current)==null?void 0:xe.getTextArea();if(a===Dt.CLAUDE){u(!0);try{let we=c;if(!we){const Ce=await Oa.createSession();if(!Ce.success||!Ce.sessionId)throw new Error(Ce.error??"Failed to create Claude session");we=Ce.sessionId,l(we)}ae(oe,{sessionId:we,role:"user"});const fe=await Oa.sendMessage({sessionId:we,message:oe});if(!fe.success)throw new Error(fe.error??"Failed to send message to Claude");ae(fe.response,{sessionId:we,role:"assistant"}),e==null||e(oe),r(""),re&&(re.style.height="auto",re.focus())}catch(we){const fe=we instanceof Error?we.message:"Unknown error";be.error("Claude API error",{description:fe}),c&&ae(`Error: ${fe}`,{sessionId:c,role:"error"})}finally{u(!1)}return}ae(oe),e==null||e(oe),r(""),i(Dt.DEFAULT),re&&(re.style.height="auto",re.focus())},[o,e,a,c,ae]),he=p.useCallback(()=>{if(a===Dt.CLAUDE){const oe=(y==null?void 0:y.split("/").pop())??"",re=c?Jr(c,3,3):"new";return oe?`[${oe}] ${re}`:c?Jr(c,3,3):"Claude"}return aS[a]},[a,c,y]),pe=p.useCallback(oe=>{if(V(oe),le(oe),!(z&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(oe.key))&&!(ye&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(oe.key))&&oe.key==="Enter"&&!z&&!ye){if(H)return;oe.shiftKey||(oe.preventDefault(),me())}},[me,V,le,z,ye,H]),ue=H?J.chatInput.maxRows*24+16:200;return t.jsxs("div",{ref:S,className:"w-screen md:w-[50vw] pr-2",style:{zIndex:Ee.canvasChatInput},"data-test":"canvas-chat-input-container","data-ui-panel":"true",children:[z&&t.jsx(kp,{commands:_,selectedIndex:G,position:ie,onSelect:K,onClose:te}),ye&&t.jsx(jd,{formulas:ge,selectedIndex:q,position:X,onSelect:U,onClose:Y,triggerPrefix:Z?".":"="}),g&&t.jsxs("div",{"data-test":"chat-input-project-selector",className:"absolute bottom-full mb-2 left-0 right-0 bg-background border rounded-lg shadow-lg p-3",style:{zIndex:Ee.canvasChatInput+1},children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-sm font-medium",children:"Select Claude Project"}),t.jsx("button",{"data-test":"chat-input-project-selector-close",onClick:()=>w(!1),className:"p-1 hover:bg-muted rounded",children:t.jsx($e,{className:"h-4 w-4"})})]}),t.jsx(Tu,{variant:"select",onChange:oe=>{v(typeof oe=="string"?oe:null),setTimeout(()=>{var xe,we;l(null),i(Dt.CLAUDE),w(!1),(we=(xe=N.current)==null?void 0:xe.getTextArea())==null||we.focus()},0)}})]}),a!==Dt.DEFAULT&&t.jsxs("div",{"data-test":"chat-input-mode-indicator",className:"absolute -top-7 left-2 flex items-center gap-1 px-2 pl-2 py-1 bg-primary text-primary-foreground text-xs font-medium rounded-t-md",children:[t.jsx("span",{"data-test":"chat-input-mode-label",children:he()}),t.jsx("button",{"data-test":"chat-input-mode-clear",onClick:()=>{i(Dt.DEFAULT),l(null)},className:"p-0.5 hover:bg-primary-foreground/20 rounded",title:"Clear mode",children:t.jsx($e,{className:"h-3 w-3"})})]}),t.jsxs("div",{className:"flex items-center pb-1","data-test":"canvas-chat-input-wrapper",children:[t.jsxs(ct,{open:m,onOpenChange:x,children:[t.jsx(lt,{asChild:!0,children:t.jsx(ee,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 h-10 w-10 bg-background rounded-lg",title:"More actions","data-test":"canvas-chat-input-plus-button",children:t.jsx(yt,{className:"h-5 w-5"})})}),t.jsx(dt,{side:"top",align:"start",className:"w-auto p-1","data-test":"canvas-chat-input-plus-menu",children:t.jsx(ee,{type:"button",variant:"ghost",size:"sm",className:"w-full justify-start gap-2",onClick:()=>{k(),x(!1)},"data-test":"canvas-chat-input-toggle-overlay",children:C?t.jsxs(t.Fragment,{children:[t.jsx(ws,{className:"h-4 w-4"}),t.jsx("span",{children:"Hide Overlay"})]}):t.jsxs(t.Fragment,{children:[t.jsx(Zt,{className:"h-4 w-4"}),t.jsx("span",{children:"Show Overlay"})]})})})]}),t.jsx("div",{className:"flex-1 min-w-0 bg-background border rounded-lg shadow-lg","data-test":"canvas-chat-input-textarea-container",children:t.jsx(Lc,{ref:N,value:o,onChange:ne,onKeyDown:pe,onFocus:P,placeholder:s,className:"min-h-[40px] resize-none border-0 focus-visible:ring-0 focus-visible:ring-offset-0",style:{maxHeight:`${ue}px`,fontSize:$?J.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:$?J.chatInput.mobile.fontConfig.cssLineHeight:void 0},rows:1,showFilePicker:!0,showCopyButton:!1,showAudioButton:!0,showConfigButton:!1,audioButtonVariant:"muted",useMarkdown:!1,readOnly:n||d,keyboard:T})}),t.jsx(ee,{type:"button",size:"icon",onClick:me,disabled:n||!o.trim()||d,className:"flex-shrink-0 h-10 w-10 ml-2","data-test":"canvas-chat-input-send-button",children:d?t.jsx(Gn,{className:"h-4 w-4 animate-spin","data-test":"canvas-chat-input-loading"}):t.jsx(np,{className:"h-4 w-4"})})]})]})},lS=[],dS=()=>{const e=F(h=>h.uiState.switchLayerDialog),s=F(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.layers)??lS}),n=F(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.activeLayerId)??pt}),o=(e==null?void 0:e.isOpen)??!1,r=(e==null?void 0:e.targetLayerId)??pt,a=s.find(h=>h.id===r),i=(a==null?void 0:a.name)??(r===pt?"Default Layer":"Unknown Layer"),c=s.find(h=>h.id===n),l=(c==null?void 0:c.name)??(n===pt?"Default Layer":"Unknown Layer"),d=()=>{E.getState().setUiState(h=>({...h,switchLayerDialog:null}))},u=()=>{E.getState().layer.setActive(r),d()};return t.jsx(Wc,{open:o,onOpenChange:h=>!h&&d(),children:t.jsxs(Hc,{"data-test":"switch-layer-dialog",children:[t.jsxs(Bc,{children:[t.jsx(Fc,{"data-test":"switch-layer-dialog-title",children:"Node on Different Layer"}),t.jsxs(Eu,{"data-test":"switch-layer-dialog-description",children:['You are currently on the "',l,'" layer. The node you clicked is on the "',i,'" layer. Would you like to switch to that layer?']})]}),t.jsxs(Ru,{"data-test":"switch-layer-dialog-footer",children:[t.jsx(ee,{variant:"outline",onClick:d,"data-test":"switch-layer-dialog-cancel",children:"Cancel"}),t.jsx(ee,{onClick:u,"data-test":"switch-layer-dialog-confirm",children:"Switch Layer"})]})]})})},uS=2e3,hS=[],Rc=[],cn={offset:{x:0,y:0},scale:1,targetView:null},pS=Ie.memo(({node:e,isSelected:s})=>{const a=(typeof e.content=="string"?e.content:"").split(`
`).filter(w=>w.trim().length>0),i=e.width??200,c=e.height??100,l=Math.max(a.length,1),d=Math.min(20,c/l),u=8,h="hsl(var(--muted))",f=s?"2px solid #2563eb":"1px solid hsl(var(--border))",g="hsl(var(--foreground))";return t.jsx("div",{style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${i}px`,height:`${c}px`,backgroundColor:h,border:f,borderRadius:"4px",padding:`${u}px`,display:"flex",flexDirection:"column",gap:`${Math.min(4,d*.2)}px`,overflow:"hidden",willChange:"transform",backfaceVisibility:"hidden"},children:a.slice(0,Math.floor(c/d)).map((w,m)=>{const x=w.length,y=Math.max(...a.map(N=>N.length),1),v=Math.max(20,x/y*90);return t.jsx("div",{style:{height:`${Math.max(2,d-4)}px`,width:`${v}%`,backgroundColor:s?"#93c5fd":g,borderRadius:"2px"}},m)})})});pS.displayName="SimplifiedNode";const kd=Ie.memo(({nodes:e,selectedNodeIds:s,selectedNodesCount:n,scale:o,offset:r})=>{const a=o<vn,i=p.useMemo(()=>{if(o>=vn)return e;const c=window.innerWidth,l=window.innerHeight,d=-r.x/o,u=-r.y/o,h=d+c/o,f=u+l/o,g=500/o;return e.filter(m=>{const x=m.x+(m.width??200),y=m.y+(m.height??100);return m.x<h+g&&x>d-g&&m.y<f+g&&y>u-g})},[e,o,r]);return a?t.jsx(t.Fragment,{children:i.map(c=>t.jsx(Vo,{node:c,isSelected:s.has(c.id),selectedNodesCount:n,useSimplifiedRendering:!0},c.id))}):t.jsx(t.Fragment,{children:e.map(c=>t.jsx(Vo,{node:c,isSelected:s.has(c.id),selectedNodesCount:n},c.id))})},(e,s)=>{const n=e.scale<vn,o=s.scale<vn;return!(n!==o||o&&(e.scale!==s.scale||e.offset.x!==s.offset.x||e.offset.y!==s.offset.y)||e.nodes!==s.nodes||e.selectedNodeIds!==s.selectedNodeIds||e.selectedNodesCount!==s.selectedNodesCount)});kd.displayName="CanvasNodesRenderer";const gS=[],Ad=Ie.memo(({groupNodes:e,selectedNodeIds:s})=>{const n=F(a=>{var i;return((i=a.projectCanvas.getActive())==null?void 0:i.viewState)??cn}),{scale:o,offset:r}=n;return e.length===0?null:t.jsx("div",{className:"absolute top-0 left-0 origin-top-left","data-test":"canvas-groups-layer",style:{transform:`translate3d(${r.x}px, ${r.y}px, 0) scale(${o})`,zIndex:Ee.canvasGroups,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:t.jsx("div",{style:{pointerEvents:"auto"},children:e.map(a=>t.jsx(Vo,{node:a,isSelected:s.has(a.id),selectedNodesCount:s.size},a.id))})})});Ad.displayName="CanvasGroupsLayer";const Id=Ie.memo(({nodes:e,selectedNodeIds:s,layers:n})=>{const o=F(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.viewState)??cn}),{scale:r,offset:a}=o,i=p.useRef(0),c=p.useRef(r),l=p.useRef(!1),d=p.useRef(null),u=p.useRef(new Map),h=p.useMemo(()=>e.filter(m=>!m.isPinned),[e]),f=p.useMemo(()=>e.filter(m=>m.isPinned),[e]),g=p.useMemo(()=>n.length===0?[Gc()]:[...n].sort((m,x)=>m.order-x.order),[n]),w=p.useMemo(()=>{const m=new Map;return g.forEach(x=>{m.set(x.id,[])}),m.has(pt)||m.set(pt,[]),h.forEach(x=>{const y=x.layerId??pt,v=m.get(y);if(v)v.push(x);else{const N=m.get(pt);N&&N.push(x)}}),m},[h,g]);return p.useEffect(()=>{i.current+=1,c.current!==r&&(l.current||(l.current=!0,u.current.forEach(x=>{x&&(x.style.willChange="transform, contents")})),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{l.current=!1,u.current.forEach(x=>{x&&(x.style.willChange="")})},200)),c.current=r},[r,e.length]),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"absolute top-0 left-0 origin-top-left",style:{transform:`translate3d(${a.x}px, ${a.y}px, 0) scale(${r})`,zIndex:Ee.canvasNodes,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:[t.jsx(yS,{scale:r,offset:a}),g.map((m,x)=>{const y=w.get(m.id)??[];return m.isVisible?t.jsx("div",{ref:v=>{u.current.set(m.id,v)},"data-layer-id":m.id,"data-layer-name":m.name,"data-test":"canvas-layer-container",style:{zIndex:x,opacity:m.opacity/100,pointerEvents:m.isLocked?"none":"auto"},children:t.jsx(kd,{nodes:y,selectedNodeIds:s,selectedNodesCount:s.size,scale:r,offset:a})},m.id):null})]}),f.length>0&&t.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:Ee.canvasNodes+1},children:t.jsx("div",{style:{pointerEvents:"auto"},children:f.map(m=>t.jsx(Vo,{node:m,isSelected:s.has(m.id),selectedNodesCount:s.size},m.id))})})]})});Id.displayName="CanvasTransformLayer";const fS=({arrows:e,selectedArrows:s})=>{const n=F(c=>{var l;return((l=c.projectCanvas.getActive())==null?void 0:l.viewState)??cn}),{scale:o,offset:r}=n,a=c=>!s.some(d=>d.id===c.id)||s.length>1,i=e.filter(a);return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:Ee.canvasArrows,willChange:"transform"},children:t.jsxs("g",{transform:`translate(${r.x}, ${r.y}) scale(${o})`,style:{touchAction:"none"},children:[i.map(c=>t.jsx(yd,{arrow:c},c.id)),t.jsx(jb,{})]})})},mS=Ie.memo(fS,(e,s)=>e.arrows.length!==s.arrows.length||e.selectedArrows.length!==s.selectedArrows.length?!1:e.arrows===s.arrows&&e.selectedArrows===s.selectedArrows),xS=({selectedArrows:e})=>{const s=F(r=>{var a;return((a=r.projectCanvas.getActive())==null?void 0:a.viewState)??cn}),{scale:n,offset:o}=s;return e.length!==1?null:t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:Ee.canvasNodes+1,willChange:"transform"},children:t.jsx("g",{transform:`translate(${o.x}, ${o.y}) scale(${n})`,style:{touchAction:"none"},children:t.jsx(yd,{arrow:e[0]},e[0].id)})})},wS=Ie.memo(xS,(e,s)=>e.selectedArrows.length!==s.selectedArrows.length?!1:e.selectedArrows===s.selectedArrows),Td=Ie.memo(()=>{const e=F(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??cn}),{scale:s,offset:n}=e;return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:Ee.canvasNodes+2,willChange:"transform"},"data-test":"temporary-drawing-layer",children:t.jsx("g",{transform:`translate(${n.x}, ${n.y}) scale(${s})`,style:{touchAction:"none"},children:t.jsx(kb,{})})})});Td.displayName="CanvasTemporaryDrawingLayer";const Ed=Ie.memo(()=>{const e=F(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??cn}),{scale:s,offset:n}=e;return t.jsx(Tb,{scale:s,offset:n})});Ed.displayName="CanvasGridLayer";const yS=({scale:e,offset:s,x:n=0,y:o=0})=>t.jsx("div",{style:{position:"absolute",left:n*e,top:o*e,width:12,height:12,background:"darkred",borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 2px #0008",cursor:"pointer",zIndex:10,transform:"translate(-50%, -50%)",userSelect:"none"},title:`Canvas origin (${n.toFixed(1)}, ${o.toFixed(1)})`}),vS=()=>{const e=F(L=>L.uiState.isOverlayVisible??!0);F(L=>L.uiState.addNodeType);const s=F(L=>L.uiState.mode),n=F(L=>L.uiState.isPanning),o=F(L=>L.uiState.selectFromDrawMode),r=F(L=>{var z,_,G;return((G=(_=(z=L.preferences)==null?void 0:z.canvasConfig)==null?void 0:_.background)==null?void 0:G.paperTexture)??J.background.paperTexture}),a=F(L=>{var z,_,G;return((G=(_=(z=L.preferences)==null?void 0:z.canvasConfig)==null?void 0:_.background)==null?void 0:G.customParams)??J.background.customParams}),{theme:i}=Vc(),c=Ie.useMemo(()=>i==="dark"?!0:i==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[i]),l=r!=="custom"&&Mu[r]||"",d=Ie.useMemo(()=>{if(!a||a.opacity===0)return{};const L=c?100-a.bgLightness:a.bgLightness;return{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${L}%)`,position:"relative"}},[a,c]),u=Ie.useMemo(()=>!a||a.opacity===0?null:{position:"absolute",inset:0,opacity:a.opacity,pointerEvents:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`,zIndex:0},[a]),h=p.useRef(0),f=p.useRef(performance.now());p.useEffect(()=>{h.current+=1;const L=performance.now();L-f.current>=2e3&&(h.current=0,f.current=L)});const[g,w]=p.useState(()=>typeof window<"u"?window.innerWidth<Us:!1);p.useEffect(()=>{const L=()=>w(window.innerWidth<Us);return window.addEventListener("resize",L),()=>window.removeEventListener("resize",L)},[]);const m=F(L=>L.toggleOverlayVisibility),x=iN(),y=F(L=>{var z;return((z=L.projectCanvas.getActive())==null?void 0:z.coreState.selectedNodes)??hS}),v=F(L=>{var z;return((z=L.projectCanvas.getActive())==null?void 0:z.coreState.arrows)??Rc}),N=F(L=>{var z;return((z=L.projectCanvas.getActive())==null?void 0:z.coreState.selectedArrows)??Rc}),b=F(L=>{var z;return((z=L.projectCanvas.getActive())==null?void 0:z.coreState.layers)??gS}),S=F(L=>L.saveStateToLocalStorage),I=JN(),C=F(L=>L.uiState.activeGlobalOverlay),k=C&&C!==ms.NONE;p.useEffect(()=>{J.autosave&&setInterval(()=>{typeof S=="function"&&S()},uS)},[]);const R=p.useMemo(()=>new Set(y.map(L=>L.id)),[y]),A=p.useMemo(()=>{const L=new Set;return x.forEach(z=>{if(z.type===ce.GROUP&&z.isCollapsed){const _=z.data;_!=null&&_.childNodeIds&&_.childNodeIds.forEach(G=>L.add(G))}if(z.type===ce.CHAT){const _=z.data;_!=null&&_.childNodeIds&&_.childNodeIds.forEach(G=>L.add(G))}}),L},[x]),T=p.useMemo(()=>{const L=cf(x,v);return A.forEach(z=>L.add(z)),L},[x,v,A]),{visibleGroupNodes:O,visibleNonGroupNodes:$}=p.useMemo(()=>{const L=x.filter(G=>!T.has(G.id)),z=[],_=[];return L.forEach(G=>{G.type===ce.GROUP?z.push(G):_.push(G)}),{visibleGroupNodes:z,visibleNonGroupNodes:_}},[x,T]),B=p.useMemo(()=>v.filter(L=>{const z=L.startNodeId!==null&&T.has(L.startNodeId),_=L.endNodeId!==null&&T.has(L.endNodeId);return!z&&!_}),[v,T]),H=p.useMemo(()=>N.filter(L=>{const z=L.startNodeId!==null&&T.has(L.startNodeId),_=L.endNodeId!==null&&T.has(L.endNodeId);return!z&&!_}),[N,T]),M=t.jsx(ee,{variant:"outline",size:"icon",onClick:m,className:"h-7 w-7","data-prevent-canvas-click":!0,title:e?"Hide Overlay":"Show Overlay","data-test":"canvas-toggle-overlay-button",children:e?t.jsx(ws,{className:"h-4 w-4"}):t.jsx(Zt,{className:"h-4 w-4"})}),j=t.jsx("div",{className:"flex items-center space-x-2",children:M}),P=s===Q.DRAW||s===Q.SELECT&&o,W=p.useMemo(()=>s===Q.MOVE?n?"grabbing":"grab":s===Q.DRAW?"crosshair":"default",[s,n]);return t.jsxs("div",{className:je("relative w-full h-full select-none",k&&"ring-2 ring-primary ring-inset",l),"data-canvas-content":!0,"data-global-overlay":C,style:{cursor:W,...d},children:[u&&t.jsx("div",{style:u,"data-test":"custom-texture-overlay"}),t.jsx(Ed,{}),t.jsx(Ad,{groupNodes:O,selectedNodeIds:R}),t.jsx(mS,{arrows:B,selectedArrows:H}),t.jsx(Id,{nodes:$,selectedNodeIds:R,layers:b}),t.jsx(wS,{selectedArrows:H}),t.jsx(Td,{}),t.jsx(Ll,{}),t.jsx(qv,{}),t.jsx(sb,{}),t.jsx(bb,{}),t.jsx(Nm,{}),t.jsx(nm,{isContentVisible:e,topMargin:"70px",topLeft:t.jsx(t.Fragment,{children:t.jsxs(t.Fragment,{children:[t.jsx(Ib,{}),t.jsx(Ev,{}),t.jsx(am,{})]})}),topRight:t.jsxs(t.Fragment,{children:[t.jsx(cd,{}),t.jsx(Cb,{})]}),bottomRight:e&&t.jsx("div",{className:"flex flex-col gap-2",children:t.jsx(Tv,{})}),bottom:t.jsx(ym,{}),alwaysVisibleBottomLeft:!g&&t.jsx("div",{className:"flex flex-col gap-2",children:j}),left:P?void 0:t.jsx(hN,{}),right:P?void 0:I.right,footer:t.jsx(cS,{})}),P&&t.jsx("div",{className:"absolute top-1/2 transform -translate-y-1/2 pointer-events-auto z-50 left-2","data-prevent-canvas-click":!0,"data-test":"draw-mode-toolbar-container",children:t.jsx(SN,{})}),t.jsx(tS,{}),t.jsx(dS,{})]})},bS=({sourceNode:e,allNodes:s,onNodeSelect:n,onClose:o,isVisible:r})=>{const[a,i]=p.useState(""),c=p.useMemo(()=>{const h=(e.highlights||[]).map(f=>f.linkedNodeId).filter(f=>f!==void 0);return s.filter(f=>h.includes(f.id))},[e.highlights,s]),l=p.useMemo(()=>{if(!a)return c;const u=a.toLowerCase();return c.filter(h=>(typeof h.content=="string"?h.content:"").toLowerCase().includes(u))},[c,a]),d=p.useMemo(()=>l.map(u=>{const h=typeof u.content=="string"?u.content:"[Complex content]",f=h.length>50?h.substring(0,50)+"...":h;return t.jsx("div",{className:"text-sm",children:f},u.id)}),[l]);return t.jsxs(_e,{isVisible:r,onClose:o,title:`Linked Nodes (${c.length})`,initialPosition:"center","data-test":"linked-nodes-popover",children:[t.jsx("div",{className:"search-field px-3 py-2 border-b border-border",children:t.jsx("input",{type:"text",className:"w-full px-2 py-1 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:"Search linked nodes...",value:a,onChange:u=>i(u.target.value)})}),t.jsx("div",{className:"linked-nodes-list overflow-hidden",children:d.length>0?t.jsx(or,{itemList:d,maxHeight:"200px",itemStyles:"border border-border",onSelectionChange:u=>{if(u.length>0){const h=l[u[0]];h&&(n(h),o())}}}):t.jsx("div",{className:"empty-state px-3 py-4 text-sm text-muted-foreground text-center",children:a?"No matching nodes found":"No linked nodes yet"})})]})},Mc=({node:e,isChanged:s})=>{const n=e.title||e.id,o=typeof e.content=="string"?e.content:"";return t.jsxs("div",{className:`absolute border-2 ${s?"border-green-500 ring-2 ring-green-500/30":"border-black"} bg-white rounded p-1`,style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:`${Ne.FONT_SIZE_MINI}px`},children:[t.jsx("div",{className:"font-semibold text-[10px] truncate",children:n}),t.jsx("div",{className:"text-[8px] text-muted-foreground truncate",children:o.substring(0,50)})]})},NS=({isVisible:e,changes:s,previewNodes:n,currentNodes:o,arrows:r,executionResult:a,onApply:i,onCancel:c})=>{const l=s.length>0,[d,u]=p.useState("canvas"),h=new Set(s.map(g=>g.nodeId)),f=p.useMemo(()=>{if(!a)return null;const g={workflow:{success:a.success,duration:`${a.duration}ms`,executedNodes:a.executedNodeCount,errors:a.errors.length},steps:[],changes:{totalNodes:s.length,updates:s.map(w=>({nodeId:w.nodeId,before:w.before,after:w.after}))}};return a.nodeStates&&a.nodeStates.forEach((w,m)=>{var x;(x=w.executionData)!=null&&x.steps&&w.executionData.steps.forEach(y=>{var N,b,S,I;const v={type:y.stepType,label:y.label,order:y.order};y.stepType==="source"?v.sourceData=w.executionData.sourceData:y.stepType==="loop"?v.items=((N=w.executionData.sourceData)==null?void 0:N.length)||0:y.stepType==="if"?(v.config=y.config,v.conditionResult=y.conditionResult,v.checkedNodes=((b=y.checkedNodes)==null?void 0:b.length)||0,v.matchedNodes=((S=y.checkedNodes)==null?void 0:S.filter(C=>C.matches).map(C=>C.nodeId))||[]):y.stepType==="nodeUpdate"&&(v.targets=((I=w.executionData.nodeUpdates)==null?void 0:I.length)||0),g.steps.push(v)})}),g},[a,s]);return t.jsx(_e,{isVisible:e,onClose:c,title:"Workflow Dry Run Results",shouldCloseManually:!0,resizable:!0,initialSize:{width:1200,height:700},children:t.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[t.jsxs("div",{className:"p-4 bg-muted border-b border-border flex items-center justify-between",children:[t.jsx("div",{className:"text-sm",children:l?t.jsxs(t.Fragment,{children:[t.jsx("strong",{children:s.length})," node",s.length!==1?"s":""," will be updated"]}):t.jsx("span",{className:"text-muted-foreground",children:"No changes to apply"})}),l&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{"data-test":"dry-run-view-canvas-button",onClick:()=>u("canvas"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="canvas"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(Zt,{size:14}),"Canvas Preview"]}),t.jsxs("button",{"data-test":"dry-run-view-list-button",onClick:()=>u("list"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="list"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(dr,{size:14}),"Details"]}),t.jsxs("button",{"data-test":"dry-run-view-json-button",onClick:()=>u("json"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="json"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(Zo,{size:14}),"JSON"]})]})]}),t.jsx("div",{className:"flex-1 overflow-hidden",children:l?d==="json"?t.jsx("div",{className:"h-full overflow-auto p-4 bg-gray-50","data-test":"dry-run-json-view",children:t.jsx("pre",{className:"text-xs font-mono bg-background border border-border rounded p-4 whitespace-pre-wrap break-words",children:JSON.stringify(f,null,2)})}):d==="canvas"?t.jsxs("div",{className:"h-full flex gap-2 p-2",children:[t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-muted px-2 py-1 text-xs font-semibold border-b border-border",children:"Current State"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:o.map(g=>t.jsx(Mc,{node:g,isChanged:h.has(g.id)},g.id))})]}),t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-green-500/10 px-2 py-1 text-xs font-semibold border-b border-green-500/30 text-green-700 dark:text-green-400",children:"Preview (After Apply)"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:n.map(g=>t.jsx(Mc,{node:g,isChanged:h.has(g.id)},g.id))})]})]}):t.jsx("div",{className:"h-full overflow-y-auto p-4 space-y-4",children:s.map((g,w)=>t.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-2 bg-background",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:g.nodeId}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",w+1]})]}),g.before.title!==g.after.title&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Title"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:g.before.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(Vt,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:g.after.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),g.before.content!==g.after.content&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Content"}),t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20 font-mono max-h-24 overflow-y-auto",children:g.before.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:g.before.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(Vt,{size:16,className:"text-muted-foreground flex-shrink-0 mt-1"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20 font-mono max-h-24 overflow-y-auto",children:g.after.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:g.after.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),(()=>{const m=Array.isArray(g.before.tags)?g.before.tags:[],x=Array.isArray(g.after.tags)?g.after.tags:[],y=m.map(b=>b.title).sort().join(", "),v=x.map(b=>b.title).sort().join(", ");return y!==v?t.jsxs("div",{className:"space-y-1","data-test":"dry-run-tags-change",children:[t.jsxs("div",{className:"text-xs font-semibold text-muted-foreground flex items-center gap-1",children:[t.jsx(Fn,{size:12}),"Tags"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:m.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:m.map(b=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-destructive/20 rounded text-xs",children:["#",b.title]},b.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})}),t.jsx(Vt,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:x.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(b=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-xs",children:["#",b.title]},b.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})})]})]}):null})()]},g.nodeId))}):t.jsx("div",{className:"text-center text-muted-foreground py-8",children:"The workflow executed successfully but made no changes to the canvas nodes."})}),t.jsxs("div",{className:"p-4 border-t border-border flex items-center justify-end gap-2",children:[t.jsxs("button",{"data-test":"dry-run-cancel-button",onClick:c,className:"px-4 py-2 text-sm border border-border rounded hover:bg-accent transition-colors flex items-center gap-2",children:[t.jsx($e,{size:16}),"Cancel"]}),l&&t.jsxs("button",{"data-test":"dry-run-apply-button",onClick:i,className:"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors flex items-center gap-2",children:[t.jsx(Ys,{size:16}),"Apply Changes"]})]})]})})},Rd=Ie.memo(({canvasId:e,canvasName:s,projectName:n,workspaceName:o,isActive:r,isDragging:a,onClose:i,onClick:c,onAuxClick:l,dragRef:d})=>{const u=`${n} / ${o} / ${s}`;return t.jsxs("div",{ref:d,"data-test":"canvas-tab",className:ve("group flex items-center gap-1 px-3 py-1.5 text-sm","border-r border-border","cursor-pointer select-none","min-w-[100px]","transition-colors duration-150",r?"bg-background text-foreground border-b-2 border-b-primary":"bg-muted/50 text-muted-foreground hover:bg-accent hover:text-accent-foreground"),style:{maxWidth:J.tabBar.maxTabWidth,opacity:a?J.tabBar.dragSourceOpacity:void 0},onClick:c,onAuxClick:l,title:u,children:[t.jsx("span",{"data-test":"canvas-tab-title",className:"truncate flex-1",children:s}),t.jsx("button",{"data-test":"canvas-tab-close",className:ve("ml-1 p-0.5 rounded-sm","opacity-0 group-hover:opacity-100","hover:bg-destructive/20 hover:text-destructive","transition-opacity duration-150",r&&"opacity-60"),onClick:h=>{h.stopPropagation(),i(h)},title:"Close tab",children:t.jsx($e,{className:"h-3 w-3"})})]})});Rd.displayName="CanvasTab";const SS=ks,er="canvas-tab-bar-zone",Md=Ie.memo(({tab:e,isActive:s,isDragging:n,manager:o,onClose:r,onClick:a,onAuxClick:i})=>{const c=Ep(o,e.canvasId,{canvasId:e.canvasId,dropZoneId:er});return t.jsx(Rd,{canvasId:e.canvasId,canvasName:e.canvasName,projectName:e.projectName,workspaceName:e.workspaceName,isActive:s,isDragging:n,onClose:l=>{l.stopPropagation(),r(e.canvasId)},onClick:()=>a(e.canvasId),onAuxClick:l=>{l.button===1&&(l.preventDefault(),i(e.canvasId))},dragRef:c})});Md.displayName="DraggableTab";const Pd=Ie.memo(()=>{const e=p.useRef(null),s=F(S=>{var I;return((I=S.preferences)==null?void 0:I.openTabs)??SS}),n=F(S=>{var I;return((I=S.projectCanvas.getActive())==null?void 0:I.id)??null}),o=F(S=>{var I;return((I=S.state)==null?void 0:I.activeProjectId)??null}),r=F(S=>{var C,k,R;const I=(C=S.state)==null?void 0:C.activeProjectId;return I?((R=(k=S.state)==null?void 0:k.projects[I])==null?void 0:R.activeWorkspaceId)??null:null}),a=p.useMemo(()=>{var I;const S=((I=E.getState().state)==null?void 0:I.projects)??{};return s.map(C=>{const k=S[C.projectId],R=k==null?void 0:k.workspaces[C.workspaceId],A=R==null?void 0:R.canvases[C.canvasId];return{canvasId:C.canvasId,canvasName:(A==null?void 0:A.name)??"Unknown",projectId:C.projectId,projectName:(k==null?void 0:k.name)??"Unknown",workspaceId:C.workspaceId,workspaceName:(R==null?void 0:R.name)??"Unknown",exists:!!A}}).filter(C=>C.exists)},[s]),i=p.useRef({switchCanvas:E.getState().projectCanvas.switch,closeTab:E.getState().closeTab,reorderTabs:E.getState().reorderTabs,createCanvas:E.getState().projectCanvas.create,openTab:E.getState().openTab});p.useEffect(()=>{if(!n||!o||!r)return;s.some(I=>I.canvasId===n)||i.current.openTab(n,o,r)},[n,o,r,s]);const[c,l]=p.useState(null),[d,u]=p.useState(null),h=p.useRef(a);h.current=a;const f=p.useMemo(()=>({onDragStart:S=>{var C;const I=((C=S.item.data)==null?void 0:C.canvasId)??null;u(I)},onDragMove:S=>{l(S.sortIndex)},onDrop:S=>{var O;const I=(O=S.item.data)==null?void 0:O.canvasId,C=S.sortIndex??0;if(!I)return;const k=h.current.map($=>$.canvasId),R=k.indexOf(I);if(R===-1)return;const A=[...k];A.splice(R,1);const T=R<C?C-1:C;A.splice(T,0,I),i.current.reorderTabs(A)},onDragEnd:()=>{l(null),u(null)}}),[]),{manager:g}=Ip({snap:{enabled:!1,threshold:10},sort:{enabled:!0,orientation:"horizontal",threshold:.5},dragThreshold:5},f),w=Tp(g,er),m=p.useCallback(S=>{e&&(e.current=S),w(S)},[w,e]),x=p.useCallback(S=>{i.current.switchCanvas(S)},[]),y=p.useCallback(S=>{i.current.closeTab(S)},[]),v=p.useCallback(S=>{i.current.closeTab(S)},[]),N=p.useCallback(()=>{const S=i.current.createCanvas("New Canvas");S&&i.current.switchCanvas(S)},[]),b=p.useCallback(()=>{E.getState().setUiState(S=>({...S,floatingHeaderExpanded:!S.floatingHeaderExpanded}))},[]);return p.useEffect(()=>{if(!n||!e.current)return;const S=e.current.querySelector(`[data-test="canvas-tab-${n}"]`);S&&S.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},[n]),a.length===0?t.jsxs("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border px-1",children:[t.jsx("div",{className:"flex-1"}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:ve("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:N,title:"New canvas",children:t.jsx(yt,{className:"h-4 w-4"})}),t.jsx("button",{"data-test":"floating-header-toggle-button",className:ve("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onPointerDown:b,title:"Toggle header",children:t.jsx(jt,{className:"h-4 w-4"})})]}):t.jsxs("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border",children:[t.jsx("div",{ref:m,"data-drop-zone":er,className:"flex-1 flex items-center overflow-x-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},children:a.map((S,I)=>{const C=c===I&&d!==S.canvasId,k=c===I+1&&I===a.length-1&&d!==S.canvasId;return t.jsxs(Ie.Fragment,{children:[C&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:J.tabBar.dropIndicator.width,opacity:J.tabBar.dropIndicator.opacity}}),t.jsx(Md,{tab:S,isActive:S.canvasId===n,isDragging:S.canvasId===d,manager:g,onClose:y,onClick:x,onAuxClick:v}),k&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:J.tabBar.dropIndicator.width,opacity:J.tabBar.dropIndicator.opacity}})]},S.canvasId)})}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:ve("flex items-center justify-center","h-7 w-7 mx-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:N,title:"New canvas",children:t.jsx(yt,{className:"h-4 w-4"})}),t.jsx("button",{"data-test":"floating-header-toggle-button",className:ve("flex items-center justify-center","h-7 w-7 mr-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onPointerDown:b,title:"Toggle header",children:t.jsx(jt,{className:"h-4 w-4"})})]})});Pd.displayName="CanvasTabBar";function CS({open:e,onOpenChange:s}){const n=F(p.useCallback(m=>{var x,y;return((y=(x=m.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:y.current)??null},[])),o=F(p.useCallback(m=>{var x,y;return((y=(x=m.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:y.root)??null},[])),r=F(p.useCallback(m=>{var y,v;const x=(v=(y=m.projectCanvas.getActive())==null?void 0:y.undoTree)==null?void 0:v.nodes;return x?Object.keys(x).length:0},[])),{allNodes:a,currentNode:i,canUndo:c,canRedo:l,treeData:d}=p.useMemo(()=>{const m=E.getState();return{allNodes:m.undo.getAllNodes(),currentNode:m.undo.getCurrent(),canUndo:m.undo.canUndo(),canRedo:m.undo.canRedo(),treeData:m.undo.getTreeData()}},[n,o,r]),u=p.useCallback(()=>{E.getState().undo.undo()},[]),h=p.useCallback(()=>{E.getState().undo.redo()},[]),f=p.useCallback(m=>{E.getState().undo.jumpTo(m)},[]),g=p.useCallback(()=>{E.getState().undo.clear()},[]),w=p.useMemo(()=>{if(!d||a.length===0)return null;const m=d.root;return m?jS(a,m,(i==null?void 0:i.id)??null):null},[a,d,i]);return t.jsx(Pu,{open:e,onOpenChange:s,children:t.jsxs(Du,{side:"right",className:"w-80 sm:w-96","data-test":"undo-tree-explorer",children:[t.jsx(Ou,{children:t.jsxs(Lu,{className:"flex items-center gap-2",children:[t.jsx(pr,{className:"h-5 w-5"}),"Undo History"]})}),t.jsxs("div",{className:"mt-4 space-y-4","data-test":"undo-tree-controls",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(ee,{variant:"outline",size:"sm",onClick:u,disabled:!c,"data-test":"undo-button",children:[t.jsx(ir,{className:"h-4 w-4 mr-1"}),"Undo"]}),t.jsxs(ee,{variant:"outline",size:"sm",onClick:h,disabled:!l,"data-test":"redo-button",children:[t.jsx(qc,{className:"h-4 w-4 mr-1"}),"Redo"]}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:g,disabled:a.length===0,className:"ml-auto text-muted-foreground hover:text-destructive","data-test":"clear-history-button",children:t.jsx(vt,{className:"h-4 w-4"})})]}),t.jsxs("div",{className:"text-sm text-muted-foreground","data-test":"history-stats",children:[a.length," operations in history"]}),t.jsx(Gs,{className:"h-[calc(100vh-200px)]","data-test":"undo-tree-scroll",children:w?t.jsx("div",{className:"pr-4","data-test":"undo-tree-content",children:w.map((m,x)=>t.jsx(kS,{item:m,isCurrent:m.node.id===(i==null?void 0:i.id),onJump:f,isLast:x===w.length-1},m.node.id))}):t.jsxs("div",{className:"text-center text-muted-foreground py-8","data-test":"empty-history",children:["No undo history yet.",t.jsx("br",{}),t.jsx("span",{className:"text-xs",children:"Drag nodes or resize them to start recording."})]})})]})]})})}function jS(e,s,n){const o=new Map(e.map(i=>[i.id,i])),r=[];function a(i,c,l,d,u){const h=o.get(i);h&&(r.push({node:h,depth:c,hasSiblings:u,isLastChild:d,branchIndex:l}),h.children.forEach((f,g)=>{a(f,c+1,g,g===h.children.length-1,h.children.length>1)}))}return a(s,0,0,!0,!1),r}function kS({item:e,isCurrent:s,onJump:n,isLast:o}){const{node:r,depth:a,hasSiblings:i,branchIndex:c}=e,l=p.useMemo(()=>new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[r.timestamp]);return t.jsxs("div",{className:"relative",style:{marginLeft:a*16},"data-test":"undo-tree-node",children:[a>0&&t.jsx("div",{className:ve("absolute left-[-12px] top-0 h-full w-px bg-border",o&&"h-3")}),a>0&&t.jsx("div",{className:"absolute left-[-12px] top-3 w-3 h-px bg-border"}),i&&c>0&&t.jsx("div",{className:"absolute left-[-14px] top-2 w-2 h-2 rounded-full bg-muted-foreground/50",title:`Branch ${c+1}`}),t.jsx("button",{onClick:()=>n(r.id),className:ve("w-full text-left px-2 py-1.5 rounded-md text-sm transition-colors","hover:bg-accent hover:text-accent-foreground",s&&"bg-primary/10 border border-primary/30 font-medium"),"data-test":"undo-tree-jump-button",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:ve("w-2 h-2 rounded-full flex-shrink-0",s?"bg-primary":"bg-muted-foreground/30")}),t.jsx("span",{className:"truncate flex-1",children:r.label??r.operation.type}),t.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[t.jsx(rs,{className:"h-3 w-3"}),l]})]})})]})}const AS=()=>{const e=F(l=>l.uiState.holdSelectProgress),[s,n]=p.useState(0),[o,r]=p.useState(null);if(p.useEffect(()=>{const l=document.querySelector('[data-test="canvas-tab-bar"]'),d=document.querySelector('[data-test="canvas-chat-input-container"]');if(l&&d){const u=l.getBoundingClientRect(),h=d.getBoundingClientRect();r({top:u.bottom,bottom:window.innerHeight-h.top})}else r({top:J.holdToSelect.indicatorTopOffset,bottom:J.holdToSelect.indicatorBottomOffset})},[e]),p.useEffect(()=>{if(!e){n(0);return}let l;const d=Date.now(),u=e.durationMs,h=()=>{const f=Date.now()-d,g=Math.min(f/u,1);n(g),g<1&&e&&(l=requestAnimationFrame(h))};return l=requestAnimationFrame(h),()=>{l&&cancelAnimationFrame(l)}},[e]),!e||!o)return null;const i=e.touchX<window.innerWidth/2?"right":"left",c=s*100;return t.jsx("div",{className:je("fixed w-0.5 z-50 pointer-events-none",i==="left"?"left-1":"right-1"),style:{top:`${o.top}px`,bottom:`${o.bottom}px`},"data-test":"hold-progress-indicator",children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center",children:[t.jsx("div",{className:"absolute w-full bg-primary rounded-full",style:{height:`${c}%`,top:`${50-c/2}%`},"data-test":"hold-progress-line"}),t.jsx("div",{className:"absolute bg-primary/30 rounded-full blur-sm",style:{height:`${c}%`,top:`${50-c/2}%`,width:"2px"},"data-test":"hold-progress-glow"}),t.jsx("div",{className:je("absolute w-0.5 h-0.5 rounded-full bg-primary shadow-lg transition-transform duration-150",s>0?"scale-100":"scale-0"),style:{top:"50%",transform:`translateY(-50%) scale(${s>0?1:0})`},"data-test":"hold-progress-dot"})]})})},io=50,IS=()=>{var i;const e=F(c=>c.uiState.nodeHoldToResize),s=(i=e==null?void 0:e.edge)==null?void 0:i.includes("-");if(!e||!s||e.touchX===void 0||e.touchY===void 0)return null;const{touchX:n,touchY:o,isHolding:r,isReady:a}=e;return t.jsx("div",{className:je("fixed rounded-full pointer-events-none","transition-all duration-150",a?"bg-emerald-500/30 shadow-[0_0_20px_10px_rgba(16,185,129,0.4)]":r?"bg-amber-500/20 shadow-[0_0_15px_8px_rgba(245,158,11,0.3)]":"bg-primary/10"),style:{width:io,height:io,left:n-io/2,top:o-io/2,zIndex:9999},"data-test":"resize-hold-indicator"})},oC=({width:e,height:s,className:n,style:o})=>{var N;const r=p.useRef(null),a="cursor-default",i=F(b=>b.uiState.isHoldSelectActive??!1),c=p.useRef(E.getState().setCanvasDimensions),l=p.useRef(async(b=!1,S)=>{var B,H;const I=E.getState(),C=((B=I.projectCanvas.getActive())==null?void 0:B.coreState.nodes)??[],k=((H=I.projectCanvas.getActive())==null?void 0:H.coreState.arrows)??[];let R=S;if(!R){const M=C.find(j=>{var P;return((P=j.data)==null?void 0:P.nodeType)==="workflowOrchestration"});R=(M==null?void 0:M.id)||"wf-orchestration-001"}const A=new Zs;A.loadWorkflow(C,k);const T=await A.executeWorkflow(R),O=[],$=b?C.map(M=>({...M})):[];return T.nodeStates&&(T.nodeUpdates&&T.nodeUpdates.length>0&&T.nodeUpdates.forEach(M=>{const j=C.find(P=>P.id===M.nodeId);if(j){const P=Array.isArray(j.tags)?j.tags:[],W=M.updates.tags!==void 0?Array.isArray(M.updates.tags)?M.updates.tags:[]:P;if(O.push({nodeId:M.nodeId,before:{title:j.title,content:typeof j.content=="string"?j.content:void 0,tags:P},after:{title:M.updates.title!==void 0?M.updates.title:j.title,content:M.updates.content!==void 0?M.updates.content:typeof j.content=="string"?j.content:void 0,tags:W}}),b){const L=$.find(z=>z.id===M.nodeId);L&&(M.updates.title!==void 0&&(L.title=M.updates.title),M.updates.content!==void 0&&(L.content=M.updates.content),M.updates.tags!==void 0&&(L.tags=M.updates.tags))}}b||I.updateNode(M.nodeId,M.updates)}),T.nodeStates.forEach((M,j)=>{var D,K,te;const P=C.find(ie=>ie.id===j);if(!P)return;const W=(D=P.data)==null?void 0:D.nodeType,L=P.type,G=W==="workflowSource"||L==="WORKFLOW_SOURCE"||(W==="workflowOrchestration"||L==="WORKFLOW_ORCHESTRATION");let V=((K=M.executionData)==null?void 0:K.formattedOutput)||((te=M.executionData)==null?void 0:te.output)||P.content;if(V!=null&&typeof V=="object"&&(V=JSON.stringify(V,null,2)),!b){const ie={content:G?P.content:V,data:{...P.data||{},executionState:M.executionState}};I.updateNode(j,ie)}})),{...T,success:T.success,errors:T.errors||[],changes:O,previewNodes:$,currentNodes:C,arrows:k}}),[d,u]=p.useState({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null}),[h,f]=p.useState({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]});p.useEffect(()=>{const b=r.current;if(!b)return;c.current(b.offsetWidth,b.offsetHeight);const S=new ResizeObserver(I=>{for(const C of I){const{width:k,height:R}=C.contentRect;c.current(k,R)}});return S.observe(b),()=>{S.disconnect()}},[]),p.useEffect(()=>{var b;(b=r.current)==null||b.focus()},[]);const g=p.useMemo(()=>({executeWorkflow:(b,S)=>l.current(b,S),showDryRunResults:b=>{f({isVisible:!0,changes:b.changes||[],previewNodes:b.previewNodes||[],currentNodes:b.currentNodes||[],arrows:b.arrows||[],executionResult:b})},showLinkedNodesPopover:(b,S)=>{u({isVisible:!0,sourceNode:b,newlyCreatedNodeId:S||null})}}),[]),w=b=>{const{newlyCreatedNodeId:S}=d;if(S){const I=E.getState(),C=I.getNodeById(S);if(C&&typeof C.content=="string"){const R=(typeof b.content=="string"?b.content:"")+`

`+C.content;I.updateNode(b.id,{content:R}),I.deleteNodeById(S)}}},m=()=>{u({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null})},x=((N=E.getState().projectCanvas.getActive())==null?void 0:N.coreState.nodes)??[],y=F(b=>b.uiState.undoTreeExplorerOpen??!1),v=p.useCallback(b=>{E.getState().setUiState(S=>({...S,undoTreeExplorerOpen:b}))},[]);return t.jsx(By,{value:g,children:t.jsx(Op,{value:r,children:t.jsxs("div",{className:"flex flex-col",style:{width:e,height:s},children:[t.jsx(Pd,{}),t.jsxs("div",{ref:r,id:"CanvasAppV2","data-canvas-container":!0,className:je("relative","overflow-hidden","focus:outline-none","flex-1",a,n,i&&"ring-2 ring-inset ring-primary/50 bg-primary/5"),style:{touchAction:"none",...o},tabIndex:0,children:[t.jsx(sm,{}),t.jsx(vS,{}),t.jsx(AS,{}),t.jsx(IS,{}),d.sourceNode&&t.jsx(bS,{sourceNode:d.sourceNode,allNodes:x,onNodeSelect:w,onClose:m,isVisible:d.isVisible}),t.jsx(NS,{isVisible:h.isVisible,changes:h.changes,previewNodes:h.previewNodes,currentNodes:h.currentNodes,arrows:h.arrows,executionResult:h.executionResult,onApply:async()=>{f({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]}),await l.current(!1)},onCancel:()=>{f({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]})}}),t.jsx(CS,{open:y,onOpenChange:v})]})]})})})};export{oC as C,ks as E,nC as a,vl as c,Mp as s,F as u};
