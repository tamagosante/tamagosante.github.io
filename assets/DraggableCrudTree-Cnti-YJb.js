import{r as c,j as e}from"./react-vendor-BOZDwKwV.js";import{W as $,w as U,B as T}from"./index-Cmkaodfg.js";import{D as ee}from"./DragDropManager-BCQ9eUTy.js";import{r as te,f as Z,D as re,i as ne}from"./DropIndicator-GmEeK0_B.js";import{a9 as ae,y as se,X as oe,aa as le,D as ce,a7 as de,a8 as ie}from"./icons-Cf9puwNc.js";function G({node:t,level:E,parentId:C,index:B,onItemClick:S,onUpdate:I,onDelete:y,defaultExpandedIds:A,selectedId:H,enableEdit:M=!0,enableDelete:N=!0,enableDrag:O=!0,deleteConfirmMessage:D,renderNode:b,dragSortIndex:h,dragTargetParent:Y,draggedNodeId:j,onTreeStructureChange:w,allNodes:z}){const[m,g]=c.useState((A==null?void 0:A.has(t.id))??!1),[R,k]=c.useState(!1),[L,q]=c.useState(t.label),o=!!(t.children&&t.children.length>0),u=H===t.id,x=c.useRef(null);c.useEffect(()=>{w()},[m,w]),c.useEffect(()=>{u&&x.current&&x.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[u]);const d=a=>{a.stopPropagation(),R||(o&&g(!m),S==null||S(t))},s=()=>{L.trim()&&L!==t.label&&(I==null||I(t.id,L.trim())),k(!1)},l=()=>{q(t.label),k(!1)},p=a=>{a.stopPropagation();const X=(D==null?void 0:D(t))??`Are you sure you want to delete "${t.label}"?`;window.confirm(X)&&(y==null||y(t.id))},n={paddingLeft:`${E*1.5}rem`},r=o?e.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:m?e.jsx(de,{className:"h-4 w-4"}):e.jsx(ie,{className:"h-4 w-4"})}):e.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),i=j&&j!==t.id&&Y===C&&h===B,f=e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"drop-indicator h-0.5 bg-primary -mt-1 mb-1",style:n}),e.jsxs("div",{ref:x,className:$("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",u&&"bg-primary/10 border border-primary"),style:n,onClick:d,children:[O&&e.jsx("div",{"data-drag-handle":t.id,"data-parent-id":C,className:"drag-handle cursor-grab active:cursor-grabbing mr-1 opacity-0 group-hover:opacity-100",children:e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"})}),r,t.icon&&e.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:t.icon}),R?e.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[e.jsx(U,{type:"text",value:L,onChange:a=>q(a.target.value),onKeyDown:a=>{a.key==="Enter"&&s(),a.key==="Escape"&&l()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:a=>a.stopPropagation()}),e.jsx(T,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),s()},className:"h-6 w-6 p-0",children:e.jsx(se,{className:"h-3 w-3"})}),e.jsx(T,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),l()},className:"h-6 w-6 p-0",children:e.jsx(oe,{className:"h-3 w-3"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tree-item-label flex-grow truncate",title:t.label,children:t.label}),e.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[M&&I&&e.jsx(T,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),k(!0)},className:"h-6 w-6 p-0",children:e.jsx(le,{className:"h-3 w-3"})}),N&&y&&e.jsx(T,{variant:"ghost",size:"sm",onClick:p,className:"h-6 w-6 p-0 text-destructive hover:text-destructive",children:e.jsx(ce,{className:"h-3 w-3"})})]})]})]})]});return e.jsxs("div",{className:"draggable-crud-tree-item",children:[b?b(t,u,o,f):f,o&&m&&e.jsx("div",{"data-drop-zone":t.id,"data-node-name":t.label,children:t.children.map((a,X)=>e.jsx(G,{node:a,level:E+1,parentId:t.id,index:X,onItemClick:S,onUpdate:I,onDelete:y,defaultExpandedIds:A,selectedId:H,enableEdit:M,enableDelete:N,enableDrag:O,deleteConfirmMessage:D,renderNode:b,dragSortIndex:h,dragTargetParent:Y,dragOverNode:null,dragX:null,dragY:null,dragExpectedX:null,dragExpectedY:null,draggedNodeId:j,dragNextNodeLabel:null,onTreeStructureChange:w,allNodes:z},a.id))})]})}function fe({data:t,onReorder:E,onItemClick:C,onUpdate:B,onDelete:S,className:I,defaultExpandedIds:y,selectedId:A,enableEdit:H=!0,enableDelete:M=!0,enableDrag:N=!0,deleteConfirmMessage:O,renderNode:D}){const b=c.useRef(null),h=c.useRef(t),Y=c.useRef(E),j=c.useRef(null),w=c.useRef([]),z=c.useRef(null),m=c.useRef({targetParent:null,sortIndex:null});c.useEffect(()=>{h.current=t,Y.current=E},[t,E]);const[g,R]=c.useState({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),[k,L]=c.useState(0),q=c.useCallback(()=>{L(o=>o+1)},[]);return c.useEffect(()=>{if(N)return b.current=new ee({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:({item:o})=>{const u=o.data.nodeId;z.current=null,m.current={targetParent:null,sortIndex:null};const x=document.querySelector(`[data-drag-handle="${u}"]`);if(x){const n=x.parentElement;if(n){const r=n.getBoundingClientRect();j.current={top:Math.round(r.top),bottom:Math.round(r.bottom)}}}const d=[];document.querySelectorAll("[data-drag-handle]").forEach(n=>{const r=n.getAttribute("data-drag-handle");if(r){const i=n.parentElement;if(i){const f=i.getBoundingClientRect(),a=Z(h.current,r);d.push({id:r,label:(a==null?void 0:a.node.label)||r,rect:{top:Math.round(f.top),bottom:Math.round(f.bottom)}})}}});const l=new Map;d.forEach(n=>{const r=n.rect.bottom-n.rect.top,i=l.get(n.id);if(!i)l.set(n.id,n);else{const f=i.rect.bottom-i.rect.top;r<f&&l.set(n.id,n)}});const p=Array.from(l.values());return p.sort((n,r)=>n.rect.top-r.rect.top),w.current=p,R({isDragging:!0,nodeId:o.id,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),!0},onDragMove:({item:o,position:u})=>{var a,X;o.data.nodeId;const x=Math.round(u.x),d=Math.round(u.y),s=j.current;if(s&&d>=s.top&&d<=s.bottom){R(v=>({...v,x,y:d,sortIndex:null,targetParent:null,overNode:null,expectedX:null,expectedY:null,nextNodeLabel:null}));return}const n=w.current.find(v=>d>=v.rect.top&&d<=v.rect.bottom);let r=null;if(n){const v=Z(h.current,n.id);if(v){const W=n.rect.bottom-n.rect.top,F=(d-n.rect.top)/W,J=F>=.33&&F<.66,Q=F>=.66;if(J)r={targetParentId:n.id,sortIndex:0};else if(Q){const P=v.parent,K=(P===null?h.current:((a=Z(h.current,P))==null?void 0:a.node.children)||[]).findIndex(V=>V.id===n.id);r={targetParentId:P,sortIndex:K+1}}else{const P=v.parent,K=(P===null?h.current:((X=Z(h.current,P))==null?void 0:X.node.children)||[]).findIndex(V=>V.id===n.id);r={targetParentId:P,sortIndex:K}}}r&&(z.current=r)}else z.current&&(r=z.current);const i=(r==null?void 0:r.targetParentId)??null,f=(r==null?void 0:r.sortIndex)??0;m.current={targetParent:i??null,sortIndex:f??null},R(v=>({...v,sortIndex:f??null,targetParent:i??null,overNode:i??null,x,y:d,expectedX:null,expectedY:null,nextNodeLabel:null}))},onDrop:({item:o})=>{const u=o.data.nodeId,x=m.current.targetParent,d=m.current.sortIndex;if(d==null)return;const{newNodes:s,removed:l}=te(h.current,u);if(!l)return;const p=ne(s,l,x,d);Y.current&&Y.current(p)},onDragEnd:()=>{j.current=null,w.current=[],m.current={targetParent:null,sortIndex:null},R({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null})}}),()=>{var o;(o=b.current)==null||o.destroy()}},[N]),c.useEffect(()=>{if(!b.current||!N)return;document.querySelectorAll('[data-dnd-registered="true"]').forEach(s=>s.removeAttribute("data-dnd-registered")),document.querySelectorAll('[data-dnd-zone-registered="true"]').forEach(s=>s.removeAttribute("data-dnd-zone-registered")),document.querySelectorAll("[data-drop-zone]").forEach(s=>{const l=s.getAttribute("data-drop-zone"),p=s.getAttribute("data-node-name");l&&(b.current.registerDropZone(l,s,void 0,{nodeName:p||l}),s.setAttribute("data-dnd-zone-registered","true"))}),document.querySelectorAll("[data-drag-handle]").forEach(s=>{const l=s.getAttribute("data-drag-handle"),p=s.getAttribute("data-parent-id");let n="root",r=s.parentElement;for(;r;){const i=r.getAttribute("data-drop-zone");if(i){n=i;break}r=r.parentElement}l&&(b.current.registerDraggable(l,s,{nodeId:l,parentId:p||null,dropZoneId:n}),s.setAttribute("data-dnd-registered","true"))})},[t,k,N]),e.jsx("div",{className:$("draggable-crud-tree",I),children:e.jsxs("div",{"data-drop-zone":"root","data-node-name":"root","data-tree-root":!0,style:{position:"relative"},children:[t.map((o,u)=>e.jsx(G,{node:o,level:0,parentId:null,index:u,onItemClick:C,onUpdate:B,onDelete:S,defaultExpandedIds:y,selectedId:A,enableEdit:H,enableDelete:M,enableDrag:N,deleteConfirmMessage:O,renderNode:D,dragSortIndex:g.sortIndex,dragTargetParent:g.targetParent,dragOverNode:g.overNode,dragX:g.x,dragY:g.y,dragExpectedX:g.expectedX,dragExpectedY:g.expectedY,draggedNodeId:g.nodeId,dragNextNodeLabel:g.nextNodeLabel,onTreeStructureChange:q,allNodes:t},o.id)),g.sortIndex===t.length&&g.targetParent===null&&e.jsx(re,{message:"Drop at end"})]})})}export{fe as D};
