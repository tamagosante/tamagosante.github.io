const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePage-RmNg9dJQ.js","assets/react-vendor-Byz07MLO.js","assets/icons-Detj0uxE.js","assets/recordingStorage-XzvoUejy.js","assets/utils-DjFvUtuq.js","assets/radix-ui-B6r6BEmy.js","assets/ui-utils-BxIQ3qGg.js","assets/Chat-BOgunWdw.js","assets/format-utils-CaqrGWxs.js","assets/InputWithAudio-CzUvHOTY.js","assets/TTSApiClient-Dx-9h8RF.js","assets/systemPromptService-CiGRUnu2.js","assets/Settings-BAZkUET2.js","assets/Demo-CKHfUoXc.js","assets/Breadcrumbs-CbFAFVWz.js","assets/JsonViewerApp-BHZpouoC.js","assets/Content-Bu0Kd-oa.js","assets/TablePage-CqfF-1-y.js","assets/data-table-DmjaQFwn.js","assets/table-ChpbC9co.js","assets/VocabularyPage-DeMtOtno.js","assets/definitionHelper-B0BF7rqf.js","assets/useVietnameseTyping-Cie0Fw5O.js","assets/TextareaPopoverAtCursor-BhwkV6wH.js","assets/cursorPosition-otMhJ5rZ.js","assets/LiveTranscriptionPage-DKocCszE.js","assets/AudioPanelDemo-B9qNwx6H.js","assets/ClaudePage-B27m3xzK.js","assets/SessionSidebar-DBUw_wJV.js","assets/tree-C6vP2RM6.js","assets/useSessionKeyboardNavigation-lTEDYtsm.js","assets/SessionDetailsPage-YiFKwxri.js","assets/ForksPage-D3VQeLgG.js","assets/KanbanPage-83vBUJg1.js","assets/DemoLayout-0I0GV7in.js","assets/react-hooks-CNdHs55p.js","assets/DragDropManager-CacIWg_Z.js","assets/SFSService-Bi7ZspKk.js","assets/KanbanDataPage-Bbxw-L51.js","assets/index-BJrGcvsO.js","assets/GlobalStatePage-DxM4UCqI.js","assets/GamePage-BngJK_tK.js","assets/NewHomeApp-C3gt7eFB.js","assets/CanvasAppV2-diaRJWb7.js","assets/VimInputHandlerV2-Bn_zUAax.js","assets/logging-DcJ9NSa2.js","assets/string-4WCj7OpV.js","assets/clipboardHtmlToMarkdown-BNZmEbgs.js","assets/VimInputHandlerV2-BfpIuMTm.css","assets/UiButtonWithExpandOption-BTBhg6Mq.js","assets/DraggableCrudTree-DuzWpmL_.js","assets/treeHelpers-DUv_6quS.js","assets/globalFacadeRegistry-BlelMPVg.js","assets/WorkflowRowItem-D2K2N_Kr.js","assets/UiDataTable-D7m-Jspi.js","assets/markdownToHtml-C-4HvgxL.js","assets/DraggableTree-B-b0vQsJ.js","assets/useOcr-DjwVfUqd.js","assets/alert-BK0jqY_S.js","assets/context-menu-kZ000qFP.js","assets/easy-form-Bspz1wFS.js","assets/forms-B7OAPNGv.js","assets/form-DpD9XZBk.js","assets/SlashCommandMenu-DnqxuuX6.js","assets/MobileLogViewer-BZAVJcj3.js","assets/userStoreLocalStorage-D-7v21rP.js","assets/userCanvasStateStorage-BEvN2V8a.js","assets/SttPage-C5sFNl15.js"])))=>i.map(i=>d[i]);
var su=Object.defineProperty;var nu=(s,e,t)=>e in s?su(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var ee=(s,e,t)=>nu(s,typeof e!="symbol"?e+"":e,t);import{r as h,j as a,e as ru,f as uo,d as Si,k as Na,b as au,R as ou,l as iu,B as cu}from"./react-vendor-Byz07MLO.js";import{B as lu,m as po,d as du,t as Ee,_ as mt,z as uu,T as pu}from"./utils-DjFvUtuq.js";import{p as Rs,t as ji,O as tr,d as ka,C as cn,s as Ea,v as sr,D as nr,R as Ci,w as hu,x as Ni,y as fu,z as mu,A as gu,B as xu,E as vu,F as bu,H as wu,J as yu,K as Su,M as ju,N as ki,Q as Ei,U as Ii,V as Cu,W as Nu,X as ku,Y as Eu,Z as Ti,$ as Iu,a0 as Tu,a1 as Ai,a2 as Au,a3 as Pi,a4 as Pu,a5 as Ru,a6 as Ri,a7 as Di,a8 as Du,a9 as _i,aa as Oi,ab as Li,ac as _u,ad as Ou,ae as Lu,af as Mu,ag as Mi,ah as Fi,ai as $i,aj as Ui,ak as Bi,al as Wi,am as Fu,an as zi,ao as Hi,ap as Gi,aq as qi,ar as $u,as as Uu,at as Bu,au as Vi,av as Wu,aw as zu,ax as Ki,ay as Hu,az as Gu,aA as Ji,aB as Yi,aC as Xi,aD as Qi,aE as Zi,aF as qu}from"./radix-ui-B6r6BEmy.js";import{t as Vu,a as qs,c as ln}from"./ui-utils-BxIQ3qGg.js";import{X as ht,bN as Ku,bO as ho,bP as Ju,y as qt,M as Lr,G as ts,bw as Yu,bp as Xu,N as rr,bQ as ec,bR as Qu,bb as tc,aJ as Zu,bu as Mr,b as ep,bS as Fr,bT as $r,bU as Ur,az as Br,h as Wr,ad as zr,V as Ds,O as Ft,a2 as Ks,F as Js,bj as tp,bk as sp,bV as np,bW as rp,ai as ap,ab as sc,ae as op,bm as ip,bX as cp,D as Ia,T as Et,bY as lp,a as nc,a1 as Ta,aL as Aa,bZ as Pa,g as wt,C as ct,f as ar,$ as dp,S as Nn,q as rc,bt as up,ap as pp,b0 as br,c as kn,l as On,W as Ys,a3 as or,b_ as ac,bA as hp,b7 as fp,ao as oc,d as ir,P as mp,aa as Xs,b$ as gp,c0 as xp,e as Ra,K as vp,w as Fs,E as Hr,i as fo,bl as Ln,aU as Gr,c1 as bp,as as Qs,c2 as wp,bg as yp,a5 as Sp,a$ as qr,c3 as jp,aZ as Cp,c4 as Np,aF as mo,aG as go,j as xo,bB as vo,c5 as kp,c6 as Ep,ar as ic,Y as Ip}from"./icons-Detj0uxE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const ps=class ps{constructor(){ee(this,"logs",[]);ee(this,"counter",0);ee(this,"maxLogs",100);ee(this,"listeners",[]);ee(this,"isCollecting",!1);ee(this,"collectedLogs",[]);ee(this,"originalConsole",{log:console.log,warn:console.warn,error:console.error,debug:console.debug})}static getInstance(){return ps.instance||(ps.instance=new ps),ps.instance}log(e,t="info",n){const r=new Date().toLocaleTimeString(),o={id:`log-${this.counter++}`,timestamp:r,message:e,level:t,service:n},i=t==="error"?console.error:t==="warning"?console.warn:t==="debug"?console.debug:console.log,c=n?`[${n}] `:"",l=`[${r}] ${c}${e}`;i(l),this.isCollecting&&this.collectedLogs.push(l),this.logs=[o,...this.logs.slice(0,this.maxLogs-1)],this.notifyListeners()}info(e,t){this.log(e,"info",t)}error(e,t){this.log(e,"error",t)}warning(e,t){this.log(e,"warning",t)}debug(e,t){this.log(e,"debug",t)}getLogs(){return this.logs}clear(){this.logs=[],this.notifyListeners()}export(){return this.logs.slice().reverse().map(e=>{const t=e.service?`[${e.service}] `:"";return`[${e.timestamp}] ${e.level.toUpperCase()}: ${t}${e.message}`}).join(`
`)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}collectLogs(e=!0){this.isCollecting=!0,this.collectedLogs=[],e&&typeof window<"u"&&this.interceptConsole(),console.log("ðŸ“ Log collection started. Call window.printCollectedLogs() to retrieve.")}interceptConsole(){const e=this;console.log=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(n),e.originalConsole.log.apply(console,t)},console.warn=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`WARN: ${n}`),e.originalConsole.warn.apply(console,t)},console.error=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`ERROR: ${n}`),e.originalConsole.error.apply(console,t)},console.debug=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`DEBUG: ${n}`),e.originalConsole.debug.apply(console,t)}}restoreConsole(){console.log=this.originalConsole.log,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,console.debug=this.originalConsole.debug}stopCollecting(){this.isCollecting=!1,this.restoreConsole();const e=this.collectedLogs.join(`
`);return console.log("ðŸ›‘ Log collection stopped."),e}getCollectedLogs(){return this.collectedLogs.join(`
`)}clearCollectedLogs(){this.collectedLogs=[]}};ee(ps,"instance");let Vr=ps;const Re=Vr.getInstance();typeof window<"u"&&(window.getCollectedLogs=()=>Re.getCollectedLogs(),window.printCollectedLogs=()=>{const s=Re.getCollectedLogs();return console.log(`ðŸ“‹ Collected logs:
`+s),s},window.startCollectingLogs=()=>Re.collectLogs(),window.stopCollectingLogs=()=>Re.stopCollecting(),window.clearCollectedLogs=()=>Re.clearCollectedLogs());const cc=()=>{const[s,e]=h.useState(()=>Re.getLogs());h.useEffect(()=>Re.subscribe(r=>{e(r)}),[]);const t=h.useRef();return t.current||(t.current={log:(n,r,o)=>Re.log(n,r,o),info:(n,r)=>Re.info(n,r),error:(n,r)=>Re.error(n,r),warning:(n,r)=>Re.warning(n,r),debug:(n,r)=>Re.debug(n,r),clear:()=>Re.clear(),export:()=>Re.export()}),{logs:s,actions:t.current}};class Tp{constructor(e="http://localhost:3333"){ee(this,"baseUrl");ee(this,"eventSource",null);this.baseUrl=e}async getProjects(e){const t=new URLSearchParams;(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const n=`${this.baseUrl}/claude/projects${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch projects: ${r.statusText}`);return await r.json()}catch(r){throw console.error("[ClaudeAPI.getProjects] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,timestamp:new Date().toISOString()}),r}}async getProjectDetails(e){const t=`${this.baseUrl}/claude/projects/${encodeURIComponent(e)}`,n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch project details: ${n.statusText}`);return n.json()}async getSessions(e){const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.excludeAgents&&t.append("excludeAgents","true");const n=`${this.baseUrl}/claude/sessions-v2${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch sessions: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getSessions] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,errorStack:r instanceof Error?r.stack:void 0,timestamp:new Date().toISOString()}),r}}async searchSessions(e,t){const n=new URLSearchParams;e&&(t!=null&&t.messageTypes&&t.messageTypes.length>0?n.append("messageContent",e):n.append("q",e)),t!=null&&t.fields&&t.fields.length>0&&!(t!=null&&t.messageTypes&&t.messageTypes.length>0)&&n.append("fields",t.fields.join(",")),(t==null?void 0:t.isActive)!==void 0&&n.append("isActive",t.isActive.toString()),(t==null?void 0:t.minMessages)!==void 0&&n.append("minMessages",t.minMessages.toString()),(t==null?void 0:t.maxMessages)!==void 0&&n.append("maxMessages",t.maxMessages.toString()),t!=null&&t.modifiedAfter&&n.append("modifiedAfter",t.modifiedAfter),t!=null&&t.modifiedBefore&&n.append("modifiedBefore",t.modifiedBefore),t!=null&&t.messageTypes&&t.messageTypes.length>0&&n.append("messageTypes",t.messageTypes.join(",")),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/sessions/search${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to search sessions: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.searchSessions] Fetch error:",{url:r,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,errorStack:o instanceof Error?o.stack:void 0,timestamp:new Date().toISOString()}),o}}async searchSessionMessages(e,t,n){const r=new URLSearchParams;t&&r.append("content",t),n!=null&&n.messageType&&n.messageType.length>0?r.append("messageType",n.messageType.join(",")):n!=null&&n.role&&r.append("role",n.role),n!=null&&n.after&&r.append("after",n.after),n!=null&&n.before&&r.append("before",n.before),n!=null&&n.sortOrder&&r.append("sortOrder",n.sortOrder),(n==null?void 0:n.page)!==void 0&&r.append("page",n.page.toString()),(n==null?void 0:n.pageSize)!==void 0&&r.append("pageSize",n.pageSize.toString());const o=`${this.baseUrl}/claude/sessions/${e}/search${r.toString()?`?${r.toString()}`:""}`,i=await fetch(o);if(!i.ok)throw new Error(`Failed to search session messages: ${i.statusText}`);return i.json()}async searchMessages(e,t){const n=new URLSearchParams;e&&n.append("q",e),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageTypes",t.messageType.join(",")),t!=null&&t.after&&n.append("after",t.after),t!=null&&t.before&&n.append("before",t.before),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/messages/search${n.toString()?`?${n.toString()}`:""}`,o=await fetch(r);if(!o.ok)throw new Error(`Failed to search messages: ${o.statusText}`);return o.json()}async getSessionDetails(e,t){const n=new URLSearchParams;(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageType",t.messageType.join(","));const r=`${this.baseUrl}/claude/sessions-v2/${e}${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch session details: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionDetails] Fetch error:",{url:r,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,timestamp:new Date().toISOString()}),o}}async sendMessage(e){const t=await fetch(`${this.baseUrl}/claude/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to send message: ${t.statusText}`);return t.json()}async createSession(e={}){const t=await fetch(`${this.baseUrl}/claude/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to create session: ${t.statusText}`);return t.json()}async updateSessionName(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customName:t})});if(!n.ok)throw new Error(`Failed to update session name: ${n.statusText}`);return n.json()}async updateSessionStatus(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Failed to update session status: ${n.statusText}`);return n.json()}async forkSession(e,t){const n=`${this.baseUrl}/claude/sessions/${e}/fork`;try{const r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to create fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.forkSession] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForks(e){const t=new URLSearchParams;e!=null&&e.parentSessionId&&t.append("parentSessionId",e.parentSessionId),e!=null&&e.sessionId&&t.append("sessionId",e.sessionId),(e==null?void 0:e.favoritesOnly)!==void 0&&t.append("favoritesOnly",e.favoritesOnly.toString()),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.sortBy&&t.append("sortBy",e.sortBy),e!=null&&e.sortOrder&&t.append("sortOrder",e.sortOrder),e!=null&&e.category&&t.append("category",e.category),e!=null&&e.tag&&t.append("tag",e.tag);const n=`${this.baseUrl}/claude/forks${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch forks: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getForks] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForkDetails(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch fork details: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getForkDetails] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async updateFork(e,t){const n=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const r=await fetch(n,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to update fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.updateFork] Fetch error:",{url:n,forkId:e,updates:t,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async deleteFork(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t,{method:"DELETE"});if(!n.ok)throw new Error(`Failed to delete fork: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.deleteFork] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async getForkTags(){const e=`${this.baseUrl}/claude/fork-tags`;try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch fork tags: ${t.statusText}`);return t.json()}catch(t){throw console.error("[ClaudeAPI.getForkTags] Fetch error:",{url:e,error:t,errorMessage:t instanceof Error?t.message:"Unknown error",timestamp:new Date().toISOString()}),t}}async getSessionForks(e,t){const n=new URLSearchParams;(t==null?void 0:t.favoritesOnly)!==void 0&&n.append("favoritesOnly",t.favoritesOnly.toString()),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder);const r=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/forks${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch session forks: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionForks] Fetch error:",{url:r,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()}),o}}async getForkTree(e,t){const n=new URLSearchParams;t!=null&&t.includeMessages&&n.append("includeMessages","true"),t!=null&&t.messageTypes&&n.append("messageTypes",t.messageTypes),(t==null?void 0:t.messageLimit)!==void 0&&n.append("messageLimit",t.messageLimit.toString());const r=n.toString(),o=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/fork-tree${r?`?${r}`:""}`;try{const i=await fetch(o);if(!i.ok)throw new Error(`Failed to fetch fork tree: ${i.statusText}`);return i.json()}catch(i){throw console.error("[ClaudeAPI.getForkTree] Fetch error:",{url:o,sessionId:e,options:t,error:i,errorMessage:i instanceof Error?i.message:"Unknown error",timestamp:new Date().toISOString()}),i}}subscribeToSessionChanges(e,t){const n=`${this.baseUrl}/claude/sessions/events`;return this.eventSource=new EventSource(n),this.eventSource.onopen=()=>{var r;console.log("[ClaudeAPI.subscribeToSessionChanges] SSE connection opened:",{url:n,readyState:(r=this.eventSource)==null?void 0:r.readyState,timestamp:new Date().toISOString()})},this.eventSource.onmessage=r=>{try{const o=JSON.parse(r.data);o.type!=="connected"&&e(o)}catch(o){console.error("[ClaudeAPI.subscribeToSessionChanges] Failed to parse SSE event:",{error:o,eventData:r.data,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=r=>{var o,i,c,l;console.error("[ClaudeAPI.subscribeToSessionChanges] SSE connection error:",{error:r,readyState:(o=this.eventSource)==null?void 0:o.readyState,readyStateText:((i=this.eventSource)==null?void 0:i.readyState)===0?"CONNECTING":((c=this.eventSource)==null?void 0:c.readyState)===1?"OPEN":((l=this.eventSource)==null?void 0:l.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),t&&t(r)},()=>{var r;(r=this.eventSource)==null||r.close(),this.eventSource=null}}}const Ye=new Tp;class Ap{constructor(e="http://localhost:3333"){ee(this,"eventSource",null);ee(this,"eventHandlers",new Set);ee(this,"errorHandlers",new Set);ee(this,"baseUrl");ee(this,"reconnectAttempts",0);ee(this,"maxReconnectAttempts",5);ee(this,"reconnectDelay",1e3);this.baseUrl=e}subscribe(e,t){return this.eventHandlers.add(e),t&&this.errorHandlers.add(t),this.eventHandlers.size===1&&!this.eventSource&&this.connect(),()=>{this.eventHandlers.delete(e),t&&this.errorHandlers.delete(t),this.eventHandlers.size===0&&this.disconnect()}}connect(){const e=`${this.baseUrl}/claude/sessions/events`;this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.reconnectAttempts=0},this.eventSource.onmessage=t=>{try{const n=JSON.parse(t.data);if(n.type==="connected")return;this.eventHandlers.forEach(r=>{try{r(n)}catch(o){console.error("[ClaudeSSEManager] Error in event handler:",{error:o,eventType:n.type,timestamp:new Date().toISOString()})}})}catch(n){console.error("[ClaudeSSEManager] Failed to parse SSE event:",{error:n,eventData:t.data,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=t=>{var n,r,o,i;if(console.error("[ClaudeSSEManager] SSE connection error:",{error:t,readyState:(n=this.eventSource)==null?void 0:n.readyState,readyStateText:((r=this.eventSource)==null?void 0:r.readyState)===0?"CONNECTING":((o=this.eventSource)==null?void 0:o.readyState)===1?"OPEN":((i=this.eventSource)==null?void 0:i.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),this.errorHandlers.forEach(c=>{try{c(t)}catch(l){console.error("[ClaudeSSEManager] Error in error handler:",l)}}),this.eventHandlers.size>0&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const c=this.reconnectDelay*this.reconnectAttempts;setTimeout(()=>{this.eventHandlers.size>0&&(this.disconnect(),this.connect())},c)}}}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null,this.reconnectAttempts=0)}getConnectionState(){var e;return((e=this.eventSource)==null?void 0:e.readyState)??null}getSubscriberCount(){return this.eventHandlers.size}}const Pp=new Ap;function Da(s,e,t=!0){const n=h.useRef(s),r=h.useRef(e);h.useEffect(()=>{n.current=s},[s]),h.useEffect(()=>{r.current=e},[e]);const o=h.useCallback(l=>{n.current(l)},[]),i=h.useCallback(l=>{var d;(d=r.current)==null||d.call(r,l)},[]),c=h.useRef(!!e);h.useEffect(()=>{c.current=!!e},[e]),h.useEffect(()=>{if(!t)return;const l=Pp.subscribe(o,c.current?i:void 0);return()=>{l()}},[t,o,i])}function lc(s,e){const t={...s};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n],o=t[n];r&&typeof r=="object"&&!Array.isArray(r)&&o&&typeof o=="object"&&!Array.isArray(o)?t[n]=lc(o,r):t[n]=r}return t}class Rp{constructor(e={}){ee(this,"STORAGE_KEY","global-store");ee(this,"state$");const t=this.loadFromStorage();this.state$=new lu({...e,...t})}getState(){return this.state$.value}getState$(){return this.state$.asObservable()}get(e){return this.state$.value[e]}select(e){return this.state$.pipe(po(t=>t[e]),du())}selectSlice(e){return this.state$.pipe(po(e))}setState(e){this.state$.next(e),this.saveToStorage()}updateState(e){const t={...this.state$.value,...e};this.state$.next(t),this.saveToStorage()}set(e,t){this.updateState({[e]:t})}update(e,t){const n=this.state$.value[e],r=typeof n=="object"&&n!==null&&typeof t=="object"&&t!==null?lc(n,t):t;this.set(e,r)}remove(e){const t={...this.state$.value};delete t[e],this.state$.next(t),this.saveToStorage()}reset(){this.state$.next({}),this.clearStorage()}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load global store from localStorage:",e),{}}}saveToStorage(){try{const e=this.getStateToPersist(this.state$.value);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save global store to localStorage:",e)}}getStateToPersist(e){var n,r;const t={...e};if(t.ui&&(t.ui={...t.ui,directoryMaps:void 0}),(n=t.app)!=null&&n.claude){const o=t.app.claude;t.app={...t.app,claude:{...o,data:void 0,forks:void 0,ui:o.ui?{...o.ui,isInitialized:void 0,loadingSessions:void 0,sessionsError:void 0,projectsInitialized:void 0,loadingProjects:void 0,projectsError:void 0,activity:void 0}:void 0}}}if((r=t.app)!=null&&r.kanban){const o=t.app.kanban;t.app={...t.app,kanban:{...o,loading:void 0,error:void 0}}}return t}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear global store from localStorage:",e)}}export(){return JSON.stringify(this.state$.value,null,2)}import(e){try{const t=JSON.parse(e);return this.setState(t),!0}catch(t){return console.error("Failed to import global store data:",t),!1}}}const ie=new Rp;function Le(s){const[e,t]=h.useState(()=>s(ie.getState()));return h.useEffect(()=>{const n=ie.selectSlice(s).subscribe(t);return()=>n.unsubscribe()},[s]),e}function _a(){return{get:ie.get.bind(ie),set:ie.set.bind(ie),update:ie.update.bind(ie),updateState:ie.updateState.bind(ie),remove:ie.remove.bind(ie),reset:ie.reset.bind(ie),getState:ie.getState.bind(ie)}}const Dp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},_p=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1},Op=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.sessionsError)??null},Lp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.pagination)??null},Mp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.currentPage)??1},Fp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.isInitialized)??!1},$p=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.excludeAgents)??!1};function Up(s={}){const{loadOnMount:e=!0,subscribeToSSE:t=!0}=s,{update:n,getState:r}=_a(),o=h.useRef(!1),i=Le(Dp),c=Le(_p),l=Le(Op),d=Le(Lp),p=Le(Mp),u=Le(Fp),f=Le($p),m=async(S=1,C=!1)=>{var N,O,R,k,A,L;try{const M=(N=r().app)==null?void 0:N.claude;n("app",{claude:{ui:{...M==null?void 0:M.ui,loadingSessions:!0,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1}}});const I=((O=M==null?void 0:M.ui)==null?void 0:O.excludeAgents)??!1,z=await Ye.getSessions({page:S,pageSize:20,excludeAgents:I}),$=[...z.sessions].sort((te,E)=>new Date(E.lastModified).getTime()-new Date(te.lastModified).getTime()),q=((R=M==null?void 0:M.data)==null?void 0:R.sessions)??[],P=C?[...q,...$]:$;n("app",{claude:{data:{sessions:P,pagination:z.pagination||null},ui:{loadingSessions:!1,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}})}catch(M){console.error("[SessionLoader] API request failed:",{error:M,errorMessage:M instanceof Error?M.message:"Unknown error",page:S,append:C,timestamp:new Date().toISOString()}),Re.error(`Session load failed: ${M instanceof Error?M.message:"Unknown error"}`,"SessionLoader"),n("app",{claude:{data:{sessions:C?((L=(A=(k=r().app)==null?void 0:k.claude)==null?void 0:A.data)==null?void 0:L.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:M instanceof Error?M.message:"Failed to load sessions",currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}}),Re.error("Store updated with error state","SessionLoader")}},g=async(S,C,N=!1)=>{var O,R,k,A,L;try{const M=(O=r().app)==null?void 0:O.claude;n("app",{claude:{ui:{...M==null?void 0:M.ui,loadingSessions:!0,sessionsError:null,searchQuery:S,searchFilters:C,isSearchActive:!0}}});const I=await Ye.searchSessions(S,C),z=((R=M==null?void 0:M.data)==null?void 0:R.sessions)??[],$=N?[...z,...I.results]:I.results;n("app",{claude:{data:{sessions:$,pagination:I.pagination},ui:{loadingSessions:!1,sessionsError:null,currentPage:I.pagination.page,searchQuery:S,searchFilters:C,isSearchActive:!0}}})}catch(M){console.error("[SessionLoader] API request failed:",{error:M,errorMessage:M instanceof Error?M.message:"Unknown error",query:S,filters:C,append:N,timestamp:new Date().toISOString()}),n("app",{claude:{data:{sessions:N?((L=(A=(k=r().app)==null?void 0:k.claude)==null?void 0:A.data)==null?void 0:L.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:M instanceof Error?M.message:"Failed to search sessions",currentPage:1,searchQuery:S,searchFilters:C,isSearchActive:!0}}})}},x=(S,C)=>{var A,L,M;const N=((M=(L=(A=r().app)==null?void 0:A.claude)==null?void 0:L.data)==null?void 0:M.sessions)??[],O=N.findIndex(I=>I.id===S);if(O===-1)return;const R=[...N];R[O]={...R[O],...C};const k=R.sort((I,z)=>new Date(z.lastModified).getTime()-new Date(I.lastModified).getTime());n("app",{claude:{data:{sessions:k},ui:{loadingSessions:!1,sessionsError:null}}})},v=S=>{var O,R,k;const N=(((k=(R=(O=r().app)==null?void 0:O.claude)==null?void 0:R.data)==null?void 0:k.sessions)??[]).filter(A=>A.id!==S);n("app",{claude:{data:{sessions:N},ui:{loadingSessions:!1,sessionsError:null}}})},b=S=>{var N,O;const C=(O=(N=r().app)==null?void 0:N.claude)==null?void 0:O.ui;if(C!=null&&C.isSearchActive&&(C==null?void 0:C.searchQuery)!==void 0){const R={...C.searchFilters,page:S};g(C.searchQuery,R)}else m(S)},w=()=>{var S,C;if(d&&p<d.totalPages){const N=(C=(S=r().app)==null?void 0:S.claude)==null?void 0:C.ui;if(N!=null&&N.isSearchActive&&(N==null?void 0:N.searchQuery)!==void 0){const O={...N.searchFilters,page:p+1};g(N.searchQuery,O,!0)}else m(p+1,!0)}},y=()=>{m(1)},j=()=>{var N,O;const S=(N=r().app)==null?void 0:N.claude,C=!((O=S==null?void 0:S.ui)!=null&&O.excludeAgents);n("app",{claude:{ui:{...S==null?void 0:S.ui,excludeAgents:C}}}),m(1)};return h.useEffect(()=>{e&&(u||o.current||(o.current=!0,m(1)))},[u]),Da(S=>{S.type==="created"&&m(p),S.type==="modified"&&S.sessionId&&(async()=>{try{const C=await Ye.getSessionDetails(S.sessionId);x(S.sessionId,{name:C.name,lastModified:C.metadata.lastModified,messageCount:C.metadata.messageCount})}catch(C){console.error("[SSE] Failed to fetch modified session:",{sessionId:S.sessionId,error:C,timestamp:new Date().toISOString()})}})(),S.type==="batch-modified"&&S.sessionIds&&m(p),S.type==="deleted"&&S.sessionId&&v(S.sessionId),S.type==="session-input-received"&&S.sessionId&&(async()=>{var C,N,O;try{const R=await Ye.getSessionDetails(S.sessionId),k=(N=(C=R.messages)==null?void 0:C[R.messages.length-1])==null?void 0:N.content,A=typeof k=="string"?k:Array.isArray(k)?(O=k.find(L=>typeof L=="object"&&L!==null&&"type"in L&&L.type==="text"))==null?void 0:O.text:k==null?void 0:k.text;x(S.sessionId,{name:R.name,lastModified:R.metadata.lastModified,messageCount:R.metadata.messageCount,latestMessage:A})}catch(R){console.error("[SSE] Failed to fetch session after input received:",{sessionId:S.sessionId,error:R,timestamp:new Date().toISOString()})}})()},S=>{console.error("[SSE] Connection error:",{error:S,errorMessage:S instanceof Error?S.message:"Unknown error",timestamp:new Date().toISOString()})},t),{sessions:i,loadingSessions:c,sessionsError:l,pagination:d,currentPage:p,isInitialized:u,excludeAgents:f,loadSessions:m,searchSessions:g,refreshSessions:y,handlePageChange:b,handleLoadMore:w,toggleExcludeAgents:j}}const Bp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},Wp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},zp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},Hp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsInitialized)??!1};function Gp(s={}){const{loadOnMount:e=!0}=s,{update:t,getState:n}=_a(),r=h.useRef(!1),o=Le(Bp),i=Le(Wp),c=Le(zp),l=Le(Hp),d=async()=>{var u,f,m;try{const g=n(),x=(u=g.app)==null?void 0:u.claude;t("app",{...g.app,claude:{...x,data:{...x==null?void 0:x.data},ui:{...x==null?void 0:x.ui,loadingProjects:!0,projectsError:null}}});const v=await Ye.getProjects({pageSize:100}),b=n(),w=(f=b.app)==null?void 0:f.claude;t("app",{...b.app,claude:{...w,data:{...w==null?void 0:w.data,projects:v.projects},ui:{...w==null?void 0:w.ui,loadingProjects:!1,projectsError:null,projectsInitialized:!0}}})}catch(g){console.error("[ProjectsLoader] API request failed:",{error:g,errorMessage:g instanceof Error?g.message:"Unknown error",timestamp:new Date().toISOString()}),Re.error(`Projects load failed: ${g instanceof Error?g.message:"Unknown error"}`,"ProjectsLoader");const x=n(),v=(m=x.app)==null?void 0:m.claude;t("app",{...x.app,claude:{...v,data:{...v==null?void 0:v.data,projects:[]},ui:{...v==null?void 0:v.ui,loadingProjects:!1,projectsError:g instanceof Error?g.message:"Failed to load projects",projectsInitialized:!0}}}),Re.error("Store updated with error state","ProjectsLoader")}},p=()=>{d()};return h.useEffect(()=>{e&&(l||r.current||(r.current=!0,d()))},[l,e]),{projects:o,loadingProjects:i,projectsError:c,projectsInitialized:l,loadProjects:d,refreshProjects:p}}function qp(){const[s,e]=h.useState(new Set),t=h.useCallback(n=>n?s.has(n):!1,[s]);return Da(n=>{var o,i,c,l,d,p,u,f,m,g,x,v,b,w,y;if(n.type==="batch-modified")return;const r=n.sessionId;if(r){if(n.type==="session-started"&&e(j=>{const S=new Set(j);return S.add(r),S}),n.type==="session-ended"&&e(j=>{const S=new Set(j);return S.delete(r),S}),n.type==="session-opened"){const j=((c=(i=(o=ie.get("app"))==null?void 0:o.claude)==null?void 0:i.ui)==null?void 0:c.activity)??{},S={...j,[r]:{...j[r],isOpened:!0}};ie.update("app",{claude:{ui:{activity:S}}}),e(C=>{const N=new Set(C);return N.add(r),N})}if(n.type==="session-closed"){const j=((p=(d=(l=ie.get("app"))==null?void 0:l.claude)==null?void 0:d.ui)==null?void 0:p.activity)??{},S=((u=j[r])==null?void 0:u.isOpened)===!0||((f=j[r])==null?void 0:f.isProcessing)===!0,C={...j,[r]:{...j[r],isOpened:!!S,isProcessing:!1}};ie.update("app",{claude:{ui:{activity:C}}}),S||e(N=>{const O=new Set(N);return O.delete(r),O}),console.log("[useSessionRunningStatus] Session closed, keeping as opened:",S)}if(n.type==="session-processing-started"){const j=((x=(g=(m=ie.get("app"))==null?void 0:m.claude)==null?void 0:g.ui)==null?void 0:x.activity)??{},S={...j,[r]:{...j[r],isProcessing:!0,isOpened:!0}};ie.update("app",{claude:{ui:{activity:S}}}),e(C=>{const N=new Set(C);return N.add(r),N})}if(n.type==="session-processing-stopped"){const j=((w=(b=(v=ie.get("app"))==null?void 0:v.claude)==null?void 0:b.ui)==null?void 0:w.activity)??{},S={...j,[r]:{...j[r],isProcessing:!1}};ie.update("app",{claude:{ui:{activity:S}}}),(((y=S[r])==null?void 0:y.isOpened)??!1)||e(N=>{const O=new Set(N);return O.delete(r),O})}}},n=>{console.error("[useSessionRunningStatus] SSE connection error:",n)}),{isSessionRunning:t,runningSessions:s}}const wr=768,yr=500;function bs(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=window.matchMedia(`(max-width: ${wr-1}px)`),n=()=>{e(window.innerWidth<wr)};return t.addEventListener("change",n),e(window.innerWidth<wr),()=>t.removeEventListener("change",n)},[]),!!s}function Yj(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=()=>{const r=window.innerWidth<yr,o=window.innerHeight<yr&&window.innerWidth<window.innerHeight*2;e(r||o)},n=window.matchMedia(`(max-width: ${yr-1}px)`);return n.addEventListener("change",t),window.addEventListener("orientationchange",t),t(),()=>{n.removeEventListener("change",t),window.removeEventListener("orientationchange",t)}},[]),!!s}function B(...s){return Vu(qs(s))}const Vp={default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},Kp=ln("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive cursor-pointer",{variants:{variant:Vp,size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",compact:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-1.2",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",smIcon:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 [&_svg:not([class*='size-'])]:size-3",smIconCompact:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",sic:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),ue=h.forwardRef(({className:s,variant:e,size:t,asChild:n=!1,...r},o)=>{const i=n?Rs:"button";return a.jsx(i,{"data-slot":"button",className:B(Kp({variant:e,size:t,className:s})),ref:o,...r})});ue.displayName="Button";const We=h.forwardRef(({className:s,type:e,...t},n)=>a.jsx("input",{type:e,className:B("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:n,...t}));We.displayName="Input";const dc=h.forwardRef(({className:s,orientation:e="horizontal",decorative:t=!0,...n},r)=>a.jsx(ji,{ref:r,decorative:t,orientation:e,className:B("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...n}));dc.displayName=ji.displayName;const Jp=Ci,Yp=ka,uc=h.forwardRef(({className:s,...e},t)=>a.jsx(tr,{className:B("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...e,ref:t}));uc.displayName=tr.displayName;const Xp=ln("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),pc=h.forwardRef(({side:s="right",className:e,children:t,...n},r)=>a.jsxs(Yp,{children:[a.jsx(uc,{}),a.jsxs(cn,{ref:r,className:B(Xp({side:s}),e),...n,children:[a.jsxs(Ea,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[a.jsx(ht,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]}),t]})]}));pc.displayName=cn.displayName;const hc=({className:s,...e})=>a.jsx("div",{className:B("flex flex-col space-y-2 text-center sm:text-left",s),...e});hc.displayName="SheetHeader";const fc=h.forwardRef(({className:s,...e},t)=>a.jsx(sr,{ref:t,className:B("text-lg font-semibold text-foreground",s),...e}));fc.displayName=sr.displayName;const mc=h.forwardRef(({className:s,...e},t)=>a.jsx(nr,{ref:t,className:B("text-sm text-muted-foreground",s),...e}));mc.displayName=nr.displayName;function bo({className:s,...e}){return a.jsx("div",{className:B("animate-pulse rounded-md bg-primary/10",s),...e})}const Fe={xs:"w-3 h-3",sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},Xj={deleteButton:"text-red-600 hover:text-red-700 hover:bg-red-50"},Qj={input:"bg-green-500",process:"bg-blue-500",output:"bg-red-500",text:"bg-blue-500",select:"bg-purple-500",audio:"bg-green-500",default:"bg-gray-500"},Zj={base:"absolute w-4 h-4 bg-background rounded-full border-2 border-border transform -translate-y-1/2 cursor-crosshair z-10",input:"node-handle node-handle-input -left-2 top-1/2",output:"node-handle node-handle-output -right-2 top-1/2",hover:"hover:border-blue-400 hover:bg-accent",active:"border-blue-400 bg-accent"},Qp={input:"w-full p-2 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background",textarea:"w-full p-3 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring resize-y bg-background",label:"text-xs font-medium text-foreground block mb-1",error:"text-destructive text-xs mt-1"},eC=.2,st={popover:1500,skipLink:1600,tooltip:1800,backdrop:1550,draggablePopover:1560,slashCommandMenu:1565,draggablePopoverDropdown:1570,canvasGroups:1,canvasArrows:5,canvasNodes:10,canvasResizeHandles:15,nodeTextarea:10,nodeAudioButton:20,nodeQuickPanel:40,canvasChatInput:50,canvasOverlay:55,quickPanelPortal:1020,toolbarDropdown:1510,commandPalette:1750},ss=fu,ns=mu,rs=gu,Vt=h.forwardRef(({className:s,sideOffset:e=4,style:t,...n},r)=>a.jsx(hu,{children:a.jsx(Ni,{ref:r,sideOffset:e,className:B("overflow-hidden rounded-md border bg-card px-3 py-1.5 text-xs text-card-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",s),style:{zIndex:st.tooltip,...t},...n})}));Vt.displayName=Ni.displayName;class Zp{constructor(){ee(this,"STORAGE_KEY","ui-store")}getStore(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to parse UI store from localStorage:",e),{}}}setStore(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save UI store to localStorage:",t)}}get(e){return this.getStore()[e]}set(e,t){const n=this.getStore();n[e]=t,this.setStore(n)}update(e,t){const n=this.getStore(),r=n[e]||{};n[e]={...r,...t},this.setStore(n)}remove(e){const t=this.getStore();delete t[e],this.setStore(t)}clear(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear UI store:",e)}}getAllData(){return this.getStore()}export(){return JSON.stringify(this.getStore(),null,2)}import(e){try{const t=JSON.parse(e);return this.setStore(t),!0}catch(t){return console.error("Failed to import UI store data:",t),!1}}}const Kr=new Zp,eh="16rem",th="18rem",sh="3rem",nh="b",gc=h.createContext(null);function _s(){const s=h.useContext(gc);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const xc=h.forwardRef(({defaultOpen:s=!0,open:e,onOpenChange:t,className:n,style:r,children:o,...i},c)=>{const l=bs(),[d,p]=h.useState(!1),[u,f]=h.useState(()=>{const w=Kr.get("sidebar");return(w==null?void 0:w.isOpen)??s}),m=e??u,g=h.useCallback(w=>{const y=typeof w=="function"?w(m):w;t?t(y):f(y),Kr.update("sidebar",{isOpen:y})},[t,m]),x=h.useCallback(()=>l?p(w=>!w):g(w=>!w),[l,g,p]);h.useEffect(()=>{const w=y=>{y.key===nh&&(y.metaKey||y.ctrlKey)&&(y.preventDefault(),x())};return window.addEventListener("keydown",w),()=>window.removeEventListener("keydown",w)},[x]);const v=m?"expanded":"collapsed",b=h.useMemo(()=>({state:v,open:m,setOpen:g,isMobile:l,openMobile:d,setOpenMobile:p,toggleSidebar:x}),[v,m,g,l,d,p,x]);return a.jsx(gc.Provider,{value:b,children:a.jsx(ss,{delayDuration:0,children:a.jsx("div",{style:{"--sidebar-width":eh,"--sidebar-width-icon":sh,...r},className:B("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",n),ref:c,...i,children:o})})})});xc.displayName="SidebarProvider";const vc=h.forwardRef(({side:s="left",variant:e="sidebar",collapsible:t="offcanvas",className:n,children:r,...o},i)=>{h.useEffect(()=>{Kr.update("sidebar",{side:s,variant:e})},[s,e]);const{isMobile:c,state:l,openMobile:d,setOpenMobile:p,toggleSidebar:u}=_s();return t==="none"?a.jsx("div",{className:B("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",n),ref:i,...o,children:r}):c?a.jsx(Jp,{open:d,onOpenChange:p,...o,children:a.jsxs(pc,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":th},side:s,children:[a.jsxs(hc,{className:"sr-only",children:[a.jsx(fc,{children:"Sidebar"}),a.jsx(mc,{children:"Displays the mobile sidebar."})]}),a.jsx("div",{className:"flex h-full w-full flex-col",children:r})]})}):a.jsxs("div",{ref:i,className:"group peer hidden text-sidebar-foreground md:block","data-state":l,"data-collapsible":l==="collapsed"?t:"","data-variant":e,"data-side":s,children:[a.jsx("div",{className:B("relative bg-transparent transition-[width] duration-200 ease-linear",e==="floating"?"w-0":"w-[--sidebar-width]","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",e==="floating"||e==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),l==="expanded"&&t==="offcanvas"&&a.jsx("div",{className:"fixed inset-0 z-[55] bg-black/50",onClick:u}),a.jsx("div",{className:B("fixed inset-y-0 z-[60] hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",e==="floating"||e==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",n),...o,children:a.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:r})})]})});vc.displayName="Sidebar";const Jr=h.forwardRef(({className:s,onClick:e,...t},n)=>{const{toggleSidebar:r}=_s();return a.jsxs(ue,{ref:n,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:B("h-7 w-7",s),onClick:o=>{e==null||e(o),r()},...t,children:[a.jsx(Ku,{}),a.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});Jr.displayName="SidebarTrigger";const rh=h.forwardRef(({className:s,...e},t)=>{const{toggleSidebar:n}=_s();return a.jsx("button",{ref:t,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:n,title:"Toggle Sidebar",className:B("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...e})});rh.displayName="SidebarRail";const bc=h.forwardRef(({className:s,...e},t)=>a.jsx("main",{ref:t,className:B("relative flex w-full flex-1 flex-col bg-background","md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow","peer-data-[collapsible=offcanvas]:ml-0 peer-data-[collapsible=offcanvas]:mr-0","peer-data-[variant=floating]:ml-0 peer-data-[variant=floating]:mr-0",s),...e}));bc.displayName="SidebarInset";const ah=h.forwardRef(({className:s,...e},t)=>a.jsx(We,{ref:t,"data-sidebar":"input",className:B("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...e}));ah.displayName="SidebarInput";const wc=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"header",className:B("flex flex-col gap-2 p-2",s),...e}));wc.displayName="SidebarHeader";const oh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"footer",className:B("flex flex-col gap-2 p-2",s),...e}));oh.displayName="SidebarFooter";const ih=h.forwardRef(({className:s,...e},t)=>a.jsx(dc,{ref:t,"data-sidebar":"separator",className:B("mx-2 w-auto bg-sidebar-border",s),...e}));ih.displayName="SidebarSeparator";const yc=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"content",className:B("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...e}));yc.displayName="SidebarContent";const ch=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"group",className:B("relative flex w-full min-w-0 flex-col p-2",s),...e}));ch.displayName="SidebarGroup";const lh=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?Rs:"div";return a.jsx(r,{ref:n,"data-sidebar":"group-label",className:B("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...t})});lh.displayName="SidebarGroupLabel";const dh=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?Rs:"button";return a.jsx(r,{ref:n,"data-sidebar":"group-action",className:B("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...t})});dh.displayName="SidebarGroupAction";const uh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"group-content",className:B("w-full text-sm",s),...e}));uh.displayName="SidebarGroupContent";const Sc=h.forwardRef(({className:s,...e},t)=>a.jsx("ul",{ref:t,"data-sidebar":"menu",className:B("flex w-full min-w-0 flex-col gap-1",s),...e}));Sc.displayName="SidebarMenu";const Ws=h.forwardRef(({className:s,...e},t)=>a.jsx("li",{ref:t,"data-sidebar":"menu-item",className:B("group/menu-item relative",s),...e}));Ws.displayName="SidebarMenuItem";const ph=ln("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),zs=h.forwardRef(({asChild:s=!1,isActive:e=!1,variant:t="default",size:n="default",tooltip:r,className:o,...i},c)=>{const l=s?Rs:"button",{isMobile:d,state:p}=_s(),u=a.jsx(l,{ref:c,"data-sidebar":"menu-button","data-size":n,"data-active":e,className:B(ph({variant:t,size:n}),o),...i});return r?(typeof r=="string"&&(r={children:r}),a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:u}),a.jsx(Vt,{side:"right",align:"center",hidden:p!=="collapsed"||d,...r})]})):u});zs.displayName="SidebarMenuButton";const hh=h.forwardRef(({className:s,asChild:e=!1,showOnHover:t=!1,...n},r)=>{const o=e?Rs:"button";return a.jsx(o,{ref:r,"data-sidebar":"menu-action",className:B("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",t&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...n})});hh.displayName="SidebarMenuAction";const fh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"menu-badge",className:B("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...e}));fh.displayName="SidebarMenuBadge";const mh=h.forwardRef(({className:s,showIcon:e=!1,...t},n)=>{const r=h.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return a.jsxs("div",{ref:n,"data-sidebar":"menu-skeleton",className:B("flex h-8 items-center gap-2 rounded-md px-2",s),...t,children:[e&&a.jsx(bo,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),a.jsx(bo,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":r}})]})});mh.displayName="SidebarMenuSkeleton";const Yr=h.forwardRef(({className:s,...e},t)=>a.jsx("ul",{ref:t,"data-sidebar":"menu-sub",className:B("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...e}));Yr.displayName="SidebarMenuSub";const En=h.forwardRef(({...s},e)=>a.jsx("li",{ref:e,...s}));En.displayName="SidebarMenuSubItem";const In=h.forwardRef(({asChild:s=!1,size:e="md",isActive:t,className:n,...r},o)=>{const i=s?Rs:"a";return a.jsx(i,{ref:o,"data-sidebar":"menu-sub-button","data-size":e,"data-active":t,className:B("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",e==="sm"&&"text-xs",e==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",n),...r})});In.displayName="SidebarMenuSubButton";const gh="audio-chunks-db",xh=1,St="chunks",Ze="metadata";class vh{constructor(){ee(this,"dbPromise");ee(this,"initializationPromise");this.dbPromise=this.initDB(),this.initializationPromise=this.waitForDB()}async waitForDB(){await this.dbPromise}async waitForInitialization(){await this.initializationPromise}async initDB(){return new Promise((e,t)=>{const n=indexedDB.open(gh,xh);n.onupgradeneeded=r=>{const o=r.target.result;if(o.objectStoreNames.contains(St)||o.createObjectStore(St),!o.objectStoreNames.contains(Ze)){const i=o.createObjectStore(Ze);i.createIndex("sessionName","sessionName",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1}),i.createIndex("chunkNumber","chunkNumber",{unique:!1})}},n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{t(new Error(`IndexedDB error: ${r.target.error}`))}})}async saveChunk(e,t){var n;if(await this.waitForInitialization(),!e.blob)throw new Error("Cannot save chunk without blob data");try{const o=(await this.dbPromise).transaction([Ze,St],"readwrite"),i=o.objectStore(Ze),c=o.objectStore(St),l={id:e.id,chunkNumber:e.chunkNumber,startTime:e.startTime.toISOString(),endTime:(n=e.endTime)==null?void 0:n.toISOString(),duration:e.duration,size:e.size??e.blob.size,name:e.name,sessionName:t,transcription:e.transcription,transcriptionStatus:e.transcriptionStatus,transcriptionError:e.transcriptionError,createdAt:new Date().toISOString(),mimeType:e.blob.type};i.put(l,e.id),c.put(e.blob,e.id),await new Promise((d,p)=>{o.oncomplete=()=>d(),o.onerror=()=>p(new Error(`Transaction failed: ${o.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to save chunk:",r),r}}async loadChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Ze,St],"readonly"),r=n.objectStore(Ze),o=n.objectStore(St),c=r.index("sessionName").getAll(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to load metadata: ${c.error}`))});if(l.length===0)return[];const d=[];for(const p of l)try{const u=o.get(p.id),f=await new Promise((m,g)=>{u.onsuccess=()=>m(u.result),u.onerror=()=>g(new Error(`Failed to load blob: ${u.error}`))});if(f){const m={id:p.id,chunkNumber:p.chunkNumber,startTime:new Date(p.startTime),endTime:p.endTime?new Date(p.endTime):void 0,duration:p.duration,blob:f,size:p.size,name:p.name,transcription:p.transcription,transcriptionStatus:p.transcriptionStatus,transcriptionError:p.transcriptionError};d.push(m)}}catch(u){console.warn(`ðŸŽ¤ðŸ“¦ðŸ’¾ âš ï¸ Failed to load chunk ${p.id}:`,u)}return d.sort((p,u)=>p.chunkNumber-u.chunkNumber),d}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to load chunks:",t),t}}async updateChunkTranscription(e,t){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Ze],"readwrite"),o=r.objectStore(Ze),i=o.get(e),c=await new Promise((d,p)=>{i.onsuccess=()=>d(i.result),i.onerror=()=>p(new Error(`Failed to get metadata: ${i.error}`))});if(!c)throw new Error(`Chunk not found: ${e}`);const l={...c,transcription:t,transcriptionStatus:"completed"};o.put(l,e),await new Promise((d,p)=>{r.oncomplete=()=>d(),r.onerror=()=>p(new Error(`Transaction failed: ${r.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription:",n),n}}async updateChunkTranscriptionStatus(e,t,n){await this.waitForInitialization();try{const o=(await this.dbPromise).transaction([Ze],"readwrite"),i=o.objectStore(Ze),c=i.get(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to get metadata: ${c.error}`))});if(!l)throw new Error(`Chunk not found: ${e}`);const d={...l,transcriptionStatus:t,transcriptionError:n};i.put(d,e),await new Promise((p,u)=>{o.oncomplete=()=>p(),o.onerror=()=>u(new Error(`Transaction failed: ${o.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription status:",r),r}}async deleteChunk(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Ze,St],"readwrite"),r=n.objectStore(Ze),o=n.objectStore(St);r.delete(e),o.delete(e),await new Promise((i,c)=>{n.oncomplete=()=>i(),n.onerror=()=>c(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunk:",t),t}}async deleteChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Ze,St],"readwrite"),r=n.objectStore(Ze),o=n.objectStore(St),c=r.index("sessionName").getAll(e),l=await new Promise((d,p)=>{c.onsuccess=()=>d(c.result),c.onerror=()=>p(new Error(`Failed to load metadata: ${c.error}`))});for(const d of l)r.delete(d.id),o.delete(d.id);await new Promise((d,p)=>{n.oncomplete=()=>d(),n.onerror=()=>p(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunks by session:",t),t}}async getAllSessions(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Ze],"readonly").objectStore(Ze).getAll(),o=await new Promise((c,l)=>{r.onsuccess=()=>c(r.result),r.onerror=()=>l(new Error(`Failed to load all metadata: ${r.error}`))});return[...new Set(o.map(c=>c.sessionName))].sort()}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get all sessions:",e),e}}async getStorageStats(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Ze],"readonly").objectStore(Ze).getAll(),o=await new Promise((l,d)=>{r.onsuccess=()=>l(r.result),r.onerror=()=>d(new Error(`Failed to load all metadata: ${r.error}`))}),i=o.reduce((l,d)=>l+d.size,0),c=new Set(o.map(l=>l.sessionName)).size;return{totalChunks:o.length,totalSize:i,sessionCount:c}}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get storage stats:",e),e}}async clearAllData(){await this.waitForInitialization();try{const t=(await this.dbPromise).transaction([Ze,St],"readwrite"),n=t.objectStore(Ze),r=t.objectStore(St);n.clear(),r.clear(),await new Promise((o,i)=>{t.oncomplete=()=>o(),t.onerror=()=>i(new Error(`Transaction failed: ${t.error}`))})}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to clear all data:",e),e}}}const bt=new vh,Sr="vocabulary-lists",Ut="default";class bh{getAllLists(){try{const e=localStorage.getItem(Sr);return e?JSON.parse(e).map(n=>({...n,createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt)})):[this.createDefaultList()]}catch(e){return console.error("Failed to load vocabulary lists:",e),[this.createDefaultList()]}}getListById(e){return this.getAllLists().find(n=>n.id===e)??null}createList(e){const t=this.getAllLists(),n={id:`list-${Date.now()}`,name:e,createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}updateList(e,t){const n=this.getAllLists(),r=n.findIndex(o=>o.id===e);return r===-1?null:(n[r]={...n[r],...t,updatedAt:new Date},this.saveLists(n),n[r])}async deleteList(e){const t=this.getAllLists();if(t.length<=1)return console.warn("Cannot delete the last vocabulary list"),!1;if(e===Ut){const r=t.find(o=>o.id===Ut);if(r&&r.entryCount>0&&t.length===1)return console.warn("Cannot delete default list with data when it's the only list"),!1}const n=t.filter(r=>r.id!==e);return this.saveLists(n),localStorage.removeItem(`vocabulary-entries-${e}`),await bt.deleteChunksBySession(`vocabulary-session-${e}`),!0}getDefaultListId(){return this.getAllLists().find(n=>n.id===Ut)||this.createDefaultList(),Ut}updateEntryCount(e,t){this.updateList(e,{entryCount:t})}migrateOldData(){const e="vocabulary-entries",t=localStorage.getItem(e);if(!t)return!1;try{this.getAllLists().find(c=>c.id===Ut)??(r=this.createDefaultList());const o=`vocabulary-entries-${Ut}`;if(!localStorage.getItem(o)){localStorage.setItem(o,t);const c=JSON.parse(t);return this.updateEntryCount(Ut,c.length),localStorage.removeItem(e),console.log("Migrated old vocabulary data to default list"),!0}return localStorage.removeItem(e),!1}catch(n){return console.error("Failed to migrate vocabulary data:",n),!1}}createDefaultList(){const e=localStorage.getItem(Sr);let t=[];if(e)try{t=JSON.parse(e).map(i=>({...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}));const o=t.find(i=>i.id===Ut);if(o)return o}catch(r){console.error("Error parsing stored lists:",r),t=[]}const n={id:Ut,name:"Default",createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}saveLists(e){localStorage.setItem(Sr,JSON.stringify(e))}}const jr=new bh,wo=xu,yo=bu,So=vu,wh="modulepreload",yh=function(s){return"/"+s},jo={},Ve=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let i=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=i(t.map(d=>{if(d=yh(d),d in jo)return;jo[d]=!0;const p=d.endsWith(".css"),u=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":wh,p||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),p)return new Promise((m,g)=>{f.addEventListener("load",m),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})},Cr=h.lazy(()=>Ve(()=>import("./HomePage-RmNg9dJQ.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>({default:s.HomePage}))),Sh=h.lazy(()=>Ve(()=>import("./Chat-BOgunWdw.js"),__vite__mapDeps([7,1,8,9,2,10,4,5,11,6])).then(s=>({default:s.Chat}))),jh=h.lazy(()=>Ve(()=>import("./Settings-BAZkUET2.js"),__vite__mapDeps([12,1,8,2,4,5,6])).then(s=>({default:s.Settings}))),Co=h.lazy(()=>Ve(()=>import("./Demo-CKHfUoXc.js"),__vite__mapDeps([13,1,14,5,2,15,4,6])).then(s=>({default:s.Demo}))),No=h.lazy(()=>Ve(()=>import("./Content-Bu0Kd-oa.js"),__vite__mapDeps([16,1,8,2,4,5,6])).then(s=>({default:s.Content}))),Ch=h.lazy(()=>Ve(()=>import("./TablePage-CqfF-1-y.js"),__vite__mapDeps([17,1,18,19,4,5,6,2])).then(s=>({default:s.TablePage}))),ko=h.lazy(()=>Ve(()=>import("./VocabularyPage-DeMtOtno.js"),__vite__mapDeps([20,1,18,19,21,22,23,24,2,4,5,6])).then(s=>({default:s.VocabularyPage}))),Nh=h.lazy(()=>Ve(()=>import("./LiveTranscriptionPage-DKocCszE.js"),__vite__mapDeps([25,1,2,4,5,6])).then(s=>({default:s.LiveTranscriptionPage}))),kh=h.lazy(()=>Ve(()=>import("./AudioPanelDemo-B9qNwx6H.js"),__vite__mapDeps([26,1,4,5,6,2])).then(s=>({default:s.AudioPanelDemo}))),Eh=h.lazy(()=>Ve(()=>import("./ClaudePage-B27m3xzK.js"),__vite__mapDeps([27,1,28,29,2,4,5,6,30])).then(s=>({default:s.ClaudePage}))),Ih=h.lazy(()=>Ve(()=>import("./SessionDetailsPage-YiFKwxri.js"),__vite__mapDeps([31,1,4,5,28,29,2,6,30])).then(s=>({default:s.SessionDetailsPage}))),Th=h.lazy(()=>Ve(()=>import("./ForksPage-D3VQeLgG.js"),__vite__mapDeps([32,1,4,5,2,29,6])).then(s=>({default:s.ForksPage}))),Nr=h.lazy(()=>Ve(()=>import("./KanbanPage-83vBUJg1.js"),__vite__mapDeps([33,1,34,14,5,2,35,36,4,37,6])).then(s=>({default:s.KanbanPage}))),Ah=h.lazy(()=>Ve(()=>import("./KanbanDataPage-Bbxw-L51.js"),__vite__mapDeps([38,1,15,14,5,2,4,6])).then(s=>({default:s.KanbanDataPage}))),Ph=h.lazy(()=>Ve(()=>import("./index-BJrGcvsO.js"),__vite__mapDeps([39,1,2,4,5,6])).then(s=>({default:s.ActionTodoPage}))),Rh=h.lazy(()=>Ve(()=>import("./GlobalStatePage-DxM4UCqI.js"),__vite__mapDeps([40,1,15,4,5,2,6])).then(s=>({default:s.GlobalStatePage}))),Dh=h.lazy(()=>Ve(()=>import("./GamePage-BngJK_tK.js"),__vite__mapDeps([41,1,2,4,5,6])).then(s=>({default:s.GamePage}))),_h=h.lazy(()=>Ve(()=>import("./NewHomeApp-C3gt7eFB.js"),__vite__mapDeps([42,1,6,4,5,2,43,44,45,46,47,48,49,23,24,21,50,36,51,52,53,54,35,55,56,57,58,15,59,60,61,62,28,29,63,64,65,66])).then(s=>({default:s.NewHomeApp}))),Oh=h.lazy(()=>Ve(()=>import("./SttPage-C5sFNl15.js"),__vite__mapDeps([67,1,4,5,6,2])).then(s=>({default:s.SttPage})));function Lh(){return a.jsx("div",{className:"page-loader flex items-center justify-center h-full",children:a.jsx("div",{className:"page-loader-spinner animate-pulse text-muted-foreground",children:"Loading..."})})}const Mn=[{path:"/",element:Cr,title:"Watcher",icon:ho,label:"Home",showInSidebar:!0},{path:"/new-home",element:_h,title:"New Home",icon:ho,label:"New Home",showInSidebar:!0},{path:"/chat",element:Sh,title:"Chat with Ollama",icon:Ju,label:"Chat",showInSidebar:!0},{path:"/settings",element:jh,title:"Settings",icon:qt,label:"Settings",showInSidebar:!0},{path:"/claude",element:Eh,title:"Claude",icon:Lr,label:"Claude",showInSidebar:!0},{path:"/claude/:sessionId",element:Ih,title:"Claude",showInSidebar:!1},{path:"/claude/forks/:forkId?",element:Th,title:"Session Forks",icon:ts,label:"Forks",showInSidebar:!1},{path:"/state",element:Rh,title:"Global State",icon:Yu,label:"Global State",showInSidebar:!0},{path:"/game",element:Dh,title:"Multiplayer Games",icon:Xu,label:"Games",showInSidebar:!0},{path:"/stt",element:Oh,title:"Speech to Text",icon:rr,label:"STT",showInSidebar:!0},{path:"/todo",element:Nr,title:"Todo",icon:Mr,label:"Todo",showInSidebar:!0,group:"collapsible",children:[{path:"/todo",element:Nr,title:"Todo",icon:ec,label:"Overview",showInSidebar:!0},{path:"/todo/kanban",element:Nr,title:"Kanban Board",icon:Qu,label:"Kanban Board",showInSidebar:!0},{path:"/todo/kanban/data",element:Ah,title:"Kanban Data",icon:tc,label:"Data",showInSidebar:!0},{path:"/todo/action",element:Ph,title:"Action Todo",icon:Zu,label:"Action-Driven",showInSidebar:!0}]},{path:"/content",element:No,title:"Content",icon:ep,label:"Content",showInSidebar:!0},{path:"/content/:contentId",element:No,title:"Content",showInSidebar:!1},{path:"/active-recording",element:Cr,title:"Active Recording",icon:Fr,label:"Active Recording",showInSidebar:!0},{path:"/vocabulary",element:ko,title:"Vocabulary",icon:$r,label:"Vocabulary",showInSidebar:!0,group:"collapsible-vocabulary"},{path:"/vocabulary/:listId",element:ko,title:"Vocabulary",showInSidebar:!1},{path:"/live-transcription",element:Nh,title:"Live Transcription",icon:Ur,label:"Live Transcription",showInSidebar:!0},{path:"/table",element:Ch,title:"Table Demo",icon:Br,label:"Table Demo",showInSidebar:!0},{path:"/demo",element:Co,title:"Demo",icon:Wr,label:"Demo",showInSidebar:!0},{path:"/demo/*",element:Co,title:"Demo",showInSidebar:!1},{path:"/demo/audio-panel",element:kh,title:"Audio Panel Demo",icon:zr,label:"Audio Panel Demo",showInSidebar:!0},{path:"/realtime",element:Cr,title:"Real-time Audio",showInSidebar:!1}];function Mh(s){const e=Mn.find(t=>t.children&&t.children.find(r=>r.path===s)?!0:t.path===s);if(e){if(e.children){const t=e.children.find(n=>n.path===s);if(t)return t.title}return e.title}for(const t of Mn){if(s.startsWith(t.path.split("/:")[0]))return t.title;if(t.children){for(const n of t.children)if(s.startsWith(n.path.split("/:")[0]))return n.title}}return"Watcher"}function Fh({logger:s,logs:e}){return a.jsx(h.Suspense,{fallback:a.jsx(Lh,{}),children:a.jsx(ru,{children:Mn.map(t=>{const n=t.element,r=a.jsx(n,{logger:s,logs:e});return t.children?t.children.map(o=>{const i=o.element;return a.jsx(uo,{path:o.path,element:a.jsx(i,{logger:s})},o.path)}):a.jsx(uo,{path:t.path,element:r},t.path)})})})}function $h(){const{open:s,toggleSidebar:e}=_s();return a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h2",{className:"text-lg font-semibold px-2",children:"Menu"}),s&&a.jsx(ue,{variant:"ghost",size:"icon",onClick:e,className:"h-7 w-7",children:a.jsx(Ds,{className:"w-4 h-4"})})]})}function Uh(){const s=Si(),e=Na(),{isMobile:t,setOpen:n,setOpenMobile:r}=_s(),{actions:o}=cc(),[i,c]=h.useState([]),[l,d]=h.useState(!1),[p,u]=h.useState(!1);h.useEffect(()=>{const x=jr.getAllLists();c(x)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/vocabulary")&&d(!0)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/todo")&&u(!0)},[e.pathname]);const f=h.useCallback((x,v)=>{x.ctrlKey||x.metaKey||x.button===1||(x.preventDefault(),s(v),t?r(!1):n(!1))},[s,t,n,r]),m=h.useCallback(async()=>{try{o.info("Fetching logs from /logs endpoint...");const v=await(await fetch("/logs")).json();console.log("Logs response:",v),o.info("Logs endpoint response logged to console")}catch(x){o.error(`Failed to fetch logs: ${x}`),console.error("Failed to fetch logs:",x)}t?r(!1):n(!1)},[o,t,n,r]),g=h.useCallback(()=>{const x=prompt("Enter a name for the new vocabulary list:");if(x!=null&&x.trim()){const v=jr.createList(x.trim());c(jr.getAllLists()),s(`/vocabulary/${v.id}`),t?r(!1):n(!1)}},[s,t,n,r]);return a.jsxs(Sc,{children:[Mn.filter(x=>x.showInSidebar).map(x=>x.group==="collapsible"&&x.children?a.jsx(wo,{open:p,onOpenChange:u,className:"group/collapsible",children:a.jsxs(Ws,{children:[a.jsx(yo,{asChild:!0,children:a.jsxs(zs,{children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label,a.jsx(Ft,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),a.jsx(So,{children:a.jsx(Yr,{children:x.children.filter(v=>v.showInSidebar).map(v=>a.jsx(En,{children:a.jsx(In,{asChild:!0,isActive:e.pathname===v.path,children:a.jsxs("a",{href:v.path,onClick:b=>f(b,v.path),children:[v.icon&&a.jsx(v.icon,{className:"w-4 h-4"}),v.label]})})},v.path))})})]})},x.path):x.group==="collapsible-vocabulary"?a.jsx(wo,{open:l,onOpenChange:d,className:"group/collapsible",children:a.jsxs(Ws,{children:[a.jsx(yo,{asChild:!0,children:a.jsxs(zs,{children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label,a.jsx(Ft,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),a.jsx(So,{children:a.jsxs(Yr,{children:[i.map(v=>a.jsx(En,{children:a.jsx(In,{asChild:!0,isActive:e.pathname===`/vocabulary/${v.id}`,children:a.jsxs("a",{href:`/vocabulary/${v.id}`,onClick:b=>f(b,`/vocabulary/${v.id}`),children:[v.name,v.entryCount>0&&a.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:v.entryCount})]})})},v.id)),a.jsx(En,{children:a.jsxs(In,{onClick:g,children:[a.jsx(Ks,{className:"w-4 h-4"}),"Create New List"]})})]})})]})},x.path):a.jsx(Ws,{children:a.jsx(zs,{asChild:!0,isActive:e.pathname===x.path,children:a.jsxs("a",{href:x.path,onClick:v=>f(v,x.path),children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label]})})},x.path)),a.jsx(Ws,{children:a.jsxs(zs,{onClick:m,children:[a.jsx(Js,{className:"w-4 h-4"}),"Logs"]})})]})}function Bh(){return a.jsxs(vc,{variant:"floating",collapsible:"offcanvas",children:[a.jsx(wc,{children:a.jsx($h,{})}),a.jsx(yc,{children:a.jsx(Uh,{})})]})}const Xr=s=>{if(s==null)return s;if(typeof s=="number")return Math.round(s*10)/10;if(Array.isArray(s))return s.map(Xr);if(typeof s=="object"){const e={};for(const[t,n]of Object.entries(s))e[t]=Xr(n);return e}return s};class Oa{constructor(e="http://localhost:3030/client-logs",t=5e3,n=!1){ee(this,"baseUrl");ee(this,"timeout");ee(this,"sessionId");ee(this,"shouldLogToConsole");this.baseUrl=e,this.timeout=t,this.shouldLogToConsole=n,this.sessionId=`todo-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async sendLogs(e,t,n){const r=t?Xr(t):void 0;this.shouldLogToConsole&&console.log(`[${n||"client.log"}] ${e}`,r?JSON.stringify(r,null,2):"");try{const o={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),customLogFile:n,logs:{[e]:[`${e}`]},metadata:r},i=await this.fetchWithTimeout(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw console.error("[ClientLogs] HTTP error:",i.status),new Error(`HTTP ${i.status}`);return await i.json()}catch(o){return console.error("[ClientLogs] Failed to send:",o),null}}sendBeacon(e,t){console.log("[ClientLogs] Sending beacon:",{message:e,metadata:t});try{const n={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),logs:{[e]:[`${e}`]},metadata:t};if(typeof navigator<"u"&&navigator.sendBeacon){const r=this.baseUrl.startsWith("http")?this.baseUrl:`${window.location.origin}${this.baseUrl}`,o=new Blob([JSON.stringify(n)],{type:"application/json"}),i=navigator.sendBeacon(r,o);return i?console.log("[ClientLogs] Beacon accepted"):console.warn("[ClientLogs] Beacon rejected (queue full?)"),i}else return console.log("[ClientLogs] sendBeacon not available, using fetch fallback"),fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),keepalive:!0}).catch(r=>{console.error("[ClientLogs] Fetch fallback failed:",r)}),!0}catch(n){return console.error("[ClientLogs] Failed to send beacon:",n),!1}}async clearLogs(e="client.log",t){if(t&&typeof window<"u"&&!window.location.pathname.includes(t))return!1;try{const n=`${this.baseUrl}?customLogFile=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?(await r.json()).success:(console.error("[ClientLogs] Failed to clear logs:",r.status),!1)}catch(n){return console.error("[ClientLogs] Failed to clear logs:",n),!1}}async clearJsonLogs(e){try{const n=`${this.baseUrl.replace("/client-logs","/client-logs-json")}?filename=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?!0:(console.error("[ClientLogs] Failed to clear JSON logs:",r.status),!1)}catch(t){return console.error("[ClientLogs] Failed to clear JSON logs:",t),!1}}async clearLogsAndAddVersion(e,t,n){const r=await this.clearLogs(e,n);return r&&await this.sendLogs("startup",{v:t},e),r}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}new Oa;const Wh={theme:"system",setTheme:()=>null},jc=h.createContext(Wh);function zh({children:s,defaultTheme:e="system",storageKey:t="vite-ui-theme",...n}){const[r,o]=h.useState(()=>localStorage.getItem(t)||e);h.useEffect(()=>{const c=window.document.documentElement;if(c.classList.remove("light","dark"),r==="system"){const l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";c.classList.add(l);return}c.classList.add(r)},[r]);const i={theme:r,setTheme:c=>{localStorage.setItem(t,c),o(c)}};return a.jsx(jc.Provider,{...n,value:i,children:s})}const Hh=()=>{const s=h.useContext(jc);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s};function Gh(){const{theme:s,setTheme:e}=Hh(),t=()=>{e(s==="dark"?"light":"dark")},n=s==="dark"||s==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return a.jsx(ue,{onClick:t,variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","aria-label":n?"Switch to light mode":"Switch to dark mode",children:n?a.jsx(tp,{className:"h-5 w-5"}):a.jsx(sp,{className:"h-5 w-5"})})}const nt=wu,ut=yu,Tn=Su,Qe=h.forwardRef(({className:s,align:e="center",sideOffset:t=4,style:n,...r},o)=>a.jsx(ju,{children:a.jsx(ki,{ref:o,align:e,sideOffset:t,style:{zIndex:st.popover,...n},className:B("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...r})}));Qe.displayName=ki.displayName;function qh(s){return"initialConfig"in s&&typeof s.children=="function"}function dn(s){if(qh(s)){const{storageKey:m,initialConfig:g,children:x,prefix:v="watcher-"}=s,b=`${v}${m}`,[w,y]=h.useState(()=>{try{const N=localStorage.getItem(b);if(N)return JSON.parse(N)}catch(N){console.error(`Failed to load config from localStorage (${b}):`,N)}return g}),[j,S]=h.useState(!1);h.useEffect(()=>{try{localStorage.setItem(b,JSON.stringify(w))}catch(N){console.error(`Failed to save config to localStorage (${b}):`,N)}},[w,b]);const C=h.useMemo(()=>({buttonLabel:N,icon:O=a.jsx(qt,{className:"h-4 w-4"}),variant:R="ghost",size:k="icon",buttonClassName:A="",contentClassName:L="",contentStyle:M,align:I="end",side:z="bottom",title:$,children:q})=>a.jsxs(nt,{open:j,onOpenChange:S,"data-test":"config-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:R,size:k,className:`config-button ${A}`,title:$||"Configuration","data-test":"config-button",children:N?a.jsxs(a.Fragment,{children:[O,N&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:N})]}):O})}),a.jsxs(Qe,{className:`config-panel ${L}`,style:{zIndex:st.draggablePopoverDropdown,...M},align:I,side:z,"data-test":"config-panel",onInteractOutside:P=>{P.target.closest(".config-panel")&&P.preventDefault()},onPointerDownOutside:P=>{P.target.closest(".config-panel")&&P.preventDefault()},children:[$&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:$})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:q})]})]}),[j,S]);return a.jsx(a.Fragment,{children:x(w,y,C)})}const{children:e,buttonLabel:t,icon:n=a.jsx(qt,{className:"h-4 w-4"}),variant:r="ghost",size:o="icon",buttonClassName:i="",contentClassName:c="",align:l="end",side:d="bottom",title:p}=s,[u,f]=h.useState(!1);return a.jsxs(nt,{open:u,onOpenChange:f,"data-test":"config-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:r,size:o,className:`config-button ${i}`,title:p||"Configuration","data-test":"config-button",children:t?a.jsxs(a.Fragment,{children:[n,t&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:t})]}):n})}),a.jsxs(Qe,{className:`config-panel ${c}`,style:{zIndex:st.draggablePopoverDropdown},align:l,side:d,"data-test":"config-panel",onInteractOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},onPointerDownOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},children:[p&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:p})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:e})]})]})}const Vh=ln("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),Se=h.forwardRef(({className:s,...e},t)=>a.jsx(Ei,{ref:t,className:B(Vh(),s),...e}));Se.displayName=Ei.displayName;const _t=h.forwardRef(({className:s,...e},t)=>a.jsx(Ii,{className:B("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",s),...e,ref:t,children:a.jsx(Cu,{className:B("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));_t.displayName=Ii.displayName;const Kh=()=>{const s=h.useRef(null),[e,t]=h.useState(!1),[n,r]=h.useState(!1),[o,i]=h.useState(null),c=()=>{try{const p=ie.export(),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=`global-state-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(f),Ee.success("Global state exported successfully")}catch(p){console.error("Error exporting state:",p),Ee.error("Failed to export global state")}},l=()=>{var p;(p=s.current)==null||p.click()},d=p=>{var m;const u=(m=p.target.files)==null?void 0:m[0];if(!u)return;t(!0),i(null);const f=new FileReader;f.onload=g=>{var v;const x=(v=g.target)==null?void 0:v.result;if(typeof x=="string")try{n&&ie.reset(),ie.import(x)?(i({success:!0}),Ee.success("Global state imported successfully")):(i({success:!1,error:"Invalid JSON format"}),Ee.error("Failed to import: invalid JSON format"))}catch(b){console.error("Error importing state:",b);const w=b instanceof Error?b.message:"Unknown error";i({success:!1,error:w}),Ee.error(`Failed to import: ${w}`)}else console.error("Failed to read file content."),Ee.error("Failed to read file content"),i({success:!1,error:"Failed to read file"});t(!1),s.current&&(s.current.value="")},f.onerror=g=>{console.error("Error reading file:",g),Ee.error("Error reading file"),i({success:!1,error:"Error reading file"}),t(!1),s.current&&(s.current.value="")},f.readAsText(u)};return a.jsxs("div",{className:"space-y-4","data-test":"global-state-io-panel",children:[a.jsxs("div",{"data-test":"global-state-export-section",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Export"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download global state as JSON"}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:c,className:"w-full","data-test":"global-state-export-button",children:[a.jsx(np,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),a.jsxs("div",{"data-test":"global-state-import-section",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Import"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import global state from a JSON file"}),a.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"global-state-replace-mode-control",children:[a.jsxs("div",{children:[a.jsx(Se,{htmlFor:"global-state-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),a.jsx(_t,{id:"global-state-replace-mode",checked:n,onCheckedChange:r,disabled:e,"data-test":"global-state-replace-mode-switch"})]}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:l,disabled:e,className:"w-full","data-test":"global-state-import-select-file-button",children:[a.jsx(rp,{className:"h-4 w-4 mr-2"}),e?"Importing...":"Select File"]}),a.jsx("input",{type:"file",ref:s,accept:".json",style:{display:"none"},onChange:d,"data-test":"global-state-import-file-input"})]}),o&&a.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"global-state-import-result",children:[o.success&&a.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"global-state-import-success",children:[a.jsx(ap,{className:"h-3 w-3"}),a.jsx("span",{children:"Import successful"})]}),!o.success&&a.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"global-state-import-error",children:[a.jsx(sc,{className:"h-3 w-3"}),a.jsx("span",{children:o.error||"Import failed"})]})]})]})},Jh=()=>a.jsx(dn,{storageKey:"global-state-io",title:"State Import/Export",icon:a.jsx(tc,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end","data-test":"global-state-io-button",children:a.jsx(Kh,{})});new Oa;const Yh={primaryColor:"blue",setPrimaryColor:()=>null},Xh=h.createContext(Yh),Qh=()=>{const s=h.useContext(Xh);if(s===void 0)throw new Error("usePrimaryColor must be used within a PrimaryColorProvider");return s};function Zh({onColorSelect:s,selectedHue:e=217}){const t=h.useRef(null),[n,r]=h.useState(!1),[o,i]=h.useState(e);h.useEffect(()=>{n||i(e)},[e,n]),h.useEffect(()=>{const g=t.current;if(!g)return;const x=g.getContext("2d");if(!x)return;const v=g.width,b=g.height,w=40,y=(b-w)/2,j=`hsl(${o} 70% 90%)`;x.fillStyle=j,x.fillRect(0,0,v,b);for(let C=0;C<v;C+=1){const N=C/v*360;x.fillStyle=`hsl(${N}, 100%, 50%)`,x.fillRect(C,y,1,w)}x.strokeStyle="#ccc",x.lineWidth=2,x.strokeRect(0,y,v,w);const S=o/360*v;x.strokeStyle="#000",x.lineWidth=3,x.beginPath(),x.moveTo(S,y-8),x.lineTo(S,y+w+8),x.stroke(),x.strokeStyle="#fff",x.lineWidth=1,x.beginPath(),x.moveTo(S,y-8),x.lineTo(S,y+w+8),x.stroke()},[o]);const c=g=>{const x=t.current;if(!x)return;const v=x.getBoundingClientRect(),b=g.clientX-v.left,w=Math.round(b/x.width*360),y=Math.max(0,Math.min(360,w));i(y),s(`${y} 70% 60%`)},l=()=>r(!0),d=()=>r(!1),p=g=>{n&&c(g)},u=()=>r(!0),f=()=>r(!1),m=g=>{if(!n)return;const x=t.current;if(!x)return;const v=x.getBoundingClientRect(),b=g.touches[0].clientX-v.left,w=Math.round(b/x.width*360),y=Math.max(0,Math.min(360,w));i(y),s(`${y} 70% 60%`)};return a.jsxs("div",{className:"color-strip-container flex flex-col items-center gap-3",children:[a.jsx("canvas",{ref:t,width:200,height:80,onClick:c,onMouseDown:l,onMouseUp:d,onMouseMove:p,onMouseLeave:()=>r(!1),onTouchStart:u,onTouchEnd:f,onTouchMove:m,className:"color-strip cursor-pointer rounded touch-none"}),a.jsx("div",{className:"color-info text-center",children:a.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hue: ",o,"Â°"]})})]})}const Fn=Ci,tC=Nu,ef=ka,Cc=h.forwardRef(({className:s,style:e,...t},n)=>a.jsx(tr,{ref:n,className:B("fixed inset-0 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),style:{zIndex:st.popover,...e},...t}));Cc.displayName=tr.displayName;const $n=h.forwardRef(({className:s,children:e,style:t,...n},r)=>a.jsxs(ef,{children:[a.jsx(Cc,{}),a.jsxs(cn,{ref:r,className:B("fixed left-[50%] top-[50%] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),style:{zIndex:st.popover,...t},...n,children:[e,a.jsxs(Ea,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ht,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));$n.displayName=cn.displayName;const Un=({className:s,...e})=>a.jsx("div",{className:B("flex flex-col space-y-1.5 text-center sm:text-left",s),...e});Un.displayName="DialogHeader";const tf=({className:s,...e})=>a.jsx("div",{className:B("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...e});tf.displayName="DialogFooter";const Zs=h.forwardRef(({className:s,...e},t)=>a.jsx(sr,{ref:t,className:B("text-lg font-semibold leading-none tracking-tight",s),...e}));Zs.displayName=sr.displayName;const Nc=h.forwardRef(({className:s,...e},t)=>a.jsx(nr,{ref:t,className:B("text-sm text-muted-foreground",s),...e}));Nc.displayName=nr.displayName;const sf=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose","white","black"],nf={slate:"#64748b",gray:"#6b7280",zinc:"#71717a",neutral:"#737373",stone:"#78716c",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e",white:"#ffffff",black:"#000000"},rf={slate:"hsl(215 16% 47%)",gray:"hsl(218 11% 43%)",zinc:"hsl(220 13% 47%)",neutral:"hsl(0 0% 45%)",stone:"hsl(12 6% 44%)",red:"hsl(0 84% 60%)",orange:"hsl(24 97% 61%)",amber:"hsl(45 96% 71%)",yellow:"hsl(54 100% 68%)",lime:"hsl(84 85% 67%)",green:"hsl(142 72% 64%)",emerald:"hsl(160 84% 65%)",teal:"hsl(168 86% 55%)",cyan:"hsl(191 87% 55%)",sky:"hsl(198 93% 60%)",blue:"hsl(217 91% 60%)",indigo:"hsl(226 86% 61%)",violet:"hsl(259 84% 63%)",purple:"hsl(280 85% 64%)",fuchsia:"hsl(289 86% 66%)",pink:"hsl(330 81% 60%)",rose:"hsl(356 84% 61%)",white:"hsl(0 0% 100%)",black:"hsl(0 0% 0%)"};function af({isOpen:s,onOpenChange:e}){const{primaryColor:t,setPrimaryColor:n}=Qh(),[r,o]=h.useState(217),[i,c]=h.useState(t),l=p=>{c(p),n(p);const u=rf[p],f=parseInt(u.split(" ")[0].replace("hsl(",""));o(f)},d=p=>{const u=parseInt(p.split(" ")[0]);o(u);const f=`${u} 70% 90%`,m=`${u} 70% 85%`,g=`${u} 70% 80%`,x=`${u} 70% 70%`;n(`hsl-${u}`),c(`hsl-${u}`);const v=window.document.documentElement;v.style.setProperty("--background",f),v.style.setProperty("--card",m),v.style.setProperty("--tab",g),v.style.setProperty("--active",x)};return a.jsx(Fn,{open:s,onOpenChange:e,children:a.jsxs($n,{className:"theme-settings-dialog sm:max-w-3xl",children:[a.jsxs(Un,{children:[a.jsx(Zs,{className:"theme-settings-title",children:"Theme Settings"}),a.jsx(Nc,{className:"theme-settings-description",children:"Choose a predefined color or use the color wheel for custom colors"})]}),a.jsxs("div",{className:"predefined-colors-section mb-6",children:[a.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Predefined Colors"}),a.jsx("div",{className:"predefined-colors-grid grid grid-cols-12 gap-2",children:sf.map(p=>a.jsx("button",{type:"button",title:p,onClick:()=>l(p),className:B("color-button w-8 h-8 rounded-full border-2 cursor-pointer transition-all","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","hover:scale-110",i===p?"ring-2 ring-ring ring-offset-2 scale-110":"border-muted",p==="white"&&"border-neutral-300"),style:{backgroundColor:nf[p]},"aria-label":`Select ${p} theme`},p))})]}),a.jsxs("div",{className:"theme-wheel-container flex gap-6 items-start",children:[a.jsxs("div",{className:"flex-shrink-0",children:[a.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Custom Color"}),a.jsx(Zh,{onColorSelect:d,selectedHue:r})]}),a.jsxs("div",{className:"flex-1 space-y-3",children:[a.jsx("div",{className:"theme-preview-title",children:a.jsx("p",{className:"text-sm font-medium text-foreground",children:"Live Preview:"})}),a.jsx("div",{className:"theme-preview-bg p-4 rounded-lg border-2",style:{backgroundColor:`hsl(${r} 70% 90%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-700",children:"Background"})}),a.jsx("div",{className:"theme-preview-card p-4 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 85%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Card"})}),a.jsx("div",{className:"theme-preview-tab p-3 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 80%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Tab"})}),a.jsx("div",{className:"theme-preview-active p-3 rounded-lg border font-semibold",style:{backgroundColor:`hsl(${r} 70% 70%)`},children:a.jsx("p",{className:"text-xs text-gray-900",children:"Active/Selected"})})]})]})]})})}function Eo({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx(dn,{title:"Settings",icon:a.jsx(qt,{className:"h-5 w-5"}),variant:s,size:e,align:"end",storageKey:"app-settings","data-test":"global-config-button",children:a.jsxs("div",{className:"settings-panel space-y-3","data-test":"config-panel",children:[a.jsxs("div",{className:"theme-toggle-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme"}),a.jsx(Gh,{})]}),a.jsxs("div",{className:"theme-settings-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme Colors"}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>n(!0),className:"w-full flex items-center gap-2","data-test":"customize-colors-button",children:[a.jsx(op,{className:"h-4 w-4"}),"Customize Colors"]})]}),a.jsx("div",{className:"divider my-3 border-t"}),a.jsxs("div",{className:"state-import-export-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Global State"}),a.jsx(Jh,{})]})]})}),a.jsx(af,{isOpen:t,onOpenChange:n})]})}class of{constructor(){ee(this,"isActive",!1);ee(this,"callbacks",new Set);ee(this,"tooltipOwnerId",null);ee(this,"panelOwnerId",null);ee(this,"clickOwnerId",null)}subscribe(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}getState(){return this.isActive}toggle(){this.isActive=!this.isActive,this.notifySubscribers()}setState(e){this.isActive!==e&&(this.isActive=e,this.notifySubscribers())}activate(){this.setState(!0)}deactivate(){this.setState(!1)}claimTooltip(e){this.tooltipOwnerId=e}releaseTooltip(e){this.tooltipOwnerId===e&&(this.tooltipOwnerId=null)}canRenderTooltip(e){return this.tooltipOwnerId===null?e===null:this.tooltipOwnerId===e}claimPanel(e){this.panelOwnerId=e}releasePanel(e){this.panelOwnerId===e&&(this.panelOwnerId=null)}canRenderPanel(e){return this.panelOwnerId===null?e===null:this.panelOwnerId===e}claimClickHandling(e){this.clickOwnerId=e}releaseClickHandling(e){this.clickOwnerId===e&&(this.clickOwnerId=null)}canHandleClicks(e){return this.clickOwnerId===null?e===null:this.clickOwnerId===e}notifySubscribers(){this.callbacks.forEach(e=>e(this.isActive))}}const xt=new of,os=({isVisible:s,onClose:e,title:t,children:n,className:r,initialPosition:o,triggerPosition:i,shouldCloseManually:c=!1,resizable:l=!1,initialSize:d,onSizeChange:p,onPositionChange:u,headerActions:f,footer:m,portalContainer:g,showPinButton:x=!1,showInspectorButton:v=!1,zIndex:b=st.draggablePopover,anchorOrigin:w="top-left"})=>{const y=i??(typeof o=="object"?o:void 0),j=h.useMemo(()=>{if(!d)return null;const G=window.innerWidth,oe=window.innerHeight,de=32;return{width:Math.min(d.width,G-de),height:d.height?Math.min(d.height,oe-de):void 0}},[d]),S=h.useMemo(()=>{const G=window.innerWidth,oe=window.innerHeight,de=(j==null?void 0:j.width)??320,pe=(j==null?void 0:j.height)??400;if(!y||o==="center")return{x:Math.max(16,(G-de)/2),y:Math.max(16,(oe-pe)/2)};let fe=y.x,be=y.y;return fe+de>G&&(fe=G-de-16),fe<16&&(fe=16),be+pe>oe&&(be=oe-pe-32),be<16&&(be=16),{x:fe,y:be}},[y,j,o]),[C,N]=h.useState(null),[O,R]=h.useState(j),[k,A]=h.useState(!1),[L,M]=h.useState(!1),[I,z]=h.useState(null),[$,q]=h.useState({x:0,y:0}),[P,te]=h.useState({x:0,y:0,width:0,height:0,posX:0,posY:0}),[E,_]=h.useState(!1),[F,V]=h.useState(!1),Y=h.useRef(null),T=h.useRef(null),W=h.useRef(!1),se=w!=="top-left"&&typeof o=="object",[le,me]=h.useState(!se);h.useEffect(()=>{if(!s||W.current||w==="top-left"){s&&w==="top-left"&&me(!0);return}typeof o=="object"&&requestAnimationFrame(()=>{if(!T.current)return;const G=T.current.getBoundingClientRect();let oe=o.x,de=o.y;(w==="top-right"||w==="bottom-right")&&(oe=o.x-G.width),(w==="bottom-left"||w==="bottom-right")&&(de=o.y-G.height);const pe=16;oe=Math.max(pe,Math.min(oe,window.innerWidth-G.width-pe)),de=Math.max(pe,Math.min(de,window.innerHeight-G.height-pe)),N({x:oe,y:de}),W.current=!0,me(!0)})},[s,o,w]),h.useEffect(()=>{s||(W.current=!1,me(!(w!=="top-left"&&typeof o=="object")))},[s,w,o]);const ae=G=>{const oe=G.target;if(!(oe.tagName==="INPUT"||oe.tagName==="TEXTAREA"||oe.tagName==="SELECT"||oe.tagName==="BUTTON"||oe.closest("button")!==null||oe.closest("input")!==null||oe.closest("textarea")!==null||oe.closest("select")!==null||oe.classList.contains("resize-handle"))&&(G.preventDefault(),T.current)){const pe=T.current.getBoundingClientRect(),fe=pe.left,be=pe.top;N({x:fe,y:be}),A(!0),q({x:G.clientX-fe,y:G.clientY-be})}},H=G=>{const oe=G.target;if(oe.tagName==="INPUT"||oe.tagName==="TEXTAREA"||oe.tagName==="SELECT"||oe.tagName==="BUTTON"||oe.closest("button")!==null||oe.closest("input")!==null||oe.closest("textarea")!==null||oe.closest("select")!==null||oe.classList.contains("resize-handle"))return;const pe=G.touches[0];if(pe&&T.current){const fe=T.current.getBoundingClientRect(),be=fe.left,Pe=fe.top;N({x:be,y:Pe}),A(!0),q({x:pe.clientX-be,y:pe.clientY-Pe})}},Q=G=>oe=>{if(oe.stopPropagation(),T.current){const de=T.current.getBoundingClientRect();M(!0),z(G),te({x:oe.clientX,y:oe.clientY,width:de.width,height:de.height,posX:de.left,posY:de.top})}},ge=G=>oe=>{oe.stopPropagation();const de=oe.touches[0];if(de&&T.current){const pe=T.current.getBoundingClientRect();M(!0),z(G),te({x:de.clientX,y:de.clientY,width:pe.width,height:pe.height,posX:pe.left,posY:pe.top})}},ce=G=>{G.stopPropagation(),xt.toggle();const oe=xt.getState();Ee.success(`Element Inspector ${oe?"activated":"deactivated"}`,{description:oe?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};h.useEffect(()=>{if(c||!s||E||F){Y.current&&(clearTimeout(Y.current),Y.current=null);return}return Y.current=setTimeout(()=>{e()},2e3),()=>{Y.current&&(clearTimeout(Y.current),Y.current=null)}},[s,E,F,e,c]),h.useEffect(()=>{s||(V(!1),N(null))},[s]);const Ae=()=>{V(!0)};h.useEffect(()=>{if(!k)return;const G=document.body.style.userSelect;document.body.style.userSelect="none";const oe=fe=>{N({x:fe.clientX-$.x,y:fe.clientY-$.y})},de=fe=>{const be=fe.touches[0];be&&(fe.preventDefault(),N({x:be.clientX-$.x,y:be.clientY-$.y}))},pe=()=>{A(!1),ve(!0),C&&u&&u(C)};return document.addEventListener("mousemove",oe),document.addEventListener("mouseup",pe),document.addEventListener("touchmove",de,{passive:!1}),document.addEventListener("touchend",pe),()=>{document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",pe),document.removeEventListener("touchmove",de),document.removeEventListener("touchend",pe),document.body.style.userSelect=G}},[k,$,C,u]),h.useEffect(()=>{if(!L||!I)return;const G=300,oe=200,de=document.body.style.userSelect;document.body.style.userSelect="none";const pe=(Ie,K)=>{const D=Ie-P.x,X=K-P.y;let we=P.width,ne=P.height,xe=P.posX,J=P.posY;if(I.includes("e"))we=Math.max(G,P.width+D);else if(I.includes("w")){const he=P.width-D;he>=G?(we=he,xe=P.posX+D):(we=G,xe=P.posX+(P.width-G))}if(I.includes("s"))ne=Math.max(oe,P.height+X);else if(I.includes("n")){const he=P.height-X;he>=oe?(ne=he,J=P.posY+X):(ne=oe,J=P.posY+(P.height-oe))}return{newWidth:we,newHeight:ne,newPosX:xe,newPosY:J}},fe=Ie=>{const{newWidth:K,newHeight:D,newPosX:X,newPosY:we}=pe(Ie.clientX,Ie.clientY);R({width:K,height:D}),(I.includes("w")||I.includes("n"))&&N({x:X,y:we})},be=Ie=>{const K=Ie.touches[0];if(!K)return;Ie.preventDefault();const{newWidth:D,newHeight:X,newPosX:we,newPosY:ne}=pe(K.clientX,K.clientY);R({width:D,height:X}),(I.includes("w")||I.includes("n"))&&N({x:we,y:ne})},Pe=()=>{M(!1),z(null),O&&O.height&&p&&p({width:O.width,height:O.height}),C&&u&&u(C)};return document.addEventListener("mousemove",fe),document.addEventListener("mouseup",Pe),document.addEventListener("touchmove",be,{passive:!1}),document.addEventListener("touchend",Pe),()=>{document.removeEventListener("mousemove",fe),document.removeEventListener("mouseup",Pe),document.removeEventListener("touchmove",be),document.removeEventListener("touchend",Pe),document.body.style.userSelect=de}},[L,I,P,O,C,p,u]),h.useEffect(()=>{if(!s||c)return;const G=oe=>{oe.key==="Escape"&&e()};return document.addEventListener("keydown",G),()=>{document.removeEventListener("keydown",G)}},[s,e,c]);const[ke,ve]=h.useState(!1);h.useEffect(()=>{s||ve(!1)},[s]);const U=(ke||k)&&C?C:S;if(!s)return null;const re=a.jsxs("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:st.backdrop},"data-test":"draggable-popover-wrapper",children:[!c&&a.jsx("div",{className:"backdrop-click-outside fixed inset-0",style:{zIndex:st.backdrop,pointerEvents:"auto"},onClick:e,"aria-hidden":"true","data-test":"draggable-popover-backdrop"}),a.jsxs("div",{ref:T,className:qs("fixed","w-80 bg-background text-foreground border border-border rounded-lg shadow-lg","flex flex-col",l&&"relative",r),style:{zIndex:b,pointerEvents:"auto",opacity:le?1:0,top:U?`${U.y}px`:"auto",right:"auto",left:U?`${U.x}px`:"auto",bottom:"auto",cursor:L&&I?I==="nw"||I==="se"?"nwse-resize":I==="ne"||I==="sw"?"nesw-resize":I==="n"||I==="s"?"ns-resize":I==="e"||I==="w"?"ew-resize":"default":"default",width:O?`${O.width}px`:void 0,height:O!=null&&O.height?`${O.height}px`:void 0,maxHeight:"calc(100vh - 2rem)"},onMouseEnter:Ae,"data-test":"draggable-popover-container",children:[a.jsxs("div",{className:"header px-3 py-2 border-b border-border flex justify-between items-center cursor-grab active:cursor-grabbing",onMouseDown:ae,onTouchStart:H,"data-test":"draggable-popover-header",children:[a.jsx("h3",{className:"title-text text-sm font-semibold select-none","data-test":"draggable-popover-title",children:t}),a.jsxs("div",{className:"action-buttons flex items-center gap-1","data-test":"draggable-popover-actions",children:[f,v&&a.jsx("button",{className:"inspector-button p-1 rounded hover:bg-accent transition-colors",onClick:ce,onMouseDown:G=>G.stopPropagation(),"aria-label":"Toggle Element Inspector",title:"Toggle Element Inspector","data-test":"draggable-popover-inspector-button",children:a.jsx(ip,{size:14})}),x&&a.jsx("button",{className:qs("pin-button p-1 rounded hover:bg-accent transition-colors",E&&"bg-accent text-accent-foreground"),onClick:G=>{G.stopPropagation(),_(!E)},onMouseDown:G=>G.stopPropagation(),"aria-label":E?"Unpin popover":"Pin popover",title:E?"Unpin":"Pin","data-test":"draggable-popover-pin-button",children:a.jsx(cp,{size:14,className:qs(E&&"fill-current")})}),a.jsx("button",{className:"close-button p-1 rounded hover:bg-accent transition-colors",onClick:G=>{G.stopPropagation(),e()},onMouseDown:G=>G.stopPropagation(),"aria-label":"Close popover",title:"Close","data-test":"draggable-popover-close-button",children:a.jsx(ht,{size:14})})]})]}),a.jsx("div",{className:"flex-1 min-h-0 overflow-auto","data-test":"draggable-popover-content",children:n}),m&&a.jsx("div",{className:"flex-shrink-0 border-t border-border","data-test":"draggable-popover-footer",children:m}),l&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"resize-handle absolute top-0 left-0 w-3 h-3 cursor-nwse-resize",onMouseDown:Q("nw"),onTouchStart:ge("nw"),"data-test":"draggable-popover-resize-nw"}),a.jsx("div",{className:"resize-handle absolute top-0 right-0 w-3 h-3 cursor-nesw-resize",onMouseDown:Q("ne"),onTouchStart:ge("ne"),"data-test":"draggable-popover-resize-ne"}),a.jsx("div",{className:"resize-handle absolute bottom-0 left-0 w-3 h-3 cursor-nesw-resize",onMouseDown:Q("sw"),onTouchStart:ge("sw"),"data-test":"draggable-popover-resize-sw"}),a.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-3 h-3 cursor-nwse-resize",onMouseDown:Q("se"),onTouchStart:ge("se"),style:{background:"linear-gradient(135deg, transparent 50%, currentColor 50%)",opacity:.3},"data-test":"draggable-popover-resize-se"}),a.jsx("div",{className:"resize-handle absolute top-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:Q("n"),onTouchStart:ge("n"),"data-test":"draggable-popover-resize-n"}),a.jsx("div",{className:"resize-handle absolute bottom-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:Q("s"),onTouchStart:ge("s"),"data-test":"draggable-popover-resize-s"}),a.jsx("div",{className:"resize-handle absolute left-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:Q("w"),onTouchStart:ge("w"),"data-test":"draggable-popover-resize-w"}),a.jsx("div",{className:"resize-handle absolute right-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:Q("e"),onTouchStart:ge("e"),"data-test":"draggable-popover-resize-e"})]})]})]});return au.createPortal(re,g??document.body)},Io=5,cf=300,lf=800,To={indicatorBg:"#dc2626",indicatorText:"#ffffff"},Ao={background:"rgba(254, 205, 211, 0.5)",border:"#06b6d4"},Qr={success:"#22c55e",hover:"#3b82f6"},Bn={click:{bg:"#dbeafe",text:"#2563eb"},drag:{bg:"#fef3c7",text:"#d97706"},type:{bg:"#dcfce7",text:"#16a34a"}};function Po(s){const e=s.getAttribute("data-test");if(e)return`[data-test="${e}"]`;const t=s.id;if(t&&!t.match(/^[:\d]|css-/))return`#${t}`;const n=Array.from(s.classList).filter(r=>!r.startsWith("css-")&&!r.match(/^[a-z]+-[\da-f]{6,}/i)).join(".");return n?`.${n}`:s.tagName.toLowerCase()}function df(s,e,t,n){const r=Math.abs(t-s),o=Math.abs(n-e);return r>Io||o>Io}function uf({targetRef:s,enabled:e}){const[t,n]=h.useState([]),[r,o]=h.useState(!1),i=h.useRef({isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}),c=h.useRef(null),l=h.useRef(null),d=h.useRef({element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""}),p=h.useCallback(y=>{n(j=>[...j,y])},[]),u=h.useCallback(()=>{const y=d.current;y.element&&(y.element.style.backgroundColor=y.originalBackground,y.element.style.outline=y.originalOutline,y.element.style.outlineOffset=y.originalOutlineOffset,d.current={element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""})},[]),f=h.useCallback(y=>{if(!r)return;const j=y.target;if(!j||j.closest('[data-test="capture-panel-v2"]')){u();return}const S=Po(j);i.current={isDragging:!1,startX:y.clientX,startY:y.clientY,startTime:Date.now(),selector:S,element:j}},[r,u]),m=h.useCallback(y=>{if(!r)return;const j=i.current;if(!j.element)return;const S=y.clientX,C=y.clientY,N=Date.now()-j.startTime;df(j.startX,j.startY,S,C)?p({type:"drag",timestamp:j.startTime,data:{startX:j.startX,startY:j.startY,endX:S,endY:C,selector:j.selector,duration:N}}):p({type:"click",timestamp:j.startTime,data:{x:j.startX,y:j.startY,selector:j.selector}}),i.current={isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}},[r,p]),g=h.useCallback(y=>{if(!r)return;const j=y.target;if(!j||!("value"in j))return;const S=Po(j),C=j.value;c.current&&window.clearTimeout(c.current),l.current={selector:S,value:C},c.current=window.setTimeout(()=>{l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},cf)},[r,p]),x=h.useCallback(y=>{if(!r)return;const j=y.target;if(j){if(j.closest('[data-test="capture-panel-v2"]')||j.closest('[data-test="recording-panel"]')){u();return}d.current.element!==j&&(u(),d.current={element:j,originalBackground:j.style.backgroundColor,originalOutline:j.style.outline,originalOutlineOffset:j.style.outlineOffset},j.style.backgroundColor=Ao.background,j.style.outline=`2px solid ${Ao.border}`,j.style.outlineOffset="1px")}},[r,u]);h.useEffect(()=>{if(!r)return;const y=document;return y.addEventListener("pointerdown",f),y.addEventListener("pointerup",m),y.addEventListener("pointermove",x),y.addEventListener("input",g,!0),()=>{y.removeEventListener("pointerdown",f),y.removeEventListener("pointerup",m),y.removeEventListener("pointermove",x),y.removeEventListener("input",g,!0),u(),c.current&&window.clearTimeout(c.current)}},[e,r,s,f,m,x,g,u]);const v=h.useCallback(()=>{o(!0)},[]),b=h.useCallback(()=>{o(!1),u(),c.current&&(window.clearTimeout(c.current),c.current=null),l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},[p,u]),w=h.useCallback(()=>{n([])},[]);return{interactions:t,isRecording:r,startRecording:v,stopRecording:b,clearRecording:w}}function kc(s){try{switch(s.type){case"click":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.click();const n=t.style.outline;t.style.outline=`3px solid ${Qr.success}`,setTimeout(()=>{t.style.outline=n},300)},300),Ee.success(`Clicked: ${e.selector}`)):Ee.error(`Element not found: ${e.selector}`);break}case"drag":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const n=t.getBoundingClientRect(),r=new PointerEvent("pointerdown",{bubbles:!0,clientX:n.left+(e.startX-n.left),clientY:n.top+(e.startY-n.top)}),o=new PointerEvent("pointerup",{bubbles:!0,clientX:e.endX,clientY:e.endY});t.dispatchEvent(r),setTimeout(()=>{t.dispatchEvent(o)},Math.min(e.duration,500))},300),Ee.success(`Dragged: ${e.selector}`)):Ee.error(`Element not found: ${e.selector}`);break}case"type":{const e=s.data,t=document.querySelector(e.selector);t&&"value"in t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.focus(),t.value=e.value,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const n=t.style.outline;t.style.outline=`3px solid ${Qr.success}`,setTimeout(()=>{t.style.outline=n},300)},300),Ee.success(`Typed into: ${e.selector}`)):Ee.error(`Input not found: ${e.selector}`);break}}}catch(e){Ee.error(`Replay failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async function pf(s,e){Ee.info(`Replaying ${e+1} interaction${e>0?"s":""}...`);for(let t=0;t<=e;t++)kc(s[t]),t<e&&await new Promise(n=>setTimeout(n,lf))}let cs=null;function hf(s){switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function ff(s){Ec();const e=hf(s);try{const t=document.querySelector(e);if(t){const n=t.getBoundingClientRect();n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth||t.scrollIntoView({behavior:"smooth",block:"center"}),cs={element:t,originalOutline:t.style.outline,originalOutlineOffset:t.style.outlineOffset},t.style.outline=`3px solid ${Qr.hover}`,t.style.outlineOffset="2px"}}catch{}}function Ec(){cs&&(cs.element.style.outline=cs.originalOutline,cs.element.style.outlineOffset=cs.originalOutlineOffset,cs=null)}function mf(s,e){const t=s-e;return t<1e3?`+${t}ms`:t<6e4?`+${(t/1e3).toFixed(1)}s`:`+${(t/6e4).toFixed(1)}m`}function gf({type:s}){switch(s){case"click":return a.jsx(Pa,{className:"w-3 h-3"});case"drag":return a.jsx(Aa,{className:"w-3 h-3"});case"type":return a.jsx(Ta,{className:"w-3 h-3"})}}function xf({interaction:s}){switch(s.type){case"click":{const e=s.data;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-click-details",children:["at (",e.x,", ",e.y,") â†’ ",a.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}case"drag":{const e=s.data;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-drag-details",children:["(",e.startX,", ",e.startY,") â†’ (",e.endX,", ",e.endY,") [",e.duration,"ms]"]})}case"type":{const e=s.data,t=e.value.length>30?`${e.value.slice(0,30)}...`:e.value;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-type-details",children:['"',t,'" â†’ ',a.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}}}function vf({interactions:s,isRecording:e,onExport:t,onClear:n}){const r=s.length>0?s[0].timestamp:0;return a.jsxs("div",{className:"flex flex-col h-full","data-test":"recording-panel",children:[a.jsxs("div",{className:"flex items-center justify-between p-2 border-b",style:{backgroundColor:"#f9fafb"},"data-test":"recording-panel-header",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium",style:{color:"#6b7280"},children:"Recordings"}),e&&a.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium animate-pulse",style:{backgroundColor:To.indicatorBg,color:To.indicatorText},"data-test":"recording-indicator",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-white"}),"REC"]}),a.jsxs("span",{className:"text-xs",style:{color:"#9ca3af"},"data-test":"interaction-count",children:["(",s.length,")"]})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:t,disabled:s.length===0,title:"Export as JSON","data-test":"export-recording-button",children:a.jsx(Ia,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:n,disabled:s.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:a.jsx(Et,{className:"w-3 h-3"})})]})]}),a.jsx("div",{className:"flex-1 overflow-auto p-2","data-test":"recording-timeline",children:s.length===0?a.jsx("div",{className:"flex items-center justify-center h-full text-xs text-gray-400","data-test":"empty-recordings",children:e?"Recording... Click or type to capture interactions":"No recordings yet"}):a.jsx("div",{className:"space-y-1",children:s.map((o,i)=>a.jsxs("div",{className:"flex items-start gap-2 p-1.5 rounded hover:bg-gray-100 cursor-pointer group transition-colors relative",onClick:()=>kc(o),onMouseEnter:()=>ff(o),onMouseLeave:Ec,title:"Click to replay this interaction","data-test":"recorded-interaction",children:[a.jsx("button",{className:"absolute top-1 right-1 w-5 h-5 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-blue-100 hover:bg-blue-200 text-blue-600",onClick:c=>{c.stopPropagation(),pf(s,i)},title:`Replay all ${i+1} interaction${i>0?"s":""} up to here`,"data-test":"replay-up-to-button",children:a.jsx(lp,{className:"w-3 h-3"})}),a.jsxs("div",{className:"flex flex-col items-center",children:[a.jsxs("div",{className:"w-5 h-5 rounded-full flex items-center justify-center relative",style:{backgroundColor:Bn[o.type].bg,color:Bn[o.type].text},"data-test":"interaction-icon",children:[a.jsx("span",{className:"group-hover:hidden",children:a.jsx(gf,{type:o.type})}),a.jsx(nc,{className:"w-3 h-3 hidden group-hover:block"})]}),i<s.length-1&&a.jsx("div",{className:"w-px h-3 bg-gray-200","data-test":"timeline-connector"})]}),a.jsxs("div",{className:"flex-1 min-w-0 pr-6",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium capitalize","data-test":"interaction-type",children:o.type}),a.jsx("span",{className:"text-xs text-gray-400","data-test":"interaction-time",children:mf(o.timestamp,r)}),a.jsx("span",{className:"text-xs text-green-600 opacity-0 group-hover:opacity-100 transition-opacity","data-test":"replay-hint",children:"â–¶ replay"})]}),a.jsx(xf,{interaction:o})]})]},`${o.timestamp}-${i}`))})})]})}const Bt="watcher:recording-sessions";function bf(){const[s,e]=h.useState([]);h.useEffect(()=>{try{const u=localStorage.getItem(Bt);u&&e(JSON.parse(u))}catch(u){console.warn("[SessionStorage] Failed to load from localStorage:",u)}},[]);const t=h.useCallback((u,f,m)=>{const g={id:`session-${Date.now()}`,name:u,description:f,savedAt:Date.now(),interactions:m,sourceUrl:window.location.href};return e(x=>{const v=[...x,g];return localStorage.setItem(Bt,JSON.stringify(v)),v}),Ee.success("Session saved!"),g},[]),n=h.useCallback(u=>{const f=localStorage.getItem(Bt);if(!f)return;const g=JSON.parse(f).find(x=>x.id===u);return g&&Ee.success("Session loaded!"),g},[]),r=h.useCallback(u=>{e(f=>{const m=f.filter(g=>g.id!==u);return localStorage.setItem(Bt,JSON.stringify(m)),m}),Ee.success("Session deleted")},[]),o=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>x.id===u?{...x,...f}:x);return localStorage.setItem(Bt,JSON.stringify(g)),g}),Ee.success("Session updated")},[]),i=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(v=>{if(v.id!==u)return v;const b=[...v.interactions];return b[f]=m,{...v,interactions:b}});return localStorage.setItem(Bt,JSON.stringify(x)),x}),Ee.success("Interaction updated")},[]),c=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>{if(x.id!==u)return x;const v=x.interactions.filter((b,w)=>w!==f);return{...x,interactions:v}});return localStorage.setItem(Bt,JSON.stringify(g)),g}),Ee.success("Interaction deleted")},[]),l=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(v=>{if(v.id!==u)return v;const b=[...v.interactions];return b.splice(f,0,m),{...v,interactions:b}});return localStorage.setItem(Bt,JSON.stringify(x)),x}),Ee.success("Interaction inserted")},[]),d=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(v=>{if(v.id!==u)return v;const b=[...v.interactions];return b[f]=m,{...v,interactions:b}});return localStorage.setItem(Bt,JSON.stringify(x)),x}),Ee.success("Interaction replaced")},[]),p=h.useCallback(()=>{try{const u=localStorage.getItem(Bt);if(!u)return;const f=JSON.parse(u);return f.length===0?void 0:f[f.length-1]}catch{return}},[]);return{savedSessions:s,saveSession:t,loadSession:n,deleteSession:r,updateSession:o,updateInteraction:i,deleteInteraction:c,insertInteraction:l,replaceInteraction:d,getLastSession:p}}const Ic=h.createContext(null);function $t({open:s,onOpenChange:e,defaultOpen:t,...n}){const[r,o]=h.useState(t??!1),i=s!==void 0,c=i?s:r,l=h.useCallback(u=>{i||o(u),e==null||e(u)},[i,e]),d=h.useCallback(()=>{l(!c)},[c,l]),p=h.useMemo(()=>({toggle:d,isOpen:c}),[d,c]);return a.jsx(Ic.Provider,{value:p,children:a.jsx(Eu,{open:c,onOpenChange:l,...n})})}const sC=Du,Kt=ku,It=h.forwardRef(({className:s,children:e,onPointerDown:t,hideChevron:n,...r},o)=>{const i=h.useContext(Ic),c=h.useCallback(l=>{if(i!=null&&i.isOpen){l.preventDefault(),i.toggle();return}t==null||t(l)},[i,t]);return a.jsxs(Ti,{ref:o,className:B("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),onPointerDown:c,...r,children:[e,!n&&a.jsx(Iu,{asChild:!0,children:a.jsx(wt,{className:"h-4 w-4 opacity-50"})})]})});It.displayName=Ti.displayName;const Tc=h.forwardRef(({className:s,...e},t)=>a.jsx(Ri,{ref:t,className:B("flex cursor-default items-center justify-center py-1",s),...e,children:a.jsx(ar,{className:"h-4 w-4"})}));Tc.displayName=Ri.displayName;const Ac=h.forwardRef(({className:s,...e},t)=>a.jsx(Di,{ref:t,className:B("flex cursor-default items-center justify-center py-1",s),...e,children:a.jsx(wt,{className:"h-4 w-4"})}));Ac.displayName=Di.displayName;const Tt=h.forwardRef(({className:s,children:e,position:t="popper",style:n,container:r,...o},i)=>a.jsx(Tu,{container:r??void 0,children:a.jsxs(Ai,{ref:i,style:{zIndex:st.tooltip,...n},className:B("relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:t,...o,children:[a.jsx(Tc,{}),a.jsx(Au,{className:B("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),a.jsx(Ac,{})]})}));Tt.displayName=Ai.displayName;const wf=h.forwardRef(({className:s,...e},t)=>a.jsx(_i,{ref:t,className:B("px-2 py-1.5 text-sm font-semibold",s),...e}));wf.displayName=_i.displayName;const Oe=h.forwardRef(({className:s,children:e,...t},n)=>a.jsxs(Pi,{ref:n,className:B("relative flex w-full cursor-default select-none items-start rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[a.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center mt-0.5",children:a.jsx(Pu,{children:a.jsx(ct,{className:"h-4 w-4"})})}),a.jsx(Ru,{className:"flex-1",children:e})]}));Oe.displayName=Pi.displayName;const yf=h.forwardRef(({className:s,...e},t)=>a.jsx(Oi,{ref:t,className:B("-mx-1 my-1 h-px bg-muted",s),...e}));yf.displayName=Oi.displayName;function Sf({onSaveSession:s,onLoadSession:e,onManageSessions:t,disabled:n=!1,portalContainer:r}){const o=i=>{switch(i){case"save":s();break;case"load":e();break;case"manage":t();break}};return a.jsxs($t,{value:"",onValueChange:o,children:[a.jsx(It,{className:"h-6 w-6 p-0 border-0 bg-transparent hover:bg-accent rounded",hideChevron:!0,disabled:n,title:"More options","data-test":"recording-more-options-trigger",children:a.jsx(dp,{className:"w-3 h-3"})}),a.jsxs(Tt,{container:r,"data-test":"recording-more-options-content",children:[a.jsx(Oe,{value:"save","data-test":"recording-option-save",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Nn,{className:"w-3 h-3"}),a.jsx("span",{children:"Save Session"})]})}),a.jsx(Oe,{value:"load","data-test":"recording-option-load",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(rc,{className:"w-3 h-3"}),a.jsx("span",{children:"Load Session"})]})}),a.jsx(Oe,{value:"manage","data-test":"recording-option-manage",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(up,{className:"w-3 h-3"}),a.jsx("span",{children:"Manage Sessions"})]})})]})]})}function Ro({interaction:s,onSave:e,onCancel:t,onPickSelector:n}){var R,k,A,L,M,I,z,$,q,P,te,E,_,F,V;const[r,o]=h.useState((s==null?void 0:s.type)??"click"),[i,c]=h.useState(jf(s)??""),[l,d]=h.useState(((k=(R=s==null?void 0:s.data)==null?void 0:R.x)==null?void 0:k.toString())??"0"),[p,u]=h.useState(((L=(A=s==null?void 0:s.data)==null?void 0:A.y)==null?void 0:L.toString())??"0"),[f,m]=h.useState(((I=(M=s==null?void 0:s.data)==null?void 0:M.startX)==null?void 0:I.toString())??"0"),[g,x]=h.useState((($=(z=s==null?void 0:s.data)==null?void 0:z.startY)==null?void 0:$.toString())??"0"),[v,b]=h.useState(((P=(q=s==null?void 0:s.data)==null?void 0:q.endX)==null?void 0:P.toString())??"0"),[w,y]=h.useState(((E=(te=s==null?void 0:s.data)==null?void 0:te.endY)==null?void 0:E.toString())??"0"),[j,S]=h.useState(((F=(_=s==null?void 0:s.data)==null?void 0:_.duration)==null?void 0:F.toString())??"100"),[C,N]=h.useState(((V=s==null?void 0:s.data)==null?void 0:V.value)??"");h.useEffect(()=>{s||(c(""),d("0"),u("0"),m("0"),x("0"),b("0"),y("0"),S("100"),N(""))},[r,s]);const O=()=>{const Y=(s==null?void 0:s.timestamp)??Date.now();let T;switch(r){case"click":T={x:parseInt(l,10)||0,y:parseInt(p,10)||0,selector:i};break;case"drag":T={startX:parseInt(f,10)||0,startY:parseInt(g,10)||0,endX:parseInt(v,10)||0,endY:parseInt(w,10)||0,selector:i,duration:parseInt(j,10)||100};break;case"type":T={selector:i,value:C};break}e({type:r,timestamp:Y,data:T})};return a.jsxs("div",{className:"space-y-3 p-3","data-test":"interaction-editor-form",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Interaction Type"}),a.jsxs($t,{value:r,onValueChange:Y=>o(Y),children:[a.jsx(It,{className:"h-8","data-test":"interaction-type-select",children:a.jsx(Kt,{})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"click",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Pa,{className:"w-3 h-3"}),"Click"]})}),a.jsx(Oe,{value:"drag",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Aa,{className:"w-3 h-3"}),"Drag"]})}),a.jsx(Oe,{value:"type",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ta,{className:"w-3 h-3"}),"Type"]})})]})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"CSS Selector"}),a.jsxs("div",{className:"flex gap-1",children:[a.jsx(We,{value:i,onChange:Y=>c(Y.target.value),placeholder:'e.g., [data-test="button"]',className:"h-8 text-xs flex-1","data-test":"interaction-selector-input"}),n&&a.jsx(ue,{variant:"outline",size:"sm",className:"h-8 px-2",onClick:n,title:"Pick from page","data-test":"pick-selector-button",children:a.jsx(pp,{className:"w-3 h-3"})})]})]}),r==="click"&&a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"X"}),a.jsx(We,{type:"number",value:l,onChange:Y=>d(Y.target.value),className:"h-8 text-xs","data-test":"click-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Y"}),a.jsx(We,{type:"number",value:p,onChange:Y=>u(Y.target.value),className:"h-8 text-xs","data-test":"click-y-input"})]})]}),r==="drag"&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Start X"}),a.jsx(We,{type:"number",value:f,onChange:Y=>m(Y.target.value),className:"h-8 text-xs","data-test":"drag-start-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Start Y"}),a.jsx(We,{type:"number",value:g,onChange:Y=>x(Y.target.value),className:"h-8 text-xs","data-test":"drag-start-y-input"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"End X"}),a.jsx(We,{type:"number",value:v,onChange:Y=>b(Y.target.value),className:"h-8 text-xs","data-test":"drag-end-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"End Y"}),a.jsx(We,{type:"number",value:w,onChange:Y=>y(Y.target.value),className:"h-8 text-xs","data-test":"drag-end-y-input"})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Duration (ms)"}),a.jsx(We,{type:"number",value:j,onChange:Y=>S(Y.target.value),className:"h-8 text-xs","data-test":"drag-duration-input"})]})]}),r==="type"&&a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-xs",children:"Value to type"}),a.jsx(We,{value:C,onChange:Y=>N(Y.target.value),placeholder:"Text to type...",className:"h-8 text-xs","data-test":"type-value-input"})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx(ue,{variant:"ghost",size:"sm",onClick:t,"data-test":"cancel-edit-button",children:"Cancel"}),a.jsx(ue,{size:"sm",onClick:O,disabled:!i,"data-test":"save-edit-button",children:s?"Update":"Add"})]})]})}function jf(s){if(s)switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function Cf({session:s,onBack:e,onUpdateSession:t,onUpdateInteraction:n,onDeleteInteraction:r,onInsertInteraction:o,onStartInsertRecord:i,onStartReplaceRecord:c}){const[l,d]=h.useState(!1),[p,u]=h.useState(!1),[f,m]=h.useState(s.name),[g,x]=h.useState(s.description),[v,b]=h.useState(null),[w,y]=h.useState(null),j=()=>{f.trim()&&(t({name:f.trim()}),d(!1))},S=()=>{t({description:g.trim()}),u(!1)},C=k=>{v!==null?(n(v,k),b(null)):w!==null&&(o(w,k),y(null))},N=k=>{switch(k){case"click":return a.jsx(Pa,{className:"w-3 h-3"});case"drag":return a.jsx(Aa,{className:"w-3 h-3"});case"type":return a.jsx(Ta,{className:"w-3 h-3"})}},O=k=>{switch(k.type){case"click":{const A=k.data;return`Click at (${A.x}, ${A.y})`}case"drag":return`Drag ${k.data.duration}ms`;case"type":{const A=k.data;return`Type "${A.value.length>20?`${A.value.slice(0,20)}...`:A.value}"`}}},R=k=>{switch(k.type){case"click":return k.data.selector;case"drag":return k.data.selector;case"type":return k.data.selector}};return v!==null?a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-interaction-form",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>b(null),"data-test":"cancel-edit-interaction",children:a.jsx(br,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium",children:["Edit Interaction #",v+1]})]}),a.jsx(Ro,{interaction:s.interactions[v],onSave:C,onCancel:()=>b(null)})]}):w!==null?a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-add-form",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>y(null),"data-test":"cancel-add-interaction",children:a.jsx(br,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium",children:["Add Interaction at #",w+1]})]}),a.jsx(Ro,{onSave:C,onCancel:()=>y(null)})]}):a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-view",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:e,"data-test":"session-editor-back",children:a.jsx(br,{className:"w-4 h-4"})}),a.jsx("span",{className:"text-sm font-medium",children:"Edit Session"})]}),a.jsxs("div",{className:"flex-1 overflow-auto p-3 space-y-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-gray-500",children:"Name"}),l?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(We,{value:f,onChange:k=>m(k.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:k=>k.key==="Enter"&&j(),"data-test":"session-name-input"}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:j,children:a.jsx(ct,{className:"w-3 h-3 text-green-600"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{d(!1),m(s.name)},children:a.jsx(ht,{className:"w-3 h-3 text-gray-500"})})]}):a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm flex-1","data-test":"session-name-display",children:s.name}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>d(!0),"data-test":"edit-session-name",children:a.jsx(kn,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-gray-500",children:"Description"}),p?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(We,{value:g,onChange:k=>x(k.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:k=>k.key==="Enter"&&S(),"data-test":"session-description-input"}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:S,children:a.jsx(ct,{className:"w-3 h-3 text-green-600"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{u(!1),x(s.description)},children:a.jsx(ht,{className:"w-3 h-3 text-gray-500"})})]}):a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm flex-1 text-gray-600","data-test":"session-description-display",children:s.description||"(no description)"}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>u(!0),"data-test":"edit-session-description",children:a.jsx(kn,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("label",{className:"text-xs text-gray-500",children:["Interactions (",s.interactions.length,")"]})}),a.jsxs("div",{className:"space-y-1","data-test":"session-interactions-list",children:[a.jsx(Do,{index:0,onAddManual:()=>y(0),onAddRecord:()=>i(0)}),s.interactions.map((k,A)=>a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50 group","data-test":"session-interaction",children:[a.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:Bn[k.type].bg,color:Bn[k.type].text},children:N(k.type)}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"text-xs font-medium",children:O(k)}),a.jsx("code",{className:"text-xs text-gray-400 truncate block",children:R(k)})]}),a.jsxs("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>b(A),title:"Edit","data-test":"edit-interaction-button",children:a.jsx(kn,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>c(A),title:"Replace by recording","data-test":"replace-interaction-button",children:a.jsx(On,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-red-500 hover:text-red-600",onClick:()=>r(A),title:"Delete","data-test":"delete-interaction-button",children:a.jsx(Et,{className:"w-3 h-3"})})]})]}),a.jsx(Do,{index:A+1,onAddManual:()=>y(A+1),onAddRecord:()=>i(A+1)})]},`${k.timestamp}-${A}`))]})]})]})]})}function Do({index:s,onAddManual:e,onAddRecord:t}){return a.jsx("div",{className:"flex items-center justify-center py-1 group opacity-0 hover:opacity-100 transition-opacity","data-test":"insert-point",children:a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsxs(ue,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-blue-500 hover:text-blue-600 hover:bg-blue-50",onClick:e,title:"Add manually","data-test":"insert-manual-button",children:[a.jsx(Ks,{className:"w-3 h-3 mr-1"}),"Manual"]}),a.jsxs(ue,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-green-500 hover:text-green-600 hover:bg-green-50",onClick:t,title:"Record new action","data-test":"insert-record-button",children:[a.jsx(Ys,{className:"w-3 h-3 mr-1"}),"Record"]})]})})}function Nf({isOpen:s,savedSessions:e,onLoad:t,onDelete:n,onUpdateSession:r,onUpdateInteraction:o,onDeleteInteraction:i,onInsertInteraction:c,onStartInsertRecord:l,onStartReplaceRecord:d,onClose:p,portalContainer:u}){const[f,m]=h.useState(null);if(!s)return null;const g=f?e.find(b=>b.id===f):null,x=b=>new Date(b).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),v=()=>{m(null)};return g?a.jsx(os,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:500},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:a.jsx(Cf,{session:g,onBack:v,onUpdateSession:b=>r(g.id,b),onUpdateInteraction:(b,w)=>o(g.id,b,w),onDeleteInteraction:b=>i(g.id,b),onInsertInteraction:(b,w)=>c(g.id,b,w),onStartInsertRecord:b=>l(g.id,b),onStartReplaceRecord:b=>d(g.id,b)})}):a.jsx(os,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:400},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:a.jsx("div",{className:"p-3 h-full overflow-auto","data-test":"session-manager-body",children:e.length===0?a.jsx("div",{className:"text-sm italic text-center py-8 text-gray-400","data-test":"session-manager-empty",children:"No saved sessions yet"}):a.jsx("div",{className:"space-y-2","data-test":"session-manager-list",children:e.map(b=>a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50","data-test":"session-item",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"text-sm font-medium truncate","data-test":"session-name",children:b.name}),b.description&&a.jsx("div",{className:"text-xs text-gray-500 truncate","data-test":"session-description",children:b.description}),a.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-2",children:[a.jsx("span",{"data-test":"session-date",children:x(b.savedAt)}),a.jsx("span",{children:"Â·"}),a.jsxs("span",{"data-test":"session-interaction-count",children:[b.interactions.length," interaction",b.interactions.length!==1?"s":""]})]})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>t(b.id),title:"Load session","data-test":"session-load",children:a.jsx(rc,{className:"w-4 h-4 text-blue-500"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>m(b.id),title:"Edit session","data-test":"session-edit",children:a.jsx(kn,{className:"w-4 h-4 text-gray-500"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>n(b.id),title:"Delete session","data-test":"session-delete",children:a.jsx(Et,{className:"w-4 h-4 text-red-500"})})]})]},b.id))})})})}function _o({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1),[r,o]=h.useState(!1),[i,c]=h.useState(!1),[l,d]=h.useState(""),[p,u]=h.useState(""),[f,m]=h.useState({type:"none"}),{interactions:g,isRecording:x,startRecording:v,stopRecording:b,clearRecording:w}=uf({targetRef:null,enabled:!0}),y=bf();h.useCallback(q=>{f.type==="insert"?(y.insertInteraction(f.sessionId,f.atIndex,q),m({type:"none"}),b(),Ee.success("Interaction inserted!")):f.type==="replace"&&(y.replaceInteraction(f.sessionId,f.atIndex,q),m({type:"none"}),b(),Ee.success("Interaction replaced!"))},[f,y,b]);const j=h.useCallback(()=>{x?(b(),n(!1),Ee.success(`Stopped recording. Captured ${g.length} interactions.`)):(v(),n(!1),Ee.info("Recording started. Click, drag, or type to capture."))},[x,g.length,v,b]),S=h.useCallback(()=>{const q={interactions:g,exportedAt:new Date().toISOString(),url:window.location.href},P=new Blob([JSON.stringify(q,null,2)],{type:"application/json"}),te=URL.createObjectURL(P),E=document.createElement("a");E.href=te,E.download=`recording-${Date.now()}.json`,E.click(),URL.revokeObjectURL(te),Ee.success("Recording exported!")},[g]),C=h.useCallback(()=>{w(),Ee.success("Recording cleared")},[w]),N=h.useCallback(()=>{n(!1)},[]),O=h.useCallback(()=>{n(!0)},[]),R=h.useCallback(()=>{if(g.length===0){Ee.error("No interactions to save");return}d(`Session ${new Date().toLocaleString()}`),u(""),c(!0)},[g.length]),k=h.useCallback(()=>{if(!l.trim()){Ee.error("Please enter a name");return}y.saveSession(l.trim(),p.trim(),g),c(!1),d(""),u("")},[l,p,g,y]),A=h.useCallback(()=>{const q=y.getLastSession();q?(w(),Ee.info(`Would load session: ${q.name}`)):Ee.info("No saved sessions. Use 'Manage Sessions' to view all.")},[y,w]),L=h.useCallback(()=>{o(!0)},[]),M=h.useCallback(q=>{const P=y.loadSession(q);P&&(w(),Ee.success(`Loaded: ${P.name}`),o(!1))},[y,w]),I=h.useCallback((q,P)=>{m({type:"insert",sessionId:q,atIndex:P}),v(),o(!1),Ee.info("Recording... Perform an action to insert it.")},[v]),z=h.useCallback((q,P)=>{m({type:"replace",sessionId:q,atIndex:P}),v(),o(!1),Ee.info("Recording... Perform an action to replace.")},[v]),$=a.jsxs(a.Fragment,{children:[a.jsxs(ue,{variant:x?"destructive":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:j,"data-test":"record-toggle-button",children:[a.jsx(Ys,{className:"w-3 h-3 mr-1",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0}),x?"Stop":"Record"]}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:S,disabled:g.length===0,title:"Export as JSON","data-test":"export-recording-button",children:a.jsx(Ia,{className:"w-3 h-3"})}),a.jsx(ue,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:C,disabled:g.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:a.jsx(Et,{className:"w-3 h-3"})}),a.jsx(Sf,{onSaveSession:R,onLoadSession:A,onManageSessions:L})]});return a.jsxs(a.Fragment,{children:[a.jsx(ue,{variant:s,size:e,onClick:x?j:O,title:x?"Stop Recording":"Open Recorder","data-test":"global-record-button",className:x?"text-red-500 hover:text-red-400":"",children:a.jsx(Ys,{className:"h-5 w-5",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0})}),x&&a.jsx("div",{className:"fixed inset-0 z-40 pointer-events-none",style:{backgroundColor:"rgba(220, 38, 38, 0.03)"},"data-test":"global-recording-overlay"}),f.type!=="none"&&a.jsxs("div",{className:"fixed top-2 left-1/2 -translate-x-1/2 z-50 bg-blue-500 text-white px-3 py-1 rounded-full text-sm animate-pulse","data-test":"edit-mode-indicator",children:[f.type==="insert"?"Recording to insert...":"Recording to replace...",a.jsx(ue,{variant:"ghost",size:"sm",className:"ml-2 h-5 px-2 text-white hover:text-white hover:bg-blue-600",onClick:()=>{m({type:"none"}),b()},children:"Cancel"})]}),a.jsx(os,{isVisible:t,onClose:N,title:`Recorder ${g.length>0?`(${g.length})`:""}`,shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth-420,y:60},initialSize:{width:400,height:350},showPinButton:!1,headerActions:$,children:a.jsx(vf,{interactions:g,isRecording:x,onExport:S,onClear:C})}),a.jsx(os,{isVisible:i,onClose:()=>c(!1),title:"Save Session",initialPosition:{x:window.innerWidth/2-175,y:150},initialSize:{width:350,height:220},shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,children:a.jsxs("div",{className:"p-4 space-y-3","data-test":"save-session-dialog",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-sm",children:"Name"}),a.jsx(We,{value:l,onChange:q=>d(q.target.value),placeholder:"Session name",autoFocus:!0,"data-test":"save-session-name"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(Se,{className:"text-sm",children:"Description (optional)"}),a.jsx(We,{value:p,onChange:q=>u(q.target.value),placeholder:"Brief description","data-test":"save-session-description"})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx(ue,{variant:"ghost",size:"sm",onClick:()=>c(!1),"data-test":"save-session-cancel",children:"Cancel"}),a.jsxs(ue,{size:"sm",onClick:k,"data-test":"save-session-confirm",children:["Save (",g.length," interactions)"]})]})]})}),a.jsx(Nf,{isOpen:r,savedSessions:y.savedSessions,onLoad:M,onDelete:y.deleteSession,onUpdateSession:y.updateSession,onUpdateInteraction:y.updateInteraction,onDeleteInteraction:y.deleteInteraction,onInsertInteraction:y.insertInteraction,onStartInsertRecord:I,onStartReplaceRecord:z,onClose:()=>o(!1)})]})}const Ct=h.forwardRef(({className:s,...e},t)=>a.jsx(Li,{ref:t,className:B("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...e,children:a.jsx(_u,{className:B("flex items-center justify-center text-current"),children:a.jsx(ct,{className:"h-4 w-4"})})}));Ct.displayName=Li.displayName;const kf=ln("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}}),pt=h.forwardRef(({className:s,variant:e,...t},n)=>a.jsx("div",{ref:n,className:B(kf({variant:e}),s),...t}));pt.displayName="Badge";function Zr({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1,contentStyle:o}){const[i,c]=h.useState(!1),[l,d]=h.useState(""),p=e.find(m=>m.value===s),u=e.filter(m=>m.label.toLowerCase().includes(l.toLowerCase())),f=m=>{t==null||t(m),c(!1),d("")};return p?a.jsxs(nt,{open:i,onOpenChange:c,children:[a.jsx(ut,{asChild:!0,children:a.jsx(pt,{variant:p.variant||"secondary",className:B("cursor-pointer hover:opacity-80 transition-opacity",p.className,r&&"opacity-50 cursor-not-allowed"),onClick:m=>{m.stopPropagation(),r&&m.preventDefault()},children:p.label})}),a.jsx(Qe,{className:"popover-content w-64 p-2",align:"start",style:o,children:a.jsxs("div",{className:"selector-container space-y-2",children:[a.jsx(We,{placeholder:n,value:l,onChange:m=>d(m.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),a.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(m=>a.jsxs(ue,{variant:"ghost",className:B("option-item w-full justify-between h-8 px-2",m.value===s&&"bg-accent"),onClick:()=>f(m.value),children:[a.jsx(pt,{variant:m.variant||"secondary",className:B("text-xs",m.className),children:m.label}),m.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4"})]},m.value))})]})})]}):null}const cr=h.forwardRef(({className:s,...e},t)=>a.jsx(mt,{ref:t,className:B("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...e}));cr.displayName=mt.displayName;const Pc=({children:s,value:e,onValueChange:t,filter:n,shouldFilter:r,...o})=>a.jsx(Fn,{modal:!1,...o,children:a.jsx(ka,{children:a.jsxs(cn,{className:B("overflow-hidden p-0 fixed inset-x-0 top-[10%] mx-auto max-w-2xl w-full","gap-4 border bg-background shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:slide-out-to-top-8 data-[state=open]:slide-in-from-top-8","sm:rounded-lg"),style:{zIndex:st.commandPalette},"data-test":"command-dialog",children:[a.jsx(Zs,{className:"sr-only",children:"Command Palette"}),a.jsx(cr,{value:e,onValueChange:t,filter:n,shouldFilter:r,className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-1.5 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:s}),a.jsxs(Ea,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ht,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})})}),lr=h.forwardRef(({className:s,...e},t)=>a.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[a.jsx(or,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),a.jsx(mt.Input,{ref:t,className:B("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...e})]}));lr.displayName=mt.Input.displayName;const un=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.List,{ref:t,className:B("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...e}));un.displayName=mt.List.displayName;const pn=h.forwardRef((s,e)=>a.jsx(mt.Empty,{ref:e,className:"py-6 text-center text-sm",...s}));pn.displayName=mt.Empty.displayName;const Ts=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.Group,{ref:t,className:B("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...e}));Ts.displayName=mt.Group.displayName;const ea=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.Separator,{ref:t,className:B("-mx-1 h-px bg-border",s),...e}));ea.displayName=mt.Separator.displayName;const is=h.forwardRef(({className:s,...e},t)=>a.jsx(mt.Item,{ref:t,className:B("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s),...e}));is.displayName=mt.Item.displayName;const Jt="__no_project__",Ef=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},If=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},Tf=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},Af=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath};function Rc({variant:s="badge",className:e,multiSelect:t=!1,value:n,onChange:r}){const[o,i]=h.useState(!1),c=r!==void 0,l=Le(Ef),d=Le(If),p=Le(Tf),u=Le(Af),f=c?n:u,m=t?Array.isArray(f)?f:f?[f]:[]:null,g=h.useCallback(w=>{var S,C,N;const y=l.find(O=>O.id===w||O.path===w),j=(y==null?void 0:y.path)??w;if(c)r(w);else{const O=ie.getState();ie.updateState({app:{...O.app,claude:{...(S=O.app)==null?void 0:S.claude,ui:{...(N=(C=O.app)==null?void 0:C.claude)==null?void 0:N.ui,selectedProjectPath:j}}}})}},[c,r,l]),x=h.useCallback(w=>{if(!t||!m)return;const y=l.find(C=>C.id===w||C.path===w),j=(y==null?void 0:y.path)??w,S=m.includes(j)?m.filter(C=>C!==j):[...m,j];c&&r(S)},[t,m,l,c,r]),v=h.useCallback(()=>{var w,y,j;if(c)r(t?[]:void 0);else{const S=ie.getState();ie.updateState({app:{...S.app,claude:{...(w=S.app)==null?void 0:w.claude,ui:{...(j=(y=S.app)==null?void 0:y.claude)==null?void 0:j.ui,selectedProjectPath:void 0}}}})}},[c,r,t]);if(h.useEffect(()=>{!c&&!d&&l.length>0&&!u&&g(l[0].path)},[c,d,l,u,g]),d)return a.jsx("div",{"data-test":"project-selector-loading",className:e,children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading projects..."})});if(p)return a.jsx("div",{"data-test":"project-selector-error",className:e,children:a.jsx("span",{className:"text-sm text-destructive",children:p})});if(l.length===0)return a.jsx("div",{"data-test":"project-selector-empty",className:e,children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"No projects found"})});const b=t?null:l.find(w=>w.path===f||w.id===f);if(t&&m){const w=l.filter(S=>m.includes(S.path)),y=m.includes(Jt),j=m.length>0;return a.jsxs("div",{"data-test":"project-selector-multi",className:"project-selector-multi-wrapper",children:[a.jsxs(nt,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(ue,{"data-test":"project-selector-trigger",variant:"outline",role:"combobox","aria-expanded":o,className:B("project-selector-trigger w-full justify-between",j&&"h-auto min-h-[40px] py-2"),disabled:d,children:[a.jsx("div",{className:"flex flex-wrap gap-1 flex-1 mr-2",children:j?a.jsxs(a.Fragment,{children:[y&&a.jsxs(pt,{"data-test":"project-badge-none",variant:"secondary",className:"selected-project-badge gap-1",children:["No project",a.jsx(ht,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:S=>{S.stopPropagation(),x(Jt)}})]}),w.map(S=>a.jsxs(pt,{"data-test":"project-badge",variant:"secondary",className:"selected-project-badge gap-1",children:[S.name,a.jsx(ht,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:C=>{C.stopPropagation(),x(S.path)}})]},S.id))]}):a.jsx("span",{className:"text-muted-foreground",children:"Select projects..."})}),a.jsx(ac,{className:"h-4 w-4 shrink-0 opacity-50"})]})}),a.jsx(Qe,{"data-test":"project-selector-content",className:"project-selector-content w-[400px] p-0",style:{zIndex:st.tooltip},children:a.jsxs(cr,{children:[a.jsx(lr,{"data-test":"project-selector-search",placeholder:"Search projects..."}),a.jsxs(un,{className:"max-h-[300px]",children:[a.jsx(pn,{children:"No projects found."}),a.jsxs(Ts,{children:[a.jsxs(is,{"data-test":"project-selector-item-none",value:Jt,onSelect:()=>x(Jt),className:"project-selector-item cursor-pointer",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4 shrink-0",m.includes(Jt)?"opacity-100":"opacity-0")}),a.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[a.jsx("span",{className:"project-name font-medium",children:"No project"}),a.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})]}),l.map(S=>a.jsxs(is,{"data-test":"project-selector-item",value:S.path,onSelect:()=>x(S.path),className:"project-selector-item cursor-pointer",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4 shrink-0",m.includes(S.path)?"opacity-100":"opacity-0")}),a.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[a.jsx("span",{className:"project-name font-medium",children:S.name}),a.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[S.sessionCount," sessions"]})]})]},S.id))]})]})]})})]}),j&&a.jsxs(ue,{"data-test":"project-selector-clear-all",variant:"outline",size:"sm",onClick:v,className:"clear-all-button w-full mt-2",children:[a.jsx(ht,{className:"h-4 w-4 mr-2"}),"Clear all (",m.length,")"]})]})}if(s==="badge"&&!t){const w=typeof f=="string"?f:void 0,y=[{value:Jt,label:"No project",variant:"secondary"},...l.map(j=>({value:j.path,label:`${j.name} (${j.sessionCount})`,variant:"secondary"}))];return a.jsx(Zr,{"data-test":"project-selector-badge",value:w??l[0].path,options:y,onChange:g,placeholder:"Search projects..."})}if(!t){const w=typeof f=="string"?f:void 0;return a.jsxs("div",{"data-test":"project-selector-select",className:"project-selector-wrapper flex gap-2",children:[a.jsxs($t,{value:w??l[0].path,onValueChange:g,children:[a.jsx(It,{"data-test":"project-selector-trigger",className:e,children:a.jsx(Kt,{children:w===Jt?"No project":b?`${b.name} (${b.sessionCount})`:"Select project"})}),a.jsxs(Tt,{children:[a.jsx(Oe,{"data-test":"project-selector-item-none",value:Jt,children:a.jsxs("div",{className:"project-option flex flex-col items-start",children:[a.jsx("span",{className:"project-name font-medium",children:"No project"}),a.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})},Jt),l.map(y=>a.jsx(Oe,{"data-test":"project-selector-item",value:y.path,children:a.jsxs("div",{className:"project-option flex flex-col items-start",children:[a.jsx("span",{className:"project-name font-medium",children:y.name}),a.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[y.sessionCount," sessions"]})]})},y.id))]})]}),w&&a.jsx(ue,{"data-test":"project-selector-clear",variant:"outline",size:"icon",onClick:v,className:"clear-project-button shrink-0",title:"Clear project filter",children:a.jsx(ht,{className:"h-4 w-4"})})]})}return null}const dr=h.forwardRef(({label:s,onAction:e,configOptions:t=[],popoverContent:n,longPressDuration:r=400,showStaticGear:o=!1,showHint:i=!1,enableOnboarding:c=!1,tooltipText:l,ariaLabel:d,variant:p="secondary",size:u="default",disabled:f=!1,className:m,compact:g=!1,buttonClassName:x,...v},b)=>{const[w,y]=h.useState(!1),[j,S]=h.useState(!1),[C,N]=h.useState(!1),[O,R]=h.useState(0),[k,A]=h.useState(c),L=h.useRef(null),M=h.useRef(null),I=h.useRef(0),z=h.useRef(!1),$=h.useRef(!1),q=h.useRef(null),P=h.useRef(null),te=h.useRef(null),E=h.useCallback(()=>{L.current&&(clearTimeout(L.current),L.current=null),M.current&&(clearInterval(M.current),M.current=null),y(!1),R(0)},[]);h.useEffect(()=>E,[E]),h.useEffect(()=>{f&&(E(),S(!1))},[f,E]),h.useEffect(()=>{if(!j||C)return;const ce=Ae=>{var ve,U;const ke=Ae.target;(ve=te.current)!=null&&ve.contains(ke)||(U=P.current)!=null&&U.contains(ke)||S(!1)};return document.addEventListener("mousedown",ce),()=>{document.removeEventListener("mousedown",ce)}},[j,C]);const _=n!==void 0||t.length>0,F=h.useCallback(ce=>{if(!(f||!_)){if(ce.type==="touchstart"&&ce.preventDefault(),y(!0),S(!1),I.current=Date.now(),z.current=!1,$.current=!0,k&&A(!1),!g){const Ae=100/(r/16);M.current=setInterval(()=>{R(ke=>{const ve=ke+Ae;return ve>100?100:ve})},16)}L.current=setTimeout(()=>{g?N(!0):S(!0),R(0),M.current&&(clearInterval(M.current),M.current=null)},r)}},[f,_,r,k,g]),V=h.useCallback(()=>{if(f)return;Date.now()-I.current<r&&!j?(z.current=!0,e()):z.current=!0,E()},[f,r,j,e,E]),Y=h.useCallback(()=>{f||($.current||e(),$.current=!1)},[f,e]),T=h.useCallback(()=>{f||j||E()},[f,j,E]),W=h.useCallback(ce=>{ce.stopPropagation(),N(!0)},[]),se=h.useCallback(ce=>{ce.onClick(),N(!1),S(!1)},[]),le=20,me=2*Math.PI*le,ae=me-O/100*me,H=`${s} (Click) / Configure (Hold)`,Q=l??H,ge=a.jsxs(ue,{ref:q,variant:p,size:u,disabled:f,className:B("button-main relative transition-all",w&&"scale-95",!g&&i&&_&&"pr-8",x),onPointerDown:F,onPointerUp:V,onPointerLeave:T,onClick:Y,"aria-label":d||(typeof s=="string"?`Button: ${s}. Secondary action: long press for configuration`:"Button with configuration options"),"aria-pressed":w,"aria-expanded":C,"aria-haspopup":"menu",...v,children:[s,!g&&i&&_&&a.jsx(hp,{className:"hint-icon absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 opacity-30"})]});return g?a.jsxs("div",{ref:b,className:B("relative inline-flex items-center",m),children:[a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:ge}),a.jsx(Vt,{children:a.jsx("p",{children:Q})})]})}),a.jsxs(nt,{open:C,onOpenChange:ce=>{N(ce)},children:[a.jsx(ut,{asChild:!0,children:a.jsx("span",{className:"absolute inset-0 pointer-events-none","aria-hidden":"true"})}),a.jsx(Qe,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ce,Ae)=>a.jsxs("button",{onClick:()=>se(ce),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ce.icon&&a.jsx("span",{className:"shrink-0",children:ce.icon}),a.jsx("span",{children:ce.label})]},ce.value??Ae))})})]})]}):a.jsxs("div",{ref:b,className:B("relative inline-flex items-center gap-2",m),children:[a.jsx(ss,{children:a.jsxs(ns,{open:k?!0:j?!1:void 0,children:[a.jsx(rs,{asChild:!0,children:a.jsxs("div",{ref:te,className:"button-container relative inline-block",children:[w&&O>0&&a.jsx("svg",{className:"progress-ring absolute inset-0 pointer-events-none",width:"100%",height:"100%",style:{transform:"rotate(-90deg)"},children:a.jsx("circle",{className:"progress-ring-circle stroke-primary/30",strokeWidth:"3",fill:"transparent",r:le,cx:"50%",cy:"50%",style:{strokeDasharray:me,strokeDashoffset:ae,transition:"stroke-dashoffset 16ms linear"}})}),ge,j&&!o&&a.jsxs(nt,{open:C,onOpenChange:ce=>{N(ce),ce||S(!1)},children:[a.jsx(ut,{asChild:!0,children:a.jsx("button",{ref:P,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200","aria-label":"Open configuration",children:a.jsx(qt,{className:"h-4 w-4"})})}),a.jsx(Qe,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ce,Ae)=>a.jsxs("button",{onClick:()=>se(ce),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ce.icon&&a.jsx("span",{className:"shrink-0",children:ce.icon}),a.jsx("span",{children:ce.label})]},ce.value??Ae))})})]}),j&&o&&a.jsx("button",{ref:P,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200",onClick:W,onTouchEnd:ce=>{ce.preventDefault(),W(ce)},"aria-label":"Open configuration",children:a.jsx(qt,{className:"h-4 w-4"})})]})}),a.jsx(Vt,{children:a.jsx("p",{children:k?"Try holding this button for advanced settings":Q})})]})}),o&&_&&a.jsxs(nt,{open:C,onOpenChange:ce=>{N(ce),ce||S(!1)},children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:"ghost",size:"icon",className:"static-gear h-8 w-8 shrink-0",disabled:f,"aria-label":"Configure",tabIndex:0,children:a.jsx(qt,{className:"h-4 w-4"})})}),a.jsx(Qe,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ce,Ae)=>a.jsxs("button",{onClick:()=>se(ce),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ce.icon&&a.jsx("span",{className:"shrink-0",children:ce.icon}),a.jsx("span",{children:ce.label})]},ce.value??Ae))})})]})]})});dr.displayName="ConfigurableButton";const Pf="â€‹";function Rf(s){return s.replace(new RegExp(Pf,"g"),"")}function Oo(s){const e=/^(\s*)/.exec(s);return e?e[1]:""}function ur(s){const e=/^(\s*)(\d+)\.\s*(.*)$/.exec(s);if(e)return{type:"numbered",indent:e[1],number:parseInt(e[2],10),fullMatch:e[0].replace(e[3],""),contentAfterPrefix:e[3]};const t=/^(\s*)-\s*(.*)$/.exec(s);return t?{type:"dash",indent:t[1],fullMatch:t[0].replace(t[2],""),contentAfterPrefix:t[2]}:{type:"none",indent:"",fullMatch:"",contentAfterPrefix:s}}function Df(s,e,t,n){if(s.trim()==="")return{type:"newline",textToInsert:`
`};const r=ur(s);if(r.type==="none")return{type:"continue",textToInsert:`
`+Oo(s)};if(!(r.contentAfterPrefix.trim().length>0)){const l=r.fullMatch.length;if(r.type==="numbered"){const d=_f(t,n,r.indent,r.number??1);return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l,textAfterCursor:d}}return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l}}if(Rf(e.split(`
`)[0]).trim().length>0)return{type:"continue",textToInsert:`
`+Oo(s)};if(r.type==="numbered"){const l=(r.number??0)+1,d=`
${r.indent}${l}. `,p=Of(t,n,r.indent,l);return{type:"continue",textToInsert:d,textAfterCursor:p}}return{type:"continue",textToInsert:`
${r.indent}- `}}function _f(s,e,t,n){const o=s.substring(e).split(`
`);let i=!1,c=n-1;const l=[];for(let d=0;d<o.length;d++){const p=o[d],u=ur(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...o.slice(d));break}else if(p.trim()===""&&d<o.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...o.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function Of(s,e,t,n){const o=s.substring(e).split(`
`);let i=!1,c=n;const l=[];for(let d=0;d<o.length;d++){const p=o[d],u=ur(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...o.slice(d));break}else if(p.trim()===""&&d<o.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...o.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function Dc(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=n===-1?s.length:n;return{lineStart:t,lineEnd:r,currentLine:s.substring(t,r),textBeforeLine:s.substring(0,t),textAfterLine:s.substring(r)}}function _c(s,e){if(e===0)return{type:"default"};const{lineStart:t,currentLine:n}=Dc(s,e),r=e-t,o=ur(n);if(o.type==="none")return{type:"default"};const i=o.fullMatch.length;if(r<=i&&r>0){const c=e-1;return{type:"delete-char",newText:s.substring(0,c)+s.substring(e),newCursorPos:c}}return{type:"default"}}const Lf={b:"**",i:"*","`":"`"},Mf={"*":"*",_:"*","`":"`"};function Oc(s,e,t){const{lineStart:n,textAfterLine:r}=Dc(s,e),o=s.substring(n,e),i=s.substring(e,s.indexOf(`
`,e)===-1?s.length:s.indexOf(`
`,e)),c=Df(o,i+r,s,e);if(c.type==="remove-prefix"){const l=c.charsToRemoveBeforeCursor??0,d=e-l;return{selectionStart:d,selectionEnd:e,textToInsert:c.textToInsert,newCursorPosition:d+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}}return c.type==="continue"?{selectionStart:e,selectionEnd:t,textToInsert:c.textToInsert,newCursorPosition:e+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}:{selectionStart:e,selectionEnd:t,textToInsert:`
`,newCursorPosition:e+1}}function Lc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r="  ",o=e+2;return{selectionStart:n,selectionEnd:n,textToInsert:r,newCursorPosition:o}}function Mc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r=s.indexOf(`
`,e),o=r===-1?s.length:r,i=s.substring(n,o);let c=0;for(let d=0;d<Math.min(2,i.length)&&i[d]===" ";d++)c++;if(c===0)return{selectionStart:e,selectionEnd:t,textToInsert:"",newCursorPosition:e};const l=Math.max(n,e-c);return{selectionStart:n,selectionEnd:n+c,textToInsert:"",newCursorPosition:l}}function Lo(s,e,t,n){const r=s.substring(e,t),o=`${n}${r}${n}`;return{selectionStart:e,selectionEnd:t,textToInsert:o,newCursorPosition:e+o.length}}function Ff(s){return Lf[s.toLowerCase()]}function $f(s){return Mf[s]}function Uf(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=s.substring(t,n===-1?s.length:n),o=r.trim();if(!o.startsWith("|")||!o.endsWith("|"))return null;const i=o.split("|").slice(1,-1);if(i.length===0||i.every(u=>/^\s*:?-+:?\s*$/.test(u)))return null;const l=r.indexOf("|"),d=e-t;let p=l+1;for(let u=0;u<i.length;u++){const f=i[u],m=p+f.length;if(d>=p&&d<=m){const g=f.trim(),x=f.length-f.trimStart().length,v=d-p;if(g.length===0)if(u>0){const b=i[u-1],y=p-1-b.length+b.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(v===x&&x>0)if(u>0){const b=i[u-1],y=p-1-b.length+b.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(v>0&&v<x)if(u>0){const b=i[u-1],y=p-1-b.length+b.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(v===0)if(u>0){const b=i[u-1],y=p-1-b.length+b.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(x===0&&v>=1&&g.length>=1){const b=s[e],w=g[v],y=v>=g.length;if(w!==void 0&&b===w||y)if(u>0){const S=i[u-1],N=p-1-S.length+S.trimEnd().length;return{newText:s,newCursorPos:t+N}}else return{newText:s,newCursorPos:e}}break}p=m+1}return null}function Bf(s,e){if(s[e-1]!==`
`)return null;const t=s.substring(0,e-1),n=t.lastIndexOf(`
`)+1,o=t.substring(n).trimEnd();if(!o.endsWith("|")||!o.includes("|")||o.split("|").slice(1,-1).every(b=>/^\s*:?-+:?\s*$/.test(b)))return null;const l=s.substring(e),d=l.indexOf(`
`),p=d===-1?l:l.substring(0,d),u=d===-1?"":l.substring(d),f=n+o.lastIndexOf("|");let m=s.substring(0,f);m.match(/\s+$/)&&(m=m.trimEnd());const x=m+p+" |"+u,v=m.length;return{newText:x,newCursorPos:v}}function Wf(s,e,t){if(e!==t||e===0)return null;const n=Bf(s,e);if(n)return{selectionStart:0,selectionEnd:s.length,textToInsert:n.newText,newCursorPosition:n.newCursorPos};const r=Uf(s,e);if(r)return{selectionStart:0,selectionEnd:s.length,textToInsert:r.newText,newCursorPosition:r.newCursorPos};const o=_c(s,e);return o.type==="delete-char"&&o.newText!==void 0?{selectionStart:0,selectionEnd:s.length,textToInsert:o.newText,newCursorPosition:o.newCursorPos??e-1}:{selectionStart:e-1,selectionEnd:e,textToInsert:"",newCursorPosition:e-1}}function zf(s){return["b","i","`"].includes(s.toLowerCase())}const Fc=h.forwardRef(({value:s,defaultValue:e,onChange:t,placeholder:n,onClick:r,onMouseDown:o,onMouseUp:i,onPaste:c,onKeyDown:l,onKeyUp:d,onBlur:p,rows:u=4,className:f="",readOnly:m=!1,disabled:g=!1,...x},v)=>{const b=w=>{if(l==null||l(w),w.defaultPrevented)return;const y=w.currentTarget,{selectionStart:j,selectionEnd:S}=y,C=y.value;if(w.key==="Enter"){w.preventDefault();const N=Oc(C,j,S);if(y.focus(),y.setSelectionRange(N.selectionStart,N.selectionEnd),N.replaceTextAfterCursor!==void 0){const R=C.substring(0,N.selectionStart)+N.textToInsert+N.replaceTextAfterCursor;y.value=R,y.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:y,currentTarget:y})}else if(N.selectionStart!==N.selectionEnd&&N.textToInsert===""){const O=C.substring(0,N.selectionStart)+C.substring(N.selectionEnd);y.value=O,y.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:y,currentTarget:y})}else{if(!document.execCommand("insertText",!1,N.textToInsert)&&t){const R=C.substring(0,N.selectionStart)+N.textToInsert+C.substring(N.selectionEnd);y.value=R,t({target:y,currentTarget:y})}y.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}}if(w.key==="Backspace"){const N=_c(C,j);if(N.type==="delete-char"&&N.newText!==void 0&&N.newCursorPos!==void 0){w.preventDefault(),y.value=N.newText,y.setSelectionRange(N.newCursorPos,N.newCursorPos),t&&t({target:y,currentTarget:y});return}}if(w.key==="Tab"){w.preventDefault();const N=w.shiftKey?Mc(C,j,S):Lc(C,j);if(y.focus(),y.setSelectionRange(N.selectionStart,N.selectionEnd),!document.execCommand("insertText",!1,N.textToInsert)&&t){const R=C.substring(0,N.selectionStart)+N.textToInsert+C.substring(N.selectionEnd);y.value=R,t({target:y,currentTarget:y})}y.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}};return a.jsx("textarea",{ref:v,value:s,defaultValue:e,onChange:t,onKeyDown:b,autoCorrect:"off",onKeyUp:d,placeholder:n,onClick:r,onMouseDown:o,onMouseUp:i,onPaste:c,onBlur:p,rows:u,className:B(Qp.textarea,f),readOnly:m,disabled:g,"data-test":x["data-test"],...x})});Fc.displayName="RichTextarea";const hn=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("rounded-xl border bg-card text-card-foreground shadow",s),...e}));hn.displayName="Card";const La=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("flex flex-col space-y-1.5 p-6",s),...e}));La.displayName="CardHeader";const Ma=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("font-semibold leading-none tracking-tight",s),...e}));Ma.displayName="CardTitle";const Hf=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("text-sm text-muted-foreground",s),...e}));Hf.displayName="CardDescription";const fn=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("p-6 pt-0",s),...e}));fn.displayName="CardContent";const Gf=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("flex items-center p-6 pt-0",s),...e}));Gf.displayName="CardFooter";const qf=Ou,Vf=Lu,nC=Fu,Kf=h.forwardRef(({className:s,inset:e,children:t,...n},r)=>a.jsxs(zi,{ref:r,className:B("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",s),...n,children:[t,a.jsx(Ft,{className:"ml-auto"})]}));Kf.displayName=zi.displayName;const Jf=h.forwardRef(({className:s,...e},t)=>a.jsx(Hi,{ref:t,className:B("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...e}));Jf.displayName=Hi.displayName;const $c=h.forwardRef(({className:s,sideOffset:e=4,...t},n)=>a.jsx(Mu,{children:a.jsx(Mi,{ref:n,sideOffset:e,className:B("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...t})}));$c.displayName=Mi.displayName;const Uc=h.forwardRef(({className:s,inset:e,...t},n)=>a.jsx(Fi,{ref:n,className:B("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",s),...t}));Uc.displayName=Fi.displayName;const Yf=h.forwardRef(({className:s,children:e,checked:t,...n},r)=>a.jsxs($i,{ref:r,className:B("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),checked:t,...n,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(Ui,{children:a.jsx(ct,{className:"h-4 w-4"})})}),e]}));Yf.displayName=$i.displayName;const Xf=h.forwardRef(({className:s,children:e,...t},n)=>a.jsxs(Gi,{ref:n,className:B("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(Ui,{children:a.jsx(Ys,{className:"h-2 w-2 fill-current"})})}),e]}));Xf.displayName=Gi.displayName;const Qf=h.forwardRef(({className:s,inset:e,...t},n)=>a.jsx(Bi,{ref:n,className:B("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",s),...t}));Qf.displayName=Bi.displayName;const Zf=h.forwardRef(({className:s,...e},t)=>a.jsx(Wi,{ref:t,className:B("-mx-1 my-1 h-px bg-muted",s),...e}));Zf.displayName=Wi.displayName;function em({onClick:s,label:e,icon:t,variant:n="default",size:r="sm",compact:o=!1,options:i=[],showDropdown:c=!0,className:l="",disabled:d=!1,contentStyle:p}){const u=c&&i.length>0,f="w-3 h-3",m=o?"w-2 h-2":"w-3 h-3";return a.jsxs("div",{className:B("split-button-group inline-flex",l),"data-test":"split-button-container",children:[a.jsxs(ue,{onClick:s,variant:n,size:r,disabled:d,className:B(o&&"h-5 px-1 min-w-0",u&&"rounded-r-none border-r-0"),"data-test":"split-button-main",children:[t&&a.jsx(t,{className:B(f,e&&"mr-1"),"data-test":"split-button-icon"}),e&&a.jsx("span",{className:o?"text-xs":"",children:e})]}),u&&a.jsxs(qf,{children:[a.jsx(Vf,{asChild:!0,children:a.jsx(ue,{variant:n,size:r,disabled:d,className:B("rounded-l-none",o?"h-5 px-0.5 min-w-0":"px-1"),"data-test":"split-button-dropdown-trigger",children:a.jsx(wt,{className:m,"data-test":"split-button-dropdown-icon"})})}),a.jsx($c,{align:"end",style:p,"data-test":"split-button-dropdown-menu",children:i.map((g,x)=>a.jsx(Uc,{onClick:g.onClick,className:"text-xs","data-test":"split-button-dropdown-option",children:g.label},x))})]})]})}async function Mo(s,e){try{e==null||e.info(`Converting ${s.type} (${s.size} bytes) to WAV`);const t=new(window.AudioContext||window.webkitAudioContext),n=await s.arrayBuffer(),r=await t.decodeAudioData(n);e==null||e.debug(`Decoded: ${r.duration}s, ${r.sampleRate}Hz, ${r.numberOfChannels}ch`);const o=r.numberOfChannels,i=r.sampleRate,c=r.length,l=new Float32Array(c*o);for(let u=0;u<o;u++){const f=r.getChannelData(u);for(let m=0;m<c;m++)l[m*o+u]=f[m]}const d=tm(l,i,o),p=new Blob([d],{type:"audio/wav"});if(!p||p.size===0)throw new Error("Failed to create valid WAV blob");return e==null||e.info(`Conversion complete: ${p.size} bytes`),p}catch(t){throw e==null||e.error(`Audio conversion failed: ${t}`),t}}function tm(s,e,t){const n=new ArrayBuffer(44+s.length*2),r=new DataView(n),o=(c,l)=>{for(let d=0;d<l.length;d++)r.setUint8(c+d,l.charCodeAt(d))};o(0,"RIFF"),r.setUint32(4,36+s.length*2,!0),o(8,"WAVE"),o(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,e,!0),r.setUint32(28,e*t*2,!0),r.setUint16(32,t*2,!0),r.setUint16(34,16,!0),o(36,"data"),r.setUint32(40,s.length*2,!0);let i=44;return s.forEach(c=>{const l=Math.max(-1,Math.min(1,c));r.setInt16(i,l*32767,!0),i+=2}),n}function sm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map((i,c)=>c===0?i.toLowerCase():i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function nm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function rm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.toLowerCase()).join("_")+t}function rC(s,e){switch(e){case"camel":return sm(s);case"pascal":return nm(s);case"snake":return rm(s);default:return s}}function Fo(s){return s.endsWith("...")?s.slice(0,-3).trim():s}function am(s){return s.trim().endsWith(".")?s.slice(0,-1).trim():s}let om="transcriptions";const $o=["ggml-large-v3","ggml-large-v3-q5_0","ggml-large-v3-turbo","ggml-distil-large-v3","distil-large-v3.5"];let im="ggml-distil-large-v3";const Bc={language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:im},cm=["CÃ¡c báº¡n","CÃ¡c báº¡n nhá»› Ä‘Äƒng kÃ½ kÃªnh Ä‘á»ƒ á»§ng há»™ kÃªnh cá»§a mÃ¬nh nhÃ©! Háº¹n gáº·p láº¡i cÃ¡c báº¡n trong nhá»¯ng video tiáº¿p theo!","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi, quÃ½ vá»‹","Hi, quÃ½ vá»‹. Xin chÃ o táº¥t cáº£ cÃ¡c báº¡n","HÃ£y subscribe cho kÃªnh","HÃ£y subscribe cho kÃªnh Ghiá»n MÃ¬ GÃµ Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","HÃ£y subscribe cho kÃªnh La La School Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","lalaschool","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Cáº¢M Æ N CÃC Báº N ÄÃƒ THEO DÃ•I VÃ€ ÄÄ‚NG KÃ KÃŠNH NHÃ‰!"];class mn extends Error{constructor(e,t,n,r){super(e),this.code=t,this.statusCode=n,this.detail=r,this.name="PythonTranscribeApiError"}}class lm extends mn{constructor(e){super(e??"Bad Request - invalid file format or missing file","PTApi_BAD_REQUEST",400,e),this.name="PTApiBadRequestError"}}class dm extends mn{constructor(e){super(e??"Payload Too Large - file exceeds size limit","PTApi_PAYLOAD_TOO_LARGE",413,e),this.name="PTApiPayloadTooLargeError"}}class um extends mn{constructor(e){super(e??"Internal Server Error - transcription service error","PTApi_INTERNAL_SERVER_ERROR",500,e),this.name="PTApiInternalServerError"}}class pm extends mn{constructor(e,t){super(t??`HTTP error! status: ${e}`,"PTApi_HTTP_ERROR",e,t),this.name="PTApiHttpError"}}class Wc extends mn{constructor(){super("Transcription contains denied phrases.","PTApi_DENIED_PHRASES"),this.name="PTApiDeniedPhrasesError"}}const hm="PythonTranscribeApiService";class fm{constructor(){ee(this,"baseUrl");this.baseUrl="http://192.168.2.70:9876"}async transcribeAudio(e,t={}){t={...Bc,...t},Re.info(`ðŸ”¤ Transcription request payload: ${JSON.stringify({file:e.name,size:`${(e.size/1024).toFixed(1)}KB`,...t})}`,hm);const n=new FormData;t.language!==void 0&&n.append("language",t.language),t.translate!==void 0&&n.append("translate",t.translate.toString()),t.no_timestamps!==void 0&&n.append("no_timestamps",t.no_timestamps.toString()),t.no_prints!==void 0&&n.append("no_prints",t.no_prints.toString()),t.auto_detect_language!==void 0&&n.append("auto_detect_language",t.auto_detect_language.toString()),t.model!==void 0&&n.append("model",t.model),n.append("file",e);try{const r=await fetch(`${this.baseUrl}/${om}`,{method:"POST",body:n});if(!r.ok){const i=await r.json();switch(r.status){case 400:throw new lm(i.detail);case 413:throw new dm(i.detail);case 500:throw new um(i.detail);default:throw new pm(r.status,i.detail)}}const o=await r.json();if(o.transcription=am(o.transcription),cm.some(i=>o.transcription.toLowerCase().includes(i.toLowerCase())))throw new Wc;return o}catch(r){throw r}}setBaseUrl(e){this.baseUrl=e}}const zc=new fm,vn={language:"auto",translate:!1,no_timestamps:!0,auto_detect_language:!0,word_level_timestamps:!1,split:!1},Wn={DEFAULT:{silenceThreshold:-20,minSilenceDuration:40,holdTime:100,padding:-60,waveformSamples:1e3},TIGHT:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3},LOOSE:{silenceThreshold:-30,minSilenceDuration:100,holdTime:200,padding:0,waveformSamples:1e3},WORD_STREAMING:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3}};class mm{constructor(e={}){ee(this,"defaultConfig");const t=Wn.DEFAULT;this.defaultConfig={silenceThreshold:e.silenceThreshold??t.silenceThreshold,minSilenceDuration:e.minSilenceDuration??t.minSilenceDuration,holdTime:e.holdTime??t.holdTime,padding:e.padding??t.padding,waveformSamples:e.waveformSamples??t.waveformSamples??1e3}}async analyzeAudio(e,t={}){const n={silenceThreshold:t.silenceThreshold??this.defaultConfig.silenceThreshold,minSilenceDuration:t.minSilenceDuration??this.defaultConfig.minSilenceDuration,holdTime:t.holdTime??this.defaultConfig.holdTime,padding:t.padding??this.defaultConfig.padding,waveformSamples:t.waveformSamples??this.defaultConfig.waveformSamples},r=this._generateWaveform(e,n.waveformSamples),o=this._normalize(r),i=this._toDbfs(o),c=this._detectActiveRegions(i,e.duration,n.silenceThreshold),l=this._mergeCloseRegions(c,n.holdTime),d=this._calculateSilences(l,e.duration*1e3),p=this._filterByDuration(d,n.minSilenceDuration),u=this._applySilencePadding(p,e.duration*1e3,n.padding);return this._getActiveRegions(u,e.duration)}_generateWaveform(e,t){const n=e.numberOfChannels,r=e.length,o=new Float32Array(r);for(let l=0;l<r;l++){let d=0;for(let p=0;p<n;p++)d+=e.getChannelData(p)[l];o[l]=d/n}const i=Math.max(1,Math.floor(r/t)),c=[];for(let l=0;l<t;l++){const d=l*i,p=Math.min(d+i,r);if(d<r&&p>d){let u=0;for(let m=d;m<p;m++)u+=Math.abs(o[m])**2;const f=Math.sqrt(u/(p-d));c.push(f)}else c.push(0)}return c}_normalize(e){const t=e.map(o=>isNaN(o)||!isFinite(o)?0:o),n=Math.max(...t),r=n>0?n:1;return t.map(o=>o/r)}_toDbfs(e){return e.map(n=>20*Math.log10(n+1e-10))}_detectActiveRegions(e,t,n){const r=e.map(l=>l>n),o=[];let i=!1,c=0;for(let l=0;l<r.length;l++)if(r[l]&&!i)c=l,i=!0;else if(!r[l]&&i){const d=l,p=c/e.length*t*1e3,u=d/e.length*t*1e3;o.push([p,u]),i=!1}if(i){const l=t*1e3,d=c/e.length*t*1e3;o.push([d,l])}return o}_mergeCloseRegions(e,t){if(e.length===0)return[];const n=[...e].sort((o,i)=>o[0]-i[0]),r=[n[0]];for(let o=1;o<n.length;o++){const[i,c]=n[o],l=r.length-1,[d,p]=r[l];i-p<=t?r[l]=[d,c]:r.push([i,c])}return r}_calculateSilences(e,t){const n=[];if(e.length===0)return[[0,t]];e[0][0]>0&&n.push([0,e[0][0]]);for(let o=0;o<e.length-1;o++){const i=e[o][1],c=e[o+1][0];c>i&&n.push([i,c])}const r=e[e.length-1][1];return r<t&&n.push([r,t]),n}_filterByDuration(e,t){return e.filter(([n,r])=>r-n>=t)}_applySilencePadding(e,t,n){if(n===0||e.length===0)return e;const r=[];for(let o=0;o<e.length;o++){const[i,c]=e[o];if(i===0){const d=Math.min(t,c+n);d>0&&r.push([0,d])}else if(o===e.length-1&&c===t){const l=Math.max(0,i-n),d=t;d>l&&r.push([l,d])}else{const l=Math.max(0,i-n),d=Math.min(t,c+n);d>l&&r.push([l,d])}}return r}_getActiveRegions(e,t){const n=[];if(e.length===0)return[[0,t]];const r=e.map(([i,c])=>[i/1e3,c/1e3]);r[0][0]>0&&n.push([0,r[0][0]]);for(let i=0;i<r.length-1;i++){const c=r[i][1],l=r[i+1][0];l>c&&n.push([c,l])}const o=r[r.length-1][1];return o<t&&n.push([o,t]),n}}class Hc{constructor(e={}){ee(this,"detector");this.detector=new mm(e)}async chunkFile(e){const t=await e.arrayBuffer(),r=await new AudioContext().decodeAudioData(t);return this.chunkAudio(r)}async chunkAudio(e,t){return(await this.detector.analyzeAudio(e,t)).map((o,i)=>{const[c,l]=o,d=this._extractChunk(e,c,l);return{blob:this._audioBufferToWav(d),startTime:c,endTime:l,duration:l-c,index:i+1}})}_extractChunk(e,t,n){const r=e.sampleRate,o=Math.floor(t*r),c=Math.floor(n*r)-o,d=new AudioContext().createBuffer(e.numberOfChannels,c,r);for(let p=0;p<e.numberOfChannels;p++){const u=e.getChannelData(p),f=d.getChannelData(p);for(let m=0;m<c;m++)f[m]=u[o+m]}return d}_audioBufferToWav(e){const t=e.numberOfChannels,n=e.sampleRate,r=1,o=16,i=o/8,c=t*i,l=n*c,d=e.length*c,p=new ArrayBuffer(44+d),u=new DataView(p),f=(x,v)=>{for(let b=0;b<v.length;b++)u.setUint8(x+b,v.charCodeAt(b))};f(0,"RIFF"),u.setUint32(4,36+d,!0),f(8,"WAVE"),f(12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,r,!0),u.setUint16(22,t,!0),u.setUint32(24,n,!0),u.setUint32(28,l,!0),u.setUint16(32,c,!0),u.setUint16(34,o,!0),f(36,"data"),u.setUint32(40,d,!0);const m=[];for(let x=0;x<t;x++)m.push(e.getChannelData(x));let g=44;for(let x=0;x<e.length;x++)for(let v=0;v<t;v++){const b=Math.max(-1,Math.min(1,m[v][x])),w=b<0?b*32768:b*32767;u.setInt16(g,w,!0),g+=2}return new Blob([p],{type:"audio/wav"})}async getActiveRegions(e,t){return this.detector.analyzeAudio(e,t)}}const He="WebSocketTranscriptionService";class gm{constructor(e){ee(this,"ws",null);ee(this,"wsUrl");ee(this,"eventHandlers",{});ee(this,"isConnected",!1);ee(this,"reconnectAttempts",0);ee(this,"maxReconnectAttempts",3);ee(this,"reconnectDelay",1e3);this.wsUrl=e??"ws://192.168.2.70:9876/ws/transcribe"??"ws://localhost:9876/ws/transcribe"}setEventHandlers(e){this.eventHandlers=e}async connect(){return new Promise((e,t)=>{try{Re.info(`Connecting to WebSocket: ${this.wsUrl}`,He),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var n,r;Re.info("WebSocket connection opened",He),this.isConnected=!0,this.reconnectAttempts=0,(r=(n=this.eventHandlers).onConnectionOpen)==null||r.call(n),e()},this.ws.onmessage=n=>{this.handleMessage(n)},this.ws.onerror=n=>{var r,o;Re.error(`WebSocket error: ${n}`,He),(o=(r=this.eventHandlers).onConnectionError)==null||o.call(r,n),t(n)},this.ws.onclose=n=>{var r,o;Re.info(`WebSocket closed: code=${n.code}, reason=${n.reason}`,He),this.isConnected=!1,(o=(r=this.eventHandlers).onConnectionClose)==null||o.call(r,n.code,n.reason),this.reconnectAttempts<this.maxReconnectAttempts&&n.code!==1e3&&(this.reconnectAttempts++,Re.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,He),setTimeout(()=>{this.connect().catch(i=>{Re.error(`Reconnection failed: ${i}`,He)})},this.reconnectDelay))}}catch(n){Re.error(`Failed to create WebSocket connection: ${n}`,He),t(n)}})}handleMessage(e){var t,n,r,o,i,c,l,d,p,u;try{const f=JSON.parse(e.data);switch(f.type){case"progress":Re.info(`Progress: ${f.data.percentage}% - ${f.data.message}`,He),(n=(t=this.eventHandlers).onProgress)==null||n.call(t,f.data);break;case"word":Re.info(`Word: "${f.data.word}" [${f.data.start_time}s - ${f.data.end_time}s]`,He),(o=(r=this.eventHandlers).onWord)==null||o.call(r,f.data);break;case"segment":Re.info(`Segment ${f.data.segment}: "${f.data.transcription}"`,He),(c=(i=this.eventHandlers).onSegment)==null||c.call(i,f.data);break;case"complete":Re.info("Transcription complete",He),(d=(l=this.eventHandlers).onComplete)==null||d.call(l,f.data);break;case"error":Re.error(`Server error: ${f.data.message} (code: ${f.data.code})`,He),(u=(p=this.eventHandlers).onError)==null||u.call(p,f.data);break;default:Re.error(`Unknown message type: ${f.type}`,He)}}catch(f){Re.error(`Failed to parse message: ${f}`,He)}}async sendConfig(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"config",data:e};Re.info(`Sending config: ${JSON.stringify(e)}`,He),this.ws.send(JSON.stringify(t))}async sendAudioChunk(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"audio_chunk",data:{chunk:e}};Re.info(`Sending audio chunk (${e.length} chars)`,He),this.ws.send(JSON.stringify(t))}async sendAudioChunks(e){for(const t of e)await this.sendAudioChunk(t)}async startTranscription(){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const e={type:"start",data:{}};Re.info("Starting transcription",He),this.ws.send(JSON.stringify(e))}async transcribeAudioFile(e,t=vn){this.isConnected||await this.connect(),await this.sendConfig(t);const n=await e.arrayBuffer(),r=new Uint8Array(n);let o="";const i=r.byteLength;for(let l=0;l<i;l++)o+=String.fromCharCode(r[l]);const c=btoa(o);await this.sendAudioChunk(c),await this.startTranscription()}async transcribeAudioBlob(e,t=vn){const n=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFile(n,t)}async transcribeAudioFileWithChunking(e,t={...vn,word_level_timestamps:!0,split:!1},n=Wn.WORD_STREAMING){this.isConnected||await this.connect(),Re.info("Starting client-side silence-based chunking",He);const o=await new Hc(n).chunkFile(e);Re.info(`Audio split into ${o.length} chunks (client-side)`,He);for(let i=0;i<o.length;i++){const c=o[i];await this._transcribeChunk(c,i+1,o.length,t)}Re.info("All chunks processed",He)}async _transcribeChunk(e,t,n,r){return new Promise((o,i)=>{Re.info(`Processing chunk ${t}/${n} (${e.startTime.toFixed(2)}s - ${e.endTime.toFixed(2)}s)`,He);const c=this.eventHandlers.onComplete,l=this.eventHandlers.onError;this.eventHandlers.onComplete=d=>{if(this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,c){const p={...d,metadata:{...d.metadata,chunk_index:t,chunk_start_time:e.startTime,chunk_end_time:e.endTime}};c(p)}Re.info(`Chunk ${t}/${n} transcription complete`,He),o()},this.eventHandlers.onError=d=>{this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,l&&l(d),Re.error(`Chunk ${t}/${n} transcription failed: ${d.message}`,He),i(new Error(d.message))},this._sendChunkTranscriptionRequest(e,r).catch(i)})}async _sendChunkTranscriptionRequest(e,t){const n={...t,split:!1};await this.sendConfig(n);const r=await e.blob.arrayBuffer(),o=new Uint8Array(r);let i="";const c=o.byteLength;for(let d=0;d<c;d++)i+=String.fromCharCode(o[d]);const l=btoa(i);await this.sendAudioChunk(l),await this.startTranscription()}async transcribeAudioBlobWithChunking(e,t={...vn,word_level_timestamps:!0,split:!1},n=Wn.WORD_STREAMING){const r=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFileWithChunking(r,t,n)}disconnect(){this.ws&&(Re.info("Disconnecting WebSocket",He),this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}setUrl(e){if(this.isConnected)throw Re.error("Cannot update URL while connected. Disconnect first.",He),new Error("Cannot update URL while connected");this.wsUrl=e,Re.info(`WebSocket URL updated to: ${this.wsUrl}`,He)}setMaxReconnectAttempts(e){this.maxReconnectAttempts=e}setReconnectDelay(e){this.reconnectDelay=e}}const xm=(s={})=>{const{onChunkCreated:e,onChunkUpdated:t,onChunkDeleted:n,onChunksLoaded:r,onError:o,sessionName:i="recording-session",enableAutoPersist:c=!0,enableAutoTranscription:l=!0,minChunkDuration:d=1e3,loadPersistedChunks:p=!0,skipLastSessionChunk:u=!1,transcribeOptions:f,useWebSocket:m=!1,onWordReceived:g,onTranscriptionProgress:x}=s,[v,b]=h.useState(!1),[w,y]=h.useState(!1),[j,S]=h.useState([]),[C,N]=h.useState(0),[O,R]=h.useState(null),k=h.useRef([]);h.useEffect(()=>{k.current=j},[j]);const A=h.useRef(f);h.useEffect(()=>{A.current=f},[f]);const L=h.useRef(null),M=h.useRef(null),I=h.useRef([]),z=h.useRef([]),$=h.useRef(null),q=h.useRef(null),P=h.useRef(null),te=h.useRef(0),E=h.useRef(!1),_=h.useRef(null),F=h.useRef(null),V=h.useCallback(U=>{const re=new Date().toISOString().slice(0,19).replace(/[:]/g,"-");return`${i}-chunk-${U.toString().padStart(3,"0")}-${re}`},[i]),Y=h.useCallback(async()=>{if(p)try{const U=await bt.loadChunksBySession(i);if(U.length===0)return;S(U);const re=Math.max(...U.map(G=>G.chunkNumber),0);N(re),r==null||r(U)}catch(U){o==null||o(`Failed to load persisted chunks: ${U instanceof Error?U.message:"Unknown error"}`)}},[i,p,r]);h.useEffect(()=>(m&&!_.current&&(_.current=new gm,_.current.setEventHandlers({onWord:U=>{const re=F.current;re&&(g==null||g(U,re))},onProgress:U=>{const re=F.current;re&&(x==null||x(U,re))},onComplete:U=>{const re=F.current;if(!re)return;const G=Fo(U.transcription);S(oe=>{const de=oe.find(fe=>fe.id===re);if(!de)return oe;const pe={...de,transcription:G,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(pe)),oe.map(fe=>fe.id===re?pe:fe)}),c&&bt.updateChunkTranscription(re,G).catch(()=>{}),F.current=null},onError:U=>{const re=F.current;re&&(S(G=>{const oe=G.find(pe=>pe.id===re);if(!oe)return G;const de={...oe,transcriptionStatus:"failed",transcriptionError:U.message};return queueMicrotask(()=>t==null?void 0:t(de)),G.map(pe=>pe.id===re?de:pe)}),c&&bt.updateChunkTranscriptionStatus(re,"failed",U.message).catch(()=>{})),o==null||o(U.message),F.current=null},onConnectionOpen:()=>{},onConnectionClose:()=>{},onConnectionError:()=>{o==null||o("WebSocket connection error")}})),()=>{_.current&&(_.current.disconnect(),_.current=null)}),[m,g,x,t,o,c]);const T=h.useCallback(async(U,re,G,oe)=>{const de=oe||A.current,pe=k.current.find(be=>be.id===U);if(!pe||pe.transcriptionStatus==="processing"||pe.transcriptionStatus==="completed"&&pe.transcription)return;const fe={...pe,transcriptionStatus:"processing"};if(S(be=>(queueMicrotask(()=>t==null?void 0:t(fe)),be.map(Pe=>Pe.id===U?fe:Pe))),c)try{await bt.updateChunkTranscriptionStatus(U,"processing")}catch{}if(m&&_.current){try{F.current=U,_.current.connected||await _.current.connect(),await _.current.transcribeAudioBlob(re,{language:(de==null?void 0:de.language)||"auto",word_level_timestamps:!0,no_timestamps:(de==null?void 0:de.no_timestamps)??!0,translate:(de==null?void 0:de.translate)??!1,auto_detect_language:(de==null?void 0:de.auto_detect_language)??!0})}catch(be){const Pe=be instanceof Error?be.message:"WebSocket transcription error";if(S(Ie=>{const K=Ie.find(X=>X.id===U);if(!K)return Ie;const D={...K,transcriptionStatus:"failed",transcriptionError:Pe};return queueMicrotask(()=>t==null?void 0:t(D)),Ie.map(X=>X.id===U?D:X)}),c)try{await bt.updateChunkTranscriptionStatus(U,"failed",Pe)}catch{}o==null||o(`WebSocket transcription failed for ${G}: ${Pe}`),F.current=null}return}try{const be=new File([re],`${G}.wav`,{type:"audio/wav"}),Pe=await zc.transcribeAudio(be,de),Ie=Fo(Pe.transcription);if(S(K=>{const D=K.find(we=>we.id===U);if(!D)return K;const X={...D,transcription:Ie,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(X)),K.map(we=>we.id===U?X:we)}),c)try{await bt.updateChunkTranscription(U,Ie)}catch{}}catch(be){if(be instanceof Wc){if(console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Skipping chunk due to denied phrases:",G),S(Ie=>Ie.filter(K=>K.id!==U)),c)try{await bt.deleteChunk(U)}catch(Ie){console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Failed to delete chunk from storage:",Ie)}n==null||n(U);return}const Pe=be instanceof Error?be.message:"Unknown transcription error";if(S(Ie=>{const K=Ie.find(X=>X.id===U);if(!K)return Ie;const D={...K,transcriptionStatus:"failed",transcriptionError:Pe};return queueMicrotask(()=>t==null?void 0:t(D)),Ie.map(X=>X.id===U?D:X)}),c)try{await bt.updateChunkTranscriptionStatus(U,"failed",Pe)}catch{}o==null||o(`Transcription failed for ${G}: ${Pe}`)}},[c,t,m]),W=h.useCallback(async()=>{try{const U=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return M.current=U,!0}catch(U){const re=U instanceof Error?U.message:"Failed to access microphone";return R(re),o==null||o(re),!1}},[o]),se=h.useCallback(async()=>{if(!(!L.current||w))try{const U=te.current+1,re={id:`segment-${crypto.randomUUID()}`,chunkNumber:U,startTime:new Date,name:V(U)};P.current=re,y(!0)}catch(U){const re=U instanceof Error?U.message:"Failed to start segment recording";R(re),o==null||o(re),y(!1)}},[w,V,o]),le=h.useCallback(async()=>{if(!(!L.current||!w||!P.current))try{const U=P.current;P.current=null,y(!1),L.current.requestData(),await new Promise(Pe=>setTimeout(Pe,50));const re=new Date,G=re.getTime()-U.startTime.getTime();if(G<d){z.current=[];return}const oe=L.current.mimeType||"audio/webm",de=[];$.current&&de.push($.current),de.push(...z.current);const pe=new Blob(de,{type:oe});let fe;try{fe=await Mo(pe)}catch{fe=pe}const be={...U,endTime:re,duration:G,blob:fe,size:fe.size,transcriptionStatus:l?"pending":void 0};if(S(Pe=>[...Pe,be]),k.current=[...k.current,be],te.current=U.chunkNumber,N(U.chunkNumber),z.current=[],c)try{await bt.saveChunk(be,i),e==null||e(be),l&&T(be.id,fe,be.name,A.current).catch(()=>{})}catch(Pe){const Ie=Pe instanceof Error?Pe.message:"Failed to save segment";R(Ie),o==null||o(Ie)}else e==null||e(be),l&&T(be.id,fe,be.name,A.current).catch(()=>{})}catch(U){const re=U instanceof Error?U.message:"Failed to stop segment";R(re),o==null||o(re),y(!1)}},[w,d,c,l,i,e,o,T]),me=h.useCallback(async()=>{if(!await W())return;const re=new Date().toISOString().slice(0,19).replace(/[:]/g,"-"),G={id:`session-${crypto.randomUUID()}`,chunkNumber:0,startTime:new Date,name:`${i}-session-${re}`};q.current=G,I.current=[],z.current=[],te.current=0,$.current=null,E.current=!1;const de=["audio/webm;codecs=opus","audio/webm;codecs=vorbis","audio/webm","audio/ogg;codecs=opus","audio/mp4;codecs=mp4a.40.2","audio/mp4"].find(fe=>MediaRecorder.isTypeSupported(fe))??"audio/webm",pe=new MediaRecorder(M.current,{mimeType:de});L.current=pe,pe.ondataavailable=fe=>{if(fe.data.size>0){if(!E.current){$.current=fe.data,E.current=!0,I.current.push(fe.data);return}I.current.push(fe.data),z.current.push(fe.data)}},pe.onstop=async()=>{if(!q.current)return;if(u){q.current=null;return}const fe=new Blob(I.current,{type:de}),be=new Date,Pe=be.getTime()-q.current.startTime.getTime();let Ie;try{Ie=await Mo(fe)}catch{Ie=fe}const K={...q.current,endTime:be,duration:Pe,blob:Ie,size:Ie.size,transcriptionStatus:l?"pending":void 0};if(S(D=>[...D,K]),k.current=[...k.current,K],c)try{await bt.saveChunk(K,i),e==null||e(K),l&&T(K.id,Ie,K.name,A.current).catch(()=>{})}catch(D){const X=D instanceof Error?D.message:"Failed to save session chunk";R(X),o==null||o(X)}else e==null||e(K);q.current=null},pe.onerror=()=>{R("Session recording failed"),o==null||o("Session recording failed")},pe.start(100),b(!0),R(null)},[W,i,c,l,u,e,o,T]),ae=h.useCallback(()=>{L.current&&L.current.state!=="inactive"&&L.current.stop(),b(!1),y(!1),M.current&&(M.current.getTracks().forEach(U=>{U.stop()}),M.current=null)},[]),H=h.useCallback(()=>{v&&ae(),S([]),N(0),R(null),P.current=null,q.current=null},[v,ae]),Q=h.useCallback(()=>{w&&(y(!1),P.current=null,z.current=[])},[w]),ge=h.useCallback(async U=>{if(S(re=>re.filter(G=>G.id!==U)),c)try{await bt.deleteChunk(U)}catch(re){o==null||o(`Failed to delete chunk from storage: ${re instanceof Error?re.message:"Unknown error"}`)}},[c]);h.useEffect(()=>{Y()},[]),h.useEffect(()=>()=>{M.current&&M.current.getTracks().forEach(U=>U.stop())},[]);const ce=h.useCallback(async()=>{if(!(!m||!_.current)){_.current.disconnect(),await new Promise(U=>setTimeout(U,100));try{await _.current.connect()}catch{o==null||o("Failed to reconnect WebSocket")}}},[m,o]),Ae={isRecording:v,isChunkRecording:w,chunks:j,currentChunkNumber:C,error:O},ke={startRecording:me,stopRecording:ae,resetRecording:H},ve=h.useCallback(async(U,re)=>{if(S(G=>{const oe=G.find(pe=>pe.id===U);if(!oe)return G;const de={...oe,transcription:re,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(de)),G.map(pe=>pe.id===U?de:pe)}),c)try{await bt.updateChunkTranscription(U,re)}catch{}},[c,t]);return{state:Ae,actions:ke,startChunk:se,stopChunk:le,discardCurrentChunk:Q,deleteChunk:ge,transcribeChunk:T,updateChunkTranscription:ve,reconnectWebSocket:ce}};function vm({config:s,isRecording:e,isChunkRecording:t,callbacks:n,cumulativeActiveTimeRef:r,peakAudioLevelRef:o}){const i=h.useRef(null),c=h.useRef(!1),l=h.useRef(null),d=h.useRef({vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold}),p=h.useRef({isRecording:e,isChunkRecording:t});h.useEffect(()=>{d.current={vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold},p.current={isRecording:e,isChunkRecording:t}},[s.vadSilenceTimeout,s.vadMaxChunkDuration,s.silenceDetectionConfig.minActiveDuration,s.silenceDetectionConfig.activationThreshold,e,t]);const u=h.useCallback(()=>{i.current=null,c.current=!1,l.current=null,o.current=0},[o]),f=h.useCallback(async()=>{i.current=Date.now(),c.current=!0,l.current=null,o.current=0,await n.startChunk()},[n,o]),m=h.useCallback(async w=>{w?await n.stopChunk():n.discardCurrentChunk(),u()},[n,u]),g=h.useCallback(async()=>{p.current.isChunkRecording?(c.current=!0,l.current=null):await f()},[f]),x=h.useCallback(async()=>{if(!p.current.isChunkRecording||!c.current)return;const w=Date.now();if(l.current===null){l.current=w;return}if(w-l.current>=d.current.vadSilenceTimeout){const C=r.current>=d.current.minActiveDuration,O=o.current>=d.current.activationThreshold;await m(C&&O)}},[m,r,o]),v=h.useCallback(async()=>{if(!p.current.isChunkRecording||!i.current)return;Date.now()-i.current>=d.current.vadMaxChunkDuration&&(await n.stopChunk(),c.current&&!p.current.isChunkRecording?await f():u())},[n,f,u]);return{processVADAudio:h.useCallback((w,y)=>{if(!p.current.isRecording)return;const j=!w,S=j&&y,C=j&&!p.current.isChunkRecording&&!c.current;(S||C)&&g(),w&&x(),v()},[g,x,v]),resetVADState:u}}const Fa={silenceThreshold:.47,minSilenceDuration:0,minActiveDuration:1500,activationThreshold:.67},Vs={enableAutoTranscription:!0,minChunkDuration:500,silenceDetectionConfig:Fa,autoStopOnSilence:!1,autoCreateChunks:!0,autoChunkCreationTime:1e3,skipLastSessionChunk:!0,transcribeOptions:Bc,chunkingMode:"time",vadMaxChunkDuration:1e4,vadSilenceTimeout:1500,useWebSocket:!1},An={default:{id:"custom-1759528805538",name:"Default (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:Fa.activationThreshold},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},eng:{id:"custom-1759528805538",name:"Eng (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},vi:{name:"VN",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},ws:{name:"WS",description:"WebSocket real-time streaming",config:{silenceDetectionConfig:{minActiveDuration:800,activationThreshold:.67},useWebSocket:!0,chunkingMode:"time",autoCreateChunks:!0,autoChunkCreationTime:1e3,minChunkDuration:500,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,model:"ggml-distil-large-v3"}}}},Gc="audio-panel-custom-presets";function qc(s,e){if(s===e)return!0;if(typeof s!="object"||typeof e!="object"||s===null||e===null)return!1;const t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!n.includes(r)||!qc(s[r],e[r]))return!1;return!0}function Vc(s){const e={};return Object.keys(s).forEach(t=>{qc(s[t],Vs[t])||(e[t]=s[t])}),e}function zn(s){return{...Vs,...s,silenceDetectionConfig:{...Vs.silenceDetectionConfig,...s.silenceDetectionConfig??{}},transcribeOptions:{...Vs.transcribeOptions,...s.transcribeOptions??{}}}}function gn(){try{const s=localStorage.getItem(Gc);return s?JSON.parse(s).map(t=>({...t,createdAt:new Date(t.createdAt)})):[]}catch(s){return console.error("Failed to load custom presets:",s),[]}}function $a(s){try{localStorage.setItem(Gc,JSON.stringify(s))}catch(e){console.error("Failed to save custom presets:",e)}}function bm(s,e,t){const n=Vc(t),r={id:`custom-${Date.now()}`,name:s,description:e,config:n,createdAt:new Date},o=gn();return o.push(r),$a(o),r}function wm(s,e){const t=gn(),n=t.findIndex(i=>i.id===s);if(n===-1)return console.error(`Preset with id ${s} not found`),null;const r=Vc(e),o={...t[n],config:r};return t[n]=o,$a(t),o}function ym(s){const t=gn().filter(n=>n.id!==s);$a(t)}function Sm(s={}){const e=h.useMemo(()=>({...Fa,...s}),[s]),[t,n]=ou.useState({isSilent:!0,currentLevel:0,silenceThreshold:e.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}),r=h.useCallback(c=>{const l=Math.max(...c),d=Date.now();n(p=>{const u=d-p.lastStateChange,f=l<=p.silenceThreshold;let m=p.isSilent,g=p.silenceDuration,x=p.activeDuration,v=p.lastStateChange;return f?(g+=u,x=0,!p.isSilent&&g>=e.minSilenceDuration&&(m=!0,v=d)):(x+=u,g=0,p.isSilent&&x>=e.minActiveDuration&&(m=!1,v=d)),{isSilent:m,currentLevel:l,silenceThreshold:p.silenceThreshold,silenceDuration:g,activeDuration:x,lastStateChange:v}})},[e.minSilenceDuration,e.minActiveDuration,t.lastStateChange]),o=h.useCallback(c=>{const l=Math.max(0,Math.min(1,c));n(d=>({...d,silenceThreshold:l}))},[]),i=h.useCallback(()=>{n(c=>({isSilent:!0,currentLevel:0,silenceThreshold:c.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}))},[]);return{state:t,processAudioData:r,updateThreshold:o,reset:i}}const Dt=h.forwardRef(({className:s,...e},t)=>a.jsxs(qi,{ref:t,className:B("relative flex w-full touch-none select-none items-center",s),...e,children:[a.jsx($u,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:a.jsx(Uu,{className:"absolute h-full bg-primary"})}),a.jsx(Bu,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));Dt.displayName=qi.displayName;const jm=({audioData:s,silenceState:e,onThresholdChange:t,hideSilenceControls:n=!1,duration:r=0,className:o=""})=>{const i=h.useCallback(d=>{t==null||t(d[0])},[t]),c=d=>{const p=d/1e3,u=Math.floor(p/60),f=Math.floor(p%60),m=Math.floor(p%1*10);return`${u}:${f.toString().padStart(2,"0")}.${m}`};return a.jsx("div",{className:`silence-detection-visualizer ${o}`,children:a.jsxs("div",{className:"visualization-container relative flex flex-col p-2 bg-muted/50 rounded-lg",style:{height:"64px"},children:[a.jsxs("div",{className:"top-controls flex justify-between items-center gap-2 mb-1 z-20",children:[a.jsx("div",{className:"time-display flex items-center",children:a.jsx("span",{className:"text-[9px] font-medium text-foreground",children:c(r)})}),a.jsxs("div",{className:"right-controls flex items-center gap-2",children:[a.jsxs("div",{className:"status-display flex items-center gap-1",children:[a.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${e.isSilent?"bg-gray-400":"bg-green-500 animate-pulse"}`}),a.jsx("span",{className:"text-[9px] font-medium",children:e.isSilent?"Silent":"Active"}),a.jsx("span",{className:"text-[9px] text-muted-foreground",children:`${(e.currentLevel*100).toFixed(0)}%`})]}),!n&&a.jsxs("div",{className:"threshold-control flex-1 flex items-center gap-1.5",children:[a.jsx("label",{className:"text-[9px] font-medium shrink-0",children:`T: ${(e.silenceThreshold*100).toFixed(0)}%`}),a.jsx(Dt,{min:0,max:1,step:.01,value:[e.silenceThreshold],onValueChange:i,className:"flex-1"})]})]})]}),a.jsxs("div",{className:"bars-container relative flex items-end justify-center flex-1",children:[a.jsx("div",{className:"threshold-line absolute left-0 right-0 border-t border-red-500 border-dashed z-10",style:{bottom:`${e.silenceThreshold*100}%`}}),a.jsx("div",{className:"visualization-bars flex items-end justify-center gap-0.5 h-full w-full max-w-2xl relative z-0",children:s.map((d,p)=>{const u=Math.max(d*100,2),f=d>e.silenceThreshold;return a.jsx("div",{className:"visualization-bar flex-1 max-w-2 rounded-t transition-all duration-75 ease-out",style:{height:`${u}%`,backgroundColor:f?`rgba(34, 197, 94, ${.3+d*.7})`:`rgba(156, 163, 175, ${.3+d*.7})`,minHeight:"2px"}},p)})})]})]})})};function Kc({transcribeOptions:s,useWebSocket:e,onTranscribeOptionsChange:t,onUseWebSocketChange:n}){return a.jsxs("div",{className:"transcription-options-section space-y-1 pt-2 border-t border-border",children:[a.jsx("h3",{className:"text-[9px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcription Options"}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"use-websocket",className:"text-[9px] font-semibold",children:"Use WebSocket Transcription"}),a.jsx(_t,{id:"use-websocket",checked:e,onCheckedChange:n,className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:e?"Real-time streaming with progress updates and word-by-word results":"Standard HTTP API with complete results"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Language"}),a.jsxs($t,{value:s.language??"auto",onValueChange:r=>t({...s,language:r}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Kt,{placeholder:"Select language"})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"auto",children:"Auto Detect"}),a.jsx(Oe,{value:"en",children:"English"}),a.jsx(Oe,{value:"vi",children:"Vietnamese"}),a.jsx(Oe,{value:"es",children:"Spanish"}),a.jsx(Oe,{value:"fr",children:"French"}),a.jsx(Oe,{value:"de",children:"German"}),a.jsx(Oe,{value:"pt",children:"Portuguese"}),a.jsx(Oe,{value:"ru",children:"Russian"}),a.jsx(Oe,{value:"ja",children:"Japanese"}),a.jsx(Oe,{value:"zh",children:"Chinese"}),a.jsx(Oe,{value:"ko",children:"Korean"}),a.jsx(Oe,{value:"it",children:"Italian"}),a.jsx(Oe,{value:"nl",children:"Dutch"})]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Transcription language"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Model"}),a.jsxs($t,{value:s.model??$o[0],onValueChange:r=>t({...s,model:r}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Kt,{placeholder:"Select model"})}),a.jsx(Tt,{children:$o.map(r=>a.jsx(Oe,{value:r,children:r},r))})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Whisper model"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"translate-english",className:"text-[9px] font-semibold",children:"Translate"}),a.jsx(_t,{id:"translate-english",checked:s.translate??!1,onCheckedChange:r=>t({...s,translate:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Translate to English"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-detect-lang",className:"text-[9px] font-semibold",children:"Auto-Detect"}),a.jsx(_t,{id:"auto-detect-lang",checked:s.auto_detect_language??!1,onCheckedChange:r=>t({...s,auto_detect_language:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto language detection"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"no-timestamps",className:"text-[9px] font-semibold",children:"No Timestamps"}),a.jsx(_t,{id:"no-timestamps",checked:s.no_timestamps!==!1,onCheckedChange:r=>t({...s,no_timestamps:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Remove timestamps"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"no-prints",className:"text-[9px] font-semibold",children:"Quiet Mode"}),a.jsx(_t,{id:"no-prints",checked:s.no_prints!==!1,onCheckedChange:r=>t({...s,no_prints:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Suppress verbose output"})]})]})]})}const bn="audio-panel-selected-preset";function Cm({config:s,onConfigChange:e}){const[t,n]=h.useState([]),[r,o]=h.useState(!1),[i,c]=h.useState(""),[l,d]=h.useState(!1),[p,u]=h.useState("");h.useEffect(()=>{const w=gn();n(w);let y=localStorage.getItem(bn);y||(y="default",localStorage.setItem(bn,y)),u(y)},[]);const f=w=>{u(w),localStorage.setItem(bn,w);const y=An[w];if(y){const S=zn(y.config);e(S);return}const j=t.find(S=>S.id===w);if(j){const S=zn(j.config);e(S)}},m=()=>{if(!i.trim()){alert("Please enter a preset name");return}const w=bm(i.trim(),"Custom configuration",s);n([...t,w]),c(""),o(!1)},g=()=>{c(""),o(!1)},x=w=>{const y=wm(w,s);y&&(n(t.map(j=>j.id===w?y:j)),d(!0))},v=w=>{ym(w),n(t.filter(y=>y.id!==w)),p===w&&(u(""),localStorage.removeItem(bn))},b=()=>{const w=An[p];if(w)return w.name;const y=t.find(j=>j.id===p);return(y==null?void 0:y.name)||""};return a.jsxs("div",{className:"config-view space-y-2 text-[10px]",children:[a.jsxs("div",{className:"preset-selector space-y-1",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Configuration Preset"}),!r&&a.jsx(ue,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>o(!0),title:"Save current configuration as preset",children:a.jsx(Nn,{className:"h-3 w-3"})})]}),r?a.jsxs("div",{className:"flex gap-1",children:[a.jsx(We,{placeholder:"Enter preset name...",value:i,onChange:w=>c(w.target.value),onKeyDown:w=>{w.key==="Enter"&&m(),w.key==="Escape"&&g()},className:"h-8 text-[9px] flex-1",autoFocus:!0}),a.jsx(ue,{onClick:m,size:"sm",className:"h-8 px-2",title:"Save preset",children:a.jsx(Nn,{className:"h-3 w-3"})}),a.jsx(ue,{onClick:g,size:"sm",variant:"ghost",className:"h-8 px-2",title:"Cancel",children:"âœ•"})]}):a.jsxs($t,{value:p,onValueChange:f,open:l,onOpenChange:d,children:[a.jsx(It,{className:"h-8 text-[9px]",children:a.jsx(Kt,{placeholder:"Select a preset...",children:p&&a.jsx("span",{className:"font-medium",children:b()})})}),a.jsxs(Tt,{children:[Object.entries(An).map(([w,y])=>a.jsxs(Oe,{value:w,children:[a.jsx("span",{className:"font-medium",children:y.name}),a.jsx("span",{className:"text-[8px] text-muted-foreground ml-2",children:y.description})]},w)),t.map(w=>a.jsx(Oe,{value:w.id,children:a.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[a.jsxs("div",{className:"flex flex-col items-start flex-1 min-w-0",children:[a.jsx("span",{className:"font-medium",children:w.name}),a.jsx("span",{className:"text-[8px] text-muted-foreground",children:w.description})]}),a.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[a.jsx(ue,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),x(w.id)},onClick:y=>{y.preventDefault(),y.stopPropagation()},title:"Update preset with current settings",children:a.jsx(Nn,{className:"h-3 w-3 text-blue-500"})}),a.jsx(ue,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),v(w.id)},onClick:y=>{y.preventDefault(),y.stopPropagation()},title:"Delete preset",children:a.jsx(Et,{className:"h-3 w-3 text-red-500"})})]})]})},w.id))]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:r?"Enter a name for the current configuration":"Quick apply preset configurations"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-transcription",className:"text-[9px] font-semibold",children:"Auto-Transcribe"}),a.jsx(_t,{id:"auto-transcription",checked:s.enableAutoTranscription,onCheckedChange:w=>e({enableAutoTranscription:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-transcribe chunks"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Chunk: ",s.minChunkDuration,"ms"]}),a.jsx(Dt,{min:500,max:5e3,step:500,value:[s.minChunkDuration],onValueChange:w=>e({minChunkDuration:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min chunk duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[a.jsx(Se,{className:"text-[9px] font-semibold",children:"Chunking Mode"}),a.jsxs($t,{value:s.chunkingMode,onValueChange:w=>e({chunkingMode:w}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Kt,{})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"time",children:"Time-based"}),a.jsx(Oe,{value:"vad",children:"Voice Activity Detection (VAD)"}),a.jsx(Oe,{value:"silence-based",children:"Silence-based Splitting"})]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:s.chunkingMode==="time"?"Fixed interval chunking for predictable real-time updates":s.chunkingMode==="vad"?"Speech-driven chunking for natural boundaries and better accuracy":"VAD recording with post-processing silence-based splits for precise segmentation"})]}),s.chunkingMode==="time"&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-create-chunks",className:"text-[9px] font-semibold",children:"Auto-Create"}),a.jsx(_t,{id:"auto-create-chunks",checked:s.autoCreateChunks,onCheckedChange:w=>e({autoCreateChunks:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-create chunks"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Auto-Time: ",s.autoChunkCreationTime,"ms"]}),a.jsx(Dt,{min:500,max:5e3,step:500,value:[s.autoChunkCreationTime],onValueChange:w=>e({autoChunkCreationTime:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-creation interval"})]})]}),(s.chunkingMode==="vad"||s.chunkingMode==="silence-based")&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Max Duration: ",s.vadMaxChunkDuration,"ms"]}),a.jsx(Dt,{min:3e3,max:3e4,step:1e3,value:[s.vadMaxChunkDuration],onValueChange:w=>e({vadMaxChunkDuration:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Max VAD chunk duration (safety ceiling)"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Silence Timeout: ",s.vadSilenceTimeout,"ms"]}),a.jsx(Dt,{min:500,max:5e3,step:100,value:[s.vadSilenceTimeout],onValueChange:w=>e({vadSilenceTimeout:w[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence duration to end chunk"})]})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"skip-last-chunk",className:"text-[9px] font-semibold",children:"Skip Last Chunk"}),a.jsx(_t,{id:"skip-last-chunk",checked:s.skipLastSessionChunk,onCheckedChange:w=>e({skipLastSessionChunk:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Skip last session chunk"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{htmlFor:"auto-stop-silence",className:"text-[9px] font-semibold",children:"Auto-Stop"}),a.jsx(_t,{id:"auto-stop-silence",checked:s.autoStopOnSilence,onCheckedChange:w=>e({autoStopOnSilence:w}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Stop on silence"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Silence: ",Math.round(s.silenceDetectionConfig.silenceThreshold*100),"%"]}),a.jsx(Dt,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.silenceThreshold],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,silenceThreshold:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence threshold"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Silent: ",s.silenceDetectionConfig.minSilenceDuration,"ms"]}),a.jsx(Dt,{min:100,max:5e3,step:100,value:[s.silenceDetectionConfig.minSilenceDuration],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minSilenceDuration:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min silence duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Active: ",s.silenceDetectionConfig.minActiveDuration,"ms"]}),a.jsx(Dt,{min:100,max:3e3,step:100,value:[s.silenceDetectionConfig.minActiveDuration],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minActiveDuration:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min active duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(Se,{className:"text-[9px] font-semibold",children:["Activation: ",Math.round(s.silenceDetectionConfig.activationThreshold*100),"%"]}),a.jsx(Dt,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.activationThreshold],onValueChange:w=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,activationThreshold:w[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Peak level threshold (filters body noise)"})]})]}),a.jsx(Kc,{transcribeOptions:s.transcribeOptions,useWebSocket:s.useWebSocket,onTranscribeOptionsChange:w=>e({transcribeOptions:w}),onUseWebSocketChange:w=>e({useWebSocket:w})})]})}function $s({audioBlob:s,isPlaying:e=!0,className:t="",height:n=80,barWidth:r=2,barGap:o=1,barColor:i="#94a3b8",progressColor:c="#3b82f6"}){const l=h.useRef(null),[d,p]=h.useState([]),[u,f]=h.useState(!1),[m,g]=h.useState({width:0,height:0});return h.useEffect(()=>{if(!s)return;let x=!1;return f(!0),(async()=>{try{const b=await s.arrayBuffer(),w=new AudioContext,y=await w.decodeAudioData(b);if(x){await w.close();return}const j=y.getChannelData(0),S=100,C=Math.floor(j.length/S),N=[];for(let A=0;A<S;A++){const L=C*A;let M=0;for(let z=0;z<C;z++){const $=j[L+z];M+=$*$}const I=Math.sqrt(M/C);N.push(I)}const O=Math.max(...N),R=1.5,k=N.map(A=>Math.min(1,A/O*R));x||p(k),await w.close()}catch(b){console.error("Failed to generate waveform:",b)}finally{x||f(!1)}})(),()=>{x=!0}},[s]),h.useEffect(()=>{if(u)return;const x=l.current;if(!x||d.length===0)return;const v=x.getContext("2d");if(!v)return;const b=x.width,w=x.height;if(b===0||w===0)return;const y=r+o,j=Math.min(d.length,Math.floor(b/y));v.clearRect(0,0,b,w);for(let S=0;S<j;S++){const C=Math.floor(S/j*d.length),N=d[C],O=Math.max(3,w*.05),R=w*.95,k=Math.max(O,N*R),A=S*y,L=(w-k)/2;v.fillStyle=e?c:i,v.fillRect(A,L,r,k)}},[d,e,r,o,i,c,m,u]),h.useEffect(()=>{const x=l.current;if(!x)return;const v=()=>{const b=x.parentElement;if(!b)return;const w=b.getBoundingClientRect();w.width>0&&w.height>0&&(x.width!==w.width||x.height!==w.height)&&(x.width=w.width,x.height=w.height,g({width:w.width,height:w.height}))};return v(),d.length>0&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{v()})}),window.addEventListener("resize",v),()=>{window.removeEventListener("resize",v)}},[n,d.length]),u?a.jsx("div",{className:`waveform-loading flex items-center justify-center ${t}`,style:{height:n},children:a.jsx("div",{className:"text-xs text-gray-400",children:"Generating waveform..."})}):a.jsx("div",{className:`waveform-container ${t}`,style:{height:n},children:a.jsx("canvas",{ref:l,className:"waveform-visualizer w-full h-full",style:{display:"block"}})})}function Nm({chunk:s,isPlaying:e,onPlay:t,onPause:n,onDownload:r,onDelete:o,onTranscribe:i,variant:c="default",showTranscribe:l=!1}){const d=c==="error"?"hover:bg-red-100":"hover:bg-slate-200";return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(ue,{size:"sm",variant:"ghost",onClick:e?n:t,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:e?a.jsx(mp,{className:"w-3.5 h-3.5"}):a.jsx(nc,{className:"w-3.5 h-3.5"})}),a.jsx(ue,{size:"sm",variant:"ghost",onClick:r,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:a.jsx(Ia,{className:"w-3.5 h-3.5"})}),l&&i&&a.jsx(ue,{size:"sm",variant:"ghost",onClick:i,className:`h-7 w-7 p-0 text-blue-600 hover:text-blue-700 ${c==="error"?"hover:bg-red-100":"hover:bg-blue-50"}`,disabled:!s.blob||s.transcriptionStatus==="processing",title:"Transcribe audio",children:a.jsx(On,{className:"w-3.5 h-3.5"})}),o&&a.jsx(ue,{size:"sm",variant:"ghost",onClick:o,className:`h-7 w-7 p-0 text-red-600 hover:text-red-700 ${c==="error"?"hover:bg-red-100":"hover:bg-red-50"}`,children:a.jsx(Et,{className:"w-3.5 h-3.5"})})]})}function km({duration:s,variant:e="default"}){const t=r=>{const o=r/1e3,i=Math.floor(o),c=Math.floor((o-i)*100);return c>0?`${i}.${c.toString().padStart(2,"0")}s`:`${i}s`},n={completed:"text-xs text-green-600 border-green-600 bg-green-50",processing:"text-xs text-blue-600 border-blue-600 bg-blue-50",failed:"text-xs text-red-600 border-red-600 bg-red-50",pending:"text-xs text-gray-600 border-gray-400 bg-gray-50",default:"text-xs text-gray-600 border-gray-400 bg-gray-50"};return a.jsxs(pt,{variant:"outline",className:n[e],children:[a.jsx(oc,{className:"w-3 h-3 mr-1"}),t(s)]})}const Em={completed:{className:"bg-card",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsx("div",{className:"text-sm leading-relaxed font-medium",children:s.transcription})]})},processing:{className:"bg-blue-50 border-blue-200",badgeVariant:"processing",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(ir,{className:"w-4 h-4 text-blue-600 animate-spin"}),a.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Transcribing audio..."})]})]})},failed:{className:"bg-red-50 border-red-200",badgeVariant:"failed",controlsVariant:"error",showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(sc,{className:"w-4 h-4 text-red-600"}),a.jsxs("span",{className:"text-sm font-medium text-red-700",children:["Transcription Failed",s.transcriptionError&&a.jsxs("span",{className:"text-xs font-normal ml-1",children:["(",s.transcriptionError,")"]})]})]})]})},pending:{className:"bg-gray-50 border-gray-200",badgeVariant:"pending",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(oc,{className:"w-4 h-4 text-gray-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"Waiting to transcribe..."})]})]})},none:{className:"bg-gray-50 border-gray-200",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx($s,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Js,{className:"w-4 h-4 text-gray-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"No transcription available"})]})]})}};function Im({chunk:s,isPlaying:e,showWaveform:t,onPlay:n,onPause:r,onDownload:o,onDelete:i,onTranscribe:c}){const d=s.transcription?"completed":s.transcriptionStatus==="processing"?"processing":s.transcriptionStatus==="failed"?"failed":s.transcriptionStatus==="pending"?"pending":"none",p=Em[d];return a.jsx(hn,{className:"chunk-item shadow-sm",children:a.jsx(fn,{className:"p-0",children:a.jsxs("div",{className:`flex flex-col border rounded-md py-2 px-2 gap-2 ${p.className}`,children:[p.renderContent(s,e,t),a.jsxs("div",{className:"flex justify-between items-center",children:[s.duration&&a.jsx(km,{duration:s.duration,variant:p.badgeVariant}),a.jsx(Nm,{chunk:s,isPlaying:e,onPlay:n,onPause:r,onDownload:o,onDelete:i,onTranscribe:c,variant:p.controlsVariant,showTranscribe:p.showTranscribe})]})]})})})}function Jc({chunks:s,className:e="",onChunkDelete:t,onChunkTranscribe:n,onTranscribeAll:r,onClearAll:o}){const[i,c]=h.useState(null),[l,d]=h.useState(!1),[p,u]=h.useState({language:"vi",model:"ggml-distil-large-v3",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1}),[f,m]=h.useState(!1),g=h.useRef(null),x=h.useRef(null),v=h.useCallback(R=>{if(!R.blob)return;g.current&&(g.current.pause(),x.current&&URL.revokeObjectURL(x.current));const k=new Audio;g.current=k;const A=URL.createObjectURL(R.blob);x.current=A,k.src=A,k.onplay=()=>{c(R.id)},k.onpause=()=>{c(null)},k.onended=()=>{c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},k.onerror=L=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Audio playback error:",L),c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},k.play().catch(L=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Failed to play audio:",L),c(null)})},[]),b=h.useCallback(()=>{g.current&&g.current.pause()},[]),w=h.useCallback(R=>{if(!R.blob)return;const k=URL.createObjectURL(R.blob),A=document.createElement("a");A.href=k,A.download=`${R.name}.wav`,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(k)},[]),y=h.useCallback(async R=>{i===R&&g.current&&(g.current.pause(),c(null)),await(t==null?void 0:t(R))},[i,t]),j=h.useCallback(async R=>{await(n==null?void 0:n(R))},[n]),S=h.useCallback(async()=>{g.current&&(g.current.pause(),c(null)),await(o==null?void 0:o())},[o]),C=h.useCallback(async()=>{await(r==null?void 0:r(p))},[r,p]);h.useEffect(()=>()=>{g.current&&g.current.pause(),x.current&&URL.revokeObjectURL(x.current)},[]);const N=s.reduce((R,k)=>R+(k.duration??0),0),O=s.reduce((R,k)=>R+(k.size??0),0);return a.jsx("div",{className:`chunks-panel flex flex-col h-full ${e}`,children:a.jsxs(hn,{className:"flex-1 flex flex-col rounded-none",children:[a.jsxs(La,{className:"pb-4",children:[a.jsxs(Ma,{className:"flex items-center justify-between",children:[a.jsx("span",{children:"Audio Chunks"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(pt,{variant:"outline",children:s.length}),s.length>0&&r&&a.jsx(dn,{variant:"ghost",size:"sm",buttonClassName:"h-6 w-6 p-0",contentClassName:"w-80",title:"Transcription Options",align:"end",storageKey:"chunks-panel-transcription-options",children:a.jsx("div",{className:"chunk-options-config",children:a.jsx(dr,{label:"Transcribe All",onAction:C,size:"sm",className:"w-full",tooltipText:"Click to transcribe all chunks, or click gear for options",popoverContent:a.jsx(Kc,{transcribeOptions:p,useWebSocket:f,onTranscribeOptionsChange:u,onUseWebSocketChange:m})})})}),s.length>0&&a.jsx(ue,{variant:"ghost",size:"sm",onClick:()=>d(!l),className:`h-6 px-2 text-xs ${l?"bg-blue-50 text-blue-600":"text-gray-600"}`,title:l?"Hide waveforms":"Show waveforms",children:a.jsx(fp,{className:"w-3 h-3"})}),s.length>0&&o&&a.jsx(ue,{variant:"ghost",size:"sm",onClick:S,className:"h-6 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",title:"Clear all chunks",children:a.jsx(Et,{className:"w-3 h-3"})})]})]}),s.length>0&&a.jsxs("div",{className:"stats-summary text-xs text-gray-600 space-y-1",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Total Duration:"}),a.jsxs("span",{children:[Math.floor(N/1e3),"s"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Total Size:"}),a.jsxs("span",{children:[(O/1024).toFixed(1)," KB"]})]})]})]}),a.jsx(fn,{className:"flex-1 overflow-hidden p-4",children:s.length===0?a.jsxs("div",{className:"empty-state flex flex-col items-center justify-center h-full text-center text-gray-500",children:[a.jsx("div",{className:"mb-2",children:"ðŸŽ¤"}),a.jsx("p",{className:"text-sm",children:"No chunks recorded yet"}),a.jsx("p",{className:"text-xs mt-1",children:"Start recording and speak to create chunks"})]}):a.jsx("div",{className:"chunks-list overflow-y-auto h-full space-y-2 pr-2",children:s.slice().reverse().map(R=>a.jsx(Im,{chunk:R,isPlaying:i===R.id,showWaveform:l,onPlay:()=>v(R),onPause:b,onDownload:()=>w(R),onDelete:()=>void y(R.id),onTranscribe:n?()=>void j(R.id):void 0},R.id))})})]})})}const Uo="audio-panel-config";function Tm({sessionName:s="audio-panel-session",enableAutoPersist:e=!0,loadPersistedChunks:t=!1,initialConfig:n,autoStart:r=!1,startTrigger:o,stopTrigger:i,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onSilenceDetected:p,onClearAndRecord:u,onWordReceived:f,onTranscriptionProgress:m,onRecordingStateChange:g,className:x=""}){var X,we;const[v,b]=h.useState(Array(32).fill(0)),[w,y]=h.useState(0),S=(()=>{try{const ne=localStorage.getItem(Uo);if(ne)return JSON.parse(ne)}catch(ne){console.error("Failed to load persisted config:",ne)}return{}})(),[C,N]=h.useState(()=>{let ne={...Vs,...S},xe=localStorage.getItem("audio-panel-selected-preset");if(xe||(xe="default",localStorage.setItem("audio-panel-selected-preset",xe)),xe)try{const J=An[xe];if(J)ne=zn(J.config);else{const je=gn().find(Te=>Te.id===xe);je&&(ne=zn(je.config))}}catch(J){console.error("Failed to apply selected preset:",J)}return{...ne,...n}}),O=h.useRef(null),R=h.useRef(null),k=h.useRef(null),A=h.useRef(null),L=h.useRef(!1),M=h.useCallback(ne=>{console.error("ðŸŽ¤ Recorder error:",ne)},[]),I=h.useRef(C.autoStopOnSilence),z=h.useRef(p),$=h.useRef(null),q=h.useRef(null),P=h.useRef(null),te=h.useRef(!1),E=h.useRef(!0),_=h.useRef(0),F=h.useRef(null),V=h.useRef(0),Y=h.useRef(C.chunkingMode);h.useEffect(()=>{I.current=C.autoStopOnSilence},[C.autoStopOnSilence]),h.useEffect(()=>{Y.current=C.chunkingMode},[C.chunkingMode]),h.useEffect(()=>{z.current=p},[p]),h.useEffect(()=>{n!=null&&n.transcribeOptions&&N(ne=>({...ne,transcribeOptions:{...ne.transcribeOptions,...n.transcribeOptions}}))},[(X=n==null?void 0:n.transcribeOptions)==null?void 0:X.language,(we=n==null?void 0:n.transcribeOptions)==null?void 0:we.model]);const{state:T,actions:W,startChunk:se,stopChunk:le,discardCurrentChunk:me,deleteChunk:ae,transcribeChunk:H,updateChunkTranscription:Q,reconnectWebSocket:ge}=xm({sessionName:s,enableAutoPersist:e,enableAutoTranscription:C.chunkingMode==="silence-based"?!1:C.enableAutoTranscription,minChunkDuration:C.minChunkDuration,loadPersistedChunks:t,skipLastSessionChunk:C.skipLastSessionChunk,transcribeOptions:C.transcribeOptions,useWebSocket:C.useWebSocket,onWordReceived:f,onTranscriptionProgress:m,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onError:M}),ce=h.useCallback(ne=>{if(ne.length===0)return"";if(ne.length===1)return ne[0].trim();let xe=ne[0].trim();for(let J=1;J<ne.length;J++){let he=ne[J].trim();if(!he)continue;!/[.!?â€¦]$/.test(xe)&&he.length>0&&(he=he.charAt(0).toLowerCase()+he.slice(1)),xe=`${xe} ${he}`}return xe},[]),Ae=h.useCallback(async ne=>{if(C.chunkingMode==="silence-based"&&ne.blob){console.log(`ðŸŽ¤ Processing chunk for silence-based splitting: ${ne.name} (${ne.blob.size} bytes)`);try{const xe=await ne.blob.arrayBuffer(),he=await new AudioContext().decodeAudioData(xe);console.log(`ðŸŽ¤ AudioBuffer duration: ${he.duration.toFixed(2)}s`);const je=Wn.DEFAULT;console.log("ðŸŽ¤ Using DEFAULT preset:",je);const Ne=await new Hc(je).chunkAudio(he);if(console.log(`ðŸŽ¤ Silence-based split: ${Ne.length} chunks detected`),console.log("ðŸŽ¤ Chunk details:",Ne.map((Ce,_e)=>({index:_e+1,startTime:Ce.startTime.toFixed(2)+"s",endTime:Ce.endTime.toFixed(2)+"s",duration:Ce.duration.toFixed(2)+"s",blobSize:Ce.blob.size+" bytes"}))),C.enableAutoTranscription&&Ne.length>0){const Ce=[];for(let Me=0;Me<Ne.length;Me++){const Be=Ne[Me],ze=`${ne.name}-split-${Me+1}`;console.log(`ðŸŽ¤ Transcribing split ${Me+1}/${Ne.length}: ${ze} (${Be.duration.toFixed(2)}s)`);try{const lt=new File([Be.blob],`${ze}.wav`,{type:"audio/wav"}),Je=await zc.transcribeAudio(lt,C.transcribeOptions);Ce.push(Je.transcription),console.log(`ðŸŽ¤ Split ${Me+1} transcribed: "${Je.transcription}"`);const rt=ce(Ce);rt&&(await Q(ne.id,rt),console.log(`ðŸŽ¤ Progressive update: "${rt}"`))}catch(lt){console.error(`ðŸŽ¤ Failed to transcribe split ${Me+1}:`,lt),Ce.push(`[Error: ${lt instanceof Error?lt.message:"Unknown error"}]`)}}const _e=ce(Ce);console.log(`ðŸŽ¤ Final transcription (${Ne.length} splits): "${_e}"`)}}catch(xe){console.error("ðŸŽ¤ Failed to split chunk by silence:",xe)}}},[C,Q,ce]);h.useEffect(()=>{if(C.chunkingMode==="silence-based"&&T.chunks.length>0){const ne=T.chunks[T.chunks.length-1];!ne.transcription&&!ne.transcriptionStatus&&Ae(ne)}},[T.chunks,C.chunkingMode,Ae]);const ke=Sm(C.silenceDetectionConfig),ve=h.useRef(ke);h.useEffect(()=>{ve.current=ke},[ke]);const U=vm({config:C.chunkingMode==="silence-based"?{...C,vadSilenceTimeout:100}:C,isRecording:T.isRecording,isChunkRecording:T.isChunkRecording,callbacks:{startChunk:se,stopChunk:le,discardCurrentChunk:me},cumulativeActiveTimeRef:_,peakAudioLevelRef:V}),re=h.useRef(U);h.useEffect(()=>{re.current=U},[U]);const G=h.useCallback(ne=>{var xe;N(J=>{const he={...J,...ne};return ne.silenceDetectionConfig&&(he.silenceDetectionConfig={...J.silenceDetectionConfig,...ne.silenceDetectionConfig}),ne.transcribeOptions&&(he.transcribeOptions={...J.transcribeOptions,...ne.transcribeOptions}),he}),((xe=ne.silenceDetectionConfig)==null?void 0:xe.silenceThreshold)!==void 0&&ke.updateThreshold(ne.silenceDetectionConfig.silenceThreshold)},[ke]);h.useEffect(()=>{try{localStorage.setItem(Uo,JSON.stringify(C))}catch(ne){console.error("Failed to persist config:",ne)}},[C]),h.useEffect(()=>{P.current=se},[se]),h.useEffect(()=>{$.current=le},[le]),h.useEffect(()=>{q.current=me},[me]);const oe=h.useRef(T.isRecording);h.useEffect(()=>{oe.current=T.isRecording},[T.isRecording]),h.useEffect(()=>{te.current=T.isChunkRecording},[T.isChunkRecording]);const de=h.useCallback(async()=>{try{const ne=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),xe=new AudioContext,J=xe.createAnalyser();J.fftSize=256,J.smoothingTimeConstant=.8,xe.createMediaStreamSource(ne).connect(J),O.current=xe,R.current=J;const je=()=>{var ze,lt;if(!R.current)return;const Te=R.current.frequencyBinCount,Ne=new Uint8Array(Te);R.current.getByteFrequencyData(Ne);const Ce=32,_e=Math.floor(Te/Ce),Me=[];for(let Je=0;Je<Ce;Je++){let rt=0;for(let vt=0;vt<_e;vt++)rt+=Ne[Je*_e+vt];const gt=rt/_e/255;Me.push(gt)}if(b(Me),ve.current.processAudioData(Me),te.current){const Je=ve.current.state.currentLevel;Je>V.current&&(V.current=Je)}if(Y.current==="vad"||Y.current==="silence-based"){const Je=ve.current.state.isSilent,rt=E.current;re.current.processVADAudio(Je,rt)}const Be=Date.now();if(te.current)if(F.current===null)F.current=Be;else{const Je=Be-F.current;E.current||(_.current+=Je),F.current=Be}else F.current=null,_.current=0;if(I.current&&T.isChunkRecording){const Je=ve.current.state.isSilent,rt=L.current;!rt&&!Je?L.current=!0:rt&&Je&&((ze=z.current)==null||ze.call(z),(lt=$.current)==null||lt.call($),L.current=!1)}E.current=ve.current.state.isSilent,k.current=requestAnimationFrame(je)};je()}catch(ne){console.error("ðŸŽ¤ âŒ Failed to setup audio analysis:",ne)}},[]),pe=h.useCallback(()=>{k.current&&(cancelAnimationFrame(k.current),k.current=null),O.current&&(O.current.close(),O.current=null),R.current=null,b(Array(32).fill(0)),ve.current.reset(),re.current.resetVADState(),L.current=!1},[]),fe=h.useCallback(async()=>{if(T.isRecording){if(T.isChunkRecording){const ne=_.current,xe=C.silenceDetectionConfig.minActiveDuration,J=V.current,he=C.silenceDetectionConfig.activationThreshold;ne>=xe&&J>=he?await le():me()}W.stopRecording(),oe.current=!1,pe(),A.current=null}else await W.startRecording(),oe.current=!0,await de(),A.current=Date.now(),C.chunkingMode==="time"&&(await se(),L.current=!1)},[T.isRecording,T.isChunkRecording,W,de,pe,C.chunkingMode,C.silenceDetectionConfig.minActiveDuration,C.silenceDetectionConfig.activationThreshold,se,le,me]);h.useEffect(()=>{if(!T.isRecording)return;const ne=setInterval(()=>{A.current&&y(Date.now()-A.current)},100);return()=>clearInterval(ne)},[T.isRecording]),h.useEffect(()=>()=>{pe()},[pe]);const be=h.useRef(null);h.useEffect(()=>{be.current!==null&&be.current!==T.isRecording&&(g==null||g(T.isRecording)),be.current=T.isRecording},[T.isRecording,g]),h.useEffect(()=>{r&&!T.isRecording&&fe()},[r]),h.useEffect(()=>{o!==void 0&&o>0&&!T.isRecording&&fe()},[o]),h.useEffect(()=>{i!==void 0&&i>0&&T.isRecording&&fe()},[i]);const Pe=h.useCallback(async ne=>{const xe=T.chunks.find(J=>J.id===ne);if(!(xe!=null&&xe.blob)){console.error("ðŸŽ¤ âŒ Cannot transcribe chunk: blob not found",ne);return}await H(ne,xe.blob,xe.name,C.transcribeOptions)},[T.chunks,H,C]),Ie=h.useCallback(async ne=>{await ae(ne),d==null||d(ne)},[ae,d]),K=h.useCallback(async()=>{const ne=T.chunks.map(xe=>xe.id);await Promise.all(ne.map(xe=>Ie(xe)))},[T.chunks,Ie]),D=h.useCallback(async()=>{await K(),u==null||u(),await ge(),T.isRecording||await fe()},[K,u,ge,T.isRecording,fe]);return h.useEffect(()=>{if(!T.isRecording||C.chunkingMode!=="time")return;const ne=setInterval(()=>{var Te,Ne;const xe=_.current,J=C.silenceDetectionConfig.minActiveDuration,he=V.current,je=C.silenceDetectionConfig.activationThreshold;if(xe<J||he<je){(Te=q.current)==null||Te.call(q),setTimeout(()=>{var Ce;(Ce=P.current)==null||Ce.call(P),_.current=0,V.current=0},50);return}(Ne=$.current)==null||Ne.call($),setTimeout(()=>{var Ce;(Ce=P.current)==null||Ce.call(P),_.current=0,V.current=0},50)},C.autoChunkCreationTime);return()=>{clearInterval(ne)}},[T.isRecording,C.autoChunkCreationTime,C.silenceDetectionConfig.minActiveDuration,C.silenceDetectionConfig.activationThreshold,C.chunkingMode]),a.jsx("div",{className:`audio-panel ${x}`,children:a.jsx(hn,{children:a.jsxs(fn,{className:"p-3 space-y-1",children:[a.jsxs("div",{className:"controls-section flex justify-between items-center gap-1",children:[a.jsx(em,{onClick:fe,label:T.isRecording?"Stop":"Record",icon:T.isRecording?Xs:rr,variant:T.isRecording?"destructive":"default",size:"sm",options:[{label:"Clear and Record",onClick:D}],showDropdown:!T.isRecording,className:"recording-toggle-group"}),a.jsxs(nt,{children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:"secondary",size:"sm",children:a.jsx(gp,{className:"w-3 h-3"})})}),a.jsx(Qe,{className:"w-80 p-3",align:"end",children:a.jsx(Cm,{config:C,onConfigChange:G})})]})]}),a.jsx("div",{className:"visualizer-section",children:a.jsx(jm,{audioData:v,silenceState:ke.state,onThresholdChange:ke.updateThreshold,hideSilenceControls:!0,duration:w})}),(C.chunkingMode==="vad"||C.chunkingMode==="silence-based")&&T.isRecording&&a.jsxs("div",{className:"vad-activity-indicator p-2 bg-slate-50 border border-slate-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("span",{className:"text-[9px] font-semibold text-slate-600",children:"VAD Activity"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-[8px] text-slate-500",children:["Level: ",(ke.state.currentLevel*100).toFixed(0),"%"]}),a.jsx("div",{className:`px-1.5 py-0.5 rounded text-[8px] font-medium ${ke.state.isSilent?"bg-gray-100 text-gray-600":"bg-green-100 text-green-700"}`,children:ke.state.isSilent?"ðŸ”‡ Silent":"ðŸŽ™ï¸ Active"})]})]}),a.jsxs("div",{className:"relative h-2 bg-slate-200 rounded-full overflow-hidden",children:[ke.state.silenceThreshold>0&&a.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-400 z-10",style:{left:`${ke.state.silenceThreshold*100}%`},title:`Threshold: ${(ke.state.silenceThreshold*100).toFixed(0)}%`}),a.jsx("div",{className:`h-full transition-all duration-100 ${ke.state.isSilent?"bg-gray-400":"bg-green-500"}`,style:{width:`${ke.state.currentLevel*100}%`}})]}),T.isChunkRecording&&a.jsxs("div",{className:"mt-1 text-[8px] text-blue-600 flex items-center gap-1",children:[a.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-blue-600 rounded-full animate-pulse"}),"Recording chunk..."]})]}),T.error&&a.jsx("div",{className:"error-display p-1.5 bg-red-50 border border-red-200 rounded-lg",children:a.jsx("p",{className:"text-[10px] text-red-600",children:T.error})}),a.jsx(Jc,{chunks:T.chunks,onChunkDelete:Ie,onChunkTranscribe:Pe,onClearAll:K})]})})})}const Bo=s=>{let e;const t=new Set,n=(d,p)=>{const u=typeof d=="function"?d(e):d;if(!Object.is(u,e)){const f=e;e=p??(typeof u!="object"||u===null)?u:Object.assign({},e,u),t.forEach(m=>m(e,f))}},r=()=>e,c={setState:n,getState:r,getInitialState:()=>l,subscribe:d=>(t.add(d),()=>t.delete(d))},l=e=s(n,r,c);return c},Yc=(s=>s?Bo(s):Bo);var Ua=(s=>(s.ADD="add",s.DRAW_ARROW="draw_arrow",s.DRAW="draw",s.SELECT="select",s.MOVE="move",s.ZOOM="zoom",s.WRITE="write",s.GRID="grid",s.VIM="vim",s))(Ua||{}),Pn=(s=>(s.WRITE="write",s.AUDIO="write:audio",s))(Pn||{}),Rn=(s=>(s.DEFAULT="draw_arrow:default",s.STAY="draw_arrow:stay",s))(Rn||{}),Xc=(s=>(s.NONE="none",s.STUDY="study",s.PAIRING="pairing",s))(Xc||{}),Ke=(s=>(s.RECT="RECT",s.TABLE="TABLE",s.TEXT="TEXT",s.ARROW="ARROW",s.TEXTCARD="TEXTCARD",s.WORKFLOW_ORCHESTRATION="WORKFLOW_ORCHESTRATION",s.WORKFLOW_SOURCE="WORKFLOW_SOURCE",s.WORKFLOW_DEFINITION="WORKFLOW_DEFINITION",s.WORKFLOW_STEP="WORKFLOW_STEP",s.OCR="OCR",s.IMAGE="IMAGE",s.GROUP="GROUP",s.CHAT="CHAT",s.VOCABULARY="VOCABULARY",s.DRAWING="DRAWING",s))(Ke||{});const aC=["content","title","x","y","width","height","createdAt","updatedAt","id","type"],oC={content:"Content",title:"Title",x:"X Position",y:"Y Position",width:"Width",height:"Height",createdAt:"Created At",updatedAt:"Updated At",id:"ID",type:"Type"},iC=["title","content"],cC={title:"Title",content:"Content"};let Ue=(s=21)=>crypto.getRandomValues(new Uint8Array(s)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class wn{static loadPreset(e){const t=new Map,n=this.convertStepsToRows(e.steps,t),r=t.get(1)||"row_1";return{id:`wf-preset-${e.id}`,x:0,y:0,width:400,height:300,type:Ke.RECT,title:e.name,content:e.description,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:n},inputHandles:[{id:`input_${r}`,name:"All Nodes",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Result",type:"output",dataType:"any"}]}}}static convertStepsToRows(e,t,n){return e.map(r=>{const o=Ue();t.set(r.order,o);const i={id:o,label:r.label,order:r.order,stepType:r.type};if(r.config){const c=JSON.parse(JSON.stringify(r.config));c.dataSource==="row_1"&&(c.dataSource=t.get(1)||"row_1"),i.config=c}return r.children&&r.children.length>0&&(i.children=this.convertStepsToRows(r.children,t,r.order)),i})}}const Am=8,Pm=0,Rm=0,lC="__paste-create__",kr=4;function zt(s){const e=Math.round(s*1.5),t=Math.round(s*.25),n=e+t*2;return{fontSize:s,lineHeight:e,padding:t,baseNodeHeight:n,cssFontSize:`${s}px`,cssLineHeight:`${e}px`,cssPadding:`${t}px`}}const et={small:zt(14),normal:zt(16),xnormal:zt(18),large:zt(20),xlarge:zt(24),xxlarge:zt(28),xxxlarge:zt(32),xxxxlarge:zt(38),xxxxxlarge:zt(48)};function Ba(s){if(s===void 0)return et.normal;let e;if(typeof s=="number")e=s;else{const t=parseFloat(s);e=isNaN(t)?et.normal.fontSize:t}for(const t of Object.values(et))if(t.fontSize===e)return t;return zt(e)}const dC=768,uC=300,pC=30,hC=50,fC=500,it={DEFAULT_NODE_WIDTH:120,DEFAULT_NODE_HEIGHT:et.normal.baseNodeHeight,VOCAB_NODE_MIN_WIDTH:140,FONT_SIZE_DEFAULT:et.normal.fontSize,FONT_SIZE_SMALL:et.small.fontSize,FONT_SIZE_XS:13,FONT_SIZE_XXS:12,FONT_SIZE_MINI:10,FONT_SIZE_PRESETS:{small:et.small.fontSize,normal:et.normal.fontSize,large:et.large.fontSize,xlarge:et.xlarge.fontSize,xxlarge:et.xxlarge.fontSize,xxxlarge:et.xxxlarge.fontSize,xxxxlarge:et.xxxxlarge.fontSize,xxxxxlarge:et.xxxxxlarge.fontSize},TEXT_PADDING:{default:{horizontal:et.normal.padding,vertical:et.normal.padding},large:{horizontal:et.large.padding,vertical:et.large.padding}},LINE_HEIGHT:et.normal.lineHeight,LINE_HEIGHT_CONFIG:25,LINE_HEIGHT_FIND:20,DEFAULT_PADDING:kr,NODE_X_PADDING:kr*2,NODE_Y_PADDING:kr*2,nodeSpacing:20,NODE_ALIGNMENT_PADDING:16,writeMode:{yRatio:.67},TEXT_MODE_ADJUST_Y:25,NEW_NODE_SEGMENT_SPACING:15,MIN_RESIZE_WIDTH:100,MIN_RESIZE_HEIGHT:100,HANDLE_OFFSET:Am/2,HANDLE_BG_COLOR:"bg-primary",HANDLE_BORDER_COLOR:"border-primary-foreground",SELECTION_RING_COLOR:"ring-ring",SELECTED_BORDER_COLOR:"border-ring",CUSTOM_CHARACTERS:["?","!"],chatInput:{BOTTOM_VISIBLE:70,BOTTOM_HIDDEN:10,NODE_GAP_TOP:100,NODE_GAP_LEFT:20,NODE_GAP_RIGHT:40,NODE_SCROLL_GAP:20},ARRANGE_NODE_GAP:60,ARRANGE_GRID_COLUMNS:3,PRESET_STEP_DELAY_MS:200},Dm={textNodeXPadding:it.NODE_X_PADDING*4};function _m(s){const e=Ba(s);return{horizontal:e.padding,vertical:e.padding}}const Om="capitalize",Lm="Capitalize",Mm="Capitalize first letter of text",Fm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Capitalize",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.capitalize()}}"}]}}]}],$m={id:Om,name:Lm,description:Mm,steps:Fm},Um="trim-symbols-light",Bm="Trim Symbols (Light)",Wm="Remove punctuation and special characters from start/end of text",zm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsLight()}}"}]}}]}],Hm={id:Um,name:Bm,description:Wm,steps:zm},Gm="trim-symbols-strict",qm="Trim Symbols (Strict)",Vm="Remove all non-alphanumeric characters from start/end of text",Km=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsStrict()}}"}]}}]}],Jm={id:Gm,name:qm,description:Vm,steps:Km},Ym="add-full-stop",Xm="Add Full Stop",Qm="Add a full stop (.) at the end of text",Zm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Add Full Stop",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title}}."}]}}]}],eg={id:Ym,name:Xm,description:Qm,steps:Zm};function Qc(){const s="workflow-templates-project",e="workflow-templates-workspace",t=wn.loadPreset($m),n=wn.loadPreset(Hm),r=wn.loadPreset(Jm),o=wn.loadPreset(eg),i="canvas-workflow-presets",c={id:i,name:"ðŸŽ¨ Workflow Presets",createdAt:Date.now(),lastModified:Date.now(),coreState:{nodes:[{id:Ue(8),x:50,y:50,type:Ke.TEXT,content:`ðŸŽ¨ Workflow Presets Library

Reusable workflow templates powered by JSON configuration.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How to Use:
1. Copy a preset workflow node below (Ctrl+C / Cmd+C)
2. Paste into your target canvas (Ctrl+V / Cmd+V)
3. Click Execute button on the workflow node
4. Done! All canvas nodes are processed automatically

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Key Features (WF-32):
âœ… Source node is OPTIONAL - workflows iterate through all canvas nodes
âœ… Templates use loop context: {{loop.index}}, {{loop.current.title}}
âœ… Simple mode with field updates or advanced mode with explicit targets

See: _docs/guidelines/canvas/workflow-presets-and-execution.md`,styles:{fontSize:`${it.FONT_SIZE_SMALL}px`,fontWeight:"bold",textColor:"#1f2937"}},{id:Ue(8),x:50,y:400,type:Ke.TEXT,content:`ðŸ”¤ Capitalize

Capitalize first letter of text.
Template: {{loop.current.title.capitalize()}}

Result: "hello world" â†’ "Hello world"`,styles:{fontSize:`${it.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...t,x:50,y:550},{id:Ue(8),x:450,y:400,type:Ke.TEXT,content:`âœ‚ï¸ Trim Symbols (Light)

Remove punctuation and special chars from edges.
Template: {{loop.current.title.trimSymbolsLight()}}

Result: "  - hello,  " â†’ "hello"`,styles:{fontSize:`${it.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...n,x:450,y:550},{id:Ue(8),x:850,y:400,type:Ke.TEXT,content:`ðŸ§¹ Trim Symbols (Strict)

Remove ALL non-alphanumeric from edges.
Template: {{loop.current.title.trimSymbolsStrict()}}

Result: "***hello***" â†’ "hello"`,styles:{fontSize:`${it.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...r,x:850,y:550},{id:Ue(8),x:1250,y:400,type:Ke.TEXT,content:`ðŸ“ Add Full Stop

Append a full stop (.) to end of text.
Template: {{loop.current.title}}.

Result: "Hello world" â†’ "Hello world."`,styles:{fontSize:`${it.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...o,x:1250,y:550}],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1,targetView:null}},l={id:e,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),canvases:{[i]:c},activeCanvasId:i};return{id:s,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[e]:l},activeWorkspaceId:e}}const tg=[{id:Ue(8),x:600,y:100,type:Ke.TEXT,content:"Node 2 - Text"}],sg=[{id:"vocab-demo-001",x:100,y:350,width:400,height:320,type:Ke.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"dictionary",term:"CÃ¢u tá»¥c ngá»¯",pronunciation:"/kÉ™ÊŠ tÊŠk Å‹ÊŠ/",partOfSpeech:"noun",definition:"Dieses Sprichwort betont die vietnamesische WertschÃ¤tzung fÃ¼r KreativitÃ¤t, Einfallsreichtum und ProblemlÃ¶sung in schwierigen Situationen",examples:[{id:"ex-001",text:"CÃ¢u tá»¥c ngá»¯ nÃ y nháº¥n máº¡nh sá»± trÃ¢n trá»ng cá»§a ngÆ°á»i Viá»‡t Ä‘á»‘i vá»›i sá»± sÃ¡ng táº¡o, tÃ­nh khÃ©o lÃ©o vÃ  kháº£ nÄƒng giáº£i quyáº¿t váº¥n Ä‘á» trong nhá»¯ng hoÃ n cáº£nh khÃ³ khÄƒn",translation:"This proverb emphasizes Vietnamese appreciation for creativity, resourcefulness and problem-solving in difficult situations"}],relatedWords:[{id:"rw-001",word:"Sprichwort",type:"synonym"},{id:"rw-002",word:"WertschÃ¤tzung",type:"related"}],etymology:{origin:"Vietnamese",language:"Tiáº¿ng Viá»‡t",evolution:"Traditional proverb passed down through generations"},expandedSections:["definition","examples"]}},{id:"vocab-demo-002",x:520,y:350,width:280,height:200,type:Ke.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"flashcard",term:"nháº¥n máº¡nh",pronunciation:"/É²É™n maÉ²/",partOfSpeech:"verb",definition:"betont / emphasize",flashcardBack:"betont (to emphasize, to stress)",isFlipped:!1,expandedSections:[]}},{id:"vocab-demo-003",x:820,y:350,width:320,height:280,type:Ke.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"word_list",term:"Sentence Breakdown",definition:"Vietnamese â†’ German word pairs",wordListItems:["CÃ¢u tá»¥c ngá»¯ â†’ Sprichwort","nÃ y â†’ Dieses","nháº¥n máº¡nh â†’ betont","sá»± trÃ¢n trá»ng â†’ WertschÃ¤tzung","cá»§a â†’ (von)","ngÆ°á»i Viá»‡t â†’ Vietnameses"],expandedSections:[]}}],ng=[...sg],rg=[],ag={nodes:ng,arrows:rg,groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},og={offset:{x:50,y:50},scale:1,targetView:null},ta=Ue(10),ig={id:ta,name:"My First Canvas",createdAt:Date.now(),lastModified:Date.now(),coreState:ag,viewState:og},sa=Ue(10),cg={id:sa,name:"Default Workspace",createdAt:Date.now(),lastModified:Date.now(),canvases:{[ta]:ig},activeCanvasId:ta},na=Ue(10),lg={id:na,name:"My Project",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[sa]:cg},activeWorkspaceId:sa},Wa={version:"3.6.8",dataVersion:"1.1.0",flags:{debug:{logEvents:!1,showDebugOverlay:!0},feature:{}},preferences:{segmentedButtons:{}},uiState:{mode:Ua.SELECT,addNodeType:Ke.TEXT,isPanning:!1,isDrawing:!1,mouseCursor:"cursor-default",selectionBox:null,temporaryArrow:null,nodeToFocusId:null,isOverlayVisible:!1,useCurvedArrows:!1,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},toolbar:{isVisible:!0,toolbarActions:[]},overlay:{},activeGlobalOverlay:Xc.NONE},state:{nodes:tg,projects:{[na]:lg,"workflow-templates-project":Qc()},activeProjectId:na}},Wo={DISABLED:"disabled",SIMPLE:"simple",COMPREHENSIVE:"comprehensive"},mC=["Straight","Quadratic","Cubic","Step","Orthogonal","TreeCubic","TreeLStep","TreeZShape"],gC=["none","subtle","medium","vintage","custom"],xC={none:{baseFrequency:.65,numOctaves:3,opacity:0,bgHue:0,bgSaturation:0,bgLightness:100},subtle:{baseFrequency:.8,numOctaves:3,opacity:.15,bgHue:0,bgSaturation:0,bgLightness:100},medium:{baseFrequency:.65,numOctaves:3,opacity:.3,bgHue:0,bgSaturation:0,bgLightness:100},vintage:{baseFrequency:.5,numOctaves:4,opacity:.4,bgHue:40,bgSaturation:30,bgLightness:96}},vC={none:"None",subtle:"Subtle",medium:"Medium",vintage:"Vintage",custom:"Custom"},bC={none:"",subtle:"paper-texture-subtle",medium:"paper-texture-medium",vintage:"paper-texture-vintage",custom:""},wC={Straight:"Straight",Quadratic:"Quadratic",Cubic:"Cubic",Step:"Step (L-shaped)",Orthogonal:"Orthogonal (Z-shaped)",TreeCubic:"Tree: Cubic",TreeLStep:"Tree: L-Step",TreeZShape:"Tree: Z-Shape"},De=class De{static getSelectionRingClass(e){return e?De._selectionRingClass:""}static getSelectedBorderClass(e){return e?De._selectedBorderClass:""}static getNodePaddingClass(e){return e===Ke.TEXT?"px-2 py-1":"p-2"}static getNodeCursorClass(e,t){return e===Ua.SELECT?t?"cursor-grabbing":"cursor-grab":""}};ee(De,"_debug",{exposeActions:!0}),ee(De,"persistState",!0),ee(De,"autosave",!0),ee(De,"hideToolbar",!1),ee(De,"hideOverlay",!1),ee(De,"background",{paperTexture:"none",customParams:null,savedPresets:[]}),ee(De,"arrows",{styles:{line:"hsl(var(--muted-light))",lineSelected:"hsl(var(--primary))"},type:"Cubic",REVERSE_CURVE:!1,CUBIC_ARROW_S_SHAPE_FACTOR:1,CUBIC_ARROW_S_SHAPE_REVERSED:!1,CUBIC_HORIZONTAL_BIAS:1,CUBIC_CONTROL_DISTANCE_MODE:"scaled-minimum",reverseArrowOnMultipleConnect:!0}),ee(De,"copyMode",{autoDrawArrows:!0}),ee(De,"highlightAndCreate",{createConnectingArrow:!1,createHighlight:!1,addHorizontally:!0}),ee(De,"nodeOptions",{maxNodeWidth:600,resizeBorderWidth:10}),ee(De,"nodeStyles",{textAlign:"left",fontSize:`${it.FONT_SIZE_DEFAULT}px`,fontWeight:"400",border:"",borderWidth:"",borderStyle:"",borderColor:"",backgroundColor:"",textColor:""}),ee(De,"zoom",{min:.01,max:4,intensity:.1,marks:[.09,.6,1,1.3,2]}),ee(De,"text",{debounceInput:300,fontSize:`${it.FONT_SIZE_DEFAULT}px`,paddingLeft:4,lineHeight:it.LINE_HEIGHT_CONFIG}),ee(De,"writeMode",{createAtMousePosition:!0,scrollDuration:3e3,scrollYRatio:.8,scrollVerticalPositionRatio:.75}),ee(De,"paste",{fixedWidth:550,maxWidth:550,adjustSizeOnPaste:!0}),ee(De,"LinterPreset",Wo),ee(De,"lint",{onPastePreset:Wo.SIMPLE}),ee(De,"contentCapture",{pasteWidth:700,nodeGap:80,depthOffset:125}),ee(De,"arrange",{gap:60,gridNodeWidth:550,gridColumns:3,gridRows:3,autoGroupOnArrange:!0,cleanUpGap:14,cleanUpRowThreshold:.5}),ee(De,"animation",{enabled:!0,durationMs:200,easing:"ease-out",splitDelayMs:50}),ee(De,"groups",{autoAddNodesOnExpand:!0}),ee(De,"slice",{laneGap:150,laneHeaderOffset:30,nodeGap:20}),ee(De,"autoScroll",{edgeThreshold:100,edgeThresholdMobile:30,scrollSpeed:15}),ee(De,"keyboardScroll",{animationDuration:300,targetScreenYRatio:.33,minKeyboardHeight:100}),ee(De,"tabBar",{maxTabWidth:150,dragSourceOpacity:.5,dragPreviewOpacity:.2,dropIndicator:{width:2,opacity:.4}}),ee(De,"slashCommand",{menuGapAboveInput:24}),ee(De,"dataTable",{dragHandleWidth:32}),ee(De,"claudeChat",{popoverRightGap:30,alignScrollDuration:500,alignNodeWithChatInput:!1,autoFocusOnWindowFocus:!0}),ee(De,"chatInput",{mobile:{bottomOffset:5,nodeGapRight:20,fontConfig:et.xnormal,get nodeFontSize(){return this.fontConfig.cssFontSize}},tabletBreakpoint:1280,maxRows:4}),ee(De,"chatNode",{viewMode:"fullwidth",windowed:{mobileViewportGap:10,desktopViewportGap:20},fullwidth:{contentPadding:20},defaultMaxHeight:600,desktopWidth:500,desktopHeight:400,desktopRightGap:20,messageGap:4,messagePadding:6,scrollSide:"right",scrollAreaWidth:"10vw",zoomFontSize:{enabled:!0,minScale:.4,maxScale:1,fontSize:18}}),ee(De,"nodeUI",{idleOpacity:.1,quickPanelGap:30,resizeHandleIdleOpacity:.3,quickArrowHandleIdleOpacity:.3}),ee(De,"canvasTable",{dropBehavior:"delete"}),ee(De,"history",{historyLimit:100,tabletHistoryLimit:30,archiveLimit:500,tabletArchiveLimit:200,tabletBreakpoint:768,holdRepeatIntervalMs:180}),ee(De,"holdToSelect",{holdDurationMs:800,movementThresholdPx:10,indicatorDelayMs:200,indicatorTopOffset:48,indicatorBottomOffset:80}),ee(De,"holdToDrag",{holdDelayMs:400,movementThresholdPx:10,enableChatNodeHighlight:!1}),ee(De,"drawing",{strokeGroupingTimeoutMs:1500,isRightHandMode:!0,markerOpacity:.3,markerColor:"#facc15",smoothingFactor:0,minPointDistance:0,compression:{enabled:!0,level:30}}),ee(De,"_selectionRingClass","ring-1 ring-ring ring-offset-1"),ee(De,"_selectedBorderClass","border-ring");let $e=De;const dg=(s,e,t,n)=>({left:-s.x/e,top:-s.y/e,right:(-s.x+t)/e,bottom:(-s.y+n)/e}),ug=(s,e,t,n,r)=>{const o=s.x+(s.width??100)/2,i=s.y+(s.height??50)/2,c=(r==null?void 0:r.verticalPositionRatio)??.5,l=t/2-o*e,d=n*c-i*e;return{x:l,y:d}},pg=(s,e,t,n=500,r)=>{const{uiState:o,projectCanvas:i,setActiveCanvasViewState:c}=e(),l=i.getActive();if(!l){console.warn("Cannot center view: No active canvas.");return}const d=l.coreState.nodes,p=l.viewState.scale,u=typeof t=="string"?d==null?void 0:d.find(b=>b.id===t):t,f=o==null?void 0:o.canvasWidth,m=o==null?void 0:o.canvasHeight;if(!u){console.warn("Cannot center view: Node dimensions not found.");return}if(!f||!m){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=l.viewState.offset;dg(g,p,f,m);const x=ug(u,p,f,m,r!=null&&r.verticalOnly?{verticalPositionRatio:$e.writeMode.scrollVerticalPositionRatio}:void 0),v=r!=null&&r.verticalOnly?{x:g.x,y:x.y}:x;c(b=>({...b,targetView:{targetOffset:v,targetScale:p,animationStartTime:0,animationDuration:n}}))},hg=(s,e,t)=>({x:Number(((s.x-t.x)/e).toFixed(3)),y:Number(((s.y-t.y)/e).toFixed(3))}),fg=s=>{const{projectCanvas:e}=s(),t=Dl.getState(),n=t==null?void 0:t.mousePosition,r=e.getActive(),o=(r==null?void 0:r.viewState.scale)??1,i=(r==null?void 0:r.viewState.offset)??{x:0,y:0};return!n||!r?null:hg(n,o,i)};var Zc=Symbol.for("immer-nothing"),zo=Symbol.for("immer-draftable"),yt=Symbol.for("immer-state");function Ot(s,...e){throw new Error(`[Immer] minified error nr: ${s}. Full error at: https://bit.ly/3cXEKWf`)}var en=Object.getPrototypeOf;function As(s){return!!s&&!!s[yt]}function gs(s){var e;return s?el(s)||Array.isArray(s)||!!s[zo]||!!((e=s.constructor)!=null&&e[zo])||xn(s)||hr(s):!1}var mg=Object.prototype.constructor.toString(),Ho=new WeakMap;function el(s){if(!s||typeof s!="object")return!1;const e=Object.getPrototypeOf(s);if(e===null||e===Object.prototype)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;if(t===Object)return!0;if(typeof t!="function")return!1;let n=Ho.get(t);return n===void 0&&(n=Function.toString.call(t),Ho.set(t,n)),n===mg}function Hn(s,e,t=!0){pr(s)===0?(t?Reflect.ownKeys(s):Object.keys(s)).forEach(r=>{e(r,s[r],s)}):s.forEach((n,r)=>e(r,n,s))}function pr(s){const e=s[yt];return e?e.type_:Array.isArray(s)?1:xn(s)?2:hr(s)?3:0}function ra(s,e){return pr(s)===2?s.has(e):Object.prototype.hasOwnProperty.call(s,e)}function tl(s,e,t){const n=pr(s);n===2?s.set(e,t):n===3?s.add(t):s[e]=t}function gg(s,e){return s===e?s!==0||1/s===1/e:s!==s&&e!==e}function xn(s){return s instanceof Map}function hr(s){return s instanceof Set}function ls(s){return s.copy_||s.base_}function aa(s,e){if(xn(s))return new Map(s);if(hr(s))return new Set(s);if(Array.isArray(s))return Array.prototype.slice.call(s);const t=el(s);if(e===!0||e==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(s);delete n[yt];let r=Reflect.ownKeys(n);for(let o=0;o<r.length;o++){const i=r[o],c=n[i];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(n[i]={configurable:!0,writable:!0,enumerable:c.enumerable,value:s[i]})}return Object.create(en(s),n)}else{const n=en(s);if(n!==null&&t)return{...s};const r=Object.create(n);return Object.assign(r,s)}}function za(s,e=!1){return fr(s)||As(s)||!gs(s)||(pr(s)>1&&Object.defineProperties(s,{set:yn,add:yn,clear:yn,delete:yn}),Object.freeze(s),e&&Object.values(s).forEach(t=>za(t,!0))),s}function xg(){Ot(2)}var yn={value:xg};function fr(s){return s===null||typeof s!="object"?!0:Object.isFrozen(s)}var vg={};function xs(s){const e=vg[s];return e||Ot(0,s),e}var tn;function sl(){return tn}function bg(s,e){return{drafts_:[],parent_:s,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Go(s,e){e&&(xs("Patches"),s.patches_=[],s.inversePatches_=[],s.patchListener_=e)}function oa(s){ia(s),s.drafts_.forEach(wg),s.drafts_=null}function ia(s){s===tn&&(tn=s.parent_)}function qo(s){return tn=bg(tn,s)}function wg(s){const e=s[yt];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function Vo(s,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return s!==void 0&&s!==t?(t[yt].modified_&&(oa(e),Ot(4)),gs(s)&&(s=Gn(e,s),e.parent_||qn(e,s)),e.patches_&&xs("Patches").generateReplacementPatches_(t[yt].base_,s,e.patches_,e.inversePatches_)):s=Gn(e,t,[]),oa(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),s!==Zc?s:void 0}function Gn(s,e,t){if(fr(e))return e;const n=s.immer_.shouldUseStrictIteration(),r=e[yt];if(!r)return Hn(e,(o,i)=>Ko(s,r,e,o,i,t),n),e;if(r.scope_!==s)return e;if(!r.modified_)return qn(s,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const o=r.copy_;let i=o,c=!1;r.type_===3&&(i=new Set(o),o.clear(),c=!0),Hn(i,(l,d)=>Ko(s,r,o,l,d,t,c),n),qn(s,o,!1),t&&s.patches_&&xs("Patches").generatePatches_(r,t,s.patches_,s.inversePatches_)}return r.copy_}function Ko(s,e,t,n,r,o,i){if(r==null||typeof r!="object"&&!i)return;const c=fr(r);if(!(c&&!i)){if(As(r)){const l=o&&e&&e.type_!==3&&!ra(e.assigned_,n)?o.concat(n):void 0,d=Gn(s,r,l);if(tl(t,n,d),As(d))s.canAutoFreeze_=!1;else return}else i&&t.add(r);if(gs(r)&&!c){if(!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||e&&e.base_&&e.base_[n]===r&&c)return;Gn(s,r),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&(xn(t)?t.has(n):Object.prototype.propertyIsEnumerable.call(t,n))&&qn(s,r)}}}function qn(s,e,t=!1){!s.parent_&&s.immer_.autoFreeze_&&s.canAutoFreeze_&&za(e,t)}function yg(s,e){const t=Array.isArray(s),n={type_:t?1:0,scope_:e?e.scope_:sl(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:s,draft_:null,copy_:null,revoke_:null,isManual_:!1};let r=n,o=Ha;t&&(r=[n],o=sn);const{revoke:i,proxy:c}=Proxy.revocable(r,o);return n.draft_=c,n.revoke_=i,c}var Ha={get(s,e){if(e===yt)return s;const t=ls(s);if(!ra(t,e))return Sg(s,t,e);const n=t[e];return s.finalized_||!gs(n)?n:n===Er(s.base_,e)?(Ir(s),s.copy_[e]=la(n,s)):n},has(s,e){return e in ls(s)},ownKeys(s){return Reflect.ownKeys(ls(s))},set(s,e,t){const n=nl(ls(s),e);if(n!=null&&n.set)return n.set.call(s.draft_,t),!0;if(!s.modified_){const r=Er(ls(s),e),o=r==null?void 0:r[yt];if(o&&o.base_===t)return s.copy_[e]=t,s.assigned_[e]=!1,!0;if(gg(t,r)&&(t!==void 0||ra(s.base_,e)))return!0;Ir(s),ca(s)}return s.copy_[e]===t&&(t!==void 0||e in s.copy_)||Number.isNaN(t)&&Number.isNaN(s.copy_[e])||(s.copy_[e]=t,s.assigned_[e]=!0),!0},deleteProperty(s,e){return Er(s.base_,e)!==void 0||e in s.base_?(s.assigned_[e]=!1,Ir(s),ca(s)):delete s.assigned_[e],s.copy_&&delete s.copy_[e],!0},getOwnPropertyDescriptor(s,e){const t=ls(s),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:s.type_!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty(){Ot(11)},getPrototypeOf(s){return en(s.base_)},setPrototypeOf(){Ot(12)}},sn={};Hn(Ha,(s,e)=>{sn[s]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});sn.deleteProperty=function(s,e){return sn.set.call(this,s,e,void 0)};sn.set=function(s,e,t){return Ha.set.call(this,s[0],e,t,s[0])};function Er(s,e){const t=s[yt];return(t?ls(t):s)[e]}function Sg(s,e,t){var r;const n=nl(e,t);return n?"value"in n?n.value:(r=n.get)==null?void 0:r.call(s.draft_):void 0}function nl(s,e){if(!(e in s))return;let t=en(s);for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=en(t)}}function ca(s){s.modified_||(s.modified_=!0,s.parent_&&ca(s.parent_))}function Ir(s){s.copy_||(s.copy_=aa(s.base_,s.scope_.immer_.useStrictShallowCopy_))}var jg=class{constructor(s){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,n)=>{if(typeof e=="function"&&typeof t!="function"){const o=t;t=e;const i=this;return function(l=o,...d){return i.produce(l,p=>t.call(this,p,...d))}}typeof t!="function"&&Ot(6),n!==void 0&&typeof n!="function"&&Ot(7);let r;if(gs(e)){const o=qo(this),i=la(e,void 0);let c=!0;try{r=t(i),c=!1}finally{c?oa(o):ia(o)}return Go(o,n),Vo(r,o)}else if(!e||typeof e!="object"){if(r=t(e),r===void 0&&(r=e),r===Zc&&(r=void 0),this.autoFreeze_&&za(r,!0),n){const o=[],i=[];xs("Patches").generateReplacementPatches_(e,r,o,i),n(o,i)}return r}else Ot(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(i,...c)=>this.produceWithPatches(i,l=>e(l,...c));let n,r;return[this.produce(e,t,(i,c)=>{n=i,r=c}),n,r]},typeof(s==null?void 0:s.autoFreeze)=="boolean"&&this.setAutoFreeze(s.autoFreeze),typeof(s==null?void 0:s.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(s.useStrictShallowCopy),typeof(s==null?void 0:s.useStrictIteration)=="boolean"&&this.setUseStrictIteration(s.useStrictIteration)}createDraft(s){gs(s)||Ot(8),As(s)&&(s=Cg(s));const e=qo(this),t=la(s,void 0);return t[yt].isManual_=!0,ia(e),t}finishDraft(s,e){const t=s&&s[yt];(!t||!t.isManual_)&&Ot(9);const{scope_:n}=t;return Go(n,e),Vo(void 0,n)}setAutoFreeze(s){this.autoFreeze_=s}setUseStrictShallowCopy(s){this.useStrictShallowCopy_=s}setUseStrictIteration(s){this.useStrictIteration_=s}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(s,e){let t;for(t=e.length-1;t>=0;t--){const r=e[t];if(r.path.length===0&&r.op==="replace"){s=r.value;break}}t>-1&&(e=e.slice(t+1));const n=xs("Patches").applyPatches_;return As(s)?n(s,e):this.produce(s,r=>n(r,e))}};function la(s,e){const t=xn(s)?xs("MapSet").proxyMap_(s,e):hr(s)?xs("MapSet").proxySet_(s,e):yg(s,e);return(e?e.scope_:sl()).drafts_.push(t),t}function Cg(s){return As(s)||Ot(10,s),rl(s)}function rl(s){if(!gs(s)||fr(s))return s;const e=s[yt];let t,n=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=aa(s,e.scope_.immer_.useStrictShallowCopy_),n=e.scope_.immer_.shouldUseStrictIteration()}else t=aa(s,!0);return Hn(t,(r,o)=>{tl(t,r,rl(o))},n),e&&(e.finalized_=!1),t}var Ng=new jg,Z=Ng.produce;const Ga=s=>{var n,r,o;if(!s.state)return null;const e=s.state.activeProjectId?(n=s.state.projects)==null?void 0:n[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?(r=e.workspaces)==null?void 0:r[e.activeWorkspaceId]:null;return t&&t.activeCanvasId?(o=t.canvases)==null?void 0:o[t.activeCanvasId]:null},kg=(s,e)=>s(Z(t=>{t.uiState.temporaryArrow=e})),Eg=(s,e)=>s(Z(t=>{var r,o,i,c,l,d;const n=Ga(t);if(n!=null&&n.coreState){const p=typeof e=="function"?e(n.coreState.arrows):e;n.coreState.arrows=p,n.coreState.selectedArrows.length>0&&(n.coreState.selectedArrows=n.coreState.selectedArrows.map(m=>p.find(x=>x.id===m.id)||m)),n.lastModified=Date.now();const u=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];u&&(u.lastModified=Date.now());const f=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];f&&(f.lastModified=Date.now())}})),Ig=(s,e)=>s(Z(t=>{var r,o,i,c,l,d;const n=Ga(t);if(n!=null&&n.coreState){const p=Array.isArray(e)?e:[],u=new Set(p.map(g=>g.id));n.coreState.selectedArrows=n.coreState.arrows.filter(g=>u.has(g.id)),n.lastModified=Date.now();const f=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];f&&(f.lastModified=Date.now());const m=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];m&&(m.lastModified=Date.now())}})),Tg=(s,e)=>s(Z(t=>{var r,o,i,c,l,d;const n=Ga(t);if(n!=null&&n.coreState){n.coreState.arrows.push(e),n.lastModified=Date.now();const p=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];p&&(p.lastModified=Date.now());const u=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];u&&(u.lastModified=Date.now())}})),Ag=(s,e,t,n)=>{s(Z(r=>{var l,d;const o=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o!=null&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i!=null&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if((d=c==null?void 0:c.coreState)!=null&&d.arrows){const p=c.coreState.arrows.findIndex(u=>u.id===t);if(p!==-1){if(c.coreState.arrows[p]={...c.coreState.arrows[p],...n},c.coreState.selectedArrows){const f=c.coreState.selectedArrows.findIndex(m=>m.id===t);f!==-1&&(c.coreState.selectedArrows[f]={...c.coreState.selectedArrows[f],...n})}const u=Date.now();c.lastModified=u,i&&(i.lastModified=u),o&&(o.lastModified=u)}}}))},Pg=(s,e)=>({setTemporary:t=>kg(s,t),setAll:t=>Eg(s,t),setSelected:t=>Ig(s,t),add:t=>Tg(s,t),update:(t,n)=>Ag(s,e,t,n)});function Rg(s,e=getComputedStyle(document.body).font){if(!s)return 0;const n=document.createElement("canvas").getContext("2d");return n?(n.font=e,n.measureText(s).width):0}const Dg=6;function _g(s,e=getComputedStyle(document.body).font){return s?s.split(/\n|&nbsp;/).map(r=>{const o=ol(r),i=cl(e,o),c=il(r);let l=Rg(c,i);return al(r)&&(l+=Dg),l}).reduce((r,o)=>Math.max(r,o),0):0}function Og(s){const e=s.trimStart();return e.startsWith("### ")?1.2:e.startsWith("## ")?1.35:e.startsWith("# ")?1.5:1}function al(s){const e=s.trimStart();return!!(e.startsWith("- ")||/^\d+\.\s/.test(e))}function ol(s){const e=s.trimStart();return e.startsWith("### ")?1.125:e.startsWith("## ")?1.25:e.startsWith("# ")?1.5:1}function il(s){const e=s.trimStart(),t=s.length-e.length,n=s.substring(0,t);if(e.startsWith("### "))return n+e.slice(4);if(e.startsWith("## "))return n+e.slice(3);if(e.startsWith("# ")||e.startsWith("> ")||e.startsWith("- "))return n+e.slice(2);const r=e.match(/^(\d+)\.\s/);return r?n+e.slice(r[0].length):s}function cl(s,e){if(e===1)return s;const t=s.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/);if(!t)return s;const n=parseFloat(t[1]),r=t[2],o=n*e;return s.replace(t[0],`${o}${r}`)}function Vn(s,e,t=getComputedStyle(document.body).font,n){if(!s)return 0;const o=document.createElement("canvas").getContext("2d");if(!o)return 0;o.font=t;const i=t.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/),l=(i?parseFloat(i[1]):16)*1.5,d=n??l;if(d===0)return console.warn("measureWrappedTextHeight: Could not determine line height. Using fallback."),s.split(`
`).length*16;const p=s.split(`
`);let u=0,f=!1,m=!1,g=!0;for(const v of p){if(v.trim()===""){u+=d,m=!1,g=!1;continue}const b=al(v);b&&!m&&!g&&(u+=d),m=b,g=!1;const w=Og(v);w>1&&(f=!0);const y=d*w,j=ol(v),S=cl(t,j);o.font=S;const N=il(v).split(" ");let O="",R=1;for(let k=0;k<N.length;k++){const A=N[k],L=O+(O?" ":"")+A;o.measureText(L).width>e&&O!==""?(R++,O=A,o.measureText(A).width>e):O=L}u+=R*y}let x=u+(f?Pm:0);return x+=Rm,x}function Lg(s,e){if(!s)return 0;const{containerWidth:t,textarea:n,fontSize:r,skipPaddingSubtraction:o=!1}=e,i=n||document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(!i)return Vn(s,t);const c=window.getComputedStyle(i),l=r??`${it.FONT_SIZE_DEFAULT}px`,d=c.fontFamily,u=`${c.fontWeight} ${l} ${d}`,m=Ba(l).lineHeight;let g=t;if(!o){const b=_m(l).horizontal*2;g=t-b}return Vn(s,g,u,m)}function Mg(s,e,t){const n=Fg(t),r=Lg(s,{containerWidth:e,fontSize:n,skipPaddingSubtraction:!0}),i=Ba(n).padding*2;return r+i}function Fg(s){var e;return(e=s==null?void 0:s.styles)==null?void 0:e.fontSize}const{DEFAULT_NODE_WIDTH:Kn,DEFAULT_NODE_HEIGHT:Jn}=it,vs=s=>{const e=s.x,t=s.y,n=s.width??Kn,r=s.height??Jn;return{x1:e,y1:t,x2:e+n,y2:t+r}},yC=(s,e,t)=>{const n=t?new Set(t):null;for(let r=e.length-1;r>=0;r--){const o=e[r];if(n&&n.has(o.id))continue;const i=vs(o);if(s.x>=i.x1&&s.x<=i.x2&&s.y>=i.y1&&s.y<=i.y2)return o}return null},Jo=s=>{const e=s.x,t=s.y,n=s.width??Kn,r=s.height??Jn;return{x:e+n/2,y:t+r/2}},SC=(s,e)=>s.x===e.x&&s.y===e.y,$g=()=>{const s=document.querySelector("textarea[data-node-textarea]"),e=document.querySelector(".markdown-textarea[data-node-textarea]"),t=s||e;if(t){const r=window.getComputedStyle(t).lineHeight;if(r&&r!=="normal"){const o=parseFloat(r);if(!isNaN(o))return o}}},Ug=(s,e,t)=>{const n=_g(s)+Dm.textNodeXPadding,r=Mg(s,n,t);return{width:n,height:r}},jC=(s,e)=>{const t=vs(s),n=vs(e);return t.x1>=n.x1&&t.y1>=n.y1&&t.x2<=n.x2&&t.y2<=n.y2},Bg=(s,e)=>{const t=vs(e);return s.filter(n=>{if(n.id===e.id)return!1;const r=vs(n);return!(r.x2<t.x1||r.x1>t.x2||r.y2<t.y1||r.y1>t.y2)})},Wg=(s,e="bottom")=>{if(!s.length)return null;switch(e){case"left":return s.reduce((t,n)=>n.x<t.x?n:t,s[0]);case"right":return s.reduce((t,n)=>n.x+(n.width??Kn)>t.x+(t.width??Kn)?n:t,s[0]);case"top":return s.reduce((t,n)=>n.y<t.y?n:t,s[0]);case"bottom":return s.reduce((t,n)=>n.y+(n.height??Jn)>t.y+(t.height??Jn)?n:t,s[0]);default:return null}},Os=s=>(e,t)=>{s(n=>{if(!n.state)return n;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return n;const c=i.coreState,l=c.nodes.findIndex(g=>g.id===e);if(l===-1)return n;const d=new Date().toISOString(),p={...t,updatedAt:d},u=[...c.nodes];u[l]={...u[l],...p};const m=c.selectedNodes.some(g=>g.id===e)?c.selectedNodes.map(g=>g.id===e?{...g,...p}:g):c.selectedNodes;return window.__nodes=u,window.__selectedNodes=m,{...n,state:{...n.state,projects:{...n.state.projects,[n.state.activeProjectId]:{...r,lastModified:Date.now(),workspaces:{...r.workspaces,[r.activeWorkspaceId]:{...o,lastModified:Date.now(),canvases:{...o.canvases,[o.activeCanvasId]:{...i,coreState:{...c,nodes:u,selectedNodes:m},lastModified:Date.now()}}}}}}}}})},zg=(s,e)=>s(t=>({uiState:{...t.uiState,mode:e}})),Hg=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:e}})),Gg=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:t.uiState.zoomSubMode==="zoom:lock"?"zoom":"zoom:lock"}})),qg=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:e}})),Vg=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:t.uiState.writeSubMode===Pn.AUDIO?Pn.WRITE:Pn.AUDIO}})),Kg=(s,e)=>s(t=>({uiState:{...t.uiState,arrowSubMode:e}})),Jg=s=>s(e=>({uiState:{...e.uiState,arrowSubMode:e.uiState.arrowSubMode===Rn.STAY?Rn.DEFAULT:Rn.STAY}})),Yg=(s,e)=>s(()=>({mousePosition:e})),Xg=(s,e)=>s(t=>({uiState:{...t.uiState,isPanning:e}})),Qg=(s,e)=>s(t=>({uiState:{...t.uiState,isHoldSelectActive:e}})),Zg=(s,e)=>s(t=>({uiState:{...t.uiState,holdSelectProgress:e}})),ex=(s,e)=>s(t=>({uiState:{...t.uiState,selectionBox:e}})),tx=(s,e)=>s(t=>({uiState:{...t.uiState,pendingSelectionStart:e}})),sx=(s,e)=>s(t=>({uiState:{...t.uiState,writeModeStartPosition:e}})),nx=(s,e)=>s(t=>({uiState:{...t.uiState,dragInfo:e}})),rx=(s,e)=>s(t=>({uiState:{...t.uiState,groupDragInfo:e}})),ax=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetGroupId:e}})),ox=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetVocabNodeId:e}})),ix=s=>s(e=>({uiState:{...e.uiState,dragVersion:(e.uiState.dragVersion??0)+1}})),cx=(s,e)=>s(t=>({uiState:{...t.uiState,tableDropTarget:e}})),lx=(s,e)=>s(t=>({uiState:{...t.uiState,resizingNode:e}})),dx=(s,e)=>s(t=>({uiState:{...t.uiState,resizingGroup:e}})),ux=(s,e)=>s(t=>({uiState:{...t.uiState,nodeToFocusId:e}})),px=(s,e)=>{var n;if(!e)return;const t=s().projectCanvas.getActive();return(n=t==null?void 0:t.coreState.nodes)==null?void 0:n.find(r=>r.id===e)},hx=(s,e)=>s(t=>({uiState:{...t.uiState,addNodeType:e}})),fx=(s,e,t=!1)=>s(n=>({uiState:{...n.uiState,activeChatNodeId:e,activeChatNodePinned:t}})),mx=(s,e)=>s(t=>({uiState:{...t.uiState,chatNodeHoldToDrag:e}})),gx=(s,e)=>s(t=>({uiState:{...t.uiState,nodeHoldToResize:e}})),xx=(s,e,t)=>s(n=>({uiState:{...n.uiState,canvasWidth:e,canvasHeight:t}})),vx=(s,e)=>s(t=>({uiState:e(t.uiState)})),bx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{if(n.nodes.length>0&&e.length===0)return console.trace("NOOO should not happend"),n;const r=typeof e=="function"?e(n.nodes):e;return{...n,nodes:r}}),{})),wx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=Array.isArray(e)?e:[],o=new Set(r.map(l=>l.id)),i=n.nodes.map(l=>({...l,isEditing:!1})),c=i.filter(l=>o.has(l.id));return{...n,nodes:i,selectedNodes:c}}),{})),yx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.selectedNodes.filter(i=>i.id!==e),o=n.nodes.map(i=>i.id===e?{...i,isEditing:!1}:i);return{...n,nodes:o,selectedNodes:r}}),{})),Sx=(s,e,t,n={dontOverlap:!1,dontSelect:!1})=>s(r=>(r.setActiveCanvasCoreState(o=>{var v;const i=new Date().toISOString(),c=o.activeLayerId,l=o.layers??[],d=l.find(b=>b.id===c);let p;if(d&&!d.isLocked)p=c??void 0;else if(l.length>0){const b=l.find(w=>!w.isLocked);p=(b==null?void 0:b.id)??((v=l[0])==null?void 0:v.id)}const u={...e,createdAt:e.createdAt??i,updatedAt:i,...p?{layerId:p}:{}};t!==void 0&&(u.content=t);const f=o.nodes;if(n.dontOverlap){const b=Bg(f,e);if(b.length>0){const w=Wg(b,"right");if(w){const y=w.x+(w.width??0);u.x=y+it.nodeSpacing}}}let m;if(!u.groupId&&u.type!==Ke.GROUP){const b=f.filter(j=>j.type===Ke.GROUP),w=vs(u),y=b.find(j=>{const S=vs(j),C=w.x1+(w.x2-w.x1)/2,N=w.y1+(w.y2-w.y1)/2;return C>=S.x1&&C<=S.x2&&N>=S.y1&&N<=S.y2});y&&(u.groupId=y.id,m=y.id)}let g=[...f,u];m&&(g=g.map(b=>{if(b.id===m){const w=b.data??{},y=w.childNodeIds??[];return{...b,data:{...w,childNodeIds:[...y,u.id]},updatedAt:i}}return b}));const x=n.dontSelect?o.selectedNodes:[u];return{...o,nodes:g,selectedNodes:x,selectedArrows:n.dontSelect?o.selectedArrows:[]}}),{})),jx=(s,e)=>s(t=>({state:e(t.state)})),Cx=s=>(e,t)=>Os(s)(e,{content:t}),Nx=s=>(e,t)=>Os(s)(e,{subContent:t}),kx=s=>(e,t)=>Os(s)(e,{title:t}),Ex=s=>(e,t)=>Os(s)(e,{...t}),Ix=s=>{var t;const e=s().projectCanvas.getActive();return(t=e==null?void 0:e.coreState.nodes)==null?void 0:t.find(n=>n.isEditing)},Tx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.nodes.find(d=>d.id===e),o=new Set([e]);if((r==null?void 0:r.type)===Ke.CHAT){const d=r.data;d!=null&&d.childNodeIds&&d.childNodeIds.forEach(p=>o.add(p))}const i=n.nodes.filter(d=>!o.has(d.id)),c=n.selectedNodes.filter(d=>!o.has(d.id)),l=n.arrows.filter(d=>(d.startNodeId===null||!o.has(d.startNodeId))&&(d.endNodeId===null||!o.has(d.endNodeId)));return{...n,nodes:i,selectedNodes:c,arrows:l}}),t.uiState.nodeToFocusId===e&&s(n=>({uiState:{...n.uiState,nodeToFocusId:null}})),{})),Ax=s=>s(e=>(e.setActiveCanvasCoreState(t=>({...t,nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]})),{})),Px=(s,e)=>s(t=>({flags:e(t.flags)})),Rx=s=>s(Wa),Dx=s=>s(e=>({uiState:{...e.uiState,isOverlayVisible:!e.uiState.isOverlayVisible}})),_x=s=>s(e=>({uiState:{...e.uiState,useCurvedArrows:!e.uiState.useCurvedArrows}})),Ox=(s,e)=>s(t=>({uiState:{...t.uiState,customNodeDropdownOpen:e}})),Lx=(s,e)=>s(t=>({uiState:{...t.uiState,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[],...t.uiState.nodeUpdateSettings||{},...e}}})),Mx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:e.sort((n,r)=>n-r)}})),Fx=(s,e)=>s(t=>{const n=t.uiState.zoomMarks||[];return n.includes(e)?t:{uiState:{...t.uiState,zoomMarks:[...n,e].sort((r,o)=>r-o)}}}),$x=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:(t.uiState.zoomMarks||[]).filter(n=>n!==e)}})),Ux=(s,e)=>s(t=>({uiState:{...t.uiState,activeGlobalOverlay:e}})),Bx=(s,e)=>s(t=>({uiState:{...t.uiState,arrangeSnapshot:e}})),Wx=s=>s(Z(e=>{const t=e.uiState.arrangeSnapshot;if(!t||!e.state)return;const n=e.state.activeProjectId?e.state.projects[e.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(o){for(const[i,c]of Object.entries(t.nodePositions)){const l=o.coreState.nodes.find(d=>d.id===i);l&&(l.x=c.x,l.y=c.y,c.width!==void 0&&(l.width=c.width),c.height!==void 0&&(l.height=c.height),l.updatedAt=new Date().toISOString())}o.coreState.selectedNodes=o.coreState.selectedNodes.map(i=>{const c=t.nodePositions[i.id];return c?{...i,x:c.x,y:c.y,width:c.width??i.width,height:c.height??i.height,updatedAt:new Date().toISOString()}:i}),e.uiState.arrangeSnapshot=null}})),zx=s=>s(e=>({uiState:{...e.uiState,arrangeSnapshot:null}})),Hx=(s,e)=>{s(t=>{if(!t.state)return t;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!o)return t;const i=e(o.viewState);if(i===o.viewState)return t;const c=Date.now();return{...t,state:{...t.state,projects:{...t.state.projects,[t.state.activeProjectId]:{...n,lastModified:c,workspaces:{...n.workspaces,[n.activeWorkspaceId]:{...r,lastModified:c,canvases:{...r.canvases,[r.activeCanvasId]:{...o,viewState:i,lastModified:c}}}}}}}}})},Gx=(s,e)=>s(Z(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;o&&(o.coreState=e(o.coreState),o.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now()))})),qx=s=>{s.forEach(e=>localStorage.removeItem(e)),window.location.reload()},Vx=s=>e=>{s(Z(t=>{var l;if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!((l=o==null?void 0:o.coreState)!=null&&l.nodes))return;const i=new Date().toISOString();let c=null;o.coreState.nodes=o.coreState.nodes.map(d=>{const p=e.find(m=>m.id===d.id);if(!p)return d;let u=!1,f=!1;for(const m in p)if(p[m]!==d[m]){u=!0,(m==="x"||m==="y")&&(f=!0);break}return u&&f&&(c=d.id),u?{...d,...p,updatedAt:i}:d}),c&&(t.uiState.lastUpdatedNodeId=c),o.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now())}),!1)},Kx=s=>(e,t)=>{Os(s)(e,{styles:t})};function Jx(){return Math.random().toString(36).substring(2,9)}let ll=0;function CC(){let s=Date.now().toString(25);return s+=ll++,`${Jx()}-${s}`}function Yx(){let s=Date.now().toString(25);return s+="_"+ll++,s}const Xx=/^c-(\d+_)?(.+)$/;function dl(s){const e=Xx.exec(s),t=Yx();return e?`${e[1]?`c-${parseInt(e[1],10)+1}_`:"c-1_"}${e[2]}`+t:`c-${s}`+t}const Qx=s=>s(e=>(e.setActiveCanvasCoreState(t=>{const r=t.selectedNodes.map(o=>{const i=o.height??it.DEFAULT_NODE_HEIGHT,c=o.y+i+it.nodeSpacing,l=dl(o.id);return{...o,id:l,y:c,x:o.x+it.nodeSpacing}});return{...t,nodes:[...t.nodes,...r],selectedNodes:r}}),{})),Zx=(s,e)=>({getNodeById:t=>t?px(s,t):void 0,setNodes:t=>bx(e,t),setSelectedNodes:t=>wx(e,t),unselectNodeById:t=>yx(e,t),addNode:(t,n,r)=>{var o;if(Sx(e,t,n,r),!(r!=null&&r.skipUndo)){const i=(o=s().projectCanvas.getActive())==null?void 0:o.coreState.nodes.find(c=>c.id===t.id);i&&s().undo.commit({type:"node:create",node:i})}},duplicateNodes:()=>Qx(e),updateNode:(t,n)=>Os(e)(t,n),updateNodes:t=>Vx(e)(t),updateNodeGeometry:(t,n)=>Ex(e)(t,n),updateNodeContent:(t,n)=>Cx(e)(t,n),updateNodeSubContent:(t,n)=>Nx(e)(t,n),updateNodeTitle:(t,n)=>kx(e)(t,n),updateNodeStyles:(t,n)=>Kx(e)(t,n),getEditingNode:()=>Ix(s),setActiveCanvasCoreState:t=>Gx(e,t),setState:t=>jx(e,t)}),ev=(s,e)=>{const t=e().projectCanvas.getActive();if(!t)return;const n=t.coreState.selectedNodes;if(n.length===0)return;const r=new Set(n.map(d=>d.id));for(const d of n)if(d.type===Ke.CHAT){const p=d.data;p!=null&&p.childNodeIds&&p.childNodeIds.forEach(u=>r.add(u))}const o=r,i=t.coreState.nodes.filter(d=>o.has(d.id)),c=t.coreState.arrows.filter(d=>d.startNodeId&&o.has(d.startNodeId)||d.endNodeId&&o.has(d.endNodeId)),l=new Map;for(const d of c){if(d.startNodeId&&o.has(d.startNodeId)){const p=l.get(d.startNodeId)||[];p.push(d),l.set(d.startNodeId,p)}if(d.endNodeId&&o.has(d.endNodeId)){const p=l.get(d.endNodeId)||[];p.includes(d)||p.push(d),l.set(d.endNodeId,p)}}if(s(d=>(d.setActiveCanvasCoreState(p=>{const u=p.nodes.filter(m=>!o.has(m.id)),f=p.arrows.filter(m=>!(m.startNodeId&&o.has(m.startNodeId)||m.endNodeId&&o.has(m.endNodeId)));return{...p,nodes:u,arrows:f,selectedNodes:[]}}),{})),i.length===1)e().undo.commit({type:"node:delete",node:i[0],connectedArrows:l.get(i[0].id)||[]});else if(i.length>1){const d=i.map(p=>({type:"node:delete",node:p,connectedArrows:l.get(p.id)||[]}));e().undo.commit({type:"batch",label:`Delete ${i.length} nodes`,operations:d})}},tv=(s,e)=>{s(t=>{const n=t.projectCanvas.getActive();if(!n)return{};const r=new Set(n.coreState.selectedArrows.map(o=>o.id));return r.size===0?{}:(t.setActiveCanvasCoreState(o=>{const i=o.arrows.filter(c=>!r.has(c.id));return{...o,arrows:i,selectedArrows:[]}}),{})})},sv=(s,e)=>({deleteSelectedNodes:()=>ev(e,s),deleteSelectedArrows:()=>tv(e),deleteNodeById:t=>{const n=s().projectCanvas.getActive(),r=n==null?void 0:n.coreState.nodes.find(i=>i.id===t),o=n==null?void 0:n.coreState.arrows.filter(i=>i.startNodeId===t||i.endNodeId===t);Tx(e,t),r&&s().undo.commit({type:"node:delete",node:r,connectedArrows:o||[]})},deleteAll:()=>Ax(e)});var us=(s=>(s.FREEHAND="draw:freehand",s.RECTANGLE="draw:rectangle",s.SQUARE="draw:square",s.CIRCLE="draw:circle",s.ELLIPSE="draw:ellipse",s.LINE="draw:line",s.ARROW="draw:arrow",s))(us||{});const ul={strokeColor:"currentColor",strokeWidth:2,strokeStyle:"solid",opacity:1},NC=2,kC=20,nv=(s,e)=>s(t=>({uiState:{...t.uiState,drawSubMode:e}})),rv=s=>s(e=>{const t=e.uiState.drawSubMode??us.FREEHAND,n=[us.FREEHAND,us.RECTANGLE,us.CIRCLE,us.LINE],o=(n.indexOf(t)+1)%n.length;return{uiState:{...e.uiState,drawSubMode:n[o]}}}),av=(s,e)=>s(t=>({uiState:{...t.uiState,temporaryDrawing:e}})),ov=(s,e)=>s(t=>({uiState:{...t.uiState,drawStyle:{...t.uiState.drawStyle??ul,...e}}})),iv=s=>s().uiState.drawSubMode??us.FREEHAND,cv=s=>s().uiState.temporaryDrawing??null,lv=s=>s().uiState.drawStyle??ul,dv=(s,e)=>s(t=>({uiState:{...t.uiState,drawAxisLock:e}})),uv=s=>s().uiState.drawAxisLock??"none",pv=(s,e)=>({setMode:t=>zg(e,t),setZoomSubMode:t=>Hg(e,t),toggleZoomSubMode:()=>Gg(e),setWriteSubMode:t=>qg(e,t),toggleWriteSubMode:()=>Vg(e),setArrowSubMode:t=>Kg(e,t),toggleArrowSubMode:()=>Jg(e),setDrawSubMode:t=>nv(e,t),toggleDrawSubMode:()=>rv(e),setTemporaryDrawing:t=>av(e,t),setDrawStyle:t=>ov(e,t),getDrawSubMode:()=>iv(s),getTemporaryDrawing:()=>cv(s),getDrawStyle:()=>lv(s),setDrawAxisLock:t=>dv(e,t),getDrawAxisLock:()=>uv(s),setActiveCanvasViewState:t=>Hx(e,t),setIsPanning:t=>Xg(e,t),setIsHoldSelectActive:t=>Qg(e,t),setHoldSelectProgress:t=>Zg(e,t),setSelectionBox:t=>ex(e,t),setPendingSelectionStart:t=>tx(e,t),setWriteModeStartPosition:t=>sx(e,t),setDragInfo:t=>nx(e,t),setGroupDragInfo:t=>rx(e,t),setHoveredDropTargetGroupId:t=>ax(e,t),setHoveredDropTargetVocabNodeId:t=>ox(e,t),incrementDragVersion:()=>ix(e),setTableDropTarget:t=>cx(e,t),setResizingNode:t=>lx(e,t),setResizingGroup:t=>dx(e,t),setNodeToFocusId:t=>ux(e,t),setAddNodeType:t=>hx(e,t),setCanvasDimensions:(t,n)=>xx(e,t,n),toggleOverlayVisibility:()=>Dx(e),toggleCurvedArrows:()=>_x(e),setCustomNodeDropdownOpen:t=>Ox(e,t),setNodeUpdateSettings:t=>Lx(e,t),setZoomMarks:t=>Mx(e,t),addZoomMark:t=>Fx(e,t),removeZoomMark:t=>$x(e,t),setUiState:t=>vx(e,t),setArrangeSnapshot:t=>Bx(e,t),revertArrangeSnapshot:()=>Wx(e),clearArrangeSnapshot:()=>zx(e),setActiveGlobalOverlay:t=>Ux(e,t),setActiveChatNodeId:(t,n=!1)=>fx(e,t,n),setChatNodeHoldToDrag:t=>mx(e,t),setNodeHoldToResize:t=>gx(e,t)}),da="gz:";async function hv(s){if(!s)return s;const t=new TextEncoder().encode(s),n=new CompressionStream("gzip"),r=n.writable.getWriter();r.write(t),r.close();const o=[],i=n.readable.getReader();for(;;){const{done:u,value:f}=await i.read();if(u)break;o.push(f)}const c=o.reduce((u,f)=>u+f.length,0),l=new Uint8Array(c);let d=0;for(const u of o)l.set(u,d),d+=u.length;const p=Array.from(l,u=>String.fromCharCode(u)).join("");return da+btoa(p)}async function EC(s){if(!s||!s.startsWith(da))return s;const e=s.slice(da.length),t=atob(e),n=Uint8Array.from(t,f=>f.charCodeAt(0)),r=new DecompressionStream("gzip"),o=r.writable.getWriter();o.write(n),o.close();const i=[],c=r.readable.getReader();for(;;){const{done:f,value:m}=await c.read();if(f)break;i.push(m)}const l=i.reduce((f,m)=>f+m.length,0),d=new Uint8Array(l);let p=0;for(const f of i)d.set(f,p),p+=f.length;return new TextDecoder().decode(d)}function Yo(s){return new Blob([s]).size}function Xo(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(2)} MB`}const fv=s=>{if(!(s!=null&&s.projects))return s;const e={};for(const[t,n]of Object.entries(s.projects)){const r={};for(const[o,i]of Object.entries(n.workspaces)){const c={};for(const[l,d]of Object.entries(i.canvases)){const{undoTree:p,...u}=d;c[l]=u}r[o]={...i,canvases:c}}e[t]={...n,workspaces:r}}return{...s,projects:e}},mv=(s,e,t)=>({saveStateToLocalStorage:()=>{const n={version:s().version,dataVersion:s().dataVersion,state:fv(s().state),uiState:s().uiState,flags:s().flags,preferences:s().preferences,extensions:s().extensions,actions:s().actions},{temporaryArrow:r,selectionBox:o,dragInfo:i,resizingNode:c,...l}=n.uiState,d=n.extensions?{registry:n.extensions.registry,settings:n.extensions.settings}:void 0,p={...n,uiState:l,extensions:d},u=JSON.stringify(p);hv(u).then(f=>{const m=Yo(u),g=Yo(f),x=((1-g/m)*100).toFixed(0);localStorage.setItem(e,f),t.log(`Canvas state saved: ${Xo(m)} â†’ ${Xo(g)} (${x}% reduction)`)}).catch(f=>{t.error("Failed to save state to localStorage",f),console.log("Failed to save state to localStorage",f),Ee.error("Save failed",{description:f instanceof Error?f.message:"Failed to save canvas",duration:3e3})})},saveCanvasData:()=>{s().saveStateToLocalStorage(),s().syncToApi()}}),gv="workflow-templates-project",xv=(s,e)=>{var n,r;if(e===null)return Qo(s);const t={...s,...e,uiState:{...s.uiState,...e.uiState||{},temporaryArrow:null,selectionBox:null,dragInfo:null,resizingNode:null},state:{projects:((n=e.state)==null?void 0:n.projects)||((r=s.state)==null?void 0:r.projects)||{},...s.state,...e.state||{}},flags:{...s.flags,...e.flags||{}},preferences:{...s.preferences,...e.preferences||{}},extensions:e.extensions?{registry:e.extensions.registry||{},settings:e.extensions.settings||{}}:s.extensions};return Qo(t)},Qo=s=>{var e;return(e=s.state)!=null&&e.projects&&(s.state.projects[gv]=Qc()),s},vv=s=>{const e=s==null?void 0:s.canvasConfig;e&&(e.arrows&&(e.arrows.type&&($e.arrows.type=e.arrows.type),e.arrows.REVERSE_CURVE!==void 0&&($e.arrows.REVERSE_CURVE=e.arrows.REVERSE_CURVE),e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR!==void 0&&($e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR),e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED!==void 0&&($e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED),e.arrows.CUBIC_HORIZONTAL_BIAS!==void 0&&($e.arrows.CUBIC_HORIZONTAL_BIAS=e.arrows.CUBIC_HORIZONTAL_BIAS),e.arrows.reverseArrowOnMultipleConnect!==void 0&&($e.arrows.reverseArrowOnMultipleConnect=e.arrows.reverseArrowOnMultipleConnect)),e.persistState!==void 0&&($e.persistState=e.persistState),e.autosave!==void 0&&($e.autosave=e.autosave),e.hideOverlay!==void 0&&($e.hideOverlay=e.hideOverlay),e.hideToolbar!==void 0&&($e.hideToolbar=e.hideToolbar),e.nodeOptions&&(e.nodeOptions.maxNodeWidth!==void 0&&($e.nodeOptions.maxNodeWidth=e.nodeOptions.maxNodeWidth),e.nodeOptions.resizeBorderWidth!==void 0&&($e.nodeOptions.resizeBorderWidth=e.nodeOptions.resizeBorderWidth)),e.zoom&&(e.zoom.min!==void 0&&($e.zoom.min=e.zoom.min),e.zoom.max!==void 0&&($e.zoom.max=e.zoom.max),e.zoom.intensity!==void 0&&($e.zoom.intensity=e.zoom.intensity)))};function pl(s){const{undoTree:e,...t}=s;return t}function hl(s){const e={};for(const[t,n]of Object.entries(s.canvases))e[t]=pl(n);return{...s,canvases:e}}function fl(s){const e={};for(const[t,n]of Object.entries(s.workspaces))e[t]=hl(n);return{...s,workspaces:e}}const bv=s=>{var m,g,x;const e=s(),t=e.state;if(!t){console.error("Cannot export: State is not available.");return}const n={};for(const[v,b]of Object.entries(t.projects))n[v]=fl(b);const r={...t,projects:n},o=e.preferences,i={splitPresets:o==null?void 0:o.splitPresets,arrangePresets:o==null?void 0:o.arrangePresets,arrangeConfigFavorites:o==null?void 0:o.arrangeConfigFavorites,pinnedPaletteItems:o==null?void 0:o.pinnedPaletteItems,canvasConfig:o==null?void 0:o.canvasConfig,keepArrowsOnSplit:o==null?void 0:o.keepArrowsOnSplit,keepSplitMatch:o==null?void 0:o.keepSplitMatch,splitHorizontally:o==null?void 0:o.splitHorizontally,splitNodeGap:o==null?void 0:o.splitNodeGap,borderButton:o==null?void 0:o.borderButton,arrowStyleButton:o==null?void 0:o.arrowStyleButton,arrangeButton:o==null?void 0:o.arrangeButton,segmentedButtons:o==null?void 0:o.segmentedButtons,projectsManagerSearch:o==null?void 0:o.projectsManagerSearch,recentCanvases:o==null?void 0:o.recentCanvases,goToSymbolSearch:o==null?void 0:o.goToSymbolSearch,openTabs:o==null?void 0:o.openTabs},c={sequencePresets:(m=e.actions)==null?void 0:m.sequencePresets,history:(g=e.actions)==null?void 0:g.history,historySelection:(x=e.actions)==null?void 0:x.historySelection},l={...r,preferences:i,actions:c},d=JSON.stringify(l,null,2),p=new Blob([d],{type:"application/json"}),u=URL.createObjectURL(p),f=document.createElement("a");f.href=u,f.download=`markop-canvas-export-${new Date().toISOString()}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u)},wv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r,canvasId:o}=e,i=t.projects[n];if(!i){console.error(`Cannot export: Project ${n} not found.`);return}const c=i.workspaces[r];if(!c){console.error(`Cannot export: Workspace ${r} not found.`);return}const l=c.canvases[o];if(!l){console.error(`Cannot export: Canvas ${o} not found.`);return}const d=pl(l),p={...c,canvases:{[o]:d},activeCanvasId:o},u={...i,workspaces:{[r]:p},activeWorkspaceId:r},f={projects:{[n]:u},activeProjectId:n},m=JSON.stringify(f,null,2),g=new Blob([m],{type:"application/json"}),x=URL.createObjectURL(g),v=l.name.replace(/[^a-zA-Z0-9-_]/g,"_"),b=document.createElement("a");b.href=x,b.download=`canvas-${v}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(x)},yv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r}=e,o=t.projects[n];if(!o){console.error(`Cannot export: Project ${n} not found.`);return}const i=o.workspaces[r];if(!i){console.error(`Cannot export: Workspace ${r} not found.`);return}const c=hl(i),l={...o,workspaces:{[r]:c},activeWorkspaceId:r},d={projects:{[n]:l},activeProjectId:n},p=JSON.stringify(d,null,2),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=i.name.replace(/[^a-zA-Z0-9-_]/g,"_"),g=document.createElement("a");g.href=f,g.download=`workspace-${m}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(f)},Sv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n}=e,r=t.projects[n];if(!r){console.error(`Cannot export: Project ${n} not found.`);return}const o=fl(r),i={projects:{[n]:o},activeProjectId:n},c=JSON.stringify(i,null,2),l=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(l),p=r.name.replace(/[^a-zA-Z0-9-_]/g,"_"),u=document.createElement("a");u.href=d,u.download=`project-${p}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d)},jv=(s,e,t={})=>{const{replace:n=!1}=t;try{const r=JSON.parse(e);if((!r||typeof r.projects!="object")&&r.projects!==null)throw new Error("Invalid data format: Missing or invalid 'projects' structure.");const o=r.projects??{};let i=0,c=0;if(n){let l=r.activeProjectId;l&&!o[l]?(console.warn("Imported activeProjectId does not exist in the imported projects. Resetting active project."),l=Object.keys(o)[0]??null):!l&&Object.keys(o).length>0&&(l=Object.keys(o)[0]),i=Object.keys(o).length;const d=r.preferences,p=r.actions;s(u=>{var m,g,x,v,b,w,y,j,S,C,N,O,R,k,A,L,M,I,z,$;const f={...u.preferences,splitPresets:(d==null?void 0:d.splitPresets)??((m=u.preferences)==null?void 0:m.splitPresets),arrangePresets:(d==null?void 0:d.arrangePresets)??((g=u.preferences)==null?void 0:g.arrangePresets),arrangeConfigFavorites:(d==null?void 0:d.arrangeConfigFavorites)??((x=u.preferences)==null?void 0:x.arrangeConfigFavorites),pinnedPaletteItems:(d==null?void 0:d.pinnedPaletteItems)??((v=u.preferences)==null?void 0:v.pinnedPaletteItems),canvasConfig:(d==null?void 0:d.canvasConfig)??((b=u.preferences)==null?void 0:b.canvasConfig),keepArrowsOnSplit:(d==null?void 0:d.keepArrowsOnSplit)??((w=u.preferences)==null?void 0:w.keepArrowsOnSplit),keepSplitMatch:(d==null?void 0:d.keepSplitMatch)??((y=u.preferences)==null?void 0:y.keepSplitMatch),splitHorizontally:(d==null?void 0:d.splitHorizontally)??((j=u.preferences)==null?void 0:j.splitHorizontally),splitNodeGap:(d==null?void 0:d.splitNodeGap)??((S=u.preferences)==null?void 0:S.splitNodeGap),borderButton:(d==null?void 0:d.borderButton)??((C=u.preferences)==null?void 0:C.borderButton),arrowStyleButton:(d==null?void 0:d.arrowStyleButton)??((N=u.preferences)==null?void 0:N.arrowStyleButton),arrangeButton:(d==null?void 0:d.arrangeButton)??((O=u.preferences)==null?void 0:O.arrangeButton),segmentedButtons:(d==null?void 0:d.segmentedButtons)??((R=u.preferences)==null?void 0:R.segmentedButtons),projectsManagerSearch:(d==null?void 0:d.projectsManagerSearch)??((k=u.preferences)==null?void 0:k.projectsManagerSearch),recentCanvases:(d==null?void 0:d.recentCanvases)??((A=u.preferences)==null?void 0:A.recentCanvases),goToSymbolSearch:(d==null?void 0:d.goToSymbolSearch)??((L=u.preferences)==null?void 0:L.goToSymbolSearch),openTabs:(d==null?void 0:d.openTabs)??((M=u.preferences)==null?void 0:M.openTabs)};return{...u,state:{projects:o,activeProjectId:l??null,nodes:void 0,arrows:void 0,selectedArrows:void 0},preferences:f,actions:{...u.actions,sequencePresets:(p==null?void 0:p.sequencePresets)??((I=u.actions)==null?void 0:I.sequencePresets),history:(p==null?void 0:p.history)??((z=u.actions)==null?void 0:z.history),historySelection:(p==null?void 0:p.historySelection)??(($=u.actions)==null?void 0:$.historySelection)},uiState:{...u.uiState,dragInfo:null,resizingNode:null,temporaryArrow:null,selectionBox:null,isPanning:!1,nodeToFocusId:null}}}),console.log(`Canvas data replaced: ${i} project(s) imported.`)}else{const l=r.preferences,d=r.actions;s(p=>{var m,g,x,v,b,w,y,j,S,C,N,O,R,k,A,L,M,I,z,$,q;const u=((m=p.state)==null?void 0:m.projects)??{},f={...u};for(const[P,te]of Object.entries(o))u[P]?(c++,console.warn(`Project "${te.name}" (${P}) already exists, skipping.`)):(f[P]=te,i++);return{...p,state:{...p.state,projects:f},...l&&{preferences:{...p.preferences,splitPresets:l.splitPresets??((g=p.preferences)==null?void 0:g.splitPresets),arrangePresets:l.arrangePresets??((x=p.preferences)==null?void 0:x.arrangePresets),arrangeConfigFavorites:l.arrangeConfigFavorites??((v=p.preferences)==null?void 0:v.arrangeConfigFavorites),pinnedPaletteItems:l.pinnedPaletteItems??((b=p.preferences)==null?void 0:b.pinnedPaletteItems),canvasConfig:l.canvasConfig??((w=p.preferences)==null?void 0:w.canvasConfig),keepArrowsOnSplit:l.keepArrowsOnSplit??((y=p.preferences)==null?void 0:y.keepArrowsOnSplit),keepSplitMatch:l.keepSplitMatch??((j=p.preferences)==null?void 0:j.keepSplitMatch),splitHorizontally:l.splitHorizontally??((S=p.preferences)==null?void 0:S.splitHorizontally),splitNodeGap:l.splitNodeGap??((C=p.preferences)==null?void 0:C.splitNodeGap),borderButton:l.borderButton??((N=p.preferences)==null?void 0:N.borderButton),arrowStyleButton:l.arrowStyleButton??((O=p.preferences)==null?void 0:O.arrowStyleButton),arrangeButton:l.arrangeButton??((R=p.preferences)==null?void 0:R.arrangeButton),segmentedButtons:l.segmentedButtons??((k=p.preferences)==null?void 0:k.segmentedButtons),projectsManagerSearch:l.projectsManagerSearch??((A=p.preferences)==null?void 0:A.projectsManagerSearch),recentCanvases:l.recentCanvases??((L=p.preferences)==null?void 0:L.recentCanvases),goToSymbolSearch:l.goToSymbolSearch??((M=p.preferences)==null?void 0:M.goToSymbolSearch),openTabs:l.openTabs??((I=p.preferences)==null?void 0:I.openTabs)}},...d&&{actions:{...p.actions,sequencePresets:d.sequencePresets??((z=p.actions)==null?void 0:z.sequencePresets),history:d.history??(($=p.actions)==null?void 0:$.history),historySelection:d.historySelection??((q=p.actions)==null?void 0:q.historySelection)}}}}),console.log(`Canvas data merged: ${i} project(s) imported, ${c} skipped.`)}return{projectsImported:i,projectsSkipped:c}}catch(r){return console.error("Failed to import canvas project data:",r),{projectsImported:0,projectsSkipped:0}}},Cv=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Date().toISOString(),u=d.map(f=>({...f,id:dl(f.id),createdAt:p,updatedAt:p,isSelected:!1,isEditing:!1}));s(Z(f=>{var g,x,v,b,w,y;const m=(y=(w=(b=(v=(x=(g=f.state)==null?void 0:g.projects)==null?void 0:x[r])==null?void 0:v.workspaces)==null?void 0:b[o])==null?void 0:w.canvases)==null?void 0:y[i];m!=null&&m.coreState&&(m.coreState.nodes.push(...u),m.lastModified=Date.now())}))},Nv=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Set(n),u=new Date().toISOString();s(Z(f=>{var j,S,C,N,O,R,k,A,L,M,I;const m=(j=f.state)==null?void 0:j.activeProjectId;if(!m)return;const g=(C=(S=f.state)==null?void 0:S.projects)==null?void 0:C[m];if(!g)return;const x=g.activeWorkspaceId;if(!x)return;const v=(N=g.workspaces)==null?void 0:N[x];if(!v)return;const b=v.activeCanvasId;if(!b)return;const w=(O=v.canvases)==null?void 0:O[b];w!=null&&w.coreState&&(w.coreState.nodes=w.coreState.nodes.filter(z=>!p.has(z.id)),w.coreState.selectedNodes=[],w.coreState.arrows=w.coreState.arrows.filter(z=>!(z.startNodeId&&p.has(z.startNodeId)||z.endNodeId&&p.has(z.endNodeId))),w.lastModified=Date.now());const y=(I=(M=(L=(A=(k=(R=f.state)==null?void 0:R.projects)==null?void 0:k[r])==null?void 0:A.workspaces)==null?void 0:L[o])==null?void 0:M.canvases)==null?void 0:I[i];if(y!=null&&y.coreState){const z=d.map($=>({...$,updatedAt:u,isSelected:!1,isEditing:!1}));y.coreState.nodes.push(...z),y.lastModified=Date.now()}}))},kv=(s,e)=>({exportCanvasData:()=>bv(s),exportSingleCanvas:t=>wv(s)(t),exportSingleWorkspace:t=>yv(s)(t),exportSingleProject:t=>Sv(s)(t),importCanvasData:(t,n)=>jv(e,t,n),copyNodesToCanvas:t=>Cv(e,s,t),moveNodesToCanvas:t=>Nv(e,s,t)}),Ev=(s,e,t)=>{const n=Ue(10),r=Date.now(),o=Ue(10),i={id:o,name:"Default Canvas",createdAt:r,lastModified:r,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},c=Ue(10),l={id:c,name:"Default Workspace",createdAt:r,lastModified:r,canvases:{[o]:i},activeCanvasId:o},d={id:n,name:t||"New Project",createdAt:r,lastModified:r,workspaces:{[c]:l},activeWorkspaceId:c};return s(Z(p=>{p.state||(p.state={projects:{},activeProjectId:null}),p.state.projects[n]=d,p.state.activeProjectId=n})),n},Iv=(s,e,t)=>{s(Z(n=>{var r;(r=n.state)!=null&&r.projects[t]?n.state.activeProjectId=t:console.warn(`Project with ID ${t} not found.`)}))},Tv=(s,e,t)=>{s(Z(n=>{var r;if((r=n.state)!=null&&r.projects[t]&&(delete n.state.projects[t],n.state.activeProjectId===t)){const o=Object.keys(n.state.projects);n.state.activeProjectId=o.length>0?o[0]:null}}))},Av=(s,e,t,n)=>{s(Z(r=>{var i;const o=(i=r.state)==null?void 0:i.projects[t];o&&(n.name!==void 0&&(o.name=n.name),n.hideFromSearch!==void 0&&(o.hideFromSearch=n.hideFromSearch),o.lastModified=n.lastModified??Date.now())}))},ml=s=>{const e=s().state;if(!e)return null;const{projects:t,activeProjectId:n}=e;return n?t[n]??null:null},Pv=(s,e)=>({create:t=>Ev(s,e,t),switch:t=>Iv(s,e,t),delete:t=>Tv(s,e,t),updateMetadata:(t,n)=>Av(s,e,t,n),getActive:()=>ml(e)}),Rv=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId;if(!n)return null;const r=Ue(10),o=Date.now(),i=Ue(10),c={id:i,name:"Default Canvas",createdAt:o,lastModified:o,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},l={id:r,name:t||"New Workspace",createdAt:o,lastModified:o,canvases:{[i]:c},activeCanvasId:i};return s(Z(p=>{var f;const u=(f=p.state)==null?void 0:f.projects[n];u&&(u.workspaces[r]=l,u.activeWorkspaceId=r,u.lastModified=o)})),r},Dv=(s,e,t)=>{s(Z(n=>{var o;const r=(o=n.state)!=null&&o.activeProjectId?n.state.projects[n.state.activeProjectId]:null;r&&r.workspaces[t]?(r.activeWorkspaceId=t,r.lastModified=Date.now()):console.warn(`Workspace with ID ${t} not found in active project.`)}))},_v=(s,e,t)=>{s(Z(n=>{var o;const r=(o=n.state)!=null&&o.activeProjectId?n.state.projects[n.state.activeProjectId]:null;if(r&&r.workspaces[t]&&(delete r.workspaces[t],r.lastModified=Date.now(),r.activeWorkspaceId===t)){const i=Object.keys(r.workspaces);r.activeWorkspaceId=i.length>0?i[0]:null}}))},Ov=(s,e,t,n)=>{s(Z(r=>{var c;const o=(c=r.state)!=null&&c.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o?o.workspaces[t]:null;if(i){n.name!==void 0&&(i.name=n.name),n.hideFromSearch!==void 0&&(i.hideFromSearch=n.hideFromSearch);const l=n.lastModified??Date.now();i.lastModified=l,o&&(o.lastModified=l)}}))},qa=s=>{const e=ml(s);return e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]??null:null},Lv=(s,e)=>({create:t=>Rv(s,e,t),switch:t=>Dv(s,e,t),delete:t=>_v(s,e,t),updateMetadata:(t,n)=>Ov(s,e,t,n),getActive:()=>qa(e)}),Mv={CanvasStateV2:!1,useSelectionHandler:!1,useArrowDrawingV2:!1,useDrawingV2:!1,useCanvasKeyboardEventsV2:!1,useCanvasMouseEventsV2:!1,WriteModeHandlerV2:!1},Zo=10,Fv=(s,e)=>{const t=s.replace(/\s*\(\d+\)$/,"");if(!e.includes(t)&&s!==t)return t;const n=new RegExp(`^${$v(t)}\\s*\\((\\d+)\\)$`),r=e.map(c=>{const l=c.match(n);return l?parseInt(l[1],10):0}).filter(c=>c>0),o=e.includes(t);let i=1;return(o||r.length>0)&&(i=Math.max(0,...r)+1),`${t} (${i})`},$v=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Uv=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId,r=qa(e),o=r==null?void 0:r.id;if(!n||!o)return null;const i=Ue(10),c=Date.now(),l={id:i,name:t||"New Canvas",createdAt:c,lastModified:c,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}};return s(Z(p=>{var m;const u=(m=p.state)==null?void 0:m.projects[n],f=u==null?void 0:u.workspaces[o];f&&(f.canvases[i]=l,f.activeCanvasId=i,f.lastModified=c,u&&(u.lastModified=c))})),i},Bv=(s,e,t)=>{s(Z(n=>{if(!n.state)return;let r=null,o=null;for(const[p,u]of Object.entries(n.state.projects)){for(const[f,m]of Object.entries(u.workspaces))if(m.canvases[t]){r=p,o=f;break}if(r)break}if(!r||!o){console.warn(`Canvas with ID ${t} not found in any workspace.`);return}const i=Date.now();n.state.activeProjectId!==r&&(n.state.activeProjectId=r);const c=n.state.projects[r];if(!c)return;c.activeWorkspaceId!==o&&(c.activeWorkspaceId=o);const l=c.workspaces[o];if(!l)return;l.activeCanvasId=t,l.lastModified=i,c.lastModified=i;const d=l.canvases[t];if(d){n.preferences||(n.preferences={}),n.preferences.recentCanvases||(n.preferences.recentCanvases=[]);const p={projectId:r,workspaceId:o,canvasId:t,canvasName:d.name,projectName:c.name,workspaceName:l.name,visitedAt:i};if(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(f=>f.canvasId!==t),n.preferences.recentCanvases.unshift(p),n.preferences.recentCanvases.length>Zo&&(n.preferences.recentCanvases=n.preferences.recentCanvases.slice(0,Zo)),n.preferences.openTabs||(n.preferences.openTabs=[]),!n.preferences.openTabs.some(f=>f.canvasId===t)){const f={canvasId:t,projectId:r,workspaceId:o};n.preferences.openTabs.push(f)}}}))},Wv=(s,e,t)=>{s(Z(n=>{var i,c;const r=(i=n.state)!=null&&i.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null;if(o&&o.canvases[t]){delete o.canvases[t];const l=Date.now();if(o.lastModified=l,r&&(r.lastModified=l),o.activeCanvasId===t){const d=Object.keys(o.canvases);o.activeCanvasId=d.length>0?d[0]:null}}(c=n.preferences)!=null&&c.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(l=>l.canvasId!==t))}))},zv=(s,e,t,n)=>{s(Z(r=>{var l;const o=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i?i.canvases[t]:null;if(c){n.name!==void 0&&(c.name=n.name),n.hideFromSearch!==void 0&&(c.hideFromSearch=n.hideFromSearch);const d=n.lastModified??Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}}))},Hv=(s,e,t,n,r)=>{const o=e().state;if(!o)return null;const i=o.projects[n];if(!i)return null;const c=i.workspaces[r];if(!c)return null;const l=c.canvases[t];if(!l)return null;const d=Object.values(c.canvases).map(g=>g.name),p=Fv(l.name,d),u=Ue(10),f=Date.now(),m={id:u,name:p,createdAt:f,lastModified:f,coreState:{nodes:l.coreState.nodes.map(g=>({...g})),arrows:l.coreState.arrows.map(g=>({...g})),selectedNodes:[],selectedArrows:[],layers:(l.coreState.layers??[]).map(g=>({...g})),activeLayerId:l.coreState.activeLayerId??null},viewState:{offset:{...l.viewState.offset},scale:l.viewState.scale}};return s(Z(g=>{var b;const x=(b=g.state)==null?void 0:b.projects[n],v=x==null?void 0:x.workspaces[r];v&&(v.canvases[u]=m,v.activeCanvasId=u,v.lastModified=f,x&&(x.lastModified=f))})),u},Gv=(s,e,t)=>{s(Z(n=>{var r;(r=n.preferences)!=null&&r.recentCanvases&&(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(o=>o.canvasId!==t))}))},qv=s=>{const e=qa(s),t=e&&e.activeCanvasId?e.canvases[e.activeCanvasId]??null:null;return window.activeCanvas=t,t},Vv=(s,e)=>({create:t=>Uv(s,e,t),switch:t=>Bv(s,e,t),delete:t=>Wv(s,e,t),duplicate:(t,n,r)=>Hv(s,e,t,n,r),updateMetadata:(t,n)=>zv(s,e,t,n),getActive:()=>qv(e),removeRecentCanvas:t=>Gv(s,e,t)});class Kv{constructor(e,t=!1){ee(this,"enabled");ee(this,"name");this.name=e,this.enabled=t}setEnabled(e){this.enabled=e}formatMessage(e){return[`[${this.name}]`,...e]}log(...e){this.enabled&&console.log(...this.formatMessage(e))}warn(...e){this.enabled&&console.warn(...this.formatMessage(e))}error(...e){this.enabled&&console.error(...this.formatMessage(e))}}const Jv=(s,e,t,n)=>{const r=t/2-s.x*e,o=n/2-s.y*e;return{x:r,y:o}},Yv=(s,e)=>{const t=e.find(i=>i.id===s.startNodeId),n=e.find(i=>i.id===s.endNodeId),r=t?Jo(t):s.startPoint,o=n?Jo(n):s.endPoint;return{x:(r.x+o.x)/2,y:(r.y+o.y)/2}},Xv=(s,e,t,n=500)=>{const{uiState:r,projectCanvas:o,setActiveCanvasViewState:i}=e(),c=o.getActive();if(!c){console.warn("Cannot center view: No active canvas.");return}const l=c.coreState.arrows,d=c.coreState.nodes,p=c.viewState.scale,u=r==null?void 0:r.canvasWidth,f=r==null?void 0:r.canvasHeight,m=typeof t=="string"?l==null?void 0:l.find(v=>v.id===t):t;if(!m){console.warn("Cannot center view: Arrow not found.");return}if(!u||!f){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=Yv(m,d),x=Jv(g,p,u,f);i(v=>({...v,targetView:{targetOffset:x,targetScale:p,animationStartTime:performance.now(),animationDuration:n}}))},Sn=20,ei=40;function Qv(s){if(s.length===0)return{x:0,y:0,width:100,height:100};let e=1/0,t=1/0,n=-1/0,r=-1/0;return s.forEach(o=>{e=Math.min(e,o.x),t=Math.min(t,o.y),n=Math.max(n,o.x+(o.width??100)),r=Math.max(r,o.y+(o.height??50))}),{x:e-Sn,y:t-Sn-ei,width:n-e+Sn*2,height:r-t+Sn*2+ei}}function Ls(s){return s.type===Ke.GROUP}function Va(s){if(Ls(s))return s.data}const Zv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const o=r.coreState.selectedNodes;if(o.length<2)return null;const i=Ue(10),c=Qv(o),l=o.map(m=>m.id),d=r.coreState.nodes.filter(Ls),p=t||`Group ${d.length+1}`,u=new Date().toISOString(),f={id:i,type:Ke.GROUP,x:c.x,y:c.y,width:c.width,height:c.height,title:p,data:{childNodeIds:l},createdAt:u,updatedAt:u};return s(Z(m=>{if(!m.state)return;const g=m.state.activeProjectId?m.state.projects[m.state.activeProjectId]:null,x=g&&g.activeWorkspaceId?g.workspaces[g.activeWorkspaceId]:null,v=x&&x.activeCanvasId?x.canvases[x.activeCanvasId]:null;if(!v)return;v.coreState.nodes.push(f),v.coreState.nodes=v.coreState.nodes.map(w=>l.includes(w.id)?{...w,groupId:i}:w),v.coreState.selectedNodes=[f];const b=Date.now();v.lastModified=b,x&&(x.lastModified=b),g&&(g.lastModified=b)})),i},eb=(s,e,t)=>{s(Z(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return;const c=i.coreState.nodes.findIndex(m=>m.id===t&&Ls(m));if(c===-1)return;const l=i.coreState.nodes[c],d=Va(l),p=(d==null?void 0:d.childNodeIds)??[];i.coreState.nodes=i.coreState.nodes.map(m=>{if(m.groupId===t){const{groupId:g,...x}=m;return x}return m});const u=i.coreState.nodes.filter(m=>p.includes(m.id));i.coreState.nodes.splice(c,1),i.coreState.selectedNodes=u;const f=Date.now();i.lastModified=f,o&&(o.lastModified=f),r&&(r.lastModified=f)}))},tb=(s,e,t,n)=>{var c;const r=e().getNodeById(t),o=r==null?void 0:r.data,i=(c=o==null?void 0:o.automation)==null?void 0:c.onEnter;if(s(Z(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=u.coreState.nodes.findIndex(b=>b.id===t&&Ls(b));if(f===-1)return;const m=u.coreState.nodes[f],g=Va(m)??{childNodeIds:[]},x=new Set([...g.childNodeIds,...n]);g.childNodeIds=Array.from(x),m.data=g,u.coreState.nodes=u.coreState.nodes.map(b=>n.includes(b.id)?{...b,groupId:t}:b),m.updatedAt=new Date().toISOString();const v=Date.now();u.lastModified=v,p&&(p.lastModified=v),d&&(d.lastModified=v)})),i!=null&&i.enabled&&i.tags.length>0)for(const l of n)for(const d of i.tags)e().addTagToNode(l,{id:Ue(8),title:d})},sb=(s,e,t)=>{var r;const n=new Map;for(const o of t){const i=e().getNodeById(o);if(i!=null&&i.groupId){const c=e().getNodeById(i.groupId),l=c==null?void 0:c.data,d=(r=l==null?void 0:l.automation)==null?void 0:r.onLeave;d!=null&&d.enabled&&d.tags.length>0&&n.set(o,{groupId:i.groupId,onLeaveTags:d.tags})}}s(Z(o=>{if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=new Set;l.coreState.nodes.forEach(u=>{t.includes(u.id)&&u.groupId&&d.add(u.groupId)}),l.coreState.nodes=l.coreState.nodes.map(u=>{if(t.includes(u.id)&&u.groupId){const{groupId:f,...m}=u;return m}return u}),d.forEach(u=>{const f=l.coreState.nodes.findIndex(x=>x.id===u&&Ls(x));if(f===-1)return;const m=l.coreState.nodes[f],g=Va(m);g&&(g.childNodeIds=g.childNodeIds.filter(x=>!t.includes(x)),m.data=g,m.updatedAt=new Date().toISOString())});const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}));for(const[o,{onLeaveTags:i}]of n){const c=e().getNodeById(o);if(c!=null&&c.tags)for(const l of i){const d=c.tags.find(p=>p.title===l);d&&e().removeTagFromNode(o,d.id)}}},nb=(s,e,t)=>{s(Z(n=>{n.uiState.activeGroupId=t}))},rb=(s,e)=>{const t=s().projectCanvas.getActive();return t?t.coreState.nodes.find(r=>r.id===e&&Ls(r))??null:null},ab=(s,e)=>({createFromSelected:t=>Zv(s,e,t),ungroup:t=>eb(s,e,t),addNodesToGroup:(t,n)=>tb(s,e,t,n),removeNodesFromGroup:t=>sb(s,e,t),setActiveGroupId:t=>nb(s,e,t),getById:t=>rb(e,t)}),ob=33,ti=24;function gl(s){return s===Ke.TABLE}function xl(s){const e=s;return!(e!=null&&e.columns)||!Array.isArray(e.columns)?null:e}const ib=(s,e,t,n,r)=>{let o=!1;return s(Z(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=d.coreState.nodes.findIndex(S=>S.id===t&&gl(S.type));if(p===-1)return;const u=d.coreState.nodes[p],f=xl(u.data);if(!f)return;const m={id:`row-${Date.now()}`};f.columns.forEach(S=>{m[S.key]=S.key===n?r:""}),f.rows.push(m),u.data=f,u.updatedAt=new Date().toISOString();const g=f.columns.find(S=>S.key===n);let x=150;if(g!=null&&g.width){const S=parseInt(g.width,10);isNaN(S)||(x=S)}const v=x-ti,b=Vn(r,v),w=Math.max(ob,b+ti),y=u.height??250;u.height=y+w;const j=Date.now();d.lastModified=j,l&&(l.lastModified=j),c&&(c.lastModified=j),o=!0})),o},cb=(s,e,t,n,r,o)=>{let i=!1;return s(Z(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;if(!p)return;const u=p.coreState.nodes.findIndex(v=>v.id===t&&gl(v.type));if(u===-1)return;const f=p.coreState.nodes[u],m=xl(f.data);if(!m)return;const g=m.rows.findIndex(v=>v.id===n);if(g===-1)return;m.rows[g][r]=o,f.data=m,f.updatedAt=new Date().toISOString();const x=Date.now();p.lastModified=x,d&&(d.lastModified=x),l&&(l.lastModified=x),i=!0})),i},lb=(s,e)=>({addRowFromDrop:(t,n,r)=>ib(s,e,t,n,r),updateCellFromDrop:(t,n,r,o)=>cb(s,e,t,n,r,o)}),fs="default-layer",db="Layer 1";function ub(s=fs,e=db){const t=new Date().toISOString();return{id:s,name:e,order:0,isVisible:!0,opacity:100,isLocked:!1,createdAt:t,updatedAt:t}}function vl(s){return[...s].sort((e,t)=>e.order-t.order)}function Ka(s){return s.length===0?-1:Math.max(...s.map(e=>e.order))}function Yn(s){return s.length===0?[ub()]:s}const pb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const o=Yn(r.coreState.layers??[]),i=Ka(o),c=Ue(10),l=t||`Layer ${o.length+1}`,d=new Date().toISOString(),p={id:c,name:l,order:i+1,isVisible:!0,opacity:100,isLocked:!1,createdAt:d,updatedAt:d};return s(Z(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=Yn(g.coreState.layers??[]),g.coreState.layers.push(p),g.coreState.activeLayerId=c;const x=Date.now();g.lastModified=x,m&&(m.lastModified=x),f&&(f.lastModified=x)})),c},hb=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||(r.coreState.layers??[]).length<=1||s(Z(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=vl(d.coreState.layers??[]),u=p.findIndex(g=>g.id===t);if(u===-1)return;let f;u>0?f=p[u-1].id:p.length>1&&(f=p[1].id),f&&(d.coreState.nodes=d.coreState.nodes.map(g=>(g.layerId??fs)===t?{...g,layerId:f}:g)),d.coreState.layers=d.coreState.layers.filter(g=>g.id!==t),d.coreState.activeLayerId===t&&(d.coreState.activeLayerId=f??null);const m=Date.now();d.lastModified=m,l&&(l.lastModified=m),c&&(c.lastModified=m)}))},fb=(s,e,t,n)=>{s(Z(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.name=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},mb=(s,e,t,n)=>{s(Z(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isVisible=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},gb=(s,e,t,n)=>{const r=Math.max(0,Math.min(100,n));s(Z(o=>{var u;if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=(u=l.coreState.layers)==null?void 0:u.find(f=>f.id===t);if(!d)return;d.opacity=r,d.updatedAt=new Date().toISOString();const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}))},xb=(s,e,t,n)=>{s(Z(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isLocked=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},vb=(s,e,t,n)=>{s(Z(r=>{var u,f;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(u=c.coreState.layers)==null?void 0:u.find(m=>m.id===t);if(!l)return;const d=l.order;l.order=n,(f=c.coreState.layers)==null||f.forEach(m=>{m.id!==t&&(n>d?m.order>d&&m.order<=n&&m.order--:m.order>=n&&m.order<d&&m.order++)}),l.updatedAt=new Date().toISOString();const p=Date.now();c.lastModified=p,i&&(i.lastModified=p),o&&(o.lastModified=p)}))},bb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(d=>d.id===t);if(!i)return;const c=Ka(o);if(i.order>=c)return;const l=o.find(d=>d.order===i.order+1);l&&s(Z(d=>{var b,w;if(!d.state)return;const p=d.state.activeProjectId?d.state.projects[d.state.activeProjectId]:null,u=p&&p.activeWorkspaceId?p.workspaces[p.activeWorkspaceId]:null,f=u&&u.activeCanvasId?u.canvases[u.activeCanvasId]:null;if(!f)return;const m=(b=f.coreState.layers)==null?void 0:b.find(y=>y.id===t),g=(w=f.coreState.layers)==null?void 0:w.find(y=>y.id===l.id);if(!m||!g)return;const x=new Date().toISOString();g.order=m.order,m.order=m.order+1,m.updatedAt=x,g.updatedAt=x;const v=Date.now();f.lastModified=v,u&&(u.lastModified=v),p&&(p.lastModified=v)}))},wb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(l=>l.id===t);if(!i||i.order<=0)return;const c=o.find(l=>l.order===i.order-1);c&&s(Z(l=>{var v,b;if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=(v=u.coreState.layers)==null?void 0:v.find(w=>w.id===t),m=(b=u.coreState.layers)==null?void 0:b.find(w=>w.id===c.id);if(!f||!m)return;const g=new Date().toISOString();m.order=f.order,f.order=f.order-1,f.updatedAt=g,m.updatedAt=g;const x=Date.now();u.lastModified=x,p&&(p.lastModified=x),d&&(d.lastModified=x)}))},yb=(s,e,t)=>{s(Z(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return;i.coreState.activeLayerId=t;const c=Date.now();i.lastModified=c,o&&(o.lastModified=c),r&&(r.lastModified=c)}))},Sb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;let o=r.coreState.layers??[];if(o.length===0&&t===fs){const u=Ue(10),f=new Date().toISOString(),m={id:u,name:"Layer 1 (Copy)",order:1,isVisible:!0,opacity:100,isLocked:!1,createdAt:f,updatedAt:f};return s(Z(g=>{if(!g.state)return;const x=g.state.activeProjectId?g.state.projects[g.state.activeProjectId]:null,v=x&&x.activeWorkspaceId?x.workspaces[x.activeWorkspaceId]:null,b=v&&v.activeCanvasId?v.canvases[v.activeCanvasId]:null;if(!b)return;b.coreState.layers=Yn(b.coreState.layers??[]),b.coreState.layers.push(m);const y=b.coreState.nodes.filter(S=>!S.layerId||S.layerId===fs).map(S=>({...S,id:Ue(10),layerId:u,createdAt:f,updatedAt:f}));b.coreState.nodes=[...b.coreState.nodes,...y],b.coreState.activeLayerId=u;const j=Date.now();b.lastModified=j,v&&(v.lastModified=j),x&&(x.lastModified=j)})),u}const i=o.find(u=>u.id===t);if(!i)return null;const c=Ka(o),l=Ue(10),d=new Date().toISOString(),p={id:l,name:`${i.name} (Copy)`,order:c+1,isVisible:i.isVisible,opacity:i.opacity,isLocked:!1,createdAt:d,updatedAt:d};return s(Z(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=Yn(g.coreState.layers??[]),g.coreState.layers.push(p);const v=g.coreState.nodes.filter(w=>(w.layerId??fs)===t).map(w=>({...w,id:Ue(10),layerId:l,createdAt:d,updatedAt:d}));g.coreState.nodes=[...g.coreState.nodes,...v],g.coreState.activeLayerId=l;const b=Date.now();g.lastModified=b,m&&(m.lastModified=b),f&&(f.lastModified=b)})),l},jb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(l=>l.id===t);if(!i)return;const c=o.find(l=>l.order===i.order-1);c&&s(Z(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;u.coreState.nodes=u.coreState.nodes.map(m=>(m.layerId??fs)===t?{...m,layerId:c.id}:m),u.coreState.layers=u.coreState.layers.filter(m=>m.id!==t),u.coreState.layers.forEach(m=>{m.order>i.order&&m.order--}),u.coreState.activeLayerId===t&&(u.coreState.activeLayerId=c.id);const f=Date.now();u.lastModified=f,p&&(p.lastModified=f),d&&(d.lastModified=f)}))},Cb=(s,e,t,n)=>{s(Z(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c||!((p=c.coreState.layers)==null?void 0:p.find(u=>u.id===n))&&n!==fs)return;c.coreState.nodes=c.coreState.nodes.map(u=>t.includes(u.id)?{...u,layerId:n}:u);const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},Nb=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.coreState.layers)==null?void 0:n.find(r=>r.id===e))??null:null},kb=s=>{const e=s().projectCanvas.getActive();return e?vl(e.coreState.layers??[]):[]},Eb=s=>{var n;const e=s().projectCanvas.getActive();if(!e)return null;const t=e.coreState.activeLayerId;return t?((n=e.coreState.layers)==null?void 0:n.find(r=>r.id===t))??null:null},Ib=(s,e)=>({create:t=>pb(s,e,t),delete:t=>hb(s,e,t),rename:(t,n)=>fb(s,e,t,n),duplicate:t=>Sb(s,e,t),setVisibility:(t,n)=>mb(s,e,t,n),setOpacity:(t,n)=>gb(s,e,t,n),setLocked:(t,n)=>xb(s,e,t,n),reorder:(t,n)=>vb(s,e,t,n),moveUp:t=>bb(s,e,t),moveDown:t=>wb(s,e,t),setActive:t=>yb(s,e,t),mergeDown:t=>jb(s,e,t),moveNodesToLayer:(t,n)=>Cb(s,e,t,n),getById:t=>Nb(e,t),getAll:()=>kb(e),getActive:()=>Eb(e)});function Tb(s,e,t){const n=new Date().toISOString();return{id:s,name:e,nodePositions:[],groupNodes:[],filterConfig:t,createdAt:n,updatedAt:n}}function At(s){if(!s.state)return{project:null,workspace:null,canvas:null};const e=s.state.activeProjectId?s.state.projects[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]:null,n=t&&t.activeCanvasId?t.canvases[t.activeCanvasId]:null;return{project:e,workspace:t,canvas:n}}function Pt(s,e,t){const n=Date.now();s&&(s.lastModified=n),e&&(e.lastModified=n),t&&(t.lastModified=n)}const Ab=(s,e,t,n)=>{const o=e().projectCanvas.getActive();if(!o)return null;const i=Ue(10),c=Tb(i,t,n);return c.nodePositions=o.coreState.nodes.map(l=>({nodeId:l.id,x:l.x,y:l.y})),s(Z(l=>{const{project:d,workspace:p,canvas:u}=At(l);u&&(u.viewLayers||(u.viewLayers=[]),u.viewLayers.push(c),u.activeViewLayerId=i,Pt(u,p,d))})),i},Pb=(s,e,t)=>{e().projectCanvas.getActive()&&s(Z(o=>{const{project:i,workspace:c,canvas:l}=At(o);!l||!l.viewLayers||(l.viewLayers=l.viewLayers.filter(d=>d.id!==t),l.activeViewLayerId===t&&(l.activeViewLayerId=null),Pt(l,c,i))}))},Rb=(s,e,t,n)=>{s(Z(r=>{const{project:o,workspace:i,canvas:c}=At(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.name=n,l.updatedAt=new Date().toISOString(),Pt(c,i,o))}))},Db=(s,e,t)=>{var d;const r=e().projectCanvas.getActive();if(!r)return null;const o=(d=r.viewLayers)==null?void 0:d.find(p=>p.id===t);if(!o)return null;const i=Ue(10),c=new Date().toISOString(),l={...o,id:i,name:`${o.name} (Copy)`,nodePositions:[...o.nodePositions],groupNodes:o.groupNodes.map(p=>({...p,id:Ue(10)})),createdAt:c,updatedAt:c};return s(Z(p=>{const{project:u,workspace:f,canvas:m}=At(p);m&&(m.viewLayers||(m.viewLayers=[]),m.viewLayers.push(l),m.activeViewLayerId=i,Pt(m,f,u))})),i},_b=(s,e,t)=>{s(Z(n=>{const{project:r,workspace:o,canvas:i}=At(n);i&&(i.activeViewLayerId=t,Pt(i,o,r))}))},Ob=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(Z(c=>{const{project:l,workspace:d,canvas:p}=At(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;const f=u.nodePositions.find(m=>m.nodeId===t);f?(f.x=n,f.y=r):u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Pt(p,d,l)}))},Lb=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||!r.activeViewLayerId||s(Z(o=>{const{project:i,workspace:c,canvas:l}=At(o);if(!l||!l.viewLayers||!l.activeViewLayerId)return;const d=l.viewLayers.find(u=>u.id===l.activeViewLayerId);if(!d)return;const p=new Map(d.nodePositions.map((u,f)=>[u.nodeId,f]));for(const u of t){const f=p.get(u.id);f!==void 0?(d.nodePositions[f].x=u.x,d.nodePositions[f].y=u.y):d.nodePositions.push({nodeId:u.id,x:u.x,y:u.y})}d.updatedAt=new Date().toISOString(),Pt(l,c,i)}))},Mb=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(Z(c=>{const{project:l,workspace:d,canvas:p}=At(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;u.nodePositions.some(m=>m.nodeId===t)||(u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Pt(p,d,l))}))},Fb=(s,e,t)=>{s(Z(n=>{const{project:r,workspace:o,canvas:i}=At(n);if(!i||!i.viewLayers)return;let c=!1;for(const l of i.viewLayers){const d=l.nodePositions.length;l.nodePositions=l.nodePositions.filter(p=>p.nodeId!==t);for(const p of l.groupNodes)p.childNodeIds=p.childNodeIds.filter(u=>u!==t);l.nodePositions.length!==d&&(l.updatedAt=new Date().toISOString(),c=!0)}c&&Pt(i,o,r)}))},$b=(s,e,t,n)=>{s(Z(r=>{const{project:o,workspace:i,canvas:c}=At(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes.push(n),l.updatedAt=new Date().toISOString(),Pt(c,i,o))}))},Ub=(s,e,t,n,r)=>{s(Z(o=>{const{project:i,workspace:c,canvas:l}=At(o);if(!l||!l.viewLayers)return;const d=l.viewLayers.find(u=>u.id===t);if(!d)return;const p=d.groupNodes.find(u=>u.id===n);p&&(Object.assign(p,r),d.updatedAt=new Date().toISOString(),Pt(l,c,i))}))},Bb=(s,e,t,n)=>{s(Z(r=>{const{project:o,workspace:i,canvas:c}=At(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes=l.groupNodes.filter(d=>d.id!==n),l.updatedAt=new Date().toISOString(),Pt(c,i,o))}))},Wb=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.viewLayers)==null?void 0:n.find(r=>r.id===e))??null:null},zb=s=>{const e=s().projectCanvas.getActive();return e?e.viewLayers??[]:[]},Hb=s=>{var t;const e=s().projectCanvas.getActive();return!e||!e.activeViewLayerId?null:((t=e.viewLayers)==null?void 0:t.find(n=>n.id===e.activeViewLayerId))??null},Gb=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.activeViewLayerId)??null},qb=(s,e)=>{const t=s().projectCanvas.getActive();return(t==null?void 0:t.activeViewLayerId)===e},Vb=(s,e)=>{var o;const t=s().projectCanvas.getActive();if(!t||!t.activeViewLayerId)return null;const n=(o=t.viewLayers)==null?void 0:o.find(i=>i.id===t.activeViewLayerId);if(!n)return null;const r=n.nodePositions.find(i=>i.nodeId===e);return r?{x:r.x,y:r.y}:null},Kb=s=>{var c;const e=s().projectCanvas.getActive();if(!e)return[];const t=e.coreState.nodes;if(!e.activeViewLayerId)return t;const n=(c=e.viewLayers)==null?void 0:c.find(l=>l.id===e.activeViewLayerId);if(!n)return t;const r=new Map(n.nodePositions.map(l=>[l.nodeId,l])),o=t.map(l=>{const d=r.get(l.id);return d?{...l,x:d.x,y:d.y}:l}),i=n.groupNodes.map(l=>({id:l.id,type:Ke.GROUP,x:l.x,y:l.y,width:l.width,height:l.height,content:l.name,data:{childNodeIds:l.childNodeIds}}));return[...o,...i]},Jb=(s,e)=>({create:(t,n)=>Ab(s,e,t,n),delete:t=>Pb(s,e,t),rename:(t,n)=>Rb(s,e,t,n),duplicate:t=>Db(s,e,t),setActive:t=>_b(s,e,t),updateNodePosition:(t,n,r)=>Ob(s,e,t,n,r),updateNodePositions:t=>Lb(s,e,t),addNodeToActiveView:(t,n,r)=>Mb(s,e,t,n,r),removeNodeFromAllViews:t=>Fb(s,e,t),addGroupNode:(t,n)=>$b(s,e,t,n),updateGroupNode:(t,n,r)=>Ub(s,e,t,n,r),removeGroupNode:(t,n)=>Bb(s,e,t,n),getById:t=>Wb(e,t),getAll:()=>zb(e),getActive:()=>Hb(e),getActiveId:()=>Gb(e),isActive:t=>qb(e,t),getEffectivePosition:t=>Vb(e,t),getNodesWithEffectivePositions:()=>Kb(e)});function Ms(s){return s.extensions||(s.extensions={registry:{},settings:{},runtime:{}}),s.extensions.registry||(s.extensions.registry={}),s.extensions.settings||(s.extensions.settings={}),s.extensions.runtime||(s.extensions.runtime={}),s.extensions}const Yb=(s,e,t,n)=>{s(Z(r=>{const o=Ms(r);o.registry[t]||(o.registry[t]={enabled:!0,installedAt:new Date().toISOString(),version:n})}))},Xb=(s,e,t)=>{s(Z(n=>{var o;const r=Ms(n);delete r.registry[t],delete r.settings[t],(o=r.runtime)==null||delete o[t]}))},Qb=(s,e,t,n)=>{s(Z(r=>{const o=Ms(r);o.registry[t]?o.registry[t].enabled=n:o.registry[t]={enabled:n,installedAt:new Date().toISOString()}}))},Zb=(s,e)=>{var n,r,o;return((o=(r=(n=s().extensions)==null?void 0:n.registry)==null?void 0:r[e])==null?void 0:o.enabled)??!1},ew=(s,e)=>{var n,r;return!!((r=(n=s().extensions)==null?void 0:n.registry)!=null&&r[e])},tw=(s,e)=>{var r,o;return((o=(r=s().extensions)==null?void 0:r.settings)==null?void 0:o[e])??null},sw=(s,e,t,n)=>{s(Z(r=>{const o=Ms(r);o.settings[t]=n}))},nw=(s,e,t,n)=>{s(Z(r=>{const o=Ms(r),i=o.settings[t]??{};o.settings[t]={...i,...n}}))},rw=(s,e)=>{var r,o;return((o=(r=s().extensions)==null?void 0:r.runtime)==null?void 0:o[e])??null},aw=(s,e,t,n)=>{s(Z(r=>{const o=Ms(r);o.runtime||(o.runtime={}),o.runtime[t]=n}))},ow=(s,e)=>({register:(t,n)=>Yb(s,e,t,n),unregister:t=>Xb(s,e,t),setEnabled:(t,n)=>Qb(s,e,t,n),isEnabled:t=>Zb(e,t),isRegistered:t=>ew(e,t),getSettings:t=>tw(e,t),setSettings:(t,n)=>sw(s,e,t,n),updateSettings:(t,n)=>nw(s,e,t,n),getRuntime:t=>rw(e,t),setRuntime:(t,n)=>aw(s,e,t,n)});function mr(){return{nodes:{},current:null,root:null}}function iw(s){switch(s.type){case"node:move":return"Move node";case"node:resize":return"Resize node";case"node:create":return`Create ${s.node.type.toLowerCase()}`;case"node:delete":return`Delete ${s.node.type.toLowerCase()}`;case"node:update":return"Update node";case"batch":return s.label??`Batch (${s.operations.length} ops)`;case"arrow:create":return"Create arrow";case"arrow:delete":return"Delete arrow";case"arrow:update":return"Update arrow";case"tag:add":return"Add tag";case"tag:remove":return"Remove tag"}}function cw(){return`hn_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}class Ja{constructor(e){ee(this,"data");this.data=e??mr()}commit(e){const t=cw(),n={id:t,operation:e,parent:this.data.current,children:[],timestamp:Date.now(),label:iw(e)};if(this.data.nodes[t]=n,this.data.current!==null){const r=this.data.nodes[this.data.current];r&&r.children.push(t)}return this.data.root===null&&(this.data.root=t),this.data.current=t,t}undo(){if(this.data.current===null)return null;const e=this.data.nodes[this.data.current];return e?(this.data.current=e.parent,e.operation):null}redo(e){const t=this.getBranches();if(t.length===0)return null;const n=e??t.length-1,r=t[n];return r?(this.data.current=r.id,r.operation):null}getBranches(){if(this.data.current===null){if(this.data.root!==null){const t=this.data.nodes[this.data.root];return t?[t]:[]}return[]}const e=this.data.nodes[this.data.current];return e?e.children.map(t=>this.data.nodes[t]).filter(t=>t!==void 0):[]}getPath(){const e=[];let t=this.data.current;for(;t!==null;){const n=this.data.nodes[t];if(!n)break;e.unshift(n),t=n.parent}return e}getRedoPath(){const e=[];let t=this.getBranches();for(;t.length>0;){const n=t[t.length-1];e.push(n),t=n.children.map(r=>this.data.nodes[r]).filter(r=>r!==void 0)}return e}jumpTo(e){var u;if(!this.data.nodes[e])return{undo:[],redo:[]};const n=new Set(this.getPath().map(f=>f.id)),r=[];let o=e;for(;o!==null;){const f=this.data.nodes[o];if(!f||(r.unshift(f),n.has(o)))break;o=f.parent}const i=[];let c=this.data.current;const l=((u=r[0])==null?void 0:u.id)??null;for(;c!==null&&c!==l;){const f=this.data.nodes[c];if(!f)break;i.push(f.operation),c=f.parent}const d=[];let p=0;l!==null&&(p=r.findIndex(f=>f.id===l)+1);for(let f=p;f<r.length;f++)d.push(r[f].operation);return this.data.current=e,{undo:i,redo:d}}getCurrent(){return this.data.current===null?null:this.data.nodes[this.data.current]??null}getRoot(){return this.data.root===null?null:this.data.nodes[this.data.root]??null}getSize(){return Object.keys(this.data.nodes).length}canUndo(){return this.data.current!==null}canRedo(){return this.getBranches().length>0}getAllNodes(){return Object.values(this.data.nodes)}serialize(){return structuredClone(this.data)}static deserialize(e){return new Ja(structuredClone(e))}prune(e){if(this.getSize()<=e)return;const n=new Set;this.getPath().forEach(i=>n.add(i.id));const o=this.getAllNodes();o.sort((i,c)=>c.timestamp-i.timestamp);for(const i of o){if(n.size>=e)break;n.add(i.id)}for(const i of Object.keys(this.data.nodes))if(!n.has(i)){const c=this.data.nodes[i];if(c!=null&&c.parent){const l=this.data.nodes[c.parent];l&&(l.children=l.children.filter(d=>d!==i))}if(this.data.root===i){const d=Object.values(this.data.nodes).filter(p=>p.id!==i&&n.has(p.id)).find(p=>p.parent===null||!n.has(p.parent));this.data.root=(d==null?void 0:d.id)??null}delete this.data.nodes[i]}for(const i of Object.values(this.data.nodes))i.children=i.children.filter(c=>this.data.nodes[c]!==void 0)}}function Ya(s,e){switch(e.type){case"node:move":return bl(s,e.nodeId,e.to);case"node:resize":return wl(s,e.nodeId,e.to);case"node:create":return yl(s,e.node);case"node:delete":return Sl(s,e.node.id,e.connectedArrows);case"node:update":return jl(s,e.nodeId,e.to);case"arrow:create":return ua(s,e.arrow);case"arrow:delete":return Cl(s,e.arrow.id);case"arrow:update":return Nl(s,e.arrowId,e.to);case"batch":return e.operations.reduce((t,n)=>Ya(t,n),s);case"tag:add":return kl(s,e.nodeId,e.tag,e.autoGroup);case"tag:remove":return lw(s,e.nodeId,e.tag.id)}}function Xa(s,e){switch(e.type){case"node:move":return bl(s,e.nodeId,e.from);case"node:resize":return wl(s,e.nodeId,e.from);case"node:create":return Sl(s,e.node.id);case"node:delete":let t=yl(s,e.node);if(e.connectedArrows)for(const n of e.connectedArrows)t=ua(t,n);return t;case"node:update":return jl(s,e.nodeId,e.from);case"arrow:create":return Cl(s,e.arrow.id);case"arrow:delete":return ua(s,e.arrow);case"arrow:update":return Nl(s,e.arrowId,e.from);case"batch":return[...e.operations].reverse().reduce((n,r)=>Xa(n,r),s);case"tag:add":return dw(s,e.nodeId,e.tag.id,e.autoGroup);case"tag:remove":return kl(s,e.nodeId,e.tag)}}function bl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,x:t.x,y:t.y}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,x:t.x,y:t.y}:o);return{...s,nodes:n,selectedNodes:r}}function wl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,x:t.x,y:t.y,width:t.width,height:t.height}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,x:t.x,y:t.y,width:t.width,height:t.height}:o);return{...s,nodes:n,selectedNodes:r}}function yl(s,e){return s.nodes.some(t=>t.id===e.id)?s:{...s,nodes:[...s.nodes,e]}}function Sl(s,e,t){const n=s.nodes.filter(c=>c.id!==e),r=s.selectedNodes.filter(c=>c.id!==e),o=s.arrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e),i=s.selectedArrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e);return{...s,nodes:n,arrows:o,selectedNodes:r,selectedArrows:i}}function jl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,...t}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,...t}:o);return{...s,nodes:n,selectedNodes:r}}function ua(s,e){return s.arrows.some(t=>t.id===e.id)?s:{...s,arrows:[...s.arrows,e]}}function Cl(s,e){const t=s.arrows.filter(r=>r.id!==e),n=s.selectedArrows.filter(r=>r.id!==e);return{...s,arrows:t,selectedArrows:n}}function Nl(s,e,t){const n=s.arrows.map(o=>o.id===e?{...o,...t}:o),r=s.selectedArrows.map(o=>o.id===e?{...o,...t}:o);return{...s,arrows:n,selectedArrows:r}}function kl(s,e,t,n){const r=i=>{if(i.id!==e)return i;const c=Array.isArray(i.tags)?i.tags:[];if(c.some(d=>d.id===t.id))return i;let l={...i,tags:[...c,t]};return n&&(l={...l,groupId:n.groupId}),l};let o={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(o=uw(o,n.groupId,e)),o}function lw(s,e,t){const n=r=>r.id!==e||!Array.isArray(r.tags)?r:{...r,tags:r.tags.filter(o=>o.id!==t)};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function dw(s,e,t,n){const r=i=>{if(i.id!==e)return i;let c={...i,tags:Array.isArray(i.tags)?i.tags.filter(l=>l.id!==t):[]};return n&&(c={...c,x:n.previousPosition.x,y:n.previousPosition.y,groupId:n.previousGroupId}),c};let o={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(o=pw(o,n.groupId,e)),o}function uw(s,e,t){const n=r=>{if(r.id!==e)return r;const o=r.data??{childNodeIds:[]},i=o.childNodeIds??[];return i.includes(t)?r:{...r,data:{...o,childNodeIds:[...i,t]}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function pw(s,e,t){const n=r=>{if(r.id!==e)return r;const o=r.data??{childNodeIds:[]},i=o.childNodeIds??[];return{...r,data:{...o,childNodeIds:i.filter(c=>c!==t)}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function si(s,e,t){return{type:"node:move",nodeId:s,from:e,to:t}}function IC(s){return s.length===1?si(s[0].nodeId,s[0].from,s[0].to):{type:"batch",operations:s.map(e=>si(e.nodeId,e.from,e.to)),label:`Move ${s.length} nodes`}}const hw="UndoArchiveDB",fw=2,qe="archived_nodes",Wt="tree_data";class mw{constructor(){ee(this,"db",null);ee(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,t)=>{const n=indexedDB.open(hw,fw);n.onerror=()=>{this.initPromise=null,t(new Error("Failed to open UndoArchiveDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const o=r.target.result;if(!o.objectStoreNames.contains(qe)){const i=o.createObjectStore(qe,{keyPath:"id"});i.createIndex("canvasId","canvasId",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("canvasId_timestamp",["canvasId","timestamp"],{unique:!1})}o.objectStoreNames.contains(Wt)||o.createObjectStore(Wt,{keyPath:"canvasId"})}}),this.initPromise)}async ensureInit(){if(this.db||await this.init(),!this.db)throw new Error("Database not initialized")}async archiveNode(e,t){await this.ensureInit();const n={...t,canvasId:e};return new Promise((r,o)=>{const l=this.db.transaction([qe],"readwrite").objectStore(qe).put(n);l.onsuccess=()=>r(),l.onerror=()=>o(new Error("Failed to archive node"))})}async archiveNodes(e,t){if(t.length!==0)return await this.ensureInit(),new Promise((n,r)=>{const i=this.db.transaction([qe],"readwrite").objectStore(qe);let c=0,l=!1;for(const d of t){const p={...d,canvasId:e},u=i.put(p);u.onsuccess=()=>{c++,c===t.length&&!l&&n()},u.onerror=()=>{l||(l=!0,r(new Error("Failed to archive nodes")))}}})}async getNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([qe],"readonly").objectStore(qe).get(e);i.onsuccess=()=>t(i.result??null),i.onerror=()=>n(new Error("Failed to get archived node"))})}async getNodes(e){return e.length===0?[]:(await this.ensureInit(),new Promise((t,n)=>{const o=this.db.transaction([qe],"readonly").objectStore(qe),i=[];let c=0;for(const l of e){const d=o.get(l);d.onsuccess=()=>{d.result&&i.push(d.result),c++,c===e.length&&t(i)},d.onerror=()=>{c++,c===e.length&&t(i)}}}))}async getAllForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([qe],"readonly").objectStore(qe).index("canvasId").getAll(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to get archived nodes for canvas"))})}async countForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([qe],"readonly").objectStore(qe).index("canvasId").count(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to count archived nodes"))})}async deleteNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([qe],"readwrite").objectStore(qe).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete archived node"))})}async deleteNodes(e){if(e.length!==0)return await this.ensureInit(),new Promise((t,n)=>{const o=this.db.transaction([qe],"readwrite").objectStore(qe);let i=0;for(const c of e){const l=o.delete(c);l.onsuccess=()=>{i++,i===e.length&&t()},l.onerror=()=>{i++,i===e.length&&t()}}})}async clearForCanvas(e){await this.ensureInit();const n=(await this.getAllForCanvas(e)).map(r=>r.id);await this.deleteNodes(n)}async getOldestForCanvas(e,t){return await this.ensureInit(),new Promise((n,r)=>{const c=this.db.transaction([qe],"readonly").objectStore(qe).index("canvasId_timestamp"),l=IDBKeyRange.bound([e,0],[e,1/0]),d=[],p=c.openCursor(l);p.onsuccess=u=>{const f=u.target.result;f&&d.length<t?(d.push(f.value),f.continue()):n(d)},p.onerror=()=>r(new Error("Failed to get oldest archived nodes"))})}async pruneForCanvas(e,t){const n=await this.countForCanvas(e);if(n<=t)return 0;const r=n-t,i=(await this.getOldestForCanvas(e,r)).map(c=>c.id);return await this.deleteNodes(i),i.length}async countAll(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([qe],"readonly").objectStore(qe).count();o.onsuccess=()=>e(o.result),o.onerror=()=>t(new Error("Failed to count all archived nodes"))})}async clearAll(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([qe],"readwrite").objectStore(qe).clear();o.onsuccess=()=>e(),o.onerror=()=>t(new Error("Failed to clear all archived nodes"))})}async saveTreeData(e,t){await this.ensureInit();const n={canvasId:e,treeData:t,lastModified:Date.now()};return new Promise((r,o)=>{const l=this.db.transaction([Wt],"readwrite").objectStore(Wt).put(n);l.onsuccess=()=>r(),l.onerror=()=>o(new Error("Failed to save tree data"))})}async loadTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([Wt],"readonly").objectStore(Wt).get(e);i.onsuccess=()=>{const c=i.result;t((c==null?void 0:c.treeData)??null)},i.onerror=()=>n(new Error("Failed to load tree data"))})}async deleteTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([Wt],"readwrite").objectStore(Wt).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete tree data"))})}async clearAllTreeData(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([Wt],"readwrite").objectStore(Wt).clear();o.onsuccess=()=>e(),o.onerror=()=>t(new Error("Failed to clear all tree data"))})}}const Mt=new mw;function El(){return typeof window>"u"?!1:window.innerWidth<$e.history.tabletBreakpoint}function Il(){const{archiveLimit:s,tabletArchiveLimit:e}=$e.history;return El()?e:s}function Tl(){const{historyLimit:s,tabletHistoryLimit:e}=$e.history;return El()?e:s}function gw(s){const e=new Set;let t=s.current;for(;t!==null;){e.add(t);const n=s.nodes[t];if(!n)break;t=n.parent}return e}async function xw(s,e){const t=Tl(),n=Object.keys(e.nodes).length;if(n<=t)return e;const r=gw(e),o=Object.values(e.nodes);o.sort((f,m)=>f.timestamp-m.timestamp);const i=[],c=n-t;for(const f of o){if(i.length>=c)break;r.has(f.id)||i.push(f)}if(i.length===0)return e;await Mt.archiveNodes(s,i);const l=Il();await Mt.pruneForCanvas(s,l);const d=new Set(i.map(f=>f.id)),p={};for(const[f,m]of Object.entries(e.nodes))d.has(f)||(p[f]={...m,children:m.children.filter(g=>!d.has(g))});let u=e.root;if(u&&d.has(u)){const m=Object.values(p).find(g=>g.parent===null||!p[g.parent]);u=(m==null?void 0:m.id)??null}return{nodes:p,current:e.current,root:u}}function vw(s,e){return!s.nodes[e]}async function bw(s,e,t){const n=await Mt.getNode(t);if(!n)return null;const r=new Set;r.add(t);let o=n;for(;o;){r.add(o.id);for(const d of o.children)r.add(d);if(o.parent){if(e.nodes[o.parent])break;o=await Mt.getNode(o.parent)}else o=null}const i=await Mt.getNodes(Array.from(r)),c={...e.nodes};for(const d of i)if(!c[d.id]){const{canvasId:p,...u}=d;c[d.id]=u}for(const d of i)if(d.parent&&c[d.parent]){const p=c[d.parent];p.children.includes(d.id)||(p.children=[...p.children,d.id])}let l=e.root;if(!l){const d=Object.values(c).find(p=>p.parent===null||!c[p.parent]);l=(d==null?void 0:d.id)??null}return{nodes:c,current:e.current,root:l}}async function ww(s){return{archivedCount:await Mt.countForCanvas(s),archiveLimit:Il(),historyLimit:Tl()}}async function yw(s){await Mt.clearForCanvas(s),await Mt.deleteTreeData(s)}async function Sw(){await Mt.init()}async function Xn(s,e){await Mt.saveTreeData(s,e)}async function jw(s){return Mt.loadTreeData(s)}function Cw(){return window.innerWidth<$e.history.tabletBreakpoint}function Nw(){const{historyLimit:s,tabletHistoryLimit:e}=$e.history;return Cw()?e:s}function Rt(s){const e=s().projectCanvas.getActive();if(!e)return null;const t=e.undoTree??mr();return Ja.deserialize(t)}function ws(s){const e=s().state;if(!e)return null;const t=e.activeProjectId?e.projects[e.activeProjectId]:null,n=t&&t.activeWorkspaceId?t.workspaces[t.activeWorkspaceId]:null;return(n==null?void 0:n.activeCanvasId)??null}function Qa(s,e){s(Z(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;o&&(o.undoTree=e.serialize())}))}const kw=(s,e,t)=>{const n=Rt(e);if(!n)return;n.commit(t),Qa(s,n);const r=ws(e),o=Nw();r&&(async()=>{try{const i=n.serialize();if(await Xn(r,i),n.getSize()>o){const c=await xw(r,i);s(Z(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;u&&u.id===r&&(u.undoTree=c)})),await Xn(r,c)}}catch(i){console.warn("Failed to persist undo history:",i)}})()},Ew=(s,e)=>{const t=Rt(e);if(!t||!t.canUndo())return!1;const n=t.undo();if(!n)return!1;const r=ws(e);return s(Z(o=>{if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;l.coreState=Xa(l.coreState,n),l.undoTree=t.serialize();const d=Date.now();l.lastModified=d,c&&(c.lastModified=d),i&&(i.lastModified=d)})),r&&Xn(r,t.serialize()).catch(o=>{console.warn("Failed to persist undo position:",o)}),!0},Iw=(s,e,t)=>{const n=Rt(e);if(!n||!n.canRedo())return!1;const r=n.redo(t);if(!r)return!1;const o=ws(e);return s(Z(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;d.coreState=Ya(d.coreState,r),d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),o&&Xn(o,n.serialize()).catch(i=>{console.warn("Failed to persist redo position:",i)}),!0},Al=(s,e,t)=>{const n=Rt(e);if(!n)return!1;const{undo:r,redo:o}=n.jumpTo(t);return r.length===0&&o.length===0?(Qa(s,n),!0):(s(Z(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;for(const u of r)d.coreState=Xa(d.coreState,u);for(const u of o)d.coreState=Ya(d.coreState,u);d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),!0)},Tw=async(s,e,t)=>{var o;const n=ws(e);if(!n)return!1;let r=(o=e().projectCanvas.getActive())==null?void 0:o.undoTree;if(r||(r=mr()),vw(r,t)){const i=await bw(n,r,t);if(!i)return!1;s(Z(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;p&&(p.undoTree=i)})),r=i}return Al(s,e,t)},Aw=s=>{const e=Rt(s);return(e==null?void 0:e.canUndo())??!1},Pw=s=>{const e=Rt(s);return(e==null?void 0:e.canRedo())??!1},Rw=s=>{const e=Rt(s);return(e==null?void 0:e.getBranches())??[]},Dw=s=>{const e=Rt(s);return(e==null?void 0:e.getCurrent())??null},_w=s=>{const e=Rt(s);return(e==null?void 0:e.getPath())??[]},Ow=s=>{const e=Rt(s);return(e==null?void 0:e.getRedoPath())??[]},Lw=s=>{const e=Rt(s);return(e==null?void 0:e.getAllNodes())??[]},Mw=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.undoTree)??null},Fw=(s,e)=>{const t=ws(e);s(Z(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;i&&(i.undoTree=mr())})),t&&yw(t).catch(n=>{console.warn("Failed to clear undo archive:",n)})},$w=(s,e,t)=>{const n=Rt(e);n&&(n.prune(t),Qa(s,n))},Uw=async s=>{const e=ws(s);return e?ww(e):null},Bw=async()=>{await Sw()},Ww=async(s,e)=>{const t=ws(e);if(!t)return!1;try{const n=await jw(t);return n?(s(Z(r=>{if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;c&&c.id===t&&(c.undoTree=n)})),!0):!1}catch(n){return console.warn("Failed to load undo history from archive:",n),!1}},zw=(s,e)=>({commit:t=>kw(s,e,t),undo:()=>Ew(s,e),redo:t=>Iw(s,e,t),jumpTo:t=>Al(s,e,t),jumpToAsync:t=>Tw(s,e,t),canUndo:()=>Aw(e),canRedo:()=>Pw(e),getBranches:()=>Rw(e),getCurrent:()=>Dw(e),getPath:()=>_w(e),getRedoPath:()=>Ow(e),getAllNodes:()=>Lw(e),getTreeData:()=>Mw(e),clear:()=>Fw(s,e),prune:t=>$w(s,e,t),getArchiveStats:()=>Uw(e),initArchive:()=>Bw(),loadFromArchive:()=>Ww(s,e)}),Hw=s=>{const e={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse","canvas-tag":"tag"};if(e[s])return e[s];const t=s.split("-");return t.length>=2?t[1]:null},Gw=(s,e,t,n)=>({getSegmentedButtonAction:r=>{var i,c;return((c=(i=s().preferences)==null?void 0:i.segmentedButtons)==null?void 0:c[r])??null},setSegmentedButtonAction:(r,o,i,c)=>{const l=n(),d=(c==null?void 0:c.skipHistoryUpdate)??!1,p=c==null?void 0:c.actionId,u=c==null?void 0:c.params;if(i){const f=i();f&&t.set(l,f)}e(Z(f=>{var v,b,w;if(f.preferences||(f.preferences={segmentedButtons:{}}),f.preferences.segmentedButtons||(f.preferences.segmentedButtons={}),f.preferences.segmentedButtons[r]=o,d){if((b=(v=f.actions)==null?void 0:v.history)!=null&&b.entries){const y=f.actions.history.entries.find(j=>j.source===r&&j.label===o);y&&(y.executorId&&t.delete(y.executorId),y.executorId=l,p&&!y.actionId&&(y.actionId=p),u&&!y.params&&(y.params=u))}return}f.actions||(f.actions={}),f.actions.history||(f.actions.history={entries:[],lastAction:void 0,maxSize:50});const m=f.actions.history.entries,g=m[0];if(g&&g.source===r&&g.label===o)g.executorId&&t.delete(g.executorId),g.executorId=l,g.timestamp=Date.now(),g.actionId=p,g.params=u,f.actions.history.lastAction=g;else{const y={executorId:l,source:r,label:o,timestamp:Date.now(),actionId:p,params:u};for(m.unshift(y);m.length>f.actions.history.maxSize;){const j=m.pop();j!=null&&j.executorId&&t.delete(j.executorId)}f.actions.history.lastAction=y}if((w=f.actions.recording)!=null&&w.isRecording){const y=Hw(r);if(y&&p){const j={id:Ue(8),action:{facadeKey:y,actionId:p,params:u,label:o},delayMs:0};f.actions.recording.capturedSteps.push(j)}}}))},getKeepArrowsOnSplit:()=>{var o;return((o=s().preferences)==null?void 0:o.keepArrowsOnSplit)??!1},setKeepArrowsOnSplit:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.keepArrowsOnSplit=r}))},getKeepSplitMatch:()=>{var o;return((o=s().preferences)==null?void 0:o.keepSplitMatch)??!1},setKeepSplitMatch:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.keepSplitMatch=r}))},getSplitHorizontally:()=>{var o;return((o=s().preferences)==null?void 0:o.splitHorizontally)??!1},setSplitHorizontally:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.splitHorizontally=r}))},getSplitNodeGap:()=>{var o;return((o=s().preferences)==null?void 0:o.splitNodeGap)??it.NEW_NODE_SEGMENT_SPACING},setSplitNodeGap:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.splitNodeGap=r}))},getLastUsedBorder:()=>{var r,o,i,c,l,d;return{lastUsedColor:((o=(r=s().preferences)==null?void 0:r.borderButton)==null?void 0:o.lastUsedColor)??"hsl(var(--primary))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.borderButton)==null?void 0:c.lastUsedWidth)??"1px",lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.borderButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedBorder:(r,o,i)=>{e(Z(c=>{c.preferences||(c.preferences={}),c.preferences.borderButton||(c.preferences.borderButton={}),c.preferences.borderButton.lastUsedColor=r,c.preferences.borderButton.lastUsedWidth=o,c.preferences.borderButton.lastUsedStyle=i}))},getLastUsedArrowStyle:()=>{var r,o,i,c,l,d;return{lastUsedColor:((o=(r=s().preferences)==null?void 0:r.arrowStyleButton)==null?void 0:o.lastUsedColor)??"hsl(var(--muted-light))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.arrowStyleButton)==null?void 0:c.lastUsedWidth)??1,lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.arrowStyleButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedArrowStyle:(r,o,i)=>{e(Z(c=>{c.preferences||(c.preferences={}),c.preferences.arrowStyleButton||(c.preferences.arrowStyleButton={}),c.preferences.arrowStyleButton.lastUsedColor=r,c.preferences.arrowStyleButton.lastUsedWidth=o,c.preferences.arrowStyleButton.lastUsedStyle=i}))},getLastArrangeOption:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.lastArrangeOption)??null},setLastArrangeOption:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.lastArrangeOption=r}))},getSortByLastArrange:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.sortByLastArrange)??!1},setSortByLastArrange:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.sortByLastArrange=r}))},getArrangeNodeGap:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.nodeGap)??$e.arrange.gap},setArrangeNodeGap:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.nodeGap=r}))},getArrangeGridColumns:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.gridColumns)??$e.arrange.gridColumns},setArrangeGridColumns:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.gridColumns=r}))},getArrangeGridRows:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.gridRows)??$e.arrange.gridRows},setArrangeGridRows:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.gridRows=r}))},getCycleRowBuffer:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.cycleRowBuffer)??20},setCycleRowBuffer:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.cycleRowBuffer=r}))},getLastTagTitle:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.tagButton)==null?void 0:o.lastTagTitle)??null},setLastTagTitle:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.tagButton||(o.preferences.tagButton={}),o.preferences.tagButton.lastTagTitle=r}))},getGoToSymbolSearch:()=>{var r;return((r=s().preferences)==null?void 0:r.goToSymbolSearch)??null},setGoToSymbolSearchOptions:r=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.goToSymbolSearch?o.preferences.goToSymbolSearch.options=r:o.preferences.goToSymbolSearch={options:r,searchHistory:[]}}))},addGoToSymbolSearchHistory:r=>{r.trim()&&e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.goToSymbolSearch||(o.preferences.goToSymbolSearch={options:{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"},searchHistory:[]});const i=o.preferences.goToSymbolSearch.searchHistory.filter(c=>c!==r);i.unshift(r),o.preferences.goToSymbolSearch.searchHistory=i.slice(0,20)}))}}),qw=(s,e)=>({getSplitPresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.presets)??[]},getSplitPresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.splitPresets)==null?void 0:r.presets.find(o=>o.id===t)},getSplitPresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.favoriteIds)??[]},getActiveSplitPresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.activePresetId)??null},createSplitPreset:(t,n)=>{const r=Ue(10);return e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.splitPresets||(o.preferences.splitPresets={presets:[],favoriteIds:[]}),o.preferences.splitPresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateSplitPreset:(t,n)=>{e(Z(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n)}))},duplicateSplitPreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.splitPresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const o=`split-preset-${Date.now()}`,i={id:o,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(Z(d=>{d.preferences||(d.preferences={}),d.preferences.splitPresets||(d.preferences.splitPresets={presets:[],favoriteIds:[]}),d.preferences.splitPresets.presets.push(i)})),o},deleteSplitPreset:t=>{e(Z(n=>{var r;(r=n.preferences)!=null&&r.splitPresets&&(n.preferences.splitPresets.presets=n.preferences.splitPresets.presets.filter(o=>o.id!==t),n.preferences.splitPresets.favoriteIds=n.preferences.splitPresets.favoriteIds.filter(o=>o!==t),n.preferences.splitPresets.activePresetId===t&&(n.preferences.splitPresets.activePresetId=void 0))}))},renameSplitPreset:(t,n)=>{e(Z(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);o&&(o.name=n)}))},applySplitPreset:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.splitPresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(Z(c=>{c.preferences||(c.preferences={}),c.preferences.keepArrowsOnSplit=r.config.keepArrowsOnSplit,c.preferences.keepSplitMatch=r.config.keepSplitMatch,c.preferences.splitHorizontally=r.config.splitHorizontally,c.preferences.splitNodeGap=r.config.splitNodeGap,c.preferences.splitPresets||(c.preferences.splitPresets={presets:[],favoriteIds:[]}),c.preferences.splitPresets.activePresetId=t}))},toggleSplitPresetFavorite:t=>{e(Z(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]});const r=n.preferences.splitPresets.favoriteIds.indexOf(t);r===-1?n.preferences.splitPresets.favoriteIds.push(t):n.preferences.splitPresets.favoriteIds.splice(r,1)}))},setActiveSplitPresetId:t=>{e(Z(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]}),n.preferences.splitPresets.activePresetId=t??void 0}))}}),Vw=(s,e)=>({getArrangePresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.presets)??[]},getArrangePresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.arrangePresets)==null?void 0:r.presets.find(o=>o.id===t)},getArrangePresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.favoriteIds)??[]},getActiveArrangePresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.activePresetId)??null},createArrangePreset:(t,n)=>{const r=Ue(10);return e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangePresets||(o.preferences.arrangePresets={presets:[],favoriteIds:[]}),o.preferences.arrangePresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateArrangePreset:(t,n)=>{e(Z(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n)}))},duplicateArrangePreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.arrangePresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const o=`arrange-preset-${Date.now()}`,i={id:o,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(Z(d=>{d.preferences||(d.preferences={}),d.preferences.arrangePresets||(d.preferences.arrangePresets={presets:[],favoriteIds:[]}),d.preferences.arrangePresets.presets.push(i)})),o},deleteArrangePreset:t=>{e(Z(n=>{var r;(r=n.preferences)!=null&&r.arrangePresets&&(n.preferences.arrangePresets.presets=n.preferences.arrangePresets.presets.filter(o=>o.id!==t),n.preferences.arrangePresets.favoriteIds=n.preferences.arrangePresets.favoriteIds.filter(o=>o!==t),n.preferences.arrangePresets.activePresetId===t&&(n.preferences.arrangePresets.activePresetId=void 0))}))},renameArrangePreset:(t,n)=>{e(Z(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&(o.name=n)}))},applyArrangePreset:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.arrangePresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(Z(c=>{c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),c.preferences.arrangeButton.nodeGap=r.config.nodeGap,c.preferences.arrangeButton.gridColumns=r.config.gridColumns,c.preferences.arrangeButton.sortByLastArrange=r.config.sortByLastArrange,c.preferences.arrangePresets||(c.preferences.arrangePresets={presets:[],favoriteIds:[]}),c.preferences.arrangePresets.activePresetId=t}))},toggleArrangePresetFavorite:t=>{e(Z(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]});const r=n.preferences.arrangePresets.favoriteIds.indexOf(t);r===-1?n.preferences.arrangePresets.favoriteIds.push(t):n.preferences.arrangePresets.favoriteIds.splice(r,1)}))},setActiveArrangePresetId:t=>{e(Z(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]}),n.preferences.arrangePresets.activePresetId=t??void 0}))}}),Kw=(s,e)=>({getArrangeConfigFavorites:()=>{var t;return((t=s().preferences)==null?void 0:t.arrangeConfigFavorites)??[]},getArrangeConfigFavoritesByType:t=>{var n;return(((n=s().preferences)==null?void 0:n.arrangeConfigFavorites)??[]).filter(r=>r.type===t)},addArrangeConfigFavorite:(t,n)=>{const r=Ue(10);return e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeConfigFavorites||(o.preferences.arrangeConfigFavorites=[]),o.preferences.arrangeConfigFavorites.some(c=>c.type===t&&c.value===n)||o.preferences.arrangeConfigFavorites.push({id:r,type:t,value:n})})),r},removeArrangeConfigFavorite:t=>{e(Z(n=>{var r;(r=n.preferences)!=null&&r.arrangeConfigFavorites&&(n.preferences.arrangeConfigFavorites=n.preferences.arrangeConfigFavorites.filter(o=>o.id!==t))}))},applyArrangeConfigFavorite:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.arrangeConfigFavorites)==null?void 0:i.find(c=>c.id===t);r&&e(Z(c=>{switch(c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),r.type){case"gap":c.preferences.arrangeButton.nodeGap=r.value;break;case"columns":c.preferences.arrangeButton.gridColumns=r.value;break;case"rows":c.preferences.arrangeButton.gridRows=r.value;break}}))},isArrangeConfigFavorite:(t,n)=>{var r;return(((r=s().preferences)==null?void 0:r.arrangeConfigFavorites)??[]).some(o=>o.type===t&&o.value===n)},toggleArrangeConfigFavorite:(t,n)=>{var c;const r=s(),i=(((c=r.preferences)==null?void 0:c.arrangeConfigFavorites)??[]).find(l=>l.type===t&&l.value===n);i?r.removeArrangeConfigFavorite(i.id):r.addArrangeConfigFavorite(t,n)}}),Jw=(s,e)=>({getPinnedPaletteItems:t=>{var n,r;return((r=(n=s().preferences)==null?void 0:n.pinnedPaletteItems)==null?void 0:r[t])??[]},pinPaletteItem:(t,n)=>{e(Z(r=>{r.preferences||(r.preferences={}),r.preferences.pinnedPaletteItems||(r.preferences.pinnedPaletteItems={}),r.preferences.pinnedPaletteItems[t]||(r.preferences.pinnedPaletteItems[t]=[]),r.preferences.pinnedPaletteItems[t].includes(n)||r.preferences.pinnedPaletteItems[t].push(n)}))},unpinPaletteItem:(t,n)=>{e(Z(r=>{var o,i;(i=(o=r.preferences)==null?void 0:o.pinnedPaletteItems)!=null&&i[t]&&(r.preferences.pinnedPaletteItems[t]=r.preferences.pinnedPaletteItems[t].filter(c=>c!==n))}))},togglePinPaletteItem:(t,n)=>{s().isPaletteItemPinned(t,n)?s().unpinPaletteItem(t,n):s().pinPaletteItem(t,n)},isPaletteItemPinned:(t,n)=>{var r,o,i;return((i=(o=(r=s().preferences)==null?void 0:r.pinnedPaletteItems)==null?void 0:o[t])==null?void 0:i.includes(n))??!1}}),Yw=(s,e)=>({getOpenTabs:()=>{var t;return((t=s().preferences)==null?void 0:t.openTabs)??[]},openTab:(t,n,r)=>{e(Z(o=>{o.preferences||(o.preferences={}),o.preferences.openTabs||(o.preferences.openTabs=[]),o.preferences.openTabs.some(c=>c.canvasId===t)||o.preferences.openTabs.push({canvasId:t,projectId:n,workspaceId:r})}))},closeTab:t=>{var c;const n=((c=s().preferences)==null?void 0:c.openTabs)??[];if(n.length<=1)return;const r=n.findIndex(l=>l.canvasId===t),o=s().projectCanvas.getActive(),i=(o==null?void 0:o.id)===t;if(e(Z(l=>{var d;(d=l.preferences)!=null&&d.openTabs&&(l.preferences.openTabs=l.preferences.openTabs.filter(p=>p.canvasId!==t))})),i){const l=r>=n.length-1?r-1:r,d=n.filter(p=>p.canvasId!==t)[l];d&&s().projectCanvas.switch(d.canvasId)}},closeOtherTabs:t=>{e(Z(n=>{var r;(r=n.preferences)!=null&&r.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(o=>o.canvasId===t))}))},closeTabsToRight:t=>{e(Z(n=>{var o;if(!((o=n.preferences)!=null&&o.openTabs))return;const r=n.preferences.openTabs.findIndex(i=>i.canvasId===t);r!==-1&&(n.preferences.openTabs=n.preferences.openTabs.slice(0,r+1))}))},reorderTabs:t=>{e(Z(n=>{var o;if(!((o=n.preferences)!=null&&o.openTabs))return;const r=new Map(n.preferences.openTabs.map(i=>[i.canvasId,i]));n.preferences.openTabs=t.map(i=>r.get(i)).filter(i=>i!==void 0)}))}}),Xw=(s,e,t,n)=>({getGlobalActionHistory:()=>{var r,o;return((o=(r=s().actions)==null?void 0:r.history)==null?void 0:o.entries)??[]},getGlobalLastAction:()=>{var r,o;return(o=(r=s().actions)==null?void 0:r.history)==null?void 0:o.lastAction},executeGlobalLastAction:()=>{var i,c;const r=(c=(i=s().actions)==null?void 0:i.history)==null?void 0:c.lastAction;if(!r)return!1;if(r.actionId){const l=n.get(r.actionId);if(l)return l(r.params),!0}const o=r.executorId?t.get(r.executorId):void 0;return o?(o(),!0):!1},executeActionById:r=>{const o=t.get(r);return o?(o(),!0):!1},hasExecutor:r=>t.has(r),clearGlobalActionHistory:()=>{var o,i;const r=((i=(o=s().actions)==null?void 0:o.history)==null?void 0:i.entries)??[];for(const c of r)c.executorId&&t.delete(c.executorId);e(Z(c=>{var l;(l=c.actions)!=null&&l.history&&(c.actions.history.entries=[],c.actions.history.lastAction=void 0)}))}}),Qw=(s,e)=>({isRecording:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.isRecording)??!1},startRecording:()=>{e(Z(t=>{t.actions||(t.actions={}),t.actions.recording={isRecording:!0,capturedSteps:[],startedAt:Date.now()}}))},stopRecording:()=>{var n,r;const t=((r=(n=s().actions)==null?void 0:n.recording)==null?void 0:r.capturedSteps)??[];return e(Z(o=>{var i;(i=o.actions)!=null&&i.recording&&(o.actions.recording.isRecording=!1)})),t},cancelRecording:()=>{e(Z(t=>{t.actions&&(t.actions.recording={isRecording:!1,capturedSteps:[]})}))},getRecordingSteps:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.capturedSteps)??[]}}),Zw=(s,e)=>({isHistorySelecting:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.isSelecting)??!1},toggleHistorySelectionMode:()=>{e(Z(t=>{t.actions||(t.actions={}),t.actions.historySelection||(t.actions.historySelection={isSelecting:!1,selectedIds:[]}),t.actions.historySelection.isSelecting=!t.actions.historySelection.isSelecting,t.actions.historySelection.isSelecting||(t.actions.historySelection.selectedIds=[])}))},toggleHistoryItemSelection:t=>{e(Z(n=>{var o;if(!((o=n.actions)!=null&&o.historySelection))return;const r=n.actions.historySelection.selectedIds.indexOf(t);r===-1?n.actions.historySelection.selectedIds.push(t):n.actions.historySelection.selectedIds.splice(r,1)}))},getSelectedHistoryIds:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.selectedIds)??[]},clearHistorySelection:()=>{e(Z(t=>{var n;(n=t.actions)!=null&&n.historySelection&&(t.actions.historySelection.selectedIds=[],t.actions.historySelection.isSelecting=!1)}))}}),ey=(s,e)=>({getSequencePresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.presets)??[]},getSequencePresetById:t=>{var n,r;return(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.presets.find(o=>o.id===t)},createSequencePreset:(t,n)=>{const r=Ue(10);return e(Z(o=>{o.actions||(o.actions={}),o.actions.sequencePresets||(o.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),o.actions.sequencePresets.presets.push({id:r,name:t,steps:n,createdAt:Date.now()})})),r},updateSequencePreset:(t,n)=>{e(Z(r=>{var i,c;const o=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n,{updatedAt:Date.now()})}))},deleteSequencePreset:t=>{e(Z(n=>{var r;(r=n.actions)!=null&&r.sequencePresets&&(n.actions.sequencePresets.presets=n.actions.sequencePresets.presets.filter(o=>o.id!==t),n.actions.sequencePresets.favoriteIds=n.actions.sequencePresets.favoriteIds.filter(o=>o!==t),n.actions.sequencePresets.activePresetId===t&&(n.actions.sequencePresets.activePresetId=void 0))}))},duplicateSequencePreset:t=>{var o,i;const n=(i=(o=s().actions)==null?void 0:o.sequencePresets)==null?void 0:i.presets.find(c=>c.id===t);if(!n)return"";const r=crypto.randomUUID();return e(Z(c=>{c.actions||(c.actions={}),c.actions.sequencePresets||(c.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const l=n.steps.map(d=>({...d,id:crypto.randomUUID()}));c.actions.sequencePresets.presets.push({id:r,name:`${n.name} (copy)`,steps:l,createdAt:Date.now()})})),r},toggleSequencePresetFavorite:t=>{e(Z(n=>{n.actions||(n.actions={}),n.actions.sequencePresets||(n.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const r=n.actions.sequencePresets.favoriteIds.indexOf(t);r===-1?n.actions.sequencePresets.favoriteIds.push(t):n.actions.sequencePresets.favoriteIds.splice(r,1)}))},getSequencePresetFavorites:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.favoriteIds)??[]}}),ty=(s,e)=>({getVisualWorkflowPresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.visualWorkflows)??[]},getVisualWorkflowPresetById:t=>{var n,r,o;return(o=(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.visualWorkflows)==null?void 0:o.find(i=>i.id===t)},createVisualWorkflowPreset:(t,n,r)=>{const o=Ue(10);return e(Z(i=>{i.actions||(i.actions={}),i.actions.sequencePresets||(i.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),i.actions.sequencePresets.visualWorkflows||(i.actions.sequencePresets.visualWorkflows=[]),i.actions.sequencePresets.visualWorkflows.push({id:o,name:t,steps:n,sourceLocation:r,createdAt:Date.now()})})),o},updateVisualWorkflowPreset:(t,n)=>{e(Z(r=>{var i,c,l;const o=(l=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)==null?void 0:l.find(d=>d.id===t);o&&Object.assign(o,n,{updatedAt:Date.now()})}))},deleteVisualWorkflowPreset:t=>{e(Z(n=>{var r,o;(o=(r=n.actions)==null?void 0:r.sequencePresets)!=null&&o.visualWorkflows&&(n.actions.sequencePresets.visualWorkflows=n.actions.sequencePresets.visualWorkflows.filter(i=>i.id!==t))}))}}),sy=(s,e)=>({addTagToNode:(t,n,r)=>{const o=s().getNodeById(t);if(!o)return;const i={x:o.x,y:o.y},c=o.groupId,l=typeof n=="string"?{id:Math.random().toString(36).slice(2,10),title:n}:n,d=Array.isArray(o.tags)?o.tags:[];if(d.some(f=>f.title===l.title))return;s().updateNode(t,{tags:[...d,l]});let u;if(!o.groupId&&o.type!==Ke.GROUP&&(u=s().getNodesByTag(l.title).find(m=>m.type===Ke.GROUP&&m.id!==t),u)){const g=o.width??200,x=o.height??100,v=u.width??400,b=u.height??300,w=u.x+v-g-20,y=u.y+b-x-20;s().updateNode(t,{x:w,y}),s().group.addNodesToGroup(u.id,[t])}r!=null&&r.skipUndo||s().undo.commit({type:"tag:add",nodeId:t,tag:l,autoGroup:u?{groupId:u.id,previousPosition:i,previousGroupId:c}:void 0})},removeTagFromNode:(t,n,r)=>{const o=s().getNodeById(t);if(!o||!Array.isArray(o.tags))return;const i=o.tags.find(c=>c.id===n);s().updateNode(t,{tags:o.tags.filter(c=>c.id!==n)}),!(r!=null&&r.skipUndo)&&i&&s().undo.commit({type:"tag:remove",nodeId:t,tag:i})},getNodesByTag:t=>{const n=s().projectCanvas.getActive();return n?(n.coreState.nodes||[]).filter(o=>Array.isArray(o.tags)&&o.tags.some(i=>i.title===t)):[]},hasTag:(t,n)=>{const r=s().getNodeById(t);return!r||!Array.isArray(r.tags)?!1:r.tags.some(o=>o.title===n)}}),ny=5e3,Us={HEALTH:"/api/canvas/health",STATE:"/api/canvas/state",USER_STATE:"/api/canvas/user"};class Pl{constructor(e="http://localhost:3030",t=ny){ee(this,"baseUrl");ee(this,"timeout");this.baseUrl=e,this.timeout=t}async health(){const e=`${this.baseUrl}${Us.HEALTH}`;try{const t=await this.fetchWithTimeout(e,{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?await t.json():(console.error("[CanvasApiClient] Health check failed:",t.status),{status:"error",timestamp:new Date().toISOString()})}catch(t){return console.error("[CanvasApiClient] Health check error:",t),{status:"error",timestamp:new Date().toISOString()}}}async getState(){const e=`${this.baseUrl}${Us.STATE}`;try{const t=await this.fetchWithTimeout(e,{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?await t.json():(console.error("[CanvasApiClient] Get state failed:",t.status),{success:!1,error:`HTTP ${t.status}`})}catch(t){return console.error("[CanvasApiClient] Get state error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}async saveState(e){const t=`${this.baseUrl}${Us.STATE}`;try{const n=await this.fetchWithTimeout(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return n.ok?await n.json():(console.error("[CanvasApiClient] Save state failed:",n.status),{success:!1,error:`HTTP ${n.status}`})}catch(n){return console.error("[CanvasApiClient] Save state error:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async getUserState(e){const t=`${this.baseUrl}${Us.USER_STATE}/${e}/state`;try{const n=await this.fetchWithTimeout(t,{method:"GET",headers:{"Content-Type":"application/json"}});return n.ok?await n.json():(console.error("[CanvasApiClient] Get user state failed:",n.status),{success:!1,error:`HTTP ${n.status}`})}catch(n){return console.error("[CanvasApiClient] Get user state error:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async saveUserState(e,t){const n=`${this.baseUrl}${Us.USER_STATE}/${e}/state`;try{const r=await this.fetchWithTimeout(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({canvasState:t})});return r.ok?await r.json():(console.error("[CanvasApiClient] Save user state failed:",r.status),{success:!1,error:`HTTP ${r.status}`})}catch(r){return console.error("[CanvasApiClient] Save user state error:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}const pa=new Pl,ry=Object.freeze(Object.defineProperty({__proto__:null,CanvasApiClient:Pl,canvasApiClient:pa},Symbol.toStringTag,{value:"Module"})),Yt="[ApiSync]",ay=s=>{var r,o;const e=s(),t=((r=e.state)==null?void 0:r.projects)??{},n={};for(const[i,c]of Object.entries(t)){const l={};for(const[d,p]of Object.entries(c.workspaces)){const u={};for(const[f,m]of Object.entries(p.canvases)){const{undoTree:g,...x}=m;u[f]=x}l[d]={...p,canvases:u}}n[i]={...c,workspaces:l}}return{projects:n,activeProjectId:((o=e.state)==null?void 0:o.activeProjectId)??null,preferences:e.preferences??{},actions:e.actions??{}}},oy=(s,e)=>{s(Z(t=>{t.state||(t.state={projects:{},activeProjectId:null}),t.state.projects=e.projects,t.state.activeProjectId=e.activeProjectId,t.preferences||(t.preferences={}),Object.assign(t.preferences,e.preferences),t.actions||(t.actions={}),Object.assign(t.actions,e.actions)}))},iy=(s,e)=>({syncToApi:async()=>{var n;if(!(((n=s().preferences)==null?void 0:n.apiSyncEnabled)??!0)){console.log(Yt,"API sync disabled, skipping sync");return}try{const r=ay(s);console.log(Yt,"Syncing state to API..."),(await pa.saveState(r)).success&&console.log(Yt,"State synced successfully")}catch{}},loadFromApi:async()=>{try{console.log(Yt,"Loading state from API...");const t=await pa.getState();return t.success?t.data?Object.keys(t.data.projects??{}).length>0?(oy(e,t.data),console.log(Yt,"State loaded successfully from API"),Ee.success("Loaded from Cloud",{description:`${Object.keys(t.data.projects).length} project(s) loaded`,duration:2e3}),!0):(console.log(Yt,"API returned empty projects"),!1):(console.log(Yt,"No data returned from API (empty state)"),!1):(console.error(Yt,"Load failed:",t.error),Ee.error("API Load Failed",{description:t.error??"Unknown error",duration:3e3}),!1)}catch(t){return console.error(Yt,"Load error:",t),Ee.error("API Load Error",{description:t instanceof Error?t.message:"Unknown error",duration:3e3}),!1}},getApiSyncEnabled:()=>{var t;return((t=s().preferences)==null?void 0:t.apiSyncEnabled)??!0},setApiSyncEnabled:t=>{e(Z(n=>{n.preferences||(n.preferences={}),n.preferences.apiSyncEnabled=t}))}}),ni=new Map,Rl=new Map,cy=(s,e)=>{Rl.set(s,e)},ly=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,ri="markop-canvas-v2-storage",Xt=new Kv("CanvasStateV2",Mv.CanvasStateV2),dy=(s,e)=>({...Wa,...pv(e,s),...Zx(e,s),project:Pv(s,e),workspace:Lv(s,e),projectCanvas:Vv(s,e),arrow:Pg(s,e),group:ab(s,e),table:lb(s,e),layer:Ib(s,e),viewLayer:Jb(s,e),ext:ow(s,e),undo:zw(s,e),getCanvasMouseCoords:()=>fg(e),...sv(e,s),setFlags:t=>Px(s,t),...Gw(e,s,ni,ly),...qw(e,s),...Vw(e,s),...Kw(e,s),...Jw(e,s),...Yw(e,s),...Xw(e,s,ni,Rl),...Qw(e,s),...Zw(e,s),...ey(e,s),...ty(e,s),resetState:()=>Rx(s),resetEverything:()=>qx([ri,"paper-texture-live-config","paper-texture-saved-presets"]),scrollToNode:(t,n=500,r)=>pg(s,e,t,n,r),scrollToArrow:(t,n=500)=>Xv(s,e,t,n),...sy(e),...kv(e,s),...mv(e,ri,Xt),...iy(e,s)}),uy=dy,Lt=Yc()(uy);let Za=!1;(async()=>{var s,e;try{const{loadActiveUserId:t,DEFAULT_USERS:n,saveActiveUserId:r}=await Ve(async()=>{const{loadActiveUserId:d,DEFAULT_USERS:p,saveActiveUserId:u}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:d,DEFAULT_USERS:p,saveActiveUserId:u}},[]),{loadCanvasStateForUser:o,createDefaultCanvasStateForUser:i}=await Ve(async()=>{const{loadCanvasStateForUser:d,createDefaultCanvasStateForUser:p}=await import("./userCanvasStateStorage-BEvN2V8a.js");return{loadCanvasStateForUser:d,createDefaultCanvasStateForUser:p}},__vite__mapDeps([66,1,4,5,6,2]));let c=t(),l=null;if(!c&&n.length>0){const d=n[0];c=d.id,r(c),Xt.log(`No active user found, initializing with default: ${d.username}`)}if(c){const d=await o(c);let p=null,u=0;const{canvasApiClient:f}=await Ve(async()=>{const{canvasApiClient:g}=await Promise.resolve().then(()=>ry);return{canvasApiClient:g}},void 0);try{const g=await f.getUserState(c);g.success&&((s=g.data)!=null&&s.canvasState)&&(p=JSON.parse(g.data.canvasState),u=g.data.lastModified??0,Xt.log(`API state available for user: ${c}, lastModified: ${u}`))}catch(g){Xt.log(`API fetch failed for user: ${c}`,g)}const m=(e=d==null?void 0:d.state)!=null&&e.projects?Math.max(...Object.values(d.state.projects).map(g=>g.lastModified??0)):0;if(p&&u>=m?(l=p,Xt.log(`Using API state (newer: ${u} >= ${m})`)):d&&(l=d,Xt.log(`Using localStorage state (newer: ${m} > ${u})`)),!l){const g=n.find(v=>v.id===c),x=(g==null?void 0:g.username)??"User";l=i(c,x),Xt.log(`Created default canvas state for user: ${x}`)}}if(l){const d=xv(Wa,l);vv(d.preferences),Lt.setState({version:d.version,dataVersion:d.dataVersion,state:d.state,uiState:d.uiState,flags:d.flags,preferences:d.preferences,extensions:d.extensions,actions:d.actions}),Xt.log("Canvas state rehydrated from user-specific storage");try{await Lt.getState().undo.initArchive(),await Lt.getState().undo.loadFromArchive()&&Xt.log("Undo history loaded from IndexedDB")}catch(p){console.warn("[PERSISTENCE] Failed to load undo history from IndexedDB:",p)}}}catch(t){console.error("[PERSISTENCE] Failed to rehydrate from localStorage:",t)}finally{Za=!0}})();let Tr=null;const py=1e3;$e.autosave&&$e.persistState&&Lt.subscribe(s=>{Za&&(Tr&&clearTimeout(Tr),Tr=setTimeout(async()=>{s.saveStateToLocalStorage(),s.getApiSyncEnabled()&&s.syncToApi();const{loadActiveUserId:e}=await Ve(async()=>{const{loadActiveUserId:r}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:r}},[]),{saveCanvasStateForUser:t}=await Ve(async()=>{const{saveCanvasStateForUser:r}=await import("./userCanvasStateStorage-BEvN2V8a.js");return{saveCanvasStateForUser:r}},__vite__mapDeps([66,1,4,5,6,2])),n=e();n&&t(n)},py))});const hy={mousePosition:null},fy=(s,e)=>({...hy,setMousePosition:t=>Yg(s,t)}),Dl=Yc()(fy),TC=Object.freeze(Object.defineProperty({__proto__:null,canvasStoreV2:Lt,canvasUiStoreV2:Dl,get isRehydrated(){return Za},registerActionHandler:cy},Symbol.toStringTag,{value:"Module"}));class my{constructor(){ee(this,"activeTranscriptions",new Map);ee(this,"listeners",new Set)}register(e,t){this.activeTranscriptions.set(e,{nodeId:e,sessionName:t,startedAt:Date.now(),status:"recording"}),this.notify()}updateStatus(e,t){const n=this.activeTranscriptions.get(e);n&&(n.status=t,this.notify())}complete(e,t){const n=Lt.getState(),r=n.getNodeById(e);if(r){const o=r.content||"",i=o+(o?`
`:"")+t;n.updateNodeContent(e,i),$g();const{width:c,height:l}=Ug(i);n.updateNode(e,{width:c,height:l,options:{...r.options,lockSize:!1}})}this.activeTranscriptions.delete(e),this.notify()}fail(e){this.activeTranscriptions.delete(e),this.notify()}has(e){return this.activeTranscriptions.has(e)}getStatus(e){var t;return((t=this.activeTranscriptions.get(e))==null?void 0:t.status)??null}getAll(){return Array.from(this.activeTranscriptions.values())}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}}const jn=new my;var eo=(s=>(s.EN="en",s.VI="vi",s.DE="de",s))(eo||{});const AC={en:"EN",vi:"VI",de:"DE"},PC={en:"English",vi:"Vietnamese",de:"German"},RC={en:"ðŸ‡¬ðŸ‡§",vi:"ðŸ‡»ðŸ‡³",de:"ðŸ‡©ðŸ‡ª"},_l="en",DC=["en","vi","de"];function Ol({onTranscriptionComplete:s,className:e="",sessionName:t="audio-button-default",getTextAreaElement:n,variant:r="default",autoStartRecording:o=!1,style:i,nodeId:c,language:l}){const[d,p]=h.useState(!1),[u,f]=h.useState(0),[m,g]=h.useState(0),[x,v]=h.useState(!1),b=h.useRef(0),w=h.useRef({});b.current++;const y={onTranscriptionComplete:s,sessionName:t,getTextAreaElement:n,variant:r,autoStartRecording:o,nodeId:c,language:l};Object.keys(y).forEach(E=>{w.current[E],y[E]}),w.current=y,h.useEffect(()=>{if(o&&!d){const E=setTimeout(()=>{f(_=>_+1)},100);return()=>clearTimeout(E)}},[o]);const j=h.useCallback(E=>"value"in E?E.value:E.textContent||"",[]),S=h.useCallback((E,_)=>{var V;if("value"in E){const Y=(V=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:V.set;Y?Y.call(E,_):E.value=_}else E.textContent=_;const F=new Event("input",{bubbles:!0});E.dispatchEvent(F)},[]),[C,N]=h.useState([]),[O,R]=h.useState(0),[k,A]=h.useState(!1),L=h.useCallback(E=>{N(_=>[..._,E]),(E.transcriptionStatus==="pending"||E.transcriptionStatus==="processing")&&v(!0)},[]),M=h.useCallback(E=>{N(_=>_.map(F=>F.id===E.id?E:F)),E.transcription?(R(_=>_+1),c?jn.complete(c,E.transcription):s==null||s(E.transcription),v(!1)):E.transcriptionStatus==="failed"&&(c&&jn.fail(c),v(!1))},[s,c]),I=h.useCallback(E=>{p(E),c&&(E?jn.register(c,t):jn.updateStatus(c,"transcribing"))},[c,t]),z=h.useCallback(E=>{E&&(E.preventDefault(),E.stopPropagation()),d?g(_=>_+1):f(_=>_+1)},[d]),$=h.useCallback(E=>{if(E.preventDefault(),E.stopPropagation(),O>0&&n){const _=n();if(!_)return;const F=C[O-1];if(!(F!=null&&F.transcription))return;const V=j(_),Y=F.transcription;let T=V;V.endsWith(Y)?T=V.slice(0,-Y.length):V.endsWith(" "+Y)&&(T=V.slice(0,-(Y.length+1))),T=T.trimEnd(),S(_,T),R(W=>W-1)}},[O,C,n,j,S]),q=h.useCallback(E=>{if(E.preventDefault(),E.stopPropagation(),O<C.length&&n){const _=n();if(!_)return;const F=C[O];if(!(F!=null&&F.transcription))return;const V=j(_),Y=V.trim()?" ":"",T=V+Y+F.transcription;S(_,T),R(W=>W+1)}},[O,C,n,j,S]),P=h.useCallback(E=>{const _=C.findIndex(F=>F.id===E);if(_!==-1){if(_<O&&n){const F=n();if(F){const Y=C.filter((T,W)=>W<O&&W!==_).map(T=>T.transcription).filter(Boolean).join(" ");S(F,Y),R(T=>T-1)}}N(F=>F.filter(V=>V.id!==E))}},[C,O,n,S]),te=h.useCallback(()=>{if(n){const E=n();E&&S(E,"")}N([]),R(0)},[n,S]);return h.useEffect(()=>{const E=_=>{if(_.ctrlKey&&_.shiftKey&&_.key==="A")if(n){const F=n();F&&document.activeElement===F&&(_.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation(),z())}else _.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation(),z()};return window.addEventListener("keydown",E,!0),()=>{window.removeEventListener("keydown",E,!0)}},[z,n]),a.jsxs("div",{className:`audio-button-wrapper flex items-center gap-1 ${e}`,"data-test":"audio-button-wrapper",style:i,children:[x&&a.jsx("div",{className:"transcription-spinner","data-test":"audio-button-transcription-spinner",children:a.jsx(ir,{className:"w-4 h-4 animate-spin text-muted-foreground","data-test":"audio-button-transcription-spinner-icon"})}),C.length>0&&a.jsxs("div",{className:"chunk-navigation flex items-center gap-0.5","data-test":"audio-button-chunk-navigation",children:[a.jsx("button",{onMouseDown:E=>E.preventDefault(),onClick:$,disabled:O===0,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Remove previous chunk",type:"button","data-test":"audio-button-previous-chunk-button",children:a.jsx(Ds,{className:Fe.sm,"data-test":"audio-button-previous-chunk-icon"})}),a.jsxs(nt,{open:k,onOpenChange:A,"data-test":"audio-button-chunk-panel-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsxs("button",{onMouseDown:E=>E.preventDefault(),onDoubleClick:()=>{te(),A(!1)},className:"chunk-counter text-xs text-muted-foreground px-1 hover:bg-accent rounded cursor-pointer",title:"View all chunks (double-click to clear)",type:"button","data-test":"audio-button-chunk-counter-button",children:[O,"/",C.length]})}),a.jsx(Qe,{className:"w-96 p-0",side:"top",align:"center","data-test":"audio-button-chunk-panel-content",children:a.jsx("div",{className:"chunk-panel-popover","data-test":"audio-button-chunk-panel-wrapper",children:a.jsx(Jc,{chunks:C,onChunkDelete:P,onChunkTranscribe:()=>{},onClearAll:te})})})]}),a.jsx("button",{onMouseDown:E=>E.preventDefault(),onClick:q,disabled:O>=C.length,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Add next chunk",type:"button","data-test":"audio-button-next-chunk-button",children:a.jsx(Ft,{className:Fe.sm,"data-test":"audio-button-next-chunk-icon"})})]}),a.jsx("button",{onMouseDown:E=>E.preventDefault(),onClick:z,className:r==="muted"?`voice-input-button p-1 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"text-muted-foreground/40 hover:text-foreground hover:bg-accent"}`:`voice-input-button p-1.5 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"hover:bg-accent"}`,title:d?"Stop recording (Ctrl+Shift+A)":"Start voice input (Ctrl+Shift+A)",type:"button","data-test":"audio-button-voice-input-button",children:a.jsx(rr,{className:`voice-input-icon ${r==="muted"?Fe.xs:Fe.sm} ${d?"animate-pulse":""}`,"data-test":"audio-button-voice-input-icon"})}),a.jsx("div",{className:"audio-panel-wrapper hidden","data-test":"audio-button-audio-panel-wrapper",children:a.jsx(Tm,{sessionName:t,enableAutoPersist:!1,loadPersistedChunks:!1,autoStart:!1,startTrigger:u,stopTrigger:m,onChunkCreated:L,onChunkUpdated:M,onRecordingStateChange:I,initialConfig:l?{transcribeOptions:{language:l,...l===eo.VI?{model:"ggml-large-v3"}:{}}}:void 0})})]})}const ai=s=>{const{header:e,itemList:t,maxHeight:n,selectedIndices:r,selectedValues:o,getItemValue:i=(P,te)=>te,onSelectionChange:c,searchable:l=!1,searchPlaceholder:d="Search...",filterItem:p=(P,te)=>String(P).toLowerCase().includes(te.toLowerCase()),showAllOption:u=l,allOptionLabel:f="All",enableDelete:m=!1,onItemDelete:g,itemStyles:x="",moreOptions:v,initiallyCollapsed:b=!1,...w}=s,y=h.useRef({}),j=h.useRef(!1),[S,C]=h.useState(new Set(r)),[N,O]=h.useState(r==null?void 0:r[r.length-1]),[R,k]=h.useState(""),[A,L]=h.useState(b);h.useEffect(()=>{const P=Array.from(S),te=r||[];if(P.length!==te.length||!P.every((E,_)=>E===te[_])){j.current=!0,C(new Set(r));const E=r==null?void 0:r[r.length-1];O(E)}},[r]),h.useEffect(()=>{if(o===void 0)return;const P=new Set,te=new Set(o);if(t.forEach((E,_)=>{te.has(i(E,_))&&P.add(_)}),P.size!==S.size||!Array.from(P).every(E=>S.has(E))){j.current=!0,C(P);const E=o[o.length-1],_=t.findIndex((F,V)=>i(F,V)===E);O(_!==-1?_:void 0)}},[o,t,i]),h.useEffect(()=>{if(j.current){const P=N;if(P!==void 0&&S.has(P)){const te=y.current[P];te&&te.scrollIntoView({behavior:"smooth",block:"nearest"})}j.current=!1}},[S,N]);const M=(P,te)=>{const E=q[P],_=t.findIndex(V=>V===E);if(_===-1)return;let F=new Set(S);if(te.shiftKey&&N!==void 0){const V=Math.min(N,_),Y=Math.max(N,_);for(let T=V;T<=Y;T++)q.some(se=>t[T]===se)&&F.add(T)}else te.ctrlKey||te.metaKey?(F.has(_)?F.delete(_):F.add(_),O(_)):(F=new Set([_]),O(_));if(C(F),c){const V=Array.from(F),Y=V.map(T=>i(t[T],T));c(V,Y)}},I=(P,te)=>{if(te.stopPropagation(),g){const E=i(t[P],P);g(P,E)}},z=()=>{k(""),C(new Set),O(void 0),c&&c([],[])},$=()=>{L(!A)},q=R&&l?t.filter((P,te)=>p(P,R,te)):t;return a.jsxs("div",{id:"UiList","data-test":"ui-list-container",className:"bg-background text-foreground select-none",...w,children:[e?a.jsxs("div",{id:"header-container","data-test":"ui-list-header-container",className:"flex justify-between items-center sticky top-0 bg-background z-10 py-2 px-2 border-b border-border",children:[a.jsx("div",{"data-test":"ui-list-header-content",className:`flex-grow ${typeof e=="string"?"font-bold":""}`,children:e}),v&&a.jsx("div",{className:"flex items-center ml-2 flex-shrink-0","data-test":"ui-list-more-options",children:v}),a.jsx(ue,{variant:"ghost",size:"sm",onClick:$,className:"p-1 h-auto flex-shrink-0","aria-label":A?"Expand list":"Collapse list","data-test":"ui-list-collapse-toggle",children:A?a.jsx(wt,{size:16}):a.jsx(ar,{size:16})})]}):null,!A&&a.jsxs(a.Fragment,{children:[l&&a.jsx("div",{className:"sticky top-0 bg-background z-10 py-2 px-2 border-b border-border","data-test":"ui-list-search-container",children:a.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:d,value:R,onChange:P=>k(P.target.value),"data-test":"ui-list-search-input"})}),a.jsxs("div",{id:"itemList","data-test":"ui-list-items-container",className:qs("space-y-1 py-1 p-2 overflow-auto"),style:{maxHeight:n},children:[l&&u&&a.jsx("div",{className:`p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${!R&&S.size===0?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:z,"data-test":"ui-list-all-option",children:f}),q.map((P,te)=>{const E=P,_=t.findIndex(V=>V===E),F=S.has(_);return a.jsxs("div",{ref:V=>y.current[_]=V,className:`flex justify-between items-center p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${F?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:V=>M(te,V),"data-test":"ui-list-item",children:[a.jsx("span",{className:"flex-grow","data-test":"ui-list-item-content",children:P}),m&&a.jsx(xp,{onClick:V=>I(_,V),className:"ml-2 px-1 py-0 text-xs text-destructive-foreground rounded hover:bg-destructive/80 focus:outline-none focus:ring-1 focus:ring-destructive","aria-label":`Delete item ${_+1}`,"data-test":"ui-list-item-delete"})]},_)})]})]})]})},Ll=h.forwardRef(({className:s,onSelectionChange:e,showBuiltInPopover:t=!0,showCopyButton:n=!1,showAudioButton:r=!1,audioButtonVariant:o="default",onAudioTranscription:i,getTextAreaElement:c,keyboard:l,triggerPopover:d,fuzzyAutocomplete:p,...u},f)=>{const m=bs(),[g,x]=h.useState(""),[v,b]=h.useState(!1),[w,y]=h.useState({top:0,left:0}),[j,S]=h.useState(!1),C=h.useRef(null),N=h.useRef(null),[O,R]=h.useState(!1),[k,A]=h.useState({top:0,left:0}),[L,M]=h.useState(null),[I,z]=h.useState(""),[$,q]=h.useState(0),P=h.useRef(null),[te,E]=h.useState(!1),[_,F]=h.useState({top:0,left:0}),[V,Y]=h.useState(""),[T,W]=h.useState(0),se=h.useRef(null),le=h.useMemo(()=>{if(!(d!=null&&d.items))return[];if(!I)return d.items;const K=I.toLowerCase();return d.items.filter(D=>D.label.toLowerCase().includes(K)||D.id.toLowerCase().includes(K))},[d==null?void 0:d.items,I]);h.useEffect(()=>{q(0)},[le.length]);const me=h.useMemo(()=>{if(!(p!=null&&p.items)||!V)return[];const K=p.filterFn??((D,X)=>D.toLowerCase().includes(X.toLowerCase()));return p.items.filter(D=>K(D,V))},[p==null?void 0:p.items,p==null?void 0:p.filterFn,V]);h.useEffect(()=>{W(0)},[me.length]);const ae=h.useCallback(async()=>{const K=C.current;if(!(!K||!K.value))try{await navigator.clipboard.writeText(K.value),S(!0),setTimeout(()=>S(!1),2e3)}catch(D){console.error("Failed to copy text:",D)}},[]),H=h.useCallback(()=>{R(!1),M(null),z(""),q(0)},[]),Q=h.useCallback(()=>{E(!1),Y(""),W(0)},[]),ge=h.useCallback((K,D)=>{const X=window.getComputedStyle(K),we=K.scrollTop,ne=parseInt(X.paddingLeft)||12,xe=parseInt(X.paddingTop)||8,J=parseInt(X.lineHeight)||20,je=K.value.substring(0,D).split(`
`),Te=je[je.length-1],Ne=je.length-1,_e=document.createElement("canvas").getContext("2d");if(!_e)return{top:xe+J,left:ne};_e.font=`${X.fontWeight} ${X.fontSize} ${X.fontFamily}`;const Me=_e.measureText(Te).width,Be=(Ne+1)*J-we+xe,ze=Me+ne;return{top:Be,left:ze}},[]),ce=h.useCallback(K=>{if(!d)return;const D=K.selectionStart,X=K.value,we=d.triggerChar;if(L!==null){if(D<=L||X[L]!==we){H();return}const ne=X.substring(L+1,D);if(/\s/.test(ne)){H();return}z(ne);return}if(D>0&&X[D-1]===we){const ne=D>1?X[D-2]:null;if(ne===null||ne===" "||ne===`
`||ne==="	"){const J=ge(K,D);A(J),M(D-1),R(!0),z(""),q(0);return}}},[d,L,ge,H]),Ae=h.useCallback(K=>{if(!p)return;const D=K.selectionStart,X=K.value,we=p.triggerAfterChars??1;if(X.length<we){te&&Q();return}if(Y(X),X.length>=we&&!te){const ne=ge(K,D);F(ne),E(!0)}},[p,te,ge,Q]),ke=h.useCallback(K=>{var we,ne;const D=C.current;if(!D)return;const X=(we=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:we.set;X&&(X.call(D,K),D.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{D.setSelectionRange(K.length,K.length),D.focus()},0),(ne=p==null?void 0:p.onSelect)==null||ne.call(p,K),Q()},[p,Q]),ve=h.useCallback(()=>{var D;if(!(p!=null&&p.findLCS)||me.length===0)return!1;const K=p.findLCS(me,V);if(K.length>V.length){const X=C.current;if(!X)return!1;const we=(D=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:D.set;return we&&(we.call(X,K),X.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{X.setSelectionRange(K.length,K.length),X.focus()},0),Y(K),!0}return!1},[p,me,V]),U=h.useCallback(()=>{const K=C.current;if(!K)return;const D=K.selectionStart,X=K.selectionEnd,we=K.value.substring(D,X).trim();if(we.length>0){x(we),b(t);const ne=K.scrollTop,xe=window.getComputedStyle(K),J=K.getBoundingClientRect(),he=parseInt(xe.paddingLeft)||12,je=parseInt(xe.paddingTop)||8,Te=K.value.substring(0,D).split(`
`),Ne=parseInt(xe.lineHeight)||20,Ce=Te.length-1,_e=Te[Ce],Be=document.createElement("canvas").getContext("2d");if(!Be)return;Be.font=`${xe.fontWeight} ${xe.fontSize} ${xe.fontFamily}`;const ze=parseInt(xe.paddingRight)||12,lt=J.width-he-ze;let Je=0,rt=0,gt=0;for(;gt<_e.length;){let vt=gt+1;for(;vt<=_e.length;){const vr=_e.substring(gt,vt);if(Be.measureText(vr).width>lt){let ys=vt-1;for(let Ss=vt-1;Ss>gt;Ss--)if(_e[Ss]===" "){ys=Ss;break}ys===gt&&vt-gt>1&&(ys=vt-1),vt=ys;break}vt++}Je=gt;const io=Math.min(vt,_e.length);if(io>=_e.length){const vr=_e.substring(Je),co=Be.measureText(vr).width,ys=(Ce+rt)*Ne-ne+Ne+je,Ss=co+he,lo={top:ys,left:Ss};y(lo),e==null||e(we,lo);return}rt++,gt=io,_e[gt]===" "&&gt++}}else b(!1),x(""),e==null||e("",void 0)},[e,t]),re=h.useCallback(()=>{U()},[U]),G=h.useCallback(K=>{var D;K.shiftKey&&U(),(D=u.onKeyUp)==null||D.call(u,K)},[U,u]),oe=h.useCallback(K=>{var je,Te;const D=C.current;if(!D||L===null)return;const X=D.value,we=X.substring(0,L),ne=X.substring(L+1+I.length),xe=we+K.value+ne,J=(je=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:je.set;J&&(J.call(D,xe),D.dispatchEvent(new Event("input",{bubbles:!0})));const he=L+K.value.length;setTimeout(()=>{D.setSelectionRange(he,he),D.focus()},0),(Te=d==null?void 0:d.onSelect)==null||Te.call(d,K,{filterText:I,triggerPosition:L}),H()},[L,I,d,H]),de=h.useCallback(K=>{var D;if(O&&d)switch(K.key){case"Escape":K.preventDefault(),H();return;case"ArrowDown":K.preventDefault(),q(X=>X<le.length-1?X+1:0);return;case"ArrowUp":K.preventDefault(),q(X=>X>0?X-1:le.length-1);return;case"Enter":case"Tab":le.length>0&&(K.preventDefault(),oe(le[$]));return}if(te&&p)switch(K.key){case"Escape":K.preventDefault(),Q();return;case"ArrowDown":K.preventDefault(),W(X=>X<me.length-1?X+1:0);return;case"ArrowUp":K.preventDefault(),W(X=>X>0?X-1:me.length-1);return;case"Tab":K.preventDefault(),!ve()&&me.length===1&&ke(me[0]);return;case"Enter":me.length>0&&(K.preventDefault(),ke(me[T]));return}(D=u.onKeyDown)==null||D.call(u,K)},[O,d,H,le,$,oe,te,p,Q,me,T,ve,ke,u]),pe=h.useCallback(K=>{var D;ce(K.target),Ae(K.target),(D=u.onChange)==null||D.call(u,K)},[ce,Ae,u]),fe=h.useCallback(K=>{var D;setTimeout(()=>{b(!1),d!=null&&d.stayOpen||H(),Q()},200),(D=u.onBlur)==null||D.call(u,K)},[u,H,Q,d==null?void 0:d.stayOpen]),be=h.useCallback(()=>{if(!g||g.length===0)return"";const K=g[0];return K>="A"&&K<="Z"?"text-red-600":K>="a"&&K<="z"?"text-blue-600":""},[g]),Pe=h.useCallback(K=>{i==null||i(K)},[i]),Ie=h.useCallback(()=>C.current,[]);return h.useImperativeHandle(f,()=>({insertTextAtStart:K=>{const D=C.current;if(!D)return;D.focus();const X=D.selectionStart,we=D.selectionEnd;if(D.setSelectionRange(0,0),!document.execCommand("insertText",!1,K)){const he=K+D.value;D.value=he,D.dispatchEvent(new Event("input",{bubbles:!0}))}const xe=X+K.length,J=we+K.length;D.setSelectionRange(xe,J)},getTextArea:()=>C.current,getSelectionPosition:()=>w,closeTriggerPopover:H,getTriggerPosition:()=>L}),[w,H,L]),a.jsxs("div",{className:"textarea-container relative w-full h-full","data-test":"selectable-textarea-container",children:[a.jsxs(nt,{open:v,"data-test":"selectable-textarea-popover",children:[a.jsx(Fc,{...u,className:B("flex w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),style:{fontSize:m?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:m?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...u.style},ref:C,onChange:pe,onKeyDown:de,onMouseUp:re,onKeyUp:G,onBlur:fe,"data-node-textarea":"true","data-test":"selectable-textarea-rich-textarea"}),a.jsx(Tn,{ref:N,style:{position:"absolute",top:`${w.top}px`,left:`${w.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-popover-anchor"}),a.jsx(Qe,{side:"bottom",align:"start",className:"selection-popover w-auto max-w-md",onOpenAutoFocus:K=>K.preventDefault(),"data-test":"selectable-textarea-popover-content",children:a.jsxs("div",{className:"popover-content flex flex-col gap-2","data-test":"selectable-textarea-popover-content-wrapper",children:[a.jsx("div",{className:"popover-label text-xs text-muted-foreground font-medium","data-test":"selectable-textarea-popover-label",children:"Selected Text:"}),a.jsx("div",{className:B("popover-text text-sm font-mono bg-muted px-2 py-1 rounded font-semibold",be()),"data-test":"selectable-textarea-popover-text",children:g})]})})]}),d&&a.jsxs(nt,{open:O,"data-test":"selectable-textarea-trigger-popover",children:[a.jsx(Tn,{ref:P,style:{position:"absolute",top:`${k.top}px`,left:`${k.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-trigger-popover-anchor"}),a.jsx(Qe,{side:"bottom",align:"start",className:B("trigger-popover p-1",d.widthClass??"w-48"),style:d.zIndex?{zIndex:d.zIndex}:void 0,onOpenAutoFocus:K=>K.preventDefault(),"data-test":"selectable-textarea-trigger-popover-content",children:a.jsxs("div",{"data-test":"trigger-popover-menu",children:[a.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:d.header??"Select"}),le.length>0?a.jsx(ai,{itemList:le.map(K=>a.jsxs("div",{className:"flex items-center gap-2 px-1","data-test":"trigger-item",children:[K.icon&&a.jsx("span",{className:"font-mono text-xs w-6 text-muted-foreground",children:K.icon}),a.jsx("span",{className:"text-sm",children:K.label})]},K.id)),selectedIndices:[$],onSelectionChange:K=>{K.length>0&&le[K[0]]&&oe(le[K[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"trigger-popover-list"}):a.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"trigger-popover-empty",children:d.emptyMessage??"No matches"})]})})]}),p&&a.jsxs(nt,{open:te,"data-test":"selectable-textarea-fuzzy-popover",children:[a.jsx(Tn,{ref:se,style:{position:"absolute",top:`${_.top}px`,left:`${_.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-fuzzy-popover-anchor"}),a.jsx(Qe,{side:"bottom",align:"start",className:B("fuzzy-popover p-1",p.widthClass??"w-48"),style:p.zIndex?{zIndex:p.zIndex}:void 0,onOpenAutoFocus:K=>K.preventDefault(),"data-test":"selectable-textarea-fuzzy-popover-content",children:a.jsxs("div",{"data-test":"fuzzy-popover-menu",children:[a.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:p.header??"Suggestions"}),me.length>0?a.jsx(ai,{itemList:me.map((K,D)=>a.jsx("div",{className:"flex items-center gap-2 px-1 text-sm","data-test":"fuzzy-item",children:a.jsx("span",{className:"truncate",children:K})},D)),selectedIndices:[T],onSelectionChange:K=>{K.length>0&&me[K[0]]&&ke(me[K[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"fuzzy-popover-list"}):a.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"fuzzy-popover-empty",children:p.emptyMessage??"No matches"})]})})]}),a.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:st.nodeAudioButton},"data-test":"selectable-textarea-action-buttons",children:[n&&a.jsx("button",{type:"button",onClick:ae,className:"p-1 rounded hover:bg-muted/80 text-muted-foreground hover:text-foreground transition-colors",title:j?"Copied!":"Copy text","data-test":"selectable-textarea-copy-button",children:j?a.jsx(ct,{className:"h-4 w-4 text-green-500"}):a.jsx(Ra,{className:"h-4 w-4"})}),r&&a.jsx(Ol,{onTranscriptionComplete:Pe,sessionName:"selectable-textarea",getTextAreaElement:c||Ie,variant:o,language:l,"data-test":"selectable-textarea-audio-button"})]})]})});Ll.displayName="SelectableTextArea";class gy{constructor(){ee(this,"directoryMapCache",new Map);ee(this,"loadPromiseCache",new Map)}async loadDirectoryMap(e){var c;const t=e??"default",r=(c=ie.getState().ui)==null?void 0:c.directoryMaps;if(r!=null&&r[t])return this.directoryMapCache.set(t,r[t]),r[t];if(this.directoryMapCache.has(t))return this.directoryMapCache.get(t);if(this.loadPromiseCache.has(t))return this.loadPromiseCache.get(t);const o=e?`/directory-map?cwd=${encodeURIComponent(e)}`:"/directoryMap.json",i=fetch("http://localhost:3333"+o).then(l=>{if(!l.ok)throw new Error(`Failed to load directory map: ${l.statusText}`);return l.json()}).then(l=>{const d=l.success?l.data:l;return this.directoryMapCache.set(t,d),this.loadPromiseCache.delete(t),this.saveToGlobalStore(t,d),d}).catch(l=>{throw this.loadPromiseCache.delete(t),l});return this.loadPromiseCache.set(t,i),i}saveToGlobalStore(e,t){var o;const n=ie.getState(),r=((o=n.ui)==null?void 0:o.directoryMaps)??{};ie.updateState({ui:{...n.ui,directoryMaps:{...r,[e]:t}}})}async getFilePath(e,t){const n=await this.loadDirectoryMap(t);if(n[e])return n[e];const r=e.toLowerCase();for(const[o,i]of Object.entries(n))if(o.toLowerCase()===r)return i}async getAllFilenames(e){const t=await this.loadDirectoryMap(e);return Object.keys(t)}async searchFiles(e,t){const n=await this.loadDirectoryMap(t),r=e.toLowerCase();return Object.entries(n).filter(([o])=>o.toLowerCase().includes(r)).map(([o,i])=>({filename:o,path:i}))}clearCache(e){var t;if(e){const n=e;this.directoryMapCache.delete(n),this.loadPromiseCache.delete(n);const r=ie.getState(),i={...((t=r.ui)==null?void 0:t.directoryMaps)??{}};delete i[n],ie.updateState({ui:{...r.ui,directoryMaps:i}})}else{this.directoryMapCache.clear(),this.loadPromiseCache.clear();const n=ie.getState();ie.updateState({ui:{...n.ui,directoryMaps:{}}})}}}const ha=new gy;function Cn(s,e){const t=s.toLowerCase(),n=e.toLowerCase();if(t==="")return{score:0,matches:[]};let r=0,o=0;const i=[];let c=0,l=0;for(;r<t.length&&o<n.length;)t[r]===n[o]?(i.push(o),l++,c+=1+l,(o===0||/[\s\-_\/\\.]/.test(e[o-1]))&&(c+=10),r++):l=0,o++;if(r!==t.length)return null;if(i.length>0){const d=i[i.length-1]-i[0]-i.length+1;c-=d}return c+=100/(e.length+1),{score:c,matches:i}}function xy(s,e){if(e.length===0)return[{text:s,isMatch:!1}];const t=[];let n=0;for(const r of e)r>n&&t.push({text:s.substring(n,r),isMatch:!1}),t.push({text:s[r],isMatch:!0}),n=r+1;return n<s.length&&t.push({text:s.substring(n),isMatch:!1}),t}const nn=h.forwardRef(({className:s,viewportClassName:e,children:t,...n},r)=>a.jsxs(Vi,{ref:r,className:B("relative overflow-hidden",s),...n,children:[a.jsx(Wu,{className:B("h-full w-full rounded-[inherit]",e),children:t}),a.jsx(Ml,{}),a.jsx(zu,{})]}));nn.displayName=Vi.displayName;const Ml=h.forwardRef(({className:s,orientation:e="vertical",...t},n)=>a.jsx(Ki,{ref:n,orientation:e,className:B("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...t,children:a.jsx(Hu,{className:"relative flex-1 rounded-full bg-border"})}));Ml.displayName=Ki.displayName;function vy({items:s,selectedIndex:e,renderItem:t,onItemClick:n,onItemHover:r,className:o,height:i="h-[400px]",emptyMessage:c="No items found",isLoading:l=!1,loadingMessage:d="Loading...",getItemKey:p}){const u=h.useRef(null);return h.useEffect(()=>{u.current&&u.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[e]),a.jsx(nn,{className:B("scrollable-list rounded-md border",i,o),"data-test":"scrollable-list-container",children:l?a.jsx("div",{className:"loading-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-loading-state",children:a.jsx("span",{"data-test":"scrollable-list-loading-message",children:d})}):s.length===0?a.jsx("div",{className:"empty-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-empty-state",children:a.jsx("span",{"data-test":"scrollable-list-empty-message",children:c})}):a.jsx("div",{className:"list-items","data-test":"scrollable-list-items",children:s.map((f,m)=>{const g=m===e,x=p?p(f,m):m;return t(f,m,g,x,g?u:void 0,()=>n==null?void 0:n(f,m),()=>r==null?void 0:r(m))})})})}const fa=h.forwardRef(({onFileSelect:s,className:e,maxResults:t=10,placeholder:n="Search files...",mode:r="normal",searchMode:o="filename",cwd:i,externalSearchQuery:c,hideSearchInput:l=!1,onTabComplete:d,onLoadComplete:p},u)=>{const[f,m]=h.useState([]),[g,x]=h.useState([]),[v,b]=h.useState(t),[w,y]=h.useState(""),[j,S]=h.useState(!0),[C,N]=h.useState(0),[O,R]=h.useState(o),k=c??w;h.useEffect(()=>{(async()=>{try{S(!0);const W=await ha.getAllFilenames(i),se=[];for(const le of W){const me=await ha.getFilePath(le,i);me&&se.push({filename:le,path:me})}m(se),x(se),b(t)}catch(W){console.error("Failed to load files:",W)}finally{S(!1),p==null||p()}})()},[t,i,p]),h.useEffect(()=>{k.startsWith("/")?O!=="fullPath"&&R("fullPath"):O!=="filename"&&R("filename");const T=k.startsWith("/")?k.slice(1):k;if(!T.trim()){x(f),b(t),N(0);return}let W=f;if(O==="fullPath"){const me=new Set,ae=[];for(const H of f){ae.push(H),me.add(H.path);const Q=H.path.split("/").filter(Boolean);for(let ge=1;ge<Q.length;ge++){const ce=Q.slice(0,ge).join("/")+"/";me.has(ce)||(me.add(ce),ae.push({filename:Q[ge-1],path:ce,isDirectory:!0}))}}W=ae}const se=[];for(const me of W)if(O==="fullPath"){const ae=Cn(T,me.path);ae&&se.push({file:me,score:ae.score,matches:ae.matches})}else{const ae=Cn(T,me.filename),H=Cn(T,me.path),Q=ae&&H?ae.score>H.score?ae:H:ae??H;Q&&se.push({file:me,score:Q.score,matches:Q.matches})}se.sort((me,ae)=>ae.score-me.score);const le=se.map(me=>me.file);x(le),b(t),N(0)},[k,f,t,O]);const A=h.useCallback(T=>{s==null||s(T)},[s]),L=h.useCallback(T=>{N(T==="down"?W=>{const se=Math.min(W+1,g.length-1);return se>=v-2&&v<g.length&&b(le=>Math.min(le+t,g.length)),se}:W=>Math.max(W-1,0))},[g.length,v,t]),M=h.useCallback(()=>{g[C]&&A(g[C])},[g,C,A]),I=h.useCallback(()=>{if(!g[C]||!k.startsWith("/"))return null;const T=g[C].path,W=k.slice(1),se=T.indexOf("/",W.length);let le;return se!==-1?le="/"+T.substring(0,se+1):le="/"+T,c===void 0&&y(le),d==null||d(le),le},[g,C,k,c,d]),z=h.useCallback(()=>g[C]??null,[g,C]);h.useImperativeHandle(u,()=>({navigate:L,selectCurrent:M,tabComplete:I,getSelectedFile:z}),[L,M,I,z]);const $=h.useCallback(T=>{switch(T.key){case"Tab":T.preventDefault(),I();break;case"ArrowDown":T.preventDefault(),L("down");break;case"ArrowUp":T.preventDefault(),L("up");break;case"Enter":T.preventDefault(),M();break;case"Escape":T.preventDefault(),y("");break}},[L,M,I]),q=(T,W)=>{if(!W.trim())return a.jsx("span",{children:T});const se=Cn(W,T);if(!se)return a.jsx("span",{children:T});const le=xy(T,se.matches);return a.jsx("span",{children:le.map((me,ae)=>a.jsx("span",{className:me.isMatch?"bg-yellow-200 dark:bg-yellow-900 font-semibold":"",children:me.text},ae))})},P=T=>{var le;const W=(le=T.split(".").pop())==null?void 0:le.toLowerCase(),se="w-4 h-4 flex-shrink-0";return["tsx","ts","jsx","js"].includes(W??"")?a.jsx(Fs,{className:B(se,"text-blue-500")}):["json","yml","yaml"].includes(W??"")?a.jsx(Fs,{className:B(se,"text-yellow-500")}):["md","txt"].includes(W??"")?a.jsx(Fs,{className:B(se,"text-gray-500")}):["css","scss"].includes(W??"")?a.jsx(Fs,{className:B(se,"text-purple-500")}):a.jsx(Fs,{className:B(se,"text-muted-foreground")})},te=T=>T.split("/").slice(0,-1).join("/")||"/",E=r==="compact"||r==="fileNameOnly",_=r==="fileNameOnly",F=k.startsWith("/")?k.slice(1):k,V=g.slice(0,v),Y=(T,W,se,le,me,ae,H)=>a.jsxs("button",{ref:me,onClick:ae,onMouseEnter:H,"data-test":"file-picker-item",className:B("file-item w-full flex items-start hover:bg-accent text-left transition-colors border-b border-border last:border-b-0",E?"px-2 py-1 gap-2":"px-3 py-2 gap-3",se&&"bg-accent"),children:[!_&&(T.isDirectory?a.jsx(vp,{className:B("w-4 h-4 flex-shrink-0","text-blue-400"),"data-test":"file-picker-item-folder-icon"}):P(T.filename)),a.jsx("div",{className:"file-info flex-1 min-w-0","data-test":"file-picker-item-info",children:O==="fullPath"?a.jsx("div",{className:B("filename font-medium truncate",E?"text-xs":"text-sm"),"data-test":"file-picker-item-path",children:q(T.path,F)}):a.jsxs("div",{className:B("filename truncate flex items-baseline gap-2",E?"text-xs":"text-sm"),"data-test":"file-picker-item-filename",children:[a.jsx("span",{className:"font-medium flex-shrink-0","data-test":"file-picker-item-name",children:q(T.filename,F)}),a.jsx("span",{className:B("text-muted-foreground overflow-hidden text-ellipsis whitespace-nowrap",E?"text-[10px]":"text-xs"),style:{direction:"rtl",textAlign:"left"},"data-test":"file-picker-item-directory",children:te(T.path)})]})})]},le);return a.jsxs("div",{className:B("file-picker flex flex-col",E?"gap-1.5":"gap-3",e),"data-test":"file-picker-container",children:[!l&&a.jsxs("div",{className:"search-input-wrapper relative","data-test":"file-picker-search-wrapper",children:[a.jsx(or,{className:B("absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none",E?"w-3 h-3":"w-4 h-4"),"data-test":"file-picker-search-icon"}),a.jsx(We,{type:"text",value:k,onChange:T=>y(T.target.value),onKeyDown:$,placeholder:n,className:B("search-input pl-9",E&&"h-8 text-xs"),autoFocus:!c,"data-test":"file-picker-search-input"})]}),!_&&a.jsx("div",{className:B("results-info text-xs text-muted-foreground",E?"px-0.5":"px-1"),"data-test":"file-picker-results-info",children:j?a.jsx("span",{"data-test":"file-picker-loading-text",children:"Loading files..."}):a.jsxs("span",{"data-test":"file-picker-results-text",children:["Showing ",V.length," of ",g.length," results",g.length<f.length&&` (filtered from ${f.length} total)`]})}),a.jsx(vy,{items:V,selectedIndex:C,renderItem:Y,onItemClick:T=>A(T),onItemHover:T=>N(T),getItemKey:T=>T.path,height:"max-h-fit",className:"file-list",emptyMessage:"No files found",isLoading:j,loadingMessage:"Loading files...","data-test":"file-picker-file-list"}),!_&&!l&&a.jsxs("div",{className:B("keyboard-hints text-muted-foreground flex",E?"text-[10px] px-0.5 gap-2":"text-xs px-1 gap-4"),"data-test":"file-picker-keyboard-hints",children:[a.jsxs("span",{"data-test":"file-picker-hint-navigate",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",E?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"â†‘â†“"})," Navigate"]}),a.jsxs("span",{"data-test":"file-picker-hint-autocomplete",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",E?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Tab"})," Autocomplete"]}),a.jsxs("span",{"data-test":"file-picker-hint-select",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",E?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Enter"})," Select"]}),a.jsxs("span",{"data-test":"file-picker-hint-clear",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",E?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Esc"})," Clear"]})]})]})});fa.displayName="FilePicker";const Dn="â€‹";function Qn(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Qt(s){const e=[];let t=0,n=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(r,o,i)=>{const c=`LINKPLACEHOLDER${t}END`,l=Qn(o),d=`<a href="${i}" class="text-primary underline hover:text-primary/80 cursor-pointer" target="_blank" rel="noopener noreferrer">${l}</a>`;return e.push({placeholder:c,html:d}),t++,c});n=Qn(n).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(new RegExp("(?<!\\w)__(.+?)__(?!\\w)","g"),"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(new RegExp("(?<!\\w)_(.+?)_(?!\\w)","g"),"<em>$1</em>").replace(/~~(.+?)~~/g,"<del>$1</del>").replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm font-mono">$1</code>');for(const{placeholder:r,html:o}of e)n=n.replace(r,o);return n}function Ar(s){function e(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent||"";if(t.nodeType===Node.ELEMENT_NODE){const n=t,r=n.tagName.toLowerCase(),o=Array.from(t.childNodes).map(e).join("");switch(r){case"strong":case"b":return`**${o}**`;case"em":case"i":return`*${o}*`;case"del":case"s":return`~~${o}~~`;case"code":return`\`${o}\``;case"a":{const i=n.getAttribute("href")||"";return`[${o}](${i})`}default:return o}}return""}return Array.from(s.childNodes).map(e).join("").trim()}function ma(s){const e=s.trim(),t=e.startsWith("|")?e.slice(1):e;return(t.endsWith("|")?t.slice(0,-1):t).split("|").map(r=>r.trim())}function Fl(s){return ma(s).every(t=>/^:?-+:?$/.test(t))}function oi(s){if(s.length<2)return s.map(Qn).join("<br>");const e=s.findIndex(o=>Fl(o));if(e===-1||e===0)return s.map(Qn).join("<br>");const t=s.slice(0,e),n=s.slice(e+1);let r='<table class="markdown-table border-collapse w-full my-2" data-test="markdown-table">';if(t.length>0){r+="<thead>";for(const o of t){const i=ma(o);r+="<tr>";for(const c of i)r+=`<th class="border border-border px-2 py-1 h-6 bg-muted font-medium text-left">${Qt(c)}</th>`;r+="</tr>"}r+="</thead>"}if(n.length>0){r+="<tbody>";for(const o of n){if(!o.trim())continue;const i=ma(o);r+="<tr>";for(const c of i)r+=`<td class="border border-border px-2 py-1 h-6">${Qt(c)}</td>`;r+="</tr>"}r+="</tbody>"}return r+="</table>",r}function by(s){const e=s.split(`
`),t=[];let n=[],r=!1;for(let i=0;i<e.length;i++){const c=e[i];if(c.trim().startsWith("|")||c.includes("|")&&Fl(c))r||(r=!0),n.push(c);else{if(r){const d=oi(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(d),n=[],r=!1}t.push(c)}}if(r&&n.length>0){const i=oi(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(i)}const o=[];for(let i=0;i<t.length;i++)t[i].startsWith("__TABLE_PLACEHOLDER_")?i+1<t.length&&(o.push(t[i+1]),i++):o.push(t[i]);return o.join(`
`)}function wy(s){const e=[];let t=!1;const n=s.querySelector("thead");if(n){t=!0;const c=n.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("th, td")).map(p=>Ar(p));e.push(d)}}const r=s.querySelector("tbody");if(r){const c=r.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>Ar(p));e.push(d)}}if(!n&&!r){const c=s.querySelectorAll(":scope > tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>Ar(p));e.push(d)}}if(e.length===0)return"";const o=[],i=Math.max(...e.map(c=>c.length));for(let c=0;c<e.length;c++){const l=e[c];for(;l.length<i;)l.push("");o.push("| "+l.join(" | ")+" |"),t&&c===0&&o.push("| "+l.map(()=>"---").join(" | ")+" |")}if(!t&&e.length>0){const c=e[0];o.splice(1,0,"| "+c.map(()=>"---").join(" | ")+" |")}return o.join(`
`)+`
`}function ot(s){if(!s)return"";const e=by(s),t=[],r=e.replace(/<table[\s\S]*?<\/table>/g,c=>(t.push(c),`MARKDOWNTABLEPLACEHOLDER${t.length-1}ENDPLACEHOLDER`)).split(`
`),o=[];for(let c=0;c<r.length;c++){const l=r[c],d=/^# (.+)$/.test(l),p=/^## (.+)$/.test(l),u=/^### (.+)$/.test(l),f=/^- (.+)$/.test(l),m=/^(\d+)\. (.+)$/.test(l),g=/^> (.+)$/.test(l),x=/^---$/.test(l),v=/^MARKDOWNTABLEPLACEHOLDER\d+ENDPLACEHOLDER$/.test(l),b=l==="";let w;if(u){const y=l.replace(/^### (.+)$/,"$1");w=`<h3>${Qt(y)}</h3>`}else if(p){const y=l.replace(/^## (.+)$/,"$1");w=`<h2>${Qt(y)}</h2>`}else if(d){const y=l.replace(/^# (.+)$/,"$1");w=`<h1>${Qt(y)}</h1>`}else if(g){const y=l.replace(/^> (.+)$/,"$1");w=`<blockquote class="border-l-2 border-muted-foreground/30 pl-3 m-0 text-muted-foreground italic">${Qt(y)}</blockquote>`}else if(x)w='<hr class="border-t border-muted-foreground/30 m-0">';else if(f){const y=l.replace(/^- (.+)$/,"$1"),j=c>0?r[c-1]:"";w=`<div class="${!(/^- /.test(j)||/^\d+\. /.test(j))&&c>0?"mt-[1lh] ":""}list-item-ul flex"><span class="mr-1.5">â€¢</span><span>${Qt(y)}</span></div>`}else if(m){const y=l.match(/^(\d+)\. (.+)$/),j=y[1],S=y[2],C=c>0?r[c-1]:"";w=`<div class="${!(/^- /.test(C)||/^\d+\. /.test(C))&&c>0?"mt-[1lh] ":""}list-item-ol flex"><span class="mr-1.5">${j}.</span><span>${Qt(S)}</span></div>`}else v?w=l:b?w='<div class="empty-line"><br></div>':w=`<div class="paragraph">${Qt(l)}</div>`;o.push(w)}let i=o.join("");for(let c=0;c<t.length;c++)i=i.replace(`MARKDOWNTABLEPLACEHOLDER${c}ENDPLACEHOLDER`,t[c]);return i}function ms(s){if(!s)return"";const e=document.createElement("div");e.innerHTML=s.replace(new RegExp(Dn,"g"),"");function t(c,l=!1){if(c.nodeType===Node.TEXT_NODE)return c.textContent||"";if(c.nodeType===Node.ELEMENT_NODE){const d=c,p=d.tagName.toLowerCase(),u=Array.from(c.childNodes).map(f=>t(f,!1)).join("");switch(p){case"strong":case"b":return`**${u}**`;case"em":case"i":return`*${u}*`;case"del":case"s":return`~~${u}~~`;case"code":return`\`${u}\``;case"a":{const f=d.getAttribute("href")||"";return`[${u}](${f})`}case"br":return`
`;case"blockquote":return`> ${u}
`;case"h1":return`# ${u}
`;case"h2":return`## ${u}
`;case"h3":return`### ${u}
`;case"table":return wy(d);case"div":case"p":if(d.classList.contains("list-item-ul")){const f=d.querySelector("span:last-child");return`- ${f?f.textContent||"":u}
`}if(d.classList.contains("list-item-ol")){const f=d.querySelector("span:first-child"),m=d.querySelector("span:last-child"),g=f?(f.textContent||"1.").replace(".",""):"1",x=m?m.textContent||"":u;return`${g}. ${x}
`}if(d.classList.contains("paragraph"))return u+`
`;if(d.classList.contains("empty-line")){const f=d.textContent||"";return f.trim()?f+`
`:`
`}return l?u:u?u+`
`:"";case"span":return d.classList.contains("text-2xl")?`# ${u}`:d.classList.contains("text-xl")?`## ${u}`:d.classList.contains("text-lg")?`### ${u}`:u;default:return u}}return""}const n=t(e,!0);let r=0;const o=Array.from(e.children);for(let c=o.length-1;c>=0;c--){const l=o[c];if(l.classList.contains("empty-line"))if(!(l.textContent||"").trim())r++;else break;else break}return r>0?n.replace(/\n+$/,"")+`
`.repeat(r):n.replace(/\n+$/,"")}const ft={a:["a","Ã¡","Ã ","áº£","Ã£","áº¡","Äƒ","áº¯","áº±","áº³","áºµ","áº·","Ã¢","áº¥","áº§","áº©","áº«","áº­"],A:["A","Ã","Ã€","áº¢","Ãƒ","áº ","Ä‚","áº®","áº°","áº²","áº´","áº¶","Ã‚","áº¤","áº¦","áº¨","áºª","áº¬"],e:["e","Ã©","Ã¨","áº»","áº½","áº¹","Ãª","áº¿","á»","á»ƒ","á»…","á»‡"],E:["E","Ã‰","Ãˆ","áºº","áº¼","áº¸","ÃŠ","áº¾","á»€","á»‚","á»„","á»†"],i:["i","Ã­","Ã¬","á»‰","Ä©","á»‹"],I:["I","Ã","ÃŒ","á»ˆ","Ä¨","á»Š"],o:["o","Ã³","Ã²","á»","Ãµ","á»","Ã´","á»‘","á»“","á»•","á»—","á»™","Æ¡","á»›","á»","á»Ÿ","á»¡","á»£"],O:["O","Ã“","Ã’","á»Ž","Ã•","á»Œ","Ã”","á»","á»’","á»”","á»–","á»˜","Æ ","á»š","á»œ","á»ž","á» ","á»¢"],u:["u","Ãº","Ã¹","á»§","Å©","á»¥","Æ°","á»©","á»«","á»­","á»¯","á»±"],U:["U","Ãš","Ã™","á»¦","Å¨","á»¤","Æ¯","á»¨","á»ª","á»¬","á»®","á»°"],y:["y","Ã½","á»³","á»·","á»¹","á»µ"],Y:["Y","Ã","á»²","á»¶","á»¸","á»´"],d:["d","Ä‘"],D:["D","Ä"]},yy={s:"acute",f:"grave",r:"hook",x:"tilde",j:"dot"},Sy={w:"horn",aa:"circumflex",aw:"breve",ee:"circumflex",oo:"circumflex",ow:"horn",uw:"horn",dd:"stroke"},ks={a:null,e:null,i:null,o:null,u:null,y:null,d:null,Äƒ:null,Ã¢:null,Ãª:null,Ã´:null,Æ¡:null,Æ°:null,Ä‘:null,Ã¡:"s",áº¯:"s",áº¥:"s",Ã©:"s",áº¿:"s",Ã­:"s",Ã³:"s",á»‘:"s",á»›:"s",Ãº:"s",á»©:"s",Ã½:"s",Ã :"f",áº±:"f",áº§:"f",Ã¨:"f",á»:"f",Ã¬:"f",Ã²:"f",á»“:"f",á»:"f",Ã¹:"f",á»«:"f",á»³:"f",áº£:"r",áº³:"r",áº©:"r",áº»:"r",á»ƒ:"r",á»‰:"r",á»:"r",á»•:"r",á»Ÿ:"r",á»§:"r",á»­:"r",á»·:"r",Ã£:"x",áºµ:"x",áº«:"x",áº½:"x",á»…:"x",Ä©:"x",Ãµ:"x",á»—:"x",á»¡:"x",Å©:"x",á»¯:"x",á»¹:"x",áº¡:"j",áº·:"j",áº­:"j",áº¹:"j",á»‡:"j",á»‹:"j",á»:"j",á»™:"j",á»£:"j",á»¥:"j",á»±:"j",á»µ:"j"};Object.keys(ks).forEach(s=>{const e=s.toUpperCase(),t=ks[s];e!==s&&(ks[e]=t)});function ds(s,e){const t=s.toLowerCase();switch(e){case"breve":return["Äƒ","áº¯","áº±","áº³","áºµ","áº·"].includes(t);case"circumflex":return["Ã¢","áº¥","áº§","áº©","áº«","áº­","Ãª","áº¿","á»","á»ƒ","á»…","á»‡","Ã´","á»‘","á»“","á»•","á»—","á»™"].includes(t);case"horn":return["Æ¡","á»›","á»","á»Ÿ","á»¡","á»£","Æ°","á»©","á»«","á»­","á»¯","á»±"].includes(t);case"stroke":return["Ä‘"].includes(t);default:return!1}}function Es(s){return s in yy}function Zn(s){return s==="w"||s==="a"||s==="e"||s==="o"||s==="u"||s==="d"}function es(s){const e=s.toLowerCase();if(ft[e]!==void 0&&e!=="d")return e;for(const t of["a","e","i","o","u","y"])if(ft[t].includes(e))return t;return null}function jy(s,e,t){const n=s.substring(e,t).toLowerCase(),r=[];for(let o=0;o<n.length;o++){const i=n[o],c=es(i);c!==null&&r.push({char:i,pos:e+o,base:c})}if(r.length===0)return-1;if(r.length===1)return r[0].pos;if(r.length===2){const o=r[0].base,i=r[1].base,c=r[1].char;return o==="o"&&["a","e"].includes(i)||o==="u"&&i==="y"||["Ãª","Ã´","Æ¡"].includes(c)?r[1].pos:r[0].pos}return r.length>=3?r[1].pos:r[r.length-1].pos}function hs(s){return s?/[\s.,;:!?()[\]{}'"<>\/\\-]/.test(s):!0}function ga(s,e){return s==="a"&&e.includes("a")&&e.includes("w")||s==="a"&&e.includes("w")&&!e.includes("a")?"aw":s==="o"&&e.includes("w")?"ow":s==="u"&&e.includes("w")?"uw":s==="a"&&e.includes("a")?"aa":s==="e"&&e.includes("e")?"ee":s==="o"&&e.includes("o")?"oo":s==="d"&&e.includes("d")?"dd":e.includes("w")?"w":null}function Cy(s){const e=Sy[s];return e==="breve"?"breve":e.includes("circumflex")?"circumflex":e.includes("horn")?"horn":e==="stroke"?"stroke":null}function Cs(s,e){const t=ft[s]||[];if(!e||e===s)return t;const n=e.slice(s.length).toLowerCase();let r=null;n.includes("s")?r="s":n.includes("j")?r="j":n.includes("r")?r="r":n.includes("x")?r="x":n.includes("f")&&(r="f");const o=ga(s,n),i=o?Cy(o):null;return t.filter(c=>!(r!==null&&ks[c]!==r||i&&!ds(c,i)))}function Ny(s){const e=s.toLowerCase();if(ft[e]!==void 0)return!1;for(const t in ft)if(ft[t].includes(e))return!0;return!1}function ii(s){const e=s.toLowerCase();for(const t in ft)if(ft[t].includes(e))return t;return s}function ky(s,e){let t=-1,n="";const r=s.charAt(e-1).toLowerCase();if(Es(r)){let o=0;for(let i=e-2;i>=0;i--)if(hs(s.charAt(i))){o=i+1;break}for(let i=o;i<e-1;i++){const c=s.charAt(i),l=es(c);if(l)return{sequenceStart:o,detectedBaseChar:l,found:!0}}}if(Zn(r)){if(r==="w")for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(hs(i))break;if(i==="o"&&o>0&&s.charAt(o-1).toLowerCase()==="u")return{sequenceStart:o-1,detectedBaseChar:"u",found:!0}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(hs(i))break;const c=es(i);if((i===r||c===r)&&ft[r])return{sequenceStart:o,detectedBaseChar:r,found:!0}}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase(),c=es(i);if(ft[i]||c){if(c!==null&&c!==i&&!(Es(r)||r===c||r==="w"))return{sequenceStart:-1,detectedBaseChar:"",found:!1};if(t=o,n=c||i,o>0){const p=s.charAt(o-1).toLowerCase(),u=es(p);(p===n||u===n)&&ft[n]&&(t=o-1)}const d=s.slice(t+1,e-1).toLowerCase();for(const p of d)if(!Es(p)&&!Zn(p)&&p!==n)return{sequenceStart:-1,detectedBaseChar:"",found:!1};break}}return{sequenceStart:t,detectedBaseChar:n,found:t>=0}}function Ey(s){const e=s.slice(0,-1);return/\s/.test(e)}function Iy(s,e,t,n,r){const o=s.slice(t,e).toLowerCase(),i=s.charAt(e-1).toLowerCase();if(e>=2&&s.charAt(e-2),Es(i)){let d=0;for(let u=e-2;u>=0;u--)if(hs(s.charAt(u))){d=u+1;break}s.substring(d,e-1);const p=jy(s,d,e-1);if(p>=0){const u=s.charAt(p),f=u.toLowerCase(),m=ii(f);if(ft[m]){let g="";ds(f,"breve")?g="w":ds(f,"circumflex")?g=m:ds(f,"horn")&&(g="w");const x=m+g+i,v=Cs(m,x);if(v.length>0){const b=v[0],w=u===u.toUpperCase()?b.toUpperCase():b,y=s.substring(0,p),j=s.substring(p+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:y+w+j+S,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let u=e-2;u>=Math.max(0,e-6);u--){const f=s.charAt(u);if(hs(f))break;if(Ny(f)){const m=ii(f);let g="";const x=f.toLowerCase();ds(x,"breve")?g="w":ds(x,"circumflex")?g=m:ds(x,"horn")&&(g="w");const v=m+g+i,b=Cs(m,v);if(b.length>0){const w=b[0],y=s.substring(0,u),j=s.substring(u+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:y+w+j+S,newCursorPos:e-1,realTimeReplacement:!0}}}if(ft[f.toLowerCase()])break}}if(Zn(i)){if(i==="w"){if(s.substring(0,e),n==="u"){const g=s.substring(t,e).toLowerCase();if(g.startsWith("uo")){const x=g.substring(2,g.length-1),v=s.substring(0,t),b=s.substring(e);return{type:"auto-complete",replacement:v+"Æ°Æ¡"+x+b,newCursorPos:t+2+x.length,realTimeReplacement:!0}}}const d=o.toLowerCase();if(d==="uow"||d.endsWith("uow")){const g=s.substring(0,t),x=s.substring(e);return{type:"auto-complete",replacement:g+"Æ°Æ¡"+x,newCursorPos:t+2,realTimeReplacement:!0}}let p=0;for(let g=e-2;g>=0;g--)if(hs(s.charAt(g))){p=g+1;break}const u=s.substring(p,e-1);let f=-1,m="";for(let g=u.length-1;g>=0;g--){const x=u[g];if(es(x.toLowerCase())==="a"){f=p+g,m="a";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(es(x.toLowerCase())==="o"){f=p+g,m="o";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(es(x.toLowerCase())==="u"){f=p+g,m="u";break}}if(f>=0){const g=s.charAt(f),x=g.toLowerCase(),v=ks[x];let b=m;b+="w",v&&(b+=v);const w=Cs(m,b);if(w.length>0){const y=w[0],j=g===g.toUpperCase()?y.toUpperCase():y,S=s.substring(0,f),C=s.substring(f+1,e-1),N=s.substring(e);return{type:"auto-complete",replacement:S+j+C+N,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let d=e-2;d>=Math.max(0,e-6);d--){const p=s.charAt(d).toLowerCase();if(hs(p))break;const u=es(p);if((p===i||u===i)&&ft[i]){const f=i+i;if(ga(i,f)){const g=ks[p],x=g?f+g:f,v=Cs(i,x);if(v.length>0){const b=v[0],w=s.substring(0,d),y=s.substring(d+1,e-1),j=s.substring(e);return{type:"auto-complete",replacement:w+b+y+j,newCursorPos:e-1,realTimeReplacement:!0}}}break}}}if(Ey(o))return{type:"terminate"};const c=Es(i)||Zn(i);let l=!1;if(c)if(Es(i))l=!0;else{const d=o.slice(n.length).toLowerCase();ga(n,d)===null?(e>=2&&s.charAt(e-2).toLowerCase(),t<e-1&&s.charAt(t).toLowerCase()===i&&(l=!0)):l=!0}if(l){const d=Cs(n,o);if(d.length>0){const p=d[0],u=s.substring(0,t),f=s.substring(e);return{type:"auto-complete",replacement:u+p+f,newCursorPos:t+1,realTimeReplacement:!0}}return{type:"terminate"}}else return Ty(s,e,t,n,o)}function Ty(s,e,t,n,r){const i=(t>0?s.charAt(t-1).toLowerCase():"")+r;if(i==="uown"||i==="uow"){const l=s.substring(0,t-1),d=s.substring(e),p=s.charAt(e-1);return{type:"auto-complete",replacement:l+"Æ°Æ¡"+p+d,newCursorPos:t-1+2+1}}const c=Cs(n,r.slice(0,-1));if(c.length>0){const l=c[0],d=s.substring(0,t),p=s.substring(e),u=s.charAt(e-1);return{type:"auto-complete",replacement:d+l+u+p,newCursorPos:t+1+1}}return{type:"terminate"}}function _C(s){return s!==""&&ft[s]!==void 0}function OC(s,e,t,n){const r=t-1;switch(e){case"right":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===c?i:s+1}case"left":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===i?c:s-1}case"down":{const o=s%n,i=Math.floor(s/n),c=Math.ceil((r+1)/n),l=i+1;if(l>=c){const d=o;return d<=r?d:s}else{const d=l*n+o;return d<=r?d:s}}case"up":{const o=s%n,i=Math.floor(s/n);if(i===0){const d=(Math.ceil((r+1)/n)-1)*n+o;return d<=r?d:s}else return(i-1)*n+o}default:return s}}function ci(s){let e=s.replace(/<strong>([^<]*)<\/strong>/g,"**$1**");return e=e.replace(/<em>([^<]*)<\/em>/g,"*$1*"),e=e.replace(/<code>([^<]*)<\/code>/g,"`$1`"),e=e.replace(/<[^>]+>/g,""),e}function $l(s){const e=[],t=[],n=/<th[^>]*>([\s\S]*?)<\/th>/g;let r;for(;(r=n.exec(s))!==null;)e.push(ci(r[1]));const o=s.match(/<tbody>([\s\S]*?)<\/tbody>/);if(o){const i=/<tr>([\s\S]*?)<\/tr>/g;let c;for(;(c=i.exec(o[1]))!==null;){const l=/<td[^>]*>([\s\S]*?)<\/td>/g,d=[];let p;for(;(p=l.exec(c[1]))!==null;)d.push(ci(p[1]));d.length>0&&t.push(d)}}return{headerCells:e,bodyCells:t}}function Ul(s){const{headerCells:e,bodyCells:t}=$l(s);let n=0,r=0;if(e.length>0){const o=e.reduce((i,c)=>i+c.length,0);n+=2+o+(e.length-1)*3+2+1,r++,n+=2+e.length*1+(e.length-1)*3+2+1,r++}for(const o of t){const i=o.reduce((c,l)=>c+l.length,0);n+=2+i+(o.length-1)*3+2+1,r++}return{markdownLength:n,lineCount:r}}function Bl(s){const{headerCells:e,bodyCells:t}=$l(s),n=[];let r=0,o=0;if(e.length>0){r+=2;for(let i=0;i<e.length;i++){const c=e[i],l=c.trim().length>0;n.push({markdownStart:r,content:c,textNodeIndex:l?o:-1,isEmpty:!l,rowIndex:0,colIndex:i}),l&&o++,r+=c.length,i<e.length-1&&(r+=3)}r+=3,r+=2;for(let i=0;i<e.length;i++)r+=1,i<e.length-1&&(r+=3);r+=3}for(let i=0;i<t.length;i++){const c=t[i];r+=2;for(let l=0;l<c.length;l++){const d=c[l],p=d.trim().length>0;n.push({markdownStart:r,content:d,textNodeIndex:p?o:-1,isEmpty:!p,rowIndex:i+1,colIndex:l}),p&&o++,r+=d.length,l<c.length-1&&(r+=3)}r+=2,i<t.length-1&&(r+=1)}return{cells:n,totalLength:r}}function xa(s){var Q,ge,ce,Ae,ke;const e=window.getSelection();if(!e||e.rangeCount===0)return{text:ms(s.innerHTML),cursorPos:0};const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");r.appendChild(n.cloneContents());const o=Array.from(r.children).filter(ve=>{const U=ve.tagName.toLowerCase();return U==="h1"||U==="h2"||U==="h3"||U==="div"||U==="blockquote"||U==="hr"||U==="table"}),i=r.querySelectorAll(".empty-line"),c=Array.from(i).filter(ve=>{var re;return(((re=ve.textContent)==null?void 0:re.trim())||"").length===0});let l=0;const d=t.startContainer;if(d.nodeType===Node.ELEMENT_NODE)(Q=d.classList)!=null&&Q.contains("empty-line")&&(l=1);else if(d.nodeType===Node.TEXT_NODE){const ve=d.parentElement;(ge=ve==null?void 0:ve.classList)!=null&&ge.contains("empty-line")&&(l=1)}const p=o.filter(ve=>!ve.classList.contains("empty-line")),u=c.length,f=(p.length>0?p.length-1:0)+u+l;let m=0;r.querySelectorAll("h1").forEach(()=>{m+=2}),r.querySelectorAll("h2").forEach(()=>{m+=3}),r.querySelectorAll("h3").forEach(()=>{m+=4}),r.querySelectorAll("blockquote").forEach(()=>{m+=2}),r.querySelectorAll("hr").forEach(()=>{m+=3});const g=r.querySelectorAll("h1, h2, h3, blockquote, hr"),x=s.querySelectorAll("h1, h2, h3, blockquote, hr");let v=!1;const b=t.startContainer;for(const ve of x)if(ve.contains(b)){v=!0;break}const w=s.querySelectorAll(".list-item-ul, .list-item-ol");for(const ve of w)if(ve.contains(b))break;const y=s.querySelectorAll("table");let j=null,S=null;for(const ve of y)if(ve.contains(b)){j=ve;const U=ve.querySelectorAll("th, td");for(const re of U)if(re.contains(b)||re===b){S=re;break}break}const C=0;let N=0;x.forEach(ve=>{var re;const U=ve.nextSibling||ve.nextElementSibling;if(U){const G=U.nodeName==="BR"||U.nodeType===Node.ELEMENT_NODE&&U.tagName==="BR",oe=U.nodeType===Node.ELEMENT_NODE&&((re=U.classList)==null?void 0:re.contains("empty-line")),de=U.nodeType===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(U.tagName);!G&&!oe&&!de&&(N+=1)}});let O=g.length;v&&O>0&&(O-=1);const R=Math.min(N,O);m+=R;const k=r.querySelectorAll(":scope > div:not(.list-item-ul):not(.list-item-ol):not(.empty-line):not(.paragraph)");r.querySelectorAll("h1, h2, h3, blockquote, hr, .list-item-ul, .list-item-ol, .paragraph").length===0&&k.length>1&&(m+=k.length-1);const L=r.querySelectorAll(".list-item-ul");L.forEach(()=>{m+=1});const M=r.querySelectorAll(".list-item-ol");M.forEach(()=>{m+=1});const I=L.length+M.length;if(I>1&&(m+=I-1),I>0){let U=(M.length>0?M[M.length-1]:L[L.length-1]).nextSibling;for(;U;){if(U.nodeType===Node.TEXT_NODE){const re=(ce=U.textContent)==null?void 0:ce.replace(new RegExp(Dn,"g"),"").trim();if(re&&re.length>0){m+=1;break}}else if(U.nodeType===Node.ELEMENT_NODE)break;U=U.nextSibling}}const $=(r.textContent||"").replace(new RegExp(Dn,"g"),""),P=Array.from(r.querySelectorAll(".empty-line")).filter(ve=>{var re;return(((re=ve.textContent)==null?void 0:re.trim())||"").length>0}).length;let te=0;const E=ve=>{const U=r.querySelectorAll(ve);let re=0;for(const G of U)!G.closest("table")&&G.textContent&&G.textContent.length>0&&re++;return re};te+=E("strong, b")*4,te+=E("em, i")*2,te+=E("code")*2,te+=E("del, s")*4;let _=0;const F=r.querySelectorAll("table");F.forEach(ve=>{var G,oe;const U=ve.outerHTML,re=ve===F[F.length-1];if(j&&S&&re){const pe=Array.from(j.querySelectorAll("th, td")).findIndex(be=>be===S||be.contains(b)),fe=Array.from(ve.querySelectorAll("th, td"));if(pe>=0){const be=Bl(U);if(pe<be.cells.length){const Pe=be.cells[pe],Ie=t.startOffset,K=Pe.markdownStart+Ie;let D=0;for(let X=0;X<pe;X++)D+=((G=fe[X].textContent)==null?void 0:G.length)||0;D+=Ie,_+=K-D}}}else{const{markdownLength:de}=Ul(U),pe=(ve.textContent||"").length;_+=de-pe;const fe=ve.nextSibling||ve.nextElementSibling,be=(fe==null?void 0:fe.nodeName)==="BR"||(fe==null?void 0:fe.nodeType)===Node.ELEMENT_NODE&&fe.tagName==="BR",Pe=!fe||fe.nodeType===Node.TEXT_NODE&&!((oe=fe.textContent)!=null&&oe.trim()),Ie=(fe==null?void 0:fe.nodeType)===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(fe.tagName);!be&&!Pe&&!Ie&&(_+=1),Ie&&(_-=1)}});const V=$.length+f+m+P+_+te+C;let Y=ms(s.innerHTML);const W=s.innerHTML.replace(new RegExp(Dn+"$"),""),se=/(<br>)+$/.exec(W);if(se){const ve=(se[0].match(/<br>/g)||[]).length,U=(/\n+$/.exec(Y)||[""])[0].length,re=ve-U;re>0&&(Y=Y+`
`.repeat(re))}const le=t.startContainer.nodeType===Node.TEXT_NODE&&t.startContainer.textContent==="â€‹",me=le&&(((ke=(Ae=t.startContainer.parentElement)==null?void 0:Ae.classList)==null?void 0:ke.contains("empty-line"))??!1),H=V+(le&&!me?-1:0);return{text:Y,cursorPos:H}}function Ay(s){const e=s.match(/<th[^>]*>([^<]*)<\/th>/g)||[],t=s.match(/<td[^>]*>([^<]*)<\/td>/g)||[],n=s.match(/<th[^>]*>(?=.*\S)[\s\S]*?<\/th>/g)||[],r=s.match(/<td[^>]*>(?=.*\S)[\s\S]*?<\/td>/g)||[];let o=0;const i=[...new Set([...e,...n])],c=[...new Set([...t,...r])];for(const l of i)l.replace(/<[^>]+>/g,"").trim().length>0&&o++;for(const l of c)l.replace(/<[^>]+>/g,"").trim().length>0&&o++;return o}function Py(s){const e=/<table[^>]*>[\s\S]*?<\/table>/g,t=[];let n=s,r=0,o;for(;(o=e.exec(s))!==null;){const i=o[0],{markdownLength:c,lineCount:l}=Ul(i),d=Ay(i);t.push({start:o.index-r,end:o.index+i.length-r,markdownLength:c,lineCount:l,textNodeCount:d,html:i});const p=`__TABLE_${t.length-1}__`;n=n.slice(0,o.index-r)+p+n.slice(o.index+i.length-r),r+=i.length-p.length}return{processedHtml:n,tables:t}}function Ry(s){return s==="<strong>"||s==="</strong>"||s==="<b>"||s==="</b>"?{type:"formatting",markdownChars:2}:s==="<em>"||s==="</em>"||s==="<i>"||s==="</i>"?{type:"formatting",markdownChars:1}:s.startsWith("<code")||s==="</code>"?{type:"formatting",markdownChars:1}:s==="<del>"||s==="</del>"||s==="<s>"||s==="</s>"?{type:"formatting",markdownChars:2}:null}function Dy(s){const{processedHtml:e,tables:t}=Py(s),n=[];let r=0,o=0,i=0,c=0,l=!1,d=!1,p=!1,u=null;const f=/(__TABLE_(\d+)__)|(<div class="empty-line"><br><\/div>)|(<br>)|(<h([123])>)|(<blockquote[^>]*>)|(<div[^>]*(list-item-(ul|ol))[^>]*>)|(<[^>]+>)|([^<]+)/g;let m;for(;(m=f.exec(e))!==null;)if(m[1]){const g=parseInt(m[2],10),x=t[g];n.push({type:"table",tableIndex:g,markdownLength:x.markdownLength,lineCount:x.lineCount,textNodeCount:x.textNodeCount})}else if(m[3])n.push({type:"br-empty-line",index:i++});else if(m[4])n.push({type:"br-standalone",index:o++});else if(m[5]){const g=parseInt(m[6],10);n.push({type:"header",level:g}),u=g}else if(m[7])n.push({type:"blockquote"});else if(m[8]){const g=m[10];n.push({type:"list-item-start",listType:g,index:c++}),l=g==="ol",p=!0}else if(m[11]){const g=m[11].toLowerCase(),x=m[11],v=Ry(g);v&&n.push(v),(x.includes('class="paragraph"')||x.includes("class='paragraph'"))&&(d=!0),x==="</div>"&&(l=!1,d&&(n.push({type:"block-end"}),d=!1),p&&(n.push({type:"block-end"}),p=!1)),/^<\/h[123]>$/.test(x)&&(u=null,n.push({type:"block-end"})),x==="</blockquote>"&&n.push({type:"block-end"})}else if(m[12]){const g=m[12];if(/^\s+$/.test(g)){r++,n.push({type:"whitespace",length:g.length});continue}const x=g==="â€¢",v=l&&/^\d+\.$/.test(g),b=u!==null,w=u;b&&(u=null),n.push({type:"text",content:g,index:r++,isBullet:x,isOlNumber:v,isHeaderText:b,headerLevel:w}),l&&(l=!1)}return{tokens:n,tables:t,processedHtml:e}}function _y(s,e,t,n,r,o){const i=s-e,c=Bl(t.html);for(let l=0;l<c.cells.length;l++){const d=c.cells[l],p=d.markdownStart,u=p+d.content.length;if(i>=p&&i<=u){if(d.isEmpty)return{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in empty table cell at row ${d.rowIndex}, col ${d.colIndex}`,emptyCellIndex:l,emptyCellRow:d.rowIndex,emptyCellCol:d.colIndex};const f=i-p;return{nodeType:"text",nodeIndex:n+d.textNodeIndex,offset:Math.min(f,d.content.length),expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is within table cell "${d.content.substring(0,20)}" at offset ${f}`}}}if(c.cells.length>0){const l=c.cells[c.cells.length-1],d=l.markdownStart+l.content.length;if(i>=d)return l.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is after last (empty) table cell at row ${l.rowIndex}, col ${l.colIndex}`,emptyCellIndex:c.cells.length-1,emptyCellRow:l.rowIndex,emptyCellCol:l.colIndex}:{nodeType:"text",nodeIndex:n+l.textNodeIndex,offset:l.content.length,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is past last table cell, placing at end of "${l.content.substring(0,20)}"`};{for(let f=0;f<c.cells.length;f++){const m=c.cells[f],g=f>0?c.cells[f-1].markdownStart+c.cells[f-1].content.length:0;if(i>=g&&i<m.markdownStart)return m.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before empty table cell at row ${m.rowIndex}, col ${m.colIndex}`,emptyCellIndex:f,emptyCellRow:m.rowIndex,emptyCellCol:m.colIndex}:{nodeType:"text",nodeIndex:n+m.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before cell "${m.content.substring(0,20)}", placing at start`}}const p=c.cells[0];return p.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing in empty first cell`,emptyCellIndex:0,emptyCellRow:p.rowIndex,emptyCellCol:p.colIndex}:{nodeType:"text",nodeIndex:n+p.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing at start of first cell`}}}return{nodeType:"text",nodeIndex:(n>0?n-1:0)+o,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!1,explanation:`Position ${s} is within table but no cells found`}}function Oy(s,e,t,n,r,o){const i=t;let c;s.isBullet?c=2:s.isOlNumber?c=s.content.length+1:c=s.content.length;const l=i,d=i+c;if(s.isBullet||s.isOlNumber?e>=l&&e<d:e>=l&&e<=d){const u=s.index+r;if(s.isBullet){const f=Math.min(e-l,1);return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within bullet text node #${u} at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else if(s.isOlNumber){const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within OL number text node #${u} "${s.content}" at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else{const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within text node #${u} "${s.content.substring(0,20)}..." at offset ${f}`},newPos:d,adjustedPos:i}}}return{placement:null,newPos:d,adjustedPos:i}}function li(s,e,t,n,r,o,i){const c=n+1;return t===n?{nodeType:s,nodeIndex:e,offset:0,expectedLine:r-1,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!0,explanation:`Position ${t} is at ${s} #${e}`}:t===c&&s==="br-standalone"?{nodeType:s,nodeIndex:e,offset:i?1:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!1,explanation:`Position ${t} is after ${s} #${e}`}:null}function Ly(s,e){const{tokens:t,tables:n}=Dy(s);let r=0,o=1,i=!1,c=!1,l=0,d=0,p=0,u=!1;for(let m=0;m<t.length;m++){const g=t[m];if(g.type==="header"){l=g.level+1,c=!1;continue}if(g.type==="formatting"){r+=g.markdownChars;continue}if(g.type==="whitespace"){r+=g.length;continue}if(g.type==="block-end"){u=!0;continue}if(g.type==="blockquote"){r+=2,c=!1;continue}if(g.type==="table"){u&&(r+=1,o++,u=!1);const x=r,v=r+g.markdownLength,b=n[g.tableIndex];if(e>=x&&e<v){const w=_y(e,x,b,p,o,d);if(w)return w}r=v,o+=g.lineCount,d+=g.textNodeCount,c=!1;continue}if(g.type==="list-item-start"){u?(r+=1,o++,u=!1):i&&!c&&(r+=1,o++),i=!0,c=!1;continue}if(g.type==="text"){if(u){if(e===r)return{nodeType:"text",nodeIndex:g.index+d,offset:0,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at implicit newline after block element`};r+=1,o++,u=!1}l>0&&(r+=l,l=0);const x=Oy(g,e,r,o,d);if(x.placement)return x.placement;r=x.newPos,p++,c=!1}else if(g.type==="br-standalone"){u&&(u=!1),o++;const x=li("br-standalone",g.index,e,r,o,d,!1);if(x)return x;r+=1,c=!0,i=!1}else if(g.type==="br-empty-line"){u&&(r+=1,o++,u=!1),o++;const x=li("br-empty-line",g.index,e,r,o,d,!0);if(x)return x;r+=1,c=!0,i=!1}}const f=t[t.length-1];if((f==null?void 0:f.type)==="text"){const m=f.index+d;return{nodeType:"text",nodeIndex:m,offset:f.content.length,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at end of last text node #${m}`}}return{nodeType:"end",nodeIndex:0,offset:0,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is beyond content (currentPos=${r})`}}function rn(s,e){var o;const t=window.getSelection();if(!t)return;const n=Ly(s.innerHTML,e),r=document.createRange();if(n.nodeType==="text"){let i;if(n.insideTableCell)i=n.nodeIndex;else if(n.tableTextNodeOffset===0)i=n.nodeIndex;else{const f=s.querySelectorAll("table");let m=0;f.forEach(x=>{const v=document.createTreeWalker(x,NodeFilter.SHOW_TEXT);for(;v.nextNode()!==null;)m++});const g=n.tableTextNodeOffset;i=n.nodeIndex-g+m}const c=document.createTreeWalker(s,NodeFilter.SHOW_TEXT);let l=null,d=0,p=null;const u=[];for(;(l=c.nextNode())!==null;){p=l;const f=l.textContent||"";if(u.push(`[${d}]: "${f.substring(0,30)}${f.length>30?"...":""}"`),d===i){const m=(l.textContent||"").length,g=Math.min(n.offset,m);if(n.atListItemStart){const x=(o=l.parentElement)==null?void 0:o.closest(".list-item-ul, .list-item-ol");if(x!=null&&x.parentNode){const v=document.createTextNode("â€‹");x.parentNode.insertBefore(v,x),r.setStart(v,1),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.setStart(l,g),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}d++}if(p){const f=(p.textContent||"").length;r.setStart(p,f),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}if(n.nodeType==="empty-table-cell"){const i=s.querySelector("table");if(i){const c=i.querySelectorAll("tr");let l=null,d=null;if(n.emptyCellRow===0)l=c[0],l&&(d=l.querySelectorAll("th")[n.emptyCellCol??0]);else{const p=i.querySelector("tbody");p?l=p.querySelectorAll("tr")[(n.emptyCellRow??1)-1]:l=c[n.emptyCellRow??1],l&&(d=l.querySelectorAll("td")[n.emptyCellCol??0])}if(d){const p=document.createTextNode("â€‹");d.appendChild(p),r.setStart(p,0),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}}if(n.nodeType==="br-standalone"){const i=s.querySelectorAll("br");let c=0;for(const l of i){const d=l.parentElement,p=d==null?void 0:d.classList.contains("empty-line"),u=l.closest("table")!==null;if(`${c}${d==null?void 0:d.tagName}${p}${u}`,!p&&!u){if(c===n.nodeIndex){if(n.placeBefore)r.setStartBefore(l),r.collapse(!0);else{const f=l.nextSibling;if(f)if(f.nodeType===Node.TEXT_NODE)r.setStart(f,0);else if(f.tagName==="BR"){const m=document.createTextNode("â€‹");l.parentNode.insertBefore(m,f),r.setStart(m,1)}else{const m=document.createTextNode("â€‹");l.parentNode.insertBefore(m,f),r.setStart(m,1)}else{const m=document.createTextNode("â€‹");l.parentNode.appendChild(m),r.setStart(m,1)}r.collapse(!0)}t.removeAllRanges(),t.addRange(r);return}c++}}}if(n.nodeType==="br-empty-line"){const c=s.querySelectorAll(".empty-line")[n.nodeIndex];if(c){if(n.placeBefore)r.setStart(c,0);else{const l=c.querySelector("br"),d=document.createTextNode("â€‹");l&&l.nextSibling?c.insertBefore(d,l.nextSibling):c.appendChild(d),r.setStart(d,1)}r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.selectNodeContents(s),r.collapse(!1),t.removeAllRanges(),t.addRange(r)}function to(s){let e="";function t(n){var r;if(n.nodeType===Node.TEXT_NODE)e+=n.textContent||"";else if(n.nodeType===Node.ELEMENT_NODE){const o=n,i=o.tagName.toLowerCase();if(i==="br")e+=`
`;else if(i==="div"||i==="p"){const c=o.childNodes.length===1&&((r=o.firstChild)==null?void 0:r.nodeName)==="BR";e.length>0&&!e.endsWith(`
`)&&!c&&(e+=`
`),o.childNodes.forEach(t)}else o.childNodes.forEach(t)}}return s.childNodes.forEach(t),e}function My(s){let e=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return e.endsWith("<br>")&&(e+="â€‹"),e}function Fy(s){const e=window.getSelection();if(!e||e.rangeCount===0)return 0;const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");return r.appendChild(n.cloneContents()),to(r).length}function $y(s,e){const t=window.getSelection();if(!t)return;let n=0;const r=document.createTreeWalker(s,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let o=r.nextNode();for(;o;){if(o.nodeType===Node.TEXT_NODE){const l=(o.textContent||"").length;if(n+l>=e){const d=document.createRange(),p=e-n;d.setStart(o,Math.min(p,l)),d.collapse(!0),t.removeAllRanges(),t.addRange(d);return}n+=l}else o.nodeName==="BR"&&(n+=1);o=r.nextNode()}const i=document.createRange();i.selectNodeContents(s),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}function Uy(s){const{editorRef:e,applyingActionRef:t,value:n,isRawMode:r,setInternalValue:o,onChange:i}=s,c=h.useCallback(()=>{if(!e.current)return null;if(r){const d=to(e.current),p=Fy(e.current);return{text:d,cursorPos:p}}else{const{cursorPos:d}=xa(e.current);return{text:n??xa(e.current).text,cursorPos:d}}},[e,r,n]),l=h.useCallback((d,p)=>{if(!e.current)return;t.current=!0;let u;if(d.replaceTextAfterCursor!==void 0?u=p.substring(0,d.selectionStart)+d.textToInsert+d.replaceTextAfterCursor:u=p.substring(0,d.selectionStart)+d.textToInsert+p.substring(d.selectionEnd),r)e.current.innerHTML=My(u),$y(e.current,d.newCursorPosition);else{const f=ot(u);e.current.innerHTML=f,rn(e.current,d.newCursorPosition)}n===void 0&&o(u),i==null||i(u),setTimeout(()=>{t.current=!1},0)},[e,r,n,o,i,t]);return{getTextAndCursor:c,applyAction:l}}function By(s){const{applyAction:e}=s,t=h.useCallback((o,i,c)=>{if(!c.hasSelection||o.metaKey||o.ctrlKey||o.altKey)return!1;const l=$f(o.key);if(!l)return!1;o.preventDefault();const d=Lo(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),n=h.useCallback((o,i,c)=>{if(!(o.metaKey||o.ctrlKey)||!c.hasSelection)return!1;const l=Ff(o.key);if(!l)return!1;o.preventDefault();const d=Lo(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),r=h.useCallback(o=>(o.metaKey||o.ctrlKey)&&!zf(o.key),[]);return{handleAutoWrap:t,handleFormatShortcut:n,shouldPassThrough:r}}class Wy{constructor(e){this.apiClient=e}log(e,t){try{const{customLogFile:n,...r}=t||{};this.apiClient.sendLogs(e,r,n)}catch(n){console.error("[ClientLogsService] Failed to log event:",e,n)}}logCritical(e,t){try{return this.apiClient.sendBeacon(e,t)}catch(n){return console.error("[ClientLogsService] Failed to log critical event:",e,n),!1}}async clearLogs(){try{return await this.apiClient.clearLogs()}catch(e){return console.error("[ClientLogsService] Failed to clear logs:",e),!1}}}class zy{constructor(e){this.client=e}async log(e,t){await this.client.sendLogs(e,t)}logCritical(e,t){return this.client.sendBeacon(e,t)}}class Hy{constructor(e={}){ee(this,"_clientLogsApiClient",null);ee(this,"_clientLogsService",null);ee(this,"_logger",null);ee(this,"_config");this._config={clientLogsApiBaseUrl:e.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",clientLogsEnabled:e.clientLogsEnabled!==!1}}get clientLogsApiClient(){return this._clientLogsApiClient||(this._clientLogsApiClient=new Oa(this._config.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",5e3)),this._clientLogsApiClient}get clientLogsService(){return this._clientLogsService||(this._clientLogsService=new Wy(this.clientLogsApiClient)),this._clientLogsService}get logger(){return this._logger||(this._logger=new zy(this.clientLogsApiClient)),this._logger}setConfig(e){this._config={...this._config,...e},this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}setClientLogsApiClient(e){this._clientLogsApiClient=e,this._clientLogsService=null,this._logger=null}reset(){this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}}const Pr=new Hy;class ye{constructor(e,t,n,r){this.isSuccess=e,this.isFailure=t,this._value=n,this._error=r}get value(){if(!this.isSuccess)throw new Error("Cannot get value from a failure result");return this._value}get error(){if(!this.isFailure)throw new Error("Cannot get error from a success result");return this._error}static success(e){return new ye(!0,!1,e,void 0)}static failure(e){return new ye(!1,!0,void 0,e)}}class Rr extends Error{constructor(e){super(`User not found: ${e}`),this.userId=e,this.name="UserNotFoundError"}}class Gy extends Error{constructor(){super("Username cannot be empty"),this.name="UsernameEmptyError"}}class qy extends Error{constructor(e){super(`Username must be at least ${e} characters`),this.minLength=e,this.name="UsernameTooShortError"}}class Vy extends Error{constructor(e){super(`Username cannot exceed ${e} characters`),this.maxLength=e,this.name="UsernameTooLongError"}}function gr(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():typeof crypto<"u"&&typeof crypto.getRandomValues=="function"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return(s==="x"?e:e&3|8).toString(16)}):(console.warn("[UUID] Using Math.random() fallback - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}))}class Ht{constructor(e,t,n,r,o,i,c){this.id=e,this.username=t,this.profilePicture=n,this.isOnline=r,this.lastSeen=o,this.createdAt=i,this.updatedAt=c,this.validate()}validate(){if(!this.id.trim())throw new Error("User ID cannot be empty");if(!this.username.trim())throw new Error("Username cannot be empty");if(this.username.length<2)throw new Error("Username must be at least 2 characters");if(this.username.length>50)throw new Error("Username cannot exceed 50 characters")}static create(e,t){const n=new Date().toISOString();return new Ht(gr(),e.trim(),t,!1,n,n,n)}static fromData(e){return new Ht(e.id,e.username,e.profilePicture,e.isOnline,e.lastSeen,e.createdAt,e.updatedAt)}setOnline(e){return new Ht(this.id,this.username,this.profilePicture,e,new Date().toISOString(),this.createdAt,new Date().toISOString())}updateProfile(e,t){return new Ht(this.id,(e==null?void 0:e.trim())||this.username,t!==void 0?t:this.profilePicture,this.isOnline,this.lastSeen,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,username:this.username,profilePicture:this.profilePicture,isOnline:this.isOnline,lastSeen:this.lastSeen,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Ky{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;console.log("[CreateUserUseCase] Executing with command:",e);try{const n=e.username.trim();if(n.length===0)return console.log("[CreateUserUseCase] Validation failed: Username is empty"),ye.failure(new Gy);if(n.length<2)return console.log("[CreateUserUseCase] Validation failed: Username too short"),ye.failure(new qy(2));if(n.length>50)return console.log("[CreateUserUseCase] Validation failed: Username too long"),ye.failure(new Vy(50));console.log("[CreateUserUseCase] Validation passed, creating user entity");const r=Ht.create(n,e.profilePicture);console.log("[CreateUserUseCase] User entity created:",r),console.log("[CreateUserUseCase] Calling repository.create...");const o=await this.repository.create(r);return console.log("[CreateUserUseCase] User persisted successfully:",o),(t=this.logger)==null||t.log("user_created",{userId:o.id,usernameLength:n.length,hasProfilePicture:!!e.profilePicture}),console.log("[CreateUserUseCase] Returning success result"),ye.success(o)}catch(n){return console.error("[CreateUserUseCase] CAUGHT ERROR:",n),ye.failure(n instanceof Error?n:new Error("Failed to create user"))}}}class Ps{constructor(e,t,n,r,o,i,c,l,d,p){this.id=e,this.gameId=t,this.senderId=n,this.senderUsername=r,this.senderProfilePicture=o,this.text=i,this.timestamp=c,this.createdAt=l,this.isPersona=d,this.isIntroduction=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Message ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.senderId.trim())throw new Error("Sender ID cannot be empty");if(!this.senderUsername.trim())throw new Error("Sender username cannot be empty");if(!this.text.trim())throw new Error("Message text cannot be empty");if(this.text.length>500)throw new Error("Message text cannot exceed 500 characters")}static create(e,t,n,r,o,i,c){const l=new Date().toISOString();return new Ps(gr(),e.trim(),t.trim(),n.trim(),r,o.trim(),l,l,i,c)}static fromData(e){return new Ps(e.id,e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,e.text,e.timestamp,e.createdAt,e.isPersona,e.isIntroduction)}toJSON(){return{id:this.id,gameId:this.gameId,senderId:this.senderId,senderUsername:this.senderUsername,senderProfilePicture:this.senderProfilePicture,text:this.text,timestamp:this.timestamp,createdAt:this.createdAt,isPersona:this.isPersona,isIntroduction:this.isIntroduction}}}class Jy{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t,n;try{const r=e.text.trim();if(r.length===0)return ye.failure(new Error("Message text cannot be empty"));if(r.length>500)return ye.failure(new Error("Message text cannot exceed 500 characters"));if(!e.gameId.trim())return ye.failure(new Error("Game ID is required"));if(!e.senderId.trim())return ye.failure(new Error("Sender ID is required"));if(!e.senderUsername.trim())return ye.failure(new Error("Sender username is required"));const o=Ps.create(e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,r),i=await this.repository.create(o);if(i.isFailure)return i;const c=/@(\w+)/g,l=Array.from(r.matchAll(c)).map(p=>p[1]);l.length>0&&!e.isFromPersona&&((t=this.logger)==null||t.log("persona_mentioned",{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,mentionedNames:l,mentionCount:l.length}));const d=e.isFromPersona?"persona_message_sent":"chat_message_sent";return(n=this.logger)==null||n.log(d,{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,messageLength:r.length,isFromPersona:e.isFromPersona||!1,hasMentions:l.length>0}),ye.success(i.value)}catch(r){return ye.failure(r instanceof Error?r:new Error("Failed to send message"))}}}class Yy{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;try{if(!e.gameId.trim())return ye.failure(new Error("Game ID is required"));const n=await this.repository.findByGameId(e.gameId);return n.isFailure?n:((t=this.logger)==null||t.log("chat_messages_loaded",{gameId:e.gameId,messageCount:n.value.length}),ye.success(n.value))}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to retrieve messages"))}}}class Xy{constructor(e,t,n,r){ee(this,"_createUserUseCase");ee(this,"_sendMessageUseCase");ee(this,"_getMessagesUseCase");this.userRepository=e,this.chatRepository=t,this.webSocketService=n,this.logger=r}async createUser(e){var n;this._createUserUseCase||(this._createUserUseCase=new Ky(this.userRepository,this.logger));const t=await this._createUserUseCase.execute(e);if(t.isSuccess){const r=await this.setUserOnline({userId:t.value.id,isOnline:!0});if((n=this.logger)==null||n.log("user_set_online",{userId:t.value.id,isOnline:!0,triggeredBy:"user_creation"}),r.isSuccess)return ye.success(r.value)}return t}async updateUser(e){try{const t=await this.userRepository.getById(e.userId);if(!t)return ye.failure(new Rr(e.userId));const n=t.updateProfile(e.username,e.profilePicture),r=await this.userRepository.update(n);return ye.success(r)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to update user"))}}async setUserOnline(e){var t;try{const n=await this.userRepository.getById(e.userId);if(!n)return ye.failure(new Rr(e.userId));const r=n.setOnline(e.isOnline),o=await this.userRepository.update(r);return(t=this.logger)==null||t.log("user_online_status_changed",{userId:e.userId,username:n.username,previousStatus:n.isOnline,newStatus:e.isOnline}),ye.success(o)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to set user online status"))}}async deleteUser(e){try{return await this.userRepository.delete(e.userId),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to delete user"))}}async getAllUsers(e){try{let t=await this.userRepository.getAll();return e.onlineOnly&&(t=t.filter(n=>n.isOnline)),ye.success(t)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to get users"))}}async getUserById(e){try{const t=await this.userRepository.getById(e.userId);return t?ye.success(t):ye.failure(new Rr(e.userId))}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to get user"))}}async connect(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to connect"))}}async disconnect(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return await this.webSocketService.disconnect(),ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to disconnect"))}}async joinLobby(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to join lobby"))}}async leaveLobby(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to leave lobby"))}}async sendMessage(e){return this._sendMessageUseCase||(this._sendMessageUseCase=new Jy(this.chatRepository,this.logger)),this._sendMessageUseCase.execute(e)}async clearMessages(e){var t;try{return await this.chatRepository.deleteByGameId(e.gameId),(t=this.logger)==null||t.log("chat_messages_cleared",{gameId:e.gameId}),ye.success(void 0)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to clear messages"))}}async getMessages(e){return this._getMessagesUseCase||(this._getMessagesUseCase=new Yy(this.chatRepository,this.logger)),this._getMessagesUseCase.execute(e)}}class Nt{constructor(e,t,n,r,o,i,c,l,d,p){this.id=e,this.name=t,this.gameType=n,this.players=r,this.status=o,this.currentTurn=i,this.winner=c,this.gameData=l,this.createdAt=d,this.updatedAt=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Game ID cannot be empty");if(this.players.length===0)throw new Error("Game must have at least one player")}static create(e,t,n){const r=new Date().toISOString(),o={metadata:{}};return new Nt(gr(),n,t,[e],"waiting",void 0,void 0,o,r,r)}static fromData(e){return new Nt(e.id,e.name,e.gameType,e.players,e.status,e.currentTurn,e.winner,e.gameData,e.createdAt,e.updatedAt)}addPlayer(e){if(this.players.includes(e))throw new Error("Player already in game");if(this.players.length>=10)throw new Error("Lobby is full");const n=[...this.players,e],r=n.length>=2?"ready":"waiting";return new Nt(this.id,this.name,this.gameType,n,r,this.currentTurn,this.winner,this.gameData,this.createdAt,new Date().toISOString())}start(){if(this.status!=="ready")throw new Error("Lobby must be in ready state to start");return new Nt(this.id,this.name,this.gameType,this.players,"in_progress",this.players[0],this.winner,this.gameData,this.createdAt,new Date().toISOString())}updateGameData(e,t){return new Nt(this.id,this.name,this.gameType,this.players,this.status,t!==void 0?t:this.currentTurn,this.winner,e,this.createdAt,new Date().toISOString())}complete(e){return new Nt(this.id,this.name,this.gameType,this.players,"completed",void 0,e,this.gameData,this.createdAt,new Date().toISOString())}abandon(){return new Nt(this.id,this.name,this.gameType,this.players,"abandoned",void 0,this.winner,this.gameData,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,name:this.name,gameType:this.gameType,players:this.players,status:this.status,currentTurn:this.currentTurn,winner:this.winner,gameData:this.gameData,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class kt{constructor(e,t,n,r,o,i,c,l){this.id=e,this.gameId=t,this.name=n,this.description=r,this.emoji=o,this.isActive=i,this.createdAt=c,this.updatedAt=l,this.validate()}validate(){if(!this.id.trim())throw new Error("Persona ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.name.trim())throw new Error("Persona name cannot be empty");if(this.name.length<2)throw new Error("Persona name must be at least 2 characters");if(this.name.length>50)throw new Error("Persona name cannot exceed 50 characters");if(!this.description.trim())throw new Error("Persona description cannot be empty");if(this.description.length<5)throw new Error("Persona description must be at least 5 characters");if(this.description.length>500)throw new Error("Persona description cannot exceed 500 characters")}static create(e,t,n,r){const o=new Date().toISOString();return new kt(gr(),e.trim(),t.trim(),n.trim(),r.trim(),!1,o,o)}static fromData(e){return new kt(e.id,e.gameId,e.name,e.description,e.emoji,e.isActive,e.createdAt,e.updatedAt)}activate(){return this.isActive?this:new kt(this.id,this.gameId,this.name,this.description,this.emoji,!0,this.createdAt,new Date().toISOString())}deactivate(){return this.isActive?new kt(this.id,this.gameId,this.name,this.description,this.emoji,!1,this.createdAt,new Date().toISOString()):this}update(e,t,n){return new kt(this.id,this.gameId,(e==null?void 0:e.trim())||this.name,(t==null?void 0:t.trim())||this.description,(n==null?void 0:n.trim())||this.emoji,this.isActive,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,gameId:this.gameId,name:this.name,description:this.description,emoji:this.emoji,isActive:this.isActive,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Qy{constructor(e,t=5e3){this.baseUrl=e,this.timeout=t}async createUser(e){const t=`${this.baseUrl}/users`;console.log("[HttpGameService.createUser] Making POST request to:",t),console.log("[HttpGameService.createUser] Request body:",e);try{const n=await this.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("[HttpGameService.createUser] Response received:",n.status);const r=await n.json();return console.log("[HttpGameService.createUser] Response data:",r),{user:Ht.fromData(r.user)}}catch(n){throw console.error("[HttpGameService.createUser] ERROR:",n),n}}async getUser(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"GET"})).json();return{user:Ht.fromData(n.user)}}async getAllUsers(){return{users:(await(await this.fetchWithTimeout(`${this.baseUrl}/users`,{method:"GET"})).json()).users.map(n=>Ht.fromData(n))}}async updateUser(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{user:Ht.fromData(r.user)}}async createGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{game:Nt.fromData(n.game)}}async getGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"GET"})).json();return{game:Nt.fromData(n.game)}}async getAllGames(e){const t=new URLSearchParams;e!=null&&e.status&&t.append("status",e.status),e!=null&&e.gameType&&t.append("gameType",e.gameType),e!=null&&e.playerId&&t.append("playerId",e.playerId);const n=`${this.baseUrl}/games${t.toString()?`?${t.toString()}`:""}`;return{games:(await(await this.fetchWithTimeout(n,{method:"GET"})).json()).games.map(i=>Nt.fromData(i))}}async joinGame(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{game:Nt.fromData(r.game)}}async startGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/start`,{method:"POST"})}async deleteGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"DELETE"})}async createChatMessage(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e.gameId}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderId:e.senderId,senderUsername:e.senderUsername,text:e.text})})).json();return{message:Ps.fromData(n.message)}}async getChatMessages(e){return{messages:(await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"GET"})).json()).messages.map(r=>Ps.fromData(r))}}async clearChatMessages(e){return await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"DELETE"})).json()}async createPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{persona:kt.fromData(n.persona)}}async getPersonas(e){return{personas:(await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"GET"})).json()).personas.map(r=>kt.fromData(r))}}async getPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/detail/${e}`,{method:"GET"})).json();return{persona:kt.fromData(n.persona)}}async updatePersona(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{persona:kt.fromData(r.persona)}}async deletePersona(e){await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"DELETE"})}async activatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/activate`,{method:"POST"})).json();return{persona:kt.fromData(n.persona)}}async deactivatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/deactivate`,{method:"POST"})).json();return{persona:kt.fromData(n.persona)}}async fetchWithTimeout(e,t){console.log("[fetchWithTimeout] Starting fetch to:",e),console.log("[fetchWithTimeout] Method:",t.method),console.log("[fetchWithTimeout] Timeout:",this.timeout+"ms");const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});if(console.log("[fetchWithTimeout] Response status:",o.status,o.statusText),!o.ok){const i=`HTTP error! status: ${o.status}`;throw console.error("[fetchWithTimeout]",i),new Error(i)}return o}catch(o){if(o instanceof Error&&o.name==="AbortError"){const i=`Request timeout after ${this.timeout}ms`;throw console.error("[fetchWithTimeout]",i),new Error(i)}throw console.error("[fetchWithTimeout] Network error:",o),o}finally{clearTimeout(r)}}}var jt=(s=>(s.DISCONNECTED="DISCONNECTED",s.CONNECTING="CONNECTING",s.CONNECTED="CONNECTED",s.RECONNECTING="RECONNECTING",s.ERROR="ERROR",s))(jt||{});class Zy{constructor(){ee(this,"ws",null);ee(this,"config",null);ee(this,"connectionState",jt.DISCONNECTED);ee(this,"messageHandlers",new Set);ee(this,"stateHandlers",new Set);ee(this,"reconnectAttempts",0);ee(this,"reconnectTimeoutId",null);ee(this,"heartbeatIntervalId",null)}async connect(e){return this.config=e,this.reconnectAttempts=0,this.doConnect()}async disconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null),this.ws&&(this.ws.close(),this.ws=null),this.updateConnectionState(jt.DISCONNECTED)}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");const t={...e,timestamp:new Date().toISOString()};this.ws.send(JSON.stringify(t))}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}onConnectionStateChange(e){return this.stateHandlers.add(e),()=>{this.stateHandlers.delete(e)}}getConnectionState(){return this.connectionState}isConnected(){return this.connectionState===jt.CONNECTED}async doConnect(){if(!this.config)throw new Error("Config not set");return new Promise((e,t)=>{this.updateConnectionState(this.reconnectAttempts>0?jt.RECONNECTING:jt.CONNECTING),this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("[WebSocket] Connected"),this.reconnectAttempts=0,this.updateConnectionState(jt.CONNECTED),this.startHeartbeat(),e()},this.ws.onmessage=n=>{try{const r=JSON.parse(n.data);this.handleMessage(r)}catch(r){console.error("[WebSocket] Failed to parse message:",r)}},this.ws.onerror=n=>{console.error("[WebSocket] Error:",n),this.updateConnectionState(jt.ERROR),t(n)},this.ws.onclose=()=>{console.log("[WebSocket] Disconnected"),this.stopHeartbeat(),this.connectionState!==jt.DISCONNECTED&&this.attemptReconnect()}})}handleMessage(e){e.type!=="pong"&&this.messageHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] Message handler error:",n)}})}attemptReconnect(){if(!this.config)return;const e=this.config.maxReconnectAttempts??10;if(this.reconnectAttempts>=e){console.error(`[WebSocket] Max reconnection attempts (${e}) reached`),this.updateConnectionState(jt.ERROR);return}this.reconnectAttempts++;const t=this.config.reconnectInterval??3e3;console.log(`[WebSocket] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${e})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.doConnect().catch(n=>{console.error("[WebSocket] Reconnection failed:",n)})},t)}startHeartbeat(){if(!this.config)return;const e=this.config.heartbeatInterval??3e4;this.heartbeatIntervalId=window.setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping"}).catch(t=>{console.error("[WebSocket] Failed to send heartbeat:",t)})},e)}stopHeartbeat(){this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null)}updateConnectionState(e){this.connectionState!==e&&(this.connectionState=e,this.stateHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] State handler error:",n)}}))}}class eS{constructor(e){this.httpService=e}async getAll(e){return(await this.httpService.getAllGames(e)).games}async getById(e){try{return(await this.httpService.getGame(e)).game}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){return(await this.httpService.createGame({gameType:e.gameType||"tic-tac-toe",creatorId:e.players[0]})).game}async update(e){return e}async delete(e){await this.httpService.deleteGame(e)}}class tS{constructor(e){this.httpService=e}async getAll(){return(await this.httpService.getAllUsers()).users}async getById(e){try{return(await this.httpService.getUser(e)).user}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){console.log("[HttpUserRepository.create] Creating user:",{username:e.username,id:e.id});try{const t=await this.httpService.createUser({username:e.username,profilePicture:e.profilePicture});return console.log("[HttpUserRepository.create] User created successfully:",t.user),t.user}catch(t){throw console.error("[HttpUserRepository.create] ERROR:",t),t}}async update(e){return(await this.httpService.updateUser(e.id,{isOnline:e.isOnline,profilePicture:e.profilePicture})).user}async delete(e){console.warn("[HttpUserRepository] Delete not implemented")}}class sS{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createChatMessage({gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,text:e.text});return ye.success(t.message)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to create chat message"))}}async findByGameId(e){try{const t=await this.httpService.getChatMessages(e);return ye.success(t.messages)}catch(t){return t instanceof Error&&t.message.includes("404")?ye.success([]):ye.failure(t instanceof Error?t:new Error("Failed to retrieve chat messages"))}}async deleteByGameId(e){try{return await this.httpService.clearChatMessages(e),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to clear chat messages"))}}}class nS{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createPersona({gameId:e.gameId,name:e.name,description:e.description,emoji:e.emoji});return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to create persona"))}}async findByGameId(e){try{const t=await this.httpService.getPersonas(e);return ye.success(t.personas)}catch(t){return t instanceof Error&&t.message.includes("404")?ye.success([]):ye.failure(t instanceof Error?t:new Error("Failed to retrieve personas"))}}async findById(e){try{const t=await this.httpService.getPersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to retrieve persona"))}}async update(e,t){try{const n=await this.httpService.updatePersona(e,{name:t.name,description:t.description,emoji:t.emoji,isActive:t.isActive});return ye.success(n.persona)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to update persona"))}}async delete(e){try{return await this.httpService.deletePersona(e),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to delete persona"))}}async activate(e){try{const t=await this.httpService.activatePersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to activate persona"))}}async deactivate(e){try{const t=await this.httpService.deactivatePersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to deactivate persona"))}}}class rS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.create(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_created",{personaId:t.value.id,gameId:e.gameId,name:e.name,description:e.description,isActive:t.value.isActive})),t}}class aS{constructor(e){this.personaRepository=e}async execute(e){return await this.personaRepository.findByGameId(e)}}class oS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t){var r;const n=await this.personaRepository.update(e,t);return n.isSuccess&&((r=this.logger)==null||r.log("persona_updated",{personaId:e,updates:t,name:n.value.name,gameId:n.value.gameId})),n}}class iS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.delete(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_deleted",{personaId:e})),t}}class cS{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t=!0){var r;const n=t?await this.personaRepository.activate(e):await this.personaRepository.deactivate(e);if(n.isSuccess){const o=t?"persona_activated":"persona_deactivated";(r=this.logger)==null||r.log(o,{personaId:e,isActive:t,name:n.value.name,gameId:n.value.gameId})}return n}}const so="CONNECT_REQUEST",Wl="CONNECT_SUCCESS",zl="CONNECT_FAILURE",no="DISCONNECT",Hl="CONNECTION_STATE_CHANGED",Gl="CREATE_USER_REQUEST",ql="CREATE_USER_SUCCESS",Vl="CREATE_USER_FAILURE",Kl="UPDATE_USER_REQUEST",Jl="UPDATE_USER_SUCCESS",Yl="UPDATE_USER_FAILURE",Xl="FETCH_USERS_REQUEST",Ql="FETCH_USERS_SUCCESS",Zl="FETCH_USERS_FAILURE",ed="SET_USER_ONLINE_REQUEST",td="SET_USER_ONLINE_SUCCESS",sd="SET_USER_ONLINE_FAILURE",nd="SET_CURRENT_USER",lS="CREATE_GAME_REQUEST",dS="CREATE_GAME_SUCCESS",uS="CREATE_GAME_FAILURE",pS="JOIN_GAME_REQUEST",hS="JOIN_GAME_SUCCESS",fS="JOIN_GAME_FAILURE",mS="START_GAME_REQUEST",gS="START_GAME_SUCCESS",xS="START_GAME_FAILURE",vS="MAKE_MOVE_REQUEST",bS="MAKE_MOVE_SUCCESS",wS="MAKE_MOVE_FAILURE",yS="LEAVE_GAME_REQUEST",SS="LEAVE_GAME_SUCCESS",jS="LEAVE_GAME_FAILURE",CS="FETCH_GAMES_REQUEST",NS="FETCH_GAMES_SUCCESS",kS="FETCH_GAMES_FAILURE",ES="GAME_UPDATED",IS="GAME_ENDED",rd="USER_LIST_UPDATED",ad="SEND_MESSAGE_REQUEST",od="SEND_MESSAGE_SUCCESS",id="SEND_MESSAGE_FAILURE",cd="FETCH_MESSAGES_REQUEST",ld="FETCH_MESSAGES_SUCCESS",dd="FETCH_MESSAGES_FAILURE",ud="CLEAR_MESSAGES_REQUEST",pd="CLEAR_MESSAGES_SUCCESS",hd="CLEAR_MESSAGES_FAILURE",fd="CHAT_MESSAGE_RECEIVED",md="CREATE_PERSONA_REQUEST",gd="CREATE_PERSONA_SUCCESS",xd="CREATE_PERSONA_FAILURE",vd="FETCH_PERSONAS_REQUEST",bd="FETCH_PERSONAS_SUCCESS",wd="FETCH_PERSONAS_FAILURE",yd="UPDATE_PERSONA_REQUEST",Sd="UPDATE_PERSONA_SUCCESS",jd="UPDATE_PERSONA_FAILURE",Cd="DELETE_PERSONA_REQUEST",Nd="DELETE_PERSONA_SUCCESS",kd="DELETE_PERSONA_FAILURE",Ed="ACTIVATE_PERSONA_REQUEST",Id="ACTIVATE_PERSONA_SUCCESS",Td="ACTIVATE_PERSONA_FAILURE",Ad="PERSONA_CREATED",Pd="PERSONA_UPDATED",Rd="PERSONA_DELETED",Dd="PERSONA_ACTIVATED",_d="PERSONA_DEACTIVATED",TS="SET_SELECTED_GAME",AS="CLEAR_ERROR",LC=()=>({type:so}),PS=()=>({type:Wl}),di=s=>({type:zl,error:s}),RS=s=>({type:Hl,payload:s}),MC=()=>({type:no}),DS=s=>({type:nd,payload:s}),_S=()=>({type:Xl}),OS=s=>({type:Ql,payload:s}),LS=s=>({type:Zl,error:s}),MS=s=>({type:rd,payload:s}),FC=(s,e)=>async t=>{console.log("[createUser] Starting user creation for username:",s),t({type:Gl});const n=Ge.gameApplicationService;console.log("[createUser] Calling application service...");const r=await n.createUser({username:s,profilePicture:e});console.log("[createUser] Result received:",{isSuccess:r.isSuccess,error:r.isSuccess?null:r.error.message}),r.isSuccess?(console.log("[createUser] Success! User created:",r.value),t({type:ql,payload:r.value}),t(DS(r.value))):(console.error("[createUser] FAILURE! Error:",r.error.message),t({type:Vl,error:r.error.message}))},$C=(s,e,t)=>async n=>{n({type:Kl});const o=await Ge.gameApplicationService.updateUser({userId:s,username:e,profilePicture:t});o.isSuccess?n({type:Jl,payload:o.value}):n({type:Yl,error:o.error.message})},UC=(s,e)=>async t=>{t({type:ed});const r=await Ge.gameApplicationService.setUserOnline({userId:s,isOnline:e});r.isSuccess?t({type:td,payload:r.value}):t({type:sd,error:r.error.message})},BC=()=>async s=>{s(_S());const t=await Ge.gameApplicationService.getAllUsers({onlineOnly:!1});t.isSuccess?s(OS(t.value)):s(LS(t.error.message))},FS=s=>({type:fd,payload:s}),$S=(s,e,t,n,r,o)=>async i=>{i({type:ad});const l=await Ge.gameApplicationService.sendMessage({gameId:s,senderId:e,senderUsername:t,senderProfilePicture:n,text:r,isFromPersona:o});l.isSuccess?i({type:od,payload:l.value}):i({type:id,error:l.error.message})},WC=s=>async e=>{e({type:cd});const n=await Ge.gameApplicationService.getMessages({gameId:s});n.isSuccess?e({type:ld,payload:n.value}):e({type:dd,error:n.error.message})},zC=s=>async e=>{e({type:ud});const n=await Ge.gameApplicationService.clearMessages({gameId:s});n.isSuccess?e({type:pd,payload:s}):e({type:hd,error:n.error.message})},US={maxContextMessages:10,responseDelay:1e3,maxResponseLength:300};function BS(s){return`You are ${s.name}, an AI assistant in a multiplayer chat lobby.

Your role and behavior:
${s.description}

Guidelines:
- Stay in character as ${s.name}
- Keep responses concise (under 300 characters)
- Be helpful and engaging
- Respond naturally to the conversation flow
- Don't mention that you're an AI unless directly asked
- Use the persona's personality consistently

Current conversation context will be provided. Respond as ${s.name} would.`}class WS{constructor(e,t,n){ee(this,"isProcessing",!1);ee(this,"config");this.ollamaApi=e,this.store=t,this.config={...US,...n}}extractMentions(e){const t=/@(\w+)/g;return Array.from(e.matchAll(t)).map(r=>r[1])}async processMessage(e,t){if(console.log("[PersonaResponseService] ========== PROCESSING MESSAGE =========="),console.log("[PersonaResponseService] Message:",e),console.log("[PersonaResponseService] Game ID:",t),this.isProcessing){console.log("[PersonaResponseService] Already processing, skipping");return}try{this.isProcessing=!0;const n=this.store.getState(),r=n.currentUser;if(console.log("[PersonaResponseService] Current user:",r==null?void 0:r.username),console.log("[PersonaResponseService] Total personas in state:",Object.keys(n.personas.byId).length),this.isPersonaMessage(e,n.personas.byId)){console.log("[PersonaResponseService] Message from persona, skipping");return}const o=this.extractMentions(e.text);if(console.log("[PersonaResponseService] Extracted mentions:",o),o.length===0){console.log("[PersonaResponseService] No @mentions in message, skipping");return}console.log("[PersonaResponseService] âœ… Detected @mentions:",o);const c=(n.personas.byGameId[t]||[]).map(d=>n.personas.byId[d]).filter(d=>d&&d.isActive);if(c.length===0){console.log("[PersonaResponseService] No active personas");return}const l=(n.chatMessages[t]||[]).slice(-this.config.maxContextMessages).map(d=>({sender:d.senderUsername,text:d.text,isPersona:this.isPersonaMessage(d,n.personas.byId)}));for(const d of c)o.some(u=>u.toLowerCase()===d.name.toLowerCase())&&(console.log("[PersonaResponseService] Persona @mentioned, generating AI response:",d.name),await this.generatePersonaResponse(d,l,t,r==null?void 0:r.id))}catch(n){console.error("[PersonaResponseService] Error processing message:",n)}finally{this.isProcessing=!1}}isPersonaMessage(e,t){return Object.values(t).some(n=>n.id===e.senderId)}async generatePersonaResponse(e,t,n,r){var o,i;try{await new Promise(u=>setTimeout(u,this.config.responseDelay));const c=[{role:"system",content:BS(e)},...t.map(u=>({role:u.isPersona?"assistant":"user",content:`${u.sender}: ${u.text}`}))];console.log("[PersonaResponseService] Generating response for:",e.name);const d=(i=(o=(await this.ollamaApi.chat(c,void 0,{stream:!1})).message)==null?void 0:o.content)==null?void 0:i.trim();if(!d){console.log("[PersonaResponseService] No response generated");return}const p=d.length>this.config.maxResponseLength?d.substring(0,this.config.maxResponseLength-3)+"...":d;console.log("[PersonaResponseService] Generated response:",p),this.store.dispatch($S(n,e.id,e.name,void 0,p,!0))}catch(c){console.error("[PersonaResponseService] Error generating response for",e.name,c)}}}const HC=["gpt-oss:latest","gemma3:4b","gemma3:27b","qwen2.5:32b","qwen3:4b","qwen3:30b","qwen3-vl:latest","qwen3-vl:4b","granite3.2-vision","granite4:small-h","deepseek-r1:32b"],Od="gemma3:27b",ui="http://192.168.2.70:11434";class zS{constructor(e=Od){this.model=e}async generateStructuredCompletion(e,t,n=this.model,r){return((r==null?void 0:r.useEndpoint)??"chat")==="chat"?this.generateStructuredCompletionWithChat(e,t,n,r):this.generateStructuredCompletionWithGenerate(e,t,n,r)}async generateStructuredCompletionWithChat(e,t,n,r){var l;const o=(r==null?void 0:r.system)??"You are a helpful assistant. Always respond in valid JSON format according to the provided schema.",i=await this.chat([{role:"system",content:o},{role:"user",content:e,images:r==null?void 0:r.images}],n,{format:t,stream:!1,signal:r==null?void 0:r.signal});console.log("ðŸ” Raw chat API result:",i);const c=(l=i.message)==null?void 0:l.content;if(console.log("ðŸ” Response type:",typeof c),console.log("ðŸ” Response value:",c),!c)throw console.error("âŒ Empty response from API:",i),new Error("Received empty response from Ollama API");if(typeof c=="string"){if(c.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(c)}catch(d){throw console.error("âŒ JSON parse error. Response was:",c),new Error(`Failed to parse JSON response: ${d instanceof Error?d.message:"Unknown error"}`)}}return c}async generateStructuredCompletionWithGenerate(e,t,n,r){const o=await this.generateCompletion(e,n,{...r,format:t});if(console.log("ðŸ” Raw generate API result:",o),console.log("ðŸ” Response type:",typeof o.response),console.log("ðŸ” Response value:",o.response),!o.response)throw console.error("âŒ Empty response from API:",o),new Error("Received empty response from Ollama API");if(typeof o.response=="string"){if(o.response.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(o.response)}catch(i){throw console.error("âŒ JSON parse error. Response was:",o.response),new Error(`Failed to parse JSON response: ${i instanceof Error?i.message:"Unknown error"}`)}}return o.response}async generateCompletion(e,t=this.model,n){var b;const{suffix:r,images:o,format:i,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f,onStreamChunk:m,signal:g}=n??{stream:!1},x=`${ui}/api/generate`,v=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:e,suffix:r,images:o,format:i,options:n==null?void 0:n.options,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f}),signal:g});if(!v.ok)throw new Error(`HTTP error! status: ${v.status}`);if(d&&v.headers.get("Content-Type")==="application/x-ndjson"){const w=(b=v.body)==null?void 0:b.getReader(),y=new TextDecoder("utf-8");let j="",S="";for(;;){const{done:C,value:N}=await(w==null?void 0:w.read())??{};if(C)break;j+=y.decode(N,{stream:!0});const O=j.split(`
`);j=O.pop();for(const R of O)if(R.trim()){const k=JSON.parse(R);k.response&&(S+=k.response,m==null||m(k.response)),console.log(k)}}return{response:S}}else{const w=await v.json();return console.log("ðŸ“¥ Non-streaming API response:",w),w}}async chat(e,t=this.model,n){var u,f;const{stream:r,format:o,keep_alive:i,onStreamChunk:c,signal:l}=n??{},d=`${ui}/api/chat`,p=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,format:o,stream:r,keep_alive:i}),signal:l});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);if(r&&p.headers.get("Content-Type")==="application/x-ndjson"){const m=(u=p.body)==null?void 0:u.getReader(),g=new TextDecoder("utf-8");let x="",v="";for(;;){const{done:b,value:w}=await(m==null?void 0:m.read())??{};if(b)break;x+=g.decode(w,{stream:!0});const y=x.split(`
`);x=y.pop();for(const j of y)if(j.trim()){const S=JSON.parse(j);(f=S.message)!=null&&f.content&&(v+=S.message.content,c==null||c(S.message.content)),console.log(S)}}return{message:{role:"assistant",content:v}}}else return await p.json()}}const HS=new zS(Od),va="game_current_user";function GS(){try{const s=localStorage.getItem(va);return s?JSON.parse(s):null}catch(s){return console.error("[gameReducer] Failed to load currentUser from localStorage:",s),null}}function Bs(s){try{s?localStorage.setItem(va,JSON.stringify(s)):localStorage.removeItem(va)}catch(e){console.error("[gameReducer] Failed to save currentUser to localStorage:",e)}}const qS={connectionState:"DISCONNECTED",isConnected:!1,currentUser:GS(),users:[],usersLoading:!1,usersError:null,games:[],gamesLoading:!1,gamesError:null,selectedGameId:null,chatMessages:{},chatLoading:!1,chatError:null,personas:{byId:{},byGameId:{},loading:!1,error:null},loading:!1,error:null};function pi(s=qS,e){var t,n,r,o,i;switch(e.type){case so:return{...s,loading:!0,error:null};case Wl:return{...s,loading:!1,isConnected:!0,error:null};case zl:return{...s,loading:!1,isConnected:!1,error:e.error};case no:return{...s,isConnected:!1,connectionState:"DISCONNECTED"};case Hl:return{...s,connectionState:e.payload,isConnected:e.payload==="CONNECTED"};case nd:{const c={...s,currentUser:e.payload};return Bs(e.payload),c}case Gl:return{...s,usersLoading:!0,usersError:null};case ql:{const c={...s,usersLoading:!1,currentUser:e.payload,users:[...s.users,e.payload],usersError:null};return Bs(e.payload),c}case Vl:return{...s,usersLoading:!1,usersError:e.error};case Kl:return{...s,usersLoading:!0,usersError:null};case Jl:{const c=((t=s.currentUser)==null?void 0:t.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((n=s.currentUser)==null?void 0:n.id)===e.payload.id&&Bs(e.payload),l}case Yl:return{...s,usersLoading:!1,usersError:e.error};case Xl:return{...s,usersLoading:!0,usersError:null};case Ql:{const c=e.payload,l=s.currentUser?c.find(p=>p.id===s.currentUser.id):null,d=l?s.currentUser:null;return!l&&s.currentUser&&(console.warn("[gameReducer] Current user not found in backend, clearing localStorage"),Bs(null)),{...s,usersLoading:!1,currentUser:d,users:c,usersError:null}}case Zl:return{...s,usersLoading:!1,usersError:e.error};case ed:return{...s,usersLoading:!0,usersError:null};case td:{const c=((r=s.currentUser)==null?void 0:r.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((o=s.currentUser)==null?void 0:o.id)===e.payload.id&&Bs(e.payload),l}case sd:return{...s,usersLoading:!1,usersError:e.error};case rd:return{...s,users:e.payload};case lS:return{...s,gamesLoading:!0,gamesError:null};case dS:return{...s,gamesLoading:!1,games:[...s.games,e.payload],gamesError:null};case uS:return{...s,gamesLoading:!1,gamesError:e.error};case pS:return{...s,gamesLoading:!0,gamesError:null};case hS:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case fS:return{...s,gamesLoading:!1,gamesError:e.error};case mS:return{...s,gamesLoading:!0,gamesError:null};case gS:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case xS:return{...s,gamesLoading:!1,gamesError:e.error};case vS:return{...s,gamesLoading:!0,gamesError:null};case bS:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case wS:return{...s,gamesLoading:!1,gamesError:e.error};case yS:return{...s,gamesLoading:!0,gamesError:null};case SS:return{...s,gamesLoading:!1,games:s.games.filter(c=>c.id!==e.payload),gamesError:null};case jS:return{...s,gamesLoading:!1,gamesError:e.error};case CS:return{...s,gamesLoading:!0,gamesError:null};case NS:return{...s,gamesLoading:!1,games:e.payload,gamesError:null};case kS:return{...s,gamesLoading:!1,gamesError:e.error};case ES:return{...s,games:s.games.map(c=>c.id===e.payload.id?e.payload:c)};case IS:return{...s,games:s.games.filter(c=>c.id!==e.payload)};case ad:return{...s,chatLoading:!0,chatError:null};case od:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]},chatError:null}}case id:return{...s,chatLoading:!1,chatError:e.error};case cd:return{...s,chatLoading:!0,chatError:null};case ld:{if(e.payload.length===0)return{...s,chatLoading:!1,chatError:null};const c=e.payload[0].gameId;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:e.payload},chatError:null}}case dd:return{...s,chatLoading:!1,chatError:e.error};case ud:return{...s,chatLoading:!0,chatError:null};case pd:{const c=e.payload;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:[]},chatError:null}}case hd:return{...s,chatLoading:!1,chatError:e.error};case fd:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return l.find(d=>d.id===c.id)?s:{...s,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]}}}case md:case vd:case yd:case Cd:case Ed:return{...s,personas:{...s.personas,loading:!0,error:null}};case gd:case Ad:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},byGameId:{...s.personas.byGameId,[c.gameId]:[...s.personas.byGameId[c.gameId]||[],c.id]},loading:!1}}}case bd:{const{personas:c}=e.payload,l={},d={};return c.forEach(p=>{l[p.id]=p,d[p.gameId]||(d[p.gameId]=[]),d[p.gameId].push(p.id)}),{...s,personas:{...s.personas,byId:{...s.personas.byId,...l},byGameId:{...s.personas.byGameId,...d},loading:!1}}}case Sd:case Pd:case Id:case Dd:case _d:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},loading:!1}}}case Nd:case Rd:{const c="id"in e.payload?e.payload.id:e.payload.personaId,l=s.personas.byId[c];if(!l)return s;const{[c]:d,...p}=s.personas.byId,u=((i=s.personas.byGameId[l.gameId])==null?void 0:i.filter(f=>f!==c))||[];return{...s,personas:{...s.personas,byId:p,byGameId:{...s.personas.byGameId,[l.gameId]:u},loading:!1}}}case xd:case wd:case jd:case kd:case Td:return{...s,personas:{...s.personas,loading:!1,error:e.payload.error}};case TS:return{...s,selectedGameId:e.payload};case AS:return{...s,error:null,gamesError:null,usersError:null};default:return s}}const VS=()=>({type:md}),KS=s=>({type:gd,payload:{persona:s}}),JS=s=>({type:xd,payload:{error:s}}),YS=()=>({type:vd}),XS=s=>({type:bd,payload:{personas:s}}),QS=s=>({type:wd,payload:{error:s}}),ZS=()=>({type:yd}),e0=s=>({type:Sd,payload:{persona:s}}),t0=s=>({type:jd,payload:{error:s}}),s0=()=>({type:Cd}),n0=s=>({type:Nd,payload:{id:s}}),r0=s=>({type:kd,payload:{error:s}}),Ld=()=>({type:Ed}),Md=s=>({type:Id,payload:{persona:s}}),Fd=s=>({type:Td,payload:{error:s}}),a0=s=>({type:Ad,payload:{persona:s}}),o0=s=>({type:Pd,payload:{persona:s}}),i0=s=>({type:Rd,payload:{personaId:s}}),c0=s=>({type:Dd,payload:{persona:s}}),l0=s=>({type:_d,payload:{persona:s}}),GC=(s,e,t,n)=>async r=>{r(VS());const o=await Ge.personaUseCases.createPersona.execute({gameId:s,name:e,description:t,emoji:n});o.isSuccess?r(KS(o.value.toJSON())):r(JS(o.error.message))},qC=s=>async e=>{e(YS());const t=await Ge.personaUseCases.getPersonas.execute(s);t.isSuccess?e(XS(t.value.map(n=>n.toJSON()))):e(QS(t.error.message))},VC=(s,e)=>async t=>{t(ZS());const n=await Ge.personaUseCases.updatePersona.execute(s,e);n.isSuccess?t(e0(n.value.toJSON())):t(t0(n.error.message))},KC=s=>async e=>{e(s0());const t=await Ge.personaUseCases.deletePersona.execute(s);t.isSuccess?e(n0(s)):e(r0(t.error.message))},JC=s=>async e=>{e(Ld());const t=await Ge.personaUseCases.activatePersona.execute(s,!0);t.isSuccess?e(Md(t.value.toJSON())):e(Fd(t.error.message))},YC=s=>async e=>{e(Ld());const t=await Ge.personaUseCases.activatePersona.execute(s,!1);t.isSuccess?e(Md(t.value.toJSON())):e(Fd(t.error.message))},d0=s=>{let e=!1;return t=>n=>{const r=t(n);if(n.type===so){if(e)return console.log("[WebSocket Middleware] Connection already initialized"),r;e=!0;const o=Ge.webSocketService,i=Ge.webSocketConfig;o.onMessage(c=>{switch(console.log("[WebSocket Middleware] Received message:",c.type),c.type){case"chat_message":{const d=c.message;d.isIntroduction&&d.isPersona?console.log(`[WebSocket Middleware] ðŸŽ­ Persona introduction received from ${d.senderUsername}:`,d.text):d.isPersona?console.log(`[WebSocket Middleware] ðŸ¤– Persona message received from ${d.senderUsername}:`,d.text):console.log("[WebSocket Middleware] Chat message received:",d),s.dispatch(FS(d));break}case"user_list":{const d=c.users;console.log("[WebSocket Middleware] User list updated:",d.length,"users"),s.dispatch(MS(d));break}case"game_update":{const d=c.game;console.log("[WebSocket Middleware] Game update received:",d.id);break}case"PERSONA_CREATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona created:",d.id),s.dispatch(a0(d));break}case"PERSONA_UPDATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona updated:",d.id),s.dispatch(o0(d));break}case"PERSONA_DELETED":{const d=c.personaId;console.log("[WebSocket Middleware] Persona deleted:",d),s.dispatch(i0(d));break}case"PERSONA_ACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona activated:",d.id),s.dispatch(c0(d));break}case"PERSONA_DEACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona deactivated:",d.id),s.dispatch(l0(d));break}case"error":{const d=c.message;console.error("[WebSocket Middleware] Error from server:",d);break}}}),o.onConnectionStateChange(c=>{if(s.dispatch(RS(c)),c===jt.CONNECTED){s.dispatch(PS());const d=s.getState().currentUser;d?(console.log(`[WebSocket Middleware] Sending JOIN message for user ${d.username} (${d.id})`),o.send({type:"join",userId:d.id,username:d.username}).catch(p=>{console.error("[WebSocket Middleware] Failed to send JOIN message:",p)})):console.warn("[WebSocket Middleware] No currentUser available to send JOIN message")}else c===jt.ERROR&&s.dispatch(di("WebSocket connection failed"))}),o.connect(i).then(()=>{console.log("[WebSocket Middleware] Successfully connected")}).catch(c=>{console.error("[WebSocket Middleware] Connection error:",c),s.dispatch(di(c instanceof Error?c.message:"Unknown connection error")),e=!1})}return n.type===no&&Ge.webSocketService.disconnect().then(()=>{console.log("[WebSocket Middleware] Disconnected"),e=!1}).catch(i=>{console.error("[WebSocket Middleware] Disconnect error:",i),e=!1}),r}},u0=s=>e=>t=>e(t),p0=s=>e=>t=>typeof t=="function"?t(s.dispatch,s.getState):e(t);function h0(s=!0){let e=pi(void 0,{type:"@@INIT"});const t=new Set,n={getState(){return e},dispatch(r){let o=i=>(e=pi(e,i),t.forEach(c=>c()),i);return o=d0(n)(o),o=p0(n)(o),s&&(o=u0()(o)),o(r)},subscribe(r){return t.add(r),()=>{t.delete(r)}}};return n}class f0{constructor(){ee(this,"_httpService",null);ee(this,"_webSocketService",null);ee(this,"_gameRepository",null);ee(this,"_userRepository",null);ee(this,"_chatRepository",null);ee(this,"_personaRepository",null);ee(this,"_store",null);ee(this,"_gameApplicationService",null);ee(this,"_config",null);ee(this,"_personaUseCases",null);ee(this,"_personaResponseService",null);ee(this,"_logger",null)}get config(){if(!this._config){const e=()=>`http://${window.location.hostname}:3030/api/multiplayer`,t=()=>`ws://${window.location.hostname}:3030/multiplayer`;this._config={httpApiBaseUrl:e(),webSocketUrl:t(),enableLogging:!0,webSocketReconnectInterval:parseInt("3000",10),webSocketMaxReconnectAttempts:parseInt("10",10),webSocketHeartbeatInterval:parseInt("30000",10),clientLogsEnabled:!0,clientLogsApiBaseUrl:"http://localhost:3030/client-logs"}}return this._config}get httpService(){return this._httpService||(this._httpService=new Qy(this.config.httpApiBaseUrl,5e3)),this._httpService}get webSocketService(){return this._webSocketService||(this._webSocketService=new Zy),this._webSocketService}get gameRepository(){return this._gameRepository||(this._gameRepository=new eS(this.httpService)),this._gameRepository}get userRepository(){return this._userRepository||(this._userRepository=new tS(this.httpService)),this._userRepository}get chatRepository(){return this._chatRepository||(this._chatRepository=new sS(this.httpService)),this._chatRepository}get personaRepository(){return this._personaRepository||(this._personaRepository=new nS(this.httpService)),this._personaRepository}get personaUseCases(){if(!this._personaUseCases){const e=this.personaRepository,t=this.logger;this._personaUseCases={createPersona:new rS(e,t),getPersonas:new aS(e),updatePersona:new oS(e,t),deletePersona:new iS(e,t),activatePersona:new cS(e,t)}}return this._personaUseCases}get clientLogsApiClient(){return Pr.clientLogsApiClient}get clientLogsService(){return Pr.clientLogsService}get logger(){return Pr.logger}get gameApplicationService(){return this._gameApplicationService||(this._gameApplicationService=new Xy(this.userRepository,this.chatRepository,this.webSocketService,this.logger)),this._gameApplicationService}get store(){return this._store||(this._store=h0(this.config.enableLogging)),this._store}get personaResponseService(){return this._personaResponseService||(this._personaResponseService=new WS(HS,this.store)),this._personaResponseService}get webSocketConfig(){return{url:this.config.webSocketUrl,reconnectInterval:this.config.webSocketReconnectInterval,maxReconnectAttempts:this.config.webSocketMaxReconnectAttempts,heartbeatInterval:this.config.webSocketHeartbeatInterval}}reset(){this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._personaResponseService=null,this._store=null,this._gameApplicationService=null,this._config=null}setHttpService(e){this._httpService=e,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._gameApplicationService=null}setWebSocketService(e){this._webSocketService=e,this._gameApplicationService=null}setGameRepository(e){this._gameRepository=e,this._gameApplicationService=null}setUserRepository(e){this._userRepository=e,this._gameApplicationService=null}setGameApplicationService(e){this._gameApplicationService=e}setLogger(e){this._logger=e,this._gameApplicationService=null}setConfig(e){this._config={...this.config,...e},this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._gameApplicationService=null,this._store=null}}const Ge=new f0,m0="backspace-debug.log";let g0=0;function hi(){return++g0}function xr(s,e){Ge.clientLogsApiClient.sendLogs(s,e,m0)}function fi(s,e,t,n,r,o){const i=o.substring(Math.max(0,n-5),n),c=o.substring(n,Math.min(o.length,n+5)),l=n>0?o[n-1]:"<none>";xr(`${e.toUpperCase()}_BEFORE`,{eventId:s,key:e,mode:t,cursorPos:n,selectionEnd:r,hasSelection:n!==r,textLength:o.length,charToDelete:e==="Backspace"?l:void 0,charToDeleteCode:e==="Backspace"&&l!=="<none>"?l.charCodeAt(0):void 0,context5Before:i,context5After:c,contextVisual:`"${i}|${c}"`,fullText:o.length<200?o:`${o.substring(0,100)}...(${o.length} chars)...${o.substring(o.length-50)}`})}function x0(s,e,t,n,r,o){const{text:i,cursorPos:c}=t,l=i.substring(Math.max(0,c-5),c),d=i.substring(c,Math.min(i.length,c+5));xr(`${e.toUpperCase()}_AFTER`,{eventId:s,newCursorPos:c,newTextLength:i.length,context5Before:l,context5After:d,contextVisual:`"${l}|${d}"`,cursorDelta:c-r,textDelta:i.length-o,expectedCursorPos:n,cursorMismatch:c!==n})}function mi(s,e,t){xr(`${e}_ACTION`,{eventId:s,actionType:e,action:{selectionStart:t.selectionStart,selectionEnd:t.selectionEnd,textToInsert:t.textToInsert,newCursorPosition:t.newCursorPosition}})}function gi(s,e,t){xr(`BACKSPACE_PREVIEW_${e}`,{eventId:s,...t})}function v0(s){const{editorRef:e,isRawMode:t,getTextAndCursor:n,applyAction:r,useRichEditing:o,setInternalValue:i,onChange:c}=s,l=h.useCallback((m,g,x,v,b)=>{setTimeout(()=>{const w=n();w&&x0(m,g,w,b,x,v)},10)},[n]),d=h.useCallback((m,g,x,v)=>{if(e.current){if(x===v&&x>0){const b=g.substring(0,x-1)+g.substring(x),w=x-1;gi(m,"DELETE",{deletedChar:g[x-1],deletedCharCode:g.charCodeAt(x-1),oldCursorPos:x,newCursorPos:w,oldTextLength:g.length,newTextLength:b.length});const y=ot(b);e.current.innerHTML=y,rn(e.current,w),i(b),c==null||c(b),l(m,"Backspace",x,g.length,w)}else if(x!==v){const b=g.substring(0,x)+g.substring(v),w=x;gi(m,"DELETE_SELECTION",{deletedText:g.substring(x,v),selectionStart:x,selectionEnd:v,newCursorPos:w});const y=ot(b);e.current.innerHTML=y,rn(e.current,w),i(b),c==null||c(b)}}},[e,i,c,l]),p=h.useCallback((m,g,x)=>{const v=hi(),{selectionStart:b,selectionEnd:w}=x;fi(v,"Backspace",t?"raw":"preview",b,w,g);const y=Wf(g,b,w);return y?(m.preventDefault(),mi(v,"BACKSPACE",{selectionStart:y.selectionStart,selectionEnd:y.selectionEnd,textToInsert:y.textToInsert,newCursorPosition:y.newCursorPosition}),r(y,g),l(v,"Backspace",b,g.length,y.newCursorPosition),!0):t?!1:(m.preventDefault(),d(v,g,b,w),!0)},[t,r,l,d]),u=h.useCallback((m,g,x)=>{if(!o||m.shiftKey)return!1;const v=hi(),{selectionStart:b,selectionEnd:w}=x;fi(v,"Enter",t?"raw":"preview",b,w,g);const y=Oc(g,b,w);return mi(v,"ENTER",{selectionStart:y.selectionStart,selectionEnd:y.selectionEnd,textToInsert:JSON.stringify(y.textToInsert),newCursorPosition:y.newCursorPosition}),m.preventDefault(),r(y,g),l(v,"Enter",b,g.length,y.newCursorPosition),!0},[o,t,r,l]),f=h.useCallback((m,g,x)=>{if(!o)return!1;m.preventDefault();const v=m.shiftKey?Mc(g,x.selectionStart,x.selectionEnd):Lc(g,x.selectionStart,x.selectionEnd);return r(v,g),!0},[o,r]);return{handleBackspace:p,handleEnter:u,handleTab:f}}function b0(s){switch(s){case"strong":return"**";case"em":return"*";case"code":return"`";case"del":return"~~";case"blockquote":return"> ";default:return""}}function w0(s){const{editorRef:e,editingRawMarkdownRef:t,isRawMode:n,allowRawPreviewOnClick:r,handleInput:o}=s,i=h.useCallback((d,p)=>{var S;d.preventDefault();const u=p.textContent||"",f=p.tagName.toLowerCase(),m=b0(f);if(!m)return;t.current=!0;const g=window.getSelection();if(!g||g.rangeCount===0)return;const x=g.getRangeAt(0);let v=0;if(p.contains(x.startContainer)){const C=document.createRange();C.selectNodeContents(p),C.setEnd(x.startContainer,x.startOffset);const N=document.createElement("div");N.appendChild(C.cloneContents()),v=((S=N.textContent)==null?void 0:S.length)||0}const b=f==="blockquote"?`${m}${u}`:`${m}${u}${m}`,w=document.createTextNode(b);p.replaceWith(w);const y=document.createRange(),j=m.length+v;y.setStart(w,j),y.setEnd(w,j),g.removeAllRanges(),g.addRange(y),o()},[t,o]),c=h.useCallback(()=>{var m;if(!e.current)return;t.current=!1;const d=window.getSelection();let p=0;if(d&&d.rangeCount>0){const g=d.getRangeAt(0),x=g.cloneRange();x.selectNodeContents(e.current),x.setEnd(g.startContainer,g.startOffset);const v=document.createElement("div");v.appendChild(x.cloneContents());const b=v.textContent||"";p=b.length;let w=0;for(let y=0;y<Math.min(p,b.length);y++){const j=b[y],S=b[y+1];j==="*"&&S==="*"?(w+=2,y++):(j==="*"||j==="_"||j==="`"||j==="~")&&w++}p=p-w}const u=ms(e.current.innerHTML),f=ot(u);if(e.current.innerHTML!==f&&(e.current.innerHTML=f,d&&d.rangeCount>0)){let g=0;const x=document.createTreeWalker(e.current,NodeFilter.SHOW_TEXT);let v=x.nextNode(),b=!1;for(;v&&!b;){const w=((m=v.textContent)==null?void 0:m.length)||0;if(g+w>=p){const y=p-g,j=document.createRange();j.setStart(v,y),j.setEnd(v,y),d.removeAllRanges(),d.addRange(j),b=!0}else g+=w,v=x.nextNode()}}},[e,t]);return{handleClick:h.useCallback(d=>{if(!e.current||!r||n)return;const u=d.target.closest("strong, em, code, del, blockquote");u?i(d,u):t.current&&c()},[e,r,n,t,i,c])}}function y0(s){const e=window.getSelection();let t=s;return e&&e.rangeCount>0&&!e.isCollapsed&&(t=s+e.toString().length),{selectionStart:s,selectionEnd:t,hasSelection:s!==t}}function S0(s){const{editorRef:e,editingRawMarkdownRef:t,applyingActionRef:n,value:r,isRawMode:o,useRichEditing:i,keyboard:c,allowRawPreviewOnClick:l,setInternalValue:d,onChange:p,onKeyDown:u,onPaste:f}=s,{getTextAndCursor:m,applyAction:g}=Uy({editorRef:e,applyingActionRef:n,value:r,isRawMode:o,setInternalValue:d,onChange:p}),{handleAutoWrap:x,handleFormatShortcut:v,shouldPassThrough:b}=By({applyAction:g}),{handleBackspace:w,handleEnter:y,handleTab:j}=v0({editorRef:e,isRawMode:o,getTextAndCursor:m,applyAction:g,useRichEditing:i,setInternalValue:d,onChange:p}),S=h.useCallback(()=>{if(!e.current)return;if(o){const A=to(e.current);r===void 0&&d(A),p==null||p(A);return}const R=e.current.innerHTML;let k=ms(R);if(c===eo.VI){const{cursorPos:A}=xa(e.current),L=k,M=A,I=ky(L,M);if(I.found){const z=Iy(L,M,I.sequenceStart,I.detectedBaseChar);if(z.type==="auto-complete"&&z.replacement){k=z.replacement;const $=z.newCursorPos??k.length;e.current.innerHTML=ot(k),rn(e.current,$)}}}r===void 0&&d(k),p==null||p(k)},[p,r,c,o,e,d]),{handleClick:C}=w0({editorRef:e,editingRawMarkdownRef:t,isRawMode:o,allowRawPreviewOnClick:l,handleInput:S}),N=h.useCallback(R=>{const k=m();if(!k||!e.current){u==null||u(R);return}const{text:A,cursorPos:L}=k,M=y0(L);if(x(R,A,M)){u==null||u(R);return}if(v(R,A,M)){u==null||u(R);return}if(b(R)){u==null||u(R);return}if(R.key==="Backspace"&&w(R,A,M)){u==null||u(R);return}if(R.key==="Enter"&&y(R,A,M)){u==null||u(R);return}if(R.key==="Tab"&&j(R,A,M)){u==null||u(R);return}u==null||u(R)},[m,x,v,b,w,y,j,e,u]),O=h.useCallback(R=>{R.preventDefault();const k=R.clipboardData.getData("text/plain"),A=k.split(`
`);if(A.length===1)document.execCommand("insertText",!1,k);else{const L=window.getSelection();if(!L||L.rangeCount===0)return;const M=L.getRangeAt(0);M.deleteContents();const I=document.createDocumentFragment();A.forEach(($,q)=>{q>0&&I.appendChild(document.createElement("br")),$&&I.appendChild(document.createTextNode($))}),M.insertNode(I),M.collapse(!1),L.removeAllRanges(),L.addRange(M);const z=e.current;z&&z.dispatchEvent(new Event("input",{bubbles:!0}))}f==null||f()},[e,f]);return{handleInput:S,handleClick:C,handleKeyDown:N,handlePaste:O}}function j0(s){const{editorRef:e,editingRawMarkdownRef:t,currentModeRef:n,applyingActionRef:r,currentValue:o,isFocused:i,allowRawPreviewOnClick:c}=s;h.useEffect(()=>{if(!e.current||r.current)return;const l=n.current,d=l==="raw"?e.current.textContent||"":ms(e.current.innerHTML);if(d===o)return;const p=o.startsWith(d)&&o.length>d.length;if((!i||p)&&(l==="raw"?e.current.textContent=o:e.current.innerHTML=ot(o),i&&p)){const u=document.createRange(),f=window.getSelection();u.selectNodeContents(e.current),u.collapse(!1),f==null||f.removeAllRanges(),f==null||f.addRange(u)}},[o,i,e,n,r]),h.useEffect(()=>{if(!i||!e.current||!c)return;const l=()=>{if(t.current)return;const d=window.getSelection();if(!(!d||!e.current)&&d.isCollapsed&&e.current.contains(d.anchorNode)){const p=ms(e.current.innerHTML),u=ot(p);if(e.current.innerHTML!==u){const f=d.getRangeAt(0),m=f.cloneRange();m.selectNodeContents(e.current),m.setEnd(f.startContainer,f.startOffset);const g=document.createElement("div");g.appendChild(m.cloneContents());const x=ms(g.innerHTML).length;e.current.innerHTML=u,rn(e.current,x)}}};return document.addEventListener("selectionchange",l),()=>{document.removeEventListener("selectionchange",l)}},[i,o,c,e,t])}const $d=h.forwardRef(({value:s,defaultValue:e,onChange:t,onBlur:n,onKeyDown:r,onPaste:o,className:i,style:c,placeholder:l,readOnly:d=!1,useRichEditing:p=!0,allowRawPreviewOnClick:u=!1,showHints:f=!0,showAudioButton:m=!1,audioButtonVariant:g="default",autoStartAudioRecording:x=!1,onAudioTranscription:v,getTextAreaElement:b,audioNodeId:w,keyboard:y=_l,showConfigButton:j=!0,mode:S,onModeChange:C,...N},O)=>{const R=bs(),[k,A]=h.useState(e||""),[L,M]=h.useState(!1),I=h.useRef(null),z=h.useRef(!1),$=h.useRef("preview"),q=h.useRef(!1),P=h.useRef(!1),te=h.useRef(!1),[E,_]=h.useState(()=>{try{const G=localStorage.getItem("watcher-markdown-textarea-mode");if(G==="raw"||G==="preview")return G}catch{}return"preview"}),F=S??E,V=S!==void 0?G=>C==null?void 0:C(G):_,Y=F==="raw";h.useEffect(()=>{if(S===void 0)try{localStorage.setItem("watcher-markdown-textarea-mode",F)}catch{}},[F,S]),h.useEffect(()=>{$.current=F,q.current=!1,P.current=!1},[F]);const T=s!==void 0?s:k,W=!T||T.trim()==="",se=h.useRef(T);P.current||(P.current=!0,se.current=T);const le=h.useRef(F),me=h.useRef(s!==void 0?s:k);me.current=s!==void 0?s:k;const ae=h.useRef(null);ae.current||(ae.current=G=>{const de=G.target.closest("a");if(de){G.preventDefault(),G.stopPropagation();const pe=de.getAttribute("href");if(pe){const fe=document.createElement("a");fe.href=pe,fe.target="_blank",fe.rel="noopener noreferrer",fe.style.display="none",document.body.appendChild(fe),fe.click(),document.body.removeChild(fe)}}});const H=h.useCallback(G=>{const oe=F!==le.current;if(le.current=F,I.current&&ae.current&&I.current.removeEventListener("click",ae.current,!0),I.current=G,G&&F!=="raw"&&ae.current&&G.addEventListener("click",ae.current,!0),G&&(oe||!q.current)){q.current=!0;const de=me.current;F==="raw"?G.textContent=de:G.innerHTML=ot(de)}},[F]);h.useImperativeHandle(O,()=>({getElement:()=>I.current,getValue:()=>T,setValue:G=>{if(s===void 0&&A(G),I.current){const oe=ot(G);I.current.innerHTML=oe;const de=document.createRange(),pe=window.getSelection();de.selectNodeContents(I.current),de.collapse(!1),pe==null||pe.removeAllRanges(),pe==null||pe.addRange(de)}t==null||t(G)},focus:()=>{var G;(G=I.current)==null||G.focus()}})),j0({editorRef:I,editingRawMarkdownRef:z,currentModeRef:$,applyingActionRef:te,currentValue:T,isFocused:L,allowRawPreviewOnClick:u});const{handleInput:Q,handleClick:ge,handleKeyDown:ce,handlePaste:Ae}=S0({editorRef:I,editingRawMarkdownRef:z,applyingActionRef:te,value:s,isRawMode:Y,useRichEditing:p,keyboard:y,allowRawPreviewOnClick:u,setInternalValue:A,onChange:t,onKeyDown:r,onPaste:o}),ke=h.useCallback(()=>{M(!0)},[]),ve=h.useCallback(G=>{v==null||v(G)},[v]),U=h.useCallback(()=>I.current,[]),re=h.useCallback(G=>{M(!1);const oe=$.current;I.current&&(oe==="raw"?I.current.textContent!==T&&(I.current.textContent=T):I.current.innerHTML=ot(T)),n==null||n(G)},[T,n]);return a.jsxs("div",{className:"markdown-textarea-container h-full","data-test":"markdown-textarea-container",children:[a.jsxs("div",{className:"markdown-textarea-wrapper relative h-full","data-test":"markdown-textarea-wrapper",children:[a.jsx("div",{ref:H,contentEditable:!d,onInput:Q,onClick:Y?void 0:ge,onFocus:ke,onBlur:re,spellCheck:!1,onKeyDown:ce,onPaste:Ae,className:B("markdown-textarea min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm","ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50",!Y&&"[&_strong]:font-bold [&_em]:italic [&_del]:line-through",!Y&&"[&_code]:bg-muted [&_code]:px-1 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono","[&_*]:![font-size:inherit] [&_*]:![line-height:inherit]",d&&"cursor-default",i),style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:R?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:R?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...c},suppressContentEditableWarning:!0,"data-node-textarea":N["data-node-textarea"],"data-test":`markdown-textarea-editor${Y?"-raw":""}`},F),W&&!L&&l&&a.jsx("div",{className:"absolute top-2 left-3 text-sm text-muted-foreground pointer-events-none","aria-hidden":!0,"data-test":"markdown-textarea-placeholder",children:l}),a.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:st.nodeAudioButton},onMouseDownCapture:G=>G.preventDefault(),children:[j&&a.jsx(dr,{compact:!0,label:Y?a.jsx(fo,{className:"h-3 w-3"}):a.jsx(Hr,{className:"h-3 w-3"}),onAction:()=>{const G=Y?"preview":"raw";V(G),C==null||C(G)},variant:"ghost",size:"icon",buttonClassName:"p-1 h-auto w-auto rounded-md transition-colors text-muted-foreground/40 hover:text-foreground hover:bg-accent",configOptions:[{label:"Preview",value:"preview",icon:a.jsx(Hr,{className:"h-4 w-4"}),onClick:()=>{V("preview"),C==null||C("preview")}},{label:"Raw Markdown",value:"raw",icon:a.jsx(fo,{className:"h-4 w-4"}),onClick:()=>{V("raw"),C==null||C("raw")}}],tooltipText:`${Y?"Raw":"Preview"} mode (click to toggle, hold for options)`,ariaLabel:"Toggle markdown display mode","data-test":"markdown-mode-toggle"}),m&&a.jsx(Ol,{onTranscriptionComplete:ve,sessionName:"markdown-textarea",getTextAreaElement:b||U,variant:g,autoStartRecording:x,nodeId:w,language:y,"data-test":"markdown-textarea-audio-button"})]})]}),f&&a.jsxs("div",{className:"markdown-hints text-xs text-muted-foreground mt-1 flex gap-3 flex-wrap","data-test":"markdown-textarea-hints",children:[a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+B"})," Bold"]}),a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+I"})," Italic"]}),a.jsx("span",{children:"**bold** *italic* `code` > quote"}),p&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"text-muted-foreground/50",children:"|"}),a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Tab"})," Indent"]}),a.jsx("span",{children:"Auto-list on Enter"})]})]})]})});$d.displayName="MarkdownTextarea";const C0=Math.round(it.LINE_HEIGHT*2/3),N0=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath},k0=(s,e)=>{const t=window.getComputedStyle(s),n=s.scrollTop,r=document.createElement("div");r.style.cssText=`
    position: absolute;
    visibility: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    width: ${s.clientWidth}px;
    font-family: ${t.fontFamily};
    font-size: ${t.fontSize};
    font-weight: ${t.fontWeight};
    line-height: ${t.lineHeight};
    letter-spacing: ${t.letterSpacing};
    padding: ${t.padding};
    border: ${t.border};
    box-sizing: ${t.boxSizing};
  `;const o=s.value.substring(0,e),i=document.createTextNode(o);r.appendChild(i);const c=document.createElement("span");c.textContent="â€‹",r.appendChild(c),document.body.appendChild(r);const l=c.offsetTop,d=c.offsetLeft;document.body.removeChild(r);const p=parseFloat(t.lineHeight)||20,u=d;return{top:l+p/3-n,left:u}},xi=(s,e)=>{let t=-1;for(let o=e;o>=0;o--){if(s[o]==="@"){t=o;break}if(s[o]===" "||s[o]===`
`||s[o]==="	")break}if(t===-1)return null;let n=t+1;for(;n<s.length;){const o=s[n];if(o===" "||o===`
`||o==="	")break;n++}const r=s.substring(t,n);return r.startsWith("@")&&r.includes("/")?{start:t,end:n,path:r}:null},as=h.forwardRef(({defaultValue:s,value:e,onChange:t,onBlur:n,onFocus:r,onKeyDown:o,onMouseDown:i,onClick:c,onPaste:l,onPasteComplete:d,className:p,style:u,placeholder:f,onSelectionChange:m,onFileSelect:g,logger:x,showBuiltInPopover:v=!1,showFilePicker:b=!0,showCopyButton:w=!1,showAudioButton:y=!0,showConfigButton:j=!0,audioButtonVariant:S="default",autoStartAudioRecording:C=!1,onAudioTranscriptionComplete:N,audioNodeId:O,readOnly:R=!1,rows:k,autoFocus:A=!1,useMarkdown:L=!1,showMarkdownHints:M=!1,keyboard:I=_l,onModeChange:z},$)=>{const[q,P]=h.useState(!1),[te,E]=h.useState({top:0,left:0}),[_,F]=h.useState(500),[V,Y]=h.useState(null),[T,W]=h.useState(!1),[se,le]=h.useState(!1),[me,ae]=h.useState(!1),H=h.useRef(null),Q=h.useRef(null),ge=h.useRef(null),ce=h.useRef(null),Ae=h.useRef(null),ke=h.useCallback(()=>{W(!0),se&&(P(!0),le(!1))},[se]),ve=Le(N0),U=bs();h.useEffect(()=>{var je;const J=(je=H.current)==null?void 0:je.getTextArea();if(!J)return;const he=Te=>{const Ne=Te.relatedTarget,Ce=(Ne==null?void 0:Ne.closest('[data-test="textarea-file-picker-popover-content"]'))!==null;Ge.clientLogsApiClient.sendLogs("2_textarea_blur",{showFilePickerPopover:q,relatedTarget:(Ne==null?void 0:Ne.tagName)??null,relatedTargetDataTest:(Ne==null?void 0:Ne.getAttribute("data-test"))??null,isMovingToFilePicker:Ce},"esc-blur-debug.log"),!Ce&&q&&(P(!1),Y(null),ae(!1))};return J.addEventListener("blur",he),()=>{J.removeEventListener("blur",he)}},[q]),h.useImperativeHandle($,()=>({getTextArea:()=>{var J,he;return L?(J=Q.current)==null?void 0:J.getElement():((he=H.current)==null?void 0:he.getTextArea())??null},insertTextAtStart:J=>{var he,je;L?(he=Q.current)==null||he.focus():(je=H.current)==null||je.insertTextAtStart(J)},focus:()=>{var J,he,je;L?(J=Q.current)==null||J.focus():(je=(he=H.current)==null?void 0:he.getTextArea())==null||je.focus()}}),[L]);const re=h.useCallback(J=>{var he,je,Te,Ne;if(L){const Ce=((he=Q.current)==null?void 0:he.getValue())??"",_e=Ce.trim()?" ":"",Me=Ce+_e+J;(je=Q.current)==null||je.setValue(Me);const Be={target:{value:Me},currentTarget:{value:Me}};t==null||t(Be)}else{const Ce=(Te=H.current)==null?void 0:Te.getTextArea();if(!Ce)return;const _e=Ce.value,Me=_e.trim()?" ":"",Be=_e+Me+J,ze=(Ne=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Ne.set;ze?ze.call(Ce,Be):Ce.value=Be;const lt=new Event("input",{bubbles:!0});Ce.dispatchEvent(lt)}N==null||N()},[L,t,N]),G=h.useCallback(()=>{var J;return((J=Q.current)==null?void 0:J.getElement())??null},[]),oe=h.useCallback(()=>{var J;return((J=H.current)==null?void 0:J.getTextArea())??null},[]),de=h.useCallback(()=>{var Te;if(V===null)return"";const J=(Te=H.current)==null?void 0:Te.getTextArea();if(!J)return"";const he=J.value,je=J.selectionStart;return he.substring(V+1,je)},[V]),pe=h.useCallback((J,he)=>{for(let je=he-1;je>=0;je--){const Te=J[je];if(Te===" "||Te===`
`||Te==="	")return null;if(Te==="@"){const Ne=je>0?J[je-1]:null;return Ne===null||Ne===" "||Ne===`
`||Ne==="	"?je:null}}return null},[]),fe=J=>{var Ne;if(!b)return!1;const he=J.selectionStart,je=J.value,Te=pe(je,he);if(Te!==null){const Ce=(Ne=H.current)==null?void 0:Ne.getTextArea();if(Ce){const _e=Ce.getBoundingClientRect(),Me=k0(Ce,he);E(Me),F(_e.width),ae(!0)}return V!==Te&&Y(Te),!q&&!se&&(T?(Ge.clientLogsApiClient.sendLogs("A_file_picker_opening",{isFilePickerReady:T,showFilePickerPopover:q},"esc-blur-debug.log"),P(!0),x==null||x.info("@ character detected - showing file picker")):(le(!0),x==null||x.info("@ character detected - waiting for files to load"))),!0}else(q||se)&&(P(!1),le(!1),Y(null),ae(!1));return!1},be=J=>{const he=J.target;fe(he),t==null||t(J)},Pe=J=>{const he=J.currentTarget;setTimeout(()=>{fe(he)},0)},Ie=J=>{const he=J.currentTarget;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(J.key)&&fe(he)},K=h.useCallback(J=>{var je,Te;if(!q||!ce.current)return!1;const he=de();switch(J.key){case"ArrowDown":return J.preventDefault(),ce.current.navigate("down"),!0;case"ArrowUp":return J.preventDefault(),ce.current.navigate("up"),!0;case"Enter":return J.preventDefault(),ce.current.selectCurrent(),!0;case"Tab":if(he.startsWith("/")){J.preventDefault();const Ne=ce.current.tabComplete();if(Ne&&V!==null){const Ce=(je=H.current)==null?void 0:je.getTextArea();if(Ce){const _e=Ce.value.substring(0,V+1),Me=Ce.value.substring(Ce.selectionStart),Be=_e+Ne+Me,ze=V+1+Ne.length,lt=(Te=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Te.set;lt?lt.call(Ce,Be):Ce.value=Be,Ce.setSelectionRange(ze,ze),Ce.dispatchEvent(new Event("input",{bubbles:!0}))}}return!0}return!1;case"Escape":return Ge.clientLogsApiClient.sendLogs("1_esc_keydown_handler",{showFilePickerPopover:q,prevented:!0,stopped:!0},"esc-blur-debug.log"),J.preventDefault(),J.stopPropagation(),P(!1),Y(null),ae(!1),!0;default:return!1}},[q,de,V]),D=h.useCallback(J=>{const he=K(J);J.key==="Escape"&&Ge.clientLogsApiClient.sendLogs("3_handleKeyDown_wrapper",{handled:he,showFilePickerPopover:q,willPassToParent:!he},"esc-blur-debug.log"),!he&&(o==null||o(J))},[K,o]),X=(J,he)=>{var je,Te;if(m==null||m(J,he),!!b)if(J.length>0){const Ne=J.toLowerCase()==="file",Ce=(je=H.current)==null?void 0:je.getTextArea();let _e=null;if(Ce){const Me=Ce.value,Be=Ce.selectionStart;_e=xi(Me,Be)}Ne||_e?(P(!0),he&&E(he),Ne?(Y(null),x==null||x.info('Word "file" selected - showing file picker')):(Y(null),x==null||x.info(`File path "${_e==null?void 0:_e.path}" detected - showing file picker to replace`))):(P(!1),Y(null),ae(!1))}else{const Ne=(Te=H.current)==null?void 0:Te.getTextArea();if(Ne&&pe(Ne.value,Ne.selectionStart)!==null)return;P(!1),Y(null),ae(!1)}},we=J=>{var he;if(Ge.clientLogsApiClient.sendLogs("0_popover_onOpenChange",{open:J,currentShowFilePickerPopover:q},"esc-blur-debug.log"),P(J),!J){ae(!1);const je=(he=H.current)==null?void 0:he.getTextArea();je&&je.focus()}},ne=J=>{var Je;const he=(Je=H.current)==null?void 0:Je.getTextArea();if(!he)return;he.focus();const je=he.value,Te=he.selectionStart,Ce=he.value.substring(he.selectionStart,he.selectionEnd).toLowerCase()==="file",_e=xi(je,Te);let Me,Be,ze;if(V!==null)Me=V,Be=Te,ze="@"+J.path+" ";else if(Ce)Me=he.selectionStart,Be=he.selectionEnd,ze="@"+J.path+" ";else if(_e)Me=_e.start,Be=_e.end,ze="@"+J.path+" ";else{P(!1),Y(null),ae(!1);return}if(he.setSelectionRange(Me,Be),!document.execCommand("insertText",!1,ze)){const rt=he.value.substring(0,Me),gt=he.value.substring(Be);he.value=rt+ze+gt,he.setSelectionRange(Me+ze.length,Me+ze.length),he.dispatchEvent(new Event("input",{bubbles:!0}))}if(V!==null){const rt=je.substring(V,Te);x==null||x.info(`Replaced "${rt}" with: ${ze}`)}else Ce?x==null||x.info(`Replaced "file" with: ${ze}`):_e&&(x==null||x.info(`Replaced "${_e.path}" with: ${ze}`));g==null||g(J),P(!1),Y(null),ae(!1)},xe=h.useCallback(J=>{const he={target:{value:J},currentTarget:{value:J}};t==null||t(he)},[t]);return a.jsxs(nt,{open:q&&me,onOpenChange:we,modal:!1,"data-test":"textarea-file-picker-popover",children:[a.jsxs("div",{ref:Ae,className:"textarea-with-file-picker relative w-full h-full","data-test":"textarea-file-picker-container",onMouseDown:J=>{J.stopPropagation()},onClick:J=>{J.stopPropagation()},children:[L?a.jsx("div",{className:"relative w-full h-full",onMouseDown:i,onPaste:l,onClick:J=>{Pe(J),c==null||c(J)},onKeyUp:Ie,children:a.jsx($d,{ref:Q,defaultValue:s,value:e,onChange:xe,onBlur:n,onKeyDown:o,onPaste:d,className:p,style:u,placeholder:f,readOnly:R,useRichEditing:!0,showHints:M,showAudioButton:y,showConfigButton:j,audioButtonVariant:S,autoStartAudioRecording:C,onAudioTranscription:re,getTextAreaElement:G,audioNodeId:O,keyboard:I,onModeChange:z,"data-node-textarea":!0,"data-test":"textarea-file-picker-markdown-textarea"})}):a.jsx(Ll,{ref:H,defaultValue:s,value:e,onChange:be,onBlur:n,onFocus:r,onKeyDown:D,onMouseDown:i,onPaste:l,onClick:J=>{Pe(J),c==null||c(J)},onKeyUp:Ie,className:p,style:u,onSelectionChange:X,placeholder:f,showBuiltInPopover:v,showCopyButton:w,showAudioButton:y,audioButtonVariant:S,onAudioTranscription:re,getTextAreaElement:oe,readOnly:R,rows:k,autoFocus:A,keyboard:I,"data-test":"textarea-file-picker-selectable-textarea"}),b&&a.jsx(Tn,{ref:ge,style:{position:"absolute",top:`${te.top}px`,left:`${te.left}px`,width:"1px",height:"1px"},"data-test":"textarea-file-picker-popover-anchor"}),b&&!T&&a.jsx("div",{className:"hidden",children:a.jsx(fa,{maxResults:1,cwd:ve??void 0,onLoadComplete:ke,"data-test":"textarea-file-picker-preloader"})})]}),b&&a.jsxs(Qe,{className:"file-picker-popover p-0 border-none",side:"bottom",align:"start",sideOffset:C0,avoidCollisions:!0,collisionPadding:16,style:{zIndex:st.draggablePopoverDropdown,width:`${Math.round(_*.7)}px`},onOpenAutoFocus:J=>J.preventDefault(),onCloseAutoFocus:J=>J.preventDefault(),onInteractOutside:J=>J.preventDefault(),onPointerDownOutside:J=>J.preventDefault(),"data-test":"textarea-file-picker-popover-content",children:[a.jsx(fa,{ref:ce,onFileSelect:ne,maxResults:U?5:10,placeholder:"Search for a file...",mode:"fileNameOnly",cwd:ve??void 0,externalSearchQuery:de(),hideSearchInput:!0,"data-test":"textarea-file-picker-file-picker"}),a.jsx("div",{className:"text-[10px] text-muted-foreground p-1","data-test":"textarea-file-picker-popover-description",children:'Type to filter. Use "/" for directory navigation, Tab to autocomplete.'})]})]})});as.displayName="TextareaWithFilePicker";const Ud=h.forwardRef(({className:s,style:e,...t},n)=>{const r=bs();return a.jsx("textarea",{className:B("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),style:{fontSize:r?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:r?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...e},ref:n,...t})});Ud.displayName="Textarea";const E0=[];function I0({sessionId:s,isVisible:e,onClose:t,onSendMessage:n,triggerPosition:r}){const o=Le(u=>{var f,m,g,x;return((x=(g=(m=(f=u.app)==null?void 0:f.claude)==null?void 0:m.ui)==null?void 0:g.messageQueues)==null?void 0:x[s])??E0}),i=u=>{var g,x,v,b,w,y;const f=ie.getState(),m=((v=(x=(g=f.app)==null?void 0:g.claude)==null?void 0:x.ui)==null?void 0:v.messageQueues)??{};ie.updateState({app:{...f.app,claude:{...(b=f.app)==null?void 0:b.claude,ui:{...(y=(w=f.app)==null?void 0:w.claude)==null?void 0:y.ui,messageQueues:{...m,[s]:u}}}}})},c=(u,f)=>{const m=o.map(g=>g.id===u?{...g,content:f}:g);i(m)},l=u=>{const f=o.filter(m=>m.id!==u);i(f)},d=u=>{const f=o.find(m=>m.id===u);f&&(n(f.content),l(u))},p=()=>{i([])};return a.jsx(os,{isVisible:e,onClose:t,title:`Message Queue (${o.length})`,triggerPosition:r,initialSize:{width:500,height:400},resizable:!0,children:a.jsx("div",{"data-test":"message-queue-content",className:"flex flex-col h-full",children:o.length===0?a.jsx("div",{"data-test":"message-queue-empty",className:"flex-1 flex items-center justify-center text-muted-foreground text-sm",children:'No queued messages. End a message with "qqq" or "queue" to add it here.'}):a.jsxs(a.Fragment,{children:[a.jsx(nn,{className:"flex-1 pr-4",children:a.jsx("div",{"data-test":"message-queue-list",className:"space-y-3 p-2",children:o.map((u,f)=>a.jsxs("div",{"data-test":"queue-item",className:"border rounded-lg p-3 space-y-2 bg-muted/30",children:[a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["#",f+1]}),a.jsx("span",{children:new Date(u.createdAt).toLocaleTimeString()})]}),a.jsx(Ud,{"data-test":"queue-item-textarea",value:u.content,onChange:m=>c(u.id,m.target.value),rows:3,className:"resize-y text-sm"}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(ue,{"data-test":"queue-item-delete",variant:"ghost",size:"sm",onClick:()=>l(u.id),title:"Delete",children:a.jsx(Et,{className:"h-4 w-4 text-destructive"})}),a.jsxs(ue,{"data-test":"queue-item-send",variant:"outline",size:"sm",onClick:()=>d(u.id),title:"Send now",children:[a.jsx(Ln,{className:"h-4 w-4 mr-1"}),"Send"]})]})]},u.id))})}),a.jsx("div",{"data-test":"message-queue-footer",className:"flex justify-end gap-2 pt-3 border-t mt-2",children:a.jsx(ue,{"data-test":"message-queue-clear-all",variant:"destructive",size:"sm",onClick:p,children:"Clear All"})})]})})})}const Dr={outputFormat:"text",permissionMode:"acceptEdits"};function ba({variant:s="outline",size:e="sm",buttonLabel:t="Options",className:n,children:r,sessionId:o,onSendQueuedMessage:i}){const[c,l]=h.useState(!1),[d,p]=h.useState(!1),u=h.useRef(null),[f,m]=h.useState(),g=Le(y=>{var j,S,C,N,O;return o?((O=(N=(C=(S=(j=y.app)==null?void 0:j.claude)==null?void 0:S.ui)==null?void 0:C.messageQueues)==null?void 0:N[o])==null?void 0:O.length)??0:0}),x=()=>{if(u.current){const y=u.current.getBoundingClientRect();m({x:y.left,y:y.bottom+8})}l(!1),p(!0)},v=Le(y=>{var j,S,C;return(C=(S=(j=y.ui)==null?void 0:j.claude)==null?void 0:S.message)==null?void 0:C.options}),b={outputFormat:(v==null?void 0:v.outputFormat)??Dr.outputFormat,permissionMode:(v==null?void 0:v.permissionMode)??Dr.permissionMode};h.useEffect(()=>{var y,j,S;if(!v){const C=ie.getState();ie.updateState({ui:{...C.ui,claude:{...(y=C.ui)==null?void 0:y.claude,message:{...(S=(j=C.ui)==null?void 0:j.claude)==null?void 0:S.message,options:Dr}}}})}},[v]);const w=y=>{var S,C,N;const j=ie.getState();ie.updateState({ui:{...j.ui,claude:{...(S=j.ui)==null?void 0:S.claude,message:{...(N=(C=j.ui)==null?void 0:C.claude)==null?void 0:N.message,options:y}}}})};return a.jsxs(a.Fragment,{children:[a.jsxs(nt,{open:c,onOpenChange:l,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(ue,{variant:s,size:e,className:n,title:"Message Options","data-test":"message-options-button",children:[a.jsx(qt,{className:"h-4 w-4"}),t&&a.jsx("span",{className:"ml-2",children:t})]})}),a.jsx(Qe,{className:"w-80",style:{zIndex:st.draggablePopoverDropdown},onClick:y=>y.stopPropagation(),"data-test":"message-options-popover",children:a.jsxs("div",{className:"message-options-panel space-y-4","data-test":"message-options-panel",children:[a.jsxs("div",{className:"output-format-select","data-test":"output-format-select",children:[a.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Output Format"}),a.jsxs($t,{value:b.outputFormat,onValueChange:y=>w({...b,outputFormat:y}),children:[a.jsx(It,{"data-test":"output-format-trigger",children:a.jsx(Kt,{})}),a.jsxs(Tt,{"data-test":"output-format-content",children:[a.jsx(Oe,{value:"text","data-test":"output-format-text",children:"Text"}),a.jsx(Oe,{value:"json","data-test":"output-format-json",children:"JSON"}),a.jsx(Oe,{value:"stream-json","data-test":"output-format-stream-json",children:"Stream JSON"})]})]})]}),a.jsxs("div",{className:"permission-mode-select","data-test":"permission-mode-select",children:[a.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Permission Mode"}),a.jsxs($t,{value:b.permissionMode,onValueChange:y=>w({...b,permissionMode:y}),children:[a.jsx(It,{"data-test":"permission-mode-trigger",children:a.jsx(Kt,{})}),a.jsxs(Tt,{"data-test":"permission-mode-content",children:[a.jsx(Oe,{value:"default","data-test":"permission-mode-default",children:"Default"}),a.jsx(Oe,{value:"acceptEdits","data-test":"permission-mode-accept-edits",children:"Accept Edits"}),a.jsx(Oe,{value:"bypassPermissions","data-test":"permission-mode-bypass",children:"Bypass Permissions"}),a.jsx(Oe,{value:"plan","data-test":"permission-mode-plan",children:"Plan Mode"})]})]})]}),o&&a.jsx("div",{"data-test":"view-queue-section",className:"pt-2 border-t",children:a.jsxs(ue,{ref:u,variant:"outline",size:"sm",className:"w-full justify-start",onClick:x,"data-test":"view-queue-button",children:[a.jsx(ec,{className:"h-4 w-4 mr-2"}),"View Queue",g>0&&a.jsx("span",{className:"ml-auto bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:g})]})})]})})]}),o&&i&&a.jsx(I0,{sessionId:o,isVisible:d,onClose:()=>p(!1),onSendMessage:i,triggerPosition:f}),r==null?void 0:r(b)]})}const T0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.items)??[]},A0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.loading)??!1},P0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.error)??null},R0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.pagination)??null},D0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.currentPage)??1},_0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.favoritesOnly)??!1},O0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.isInitialized)??!1};function L0(s={}){const{loadOnMount:e=!1,parentSessionId:t,filterByCategory:n,filterByTag:r,pageSize:o=20}=s,{update:i,getState:c}=_a(),l=h.useRef(!1),d=Le(T0),p=Le(A0),u=Le(P0),f=Le(R0),m=Le(D0),g=Le(_0),x=Le(O0),v=h.useCallback(async(k=1,A=!1)=>{var L,M,I,z;try{const $=(M=(L=c().app)==null?void 0:L.claude)==null?void 0:M.forks;i("app",{claude:{forks:{...$,loading:!0,error:null,currentPage:k}}});const q={page:k,pageSize:o,sortBy:"createdAt",sortOrder:"desc"};t&&(q.parentSessionId=t),$!=null&&$.favoritesOnly&&(q.favoritesOnly=!0),n&&(q.category=n),r&&(q.tag=r);const P=await Ye.getForks(q),te=($==null?void 0:$.items)??[],E=A?[...te,...P.forks]:P.forks;i("app",{claude:{forks:{items:E,pagination:P.pagination,currentPage:k,loading:!1,error:null,favoritesOnly:($==null?void 0:$.favoritesOnly)??!1,isInitialized:!0}}})}catch($){console.error("[useForks] API request failed:",{error:$,errorMessage:$ instanceof Error?$.message:"Unknown error",page:k,append:A,parentSessionId:t,timestamp:new Date().toISOString()});const q=(z=(I=c().app)==null?void 0:I.claude)==null?void 0:z.forks;i("app",{claude:{forks:{items:A?(q==null?void 0:q.items)??[]:[],pagination:null,currentPage:k,loading:!1,error:$ instanceof Error?$.message:"Failed to load forks",favoritesOnly:(q==null?void 0:q.favoritesOnly)??!1,isInitialized:!0}}})}},[i,c,t,n,r,o]),b=h.useCallback(()=>{var L,M;const k=(M=(L=c().app)==null?void 0:L.claude)==null?void 0:M.forks,A=!(k!=null&&k.favoritesOnly);i("app",{claude:{forks:{...k,favoritesOnly:A}}}),v(1)},[i,c,v]),w=h.useCallback(async k=>{var M,I,z,$,q;const A=((z=(I=(M=c().app)==null?void 0:M.claude)==null?void 0:I.forks)==null?void 0:z.items)??[],L=A.find(P=>P.sessionId===k);if(L)try{const P=await Ye.updateFork(k,{isFavorite:!L.isFavorite}),te=A.map(_=>_.sessionId===k?P.fork:_),E=(q=($=c().app)==null?void 0:$.claude)==null?void 0:q.forks;i("app",{claude:{forks:{...E,items:te}}})}catch(P){console.error("[useForks] Failed to toggle favorite:",{sessionId:k,error:P,errorMessage:P instanceof Error?P.message:"Unknown error",timestamp:new Date().toISOString()})}},[i,c]),y=h.useCallback(async(k,A)=>{try{return(await Ye.forkSession(k,A)).success?(v(1),!0):!1}catch(L){return console.error("[useForks] Failed to create fork:",{sessionId:k,request:A,error:L,errorMessage:L instanceof Error?L.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[v]),j=h.useCallback(async k=>{var A,L;try{if((await Ye.deleteFork(k)).success){const I=(L=(A=c().app)==null?void 0:A.claude)==null?void 0:L.forks,$=((I==null?void 0:I.items)??[]).filter(q=>q.sessionId!==k);return i("app",{claude:{forks:{...I,items:$}}}),!0}return!1}catch(M){return console.error("[useForks] Failed to delete fork:",{sessionId:k,error:M,errorMessage:M instanceof Error?M.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[i,c]),S=h.useCallback(()=>{f&&m<f.totalPages&&v(m+1,!0)},[f,m,v]),C=h.useCallback(()=>{v(1)},[v]),N=h.useCallback(async(k,A)=>{var L,M;try{const I=await Ye.updateFork(k,A);if(I.success){const z=(M=(L=c().app)==null?void 0:L.claude)==null?void 0:M.forks,q=((z==null?void 0:z.items)??[]).map(P=>P.sessionId===k?I.fork:P);return i("app",{claude:{forks:{...z,items:q}}}),I.fork}return null}catch(I){return console.error("[useForks] Failed to update fork:",{sessionId:k,updates:A,error:I,errorMessage:I instanceof Error?I.message:"Unknown error",timestamp:new Date().toISOString()}),null}},[i,c]),O=h.useCallback((k,A)=>{var $,q;const L=(q=($=c().app)==null?void 0:$.claude)==null?void 0:q.forks,M=(L==null?void 0:L.items)??[],I=M.findIndex(P=>P.sessionId===k);if(I===-1)return;const z=[...M];z[I]={...z[I],...A},i("app",{claude:{forks:{...L,items:z}}})},[i,c]),R=h.useCallback(async()=>{try{return(await Ye.getForkTags()).tags}catch(k){return console.error("[useForks] Failed to get available tags:",{error:k,errorMessage:k instanceof Error?k.message:"Unknown error",timestamp:new Date().toISOString()}),[]}},[]);return h.useEffect(()=>{e&&(x||l.current||(l.current=!0,v(1)))},[e,x,v]),{forks:d,loading:p,error:u,pagination:f,currentPage:m,favoritesOnly:g,isInitialized:x,loadForks:v,refreshForks:C,handleLoadMore:S,toggleFavoritesOnly:b,toggleFavorite:w,createFork:y,deleteFork:j,updateFork:N,updateSingleFork:O,getAvailableTags:R}}const M0="Use @agent-code-worktree-specialist to help with this task.",F0="Please implement this feature following best practices and ensure all tests pass.";function wa({variant:s="ghost",size:e="icon",className:t="create-session-panel-button",disabled:n=!1,icon:r,initialMessage:o,buttonTitle:i="Create New Session with Message",projectPath:c,initialForkSessionId:l,onOpen:d,onCreating:p,onSessionCreated:u,useModal:f=!1}){const[m,g]=h.useState(!1),[x,v]=h.useState(!1),[b,w]=h.useState(o||""),[y,j]=h.useState(o||""),[S,C]=h.useState(void 0),[N,O]=h.useState(!1),[R,k]=h.useState(null),[A,L]=h.useState(l??null),M=h.useRef(null),{forks:I,loading:z}=L0({loadOnMount:!0}),$=Le(T=>{var W,se,le;return(le=(se=(W=T.app)==null?void 0:W.claude)==null?void 0:se.ui)==null?void 0:le.selectedProjectPath}),q=Le(T=>{var W,se;return(se=(W=T.ui)==null?void 0:W.global)==null?void 0:se.createClaudeSessionPopoverSize}),P=q?{width:q.width}:void 0,te=T=>{var se;const W=ie.getState();ie.updateState({ui:{...W.ui,global:{...(se=W.ui)==null?void 0:se.global,createClaudeSessionPopoverSize:{width:T.width}}}})};h.useEffect(()=>{o!==y&&(w(o||""),j(o||""))},[o,y]),h.useEffect(()=>{L(l??null)},[l]),h.useEffect(()=>{var T,W,se,le,me,ae;if(m&&c&&c!=="none"){const H=ie.getState();((se=(W=(T=H.app)==null?void 0:T.claude)==null?void 0:W.ui)==null?void 0:se.selectedProjectPath)!==c&&ie.updateState({app:{...H.app,claude:{...(le=H.app)==null?void 0:le.claude,ui:{...(ae=(me=H.app)==null?void 0:me.claude)==null?void 0:ae.ui,selectedProjectPath:c}}}})}},[m,c]);const E=()=>{if(!f&&M.current){const T=M.current.getBoundingClientRect();C({x:T.left,y:T.bottom+8})}g(!0),d&&d()},_=()=>{g(!1)},F=(T,W)=>{const se=[];return W.usePrompt1&&W.prompt1Text&&se.push(W.prompt1Text),W.usePrompt2&&W.prompt2Text&&se.push(W.prompt2Text),se.length>0?`${se.join(`

`)}

${T}`:T},V=T=>{const W=$??c;return{message:b.trim(),cwd:W,projectId:W,options:{outputFormat:T.outputFormat,permissionMode:T.permissionMode}}},Y=async T=>{if(console.log("ðŸŽ¯ [ButtonCreateSession] handleSendMessage called",{messageLength:b.trim().length,sessionOptions:T,selectedForkSessionId:A,timestamp:new Date().toISOString()}),!b.trim()){console.log("âš ï¸ [ButtonCreateSession] Message is empty, aborting");return}try{if(console.log("ðŸ“¤ [ButtonCreateSession] Setting sending state to true"),v(!0),p&&(console.log("ðŸ“£ [ButtonCreateSession] Calling onCreating callback"),p()),A){console.log("ðŸ´ [ButtonCreateSession] Creating new fork from selected fork",{parentSessionId:A});const W=await Ye.forkSession(A,{description:`Fork for: ${b.trim().slice(0,50)}...`});if(console.log("âœ… [ButtonCreateSession] New fork created",{success:W.success,newSessionId:W.sessionId,parentSessionId:W.parentSessionId}),!W.success||!W.sessionId)throw new Error("Failed to create fork from selected session");console.log("ðŸ“¤ [ButtonCreateSession] Sending message to new fork",{sessionId:W.sessionId});const se=await Ye.sendMessage({sessionId:W.sessionId,message:b.trim(),options:{outputFormat:T.outputFormat,permissionMode:T.permissionMode}});if(console.log("âœ… [ButtonCreateSession] Message sent to new fork",{success:se.success,sessionId:se.sessionId}),se.success)u&&u(se.sessionId,se.response),_();else throw new Error("Failed to send message to new fork session")}else{const W=V(T);console.log("ðŸ“¦ [ButtonCreateSession] Request body built",{hasMessage:!!W.message,hasCwd:!!W.cwd,hasProjectId:!!W.projectId,optionsCount:Object.keys(W.options||{}).length}),console.log("ðŸš€ [ButtonCreateSession] Calling claudeAPI.createSession");const se=await Ye.createSession(W);if(console.log("âœ… [ButtonCreateSession] API response received",{success:se.success,hasSessionId:!!se.sessionId,error:se.error}),se.success&&se.sessionId)console.log("ðŸŽ‰ [ButtonCreateSession] Session created successfully",{sessionId:se.sessionId}),u&&(console.log("ðŸ“ž [ButtonCreateSession] Calling onSessionCreated callback"),u(se.sessionId,se.response)),_();else throw new Error(se.error??"Failed to create session")}}catch(W){console.error("âŒ [ButtonCreateSession] Failed to create/resume session:",W)}finally{console.log("ðŸ [ButtonCreateSession] Setting sending state to false"),v(!1)}};return a.jsx(dn,{storageKey:"claude-session-prompts",initialConfig:{usePrompt1:!1,usePrompt2:!1,prompt1Text:M0,prompt2Text:F0},children:(T,W,se)=>{const le=(ae,H)=>{const Q={...T,[ae]:H};W(Q);const ge=F(o||"",Q);w(ge)},me=a.jsxs("div",{"data-test":"create-session-content",className:"content-wrapper p-4 space-y-4",children:[a.jsxs("div",{"data-test":"create-session-project-selector-section",className:"project-selector-container mb-4",children:[a.jsxs("div",{"data-test":"create-session-header",className:"flex items-center justify-between",children:[a.jsxs("div",{"data-test":"create-session-labels",className:"flex items-center gap-4",children:[a.jsx("label",{"data-test":"create-session-project-label",className:"project-selector-label text-sm font-medium",children:"Select Project"}),a.jsxs("label",{"data-test":"create-session-fork-label",className:"fork-selector-label text-sm font-medium flex items-center gap-1",children:[a.jsx(ts,{className:"h-3 w-3"}),"Fork From"]})]}),a.jsx(se,{title:"Prompt Configuration",buttonClassName:"prompt-config-button",children:a.jsxs("div",{"data-test":"prompt-config-panel",className:"prompt-config-panel space-y-4",onClick:ae=>ae.stopPropagation(),children:[a.jsxs("div",{"data-test":"prompt-checkbox-1-container",className:"prompt-checkbox-container flex items-center space-x-2",children:[a.jsx(Ct,{"data-test":"prompt-checkbox-1",id:"use-prompt-1",checked:T.usePrompt1,onCheckedChange:ae=>le("usePrompt1",ae===!0)}),a.jsx(Se,{htmlFor:"use-prompt-1",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 1"})]}),a.jsx("div",{"data-test":"prompt-text-display-1",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:T.prompt1Text}),a.jsxs("div",{"data-test":"prompt-checkbox-2-container",className:"prompt-checkbox-container flex items-center space-x-2 mt-4",children:[a.jsx(Ct,{"data-test":"prompt-checkbox-2",id:"use-prompt-2",checked:T.usePrompt2,onCheckedChange:ae=>le("usePrompt2",ae===!0)}),a.jsx(Se,{htmlFor:"use-prompt-2",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 2"})]}),a.jsx("div",{"data-test":"prompt-text-display-2",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:T.prompt2Text})]})})]}),a.jsxs("div",{"data-test":"create-session-selectors",className:"flex gap-2 mt-2",children:[a.jsx("div",{className:`flex-1 ${A?"opacity-50 pointer-events-none":""}`,children:a.jsx(Rc,{"data-test":"create-session-project-selector",variant:"select",className:"project-selector w-full"})}),a.jsxs($t,{value:A??"none",onValueChange:ae=>L(ae==="none"?null:ae),children:[a.jsx(It,{"data-test":"create-session-fork-selector",className:"fork-selector flex-1",children:a.jsx(Kt,{placeholder:"No fork (new session)"})}),a.jsxs(Tt,{"data-test":"create-session-fork-options",style:{zIndex:st.draggablePopoverDropdown},children:[a.jsx(Oe,{value:"none","data-test":"fork-option-none",children:a.jsx("span",{className:"text-muted-foreground",children:"No fork (new session)"})}),z?a.jsx(Oe,{value:"loading",disabled:!0,children:"Loading forks..."}):I.map(ae=>a.jsx(Oe,{value:ae.sessionId,"data-test":"fork-option-item",children:a.jsxs("div",{className:"flex flex-col items-start",children:[a.jsx("span",{className:"font-medium",children:ae.sessionName??ae.description??`Fork ${ae.sessionId.slice(0,8)}`}),a.jsxs("span",{className:"text-xs text-muted-foreground",children:[ae.messageCount??0," messages"]})]})},ae.id))]})]})]})]}),a.jsxs("div",{"data-test":"create-session-message-container",className:"new-session-input-container space-y-3",children:[a.jsx(as,{"data-test":"create-session-textarea",value:b,onChange:ae=>w(ae.target.value),placeholder:"Type your message...",rows:10,className:"resize-y"}),a.jsx("div",{"data-test":"create-session-actions",className:"flex justify-end gap-2 items-center",children:a.jsx(ba,{variant:"outline",size:"sm",buttonLabel:"Options",className:"session-options-button","data-test":"create-session-options-button",children:ae=>a.jsx(dr,{"data-test":"create-session-send-button",label:a.jsxs(a.Fragment,{children:[A?a.jsx(ts,{className:"h-4 w-4 mr-2"}):a.jsx(Ln,{className:"h-4 w-4 mr-2"}),x?A?"Forking...":"Creating Session...":A?"Fork & Send":"Create Session"]}),onAction:()=>{console.log("ðŸ‘† [ButtonCreateSession] ConfigurableButton onAction triggered",{messageLength:b.trim().length,sending:x,selectedForkSessionId:A,disabled:!b.trim()||x,timestamp:new Date().toISOString()}),Y(ae)},disabled:!b.trim()||x,variant:"default",configOptions:[{label:"Preview Request Body",value:"preview",onClick:()=>{k(ae),O(!0)},icon:a.jsx(Hr,{className:"h-4 w-4"})}],showHint:!0,tooltipText:A?"Click to fork and send message":"Click to send, hold to preview request",ariaLabel:A?"Fork and Send button":"Create Session button with preview option"})})}),N&&R&&a.jsx(Fn,{open:N,onOpenChange:O,children:a.jsxs($n,{className:"sm:max-w-[600px] max-h-[70vh] overflow-y-auto",children:[a.jsx(Un,{children:a.jsx(Zs,{children:"Request Body Preview"})}),a.jsx("pre",{className:"request-preview-content bg-muted p-4 rounded-md text-xs font-mono overflow-x-auto whitespace-pre-wrap",children:JSON.stringify(V(R),null,2)}),a.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[a.jsx(ue,{variant:"outline",onClick:()=>O(!1),children:"Close"}),a.jsxs(ue,{onClick:()=>{O(!1),Y(R)},children:[a.jsx(Ln,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})]});return a.jsxs(a.Fragment,{children:[a.jsx(ue,{ref:M,"data-test":"create-session-button",variant:s,size:e,disabled:n,className:t,title:i,onClick:E,children:r??a.jsx(Gr,{className:"h-4 w-4 hover:text-purple-500 transition-colors"})}),f?a.jsx(Fn,{open:m,onOpenChange:g,children:a.jsxs($n,{"data-test":"create-session-dialog",className:"sm:max-w-[700px] max-h-[80vh] overflow-y-auto",children:[a.jsx(Un,{children:a.jsx(Zs,{children:"Create New Session"})}),me]})}):a.jsx(os,{"data-test":"create-session-popover",isVisible:m,onClose:_,title:"Create New Session",className:"max-h-[80vh]",shouldCloseManually:!0,resizable:!0,initialSize:P||{width:700},onSizeChange:te,triggerPosition:S,children:me})]})}})}function vi({buttonLabel:s,icon:e=a.jsx(rr,{className:"h-5 w-5"}),variant:t="ghost",size:n="icon",buttonClassName:r="",contentClassName:o="",align:i="end",side:c="bottom",title:l="Audio Recorder"}){const[d,p]=h.useState(!1);return a.jsxs(nt,{open:d,onOpenChange:p,"data-test":"audio-recorder-popover",children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:t,size:n,className:`audio-recorder-button ${r}`,title:l,"data-test":"audio-recorder-trigger-button",children:s?a.jsxs(a.Fragment,{children:[e,s&&a.jsx("span",{className:"ml-2","data-test":"audio-recorder-button-label",children:s})]}):e})}),a.jsxs(Qe,{className:`audio-recorder-panel w-[400px] ${o}`,align:i,side:c,"data-test":"audio-recorder-popover-content",children:[l&&a.jsx("div",{className:"audio-panel-header pb-2 mb-2 border-b border-border","data-test":"audio-recorder-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"audio-recorder-panel-title",children:l})}),a.jsx("div",{className:"audio-panel-content","data-test":"audio-recorder-panel-content",children:a.jsx(as,{})})]})]})}const Bd=Gu,ro=h.forwardRef(({className:s,...e},t)=>a.jsx(Ji,{ref:t,className:B("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",s),...e}));ro.displayName=Ji.displayName;const an=h.forwardRef(({className:s,...e},t)=>a.jsx(Yi,{ref:t,className:B("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",s),...e}));an.displayName=Yi.displayName;const on=h.forwardRef(({className:s,...e},t)=>a.jsx(Xi,{ref:t,className:B("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...e}));on.displayName=Xi.displayName;var Gt=(s=>(s.LOW="low",s.MEDIUM="medium",s.HIGH="high",s.URGENT="urgent",s))(Gt||{}),Xe=(s=>(s.FREEZER="freezer",s.BACKLOG="backlog",s.SELECTED="selected",s.DOING="doing",s.DONE="done",s.ARCHIVE="archive",s))(Xe||{}),Zt=(s=>(s.PERSONAL="personal",s.WORK="work",s.SHOPPING="shopping",s.HEALTH="health",s.OTHER="other",s))(Zt||{});function Wd({session:s,segmentsToStrip:e=3,onNameUpdated:t}){const[n,r]=h.useState(!1),[o,i]=h.useState(""),[c,l]=h.useState(!1),d=h.useRef(null),p=h.useRef(0),u=h.useMemo(()=>{const{name:b,cwd:w}=s;if(!b.startsWith("-home-"))return b;let j=b;const S=/\/[a-f0-9]{8}[a-f0-9-]*$/i;j=j.replace(S,""),j.startsWith("-")&&(j=j.substring(1));const C="/"+j.replace(/-/g,"/");w&&C.startsWith(w);const N=C.split("/").filter(Boolean);return e>0&&N.length>e?N.slice(e).join("/"):N.length===0?b:N.join("/")},[s,e]),f=s.customName||u;h.useEffect(()=>{n&&d.current&&(d.current.focus(),d.current.select())},[n]);const m=()=>{i(s.customName||""),r(!0)},g=b=>{const w=Date.now(),y=w-p.current;y<300&&y>0&&(b.preventDefault(),m()),p.current=w},x=async()=>{if(!c)try{l(!0);const b=o.trim()===""?null:o.trim();await Ye.updateSessionName(s.id,b),t==null||t(),r(!1)}catch(b){console.error("Failed to update session name:",b),alert("Failed to update session name")}finally{l(!1)}},v=b=>{b.key==="Enter"?x():b.key==="Escape"&&r(!1)};return n?a.jsxs("div",{className:"session-name-edit flex items-center gap-2","data-test":"session-name-edit-container",children:[a.jsx("input",{ref:d,type:"text",value:o,onChange:b=>i(b.target.value),onKeyDown:v,onBlur:()=>r(!1),className:"flex-1 px-2 py-1 border rounded",placeholder:u,disabled:c,"data-test":"session-name-input"}),a.jsx("button",{onMouseDown:b=>{b.preventDefault(),x()},disabled:c,className:"session-name-save-btn p-1 hover:bg-gray-100 rounded",title:"Save (Enter)","data-test":"session-name-save-button",children:a.jsx(ct,{className:"w-4 h-4"})})]}):a.jsx("span",{className:"session-name-display cursor-pointer hover:underline",style:{touchAction:"manipulation"},onPointerDown:g,onDoubleClick:m,title:"Double-click to edit","data-test":"session-name-display",children:f})}function $0({sessionIds:s=[],className:e="",title:t="Claude session is running",showCount:n=!1,lastActiveTime:r,isCreating:o=!1}){const[i,c]=h.useState({}),[l,d]=h.useState([]),p=h.useRef(s);h.useEffect(()=>{p.current=s},[s]),h.useEffect(()=>{var O,R,k;const C=((k=(R=(O=ie.get("app"))==null?void 0:O.claude)==null?void 0:R.data)==null?void 0:k.sessions)??[];d(C);const N=ie.selectSlice(A=>{var L,M,I;return(I=(M=(L=A.app)==null?void 0:L.claude)==null?void 0:M.data)==null?void 0:I.sessions}).subscribe(A=>{d(A??[])});return()=>N.unsubscribe()},[]);const u=h.useMemo(()=>{if(r!==void 0)return r;if(!s.length||!l.length)return;const C=l.filter(O=>s.includes(O.id));if(!C.length)return;const N=C.reduce((O,R)=>{const k=new Date(R.lastModified).getTime();return k>O?k:O},0);return N>0?N:void 0},[r,s,l]);h.useEffect(()=>{var A,L,M;const C=I=>{if(!I)return{};const z={};for(const $ of p.current)I[$]&&(z[$]=I[$]);return z},N=(I,z)=>{const $=Object.keys(I),q=Object.keys(z);if($.length!==q.length)return!0;for(const P of q)if(!I[P]||I[P].isOpened!==z[P].isOpened||I[P].isProcessing!==z[P].isProcessing)return!0;return!1},O=((M=(L=(A=ie.get("app"))==null?void 0:A.claude)==null?void 0:L.ui)==null?void 0:M.activity)??{},R=C(O);c(R);const k=ie.selectSlice(I=>{var z,$,q;return(q=($=(z=I.app)==null?void 0:z.claude)==null?void 0:$.ui)==null?void 0:q.activity}).subscribe(I=>{const z=C(I);c($=>N($,z)?z:$)});return()=>k.unsubscribe()},[]);const f=h.useCallback(C=>{const N=i[C];if(N!=null&&N.isProcessing)return"running";if(N!=null&&N.isOpened&&!(N!=null&&N.isProcessing))return"opened";if(u){const O=Date.now()-36e5;if(u>O)return"recent"}return"inactive"},[i,u]),m=C=>{switch(C){case"running":return{status:"running",color:"bg-green-500",bgColor:"bg-green-500",textColor:"text-green-600"};case"opened":return{status:"opened",color:"bg-orange-500",bgColor:"bg-orange-500",textColor:"text-orange-600"};case"recent":return{status:"recent",color:"bg-yellow-500",bgColor:"bg-yellow-500",textColor:"text-yellow-600"};case"inactive":default:return{status:"inactive",color:"bg-gray-400",bgColor:"bg-gray-400",textColor:"text-gray-500"}}},g=h.useMemo(()=>s.map(C=>({id:C,status:f(C)})).filter(C=>C.status!=="inactive"),[s,f]),x=g.length>0,v=h.useMemo(()=>g.some(C=>C.status==="running")?"running":g.some(C=>C.status==="opened")?"opened":g.some(C=>C.status==="recent")?"recent":"inactive",[g]),b=m(v),w=h.useMemo(()=>{if(n&&g.length>1){const N={running:"running",opened:"opened",recent:"recently active",inactive:"inactive"}[v];return`${g.length} Claude sessions ${N}`}const C={running:"Claude session is running",opened:"Claude session is opened",recent:"Claude session recently active",inactive:"Claude session inactive"}[v];return t||C},[n,g.length,v,t]);if(!x&&!o)return null;const y=o?"running":v,j=o?m("running"):b,S=o?"Creating Claude session...":w;return a.jsxs("div",{className:`session-activity-indicator flex items-center gap-1 ${e}`,title:S,"data-test":"session-activity-indicator",children:[a.jsx("div",{className:`activity-dot w-2 h-2 ${j.bgColor} rounded-full ${y==="running"?"animate-pulse":""}`,"data-test":"activity-dot","data-activity-status":y,"data-is-creating":o}),n&&g.length>1&&a.jsx("span",{className:`activity-count text-xs ${j.textColor} font-medium`,"data-test":"activity-count",children:g.length})]})}function U0(s,e){if(s.className!==e.className||s.title!==e.title||s.showCount!==e.showCount||s.lastActiveTime!==e.lastActiveTime||s.isCreating!==e.isCreating)return!1;const t=s.sessionIds??[],n=e.sessionIds??[];return t.length!==n.length?!1:t.every((r,o)=>r===n[o])}const ao=h.memo($0,U0),B0=[{value:"user",label:"User Messages",description:"Pure user messages (no tool content)"},{value:"assistant",label:"Assistant Responses",description:"Pure assistant responses (no thinking/tool blocks)"},{value:"thinking",label:"Thinking Blocks",description:"Messages containing thinking blocks"},{value:"tools",label:"Tool Calls/Results",description:"Messages containing tool_use or tool_result blocks"}],zd=h.forwardRef(({searchQuery:s,onSearchChange:e,onAdvancedSearch:t,className:n},r)=>{const[o,i]=h.useState(!1),[c,l]=h.useState({messageType:[],sortOrder:"desc",pageSize:50}),d=h.useMemo(()=>{const{sortOrder:v,pageSize:b,messageType:w,...y}=c,j=Object.values(y).some(N=>N!==void 0),S=w&&w.length>0;return j||S||v!=="desc"},[c]),p=(v,b)=>{l(w=>({...w,[v]:b}))},u=(v,b)=>{l(w=>{const y=w.messageType||[],j=b?[...y,v]:y.filter(S=>S!==v);return{...w,messageType:j.length>0?j:[]}})},f=()=>{t&&t(s,c),i(!1)},m=()=>{l({messageType:[],sortOrder:"desc",pageSize:50})},g=v=>{v.key==="Enter"&&t&&t(s,c)},x=()=>{e("")};return a.jsx("div",{ref:r,className:B("messages-search-container relative",n),"data-test":"messages-search-container",children:a.jsxs("div",{className:"search-input-wrapper relative flex items-center gap-1","data-test":"messages-search-input-wrapper",children:[a.jsx(or,{className:"search-icon absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10","data-test":"messages-search-icon"}),a.jsx(We,{type:"text",placeholder:"Search messages...",value:s,onChange:v=>e(v.target.value),onKeyDown:g,className:B("search-input pl-9",s?"pr-16":"pr-10"),"data-test":"messages-search-input"}),s&&a.jsx(ue,{variant:"ghost",size:"icon",onClick:x,className:"clear-button absolute right-9 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"messages-search-clear-button",children:a.jsx(ht,{className:"h-4 w-4"})}),d&&a.jsx("div",{className:B("filter-indicator absolute top-1/2 -translate-y-1/2 h-2 w-2 rounded-full bg-primary pointer-events-none z-10",s?"right-17":"right-11"),"data-test":"messages-search-filter-indicator"}),a.jsxs(nt,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsx(ue,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0","aria-label":o?"Collapse advanced search":"Expand advanced search","data-test":"messages-search-expand-button",children:o?a.jsx(ar,{className:"h-4 w-4"}):a.jsx(wt,{className:"h-4 w-4"})})}),a.jsxs(Qe,{align:"start",className:"advanced-search-panel w-96 max-h-[600px] overflow-y-auto","data-test":"messages-advanced-search-panel",children:[a.jsxs("div",{className:"panel-header space-y-2 pb-3 border-b","data-test":"messages-panel-header",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),a.jsx(ue,{variant:"ghost",size:"sm",onClick:m,className:"h-7 text-xs","data-test":"messages-clear-filters-button",children:"Clear All"})]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Search message content with filters"})]}),a.jsxs("div",{className:"panel-content space-y-4 py-4","data-test":"messages-panel-content",children:[a.jsxs("div",{className:"message-types-filter space-y-2","data-test":"messages-types-section",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Message Types"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Filter by message type"}),a.jsx("div",{className:"message-types-grid space-y-2",children:B0.map(v=>{var b;return a.jsxs("div",{className:"message-type-item flex items-center space-x-2",children:[a.jsx(Ct,{id:`msgtype-${v.value}`,checked:(b=c.messageType)==null?void 0:b.includes(v.value),onCheckedChange:w=>u(v.value,w===!0),"data-test":"messages-message-type-checkbox"}),a.jsxs("label",{htmlFor:`msgtype-${v.value}`,className:"text-sm cursor-pointer flex-1",children:[a.jsx("span",{children:v.label}),a.jsx("span",{className:"text-xs text-muted-foreground block",children:v.description})]})]},v.value)})})]}),a.jsxs("div",{className:"timestamp-range-filter space-y-2",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Timestamp Range"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"timestamp-input-wrapper",children:[a.jsx(Se,{htmlFor:"timestamp-after",className:"text-xs text-muted-foreground",children:"After"}),a.jsx(We,{id:"timestamp-after",type:"datetime-local",value:c.after??"",onChange:v=>p("after",v.target.value||void 0),className:"h-8"})]}),a.jsxs("div",{className:"timestamp-input-wrapper",children:[a.jsx(Se,{htmlFor:"timestamp-before",className:"text-xs text-muted-foreground",children:"Before"}),a.jsx(We,{id:"timestamp-before",type:"datetime-local",value:c.before??"",onChange:v=>p("before",v.target.value||void 0),className:"h-8"})]})]})]}),a.jsxs("div",{className:"sorting-section space-y-2",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Sort By Timestamp"}),a.jsxs($t,{value:c.sortOrder,onValueChange:v=>p("sortOrder",v),children:[a.jsx(It,{className:"h-8",children:a.jsx(Kt,{})}),a.jsxs(Tt,{children:[a.jsx(Oe,{value:"desc",children:"Newest First"}),a.jsx(Oe,{value:"asc",children:"Oldest First"})]})]})]}),a.jsxs("div",{className:"pagination-section space-y-2",children:[a.jsx(Se,{className:"text-sm font-medium",children:"Results Per Page"}),a.jsx(We,{type:"number",min:"1",max:"100",value:c.pageSize??50,onChange:v=>p("pageSize",v.target.value?parseInt(v.target.value):50),className:"h-8"})]})]}),a.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 border-t","data-test":"messages-panel-footer",children:[a.jsx(ue,{onClick:f,className:"flex-1",size:"sm","data-test":"messages-apply-search-button",children:"Apply Search"}),a.jsx(ue,{onClick:()=>i(!1),variant:"outline",size:"sm","data-test":"messages-cancel-button",children:"Cancel"})]})]})]})]})})});zd.displayName="MessagesSearch";function Ns({onClick:s,textToCopy:e,title:t="Copy formatted text",size:n="icon",variant:r="ghost"}){const[o,i]=h.useState(!1),c=async()=>{if(s){s();return}if(!e){Ee.error("No text to copy");return}try{await navigator.clipboard.writeText(e),i(!0),Ee.success("Copied to clipboard!"),setTimeout(()=>i(!1),2e3)}catch(l){Ee.error("Failed to copy to clipboard"),console.error("Copy failed:",l)}};return a.jsx(ue,{onClick:c,title:t,size:n,variant:r,children:o?a.jsx(ct,{}):a.jsx(Ra,{})})}function W0(s){return s.name==="Bash"}function z0(s){return s.name==="TodoWrite"}function Hd(s){return s.name==="ExitPlanMode"}function H0(s){return s.name==="Task"}function Gd(s){return s.name==="AskUserQuestion"}function qd(s){return typeof s=="object"&&s!==null&&"type"in s&&s.type==="tool_use"}const Vd=h.forwardRef(({className:s,...e},t)=>a.jsx(Qi,{className:B("grid gap-2",s),...e,ref:t}));Vd.displayName=Qi.displayName;const Kd=h.forwardRef(({className:s,...e},t)=>a.jsx(Zi,{ref:t,className:B("aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",s),...e,children:a.jsx(qu,{className:"flex items-center justify-center",children:a.jsx(Ys,{className:"h-3.5 w-3.5 fill-primary"})})}));Kd.displayName=Zi.displayName;const G0=s=>{var t,n,r;const e=ie.getState();ie.updateState({ui:{...e.ui,claude:{...(t=e.ui)==null?void 0:t.claude,message:{...(r=(n=e.ui)==null?void 0:n.claude)==null?void 0:r.message,prefill:s}}}})},oo=h.memo(({toolBlock:s})=>{const{questions:e}=s.input,[t,n]=h.useState({}),r=h.useCallback(c=>{const l=[];e.forEach((d,p)=>{const u=c[p];if(u!==void 0)if(d.multiSelect&&u instanceof Set){const f=Array.from(u).sort().map(m=>d.options[m].label);f.length>0&&l.push(`**${d.header}**: ${f.join(", ")}`)}else typeof u=="number"&&l.push(`**${d.header}**: ${d.options[u].label}`)}),G0(l.join(`
`))},[e]),o=h.useCallback((c,l,d)=>{const p=d.findIndex(u=>u.label===l);p!==-1&&n(u=>{const f={...u,[c]:p};return r(f),f})},[r]),i=h.useCallback((c,l,d)=>{n(p=>{const u=p[c]instanceof Set?p[c]:new Set,f=new Set(u);d?f.add(l):f.delete(l);const m={...p,[c]:f};return r(m),m})},[r]);return a.jsxs("div",{className:"ask-user-question-block bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-ask-user-question",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"ask-user-header",children:[a.jsx(bp,{className:"h-4 w-4 text-muted-foreground"}),a.jsxs("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:["Question",e.length>1?"s":""]})]}),a.jsx("div",{className:"questions-list space-y-4","data-test":"questions-list",children:e.map((c,l)=>a.jsxs("div",{className:"question-item","data-test":"question-item",children:[a.jsxs("div",{className:"question-header flex items-center gap-2 mb-1",children:[a.jsx("span",{className:"text-xs font-medium text-muted-foreground bg-muted-foreground/10 px-1.5 py-0.5 rounded","data-test":"question-tag",children:c.header}),c.multiSelect&&a.jsx("span",{className:"text-xs text-muted-foreground/70","data-test":"multi-select-indicator",children:"(select multiple)"})]}),a.jsx("p",{className:"question-text text-sm mb-2","data-test":"question-text",children:c.question}),c.multiSelect?a.jsx("div",{className:"options-list space-y-2","data-test":"options-list-checkbox",children:c.options.map((d,p)=>{const u=t[l]instanceof Set?t[l]:new Set;return a.jsxs("div",{className:"option-item flex items-start gap-2","data-test":"option-item",children:[a.jsx(Ct,{id:`q${l}-opt${p}`,className:"mt-0.5",checked:u.has(p),onCheckedChange:f=>i(l,p,!!f),"data-test":"option-checkbox"}),a.jsxs(Se,{htmlFor:`q${l}-opt${p}`,className:"text-sm cursor-pointer leading-tight",children:[a.jsx("span",{className:"font-medium","data-test":"option-label",children:d.label}),d.description&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1","data-test":"option-description",children:["â€” ",d.description]})]})]},p)})}):a.jsx(Vd,{className:"space-y-2",value:typeof t[l]=="number"?c.options[t[l]].label:void 0,onValueChange:d=>o(l,d,c.options),"data-test":"options-list-radio",children:c.options.map((d,p)=>a.jsxs("div",{className:"option-item flex items-start gap-2","data-test":"option-item",children:[a.jsx(Kd,{value:d.label,id:`q${l}-opt${p}`,className:"mt-0.5","data-test":"option-radio"}),a.jsxs(Se,{htmlFor:`q${l}-opt${p}`,className:"text-sm cursor-pointer leading-tight",children:[a.jsx("span",{className:"font-medium","data-test":"option-label",children:d.label}),d.description&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1","data-test":"option-description",children:["â€” ",d.description]})]})]},p))})]},l))})]})});oo.displayName="AskUserQuestionBlock";const Jd=h.memo(({toolBlock:s})=>{const{plan:e}=s.input;return e?a.jsxs("div",{className:"plan-block bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-plan",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"plan-header",children:[a.jsx(Js,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Plan"})]}),a.jsx("div",{className:"plan-content prose prose-sm dark:prose-invert max-w-none text-sm [&_h1]:text-lg [&_h1]:font-bold [&_h1]:mt-3 [&_h1]:mb-2 [&_h2]:text-base [&_h2]:font-semibold [&_h2]:mt-3 [&_h2]:mb-1 [&_h3]:text-sm [&_h3]:font-semibold [&_h3]:mt-2 [&_h3]:mb-1 [&_pre]:bg-background/50 [&_pre]:p-2 [&_pre]:rounded [&_pre]:text-xs [&_pre]:overflow-x-auto [&_code]:text-xs [&_code]:bg-background/50 [&_code]:px-1 [&_code]:rounded [&_.list-item-ul]:flex [&_.list-item-ul]:ml-2 [&_.list-item-ol]:flex [&_.list-item-ol]:ml-2","data-test":"plan-content",dangerouslySetInnerHTML:{__html:ot(e)}})]}):null});Jd.displayName="PlanBlock";const ya=h.memo(({messages:s,renderMessage:e})=>{const[t,n]=h.useState(!1),{askUserQuestionBlocks:r,planBlocks:o}=h.useMemo(()=>{const p=[],u=[];for(const f of s)if(Array.isArray(f.content))for(const m of f.content)qd(m)&&(Gd(m)?p.push(m):Hd(m)&&m.input.plan&&u.push(m));return{askUserQuestionBlocks:p,planBlocks:u}},[s]),i=s.map(p=>{if(!Array.isArray(p.content))return"Tool";for(const u of p.content){if(typeof u=="object"&&u.type==="tool_use"&&"name"in u)return u.name;if(typeof u=="object"&&u.type==="tool_result")return"Result"}return"Tool"}),c=h.useMemo(()=>{for(const p of s)if(Array.isArray(p.content)){for(const u of p.content)if(typeof u=="object"&&u.type==="tool_use"&&"name"in u&&u.name==="Bash"&&"input"in u&&typeof u.input=="object"&&u.input!==null&&"command"in u.input&&typeof u.input.command=="string"&&u.input.command.includes("git commit -m"))return!0}return!1},[s]),l=[...new Set(i)];let d=l.length<=3?l.join(", "):`${l.slice(0,2).join(", ")} +${l.length-2} more`;return c&&(d=`Committed, ${d}`),a.jsxs("div",{className:"tool-call-group w-full space-y-2","data-test":"tool-call-group","data-test-tool-count":s.length,children:[a.jsxs("button",{onClick:()=>n(!t),className:"tool-group-header flex items-center gap-2 w-full py-2 rounded-lg hover:bg-muted/50 transition-colors","data-test":"tool-group-toggle",children:[t?a.jsx(wt,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}):a.jsx(Ft,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),a.jsxs("span",{className:"text-xs uppercase text-muted-foreground","data-test":"tool-group-label",children:[s.length," Tool Call",s.length!==1?"s":""]}),!t&&a.jsx("span",{className:"text-xs text-muted-foreground/70 font-mono truncate","data-test":"tool-group-summary",children:d})]}),t&&a.jsx("div",{className:"tool-group-content space-y-2 mt-2 pl-4 border-l-2 border-muted-foreground/20","data-test":"tool-group-content",children:s.map(p=>e(p))}),o.length>0&&a.jsx(Jd,{toolBlock:o[o.length-1]},`plan-${o[o.length-1].id}`),r.length>0&&a.jsx(oo,{toolBlock:r[r.length-1]},`ask-user-${r[r.length-1].id}`)]})});ya.displayName="ToolCallGroup";const Yd=h.memo(({content:s})=>{const[e,t]=h.useState(!1);return a.jsxs("div",{className:"thinking-section","data-test":"thinking-block",children:[a.jsxs("button",{onClick:n=>{n.stopPropagation(),t(!e)},className:"thinking-toggle flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"thinking-toggle",children:[e?a.jsx(wt,{className:"h-3 w-3"}):a.jsx(Ft,{className:"h-3 w-3"}),a.jsx("span",{className:"font-semibold uppercase",children:"Thinking"}),!e&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1 truncate max-w-[200px]",children:[s.slice(0,50),"..."]})]}),e&&a.jsx("div",{className:"thinking-content mt-2 p-2 bg-muted-foreground/5 rounded border-l-2 border-muted-foreground/30 text-sm text-muted-foreground whitespace-pre-wrap break-words max-w-full","data-test":"thinking-content",children:s})]})});Yd.displayName="ThinkingBlockComponent";const Xd=s=>typeof s=="string"?a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-text",dangerouslySetInnerHTML:{__html:ot(s)}}):Array.isArray(s)?s.map((e,t)=>{if(typeof e=="string")return a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-block-string",dangerouslySetInnerHTML:{__html:ot(e)}},t);if(typeof e=="object"&&e.type==="text"&&"text"in e)return a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-block-text",dangerouslySetInnerHTML:{__html:ot(e.text)}},t);if(typeof e=="object"&&e.type==="thinking"){const n=("thinking"in e?e.thinking:null)||("text"in e?e.text:null);if(n)return a.jsx(Yd,{content:n},t)}if(qd(e)){const n=e;if(Hd(n)&&n.input.plan)return a.jsxs("div",{className:"tool-use-plan bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-plan",children:[a.jsx("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"plan-header",children:a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Plan"})}),a.jsx("div",{className:"plan-content prose prose-sm dark:prose-invert max-w-none text-sm [&_h1]:text-lg [&_h1]:font-bold [&_h1]:mt-3 [&_h1]:mb-2 [&_h2]:text-base [&_h2]:font-semibold [&_h2]:mt-3 [&_h2]:mb-1 [&_h3]:text-sm [&_h3]:font-semibold [&_h3]:mt-2 [&_h3]:mb-1 [&_pre]:bg-background/50 [&_pre]:p-2 [&_pre]:rounded [&_pre]:text-xs [&_pre]:overflow-x-auto [&_code]:text-xs [&_code]:bg-background/50 [&_code]:px-1 [&_code]:rounded [&_.list-item-ul]:flex [&_.list-item-ul]:ml-2 [&_.list-item-ol]:flex [&_.list-item-ol]:ml-2","data-test":"plan-content",dangerouslySetInnerHTML:{__html:ot(n.input.plan)}})]},t);if(z0(n)){const{todos:o}=n.input;return a.jsxs("div",{className:"tool-use-todos bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-todos",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"todos-header",children:[a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Todo List"}),a.jsxs("span",{className:"text-xs text-muted-foreground/70",children:["(",o.length," items)"]})]}),a.jsx("ul",{className:"todos-list space-y-1","data-test":"todos-list",children:o.map((i,c)=>a.jsxs("li",{className:"todo-item flex items-start gap-2 text-xs","data-test":"todo-item",children:[a.jsx("span",{className:`todo-status flex-shrink-0 ${i.status==="completed"?"text-green-500":i.status==="in_progress"?"text-yellow-500":"text-muted-foreground/50"}`,"data-test":"todo-status",children:i.status==="completed"?"âœ“":i.status==="in_progress"?"â–¶":"â—‹"}),a.jsx("span",{className:`todo-content ${i.status==="completed"?"line-through text-muted-foreground/70":""}`,"data-test":"todo-content",children:i.content})]},c))})]},t)}if(Gd(n))return a.jsx(oo,{toolBlock:n},t);let r;return(W0(n)||H0(n))&&(r=n.input.description),a.jsxs("div",{className:"tool-use bg-muted-foreground/10 p-2 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-tool-use",children:[a.jsxs("div",{className:"text-xs font-mono truncate","data-test":"tool-use-name",children:["Tool: ",n.name]}),r&&a.jsx("div",{className:"text-xs text-muted-foreground mt-1 truncate","data-test":"tool-use-description",children:r})]},t)}return a.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded mt-1 overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-block-json",children:JSON.stringify(e,null,2)},t)}):typeof s=="object"&&s!==null?s.text?a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-object-text",dangerouslySetInnerHTML:{__html:ot(s.text)}}):s.content?a.jsx("div",{"data-test":"message-content-recursive",children:Xd(s.content)}):a.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-object-json",children:JSON.stringify(s,null,2)}):a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-fallback",dangerouslySetInnerHTML:{__html:ot(String(s))}}),bi=s=>{const e=s.match(/<thinking>([\s\S]*?)<\/thinking>/);if(e){const t=e[1].trim(),n=s.replace(/<thinking>[\s\S]*?<\/thinking>/,"").trim();return{thinking:t||null,mainContent:n}}return{thinking:null,mainContent:s}},Hs=h.memo(({message:s,formatTime:e})=>{const[t,n]=h.useState(!1),[r,o]=h.useState(!1),[i,c]=h.useState(!1),l=h.useMemo(()=>Array.isArray(s.content)?s.content.some(v=>typeof v=="object"&&(v.type==="tool_result"||v.type==="tool_use")):!1,[s.content]),{thinkingContent:d,mainContent:p}=h.useMemo(()=>{if(s.role!=="assistant"||l)return{thinkingContent:null,mainContent:s.content};if(Array.isArray(s.content)){const v=[];let b=null;for(const w of s.content)if(typeof w=="object"&&w.type==="text"&&"text"in w){const y=bi(w.text);y.thinking&&(b=y.thinking),y.mainContent&&v.push({type:"text",text:y.mainContent})}else v.push(w);return{thinkingContent:b,mainContent:v.length>0?v:s.content}}if(typeof s.content=="string"){const v=bi(s.content);return{thinkingContent:v.thinking,mainContent:v.mainContent}}return{thinkingContent:null,mainContent:s.content}},[s.content,s.role,l]),u=l?"TOOL":s.role,f=v=>typeof v=="string"?v:Array.isArray(v)?v.map(b=>typeof b=="string"?b:typeof b=="object"&&b.type==="text"&&"text"in b?b.text:"").filter(Boolean).join(`
`):typeof v=="object"&&v!==null?v.text?v.text:v.content?f(v.content):JSON.stringify(v,null,2):String(v),m=async v=>{v.stopPropagation();const b=f(s.content);try{await navigator.clipboard.writeText(b),n(!0),setTimeout(()=>n(!1),2e3)}catch(w){console.error("Failed to copy message:",w)}},g=()=>{if(!Array.isArray(s.content))return"Tool";for(const v of s.content){if(typeof v=="object"&&v.type==="tool_result")return`Result${"is_error"in v&&v.is_error?" (error)":""}`;if(typeof v=="object"&&v.type==="tool_use"&&"name"in v)return v.name}return"Tool"},x=()=>{var v;if(!Array.isArray(s.content))return"";for(const b of s.content){if(typeof b=="object"&&b.type==="tool_result"&&"tool_use_id"in b){let w="";if("content"in b){const y=b.content;if(typeof y=="string")w=y.slice(0,50)+(y.length>50?"...":"");else if(Array.isArray(y)&&((v=y[0])!=null&&v.text)){const j=y[0].text;w=j.slice(0,50)+(j.length>50?"...":"")}}return w||"(empty)"}if(typeof b=="object"&&b.type==="tool_use"&&"name"in b){const w=b.name,y=[];if("input"in b&&typeof b.input=="object"&&b.input!==null){const j=b.input;if(j.description&&typeof j.description=="string"&&y.push(j.description),w==="Bash"&&j.command&&typeof j.command=="string"){const S=j.command.slice(0,40)+(j.command.length>40?"...":"");y.push(`$ ${S}`)}if(["Read","Write","Edit"].includes(w)&&j.file_path&&typeof j.file_path=="string"){const S=j.file_path.split("/").slice(-3).join("/");y.push(S)}["Grep","Glob"].includes(w)&&j.pattern&&typeof j.pattern=="string"&&y.push(`"${j.pattern}"`)}return y.join(" | ")||""}}return""};return a.jsxs("div",{className:`message-item flex flex-col w-full ${s.role==="user"?"items-end":"items-start"} ${s._isOptimistic?"opacity-60":""}`,"data-test":"message-item-wrapper","data-test-message-id":s.id,"data-test-optimistic":s._isOptimistic?"true":void 0,children:[a.jsxs("div",{className:`message-role-header flex items-center gap-1.5 mb-1 px-1 ${s.role==="user"?"flex-row-reverse":"flex-row"}`,"data-test":"message-role-header",children:[a.jsx("span",{className:"message-role text-xs font-semibold uppercase text-muted-foreground","data-test":"message-role-label",children:u}),a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"message-info-button p-0.5 hover:bg-muted rounded transition-colors",onClick:v=>v.stopPropagation(),"data-test":"message-info-button",children:a.jsx(Qs,{className:"h-3 w-3 text-muted-foreground/50"})})}),a.jsxs(Vt,{className:"flex items-center gap-2","data-test":"message-id-tooltip",children:[a.jsxs("span",{className:"text-xs font-mono",children:["ID: ",s.id]}),a.jsx(Ns,{textToCopy:s.id,title:"Copy message ID",size:"smIconCompact",variant:"ghost"})]})]})})]}),a.jsxs("div",{onClick:()=>{console.log("Message clicked:",s)},className:`message-bubble max-w-[85%] rounded-lg p-3 overflow-hidden cursor-pointer ${s.role==="user"?"bg-primary text-primary-foreground":l?"bg-muted/50 border border-muted-foreground/20":"bg-muted"}`,"data-test":"message-bubble",children:[l&&a.jsxs("div",{className:"message-tool-header mb-2 flex items-center gap-2","data-test":"message-tool-header",children:[a.jsx("button",{onClick:v=>{v.stopPropagation(),o(!r)},className:"expand-tool-button p-0.5 -ml-1 hover:bg-muted-foreground/10 rounded transition-colors flex-shrink-0","data-test":"expand-tool-button",children:r?a.jsx(wt,{className:"h-3 w-3 text-muted-foreground"}):a.jsx(Ft,{className:"h-3 w-3 text-muted-foreground"})}),a.jsx("span",{className:"text-xs text-muted-foreground font-semibold","data-test":"tool-name",children:g()})]}),l&&!r&&a.jsx("div",{className:"tool-summary-content text-xs text-muted-foreground font-mono truncate mb-2","data-test":"tool-summary",children:x()}),d&&a.jsxs("div",{className:"thinking-section mb-2","data-test":"thinking-section",children:[a.jsxs("button",{onClick:v=>{v.stopPropagation(),c(!i)},className:"thinking-toggle flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"thinking-toggle",children:[i?a.jsx(wt,{className:"h-3 w-3"}):a.jsx(Ft,{className:"h-3 w-3"}),a.jsx("span",{className:"font-semibold uppercase",children:"Thinking"}),!i&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1 truncate max-w-[200px]",children:[d.slice(0,50),"..."]})]}),i&&a.jsx("div",{className:"thinking-content mt-2 p-2 bg-muted-foreground/5 rounded border-l-2 border-muted-foreground/30 text-sm text-muted-foreground whitespace-pre-wrap break-words max-w-full","data-test":"thinking-content",children:d})]}),(!l||r)&&a.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words overflow-wrap-anywhere word-break max-w-full","data-test":"message-content",children:Xd(p)}),s.toolCalls&&s.toolCalls.length>0&&a.jsxs("div",{className:"message-tool-calls mt-2 space-y-1","data-test":"message-tool-calls",children:[a.jsx("div",{className:`text-xs font-semibold ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":"message-tool-calls-label",children:"Tool Calls:"}),s.toolCalls.map((v,b)=>a.jsx("div",{className:`tool-call-item p-2 rounded text-xs font-mono ${s.role==="user"?"bg-primary-foreground/10":"bg-muted-foreground/10"}`,"data-test":"tool-call-item",children:a.jsx("pre",{className:"whitespace-pre-wrap break-words max-w-full","data-test":"tool-call-json",children:JSON.stringify(v,null,2)})},b))]}),a.jsxs("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"message-footer",children:[a.jsx("div",{className:`message-time text-xs max-w-full ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"} ${s._isOptimistic?"italic":""}`,"data-test":"message-timestamp",children:s._isOptimistic?"Sending...":e(s.timestamp)}),a.jsx("button",{onClick:m,className:`copy-button p-1 rounded hover:bg-opacity-20 transition-colors ${s.role==="user"?"hover:bg-primary-foreground":"hover:bg-foreground"}`,title:"Copy message","data-test":"copy-message-button",children:t?a.jsx(ct,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground":"text-muted-foreground"}`,"data-test":"copy-success-icon"}):a.jsx(Ra,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"copy-icon"})})]})]})]},s.id)});Hs.displayName="MessageItem";const Qd=h.memo(({message:s})=>{const e=s.entryType==="user";return a.jsxs("div",{className:`inherited-message-item flex flex-col w-full ${e?"items-end":"items-start"}`,"data-test":"inherited-message-item","data-test-message-id":s.uuid,children:[a.jsxs("div",{className:`message-role-header flex items-center gap-1.5 mb-1 px-1 ${e?"flex-row-reverse":"flex-row"}`,"data-test":"inherited-message-role-header",children:[a.jsx("span",{className:"message-role text-xs font-semibold uppercase text-muted-foreground/70",children:s.entryType}),e?a.jsx(Sp,{className:"h-3 w-3 text-muted-foreground/50"}):a.jsx(qr,{className:"h-3 w-3 text-muted-foreground/50"})]}),a.jsxs("div",{className:`message-bubble max-w-[85%] rounded-lg p-3 border-dashed border ${e?"bg-primary/30 text-primary-foreground/80 border-primary/30":"bg-muted/30 border-muted-foreground/20"}`,"data-test":"inherited-message-bubble",children:[a.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words","data-test":"inherited-message-content",children:s.preview||"(empty)"}),a.jsx("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"inherited-message-footer",children:a.jsx("div",{className:`message-time text-xs ${e?"text-primary-foreground/50":"text-muted-foreground/50"}`,"data-test":"inherited-message-timestamp",children:new Date(s.timestamp).toLocaleTimeString()})})]})]})});Qd.displayName="InheritedMessageItem";function q0({messages:s,sessionDetails:e,metadata:t,loading:n,pagination:r,onLoadOlder:o,onSearch:i,onNameUpdated:c,onFork:l,scrollToMessageId:d,onBackClick:p,showBackButton:u,inheritedMessages:f}){var T,W,se,le,me,ae;const m=h.useRef(null),g=h.useRef(null),x=h.useRef(0),v=h.useRef(null),b=h.useRef(0),w=h.useRef(!1),[y,j]=h.useState(""),[S,C]=h.useState(!1),N=h.useRef(!1),[O,R]=h.useState(!1),[k,A]=h.useState(((se=(W=(T=ie.getState().app)==null?void 0:T.claude)==null?void 0:W.ui)==null?void 0:se.autoScrollThreshold)??300);h.useEffect(()=>{const H=(e==null?void 0:e.name)??null;v.current!==H&&(x.current=0,v.current=H,N.current=!1,R(!1))},[e==null?void 0:e.name]);const L=h.useCallback(H=>new Date(H).toLocaleTimeString(),[]),M=h.useCallback(H=>{const Q=new Date(H);return Q.toLocaleDateString()+" "+Q.toLocaleTimeString()},[]),[I,z]=h.useState(((ae=(me=(le=ie.getState().app)==null?void 0:le.claude)==null?void 0:me.ui)==null?void 0:ae.messageFilters)??["user","assistant","thinking","tools"]),$=h.useCallback(H=>{const{scrollTop:Q,scrollHeight:ge,clientHeight:ce}=H,ke=getComputedStyle(H).flexDirection==="column-reverse";let ve;return ke?ve=Q<=k:ve=ge-Q-ce<=k,console.log("[scroll-debug]",{isColumnReverse:ke,scrollTop:Q,scrollHeight:ge,clientHeight:ce,autoScrollThreshold:k,nearBottom:ve}),ve},[k]),q=h.useCallback(H=>{const Q=H.target;Q&&($(Q)?(N.current=!1,R(!1)):(N.current=!0,R(!0)))},[$]);h.useEffect(()=>{const H=m.current;if(!H)return;const Q=H.querySelector("[data-radix-scroll-area-viewport]");if(Q)return $(Q)?R(!1):R(!0),Q.addEventListener("scroll",q),()=>Q.removeEventListener("scroll",q)},[q,$]);const P=h.useCallback(H=>{var ge,ce,Ae;A(H);const Q=ie.getState();ie.setState({...Q,app:{...Q.app,claude:{...(ge=Q.app)==null?void 0:ge.claude,ui:{...(Ae=(ce=Q.app)==null?void 0:ce.claude)==null?void 0:Ae.ui,autoScrollThreshold:H}}}})},[]);h.useEffect(()=>{var ce,Ae,ke,ve,U,re;((ke=(Ae=(ce=ie.getState().app)==null?void 0:ce.claude)==null?void 0:Ae.ui)==null?void 0:ke.messageFilters)||ie.update("app",{claude:{...(ve=ie.getState().app)==null?void 0:ve.claude,ui:{...(re=(U=ie.getState().app)==null?void 0:U.claude)==null?void 0:re.ui,messageFilters:["user","assistant","thinking","tools"]}}});const Q=ie.selectSlice(G=>{var oe,de,pe;return(pe=(de=(oe=G.app)==null?void 0:oe.claude)==null?void 0:de.ui)==null?void 0:pe.messageFilters}).subscribe(G=>{G&&z(G)}),ge=ie.selectSlice(G=>{var oe,de,pe;return(pe=(de=(oe=G.app)==null?void 0:oe.claude)==null?void 0:de.ui)==null?void 0:pe.autoScrollThreshold}).subscribe(G=>{G!==void 0&&A(G)});return()=>{Q.unsubscribe(),ge.unsubscribe()}},[]);const te=H=>{var Ae,ke,ve,U,re,G;const Q=((ve=(ke=(Ae=ie.getState().app)==null?void 0:Ae.claude)==null?void 0:ke.ui)==null?void 0:ve.messageFilters)??I,ge=Q.includes(H)?Q.filter(oe=>oe!==H):[...Q,H],ce=ie.getState();ie.setState({...ce,app:{...ce.app,claude:{...(U=ce.app)==null?void 0:U.claude,ui:{...(G=(re=ce.app)==null?void 0:re.claude)==null?void 0:G.ui,messageFilters:ge}}}})},E=(H,Q)=>{i&&i(H,Q)},_=h.useMemo(()=>s.filter(Q=>!Q.content||Q.content===""?!1:Array.isArray(Q.content)&&Q.content.some(ce=>typeof ce=="object"&&(ce.type==="tool_use"||ce.type==="tool_result"))?I.includes("tools"):!!(Q.role==="user"&&I.includes("user")||Q.role==="assistant"&&I.includes("assistant"))),[s,I]),F=h.useCallback(H=>Array.isArray(H.content)?H.content.some(Q=>typeof Q=="object"&&(Q.type==="tool_use"||Q.type==="tool_result")):!1,[]),V=h.useMemo(()=>{const H=[];let Q=[];for(const ge of _)F(ge)?Q.push(ge):(Q.length>0&&(H.push({type:"tool-group",messages:Q}),Q=[]),H.push({type:"single",message:ge}));return Q.length>0&&H.push({type:"tool-group",messages:Q}),H},[_,F]);h.useLayoutEffect(()=>{const H=x.current===0&&_.length>0,Q=_.length>x.current&&x.current>0;if(m.current){const ge=m.current.querySelector("[data-radix-scroll-area-viewport]");if(H&&ge)ge.scrollTop=ge.scrollHeight,b.current=ge.scrollHeight,x.current=_.length,w.current=!1;else if(Q&&ge){const ce=ge.scrollHeight,Ae=ce-b.current;ge.scrollTop=ge.scrollTop+Ae,b.current=ce,x.current=_.length,w.current=!0}}},[_]),h.useEffect(()=>{if(x.current!==0){if(w.current){w.current=!1;return}if(!N.current&&m.current){const H=m.current.querySelector("[data-radix-scroll-area-viewport]");H&&setTimeout(()=>{H.scrollTo({top:H.scrollHeight,behavior:"smooth"})},50)}}},[_]),h.useEffect(()=>{if(S&&g.current){const H=g.current.querySelector("[data-radix-scroll-area-viewport]");H&&setTimeout(()=>{H.scrollTo({top:H.scrollHeight,behavior:"auto"})},100)}},[S]);const Y=h.useCallback((H=!0,Q=!1)=>{const ge=Q?g:m;if(ge.current){const ce=ge.current.querySelector("[data-radix-scroll-area-viewport]");ce&&(ce.scrollTo({top:ce.scrollHeight,behavior:H?"smooth":"auto"}),Q||(N.current=!1,R(!1)))}},[]);return h.useEffect(()=>{if(!d||!m.current)return;const H=m.current.querySelector(`[data-test-message-id="${d}"]`);H&&(H.scrollIntoView({behavior:"smooth",block:"center"}),H.classList.add("message-highlight"),setTimeout(()=>{H.classList.remove("message-highlight")},2e3))},[d]),a.jsxs(hn,{className:"chat-interface-card h-full flex flex-col overflow-hidden rounded-none border-0 md:rounded-lg md:border","data-test":"chat-interface-card",children:[a.jsxs(La,{className:"chat-header pb-2 pt-2 px-2 md:pt-4 md:px-6 flex-shrink-0","data-test":"chat-header",children:[a.jsxs("div",{className:"header-title-container flex items-center gap-2 text-sm","data-test":"header-title-container",children:[u&&p&&a.jsx(ue,{variant:"ghost",size:"icon",onClick:p,className:"md:hidden h-8 w-8 flex-shrink-0","data-test":"back-to-sessions-button",children:a.jsx(Ds,{className:"h-5 w-5"})}),a.jsx(ao,{sessionIds:e!=null&&e.id?[e.id]:[]}),a.jsx(Ma,{className:"text-base truncate","data-test":"chat-title",children:e?a.jsx(Wd,{session:e,segmentsToStrip:3,onNameUpdated:c}):"New Conversation"}),t&&a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"info-button p-1 hover:bg-muted rounded-sm transition-colors","data-test":"session-info-button",children:a.jsx(Qs,{className:"h-4 w-4 text-muted-foreground"})})}),a.jsx(Vt,{className:"metadata-tooltip","data-test":"session-metadata-tooltip",children:a.jsxs("div",{className:"metadata-section text-xs space-y-1","data-test":"metadata-section",children:[a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-created",children:[a.jsx("span",{className:"font-medium",children:"Created:"})," ",M(t.created)]}),a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-modified",children:[a.jsx("span",{className:"font-medium",children:"Last Modified:"})," ",M(t.lastModified)]}),a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-message-count",children:[a.jsx("span",{className:"font-medium",children:"Messages:"})," ",t.messageCount]}),t.model&&a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-model",children:[a.jsx("span",{className:"font-medium",children:"Model:"})," ",t.model]}),(e==null?void 0:e.id)&&a.jsxs("div",{className:"metadata-item flex items-center gap-1","data-test":"metadata-item-session-id",children:[a.jsx("span",{className:"font-medium",children:"ID:"}),a.jsxs("span",{className:"font-mono",children:[e.id.slice(0,6),"...",e.id.slice(-6)]}),a.jsx(Ns,{textToCopy:e.id,title:"Copy session ID",size:"smIconCompact",variant:"ghost"})]})]})})]})}),l&&a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"fork-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:H=>l({x:H.clientX,y:H.clientY}),"data-test":"fork-session-button",children:a.jsx(ts,{className:"h-4 w-4 text-muted-foreground"})})}),a.jsx(Vt,{children:a.jsx("p",{children:"Fork this session"})})]})}),a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsx("button",{className:"expand-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:()=>C(!0),"data-test":"expand-chat-button",children:a.jsx(wp,{className:"h-4 w-4 text-muted-foreground"})})}),a.jsx(Vt,{children:a.jsx("p",{children:"Expand chat view"})})]})}),a.jsx(dn,{storageKey:"chat-interface-config",title:"Chat Configuration",contentClassName:"chat-config-panel w-64",children:a.jsxs("div",{className:"config-content space-y-4","data-test":"chat-config-content",children:[a.jsxs("div",{className:"project-selector-section space-y-2","data-test":"project-selector-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Project"}),a.jsx(Rc,{variant:"select",className:"w-full"})]}),a.jsxs("div",{className:"filters-section space-y-2","data-test":"message-filters-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Show messages"}),a.jsxs("div",{className:"filter-options space-y-2","data-test":"filter-options",children:[a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-user",children:[a.jsx(Ct,{id:"filter-user",checked:I.includes("user"),onCheckedChange:()=>te("user"),"data-test":"filter-checkbox-user"}),a.jsx(Se,{htmlFor:"filter-user",className:"text-sm cursor-pointer",children:"User"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-assistant",children:[a.jsx(Ct,{id:"filter-assistant",checked:I.includes("assistant"),onCheckedChange:()=>te("assistant"),"data-test":"filter-checkbox-assistant"}),a.jsx(Se,{htmlFor:"filter-assistant",className:"text-sm cursor-pointer",children:"Assistant"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-thinking",children:[a.jsx(Ct,{id:"filter-thinking",checked:I.includes("thinking"),onCheckedChange:()=>te("thinking"),"data-test":"filter-checkbox-thinking"}),a.jsx(Se,{htmlFor:"filter-thinking",className:"text-sm cursor-pointer",children:"Thinking"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-tools",children:[a.jsx(Ct,{id:"filter-tools",checked:I.includes("tools"),onCheckedChange:()=>te("tools"),"data-test":"filter-checkbox-tools"}),a.jsx(Se,{htmlFor:"filter-tools",className:"text-sm cursor-pointer",children:"Tools"})]})]})]}),a.jsxs("div",{className:"auto-scroll-section space-y-2","data-test":"auto-scroll-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Auto-scroll threshold"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Auto-scroll only when within this distance from bottom (px)"}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(Dt,{value:[k],onValueChange:([H])=>P(H),min:0,max:500,step:10,className:"flex-1","data-test":"auto-scroll-threshold-slider"}),a.jsx("span",{className:"text-sm font-mono w-12 text-right","data-test":"auto-scroll-threshold-value",children:k})]})]})]})})]}),i&&a.jsx(zd,{searchQuery:y,onSearchChange:j,onAdvancedSearch:E,className:"mt-3"})]}),a.jsxs(fn,{className:"chat-content flex-1 min-h-0 overflow-hidden p-0 relative","data-test":"chat-content",children:[a.jsx(nn,{ref:m,className:"chat-scroll-area h-full w-full",viewportClassName:"!block","data-test":"chat-scroll-area",children:a.jsxs("div",{className:"messages-container space-y-4 px-2 md:px-4 pt-2 w-full max-w-full overflow-x-hidden","data-test":"messages-container",children:[o&&r&&a.jsx("div",{className:"load-older-container flex justify-center pb-4 pt-2","data-test":"load-older-container",children:a.jsxs(ue,{variant:"outline",size:"sm",onClick:o,disabled:n,className:"load-older-button","data-test":"load-older-button",children:[a.jsx(wt,{className:"h-4 w-4 mr-2 rotate-180"}),"Load Older Messages",r&&a.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(",s.length," of ",r.totalCount,")"]})]})}),f&&f.length>0&&a.jsxs("div",{className:"inherited-messages-section","data-test":"inherited-messages-section",children:[a.jsxs("div",{className:"inherited-messages-header flex items-center gap-2 mb-3 pb-2 border-b border-dashed border-muted-foreground/30",children:[a.jsx(ts,{className:"h-4 w-4 text-muted-foreground"}),a.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["Inherited from parent session (",f.length," messages)"]})]}),a.jsx("div",{className:"inherited-messages-list space-y-4 opacity-70",children:f.map(H=>a.jsx(Qd,{message:H},H.uuid))}),a.jsxs("div",{className:"fork-point-divider flex items-center gap-2 my-4 py-2",children:[a.jsx("div",{className:"flex-1 border-t border-dashed border-primary/40"}),a.jsxs("span",{className:"text-xs font-medium text-primary/70 flex items-center gap-1",children:[a.jsx(ts,{className:"h-3 w-3"}),"Fork point"]}),a.jsx("div",{className:"flex-1 border-t border-dashed border-primary/40"})]})]}),n&&_.length===0?a.jsx("div",{className:"loading-message text-sm text-muted-foreground","data-test":"loading-message",children:"Loading messages..."}):_.length===0&&(!f||f.length===0)?a.jsxs("div",{className:"empty-state text-center mt-8","data-test":"empty-state",children:[a.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"New Session"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Type your first message below to start the conversation"})]}):V.map((H,Q)=>H.type==="tool-group"?a.jsx(ya,{messages:H.messages,renderMessage:ge=>a.jsx(Hs,{message:ge,formatTime:L},ge.id)},`tool-group-${H.messages[0].id}`):a.jsx(Hs,{message:H.message,formatTime:L},H.message.id))]})}),O&&a.jsx(ue,{variant:"outline",size:"icon",onClick:()=>Y(!0),className:"absolute bottom-4 right-4 h-8 w-8 rounded-full shadow-md bg-background/90 backdrop-blur-sm hover:bg-background z-10","data-test":"chat-scroll-to-bottom",title:"Scroll to latest message",children:a.jsx(wt,{className:"h-4 w-4"})})]}),a.jsx(os,{isVisible:S,onClose:()=>C(!1),title:e?typeof e.customName=="string"?e.customName:e.name:"Chat Messages",shouldCloseManually:!0,resizable:!0,initialSize:{width:1e3,height:700},initialPosition:{x:100,y:50},children:a.jsxs("div",{className:"expanded-chat-content flex flex-col flex-1 overflow-hidden","data-test":"expanded-chat-view",children:[a.jsxs("div",{className:"expanded-controls-header flex items-center justify-between gap-4 px-4 py-2 border-b border-border flex-shrink-0","data-test":"expanded-controls-header",children:[a.jsxs("div",{className:"filter-controls flex items-center gap-3","data-test":"expanded-filter-controls",children:[a.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Show:"}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(Ct,{id:"expanded-filter-user",checked:I.includes("user"),onCheckedChange:()=>te("user"),"data-test":"expanded-filter-checkbox-user"}),a.jsx(Se,{htmlFor:"expanded-filter-user",className:"text-xs cursor-pointer",children:"User"})]}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(Ct,{id:"expanded-filter-assistant",checked:I.includes("assistant"),onCheckedChange:()=>te("assistant"),"data-test":"expanded-filter-checkbox-assistant"}),a.jsx(Se,{htmlFor:"expanded-filter-assistant",className:"text-xs cursor-pointer",children:"Assistant"})]}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(Ct,{id:"expanded-filter-tools",checked:I.includes("tools"),onCheckedChange:()=>te("tools"),"data-test":"expanded-filter-checkbox-tools"}),a.jsx(Se,{htmlFor:"expanded-filter-tools",className:"text-xs cursor-pointer",children:"Tools"})]})]}),a.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>Y(!0,!0),className:"scroll-to-bottom-button flex items-center gap-1.5 h-7 text-xs","data-test":"scroll-to-bottom-button",title:"Scroll to latest message",children:[a.jsx(yp,{className:"h-3 w-3"}),"Latest"]})]}),a.jsx("div",{className:"flex-1 min-h-0 p-4 pt-2",children:a.jsx(nn,{className:"h-full",ref:g,children:a.jsx("div",{className:"messages-container-expanded space-y-4 pr-4",children:_.length===0?a.jsxs("div",{className:"empty-state text-center mt-8","data-test":"expanded-empty-state",children:[a.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"No Messages"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"This session has no messages yet"})]}):V.map(H=>H.type==="tool-group"?a.jsx(ya,{messages:H.messages,renderMessage:Q=>a.jsx(Hs,{message:Q,formatTime:L},Q.id)},`expanded-tool-group-${H.messages[0].id}`):a.jsx(Hs,{message:H.message,formatTime:L},H.message.id))})})})]})})]})}function Sa({sessionId:s,message:e,onBeforeSend:t,onSendSuccess:n,onSendError:r,outputFormat:o="text",permissionMode:i="acceptEdits",variant:c="ghost",size:l="icon",className:d="",title:p="Send to Claude session",disabled:u,...f}){const[m,g]=h.useState(!1);h.useEffect(()=>{g(!1)},[s]);const x=h.useCallback(async()=>{if(e.trim()){t==null||t();try{g(!0),await Ye.sendMessage({message:e.trim(),sessionId:s,options:{outputFormat:o,permissionMode:i}}),console.log(`Sent message to Claude session ${s}: ${e}`),n==null||n()}catch(v){console.error("Failed to send message to Claude:",v),r==null||r(v)}finally{g(!1)}}},[e,s,o,i,m,t,n,r]);return a.jsx(ue,{variant:c,size:l,onClick:x,className:d,title:p,disabled:u||!e.trim(),"data-test":"claude-send-button","data-test-sending":m?"true":"false",...f,children:m?a.jsx(ir,{className:"h-3 w-3 animate-spin loading-indicator","data-test":"send-button-loading"}):a.jsx(Ln,{className:"h-3 w-3","data-test":"send-button-icon"})})}const _r=["acceptEdits","plan","bypassPermissions"],V0={acceptEdits:"Accept Edits",plan:"Plan",bypassPermissions:"Bypass"};function K0({sessionId:s,initialMessage:e="",rows:t=3,value:n,onChange:r,onSendSuccess:o,onSendError:i,onAddOptimisticMessage:c,onRemoveOptimisticMessage:l,userMessages:d}){const[p,u]=h.useState(e),f=h.useRef(null),m=h.useRef(null),[g,x]=h.useState(-1),v=h.useRef(""),b=bs(),[w,y]=h.useState(1),j=Le(E=>{var _,F,V,Y;return(Y=(V=(F=(_=E.ui)==null?void 0:_.claude)==null?void 0:F.message)==null?void 0:V.options)==null?void 0:Y.permissionMode}),S=j==="default"||!j?"acceptEdits":j,C=Le(E=>{var _,F,V;return(V=(F=(_=E.ui)==null?void 0:_.claude)==null?void 0:F.message)==null?void 0:V.prefill});h.useEffect(()=>{var E,_,F;if(C){u(C);const V=ie.getState();ie.updateState({ui:{...V.ui,claude:{...(E=V.ui)==null?void 0:E.claude,message:{...(F=(_=V.ui)==null?void 0:_.claude)==null?void 0:F.message,prefill:void 0}}}})}},[C]);const N=h.useCallback(()=>{var Y,T,W,se,le,me;const _=(_r.indexOf(S)+1)%_r.length,F=_r[_],V=ie.getState();ie.updateState({ui:{...V.ui,claude:{...(Y=V.ui)==null?void 0:Y.claude,message:{...(W=(T=V.ui)==null?void 0:T.claude)==null?void 0:W.message,options:{...(me=(le=(se=V.ui)==null?void 0:se.claude)==null?void 0:le.message)==null?void 0:me.options,permissionMode:F}}}}})},[S]),O=n??p,R=r??u,k=h.useMemo(()=>{if(!d)return[];const E=["This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation"];return d.map(_=>typeof _.content=="string"?_.content:"").filter(_=>_&&!E.some(F=>_.startsWith(F))).reverse()},[d]);h.useEffect(()=>{var F,V,Y;const E=(Y=(V=(F=ie.getState().app)==null?void 0:F.claude)==null?void 0:V.ui)==null?void 0:Y.messageDrafts,_=E==null?void 0:E[s];u(_||"")},[s]),h.useEffect(()=>{var E,_,F,V,Y,T;if(!n){const se={...((F=(_=(E=ie.getState().app)==null?void 0:E.claude)==null?void 0:_.ui)==null?void 0:F.messageDrafts)||{}};p.trim()?se[s]=p:delete se[s],ie.updateState({app:{...ie.getState().app,claude:{...(V=ie.getState().app)==null?void 0:V.claude,ui:{...(T=(Y=ie.getState().app)==null?void 0:Y.claude)==null?void 0:T.ui,messageDrafts:se}}}})}},[p,s,n]);const A=h.useRef(1),[L,M]=h.useState(void 0);h.useEffect(()=>{var Ae;if(!b){y(t),M(void 0);return}const E=(Ae=f.current)==null?void 0:Ae.getTextArea();if(!E)return;const _=1,F=4,V=getComputedStyle(E),Y=parseFloat(V.lineHeight)||24,T=parseFloat(V.paddingTop)||0,W=parseFloat(V.paddingBottom)||0,se=parseFloat(V.borderTopWidth)||0,le=parseFloat(V.borderBottomWidth)||0;if(!O.trim()){const ke=Y*_+T+W;A.current=_,y(_),M(`${ke}px`),E.style.overflowY="hidden";return}const me=E.style.height;E.style.height="auto";const H=E.scrollHeight-T-W-se-le,Q=Math.max(1,Math.round(H/Y));E.style.height=me;const ge=Math.min(F,Math.max(_,Q)),ce=Y*ge+T+W;A.current=ge,y(ge),M(`${ce}px`),E.style.overflowY=Q>F?"auto":"hidden"},[O,b,t]);const I=()=>{var T,W,se,le,me,ae,H,Q,ge,ce,Ae,ke,ve,U;const E=O.trim(),_=E.match(/(qqq|queue)$/i);if(_){const re=E.slice(0,-_[0].length).trim();if(re){q(re),R("");const G=(T=f.current)==null?void 0:T.getTextArea();G&&(G.value="",G.dispatchEvent(new Event("input",{bubbles:!0})));const de={...((le=(se=(W=ie.getState().app)==null?void 0:W.claude)==null?void 0:se.ui)==null?void 0:le.messageDrafts)??{}};delete de[s],ie.updateState({app:{...ie.getState().app,claude:{...(me=ie.getState().app)==null?void 0:me.claude,ui:{...(H=(ae=ie.getState().app)==null?void 0:ae.claude)==null?void 0:H.ui,messageDrafts:de}}}})}return}if(c&&O.trim()){const re=c(O.trim());m.current=re}x(-1),v.current="",R("");const F=(Q=f.current)==null?void 0:Q.getTextArea();F&&(F.value="",F.dispatchEvent(new Event("input",{bubbles:!0})));const Y={...((Ae=(ce=(ge=ie.getState().app)==null?void 0:ge.claude)==null?void 0:ce.ui)==null?void 0:Ae.messageDrafts)||{}};delete Y[s],ie.updateState({app:{...ie.getState().app,claude:{...(ke=ie.getState().app)==null?void 0:ke.claude,ui:{...(U=(ve=ie.getState().app)==null?void 0:ve.claude)==null?void 0:U.ui,messageDrafts:Y}}}})},z=()=>{m.current=null,o==null||o()},$=E=>{l&&m.current&&(l(m.current),m.current=null),i==null||i(E)},q=E=>{var W,se,le,me,ae,H;const _=ie.getState(),F=((le=(se=(W=_.app)==null?void 0:W.claude)==null?void 0:se.ui)==null?void 0:le.messageQueues)??{},V=F[s]??[],Y={id:crypto.randomUUID(),content:E,createdAt:Date.now()},T={...F,[s]:[...V,Y]};ie.updateState({app:{..._.app,claude:{...(me=_.app)==null?void 0:me.claude,ui:{...(H=(ae=_.app)==null?void 0:ae.claude)==null?void 0:H.ui,messageQueues:T}}}})},P=E=>{R(E),setTimeout(()=>{var _;(_=document.querySelector(".claude-send-button"))==null||_.click()},0)},te=E=>{var _;if(E.key==="Enter"&&!E.shiftKey){E.preventDefault(),(_=document.querySelector(".claude-send-button"))==null||_.click();return}if(E.key==="ArrowUp"&&k.length>0&&(E.currentTarget.selectionStart===0||!O)){E.preventDefault(),g===-1&&(v.current=O);const V=Math.min(g+1,k.length-1);V!==g&&(x(V),R(k[V]))}if(E.key==="ArrowDown"&&g>=0){const F=E.currentTarget;if(F.selectionStart===F.value.length||!O){E.preventDefault();const Y=g-1;Y<0?(x(-1),R(v.current)):(x(Y),R(k[Y]))}}};return a.jsxs("div",{className:"message-input-container","data-test":"message-input-container",children:[a.jsxs("div",{className:B("message-input-area flex gap-2",b?"items-end":"items-start"),"data-test":"message-input-area",children:[b&&a.jsx(ba,{variant:"ghost",size:"icon",buttonLabel:"",sessionId:s,onSendQueuedMessage:P,className:"!size-12"}),a.jsx(as,{ref:f,value:O,onChange:E=>R(E.target.value),onKeyDown:te,placeholder:b?"Type your message...":"Type your message... (Shift+Enter for new line, @ to insert file path)",className:B("message-textarea flex-1",b?"resize-none":"resize-y"),style:L?{height:L,transition:"height 150ms ease-out"}:void 0,showBuiltInPopover:!1,rows:b?1:w,"data-test":"message-textarea"}),b?a.jsx(Sa,{sessionId:s,message:O,outputFormat:"text",permissionMode:S,className:"claude-send-button send-button !size-12",size:"icon",onBeforeSend:I,onSendSuccess:z,onSendError:$}):a.jsx("div",{className:"send-controls flex flex-col gap-2","data-test":"send-controls",children:a.jsx(ba,{variant:"ghost",size:"icon",buttonLabel:"",sessionId:s,onSendQueuedMessage:P,children:E=>a.jsx(Sa,{sessionId:s,message:O,outputFormat:E.outputFormat,permissionMode:E.permissionMode,className:"claude-send-button send-button",size:"icon",onBeforeSend:I,onSendSuccess:z,onSendError:$})})})]}),a.jsx("div",{className:"message-input-footer flex items-center justify-start mt-1 px-1","data-test":"message-input-footer",children:a.jsx("button",{type:"button",onClick:N,className:"permission-mode-toggle text-xs text-muted-foreground hover:text-foreground transition-colors cursor-pointer","data-test":"permission-mode-toggle",title:"Click to cycle permission mode",children:V0[S]})})]})}function J0({forkCount:s,forkedFromName:e,forkedFromId:t,onClick:n,size:r="default"}){if(!s&&!e)return null;const o=!!e,i=s&&s>0,c=r==="sm"?10:12,l=r==="sm"?"text-[10px] px-1.5 py-0":"",d=p=>{o&&t&&n&&(p.stopPropagation(),n(t))};return o?a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsxs(pt,{"data-test":"fork-indicator-forked-from",variant:"secondary",className:`fork-indicator-badge gap-1 cursor-pointer hover:bg-secondary/80 ${l}`,onClick:d,children:[a.jsx(ts,{size:c,"data-test":"fork-indicator-icon"}),a.jsx("span",{"data-test":"fork-indicator-label",children:"Forked"})]})}),a.jsxs(Vt,{"data-test":"fork-indicator-tooltip",children:[a.jsxs("p",{children:["Forked from: ",e]}),n&&a.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to view parent"})]})]})}):i?a.jsx(ss,{children:a.jsxs(ns,{children:[a.jsx(rs,{asChild:!0,children:a.jsxs(pt,{"data-test":"fork-indicator-count",variant:"outline",className:`fork-indicator-badge gap-1 ${l}`,children:[a.jsx(ts,{size:c,"data-test":"fork-indicator-icon"}),a.jsx("span",{"data-test":"fork-indicator-count-value",children:s})]})}),a.jsx(Vt,{"data-test":"fork-indicator-tooltip",children:a.jsxs("p",{children:[s," fork",s>1?"s":""," created from this session"]})})]})}):null}function Y0(s){const e=new Date,t=new Date(s),n=e.getTime()-t.getTime(),r=Math.floor(n/(1e3*60)),o=Math.floor(n/(1e3*60*60)),i=Math.floor(n/(1e3*60*60*24)),c=Math.floor(i/7),l=Math.floor(i/365);return r<1?"just now":r<60?`${r} min ago`:o<24?`${o} ${o===1?"hour":"hours"} ago`:i<7?`${i} ${i===1?"day":"days"} ago`:c<52?`${c} ${c===1?"week":"weeks"} ago`:`${l} ${l===1?"year":"years"} ago`}function Zd({session:s,isSelected:e,isFocused:t=!1,onClick:n,formatDate:r,formatCwd:o,segmentsToStrip:i=3,onNameUpdated:c,compact:l=!1,forkCount:d,forkedFromName:p,forkedFromId:u,onFork:f,onNavigateToParent:m,hasDraft:g=!1}){const x=v=>{v.stopPropagation(),f==null||f(s)};return a.jsxs("div",{"data-test":"session-list-item",onClick:()=>{n()},className:`session-item group relative ${l?"p-1.5":"p-3"} rounded-lg border cursor-pointer transition-colors ${e?"bg-primary/10 border-primary":t?"bg-accent/50 border-accent-foreground/30 ring-2 ring-accent-foreground/20":"hover:bg-accent"}`,children:[a.jsx("div",{"data-test":"session-cwd",className:"session-cwd text-xs text-muted-foreground truncate",children:o(s.cwd)}),a.jsxs("div",{"data-test":"session-name-container",className:`session-name-container ${l?"font-medium text-sm":"font-bold text-base"} break-words line-clamp-2 ${l?"":"mt-1"} flex items-center gap-2`,children:[a.jsx(ao,{sessionIds:[s.id]}),a.jsx(Wd,{session:s,segmentsToStrip:i,onNameUpdated:c}),g&&a.jsx("span",{"data-test":"session-draft-indicator",title:"Has draft message",className:"text-amber-500 flex-shrink-0",children:a.jsx(jp,{size:14})})]}),(s.latestMessage||s.firstMessage)&&!l&&a.jsx("div",{"data-test":"session-latest-message",className:"session-latest-message text-sm text-muted-foreground truncate mt-1",children:s.latestMessage||s.firstMessage}),a.jsxs("div",{"data-test":"session-meta",className:`session-meta text-xs text-muted-foreground flex items-center gap-2 flex-wrap ${l?"mt-0.5":"mt-1"}`,children:[a.jsxs("span",{children:[s.messageCount," messages"]}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:Y0(s.lastModified)}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:r(s.lastModified)}),(d||p)&&a.jsxs(a.Fragment,{children:[a.jsx("span",{children:"â€¢"}),a.jsx(J0,{forkCount:d,forkedFromName:p,forkedFromId:u,onClick:m,size:"sm"})]})]}),f&&!l&&a.jsx("div",{"data-test":"session-fork-action",className:"session-fork-action absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity",children:a.jsx(ue,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:x,title:"Fork this session","data-test":"session-fork-btn",children:a.jsx(ts,{size:14})})})]})}const X0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},Q0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1};function eu({value:s,onChange:e,className:t="",placeholder:n="Select a session",label:r="Claude Session",showLabel:o=!0,multiSelect:i=!1}){const[c,l]=h.useState(!1),d=Le(X0),p=Le(Q0),u=Array.isArray(s)?s:s?[s]:[],f=h.useMemo(()=>[...d].sort((b,w)=>{const y=new Date(b.lastModified).getTime();return new Date(w.lastModified).getTime()-y}),[d]),m=f.filter(b=>u.includes(b.id)),g=b=>new Date(b).toLocaleDateString(),x=b=>b?b.split("/").slice(-2).join("/"):"No directory",v=b=>{if(i){const w=u.includes(b)?u.filter(y=>y!==b):[...u,b];e(w)}else e(b===s?"":b),l(!1)};return a.jsxs("div",{"data-test":"session-selector",className:`session-selector-container ${t}`,children:[o&&a.jsx(Se,{"data-test":"session-selector-label",className:"session-selector-label",children:r}),a.jsxs(nt,{open:c,onOpenChange:l,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(ue,{"data-test":"session-selector-trigger",variant:"outline",role:"combobox","aria-expanded":c,className:"session-selector-trigger w-full justify-between",disabled:p,children:[m.length>0?a.jsx("span",{className:"truncate",children:i?`${m.length} session${m.length>1?"s":""} selected`:m[0].customName||m[0].name}):a.jsx("span",{className:"text-muted-foreground",children:n}),a.jsx(ac,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),a.jsx(Qe,{"data-test":"session-selector-content",className:"session-selector-content w-[400px] p-0",style:{zIndex:st.draggablePopoverDropdown},children:a.jsxs(cr,{children:[a.jsx(lr,{"data-test":"session-selector-search",placeholder:"Search sessions..."}),a.jsxs(un,{className:"max-h-[300px]",children:[a.jsx(pn,{children:"No sessions found."}),a.jsxs(Ts,{children:[!i&&a.jsxs(is,{"data-test":"session-selector-item-none",value:"none",onSelect:()=>{e(""),l(!1)},className:"session-selector-item-none",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4",u.length===0?"opacity-100":"opacity-0")}),"No Session"]}),f.map(b=>a.jsx(is,{"data-test":"session-selector-item",value:b.id,onSelect:()=>v(b.id),className:"session-selector-item p-0 cursor-pointer",children:a.jsxs("div",{className:"flex items-center w-full",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4 shrink-0",u.includes(b.id)?"opacity-100":"opacity-0")}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx(Zd,{session:b,isSelected:u.includes(b.id),onClick:()=>{},formatDate:g,formatCwd:x,compact:!0})})]})},b.id))]}),f.length===0&&!p&&a.jsx("div",{"data-test":"session-selector-no-sessions",className:"no-sessions text-center py-4 text-sm text-muted-foreground",children:"No sessions available"}),p&&a.jsx("div",{"data-test":"session-selector-loading",className:"loading-sessions text-center py-4 text-sm text-muted-foreground",children:"Loading sessions..."})]})]})})]})]})}const Z0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]};function ej({sessionIds:s,currentIndex:e,onIndexChange:t,disabled:n=!1,className:r=""}){const[o,i]=h.useState(!1),[c,l]=h.useState(""),d=Le(Z0),p=h.useMemo(()=>s.map(w=>d.find(y=>y.id===w)).filter(w=>w!==void 0),[s,d]),u=p[e],f=p.filter(w=>(w.customName??w.name).toLowerCase().includes(c.toLowerCase())),m=w=>{t(w),i(!1),l("")},g=w=>{if(w.stopPropagation(),n||p.length===0)return;const y=e-1,j=y<0?p.length-1:y;t(j)},x=w=>{if(w.stopPropagation(),n||p.length===0)return;const y=e+1,j=y>=p.length?0:y;t(j)},v=w=>new Date(w).toLocaleDateString(),b=w=>w?w.split("/").slice(-2).join("/"):"No directory";return p.length===0?null:p.length===1?a.jsx(pt,{variant:"outline",className:B("navigable-session-badge bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed",r),"data-test":"navigable-session-badge-single",children:(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"}):a.jsxs("div",{className:B("navigable-session-selector flex items-center gap-1",r),"data-test":"navigable-session-selector",children:[a.jsx("button",{onClick:g,disabled:n,className:B("chevron-left p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous session","data-test":"navigable-session-previous-button",children:a.jsx(Ds,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),a.jsxs(nt,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsxs(pt,{variant:"outline",className:B("navigable-badge cursor-pointer hover:opacity-80 transition-opacity bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed"),onClick:w=>{w.stopPropagation(),n&&w.preventDefault()},"data-test":"navigable-session-badge",children:[(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"," (",e+1,"/",p.length,")"]})}),a.jsx(Qe,{className:"popover-content w-[400px] p-2",align:"start","data-test":"navigable-session-popover-content",children:a.jsxs("div",{className:"selector-container space-y-2","data-test":"navigable-session-selector-container",children:[a.jsx(We,{placeholder:"Search sessions...",value:c,onChange:w=>l(w.target.value),className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"navigable-session-search-input"}),a.jsx("div",{className:"sessions-list max-h-64 overflow-y-auto space-y-1","data-test":"navigable-session-list",children:f.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"navigable-session-empty-state",children:"No sessions found"}):f.map(w=>{const y=p.indexOf(w);return a.jsxs(ue,{variant:"ghost",className:B("session-item w-full justify-between h-auto px-2 py-1",y===e&&"bg-accent"),onClick:()=>m(y),"data-test":"navigable-session-item",children:[a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx(Zd,{session:w,isSelected:y===e,onClick:()=>{},formatDate:v,formatCwd:b,compact:!0})}),y===e&&a.jsx(ct,{className:"check-icon h-4 w-4 ml-2 shrink-0","data-test":"navigable-session-check-icon"})]},w.id)})})]})})]}),a.jsx("button",{onClick:x,disabled:n,className:B("chevron-right p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Next session","data-test":"navigable-session-next-button",children:a.jsx(Ft,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]})}function tj(s,e={}){const{loadOnMount:t=!0,subscribeToSSE:n=!0,pageSize:r=50,messageType:o,onSessionDeleted:i}=e,[c,l]=h.useState([]),[d,p]=h.useState(null),[u,f]=h.useState(null),[m,g]=h.useState(!1),[x,v]=h.useState(null),[b,w]=h.useState(1),[y,j]=h.useState(""),[S,C]=h.useState(null),[N,O]=h.useState(!1),R=h.useRef(),k=h.useRef(s),A=h.useRef(new Map);h.useEffect(()=>{k.current=s},[s]);const L=h.useCallback(async(P=1,te=!1,E=!1)=>{var F,V,Y;if(!s)return;const _=s;try{E||g(!0),j(""),C(null),O(!1);const T=o??((Y=(V=(F=ie.getState().app)==null?void 0:F.claude)==null?void 0:V.ui)==null?void 0:Y.messageFilters),W=await Ye.getSessionDetails(s,{page:P,pageSize:r,messageType:T});if(k.current!==_)return;if(te)l(se=>[...W.messages,...se]);else{const se=new Set(W.messages.filter(ae=>ae.role==="user").map(ae=>typeof ae.content=="string"?ae.content:JSON.stringify(ae.content)));l(ae=>{const Q=ae.filter(ge=>ge._isOptimistic).filter(ge=>{const ce=typeof ge.content=="string"?ge.content:JSON.stringify(ge.content);return!se.has(ce)});return[...W.messages,...Q]});const le=A.current.get(s)||[],me=le.filter(ae=>{const H=typeof ae.content=="string"?ae.content:JSON.stringify(ae.content);return!se.has(H)});me.length!==le.length&&A.current.set(s,me)}p({id:s,name:W.name,customName:W.customName,cwd:W.cwd}),f(W.metadata),v(W.pagination??null),w(P)}catch(T){console.error("Failed to load session details:",T),l([]),p(null),f(null),v(null)}finally{E||g(!1)}},[s,r,o]),M=h.useCallback(async(P,te,E=!1)=>{if(!s)return;const _=s;try{g(!0),j(P),C(te),O(!0);const F=await Ye.searchSessionMessages(s,P,te);if(k.current!==_)return;l(E?V=>[...F.results,...V]:F.results),v(F.pagination),w(F.pagination.page)}catch(F){E||l([]),console.error("Failed to search messages:",F)}finally{g(!1)}},[s]),I=h.useCallback(()=>{if(!(!s||!x||b>=x.totalPages))if(N&&y!==void 0){const P={...S,page:b+1};M(y,P,!0)}else L(b+1,!0)},[s,x,b,N,y,S,M,L]),z=h.useCallback(async()=>{s&&(N&&y!==void 0?await M(y,{...S,page:b}):await L(b))},[s,N,y,S,b,M,L]),$=h.useCallback(P=>{if(!s)return"";const te=`optimistic-${Date.now()}`,E={id:te,role:"user",content:P,timestamp:new Date().toISOString(),_isOptimistic:!0},_=A.current.get(s)||[];return A.current.set(s,[..._,E]),l(F=>[...F,E]),te},[s]),q=h.useCallback(P=>{if(s){const te=A.current.get(s)||[];A.current.set(s,te.filter(E=>E.id!==P))}l(te=>te.filter(E=>E.id!==P))},[s]);return h.useEffect(()=>{const P=s?A.current.get(s)||[]:[];l(P),p(null),f(null),v(null),w(1),j(""),C(null),O(!1),s&&t&&L(1)},[s,t]),h.useEffect(()=>{if(!s)return;const P=ie.selectSlice(te=>{var E,_,F;return(F=(_=(E=te.app)==null?void 0:E.claude)==null?void 0:_.ui)==null?void 0:F.messageFilters}).subscribe(te=>{if(JSON.stringify(R.current)!==JSON.stringify(te)&&(R.current=te,!o))if(N&&y!==void 0){const _={...S,messageType:te,page:1};M(y,_)}else L(1,!1,!0)});return()=>P.unsubscribe()},[s,o,N,y,S,M,L]),Da(P=>{P.type!=="batch-modified"&&("sessionId"in P&&P.sessionId!==s||(P.type==="modified"&&(async()=>{var E,_,F;if(!s)return;const te=s;try{const V=o??((F=(_=(E=ie.getState().app)==null?void 0:E.claude)==null?void 0:_.ui)==null?void 0:F.messageFilters),Y=await Ye.getSessionDetails(s,{page:1,pageSize:r,messageType:V});if(k.current!==te)return;const T=new Set(Y.messages.filter(le=>le.role==="user").map(le=>typeof le.content=="string"?le.content:JSON.stringify(le.content)));l(le=>{const me=new Set(le.filter(Q=>!Q._isOptimistic).map(Q=>Q.id)),ae=Y.messages.filter(Q=>!me.has(Q.id)),H=le.filter(Q=>{if(!Q._isOptimistic)return!0;const ge=typeof Q.content=="string"?Q.content:JSON.stringify(Q.content);return!T.has(ge)});return ae.length===0&&H.length===le.length?le:[...H,...ae]});const W=A.current.get(s)||[],se=W.filter(le=>{const me=typeof le.content=="string"?le.content:JSON.stringify(le.content);return!T.has(me)});se.length!==W.length&&A.current.set(s,se),f(Y.metadata)}catch(V){console.error("Failed to fetch new messages on SSE update:",V)}})(),P.type==="deleted"&&(l([]),p(null),f(null),v(null),i==null||i())))},P=>{console.error("SSE connection error in useSessionMessages:",P)},!!s&&n),{messages:c,sessionDetails:d,metadata:u,loading:m,pagination:x,currentPage:b,isSearchActive:N,loadSessionDetails:L,loadOlderMessages:I,searchMessages:M,refreshSession:z,addOptimisticMessage:$,removeOptimisticMessage:q}}function sj({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1}){const[o,i]=h.useState(!1),[c,l]=h.useState(""),d=e.find(x=>x.value===s),p=e.findIndex(x=>x.value===s),u=e.filter(x=>x.label.toLowerCase().includes(c.toLowerCase())),f=x=>{t==null||t(x),i(!1),l("")},m=x=>{if(x.stopPropagation(),r)return;const v=p-1,b=v<0?e.length-1:v;t==null||t(e[b].value)},g=x=>{if(x.stopPropagation(),r)return;const v=p+1,b=v>=e.length?0:v;t==null||t(e[b].value)};return d?a.jsxs("div",{className:"navigable-select-container flex items-center gap-1",children:[a.jsx("button",{onClick:m,disabled:r,className:B("chevron-left p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous option",children:a.jsx(Ds,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),a.jsxs(nt,{open:o,onOpenChange:i,children:[a.jsx(ut,{asChild:!0,children:a.jsx(pt,{variant:d.variant||"secondary",className:B("navigable-badge cursor-pointer hover:opacity-80 transition-opacity",d.className,r&&"opacity-50 cursor-not-allowed"),onClick:x=>{x.stopPropagation(),r&&x.preventDefault()},children:d.label})}),a.jsx(Qe,{className:"popover-content w-64 p-2",align:"start",children:a.jsxs("div",{className:"selector-container space-y-2",children:[a.jsx(We,{placeholder:n,value:c,onChange:x=>l(x.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),a.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(x=>a.jsxs(ue,{variant:"ghost",className:B("option-item w-full justify-between h-8 px-2",x.value===s&&"bg-accent"),onClick:()=>f(x.value),children:[a.jsx(pt,{variant:x.variant||"secondary",className:B("text-xs",x.className),children:x.label}),x.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4"})]},x.value))})]})})]}),a.jsx("button",{onClick:g,disabled:r,className:B("chevron-right p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Next option",children:a.jsx(Ft,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]}):null}function Gs(){var s;try{const e=(s=ie.getState().app)==null?void 0:s.kanban;return e?{spaces:e.spaces??[],activeSpaceId:e.activeSpaceId??"all",customPresets:e.customPresets??[],activePresetId:e.activePresetId??"all",currentFilters:e.currentFilters??ja,customCategories:e.customCategories??[]}:null}catch(e){return console.error("Failed to load persisted Kanban state:",e),null}}function _n(s){var e;try{const t=ie.getState();ie.updateState({app:{...t.app,kanban:{...(e=t.app)==null?void 0:e.kanban,...s}}})}catch(t){console.error("Failed to save persisted Kanban state:",t)}}function nj(){try{const s=ie.getState();ie.updateState({app:{...s.app,kanban:void 0}})}catch(s){console.error("Failed to clear persisted Kanban state:",s)}}const XC={id:!0,title:!0,description:!0,status:!0,priority:!0,category:!0,space:!0,claudeProjectPath:!0,dueDate:!0,createdAt:!0,updatedAt:!0,completedAt:!0,tags:!0,subtasks:!0},ja={searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[Xe.FREEZER,Xe.BACKLOG,Xe.SELECTED,Xe.DOING,Xe.DONE,Xe.ARCHIVE]};function rj(s){return s&&s.version==="4.0"&&"todos"in s&&"spaces"in s}function aj(s){return{version:"4.0",exportedAt:new Date().toISOString(),...s,loading:!1,error:void 0}}const oj=[{value:Zt.PERSONAL,label:"Personal",variant:"secondary",className:"bg-purple-100 text-purple-800 border-purple-200"},{value:Zt.WORK,label:"Work",variant:"secondary",className:"bg-indigo-100 text-indigo-800 border-indigo-200"},{value:Zt.SHOPPING,label:"Shopping",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Zt.HEALTH,label:"Health",variant:"secondary",className:"bg-pink-100 text-pink-800 border-pink-200"},{value:Zt.OTHER,label:"Other",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}],Or=["bg-red-100 text-red-800 border-red-200","bg-orange-100 text-orange-800 border-orange-200","bg-amber-100 text-amber-800 border-amber-200","bg-yellow-100 text-yellow-800 border-yellow-200","bg-lime-100 text-lime-800 border-lime-200","bg-emerald-100 text-emerald-800 border-emerald-200","bg-teal-100 text-teal-800 border-teal-200","bg-cyan-100 text-cyan-800 border-cyan-200","bg-sky-100 text-sky-800 border-sky-200","bg-blue-100 text-blue-800 border-blue-200","bg-violet-100 text-violet-800 border-violet-200","bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200","bg-rose-100 text-rose-800 border-rose-200"];class ij{getAllCategories(){const e=this.getCustomCategories();return[...oj,...e]}getCustomCategories(){try{const e=Gs();return(e==null?void 0:e.customCategories)??[]}catch(e){return console.error("[CategoryFacade] Failed to load custom categories:",e),[]}}createCategory(e){try{if(!e||!e.trim())return{success:!1,error:"Category label cannot be empty"};const t=e.trim();if(this.getAllCategories().find(f=>f.label.toLowerCase()===t.toLowerCase()))return{success:!1,error:`Category "${t}" already exists`};const o=`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=this.getCustomCategories(),c=i.map(f=>f.className||""),l=this.getRandomColorClass(c),d={id:o,value:o,label:t,variant:"secondary",className:l,isCustom:!0},p=Gs(),u=[...i,d];return _n({...p,spaces:(p==null?void 0:p.spaces)??[],activeSpaceId:(p==null?void 0:p.activeSpaceId)??"all",customPresets:(p==null?void 0:p.customPresets)??[],activePresetId:(p==null?void 0:p.activePresetId)??"all",currentFilters:(p==null?void 0:p.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:u}),{success:!0,category:d}}catch(t){return console.error("[CategoryFacade] Failed to create category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}deleteCategory(e){try{if(this.isDefaultCategory(e))return{success:!1,error:"Cannot delete default categories"};const t=this.getCustomCategories();if(!t.find(i=>i.id===e))return{success:!1,error:`Category with ID "${e}" not found`};const r=t.filter(i=>i.id!==e),o=Gs();return _n({...o,spaces:(o==null?void 0:o.spaces)??[],activeSpaceId:(o==null?void 0:o.activeSpaceId)??"all",customPresets:(o==null?void 0:o.customPresets)??[],activePresetId:(o==null?void 0:o.activePresetId)??"all",currentFilters:(o==null?void 0:o.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:r}),{success:!0,deletedId:e}}catch(t){return console.error("[CategoryFacade] Failed to delete category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}isDefaultCategory(e){return Object.values(Zt).includes(e)}categoryExists(e){return this.getAllCategories().some(n=>n.value===e)}getCategoryByValue(e){return this.getAllCategories().find(n=>n.value===e)}clearAllCustomCategories(){try{const e=Gs();_n({...e,spaces:(e==null?void 0:e.spaces)??[],activeSpaceId:(e==null?void 0:e.activeSpaceId)??"all",customPresets:(e==null?void 0:e.customPresets)??[],activePresetId:(e==null?void 0:e.activePresetId)??"all",currentFilters:(e==null?void 0:e.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:[]}),console.info("[CategoryFacade] Cleared all custom categories")}catch(e){console.error("[CategoryFacade] Failed to clear custom categories:",e)}}getRandomColorClass(e){const t=Or.filter(n=>!e.includes(n));return t.length===0?Or[Math.floor(Math.random()*Or.length)]:t[Math.floor(Math.random()*t.length)]}}const js=new ij,cj=s=>{var e,t;return((t=(e=s.app)==null?void 0:e.kanban)==null?void 0:t.customCategories)??[]};function lj({value:s,onChange:e,placeholder:t="Search categories...",disabled:n=!1}){const[r,o]=h.useState(!1),[i,c]=h.useState(""),l=Le(cj),d=h.useMemo(()=>js.getAllCategories(),[l]),p=d.find(b=>b.value===s),u=d.filter(b=>b.label.toLowerCase().includes(i.toLowerCase())),f=h.useCallback(b=>{e==null||e(b),o(!1),c("")},[e]),m=h.useCallback(()=>{if(!i.trim())return;const b=js.createCategory(i.trim());b.success&&b.category?(f(b.category.value),c("")):console.error("[CategorySelector] Failed to create category:",b.error)},[i,f]),g=h.useCallback((b,w)=>{var j;if(b.stopPropagation(),js.isDefaultCategory(w))return;const y=js.deleteCategory(w);if(y.success){if(s===w){const S=js.getAllCategories();f(((j=S[0])==null?void 0:j.value)||"")}}else console.error("[CategorySelector] Failed to delete category:",y.error)},[s,f]),x=h.useCallback(b=>{o(b),b||c("")},[]);if(!p)return null;const v=i.trim()&&u.length===0;return a.jsxs(nt,{open:r,onOpenChange:x,children:[a.jsx(ut,{asChild:!0,children:a.jsx(pt,{"data-test":"category-selector-trigger",variant:p.variant||"secondary",className:B("cursor-pointer hover:opacity-80 transition-opacity",p.className,n&&"opacity-50 cursor-not-allowed"),onClick:b=>{b.stopPropagation(),n&&b.preventDefault()},children:p.label})}),a.jsx(Qe,{className:"popover-content w-64 p-2",align:"start","data-test":"category-selector-popover",children:a.jsxs("div",{className:"selector-container space-y-2","data-test":"category-selector-container",children:[a.jsx(We,{"data-test":"category-search-input",placeholder:t,value:i,onChange:b=>c(b.target.value),onKeyDown:b=>{b.key==="Enter"&&v&&(b.preventDefault(),m())},className:"search-input h-8 text-sm",autoFocus:!0}),a.jsxs("div",{className:"options-list max-h-64 overflow-y-auto space-y-1","data-test":"category-options-list",children:[u.length===0&&!v&&a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"category-empty-state",children:"No options found"}),v&&a.jsxs(ue,{"data-test":"category-create-button",variant:"ghost",className:"category-create-button w-full justify-start h-8 px-2 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:m,children:[a.jsx(Ks,{className:"create-icon h-4 w-4 mr-2","data-test":"category-create-icon"}),'Create "',i,'"']}),u.map(b=>{const w=!js.isDefaultCategory(b.value);return a.jsxs("div",{"data-test":"category-option-wrapper",className:B("option-item-wrapper flex items-center gap-1",b.value===s&&"bg-accent rounded"),children:[a.jsxs(ue,{"data-test":"category-option-button",variant:"ghost",className:B("option-item flex-1 justify-between h-8 px-2"),onClick:()=>f(b.value),children:[a.jsx(pt,{"data-test":"category-option-badge",variant:b.variant||"secondary",className:B("text-xs",b.className),children:b.label}),b.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4","data-test":"category-selected-check"})]}),w&&a.jsx(ue,{"data-test":"category-delete-button",variant:"ghost",size:"icon",className:"category-delete-button h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50",onClick:y=>g(y,b.value),title:"Delete category",children:a.jsx(Et,{className:"delete-icon h-4 w-4","data-test":"category-delete-icon"})})]},b.value)})]})]})})]})}function er(){return"xxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class QC{constructor(e){ee(this,"items",[]);this.initialItems=e,e&&(e.forEach(t=>{t.id===void 0&&(t.id=er())}),this.items=e)}create(e,t={}){const n={id:er(),created:new Date().toISOString(),...e},{allowDuplicate:r,uniqueByKey:o}=t;if(r)return this.items.push(n),n;let i=-1;if(o&&(i=this.items.findIndex(p=>p[o]===n[o])),i!==-1)return;const l=this.items.findIndex(p=>p.id===n.id);return l!==-1?(this.items[l]=n,n):(this.items.push(n),n)}insertAt(e,t){const n=structuredClone(this.items);return n.splice(e,0,...t),n}batchCreate(e){this.items.push(...e)}readAll(e=!0){return e?structuredClone(this.items):this.items}readBetween(e,t){const n=[];for(let r=e;r<=t;r++){const o=this.items[r];n.push(o)}return n}readById(e){return this.items.find(t=>t.id===e)}readByKey(e,t){return this.items.find(n=>n[e]===t)}readFirst(){return this.items.length===0?void 0:this.items[0]}readLast(){return this.items.length===0?void 0:this.items[this.items.length-1]}update(e){const t=this.items.findIndex(n=>n.id===e.id);t!==-1&&(this.items[t]=e)}batchUpdate(e){e.forEach(t=>{const n=this.items.findIndex(r=>r.id===t.id);n!==-1&&(this.items[n]=t)})}delete(e){console.log("[CRUDService.ts,123] this.items: ",this.items);const t=this.items.findIndex(n=>n.id===e);console.log("[CRUDService.ts,123] indexToDelete: ",t),t!==-1&&this.items.splice(t,1)}deleteByKey(e,t){this.items=this.items.filter(n=>n[e]!==t)}deleteBetween(e,t){const n=this.items.slice(0,e),r=this.items.slice(t+1,this.items.length);return[...n,...r]}batchDelete(e){this.items=this.items.filter(t=>!e.includes(t.id))}getPreviousItem(e){const n=this.getCurrentItemIndex(e)-1,r=Math.max(n,0);return this.items[r]}getNextItem(e){const n=this.getCurrentItemIndex(e)+1,r=this.count()-1,o=Math.min(n,r);return this.items[o]}getCurrentItemIndex(e){return this.findIndexByKey("id",e)}count(){return this.items.length}clear(){this.items=[]}filterByKey(e,t){return this.items.filter(n=>n[e]===t)}findByKey(e,t){return this.items.find(n=>n[e]===t)}findIndexByKey(e,t){return this.items.findIndex(n=>n[e]===t)}replace(e){e&&(this.items=e)}replaceOne(e,t){console.log(">>>> _ >>>> ~ file: CRUDService.ts:203 ~ replace:",t);const n=structuredClone(this.items);return n[e]=t,n}sort(e,t=!0){this.items.sort((n,r)=>{const o=n[e],i=r[e];return o===i?0:t?o<i?-1:1:o>i?-1:1})}}const dj="TodoDB",uj=2,at="todos";class pj{constructor(){ee(this,"db",null)}async init(){return new Promise((e,t)=>{const n=indexedDB.open(dj,uj);n.onerror=()=>{t(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const o=r.target.result,i=r.target.transaction,c=r.oldVersion;if(!o.objectStoreNames.contains(at)){const l=o.createObjectStore(at,{keyPath:"id.value"});l.createIndex("status","status",{unique:!1}),l.createIndex("priority","priority",{unique:!1}),l.createIndex("category","category",{unique:!1}),l.createIndex("createdAt","createdAt.value",{unique:!1}),l.createIndex("dueDate","dueDate.value",{unique:!1}),l.createIndex("sortOrder","sortOrder",{unique:!1})}if(c<2){const l=i.objectStore(at);l.indexNames.contains("sortOrder")||l.createIndex("sortOrder","sortOrder",{unique:!1});const d=l.getAll();d.onsuccess=()=>{const p=d.result,u={};p.forEach(f=>{const m=f.status||"backlog";u[m]||(u[m]=[]),u[m].push(f)}),Object.keys(u).forEach(f=>{u[f].forEach((m,g)=>{m.sortOrder===void 0&&(m.sortOrder=g,l.put(m))})})}}}})}async getAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([at],"readonly").objectStore(at).getAll();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to get todos"))}})}async getById(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([at],"readonly").objectStore(at).get(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{n(new Error("Failed to get todo"))}})}async add(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([at],"readwrite").objectStore(at).add(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to add todo"))}})}async update(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([at],"readwrite").objectStore(at).put(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to update todo"))}})}async delete(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([at],"readwrite").objectStore(at).delete(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to delete todo"))}})}async clear(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([at],"readwrite").objectStore(at).clear();o.onsuccess=()=>{e()},o.onerror=()=>{t(new Error("Failed to clear todos"))}})}async count(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([at],"readonly").objectStore(at).count();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to count todos"))}})}}const dt=new pj;function hj(s){return s&&typeof s=="object"&&("claudeProject"in s||"sessionIds"in s)}class fj{constructor(){ee(this,"initialized",!1)}async init(){if(this.initialized)return;await dt.init(),this.initialized=!0,await dt.count()===0&&await this.seedMockData()}createTodoId(e){return{value:e}}createTimestamp(e){return{value:e??new Date}}async createTodo(e){await this.init();const t=e.status??Xe.BACKLOG;let n=e.sortOrder;if(n===void 0){const i=(await dt.getAll()).filter(l=>l.status===t);n=(i.length>0?Math.max(...i.map(l=>l.sortOrder??0)):-1)+1}const r={id:this.createTodoId(er()),title:e.title,description:e.description,status:t,priority:e.priority??Gt.MEDIUM,category:e.category??Zt.PERSONAL,space:e.space,sortOrder:n,dueDate:e.dueDate?this.createTimestamp(e.dueDate):void 0,createdAt:this.createTimestamp(),updatedAt:this.createTimestamp(),tags:e.tags??[],subtasks:[],customProps:e.customProps};return await dt.add(r),r}async getTodo(e){await this.init();const t=await dt.getById(e.value);if(!t)throw new Error(`Todo with id ${e.value} not found`);return t}async getAllTodos(e){await this.init();let t=await dt.getAll();if(e!=null&&e.filters){const{status:n,priority:r,category:o,space:i,claudeProjectPath:c,tags:l,searchQuery:d}=e.filters;if(n&&n.length>0&&(t=t.filter(p=>n.includes(p.status))),r&&r.length>0&&(t=t.filter(p=>r.includes(p.priority))),o&&o.length>0&&(t=t.filter(p=>o.includes(p.category))),i&&i.length>0&&(t=t.filter(p=>p.space&&i.includes(p.space))),c&&c.length>0&&(t=t.filter(p=>{if(hj(p.customProps))return p.customProps.claudeProjectPath&&c.includes(p.customProps.claudeProjectPath)})),l&&l.length>0&&(t=t.filter(p=>l.some(u=>p.tags.includes(u)))),d){const p=d.toLowerCase();t=t.filter(u=>{var f;return u.title.toLowerCase().includes(p)||((f=u.description)==null?void 0:f.toLowerCase().includes(p))})}}if(e!=null&&e.sort){const{field:n,direction:r}=e.sort;t.sort((o,i)=>{const c=o[n],l=i[n];if(c==null||l===void 0||l===null)return 0;const d=c<l?-1:c>l?1:0;return r==="asc"?d:-d})}else t.sort((n,r)=>(n.sortOrder??0)-(r.sortOrder??0));if((e==null?void 0:e.offset)!==void 0||(e==null?void 0:e.limit)!==void 0){const n=e.offset??0,r=e.limit??t.length;t=t.slice(n,n+r)}return t}async updateTodo(e,t){await this.init();const n=await this.getTodo(e),r={...n,...t,dueDate:t.dueDate?this.createTimestamp(t.dueDate instanceof Date?t.dueDate:new Date(t.dueDate.value)):n.dueDate,updatedAt:this.createTimestamp(),customProps:t.customProps?{...n.customProps,...t.customProps}:n.customProps};return await dt.update(r),r}async deleteTodo(e){await this.init(),await dt.delete(e.value)}async startTodo(e){return this.updateTodo(e,{status:Xe.DOING})}async completeTodo(e){const t=await this.updateTodo(e,{status:Xe.DONE});return t.completedAt=this.createTimestamp(),await dt.update(t),t}async cancelTodo(e){return this.updateTodo(e,{status:Xe.ARCHIVE})}async addSubtask(e,t){await this.init();const n=await this.getTodo(e),r={id:this.createTodoId(er()),title:t.title,isCompleted:!1,createdAt:this.createTimestamp()};return n.subtasks.push(r),n.updatedAt=this.createTimestamp(),await dt.update(n),n}async updateSubtask(e,t,n){await this.init();const r=await this.getTodo(e),o=r.subtasks.find(i=>i.id.value===t.value);if(!o)throw new Error(`Subtask with id ${t.value} not found`);return n.title!==void 0&&(o.title=n.title),n.isCompleted!==void 0&&(o.isCompleted=n.isCompleted),r.updatedAt=this.createTimestamp(),await dt.update(r),r}async toggleSubtask(e,t){await this.init();const n=await this.getTodo(e),r=n.subtasks.find(o=>o.id.value===t.value);if(!r)throw new Error(`Subtask with id ${t.value} not found`);return r.isCompleted=!r.isCompleted,n.updatedAt=this.createTimestamp(),await dt.update(n),n}async removeSubtask(e,t){await this.init();const n=await this.getTodo(e);return n.subtasks=n.subtasks.filter(r=>r.id.value!==t.value),n.updatedAt=this.createTimestamp(),await dt.update(n),n}async bulkUpdateStatus(e,t){await this.init(),await Promise.all(e.map(n=>this.updateTodo(n,{status:t})))}async bulkDelete(e){await this.init(),await Promise.all(e.map(t=>this.deleteTodo(t)))}async seedMockData(){const e=[];for(const n of e){const r=await this.createTodo(n);n.title==="Complete project documentation"&&(await this.addSubtask(r.id,{title:"Write API documentation"}),await this.addSubtask(r.id,{title:"Create usage examples"}),await this.addSubtask(r.id,{title:"Add screenshots"})),n.title==="Buy groceries"&&(await this.addSubtask(r.id,{title:"Check pantry inventory"}),await this.addSubtask(r.id,{title:"Make shopping list"}))}const t=await this.getAllTodos();t.length>0&&await this.startTodo(t[0].id),t.length>3&&await this.completeTodo(t[3].id)}async clearAllTodos(){await this.init(),await dt.clear()}async exportTodos(){await this.init();const e=await this.getAllTodos(),t=Gs(),n={todos:e,spaces:(t==null?void 0:t.spaces)??[],activeSpaceId:(t==null?void 0:t.activeSpaceId)??"all",customPresets:(t==null?void 0:t.customPresets)??[],activePresetId:(t==null?void 0:t.activePresetId)??"all",currentFilters:(t==null?void 0:t.currentFilters)??ja,customCategories:(t==null?void 0:t.customCategories)??[],loading:!1},r={...n,todos:n.todos.map(i=>({...i,createdAt:{value:i.createdAt.value.toISOString()},updatedAt:{value:i.updatedAt.value.toISOString()},completedAt:i.completedAt?{value:i.completedAt.value.toISOString()}:void 0,dueDate:i.dueDate?{value:i.dueDate.value.toISOString()}:void 0,subtasks:i.subtasks.map(c=>({...c,createdAt:{value:c.createdAt.value.toISOString()}}))}))},o=aj(r);return JSON.stringify(o,null,2)}async importTodos(e,t){var d,p,u;await this.init();const n=[];let r=0,o=0,i=0,c=0,l=0;try{const f=JSON.parse(e);if(!rj(f))throw new Error("Invalid format: Expected KanbanExportData v4.0 format");const m=f;t!=null&&t.replace&&(await this.clearAllTodos(),nj());const g=m.todos??[];for(const x of g)try{const v={...x,createdAt:{value:new Date(x.createdAt.value)},updatedAt:{value:new Date(x.updatedAt.value)},completedAt:x.completedAt?{value:new Date(x.completedAt.value)}:void 0,dueDate:x.dueDate?{value:new Date(x.dueDate.value)}:void 0,subtasks:(x.subtasks??[]).map(w=>({...w,createdAt:{value:new Date(w.createdAt.value)}}))};await dt.getById(v.id.value)&&!(t!=null&&t.replace)?o++:(await dt.add(v),r++)}catch(v){n.push(`Failed to import todo "${x.title}": ${v instanceof Error?v.message:"Unknown error"}`),o++}try{const x={spaces:m.spaces??[],activeSpaceId:m.activeSpaceId??"all",customPresets:m.customPresets??[],activePresetId:m.activePresetId??"all",currentFilters:m.currentFilters??ja,customCategories:m.customCategories??[]};_n(x),c=((d=m.spaces)==null?void 0:d.length)??0,i=((p=m.customPresets)==null?void 0:p.length)??0,l=((u=m.customCategories)==null?void 0:u.length)??0}catch(x){n.push(`Failed to save persisted state: ${x instanceof Error?x.message:"Unknown error"}`)}return{imported:r,skipped:o,errors:n,presetsImported:i,spacesImported:c,categoriesImported:l}}catch(f){throw new Error(`Failed to parse JSON: ${f instanceof Error?f.message:"Unknown error"}`)}}}const tt=new fj;class mj{async createTicket(e,t){await tt.createTodo({...t,status:e})}}class gj{async createSessionForTodo(e,t){const n=await Ye.createSession({message:t.message,cwd:t.projectPath,projectId:t.projectPath,options:{outputFormat:t.outputFormat,permissionMode:t.permissionMode}});return n.success&&n.sessionId&&await this.linkSessionToTodo(e,n.sessionId),n}async linkSessionToTodo(e,t,n={mode:"append"}){var c;const r=await tt.getTodo(e),o=((c=r.customProps)==null?void 0:c.sessionIds)??[],i=n.mode==="replace"?[t]:[...o,t];await tt.updateTodo(e,{customProps:{...r.customProps,sessionIds:i}})}async unlinkSessionFromTodo(e,t){var i;const n=await tt.getTodo(e),o=(((i=n.customProps)==null?void 0:i.sessionIds)??[]).filter(c=>c!==t);await tt.updateTodo(e,{customProps:{...n.customProps,sessionIds:o}})}async getSessionsForTodo(e){var n;return((n=(await tt.getTodo(e)).customProps)==null?void 0:n.sessionIds)??[]}async hasLinkedSessions(e){return(await this.getSessionsForTodo(e)).length>0}buildInitialMessageFromTodo(e){const t=[];if(t.push(`# ${e.title}
`),e.description&&(t.push("## Description"),t.push(e.description),t.push("")),e.dueDate){const n=new Date(e.dueDate.value);t.push(`**Due Date:** ${n.toLocaleDateString()}`),t.push("")}return e.subtasks&&e.subtasks.length>0&&(t.push("## Subtasks"),e.subtasks.forEach(n=>{const r=n.isCompleted?"[x]":"[ ]";t.push(`${r} ${n.title}`)}),t.push("")),e.tags&&e.tags.length>0&&(t.push(`**Tags:** ${e.tags.join(", ")}`),t.push("")),t.push("---"),t.push("I permit and approve all file changes in this session to help complete this task."),t.join(`
`)}async createSessionWithTodoContext(e,t,n={}){var l;const r=await tt.getTodo(e),o=this.buildInitialMessageFromTodo(r),i=t?`${o}

---

${t}`:o,c=n.projectPath??((l=r.customProps)==null?void 0:l.claudeProjectPath);return this.createSessionForTodo(e,{message:i,projectPath:c,outputFormat:n.outputFormat,permissionMode:n.permissionMode})}async setProjectPath(e,t){const n=await tt.getTodo(e);await tt.updateTodo(e,{customProps:{...n.customProps,claudeProjectPath:t}})}async getProjectPath(e){var n;return(n=(await tt.getTodo(e)).customProps)==null?void 0:n.claudeProjectPath}}class xj{constructor(){ee(this,"column");ee(this,"claude");this.column=new mj,this.claude=new gj}async createTestFailureTicket(e){const t=this.buildFailureDescription(e),n=`[Test Failure] ${e.scenario}`;await this.column.createTicket(Xe.BACKLOG,{title:n,description:t,priority:Gt.HIGH,category:Zt.WORK,tags:["test-failure","bdd",e.feature.toLowerCase().replace(/\s+/g,"-")],customProps:{testFailureId:e.id,feature:e.feature,scenario:e.scenario,failedStep:e.failedStep,stepType:e.stepType,stepIndex:e.stepIndex,timestamp:e.timestamp}})}async sendTestFailureToClaude(e,t){const n=this.buildClaudeMessage(e);return await Ye.createSession({message:n,cwd:t==null?void 0:t.projectPath,projectId:t==null?void 0:t.projectPath,options:{outputFormat:t==null?void 0:t.outputFormat,permissionMode:t==null?void 0:t.permissionMode}})}buildClaudeMessage(e){const t=[];return t.push(`I have a BDD test failure that needs debugging help.
`),t.push("## Test Context"),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Step Type:** ${e.stepType||"Unknown"}`),t.push(`**Step Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Step Text:** \`${e.failedStep}\`
`)),t.push("## Error Details"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
## Request`),t.push("Please help me understand:"),t.push("1. What caused this test failure?"),t.push("2. What is the root cause of the error?"),t.push("3. How can I fix this issue?"),t.push("4. Are there any related issues I should be aware of?"),t.join(`
`)}buildFailureDescription(e){const t=[];return t.push(`# Test Failure Report
`),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Type:** ${e.stepType||"Unknown"}`),t.push(`**Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Text:** ${e.failedStep}
`)),t.push("## Error"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
---`),t.push("**Next Steps:**"),t.push("1. Review the error and failed step"),t.push("2. Reproduce the issue locally"),t.push("3. Send to Claude for analysis (Future: Phase 3)"),t.join(`
`)}}const tu=new xj,vj=[{value:Gt.LOW,label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Gt.MEDIUM,label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Gt.HIGH,label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:Gt.URGENT,label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],bj=[{value:Xe.FREEZER,label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:Xe.BACKLOG,label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Xe.SELECTED,label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:Xe.DOING,label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Xe.DONE,label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Xe.ARCHIVE,label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],wj=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},yj=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1};function Sj({todo:s,mode:e,onUpdate:t,onClose:n,activeSessionId:r,isProcessingAll:o=!1,currentProcessingSubtaskId:i=null,onProcessAll:c,onStopProcessing:l}){const[d,p]=h.useState(""),[u,f]=h.useState(""),[m,g]=h.useState(""),[x,v]=h.useState(""),[b,w]=h.useState(""),[y,j]=h.useState(Xe.BACKLOG),[S,C]=h.useState(Gt.MEDIUM),[N,O]=h.useState(""),[R,k]=h.useState([]),[A,L]=h.useState([]),[M,I]=h.useState([]),[z,$]=h.useState(void 0),[q,P]=h.useState(0),[te,E]=h.useState({}),_=h.useRef(null),F=h.useRef({}),V=Le(wj),Y=Le(yj);h.useEffect(()=>{var D,X;s?(p(s.title),f(s.description??""),g(s.dueDate?new Date(s.dueDate.value).toISOString().split("T")[0]:""),j(s.status),C(s.priority),O(s.category),k(s.tags),L(s.subtasks),I(((D=s.customProps)==null?void 0:D.sessionIds)??[]),$((X=s.customProps)==null?void 0:X.claudeProjectPath)):(p(""),f(""),g(""),j(Xe.BACKLOG),C(Gt.MEDIUM),O(""),k([]),L([]),I([]),$(void 0))},[s]);const T=h.useCallback((D,X)=>{const we=F.current[D],ne=we==null?void 0:we.getTextArea();if(!ne||!X)return 1;const xe=ne.offsetWidth;if(xe===0)return 1;const J=window.getComputedStyle(ne),he=J.font,je=J.lineHeight,Te=je==="normal"?parseFloat(J.fontSize)*1.2:parseFloat(je),Ne=Vn(X,xe,he,Te);return Math.max(1,Math.ceil(Ne/Te))},[]);h.useEffect(()=>{const D={};A.forEach(X=>{const we=T(X.id.value,X.title);D[X.id.value]=we}),E(D)},[A,T]),h.useEffect(()=>{var X;const D=(X=_.current)==null?void 0:X.getTextArea();if(D){const we=()=>{const xe=D.offsetWidth;P(xe)};we();const ne=new ResizeObserver(we);return ne.observe(D),()=>{ne.disconnect()}}},[]);const W=h.useCallback(async D=>{if(e==="edit"&&s)try{await tt.updateTodo(s.id,D),t()}catch(X){console.error("Failed to update todo:",X)}},[e,s,t]),se=h.useCallback(async()=>{if(e==="create"&&d.trim())try{await tu.column.createTicket(y,{title:d.trim(),description:u.trim()||void 0,priority:S,category:N||void 0,tags:R,dueDate:m?new Date(m):void 0,customProps:{sessionIds:M,claudeProject:z}}),t(),n()}catch(D){console.error("Failed to create todo:",D)}},[e,d,u,y,S,N,R,m,M,z,t,n]);h.useCallback(()=>{e==="edit"&&s&&d!==s.title&&d.trim()&&W({title:d})},[e,s,d,W]);const le=h.useCallback(()=>{e==="edit"&&s&&u!==(s.description??"")&&W({description:u})},[e,s,u,W]),me=h.useCallback(D=>{g(D),e==="edit"&&W(D?{dueDate:{value:new Date(D)}}:{dueDate:void 0})},[e,W]),ae=h.useCallback(()=>{const D=x.trim();if(D&&!R.includes(D)){const X=[...R,D];k(X),e==="edit"&&W({tags:X}),v("")}},[x,R,e,W]),H=h.useCallback(D=>{const X=R.filter(we=>we!==D);k(X),e==="edit"&&W({tags:X})},[R,e,W]),Q=h.useCallback(async()=>{if(b.trim())if(e==="edit"&&s)try{await tt.addSubtask(s.id,{title:b.trim()}),w(""),t()}catch(D){console.error("Failed to add subtask:",D)}else L([...A,{id:{value:`temp-${Date.now()}`},title:b.trim(),isCompleted:!1}]),w("")},[e,s,b,A,t]),ge=h.useCallback(async D=>{if(e==="edit"&&s)try{await tt.toggleSubtask(s.id,D),t()}catch(X){console.error("Failed to toggle subtask:",X)}else L(A.map(X=>X.id.value===D.value?{...X,isCompleted:!X.isCompleted}:X))},[e,s,A,t]),ce=h.useCallback(async D=>{if(e==="edit"&&s)try{await tt.removeSubtask(s.id,D),t()}catch(X){console.error("Failed to remove subtask:",X)}else L(A.filter(X=>X.id.value!==D.value))},[e,s,A,t]),Ae=h.useCallback(async()=>{if(u.trim())try{const D=u.split(`
`),X=[];for(const we of D){const ne=we.trim(),J=/^-\s*\[([ x])\]\s*(.+)$/i.exec(ne);if(J){const Te=J[1].toLowerCase()==="x",Ne=J[2].trim();Ne&&X.push({title:Ne,isCompleted:Te});continue}const je=/^-\s+(.+)$/.exec(ne);if(je){const Te=je[1].trim();Te&&X.push({title:Te,isCompleted:!1})}}if(e==="edit"&&s){for(const we of X){const ne=await tt.addSubtask(s.id,{title:we.title});if(we.isCompleted){const xe=ne.subtasks[ne.subtasks.length-1];xe&&await tt.toggleSubtask(s.id,xe.id)}}t()}else{const we=X.map((ne,xe)=>({id:{value:`temp-${Date.now()}-${xe}`},title:ne.title,isCompleted:ne.isCompleted}));L([...A,...we])}}catch(D){console.error("Failed to split tasks:",D)}},[e,s,u,A,t]),ke=h.useCallback(D=>{j(D),e==="edit"&&W({status:D})},[e,W]),ve=h.useCallback(D=>{C(D),e==="edit"&&W({priority:D})},[e,W]),U=h.useCallback(D=>{O(D),e==="edit"&&W({category:D})},[e,W]),re=h.useCallback(D=>{const X=Array.isArray(D)?D:[D];I(X),e==="edit"&&W({customProps:{sessionIds:X}})},[e,W]),G=h.useCallback(D=>{var we,ne,xe;$(D);const X=ie.getState();ie.updateState({app:{...X.app,claude:{...(we=X.app)==null?void 0:we.claude,ui:{...(xe=(ne=X.app)==null?void 0:ne.claude)==null?void 0:xe.ui,selectedProjectPath:D}}}}),e==="edit"&&W({customProps:{claudeProjectPath:D}})},[e,W]),oe=h.useMemo(()=>V.map(D=>({value:D.path,label:D.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[V]),de=h.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...oe],[oe]);h.useCallback(D=>{p(D.target.value)},[]);const pe=h.useCallback(D=>{f(D.target.value)},[]),fe=h.useCallback(D=>{D.key==="Escape"&&D.currentTarget.blur()},[]),be=h.useCallback(D=>{v(D.target.value)},[]),Pe=h.useCallback(D=>{D.key==="Enter"&&(D.preventDefault(),ae())},[ae]),Ie=h.useCallback(D=>{w(D.target.value)},[]),K=h.useCallback(D=>{D.key==="Enter"&&!D.shiftKey&&(D.preventDefault(),Q())},[Q]);return a.jsxs("div",{className:"details-grid grid grid-cols-4 gap-6","data-test":"todo-details-form",children:[a.jsxs("div",{className:"left-column col-span-3 space-y-6","data-test":"todo-details-left-column",children:[a.jsxs("div",{className:"form-field-description space-y-2","data-test":"todo-details-description-field",children:[a.jsx(Se,{htmlFor:"description","data-test":"todo-details-description-label",children:"Description"}),a.jsx(as,{value:u,onChange:pe,onBlur:le,onKeyDown:fe,placeholder:"Enter description...",rows:12,className:"description-textarea min-h-[100px] w-full","data-test":"todo-details-description-textarea",useMarkdown:!0}),a.jsxs("div",{className:"description-actions mt-2 flex gap-2 justify-between","data-test":"todo-details-description-actions",children:[a.jsx(ue,{onClick:Ae,size:"sm",variant:"outline",className:"split-tasks-button",disabled:!u.trim(),"data-test":"todo-details-split-tasks-button",children:"Split Tasks"}),e==="edit"?a.jsx(ue,{onClick:le,size:"sm",variant:"outline",className:"save-description-button","data-test":"todo-details-save-description-button",children:"Save"}):a.jsx(ue,{onClick:se,size:"sm",variant:"default",className:"create-todo-button",disabled:!d.trim(),"data-test":"todo-details-create-button",children:"Create Todo"})]})]}),a.jsxs("div",{className:"form-field-subtasks space-y-2","data-test":"todo-details-subtasks-field",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(Se,{"data-test":"todo-details-subtasks-label",children:"Subtasks"}),e==="edit"&&r&&A.some(D=>!D.isCompleted)&&(c??l)&&a.jsx(ue,{size:"sm",variant:o?"destructive":"outline",onClick:o?l:c,className:"process-all-button","data-test":"todo-details-process-all-button",children:o?a.jsxs(a.Fragment,{children:[a.jsx(ht,{className:"w-3 h-3 mr-1"}),"Stop"]}):"Process All"})]}),a.jsxs("div",{className:"subtasks-container space-y-2","data-test":"todo-details-subtasks-container",children:[a.jsx("div",{className:"subtasks-list space-y-2","data-test":"todo-details-subtasks-list",children:A.map(D=>a.jsxs("div",{className:"subtask-item flex items-center gap-2 p-2 rounded border","data-test":"todo-details-subtask-item",children:[a.jsx("input",{type:"checkbox",checked:D.isCompleted,onChange:()=>ge(D.id),className:"subtask-checkbox",disabled:o,"data-test":"todo-details-subtask-checkbox"}),a.jsx("div",{className:B("subtask-title-wrapper flex-1",D.isCompleted&&"line-through text-gray-500"),children:a.jsx(as,{ref:X=>{F.current[D.id.value]=X},value:D.title,onChange:async X=>{const we=X.target.value,ne=T(D.id.value,we);if(E(xe=>({...xe,[D.id.value]:ne})),e==="edit"&&s)try{await tt.updateSubtask(s.id,D.id,{title:we}),t()}catch(xe){console.error("Failed to update subtask title:",xe)}else L(A.map(xe=>xe.id.value===D.id.value?{...xe,title:we}:xe))},placeholder:"Edit subtask...",className:"subtask-title-textarea resize-none w-full",rows:te[D.id.value]||1,"data-test":"todo-details-subtask-textarea"})}),i===D.id.value&&a.jsx(ir,{className:"w-4 h-4 animate-spin text-blue-500","data-test":"todo-details-subtask-loading"}),e==="edit"&&r&&a.jsx(Sa,{sessionId:r,message:D.title,className:"subtask-send h-7 w-7 hover:text-blue-500",disabled:o,"data-test":"todo-details-subtask-send"}),a.jsx("button",{onClick:()=>ce(D.id),className:"subtask-remove hover:text-red-500",disabled:o,"data-test":"todo-details-subtask-remove",children:a.jsx(ht,{className:"w-4 h-4"})})]},D.id.value))}),a.jsxs("div",{className:"subtask-input flex gap-2","data-test":"todo-details-subtask-input-container",children:[a.jsx(as,{ref:_,value:b,onChange:Ie,onKeyDown:K,placeholder:"Add a subtask...",rows:1,className:"flex-1","data-test":"todo-details-subtask-input"}),a.jsx(ue,{onClick:()=>void Q(),size:"sm",className:"subtask-add-button","data-test":"todo-details-subtask-add-button",children:a.jsx(Ks,{className:"w-4 h-4"})})]})]})]}),e==="edit"&&M.length>0&&a.jsxs("div",{className:"form-field-sessions space-y-2","data-test":"todo-details-sessions-field",children:[a.jsxs(Se,{"data-test":"todo-details-sessions-label",children:["Claude Session IDs (",M.length,")"]}),M.map((D,X)=>a.jsx(We,{value:D,readOnly:!0,className:"session-id-input bg-gray-50 mb-1",title:`Session ${X+1}`,"data-test":"todo-details-session-input"},D))]})]}),a.jsxs("div",{className:"right-column col-span-1 space-y-4","data-test":"todo-details-right-column",children:[a.jsxs("div",{className:"form-field-selectors space-y-4","data-test":"todo-details-selectors",children:[a.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-details-status-selector",children:[a.jsx(Se,{"data-test":"todo-details-status-label",children:"Status"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(sj,{value:y,options:bj,onChange:ke,placeholder:"Search status...","data-test":"todo-details-status-select"})})]}),a.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-details-priority-selector",children:[a.jsx(Se,{"data-test":"todo-details-priority-label",children:"Priority"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(Zr,{value:S,options:vj,onChange:ve,placeholder:"Search priorities...",contentStyle:{zIndex:st.draggablePopoverDropdown},"data-test":"todo-details-priority-badge"})})]}),a.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-details-category-selector",children:[a.jsx(Se,{"data-test":"todo-details-category-label",children:"Category"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(lj,{value:N||"personal",onChange:U,placeholder:"Search categories...","data-test":"todo-details-category-select"})})]}),!Y&&de.length>1&&a.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-details-project-selector",children:[a.jsx(Se,{"data-test":"todo-details-project-label",children:"Claude Project"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(Zr,{value:z??"__no_project__",options:de,onChange:G,placeholder:"Search projects...",contentStyle:{zIndex:st.draggablePopoverDropdown},"data-test":"todo-details-project-badge"})})]}),e==="edit"&&a.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-details-session-selector",children:[a.jsx(Se,{"data-test":"todo-details-session-selector-label",children:"Claude Sessions"}),a.jsx(eu,{value:M,onChange:re,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-details-session-select"})]}),a.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-details-tags-selector",children:[a.jsx(Se,{"data-test":"todo-details-tags-label",children:"Tags"}),a.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-details-tags-container",children:[a.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-details-tags-list",children:R.map(D=>a.jsxs(pt,{variant:"outline",className:"tag-badge gap-1","data-test":"todo-details-tag",children:[D,a.jsx("button",{onClick:()=>H(D),className:"tag-remove ml-1 hover:text-red-500","data-test":"todo-details-tag-remove",children:a.jsx(ht,{className:"w-3 h-3"})})]},D))}),a.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-details-tag-input-container",children:[a.jsx(We,{value:x,onChange:be,onKeyDown:Pe,placeholder:"Add a tag...","data-test":"todo-details-tag-input"}),a.jsx(ue,{onClick:ae,size:"sm",className:"tag-add-button","data-test":"todo-details-tag-add-button",children:a.jsx(Ks,{className:"w-4 h-4"})})]})]})]})]}),a.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-details-due-date-field",children:[a.jsx(Se,{htmlFor:"dueDate","data-test":"todo-details-due-date-label",children:"Due Date"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Cp,{className:"w-4 h-4 text-gray-400"}),a.jsx(We,{id:"dueDate",type:"date",value:m,onChange:D=>me(D.target.value),"data-test":"todo-details-due-date-input"})]})]})]})]})}function jj({todo:s,isOpen:e,onClose:t,onUpdate:n,currentCardIndex:r,totalCardsInColumn:o,onNavigatePrevious:i,onNavigateNext:c,initialValues:l}){var Q,ge,ce,Ae,ke,ve;const[d,p]=h.useState("details"),[u,f]=h.useState(""),[m,g]=h.useState(!1),[x,v]=h.useState(null),[b,w]=h.useState(!1),[y,j]=h.useState(!1),[S,C]=h.useState(0),[N,O]=h.useState((s==null?void 0:s.title)??(l==null?void 0:l.title)??""),[R,k]=h.useState(!1),A=!s||s.id.value==="temp-new-todo",L=h.useMemo(()=>A?{id:{value:"temp-create"},title:(l==null?void 0:l.title)??N,description:(l==null?void 0:l.description)??"",status:Xe.BACKLOG,priority:Gt.MEDIUM,category:(l==null?void 0:l.category)??"",sortOrder:0,tags:(l==null?void 0:l.tags)??[],subtasks:[],createdAt:{value:new Date},updatedAt:{value:new Date},customProps:{sessionIds:[],claudeProjectPath:l==null?void 0:l.claudeProjectPath}}:null,[A,l==null?void 0:l.title,l==null?void 0:l.description,l==null?void 0:l.category,l==null?void 0:l.tags,l==null?void 0:l.claudeProjectPath,N]),M=(ge=(Q=s==null?void 0:s.customProps)==null?void 0:Q.sessionIds)==null?void 0:ge[S],I=h.useMemo(()=>{var U;return((U=s==null?void 0:s.customProps)==null?void 0:U.sessionIds)??[]},[(ce=s==null?void 0:s.customProps)==null?void 0:ce.sessionIds]),z=h.useMemo(()=>({loadOnMount:d==="session",subscribeToSSE:d==="session"}),[d]),{messages:$,sessionDetails:q,metadata:P,loading:te,pagination:E,loadOlderMessages:_,refreshSession:F,addOptimisticMessage:V,removeOptimisticMessage:Y}=tj(M,z);h.useLayoutEffect(()=>{var U,re,G,oe,de,pe,fe;if(e&&((U=s==null?void 0:s.customProps)!=null&&U.claudeProjectPath)){const be=ie.getState();((oe=(G=(re=be.app)==null?void 0:re.claude)==null?void 0:G.ui)==null?void 0:oe.selectedProjectPath)!==s.customProps.claudeProjectPath&&ie.updateState({app:{...be.app,claude:{...(de=be.app)==null?void 0:de.claude,ui:{...(fe=(pe=be.app)==null?void 0:pe.claude)==null?void 0:fe.ui,selectedProjectPath:s.customProps.claudeProjectPath}}}})}},[e,(Ae=s==null?void 0:s.customProps)==null?void 0:Ae.claudeProjectPath]),h.useEffect(()=>{p("details"),C(0),O((s==null?void 0:s.title)??(l==null?void 0:l.title)??"")},[s==null?void 0:s.id.value,s==null?void 0:s.title,s==null?void 0:s.description,e,l==null?void 0:l.title]),h.useEffect(()=>{const U=I.length;U>0&&S>=U&&C(0)},[I.length,S]),h.useEffect(()=>{d==="session"&&M&&F()},[S,M,d,F]);const T=h.useCallback(U=>{p(U),U==="session"&&M&&F()},[M,F]),W=h.useCallback(()=>{k(!0)},[]),se=h.useCallback(async U=>{if(!s){k(!1);return}try{await tu.claude.linkSessionToTodo(s.id,U),n(),k(!1),p("session"),await F()}catch(re){console.error("Failed to handle session creation:",re),k(!1)}},[s,n,F]),le=h.useCallback(async()=>{w(!0);try{await F()}finally{w(!1)}},[F]),me=h.useCallback(async()=>{var re,G,oe,de,pe,fe,be,Pe,Ie,K;if(!s||!M)return;const U=s.subtasks.filter(D=>!D.isCompleted);if(U.length!==0){g(!0),j(!1);try{const D=s.id;for(const X of U){if(y)break;v(X.id.value),await Ye.sendMessage({message:X.title,sessionId:M,options:{outputFormat:"text",permissionMode:"acceptEdits"}});let we=!1;for(let ne=0;ne<50;ne++)if(await new Promise(J=>setTimeout(J,100)),(pe=(de=(oe=(G=(re=ie.get("app"))==null?void 0:re.claude)==null?void 0:G.ui)==null?void 0:oe.activity)==null?void 0:de[M])==null?void 0:pe.isProcessing){we=!0;break}if(!we)console.warn(`[ProcessAll] ${X.title} - Processing never started, continuing anyway`);else for(let ne=0;ne<600&&(await new Promise(J=>setTimeout(J,100)),!!((K=(Ie=(Pe=(be=(fe=ie.get("app"))==null?void 0:fe.claude)==null?void 0:be.ui)==null?void 0:Pe.activity)==null?void 0:Ie[M])==null?void 0:K.isProcessing));ne++);await tt.toggleSubtask(D,X.id),await new Promise(ne=>setTimeout(ne,500))}n()}catch(D){console.error("Failed to process all subtasks:",D)}finally{g(!1),v(null),j(!1)}}},[s,M,n,y]),ae=h.useCallback(()=>{j(!0)},[]),H=h.useCallback(async U=>{const re=U.target.value;if(O(re),!A&&s)try{await tt.updateTodo(s.id,{title:re}),n()}catch(G){console.error("Failed to update todo title:",G)}},[A,s,n]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"panel-header","data-test":"kanban-card-details-header",children:a.jsxs("div",{className:"header-title-row flex items-center justify-between gap-4","data-test":"kanban-card-details-title-row",children:[a.jsxs("div",{className:"header-left flex items-center gap-2 flex-1 min-w-0","data-test":"kanban-card-details-header-left",children:[!A&&a.jsx(ao,{"data-test":"kanban-card-details-session-activity",sessionIds:I,showCount:!0,isCreating:R}),!A&&i&&a.jsx(ue,{"data-test":"kanban-card-details-navigate-previous",variant:"ghost",size:"icon",onClick:i,disabled:r===0,className:"navigate-previous-card h-8 w-8 flex-shrink-0",title:"Previous card in column",children:a.jsx(Ds,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-left-icon"})}),a.jsx("div",{className:"flex-1 min-w-0","data-test":"kanban-card-details-title-wrapper",children:a.jsx(as,{"data-test":"kanban-card-details-title-textarea",value:N,onChange:H,placeholder:A?"Enter todo title...":"Edit todo title",className:"todo-title-textarea text-lg font-semibold resize-none w-full",rows:1})}),!A&&c&&a.jsx(ue,{"data-test":"kanban-card-details-navigate-next",variant:"ghost",size:"icon",onClick:c,disabled:r!==void 0&&o!==void 0&&r>=o-1,className:"navigate-next-card h-8 w-8 flex-shrink-0",title:"Next card in column",children:a.jsx(Ft,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-right-icon"})})]}),!A&&s&&a.jsxs("div",{className:"header-actions flex items-center gap-2 flex-shrink-0","data-test":"kanban-card-details-header-actions",children:[a.jsx(eu,{"data-test":"kanban-card-details-session-selector",value:((ke=s.customProps)==null?void 0:ke.sessionIds)??[],onChange:async U=>{const re=Array.isArray(U)?U:[];await tt.updateTodo(s.id,{customProps:{...s.customProps,sessionIds:re}}),n()},className:"session-selector-header",showLabel:!1,placeholder:"Link to sessions",multiSelect:!0}),a.jsx(wa,{"data-test":"kanban-card-details-create-session-button",variant:"ghost",size:"icon",className:"create-session-button-panel",initialMessage:`Working on: ${s.title}

${s.description??""}`,projectPath:(ve=s.customProps)==null?void 0:ve.claudeProjectPath,onCreating:W,onSessionCreated:se,useModal:!0})]})]})}),a.jsxs(Bd,{value:d,onValueChange:T,className:"panel-tabs flex-1 flex flex-col overflow-hidden","data-test":"kanban-card-details-tabs",children:[a.jsxs(ro,{className:B("grid w-full",A?"grid-cols-1":"grid-cols-2"),"data-test":"kanban-card-details-tabs-list",children:[a.jsx(an,{value:"details","data-test":"kanban-card-details-tab-details",children:"Details"}),!A&&a.jsx(an,{value:"session",disabled:!M,"data-test":"kanban-card-details-tab-session",children:"Claude Session"})]}),a.jsx(on,{value:"details",className:"panel-form mt-4 flex-1 overflow-y-auto data-[state=inactive]:hidden","data-test":"kanban-card-details-details-content",children:a.jsx(Sj,{todo:A?L:s,mode:A?"create":"edit",onUpdate:n,onClose:t,activeSessionId:M,isProcessingAll:m,currentProcessingSubtaskId:x,onProcessAll:me,onStopProcessing:ae})}),!A&&a.jsxs(on,{value:"session",className:"session-tab mt-4 flex-1 flex flex-col overflow-hidden data-[state=inactive]:hidden","data-test":"kanban-card-details-session-content",children:[null,te?a.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session",children:"Loading session..."}):M&&!q?a.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session-initial",children:a.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>void F(),className:"load-session-button",children:[a.jsx(On,{className:"w-4 h-4 mr-2"}),"Load Session"]})}):q?a.jsxs("div",{className:"session-chat-area flex flex-col gap-4 h-[calc(100vh-220px)]","data-test":"kanban-card-details-chat-area",children:[a.jsxs("div",{className:"session-header flex items-center justify-between","data-test":"kanban-card-details-session-header",children:[a.jsxs("div",{className:"session-header-left flex items-center gap-3","data-test":"kanban-card-details-session-header-left",children:[a.jsx("h3",{className:"session-title text-sm font-medium text-muted-foreground","data-test":"kanban-card-details-session-title",children:"Session Messages"}),I.length>1&&a.jsx(ej,{"data-test":"kanban-card-details-session-navigator",sessionIds:I,currentIndex:S,onIndexChange:C,className:"session-navigator"})]}),a.jsxs(ue,{"data-test":"kanban-card-details-refresh-button",onClick:()=>void le(),size:"sm",variant:"outline",disabled:b,className:"refresh-session-button",children:[a.jsx(On,{className:B("w-4 h-4 mr-2",b&&"animate-spin"),"data-test":"kanban-card-details-refresh-icon"}),b?"Refreshing...":"Refresh"]})]}),a.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden","data-test":"kanban-card-details-chat-messages",children:a.jsx(q0,{"data-test":"kanban-card-details-chat-interface",messages:$,sessionDetails:q,metadata:P,loading:te,pagination:E,onLoadOlder:E&&E.page<E.totalPages?_:void 0})}),a.jsx("div",{className:"chat-input flex-shrink-0","data-test":"kanban-card-details-chat-input",children:a.jsx(K0,{"data-test":"kanban-card-details-message-input",sessionId:M,value:u,onChange:f,onSendSuccess:()=>{F()},onAddOptimisticMessage:V,onRemoveOptimisticMessage:Y})})]}):a.jsx("div",{className:"no-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-no-session",children:"No Claude session found"})]})]})]})}function Cj({isOpen:s,onClose:e,onUpdate:t,triggerPosition:n,initialValues:r}){var c,l,d;const i={claudeProjectPath:((d=(l=(c=ie.getState().app)==null?void 0:c.claude)==null?void 0:l.ui)==null?void 0:d.selectedProjectPath)??void 0,...r};return a.jsx(os,{isVisible:s,onClose:e,title:"Create New Todo",shouldCloseManually:!0,resizable:!0,initialSize:{width:900,height:600},triggerPosition:n??void 0,className:"add-ticket-popover","data-test":"add-ticket-popover",children:a.jsx("div",{"data-test":"add-ticket-popover-content",className:"popover-content flex flex-col h-full overflow-hidden p-4",children:a.jsx(jj,{todo:null,isOpen:s,onClose:e,onUpdate:t,initialValues:i})})})}function wi({onTicketCreated:s,initialValues:e,variant:t="ghost",size:n="icon",className:r="add-ticket-button",title:o="Add New Ticket"}){const[i,c]=h.useState(!1),[l,d]=h.useState(null),p=m=>{const g=m.currentTarget.getBoundingClientRect();d({x:g.left,y:g.top}),c(!0)},u=()=>{c(!1),d(null)},f=()=>{s&&s(),u()};return a.jsxs(a.Fragment,{children:[a.jsx(ue,{variant:t,size:n,onClick:p,title:o,className:r,"data-test":"add-ticket-button",children:a.jsx(Np,{className:"h-5 w-5","data-test":"add-ticket-button-icon"})}),a.jsx(Cj,{isOpen:i,onClose:u,onUpdate:f,triggerPosition:l,initialValues:e,"data-test":"add-ticket-popover"})]})}function Nj({version:s}){const e=Na(),t=bs(),[n,r]=h.useState(!1);if(e.pathname==="/game"||e.pathname==="/new-home")return null;const o=typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port.startsWith("517");if(t)return a.jsxs("header",{"data-test":n?"mobile-header-expanded":"mobile-header-collapsed",className:"sticky top-0 z-50 bg-black text-white shadow-md",children:[a.jsx("div",{className:"overflow-hidden transition-[max-height] duration-300 ease-in-out",style:{maxHeight:n?"200px":"0px"},children:a.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[a.jsx(Jr,{}),o&&a.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qr,{className:Fe.md}),a.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qt,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Mr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?a.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?a.jsxs(a.Fragment,{children:[a.jsx(mo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?a.jsxs(a.Fragment,{children:[a.jsx(go,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?a.jsxs(a.Fragment,{children:[a.jsx(zr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?a.jsxs(a.Fragment,{children:[a.jsx(xo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):a.jsxs(a.Fragment,{children:[a.jsx(Wr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Js,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(vo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Fr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Br,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx($r,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Ur,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Lr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):a.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&a.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),a.jsx(_o,{}),a.jsx(wi,{}),a.jsx(vi,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(wa,{variant:"ghost",size:"icon",icon:a.jsx(Gr,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),a.jsx(Eo,{variant:"ghost",size:"icon"})]})]})}),a.jsx("button",{"data-test":"mobile-header-toggle-btn",onClick:()=>r(!n),className:"w-full h-[10px] flex items-center justify-center active:bg-gray-800 cursor-pointer",children:a.jsx("div",{className:"transition-transform duration-300",style:{transform:n?"rotate(180deg)":"rotate(0deg)"},children:a.jsx(wt,{className:"h-3 w-3 text-gray-400"})})})]});const i=a.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[a.jsx(Jr,{}),o&&a.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qr,{className:Fe.md}),a.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qt,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Mr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?a.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?a.jsxs(a.Fragment,{children:[a.jsx(mo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?a.jsxs(a.Fragment,{children:[a.jsx(go,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?a.jsxs(a.Fragment,{children:[a.jsx(zr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?a.jsxs(a.Fragment,{children:[a.jsx(xo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):a.jsxs(a.Fragment,{children:[a.jsx(Wr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Js,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(vo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Fr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Br,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx($r,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Ur,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Lr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):a.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&a.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),a.jsx(_o,{}),a.jsx(wi,{}),a.jsx(vi,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(wa,{variant:"ghost",size:"icon",icon:a.jsx(Gr,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),a.jsx(Eo,{variant:"ghost",size:"icon"})]})]});return a.jsx("header",{"data-test":"desktop-header",className:"sticky top-0 z-50 bg-black text-white shadow-md",children:i})}function kj(){const s=document.activeElement;if(!s)return null;const e=["INPUT","TEXTAREA"].includes(s.nodeName??""),t=s.contentEditable==="true";return e||t}class Ej{constructor(){ee(this,"shortcuts",new Map);ee(this,"isListening",!1);this.handleKeyDown=this.handleKeyDown.bind(this)}generateShortcutId(e){const t=[];return e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),`${t.join("+")}-${e.key.toLowerCase()}`}handleKeyDown(e){if(kj())return;const t=this.generateShortcutId({key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey}),n=this.shortcuts.get(t);n&&(n.preventDefault!==!1&&e.preventDefault(),n.callback())}register(e){const t=this.generateShortcutId(e);return this.shortcuts.set(t,e),this.isListening||this.startListening(),()=>this.unregister(t)}unregister(e){this.shortcuts.delete(e),this.shortcuts.size===0&&this.stopListening()}unregisterAll(){this.shortcuts.clear(),this.stopListening()}startListening(){this.isListening||(document.addEventListener("keydown",this.handleKeyDown),this.isListening=!0)}stopListening(){this.isListening&&(document.removeEventListener("keydown",this.handleKeyDown),this.isListening=!1)}getRegisteredShortcuts(){return Array.from(this.shortcuts.values())}isShortcutRegistered(e){const t=this.generateShortcutId(e);return this.shortcuts.has(t)}}const Is=new Ej,yi="command-palette-recently-used",Ij=5;function Tj({actions:s=[],placeholder:e="Type a command or search..."}){const[t,n]=h.useState(!1),[r,o]=h.useState(""),[i,c]=h.useState(()=>{try{const u=localStorage.getItem(yi);return u?JSON.parse(u):[]}catch{return[]}});h.useEffect(()=>{const u=Is.register({key:"q",altKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),f=Is.register({key:"p",metaKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),m=Is.register({key:"q",ctrlKey:!0,altKey:!0,preventDefault:!0,callback:()=>{const g=i[0];if(g){const x=s.find(v=>v.id===g);x&&x.action()}}});return()=>{u(),f(),m()}},[i,s]),h.useEffect(()=>{if(!t)return;const u=f=>{if(f.key!=="ArrowUp"&&f.key!=="ArrowDown")return;const m=Array.from(document.querySelectorAll("[cmdk-item]")).filter(b=>b.getAttribute("data-disabled")!=="true");if(m.length===0)return;const g=m.map(b=>b.getAttribute("data-value")||""),x=g.indexOf(r);let v;if(f.key==="ArrowUp"){x<=0&&(f.preventDefault(),f.stopPropagation(),v=m.length-1,o(g[v]));return}else{x>=m.length-1&&(f.preventDefault(),f.stopPropagation(),v=0,o(g[v]));return}};return document.addEventListener("keydown",u,{capture:!0}),()=>document.removeEventListener("keydown",u,{capture:!0})},[t,r]);const l=s.reduce((u,f)=>{const m=f.group??"General";return u[m]||(u[m]=[]),u[m].push(f),u},{}),d=u=>{n(!1),u.action(),c(f=>{const m=f.filter(x=>x!==u.id),g=[u.id,...m].slice(0,Ij);try{localStorage.setItem(yi,JSON.stringify(g))}catch{}return g})},p=i.map(u=>s.find(f=>f.id===u)).filter(u=>u!==void 0);return a.jsxs(Pc,{open:t,onOpenChange:n,value:r,onValueChange:o,"data-test":"command-palette-dialog",children:[a.jsx(lr,{"data-test":"command-palette-input",placeholder:e}),a.jsxs(un,{"data-test":"command-palette-list",children:[a.jsx(pn,{"data-test":"command-palette-empty",children:"No results found."}),p.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(Ts,{heading:"Recently Used","data-test":"command-group-recent",children:p.map(u=>a.jsxs(is,{value:`recent-${u.id}`,onSelect:()=>d(u),className:"command-item flex justify-between items-center","data-test":"command-item-recent",children:[a.jsx("span",{"data-test":"command-item-recent-label",children:u.label}),u.shortcut&&a.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":"command-item-recent-shortcut",children:u.shortcut})]},`recent-${u.id}`))}),a.jsx(ea,{"data-test":"command-separator-recent"})]}),Object.entries(l).map(([u,f],m)=>a.jsxs("div",{"data-test":"command-group-container",children:[m>0&&a.jsx(ea,{"data-test":"command-separator"}),a.jsx(Ts,{heading:u,"data-test":"command-group",children:f.map(g=>a.jsxs(is,{value:g.id,onSelect:()=>d(g),className:"command-item flex justify-between items-center","data-test":"command-item",children:[a.jsx("span",{"data-test":"command-item-label",children:g.label}),g.shortcut&&a.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":"command-item-shortcut",children:g.shortcut})]},g.id))})]},u))]})]})}const Aj=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Pj=s=>(e,t)=>{if(!t)return 1;let n=t,r=e;if(s.matchCase||(n=n.toLowerCase(),r=r.toLowerCase()),s.matchWholeWord)return new RegExp(`\\b${Aj(n)}\\b`,s.matchCase?"":"i").test(e)?1:0;const o=r.includes(n);if(s.mode==="fuzzy"){if(o)return 2;let i=0;for(let c=0;c<r.length&&i<n.length;c++)r[c]===n[i]&&i++;return i===n.length?1:0}else return o?1:0},Rj={matchCase:!1,matchWholeWord:!1,mode:"fuzzy"};function Dj({placeholder:s="Search...",initialOptions:e,onSearchOptionsChange:t,onSearchChange:n,onNavigate:r,className:o}){const[i,c]=h.useState(e??Rj),l=h.useCallback(f=>{c(f),t==null||t(f)},[t]),d=()=>{const f={...i,matchCase:!i.matchCase};l(f)},p=()=>{const f={...i,matchWholeWord:!i.matchWholeWord};l(f)},u=()=>{const f={...i,mode:i.mode==="fuzzy"?"exact":"fuzzy"};l(f)};return a.jsxs("div",{className:B("flex items-center border-b px-3 pr-12",o),"cmdk-input-wrapper":"","data-test":"search-input-with-options",children:[a.jsx(or,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),a.jsx(mt.Input,{"data-test":"search-input",placeholder:s,onValueChange:n,className:"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"}),a.jsxs("div",{className:"flex items-center gap-0.5 shrink-0","data-test":"search-options",children:[a.jsx("button",{type:"button",onClick:d,className:B("p-1.5 rounded hover:bg-accent transition-colors",i.matchCase&&"bg-accent text-accent-foreground"),title:"Match Case (Aa)","data-test":"search-match-case-button",children:a.jsx(kp,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:p,className:B("p-1.5 rounded hover:bg-accent transition-colors",i.matchWholeWord&&"bg-accent text-accent-foreground"),title:"Match Whole Word","data-test":"search-match-whole-word-button",children:a.jsx(Ep,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:u,className:B("p-1.5 rounded hover:bg-accent transition-colors text-xs font-mono",i.mode==="exact"&&"bg-accent text-accent-foreground"),title:i.mode==="fuzzy"?"Fuzzy Search (click for Exact)":"Exact Search (click for Fuzzy)","data-test":"search-mode-button",children:i.mode==="fuzzy"?"Fz":"Ex"}),a.jsx("div",{className:"w-px h-4 bg-border mx-1","data-test":"search-separator"}),a.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("up"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Previous Result (â†‘)","data-test":"search-navigate-up-button",children:a.jsx(ar,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("down"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Next Result (â†“)","data-test":"search-navigate-down-button",children:a.jsx(wt,{className:"h-4 w-4"})})]})]})}function _j(s,e){return{navigateResults:h.useCallback(n=>{const r=Array.from(document.querySelectorAll("[cmdk-item]")).filter(l=>l.getAttribute("data-disabled")!=="true");if(r.length===0)return;const o=r.map(l=>l.getAttribute("data-value")||""),i=o.indexOf(s);let c;n==="up"?c=i<=0?r.length-1:i-1:c=i>=r.length-1?0:i+1,e(o[c])},[s,e])}}function Oj({placeholder:s="Go to node by title or content..."}){const[e,t]=h.useState(!1),[n,r]=h.useState(""),[o,i]=h.useState(""),c=Lt.getState().getGoToSymbolSearch(),[l,d]=h.useState((c==null?void 0:c.options)??{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}),p=h.useCallback(v=>{d(v),Lt.getState().setGoToSymbolSearchOptions(v)},[]),u=h.useMemo(()=>Pj(l),[l]),{navigateResults:f}=_j(n,r),m=h.useMemo(()=>{var w;if(!e)return[];const v=Lt.getState();if(!((w=v.state)!=null&&w.projects))return[];const b=[];return Object.values(v.state.projects).forEach(y=>{Object.values(y.workspaces).forEach(j=>{Object.values(j.canvases).forEach(S=>{(S.coreState.nodes||[]).forEach(N=>{var L;const O=(L=N.data)==null?void 0:L.nodeType;if(O==="workflowOrchestration"||O==="workflowSource")return;const R=N.title||"",k=typeof N.content=="string"?N.content:"",A=k.length>80?k.substring(0,80)+"...":k;!R&&!k||b.push({id:`${S.id}:${N.id}`,nodeId:N.id,canvasId:S.id,title:R||A.substring(0,40)||N.id,contentPreview:A,path:`${y.name} / ${j.name} / ${S.name}`,node:N})})})})}),b},[e]),g=h.useMemo(()=>{const v={};return m.forEach(b=>{v[b.path]||(v[b.path]=[]),v[b.path].push(b)}),v},[m]),x=h.useCallback(v=>{o.trim()&&Lt.getState().addGoToSymbolSearchHistory(o.trim()),t(!1),i("");const b=Lt.getState();b.projectCanvas.switch(v.canvasId),setTimeout(()=>{b.scrollToNode(v.nodeId,500),b.setSelectedNodes([v.node])},50)},[o]);return h.useEffect(()=>{const v=Is.register({key:"o",ctrlKey:!0,preventDefault:!0,callback:()=>t(w=>!w)}),b=Is.register({key:"o",metaKey:!0,preventDefault:!0,callback:()=>t(w=>!w)});return()=>{v(),b()}},[]),h.useEffect(()=>{if(!e)return;const v=b=>{if(b.key!=="ArrowUp"&&b.key!=="ArrowDown")return;const w=Array.from(document.querySelectorAll("[cmdk-item]")).filter(S=>S.getAttribute("data-disabled")!=="true");if(w.length===0)return;const y=w.map(S=>S.getAttribute("data-value")||""),j=y.indexOf(n);if(b.key==="ArrowUp"){j<=0&&(b.preventDefault(),b.stopPropagation(),r(y[w.length-1]));return}else{j>=w.length-1&&(b.preventDefault(),b.stopPropagation(),r(y[0]));return}};return document.addEventListener("keydown",v,{capture:!0}),()=>document.removeEventListener("keydown",v,{capture:!0})},[e,n]),a.jsxs(Pc,{open:e,onOpenChange:t,value:n,onValueChange:r,filter:u,"data-test":"go-to-symbol-dialog",children:[a.jsx(Dj,{placeholder:s,initialOptions:l,onSearchOptionsChange:p,onSearchChange:i,onNavigate:f}),a.jsxs(un,{"data-test":"go-to-symbol-list",children:[a.jsx(pn,{"data-test":"go-to-symbol-empty",children:"No nodes found."}),Object.entries(g).map(([v,b])=>a.jsx(Ts,{heading:v,"data-test":"go-to-symbol-group",children:b.map(w=>a.jsxs(is,{value:`${w.title} ${w.contentPreview} ${w.path}`,onSelect:()=>x(w),className:"flex flex-col items-start gap-0.5","data-test":"go-to-symbol-item",children:[a.jsx("span",{className:"font-medium text-sm","data-test":"go-to-symbol-item-title",children:w.title}),w.contentPreview&&w.title!==w.contentPreview.substring(0,40)&&a.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-full","data-test":"go-to-symbol-item-preview",children:w.contentPreview})]},w.id))},v))]})]})}function Lj(s){const e=s.split(/[/\\]/),t=e.pop()||"",n=/:(\d+)(?::\d+)?$/.exec(t);let r="",o=t;return n&&(r=n[1],o=t.slice(0,n.index)),{dir:e.join("/"),filename:o,line:r}}function Ca(s){return Lj(s).filename}function Mj(s,e,t=300,n=15,r=10,o=200){let i=s+n,c=e+n;return i+t>window.innerWidth&&(i=window.innerWidth-t-r),c+o>window.innerHeight&&(c=window.innerHeight-o-r),i<r&&(i=r),c<r&&(c=r),{left:i,top:c}}function Fj({onElementClicked:s,onElementHovered:e,onInspectorActivated:t,onInspectorDeactivated:n,shouldInspectElement:r,renderTooltip:o,excludeClassNames:i=[],tooltipOwnerId:c,clickOwnerId:l=null}){const[d,p]=h.useState(!1),[u,f]=h.useState(null),m=h.useRef(null),g=h.useRef(s),x=h.useRef(e),v=h.useRef(t),b=h.useRef(n),w=h.useRef(r),y=h.useRef(null),j=h.useRef(null),S=h.useRef(null);h.useEffect(()=>{g.current=s,x.current=e,v.current=t,b.current=n,w.current=r}),h.useEffect(()=>{if(c)return xt.claimTooltip(c),()=>{xt.releaseTooltip(c)}},[c]);const C=h.useMemo(()=>["inspector-tooltip","collected-elements-popover",...i],[i]),N=h.useRef({}),O=h.useCallback(($,...q)=>{const P=Date.now();(!N.current[$]||P-N.current[$]>500)&&(N.current[$]=P,console.log(...q))},[]),R=h.useCallback(($,q="hover")=>{for(const F of C)if($.closest(`.${F}`))return O("class-"+F,`[Inspector:${q}] Excluding by class:`,F,$),!0;const P=["word-extractor-app","word-extractor-app-body","word-extractor-mount","watcher-context-menu"];if($.id&&P.includes($.id))return O("id-"+$.id,`[Inspector:${q}] Excluding by ID:`,$.id,$),!0;if($.closest("#word-extractor-app"))return O("closest-app",`[Inspector:${q}] Excluding by closest #word-extractor-app`,$),!0;const te=$.getRootNode();if(te instanceof ShadowRoot){const F=te.host;if(F&&P.includes(F.id))return O("shadow-host",`[Inspector:${q}] Excluding by shadow DOM host:`,F.id),!0}const E=["custom-capture-controller","custom-capture-content","content-capture-controller","capture-mode-select","custom-selector","field-dialog","array-dialog","draggable-popover-container","draggable-popover-wrapper","schema-panel","preview-panel","watcher-extension-app"];let _=$;for(;_;){const F=_.getAttribute("data-test");if(F){for(const V of E)if(F===V||F.startsWith(V))return!0}_=_.parentElement}return!!(w.current&&!w.current($))},[C,O]),k=h.useCallback($=>{var T;const P=$.composedPath()[0]||$.target;if(P.closest("[data-radix-select-content]")||P.closest("[data-radix-popper-content-wrapper]")||P.closest("[role='option']")||R(P))return;const te=m.current===P;m.current&&!te&&(m.current.style.outline="",m.current.style.outlineOffset=""),P.style.outline="2px solid #06b6d4",P.style.outlineOffset="2px",m.current=P;const E=P.tagName.toLowerCase(),_=Array.from(P.classList),F=P.getAttribute("data-test")||void 0,V=P.getAttribute("data-react-inspector")||void 0,Y={tagName:E,classes:_,dataTest:F,reactInspectorId:V,resolvedPath:void 0,x:$.clientX,y:$.clientY};te?f(W=>W?{...W,x:$.clientX,y:$.clientY}:Y):(f(Y),(T=x.current)==null||T.call(x,P,Y))},[R]),A=h.useCallback($=>{var Y;const P=$.composedPath()[0]||$.target;if(P.closest("[data-radix-select-content]")||P.closest("[data-radix-popper-content-wrapper]")||P.closest("[role='option']")||R(P,"click")||!xt.canHandleClicks(l))return;$.preventDefault(),$.stopPropagation();const te=P.tagName.toLowerCase(),E=Array.from(P.classList),_=P.getAttribute("data-test")||void 0,F=P.getAttribute("data-react-inspector")||void 0,V={tagName:te,classes:E,dataTest:_,reactInspectorId:F,resolvedPath:void 0,x:$.clientX,y:$.clientY};(Y=g.current)==null||Y.call(g,P,V)},[R,l]),L=h.useCallback($=>{$.key==="Escape"&&d&&xt.deactivate()},[d]);h.useEffect(()=>(p(xt.getState()),xt.subscribe(q=>{var P,te;p(q),q?(P=v.current)==null||P.call(v):(te=b.current)==null||te.call(b)})),[]),h.useEffect(()=>{var $;return d?(y.current=k,j.current=A,S.current=L,document.body.style.setProperty("cursor","crosshair","important"),document.addEventListener("mousemove",k),document.addEventListener("click",A,!0),document.addEventListener("keydown",L)):(document.body.style.removeProperty("cursor"),y.current&&document.removeEventListener("mousemove",y.current),j.current&&document.removeEventListener("click",j.current,!0),S.current&&document.removeEventListener("keydown",S.current),f(null),($=x.current)==null||$.call(x,null,null),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)),()=>{document.body.style.removeProperty("cursor"),y.current&&document.removeEventListener("mousemove",y.current),j.current&&document.removeEventListener("click",j.current,!0),S.current&&document.removeEventListener("keydown",S.current),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)}},[d]);const M=u?Mj(u.x,u.y):{left:0,top:0},I=u&&a.jsx("div",{className:"inspector-tooltip fixed z-[9999] bg-black text-white p-3 rounded-lg shadow-xl text-xs font-mono pointer-events-none",style:{left:`${M.left}px`,top:`${M.top}px`,width:"300px"},"data-test":"element-inspector-tooltip",children:a.jsxs("div",{className:"metadata-section space-y-2","data-test":"element-inspector-metadata-section",children:[a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-tag-row",children:[a.jsx(ic,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"Tag"}),a.jsxs("div",{className:"text-blue-300","data-test":"element-inspector-tag-value",children:["<",u.tagName,">"]})]})]}),u.dataTest&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-data-test-row",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"Data Test"}),a.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-data-test-value",children:u.dataTest})]})]}),!u.dataTest&&u.classes.length>0&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-classes-row",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-gray-400 text-[10px]",children:["Classes (",u.classes.length,")"]}),a.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-classes-value",children:u.classes.join(" ")})]})]}),u.reactInspectorId&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-file-row",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Name"}),a.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-name",children:Ca(u.resolvedPath||u.reactInspectorId)}),a.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Path"}),a.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-path",children:u.resolvedPath||u.reactInspectorId||"Resolving..."})]})]}),!u.reactInspectorId&&a.jsxs("div",{className:"metadata-row flex items-start gap-2",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-gray-600"}),a.jsx("div",{children:a.jsx("div",{className:"text-gray-500 text-[10px] italic",children:"No data-react-inspector attribute"})})]})]})}),z=xt.canRenderTooltip(c??null);return a.jsx(a.Fragment,{children:d&&u&&z&&(o?o(u):I)})}async function $j(s){if(!s)return;const n=s.split(":")[0].split("/").pop();if(n)try{return await ha.getFilePath(n)}catch(r){console.error("Failed to resolve inspector path:",r);return}}function Uj({onElementCollected:s,onElementRemoved:e,onElementsCleared:t,renderCollectedItem:n,renderCollectedPanel:r,showDefaultPanel:o=!0,tooltipOwnerId:i,panelOwnerId:c}){const[l,d]=h.useState([]),[p,u]=h.useState(!1),[f,m]=h.useState({x:100,y:100}),g=h.useRef(!1),x=h.useRef({x:0,y:0});h.useEffect(()=>{if(c)return xt.claimPanel(c),()=>{xt.releasePanel(c)}},[c]);const v=h.useCallback((I,z)=>{(async()=>{const q=await $j(z.reactInspectorId)||z.reactInspectorId,P={id:`${Date.now()}-${Math.random()}`,tagName:z.tagName,classes:z.classes,dataTest:z.dataTest,reactInspectorId:z.reactInspectorId,resolvedPath:q,timestamp:Date.now()};d(te=>[...te,P]),s==null||s(P,I),Ee.success("Element collected!",{description:`<${z.tagName}>${q?` [${q}]`:""}`,duration:2e3})})()},[s]),b=h.useCallback(()=>{(l.length>0||p)&&u(!0)},[l.length,p]),w=I=>{I.target.closest(".popover-drag-handle")&&(g.current=!0,x.current={x:I.clientX-f.x,y:I.clientY-f.y})},y=h.useCallback(I=>{g.current&&m({x:I.clientX-x.current.x,y:I.clientY-x.current.y})},[]),j=h.useCallback(()=>{g.current=!1},[]);h.useEffect(()=>(p&&(document.addEventListener("mousemove",y),document.addEventListener("mouseup",j)),()=>{document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",j)}),[p,y,j]),h.useEffect(()=>{const I=z=>{z.key==="Escape"&&p&&u(!1)};return p&&document.addEventListener("keydown",I),()=>{document.removeEventListener("keydown",I)}},[p]);const S=I=>{d(z=>z.filter($=>$.id!==I.id)),e==null||e(I),Ee.info("Element removed from collection")},C=()=>{d([]),u(!1),t==null||t(),Ee.info("All collected elements cleared")},N=()=>{u(!1),d([]),t==null||t()},O=()=>l.map((I,z)=>{const $=I.dataTest?`[data-test="${I.dataTest}"]`:I.classes.length>0?`.${I.classes[0]}`:"",q=I.resolvedPath||"unknown";return`${z+1}. ${I.tagName}${$} inside @${q}`}).join(`
`),R=(I,z)=>a.jsxs("div",{className:"collected-element p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors","data-test":"element-inspector-collected-item",children:[a.jsxs("div",{className:"element-header flex items-center justify-between mb-2","data-test":"element-inspector-collected-item-header",children:[a.jsxs("div",{className:"element-index text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded","data-test":"element-inspector-collected-item-index",children:["#",z+1]}),a.jsx("button",{onClick:()=>S(I),className:"remove-btn p-1 hover:bg-red-100 rounded transition-colors",title:"Remove element","data-test":"element-inspector-collected-item-remove-button",children:a.jsx(Et,{className:"w-4 h-4 text-red-600"})})]}),a.jsxs("div",{className:"element-details space-y-1 text-xs",children:[a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(ic,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-600"}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"Tag:"})," ",a.jsxs("span",{className:"font-mono text-blue-700",children:["<",I.tagName,">"]})]})]}),I.resolvedPath&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-600"}),a.jsxs("div",{children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"File Name:"})," ",a.jsx("span",{className:"font-mono text-purple-700",children:Ca(I.resolvedPath)}),a.jsx(Ns,{textToCopy:Ca(I.resolvedPath),size:"sm"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"File Path:"})," ",a.jsx("span",{className:"font-mono text-purple-700",children:I.resolvedPath}),a.jsx(Ns,{textToCopy:I.resolvedPath,size:"sm"})]})]})]}),I.dataTest&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("span",{className:"text-gray-500",children:"Data Test:"})," ",a.jsx("span",{className:"font-mono text-green-700",children:I.dataTest}),a.jsx(Ns,{textToCopy:I.dataTest,size:"sm"})]})]}),!I.dataTest&&I.classes.length>0&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("span",{className:"text-gray-500",children:["Classes (",I.classes.length,"):"]}),a.jsx("div",{className:"font-mono text-green-700 text-[10px] break-all mt-1",children:I.classes.join(" ")})]})]}),a.jsx("div",{className:"timestamp text-[10px] text-gray-400 mt-2",children:new Date(I.timestamp).toLocaleTimeString()})]})]},I.id),k=a.jsxs("div",{className:"collected-elements-popover fixed z-[9999] bg-white border-2 border-purple-400 rounded-lg shadow-2xl",style:{left:`${f.x}px`,top:`${f.y}px`,width:"550px",maxHeight:"500px"},onMouseDown:w,"data-test":"element-inspector-collected-popover",children:[a.jsxs("div",{className:"popover-drag-handle popover-header bg-purple-500 text-white p-3 rounded-t-lg cursor-move flex items-center justify-between","data-test":"element-inspector-collected-header",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ip,{className:"w-5 h-5"}),a.jsxs("h3",{className:"font-semibold","data-test":"element-inspector-collected-title",children:["Collected Elements (",l.length,")"]})]}),a.jsxs("div",{className:"flex items-center gap-2","data-test":"element-inspector-collected-actions",children:[a.jsx(Ns,{textToCopy:O()}),a.jsx("button",{onClick:N,className:"hover:bg-purple-600 rounded p-1 transition-colors",title:"Close","data-test":"element-inspector-collected-close-button",children:a.jsx(ht,{className:"w-5 h-5"})})]})]}),a.jsxs(Bd,{defaultValue:"list",className:"popover-tabs px-3","data-test":"element-inspector-collected-tabs",children:[a.jsxs(ro,{className:"tabs-list grid w-full grid-cols-2 mt-3","data-test":"element-inspector-collected-tabs-list",children:[a.jsx(an,{value:"list","data-test":"element-inspector-collected-list-tab",children:"List View"}),a.jsx(an,{value:"text","data-test":"element-inspector-collected-text-tab",children:"Text View"})]}),a.jsxs(on,{value:"list",className:"tabs-content m-0","data-test":"element-inspector-collected-list-content",children:[a.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4 space-y-2","data-test":"element-inspector-collected-list",children:l.map((I,z)=>n?n(I,z,()=>R(I,z)):R(I,z))}),a.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-list-footer",children:a.jsxs(ue,{onClick:C,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-clear-all-button",children:[a.jsx(Et,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]}),a.jsxs(on,{value:"text",className:"tabs-content m-0","data-test":"element-inspector-collected-text-content",children:[a.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4","data-test":"element-inspector-collected-text",children:a.jsx("pre",{className:"text-xs font-mono text-gray-800 whitespace-pre-wrap break-words bg-gray-50 p-3 rounded border border-gray-200","data-test":"element-inspector-collected-text-formatted",children:O()})}),a.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-text-footer",children:a.jsxs(ue,{onClick:C,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-text-clear-all-button",children:[a.jsx(Et,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]})]})]}),A=xt.canRenderPanel(c??null),L=o&&p&&l.length>0&&A,M=r?r(l,k):k;return a.jsxs(a.Fragment,{children:[a.jsx(Fj,{tooltipOwnerId:i,onElementClicked:v,onInspectorDeactivated:b}),L&&M]})}const Bj=({...s})=>{const{theme:e="system"}=uu();return a.jsx(pu,{theme:e,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"!text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...s})};function Wj({navigate:s}){return[{id:"nav-home",label:"Go to Home",shortcut:"Ctrl+H",action:()=>s("/"),group:"Navigation"},{id:"nav-chat",label:"Go to Chat",action:()=>s("/chat"),group:"Navigation"},{id:"nav-demo",label:"Go to Demo",action:()=>s("/demo"),group:"Navigation"},{id:"nav-settings",label:"Go to Settings",action:()=>s("/settings"),group:"Navigation"},{id:"nav-todo",label:"Go to Todo",action:()=>s("/todo"),group:"Navigation"},{id:"nav-kanban",label:"Go to Kanban Board",action:()=>s("/todo/kanban"),group:"Navigation"},{id:"nav-content",label:"Go to Content",action:()=>s("/content"),group:"Navigation"},{id:"nav-vocabulary",label:"Go to Vocabulary",action:()=>s("/vocabulary"),group:"Navigation"},{id:"nav-live-transcription",label:"Go to Live Transcription",action:()=>s("/live-transcription"),group:"Navigation"},{id:"nav-claude",label:"Go to Claude",action:()=>s("/claude"),group:"Navigation"},{id:"nav-state",label:"Go to Global State",action:()=>s("/state"),group:"Navigation"},{id:"toggle-element-inspector",label:"Toggle Element Inspector",shortcut:"Ctrl+Shift+I",action:()=>{xt.toggle();const e=xt.getState();Ee.success(`Element Inspector ${e?"activated":"deactivated"}`,{description:e?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})},group:"Tools"},{id:"toggle-fullscreen",label:"Toggle Fullscreen",shortcut:"F11",action:()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{Ee.success("Fullscreen mode deactivated",{duration:2e3})}).catch(e=>{Ee.error("Failed to exit fullscreen",{description:e.message,duration:3e3})}):document.documentElement.requestFullscreen().then(()=>{Ee.success("Fullscreen mode activated",{description:"Press F11 or ESC to exit fullscreen",duration:2e3})}).catch(e=>{Ee.error("Failed to enter fullscreen",{description:e.message,duration:3e3})})},group:"Tools"}]}function zj(){const{logs:s,actions:e}=cc(),t=Na(),n=Si(),[r,o]=h.useState(null);Up({loadOnMount:!0,subscribeToSSE:!0}),Gp({loadOnMount:!0}),qp(),h.useEffect(()=>{localStorage.getItem("VITE_CLEAR_LOGS_ON_RELOAD"),Ge.clientLogsService.clearLogs(),Ge.clientLogsApiClient.clearLogsAndAddVersion("esc-blur-debug.log",1),Ge.clientLogsApiClient.clearLogsAndAddVersion("share-debug.log",1)},[t.pathname]);const i=Wj({navigate:n});return h.useEffect(()=>{(async()=>{})()},[]),h.useEffect(()=>{const c=Is.register({key:"c",callback:()=>{console.clear(),Ee.success("Console cleared",{duration:1500})}});return()=>c()},[]),h.useEffect(()=>{document.title=Mh(t.pathname)},[t.pathname]),a.jsxs(xc,{defaultOpen:!1,children:[a.jsx(Tj,{actions:i}),a.jsx(Oj,{}),a.jsx(Uj,{}),a.jsx(Bj,{}),a.jsx(Bh,{}),a.jsx(bc,{className:"h-screen overflow-hidden",children:a.jsxs("div",{className:"h-full bg-background flex flex-col",children:[t.pathname!=="/stt"&&a.jsx(Nj,{version:r}),a.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:a.jsx(Fh,{logger:e,logs:s})})]})})]})}iu.createRoot(document.getElementById("root")).render(a.jsx(zh,{defaultTheme:"light",storageKey:"watcher-ui-theme",children:a.jsx(cu,{children:a.jsx(zj,{})})}));export{yo as $,Tm as A,pt as B,hn as C,Fa as D,as as E,_l as F,EC as G,hv as H,We as I,pa as J,Ke as K,Se as L,K0 as M,Ue as N,Lt as O,wo as P,So as Q,Dt as R,$t as S,Ud as T,Fe as U,B as V,ky as W,Iy as X,_C as Y,ft as Z,OC as _,ue as a,Zd as a$,xc as a0,vc as a1,wc as a2,yc as a3,ch as a4,lh as a5,uh as a6,Sc as a7,Ws as a8,zs as a9,ut as aA,Qe as aB,_a as aC,Rc as aD,xt as aE,Fj as aF,Uj as aG,Mj as aH,fa as aI,Ve as aJ,rn as aK,Kr as aL,rC as aM,ha as aN,HC as aO,HS as aP,Fc as aQ,lC as aR,it as aS,$g as aT,Ug as aU,Vn as aV,Y0 as aW,L0 as aX,ns as aY,rs as aZ,Vt as a_,bc as aa,Jr as ab,os as ac,qf as ad,Vf as ae,$c as af,Uc as ag,bs as ah,$e as ai,Ct as aj,Oa as ak,dc as al,Wn as am,Mo as an,Hc as ao,zc as ap,dr as aq,$d as ar,xa as as,Xe as at,Gt as au,nn as av,ai as aw,Re as ax,st as ay,nt as az,La as b,Ll as b$,wa as b0,Vd as b1,Kd as b2,Ml as b3,zS as b4,Qp as b5,Xj as b6,Jp as b7,pc as b8,Is as b9,JC as bA,YC as bB,cr as bC,un as bD,pn as bE,Ts as bF,is as bG,af as bH,tu as bI,Zr as bJ,lj as bK,jj as bL,Jt as bM,Zt as bN,ij as bO,Fn as bP,tC as bQ,$n as bR,Un as bS,Zs as bT,Nc as bU,tf as bV,ja as bW,Gs as bX,_n as bY,XC as bZ,em as b_,bo as ba,ss as bb,QC as bc,CC as bd,Yf as be,Ge as bf,Xo as bg,Yo as bh,mr as bi,wi as bj,vi as bk,Gh as bl,BC as bm,FC as bn,$C as bo,UC as bp,DS as bq,LC as br,MC as bs,$S as bt,WC as bu,zC as bv,GC as bw,qC as bx,VC as by,KC as bz,Ma as c,AC as c$,dt as c0,xj as c1,Jx as c2,kj as c3,er as c4,Pr as c5,Rg as c6,Tn as c7,Yc as c8,Dl as c9,oC as cA,Am as cB,sC as cC,wf as cD,sj as cE,eu as cF,eC as cG,cy as cH,SC as cI,Xc as cJ,Z as cK,nC as cL,Kf as cM,Jf as cN,Qf as cO,Zf as cP,iC as cQ,cC as cR,NC as cS,kC as cT,xC as cU,Hh as cV,gC as cW,vC as cX,mC as cY,wC as cZ,DC as c_,hC as ca,Kv as cb,Ua as cc,hg as cd,uC as ce,pC as cf,fC as cg,Mv as ch,dC as ci,ul as cj,us as ck,_g as cl,Dm as cm,Mg as cn,Pn as co,Rn as cp,vs as cq,Jo as cr,Yj as cs,fs as ct,jC as cu,IC as cv,yC as cw,iw as cx,jn as cy,aC as cz,Hf as d,RC as d0,eo as d1,PC as d2,ub as d3,Pj as d4,_j as d5,Pc as d6,Dj as d7,ea as d8,Lg as d9,bC as da,hc as db,fc as dc,Qj as dd,Zj as de,TC as df,fn as e,bt as f,dn as g,It as h,Kt as i,Tt as j,Oe as k,_t as l,Bd as m,ro as n,an as o,on as p,Jc as q,tj as r,q0 as s,ao as t,Up as u,jr as v,Ye as w,tt as x,ie as y,Le as z};
