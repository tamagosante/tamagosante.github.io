var pe=Object.defineProperty;var fe=(a,e,t)=>e in a?pe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var M=(a,e,t)=>fe(a,typeof e!="symbol"?e+"":e,t);import{K as me,aJ as he,ac as ae,bb as oe,aY as ne,aZ as ie,a_ as le,az as ge,aA as xe,aB as be}from"./index-CJ-Awmlc.js";import{r as q,j as r}from"./react-vendor-Byz07MLO.js";import{T as B,a2 as K,as as de,y as ye}from"./icons-Detj0uxE.js";import{a as ve}from"./string-4WCj7OpV.js";class G{static toWorkflowNode(e,t){const s=e.data,o=(s==null?void 0:s.nodeType)||this.CANVAS_TYPE_TO_NODE_TYPE[e.type]||"unknown",n={...(s==null?void 0:s.parameters)||{}};e.content&&(n._nodeContent=e.content);let i=(s==null?void 0:s.inputHandles)||[],d=(s==null?void 0:s.outputHandles)||[];if(t){const h=t.get(o);h&&(h.inputs&&(i=h.inputs.map(c=>({id:c.id,name:c.name,type:"input",dataType:c.dataType}))),h.outputs&&(d=h.outputs.map(c=>({id:c.id,name:c.name,type:"output",dataType:c.dataType}))))}return{id:e.id,type:o,parameters:n,inputHandles:i,outputHandles:d,executionState:s==null?void 0:s.executionState,executionData:s==null?void 0:s.executionData}}static toWorkflowNodes(e,t){return e.filter(s=>{const o=s.data,n=o&&o.nodeType&&o.nodeType!=="unknown",i=this.CANVAS_TYPE_TO_NODE_TYPE[s.type]!==void 0;return n||i}).map(s=>this.toWorkflowNode(s,t))}static toWorkflowConnection(e){const t=e.startNodeId||"",s=e.endNodeId||"";let o;if(e.endRowId)o=`input_${e.endRowId}`;else if(e.label){const n=e.label.match(/step\s+(\d+)/i);n?o=`input_row_${n[1]}`:o=`handle-${s}-in`}else o=`handle-${s}-in`;return{id:e.id,sourceNodeId:t,sourceHandleId:`handle-${t}-out`,targetNodeId:s,targetHandleId:o,isValid:!0,dataType:"any"}}static toWorkflowConnections(e){const t=new Map;return e.forEach(s=>{const o=s.endNodeId||"";t.has(o)||t.set(o,[]),t.get(o).push(s)}),e.map(s=>{const o=s.startNodeId||"",n=s.endNodeId||"";let i=`handle-${n}-in`;if(s.endRowId)i=`input_${s.endRowId}`;else if(s.label){const d=s.label.match(/step\s+(\d+)/i);d?i=`input_row_${d[1]}`:i=`handle-${n}-in`}else{const d=t.get(n)||[];if(d.findIndex(c=>c.id===s.id)>=0){const c=new Set;d.forEach(w=>{if(w.label){const j=w.label.match(/step\s+(\d+)/i);j&&c.add(parseInt(j[1]))}});let S=1;for(const w of d)if(!(w.label&&w.label.match(/step\s+(\d+)/i))){for(;c.has(S);)S++;if(w.id===s.id){i=`input_row_${S}`;break}c.add(S),S++}}else i=`handle-${n}-in`}return{id:s.id,sourceNodeId:o,sourceHandleId:`handle-${o}-out`,targetNodeId:n,targetHandleId:i,isValid:!0,dataType:"any"}})}static fromWorkflowNode(e,t){return{id:e.id,x:(t==null?void 0:t.x)??0,y:(t==null?void 0:t.y)??0,type:me.RECT,data:{nodeType:e.type,parameters:e.parameters,inputHandles:e.inputHandles,outputHandles:e.outputHandles,executionState:e.executionState,executionData:e.executionData}}}static fromWorkflowConnection(e){return{id:e.id,startNodeId:e.sourceNodeId,endNodeId:e.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}}}M(G,"CANVAS_TYPE_TO_NODE_TYPE",{WORKFLOW_SOURCE:"workflowSource",WORKFLOW_ORCHESTRATION:"workflowOrchestration"});class we{constructor(){M(this,"definitions",new Map)}register(e){this.definitions.set(e.type,e)}get(e){return this.definitions.get(e)}getAll(){return Array.from(this.definitions.values())}getByCategory(e){return this.getAll().filter(t=>t.category===e)}search(e){if(!e||e.trim()==="")return[];const t=e.toLowerCase();return this.getAll().filter(s=>{var o;return!!(s.name.toLowerCase().includes(t)||s.description.toLowerCase().includes(t)||(o=s.tags)!=null&&o.some(n=>n.toLowerCase().includes(t)))})}has(e){return this.definitions.has(e)}unregister(e){this.definitions.delete(e)}clear(){this.definitions.clear()}}class Ne{constructor(e="workflow-executions"){M(this,"storageKey");this.storageKey=e}async save(e){const t=await this.loadAll();t[e.id]=this.serializeExecution(e),this.saveAll(t)}async get(e){const s=(await this.loadAll())[e];return s?this.deserializeExecution(s):null}async listByWorkflow(e,t){const s=await this.loadAll(),o=Object.values(s).filter(n=>n.workflowId===e).map(n=>this.deserializeExecution(n)).sort((n,i)=>new Date(i.startTime).getTime()-new Date(n.startTime).getTime());return t?o.slice(0,t):o}async listRecent(e){const t=await this.loadAll(),s=Object.values(t).map(o=>this.deserializeExecution(o)).sort((o,n)=>new Date(n.startTime).getTime()-new Date(o.startTime).getTime());return e?s.slice(0,e):s}async delete(e){const t=await this.loadAll();delete t[e],this.saveAll(t)}async deleteByWorkflow(e){const t=await this.loadAll(),s=Object.entries(t).filter(([o,n])=>n.workflowId!==e).reduce((o,[n,i])=>({...o,[n]:i}),{});this.saveAll(s)}async clear(){localStorage.removeItem(this.storageKey)}async loadAll(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch(e){return console.error("Failed to load executions from localStorage:",e),{}}}saveAll(e){try{const t=JSON.stringify(e);localStorage.setItem(this.storageKey,t)}catch(t){throw console.error("Failed to save executions to localStorage:",t),new Error("Failed to save executions: localStorage quota may be exceeded")}}serializeExecution(e){return{...e,nodeExecutions:e.nodeExecutions?Array.from(e.nodeExecutions.entries()):[]}}deserializeExecution(e){return{...e,nodeExecutions:new Map(Array.isArray(e.nodeExecutions)?e.nodeExecutions:[])}}}class Se{constructor(e,t){this.nodeRegistry=e,this.executionStore=t}async executeWorkflow(e,t,s,o,n){const i={workflowId:this.generateId("workflow"),executionId:this.generateId("execution"),startTime:new Date().toISOString(),status:"running",executionData:new Map,errors:[],allCanvasNodes:s,selectedNodes:n};try{if(e.length===0)return i.status="completed",i;const d=this.findTriggerNode(e,o),h=this.computeExecutionOrder(e,t,d);return await this.executeNodesInOrder(h,t,i),i.errors.length===0?i.status="completed":i.status="failed",await this.saveExecutionRecord(i,e),i}catch(d){return i.status="failed",i.errors.push({nodeId:i.currentNodeId||"unknown",message:d instanceof Error?d.message:String(d),timestamp:new Date().toISOString(),stack:d instanceof Error?d.stack:void 0}),i}}findTriggerNode(e,t){if(t){const o=e.find(n=>n.id===t);if(!o)throw new Error(`Specified trigger node '${t}' not found`);return o}const s=e.filter(o=>{const n=this.nodeRegistry.get(o.type);return(n==null?void 0:n.category)==="trigger"});if(s.length===0){const o=e.filter(n=>{const i=this.nodeRegistry.get(n.type);return(i==null?void 0:i.type)==="workflowOrchestration"});if(o.length===0)throw new Error("No trigger node found in workflow");if(o.length>1)throw new Error("Multiple orchestration nodes found - specify which one to execute");return o[0]}if(s.length>1)throw new Error("Multiple trigger nodes found in workflow");return s[0]}computeExecutionOrder(e,t,s){const o=new Map,n=new Map;e.forEach(x=>{o.set(x.id,[]),n.set(x.id,[])}),t.forEach(x=>{const g=o.get(x.sourceNodeId)||[];g.push(x.targetNodeId),o.set(x.sourceNodeId,g);const T=n.get(x.targetNodeId)||[];T.push(x.sourceNodeId),n.set(x.targetNodeId,T)});const i=new Set,d=[s.id],h=new Set;for(;d.length>0;){const x=d.shift();if(h.has(x))continue;h.add(x),i.add(x),(n.get(x)||[]).forEach(T=>{h.has(T)||d.push(T)})}const c=new Map;i.forEach(x=>{c.set(x,0)}),t.forEach(x=>{i.has(x.sourceNodeId)&&i.has(x.targetNodeId)&&c.set(x.targetNodeId,(c.get(x.targetNodeId)||0)+1)});const S=[];i.forEach(x=>{c.get(x)===0&&S.push(x)});const w=[],j=new Set;for(;S.length>0;){const x=S.shift();if(j.has(x))continue;j.add(x);const g=e.find(b=>b.id===x);if(!g)continue;w.push(g),(o.get(x)||[]).forEach(b=>{if(!i.has(b))return;const $=c.get(b)||0;c.set(b,$-1),c.get(b)===0&&!j.has(b)&&S.push(b)})}if(j.size<i.size)throw new Error("Circular dependency detected in workflow");return w}async executeNodesInOrder(e,t,s){var o;for(const n of e){s.currentNodeId=n.id;try{const i=this.nodeRegistry.get(n.type);if(!i)throw new Error(`Node type '${n.type}' not found in registry`);const d=this.getInputDataForNode(n,t,s),h=await i.executor(n,d,s);s.executionData.set(n.id,h)}catch(i){const d={nodeId:n.id,message:i instanceof Error?i.message:String(i),timestamp:new Date().toISOString(),stack:i instanceof Error?i.stack:void 0};if(s.errors.push(d),!((o=n.parameters)!=null&&o.continueOnError))break}}}getInputDataForNode(e,t,s){const o=t.filter(d=>d.targetNodeId===e.id);if(o.length===0)return null;const n=e.inputHandles&&e.inputHandles.length>1;if(o.length===1&&!n){const d=o[0];return s.executionData.get(d.sourceNodeId)}const i=new Map;return o.forEach(d=>{const h=s.executionData.get(d.sourceNodeId);h!==void 0&&i.set(d.targetHandleId,{_sourceNodeId:d.sourceNodeId,_data:h})}),i}async saveExecutionRecord(e,t){const s={id:e.executionId,workflowId:e.workflowId,startTime:e.startTime,endTime:new Date().toISOString(),duration:Date.now()-new Date(e.startTime).getTime(),status:e.status,nodeExecutions:new Map,errors:e.errors};t.forEach(o=>{const n=e.executionData.get(o.id);n!==void 0&&s.nodeExecutions.set(o.id,{nodeId:o.id,nodeType:o.type,startTime:e.startTime,endTime:new Date().toISOString(),status:"success",input:{},output:n})}),await this.executionStore.save(s)}generateId(e){return`${e}-${Date.now()}-${Math.random().toString(36).substring(7)}`}}const je={type:"manualTrigger",category:"trigger",name:"Manual Trigger",description:"Manually start the workflow with a button click",parameters:[{name:"label",displayName:"Button Label",type:"string",required:!1,default:"Execute Workflow",placeholder:"Enter button label",description:"Label for the trigger button"}],inputs:[],outputs:[{id:"output_main",name:"Trigger Output",dataType:"object",required:!1}],executor:async(a,e,t)=>{const o={value:a.parameters._nodeContent||"",timestamp:new Date().toISOString(),executionId:t.executionId,triggeredBy:"manual"};return a.parameters.label&&(o.label=a.parameters.label),o},version:1,author:"System"},Te={type:"textInput",category:"data",name:"Text Input",description:"Collect text input from user",version:1,parameters:[{name:"label",displayName:"Input Label",type:"string",required:!0,default:"Enter text",description:"Label shown to the user"},{name:"placeholder",displayName:"Placeholder",type:"string",required:!1,default:"",description:"Placeholder text in input field"},{name:"defaultValue",displayName:"Default Value",type:"string",required:!1,default:"",description:"Pre-filled value"}],inputs:[{id:"input_main",name:"Trigger",dataType:"any",required:!1}],outputs:[{id:"output_main",name:"User Input",dataType:"string",required:!0}],executor:async(a,e,t)=>({value:a.parameters._nodeContent||a.parameters.defaultValue||"John Doe",label:a.parameters.label,timestamp:new Date().toISOString()})},Ie={type:"textOutput",category:"data",name:"Text Output",description:"Display formatted text output",version:1,parameters:[{name:"template",displayName:"Output Template",type:"string",required:!1,default:"Result: {{input}}",description:"Template for output. Use {{input}} for input data"}],inputs:[{id:"input_main",name:"Data",dataType:"any",required:!0}],outputs:[{id:"output_main",name:"Formatted Output",dataType:"string",required:!0}],executor:async(a,e,t)=>{let o=a.parameters.template||"Result: {{input}}";if(e&&typeof e=="object"){const n=e.value||e.formattedOutput||e.output||e.label||JSON.stringify(e);o=o.replace(/\{\{input\}\}/g,n)}else o=o.replace(/\{\{input\}\}/g,String(e||""));return{output:o,formattedOutput:o,timestamp:new Date().toISOString()}}},Ee={type:"workflowSource",category:"data",name:"Workflow Source",description:"Provide static data as workflow source",version:1,parameters:[{name:"displayFormat",displayName:"Display Format",type:"string",required:!1,default:"json",description:"How to display the data (json, text)"}],inputs:[],outputs:[{id:"output_main",name:"Source Data",dataType:"object",required:!0}],executor:async(a,e,t)=>{const s=a.parameters._nodeContent||"";let o;try{o=JSON.parse(s)}catch{o=s}return{value:s,output:o,timestamp:new Date().toISOString()}}},Q={toLowerCase:{args:0,fn:a=>a.toLowerCase()},toUpperCase:{args:0,fn:a=>a.toUpperCase()},trim:{args:0,fn:a=>a.trim()},trimStart:{args:0,fn:a=>a.trimStart()},trimEnd:{args:0,fn:a=>a.trimEnd()},toString:{args:0,fn:a=>String(a)},length:{args:0,fn:a=>a.length},capitalize:{args:0,fn:a=>a.charAt(0).toUpperCase()+a.slice(1)},trimSymbolsLight:{args:0,fn:a=>{const e=/^[\s.,!?;:\-_@#$%^&*()[\]{}<>/\\|~`+'"]+|[\s.,!?;:\-_@#$%^&*()[\]{}<>/\\|~`+'"]+$/g;return a.replace(e,"").trim()}},trimSymbolsStrict:{args:0,fn:a=>{const e=/^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$/g;return a.replace(e,"").trim()}},charAt:{args:1,fn:(a,e)=>a.charAt(parseInt(e,10)||0)},split:{args:1,fn:(a,e)=>a.split(e)},startsWith:{args:1,fn:(a,e)=>a.startsWith(e)},endsWith:{args:1,fn:(a,e)=>a.endsWith(e)},includes:{args:1,fn:(a,e)=>a.includes(e)},indexOf:{args:1,fn:(a,e)=>a.indexOf(e)},padStart:{args:1,fn:(a,e)=>a.padStart(parseInt(e,10)||0)},padEnd:{args:1,fn:(a,e)=>a.padEnd(parseInt(e,10)||0)},repeat:{args:1,fn:(a,e)=>a.repeat(parseInt(e,10)||0)},slice:{args:2,fn:(a,e,t)=>a.slice(parseInt(e,10)||0,t?parseInt(t,10):void 0)},substring:{args:2,fn:(a,e,t)=>a.substring(parseInt(e,10)||0,t?parseInt(t,10):void 0)},replace:{args:2,fn:(a,e,t)=>a.replace(e,t||"")},padStartWith:{args:2,fn:(a,e,t)=>a.padStart(parseInt(e,10)||0,t||" ")},padEndWith:{args:2,fn:(a,e,t)=>a.padEnd(parseInt(e,10)||0,t||" ")}};function ce(a,e){a=a.trim();try{let t=e,s=a;for(;s.length>0;){const o=s.match(/^\.([a-zA-Z_][a-zA-Z0-9_]*)\(([^)]*)\)/);if(o){const i=o[1],d=o[2];if(Q[i]){const h=Q[i],c=d?d.split(",").map(w=>w.trim()):[],S=t==null?"":String(t);try{t=h.fn(S,...c)}catch{}}s=s.slice(o[0].length);continue}const n=s.match(/^\.?([a-zA-Z_][a-zA-Z0-9_]*)/);if(n){const i=n[1];t=t==null?void 0:t[i],s=s.slice(n[0].length);continue}if(s.startsWith("[")){let i=0,d=-1;for(let c=0;c<s.length;c++)if(s[c]==="["&&i++,s[c]==="]"&&(i--,i===0)){d=c;break}if(d===-1)break;const h=s.slice(1,d);if(/^\d+$/.test(h)){const c=parseInt(h,10);t=t==null?void 0:t[c]}else{const c=ce(h,e);t=t==null?void 0:t[c]}s=s.slice(d+1);continue}break}return t??""}catch{return""}}const ee=["workflowOrchestration","workflowSource","WORKFLOW_ORCHESTRATION","WORKFLOW_SOURCE"];function ue(a){var s;const e=a.type,t=(s=a.data)==null?void 0:s.nodeType;return ee.includes(e)||ee.includes(t)}function Y(a){return a.filter(e=>!ue(e))}function ke(a,e,t,s,o,n){const d=ce(a,{loop:e||{},source:t||{},if:s||{},node:o||{},selection:{count:0,nodes:[]}});return d==null?"":typeof d=="object"?JSON.stringify(d):String(d)}function V(a,e,t,s,o,n){return a?a.replace(/\{\{([^}]+)\}\}/g,(d,h)=>ke(h,e,t,s,o)):""}function Z(a,e,t,s,o,n){if(typeof a=="string")return V(a,e,t,s,o);if(Array.isArray(a))return a.map(i=>Z(i,e,t,s,o));if(a&&typeof a=="object"){const i={};for(const d in a)i[d]=Z(a[d],e,t,s,o);return i}return a}function Oe(){return`tag_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function _e(a){return!a||typeof a!="string"?[]:a.split(/,\s*/).map(e=>e.trim()).filter(e=>e.length>0).map(e=>({id:Oe(),title:e}))}function te(a){const e={};for(const[t,s]of Object.entries(a))t==="tags"&&typeof s=="string"?e[t]=_e(s):e[t]=s;return e}const Ce={type:"workflowOrchestration",category:"logic",name:"Workflow",description:"Orchestrate multiple inputs in a specific order",version:1,parameters:[{name:"rows",displayName:"Workflow Steps",type:"json",required:!1,default:[{id:"row_1",label:"Step 1",order:1},{id:"row_2",label:"Step 2",order:2}],description:"Define workflow steps and their order"}],inputs:[{id:"input_row_1",name:"Step 1 Input",dataType:"any",required:!1},{id:"input_row_2",name:"Step 2 Input",dataType:"any",required:!1}],outputs:[{id:"output_main",name:"Combined Output",dataType:"object",required:!0}],executor:async(a,e,t)=>{const s=a.parameters.rows||[{id:"row_1",label:"Step 1",order:1},{id:"row_2",label:"Step 2",order:2}];let o;e instanceof Map?o=e:e&&typeof e=="object"?o=new Map(Object.entries(e)):o=new Map;function n(l){const N=[];return l.forEach(v=>{N.push(v),v.children&&Array.isArray(v.children)&&N.push(...n(v.children))}),N}const i=n(s),d=[];i.forEach(l=>{const N=`input_${l.id}`,v=o.get(N);if(v!==void 0||["nodeUpdate","if","loop","toolbarAction"].includes(l.stepType)){const F=v==null?void 0:v._sourceNodeId,W=(v==null?void 0:v._data)!==void 0?v._data:v;d.push({label:l.label,data:W,order:l.order,sourceNodeId:F,stepType:l.stepType||"empty",config:l.config})}}),d.sort((l,N)=>l.order-N.order);const h=d.find(l=>l.stepType==="source");let c=[],S;if(h){const l=typeof h.data=="object"&&h.data!==null?h.data.value||h.data.output||h.data.formattedOutput||h.data:String(h.data);if(typeof l=="string")try{const N=JSON.parse(l);S=N,Array.isArray(N)?c=N:c=Object.values(N)}catch{l.includes(`
`)?c=l.split(`
`).filter(N=>N.trim()):c=[l]}else Array.isArray(l)?c=l:typeof l=="object"&&l!==null?(S=l,c=Object.values(l)):c=[l]}const w=t.selectedNodes||[];w.length;let j=null,x=null,g=new Map;const T=[];for(const l of d){if(j===!1&&l.stepType!=="if"){T.push({...l,skipped:!0,skipReason:"if_condition_false"});continue}if(l.stepType==="source"){T.push({...l,sourceData:c,sourceCount:c.length});continue}if(l.stepType==="loop"){const N=c.length>0?c:[];N.length===0&&d.forEach(v=>{if(v.order!==l.order&&v.stepType!=="source"){const E=typeof v.data=="object"&&v.data!==null?v.data.value||v.data.output||v.data.formattedOutput||JSON.stringify(v.data):String(v.data);N.push(E)}}),T.push({...l,loopValues:N,loopCount:N.length});continue}if(l.stepType==="if"){const N=l.config||{},{field:v,operator:E,expectedValue:F}=N,W=c.length>0?{current:c[0],index:1,total:c.length,values:c}:void 0,p=V(F||"",W,S);let f=!1,u=[];t.allCanvasNodes&&Array.isArray(t.allCanvasNodes)&&Y(t.allCanvasNodes).forEach(_=>{let I;v&&v.includes(".")?I=v.split(".").reduce((C,D)=>C==null?void 0:C[D],_):I=_[v];let m=!1;const O=String(I??""),A=String(p);switch(E){case"equals":m=O===A;break;case"notEquals":m=O!==A;break;case"contains":m=O.includes(A);break;case"notContains":m=!O.includes(A);break;case"matches":case"notMatches":case"matchAndRemove":{const R=/^\/(.+)\/([gimsuvy]*)$/.exec(p);if(R)try{const C=R[1],D=R[2],L=new RegExp(C,D),H=O.match(L),J=H!==null;if(E==="matchAndRemove"){if(m=J,m){const X=O.replace(L,"").trim(),z=g.get(_.id);g.set(_.id,{capture:(z==null?void 0:z.capture)||(H?Array.from(H):[]),result:X})}}else if(m=E==="matches"?J:!J,m&&H&&/\((?!\?)/.test(C)){const z=g.get(_.id);g.set(_.id,{capture:Array.from(H),result:z==null?void 0:z.result})}}catch{m=!1}else if(E==="matchAndRemove"){if(m=O.includes(p),m){const C=O.split(p).join("").trim(),D=g.get(_.id);g.set(_.id,{capture:(D==null?void 0:D.capture)||[],result:C})}}else{const C=O.includes(p);m=E==="matches"?C:!C}break}case"greaterThan":m=Number(I)>Number(p);break;case"lessThan":m=Number(I)<Number(p);break;case"greaterThanOrEqual":m=Number(I)>=Number(p);break;case"lessThanOrEqual":m=Number(I)<=Number(p);break;default:m=!1}m&&(f=!0),u.push({nodeId:_.id,fieldValue:I,matches:m})}),j=f;const y=u.filter(k=>k.matches);x=y.length>0?new Set(y.map(k=>k.nodeId)):null,T.push({...l,conditionResult:f,checkedNodes:u,config:{...N,evaluatedExpectedValue:p}});continue}if(l.stepType==="toolbarAction"){const N=l.config||{},{facadeKey:v,actionId:E,params:F}=N;if(!v||!E){console.warn("WorkflowNode: toolbarAction step missing facadeKey or actionId",N),T.push({...l,error:"Missing facadeKey or actionId"});continue}const{globalFacadeRegistry:W}=await he(async()=>{const{globalFacadeRegistry:f}=await import("./globalFacadeRegistry-BlelMPVg.js");return{globalFacadeRegistry:f}},[]),p=W.get(v);if(!p){console.warn(`WorkflowNode: Facade "${v}" not found in registry`),T.push({...l,error:`Facade "${v}" not found`});continue}try{p.execute(E,F||{}),await new Promise(f=>setTimeout(f,100)),T.push({...l,executed:!0,facadeKey:v,actionId:E,params:F});continue}catch(f){console.error(`WorkflowNode: Error executing ${v}.${E}:`,f),T.push({...l,error:f instanceof Error?f.message:String(f)});continue}}if(l.stepType==="nodeUpdate"){const N=l.config||{},v=l.order>=10,E=[],p=(N.simpleFieldUpdates||[]).some(u=>u.template&&/\{\{[^}]*node\.[^}]+\}\}/.test(u.template))?Y(t.allCanvasNodes||[]):c.length>0?c:w.length>0?w:Y(t.allCanvasNodes||[]),f=v&&p.length>0?p.length:1;for(let u=0;u<f;u++){const y=p.length>0?{current:p[u],index:u+1,total:p.length,values:p}:void 0;t.allCanvasNodes&&Array.isArray(t.allCanvasNodes)&&Y(t.allCanvasNodes).forEach(m=>{if(x&&!x.has(m.id))return;const O=g.has(m.id)?g.get(m.id):void 0,A={};let R=!1;if(m.title&&typeof m.title=="string"&&/\{\{[^}]+\}\}/.test(m.title)){const D=V(m.title,y,S,O,m);A.title=D,R=!0}m.content&&typeof m.content=="string"&&/\{\{[^}]+\}\}/.test(m.content)&&(A.content=V(m.content,y,S,O,m),R=!0),R&&E.push({nodeId:m.id,updates:A})});const k=N.simpleFieldUpdates||[];if(k.length>0&&y&&y.current&&y.current.id){const I=g.has(y.current.id)?g.get(y.current.id):void 0,m={};k.forEach(R=>{const{field:C,template:D}=R,L=V(D,y,S,I,y.current);m[C]=L});const O=te(m),A=E.find(R=>R.nodeId===y.current.id);A?Object.assign(A.updates,O):E.push({nodeId:y.current.id,updates:O})}(N.targets||[]).forEach(I=>{var D;if(y&&y.current&&y.current.id&&I.nodeId!==y.current.id||x&&!x.has(I.nodeId))return;const m=g.has(I.nodeId)?g.get(I.nodeId):void 0,O=(D=t.allCanvasNodes)==null?void 0:D.find(L=>L.id===I.nodeId),A=E.find(L=>L.nodeId===I.nodeId),R=Z(I.updates,y,S,m,O),C=te(R);A?Object.assign(A.updates,C):E.push({nodeId:I.nodeId,updates:C})})}T.push({...l,nodeUpdates:E,loopContext:void 0});continue}T.push(l)}const b=[];T.forEach(l=>{if(l.stepType==="nodeUpdate"&&"nodeUpdates"in l&&!("skipped"in l)){const N=l.nodeUpdates.filter(v=>{var F;const E=(F=t.allCanvasNodes)==null?void 0:F.find(W=>W.id===v.nodeId);return E?!ue(E):!0});b.push(...N)}});const $={steps:T,stepCount:T.length,timestamp:new Date().toISOString(),sourceData:c,hasSource:c.length>0,nodeUpdates:b},P=T.map(l=>{const N=l.sourceNodeId?` ← ${l.sourceNodeId}`:" (not connected)";return`${l.label}${N}`}).join(`
`),U=T.map(l=>l.stepType==="source"&&"sourceData"in l?`Source: ${l.sourceCount} items
${l.sourceData.join(`
`)}`:l.stepType==="loop"&&"loopValues"in l?l.loopValues.map((v,E)=>`[${E+1}] ${v}`).join(`
`):typeof l.data=="object"&&l.data!==null?l.data.value||l.data.output||l.data.formattedOutput||JSON.stringify(l.data):String(l.data)).join(`
`);return{...$,rowConnections:P,formattedOutput:U}}};class Le{constructor(){M(this,"nodes",[]);M(this,"arrows",[]);M(this,"nodeRegistry");M(this,"executionStore");M(this,"executionService");this.nodeRegistry=new we,this.executionStore=new Ne,this.executionService=new Se(this.nodeRegistry,this.executionStore),this.registerDefaultNodes()}registerDefaultNodes(){this.nodeRegistry.register(je),this.nodeRegistry.register(Te),this.nodeRegistry.register(Ie),this.nodeRegistry.register(Ee),this.nodeRegistry.register(Ce)}loadWorkflow(e,t){this.nodes=e,this.arrows=t}async executeWorkflow(e,t){var o;const s=Date.now();try{const n=G.toWorkflowNodes(this.nodes,this.nodeRegistry),i=G.toWorkflowConnections(this.arrows),d=await this.executionService.executeWorkflow(n,i,this.nodes,e,t),h=this.buildNodeStates(d,n);let c=[];const S=Array.from(h.entries()).find(([w,j])=>{const x=n.find(b=>b.id===w),g=(x==null?void 0:x.type)==="workflowOrchestration",T=!!j.executionData;return g&&(w===e||T)});if(S){const[w,j]=S;c=((o=j.executionData)==null?void 0:o.nodeUpdates)||[]}return{success:d.status==="completed",executionId:d.executionId,duration:Date.now()-s,executedNodeCount:d.executionData.size,errors:d.errors.map(w=>({nodeId:w.nodeId,message:w.message})),nodeStates:h,nodeUpdates:c}}catch(n){return{success:!1,error:n instanceof Error?n.message:String(n),errors:[],duration:Date.now()-s}}}buildNodeStates(e,t){const s=new Map;return t.forEach(o=>{const n=e.errors.some(c=>c.nodeId===o.id),i=e.executionData.has(o.id),d=n?"error":i?"success":"idle",h=e.executionData.get(o.id);s.set(o.id,{executionState:d,executionData:h})}),s}async getExecutionHistory(e=10){return await this.executionStore.listRecent(e)}async getExecution(e){return await this.executionStore.get(e)}async clearHistory(){await this.executionStore.clear()}getRegisteredNodeTypes(){return this.nodeRegistry.getAll().map(e=>e.type)}}const se=[{value:"title",label:"Title",type:"string"},{value:"content",label:"Content",type:"string"},{value:"tags",label:"Tags",type:"tags"},{value:"x",label:"X Position",type:"number"},{value:"y",label:"Y Position",type:"number"},{value:"width",label:"Width",type:"number"},{value:"height",label:"Height",type:"number"},{value:"styles.backgroundColor",label:"Background Color",type:"string"},{value:"styles.textColor",label:"Text Color",type:"string"},{value:"styles.fontSize",label:"Font Size",type:"string"},{value:"styles.fontWeight",label:"Font Weight",type:"string"},{value:"isPinned",label:"Is Pinned",type:"boolean"}],ze=({isVisible:a,onClose:e,allNodes:t,currentConfig:s,onSave:o,initialPosition:n,initialSize:i})=>{const[d,h]=q.useState((s==null?void 0:s.mode)||"simple"),[c,S]=q.useState(()=>s!=null&&s.simpleFieldUpdates&&s.simpleFieldUpdates.length>0?s.simpleFieldUpdates:s!=null&&s.simpleConfig?[{field:s.simpleConfig.field,template:s.simpleConfig.template}]:[{field:"content",template:"{{loop.current}}"}]),[w,j]=q.useState(()=>(s==null?void 0:s.mode)==="advanced"&&(s!=null&&s.targets)?s.targets.map(p=>({nodeId:p.nodeId,fields:Object.entries(p.updates).map(([f,u])=>({field:f,value:String(u)}))})):[]),x=()=>{S([...c,{field:"content",template:"{{loop.current}}"}])},g=p=>{c.length!==1&&S(c.filter((f,u)=>u!==p))},T=(p,f)=>{S(c.map((u,y)=>y===p?{...u,field:f}:u))},b=(p,f)=>{S(c.map((u,y)=>y===p?{...u,template:f}:u))},$=()=>{const p=c.filter(u=>u.template.trim());if(p.length===0)return;const f=t.map(u=>({nodeId:u.id,fields:p.map(({field:y,template:k})=>({field:y,value:k}))}));j(f)},P=()=>{j([...w,{nodeId:"",fields:[{field:"title",value:""}]}])},U=p=>{j(w.filter((f,u)=>u!==p))},l=(p,f)=>{const u=[...w];u[p].nodeId=f,j(u)},N=p=>{const f=[...w];f[p].fields.push({field:"title",value:""}),j(f)},v=(p,f)=>{const u=[...w];u[p].fields=u[p].fields.filter((y,k)=>k!==f),j(u)},E=(p,f,u)=>{const y=[...w];y[p].fields[f].field=u,j(y)},F=(p,f,u)=>{const y=[...w];y[p].fields[f].value=u,j(y)},W=()=>{let p=[];if(d==="simple"){const f=c.filter(u=>u.template.trim());if(f.length===0)return;p=t.map(u=>{const y={};return f.forEach(({field:k,template:_})=>{if(k.includes(".")){const I=k.split(".");let m=y;for(let O=0;O<I.length-1;O++)m[I[O]]||(m[I[O]]={}),m=m[I[O]];m[I[I.length-1]]=_}else y[k]=_}),{nodeId:u.id,updates:y}})}else if(p=w.filter(f=>f.nodeId&&f.fields.length>0).map(f=>{const u={};return f.fields.forEach(({field:y,value:k})=>{if(k)if(y.includes(".")){const _=y.split(".");let I=u;for(let m=0;m<_.length-1;m++)I[_[m]]||(I[_[m]]={}),I=I[_[m]];I[_[_.length-1]]=k}else u[y]=k}),{nodeId:f.nodeId,updates:u}}),p.length===0)return;o({mode:d,dataSource:(s==null?void 0:s.dataSource)||"row_1",targets:p,simpleFieldUpdates:d==="simple"?c:void 0}),e()};return r.jsx(ae,{isVisible:a,onClose:e,title:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{children:"Configure Node Update"}),r.jsx(oe,{children:r.jsxs(ne,{children:[r.jsx(ie,{asChild:!0,children:r.jsx(de,{size:14,className:"text-muted-foreground cursor-help"})}),r.jsx(le,{side:"right",className:"max-w-xs",children:r.jsxs("div",{className:"text-xs space-y-1",children:[r.jsxs("div",{children:[r.jsx("strong",{children:"Loop:"})," ",r.jsx("code",{children:"{{loop.current}}"}),", ",r.jsx("code",{children:"{{loop.index}}"}),", ",r.jsx("code",{children:"{{loop.total}}"})]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Node:"})," ",r.jsx("code",{children:"{{node.title}}"}),", ",r.jsx("code",{children:"{{node.content}}"})]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Lookup:"})," ",r.jsx("code",{children:"{{source[node.title]}}"})]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Methods:"})," ",r.jsx("code",{children:"{{node.title.toLowerCase()}}"}),", ",r.jsx("code",{children:".toUpperCase()"}),", ",r.jsx("code",{children:".trim()"})]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Combined:"})," ",r.jsx("code",{children:"{{source[node.title.toLowerCase()]}}"})]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Tags:"})," Comma-separated values are split into array"]})]})})]})})]}),shouldCloseManually:!0,resizable:!0,initialSize:i||{width:500,height:400},triggerPosition:n,children:r.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[r.jsxs("div",{className:"flex border-b border-border",children:[r.jsx("button",{onClick:()=>h("simple"),className:`flex-1 px-4 py-2 text-sm font-medium transition-colors ${d==="simple"?"border-b-2 border-primary text-primary bg-accent/50":"text-muted-foreground hover:text-foreground hover:bg-accent/30"}`,children:"Simple"}),r.jsx("button",{onClick:()=>h("advanced"),className:`flex-1 px-4 py-2 text-sm font-medium transition-colors ${d==="advanced"?"border-b-2 border-primary text-primary bg-accent/50":"text-muted-foreground hover:text-foreground hover:bg-accent/30"}`,children:"Advanced"})]}),r.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto p-4 space-y-4",children:d==="simple"?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:["Update the same fields across ",r.jsx("strong",{children:"all nodes"})," (",t.length," nodes)"]}),c.map((p,f)=>r.jsx("div",{className:"space-y-2",children:r.jsxs("div",{className:"flex gap-3 items-end",children:[r.jsxs("div",{className:"w-1/3",children:[f===0&&r.jsx("label",{className:"text-sm font-medium block mb-2",children:"Field to Update"}),r.jsx("select",{value:p.field,onChange:u=>T(f,u.target.value),className:"w-full text-sm border border-border rounded px-3 py-2 bg-background",children:se.map(u=>r.jsx("option",{value:u.value,children:u.label},u.value))})]}),r.jsxs("div",{className:"w-2/3",children:[f===0&&r.jsx("label",{className:"text-sm font-medium block mb-2",children:"Template Value"}),r.jsx("input",{type:"text",value:p.template,onChange:u=>b(f,u.target.value),placeholder:"e.g., {{loop.current}} or New: {{loop.current}}",className:"w-full text-sm border border-border rounded px-3 py-2 bg-background"})]}),c.length>1&&r.jsx("button",{onClick:()=>g(f),className:"p-2 rounded hover:bg-destructive/10 text-destructive mb-0.5",title:"Remove field",children:r.jsx(B,{size:16})})]})},f)),r.jsxs("button",{onClick:x,className:"w-full text-sm flex items-center justify-center gap-2 py-2 border border-dashed border-border rounded hover:bg-accent",children:[r.jsx(K,{size:16})," Add Field"]})]}):r.jsxs(r.Fragment,{children:[w.length===0&&c.some(p=>p.template.trim())&&r.jsxs("div",{className:"bg-muted/50 border border-border rounded-lg p-3",children:[r.jsxs("div",{className:"text-sm mb-2",children:[r.jsx("strong",{children:"Start from Simple Mode?"}),r.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Import ",c.filter(p=>p.template.trim()).length," field update(s) for all ",t.length," nodes"]})]}),r.jsxs("button",{onClick:$,className:"w-full text-sm flex items-center justify-center gap-2 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90",children:[r.jsx(K,{size:16})," Import from Simple Mode"]})]}),w.map((p,f)=>r.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("span",{className:"text-sm font-semibold",children:["Target ",f+1]}),r.jsx("button",{onClick:()=>U(f),className:"p-1 rounded hover:bg-destructive/10 text-destructive",title:"Remove target",children:r.jsx(B,{size:14})})]}),r.jsxs("div",{children:[r.jsx("label",{className:"text-xs font-medium block mb-1",children:"Node"}),r.jsxs("select",{value:p.nodeId,onChange:u=>l(f,u.target.value),className:"w-full text-sm border border-border rounded px-2 py-1 bg-background",children:[r.jsx("option",{value:"",children:"Select node..."}),t.map(u=>r.jsx("option",{value:u.id,children:u.title||u.id},u.id))]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-xs font-medium block",children:"Fields to Update"}),p.fields.map((u,y)=>r.jsxs("div",{className:"flex gap-2",children:[r.jsx("select",{value:u.field,onChange:k=>E(f,y,k.target.value),className:"flex-1 text-xs border border-border rounded px-2 py-1 bg-background",children:se.map(k=>r.jsx("option",{value:k.value,children:k.label},k.value))}),r.jsx("input",{type:"text",value:u.value,onChange:k=>F(f,y,k.target.value),placeholder:"Value or template",className:"flex-1 text-xs border border-border rounded px-2 py-1 bg-background"}),r.jsx("button",{onClick:()=>v(f,y),className:"p-1 rounded hover:bg-destructive/10 text-destructive",title:"Remove field",disabled:p.fields.length===1,children:r.jsx(B,{size:14})})]},y)),r.jsxs("button",{onClick:()=>N(f),className:"text-xs flex items-center gap-1 text-primary hover:underline",children:[r.jsx(K,{size:12})," Add Field"]})]})]},f)),r.jsxs("button",{onClick:P,className:"w-full text-sm flex items-center justify-center gap-2 py-2 border border-dashed border-border rounded hover:bg-accent",children:[r.jsx(K,{size:16})," Add Target Node"]})]})}),r.jsxs("div",{className:"border-t border-border p-3 flex justify-end gap-2",children:[r.jsx("button",{"data-test":"node-update-config-cancel-button",onClick:e,className:"px-3 py-1.5 text-sm border border-border rounded hover:bg-accent",children:"Cancel"}),r.jsx("button",{"data-test":"node-update-config-save-button",onClick:W,className:"px-3 py-1.5 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90",children:"Save"})]})]})})},Ae=[{value:"title",label:"Title",type:"string"},{value:"content",label:"Content",type:"string"},{value:"x",label:"X Position",type:"number"},{value:"y",label:"Y Position",type:"number"},{value:"width",label:"Width",type:"number"},{value:"height",label:"Height",type:"number"},{value:"isPinned",label:"Is Pinned",type:"boolean"}],re=[{value:"equals",label:"Equals",description:"Exact match (===)",group:"comparison"},{value:"notEquals",label:"Not Equals",description:"Not an exact match (!==)",group:"comparison"},{value:"contains",label:"Contains",description:"Field includes the value",group:"comparison"},{value:"notContains",label:"Not Contains",description:"Field does not include the value",group:"comparison"},{value:"greaterThan",label:"Greater Than",description:"Numeric comparison (>)",group:"comparison"},{value:"lessThan",label:"Less Than",description:"Numeric comparison (<)",group:"comparison"},{value:"greaterThanOrEqual",label:"Greater Or Equal",description:"Numeric comparison (>=)",group:"comparison"},{value:"lessThanOrEqual",label:"Less Or Equal",description:"Numeric comparison (<=)",group:"comparison"},{value:"matches",label:"Matches",description:"Field matches regex pattern (use /pattern/)",group:"regex"},{value:"notMatches",label:"Not Matches",description:"Field does not match regex pattern",group:"regex"},{value:"matchAndRemove",label:"Match & Remove",description:"Remove regex match, result in {{if.result}}",group:"regex"}],Re=[{id:"comparison",label:"Comparison"},{id:"regex",label:"Regex"}],qe=({isVisible:a,onClose:e,currentConfig:t,onSave:s,initialPosition:o,initialSize:n})=>{var x;const[i,d]=q.useState((t==null?void 0:t.field)||"title"),[h,c]=q.useState((t==null?void 0:t.operator)||"equals"),[S,w]=q.useState((t==null?void 0:t.expectedValue)||""),j=()=>{if(!S.trim())return;s({field:i,operator:h,expectedValue:S}),e()};return r.jsx(ae,{isVisible:a,onClose:e,title:r.jsxs("div",{"data-test":"if-step-config-title",className:"flex items-center gap-2",children:[r.jsx("span",{children:"Configure If Condition"}),r.jsx(oe,{children:r.jsxs(ne,{children:[r.jsx(ie,{asChild:!0,children:r.jsx(de,{"data-test":"if-step-config-info-icon",size:14,className:"text-muted-foreground cursor-help"})}),r.jsx(le,{side:"right",className:"max-w-xs","data-test":"if-step-config-tooltip",children:r.jsxs("div",{className:"text-xs space-y-1",children:[r.jsxs("div",{children:[r.jsx("strong",{children:"Templates:"})," Use ",r.jsx("code",{children:"{{users}}"}),", ",r.jsx("code",{children:"{{count}}"})," in expected value"]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Example:"})," title contains ",r.jsx("code",{children:"{{loop.current}}"})]})]})})]})})]}),shouldCloseManually:!0,resizable:!0,initialSize:n||{width:400,height:320},triggerPosition:o,children:r.jsxs("div",{"data-test":"if-step-config-container",className:"flex flex-col flex-1 h-full overflow-scroll",children:[r.jsxs("div",{"data-test":"if-step-config-content",className:"flex-1 min-h-0 overflow-y-auto p-4 space-y-4",children:[r.jsx("div",{"data-test":"if-step-config-info-banner",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:"Check if a field meets a specific condition"}),r.jsxs("div",{"data-test":"if-step-config-field-section",children:[r.jsx("label",{"data-test":"if-step-config-field-label",className:"text-sm font-medium block mb-2",children:"Field to Check"}),r.jsx("select",{"data-test":"if-step-config-field-select",value:i,onChange:g=>d(g.target.value),className:"w-full text-sm border border-border rounded px-3 py-2 bg-background",children:Ae.map(g=>r.jsx("option",{value:g.value,"data-test":"if-step-config-field-option",children:g.label},g.value))})]}),r.jsxs("div",{"data-test":"if-step-config-operator-section",children:[r.jsx("label",{"data-test":"if-step-config-operator-label",className:"text-sm font-medium block mb-2",children:"Operator"}),r.jsx("select",{"data-test":"if-step-config-operator-select",value:h,onChange:g=>c(g.target.value),className:"w-full text-sm border border-border rounded px-3 py-2 bg-background",children:Re.map(g=>r.jsx("optgroup",{label:g.label,"data-test":"if-step-config-operator-group",children:re.filter(T=>T.group===g.id).map(T=>r.jsx("option",{value:T.value,"data-test":"if-step-config-operator-option",children:T.label},T.value))},g.id))}),r.jsx("p",{"data-test":"if-step-config-operator-description",className:"text-xs text-muted-foreground mt-1",children:(x=re.find(g=>g.value===h))==null?void 0:x.description})]}),r.jsxs("div",{"data-test":"if-step-config-value-section",children:[r.jsx("label",{"data-test":"if-step-config-value-label",className:"text-sm font-medium block mb-2",children:"Operator Value"}),r.jsx("input",{"data-test":"if-step-config-value-input",type:"text",value:S,onChange:g=>w(g.target.value),placeholder:"e.g., {{users}}, Alice, or /pattern/",className:"w-full text-sm border border-border rounded px-3 py-2 bg-background"}),r.jsxs("p",{"data-test":"if-step-config-value-hint",className:"text-xs text-muted-foreground mt-1",children:["Supports templates ","{{users}}",", ","{{count}}",", ","{{loop.current}}"," and regex /pattern/"]})]})]}),r.jsxs("div",{"data-test":"if-step-config-footer",className:"border-t border-border p-3 flex justify-end gap-2",children:[r.jsx("button",{"data-test":"if-step-config-cancel-button",onClick:e,className:"px-3 py-1.5 text-sm border border-border rounded hover:bg-accent",children:"Cancel"}),r.jsx("button",{"data-test":"if-step-config-save-button",onClick:j,className:"px-3 py-1.5 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-primary",disabled:!S.trim(),children:"Save"})]})]})})},He=-28,Ve=["source"],De=["loop","nodeUpdate","transform","condition","if"],Fe=[{id:"source",label:"Source",description:"Provides data for downstream steps"},{id:"loop",label:"Loop",description:"Iterate through source data"},{id:"nodeUpdate",label:"Node Update",description:"Update any node fields with loop data"},{id:"if",label:"If",description:"Conditional check on node fields"},{id:"transform",label:"Transform",description:"Transform input data"},{id:"condition",label:"Condition",description:"Conditional branching"},{id:"empty",label:"Empty",description:"Pass through data unchanged"}],Ke=({row:a,node:e,nodes:t,incomingArrows:s,selectedRowId:o,configPopoverOpen:n,rowElementsRef:i,onRowClick:d,onConfigureRow:h,onDeleteRow:c,onSelectedRowIdChange:S})=>{const w=ve(a.id,2,2),j=a.stepType||"empty",x=s.find(b=>b.endRowId===a.id);let g="";if(x){const b=t.find(P=>P.id===x.startNodeId);g=`${(b==null?void 0:b.title)||(b==null?void 0:b.content)||x.startNodeId}`}else De.includes(j)?g=a.label||`${w}`:j==="source"?g=`${w} (not connected)`:g=a.label||`${w}`;if(j==="nodeUpdate"&&a.config){const b=a.config.targets||[];if(b.length>0){const $=new Set;b.forEach(U=>{U.updates&&Object.keys(U.updates).forEach(l=>{typeof U.updates[l]=="object"&&l==="styles"?Object.keys(U.updates[l]).forEach(N=>{$.add(`${l}.${N}`)}):$.add(l)})});const P=Array.from($);if(P.length>0){const U=P.slice(0,2).join(", "),l=P.length>2?`, +${P.length-2}`:"";g+=` → ${U}${l}`}}}return g=(a.order!=null?`${a.order}. `:"")+g,a.id,r.jsx("div",{ref:b=>{b&&i.current.set(a.id,b)},"data-workflow-row":`${e.id}:${a.id}`,className:"relative p-1.5 bg-background rounded border transition-all duration-200 hover:shadow-md hover:border-primary hover:-translate-y-0.5",children:r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsx("span",{className:"flex-1",children:g}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsxs(ge,{onOpenChange:b=>{S(b?a.id:null)},children:[r.jsx(xe,{asChild:!0,children:r.jsx("button",{"data-test":"workflow-step-type-button",onClick:b=>{b.stopPropagation()},className:"text-[10px] px-1 py-0.5 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-colors cursor-pointer",title:"Change step type",children:j})}),o===a.id&&r.jsxs(be,{className:"w-64 p-2",side:"right",align:"start",children:[r.jsx("div",{className:"text-xs font-semibold mb-2 text-muted-foreground",children:"Select Step Type"}),r.jsx("div",{className:"space-y-1",children:Fe.map(b=>r.jsxs("button",{onClick:()=>h(a.id,b.id),className:"w-full text-left p-2 text-xs hover:bg-accent rounded flex flex-col",children:[r.jsx("div",{className:"font-semibold",children:b.label}),r.jsx("div",{className:"text-[10px] text-muted-foreground",children:b.description})]},b.id))})]})]}),(j==="nodeUpdate"||j==="if")&&r.jsx("button",{"data-test":"workflow-row-config-button",onClick:b=>{b.stopPropagation(),b.preventDefault(),d(a.id,b,"gear")},className:"p-1 hover:bg-accent rounded transition-colors",title:"Configure step",children:r.jsx(ye,{size:12,className:"text-muted-foreground"})}),r.jsx("button",{"data-test":"workflow-row-delete-button",onClick:b=>{b.stopPropagation(),b.preventDefault(),c(a.id)},className:"p-1 hover:bg-destructive/10 text-destructive rounded transition-colors",title:"Delete step",children:r.jsx(B,{size:12})})]})]})})};export{He as C,qe as I,ze as N,Ve as S,Le as W,Ke as a,ce as e};
