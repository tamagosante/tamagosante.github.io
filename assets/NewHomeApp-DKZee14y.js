import{j as a,r as f}from"./react-vendor-Byz07MLO.js";import{a as M}from"./ui-utils-BxIQ3qGg.js";import{a as N,aF as Y,J as C,ac as X,T as me,bj as $,bk as ie,N as L,bl as J,aj as ge,L as xe,bm as K,P as ye,S as ve,h as Ce,i as we,j as be,k as Se,Q as je,ay as Ne,R as Pe,I as Te,bn as Ue,bo as ze,b2 as Ae,bp as ke}from"./index-eHP58yiE.js";import{t as A}from"./utils-DJ2ViQ2u.js";import{bv as Ee,aj as Ie,D as Le,C as le,e as ce,be as Re,T as de,h as ue,o as Oe,w as De,q as Be}from"./icons-vtiX7BHn.js";import{c as Me,s as _e,u as B,E as q,a as He,C as We}from"./CanvasAppV2-Sc1Hz9kO.js";import{initializeDefaultUsers as $e,loadActiveUserId as Ve,saveCurrentUser as I,saveActiveUserId as pe,savePresets as E,createTimestamp as _,generateId as Q,loadPresets as Z,saveUsers as O,loadCurrentUser as Fe,loadUsers as Xe}from"./userStoreLocalStorage-D-7v21rP.js";import{switchCanvasStateForUser as Ge}from"./userCanvasStateStorage-B5aouBzz.js";import"./radix-ui-v9Pxfv0s.js";import"./VimInputHandlerV2-DJs-ook4.js";import"./logging-DNAPNJun.js";import"./string-4WCj7OpV.js";import"./clipboardHtmlToMarkdown-BNZmEbgs.js";import"./UiButtonWithExpandOption-h1AbWOIL.js";import"./TextareaPopoverAtCursor-BhwkV6wH.js";import"./cursorPosition-otMhJ5rZ.js";import"./definitionHelper-DuYF3Asi.js";import"./DraggableCrudTree-CyO8j1zi.js";import"./DragDropManager-KcuPnjwl.js";import"./treeHelpers-DUv_6quS.js";import"./globalFacadeRegistry-BlelMPVg.js";import"./WorkflowRowItem-iqt932NO.js";import"./UiDataTable-BJzbkTin.js";import"./react-hooks-rjLLAVfy.js";import"./markdownToHtml-C-4HvgxL.js";import"./DraggableTree-Dr3LK8bf.js";import"./useOcr-BhvO77pd.js";import"./alert-D9C8hSnn.js";import"./JsonViewerApp-BHZpouoC.js";import"./easy-form-DAFxRHyz.js";import"./forms-B7OAPNGv.js";import"./form-DxSbN1YK.js";import"./SessionSidebar-BExSPAHd.js";import"./SlashCommandMenu-DAHzvOSL.js";import"./MobileSheet-8BahCbCX.js";const Ye=({variant:e="ghost",size:r="icon",className:s,iconClassName:t="h-5 w-5",showTooltip:n=!0})=>{const o=()=>{Y.toggle();const i=Y.getState();A.success(`Element Inspector ${i?"activated":"deactivated"}`,{description:i?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};return a.jsx(N,{variant:e,size:r,onClick:o,className:s,title:n?"Toggle Element Inspector (Ctrl+Shift+I)":void 0,"aria-label":"Toggle Element Inspector","data-test":"element-inspector-button",children:a.jsx(Ee,{className:t})})},ee=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const r=Math.random()*16|0;return(e==="x"?r:r&3|8).toString(16)}),Je=1,V="cs:",he={[C.RECT]:0,[C.TEXT]:1,[C.TEXTCARD]:2,[C.DRAWING]:3,[C.CHAT]:4},Ke={0:C.RECT,1:C.TEXT,2:C.TEXTCARD,3:C.DRAWING,4:C.CHAT},R=e=>e.slice(0,8),qe=e=>{if(typeof e=="string")return e;if(typeof e=="number")return String(e);e!=null},Qe=e=>{var n;const r=he[e.type];if(r===void 0)return null;const s={i:R(e.id),x:Math.round(e.x),y:Math.round(e.y),t:r};e.width&&(s.w=Math.round(e.width)),e.height&&(s.h=Math.round(e.height));const t=qe(e.content);if(t&&(s.c=t),e.title&&(s.l=e.title),e.type===C.DRAWING&&e.data){const o=e.data,i=Me(o,30);s.d=Ze(i)}if(e.type===C.CHAT&&e.data){const o=e.data;(n=o.childNodeIds)!=null&&n.length&&(s.ch=o.childNodeIds.map(R))}return s},Ze=e=>{var s;return(s=e.elements)!=null&&s.length?{el:e.elements.map(t=>{const n={t:t.type==="freehand"?"f":"s",c:t.style.strokeColor,w:t.style.strokeWidth};return t.type==="freehand"&&t.stroke?n.p=_e(t.stroke.smoothedPath,0):t.type==="shape"&&t.shape&&(n.st={t:t.shape.shapeType,s:[Math.round(t.shape.startPoint.x),Math.round(t.shape.startPoint.y)],e:[Math.round(t.shape.endPoint.x),Math.round(t.shape.endPoint.y)]}),n}),iw:e.intrinsicWidth?Math.round(e.intrinsicWidth):void 0,ih:e.intrinsicHeight?Math.round(e.intrinsicHeight):void 0}:void 0},et=e=>({i:R(e.id),s:e.startNodeId?R(e.startNodeId):null,e:e.endNodeId?R(e.endNodeId):null,sp:[Math.round(e.startPoint.x),Math.round(e.startPoint.y)],ep:[Math.round(e.endPoint.x),Math.round(e.endPoint.y)],l:e.label||void 0}),tt=(e,r)=>{const s=e.filter(o=>he[o.type]!==void 0).map(Qe).filter(o=>o!==null),t=new Set(s.map(o=>o.i)),n=r.filter(o=>{const i=!o.startNodeId||t.has(R(o.startNodeId)),d=!o.endNodeId||t.has(R(o.endNodeId));return i&&d}).map(et);return{v:Je,n:s,a:n}},te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",D="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",st=e=>{let r="";const s=e.length;for(let t=0;t<s;t+=3){const n=e[t],o=t+1<s?e[t+1]:0,i=t+2<s?e[t+2]:0,d=n<<16|o<<8|i;r+=D[d>>18&63],r+=D[d>>12&63],t+1<s&&(r+=D[d>>6&63]),t+2<s&&(r+=D[d&63])}return r},nt=e=>{const r={};for(let c=0;c<D.length;c++)r[D[c]]=c;for(let c=0;c<te.length;c++)r[te[c]]=c;const s=e.replace(/[\s=]+/g,""),t=s.length,n=t%4,i=Math.floor(t/4)*3+(n===0?0:n-1),d=new Uint8Array(i);let u=0;for(let c=0;c<t;c+=4){const l=r[s[c]]??0,h=c+1<t?r[s[c+1]]??0:0,m=c+2<t?r[s[c+2]]??0:0,y=c+3<t?r[s[c+3]]??0:0,b=l<<18|h<<12|m<<6|y;u<i&&(d[u++]=b>>16&255),c+2<t&&u<i&&(d[u++]=b>>8&255),c+3<t&&u<i&&(d[u++]=b&255)}return d},at=async(e,r)=>{const s=tt(e,r),t=JSON.stringify(s),o=new TextEncoder().encode(t),i=new CompressionStream("gzip"),d=i.writable.getWriter();await d.write(o),await d.close();const u=[],c=i.readable.getReader();for(;;){const{done:v,value:U}=await c.read();if(v)break;u.push(U)}const l=u.reduce((v,U)=>v+U.length,0),h=new Uint8Array(l);let m=0;for(const v of u)h.set(v,m),m+=v.length;const y=st(h),b=V+y;return{url:b,stats:{nodeCount:s.n.length,arrowCount:s.a.length,rawSize:t.length,compressedSize:b.length,compressionRatio:Math.round((1-b.length/t.length)*100)}}},se=async e=>{const r=e.trim();if(!r.startsWith(V))return null;try{const s=r.slice(V.length),t=nt(s),n=new DecompressionStream("gzip"),o=n.writable.getWriter();await o.write(t),await o.close();const i=[],d=n.readable.getReader();for(;;){const{done:m,value:y}=await d.read();if(m)break;i.push(y)}const u=i.reduce((m,y)=>m+y.length,0),c=new Uint8Array(u);let l=0;for(const m of i)c.set(m,l),l+=m.length;const h=new TextDecoder().decode(c);return JSON.parse(h)}catch{return null}},ne=e=>{const r=new Map,s=e.n.map(n=>{const o=ee();r.set(n.i,o);const i={id:o,x:n.x,y:n.y,type:Ke[n.t]??C.RECT};return n.w&&(i.width=n.w),n.h&&(i.height=n.h),n.c&&(i.content=n.c),n.l&&(i.title=n.l),n.d&&(i.data=rt(n.d)),i});e.n.forEach((n,o)=>{var i;if((i=n.ch)!=null&&i.length){const d=n.ch.map(u=>r.get(u)).filter(u=>u!==void 0);s[o].data={...s[o].data||{},childNodeIds:d,viewMode:"canvas"}}});const t=e.a.map(n=>({id:ee(),startNodeId:n.s?r.get(n.s)??null:null,endNodeId:n.e?r.get(n.e)??null:null,startPoint:{x:n.sp[0],y:n.sp[1]},endPoint:{x:n.ep[0],y:n.ep[1]},label:n.l}));return{nodes:s,arrows:t}},rt=e=>({elements:e.el.map(s=>s.t==="f"&&s.p?{type:"freehand",stroke:{points:[],smoothedPath:s.p},style:{strokeColor:s.c,strokeWidth:s.w,strokeStyle:"solid"}}:s.t==="s"&&s.st?{type:"shape",shape:{shapeType:s.st.t,startPoint:{x:s.st.s[0],y:s.st.s[1]},endPoint:{x:s.st.e[0],y:s.st.e[1]}},style:{strokeColor:s.c,strokeWidth:s.w,strokeStyle:"solid"}}:{type:"freehand",stroke:{points:[],smoothedPath:""},style:{strokeColor:s.c,strokeWidth:s.w,strokeStyle:"solid"}}),intrinsicWidth:e.iw,intrinsicHeight:e.ih}),ot=({isOpen:e,onClose:r,triggerPosition:s})=>{const[t,n]=f.useState(""),[o,i]=f.useState(!1),[d,u]=f.useState(null),[c,l]=f.useState(null),h=B(g=>{var x;return((x=g.projectCanvas.getActive())==null?void 0:x.coreState.nodes)??q}),m=B(g=>{var x;return((x=g.projectCanvas.getActive())==null?void 0:x.coreState.arrows)??q}),y=B(g=>g.setNodes),b=B(g=>g.arrow.setAll);f.useEffect(()=>{if(!(t!=null&&t.startsWith("cs:"))){l(null);return}(async()=>{try{const x=await se(t);if(!x){l({textCount:0,drawingCount:0,chatCount:0,arrowCount:0,isValid:!1});return}const{nodes:S,arrows:j}=ne(x),P=S.filter(w=>w.type===C.RECT||w.type===C.TEXT||w.type===C.TEXTCARD).length,p=S.filter(w=>w.type===C.DRAWING).length,T=S.filter(w=>w.type===C.CHAT).length;l({textCount:P,drawingCount:p,chatCount:T,arrowCount:j.length,isValid:!0})}catch{l({textCount:0,drawingCount:0,chatCount:0,arrowCount:0,isValid:!1})}})()},[t]);const v=f.useCallback(async()=>{var g;try{const{url:x,stats:S}=await at(h,m);if((g=navigator.clipboard)!=null&&g.writeText)await navigator.clipboard.writeText(x);else{const j=document.createElement("textarea");j.value=x,j.style.position="fixed",j.style.left="-9999px",j.style.top="0",document.body.appendChild(j),j.focus(),j.select();const P=document.execCommand("copy");if(document.body.removeChild(j),!P)throw new Error("Copy command failed")}u(S),i(!0),setTimeout(()=>i(!1),2e3),A.success("Canvas copied!",{description:`${S.nodeCount} nodes, ${S.arrowCount} arrows (${S.compressionRatio}% smaller)`})}catch(x){A.error("Failed to copy",{description:x instanceof Error?x.message:"Unknown error"})}},[h,m]),U=f.useCallback(async()=>{if(t.startsWith("cs:"))try{const g=await se(t);if(!g){A.error("Invalid share data");return}const{nodes:x,arrows:S}=ne(g),j=x.filter(w=>w.type===C.RECT||w.type===C.TEXT||w.type===C.TEXTCARD).length,P=x.filter(w=>w.type===C.DRAWING).length,p=x.filter(w=>w.type===C.CHAT).length;x.length>0&&y(w=>[...w,...x]),S.length>0&&b(w=>[...w,...S]);const T=[];j>0&&T.push(`${j} text`),P>0&&T.push(`${P} drawings`),p>0&&T.push(`${p} chats`),S.length>0&&T.push(`${S.length} arrows`),A.success("Canvas imported!",{description:`Added ${T.join(", ")}`}),n(""),l(null),r()}catch(g){A.error("Failed to import",{description:g instanceof Error?g.message:"Invalid data"})}},[t,y,b,r]),k=a.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:v,title:"Copy canvas to clipboard","data-test":"canvas-share-copy-button",children:o?a.jsx(le,{size:14,className:"text-green-500"}):a.jsx(ce,{size:14})});return a.jsx(X,{isVisible:e,onClose:r,title:"Share Canvas",triggerPosition:s,initialSize:{width:400,height:300},resizable:!0,headerActions:k,showPinButton:!1,showInspectorButton:!1,anchorOrigin:"top-right",children:a.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full","data-test":"canvas-share-content",children:[d&&a.jsxs("div",{className:"text-xs text-muted-foreground bg-muted/50 rounded p-2","data-test":"canvas-share-stats",children:["Last copy: ",d.nodeCount," nodes, ",d.arrowCount," arrows",a.jsx("br",{}),"Size: ",d.rawSize," â†’ ",d.compressedSize," bytes (",d.compressionRatio,"% reduction)"]}),a.jsxs("div",{className:"flex flex-col gap-1 flex-1 min-h-0",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("label",{className:"text-xs font-medium",htmlFor:"paste-input",children:"Paste to import:"}),t&&a.jsx("button",{type:"button",onClick:()=>n(""),className:"text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"canvas-share-clear-button",children:"Clear"})]}),a.jsx(me,{id:"paste-input",placeholder:"Paste cs:... data here",value:t,onChange:g=>n(g.target.value),className:"flex-1 min-h-[80px] text-xs font-mono resize-none","data-test":"canvas-share-paste-input"}),c&&a.jsx("div",{className:"flex items-center justify-between gap-2 mt-1","data-test":"canvas-share-import-preview",children:c.isValid?a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"text-xs text-muted-foreground",children:[c.textCount>0&&`${c.textCount} text`,c.drawingCount>0&&`${c.drawingCount} drawings`,c.chatCount>0&&`${c.chatCount} chats`,c.arrowCount>0&&`${c.arrowCount} arrows`].filter(Boolean).join(", ")}),a.jsxs(N,{size:"sm",onClick:U,className:"gap-1","data-test":"canvas-share-import-button",children:[a.jsx(Le,{size:14}),"Import"]})]}):a.jsx("span",{className:"text-xs text-destructive",children:"Invalid share data"})})]})]})})},it=({onClick:e})=>{const r=s=>{const t=s.currentTarget.getBoundingClientRect();e({x:t.right,y:t.bottom+8})};return a.jsx(N,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5",onClick:r,title:"Share Canvas","data-test":"canvas-share-trigger",children:a.jsx(Ie,{className:"h-5 w-5"})})};function F(e){return ie(JSON.stringify(e))}function lt(e){return ie(JSON.stringify(e))}function G(e){const r=Object.values(e.nodes),s=lt(e);let t=0,n=null;const o={},i={};for(const c of r){const l=F(c);l>t&&(t=l,n=c.id);const h=c.operation.type;o[h]=(o[h]||0)+1,i[h]=(i[h]||0)+l}const d=r.filter(c=>c.children.length>1).length,u=dt(e);return{nodeCount:r.length,totalSizeBytes:s,totalSizeFormatted:$(s),avgNodeSizeBytes:r.length>0?Math.round(s/r.length):0,avgNodeSizeFormatted:$(r.length>0?s/r.length:0),largestNodeSizeBytes:t,largestNodeId:n,operationTypeCounts:o,operationTypeSizes:i,branchCount:d,maxDepth:u}}function ct(e,r){const t=Object.values(e.nodes).map(n=>({nodeId:n.id,operationType:n.operation.type,sizeBytes:F(n),sizeFormatted:$(F(n)),timestamp:n.timestamp,label:n.label||n.operation.type}));return t.sort((n,o)=>o.sizeBytes-n.sizeBytes),r?t.slice(0,r):t}function fe(e){const r=G(e),s=[];for(const[t,n]of Object.entries(r.operationTypeSizes)){const o=r.operationTypeCounts[t]||0;s.push({type:t,count:o,totalSize:n,avgSize:o>0?Math.round(n/o):0,formatted:$(n)})}return s.sort((t,n)=>n.totalSize-t.totalSize),s}function dt(e){if(!e.root)return 0;function r(s,t){if(t.has(s))return 0;t.add(s);const n=e.nodes[s];if(!n)return 0;if(n.children.length===0)return 1;let o=0;for(const i of n.children)o=Math.max(o,r(i,t));return 1+o}return r(e.root,new Set)}function ut(e,r=1e4){return ct(e).filter(s=>s.sizeBytes>r)}function pt(e){const r=G(e),s=fe(e);let t=`# Undo Tree Summary

`;t+=`## Statistics
`,t+=`- Total nodes: ${r.nodeCount}
`,t+=`- Total size: ${r.totalSizeFormatted}
`,t+=`- Average node size: ${r.avgNodeSizeFormatted}
`,t+=`- Branches: ${r.branchCount}
`,t+=`- Max depth: ${r.maxDepth}

`,t+=`## Size by Operation Type
`;for(const n of s)t+=`- ${n.type}: ${n.count} ops, ${n.formatted}
`;return t}function ht(){const[e,r]=f.useState(null),[s,t]=f.useState(!1),[n,o]=f.useState(!1),i=async()=>{o(!0);try{const c=L.getState().undo.getTreeData()??J(),l=G(c),h=fe(c),m=ut(c,5e3),y=await L.getState().undo.getArchiveStats();r({stats:l,byType:h,bloated:m,archive:y})}finally{o(!1)}},d=()=>{const c=L.getState().undo.getTreeData()??J(),l=pt(c);navigator.clipboard.writeText(l),t(!0),setTimeout(()=>t(!1),2e3)};return a.jsxs("div",{className:"flex flex-col gap-2","data-test":"undo-storage-analyzer",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx(N,{variant:"outline",size:"sm",onClick:i,disabled:n,"data-test":"analyze-undo-storage-button",children:n?"Analyzing...":"Analyze Undo Storage"}),e&&a.jsx(N,{variant:"outline",size:"sm",onClick:d,"data-test":"copy-undo-summary-button",children:s?"Copied!":"Copy Summary"})]}),e&&a.jsxs("div",{className:"text-xs space-y-2 max-h-48 overflow-y-auto p-2 bg-muted rounded","data-test":"undo-analysis-results",children:[a.jsxs("div",{"data-test":"undo-stats-overview",children:[a.jsx("span",{className:"font-medium",children:"In Memory:"})," ",e.stats.totalSizeFormatted,a.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(",e.stats.nodeCount," nodes, avg ",e.stats.avgNodeSizeFormatted,")"]})]}),e.archive&&a.jsxs("div",{"data-test":"undo-stats-archive",children:[a.jsx("span",{className:"font-medium",children:"Archived:"})," ",a.jsxs("span",{className:"text-muted-foreground",children:[e.archive.archivedCount," / ",e.archive.archiveLimit," nodes"]}),a.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(limit: ",e.archive.historyLimit," in memory)"]})]}),e.byType.length>0&&a.jsxs("div",{"data-test":"undo-stats-by-type",children:[a.jsx("span",{className:"font-medium",children:"By Type:"}),a.jsx("ul",{className:"ml-2",children:e.byType.slice(0,5).map(u=>a.jsxs("li",{className:"text-muted-foreground",children:[u.type,": ",u.formatted," (",u.count,")"]},u.type))})]}),e.bloated.length>0&&a.jsxs("div",{className:"text-amber-600","data-test":"undo-stats-bloated",children:[a.jsxs("span",{className:"font-medium",children:["Bloated (",e.bloated.length,"):"]}),a.jsx("ul",{className:"ml-2",children:e.bloated.slice(0,3).map(u=>a.jsxs("li",{children:[u.label,": ",u.sizeFormatted]},u.nodeId))})]})]})]})}const ae="debug-reset-canvas-on-reload";function ft(){const[e,r]=f.useState(!1),[s,t]=f.useState(!1),[n,o]=f.useState(!1),[i,d]=f.useState();f.useEffect(()=>{localStorage.getItem(ae)==="true"&&(r(!0),L.getState().resetState())},[]);const u=l=>{r(l),localStorage.setItem(ae,String(l))},c=l=>{const h=l.currentTarget.getBoundingClientRect();d({x:h.left,y:h.bottom+8}),o(!0)};return a.jsxs(a.Fragment,{children:[a.jsx(N,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","data-test":"debug-popover-trigger",onClick:c,children:a.jsx(Re,{className:"h-5 w-5"})}),a.jsx(X,{isVisible:n,onClose:()=>o(!1),title:"Debug Actions",triggerPosition:i,className:"w-72",children:a.jsxs("div",{className:"flex flex-col gap-3 p-3","data-test":"debug-popover-content",children:[a.jsx(N,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>L.getState().resetState(),"data-test":"reset-canvas-state-button",children:"Reset canvas state"}),a.jsx(N,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>L.getState().resetEverything(),"data-test":"reset-everything-button",children:"Reset everything"}),a.jsxs("div",{className:"flex items-center gap-2","data-test":"reset-on-reload-container",children:[a.jsx(ge,{id:"reset-on-reload",checked:e,onCheckedChange:u,"data-test":"reset-on-reload-checkbox"}),a.jsx(xe,{htmlFor:"reset-on-reload",className:"text-sm cursor-pointer","data-test":"reset-on-reload-label",children:"Reset on reload"})]}),a.jsx("hr",{className:"border-border"}),a.jsx("p",{className:"text-sm font-medium",children:"Storage Analysis"}),a.jsx(ht,{}),a.jsx("hr",{className:"border-border"}),a.jsx("p",{className:"text-sm font-medium",children:"Mobile Logs"}),a.jsxs("div",{className:"flex gap-2","data-test":"mobile-logs-actions",children:[a.jsx(N,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>{const l=!s;t(l),l&&o(!1)},"data-test":"toggle-mobile-logs-button",children:s?"Hide Mobile Logs":"Show Mobile Logs"}),a.jsx(N,{variant:"outline",size:"sm",onClick:async()=>{await K.copyToClipboard()?A.success("Logs copied to clipboard!"):A.error("Failed to copy logs")},title:"Copy mobile logs to clipboard","data-test":"copy-mobile-logs-button",children:a.jsx(ce,{className:"h-4 w-4"})}),a.jsx(N,{variant:"outline",size:"sm",onClick:()=>{K.clear(),A.success("Logs cleared!")},title:"Clear mobile logs","data-test":"clear-mobile-logs-button",children:a.jsx(de,{className:"h-4 w-4"})})]})]})}),s&&a.jsx(ye,{defaultVisible:!0,autoRefresh:!0,refreshInterval:500,onClose:()=>t(!1)})]})}const H=$e(),re=Ve(),W=re&&H.find(e=>e.id===re)||H[0];W&&(I(W),pe(W.id));const oe={currentUser:W||null,users:H,presets:[],isLoading:!1,isOffline:!0,error:null,_apiClient:null},z=He((e,r)=>({...oe,setApiClient:s=>e({_apiClient:s}),loadUsers:async()=>{e({isLoading:!0,error:null});const s=r()._apiClient;if(s)try{const n=await s.getUsers();O(n),e({users:n,isLoading:!1,isOffline:!1});return}catch{}const t=Xe();e({users:t||[],isLoading:!1,isOffline:!0})},loadActiveUser:async()=>{e({isLoading:!0,error:null});const s=r()._apiClient;if(s)try{const o=await s.getActiveUser();I(o),e({currentUser:o,isLoading:!1,isOffline:!1}),o&&await r().loadPresets(o.id);return}catch{}const t=Fe(),n=Z();e({currentUser:t,presets:n||[],isLoading:!1,isOffline:!0})},setActiveUser:async s=>{e({isLoading:!0,error:null});const t=r()._apiClient,n=r().currentUser;let o=!t;if(t)try{await t.setActiveUser(s),o=!1}catch{o=!0}if(pe(s),s){const d=r().users.find(u=>u.id===s);d?(await Ge((n==null?void 0:n.id)??null,d.id,d.username),I(d),e({currentUser:d,isLoading:!1,isOffline:o}),await r().loadPresets(s)):await r().loadActiveUser()}else I(null),E([]),e({currentUser:null,presets:[],isLoading:!1,isOffline:o})},createUser:async s=>{e({isLoading:!0,error:null});const t=r()._apiClient,n=_(),o={id:Q(),username:s,profilePicture:"",isOnline:!0,lastSeen:n,createdAt:n,updatedAt:n};if(t)try{const d=await t.createUser({username:s}),u=[...r().users,d];return O(u),e({users:u,isLoading:!1,isOffline:!1}),d}catch{}const i=[...r().users,o];return O(i),e({users:i,isLoading:!1,isOffline:!0}),o},updateUser:async(s,t)=>{e({isLoading:!0,error:null});const n=r()._apiClient;if(n)try{const l=await n.updateUser(s,t),h=r().users.map(b=>b.id===s?l:b),m=r().currentUser,y=(m==null?void 0:m.id)===s?l:m;O(h),y&&I(y),e({users:h,currentUser:y,isLoading:!1,isOffline:!1});return}catch{}const o=r().users.find(l=>l.id===s);if(!o){e({error:"User not found",isLoading:!1});return}const i={...o,...t,updatedAt:_()},d=r().users.map(l=>l.id===s?i:l),u=r().currentUser,c=(u==null?void 0:u.id)===s?i:u;O(d),c&&I(c),e({users:d,currentUser:c,isLoading:!1,isOffline:!0})},deleteUser:async s=>{e({isLoading:!0,error:null});const t=r()._apiClient;let n=!t;if(t)try{await t.deleteUser(s),n=!1}catch{n=!0}const o=r().users.filter(u=>u.id!==s),i=r().currentUser,d=(i==null?void 0:i.id)===s;O(o),d&&(I(null),E([])),e({users:o,currentUser:d?null:i,presets:d?[]:r().presets,isLoading:!1,isOffline:n})},loadPresets:async s=>{e({isLoading:!0,error:null});const t=r()._apiClient;if(t)try{const i=await t.getPresets(s);E(i),e({presets:i,isLoading:!1,isOffline:!1});return}catch{}const n=Z(),o=(n==null?void 0:n.filter(i=>i.userId===s))||[];e({presets:o,isLoading:!1,isOffline:!0})},createPreset:async(s,t)=>{const n=r().currentUser;if(!n)throw e({error:"No active user"}),new Error("No active user");e({isLoading:!0,error:null});const o=r()._apiClient,i=_(),d={id:Q(),userId:n.id,name:s,settings:t||{},createdAt:i,updatedAt:i};if(o)try{const c=await o.createPreset(n.id,{name:s,settings:t}),l=[...r().presets,c];return E(l),e({presets:l,isLoading:!1,isOffline:!1}),c}catch{}const u=[...r().presets,d];return E(u),e({presets:u,isLoading:!1,isOffline:!0}),d},updatePreset:async(s,t)=>{e({isLoading:!0,error:null});const n=r()._apiClient;if(n)try{const u=await n.updatePreset(s,t),c=r().presets.map(l=>l.id===s?u:l);E(c),e({presets:c,isLoading:!1,isOffline:!1});return}catch{}const o=r().presets.find(u=>u.id===s);if(!o){e({error:"Preset not found",isLoading:!1});return}const i={...o,...t,updatedAt:_()},d=r().presets.map(u=>u.id===s?i:u);E(d),e({presets:d,isLoading:!1,isOffline:!0})},deletePreset:async s=>{e({isLoading:!0,error:null});const t=r()._apiClient;let n=!t;if(t)try{await t.deletePreset(s),n=!1}catch{n=!0}const o=r().presets.filter(i=>i.id!==s);E(o),e({presets:o,isLoading:!1,isOffline:n})},applyPreset:async s=>{const t=r().currentUser;if(!t){e({error:"No active user"});return}e({isLoading:!0,error:null});const n=r()._apiClient;if(n)try{await n.applyPreset(t.id,s),e({isLoading:!1,isOffline:!1});return}catch{}e({isLoading:!1,isOffline:!0})},clearError:()=>e({error:null}),reset:()=>e(oe)})),mt=320,gt=400;function xt({isOpen:e,onClose:r,triggerPosition:s}){const t=z(p=>p.currentUser),n=z(p=>p.users),o=z(p=>p.presets),i=z(p=>p.setActiveUser),d=z(p=>p.createPreset),u=z(p=>p.deletePreset),c=z(p=>p.applyPreset),l=z(p=>p.isLoading),[h,m]=f.useState(!0),[y,b]=f.useState(""),[v,U]=f.useState(!1),[k,g]=f.useState(null),x=p=>{i(p)},S=async()=>{if(y.trim()){U(!0);try{await d(y.trim()),b("")}finally{U(!1)}}},j=async p=>{g(p.id),await c(p.id)},P=async p=>{await u(p),k===p&&g(null)};return a.jsx(X,{isVisible:e,onClose:r,title:"User Settings",triggerPosition:s,initialSize:{width:mt,height:gt},resizable:!0,shouldCloseManually:!0,anchorOrigin:"top-right","data-test":"user-settings-popover",children:a.jsxs("div",{className:"p-4 space-y-4","data-test":"user-settings-content",children:[a.jsx("section",{"data-test":"user-info-section",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-12 h-12 rounded-full bg-muted flex items-center justify-center","data-test":"user-avatar",children:t!=null&&t.profilePicture?a.jsx("img",{src:t.profilePicture,alt:t.username,className:"w-full h-full rounded-full object-cover"}):a.jsx(ue,{className:"w-6 h-6 text-muted-foreground"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"font-medium text-sm","data-test":"user-display-name",children:(t==null?void 0:t.username)||"No user"}),a.jsxs(ve,{value:(t==null?void 0:t.id)||"",onValueChange:x,children:[a.jsx(Ce,{className:"h-7 text-xs mt-1","data-test":"user-switcher-select",children:a.jsx(we,{placeholder:"Switch user"})}),a.jsx(be,{"data-test":"user-switcher-dropdown",children:n.map(p=>a.jsx(Se,{value:p.id,"data-test":`user-option-${p.id}`,children:p.username},p.id))})]})]})]})}),a.jsxs(je,{open:h,onOpenChange:m,children:[a.jsxs(Ne,{className:"flex items-center justify-between w-full py-2 text-sm font-medium hover:bg-muted/50 rounded px-2 -mx-2","data-test":"presets-section-trigger",children:[a.jsx("span",{children:"Presets"}),a.jsx(Oe,{className:M("w-4 h-4 transition-transform",h&&"rotate-180")})]}),a.jsx(Pe,{"data-test":"presets-section-content",children:a.jsxs("div",{className:"mt-2 space-y-2",children:[o.length===0?a.jsx("p",{className:"text-xs text-muted-foreground py-2","data-test":"no-presets-message",children:"No presets yet. Create one below."}):a.jsx("ul",{className:"space-y-1","data-test":"presets-list",children:o.map(p=>a.jsxs("li",{className:M("flex items-center justify-between px-2 py-1.5 rounded text-sm","hover:bg-muted/50 transition-colors",k===p.id&&"bg-muted"),"data-test":`preset-item-${p.id}`,children:[a.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>void j(p),disabled:l,"data-test":`preset-apply-${p.id}`,children:[a.jsx("span",{className:M("w-4 h-4 rounded-full border flex items-center justify-center",k===p.id?"border-primary bg-primary":"border-muted-foreground"),children:k===p.id&&a.jsx(le,{className:"w-3 h-3 text-primary-foreground"})}),a.jsx("span",{children:p.name})]}),a.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>void P(p.id),disabled:l,"data-test":`preset-delete-${p.id}`,children:a.jsx(de,{className:"w-3 h-3"})})]},p.id))}),a.jsxs("div",{className:"flex items-center gap-2 pt-2","data-test":"create-preset-form",children:[a.jsx(Te,{placeholder:"New preset name",value:y,onChange:p=>b(p.target.value),onKeyDown:p=>{p.key==="Enter"&&S()},className:"h-8 text-sm",disabled:v,"data-test":"new-preset-input"}),a.jsx(N,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>void S(),disabled:!y.trim()||v,"data-test":"create-preset-button",children:a.jsx(De,{className:"w-4 h-4"})})]})]})})]})]})})}function yt({variant:e="ghost",size:r="icon"}){const s=z(c=>c.currentUser),[t,n]=f.useState(!1),[o,i]=f.useState(),d=f.useRef(null),u=()=>{if(d.current){const c=d.current.getBoundingClientRect();i({x:c.right,y:c.bottom+8})}n(!0)};return a.jsxs(a.Fragment,{children:[a.jsx(N,{ref:d,variant:e,size:r,onClick:u,"aria-label":"User settings",title:(s==null?void 0:s.username)||"User settings","data-test":"user-button",children:s!=null&&s.profilePicture?a.jsx("img",{src:s.profilePicture,alt:s.username,className:"w-5 h-5 rounded-full object-cover"}):a.jsx("span",{className:"flex items-center justify-center",children:s!=null&&s.username?a.jsx("span",{className:"text-sm font-medium",children:s.username.charAt(0).toUpperCase()}):a.jsx(ue,{className:"h-5 w-5"})})}),a.jsx(xt,{isOpen:t,onClose:()=>n(!1),triggerPosition:o})]})}function vt({showCollapseButton:e=!1}){const r=B(l=>l.uiState.floatingHeaderExpanded??!1),[s,t]=f.useState(!1),[n,o]=f.useState(),[i,d]=f.useState(!1),u=f.useRef(r);f.useEffect(()=>{if(u.current&&!r){d(!0);const l=setTimeout(()=>d(!1),300);return()=>clearTimeout(l)}u.current=r},[r]);const c=()=>{L.getState().setUiState(l=>({...l,floatingHeaderExpanded:!l.floatingHeaderExpanded}))};return!r&&!i?null:a.jsx("div",{className:"w-[98vw] pointer-events-none flex justify-end","data-test":"floating-header-wrapper",children:a.jsxs("header",{className:M("bg-card text-card-foreground top-0 flex items-center rounded-md p-2 shadow-md pointer-events-auto",r&&"animate-in slide-in-from-right duration-300",i&&"animate-out slide-out-to-right duration-300"),children:[e&&a.jsx(N,{variant:"ghost",size:"icon",onClick:c,"aria-label":"Collapse header","data-test":"floating-header-collapse-button",children:a.jsx(Be,{className:"size-5"})}),a.jsxs("div",{className:M("flex items-center gap-2",e&&"ml-2"),children:[a.jsx("h1",{className:"text-xl whitespace-nowrap",children:"CN-1"}),a.jsx(Ue,{}),a.jsx(ze,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(Ye,{}),a.jsx(Ae,{}),a.jsx(it,{onClick:l=>{o(l),t(!0)}}),a.jsx(ot,{isOpen:s,onClose:()=>t(!1),triggerPosition:n}),a.jsx(ft,{}),a.jsx(yt,{}),a.jsx(ke,{})]})]})})}function Ct(){const[e,r]=f.useState(!1),[s,t]=f.useState({top:0,left:0}),[n,o]=f.useState(null),i=l=>{const h=l.getBoundingClientRect(),m=window.getComputedStyle(l),y=parseInt(m.lineHeight||m.fontSize),b=l.selectionStart,v=document.createElement("div");["boxSizing","width","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontFamily","fontSize","fontWeight","lineHeight","letterSpacing"].forEach(T=>{v.style[T]=m[T]}),v.style.position="absolute",v.style.top=h.top+"px",v.style.left=h.left+"px",v.style.visibility="hidden",v.style.whiteSpace="pre-wrap",v.style.wordWrap="break-word",v.style.overflow="hidden";const k=l.value.substring(0,b);v.textContent=k;const g=document.createElement("span");g.textContent="|",v.appendChild(g),document.body.appendChild(v);const x=g.getBoundingClientRect();document.body.removeChild(v);const S=x.top-h.top,j=x.left-h.left,P=S+y+4-l.scrollTop,p=j-l.scrollLeft;return{top:P,left:p}};return{showPopover:e,popoverPosition:s,handleKeyDown:l=>{if(l.key==="/"&&!e){const h=l.currentTarget,m=h.selectionStart,y=i(h);t(y),o(m),r(!0)}else(l.key==="Escape"||l.key==="Backspace"&&e&&n!==null&&l.currentTarget.selectionStart===n)&&(r(!1),o(null))},handleChange:l=>{e&&n!==null&&(n>=l.length||l[n]!=="/")&&(r(!1),o(null))},closePopover:()=>{r(!1),o(null)}}}const ss=()=>{const[e,r]=f.useState("");return Ct(),a.jsxs("div",{className:"page-container w-screen h-screen relative bg-background text-foreground",children:[a.jsx("div",{className:"absolute top-10 left-1/2 -translate-x-1/2 z-[60] pointer-events-none",children:a.jsx(vt,{})}),a.jsx("main",{className:"content-area w-full h-full",children:a.jsx("div",{className:"demo-section h-full",children:a.jsx(We,{width:"100%",height:"100%"})})})]})};export{ss as NewHomeApp};
