const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePage-CCEew-pO.js","assets/react-vendor-Byz07MLO.js","assets/icons-yhbeTEay.js","assets/recordingStorage-XzvoUejy.js","assets/utils-G1l1U0hd.js","assets/radix-ui-9f16WUVy.js","assets/ui-utils-BxIQ3qGg.js","assets/Chat-CLF3Tm2v.js","assets/format-utils-CaqrGWxs.js","assets/InputWithAudio-bcBUUEi2.js","assets/textarea-ZFIB_HyS.js","assets/TTSApiClient-B2jcHm8T.js","assets/systemPromptService-CiGRUnu2.js","assets/Settings-BAYSslX0.js","assets/Demo-D4h8yW46.js","assets/Breadcrumbs-BjZV4SIv.js","assets/JsonViewerApp-BHZpouoC.js","assets/Content-Dyg16hzh.js","assets/TablePage-lVZwRZog.js","assets/data-table-BsBSQvmG.js","assets/table-BU9steQ-.js","assets/VocabularyPage-DmeQBpfD.js","assets/definitionHelper-CZKT8hW2.js","assets/useVietnameseTyping-CIW9gKE9.js","assets/TextareaPopoverAtCursor-DB-dMS5D.js","assets/cursorPosition-otMhJ5rZ.js","assets/LiveTranscriptionPage-B4cyhHJq.js","assets/AudioPanelDemo-DObibpfH.js","assets/ClaudePage-DBufX_Vv.js","assets/SessionSidebar-CSfwOUNw.js","assets/tree-CNsSXVP0.js","assets/SessionDetailsPage-DRK_GrGb.js","assets/ForksPage-DSJxcvPP.js","assets/KanbanPage-DBU8-Q4U.js","assets/DemoLayout-CVyi6Okj.js","assets/react-hooks-CNdHs55p.js","assets/DragDropManager-CacIWg_Z.js","assets/SFSService-BFwsjKwD.js","assets/KanbanDataPage-Bg9hGMtJ.js","assets/index-Deh15k0e.js","assets/GlobalStatePage--j4TH4Ky.js","assets/GamePage-C7cWnvDc.js","assets/NewHomeApp-RvH7XgZ3.js","assets/CanvasAppV2-B2VtvxhC.js","assets/VimInputHandlerV2-CJwq8Ehj.js","assets/logging-CYRX986s.js","assets/string-4WCj7OpV.js","assets/clipboardHtmlToMarkdown-km7b-PJ7.js","assets/VimInputHandlerV2-BfpIuMTm.css","assets/UiButtonWithExpandOption-CPX53qLO.js","assets/DraggableCrudTree-BWkC8K4c.js","assets/treeHelpers-DUv_6quS.js","assets/globalFacadeRegistry-BlelMPVg.js","assets/WorkflowRowItem-D-fkRf8u.js","assets/UiDataTable-Dfde_OFA.js","assets/markdownToHtml-C-4HvgxL.js","assets/DraggableTree-h_RnWs_o.js","assets/useOcr-7vtWixZN.js","assets/alert-BYqYRHel.js","assets/context-menu-VDENXG3G.js","assets/easy-form-gMDj6oBZ.js","assets/forms-B7OAPNGv.js","assets/form-4XCOk2xb.js","assets/SlashCommandMenu-bphscUeq.js","assets/MobileLogViewer-CntKY_OW.js","assets/SttPage-DiTJjwzb.js"])))=>i.map(i=>d[i]);
var Nd=Object.defineProperty;var Ed=(s,e,t)=>e in s?Nd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var Q=(s,e,t)=>Ed(s,typeof e!="symbol"?e+"":e,t);import{r as h,j as o,e as kd,f as Wa,d as Go,k as aa,b as Id,R as Td,l as Ad,B as Pd}from"./react-vendor-Byz07MLO.js";import{B as Rd,m as za,d as Dd,t as be,_ as dt,z as Od,T as Ld}from"./utils-G1l1U0hd.js";import{p as ks,x as qo,O as Jn,d as oa,C as Xs,w as ia,y as Yn,D as Xn,R as Vo,z as _d,A as Ko,B as Md,E as Fd,F as $d,H as Ud,J as Bd,K as Wd,M as zd,N as Hd,Q as Gd,U as qd,V as Jo,W as Yo,X as Xo,Y as Vd,Z as Kd,$ as Jd,a0 as Yd,a1 as Qo,a2 as Xd,a3 as Qd,a4 as Zo,a5 as Zd,a6 as ei,a7 as eu,a8 as tu,a9 as ti,aa as si,ab as ni,ac as ri,ad as ai,ae as su,af as nu,ag as ru,ah as au,ai as oi,aj as ii,ak as ci,al as li,am as di,an as ui,ao as ou,ap as pi,aq as hi,ar as fi,as as mi,at as iu,au as cu,av as lu,aw as gi,ax as du,ay as uu,az as xi,aA as pu,aB as hu,aC as vi,aD as wi,aE as bi}from"./radix-ui-9f16WUVy.js";import{t as fu,a as Us,c as Qs}from"./ui-utils-BxIQ3qGg.js";import{X as ct,bM as mu,bN as Ha,bO as gu,y as Vt,M as yi,G as ls,bv as xu,bo as vu,N as Qn,bP as wu,bQ as bu,b9 as Si,aJ as yu,bt as Ci,b as Su,bR as ji,bS as Ni,bT as Ei,az as ki,h as Ii,ad as Ti,V as Zs,O as ds,a2 as Ws,F as ca,bi as Cu,bj as ju,bU as Nu,bV as Eu,ai as ku,ab as Ai,ae as Iu,bf as Tu,bW as Au,D as la,T as At,bX as Pu,a as Pi,a1 as da,aL as ua,bY as pa,g as ms,C as st,f as Zn,$ as Ru,S as gn,q as Ri,bs as Du,ap as Ou,a_ as hr,c as xn,l as En,W as kn,a3 as er,bZ as Di,bz as Lu,b5 as _u,ao as Oi,d as tr,P as Mu,aa as zs,b_ as Fu,b$ as $u,e as ha,K as Ga,w as Rs,E as Tr,i as qa,bl as Ar,aU as Li,as as In,c0 as Uu,be as Bu,aZ as Wu,c1 as zu,bk as Hu,aF as Gu,aG as qu,j as Vu,bA as Ku,c2 as Ju,c3 as Yu,ar as _i,Y as Xu}from"./icons-yhbeTEay.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();const as=class as{constructor(){Q(this,"logs",[]);Q(this,"counter",0);Q(this,"maxLogs",100);Q(this,"listeners",[]);Q(this,"isCollecting",!1);Q(this,"collectedLogs",[]);Q(this,"originalConsole",{log:console.log,warn:console.warn,error:console.error,debug:console.debug})}static getInstance(){return as.instance||(as.instance=new as),as.instance}log(e,t="info",n){const r=new Date().toLocaleTimeString(),a={id:`log-${this.counter++}`,timestamp:r,message:e,level:t,service:n},i=t==="error"?console.error:t==="warning"?console.warn:t==="debug"?console.debug:console.log,c=n?`[${n}] `:"",l=`[${r}] ${c}${e}`;i(l),this.isCollecting&&this.collectedLogs.push(l),this.logs=[a,...this.logs.slice(0,this.maxLogs-1)],this.notifyListeners()}info(e,t){this.log(e,"info",t)}error(e,t){this.log(e,"error",t)}warning(e,t){this.log(e,"warning",t)}debug(e,t){this.log(e,"debug",t)}getLogs(){return this.logs}clear(){this.logs=[],this.notifyListeners()}export(){return this.logs.slice().reverse().map(e=>{const t=e.service?`[${e.service}] `:"";return`[${e.timestamp}] ${e.level.toUpperCase()}: ${t}${e.message}`}).join(`
`)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}collectLogs(e=!0){this.isCollecting=!0,this.collectedLogs=[],e&&typeof window<"u"&&this.interceptConsole(),console.log("ðŸ“ Log collection started. Call window.printCollectedLogs() to retrieve.")}interceptConsole(){const e=this;console.log=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(n),e.originalConsole.log.apply(console,t)},console.warn=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`WARN: ${n}`),e.originalConsole.warn.apply(console,t)},console.error=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`ERROR: ${n}`),e.originalConsole.error.apply(console,t)},console.debug=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`DEBUG: ${n}`),e.originalConsole.debug.apply(console,t)}}restoreConsole(){console.log=this.originalConsole.log,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,console.debug=this.originalConsole.debug}stopCollecting(){this.isCollecting=!1,this.restoreConsole();const e=this.collectedLogs.join(`
`);return console.log("ðŸ›‘ Log collection stopped."),e}getCollectedLogs(){return this.collectedLogs.join(`
`)}clearCollectedLogs(){this.collectedLogs=[]}};Q(as,"instance");let Pr=as;const je=Pr.getInstance();typeof window<"u"&&(window.getCollectedLogs=()=>je.getCollectedLogs(),window.printCollectedLogs=()=>{const s=je.getCollectedLogs();return console.log(`ðŸ“‹ Collected logs:
`+s),s},window.startCollectingLogs=()=>je.collectLogs(),window.stopCollectingLogs=()=>je.stopCollecting(),window.clearCollectedLogs=()=>je.clearCollectedLogs());const Mi=()=>{const[s,e]=h.useState(()=>je.getLogs());h.useEffect(()=>je.subscribe(r=>{e(r)}),[]);const t=h.useRef();return t.current||(t.current={log:(n,r,a)=>je.log(n,r,a),info:(n,r)=>je.info(n,r),error:(n,r)=>je.error(n,r),warning:(n,r)=>je.warning(n,r),debug:(n,r)=>je.debug(n,r),clear:()=>je.clear(),export:()=>je.export()}),{logs:s,actions:t.current}};class Qu{constructor(e="http://localhost:3333"){Q(this,"baseUrl");Q(this,"eventSource",null);this.baseUrl=e}async getProjects(e){const t=new URLSearchParams;(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const n=`${this.baseUrl}/claude/projects${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch projects: ${r.statusText}`);return await r.json()}catch(r){throw console.error("[ClaudeAPI.getProjects] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,timestamp:new Date().toISOString()}),r}}async getProjectDetails(e){const t=`${this.baseUrl}/claude/projects/${encodeURIComponent(e)}`,n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch project details: ${n.statusText}`);return n.json()}async getSessions(e){const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.excludeAgents&&t.append("excludeAgents","true");const n=`${this.baseUrl}/claude/sessions-v2${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch sessions: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getSessions] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,errorStack:r instanceof Error?r.stack:void 0,timestamp:new Date().toISOString()}),r}}async searchSessions(e,t){const n=new URLSearchParams;e&&(t!=null&&t.messageTypes&&t.messageTypes.length>0?n.append("messageContent",e):n.append("q",e)),t!=null&&t.fields&&t.fields.length>0&&!(t!=null&&t.messageTypes&&t.messageTypes.length>0)&&n.append("fields",t.fields.join(",")),(t==null?void 0:t.isActive)!==void 0&&n.append("isActive",t.isActive.toString()),(t==null?void 0:t.minMessages)!==void 0&&n.append("minMessages",t.minMessages.toString()),(t==null?void 0:t.maxMessages)!==void 0&&n.append("maxMessages",t.maxMessages.toString()),t!=null&&t.modifiedAfter&&n.append("modifiedAfter",t.modifiedAfter),t!=null&&t.modifiedBefore&&n.append("modifiedBefore",t.modifiedBefore),t!=null&&t.messageTypes&&t.messageTypes.length>0&&n.append("messageTypes",t.messageTypes.join(",")),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/sessions/search${n.toString()?`?${n.toString()}`:""}`;try{const a=await fetch(r);if(!a.ok)throw new Error(`Failed to search sessions: ${a.statusText}`);return a.json()}catch(a){throw console.error("[ClaudeAPI.searchSessions] Fetch error:",{url:r,error:a,errorMessage:a instanceof Error?a.message:"Unknown error",errorName:a instanceof Error?a.name:void 0,errorStack:a instanceof Error?a.stack:void 0,timestamp:new Date().toISOString()}),a}}async searchSessionMessages(e,t,n){const r=new URLSearchParams;t&&r.append("content",t),n!=null&&n.messageType&&n.messageType.length>0?r.append("messageType",n.messageType.join(",")):n!=null&&n.role&&r.append("role",n.role),n!=null&&n.after&&r.append("after",n.after),n!=null&&n.before&&r.append("before",n.before),n!=null&&n.sortOrder&&r.append("sortOrder",n.sortOrder),(n==null?void 0:n.page)!==void 0&&r.append("page",n.page.toString()),(n==null?void 0:n.pageSize)!==void 0&&r.append("pageSize",n.pageSize.toString());const a=`${this.baseUrl}/claude/sessions/${e}/search${r.toString()?`?${r.toString()}`:""}`,i=await fetch(a);if(!i.ok)throw new Error(`Failed to search session messages: ${i.statusText}`);return i.json()}async searchMessages(e,t){const n=new URLSearchParams;e&&n.append("q",e),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageTypes",t.messageType.join(",")),t!=null&&t.after&&n.append("after",t.after),t!=null&&t.before&&n.append("before",t.before),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/messages/search${n.toString()?`?${n.toString()}`:""}`,a=await fetch(r);if(!a.ok)throw new Error(`Failed to search messages: ${a.statusText}`);return a.json()}async getSessionDetails(e,t){const n=new URLSearchParams;(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageType",t.messageType.join(","));const r=`${this.baseUrl}/claude/sessions-v2/${e}${n.toString()?`?${n.toString()}`:""}`;try{const a=await fetch(r);if(!a.ok)throw new Error(`Failed to fetch session details: ${a.statusText}`);return a.json()}catch(a){throw console.error("[ClaudeAPI.getSessionDetails] Fetch error:",{url:r,sessionId:e,error:a,errorMessage:a instanceof Error?a.message:"Unknown error",errorName:a instanceof Error?a.name:void 0,timestamp:new Date().toISOString()}),a}}async sendMessage(e){const t=await fetch(`${this.baseUrl}/claude/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to send message: ${t.statusText}`);return t.json()}async createSession(e={}){const t=await fetch(`${this.baseUrl}/claude/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to create session: ${t.statusText}`);return t.json()}async updateSessionName(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customName:t})});if(!n.ok)throw new Error(`Failed to update session name: ${n.statusText}`);return n.json()}async updateSessionStatus(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Failed to update session status: ${n.statusText}`);return n.json()}async forkSession(e,t){const n=`${this.baseUrl}/claude/sessions/${e}/fork`;try{const r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to create fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.forkSession] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForks(e){const t=new URLSearchParams;e!=null&&e.parentSessionId&&t.append("parentSessionId",e.parentSessionId),e!=null&&e.sessionId&&t.append("sessionId",e.sessionId),(e==null?void 0:e.favoritesOnly)!==void 0&&t.append("favoritesOnly",e.favoritesOnly.toString()),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.sortBy&&t.append("sortBy",e.sortBy),e!=null&&e.sortOrder&&t.append("sortOrder",e.sortOrder);const n=`${this.baseUrl}/claude/forks${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch forks: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getForks] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForkDetails(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch fork details: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getForkDetails] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async updateFork(e,t){const n=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const r=await fetch(n,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to update fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.updateFork] Fetch error:",{url:n,forkId:e,updates:t,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async deleteFork(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t,{method:"DELETE"});if(!n.ok)throw new Error(`Failed to delete fork: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.deleteFork] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async getSessionForks(e,t){const n=new URLSearchParams;(t==null?void 0:t.favoritesOnly)!==void 0&&n.append("favoritesOnly",t.favoritesOnly.toString()),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder);const r=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/forks${n.toString()?`?${n.toString()}`:""}`;try{const a=await fetch(r);if(!a.ok)throw new Error(`Failed to fetch session forks: ${a.statusText}`);return a.json()}catch(a){throw console.error("[ClaudeAPI.getSessionForks] Fetch error:",{url:r,sessionId:e,error:a,errorMessage:a instanceof Error?a.message:"Unknown error",timestamp:new Date().toISOString()}),a}}async getForkTree(e){const t=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/fork-tree`;try{const n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch fork tree: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getForkTree] Fetch error:",{url:t,sessionId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}subscribeToSessionChanges(e,t){const n=`${this.baseUrl}/claude/sessions/events`;return this.eventSource=new EventSource(n),this.eventSource.onopen=()=>{var r;console.log("[ClaudeAPI.subscribeToSessionChanges] SSE connection opened:",{url:n,readyState:(r=this.eventSource)==null?void 0:r.readyState,timestamp:new Date().toISOString()})},this.eventSource.onmessage=r=>{try{const a=JSON.parse(r.data);a.type!=="connected"&&e(a)}catch(a){console.error("[ClaudeAPI.subscribeToSessionChanges] Failed to parse SSE event:",{error:a,eventData:r.data,errorMessage:a instanceof Error?a.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=r=>{var a,i,c,l;console.error("[ClaudeAPI.subscribeToSessionChanges] SSE connection error:",{error:r,readyState:(a=this.eventSource)==null?void 0:a.readyState,readyStateText:((i=this.eventSource)==null?void 0:i.readyState)===0?"CONNECTING":((c=this.eventSource)==null?void 0:c.readyState)===1?"OPEN":((l=this.eventSource)==null?void 0:l.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),t&&t(r)},()=>{var r;(r=this.eventSource)==null||r.close(),this.eventSource=null}}}const Ke=new Qu;class Zu{constructor(e="http://localhost:3333"){Q(this,"eventSource",null);Q(this,"eventHandlers",new Set);Q(this,"errorHandlers",new Set);Q(this,"baseUrl");Q(this,"reconnectAttempts",0);Q(this,"maxReconnectAttempts",5);Q(this,"reconnectDelay",1e3);this.baseUrl=e}subscribe(e,t){return this.eventHandlers.add(e),t&&this.errorHandlers.add(t),this.eventHandlers.size===1&&!this.eventSource&&this.connect(),()=>{this.eventHandlers.delete(e),t&&this.errorHandlers.delete(t),this.eventHandlers.size===0&&this.disconnect()}}connect(){const e=`${this.baseUrl}/claude/sessions/events`;this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.reconnectAttempts=0},this.eventSource.onmessage=t=>{try{const n=JSON.parse(t.data);if(n.type==="connected")return;this.eventHandlers.forEach(r=>{try{r(n)}catch(a){console.error("[ClaudeSSEManager] Error in event handler:",{error:a,eventType:n.type,timestamp:new Date().toISOString()})}})}catch(n){console.error("[ClaudeSSEManager] Failed to parse SSE event:",{error:n,eventData:t.data,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=t=>{var n,r,a,i;if(console.error("[ClaudeSSEManager] SSE connection error:",{error:t,readyState:(n=this.eventSource)==null?void 0:n.readyState,readyStateText:((r=this.eventSource)==null?void 0:r.readyState)===0?"CONNECTING":((a=this.eventSource)==null?void 0:a.readyState)===1?"OPEN":((i=this.eventSource)==null?void 0:i.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),this.errorHandlers.forEach(c=>{try{c(t)}catch(l){console.error("[ClaudeSSEManager] Error in error handler:",l)}}),this.eventHandlers.size>0&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const c=this.reconnectDelay*this.reconnectAttempts;setTimeout(()=>{this.eventHandlers.size>0&&(this.disconnect(),this.connect())},c)}}}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null,this.reconnectAttempts=0)}getConnectionState(){var e;return((e=this.eventSource)==null?void 0:e.readyState)??null}getSubscriberCount(){return this.eventHandlers.size}}const ep=new Zu;function fa(s,e,t=!0){const n=h.useRef(s),r=h.useRef(e);h.useEffect(()=>{n.current=s},[s]),h.useEffect(()=>{r.current=e},[e]);const a=h.useCallback(l=>{n.current(l)},[]),i=h.useCallback(l=>{var d;(d=r.current)==null||d.call(r,l)},[]),c=h.useRef(!!e);h.useEffect(()=>{c.current=!!e},[e]),h.useEffect(()=>{if(!t)return;const l=ep.subscribe(a,c.current?i:void 0);return()=>{l()}},[t,a,i])}function Fi(s,e){const t={...s};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n],a=t[n];r&&typeof r=="object"&&!Array.isArray(r)&&a&&typeof a=="object"&&!Array.isArray(a)?t[n]=Fi(a,r):t[n]=r}return t}class tp{constructor(e={}){Q(this,"STORAGE_KEY","global-store");Q(this,"state$");const t=this.loadFromStorage();this.state$=new Rd({...e,...t})}getState(){return this.state$.value}getState$(){return this.state$.asObservable()}get(e){return this.state$.value[e]}select(e){return this.state$.pipe(za(t=>t[e]),Dd())}selectSlice(e){return this.state$.pipe(za(e))}setState(e){this.state$.next(e),this.saveToStorage()}updateState(e){const t={...this.state$.value,...e};this.state$.next(t),this.saveToStorage()}set(e,t){this.updateState({[e]:t})}update(e,t){const n=this.state$.value[e],r=typeof n=="object"&&n!==null&&typeof t=="object"&&t!==null?Fi(n,t):t;this.set(e,r)}remove(e){const t={...this.state$.value};delete t[e],this.state$.next(t),this.saveToStorage()}reset(){this.state$.next({}),this.clearStorage()}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load global store from localStorage:",e),{}}}saveToStorage(){try{const e=this.getStateToPersist(this.state$.value);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save global store to localStorage:",e)}}getStateToPersist(e){var n,r;const t={...e};if(t.ui&&(t.ui={...t.ui,directoryMaps:void 0}),(n=t.app)!=null&&n.claude){const a=t.app.claude;t.app={...t.app,claude:{...a,data:void 0,forks:void 0,ui:a.ui?{...a.ui,isInitialized:void 0,loadingSessions:void 0,sessionsError:void 0,projectsInitialized:void 0,loadingProjects:void 0,projectsError:void 0,activity:void 0}:void 0}}}if((r=t.app)!=null&&r.kanban){const a=t.app.kanban;t.app={...t.app,kanban:{...a,loading:void 0,error:void 0}}}return t}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear global store from localStorage:",e)}}export(){return JSON.stringify(this.state$.value,null,2)}import(e){try{const t=JSON.parse(e);return this.setState(t),!0}catch(t){return console.error("Failed to import global store data:",t),!1}}}const oe=new tp;function Re(s){const[e,t]=h.useState(()=>s(oe.getState()));return h.useEffect(()=>{const n=oe.selectSlice(s).subscribe(t);return()=>n.unsubscribe()},[s]),e}function ma(){return{get:oe.get.bind(oe),set:oe.set.bind(oe),update:oe.update.bind(oe),updateState:oe.updateState.bind(oe),remove:oe.remove.bind(oe),reset:oe.reset.bind(oe),getState:oe.getState.bind(oe)}}const sp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},np=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1},rp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.sessionsError)??null},ap=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.pagination)??null},op=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.currentPage)??1},ip=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.isInitialized)??!1},cp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.excludeAgents)??!1};function lp(s={}){const{loadOnMount:e=!0,subscribeToSSE:t=!0}=s,{update:n,getState:r}=ma(),a=h.useRef(!1),i=Re(sp),c=Re(np),l=Re(rp),d=Re(ap),p=Re(op),u=Re(ip),f=Re(cp),m=async(S=1,C=!1)=>{var N,A,I,k,P,W;try{const R=(N=r().app)==null?void 0:N.claude;n("app",{claude:{ui:{...R==null?void 0:R.ui,loadingSessions:!0,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1}}});const F=((A=R==null?void 0:R.ui)==null?void 0:A.excludeAgents)??!1,L=await Ke.getSessions({page:S,pageSize:20,excludeAgents:F}),T=[...L.sessions].sort((H,Y)=>new Date(Y.lastModified).getTime()-new Date(H.lastModified).getTime()),M=((I=R==null?void 0:R.data)==null?void 0:I.sessions)??[],D=C?[...M,...T]:T;n("app",{claude:{data:{sessions:D,pagination:L.pagination||null},ui:{loadingSessions:!1,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}})}catch(R){console.error("[SessionLoader] API request failed:",{error:R,errorMessage:R instanceof Error?R.message:"Unknown error",page:S,append:C,timestamp:new Date().toISOString()}),je.error(`Session load failed: ${R instanceof Error?R.message:"Unknown error"}`,"SessionLoader"),n("app",{claude:{data:{sessions:C?((W=(P=(k=r().app)==null?void 0:k.claude)==null?void 0:P.data)==null?void 0:W.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:R instanceof Error?R.message:"Failed to load sessions",currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}}),je.error("Store updated with error state","SessionLoader")}},g=async(S,C,N=!1)=>{var A,I,k,P,W;try{const R=(A=r().app)==null?void 0:A.claude;n("app",{claude:{ui:{...R==null?void 0:R.ui,loadingSessions:!0,sessionsError:null,searchQuery:S,searchFilters:C,isSearchActive:!0}}});const F=await Ke.searchSessions(S,C),L=((I=R==null?void 0:R.data)==null?void 0:I.sessions)??[],T=N?[...L,...F.results]:F.results;n("app",{claude:{data:{sessions:T,pagination:F.pagination},ui:{loadingSessions:!1,sessionsError:null,currentPage:F.pagination.page,searchQuery:S,searchFilters:C,isSearchActive:!0}}})}catch(R){console.error("[SessionLoader] API request failed:",{error:R,errorMessage:R instanceof Error?R.message:"Unknown error",query:S,filters:C,append:N,timestamp:new Date().toISOString()}),n("app",{claude:{data:{sessions:N?((W=(P=(k=r().app)==null?void 0:k.claude)==null?void 0:P.data)==null?void 0:W.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:R instanceof Error?R.message:"Failed to search sessions",currentPage:1,searchQuery:S,searchFilters:C,isSearchActive:!0}}})}},x=(S,C)=>{var P,W,R;const N=((R=(W=(P=r().app)==null?void 0:P.claude)==null?void 0:W.data)==null?void 0:R.sessions)??[],A=N.findIndex(F=>F.id===S);if(A===-1)return;const I=[...N];I[A]={...I[A],...C};const k=I.sort((F,L)=>new Date(L.lastModified).getTime()-new Date(F.lastModified).getTime());n("app",{claude:{data:{sessions:k},ui:{loadingSessions:!1,sessionsError:null}}})},y=S=>{var A,I,k;const N=(((k=(I=(A=r().app)==null?void 0:A.claude)==null?void 0:I.data)==null?void 0:k.sessions)??[]).filter(P=>P.id!==S);n("app",{claude:{data:{sessions:N},ui:{loadingSessions:!1,sessionsError:null}}})},w=S=>{var N,A;const C=(A=(N=r().app)==null?void 0:N.claude)==null?void 0:A.ui;if(C!=null&&C.isSearchActive&&(C==null?void 0:C.searchQuery)!==void 0){const I={...C.searchFilters,page:S};g(C.searchQuery,I)}else m(S)},v=()=>{var S,C;if(d&&p<d.totalPages){const N=(C=(S=r().app)==null?void 0:S.claude)==null?void 0:C.ui;if(N!=null&&N.isSearchActive&&(N==null?void 0:N.searchQuery)!==void 0){const A={...N.searchFilters,page:p+1};g(N.searchQuery,A,!0)}else m(p+1,!0)}},b=()=>{m(1)},j=()=>{var N,A;const S=(N=r().app)==null?void 0:N.claude,C=!((A=S==null?void 0:S.ui)!=null&&A.excludeAgents);n("app",{claude:{ui:{...S==null?void 0:S.ui,excludeAgents:C}}}),m(1)};return h.useEffect(()=>{e&&(u||a.current||(a.current=!0,m(1)))},[u]),fa(S=>{S.type==="created"&&m(p),S.type==="modified"&&S.sessionId&&(async()=>{try{const C=await Ke.getSessionDetails(S.sessionId);x(S.sessionId,{name:C.name,lastModified:C.metadata.lastModified,messageCount:C.metadata.messageCount})}catch(C){console.error("[SSE] Failed to fetch modified session:",{sessionId:S.sessionId,error:C,timestamp:new Date().toISOString()})}})(),S.type==="batch-modified"&&S.sessionIds&&m(p),S.type==="deleted"&&S.sessionId&&y(S.sessionId)},S=>{console.error("[SSE] Connection error:",{error:S,errorMessage:S instanceof Error?S.message:"Unknown error",timestamp:new Date().toISOString()})},t),{sessions:i,loadingSessions:c,sessionsError:l,pagination:d,currentPage:p,isInitialized:u,excludeAgents:f,loadSessions:m,searchSessions:g,refreshSessions:b,handlePageChange:w,handleLoadMore:v,toggleExcludeAgents:j}}const dp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},up=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},pp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},hp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsInitialized)??!1};function fp(s={}){const{loadOnMount:e=!0}=s,{update:t,getState:n}=ma(),r=h.useRef(!1),a=Re(dp),i=Re(up),c=Re(pp),l=Re(hp),d=async()=>{var u,f,m;try{const g=n(),x=(u=g.app)==null?void 0:u.claude;t("app",{...g.app,claude:{...x,data:{...x==null?void 0:x.data},ui:{...x==null?void 0:x.ui,loadingProjects:!0,projectsError:null}}});const y=await Ke.getProjects({pageSize:100}),w=n(),v=(f=w.app)==null?void 0:f.claude;t("app",{...w.app,claude:{...v,data:{...v==null?void 0:v.data,projects:y.projects},ui:{...v==null?void 0:v.ui,loadingProjects:!1,projectsError:null,projectsInitialized:!0}}})}catch(g){console.error("[ProjectsLoader] API request failed:",{error:g,errorMessage:g instanceof Error?g.message:"Unknown error",timestamp:new Date().toISOString()}),je.error(`Projects load failed: ${g instanceof Error?g.message:"Unknown error"}`,"ProjectsLoader");const x=n(),y=(m=x.app)==null?void 0:m.claude;t("app",{...x.app,claude:{...y,data:{...y==null?void 0:y.data,projects:[]},ui:{...y==null?void 0:y.ui,loadingProjects:!1,projectsError:g instanceof Error?g.message:"Failed to load projects",projectsInitialized:!0}}}),je.error("Store updated with error state","ProjectsLoader")}},p=()=>{d()};return h.useEffect(()=>{e&&(l||r.current||(r.current=!0,d()))},[l,e]),{projects:a,loadingProjects:i,projectsError:c,projectsInitialized:l,loadProjects:d,refreshProjects:p}}function mp(){const[s,e]=h.useState(new Set),t=h.useCallback(n=>n?s.has(n):!1,[s]);return fa(n=>{var a,i,c,l,d,p,u,f,m,g,x,y,w,v,b;if(n.type==="batch-modified")return;const r=n.sessionId;if(r){if(n.type==="session-started"&&e(j=>{const S=new Set(j);return S.add(r),S}),n.type==="session-ended"&&e(j=>{const S=new Set(j);return S.delete(r),S}),n.type==="session-opened"){const j=((c=(i=(a=oe.get("app"))==null?void 0:a.claude)==null?void 0:i.ui)==null?void 0:c.activity)??{},S={...j,[r]:{...j[r],isOpened:!0}};oe.update("app",{claude:{ui:{activity:S}}}),e(C=>{const N=new Set(C);return N.add(r),N})}if(n.type==="session-closed"){const j=((p=(d=(l=oe.get("app"))==null?void 0:l.claude)==null?void 0:d.ui)==null?void 0:p.activity)??{},S=((u=j[r])==null?void 0:u.isOpened)===!0||((f=j[r])==null?void 0:f.isProcessing)===!0,C={...j,[r]:{...j[r],isOpened:!!S,isProcessing:!1}};oe.update("app",{claude:{ui:{activity:C}}}),S||e(N=>{const A=new Set(N);return A.delete(r),A}),console.log("[useSessionRunningStatus] Session closed, keeping as opened:",S)}if(n.type==="session-processing-started"){const j=((x=(g=(m=oe.get("app"))==null?void 0:m.claude)==null?void 0:g.ui)==null?void 0:x.activity)??{},S={...j,[r]:{...j[r],isProcessing:!0,isOpened:!0}};oe.update("app",{claude:{ui:{activity:S}}}),e(C=>{const N=new Set(C);return N.add(r),N})}if(n.type==="session-processing-stopped"){const j=((v=(w=(y=oe.get("app"))==null?void 0:y.claude)==null?void 0:w.ui)==null?void 0:v.activity)??{},S={...j,[r]:{...j[r],isProcessing:!1}};oe.update("app",{claude:{ui:{activity:S}}}),(((b=S[r])==null?void 0:b.isOpened)??!1)||e(N=>{const A=new Set(N);return A.delete(r),A})}}},n=>{console.error("[useSessionRunningStatus] SSE connection error:",n)}),{isSessionRunning:t,runningSessions:s}}const fr=768;function gp(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=window.matchMedia(`(max-width: ${fr-1}px)`),n=()=>{e(window.innerWidth<fr)};return t.addEventListener("change",n),e(window.innerWidth<fr),()=>t.removeEventListener("change",n)},[]),!!s}function B(...s){return fu(Us(s))}const xp={default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},vp=Qs("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive cursor-pointer",{variants:{variant:xp,size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",compact:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-1.2",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",smIcon:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 [&_svg:not([class*='size-'])]:size-3",smIconCompact:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",sic:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),se=h.forwardRef(({className:s,variant:e,size:t,asChild:n=!1,...r},a)=>{const i=n?ks:"button";return o.jsx(i,{"data-slot":"button",className:B(vp({variant:e,size:t,className:s})),ref:a,...r})});se.displayName="Button";const _e=h.forwardRef(({className:s,type:e,...t},n)=>o.jsx("input",{type:e,className:B("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:n,...t}));_e.displayName="Input";const $i=h.forwardRef(({className:s,orientation:e="horizontal",decorative:t=!0,...n},r)=>o.jsx(qo,{ref:r,decorative:t,orientation:e,className:B("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...n}));$i.displayName=qo.displayName;const wp=Vo,bp=oa,Ui=h.forwardRef(({className:s,...e},t)=>o.jsx(Jn,{className:B("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...e,ref:t}));Ui.displayName=Jn.displayName;const yp=Qs("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Bi=h.forwardRef(({side:s="right",className:e,children:t,...n},r)=>o.jsxs(bp,{children:[o.jsx(Ui,{}),o.jsxs(Xs,{ref:r,className:B(yp({side:s}),e),...n,children:[o.jsxs(ia,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[o.jsx(ct,{className:"h-4 w-4"}),o.jsx("span",{className:"sr-only",children:"Close"})]}),t]})]}));Bi.displayName=Xs.displayName;const Wi=({className:s,...e})=>o.jsx("div",{className:B("flex flex-col space-y-2 text-center sm:text-left",s),...e});Wi.displayName="SheetHeader";const zi=h.forwardRef(({className:s,...e},t)=>o.jsx(Yn,{ref:t,className:B("text-lg font-semibold text-foreground",s),...e}));zi.displayName=Yn.displayName;const Hi=h.forwardRef(({className:s,...e},t)=>o.jsx(Xn,{ref:t,className:B("text-sm text-muted-foreground",s),...e}));Hi.displayName=Xn.displayName;function Va({className:s,...e}){return o.jsx("div",{className:B("animate-pulse rounded-md bg-primary/10",s),...e})}const Qe={xs:"w-3 h-3",sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},lC={deleteButton:"text-red-600 hover:text-red-700 hover:bg-red-50"},dC={input:"bg-green-500",process:"bg-blue-500",output:"bg-red-500",text:"bg-blue-500",select:"bg-purple-500",audio:"bg-green-500",default:"bg-gray-500"},uC={base:"absolute w-4 h-4 bg-background rounded-full border-2 border-border transform -translate-y-1/2 cursor-crosshair z-10",input:"node-handle node-handle-input -left-2 top-1/2",output:"node-handle node-handle-output -right-2 top-1/2",hover:"hover:border-blue-400 hover:bg-accent",active:"border-blue-400 bg-accent"},Sp={input:"w-full p-2 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background",textarea:"w-full p-3 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring resize-y bg-background",label:"text-xs font-medium text-foreground block mb-1",error:"text-destructive text-xs mt-1"},pC=.2,Je={popover:1500,skipLink:1600,tooltip:1800,backdrop:1550,draggablePopover:1560,slashCommandMenu:1565,draggablePopoverDropdown:1570,canvasGroups:1,canvasArrows:5,canvasNodes:10,canvasResizeHandles:15,nodeTextarea:10,nodeAudioButton:20,nodeQuickPanel:40,canvasChatInput:50,canvasOverlay:55,quickPanelPortal:1020,toolbarDropdown:1050,commandPalette:1750},Yt=Md,Xt=Fd,Qt=$d,Kt=h.forwardRef(({className:s,sideOffset:e=4,style:t,...n},r)=>o.jsx(_d,{children:o.jsx(Ko,{ref:r,sideOffset:e,className:B("overflow-hidden rounded-md border bg-card px-3 py-1.5 text-xs text-card-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",s),style:{zIndex:Je.tooltip,...t},...n})}));Kt.displayName=Ko.displayName;class Cp{constructor(){Q(this,"STORAGE_KEY","ui-store")}getStore(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to parse UI store from localStorage:",e),{}}}setStore(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save UI store to localStorage:",t)}}get(e){return this.getStore()[e]}set(e,t){const n=this.getStore();n[e]=t,this.setStore(n)}update(e,t){const n=this.getStore(),r=n[e]||{};n[e]={...r,...t},this.setStore(n)}remove(e){const t=this.getStore();delete t[e],this.setStore(t)}clear(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear UI store:",e)}}getAllData(){return this.getStore()}export(){return JSON.stringify(this.getStore(),null,2)}import(e){try{const t=JSON.parse(e);return this.setStore(t),!0}catch(t){return console.error("Failed to import UI store data:",t),!1}}}const Rr=new Cp,jp="16rem",Np="18rem",Ep="3rem",kp="b",Gi=h.createContext(null);function Is(){const s=h.useContext(Gi);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const qi=h.forwardRef(({defaultOpen:s=!0,open:e,onOpenChange:t,className:n,style:r,children:a,...i},c)=>{const l=gp(),[d,p]=h.useState(!1),[u,f]=h.useState(()=>{const v=Rr.get("sidebar");return(v==null?void 0:v.isOpen)??s}),m=e??u,g=h.useCallback(v=>{const b=typeof v=="function"?v(m):v;t?t(b):f(b),Rr.update("sidebar",{isOpen:b})},[t,m]),x=h.useCallback(()=>l?p(v=>!v):g(v=>!v),[l,g,p]);h.useEffect(()=>{const v=b=>{b.key===kp&&(b.metaKey||b.ctrlKey)&&(b.preventDefault(),x())};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)},[x]);const y=m?"expanded":"collapsed",w=h.useMemo(()=>({state:y,open:m,setOpen:g,isMobile:l,openMobile:d,setOpenMobile:p,toggleSidebar:x}),[y,m,g,l,d,p,x]);return o.jsx(Gi.Provider,{value:w,children:o.jsx(Yt,{delayDuration:0,children:o.jsx("div",{style:{"--sidebar-width":jp,"--sidebar-width-icon":Ep,...r},className:B("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",n),ref:c,...i,children:a})})})});qi.displayName="SidebarProvider";const Vi=h.forwardRef(({side:s="left",variant:e="sidebar",collapsible:t="offcanvas",className:n,children:r,...a},i)=>{h.useEffect(()=>{Rr.update("sidebar",{side:s,variant:e})},[s,e]);const{isMobile:c,state:l,openMobile:d,setOpenMobile:p,toggleSidebar:u}=Is();return t==="none"?o.jsx("div",{className:B("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",n),ref:i,...a,children:r}):c?o.jsx(wp,{open:d,onOpenChange:p,...a,children:o.jsxs(Bi,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":Np},side:s,children:[o.jsxs(Wi,{className:"sr-only",children:[o.jsx(zi,{children:"Sidebar"}),o.jsx(Hi,{children:"Displays the mobile sidebar."})]}),o.jsx("div",{className:"flex h-full w-full flex-col",children:r})]})}):o.jsxs("div",{ref:i,className:"group peer hidden text-sidebar-foreground md:block","data-state":l,"data-collapsible":l==="collapsed"?t:"","data-variant":e,"data-side":s,children:[o.jsx("div",{className:B("relative bg-transparent transition-[width] duration-200 ease-linear",e==="floating"?"w-0":"w-[--sidebar-width]","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",e==="floating"||e==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),l==="expanded"&&t==="offcanvas"&&o.jsx("div",{className:"fixed inset-0 z-[55] bg-black/50",onClick:u}),o.jsx("div",{className:B("fixed inset-y-0 z-[60] hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",e==="floating"||e==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",n),...a,children:o.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:r})})]})});Vi.displayName="Sidebar";const Ki=h.forwardRef(({className:s,onClick:e,...t},n)=>{const{toggleSidebar:r}=Is();return o.jsxs(se,{ref:n,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:B("h-7 w-7",s),onClick:a=>{e==null||e(a),r()},...t,children:[o.jsx(mu,{}),o.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});Ki.displayName="SidebarTrigger";const Ip=h.forwardRef(({className:s,...e},t)=>{const{toggleSidebar:n}=Is();return o.jsx("button",{ref:t,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:n,title:"Toggle Sidebar",className:B("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...e})});Ip.displayName="SidebarRail";const Ji=h.forwardRef(({className:s,...e},t)=>o.jsx("main",{ref:t,className:B("relative flex w-full flex-1 flex-col bg-background","md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow","peer-data-[collapsible=offcanvas]:ml-0 peer-data-[collapsible=offcanvas]:mr-0","peer-data-[variant=floating]:ml-0 peer-data-[variant=floating]:mr-0",s),...e}));Ji.displayName="SidebarInset";const Tp=h.forwardRef(({className:s,...e},t)=>o.jsx(_e,{ref:t,"data-sidebar":"input",className:B("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...e}));Tp.displayName="SidebarInput";const Yi=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,"data-sidebar":"header",className:B("flex flex-col gap-2 p-2",s),...e}));Yi.displayName="SidebarHeader";const Ap=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,"data-sidebar":"footer",className:B("flex flex-col gap-2 p-2",s),...e}));Ap.displayName="SidebarFooter";const Pp=h.forwardRef(({className:s,...e},t)=>o.jsx($i,{ref:t,"data-sidebar":"separator",className:B("mx-2 w-auto bg-sidebar-border",s),...e}));Pp.displayName="SidebarSeparator";const Xi=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,"data-sidebar":"content",className:B("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...e}));Xi.displayName="SidebarContent";const Rp=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,"data-sidebar":"group",className:B("relative flex w-full min-w-0 flex-col p-2",s),...e}));Rp.displayName="SidebarGroup";const Dp=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?ks:"div";return o.jsx(r,{ref:n,"data-sidebar":"group-label",className:B("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...t})});Dp.displayName="SidebarGroupLabel";const Op=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?ks:"button";return o.jsx(r,{ref:n,"data-sidebar":"group-action",className:B("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...t})});Op.displayName="SidebarGroupAction";const Lp=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,"data-sidebar":"group-content",className:B("w-full text-sm",s),...e}));Lp.displayName="SidebarGroupContent";const Qi=h.forwardRef(({className:s,...e},t)=>o.jsx("ul",{ref:t,"data-sidebar":"menu",className:B("flex w-full min-w-0 flex-col gap-1",s),...e}));Qi.displayName="SidebarMenu";const _s=h.forwardRef(({className:s,...e},t)=>o.jsx("li",{ref:t,"data-sidebar":"menu-item",className:B("group/menu-item relative",s),...e}));_s.displayName="SidebarMenuItem";const _p=Qs("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),Ms=h.forwardRef(({asChild:s=!1,isActive:e=!1,variant:t="default",size:n="default",tooltip:r,className:a,...i},c)=>{const l=s?ks:"button",{isMobile:d,state:p}=Is(),u=o.jsx(l,{ref:c,"data-sidebar":"menu-button","data-size":n,"data-active":e,className:B(_p({variant:t,size:n}),a),...i});return r?(typeof r=="string"&&(r={children:r}),o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:u}),o.jsx(Kt,{side:"right",align:"center",hidden:p!=="collapsed"||d,...r})]})):u});Ms.displayName="SidebarMenuButton";const Mp=h.forwardRef(({className:s,asChild:e=!1,showOnHover:t=!1,...n},r)=>{const a=e?ks:"button";return o.jsx(a,{ref:r,"data-sidebar":"menu-action",className:B("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",t&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...n})});Mp.displayName="SidebarMenuAction";const Fp=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,"data-sidebar":"menu-badge",className:B("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...e}));Fp.displayName="SidebarMenuBadge";const $p=h.forwardRef(({className:s,showIcon:e=!1,...t},n)=>{const r=h.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return o.jsxs("div",{ref:n,"data-sidebar":"menu-skeleton",className:B("flex h-8 items-center gap-2 rounded-md px-2",s),...t,children:[e&&o.jsx(Va,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),o.jsx(Va,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":r}})]})});$p.displayName="SidebarMenuSkeleton";const Dr=h.forwardRef(({className:s,...e},t)=>o.jsx("ul",{ref:t,"data-sidebar":"menu-sub",className:B("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...e}));Dr.displayName="SidebarMenuSub";const vn=h.forwardRef(({...s},e)=>o.jsx("li",{ref:e,...s}));vn.displayName="SidebarMenuSubItem";const wn=h.forwardRef(({asChild:s=!1,size:e="md",isActive:t,className:n,...r},a)=>{const i=s?ks:"a";return o.jsx(i,{ref:a,"data-sidebar":"menu-sub-button","data-size":e,"data-active":t,className:B("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",e==="sm"&&"text-xs",e==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",n),...r})});wn.displayName="SidebarMenuSubButton";const Up="audio-chunks-db",Bp=1,wt="chunks",qe="metadata";class Wp{constructor(){Q(this,"dbPromise");Q(this,"initializationPromise");this.dbPromise=this.initDB(),this.initializationPromise=this.waitForDB()}async waitForDB(){await this.dbPromise}async waitForInitialization(){await this.initializationPromise}async initDB(){return new Promise((e,t)=>{const n=indexedDB.open(Up,Bp);n.onupgradeneeded=r=>{const a=r.target.result;if(a.objectStoreNames.contains(wt)||a.createObjectStore(wt),!a.objectStoreNames.contains(qe)){const i=a.createObjectStore(qe);i.createIndex("sessionName","sessionName",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1}),i.createIndex("chunkNumber","chunkNumber",{unique:!1})}},n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{t(new Error(`IndexedDB error: ${r.target.error}`))}})}async saveChunk(e,t){var n;if(await this.waitForInitialization(),!e.blob)throw new Error("Cannot save chunk without blob data");try{const a=(await this.dbPromise).transaction([qe,wt],"readwrite"),i=a.objectStore(qe),c=a.objectStore(wt),l={id:e.id,chunkNumber:e.chunkNumber,startTime:e.startTime.toISOString(),endTime:(n=e.endTime)==null?void 0:n.toISOString(),duration:e.duration,size:e.size??e.blob.size,name:e.name,sessionName:t,transcription:e.transcription,transcriptionStatus:e.transcriptionStatus,transcriptionError:e.transcriptionError,createdAt:new Date().toISOString(),mimeType:e.blob.type};i.put(l,e.id),c.put(e.blob,e.id),await new Promise((d,p)=>{a.oncomplete=()=>d(),a.onerror=()=>p(new Error(`Transaction failed: ${a.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to save chunk:",r),r}}async loadChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([qe,wt],"readonly"),r=n.objectStore(qe),a=n.objectStore(wt),c=r.index("sessionName").getAll(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to load metadata: ${c.error}`))});if(l.length===0)return[];const d=[];for(const p of l)try{const u=a.get(p.id),f=await new Promise((m,g)=>{u.onsuccess=()=>m(u.result),u.onerror=()=>g(new Error(`Failed to load blob: ${u.error}`))});if(f){const m={id:p.id,chunkNumber:p.chunkNumber,startTime:new Date(p.startTime),endTime:p.endTime?new Date(p.endTime):void 0,duration:p.duration,blob:f,size:p.size,name:p.name,transcription:p.transcription,transcriptionStatus:p.transcriptionStatus,transcriptionError:p.transcriptionError};d.push(m)}}catch(u){console.warn(`ðŸŽ¤ðŸ“¦ðŸ’¾ âš ï¸ Failed to load chunk ${p.id}:`,u)}return d.sort((p,u)=>p.chunkNumber-u.chunkNumber),d}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to load chunks:",t),t}}async updateChunkTranscription(e,t){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([qe],"readwrite"),a=r.objectStore(qe),i=a.get(e),c=await new Promise((d,p)=>{i.onsuccess=()=>d(i.result),i.onerror=()=>p(new Error(`Failed to get metadata: ${i.error}`))});if(!c)throw new Error(`Chunk not found: ${e}`);const l={...c,transcription:t,transcriptionStatus:"completed"};a.put(l,e),await new Promise((d,p)=>{r.oncomplete=()=>d(),r.onerror=()=>p(new Error(`Transaction failed: ${r.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription:",n),n}}async updateChunkTranscriptionStatus(e,t,n){await this.waitForInitialization();try{const a=(await this.dbPromise).transaction([qe],"readwrite"),i=a.objectStore(qe),c=i.get(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to get metadata: ${c.error}`))});if(!l)throw new Error(`Chunk not found: ${e}`);const d={...l,transcriptionStatus:t,transcriptionError:n};i.put(d,e),await new Promise((p,u)=>{a.oncomplete=()=>p(),a.onerror=()=>u(new Error(`Transaction failed: ${a.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription status:",r),r}}async deleteChunk(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([qe,wt],"readwrite"),r=n.objectStore(qe),a=n.objectStore(wt);r.delete(e),a.delete(e),await new Promise((i,c)=>{n.oncomplete=()=>i(),n.onerror=()=>c(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunk:",t),t}}async deleteChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([qe,wt],"readwrite"),r=n.objectStore(qe),a=n.objectStore(wt),c=r.index("sessionName").getAll(e),l=await new Promise((d,p)=>{c.onsuccess=()=>d(c.result),c.onerror=()=>p(new Error(`Failed to load metadata: ${c.error}`))});for(const d of l)r.delete(d.id),a.delete(d.id);await new Promise((d,p)=>{n.oncomplete=()=>d(),n.onerror=()=>p(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunks by session:",t),t}}async getAllSessions(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([qe],"readonly").objectStore(qe).getAll(),a=await new Promise((c,l)=>{r.onsuccess=()=>c(r.result),r.onerror=()=>l(new Error(`Failed to load all metadata: ${r.error}`))});return[...new Set(a.map(c=>c.sessionName))].sort()}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get all sessions:",e),e}}async getStorageStats(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([qe],"readonly").objectStore(qe).getAll(),a=await new Promise((l,d)=>{r.onsuccess=()=>l(r.result),r.onerror=()=>d(new Error(`Failed to load all metadata: ${r.error}`))}),i=a.reduce((l,d)=>l+d.size,0),c=new Set(a.map(l=>l.sessionName)).size;return{totalChunks:a.length,totalSize:i,sessionCount:c}}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get storage stats:",e),e}}async clearAllData(){await this.waitForInitialization();try{const t=(await this.dbPromise).transaction([qe,wt],"readwrite"),n=t.objectStore(qe),r=t.objectStore(wt);n.clear(),r.clear(),await new Promise((a,i)=>{t.oncomplete=()=>a(),t.onerror=()=>i(new Error(`Transaction failed: ${t.error}`))})}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to clear all data:",e),e}}}const ft=new Wp,mr="vocabulary-lists",Ot="default";class zp{getAllLists(){try{const e=localStorage.getItem(mr);return e?JSON.parse(e).map(n=>({...n,createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt)})):[this.createDefaultList()]}catch(e){return console.error("Failed to load vocabulary lists:",e),[this.createDefaultList()]}}getListById(e){return this.getAllLists().find(n=>n.id===e)??null}createList(e){const t=this.getAllLists(),n={id:`list-${Date.now()}`,name:e,createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}updateList(e,t){const n=this.getAllLists(),r=n.findIndex(a=>a.id===e);return r===-1?null:(n[r]={...n[r],...t,updatedAt:new Date},this.saveLists(n),n[r])}async deleteList(e){const t=this.getAllLists();if(t.length<=1)return console.warn("Cannot delete the last vocabulary list"),!1;if(e===Ot){const r=t.find(a=>a.id===Ot);if(r&&r.entryCount>0&&t.length===1)return console.warn("Cannot delete default list with data when it's the only list"),!1}const n=t.filter(r=>r.id!==e);return this.saveLists(n),localStorage.removeItem(`vocabulary-entries-${e}`),await ft.deleteChunksBySession(`vocabulary-session-${e}`),!0}getDefaultListId(){return this.getAllLists().find(n=>n.id===Ot)||this.createDefaultList(),Ot}updateEntryCount(e,t){this.updateList(e,{entryCount:t})}migrateOldData(){const e="vocabulary-entries",t=localStorage.getItem(e);if(!t)return!1;try{this.getAllLists().find(c=>c.id===Ot)??(r=this.createDefaultList());const a=`vocabulary-entries-${Ot}`;if(!localStorage.getItem(a)){localStorage.setItem(a,t);const c=JSON.parse(t);return this.updateEntryCount(Ot,c.length),localStorage.removeItem(e),console.log("Migrated old vocabulary data to default list"),!0}return localStorage.removeItem(e),!1}catch(n){return console.error("Failed to migrate vocabulary data:",n),!1}}createDefaultList(){const e=localStorage.getItem(mr);let t=[];if(e)try{t=JSON.parse(e).map(i=>({...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}));const a=t.find(i=>i.id===Ot);if(a)return a}catch(r){console.error("Error parsing stored lists:",r),t=[]}const n={id:Ot,name:"Default",createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}saveLists(e){localStorage.setItem(mr,JSON.stringify(e))}}const gr=new zp,Ka=Ud,Ja=Wd,Ya=Bd,Hp="modulepreload",Gp=function(s){return"/"+s},Xa={},Ze=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let i=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=i(t.map(d=>{if(d=Gp(d),d in Xa)return;Xa[d]=!0;const p=d.endsWith(".css"),u=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":Hp,p||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),p)return new Promise((m,g)=>{f.addEventListener("load",m),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function a(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&a(c.reason);return e().catch(a)})},xr=h.lazy(()=>Ze(()=>import("./HomePage-CCEew-pO.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>({default:s.HomePage}))),qp=h.lazy(()=>Ze(()=>import("./Chat-CLF3Tm2v.js"),__vite__mapDeps([7,1,8,9,10,2,11,4,5,12,6])).then(s=>({default:s.Chat}))),Vp=h.lazy(()=>Ze(()=>import("./Settings-BAYSslX0.js"),__vite__mapDeps([13,1,8,2,4,5,6])).then(s=>({default:s.Settings}))),Qa=h.lazy(()=>Ze(()=>import("./Demo-D4h8yW46.js"),__vite__mapDeps([14,1,15,5,2,16,4,6])).then(s=>({default:s.Demo}))),Za=h.lazy(()=>Ze(()=>import("./Content-Dyg16hzh.js"),__vite__mapDeps([17,1,8,2,4,5,6])).then(s=>({default:s.Content}))),Kp=h.lazy(()=>Ze(()=>import("./TablePage-lVZwRZog.js"),__vite__mapDeps([18,1,19,20,4,5,6,2])).then(s=>({default:s.TablePage}))),eo=h.lazy(()=>Ze(()=>import("./VocabularyPage-DmeQBpfD.js"),__vite__mapDeps([21,1,19,20,10,22,23,24,25,2,4,5,6])).then(s=>({default:s.VocabularyPage}))),Jp=h.lazy(()=>Ze(()=>import("./LiveTranscriptionPage-B4cyhHJq.js"),__vite__mapDeps([26,1,10,2,4,5,6])).then(s=>({default:s.LiveTranscriptionPage}))),Yp=h.lazy(()=>Ze(()=>import("./AudioPanelDemo-DObibpfH.js"),__vite__mapDeps([27,1,4,5,6,2])).then(s=>({default:s.AudioPanelDemo}))),Xp=h.lazy(()=>Ze(()=>import("./ClaudePage-DBufX_Vv.js"),__vite__mapDeps([28,1,29,5,2,30,4,6])).then(s=>({default:s.ClaudePage}))),Qp=h.lazy(()=>Ze(()=>import("./SessionDetailsPage-DRK_GrGb.js"),__vite__mapDeps([31,1,4,5,29,2,30,6,10])).then(s=>({default:s.SessionDetailsPage}))),Zp=h.lazy(()=>Ze(()=>import("./ForksPage-DSJxcvPP.js"),__vite__mapDeps([32,1,4,5,10,2,30,6])).then(s=>({default:s.ForksPage}))),vr=h.lazy(()=>Ze(()=>import("./KanbanPage-DBU8-Q4U.js"),__vite__mapDeps([33,1,34,15,5,2,35,36,4,37,6])).then(s=>({default:s.KanbanPage}))),eh=h.lazy(()=>Ze(()=>import("./KanbanDataPage-Bg9hGMtJ.js"),__vite__mapDeps([38,1,16,15,5,2,4,6])).then(s=>({default:s.KanbanDataPage}))),th=h.lazy(()=>Ze(()=>import("./index-Deh15k0e.js"),__vite__mapDeps([39,1,2,4,5,6])).then(s=>({default:s.ActionTodoPage}))),sh=h.lazy(()=>Ze(()=>import("./GlobalStatePage--j4TH4Ky.js"),__vite__mapDeps([40,1,16,4,5,2,6])).then(s=>({default:s.GlobalStatePage}))),nh=h.lazy(()=>Ze(()=>import("./GamePage-C7cWnvDc.js"),__vite__mapDeps([41,1,2,10,4,5,6])).then(s=>({default:s.GamePage}))),rh=h.lazy(()=>Ze(()=>import("./NewHomeApp-RvH7XgZ3.js"),__vite__mapDeps([42,1,6,4,5,2,10,43,44,45,46,47,48,49,24,25,22,50,36,51,52,53,54,35,29,30,55,56,57,58,16,59,60,61,62,63,64])).then(s=>({default:s.NewHomeApp}))),ah=h.lazy(()=>Ze(()=>import("./SttPage-DiTJjwzb.js"),__vite__mapDeps([65,1,4,5,6,2])).then(s=>({default:s.SttPage})));function oh(){return o.jsx("div",{className:"page-loader flex items-center justify-center h-full",children:o.jsx("div",{className:"page-loader-spinner animate-pulse text-muted-foreground",children:"Loading..."})})}const Tn=[{path:"/",element:xr,title:"Watcher",icon:Ha,label:"Home",showInSidebar:!0},{path:"/new-home",element:rh,title:"New Home",icon:Ha,label:"New Home",showInSidebar:!0},{path:"/chat",element:qp,title:"Chat with Ollama",icon:gu,label:"Chat",showInSidebar:!0},{path:"/settings",element:Vp,title:"Settings",icon:Vt,label:"Settings",showInSidebar:!0},{path:"/claude",element:Xp,title:"Claude",icon:yi,label:"Claude",showInSidebar:!0},{path:"/claude/:sessionId",element:Qp,title:"Claude",showInSidebar:!1},{path:"/claude/forks/:forkId?",element:Zp,title:"Session Forks",icon:ls,label:"Forks",showInSidebar:!1},{path:"/state",element:sh,title:"Global State",icon:xu,label:"Global State",showInSidebar:!0},{path:"/game",element:nh,title:"Multiplayer Games",icon:vu,label:"Games",showInSidebar:!0},{path:"/stt",element:ah,title:"Speech to Text",icon:Qn,label:"STT",showInSidebar:!0},{path:"/todo",element:vr,title:"Todo",icon:Ci,label:"Todo",showInSidebar:!0,group:"collapsible",children:[{path:"/todo",element:vr,title:"Todo",icon:wu,label:"Overview",showInSidebar:!0},{path:"/todo/kanban",element:vr,title:"Kanban Board",icon:bu,label:"Kanban Board",showInSidebar:!0},{path:"/todo/kanban/data",element:eh,title:"Kanban Data",icon:Si,label:"Data",showInSidebar:!0},{path:"/todo/action",element:th,title:"Action Todo",icon:yu,label:"Action-Driven",showInSidebar:!0}]},{path:"/content",element:Za,title:"Content",icon:Su,label:"Content",showInSidebar:!0},{path:"/content/:contentId",element:Za,title:"Content",showInSidebar:!1},{path:"/active-recording",element:xr,title:"Active Recording",icon:ji,label:"Active Recording",showInSidebar:!0},{path:"/vocabulary",element:eo,title:"Vocabulary",icon:Ni,label:"Vocabulary",showInSidebar:!0,group:"collapsible-vocabulary"},{path:"/vocabulary/:listId",element:eo,title:"Vocabulary",showInSidebar:!1},{path:"/live-transcription",element:Jp,title:"Live Transcription",icon:Ei,label:"Live Transcription",showInSidebar:!0},{path:"/table",element:Kp,title:"Table Demo",icon:ki,label:"Table Demo",showInSidebar:!0},{path:"/demo",element:Qa,title:"Demo",icon:Ii,label:"Demo",showInSidebar:!0},{path:"/demo/*",element:Qa,title:"Demo",showInSidebar:!1},{path:"/demo/audio-panel",element:Yp,title:"Audio Panel Demo",icon:Ti,label:"Audio Panel Demo",showInSidebar:!0},{path:"/realtime",element:xr,title:"Real-time Audio",showInSidebar:!1}];function ih(s){const e=Tn.find(t=>t.children&&t.children.find(r=>r.path===s)?!0:t.path===s);if(e){if(e.children){const t=e.children.find(n=>n.path===s);if(t)return t.title}return e.title}for(const t of Tn){if(s.startsWith(t.path.split("/:")[0]))return t.title;if(t.children){for(const n of t.children)if(s.startsWith(n.path.split("/:")[0]))return n.title}}return"Watcher"}function ch({logger:s,logs:e}){return o.jsx(h.Suspense,{fallback:o.jsx(oh,{}),children:o.jsx(kd,{children:Tn.map(t=>{const n=t.element,r=o.jsx(n,{logger:s,logs:e});return t.children?t.children.map(a=>{const i=a.element;return o.jsx(Wa,{path:a.path,element:o.jsx(i,{logger:s})},a.path)}):o.jsx(Wa,{path:t.path,element:r},t.path)})})})}function lh(){const{open:s,toggleSidebar:e}=Is();return o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx("h2",{className:"text-lg font-semibold px-2",children:"Menu"}),s&&o.jsx(se,{variant:"ghost",size:"icon",onClick:e,className:"h-7 w-7",children:o.jsx(Zs,{className:"w-4 h-4"})})]})}function dh(){const s=Go(),e=aa(),{isMobile:t,setOpen:n,setOpenMobile:r}=Is(),{actions:a}=Mi(),[i,c]=h.useState([]),[l,d]=h.useState(!1),[p,u]=h.useState(!1);h.useEffect(()=>{const x=gr.getAllLists();c(x)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/vocabulary")&&d(!0)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/todo")&&u(!0)},[e.pathname]);const f=h.useCallback((x,y)=>{x.ctrlKey||x.metaKey||x.button===1||(x.preventDefault(),s(y),t?r(!1):n(!1))},[s,t,n,r]),m=h.useCallback(async()=>{try{a.info("Fetching logs from /logs endpoint...");const y=await(await fetch("/logs")).json();console.log("Logs response:",y),a.info("Logs endpoint response logged to console")}catch(x){a.error(`Failed to fetch logs: ${x}`),console.error("Failed to fetch logs:",x)}t?r(!1):n(!1)},[a,t,n,r]),g=h.useCallback(()=>{const x=prompt("Enter a name for the new vocabulary list:");if(x!=null&&x.trim()){const y=gr.createList(x.trim());c(gr.getAllLists()),s(`/vocabulary/${y.id}`),t?r(!1):n(!1)}},[s,t,n,r]);return o.jsxs(Qi,{children:[Tn.filter(x=>x.showInSidebar).map(x=>x.group==="collapsible"&&x.children?o.jsx(Ka,{open:p,onOpenChange:u,className:"group/collapsible",children:o.jsxs(_s,{children:[o.jsx(Ja,{asChild:!0,children:o.jsxs(Ms,{children:[x.icon&&o.jsx(x.icon,{className:"w-4 h-4"}),x.label,o.jsx(ds,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),o.jsx(Ya,{children:o.jsx(Dr,{children:x.children.filter(y=>y.showInSidebar).map(y=>o.jsx(vn,{children:o.jsx(wn,{asChild:!0,isActive:e.pathname===y.path,children:o.jsxs("a",{href:y.path,onClick:w=>f(w,y.path),children:[y.icon&&o.jsx(y.icon,{className:"w-4 h-4"}),y.label]})})},y.path))})})]})},x.path):x.group==="collapsible-vocabulary"?o.jsx(Ka,{open:l,onOpenChange:d,className:"group/collapsible",children:o.jsxs(_s,{children:[o.jsx(Ja,{asChild:!0,children:o.jsxs(Ms,{children:[x.icon&&o.jsx(x.icon,{className:"w-4 h-4"}),x.label,o.jsx(ds,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),o.jsx(Ya,{children:o.jsxs(Dr,{children:[i.map(y=>o.jsx(vn,{children:o.jsx(wn,{asChild:!0,isActive:e.pathname===`/vocabulary/${y.id}`,children:o.jsxs("a",{href:`/vocabulary/${y.id}`,onClick:w=>f(w,`/vocabulary/${y.id}`),children:[y.name,y.entryCount>0&&o.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:y.entryCount})]})})},y.id)),o.jsx(vn,{children:o.jsxs(wn,{onClick:g,children:[o.jsx(Ws,{className:"w-4 h-4"}),"Create New List"]})})]})})]})},x.path):o.jsx(_s,{children:o.jsx(Ms,{asChild:!0,isActive:e.pathname===x.path,children:o.jsxs("a",{href:x.path,onClick:y=>f(y,x.path),children:[x.icon&&o.jsx(x.icon,{className:"w-4 h-4"}),x.label]})})},x.path)),o.jsx(_s,{children:o.jsxs(Ms,{onClick:m,children:[o.jsx(ca,{className:"w-4 h-4"}),"Logs"]})})]})}function uh(){return o.jsxs(Vi,{variant:"floating",collapsible:"offcanvas",children:[o.jsx(Yi,{children:o.jsx(lh,{})}),o.jsx(Xi,{children:o.jsx(dh,{})})]})}const Or=s=>{if(s==null)return s;if(typeof s=="number")return Math.round(s*10)/10;if(Array.isArray(s))return s.map(Or);if(typeof s=="object"){const e={};for(const[t,n]of Object.entries(s))e[t]=Or(n);return e}return s};class ga{constructor(e="http://localhost:3030/client-logs",t=5e3,n=!1){Q(this,"baseUrl");Q(this,"timeout");Q(this,"sessionId");Q(this,"shouldLogToConsole");this.baseUrl=e,this.timeout=t,this.shouldLogToConsole=n,this.sessionId=`todo-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async sendLogs(e,t,n){const r=t?Or(t):void 0;this.shouldLogToConsole&&console.log(`[${n||"client.log"}] ${e}`,r?JSON.stringify(r,null,2):"");try{const a={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),customLogFile:n,logs:{[e]:[`${e}`]},metadata:r},i=await this.fetchWithTimeout(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok)throw console.error("[ClientLogs] HTTP error:",i.status),new Error(`HTTP ${i.status}`);return await i.json()}catch(a){return console.error("[ClientLogs] Failed to send:",a),null}}sendBeacon(e,t){console.log("[ClientLogs] Sending beacon:",{message:e,metadata:t});try{const n={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),logs:{[e]:[`${e}`]},metadata:t};if(typeof navigator<"u"&&navigator.sendBeacon){const r=this.baseUrl.startsWith("http")?this.baseUrl:`${window.location.origin}${this.baseUrl}`,a=new Blob([JSON.stringify(n)],{type:"application/json"}),i=navigator.sendBeacon(r,a);return i?console.log("[ClientLogs] Beacon accepted"):console.warn("[ClientLogs] Beacon rejected (queue full?)"),i}else return console.log("[ClientLogs] sendBeacon not available, using fetch fallback"),fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),keepalive:!0}).catch(r=>{console.error("[ClientLogs] Fetch fallback failed:",r)}),!0}catch(n){return console.error("[ClientLogs] Failed to send beacon:",n),!1}}async clearLogs(e="client.log",t){if(t&&typeof window<"u"&&!window.location.pathname.includes(t))return!1;try{const n=`${this.baseUrl}?customLogFile=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?(await r.json()).success:(console.error("[ClientLogs] Failed to clear logs:",r.status),!1)}catch(n){return console.error("[ClientLogs] Failed to clear logs:",n),!1}}async clearJsonLogs(e){try{const n=`${this.baseUrl.replace("/client-logs","/client-logs-json")}?filename=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?!0:(console.error("[ClientLogs] Failed to clear JSON logs:",r.status),!1)}catch(t){return console.error("[ClientLogs] Failed to clear JSON logs:",t),!1}}async clearLogsAndAddVersion(e,t,n){const r=await this.clearLogs(e,n);return r&&await this.sendLogs("startup",{v:t},e),r}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const a=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),a}catch(a){throw clearTimeout(r),a instanceof Error&&a.name==="AbortError"?new Error("Request timeout"):a}}}new ga;const ph={theme:"system",setTheme:()=>null},Zi=h.createContext(ph);function hh({children:s,defaultTheme:e="system",storageKey:t="vite-ui-theme",...n}){const[r,a]=h.useState(()=>localStorage.getItem(t)||e);h.useEffect(()=>{const c=window.document.documentElement;if(c.classList.remove("light","dark"),r==="system"){const l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";c.classList.add(l);return}c.classList.add(r)},[r]);const i={theme:r,setTheme:c=>{localStorage.setItem(t,c),a(c)}};return o.jsx(Zi.Provider,{...n,value:i,children:s})}const fh=()=>{const s=h.useContext(Zi);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s};function mh(){const{theme:s,setTheme:e}=fh(),t=()=>{e(s==="dark"?"light":"dark")},n=s==="dark"||s==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return o.jsx(se,{onClick:t,variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","aria-label":n?"Switch to light mode":"Switch to dark mode",children:n?o.jsx(Cu,{className:"h-5 w-5"}):o.jsx(ju,{className:"h-5 w-5"})})}const Ye=zd,at=Hd,bn=Gd,Ge=h.forwardRef(({className:s,align:e="center",sideOffset:t=4,style:n,...r},a)=>o.jsx(qd,{children:o.jsx(Jo,{ref:a,align:e,sideOffset:t,style:{zIndex:Je.popover,...n},className:B("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...r})}));Ge.displayName=Jo.displayName;function gh(s){return"initialConfig"in s&&typeof s.children=="function"}function en(s){if(gh(s)){const{storageKey:m,initialConfig:g,children:x,prefix:y="watcher-"}=s,w=`${y}${m}`,[v,b]=h.useState(()=>{try{const N=localStorage.getItem(w);if(N)return JSON.parse(N)}catch(N){console.error(`Failed to load config from localStorage (${w}):`,N)}return g}),[j,S]=h.useState(!1);h.useEffect(()=>{try{localStorage.setItem(w,JSON.stringify(v))}catch(N){console.error(`Failed to save config to localStorage (${w}):`,N)}},[v,w]);const C=h.useMemo(()=>({buttonLabel:N,icon:A=o.jsx(Vt,{className:"h-4 w-4"}),variant:I="ghost",size:k="icon",buttonClassName:P="",contentClassName:W="",contentStyle:R,align:F="end",side:L="bottom",title:T,children:M})=>o.jsxs(Ye,{open:j,onOpenChange:S,"data-test":"config-popover",children:[o.jsx(at,{asChild:!0,children:o.jsx(se,{variant:I,size:k,className:`config-button ${P}`,title:T||"Configuration","data-test":"config-button",children:N?o.jsxs(o.Fragment,{children:[A,N&&o.jsx("span",{className:"ml-2","data-test":"config-button-label",children:N})]}):A})}),o.jsxs(Ge,{className:`config-panel ${W}`,style:{zIndex:Je.draggablePopoverDropdown,...R},align:F,side:L,"data-test":"config-panel",onInteractOutside:D=>{D.target.closest(".config-panel")&&D.preventDefault()},onPointerDownOutside:D=>{D.target.closest(".config-panel")&&D.preventDefault()},children:[T&&o.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:o.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:T})}),o.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:M})]})]}),[j,S]);return o.jsx(o.Fragment,{children:x(v,b,C)})}const{children:e,buttonLabel:t,icon:n=o.jsx(Vt,{className:"h-4 w-4"}),variant:r="ghost",size:a="icon",buttonClassName:i="",contentClassName:c="",align:l="end",side:d="bottom",title:p}=s,[u,f]=h.useState(!1);return o.jsxs(Ye,{open:u,onOpenChange:f,"data-test":"config-popover",children:[o.jsx(at,{asChild:!0,children:o.jsx(se,{variant:r,size:a,className:`config-button ${i}`,title:p||"Configuration","data-test":"config-button",children:t?o.jsxs(o.Fragment,{children:[n,t&&o.jsx("span",{className:"ml-2","data-test":"config-button-label",children:t})]}):n})}),o.jsxs(Ge,{className:`config-panel ${c}`,style:{zIndex:Je.draggablePopoverDropdown},align:l,side:d,"data-test":"config-panel",onInteractOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},onPointerDownOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},children:[p&&o.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:o.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:p})}),o.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:e})]})]})}const xh=Qs("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),me=h.forwardRef(({className:s,...e},t)=>o.jsx(Yo,{ref:t,className:B(xh(),s),...e}));me.displayName=Yo.displayName;const kt=h.forwardRef(({className:s,...e},t)=>o.jsx(Xo,{className:B("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",s),...e,ref:t,children:o.jsx(Vd,{className:B("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));kt.displayName=Xo.displayName;const vh=()=>{const s=h.useRef(null),[e,t]=h.useState(!1),[n,r]=h.useState(!1),[a,i]=h.useState(null),c=()=>{try{const p=oe.export(),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=`global-state-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(f),be.success("Global state exported successfully")}catch(p){console.error("Error exporting state:",p),be.error("Failed to export global state")}},l=()=>{var p;(p=s.current)==null||p.click()},d=p=>{var m;const u=(m=p.target.files)==null?void 0:m[0];if(!u)return;t(!0),i(null);const f=new FileReader;f.onload=g=>{var y;const x=(y=g.target)==null?void 0:y.result;if(typeof x=="string")try{n&&oe.reset(),oe.import(x)?(i({success:!0}),be.success("Global state imported successfully")):(i({success:!1,error:"Invalid JSON format"}),be.error("Failed to import: invalid JSON format"))}catch(w){console.error("Error importing state:",w);const v=w instanceof Error?w.message:"Unknown error";i({success:!1,error:v}),be.error(`Failed to import: ${v}`)}else console.error("Failed to read file content."),be.error("Failed to read file content"),i({success:!1,error:"Failed to read file"});t(!1),s.current&&(s.current.value="")},f.onerror=g=>{console.error("Error reading file:",g),be.error("Error reading file"),i({success:!1,error:"Error reading file"}),t(!1),s.current&&(s.current.value="")},f.readAsText(u)};return o.jsxs("div",{className:"space-y-4","data-test":"global-state-io-panel",children:[o.jsxs("div",{"data-test":"global-state-export-section",children:[o.jsx(me,{className:"text-sm font-medium",children:"Export"}),o.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download global state as JSON"}),o.jsxs(se,{variant:"outline",size:"sm",onClick:c,className:"w-full","data-test":"global-state-export-button",children:[o.jsx(Nu,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),o.jsxs("div",{"data-test":"global-state-import-section",children:[o.jsx(me,{className:"text-sm font-medium",children:"Import"}),o.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import global state from a JSON file"}),o.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"global-state-replace-mode-control",children:[o.jsxs("div",{children:[o.jsx(me,{htmlFor:"global-state-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),o.jsx(kt,{id:"global-state-replace-mode",checked:n,onCheckedChange:r,disabled:e,"data-test":"global-state-replace-mode-switch"})]}),o.jsxs(se,{variant:"outline",size:"sm",onClick:l,disabled:e,className:"w-full","data-test":"global-state-import-select-file-button",children:[o.jsx(Eu,{className:"h-4 w-4 mr-2"}),e?"Importing...":"Select File"]}),o.jsx("input",{type:"file",ref:s,accept:".json",style:{display:"none"},onChange:d,"data-test":"global-state-import-file-input"})]}),a&&o.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"global-state-import-result",children:[a.success&&o.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"global-state-import-success",children:[o.jsx(ku,{className:"h-3 w-3"}),o.jsx("span",{children:"Import successful"})]}),!a.success&&o.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"global-state-import-error",children:[o.jsx(Ai,{className:"h-3 w-3"}),o.jsx("span",{children:a.error||"Import failed"})]})]})]})},wh=()=>o.jsx(en,{storageKey:"global-state-io",title:"State Import/Export",icon:o.jsx(Si,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end","data-test":"global-state-io-button",children:o.jsx(vh,{})});new ga;const bh={primaryColor:"blue",setPrimaryColor:()=>null},yh=h.createContext(bh),Sh=()=>{const s=h.useContext(yh);if(s===void 0)throw new Error("usePrimaryColor must be used within a PrimaryColorProvider");return s};function Ch({onColorSelect:s,selectedHue:e=217}){const t=h.useRef(null),[n,r]=h.useState(!1),[a,i]=h.useState(e);h.useEffect(()=>{n||i(e)},[e,n]),h.useEffect(()=>{const g=t.current;if(!g)return;const x=g.getContext("2d");if(!x)return;const y=g.width,w=g.height,v=40,b=(w-v)/2,j=`hsl(${a} 70% 90%)`;x.fillStyle=j,x.fillRect(0,0,y,w);for(let C=0;C<y;C+=1){const N=C/y*360;x.fillStyle=`hsl(${N}, 100%, 50%)`,x.fillRect(C,b,1,v)}x.strokeStyle="#ccc",x.lineWidth=2,x.strokeRect(0,b,y,v);const S=a/360*y;x.strokeStyle="#000",x.lineWidth=3,x.beginPath(),x.moveTo(S,b-8),x.lineTo(S,b+v+8),x.stroke(),x.strokeStyle="#fff",x.lineWidth=1,x.beginPath(),x.moveTo(S,b-8),x.lineTo(S,b+v+8),x.stroke()},[a]);const c=g=>{const x=t.current;if(!x)return;const y=x.getBoundingClientRect(),w=g.clientX-y.left,v=Math.round(w/x.width*360),b=Math.max(0,Math.min(360,v));i(b),s(`${b} 70% 60%`)},l=()=>r(!0),d=()=>r(!1),p=g=>{n&&c(g)},u=()=>r(!0),f=()=>r(!1),m=g=>{if(!n)return;const x=t.current;if(!x)return;const y=x.getBoundingClientRect(),w=g.touches[0].clientX-y.left,v=Math.round(w/x.width*360),b=Math.max(0,Math.min(360,v));i(b),s(`${b} 70% 60%`)};return o.jsxs("div",{className:"color-strip-container flex flex-col items-center gap-3",children:[o.jsx("canvas",{ref:t,width:200,height:80,onClick:c,onMouseDown:l,onMouseUp:d,onMouseMove:p,onMouseLeave:()=>r(!1),onTouchStart:u,onTouchEnd:f,onTouchMove:m,className:"color-strip cursor-pointer rounded touch-none"}),o.jsx("div",{className:"color-info text-center",children:o.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hue: ",a,"Â°"]})})]})}const An=Vo,hC=Kd,jh=oa,ec=h.forwardRef(({className:s,style:e,...t},n)=>o.jsx(Jn,{ref:n,className:B("fixed inset-0 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),style:{zIndex:Je.popover,...e},...t}));ec.displayName=Jn.displayName;const Pn=h.forwardRef(({className:s,children:e,style:t,...n},r)=>o.jsxs(jh,{children:[o.jsx(ec,{}),o.jsxs(Xs,{ref:r,className:B("fixed left-[50%] top-[50%] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),style:{zIndex:Je.popover,...t},...n,children:[e,o.jsxs(ia,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[o.jsx(ct,{className:"h-4 w-4"}),o.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Pn.displayName=Xs.displayName;const Rn=({className:s,...e})=>o.jsx("div",{className:B("flex flex-col space-y-1.5 text-center sm:text-left",s),...e});Rn.displayName="DialogHeader";const Nh=({className:s,...e})=>o.jsx("div",{className:B("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...e});Nh.displayName="DialogFooter";const Hs=h.forwardRef(({className:s,...e},t)=>o.jsx(Yn,{ref:t,className:B("text-lg font-semibold leading-none tracking-tight",s),...e}));Hs.displayName=Yn.displayName;const tc=h.forwardRef(({className:s,...e},t)=>o.jsx(Xn,{ref:t,className:B("text-sm text-muted-foreground",s),...e}));tc.displayName=Xn.displayName;const Eh=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose","white","black"],kh={slate:"#64748b",gray:"#6b7280",zinc:"#71717a",neutral:"#737373",stone:"#78716c",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e",white:"#ffffff",black:"#000000"},Ih={slate:"hsl(215 16% 47%)",gray:"hsl(218 11% 43%)",zinc:"hsl(220 13% 47%)",neutral:"hsl(0 0% 45%)",stone:"hsl(12 6% 44%)",red:"hsl(0 84% 60%)",orange:"hsl(24 97% 61%)",amber:"hsl(45 96% 71%)",yellow:"hsl(54 100% 68%)",lime:"hsl(84 85% 67%)",green:"hsl(142 72% 64%)",emerald:"hsl(160 84% 65%)",teal:"hsl(168 86% 55%)",cyan:"hsl(191 87% 55%)",sky:"hsl(198 93% 60%)",blue:"hsl(217 91% 60%)",indigo:"hsl(226 86% 61%)",violet:"hsl(259 84% 63%)",purple:"hsl(280 85% 64%)",fuchsia:"hsl(289 86% 66%)",pink:"hsl(330 81% 60%)",rose:"hsl(356 84% 61%)",white:"hsl(0 0% 100%)",black:"hsl(0 0% 0%)"};function Th({isOpen:s,onOpenChange:e}){const{primaryColor:t,setPrimaryColor:n}=Sh(),[r,a]=h.useState(217),[i,c]=h.useState(t),l=p=>{c(p),n(p);const u=Ih[p],f=parseInt(u.split(" ")[0].replace("hsl(",""));a(f)},d=p=>{const u=parseInt(p.split(" ")[0]);a(u);const f=`${u} 70% 90%`,m=`${u} 70% 85%`,g=`${u} 70% 80%`,x=`${u} 70% 70%`;n(`hsl-${u}`),c(`hsl-${u}`);const y=window.document.documentElement;y.style.setProperty("--background",f),y.style.setProperty("--card",m),y.style.setProperty("--tab",g),y.style.setProperty("--active",x)};return o.jsx(An,{open:s,onOpenChange:e,children:o.jsxs(Pn,{className:"theme-settings-dialog sm:max-w-3xl",children:[o.jsxs(Rn,{children:[o.jsx(Hs,{className:"theme-settings-title",children:"Theme Settings"}),o.jsx(tc,{className:"theme-settings-description",children:"Choose a predefined color or use the color wheel for custom colors"})]}),o.jsxs("div",{className:"predefined-colors-section mb-6",children:[o.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Predefined Colors"}),o.jsx("div",{className:"predefined-colors-grid grid grid-cols-12 gap-2",children:Eh.map(p=>o.jsx("button",{type:"button",title:p,onClick:()=>l(p),className:B("color-button w-8 h-8 rounded-full border-2 cursor-pointer transition-all","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","hover:scale-110",i===p?"ring-2 ring-ring ring-offset-2 scale-110":"border-muted",p==="white"&&"border-neutral-300"),style:{backgroundColor:kh[p]},"aria-label":`Select ${p} theme`},p))})]}),o.jsxs("div",{className:"theme-wheel-container flex gap-6 items-start",children:[o.jsxs("div",{className:"flex-shrink-0",children:[o.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Custom Color"}),o.jsx(Ch,{onColorSelect:d,selectedHue:r})]}),o.jsxs("div",{className:"flex-1 space-y-3",children:[o.jsx("div",{className:"theme-preview-title",children:o.jsx("p",{className:"text-sm font-medium text-foreground",children:"Live Preview:"})}),o.jsx("div",{className:"theme-preview-bg p-4 rounded-lg border-2",style:{backgroundColor:`hsl(${r} 70% 90%)`},children:o.jsx("p",{className:"text-xs font-semibold text-gray-700",children:"Background"})}),o.jsx("div",{className:"theme-preview-card p-4 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 85%)`},children:o.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Card"})}),o.jsx("div",{className:"theme-preview-tab p-3 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 80%)`},children:o.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Tab"})}),o.jsx("div",{className:"theme-preview-active p-3 rounded-lg border font-semibold",style:{backgroundColor:`hsl(${r} 70% 70%)`},children:o.jsx("p",{className:"text-xs text-gray-900",children:"Active/Selected"})})]})]})]})})}function Ah({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1);return o.jsxs(o.Fragment,{children:[o.jsx(en,{title:"Settings",icon:o.jsx(Vt,{className:"h-5 w-5"}),variant:s,size:e,align:"end",storageKey:"app-settings","data-test":"global-config-button",children:o.jsxs("div",{className:"settings-panel space-y-3","data-test":"config-panel",children:[o.jsxs("div",{className:"theme-toggle-section",children:[o.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme"}),o.jsx(mh,{})]}),o.jsxs("div",{className:"theme-settings-section",children:[o.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme Colors"}),o.jsxs(se,{variant:"outline",size:"sm",onClick:()=>n(!0),className:"w-full flex items-center gap-2","data-test":"customize-colors-button",children:[o.jsx(Iu,{className:"h-4 w-4"}),"Customize Colors"]})]}),o.jsx("div",{className:"divider my-3 border-t"}),o.jsxs("div",{className:"state-import-export-section",children:[o.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Global State"}),o.jsx(wh,{})]})]})}),o.jsx(Th,{isOpen:t,onOpenChange:n})]})}class Ph{constructor(){Q(this,"isActive",!1);Q(this,"callbacks",new Set);Q(this,"tooltipOwnerId",null);Q(this,"panelOwnerId",null);Q(this,"clickOwnerId",null)}subscribe(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}getState(){return this.isActive}toggle(){this.isActive=!this.isActive,this.notifySubscribers()}setState(e){this.isActive!==e&&(this.isActive=e,this.notifySubscribers())}activate(){this.setState(!0)}deactivate(){this.setState(!1)}claimTooltip(e){this.tooltipOwnerId=e}releaseTooltip(e){this.tooltipOwnerId===e&&(this.tooltipOwnerId=null)}canRenderTooltip(e){return this.tooltipOwnerId===null?e===null:this.tooltipOwnerId===e}claimPanel(e){this.panelOwnerId=e}releasePanel(e){this.panelOwnerId===e&&(this.panelOwnerId=null)}canRenderPanel(e){return this.panelOwnerId===null?e===null:this.panelOwnerId===e}claimClickHandling(e){this.clickOwnerId=e}releaseClickHandling(e){this.clickOwnerId===e&&(this.clickOwnerId=null)}canHandleClicks(e){return this.clickOwnerId===null?e===null:this.clickOwnerId===e}notifySubscribers(){this.callbacks.forEach(e=>e(this.isActive))}}const ut=new Ph,us=({isVisible:s,onClose:e,title:t,children:n,className:r,initialPosition:a="bottom-right",triggerPosition:i,shouldCloseManually:c=!1,resizable:l=!1,initialSize:d,onSizeChange:p,onPositionChange:u,headerActions:f,footer:m,portalContainer:g,showPinButton:x=!1,showInspectorButton:y=!1,zIndex:w=Je.draggablePopover,anchorOrigin:v="top-left"})=>{const b=i??(typeof a=="object"?a:void 0),j=h.useMemo(()=>{if(!b||!d)return null;const te=window.innerWidth,$=window.innerHeight,V=d.width,ee=d.height;let le=b.x,ne=b.y;return le+V>te&&(le=te-V-16),le<16&&(le=16),ne+ee>$&&(ne=$-ee-32),ne<16&&(ne=16),{x:le,y:ne}},[b,d]),[S,C]=h.useState(null),[N,A]=h.useState(d||null),[I,k]=h.useState(!1),[P,W]=h.useState(!1),[R,F]=h.useState(null),[L,T]=h.useState({x:0,y:0}),[M,D]=h.useState({x:0,y:0,width:0,height:0,posX:0,posY:0}),[H,Y]=h.useState(!1),[O,q]=h.useState(!1),K=h.useRef(null),G=h.useRef(null),U=h.useRef(!1),Z=v!=="top-left"&&typeof a=="object",[ue,we]=h.useState(!Z);h.useEffect(()=>{if(!s||U.current||v==="top-left"){s&&v==="top-left"&&we(!0);return}typeof a=="object"&&requestAnimationFrame(()=>{if(!G.current)return;const te=G.current.getBoundingClientRect();let $=a.x,V=a.y;(v==="top-right"||v==="bottom-right")&&($=a.x-te.width),(v==="bottom-left"||v==="bottom-right")&&(V=a.y-te.height);const ee=16;$=Math.max(ee,Math.min($,window.innerWidth-te.width-ee)),V=Math.max(ee,Math.min(V,window.innerHeight-te.height-ee)),C({x:$,y:V}),U.current=!0,we(!0)})},[s,a,v]),h.useEffect(()=>{s||(U.current=!1,we(!(v!=="top-left"&&typeof a=="object")))},[s,v,a]);const ae=te=>{const $=te.target;if(!($.tagName==="INPUT"||$.tagName==="TEXTAREA"||$.tagName==="SELECT"||$.tagName==="BUTTON"||$.closest("button")!==null||$.closest("input")!==null||$.closest("textarea")!==null||$.closest("select")!==null||$.classList.contains("resize-handle"))&&(te.preventDefault(),G.current)){const ee=G.current.getBoundingClientRect(),le=ee.left,ne=ee.top;C({x:le,y:ne}),k(!0),T({x:te.clientX-le,y:te.clientY-ne})}},Te=te=>{const $=te.target;if($.tagName==="INPUT"||$.tagName==="TEXTAREA"||$.tagName==="SELECT"||$.tagName==="BUTTON"||$.closest("button")!==null||$.closest("input")!==null||$.closest("textarea")!==null||$.closest("select")!==null||$.classList.contains("resize-handle"))return;const ee=te.touches[0];if(ee&&G.current){const le=G.current.getBoundingClientRect(),ne=le.left,de=le.top;C({x:ne,y:de}),k(!0),T({x:ee.clientX-ne,y:ee.clientY-de})}},ke=te=>$=>{if($.stopPropagation(),G.current){const V=G.current.getBoundingClientRect();W(!0),F(te),D({x:$.clientX,y:$.clientY,width:V.width,height:V.height,posX:V.left,posY:V.top})}},Ee=te=>$=>{$.stopPropagation();const V=$.touches[0];if(V&&G.current){const ee=G.current.getBoundingClientRect();W(!0),F(te),D({x:V.clientX,y:V.clientY,width:ee.width,height:ee.height,posX:ee.left,posY:ee.top})}},$e=te=>{te.stopPropagation(),ut.toggle();const $=ut.getState();be.success(`Element Inspector ${$?"activated":"deactivated"}`,{description:$?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};h.useEffect(()=>{if(c||!s||H||O){K.current&&(clearTimeout(K.current),K.current=null);return}return K.current=setTimeout(()=>{e()},2e3),()=>{K.current&&(clearTimeout(K.current),K.current=null)}},[s,H,O,e,c]),h.useEffect(()=>{s||(q(!1),C(null))},[s]);const ge=()=>{q(!0)};h.useEffect(()=>{if(!I)return;const te=document.body.style.userSelect;document.body.style.userSelect="none";const $=le=>{C({x:le.clientX-L.x,y:le.clientY-L.y})},V=le=>{const ne=le.touches[0];ne&&(le.preventDefault(),C({x:ne.clientX-L.x,y:ne.clientY-L.y}))},ee=()=>{k(!1),S&&u&&u(S)};return document.addEventListener("mousemove",$),document.addEventListener("mouseup",ee),document.addEventListener("touchmove",V,{passive:!1}),document.addEventListener("touchend",ee),()=>{document.removeEventListener("mousemove",$),document.removeEventListener("mouseup",ee),document.removeEventListener("touchmove",V),document.removeEventListener("touchend",ee),document.body.style.userSelect=te}},[I,L,S,u]),h.useEffect(()=>{if(!P||!R)return;const te=300,$=200,V=document.body.style.userSelect;document.body.style.userSelect="none";const ee=(fe,xe)=>{const Ce=fe-M.x,Se=xe-M.y;let _=M.width,E=M.height,z=M.posX,pe=M.posY;if(R.includes("e"))_=Math.max(te,M.width+Ce);else if(R.includes("w")){const X=M.width-Ce;X>=te?(_=X,z=M.posX+Ce):(_=te,z=M.posX+(M.width-te))}if(R.includes("s"))E=Math.max($,M.height+Se);else if(R.includes("n")){const X=M.height-Se;X>=$?(E=X,pe=M.posY+Se):(E=$,pe=M.posY+(M.height-$))}return{newWidth:_,newHeight:E,newPosX:z,newPosY:pe}},le=fe=>{const{newWidth:xe,newHeight:Ce,newPosX:Se,newPosY:_}=ee(fe.clientX,fe.clientY);A({width:xe,height:Ce}),(R.includes("w")||R.includes("n"))&&C({x:Se,y:_})},ne=fe=>{const xe=fe.touches[0];if(!xe)return;fe.preventDefault();const{newWidth:Ce,newHeight:Se,newPosX:_,newPosY:E}=ee(xe.clientX,xe.clientY);A({width:Ce,height:Se}),(R.includes("w")||R.includes("n"))&&C({x:_,y:E})},de=()=>{W(!1),F(null),N&&p&&p(N),S&&u&&u(S)};return document.addEventListener("mousemove",le),document.addEventListener("mouseup",de),document.addEventListener("touchmove",ne,{passive:!1}),document.addEventListener("touchend",de),()=>{document.removeEventListener("mousemove",le),document.removeEventListener("mouseup",de),document.removeEventListener("touchmove",ne),document.removeEventListener("touchend",de),document.body.style.userSelect=V}},[P,R,M,N,S,p,u]),h.useEffect(()=>{if(!s||c)return;const te=$=>{$.key==="Escape"&&e()};return document.addEventListener("keydown",te),()=>{document.removeEventListener("keydown",te)}},[s,e,c]),h.useEffect(()=>{j&&!S&&C(j)},[j,S]);const ie=S||j;if(!s)return null;const re=o.jsxs("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:Je.backdrop},"data-test":"draggable-popover-wrapper",children:[!c&&o.jsx("div",{className:"backdrop-click-outside fixed inset-0",style:{zIndex:Je.backdrop,pointerEvents:"auto"},onClick:e,"aria-hidden":"true","data-test":"draggable-popover-backdrop"}),o.jsxs("div",{ref:G,className:Us("fixed","w-80 bg-background text-foreground border border-border rounded-lg shadow-lg","flex flex-col",l&&"relative",r),style:{zIndex:w,pointerEvents:"auto",opacity:ue?1:0,top:ie?`${ie.y}px`:a==="bottom-right"?"1rem":typeof a=="object"?`${a.y}px`:"auto",right:!ie&&a==="bottom-right"?"1rem":"auto",left:ie?`${ie.x}px`:typeof a=="object"?`${a.x}px`:"auto",bottom:"auto",cursor:P&&R?R==="nw"||R==="se"?"nwse-resize":R==="ne"||R==="sw"?"nesw-resize":R==="n"||R==="s"?"ns-resize":R==="e"||R==="w"?"ew-resize":"default":"default",width:N?`${N.width}px`:void 0,height:N?`${N.height}px`:void 0,maxHeight:"calc(100vh - 2rem)"},onMouseEnter:ge,"data-test":"draggable-popover-container",children:[o.jsxs("div",{className:"header px-3 py-2 border-b border-border flex justify-between items-center cursor-grab active:cursor-grabbing",onMouseDown:ae,onTouchStart:Te,"data-test":"draggable-popover-header",children:[o.jsx("h3",{className:"title-text text-sm font-semibold select-none","data-test":"draggable-popover-title",children:t}),o.jsxs("div",{className:"action-buttons flex items-center gap-1","data-test":"draggable-popover-actions",children:[f,y&&o.jsx("button",{className:"inspector-button p-1 rounded hover:bg-accent transition-colors",onClick:$e,onMouseDown:te=>te.stopPropagation(),"aria-label":"Toggle Element Inspector",title:"Toggle Element Inspector","data-test":"draggable-popover-inspector-button",children:o.jsx(Tu,{size:14})}),x&&o.jsx("button",{className:Us("pin-button p-1 rounded hover:bg-accent transition-colors",H&&"bg-accent text-accent-foreground"),onClick:te=>{te.stopPropagation(),Y(!H)},onMouseDown:te=>te.stopPropagation(),"aria-label":H?"Unpin popover":"Pin popover",title:H?"Unpin":"Pin","data-test":"draggable-popover-pin-button",children:o.jsx(Au,{size:14,className:Us(H&&"fill-current")})}),o.jsx("button",{className:"close-button p-1 rounded hover:bg-accent transition-colors",onClick:te=>{te.stopPropagation(),e()},onMouseDown:te=>te.stopPropagation(),"aria-label":"Close popover",title:"Close","data-test":"draggable-popover-close-button",children:o.jsx(ct,{size:14})})]})]}),o.jsx("div",{className:"flex-1 min-h-0 overflow-auto","data-test":"draggable-popover-content",children:n}),m&&o.jsx("div",{className:"flex-shrink-0 border-t border-border","data-test":"draggable-popover-footer",children:m}),l&&o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"resize-handle absolute top-0 left-0 w-3 h-3 cursor-nwse-resize",onMouseDown:ke("nw"),onTouchStart:Ee("nw"),"data-test":"draggable-popover-resize-nw"}),o.jsx("div",{className:"resize-handle absolute top-0 right-0 w-3 h-3 cursor-nesw-resize",onMouseDown:ke("ne"),onTouchStart:Ee("ne"),"data-test":"draggable-popover-resize-ne"}),o.jsx("div",{className:"resize-handle absolute bottom-0 left-0 w-3 h-3 cursor-nesw-resize",onMouseDown:ke("sw"),onTouchStart:Ee("sw"),"data-test":"draggable-popover-resize-sw"}),o.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-3 h-3 cursor-nwse-resize",onMouseDown:ke("se"),onTouchStart:Ee("se"),style:{background:"linear-gradient(135deg, transparent 50%, currentColor 50%)",opacity:.3},"data-test":"draggable-popover-resize-se"}),o.jsx("div",{className:"resize-handle absolute top-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:ke("n"),onTouchStart:Ee("n"),"data-test":"draggable-popover-resize-n"}),o.jsx("div",{className:"resize-handle absolute bottom-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:ke("s"),onTouchStart:Ee("s"),"data-test":"draggable-popover-resize-s"}),o.jsx("div",{className:"resize-handle absolute left-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:ke("w"),onTouchStart:Ee("w"),"data-test":"draggable-popover-resize-w"}),o.jsx("div",{className:"resize-handle absolute right-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:ke("e"),onTouchStart:Ee("e"),"data-test":"draggable-popover-resize-e"})]})]})]});return Id.createPortal(re,g??document.body)},to=5,Rh=300,Dh=800,so={indicatorBg:"#dc2626",indicatorText:"#ffffff"},no={background:"rgba(254, 205, 211, 0.5)",border:"#06b6d4"},Lr={success:"#22c55e",hover:"#3b82f6"},Dn={click:{bg:"#dbeafe",text:"#2563eb"},drag:{bg:"#fef3c7",text:"#d97706"},type:{bg:"#dcfce7",text:"#16a34a"}};function ro(s){const e=s.getAttribute("data-test");if(e)return`[data-test="${e}"]`;const t=s.id;if(t&&!t.match(/^[:\d]|css-/))return`#${t}`;const n=Array.from(s.classList).filter(r=>!r.startsWith("css-")&&!r.match(/^[a-z]+-[\da-f]{6,}/i)).join(".");return n?`.${n}`:s.tagName.toLowerCase()}function Oh(s,e,t,n){const r=Math.abs(t-s),a=Math.abs(n-e);return r>to||a>to}function Lh({targetRef:s,enabled:e}){const[t,n]=h.useState([]),[r,a]=h.useState(!1),i=h.useRef({isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}),c=h.useRef(null),l=h.useRef(null),d=h.useRef({element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""}),p=h.useCallback(b=>{n(j=>[...j,b])},[]),u=h.useCallback(()=>{const b=d.current;b.element&&(b.element.style.backgroundColor=b.originalBackground,b.element.style.outline=b.originalOutline,b.element.style.outlineOffset=b.originalOutlineOffset,d.current={element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""})},[]),f=h.useCallback(b=>{if(!r)return;const j=b.target;if(!j||j.closest('[data-test="capture-panel-v2"]')){u();return}const S=ro(j);i.current={isDragging:!1,startX:b.clientX,startY:b.clientY,startTime:Date.now(),selector:S,element:j}},[r,u]),m=h.useCallback(b=>{if(!r)return;const j=i.current;if(!j.element)return;const S=b.clientX,C=b.clientY,N=Date.now()-j.startTime;Oh(j.startX,j.startY,S,C)?p({type:"drag",timestamp:j.startTime,data:{startX:j.startX,startY:j.startY,endX:S,endY:C,selector:j.selector,duration:N}}):p({type:"click",timestamp:j.startTime,data:{x:j.startX,y:j.startY,selector:j.selector}}),i.current={isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}},[r,p]),g=h.useCallback(b=>{if(!r)return;const j=b.target;if(!j||!("value"in j))return;const S=ro(j),C=j.value;c.current&&window.clearTimeout(c.current),l.current={selector:S,value:C},c.current=window.setTimeout(()=>{l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},Rh)},[r,p]),x=h.useCallback(b=>{if(!r)return;const j=b.target;if(j){if(j.closest('[data-test="capture-panel-v2"]')||j.closest('[data-test="recording-panel"]')){u();return}d.current.element!==j&&(u(),d.current={element:j,originalBackground:j.style.backgroundColor,originalOutline:j.style.outline,originalOutlineOffset:j.style.outlineOffset},j.style.backgroundColor=no.background,j.style.outline=`2px solid ${no.border}`,j.style.outlineOffset="1px")}},[r,u]);h.useEffect(()=>{if(!r)return;const b=document;return b.addEventListener("pointerdown",f),b.addEventListener("pointerup",m),b.addEventListener("pointermove",x),b.addEventListener("input",g,!0),()=>{b.removeEventListener("pointerdown",f),b.removeEventListener("pointerup",m),b.removeEventListener("pointermove",x),b.removeEventListener("input",g,!0),u(),c.current&&window.clearTimeout(c.current)}},[e,r,s,f,m,x,g,u]);const y=h.useCallback(()=>{a(!0)},[]),w=h.useCallback(()=>{a(!1),u(),c.current&&(window.clearTimeout(c.current),c.current=null),l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},[p,u]),v=h.useCallback(()=>{n([])},[]);return{interactions:t,isRecording:r,startRecording:y,stopRecording:w,clearRecording:v}}function sc(s){try{switch(s.type){case"click":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.click();const n=t.style.outline;t.style.outline=`3px solid ${Lr.success}`,setTimeout(()=>{t.style.outline=n},300)},300),be.success(`Clicked: ${e.selector}`)):be.error(`Element not found: ${e.selector}`);break}case"drag":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const n=t.getBoundingClientRect(),r=new PointerEvent("pointerdown",{bubbles:!0,clientX:n.left+(e.startX-n.left),clientY:n.top+(e.startY-n.top)}),a=new PointerEvent("pointerup",{bubbles:!0,clientX:e.endX,clientY:e.endY});t.dispatchEvent(r),setTimeout(()=>{t.dispatchEvent(a)},Math.min(e.duration,500))},300),be.success(`Dragged: ${e.selector}`)):be.error(`Element not found: ${e.selector}`);break}case"type":{const e=s.data,t=document.querySelector(e.selector);t&&"value"in t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.focus(),t.value=e.value,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const n=t.style.outline;t.style.outline=`3px solid ${Lr.success}`,setTimeout(()=>{t.style.outline=n},300)},300),be.success(`Typed into: ${e.selector}`)):be.error(`Input not found: ${e.selector}`);break}}}catch(e){be.error(`Replay failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async function _h(s,e){be.info(`Replaying ${e+1} interaction${e>0?"s":""}...`);for(let t=0;t<=e;t++)sc(s[t]),t<e&&await new Promise(n=>setTimeout(n,Dh))}let ts=null;function Mh(s){switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function Fh(s){nc();const e=Mh(s);try{const t=document.querySelector(e);if(t){const n=t.getBoundingClientRect();n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth||t.scrollIntoView({behavior:"smooth",block:"center"}),ts={element:t,originalOutline:t.style.outline,originalOutlineOffset:t.style.outlineOffset},t.style.outline=`3px solid ${Lr.hover}`,t.style.outlineOffset="2px"}}catch{}}function nc(){ts&&(ts.element.style.outline=ts.originalOutline,ts.element.style.outlineOffset=ts.originalOutlineOffset,ts=null)}function $h(s,e){const t=s-e;return t<1e3?`+${t}ms`:t<6e4?`+${(t/1e3).toFixed(1)}s`:`+${(t/6e4).toFixed(1)}m`}function Uh({type:s}){switch(s){case"click":return o.jsx(pa,{className:"w-3 h-3"});case"drag":return o.jsx(ua,{className:"w-3 h-3"});case"type":return o.jsx(da,{className:"w-3 h-3"})}}function Bh({interaction:s}){switch(s.type){case"click":{const e=s.data;return o.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-click-details",children:["at (",e.x,", ",e.y,") â†’ ",o.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}case"drag":{const e=s.data;return o.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-drag-details",children:["(",e.startX,", ",e.startY,") â†’ (",e.endX,", ",e.endY,") [",e.duration,"ms]"]})}case"type":{const e=s.data,t=e.value.length>30?`${e.value.slice(0,30)}...`:e.value;return o.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-type-details",children:['"',t,'" â†’ ',o.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}}}function Wh({interactions:s,isRecording:e,onExport:t,onClear:n}){const r=s.length>0?s[0].timestamp:0;return o.jsxs("div",{className:"flex flex-col h-full","data-test":"recording-panel",children:[o.jsxs("div",{className:"flex items-center justify-between p-2 border-b",style:{backgroundColor:"#f9fafb"},"data-test":"recording-panel-header",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"text-xs font-medium",style:{color:"#6b7280"},children:"Recordings"}),e&&o.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium animate-pulse",style:{backgroundColor:so.indicatorBg,color:so.indicatorText},"data-test":"recording-indicator",children:[o.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-white"}),"REC"]}),o.jsxs("span",{className:"text-xs",style:{color:"#9ca3af"},"data-test":"interaction-count",children:["(",s.length,")"]})]}),o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:t,disabled:s.length===0,title:"Export as JSON","data-test":"export-recording-button",children:o.jsx(la,{className:"w-3 h-3"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:n,disabled:s.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:o.jsx(At,{className:"w-3 h-3"})})]})]}),o.jsx("div",{className:"flex-1 overflow-auto p-2","data-test":"recording-timeline",children:s.length===0?o.jsx("div",{className:"flex items-center justify-center h-full text-xs text-gray-400","data-test":"empty-recordings",children:e?"Recording... Click or type to capture interactions":"No recordings yet"}):o.jsx("div",{className:"space-y-1",children:s.map((a,i)=>o.jsxs("div",{className:"flex items-start gap-2 p-1.5 rounded hover:bg-gray-100 cursor-pointer group transition-colors relative",onClick:()=>sc(a),onMouseEnter:()=>Fh(a),onMouseLeave:nc,title:"Click to replay this interaction","data-test":`interaction-${i}`,children:[o.jsx("button",{className:"absolute top-1 right-1 w-5 h-5 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-blue-100 hover:bg-blue-200 text-blue-600",onClick:c=>{c.stopPropagation(),_h(s,i)},title:`Replay all ${i+1} interaction${i>0?"s":""} up to here`,"data-test":`replay-up-to-${i}`,children:o.jsx(Pu,{className:"w-3 h-3"})}),o.jsxs("div",{className:"flex flex-col items-center",children:[o.jsxs("div",{className:"w-5 h-5 rounded-full flex items-center justify-center relative",style:{backgroundColor:Dn[a.type].bg,color:Dn[a.type].text},"data-test":"interaction-icon",children:[o.jsx("span",{className:"group-hover:hidden",children:o.jsx(Uh,{type:a.type})}),o.jsx(Pi,{className:"w-3 h-3 hidden group-hover:block"})]}),i<s.length-1&&o.jsx("div",{className:"w-px h-3 bg-gray-200","data-test":"timeline-connector"})]}),o.jsxs("div",{className:"flex-1 min-w-0 pr-6",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"text-xs font-medium capitalize","data-test":"interaction-type",children:a.type}),o.jsx("span",{className:"text-xs text-gray-400","data-test":"interaction-time",children:$h(a.timestamp,r)}),o.jsx("span",{className:"text-xs text-green-600 opacity-0 group-hover:opacity-100 transition-opacity","data-test":"replay-hint",children:"â–¶ replay"})]}),o.jsx(Bh,{interaction:a})]})]},`${a.timestamp}-${i}`))})})]})}const Lt="watcher:recording-sessions";function zh(){const[s,e]=h.useState([]);h.useEffect(()=>{try{const u=localStorage.getItem(Lt);u&&e(JSON.parse(u))}catch(u){console.warn("[SessionStorage] Failed to load from localStorage:",u)}},[]);const t=h.useCallback((u,f,m)=>{const g={id:`session-${Date.now()}`,name:u,description:f,savedAt:Date.now(),interactions:m,sourceUrl:window.location.href};return e(x=>{const y=[...x,g];return localStorage.setItem(Lt,JSON.stringify(y)),y}),be.success("Session saved!"),g},[]),n=h.useCallback(u=>{const f=localStorage.getItem(Lt);if(!f)return;const g=JSON.parse(f).find(x=>x.id===u);return g&&be.success("Session loaded!"),g},[]),r=h.useCallback(u=>{e(f=>{const m=f.filter(g=>g.id!==u);return localStorage.setItem(Lt,JSON.stringify(m)),m}),be.success("Session deleted")},[]),a=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>x.id===u?{...x,...f}:x);return localStorage.setItem(Lt,JSON.stringify(g)),g}),be.success("Session updated")},[]),i=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(y=>{if(y.id!==u)return y;const w=[...y.interactions];return w[f]=m,{...y,interactions:w}});return localStorage.setItem(Lt,JSON.stringify(x)),x}),be.success("Interaction updated")},[]),c=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>{if(x.id!==u)return x;const y=x.interactions.filter((w,v)=>v!==f);return{...x,interactions:y}});return localStorage.setItem(Lt,JSON.stringify(g)),g}),be.success("Interaction deleted")},[]),l=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(y=>{if(y.id!==u)return y;const w=[...y.interactions];return w.splice(f,0,m),{...y,interactions:w}});return localStorage.setItem(Lt,JSON.stringify(x)),x}),be.success("Interaction inserted")},[]),d=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(y=>{if(y.id!==u)return y;const w=[...y.interactions];return w[f]=m,{...y,interactions:w}});return localStorage.setItem(Lt,JSON.stringify(x)),x}),be.success("Interaction replaced")},[]),p=h.useCallback(()=>{try{const u=localStorage.getItem(Lt);if(!u)return;const f=JSON.parse(u);return f.length===0?void 0:f[f.length-1]}catch{return}},[]);return{savedSessions:s,saveSession:t,loadSession:n,deleteSession:r,updateSession:a,updateInteraction:i,deleteInteraction:c,insertInteraction:l,replaceInteraction:d,getLastSession:p}}const rc=h.createContext(null);function Ct({open:s,onOpenChange:e,defaultOpen:t,...n}){const[r,a]=h.useState(t??!1),i=s!==void 0,c=i?s:r,l=h.useCallback(u=>{i||a(u),e==null||e(u)},[i,e]),d=h.useCallback(()=>{l(!c)},[c,l]),p=h.useMemo(()=>({toggle:d,isOpen:c}),[d,c]);return o.jsx(rc.Provider,{value:p,children:o.jsx(Yd,{open:c,onOpenChange:l,...n})})}const Rt=Jd,mt=h.forwardRef(({className:s,children:e,onPointerDown:t,hideChevron:n,...r},a)=>{const i=h.useContext(rc),c=h.useCallback(l=>{if(i!=null&&i.isOpen){l.preventDefault(),i.toggle();return}t==null||t(l)},[i,t]);return o.jsxs(Qo,{ref:a,className:B("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),onPointerDown:c,...r,children:[e,!n&&o.jsx(Xd,{asChild:!0,children:o.jsx(ms,{className:"h-4 w-4 opacity-50"})})]})});mt.displayName=Qo.displayName;const ac=h.forwardRef(({className:s,...e},t)=>o.jsx(ti,{ref:t,className:B("flex cursor-default items-center justify-center py-1",s),...e,children:o.jsx(Zn,{className:"h-4 w-4"})}));ac.displayName=ti.displayName;const oc=h.forwardRef(({className:s,...e},t)=>o.jsx(si,{ref:t,className:B("flex cursor-default items-center justify-center py-1",s),...e,children:o.jsx(ms,{className:"h-4 w-4"})}));oc.displayName=si.displayName;const gt=h.forwardRef(({className:s,children:e,position:t="popper",style:n,container:r,...a},i)=>o.jsx(Qd,{container:r??void 0,children:o.jsxs(Zo,{ref:i,style:{zIndex:Je.tooltip,...n},className:B("relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:t,...a,children:[o.jsx(ac,{}),o.jsx(Zd,{className:B("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),o.jsx(oc,{})]})}));gt.displayName=Zo.displayName;const Hh=h.forwardRef(({className:s,...e},t)=>o.jsx(ni,{ref:t,className:B("px-2 py-1.5 text-sm font-semibold",s),...e}));Hh.displayName=ni.displayName;const Ne=h.forwardRef(({className:s,children:e,...t},n)=>o.jsxs(ei,{ref:n,className:B("relative flex w-full cursor-default select-none items-start rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[o.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center mt-0.5",children:o.jsx(eu,{children:o.jsx(st,{className:"h-4 w-4"})})}),o.jsx(tu,{className:"flex-1",children:e})]}));Ne.displayName=ei.displayName;const Gh=h.forwardRef(({className:s,...e},t)=>o.jsx(ri,{ref:t,className:B("-mx-1 my-1 h-px bg-muted",s),...e}));Gh.displayName=ri.displayName;function qh({onSaveSession:s,onLoadSession:e,onManageSessions:t,disabled:n=!1,portalContainer:r}){const a=i=>{switch(i){case"save":s();break;case"load":e();break;case"manage":t();break}};return o.jsxs(Ct,{value:"",onValueChange:a,children:[o.jsx(mt,{className:"h-6 w-6 p-0 border-0 bg-transparent hover:bg-accent rounded",hideChevron:!0,disabled:n,title:"More options","data-test":"recording-more-options-trigger",children:o.jsx(Ru,{className:"w-3 h-3"})}),o.jsxs(gt,{container:r,"data-test":"recording-more-options-content",children:[o.jsx(Ne,{value:"save","data-test":"recording-option-save",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(gn,{className:"w-3 h-3"}),o.jsx("span",{children:"Save Session"})]})}),o.jsx(Ne,{value:"load","data-test":"recording-option-load",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(Ri,{className:"w-3 h-3"}),o.jsx("span",{children:"Load Session"})]})}),o.jsx(Ne,{value:"manage","data-test":"recording-option-manage",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(Du,{className:"w-3 h-3"}),o.jsx("span",{children:"Manage Sessions"})]})})]})]})}function ao({interaction:s,onSave:e,onCancel:t,onPickSelector:n}){var I,k,P,W,R,F,L,T,M,D,H,Y,O,q,K;const[r,a]=h.useState((s==null?void 0:s.type)??"click"),[i,c]=h.useState(Vh(s)??""),[l,d]=h.useState(((k=(I=s==null?void 0:s.data)==null?void 0:I.x)==null?void 0:k.toString())??"0"),[p,u]=h.useState(((W=(P=s==null?void 0:s.data)==null?void 0:P.y)==null?void 0:W.toString())??"0"),[f,m]=h.useState(((F=(R=s==null?void 0:s.data)==null?void 0:R.startX)==null?void 0:F.toString())??"0"),[g,x]=h.useState(((T=(L=s==null?void 0:s.data)==null?void 0:L.startY)==null?void 0:T.toString())??"0"),[y,w]=h.useState(((D=(M=s==null?void 0:s.data)==null?void 0:M.endX)==null?void 0:D.toString())??"0"),[v,b]=h.useState(((Y=(H=s==null?void 0:s.data)==null?void 0:H.endY)==null?void 0:Y.toString())??"0"),[j,S]=h.useState(((q=(O=s==null?void 0:s.data)==null?void 0:O.duration)==null?void 0:q.toString())??"100"),[C,N]=h.useState(((K=s==null?void 0:s.data)==null?void 0:K.value)??"");h.useEffect(()=>{s||(c(""),d("0"),u("0"),m("0"),x("0"),w("0"),b("0"),S("100"),N(""))},[r,s]);const A=()=>{const G=(s==null?void 0:s.timestamp)??Date.now();let U;switch(r){case"click":U={x:parseInt(l,10)||0,y:parseInt(p,10)||0,selector:i};break;case"drag":U={startX:parseInt(f,10)||0,startY:parseInt(g,10)||0,endX:parseInt(y,10)||0,endY:parseInt(v,10)||0,selector:i,duration:parseInt(j,10)||100};break;case"type":U={selector:i,value:C};break}e({type:r,timestamp:G,data:U})};return o.jsxs("div",{className:"space-y-3 p-3","data-test":"interaction-editor-form",children:[o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"Interaction Type"}),o.jsxs(Ct,{value:r,onValueChange:G=>a(G),children:[o.jsx(mt,{className:"h-8","data-test":"interaction-type-select",children:o.jsx(Rt,{})}),o.jsxs(gt,{children:[o.jsx(Ne,{value:"click",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(pa,{className:"w-3 h-3"}),"Click"]})}),o.jsx(Ne,{value:"drag",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(ua,{className:"w-3 h-3"}),"Drag"]})}),o.jsx(Ne,{value:"type",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(da,{className:"w-3 h-3"}),"Type"]})})]})]})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"CSS Selector"}),o.jsxs("div",{className:"flex gap-1",children:[o.jsx(_e,{value:i,onChange:G=>c(G.target.value),placeholder:'e.g., [data-test="button"]',className:"h-8 text-xs flex-1","data-test":"interaction-selector-input"}),n&&o.jsx(se,{variant:"outline",size:"sm",className:"h-8 px-2",onClick:n,title:"Pick from page","data-test":"pick-selector-button",children:o.jsx(Ou,{className:"w-3 h-3"})})]})]}),r==="click"&&o.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"X"}),o.jsx(_e,{type:"number",value:l,onChange:G=>d(G.target.value),className:"h-8 text-xs","data-test":"click-x-input"})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"Y"}),o.jsx(_e,{type:"number",value:p,onChange:G=>u(G.target.value),className:"h-8 text-xs","data-test":"click-y-input"})]})]}),r==="drag"&&o.jsxs("div",{className:"space-y-2",children:[o.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"Start X"}),o.jsx(_e,{type:"number",value:f,onChange:G=>m(G.target.value),className:"h-8 text-xs","data-test":"drag-start-x-input"})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"Start Y"}),o.jsx(_e,{type:"number",value:g,onChange:G=>x(G.target.value),className:"h-8 text-xs","data-test":"drag-start-y-input"})]})]}),o.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"End X"}),o.jsx(_e,{type:"number",value:y,onChange:G=>w(G.target.value),className:"h-8 text-xs","data-test":"drag-end-x-input"})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"End Y"}),o.jsx(_e,{type:"number",value:v,onChange:G=>b(G.target.value),className:"h-8 text-xs","data-test":"drag-end-y-input"})]})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"Duration (ms)"}),o.jsx(_e,{type:"number",value:j,onChange:G=>S(G.target.value),className:"h-8 text-xs","data-test":"drag-duration-input"})]})]}),r==="type"&&o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-xs",children:"Value to type"}),o.jsx(_e,{value:C,onChange:G=>N(G.target.value),placeholder:"Text to type...",className:"h-8 text-xs","data-test":"type-value-input"})]}),o.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[o.jsx(se,{variant:"ghost",size:"sm",onClick:t,"data-test":"cancel-edit-button",children:"Cancel"}),o.jsx(se,{size:"sm",onClick:A,disabled:!i,"data-test":"save-edit-button",children:s?"Update":"Add"})]})]})}function Vh(s){if(s)switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function Kh({session:s,onBack:e,onUpdateSession:t,onUpdateInteraction:n,onDeleteInteraction:r,onInsertInteraction:a,onStartInsertRecord:i,onStartReplaceRecord:c}){const[l,d]=h.useState(!1),[p,u]=h.useState(!1),[f,m]=h.useState(s.name),[g,x]=h.useState(s.description),[y,w]=h.useState(null),[v,b]=h.useState(null),j=()=>{f.trim()&&(t({name:f.trim()}),d(!1))},S=()=>{t({description:g.trim()}),u(!1)},C=k=>{y!==null?(n(y,k),w(null)):v!==null&&(a(v,k),b(null))},N=k=>{switch(k){case"click":return o.jsx(pa,{className:"w-3 h-3"});case"drag":return o.jsx(ua,{className:"w-3 h-3"});case"type":return o.jsx(da,{className:"w-3 h-3"})}},A=k=>{switch(k.type){case"click":{const P=k.data;return`Click at (${P.x}, ${P.y})`}case"drag":return`Drag ${k.data.duration}ms`;case"type":{const P=k.data;return`Type "${P.value.length>20?`${P.value.slice(0,20)}...`:P.value}"`}}},I=k=>{switch(k.type){case"click":return k.data.selector;case"drag":return k.data.selector;case"type":return k.data.selector}};return y!==null?o.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-interaction-form",children:[o.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>w(null),"data-test":"cancel-edit-interaction",children:o.jsx(hr,{className:"w-4 h-4"})}),o.jsxs("span",{className:"text-sm font-medium",children:["Edit Interaction #",y+1]})]}),o.jsx(ao,{interaction:s.interactions[y],onSave:C,onCancel:()=>w(null)})]}):v!==null?o.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-add-form",children:[o.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>b(null),"data-test":"cancel-add-interaction",children:o.jsx(hr,{className:"w-4 h-4"})}),o.jsxs("span",{className:"text-sm font-medium",children:["Add Interaction at #",v+1]})]}),o.jsx(ao,{onSave:C,onCancel:()=>b(null)})]}):o.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-view",children:[o.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:e,"data-test":"session-editor-back",children:o.jsx(hr,{className:"w-4 h-4"})}),o.jsx("span",{className:"text-sm font-medium",children:"Edit Session"})]}),o.jsxs("div",{className:"flex-1 overflow-auto p-3 space-y-4",children:[o.jsxs("div",{className:"space-y-1",children:[o.jsx("label",{className:"text-xs text-gray-500",children:"Name"}),l?o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(_e,{value:f,onChange:k=>m(k.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:k=>k.key==="Enter"&&j(),"data-test":"session-name-input"}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:j,children:o.jsx(st,{className:"w-3 h-3 text-green-600"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{d(!1),m(s.name)},children:o.jsx(ct,{className:"w-3 h-3 text-gray-500"})})]}):o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx("span",{className:"text-sm flex-1","data-test":"session-name-display",children:s.name}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>d(!0),"data-test":"edit-session-name",children:o.jsx(xn,{className:"w-3 h-3"})})]})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx("label",{className:"text-xs text-gray-500",children:"Description"}),p?o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(_e,{value:g,onChange:k=>x(k.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:k=>k.key==="Enter"&&S(),"data-test":"session-description-input"}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:S,children:o.jsx(st,{className:"w-3 h-3 text-green-600"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{u(!1),x(s.description)},children:o.jsx(ct,{className:"w-3 h-3 text-gray-500"})})]}):o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx("span",{className:"text-sm flex-1 text-gray-600","data-test":"session-description-display",children:s.description||"(no description)"}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>u(!0),"data-test":"edit-session-description",children:o.jsx(xn,{className:"w-3 h-3"})})]})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx("div",{className:"flex items-center justify-between",children:o.jsxs("label",{className:"text-xs text-gray-500",children:["Interactions (",s.interactions.length,")"]})}),o.jsxs("div",{className:"space-y-1","data-test":"session-interactions-list",children:[o.jsx(oo,{index:0,onAddManual:()=>b(0),onAddRecord:()=>i(0)}),s.interactions.map((k,P)=>o.jsxs("div",{children:[o.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50 group","data-test":`session-interaction-${P}`,children:[o.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:Dn[k.type].bg,color:Dn[k.type].text},children:N(k.type)}),o.jsxs("div",{className:"flex-1 min-w-0",children:[o.jsx("div",{className:"text-xs font-medium",children:A(k)}),o.jsx("code",{className:"text-xs text-gray-400 truncate block",children:I(k)})]}),o.jsxs("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>w(P),title:"Edit","data-test":`edit-interaction-${P}`,children:o.jsx(xn,{className:"w-3 h-3"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>c(P),title:"Replace by recording","data-test":`replace-interaction-${P}`,children:o.jsx(En,{className:"w-3 h-3"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-red-500 hover:text-red-600",onClick:()=>r(P),title:"Delete","data-test":`delete-interaction-${P}`,children:o.jsx(At,{className:"w-3 h-3"})})]})]}),o.jsx(oo,{index:P+1,onAddManual:()=>b(P+1),onAddRecord:()=>i(P+1)})]},`${k.timestamp}-${P}`))]})]})]})]})}function oo({index:s,onAddManual:e,onAddRecord:t}){return o.jsx("div",{className:"flex items-center justify-center py-1 group opacity-0 hover:opacity-100 transition-opacity","data-test":`insert-point-${s}`,children:o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsxs(se,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-blue-500 hover:text-blue-600 hover:bg-blue-50",onClick:e,title:"Add manually","data-test":`insert-manual-${s}`,children:[o.jsx(Ws,{className:"w-3 h-3 mr-1"}),"Manual"]}),o.jsxs(se,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-green-500 hover:text-green-600 hover:bg-green-50",onClick:t,title:"Record new action","data-test":`insert-record-${s}`,children:[o.jsx(kn,{className:"w-3 h-3 mr-1"}),"Record"]})]})})}function Jh({isOpen:s,savedSessions:e,onLoad:t,onDelete:n,onUpdateSession:r,onUpdateInteraction:a,onDeleteInteraction:i,onInsertInteraction:c,onStartInsertRecord:l,onStartReplaceRecord:d,onClose:p,portalContainer:u}){const[f,m]=h.useState(null);if(!s)return null;const g=f?e.find(w=>w.id===f):null,x=w=>new Date(w).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),y=()=>{m(null)};return g?o.jsx(us,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:500},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:o.jsx(Kh,{session:g,onBack:y,onUpdateSession:w=>r(g.id,w),onUpdateInteraction:(w,v)=>a(g.id,w,v),onDeleteInteraction:w=>i(g.id,w),onInsertInteraction:(w,v)=>c(g.id,w,v),onStartInsertRecord:w=>l(g.id,w),onStartReplaceRecord:w=>d(g.id,w)})}):o.jsx(us,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:400},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:o.jsx("div",{className:"p-3 h-full overflow-auto","data-test":"session-manager-body",children:e.length===0?o.jsx("div",{className:"text-sm italic text-center py-8 text-gray-400","data-test":"session-manager-empty",children:"No saved sessions yet"}):o.jsx("div",{className:"space-y-2","data-test":"session-manager-list",children:e.map(w=>o.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50","data-test":`session-item-${w.id}`,children:[o.jsxs("div",{className:"flex-1 min-w-0",children:[o.jsx("div",{className:"text-sm font-medium truncate","data-test":"session-name",children:w.name}),w.description&&o.jsx("div",{className:"text-xs text-gray-500 truncate","data-test":"session-description",children:w.description}),o.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-2",children:[o.jsx("span",{"data-test":"session-date",children:x(w.savedAt)}),o.jsx("span",{children:"Â·"}),o.jsxs("span",{"data-test":"session-interaction-count",children:[w.interactions.length," interaction",w.interactions.length!==1?"s":""]})]})]}),o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>t(w.id),title:"Load session","data-test":"session-load",children:o.jsx(Ri,{className:"w-4 h-4 text-blue-500"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>m(w.id),title:"Edit session","data-test":"session-edit",children:o.jsx(xn,{className:"w-4 h-4 text-gray-500"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>n(w.id),title:"Delete session","data-test":"session-delete",children:o.jsx(At,{className:"w-4 h-4 text-red-500"})})]})]},w.id))})})})}function Yh({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1),[r,a]=h.useState(!1),[i,c]=h.useState(!1),[l,d]=h.useState(""),[p,u]=h.useState(""),[f,m]=h.useState({type:"none"}),{interactions:g,isRecording:x,startRecording:y,stopRecording:w,clearRecording:v}=Lh({targetRef:null,enabled:!0}),b=zh();h.useCallback(M=>{f.type==="insert"?(b.insertInteraction(f.sessionId,f.atIndex,M),m({type:"none"}),w(),be.success("Interaction inserted!")):f.type==="replace"&&(b.replaceInteraction(f.sessionId,f.atIndex,M),m({type:"none"}),w(),be.success("Interaction replaced!"))},[f,b,w]);const j=h.useCallback(()=>{x?(w(),n(!1),be.success(`Stopped recording. Captured ${g.length} interactions.`)):(y(),n(!1),be.info("Recording started. Click, drag, or type to capture."))},[x,g.length,y,w]),S=h.useCallback(()=>{const M={interactions:g,exportedAt:new Date().toISOString(),url:window.location.href},D=new Blob([JSON.stringify(M,null,2)],{type:"application/json"}),H=URL.createObjectURL(D),Y=document.createElement("a");Y.href=H,Y.download=`recording-${Date.now()}.json`,Y.click(),URL.revokeObjectURL(H),be.success("Recording exported!")},[g]),C=h.useCallback(()=>{v(),be.success("Recording cleared")},[v]),N=h.useCallback(()=>{n(!1)},[]),A=h.useCallback(()=>{n(!0)},[]),I=h.useCallback(()=>{if(g.length===0){be.error("No interactions to save");return}d(`Session ${new Date().toLocaleString()}`),u(""),c(!0)},[g.length]),k=h.useCallback(()=>{if(!l.trim()){be.error("Please enter a name");return}b.saveSession(l.trim(),p.trim(),g),c(!1),d(""),u("")},[l,p,g,b]),P=h.useCallback(()=>{const M=b.getLastSession();M?(v(),be.info(`Would load session: ${M.name}`)):be.info("No saved sessions. Use 'Manage Sessions' to view all.")},[b,v]),W=h.useCallback(()=>{a(!0)},[]),R=h.useCallback(M=>{const D=b.loadSession(M);D&&(v(),be.success(`Loaded: ${D.name}`),a(!1))},[b,v]),F=h.useCallback((M,D)=>{m({type:"insert",sessionId:M,atIndex:D}),y(),a(!1),be.info("Recording... Perform an action to insert it.")},[y]),L=h.useCallback((M,D)=>{m({type:"replace",sessionId:M,atIndex:D}),y(),a(!1),be.info("Recording... Perform an action to replace.")},[y]),T=o.jsxs(o.Fragment,{children:[o.jsxs(se,{variant:x?"destructive":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:j,"data-test":"record-toggle-button",children:[o.jsx(kn,{className:"w-3 h-3 mr-1",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0}),x?"Stop":"Record"]}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:S,disabled:g.length===0,title:"Export as JSON","data-test":"export-recording-button",children:o.jsx(la,{className:"w-3 h-3"})}),o.jsx(se,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:C,disabled:g.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:o.jsx(At,{className:"w-3 h-3"})}),o.jsx(qh,{onSaveSession:I,onLoadSession:P,onManageSessions:W})]});return o.jsxs(o.Fragment,{children:[o.jsx(se,{variant:s,size:e,onClick:x?j:A,title:x?"Stop Recording":"Open Recorder","data-test":"global-record-button",className:x?"text-red-500 hover:text-red-400":"",children:o.jsx(kn,{className:"h-5 w-5",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0})}),x&&o.jsx("div",{className:"fixed inset-0 z-40 pointer-events-none",style:{backgroundColor:"rgba(220, 38, 38, 0.03)"},"data-test":"global-recording-overlay"}),f.type!=="none"&&o.jsxs("div",{className:"fixed top-2 left-1/2 -translate-x-1/2 z-50 bg-blue-500 text-white px-3 py-1 rounded-full text-sm animate-pulse","data-test":"edit-mode-indicator",children:[f.type==="insert"?"Recording to insert...":"Recording to replace...",o.jsx(se,{variant:"ghost",size:"sm",className:"ml-2 h-5 px-2 text-white hover:text-white hover:bg-blue-600",onClick:()=>{m({type:"none"}),w()},children:"Cancel"})]}),o.jsx(us,{isVisible:t,onClose:N,title:`Recorder ${g.length>0?`(${g.length})`:""}`,shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth-420,y:60},initialSize:{width:400,height:350},showPinButton:!1,headerActions:T,children:o.jsx(Wh,{interactions:g,isRecording:x,onExport:S,onClear:C})}),o.jsx(us,{isVisible:i,onClose:()=>c(!1),title:"Save Session",initialPosition:{x:window.innerWidth/2-175,y:150},initialSize:{width:350,height:220},shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,children:o.jsxs("div",{className:"p-4 space-y-3","data-test":"save-session-dialog",children:[o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-sm",children:"Name"}),o.jsx(_e,{value:l,onChange:M=>d(M.target.value),placeholder:"Session name",autoFocus:!0,"data-test":"save-session-name"})]}),o.jsxs("div",{className:"space-y-1",children:[o.jsx(me,{className:"text-sm",children:"Description (optional)"}),o.jsx(_e,{value:p,onChange:M=>u(M.target.value),placeholder:"Brief description","data-test":"save-session-description"})]}),o.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[o.jsx(se,{variant:"ghost",size:"sm",onClick:()=>c(!1),"data-test":"save-session-cancel",children:"Cancel"}),o.jsxs(se,{size:"sm",onClick:k,"data-test":"save-session-confirm",children:["Save (",g.length," interactions)"]})]})]})}),o.jsx(Jh,{isOpen:r,savedSessions:b.savedSessions,onLoad:R,onDelete:b.deleteSession,onUpdateSession:b.updateSession,onUpdateInteraction:b.updateInteraction,onDeleteInteraction:b.deleteInteraction,onInsertInteraction:b.insertInteraction,onStartInsertRecord:F,onStartReplaceRecord:L,onClose:()=>a(!1)})]})}const Ft=h.forwardRef(({className:s,...e},t)=>o.jsx(ai,{ref:t,className:B("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...e,children:o.jsx(su,{className:B("flex items-center justify-center text-current"),children:o.jsx(st,{className:"h-4 w-4"})})}));Ft.displayName=ai.displayName;const Xh=Qs("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}}),ot=h.forwardRef(({className:s,variant:e,...t},n)=>o.jsx("div",{ref:n,className:B(Xh({variant:e}),s),...t}));ot.displayName="Badge";function _r({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1,contentStyle:a}){const[i,c]=h.useState(!1),[l,d]=h.useState(""),p=e.find(m=>m.value===s),u=e.filter(m=>m.label.toLowerCase().includes(l.toLowerCase())),f=m=>{t==null||t(m),c(!1),d("")};return p?o.jsxs(Ye,{open:i,onOpenChange:c,children:[o.jsx(at,{asChild:!0,children:o.jsx(ot,{variant:p.variant||"secondary",className:B("cursor-pointer hover:opacity-80 transition-opacity",p.className,r&&"opacity-50 cursor-not-allowed"),onClick:m=>{m.stopPropagation(),r&&m.preventDefault()},children:p.label})}),o.jsx(Ge,{className:"popover-content w-64 p-2",align:"start",style:a,children:o.jsxs("div",{className:"selector-container space-y-2",children:[o.jsx(_e,{placeholder:n,value:l,onChange:m=>d(m.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),o.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?o.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(m=>o.jsxs(se,{variant:"ghost",className:B("option-item w-full justify-between h-8 px-2",m.value===s&&"bg-accent"),onClick:()=>f(m.value),children:[o.jsx(ot,{variant:m.variant||"secondary",className:B("text-xs",m.className),children:m.label}),m.value===s&&o.jsx(st,{className:"check-icon h-4 w-4"})]},m.value))})]})})]}):null}const sr=h.forwardRef(({className:s,...e},t)=>o.jsx(dt,{ref:t,className:B("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...e}));sr.displayName=dt.displayName;const ic=({children:s,value:e,onValueChange:t,filter:n,shouldFilter:r,...a})=>o.jsx(An,{modal:!1,...a,children:o.jsx(oa,{children:o.jsxs(Xs,{className:B("overflow-hidden p-0 fixed inset-x-0 top-[10%] mx-auto max-w-2xl w-full","gap-4 border bg-background shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:slide-out-to-top-8 data-[state=open]:slide-in-from-top-8","sm:rounded-lg"),style:{zIndex:Je.commandPalette},"data-test":"command-dialog",children:[o.jsx(Hs,{className:"sr-only",children:"Command Palette"}),o.jsx(sr,{value:e,onValueChange:t,filter:n,shouldFilter:r,className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-1.5 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:s}),o.jsxs(ia,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[o.jsx(ct,{className:"h-4 w-4"}),o.jsx("span",{className:"sr-only",children:"Close"})]})]})})}),nr=h.forwardRef(({className:s,...e},t)=>o.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[o.jsx(er,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),o.jsx(dt.Input,{ref:t,className:B("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...e})]}));nr.displayName=dt.Input.displayName;const tn=h.forwardRef(({className:s,...e},t)=>o.jsx(dt.List,{ref:t,className:B("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...e}));tn.displayName=dt.List.displayName;const sn=h.forwardRef((s,e)=>o.jsx(dt.Empty,{ref:e,className:"py-6 text-center text-sm",...s}));sn.displayName=dt.Empty.displayName;const js=h.forwardRef(({className:s,...e},t)=>o.jsx(dt.Group,{ref:t,className:B("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...e}));js.displayName=dt.Group.displayName;const Mr=h.forwardRef(({className:s,...e},t)=>o.jsx(dt.Separator,{ref:t,className:B("-mx-1 h-px bg-border",s),...e}));Mr.displayName=dt.Separator.displayName;const es=h.forwardRef(({className:s,...e},t)=>o.jsx(dt.Item,{ref:t,className:B("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s),...e}));es.displayName=dt.Item.displayName;const zt="__no_project__",Qh=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},Zh=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},ef=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},tf=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath};function cc({variant:s="badge",className:e,multiSelect:t=!1,value:n,onChange:r}){const[a,i]=h.useState(!1),c=r!==void 0,l=Re(Qh),d=Re(Zh),p=Re(ef),u=Re(tf),f=c?n:u,m=t?Array.isArray(f)?f:f?[f]:[]:null,g=h.useCallback(v=>{var S,C,N;const b=l.find(A=>A.id===v||A.path===v),j=(b==null?void 0:b.path)??v;if(c)r(v);else{const A=oe.getState();oe.updateState({app:{...A.app,claude:{...(S=A.app)==null?void 0:S.claude,ui:{...(N=(C=A.app)==null?void 0:C.claude)==null?void 0:N.ui,selectedProjectPath:j}}}})}},[c,r,l]),x=h.useCallback(v=>{if(!t||!m)return;const b=l.find(C=>C.id===v||C.path===v),j=(b==null?void 0:b.path)??v,S=m.includes(j)?m.filter(C=>C!==j):[...m,j];c&&r(S)},[t,m,l,c,r]),y=h.useCallback(()=>{var v,b,j;if(c)r(t?[]:void 0);else{const S=oe.getState();oe.updateState({app:{...S.app,claude:{...(v=S.app)==null?void 0:v.claude,ui:{...(j=(b=S.app)==null?void 0:b.claude)==null?void 0:j.ui,selectedProjectPath:void 0}}}})}},[c,r,t]);if(h.useEffect(()=>{!c&&!d&&l.length>0&&!u&&g(l[0].path)},[c,d,l,u,g]),d)return o.jsx("div",{"data-test":"project-selector-loading",className:e,children:o.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading projects..."})});if(p)return o.jsx("div",{"data-test":"project-selector-error",className:e,children:o.jsx("span",{className:"text-sm text-destructive",children:p})});if(l.length===0)return o.jsx("div",{"data-test":"project-selector-empty",className:e,children:o.jsx("span",{className:"text-sm text-muted-foreground",children:"No projects found"})});const w=t?null:l.find(v=>v.path===f||v.id===f);if(t&&m){const v=l.filter(S=>m.includes(S.path)),b=m.includes(zt),j=m.length>0;return o.jsxs("div",{"data-test":"project-selector-multi",className:"project-selector-multi-wrapper",children:[o.jsxs(Ye,{open:a,onOpenChange:i,children:[o.jsx(at,{asChild:!0,children:o.jsxs(se,{"data-test":"project-selector-trigger",variant:"outline",role:"combobox","aria-expanded":a,className:B("project-selector-trigger w-full justify-between",j&&"h-auto min-h-[40px] py-2"),disabled:d,children:[o.jsx("div",{className:"flex flex-wrap gap-1 flex-1 mr-2",children:j?o.jsxs(o.Fragment,{children:[b&&o.jsxs(ot,{"data-test":"project-badge-none",variant:"secondary",className:"selected-project-badge gap-1",children:["No project",o.jsx(ct,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:S=>{S.stopPropagation(),x(zt)}})]}),v.map(S=>o.jsxs(ot,{"data-test":`project-badge-${S.id}`,variant:"secondary",className:"selected-project-badge gap-1",children:[S.name,o.jsx(ct,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:C=>{C.stopPropagation(),x(S.path)}})]},S.id))]}):o.jsx("span",{className:"text-muted-foreground",children:"Select projects..."})}),o.jsx(Di,{className:"h-4 w-4 shrink-0 opacity-50"})]})}),o.jsx(Ge,{"data-test":"project-selector-content",className:"project-selector-content w-[400px] p-0",style:{zIndex:Je.tooltip},children:o.jsxs(sr,{children:[o.jsx(nr,{"data-test":"project-selector-search",placeholder:"Search projects..."}),o.jsxs(tn,{className:"max-h-[300px]",children:[o.jsx(sn,{children:"No projects found."}),o.jsxs(js,{children:[o.jsxs(es,{"data-test":"project-selector-item-none",value:zt,onSelect:()=>x(zt),className:"project-selector-item cursor-pointer",children:[o.jsx(st,{className:B("mr-2 h-4 w-4 shrink-0",m.includes(zt)?"opacity-100":"opacity-0")}),o.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[o.jsx("span",{className:"project-name font-medium",children:"No project"}),o.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})]}),l.map(S=>o.jsxs(es,{"data-test":`project-selector-item-${S.id}`,value:S.path,onSelect:()=>x(S.path),className:"project-selector-item cursor-pointer",children:[o.jsx(st,{className:B("mr-2 h-4 w-4 shrink-0",m.includes(S.path)?"opacity-100":"opacity-0")}),o.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[o.jsx("span",{className:"project-name font-medium",children:S.name}),o.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[S.sessionCount," sessions"]})]})]},S.id))]})]})]})})]}),j&&o.jsxs(se,{"data-test":"project-selector-clear-all",variant:"outline",size:"sm",onClick:y,className:"clear-all-button w-full mt-2",children:[o.jsx(ct,{className:"h-4 w-4 mr-2"}),"Clear all (",m.length,")"]})]})}if(s==="badge"&&!t){const v=typeof f=="string"?f:void 0,b=[{value:zt,label:"No project",variant:"secondary"},...l.map(j=>({value:j.path,label:`${j.name} (${j.sessionCount})`,variant:"secondary"}))];return o.jsx(_r,{"data-test":"project-selector-badge",value:v??l[0].path,options:b,onChange:g,placeholder:"Search projects..."})}if(!t){const v=typeof f=="string"?f:void 0;return o.jsxs("div",{"data-test":"project-selector-select",className:"project-selector-wrapper flex gap-2",children:[o.jsxs(Ct,{value:v??l[0].path,onValueChange:g,children:[o.jsx(mt,{"data-test":"project-selector-trigger",className:e,children:o.jsx(Rt,{children:v===zt?"No project":w?`${w.name} (${w.sessionCount})`:"Select project"})}),o.jsxs(gt,{children:[o.jsx(Ne,{"data-test":"project-selector-item-none",value:zt,children:o.jsxs("div",{className:"project-option flex flex-col items-start",children:[o.jsx("span",{className:"project-name font-medium",children:"No project"}),o.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})},zt),l.map(b=>o.jsx(Ne,{"data-test":`project-selector-item-${b.id}`,value:b.path,children:o.jsxs("div",{className:"project-option flex flex-col items-start",children:[o.jsx("span",{className:"project-name font-medium",children:b.name}),o.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[b.sessionCount," sessions"]})]})},b.id))]})]}),v&&o.jsx(se,{"data-test":"project-selector-clear",variant:"outline",size:"icon",onClick:y,className:"clear-project-button shrink-0",title:"Clear project filter",children:o.jsx(ct,{className:"h-4 w-4"})})]})}return null}const rr=h.forwardRef(({label:s,onAction:e,configOptions:t=[],popoverContent:n,longPressDuration:r=400,showStaticGear:a=!1,showHint:i=!1,enableOnboarding:c=!1,tooltipText:l,ariaLabel:d,variant:p="secondary",size:u="default",disabled:f=!1,className:m,compact:g=!1,buttonClassName:x,...y},w)=>{const[v,b]=h.useState(!1),[j,S]=h.useState(!1),[C,N]=h.useState(!1),[A,I]=h.useState(0),[k,P]=h.useState(c),W=h.useRef(null),R=h.useRef(null),F=h.useRef(0),L=h.useRef(!1),T=h.useRef(!1),M=h.useRef(null),D=h.useRef(null),H=h.useRef(null),Y=h.useCallback(()=>{W.current&&(clearTimeout(W.current),W.current=null),R.current&&(clearInterval(R.current),R.current=null),b(!1),I(0)},[]);h.useEffect(()=>Y,[Y]),h.useEffect(()=>{f&&(Y(),S(!1))},[f,Y]),h.useEffect(()=>{if(!j||C)return;const ge=ie=>{var te,$;const re=ie.target;(te=H.current)!=null&&te.contains(re)||($=D.current)!=null&&$.contains(re)||S(!1)};return document.addEventListener("mousedown",ge),()=>{document.removeEventListener("mousedown",ge)}},[j,C]);const O=n!==void 0||t.length>0,q=h.useCallback(ge=>{if(!(f||!O)){if(ge.type==="touchstart"&&ge.preventDefault(),b(!0),S(!1),F.current=Date.now(),L.current=!1,T.current=!0,k&&P(!1),!g){const ie=100/(r/16);R.current=setInterval(()=>{I(re=>{const te=re+ie;return te>100?100:te})},16)}W.current=setTimeout(()=>{g?N(!0):S(!0),I(0),R.current&&(clearInterval(R.current),R.current=null)},r)}},[f,O,r,k,g]),K=h.useCallback(()=>{if(f)return;Date.now()-F.current<r&&!j?(L.current=!0,e()):L.current=!0,Y()},[f,r,j,e,Y]),G=h.useCallback(()=>{f||(T.current||e(),T.current=!1)},[f,e]),U=h.useCallback(()=>{f||j||Y()},[f,j,Y]),Z=h.useCallback(ge=>{ge.stopPropagation(),N(!0)},[]),ue=h.useCallback(ge=>{ge.onClick(),N(!1),S(!1)},[]),we=20,ae=2*Math.PI*we,Te=ae-A/100*ae,ke=`${s} (Click) / Configure (Hold)`,Ee=l??ke,$e=o.jsxs(se,{ref:M,variant:p,size:u,disabled:f,className:B("button-main relative transition-all",v&&"scale-95",!g&&i&&O&&"pr-8",x),onPointerDown:q,onPointerUp:K,onPointerLeave:U,onClick:G,"aria-label":d||(typeof s=="string"?`Button: ${s}. Secondary action: long press for configuration`:"Button with configuration options"),"aria-pressed":v,"aria-expanded":C,"aria-haspopup":"menu",...y,children:[s,!g&&i&&O&&o.jsx(Lu,{className:"hint-icon absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 opacity-30"})]});return g?o.jsxs("div",{ref:w,className:B("relative inline-flex items-center",m),children:[o.jsx(Yt,{children:o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:$e}),o.jsx(Kt,{children:o.jsx("p",{children:Ee})})]})}),o.jsxs(Ye,{open:C,onOpenChange:ge=>{N(ge)},children:[o.jsx(at,{asChild:!0,children:o.jsx("span",{className:"absolute inset-0 pointer-events-none","aria-hidden":"true"})}),o.jsx(Ge,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?o.jsx("div",{className:"config-panel-custom-content",children:n}):o.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ge,ie)=>o.jsxs("button",{onClick:()=>ue(ge),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ge.icon&&o.jsx("span",{className:"shrink-0",children:ge.icon}),o.jsx("span",{children:ge.label})]},ge.value??ie))})})]})]}):o.jsxs("div",{ref:w,className:B("relative inline-flex items-center gap-2",m),children:[o.jsx(Yt,{children:o.jsxs(Xt,{open:k?!0:j?!1:void 0,children:[o.jsx(Qt,{asChild:!0,children:o.jsxs("div",{ref:H,className:"button-container relative inline-block",children:[v&&A>0&&o.jsx("svg",{className:"progress-ring absolute inset-0 pointer-events-none",width:"100%",height:"100%",style:{transform:"rotate(-90deg)"},children:o.jsx("circle",{className:"progress-ring-circle stroke-primary/30",strokeWidth:"3",fill:"transparent",r:we,cx:"50%",cy:"50%",style:{strokeDasharray:ae,strokeDashoffset:Te,transition:"stroke-dashoffset 16ms linear"}})}),$e,j&&!a&&o.jsxs(Ye,{open:C,onOpenChange:ge=>{N(ge),ge||S(!1)},children:[o.jsx(at,{asChild:!0,children:o.jsx("button",{ref:D,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200","aria-label":"Open configuration",children:o.jsx(Vt,{className:"h-4 w-4"})})}),o.jsx(Ge,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?o.jsx("div",{className:"config-panel-custom-content",children:n}):o.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ge,ie)=>o.jsxs("button",{onClick:()=>ue(ge),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ge.icon&&o.jsx("span",{className:"shrink-0",children:ge.icon}),o.jsx("span",{children:ge.label})]},ge.value??ie))})})]}),j&&a&&o.jsx("button",{ref:D,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200",onClick:Z,onTouchEnd:ge=>{ge.preventDefault(),Z(ge)},"aria-label":"Open configuration",children:o.jsx(Vt,{className:"h-4 w-4"})})]})}),o.jsx(Kt,{children:o.jsx("p",{children:k?"Try holding this button for advanced settings":Ee})})]})}),a&&O&&o.jsxs(Ye,{open:C,onOpenChange:ge=>{N(ge),ge||S(!1)},children:[o.jsx(at,{asChild:!0,children:o.jsx(se,{variant:"ghost",size:"icon",className:"static-gear h-8 w-8 shrink-0",disabled:f,"aria-label":"Configure",tabIndex:0,children:o.jsx(Vt,{className:"h-4 w-4"})})}),o.jsx(Ge,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?o.jsx("div",{className:"config-panel-custom-content",children:n}):o.jsx("div",{className:"config-panel-content space-y-1",children:t.map((ge,ie)=>o.jsxs("button",{onClick:()=>ue(ge),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[ge.icon&&o.jsx("span",{className:"shrink-0",children:ge.icon}),o.jsx("span",{children:ge.label})]},ge.value??ie))})})]})]})});rr.displayName="ConfigurableButton";const sf="â€‹";function nf(s){return s.replace(new RegExp(sf,"g"),"")}function io(s){const e=/^(\s*)/.exec(s);return e?e[1]:""}function ar(s){const e=/^(\s*)(\d+)\.\s*(.*)$/.exec(s);if(e)return{type:"numbered",indent:e[1],number:parseInt(e[2],10),fullMatch:e[0].replace(e[3],""),contentAfterPrefix:e[3]};const t=/^(\s*)-\s*(.*)$/.exec(s);return t?{type:"dash",indent:t[1],fullMatch:t[0].replace(t[2],""),contentAfterPrefix:t[2]}:{type:"none",indent:"",fullMatch:"",contentAfterPrefix:s}}function rf(s,e,t,n){if(s.trim()==="")return{type:"newline",textToInsert:`
`};const r=ar(s);if(r.type==="none")return{type:"continue",textToInsert:`
`+io(s)};if(!(r.contentAfterPrefix.trim().length>0)){const l=r.fullMatch.length;if(r.type==="numbered"){const d=af(t,n,r.indent,r.number??1);return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l,textAfterCursor:d}}return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l}}if(nf(e.split(`
`)[0]).trim().length>0)return{type:"continue",textToInsert:`
`+io(s)};if(r.type==="numbered"){const l=(r.number??0)+1,d=`
${r.indent}${l}. `,p=of(t,n,r.indent,l);return{type:"continue",textToInsert:d,textAfterCursor:p}}return{type:"continue",textToInsert:`
${r.indent}- `}}function af(s,e,t,n){const a=s.substring(e).split(`
`);let i=!1,c=n-1;const l=[];for(let d=0;d<a.length;d++){const p=a[d],u=ar(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...a.slice(d));break}else if(p.trim()===""&&d<a.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...a.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function of(s,e,t,n){const a=s.substring(e).split(`
`);let i=!1,c=n;const l=[];for(let d=0;d<a.length;d++){const p=a[d],u=ar(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...a.slice(d));break}else if(p.trim()===""&&d<a.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...a.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function lc(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=n===-1?s.length:n;return{lineStart:t,lineEnd:r,currentLine:s.substring(t,r),textBeforeLine:s.substring(0,t),textAfterLine:s.substring(r)}}function dc(s,e){if(e===0)return{type:"default"};const{lineStart:t,currentLine:n}=lc(s,e),r=e-t,a=ar(n);if(a.type==="none")return{type:"default"};const i=a.fullMatch.length;if(r<=i&&r>0){const c=e-1;return{type:"delete-char",newText:s.substring(0,c)+s.substring(e),newCursorPos:c}}return{type:"default"}}const cf={b:"**",i:"*","`":"`"},lf={"*":"*",_:"*","`":"`"};function uc(s,e,t){const{lineStart:n,textAfterLine:r}=lc(s,e),a=s.substring(n,e),i=s.substring(e,s.indexOf(`
`,e)===-1?s.length:s.indexOf(`
`,e)),c=rf(a,i+r,s,e);if(c.type==="remove-prefix"){const l=c.charsToRemoveBeforeCursor??0,d=e-l;return{selectionStart:d,selectionEnd:e,textToInsert:c.textToInsert,newCursorPosition:d+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}}return c.type==="continue"?{selectionStart:e,selectionEnd:t,textToInsert:c.textToInsert,newCursorPosition:e+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}:{selectionStart:e,selectionEnd:t,textToInsert:`
`,newCursorPosition:e+1}}function pc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r="  ",a=e+2;return{selectionStart:n,selectionEnd:n,textToInsert:r,newCursorPosition:a}}function hc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r=s.indexOf(`
`,e),a=r===-1?s.length:r,i=s.substring(n,a);let c=0;for(let d=0;d<Math.min(2,i.length)&&i[d]===" ";d++)c++;if(c===0)return{selectionStart:e,selectionEnd:t,textToInsert:"",newCursorPosition:e};const l=Math.max(n,e-c);return{selectionStart:n,selectionEnd:n+c,textToInsert:"",newCursorPosition:l}}function co(s,e,t,n){const r=s.substring(e,t),a=`${n}${r}${n}`;return{selectionStart:e,selectionEnd:t,textToInsert:a,newCursorPosition:e+a.length}}function df(s){return cf[s.toLowerCase()]}function uf(s){return lf[s]}function pf(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=s.substring(t,n===-1?s.length:n),a=r.trim();if(!a.startsWith("|")||!a.endsWith("|"))return null;const i=a.split("|").slice(1,-1);if(i.length===0||i.every(u=>/^\s*:?-+:?\s*$/.test(u)))return null;const l=r.indexOf("|"),d=e-t;let p=l+1;for(let u=0;u<i.length;u++){const f=i[u],m=p+f.length;if(d>=p&&d<=m){const g=f.trim(),x=f.length-f.trimStart().length,y=d-p;if(g.length===0)if(u>0){const w=i[u-1],b=p-1-w.length+w.trimEnd().length;return{newText:s,newCursorPos:t+b}}else return{newText:s,newCursorPos:e};if(y===x&&x>0)if(u>0){const w=i[u-1],b=p-1-w.length+w.trimEnd().length;return{newText:s,newCursorPos:t+b}}else return{newText:s,newCursorPos:e};if(y>0&&y<x)if(u>0){const w=i[u-1],b=p-1-w.length+w.trimEnd().length;return{newText:s,newCursorPos:t+b}}else return{newText:s,newCursorPos:e};if(y===0)if(u>0){const w=i[u-1],b=p-1-w.length+w.trimEnd().length;return{newText:s,newCursorPos:t+b}}else return{newText:s,newCursorPos:e};if(x===0&&y>=1&&g.length>=1){const w=s[e],v=g[y],b=y>=g.length;if(v!==void 0&&w===v||b)if(u>0){const S=i[u-1],N=p-1-S.length+S.trimEnd().length;return{newText:s,newCursorPos:t+N}}else return{newText:s,newCursorPos:e}}break}p=m+1}return null}function hf(s,e){if(s[e-1]!==`
`)return null;const t=s.substring(0,e-1),n=t.lastIndexOf(`
`)+1,a=t.substring(n).trimEnd();if(!a.endsWith("|")||!a.includes("|")||a.split("|").slice(1,-1).every(w=>/^\s*:?-+:?\s*$/.test(w)))return null;const l=s.substring(e),d=l.indexOf(`
`),p=d===-1?l:l.substring(0,d),u=d===-1?"":l.substring(d),f=n+a.lastIndexOf("|");let m=s.substring(0,f);m.match(/\s+$/)&&(m=m.trimEnd());const x=m+p+" |"+u,y=m.length;return{newText:x,newCursorPos:y}}function ff(s,e,t){if(e!==t||e===0)return null;const n=hf(s,e);if(n)return{selectionStart:0,selectionEnd:s.length,textToInsert:n.newText,newCursorPosition:n.newCursorPos};const r=pf(s,e);if(r)return{selectionStart:0,selectionEnd:s.length,textToInsert:r.newText,newCursorPosition:r.newCursorPos};const a=dc(s,e);return a.type==="delete-char"&&a.newText!==void 0?{selectionStart:0,selectionEnd:s.length,textToInsert:a.newText,newCursorPosition:a.newCursorPos??e-1}:{selectionStart:e-1,selectionEnd:e,textToInsert:"",newCursorPosition:e-1}}function mf(s){return["b","i","`"].includes(s.toLowerCase())}const fc=h.forwardRef(({value:s,defaultValue:e,onChange:t,placeholder:n,onClick:r,onMouseDown:a,onMouseUp:i,onPaste:c,onKeyDown:l,onKeyUp:d,onBlur:p,rows:u=4,className:f="",readOnly:m=!1,disabled:g=!1,...x},y)=>{const w=v=>{if(l==null||l(v),v.defaultPrevented)return;const b=v.currentTarget,{selectionStart:j,selectionEnd:S}=b,C=b.value;if(v.key==="Enter"){v.preventDefault();const N=uc(C,j,S);if(b.focus(),b.setSelectionRange(N.selectionStart,N.selectionEnd),N.replaceTextAfterCursor!==void 0){const I=C.substring(0,N.selectionStart)+N.textToInsert+N.replaceTextAfterCursor;b.value=I,b.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:b,currentTarget:b})}else if(N.selectionStart!==N.selectionEnd&&N.textToInsert===""){const A=C.substring(0,N.selectionStart)+C.substring(N.selectionEnd);b.value=A,b.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:b,currentTarget:b})}else{if(!document.execCommand("insertText",!1,N.textToInsert)&&t){const I=C.substring(0,N.selectionStart)+N.textToInsert+C.substring(N.selectionEnd);b.value=I,t({target:b,currentTarget:b})}b.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}}if(v.key==="Backspace"){const N=dc(C,j);if(N.type==="delete-char"&&N.newText!==void 0&&N.newCursorPos!==void 0){v.preventDefault(),b.value=N.newText,b.setSelectionRange(N.newCursorPos,N.newCursorPos),t&&t({target:b,currentTarget:b});return}}if(v.key==="Tab"){v.preventDefault();const N=v.shiftKey?hc(C,j,S):pc(C,j);if(b.focus(),b.setSelectionRange(N.selectionStart,N.selectionEnd),!document.execCommand("insertText",!1,N.textToInsert)&&t){const I=C.substring(0,N.selectionStart)+N.textToInsert+C.substring(N.selectionEnd);b.value=I,t({target:b,currentTarget:b})}b.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}};return o.jsx("textarea",{ref:y,value:s,defaultValue:e,onChange:t,onKeyDown:w,onKeyUp:d,placeholder:n,onClick:r,onMouseDown:a,onMouseUp:i,onPaste:c,onBlur:p,rows:u,className:B(Sp.textarea,f),readOnly:m,disabled:g,"data-test":x["data-test"],...x})});fc.displayName="RichTextarea";const nn=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,className:B("rounded-xl border bg-card text-card-foreground shadow",s),...e}));nn.displayName="Card";const xa=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,className:B("flex flex-col space-y-1.5 p-6",s),...e}));xa.displayName="CardHeader";const va=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,className:B("font-semibold leading-none tracking-tight",s),...e}));va.displayName="CardTitle";const gf=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,className:B("text-sm text-muted-foreground",s),...e}));gf.displayName="CardDescription";const rn=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,className:B("p-6 pt-0",s),...e}));rn.displayName="CardContent";const xf=h.forwardRef(({className:s,...e},t)=>o.jsx("div",{ref:t,className:B("flex items-center p-6 pt-0",s),...e}));xf.displayName="CardFooter";const vf=nu,wf=ru,fC=ou,bf=h.forwardRef(({className:s,inset:e,children:t,...n},r)=>o.jsxs(pi,{ref:r,className:B("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",s),...n,children:[t,o.jsx(ds,{className:"ml-auto"})]}));bf.displayName=pi.displayName;const yf=h.forwardRef(({className:s,...e},t)=>o.jsx(hi,{ref:t,className:B("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...e}));yf.displayName=hi.displayName;const mc=h.forwardRef(({className:s,sideOffset:e=4,...t},n)=>o.jsx(au,{children:o.jsx(oi,{ref:n,sideOffset:e,className:B("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...t})}));mc.displayName=oi.displayName;const gc=h.forwardRef(({className:s,inset:e,...t},n)=>o.jsx(ii,{ref:n,className:B("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",s),...t}));gc.displayName=ii.displayName;const Sf=h.forwardRef(({className:s,children:e,checked:t,...n},r)=>o.jsxs(ci,{ref:r,className:B("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),checked:t,...n,children:[o.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:o.jsx(li,{children:o.jsx(st,{className:"h-4 w-4"})})}),e]}));Sf.displayName=ci.displayName;const Cf=h.forwardRef(({className:s,children:e,...t},n)=>o.jsxs(fi,{ref:n,className:B("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[o.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:o.jsx(li,{children:o.jsx(kn,{className:"h-2 w-2 fill-current"})})}),e]}));Cf.displayName=fi.displayName;const jf=h.forwardRef(({className:s,inset:e,...t},n)=>o.jsx(di,{ref:n,className:B("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",s),...t}));jf.displayName=di.displayName;const Nf=h.forwardRef(({className:s,...e},t)=>o.jsx(ui,{ref:t,className:B("-mx-1 my-1 h-px bg-muted",s),...e}));Nf.displayName=ui.displayName;function Ef({onClick:s,label:e,icon:t,variant:n="default",size:r="sm",compact:a=!1,options:i=[],showDropdown:c=!0,className:l="",disabled:d=!1,"data-test":p,contentStyle:u}){const f=c&&i.length>0,m="w-3 h-3",g=a?"w-2 h-2":"w-3 h-3";return o.jsxs("div",{className:B("split-button-group inline-flex",l),"data-test":p,children:[o.jsxs(se,{onClick:s,variant:n,size:r,disabled:d,className:B(a&&"h-5 px-1 min-w-0",f&&"rounded-r-none border-r-0"),"data-test":p?`${p}-main-button`:void 0,children:[t&&o.jsx(t,{className:B(m,e&&"mr-1"),"data-test":p?`${p}-icon`:void 0}),e&&o.jsx("span",{className:a?"text-xs":"",children:e})]}),f&&o.jsxs(vf,{children:[o.jsx(wf,{asChild:!0,children:o.jsx(se,{variant:n,size:r,disabled:d,className:B("rounded-l-none",a?"h-5 px-0.5 min-w-0":"px-1"),"data-test":p?`${p}-dropdown-trigger`:void 0,children:o.jsx(ms,{className:g,"data-test":p?`${p}-dropdown-icon`:void 0})})}),o.jsx(mc,{align:"end",style:u,"data-test":p?`${p}-dropdown-menu`:void 0,children:i.map((x,y)=>o.jsx(gc,{onClick:x.onClick,className:"text-xs","data-test":p?`${p}-option-${x.label.toLowerCase().replace(/\s+/g,"-")}`:void 0,children:x.label},y))})]})]})}async function lo(s,e){try{e==null||e.info(`Converting ${s.type} (${s.size} bytes) to WAV`);const t=new(window.AudioContext||window.webkitAudioContext),n=await s.arrayBuffer(),r=await t.decodeAudioData(n);e==null||e.debug(`Decoded: ${r.duration}s, ${r.sampleRate}Hz, ${r.numberOfChannels}ch`);const a=r.numberOfChannels,i=r.sampleRate,c=r.length,l=new Float32Array(c*a);for(let u=0;u<a;u++){const f=r.getChannelData(u);for(let m=0;m<c;m++)l[m*a+u]=f[m]}const d=kf(l,i,a),p=new Blob([d],{type:"audio/wav"});if(!p||p.size===0)throw new Error("Failed to create valid WAV blob");return e==null||e.info(`Conversion complete: ${p.size} bytes`),p}catch(t){throw e==null||e.error(`Audio conversion failed: ${t}`),t}}function kf(s,e,t){const n=new ArrayBuffer(44+s.length*2),r=new DataView(n),a=(c,l)=>{for(let d=0;d<l.length;d++)r.setUint8(c+d,l.charCodeAt(d))};a(0,"RIFF"),r.setUint32(4,36+s.length*2,!0),a(8,"WAVE"),a(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,e,!0),r.setUint32(28,e*t*2,!0),r.setUint16(32,t*2,!0),r.setUint16(34,16,!0),a(36,"data"),r.setUint32(40,s.length*2,!0);let i=44;return s.forEach(c=>{const l=Math.max(-1,Math.min(1,c));r.setInt16(i,l*32767,!0),i+=2}),n}function If(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map((i,c)=>c===0?i.toLowerCase():i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function Tf(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function Af(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.toLowerCase()).join("_")+t}function mC(s,e){switch(e){case"camel":return If(s);case"pascal":return Tf(s);case"snake":return Af(s);default:return s}}function uo(s){return s.endsWith("...")?s.slice(0,-3).trim():s}function Pf(s){return s.trim().endsWith(".")?s.slice(0,-1).trim():s}let Rf="transcriptions";const po=["ggml-large-v3","ggml-large-v3-q5_0","ggml-large-v3-turbo","ggml-distil-large-v3","distil-large-v3.5"];let Df="ggml-distil-large-v3";const xc={language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:Df},Of=["CÃ¡c báº¡n","CÃ¡c báº¡n nhá»› Ä‘Äƒng kÃ½ kÃªnh Ä‘á»ƒ á»§ng há»™ kÃªnh cá»§a mÃ¬nh nhÃ©! Háº¹n gáº·p láº¡i cÃ¡c báº¡n trong nhá»¯ng video tiáº¿p theo!","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi, quÃ½ vá»‹","Hi, quÃ½ vá»‹. Xin chÃ o táº¥t cáº£ cÃ¡c báº¡n","HÃ£y subscribe cho kÃªnh","HÃ£y subscribe cho kÃªnh Ghiá»n MÃ¬ GÃµ Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","HÃ£y subscribe cho kÃªnh La La School Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","lalaschool","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Cáº¢M Æ N CÃC Báº N ÄÃƒ THEO DÃ•I VÃ€ ÄÄ‚NG KÃ KÃŠNH NHÃ‰!"];class an extends Error{constructor(e,t,n,r){super(e),this.code=t,this.statusCode=n,this.detail=r,this.name="PythonTranscribeApiError"}}class Lf extends an{constructor(e){super(e??"Bad Request - invalid file format or missing file","PTApi_BAD_REQUEST",400,e),this.name="PTApiBadRequestError"}}class _f extends an{constructor(e){super(e??"Payload Too Large - file exceeds size limit","PTApi_PAYLOAD_TOO_LARGE",413,e),this.name="PTApiPayloadTooLargeError"}}class Mf extends an{constructor(e){super(e??"Internal Server Error - transcription service error","PTApi_INTERNAL_SERVER_ERROR",500,e),this.name="PTApiInternalServerError"}}class Ff extends an{constructor(e,t){super(t??`HTTP error! status: ${e}`,"PTApi_HTTP_ERROR",e,t),this.name="PTApiHttpError"}}class vc extends an{constructor(){super("Transcription contains denied phrases.","PTApi_DENIED_PHRASES"),this.name="PTApiDeniedPhrasesError"}}const $f="PythonTranscribeApiService";class Uf{constructor(){Q(this,"baseUrl");this.baseUrl="http://192.168.2.70:9876"}async transcribeAudio(e,t={}){t={...xc,...t},je.info(`ðŸ”¤ Transcription request payload: ${JSON.stringify({file:e.name,size:`${(e.size/1024).toFixed(1)}KB`,...t})}`,$f);const n=new FormData;t.language!==void 0&&n.append("language",t.language),t.translate!==void 0&&n.append("translate",t.translate.toString()),t.no_timestamps!==void 0&&n.append("no_timestamps",t.no_timestamps.toString()),t.no_prints!==void 0&&n.append("no_prints",t.no_prints.toString()),t.auto_detect_language!==void 0&&n.append("auto_detect_language",t.auto_detect_language.toString()),t.model!==void 0&&n.append("model",t.model),n.append("file",e);try{const r=await fetch(`${this.baseUrl}/${Rf}`,{method:"POST",body:n});if(!r.ok){const i=await r.json();switch(r.status){case 400:throw new Lf(i.detail);case 413:throw new _f(i.detail);case 500:throw new Mf(i.detail);default:throw new Ff(r.status,i.detail)}}const a=await r.json();if(a.transcription=Pf(a.transcription),Of.some(i=>a.transcription.toLowerCase().includes(i.toLowerCase())))throw new vc;return a}catch(r){throw r}}setBaseUrl(e){this.baseUrl=e}}const wc=new Uf,ln={language:"auto",translate:!1,no_timestamps:!0,auto_detect_language:!0,word_level_timestamps:!1,split:!1},On={DEFAULT:{silenceThreshold:-20,minSilenceDuration:40,holdTime:100,padding:-60,waveformSamples:1e3},TIGHT:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3},LOOSE:{silenceThreshold:-30,minSilenceDuration:100,holdTime:200,padding:0,waveformSamples:1e3},WORD_STREAMING:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3}};class Bf{constructor(e={}){Q(this,"defaultConfig");const t=On.DEFAULT;this.defaultConfig={silenceThreshold:e.silenceThreshold??t.silenceThreshold,minSilenceDuration:e.minSilenceDuration??t.minSilenceDuration,holdTime:e.holdTime??t.holdTime,padding:e.padding??t.padding,waveformSamples:e.waveformSamples??t.waveformSamples??1e3}}async analyzeAudio(e,t={}){const n={silenceThreshold:t.silenceThreshold??this.defaultConfig.silenceThreshold,minSilenceDuration:t.minSilenceDuration??this.defaultConfig.minSilenceDuration,holdTime:t.holdTime??this.defaultConfig.holdTime,padding:t.padding??this.defaultConfig.padding,waveformSamples:t.waveformSamples??this.defaultConfig.waveformSamples},r=this._generateWaveform(e,n.waveformSamples),a=this._normalize(r),i=this._toDbfs(a),c=this._detectActiveRegions(i,e.duration,n.silenceThreshold),l=this._mergeCloseRegions(c,n.holdTime),d=this._calculateSilences(l,e.duration*1e3),p=this._filterByDuration(d,n.minSilenceDuration),u=this._applySilencePadding(p,e.duration*1e3,n.padding);return this._getActiveRegions(u,e.duration)}_generateWaveform(e,t){const n=e.numberOfChannels,r=e.length,a=new Float32Array(r);for(let l=0;l<r;l++){let d=0;for(let p=0;p<n;p++)d+=e.getChannelData(p)[l];a[l]=d/n}const i=Math.max(1,Math.floor(r/t)),c=[];for(let l=0;l<t;l++){const d=l*i,p=Math.min(d+i,r);if(d<r&&p>d){let u=0;for(let m=d;m<p;m++)u+=Math.abs(a[m])**2;const f=Math.sqrt(u/(p-d));c.push(f)}else c.push(0)}return c}_normalize(e){const t=e.map(a=>isNaN(a)||!isFinite(a)?0:a),n=Math.max(...t),r=n>0?n:1;return t.map(a=>a/r)}_toDbfs(e){return e.map(n=>20*Math.log10(n+1e-10))}_detectActiveRegions(e,t,n){const r=e.map(l=>l>n),a=[];let i=!1,c=0;for(let l=0;l<r.length;l++)if(r[l]&&!i)c=l,i=!0;else if(!r[l]&&i){const d=l,p=c/e.length*t*1e3,u=d/e.length*t*1e3;a.push([p,u]),i=!1}if(i){const l=t*1e3,d=c/e.length*t*1e3;a.push([d,l])}return a}_mergeCloseRegions(e,t){if(e.length===0)return[];const n=[...e].sort((a,i)=>a[0]-i[0]),r=[n[0]];for(let a=1;a<n.length;a++){const[i,c]=n[a],l=r.length-1,[d,p]=r[l];i-p<=t?r[l]=[d,c]:r.push([i,c])}return r}_calculateSilences(e,t){const n=[];if(e.length===0)return[[0,t]];e[0][0]>0&&n.push([0,e[0][0]]);for(let a=0;a<e.length-1;a++){const i=e[a][1],c=e[a+1][0];c>i&&n.push([i,c])}const r=e[e.length-1][1];return r<t&&n.push([r,t]),n}_filterByDuration(e,t){return e.filter(([n,r])=>r-n>=t)}_applySilencePadding(e,t,n){if(n===0||e.length===0)return e;const r=[];for(let a=0;a<e.length;a++){const[i,c]=e[a];if(i===0){const d=Math.min(t,c+n);d>0&&r.push([0,d])}else if(a===e.length-1&&c===t){const l=Math.max(0,i-n),d=t;d>l&&r.push([l,d])}else{const l=Math.max(0,i-n),d=Math.min(t,c+n);d>l&&r.push([l,d])}}return r}_getActiveRegions(e,t){const n=[];if(e.length===0)return[[0,t]];const r=e.map(([i,c])=>[i/1e3,c/1e3]);r[0][0]>0&&n.push([0,r[0][0]]);for(let i=0;i<r.length-1;i++){const c=r[i][1],l=r[i+1][0];l>c&&n.push([c,l])}const a=r[r.length-1][1];return a<t&&n.push([a,t]),n}}class bc{constructor(e={}){Q(this,"detector");this.detector=new Bf(e)}async chunkFile(e){const t=await e.arrayBuffer(),r=await new AudioContext().decodeAudioData(t);return this.chunkAudio(r)}async chunkAudio(e,t){return(await this.detector.analyzeAudio(e,t)).map((a,i)=>{const[c,l]=a,d=this._extractChunk(e,c,l);return{blob:this._audioBufferToWav(d),startTime:c,endTime:l,duration:l-c,index:i+1}})}_extractChunk(e,t,n){const r=e.sampleRate,a=Math.floor(t*r),c=Math.floor(n*r)-a,d=new AudioContext().createBuffer(e.numberOfChannels,c,r);for(let p=0;p<e.numberOfChannels;p++){const u=e.getChannelData(p),f=d.getChannelData(p);for(let m=0;m<c;m++)f[m]=u[a+m]}return d}_audioBufferToWav(e){const t=e.numberOfChannels,n=e.sampleRate,r=1,a=16,i=a/8,c=t*i,l=n*c,d=e.length*c,p=new ArrayBuffer(44+d),u=new DataView(p),f=(x,y)=>{for(let w=0;w<y.length;w++)u.setUint8(x+w,y.charCodeAt(w))};f(0,"RIFF"),u.setUint32(4,36+d,!0),f(8,"WAVE"),f(12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,r,!0),u.setUint16(22,t,!0),u.setUint32(24,n,!0),u.setUint32(28,l,!0),u.setUint16(32,c,!0),u.setUint16(34,a,!0),f(36,"data"),u.setUint32(40,d,!0);const m=[];for(let x=0;x<t;x++)m.push(e.getChannelData(x));let g=44;for(let x=0;x<e.length;x++)for(let y=0;y<t;y++){const w=Math.max(-1,Math.min(1,m[y][x])),v=w<0?w*32768:w*32767;u.setInt16(g,v,!0),g+=2}return new Blob([p],{type:"audio/wav"})}async getActiveRegions(e,t){return this.detector.analyzeAudio(e,t)}}const Me="WebSocketTranscriptionService";class Wf{constructor(e){Q(this,"ws",null);Q(this,"wsUrl");Q(this,"eventHandlers",{});Q(this,"isConnected",!1);Q(this,"reconnectAttempts",0);Q(this,"maxReconnectAttempts",3);Q(this,"reconnectDelay",1e3);this.wsUrl=e??"ws://192.168.2.70:9876/ws/transcribe"??"ws://localhost:9876/ws/transcribe"}setEventHandlers(e){this.eventHandlers=e}async connect(){return new Promise((e,t)=>{try{je.info(`Connecting to WebSocket: ${this.wsUrl}`,Me),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var n,r;je.info("WebSocket connection opened",Me),this.isConnected=!0,this.reconnectAttempts=0,(r=(n=this.eventHandlers).onConnectionOpen)==null||r.call(n),e()},this.ws.onmessage=n=>{this.handleMessage(n)},this.ws.onerror=n=>{var r,a;je.error(`WebSocket error: ${n}`,Me),(a=(r=this.eventHandlers).onConnectionError)==null||a.call(r,n),t(n)},this.ws.onclose=n=>{var r,a;je.info(`WebSocket closed: code=${n.code}, reason=${n.reason}`,Me),this.isConnected=!1,(a=(r=this.eventHandlers).onConnectionClose)==null||a.call(r,n.code,n.reason),this.reconnectAttempts<this.maxReconnectAttempts&&n.code!==1e3&&(this.reconnectAttempts++,je.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,Me),setTimeout(()=>{this.connect().catch(i=>{je.error(`Reconnection failed: ${i}`,Me)})},this.reconnectDelay))}}catch(n){je.error(`Failed to create WebSocket connection: ${n}`,Me),t(n)}})}handleMessage(e){var t,n,r,a,i,c,l,d,p,u;try{const f=JSON.parse(e.data);switch(f.type){case"progress":je.info(`Progress: ${f.data.percentage}% - ${f.data.message}`,Me),(n=(t=this.eventHandlers).onProgress)==null||n.call(t,f.data);break;case"word":je.info(`Word: "${f.data.word}" [${f.data.start_time}s - ${f.data.end_time}s]`,Me),(a=(r=this.eventHandlers).onWord)==null||a.call(r,f.data);break;case"segment":je.info(`Segment ${f.data.segment}: "${f.data.transcription}"`,Me),(c=(i=this.eventHandlers).onSegment)==null||c.call(i,f.data);break;case"complete":je.info("Transcription complete",Me),(d=(l=this.eventHandlers).onComplete)==null||d.call(l,f.data);break;case"error":je.error(`Server error: ${f.data.message} (code: ${f.data.code})`,Me),(u=(p=this.eventHandlers).onError)==null||u.call(p,f.data);break;default:je.error(`Unknown message type: ${f.type}`,Me)}}catch(f){je.error(`Failed to parse message: ${f}`,Me)}}async sendConfig(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"config",data:e};je.info(`Sending config: ${JSON.stringify(e)}`,Me),this.ws.send(JSON.stringify(t))}async sendAudioChunk(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"audio_chunk",data:{chunk:e}};je.info(`Sending audio chunk (${e.length} chars)`,Me),this.ws.send(JSON.stringify(t))}async sendAudioChunks(e){for(const t of e)await this.sendAudioChunk(t)}async startTranscription(){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const e={type:"start",data:{}};je.info("Starting transcription",Me),this.ws.send(JSON.stringify(e))}async transcribeAudioFile(e,t=ln){this.isConnected||await this.connect(),await this.sendConfig(t);const n=await e.arrayBuffer(),r=new Uint8Array(n);let a="";const i=r.byteLength;for(let l=0;l<i;l++)a+=String.fromCharCode(r[l]);const c=btoa(a);await this.sendAudioChunk(c),await this.startTranscription()}async transcribeAudioBlob(e,t=ln){const n=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFile(n,t)}async transcribeAudioFileWithChunking(e,t={...ln,word_level_timestamps:!0,split:!1},n=On.WORD_STREAMING){this.isConnected||await this.connect(),je.info("Starting client-side silence-based chunking",Me);const a=await new bc(n).chunkFile(e);je.info(`Audio split into ${a.length} chunks (client-side)`,Me);for(let i=0;i<a.length;i++){const c=a[i];await this._transcribeChunk(c,i+1,a.length,t)}je.info("All chunks processed",Me)}async _transcribeChunk(e,t,n,r){return new Promise((a,i)=>{je.info(`Processing chunk ${t}/${n} (${e.startTime.toFixed(2)}s - ${e.endTime.toFixed(2)}s)`,Me);const c=this.eventHandlers.onComplete,l=this.eventHandlers.onError;this.eventHandlers.onComplete=d=>{if(this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,c){const p={...d,metadata:{...d.metadata,chunk_index:t,chunk_start_time:e.startTime,chunk_end_time:e.endTime}};c(p)}je.info(`Chunk ${t}/${n} transcription complete`,Me),a()},this.eventHandlers.onError=d=>{this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,l&&l(d),je.error(`Chunk ${t}/${n} transcription failed: ${d.message}`,Me),i(new Error(d.message))},this._sendChunkTranscriptionRequest(e,r).catch(i)})}async _sendChunkTranscriptionRequest(e,t){const n={...t,split:!1};await this.sendConfig(n);const r=await e.blob.arrayBuffer(),a=new Uint8Array(r);let i="";const c=a.byteLength;for(let d=0;d<c;d++)i+=String.fromCharCode(a[d]);const l=btoa(i);await this.sendAudioChunk(l),await this.startTranscription()}async transcribeAudioBlobWithChunking(e,t={...ln,word_level_timestamps:!0,split:!1},n=On.WORD_STREAMING){const r=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFileWithChunking(r,t,n)}disconnect(){this.ws&&(je.info("Disconnecting WebSocket",Me),this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}setUrl(e){if(this.isConnected)throw je.error("Cannot update URL while connected. Disconnect first.",Me),new Error("Cannot update URL while connected");this.wsUrl=e,je.info(`WebSocket URL updated to: ${this.wsUrl}`,Me)}setMaxReconnectAttempts(e){this.maxReconnectAttempts=e}setReconnectDelay(e){this.reconnectDelay=e}}const zf=(s={})=>{const{onChunkCreated:e,onChunkUpdated:t,onChunkDeleted:n,onChunksLoaded:r,onError:a,sessionName:i="recording-session",enableAutoPersist:c=!0,enableAutoTranscription:l=!0,minChunkDuration:d=1e3,loadPersistedChunks:p=!0,skipLastSessionChunk:u=!1,transcribeOptions:f,useWebSocket:m=!1,onWordReceived:g,onTranscriptionProgress:x}=s,[y,w]=h.useState(!1),[v,b]=h.useState(!1),[j,S]=h.useState([]),[C,N]=h.useState(0),[A,I]=h.useState(null),k=h.useRef([]);h.useEffect(()=>{k.current=j},[j]);const P=h.useRef(f);h.useEffect(()=>{P.current=f},[f]);const W=h.useRef(null),R=h.useRef(null),F=h.useRef([]),L=h.useRef([]),T=h.useRef(null),M=h.useRef(null),D=h.useRef(null),H=h.useRef(0),Y=h.useRef(!1),O=h.useRef(null),q=h.useRef(null),K=h.useCallback($=>{const V=new Date().toISOString().slice(0,19).replace(/[:]/g,"-");return`${i}-chunk-${$.toString().padStart(3,"0")}-${V}`},[i]),G=h.useCallback(async()=>{if(p)try{const $=await ft.loadChunksBySession(i);if($.length===0)return;S($);const V=Math.max(...$.map(ee=>ee.chunkNumber),0);N(V),r==null||r($)}catch($){a==null||a(`Failed to load persisted chunks: ${$ instanceof Error?$.message:"Unknown error"}`)}},[i,p,r]);h.useEffect(()=>(m&&!O.current&&(O.current=new Wf,O.current.setEventHandlers({onWord:$=>{const V=q.current;V&&(g==null||g($,V))},onProgress:$=>{const V=q.current;V&&(x==null||x($,V))},onComplete:$=>{const V=q.current;if(!V)return;const ee=uo($.transcription);S(le=>{const ne=le.find(fe=>fe.id===V);if(!ne)return le;const de={...ne,transcription:ee,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(de)),le.map(fe=>fe.id===V?de:fe)}),c&&ft.updateChunkTranscription(V,ee).catch(()=>{}),q.current=null},onError:$=>{const V=q.current;V&&(S(ee=>{const le=ee.find(de=>de.id===V);if(!le)return ee;const ne={...le,transcriptionStatus:"failed",transcriptionError:$.message};return queueMicrotask(()=>t==null?void 0:t(ne)),ee.map(de=>de.id===V?ne:de)}),c&&ft.updateChunkTranscriptionStatus(V,"failed",$.message).catch(()=>{})),a==null||a($.message),q.current=null},onConnectionOpen:()=>{},onConnectionClose:()=>{},onConnectionError:()=>{a==null||a("WebSocket connection error")}})),()=>{O.current&&(O.current.disconnect(),O.current=null)}),[m,g,x,t,a,c]);const U=h.useCallback(async($,V,ee,le)=>{const ne=le||P.current,de=k.current.find(xe=>xe.id===$);if(!de||de.transcriptionStatus==="processing"||de.transcriptionStatus==="completed"&&de.transcription)return;const fe={...de,transcriptionStatus:"processing"};if(S(xe=>(queueMicrotask(()=>t==null?void 0:t(fe)),xe.map(Ce=>Ce.id===$?fe:Ce))),c)try{await ft.updateChunkTranscriptionStatus($,"processing")}catch{}if(m&&O.current){try{q.current=$,O.current.connected||await O.current.connect(),await O.current.transcribeAudioBlob(V,{language:(ne==null?void 0:ne.language)||"auto",word_level_timestamps:!0,no_timestamps:(ne==null?void 0:ne.no_timestamps)??!0,translate:(ne==null?void 0:ne.translate)??!1,auto_detect_language:(ne==null?void 0:ne.auto_detect_language)??!0})}catch(xe){const Ce=xe instanceof Error?xe.message:"WebSocket transcription error";if(S(Se=>{const _=Se.find(z=>z.id===$);if(!_)return Se;const E={..._,transcriptionStatus:"failed",transcriptionError:Ce};return queueMicrotask(()=>t==null?void 0:t(E)),Se.map(z=>z.id===$?E:z)}),c)try{await ft.updateChunkTranscriptionStatus($,"failed",Ce)}catch{}a==null||a(`WebSocket transcription failed for ${ee}: ${Ce}`),q.current=null}return}try{const xe=new File([V],`${ee}.wav`,{type:"audio/wav"}),Ce=await wc.transcribeAudio(xe,ne),Se=uo(Ce.transcription);if(S(_=>{const E=_.find(pe=>pe.id===$);if(!E)return _;const z={...E,transcription:Se,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(z)),_.map(pe=>pe.id===$?z:pe)}),c)try{await ft.updateChunkTranscription($,Se)}catch{}}catch(xe){if(xe instanceof vc){if(console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Skipping chunk due to denied phrases:",ee),S(Se=>Se.filter(_=>_.id!==$)),c)try{await ft.deleteChunk($)}catch(Se){console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Failed to delete chunk from storage:",Se)}n==null||n($);return}const Ce=xe instanceof Error?xe.message:"Unknown transcription error";if(S(Se=>{const _=Se.find(z=>z.id===$);if(!_)return Se;const E={..._,transcriptionStatus:"failed",transcriptionError:Ce};return queueMicrotask(()=>t==null?void 0:t(E)),Se.map(z=>z.id===$?E:z)}),c)try{await ft.updateChunkTranscriptionStatus($,"failed",Ce)}catch{}a==null||a(`Transcription failed for ${ee}: ${Ce}`)}},[c,t,m]),Z=h.useCallback(async()=>{try{const $=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return R.current=$,!0}catch($){const V=$ instanceof Error?$.message:"Failed to access microphone";return I(V),a==null||a(V),!1}},[a]),ue=h.useCallback(async()=>{if(!(!W.current||v))try{const $=H.current+1,V={id:`segment-${crypto.randomUUID()}`,chunkNumber:$,startTime:new Date,name:K($)};D.current=V,b(!0)}catch($){const V=$ instanceof Error?$.message:"Failed to start segment recording";I(V),a==null||a(V),b(!1)}},[v,K,a]),we=h.useCallback(async()=>{if(!(!W.current||!v||!D.current))try{const $=D.current;D.current=null,b(!1),W.current.requestData(),await new Promise(Ce=>setTimeout(Ce,50));const V=new Date,ee=V.getTime()-$.startTime.getTime();if(ee<d){L.current=[];return}const le=W.current.mimeType||"audio/webm",ne=[];T.current&&ne.push(T.current),ne.push(...L.current);const de=new Blob(ne,{type:le});let fe;try{fe=await lo(de)}catch{fe=de}const xe={...$,endTime:V,duration:ee,blob:fe,size:fe.size,transcriptionStatus:l?"pending":void 0};if(S(Ce=>[...Ce,xe]),k.current=[...k.current,xe],H.current=$.chunkNumber,N($.chunkNumber),L.current=[],c)try{await ft.saveChunk(xe,i),e==null||e(xe),l&&U(xe.id,fe,xe.name,P.current).catch(()=>{})}catch(Ce){const Se=Ce instanceof Error?Ce.message:"Failed to save segment";I(Se),a==null||a(Se)}else e==null||e(xe),l&&U(xe.id,fe,xe.name,P.current).catch(()=>{})}catch($){const V=$ instanceof Error?$.message:"Failed to stop segment";I(V),a==null||a(V),b(!1)}},[v,d,c,l,i,e,a,U]),ae=h.useCallback(async()=>{if(!await Z())return;const V=new Date().toISOString().slice(0,19).replace(/[:]/g,"-"),ee={id:`session-${crypto.randomUUID()}`,chunkNumber:0,startTime:new Date,name:`${i}-session-${V}`};M.current=ee,F.current=[],L.current=[],H.current=0,T.current=null,Y.current=!1;const ne=["audio/webm;codecs=opus","audio/webm;codecs=vorbis","audio/webm","audio/ogg;codecs=opus","audio/mp4;codecs=mp4a.40.2","audio/mp4"].find(fe=>MediaRecorder.isTypeSupported(fe))??"audio/webm",de=new MediaRecorder(R.current,{mimeType:ne});W.current=de,de.ondataavailable=fe=>{if(fe.data.size>0){if(!Y.current){T.current=fe.data,Y.current=!0,F.current.push(fe.data);return}F.current.push(fe.data),L.current.push(fe.data)}},de.onstop=async()=>{if(!M.current)return;if(u){M.current=null;return}const fe=new Blob(F.current,{type:ne}),xe=new Date,Ce=xe.getTime()-M.current.startTime.getTime();let Se;try{Se=await lo(fe)}catch{Se=fe}const _={...M.current,endTime:xe,duration:Ce,blob:Se,size:Se.size,transcriptionStatus:l?"pending":void 0};if(S(E=>[...E,_]),k.current=[...k.current,_],c)try{await ft.saveChunk(_,i),e==null||e(_),l&&U(_.id,Se,_.name,P.current).catch(()=>{})}catch(E){const z=E instanceof Error?E.message:"Failed to save session chunk";I(z),a==null||a(z)}else e==null||e(_);M.current=null},de.onerror=()=>{I("Session recording failed"),a==null||a("Session recording failed")},de.start(100),w(!0),I(null)},[Z,i,c,l,u,e,a,U]),Te=h.useCallback(()=>{W.current&&W.current.state!=="inactive"&&W.current.stop(),w(!1),b(!1),R.current&&(R.current.getTracks().forEach($=>{$.stop()}),R.current=null)},[]),ke=h.useCallback(()=>{y&&Te(),S([]),N(0),I(null),D.current=null,M.current=null},[y,Te]),Ee=h.useCallback(()=>{v&&(b(!1),D.current=null,L.current=[])},[v]),$e=h.useCallback(async $=>{if(S(V=>V.filter(ee=>ee.id!==$)),c)try{await ft.deleteChunk($)}catch(V){a==null||a(`Failed to delete chunk from storage: ${V instanceof Error?V.message:"Unknown error"}`)}},[c]);h.useEffect(()=>{G()},[]),h.useEffect(()=>()=>{R.current&&R.current.getTracks().forEach($=>$.stop())},[]);const ge=h.useCallback(async()=>{if(!(!m||!O.current)){O.current.disconnect(),await new Promise($=>setTimeout($,100));try{await O.current.connect()}catch{a==null||a("Failed to reconnect WebSocket")}}},[m,a]),ie={isRecording:y,isChunkRecording:v,chunks:j,currentChunkNumber:C,error:A},re={startRecording:ae,stopRecording:Te,resetRecording:ke},te=h.useCallback(async($,V)=>{if(S(ee=>{const le=ee.find(de=>de.id===$);if(!le)return ee;const ne={...le,transcription:V,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(ne)),ee.map(de=>de.id===$?ne:de)}),c)try{await ft.updateChunkTranscription($,V)}catch{}},[c,t]);return{state:ie,actions:re,startChunk:ue,stopChunk:we,discardCurrentChunk:Ee,deleteChunk:$e,transcribeChunk:U,updateChunkTranscription:te,reconnectWebSocket:ge}};function Hf({config:s,isRecording:e,isChunkRecording:t,callbacks:n,cumulativeActiveTimeRef:r,peakAudioLevelRef:a}){const i=h.useRef(null),c=h.useRef(!1),l=h.useRef(null),d=h.useRef({vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold}),p=h.useRef({isRecording:e,isChunkRecording:t});h.useEffect(()=>{d.current={vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold},p.current={isRecording:e,isChunkRecording:t}},[s.vadSilenceTimeout,s.vadMaxChunkDuration,s.silenceDetectionConfig.minActiveDuration,s.silenceDetectionConfig.activationThreshold,e,t]);const u=h.useCallback(()=>{i.current=null,c.current=!1,l.current=null,a.current=0},[a]),f=h.useCallback(async()=>{i.current=Date.now(),c.current=!0,l.current=null,a.current=0,await n.startChunk()},[n,a]),m=h.useCallback(async v=>{v?await n.stopChunk():n.discardCurrentChunk(),u()},[n,u]),g=h.useCallback(async()=>{p.current.isChunkRecording?(c.current=!0,l.current=null):await f()},[f]),x=h.useCallback(async()=>{if(!p.current.isChunkRecording||!c.current)return;const v=Date.now();if(l.current===null){l.current=v;return}if(v-l.current>=d.current.vadSilenceTimeout){const C=r.current>=d.current.minActiveDuration,A=a.current>=d.current.activationThreshold;await m(C&&A)}},[m,r,a]),y=h.useCallback(async()=>{if(!p.current.isChunkRecording||!i.current)return;Date.now()-i.current>=d.current.vadMaxChunkDuration&&(await n.stopChunk(),c.current&&!p.current.isChunkRecording?await f():u())},[n,f,u]);return{processVADAudio:h.useCallback((v,b)=>{if(!p.current.isRecording)return;const j=!v,S=j&&b,C=j&&!p.current.isChunkRecording&&!c.current;(S||C)&&g(),v&&x(),y()},[g,x,y]),resetVADState:u}}const wa={silenceThreshold:.47,minSilenceDuration:0,minActiveDuration:1500,activationThreshold:.67},Bs={enableAutoTranscription:!0,minChunkDuration:500,silenceDetectionConfig:wa,autoStopOnSilence:!1,autoCreateChunks:!0,autoChunkCreationTime:1e3,skipLastSessionChunk:!0,transcribeOptions:xc,chunkingMode:"time",vadMaxChunkDuration:1e4,vadSilenceTimeout:1500,useWebSocket:!1},yn={default:{id:"custom-1759528805538",name:"Default (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:wa.activationThreshold},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},eng:{id:"custom-1759528805538",name:"Eng (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},vi:{name:"VN",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},ws:{name:"WS",description:"WebSocket real-time streaming",config:{silenceDetectionConfig:{minActiveDuration:800,activationThreshold:.67},useWebSocket:!0,chunkingMode:"time",autoCreateChunks:!0,autoChunkCreationTime:1e3,minChunkDuration:500,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,model:"ggml-distil-large-v3"}}}},yc="audio-panel-custom-presets";function Sc(s,e){if(s===e)return!0;if(typeof s!="object"||typeof e!="object"||s===null||e===null)return!1;const t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!n.includes(r)||!Sc(s[r],e[r]))return!1;return!0}function Cc(s){const e={};return Object.keys(s).forEach(t=>{Sc(s[t],Bs[t])||(e[t]=s[t])}),e}function Ln(s){return{...Bs,...s,silenceDetectionConfig:{...Bs.silenceDetectionConfig,...s.silenceDetectionConfig??{}},transcribeOptions:{...Bs.transcribeOptions,...s.transcribeOptions??{}}}}function on(){try{const s=localStorage.getItem(yc);return s?JSON.parse(s).map(t=>({...t,createdAt:new Date(t.createdAt)})):[]}catch(s){return console.error("Failed to load custom presets:",s),[]}}function ba(s){try{localStorage.setItem(yc,JSON.stringify(s))}catch(e){console.error("Failed to save custom presets:",e)}}function Gf(s,e,t){const n=Cc(t),r={id:`custom-${Date.now()}`,name:s,description:e,config:n,createdAt:new Date},a=on();return a.push(r),ba(a),r}function qf(s,e){const t=on(),n=t.findIndex(i=>i.id===s);if(n===-1)return console.error(`Preset with id ${s} not found`),null;const r=Cc(e),a={...t[n],config:r};return t[n]=a,ba(t),a}function Vf(s){const t=on().filter(n=>n.id!==s);ba(t)}function Kf(s={}){const e=h.useMemo(()=>({...wa,...s}),[s]),[t,n]=Td.useState({isSilent:!0,currentLevel:0,silenceThreshold:e.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}),r=h.useCallback(c=>{const l=Math.max(...c),d=Date.now();n(p=>{const u=d-p.lastStateChange,f=l<=p.silenceThreshold;let m=p.isSilent,g=p.silenceDuration,x=p.activeDuration,y=p.lastStateChange;return f?(g+=u,x=0,!p.isSilent&&g>=e.minSilenceDuration&&(m=!0,y=d)):(x+=u,g=0,p.isSilent&&x>=e.minActiveDuration&&(m=!1,y=d)),{isSilent:m,currentLevel:l,silenceThreshold:p.silenceThreshold,silenceDuration:g,activeDuration:x,lastStateChange:y}})},[e.minSilenceDuration,e.minActiveDuration,t.lastStateChange]),a=h.useCallback(c=>{const l=Math.max(0,Math.min(1,c));n(d=>({...d,silenceThreshold:l}))},[]),i=h.useCallback(()=>{n(c=>({isSilent:!0,currentLevel:0,silenceThreshold:c.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}))},[]);return{state:t,processAudioData:r,updateThreshold:a,reset:i}}const Mt=h.forwardRef(({className:s,...e},t)=>o.jsxs(mi,{ref:t,className:B("relative flex w-full touch-none select-none items-center",s),...e,children:[o.jsx(iu,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:o.jsx(cu,{className:"absolute h-full bg-primary"})}),o.jsx(lu,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));Mt.displayName=mi.displayName;const Jf=({audioData:s,silenceState:e,onThresholdChange:t,hideSilenceControls:n=!1,duration:r=0,className:a=""})=>{const i=h.useCallback(d=>{t==null||t(d[0])},[t]),c=d=>{const p=d/1e3,u=Math.floor(p/60),f=Math.floor(p%60),m=Math.floor(p%1*10);return`${u}:${f.toString().padStart(2,"0")}.${m}`};return o.jsx("div",{className:`silence-detection-visualizer ${a}`,children:o.jsxs("div",{className:"visualization-container relative flex flex-col p-2 bg-muted/50 rounded-lg",style:{height:"64px"},children:[o.jsxs("div",{className:"top-controls flex justify-between items-center gap-2 mb-1 z-20",children:[o.jsx("div",{className:"time-display flex items-center",children:o.jsx("span",{className:"text-[9px] font-medium text-foreground",children:c(r)})}),o.jsxs("div",{className:"right-controls flex items-center gap-2",children:[o.jsxs("div",{className:"status-display flex items-center gap-1",children:[o.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${e.isSilent?"bg-gray-400":"bg-green-500 animate-pulse"}`}),o.jsx("span",{className:"text-[9px] font-medium",children:e.isSilent?"Silent":"Active"}),o.jsx("span",{className:"text-[9px] text-muted-foreground",children:`${(e.currentLevel*100).toFixed(0)}%`})]}),!n&&o.jsxs("div",{className:"threshold-control flex-1 flex items-center gap-1.5",children:[o.jsx("label",{className:"text-[9px] font-medium shrink-0",children:`T: ${(e.silenceThreshold*100).toFixed(0)}%`}),o.jsx(Mt,{min:0,max:1,step:.01,value:[e.silenceThreshold],onValueChange:i,className:"flex-1"})]})]})]}),o.jsxs("div",{className:"bars-container relative flex items-end justify-center flex-1",children:[o.jsx("div",{className:"threshold-line absolute left-0 right-0 border-t border-red-500 border-dashed z-10",style:{bottom:`${e.silenceThreshold*100}%`}}),o.jsx("div",{className:"visualization-bars flex items-end justify-center gap-0.5 h-full w-full max-w-2xl relative z-0",children:s.map((d,p)=>{const u=Math.max(d*100,2),f=d>e.silenceThreshold;return o.jsx("div",{className:"visualization-bar flex-1 max-w-2 rounded-t transition-all duration-75 ease-out",style:{height:`${u}%`,backgroundColor:f?`rgba(34, 197, 94, ${.3+d*.7})`:`rgba(156, 163, 175, ${.3+d*.7})`,minHeight:"2px"}},p)})})]})]})})};function jc({transcribeOptions:s,useWebSocket:e,onTranscribeOptionsChange:t,onUseWebSocketChange:n}){return o.jsxs("div",{className:"transcription-options-section space-y-1 pt-2 border-t border-border",children:[o.jsx("h3",{className:"text-[9px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcription Options"}),o.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[o.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"use-websocket",className:"text-[9px] font-semibold",children:"Use WebSocket Transcription"}),o.jsx(kt,{id:"use-websocket",checked:e,onCheckedChange:n,className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:e?"Real-time streaming with progress updates and word-by-word results":"Standard HTTP API with complete results"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsx(me,{className:"text-[9px] font-semibold",children:"Language"}),o.jsxs(Ct,{value:s.language??"auto",onValueChange:r=>t({...s,language:r}),children:[o.jsx(mt,{className:"h-7 text-[9px]",children:o.jsx(Rt,{placeholder:"Select language"})}),o.jsxs(gt,{children:[o.jsx(Ne,{value:"auto",children:"Auto Detect"}),o.jsx(Ne,{value:"en",children:"English"}),o.jsx(Ne,{value:"vi",children:"Vietnamese"}),o.jsx(Ne,{value:"es",children:"Spanish"}),o.jsx(Ne,{value:"fr",children:"French"}),o.jsx(Ne,{value:"de",children:"German"}),o.jsx(Ne,{value:"pt",children:"Portuguese"}),o.jsx(Ne,{value:"ru",children:"Russian"}),o.jsx(Ne,{value:"ja",children:"Japanese"}),o.jsx(Ne,{value:"zh",children:"Chinese"}),o.jsx(Ne,{value:"ko",children:"Korean"}),o.jsx(Ne,{value:"it",children:"Italian"}),o.jsx(Ne,{value:"nl",children:"Dutch"})]})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Transcription language"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsx(me,{className:"text-[9px] font-semibold",children:"Model"}),o.jsxs(Ct,{value:s.model??po[0],onValueChange:r=>t({...s,model:r}),children:[o.jsx(mt,{className:"h-7 text-[9px]",children:o.jsx(Rt,{placeholder:"Select model"})}),o.jsx(gt,{children:po.map(r=>o.jsx(Ne,{value:r,children:r},r))})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Whisper model"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"translate-english",className:"text-[9px] font-semibold",children:"Translate"}),o.jsx(kt,{id:"translate-english",checked:s.translate??!1,onCheckedChange:r=>t({...s,translate:r}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Translate to English"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"auto-detect-lang",className:"text-[9px] font-semibold",children:"Auto-Detect"}),o.jsx(kt,{id:"auto-detect-lang",checked:s.auto_detect_language??!1,onCheckedChange:r=>t({...s,auto_detect_language:r}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto language detection"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"no-timestamps",className:"text-[9px] font-semibold",children:"No Timestamps"}),o.jsx(kt,{id:"no-timestamps",checked:s.no_timestamps!==!1,onCheckedChange:r=>t({...s,no_timestamps:r}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Remove timestamps"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"no-prints",className:"text-[9px] font-semibold",children:"Quiet Mode"}),o.jsx(kt,{id:"no-prints",checked:s.no_prints!==!1,onCheckedChange:r=>t({...s,no_prints:r}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Suppress verbose output"})]})]})]})}const dn="audio-panel-selected-preset";function Yf({config:s,onConfigChange:e}){const[t,n]=h.useState([]),[r,a]=h.useState(!1),[i,c]=h.useState(""),[l,d]=h.useState(!1),[p,u]=h.useState("");h.useEffect(()=>{const v=on();n(v);let b=localStorage.getItem(dn);b||(b="default",localStorage.setItem(dn,b)),u(b)},[]);const f=v=>{u(v),localStorage.setItem(dn,v);const b=yn[v];if(b){const S=Ln(b.config);e(S);return}const j=t.find(S=>S.id===v);if(j){const S=Ln(j.config);e(S)}},m=()=>{if(!i.trim()){alert("Please enter a preset name");return}const v=Gf(i.trim(),"Custom configuration",s);n([...t,v]),c(""),a(!1)},g=()=>{c(""),a(!1)},x=v=>{const b=qf(v,s);b&&(n(t.map(j=>j.id===v?b:j)),d(!0))},y=v=>{Vf(v),n(t.filter(b=>b.id!==v)),p===v&&(u(""),localStorage.removeItem(dn))},w=()=>{const v=yn[p];if(v)return v.name;const b=t.find(j=>j.id===p);return(b==null?void 0:b.name)||""};return o.jsxs("div",{className:"config-view space-y-2 text-[10px]",children:[o.jsxs("div",{className:"preset-selector space-y-1",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{className:"text-[9px] font-semibold",children:"Configuration Preset"}),!r&&o.jsx(se,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>a(!0),title:"Save current configuration as preset",children:o.jsx(gn,{className:"h-3 w-3"})})]}),r?o.jsxs("div",{className:"flex gap-1",children:[o.jsx(_e,{placeholder:"Enter preset name...",value:i,onChange:v=>c(v.target.value),onKeyDown:v=>{v.key==="Enter"&&m(),v.key==="Escape"&&g()},className:"h-8 text-[9px] flex-1",autoFocus:!0}),o.jsx(se,{onClick:m,size:"sm",className:"h-8 px-2",title:"Save preset",children:o.jsx(gn,{className:"h-3 w-3"})}),o.jsx(se,{onClick:g,size:"sm",variant:"ghost",className:"h-8 px-2",title:"Cancel",children:"âœ•"})]}):o.jsxs(Ct,{value:p,onValueChange:f,open:l,onOpenChange:d,children:[o.jsx(mt,{className:"h-8 text-[9px]",children:o.jsx(Rt,{placeholder:"Select a preset...",children:p&&o.jsx("span",{className:"font-medium",children:w()})})}),o.jsxs(gt,{children:[Object.entries(yn).map(([v,b])=>o.jsxs(Ne,{value:v,children:[o.jsx("span",{className:"font-medium",children:b.name}),o.jsx("span",{className:"text-[8px] text-muted-foreground ml-2",children:b.description})]},v)),t.map(v=>o.jsx(Ne,{value:v.id,children:o.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[o.jsxs("div",{className:"flex flex-col items-start flex-1 min-w-0",children:[o.jsx("span",{className:"font-medium",children:v.name}),o.jsx("span",{className:"text-[8px] text-muted-foreground",children:v.description})]}),o.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[o.jsx(se,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:b=>{b.preventDefault(),b.stopPropagation(),x(v.id)},onClick:b=>{b.preventDefault(),b.stopPropagation()},title:"Update preset with current settings",children:o.jsx(gn,{className:"h-3 w-3 text-blue-500"})}),o.jsx(se,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:b=>{b.preventDefault(),b.stopPropagation(),y(v.id)},onClick:b=>{b.preventDefault(),b.stopPropagation()},title:"Delete preset",children:o.jsx(At,{className:"h-3 w-3 text-red-500"})})]})]})},v.id))]})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:r?"Enter a name for the current configuration":"Quick apply preset configurations"})]}),o.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"auto-transcription",className:"text-[9px] font-semibold",children:"Auto-Transcribe"}),o.jsx(kt,{id:"auto-transcription",checked:s.enableAutoTranscription,onCheckedChange:v=>e({enableAutoTranscription:v}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-transcribe chunks"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Chunk: ",s.minChunkDuration,"ms"]}),o.jsx(Mt,{min:500,max:5e3,step:500,value:[s.minChunkDuration],onValueChange:v=>e({minChunkDuration:v[0]}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min chunk duration"})]}),o.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[o.jsx(me,{className:"text-[9px] font-semibold",children:"Chunking Mode"}),o.jsxs(Ct,{value:s.chunkingMode,onValueChange:v=>e({chunkingMode:v}),children:[o.jsx(mt,{className:"h-7 text-[9px]",children:o.jsx(Rt,{})}),o.jsxs(gt,{children:[o.jsx(Ne,{value:"time",children:"Time-based"}),o.jsx(Ne,{value:"vad",children:"Voice Activity Detection (VAD)"}),o.jsx(Ne,{value:"silence-based",children:"Silence-based Splitting"})]})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:s.chunkingMode==="time"?"Fixed interval chunking for predictable real-time updates":s.chunkingMode==="vad"?"Speech-driven chunking for natural boundaries and better accuracy":"VAD recording with post-processing silence-based splits for precise segmentation"})]}),s.chunkingMode==="time"&&o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"auto-create-chunks",className:"text-[9px] font-semibold",children:"Auto-Create"}),o.jsx(kt,{id:"auto-create-chunks",checked:s.autoCreateChunks,onCheckedChange:v=>e({autoCreateChunks:v}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-create chunks"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Auto-Time: ",s.autoChunkCreationTime,"ms"]}),o.jsx(Mt,{min:500,max:5e3,step:500,value:[s.autoChunkCreationTime],onValueChange:v=>e({autoChunkCreationTime:v[0]}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-creation interval"})]})]}),(s.chunkingMode==="vad"||s.chunkingMode==="silence-based")&&o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Max Duration: ",s.vadMaxChunkDuration,"ms"]}),o.jsx(Mt,{min:3e3,max:3e4,step:1e3,value:[s.vadMaxChunkDuration],onValueChange:v=>e({vadMaxChunkDuration:v[0]}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Max VAD chunk duration (safety ceiling)"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Silence Timeout: ",s.vadSilenceTimeout,"ms"]}),o.jsx(Mt,{min:500,max:5e3,step:100,value:[s.vadSilenceTimeout],onValueChange:v=>e({vadSilenceTimeout:v[0]}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence duration to end chunk"})]})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"skip-last-chunk",className:"text-[9px] font-semibold",children:"Skip Last Chunk"}),o.jsx(kt,{id:"skip-last-chunk",checked:s.skipLastSessionChunk,onCheckedChange:v=>e({skipLastSessionChunk:v}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Skip last session chunk"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{htmlFor:"auto-stop-silence",className:"text-[9px] font-semibold",children:"Auto-Stop"}),o.jsx(kt,{id:"auto-stop-silence",checked:s.autoStopOnSilence,onCheckedChange:v=>e({autoStopOnSilence:v}),className:"scale-75"})]}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Stop on silence"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Silence: ",Math.round(s.silenceDetectionConfig.silenceThreshold*100),"%"]}),o.jsx(Mt,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.silenceThreshold],onValueChange:v=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,silenceThreshold:v[0]}}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence threshold"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Silent: ",s.silenceDetectionConfig.minSilenceDuration,"ms"]}),o.jsx(Mt,{min:100,max:5e3,step:100,value:[s.silenceDetectionConfig.minSilenceDuration],onValueChange:v=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minSilenceDuration:v[0]}}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min silence duration"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Active: ",s.silenceDetectionConfig.minActiveDuration,"ms"]}),o.jsx(Mt,{min:100,max:3e3,step:100,value:[s.silenceDetectionConfig.minActiveDuration],onValueChange:v=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minActiveDuration:v[0]}}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min active duration"})]}),o.jsxs("div",{className:"config-item space-y-0.5",children:[o.jsxs(me,{className:"text-[9px] font-semibold",children:["Activation: ",Math.round(s.silenceDetectionConfig.activationThreshold*100),"%"]}),o.jsx(Mt,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.activationThreshold],onValueChange:v=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,activationThreshold:v[0]}}),className:"w-full"}),o.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Peak level threshold (filters body noise)"})]})]}),o.jsx(jc,{transcribeOptions:s.transcribeOptions,useWebSocket:s.useWebSocket,onTranscribeOptionsChange:v=>e({transcribeOptions:v}),onUseWebSocketChange:v=>e({useWebSocket:v})})]})}function Ds({audioBlob:s,isPlaying:e=!0,className:t="",height:n=80,barWidth:r=2,barGap:a=1,barColor:i="#94a3b8",progressColor:c="#3b82f6"}){const l=h.useRef(null),[d,p]=h.useState([]),[u,f]=h.useState(!1),[m,g]=h.useState({width:0,height:0});return h.useEffect(()=>{if(!s)return;let x=!1;return f(!0),(async()=>{try{const w=await s.arrayBuffer(),v=new AudioContext,b=await v.decodeAudioData(w);if(x){await v.close();return}const j=b.getChannelData(0),S=100,C=Math.floor(j.length/S),N=[];for(let P=0;P<S;P++){const W=C*P;let R=0;for(let L=0;L<C;L++){const T=j[W+L];R+=T*T}const F=Math.sqrt(R/C);N.push(F)}const A=Math.max(...N),I=1.5,k=N.map(P=>Math.min(1,P/A*I));x||p(k),await v.close()}catch(w){console.error("Failed to generate waveform:",w)}finally{x||f(!1)}})(),()=>{x=!0}},[s]),h.useEffect(()=>{if(u)return;const x=l.current;if(!x||d.length===0)return;const y=x.getContext("2d");if(!y)return;const w=x.width,v=x.height;if(w===0||v===0)return;const b=r+a,j=Math.min(d.length,Math.floor(w/b));y.clearRect(0,0,w,v);for(let S=0;S<j;S++){const C=Math.floor(S/j*d.length),N=d[C],A=Math.max(3,v*.05),I=v*.95,k=Math.max(A,N*I),P=S*b,W=(v-k)/2;y.fillStyle=e?c:i,y.fillRect(P,W,r,k)}},[d,e,r,a,i,c,m,u]),h.useEffect(()=>{const x=l.current;if(!x)return;const y=()=>{const w=x.parentElement;if(!w)return;const v=w.getBoundingClientRect();v.width>0&&v.height>0&&(x.width!==v.width||x.height!==v.height)&&(x.width=v.width,x.height=v.height,g({width:v.width,height:v.height}))};return y(),d.length>0&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{y()})}),window.addEventListener("resize",y),()=>{window.removeEventListener("resize",y)}},[n,d.length]),u?o.jsx("div",{className:`waveform-loading flex items-center justify-center ${t}`,style:{height:n},children:o.jsx("div",{className:"text-xs text-gray-400",children:"Generating waveform..."})}):o.jsx("div",{className:`waveform-container ${t}`,style:{height:n},children:o.jsx("canvas",{ref:l,className:"waveform-visualizer w-full h-full",style:{display:"block"}})})}function Xf({chunk:s,isPlaying:e,onPlay:t,onPause:n,onDownload:r,onDelete:a,onTranscribe:i,variant:c="default",showTranscribe:l=!1}){const d=c==="error"?"hover:bg-red-100":"hover:bg-slate-200";return o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(se,{size:"sm",variant:"ghost",onClick:e?n:t,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:e?o.jsx(Mu,{className:"w-3.5 h-3.5"}):o.jsx(Pi,{className:"w-3.5 h-3.5"})}),o.jsx(se,{size:"sm",variant:"ghost",onClick:r,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:o.jsx(la,{className:"w-3.5 h-3.5"})}),l&&i&&o.jsx(se,{size:"sm",variant:"ghost",onClick:i,className:`h-7 w-7 p-0 text-blue-600 hover:text-blue-700 ${c==="error"?"hover:bg-red-100":"hover:bg-blue-50"}`,disabled:!s.blob||s.transcriptionStatus==="processing",title:"Transcribe audio",children:o.jsx(En,{className:"w-3.5 h-3.5"})}),a&&o.jsx(se,{size:"sm",variant:"ghost",onClick:a,className:`h-7 w-7 p-0 text-red-600 hover:text-red-700 ${c==="error"?"hover:bg-red-100":"hover:bg-red-50"}`,children:o.jsx(At,{className:"w-3.5 h-3.5"})})]})}function Qf({duration:s,variant:e="default"}){const t=r=>{const a=r/1e3,i=Math.floor(a),c=Math.floor((a-i)*100);return c>0?`${i}.${c.toString().padStart(2,"0")}s`:`${i}s`},n={completed:"text-xs text-green-600 border-green-600 bg-green-50",processing:"text-xs text-blue-600 border-blue-600 bg-blue-50",failed:"text-xs text-red-600 border-red-600 bg-red-50",pending:"text-xs text-gray-600 border-gray-400 bg-gray-50",default:"text-xs text-gray-600 border-gray-400 bg-gray-50"};return o.jsxs(ot,{variant:"outline",className:n[e],children:[o.jsx(Oi,{className:"w-3 h-3 mr-1"}),t(s)]})}const Zf={completed:{className:"bg-card",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>o.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&o.jsx(Ds,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),o.jsx("div",{className:"text-sm leading-relaxed font-medium",children:s.transcription})]})},processing:{className:"bg-blue-50 border-blue-200",badgeVariant:"processing",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>o.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&o.jsx(Ds,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(tr,{className:"w-4 h-4 text-blue-600 animate-spin"}),o.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Transcribing audio..."})]})]})},failed:{className:"bg-red-50 border-red-200",badgeVariant:"failed",controlsVariant:"error",showTranscribe:!0,renderContent:(s,e,t)=>o.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&o.jsx(Ds,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(Ai,{className:"w-4 h-4 text-red-600"}),o.jsxs("span",{className:"text-sm font-medium text-red-700",children:["Transcription Failed",s.transcriptionError&&o.jsxs("span",{className:"text-xs font-normal ml-1",children:["(",s.transcriptionError,")"]})]})]})]})},pending:{className:"bg-gray-50 border-gray-200",badgeVariant:"pending",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>o.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&o.jsx(Ds,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(Oi,{className:"w-4 h-4 text-gray-500"}),o.jsx("span",{className:"text-sm text-gray-600",children:"Waiting to transcribe..."})]})]})},none:{className:"bg-gray-50 border-gray-200",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>o.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&o.jsx(Ds,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(ca,{className:"w-4 h-4 text-gray-500"}),o.jsx("span",{className:"text-sm text-gray-600",children:"No transcription available"})]})]})}};function em({chunk:s,isPlaying:e,showWaveform:t,onPlay:n,onPause:r,onDownload:a,onDelete:i,onTranscribe:c}){const d=s.transcription?"completed":s.transcriptionStatus==="processing"?"processing":s.transcriptionStatus==="failed"?"failed":s.transcriptionStatus==="pending"?"pending":"none",p=Zf[d];return o.jsx(nn,{className:"chunk-item shadow-sm",children:o.jsx(rn,{className:"p-0",children:o.jsxs("div",{className:`flex flex-col border rounded-md py-2 px-2 gap-2 ${p.className}`,children:[p.renderContent(s,e,t),o.jsxs("div",{className:"flex justify-between items-center",children:[s.duration&&o.jsx(Qf,{duration:s.duration,variant:p.badgeVariant}),o.jsx(Xf,{chunk:s,isPlaying:e,onPlay:n,onPause:r,onDownload:a,onDelete:i,onTranscribe:c,variant:p.controlsVariant,showTranscribe:p.showTranscribe})]})]})})})}function Nc({chunks:s,className:e="",onChunkDelete:t,onChunkTranscribe:n,onTranscribeAll:r,onClearAll:a}){const[i,c]=h.useState(null),[l,d]=h.useState(!1),[p,u]=h.useState({language:"vi",model:"ggml-distil-large-v3",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1}),[f,m]=h.useState(!1),g=h.useRef(null),x=h.useRef(null),y=h.useCallback(I=>{if(!I.blob)return;g.current&&(g.current.pause(),x.current&&URL.revokeObjectURL(x.current));const k=new Audio;g.current=k;const P=URL.createObjectURL(I.blob);x.current=P,k.src=P,k.onplay=()=>{c(I.id)},k.onpause=()=>{c(null)},k.onended=()=>{c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},k.onerror=W=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Audio playback error:",W),c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},k.play().catch(W=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Failed to play audio:",W),c(null)})},[]),w=h.useCallback(()=>{g.current&&g.current.pause()},[]),v=h.useCallback(I=>{if(!I.blob)return;const k=URL.createObjectURL(I.blob),P=document.createElement("a");P.href=k,P.download=`${I.name}.wav`,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(k)},[]),b=h.useCallback(async I=>{i===I&&g.current&&(g.current.pause(),c(null)),await(t==null?void 0:t(I))},[i,t]),j=h.useCallback(async I=>{await(n==null?void 0:n(I))},[n]),S=h.useCallback(async()=>{g.current&&(g.current.pause(),c(null)),await(a==null?void 0:a())},[a]),C=h.useCallback(async()=>{await(r==null?void 0:r(p))},[r,p]);h.useEffect(()=>()=>{g.current&&g.current.pause(),x.current&&URL.revokeObjectURL(x.current)},[]);const N=s.reduce((I,k)=>I+(k.duration??0),0),A=s.reduce((I,k)=>I+(k.size??0),0);return o.jsx("div",{className:`chunks-panel flex flex-col h-full ${e}`,children:o.jsxs(nn,{className:"flex-1 flex flex-col rounded-none",children:[o.jsxs(xa,{className:"pb-4",children:[o.jsxs(va,{className:"flex items-center justify-between",children:[o.jsx("span",{children:"Audio Chunks"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(ot,{variant:"outline",children:s.length}),s.length>0&&r&&o.jsx(en,{variant:"ghost",size:"sm",buttonClassName:"h-6 w-6 p-0",contentClassName:"w-80",title:"Transcription Options",align:"end",storageKey:"chunks-panel-transcription-options",children:o.jsx("div",{className:"chunk-options-config",children:o.jsx(rr,{label:"Transcribe All",onAction:C,size:"sm",className:"w-full",tooltipText:"Click to transcribe all chunks, or click gear for options",popoverContent:o.jsx(jc,{transcribeOptions:p,useWebSocket:f,onTranscribeOptionsChange:u,onUseWebSocketChange:m})})})}),s.length>0&&o.jsx(se,{variant:"ghost",size:"sm",onClick:()=>d(!l),className:`h-6 px-2 text-xs ${l?"bg-blue-50 text-blue-600":"text-gray-600"}`,title:l?"Hide waveforms":"Show waveforms",children:o.jsx(_u,{className:"w-3 h-3"})}),s.length>0&&a&&o.jsx(se,{variant:"ghost",size:"sm",onClick:S,className:"h-6 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",title:"Clear all chunks",children:o.jsx(At,{className:"w-3 h-3"})})]})]}),s.length>0&&o.jsxs("div",{className:"stats-summary text-xs text-gray-600 space-y-1",children:[o.jsxs("div",{className:"flex justify-between",children:[o.jsx("span",{children:"Total Duration:"}),o.jsxs("span",{children:[Math.floor(N/1e3),"s"]})]}),o.jsxs("div",{className:"flex justify-between",children:[o.jsx("span",{children:"Total Size:"}),o.jsxs("span",{children:[(A/1024).toFixed(1)," KB"]})]})]})]}),o.jsx(rn,{className:"flex-1 overflow-hidden p-4",children:s.length===0?o.jsxs("div",{className:"empty-state flex flex-col items-center justify-center h-full text-center text-gray-500",children:[o.jsx("div",{className:"mb-2",children:"ðŸŽ¤"}),o.jsx("p",{className:"text-sm",children:"No chunks recorded yet"}),o.jsx("p",{className:"text-xs mt-1",children:"Start recording and speak to create chunks"})]}):o.jsx("div",{className:"chunks-list overflow-y-auto h-full space-y-2 pr-2",children:s.slice().reverse().map(I=>o.jsx(em,{chunk:I,isPlaying:i===I.id,showWaveform:l,onPlay:()=>y(I),onPause:w,onDownload:()=>v(I),onDelete:()=>void b(I.id),onTranscribe:n?()=>void j(I.id):void 0},I.id))})})]})})}const ho="audio-panel-config";function tm({sessionName:s="audio-panel-session",enableAutoPersist:e=!0,loadPersistedChunks:t=!1,initialConfig:n,autoStart:r=!1,startTrigger:a,stopTrigger:i,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onSilenceDetected:p,onClearAndRecord:u,onWordReceived:f,onTranscriptionProgress:m,onRecordingStateChange:g,className:x=""}){var z,pe;const[y,w]=h.useState(Array(32).fill(0)),[v,b]=h.useState(0),S=(()=>{try{const X=localStorage.getItem(ho);if(X)return JSON.parse(X)}catch(X){console.error("Failed to load persisted config:",X)}return{}})(),[C,N]=h.useState(()=>{let X={...Bs,...S},ce=localStorage.getItem("audio-panel-selected-preset");if(ce||(ce="default",localStorage.setItem("audio-panel-selected-preset",ce)),ce)try{const ve=yn[ce];if(ve)X=Ln(ve.config);else{const Ae=on().find(Oe=>Oe.id===ce);Ae&&(X=Ln(Ae.config))}}catch(ve){console.error("Failed to apply selected preset:",ve)}return{...X,...n}}),A=h.useRef(null),I=h.useRef(null),k=h.useRef(null),P=h.useRef(null),W=h.useRef(!1),R=h.useCallback(X=>{console.error("ðŸŽ¤ Recorder error:",X)},[]),F=h.useRef(C.autoStopOnSilence),L=h.useRef(p),T=h.useRef(null),M=h.useRef(null),D=h.useRef(null),H=h.useRef(!1),Y=h.useRef(!0),O=h.useRef(0),q=h.useRef(null),K=h.useRef(0),G=h.useRef(C.chunkingMode);h.useEffect(()=>{F.current=C.autoStopOnSilence},[C.autoStopOnSilence]),h.useEffect(()=>{G.current=C.chunkingMode},[C.chunkingMode]),h.useEffect(()=>{L.current=p},[p]),h.useEffect(()=>{n!=null&&n.transcribeOptions&&N(X=>({...X,transcribeOptions:{...X.transcribeOptions,...n.transcribeOptions}}))},[(z=n==null?void 0:n.transcribeOptions)==null?void 0:z.language,(pe=n==null?void 0:n.transcribeOptions)==null?void 0:pe.model]);const{state:U,actions:Z,startChunk:ue,stopChunk:we,discardCurrentChunk:ae,deleteChunk:Te,transcribeChunk:ke,updateChunkTranscription:Ee,reconnectWebSocket:$e}=zf({sessionName:s,enableAutoPersist:e,enableAutoTranscription:C.chunkingMode==="silence-based"?!1:C.enableAutoTranscription,minChunkDuration:C.minChunkDuration,loadPersistedChunks:t,skipLastSessionChunk:C.skipLastSessionChunk,transcribeOptions:C.transcribeOptions,useWebSocket:C.useWebSocket,onWordReceived:f,onTranscriptionProgress:m,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onError:R}),ge=h.useCallback(X=>{if(X.length===0)return"";if(X.length===1)return X[0].trim();let ce=X[0].trim();for(let ve=1;ve<X.length;ve++){let ye=X[ve].trim();if(!ye)continue;!/[.!?â€¦]$/.test(ce)&&ye.length>0&&(ye=ye.charAt(0).toLowerCase()+ye.slice(1)),ce=`${ce} ${ye}`}return ce},[]),ie=h.useCallback(async X=>{if(C.chunkingMode==="silence-based"&&X.blob){console.log(`ðŸŽ¤ Processing chunk for silence-based splitting: ${X.name} (${X.blob.size} bytes)`);try{const ce=await X.blob.arrayBuffer(),ye=await new AudioContext().decodeAudioData(ce);console.log(`ðŸŽ¤ AudioBuffer duration: ${ye.duration.toFixed(2)}s`);const Ae=On.DEFAULT;console.log("ðŸŽ¤ Using DEFAULT preset:",Ae);const De=await new bc(Ae).chunkAudio(ye);if(console.log(`ðŸŽ¤ Silence-based split: ${De.length} chunks detected`),console.log("ðŸŽ¤ Chunk details:",De.map((Ue,Be)=>({index:Be+1,startTime:Ue.startTime.toFixed(2)+"s",endTime:Ue.endTime.toFixed(2)+"s",duration:Ue.duration.toFixed(2)+"s",blobSize:Ue.blob.size+" bytes"}))),C.enableAutoTranscription&&De.length>0){const Ue=[];for(let et=0;et<De.length;et++){const pt=De[et],Wt=`${X.name}-split-${et+1}`;console.log(`ðŸŽ¤ Transcribing split ${et+1}/${De.length}: ${Wt} (${pt.duration.toFixed(2)}s)`);try{const Dt=new File([pt.blob],`${Wt}.wav`,{type:"audio/wav"}),Xe=await wc.transcribeAudio(Dt,C.transcribeOptions);Ue.push(Xe.transcription),console.log(`ðŸŽ¤ Split ${et+1} transcribed: "${Xe.transcription}"`);const it=ge(Ue);it&&(await Ee(X.id,it),console.log(`ðŸŽ¤ Progressive update: "${it}"`))}catch(Dt){console.error(`ðŸŽ¤ Failed to transcribe split ${et+1}:`,Dt),Ue.push(`[Error: ${Dt instanceof Error?Dt.message:"Unknown error"}]`)}}const Be=ge(Ue);console.log(`ðŸŽ¤ Final transcription (${De.length} splits): "${Be}"`)}}catch(ce){console.error("ðŸŽ¤ Failed to split chunk by silence:",ce)}}},[C,Ee,ge]);h.useEffect(()=>{if(C.chunkingMode==="silence-based"&&U.chunks.length>0){const X=U.chunks[U.chunks.length-1];!X.transcription&&!X.transcriptionStatus&&ie(X)}},[U.chunks,C.chunkingMode,ie]);const re=Kf(C.silenceDetectionConfig),te=h.useRef(re);h.useEffect(()=>{te.current=re},[re]);const $=Hf({config:C.chunkingMode==="silence-based"?{...C,vadSilenceTimeout:100}:C,isRecording:U.isRecording,isChunkRecording:U.isChunkRecording,callbacks:{startChunk:ue,stopChunk:we,discardCurrentChunk:ae},cumulativeActiveTimeRef:O,peakAudioLevelRef:K}),V=h.useRef($);h.useEffect(()=>{V.current=$},[$]);const ee=h.useCallback(X=>{var ce;N(ve=>{const ye={...ve,...X};return X.silenceDetectionConfig&&(ye.silenceDetectionConfig={...ve.silenceDetectionConfig,...X.silenceDetectionConfig}),X.transcribeOptions&&(ye.transcribeOptions={...ve.transcribeOptions,...X.transcribeOptions}),ye}),((ce=X.silenceDetectionConfig)==null?void 0:ce.silenceThreshold)!==void 0&&re.updateThreshold(X.silenceDetectionConfig.silenceThreshold)},[re]);h.useEffect(()=>{try{localStorage.setItem(ho,JSON.stringify(C))}catch(X){console.error("Failed to persist config:",X)}},[C]),h.useEffect(()=>{D.current=ue},[ue]),h.useEffect(()=>{T.current=we},[we]),h.useEffect(()=>{M.current=ae},[ae]);const le=h.useRef(U.isRecording);h.useEffect(()=>{le.current=U.isRecording},[U.isRecording]),h.useEffect(()=>{H.current=U.isChunkRecording},[U.isChunkRecording]);const ne=h.useCallback(async()=>{try{const X=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),ce=new AudioContext,ve=ce.createAnalyser();ve.fftSize=256,ve.smoothingTimeConstant=.8,ce.createMediaStreamSource(X).connect(ve),A.current=ce,I.current=ve;const Ae=()=>{var Wt,Dt;if(!I.current)return;const Oe=I.current.frequencyBinCount,De=new Uint8Array(Oe);I.current.getByteFrequencyData(De);const Ue=32,Be=Math.floor(Oe/Ue),et=[];for(let Xe=0;Xe<Ue;Xe++){let it=0;for(let ht=0;ht<Be;ht++)it+=De[Xe*Be+ht];const vt=it/Be/255;et.push(vt)}if(w(et),te.current.processAudioData(et),H.current){const Xe=te.current.state.currentLevel;Xe>K.current&&(K.current=Xe)}if(G.current==="vad"||G.current==="silence-based"){const Xe=te.current.state.isSilent,it=Y.current;V.current.processVADAudio(Xe,it)}const pt=Date.now();if(H.current)if(q.current===null)q.current=pt;else{const Xe=pt-q.current;Y.current||(O.current+=Xe),q.current=pt}else q.current=null,O.current=0;if(F.current&&U.isChunkRecording){const Xe=te.current.state.isSilent,it=W.current;!it&&!Xe?W.current=!0:it&&Xe&&((Wt=L.current)==null||Wt.call(L),(Dt=T.current)==null||Dt.call(T),W.current=!1)}Y.current=te.current.state.isSilent,k.current=requestAnimationFrame(Ae)};Ae()}catch(X){console.error("ðŸŽ¤ âŒ Failed to setup audio analysis:",X)}},[]),de=h.useCallback(()=>{k.current&&(cancelAnimationFrame(k.current),k.current=null),A.current&&(A.current.close(),A.current=null),I.current=null,w(Array(32).fill(0)),te.current.reset(),V.current.resetVADState(),W.current=!1},[]),fe=h.useCallback(async()=>{if(U.isRecording){if(U.isChunkRecording){const X=O.current,ce=C.silenceDetectionConfig.minActiveDuration,ve=K.current,ye=C.silenceDetectionConfig.activationThreshold;X>=ce&&ve>=ye?await we():ae()}Z.stopRecording(),le.current=!1,de(),P.current=null}else await Z.startRecording(),le.current=!0,await ne(),P.current=Date.now(),C.chunkingMode==="time"&&(await ue(),W.current=!1)},[U.isRecording,U.isChunkRecording,Z,ne,de,C.chunkingMode,C.silenceDetectionConfig.minActiveDuration,C.silenceDetectionConfig.activationThreshold,ue,we,ae]);h.useEffect(()=>{if(!U.isRecording)return;const X=setInterval(()=>{P.current&&b(Date.now()-P.current)},100);return()=>clearInterval(X)},[U.isRecording]),h.useEffect(()=>()=>{de()},[de]);const xe=h.useRef(null);h.useEffect(()=>{xe.current!==null&&xe.current!==U.isRecording&&(g==null||g(U.isRecording)),xe.current=U.isRecording},[U.isRecording,g]),h.useEffect(()=>{r&&!U.isRecording&&fe()},[r]),h.useEffect(()=>{a!==void 0&&a>0&&!U.isRecording&&fe()},[a]),h.useEffect(()=>{i!==void 0&&i>0&&U.isRecording&&fe()},[i]);const Ce=h.useCallback(async X=>{const ce=U.chunks.find(ve=>ve.id===X);if(!(ce!=null&&ce.blob)){console.error("ðŸŽ¤ âŒ Cannot transcribe chunk: blob not found",X);return}await ke(X,ce.blob,ce.name,C.transcribeOptions)},[U.chunks,ke,C]),Se=h.useCallback(async X=>{await Te(X),d==null||d(X)},[Te,d]),_=h.useCallback(async()=>{const X=U.chunks.map(ce=>ce.id);await Promise.all(X.map(ce=>Se(ce)))},[U.chunks,Se]),E=h.useCallback(async()=>{await _(),u==null||u(),await $e(),U.isRecording||await fe()},[_,u,$e,U.isRecording,fe]);return h.useEffect(()=>{if(!U.isRecording||C.chunkingMode!=="time")return;const X=setInterval(()=>{var Oe,De;const ce=O.current,ve=C.silenceDetectionConfig.minActiveDuration,ye=K.current,Ae=C.silenceDetectionConfig.activationThreshold;if(ce<ve||ye<Ae){(Oe=M.current)==null||Oe.call(M),setTimeout(()=>{var Ue;(Ue=D.current)==null||Ue.call(D),O.current=0,K.current=0},50);return}(De=T.current)==null||De.call(T),setTimeout(()=>{var Ue;(Ue=D.current)==null||Ue.call(D),O.current=0,K.current=0},50)},C.autoChunkCreationTime);return()=>{clearInterval(X)}},[U.isRecording,C.autoChunkCreationTime,C.silenceDetectionConfig.minActiveDuration,C.silenceDetectionConfig.activationThreshold,C.chunkingMode]),o.jsx("div",{className:`audio-panel ${x}`,children:o.jsx(nn,{children:o.jsxs(rn,{className:"p-3 space-y-1",children:[o.jsxs("div",{className:"controls-section flex justify-between items-center gap-1",children:[o.jsx(Ef,{onClick:fe,label:U.isRecording?"Stop":"Record",icon:U.isRecording?zs:Qn,variant:U.isRecording?"destructive":"default",size:"sm",options:[{label:"Clear and Record",onClick:E}],showDropdown:!U.isRecording,className:"recording-toggle-group"}),o.jsxs(Ye,{children:[o.jsx(at,{asChild:!0,children:o.jsx(se,{variant:"secondary",size:"sm",children:o.jsx(Fu,{className:"w-3 h-3"})})}),o.jsx(Ge,{className:"w-80 p-3",align:"end",children:o.jsx(Yf,{config:C,onConfigChange:ee})})]})]}),o.jsx("div",{className:"visualizer-section",children:o.jsx(Jf,{audioData:y,silenceState:re.state,onThresholdChange:re.updateThreshold,hideSilenceControls:!0,duration:v})}),(C.chunkingMode==="vad"||C.chunkingMode==="silence-based")&&U.isRecording&&o.jsxs("div",{className:"vad-activity-indicator p-2 bg-slate-50 border border-slate-200 rounded-lg",children:[o.jsxs("div",{className:"flex items-center justify-between mb-1",children:[o.jsx("span",{className:"text-[9px] font-semibold text-slate-600",children:"VAD Activity"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsxs("span",{className:"text-[8px] text-slate-500",children:["Level: ",(re.state.currentLevel*100).toFixed(0),"%"]}),o.jsx("div",{className:`px-1.5 py-0.5 rounded text-[8px] font-medium ${re.state.isSilent?"bg-gray-100 text-gray-600":"bg-green-100 text-green-700"}`,children:re.state.isSilent?"ðŸ”‡ Silent":"ðŸŽ™ï¸ Active"})]})]}),o.jsxs("div",{className:"relative h-2 bg-slate-200 rounded-full overflow-hidden",children:[re.state.silenceThreshold>0&&o.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-400 z-10",style:{left:`${re.state.silenceThreshold*100}%`},title:`Threshold: ${(re.state.silenceThreshold*100).toFixed(0)}%`}),o.jsx("div",{className:`h-full transition-all duration-100 ${re.state.isSilent?"bg-gray-400":"bg-green-500"}`,style:{width:`${re.state.currentLevel*100}%`}})]}),U.isChunkRecording&&o.jsxs("div",{className:"mt-1 text-[8px] text-blue-600 flex items-center gap-1",children:[o.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-blue-600 rounded-full animate-pulse"}),"Recording chunk..."]})]}),U.error&&o.jsx("div",{className:"error-display p-1.5 bg-red-50 border border-red-200 rounded-lg",children:o.jsx("p",{className:"text-[10px] text-red-600",children:U.error})}),o.jsx(Nc,{chunks:U.chunks,onChunkDelete:Se,onChunkTranscribe:Ce,onClearAll:_})]})})})}const fo=s=>{let e;const t=new Set,n=(d,p)=>{const u=typeof d=="function"?d(e):d;if(!Object.is(u,e)){const f=e;e=p??(typeof u!="object"||u===null)?u:Object.assign({},e,u),t.forEach(m=>m(e,f))}},r=()=>e,c={setState:n,getState:r,getInitialState:()=>l,subscribe:d=>(t.add(d),()=>t.delete(d))},l=e=s(n,r,c);return c},Ec=(s=>s?fo(s):fo);var ya=(s=>(s.ADD="add",s.DRAW_ARROW="draw_arrow",s.DRAW="draw",s.SELECT="select",s.MOVE="move",s.ZOOM="zoom",s.WRITE="write",s.GRID="grid",s.VIM="vim",s))(ya||{}),Sn=(s=>(s.WRITE="write",s.AUDIO="write:audio",s))(Sn||{}),Cn=(s=>(s.DEFAULT="draw_arrow:default",s.STAY="draw_arrow:stay",s))(Cn||{}),kc=(s=>(s.NONE="none",s.STUDY="study",s.PAIRING="pairing",s))(kc||{}),He=(s=>(s.RECT="RECT",s.TABLE="TABLE",s.TEXT="TEXT",s.ARROW="ARROW",s.TEXTCARD="TEXTCARD",s.WORKFLOW_ORCHESTRATION="WORKFLOW_ORCHESTRATION",s.WORKFLOW_SOURCE="WORKFLOW_SOURCE",s.WORKFLOW_DEFINITION="WORKFLOW_DEFINITION",s.WORKFLOW_STEP="WORKFLOW_STEP",s.OCR="OCR",s.IMAGE="IMAGE",s.GROUP="GROUP",s.VOCABULARY="VOCABULARY",s.DRAWING="DRAWING",s))(He||{});const gC=["content","title","x","y","width","height","createdAt","updatedAt","id","type"],xC={content:"Content",title:"Title",x:"X Position",y:"Y Position",width:"Width",height:"Height",createdAt:"Created At",updatedAt:"Updated At",id:"ID",type:"Type"},vC=["title","content"],wC={title:"Title",content:"Content"};let Pe=(s=21)=>crypto.getRandomValues(new Uint8Array(s)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class un{static loadPreset(e){const t=new Map,n=this.convertStepsToRows(e.steps,t),r=t.get(1)||"row_1";return{id:`wf-preset-${e.id}`,x:0,y:0,width:400,height:300,type:He.RECT,title:e.name,content:e.description,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:n},inputHandles:[{id:`input_${r}`,name:"All Nodes",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Result",type:"output",dataType:"any"}]}}}static convertStepsToRows(e,t,n){return e.map(r=>{const a=Pe();t.set(r.order,a);const i={id:a,label:r.label,order:r.order,stepType:r.type};if(r.config){const c=JSON.parse(JSON.stringify(r.config));c.dataSource==="row_1"&&(c.dataSource=t.get(1)||"row_1"),i.config=c}return r.children&&r.children.length>0&&(i.children=this.convertStepsToRows(r.children,t,r.order)),i})}}const sm=8,nm=0,rm=-5,bC="__paste-create__",wr=4,rt={DEFAULT_NODE_WIDTH:120,DEFAULT_NODE_HEIGHT:31,VOCAB_NODE_MIN_WIDTH:140,FONT_SIZE_DEFAULT:16,FONT_SIZE_SMALL:14,FONT_SIZE_XS:13,FONT_SIZE_XXS:12,FONT_SIZE_MINI:10,LINE_HEIGHT:24,LINE_HEIGHT_CONFIG:25,LINE_HEIGHT_FIND:20,DEFAULT_PADDING:wr,NODE_X_PADDING:wr*2,NODE_Y_PADDING:wr*2,nodeSpacing:20,NODE_ALIGNMENT_PADDING:16,writeMode:{yRatio:.67},TEXT_MODE_ADJUST_Y:25,NEW_NODE_SEGMENT_SPACING:15,MIN_RESIZE_WIDTH:100,MIN_RESIZE_HEIGHT:100,HANDLE_OFFSET:sm/2,HANDLE_BG_COLOR:"bg-primary",HANDLE_BORDER_COLOR:"border-primary-foreground",SELECTION_RING_COLOR:"ring-ring",SELECTED_BORDER_COLOR:"border-ring",CUSTOM_CHARACTERS:["?","!"],chatInput:{BOTTOM_VISIBLE:70,BOTTOM_HIDDEN:30,NODE_GAP_TOP:100,NODE_GAP_LEFT:20,NODE_GAP_RIGHT:40,NODE_SCROLL_GAP:20},ARRANGE_NODE_GAP:60,ARRANGE_GRID_COLUMNS:3,PRESET_STEP_DELAY_MS:200},am={textNodeXPadding:rt.NODE_X_PADDING*4},om="capitalize",im="Capitalize",cm="Capitalize first letter of text",lm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Capitalize",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.capitalize()}}"}]}}]}],dm={id:om,name:im,description:cm,steps:lm},um="trim-symbols-light",pm="Trim Symbols (Light)",hm="Remove punctuation and special characters from start/end of text",fm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsLight()}}"}]}}]}],mm={id:um,name:pm,description:hm,steps:fm},gm="trim-symbols-strict",xm="Trim Symbols (Strict)",vm="Remove all non-alphanumeric characters from start/end of text",wm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsStrict()}}"}]}}]}],bm={id:gm,name:xm,description:vm,steps:wm},ym="add-full-stop",Sm="Add Full Stop",Cm="Add a full stop (.) at the end of text",jm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Add Full Stop",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title}}."}]}}]}],Nm={id:ym,name:Sm,description:Cm,steps:jm};function Ic(){const s="workflow-templates-project",e="workflow-templates-workspace",t=un.loadPreset(dm),n=un.loadPreset(mm),r=un.loadPreset(bm),a=un.loadPreset(Nm),i="canvas-workflow-presets",c={id:i,name:"ðŸŽ¨ Workflow Presets",createdAt:Date.now(),lastModified:Date.now(),coreState:{nodes:[{id:Pe(8),x:50,y:50,type:He.TEXT,content:`ðŸŽ¨ Workflow Presets Library

Reusable workflow templates powered by JSON configuration.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How to Use:
1. Copy a preset workflow node below (Ctrl+C / Cmd+C)
2. Paste into your target canvas (Ctrl+V / Cmd+V)
3. Click Execute button on the workflow node
4. Done! All canvas nodes are processed automatically

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Key Features (WF-32):
âœ… Source node is OPTIONAL - workflows iterate through all canvas nodes
âœ… Templates use loop context: {{loop.index}}, {{loop.current.title}}
âœ… Simple mode with field updates or advanced mode with explicit targets

See: _docs/guidelines/canvas/workflow-presets-and-execution.md`,styles:{fontSize:`${rt.FONT_SIZE_SMALL}px`,fontWeight:"bold",textColor:"#1f2937"}},{id:Pe(8),x:50,y:400,type:He.TEXT,content:`ðŸ”¤ Capitalize

Capitalize first letter of text.
Template: {{loop.current.title.capitalize()}}

Result: "hello world" â†’ "Hello world"`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...t,x:50,y:550},{id:Pe(8),x:450,y:400,type:He.TEXT,content:`âœ‚ï¸ Trim Symbols (Light)

Remove punctuation and special chars from edges.
Template: {{loop.current.title.trimSymbolsLight()}}

Result: "  - hello,  " â†’ "hello"`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...n,x:450,y:550},{id:Pe(8),x:850,y:400,type:He.TEXT,content:`ðŸ§¹ Trim Symbols (Strict)

Remove ALL non-alphanumeric from edges.
Template: {{loop.current.title.trimSymbolsStrict()}}

Result: "***hello***" â†’ "hello"`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...r,x:850,y:550},{id:Pe(8),x:1250,y:400,type:He.TEXT,content:`ðŸ“ Add Full Stop

Append a full stop (.) to end of text.
Template: {{loop.current.title}}.

Result: "Hello world" â†’ "Hello world."`,styles:{fontSize:`${rt.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...a,x:1250,y:550}],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1,targetView:null}},l={id:e,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),canvases:{[i]:c},activeCanvasId:i};return{id:s,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[e]:l},activeWorkspaceId:e}}const Em=[{id:Pe(8),x:600,y:100,type:He.TEXT,content:"Node 2 - Text"}],km=[{id:"vocab-demo-001",x:100,y:350,width:400,height:320,type:He.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"dictionary",term:"CÃ¢u tá»¥c ngá»¯",pronunciation:"/kÉ™ÊŠ tÊŠk Å‹ÊŠ/",partOfSpeech:"noun",definition:"Dieses Sprichwort betont die vietnamesische WertschÃ¤tzung fÃ¼r KreativitÃ¤t, Einfallsreichtum und ProblemlÃ¶sung in schwierigen Situationen",examples:[{id:"ex-001",text:"CÃ¢u tá»¥c ngá»¯ nÃ y nháº¥n máº¡nh sá»± trÃ¢n trá»ng cá»§a ngÆ°á»i Viá»‡t Ä‘á»‘i vá»›i sá»± sÃ¡ng táº¡o, tÃ­nh khÃ©o lÃ©o vÃ  kháº£ nÄƒng giáº£i quyáº¿t váº¥n Ä‘á» trong nhá»¯ng hoÃ n cáº£nh khÃ³ khÄƒn",translation:"This proverb emphasizes Vietnamese appreciation for creativity, resourcefulness and problem-solving in difficult situations"}],relatedWords:[{id:"rw-001",word:"Sprichwort",type:"synonym"},{id:"rw-002",word:"WertschÃ¤tzung",type:"related"}],etymology:{origin:"Vietnamese",language:"Tiáº¿ng Viá»‡t",evolution:"Traditional proverb passed down through generations"},expandedSections:["definition","examples"]}},{id:"vocab-demo-002",x:520,y:350,width:280,height:200,type:He.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"flashcard",term:"nháº¥n máº¡nh",pronunciation:"/É²É™n maÉ²/",partOfSpeech:"verb",definition:"betont / emphasize",flashcardBack:"betont (to emphasize, to stress)",isFlipped:!1,expandedSections:[]}},{id:"vocab-demo-003",x:820,y:350,width:320,height:280,type:He.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"word_list",term:"Sentence Breakdown",definition:"Vietnamese â†’ German word pairs",wordListItems:["CÃ¢u tá»¥c ngá»¯ â†’ Sprichwort","nÃ y â†’ Dieses","nháº¥n máº¡nh â†’ betont","sá»± trÃ¢n trá»ng â†’ WertschÃ¤tzung","cá»§a â†’ (von)","ngÆ°á»i Viá»‡t â†’ Vietnameses"],expandedSections:[]}}],Im=[...km],Tm=[],Am={nodes:Im,arrows:Tm,groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},Pm={offset:{x:50,y:50},scale:1,targetView:null},Fr=Pe(10),Rm={id:Fr,name:"My First Canvas",createdAt:Date.now(),lastModified:Date.now(),coreState:Am,viewState:Pm},$r=Pe(10),Dm={id:$r,name:"Default Workspace",createdAt:Date.now(),lastModified:Date.now(),canvases:{[Fr]:Rm},activeCanvasId:Fr},Ur=Pe(10),Om={id:Ur,name:"My Project",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[$r]:Dm},activeWorkspaceId:$r},_n={version:"3.6.8",dataVersion:"1.1.0",flags:{debug:{logEvents:!1,showDebugOverlay:!0},feature:{}},preferences:{segmentedButtons:{}},uiState:{mode:ya.SELECT,addNodeType:He.TEXT,isPanning:!1,isDrawing:!1,mouseCursor:"cursor-default",selectionBox:null,temporaryArrow:null,nodeToFocusId:null,isOverlayVisible:!1,useCurvedArrows:!1,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},toolbar:{isVisible:!0,toolbarActions:[]},overlay:{},activeGlobalOverlay:kc.NONE},state:{nodes:Em,projects:{[Ur]:Om,"workflow-templates-project":Ic()},activeProjectId:Ur}},mo={DISABLED:"disabled",SIMPLE:"simple",COMPREHENSIVE:"comprehensive"},yC=["Straight","Quadratic","Cubic","Step","Orthogonal","TreeCubic","TreeLStep","TreeZShape"],SC=["none","subtle","medium","vintage","custom"],CC={none:{baseFrequency:.65,numOctaves:3,opacity:0,bgHue:0,bgSaturation:0,bgLightness:100},subtle:{baseFrequency:.8,numOctaves:3,opacity:.15,bgHue:0,bgSaturation:0,bgLightness:100},medium:{baseFrequency:.65,numOctaves:3,opacity:.3,bgHue:0,bgSaturation:0,bgLightness:100},vintage:{baseFrequency:.5,numOctaves:4,opacity:.4,bgHue:40,bgSaturation:30,bgLightness:96}},jC={none:"None",subtle:"Subtle",medium:"Medium",vintage:"Vintage",custom:"Custom"},NC={none:"",subtle:"paper-texture-subtle",medium:"paper-texture-medium",vintage:"paper-texture-vintage",custom:""},EC={Straight:"Straight",Quadratic:"Quadratic",Cubic:"Cubic",Step:"Step (L-shaped)",Orthogonal:"Orthogonal (Z-shaped)",TreeCubic:"Tree: Cubic",TreeLStep:"Tree: L-Step",TreeZShape:"Tree: Z-Shape"},Ie=class Ie{static getSelectionRingClass(e){return e?Ie._selectionRingClass:""}static getSelectedBorderClass(e){return e?Ie._selectedBorderClass:""}static getNodePaddingClass(e){return e===He.TEXT?"px-2 py-1":"p-2"}static getNodeCursorClass(e,t){return e===ya.SELECT?t?"cursor-grabbing":"cursor-grab":""}};Q(Ie,"_debug",{exposeActions:!0}),Q(Ie,"persistState",!0),Q(Ie,"autosave",!0),Q(Ie,"hideToolbar",!1),Q(Ie,"hideOverlay",!1),Q(Ie,"background",{paperTexture:"none",customParams:null,savedPresets:[]}),Q(Ie,"arrows",{styles:{line:"hsl(var(--muted-light))",lineSelected:"hsl(var(--primary))"},type:"Cubic",REVERSE_CURVE:!1,CUBIC_ARROW_S_SHAPE_FACTOR:1,CUBIC_ARROW_S_SHAPE_REVERSED:!1,CUBIC_HORIZONTAL_BIAS:1,CUBIC_CONTROL_DISTANCE_MODE:"scaled-minimum",reverseArrowOnMultipleConnect:!0}),Q(Ie,"copyMode",{autoDrawArrows:!0}),Q(Ie,"highlightAndCreate",{createConnectingArrow:!1,createHighlight:!1,addHorizontally:!0}),Q(Ie,"nodeOptions",{maxNodeWidth:600,resizeBorderWidth:10}),Q(Ie,"nodeStyles",{textAlign:"left",fontSize:`${rt.FONT_SIZE_DEFAULT}px`,fontWeight:"400",border:"",borderWidth:"",borderStyle:"",borderColor:"",backgroundColor:"",textColor:""}),Q(Ie,"zoom",{min:.01,max:4,intensity:.1,marks:[.09,.6,1,1.3,2]}),Q(Ie,"text",{debounceInput:300,fontSize:`${rt.FONT_SIZE_DEFAULT}px`,paddingLeft:4,lineHeight:rt.LINE_HEIGHT_CONFIG}),Q(Ie,"writeMode",{createAtMousePosition:!0,scrollDuration:3e3,scrollYRatio:.8,scrollVerticalPositionRatio:.75}),Q(Ie,"paste",{fixedWidth:550,maxWidth:550,adjustSizeOnPaste:!0}),Q(Ie,"LinterPreset",mo),Q(Ie,"lint",{onPastePreset:mo.SIMPLE}),Q(Ie,"contentCapture",{pasteWidth:700,nodeGap:80,depthOffset:125}),Q(Ie,"arrange",{gap:60,gridNodeWidth:550,gridColumns:3,gridRows:3,autoGroupOnArrange:!0,cleanUpGap:14,cleanUpRowThreshold:.5}),Q(Ie,"animation",{enabled:!0,durationMs:200,easing:"ease-out",splitDelayMs:50}),Q(Ie,"groups",{autoAddNodesOnExpand:!0}),Q(Ie,"slice",{laneGap:150,laneHeaderOffset:30,nodeGap:20}),Q(Ie,"autoScroll",{edgeThreshold:100,edgeThresholdMobile:30,scrollSpeed:15}),Q(Ie,"keyboardScroll",{animationDuration:300,targetScreenYRatio:.33,minKeyboardHeight:100}),Q(Ie,"tabBar",{maxTabWidth:150,dragSourceOpacity:.5,dragPreviewOpacity:.2,dropIndicator:{width:2,opacity:.4}}),Q(Ie,"slashCommand",{menuGapAboveInput:24}),Q(Ie,"dataTable",{dragHandleWidth:32}),Q(Ie,"claudeChat",{popoverRightGap:30,alignScrollDuration:500,alignNodeWithChatInput:!1,autoFocusOnWindowFocus:!0}),Q(Ie,"nodeUI",{idleOpacity:.1,quickPanelGap:30,resizeHandleIdleOpacity:.3,quickArrowHandleIdleOpacity:.3}),Q(Ie,"canvasTable",{dropBehavior:"delete"}),Q(Ie,"history",{historyLimit:100,tabletHistoryLimit:30,archiveLimit:500,tabletArchiveLimit:200,tabletBreakpoint:768,holdRepeatIntervalMs:180}),Q(Ie,"drawing",{strokeGroupingTimeoutMs:1500,isRightHandMode:!0,markerOpacity:.3,markerColor:"#facc15",smoothingFactor:0,minPointDistance:0,compression:{enabled:!0,level:30}}),Q(Ie,"_selectionRingClass","ring-1 ring-ring ring-offset-1"),Q(Ie,"_selectedBorderClass","border-ring");let Le=Ie;const Lm=(s,e,t,n)=>({left:-s.x/e,top:-s.y/e,right:(-s.x+t)/e,bottom:(-s.y+n)/e}),_m=(s,e,t,n,r)=>{const a=s.x+(s.width??100)/2,i=s.y+(s.height??50)/2,c=(r==null?void 0:r.verticalPositionRatio)??.5,l=t/2-a*e,d=n*c-i*e;return{x:l,y:d}},Mm=(s,e,t,n=500,r)=>{const{uiState:a,projectCanvas:i,setActiveCanvasViewState:c}=e(),l=i.getActive();if(!l){console.warn("Cannot center view: No active canvas.");return}const d=l.coreState.nodes,p=l.viewState.scale,u=typeof t=="string"?d==null?void 0:d.find(w=>w.id===t):t,f=a==null?void 0:a.canvasWidth,m=a==null?void 0:a.canvasHeight;if(!u){console.warn("Cannot center view: Node dimensions not found.");return}if(!f||!m){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=l.viewState.offset;Lm(g,p,f,m);const x=_m(u,p,f,m,r!=null&&r.verticalOnly?{verticalPositionRatio:Le.writeMode.scrollVerticalPositionRatio}:void 0),y=r!=null&&r.verticalOnly?{x:g.x,y:x.y}:x;c(w=>({...w,targetView:{targetOffset:y,targetScale:p,animationStartTime:0,animationDuration:n}}))},Fm=(s,e,t)=>({x:Number(((s.x-t.x)/e).toFixed(3)),y:Number(((s.y-t.y)/e).toFixed(3))}),$m=s=>{const{projectCanvas:e}=s(),t=cl.getState(),n=t==null?void 0:t.mousePosition,r=e.getActive(),a=(r==null?void 0:r.viewState.scale)??1,i=(r==null?void 0:r.viewState.offset)??{x:0,y:0};return!n||!r?null:Fm(n,a,i)};var Tc=Symbol.for("immer-nothing"),go=Symbol.for("immer-draftable"),xt=Symbol.for("immer-state");function It(s,...e){throw new Error(`[Immer] minified error nr: ${s}. Full error at: https://bit.ly/3cXEKWf`)}var Gs=Object.getPrototypeOf;function Ns(s){return!!s&&!!s[xt]}function ps(s){var e;return s?Ac(s)||Array.isArray(s)||!!s[go]||!!((e=s.constructor)!=null&&e[go])||cn(s)||ir(s):!1}var Um=Object.prototype.constructor.toString(),xo=new WeakMap;function Ac(s){if(!s||typeof s!="object")return!1;const e=Object.getPrototypeOf(s);if(e===null||e===Object.prototype)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;if(t===Object)return!0;if(typeof t!="function")return!1;let n=xo.get(t);return n===void 0&&(n=Function.toString.call(t),xo.set(t,n)),n===Um}function Mn(s,e,t=!0){or(s)===0?(t?Reflect.ownKeys(s):Object.keys(s)).forEach(r=>{e(r,s[r],s)}):s.forEach((n,r)=>e(r,n,s))}function or(s){const e=s[xt];return e?e.type_:Array.isArray(s)?1:cn(s)?2:ir(s)?3:0}function Br(s,e){return or(s)===2?s.has(e):Object.prototype.hasOwnProperty.call(s,e)}function Pc(s,e,t){const n=or(s);n===2?s.set(e,t):n===3?s.add(t):s[e]=t}function Bm(s,e){return s===e?s!==0||1/s===1/e:s!==s&&e!==e}function cn(s){return s instanceof Map}function ir(s){return s instanceof Set}function ss(s){return s.copy_||s.base_}function Wr(s,e){if(cn(s))return new Map(s);if(ir(s))return new Set(s);if(Array.isArray(s))return Array.prototype.slice.call(s);const t=Ac(s);if(e===!0||e==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(s);delete n[xt];let r=Reflect.ownKeys(n);for(let a=0;a<r.length;a++){const i=r[a],c=n[i];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(n[i]={configurable:!0,writable:!0,enumerable:c.enumerable,value:s[i]})}return Object.create(Gs(s),n)}else{const n=Gs(s);if(n!==null&&t)return{...s};const r=Object.create(n);return Object.assign(r,s)}}function Sa(s,e=!1){return cr(s)||Ns(s)||!ps(s)||(or(s)>1&&Object.defineProperties(s,{set:pn,add:pn,clear:pn,delete:pn}),Object.freeze(s),e&&Object.values(s).forEach(t=>Sa(t,!0))),s}function Wm(){It(2)}var pn={value:Wm};function cr(s){return s===null||typeof s!="object"?!0:Object.isFrozen(s)}var zm={};function hs(s){const e=zm[s];return e||It(0,s),e}var qs;function Rc(){return qs}function Hm(s,e){return{drafts_:[],parent_:s,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function vo(s,e){e&&(hs("Patches"),s.patches_=[],s.inversePatches_=[],s.patchListener_=e)}function zr(s){Hr(s),s.drafts_.forEach(Gm),s.drafts_=null}function Hr(s){s===qs&&(qs=s.parent_)}function wo(s){return qs=Hm(qs,s)}function Gm(s){const e=s[xt];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function bo(s,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return s!==void 0&&s!==t?(t[xt].modified_&&(zr(e),It(4)),ps(s)&&(s=Fn(e,s),e.parent_||$n(e,s)),e.patches_&&hs("Patches").generateReplacementPatches_(t[xt].base_,s,e.patches_,e.inversePatches_)):s=Fn(e,t,[]),zr(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),s!==Tc?s:void 0}function Fn(s,e,t){if(cr(e))return e;const n=s.immer_.shouldUseStrictIteration(),r=e[xt];if(!r)return Mn(e,(a,i)=>yo(s,r,e,a,i,t),n),e;if(r.scope_!==s)return e;if(!r.modified_)return $n(s,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const a=r.copy_;let i=a,c=!1;r.type_===3&&(i=new Set(a),a.clear(),c=!0),Mn(i,(l,d)=>yo(s,r,a,l,d,t,c),n),$n(s,a,!1),t&&s.patches_&&hs("Patches").generatePatches_(r,t,s.patches_,s.inversePatches_)}return r.copy_}function yo(s,e,t,n,r,a,i){if(r==null||typeof r!="object"&&!i)return;const c=cr(r);if(!(c&&!i)){if(Ns(r)){const l=a&&e&&e.type_!==3&&!Br(e.assigned_,n)?a.concat(n):void 0,d=Fn(s,r,l);if(Pc(t,n,d),Ns(d))s.canAutoFreeze_=!1;else return}else i&&t.add(r);if(ps(r)&&!c){if(!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||e&&e.base_&&e.base_[n]===r&&c)return;Fn(s,r),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&(cn(t)?t.has(n):Object.prototype.propertyIsEnumerable.call(t,n))&&$n(s,r)}}}function $n(s,e,t=!1){!s.parent_&&s.immer_.autoFreeze_&&s.canAutoFreeze_&&Sa(e,t)}function qm(s,e){const t=Array.isArray(s),n={type_:t?1:0,scope_:e?e.scope_:Rc(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:s,draft_:null,copy_:null,revoke_:null,isManual_:!1};let r=n,a=Ca;t&&(r=[n],a=Vs);const{revoke:i,proxy:c}=Proxy.revocable(r,a);return n.draft_=c,n.revoke_=i,c}var Ca={get(s,e){if(e===xt)return s;const t=ss(s);if(!Br(t,e))return Vm(s,t,e);const n=t[e];return s.finalized_||!ps(n)?n:n===br(s.base_,e)?(yr(s),s.copy_[e]=qr(n,s)):n},has(s,e){return e in ss(s)},ownKeys(s){return Reflect.ownKeys(ss(s))},set(s,e,t){const n=Dc(ss(s),e);if(n!=null&&n.set)return n.set.call(s.draft_,t),!0;if(!s.modified_){const r=br(ss(s),e),a=r==null?void 0:r[xt];if(a&&a.base_===t)return s.copy_[e]=t,s.assigned_[e]=!1,!0;if(Bm(t,r)&&(t!==void 0||Br(s.base_,e)))return!0;yr(s),Gr(s)}return s.copy_[e]===t&&(t!==void 0||e in s.copy_)||Number.isNaN(t)&&Number.isNaN(s.copy_[e])||(s.copy_[e]=t,s.assigned_[e]=!0),!0},deleteProperty(s,e){return br(s.base_,e)!==void 0||e in s.base_?(s.assigned_[e]=!1,yr(s),Gr(s)):delete s.assigned_[e],s.copy_&&delete s.copy_[e],!0},getOwnPropertyDescriptor(s,e){const t=ss(s),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:s.type_!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty(){It(11)},getPrototypeOf(s){return Gs(s.base_)},setPrototypeOf(){It(12)}},Vs={};Mn(Ca,(s,e)=>{Vs[s]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});Vs.deleteProperty=function(s,e){return Vs.set.call(this,s,e,void 0)};Vs.set=function(s,e,t){return Ca.set.call(this,s[0],e,t,s[0])};function br(s,e){const t=s[xt];return(t?ss(t):s)[e]}function Vm(s,e,t){var r;const n=Dc(e,t);return n?"value"in n?n.value:(r=n.get)==null?void 0:r.call(s.draft_):void 0}function Dc(s,e){if(!(e in s))return;let t=Gs(s);for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Gs(t)}}function Gr(s){s.modified_||(s.modified_=!0,s.parent_&&Gr(s.parent_))}function yr(s){s.copy_||(s.copy_=Wr(s.base_,s.scope_.immer_.useStrictShallowCopy_))}var Km=class{constructor(s){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,n)=>{if(typeof e=="function"&&typeof t!="function"){const a=t;t=e;const i=this;return function(l=a,...d){return i.produce(l,p=>t.call(this,p,...d))}}typeof t!="function"&&It(6),n!==void 0&&typeof n!="function"&&It(7);let r;if(ps(e)){const a=wo(this),i=qr(e,void 0);let c=!0;try{r=t(i),c=!1}finally{c?zr(a):Hr(a)}return vo(a,n),bo(r,a)}else if(!e||typeof e!="object"){if(r=t(e),r===void 0&&(r=e),r===Tc&&(r=void 0),this.autoFreeze_&&Sa(r,!0),n){const a=[],i=[];hs("Patches").generateReplacementPatches_(e,r,a,i),n(a,i)}return r}else It(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(i,...c)=>this.produceWithPatches(i,l=>e(l,...c));let n,r;return[this.produce(e,t,(i,c)=>{n=i,r=c}),n,r]},typeof(s==null?void 0:s.autoFreeze)=="boolean"&&this.setAutoFreeze(s.autoFreeze),typeof(s==null?void 0:s.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(s.useStrictShallowCopy),typeof(s==null?void 0:s.useStrictIteration)=="boolean"&&this.setUseStrictIteration(s.useStrictIteration)}createDraft(s){ps(s)||It(8),Ns(s)&&(s=Jm(s));const e=wo(this),t=qr(s,void 0);return t[xt].isManual_=!0,Hr(e),t}finishDraft(s,e){const t=s&&s[xt];(!t||!t.isManual_)&&It(9);const{scope_:n}=t;return vo(n,e),bo(void 0,n)}setAutoFreeze(s){this.autoFreeze_=s}setUseStrictShallowCopy(s){this.useStrictShallowCopy_=s}setUseStrictIteration(s){this.useStrictIteration_=s}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(s,e){let t;for(t=e.length-1;t>=0;t--){const r=e[t];if(r.path.length===0&&r.op==="replace"){s=r.value;break}}t>-1&&(e=e.slice(t+1));const n=hs("Patches").applyPatches_;return Ns(s)?n(s,e):this.produce(s,r=>n(r,e))}};function qr(s,e){const t=cn(s)?hs("MapSet").proxyMap_(s,e):ir(s)?hs("MapSet").proxySet_(s,e):qm(s,e);return(e?e.scope_:Rc()).drafts_.push(t),t}function Jm(s){return Ns(s)||It(10,s),Oc(s)}function Oc(s){if(!ps(s)||cr(s))return s;const e=s[xt];let t,n=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=Wr(s,e.scope_.immer_.useStrictShallowCopy_),n=e.scope_.immer_.shouldUseStrictIteration()}else t=Wr(s,!0);return Mn(t,(r,a)=>{Pc(t,r,Oc(a))},n),e&&(e.finalized_=!1),t}var Ym=new Km,J=Ym.produce;const ja=s=>{var n,r,a;if(!s.state)return null;const e=s.state.activeProjectId?(n=s.state.projects)==null?void 0:n[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?(r=e.workspaces)==null?void 0:r[e.activeWorkspaceId]:null;return t&&t.activeCanvasId?(a=t.canvases)==null?void 0:a[t.activeCanvasId]:null},Xm=(s,e)=>s(J(t=>{t.uiState.temporaryArrow=e})),Qm=(s,e)=>s(J(t=>{var r,a,i,c,l,d;const n=ja(t);if(n!=null&&n.coreState){const p=typeof e=="function"?e(n.coreState.arrows):e;n.coreState.arrows=p,n.coreState.selectedArrows.length>0&&(n.coreState.selectedArrows=n.coreState.selectedArrows.map(m=>p.find(x=>x.id===m.id)||m)),n.lastModified=Date.now();const u=(c=(i=(a=(r=t.state)==null?void 0:r.projects)==null?void 0:a[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];u&&(u.lastModified=Date.now());const f=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];f&&(f.lastModified=Date.now())}})),Zm=(s,e)=>s(J(t=>{var r,a,i,c,l,d;const n=ja(t);if(n!=null&&n.coreState){const p=Array.isArray(e)?e:[],u=new Set(p.map(g=>g.id));n.coreState.selectedArrows=n.coreState.arrows.filter(g=>u.has(g.id)),n.lastModified=Date.now();const f=(c=(i=(a=(r=t.state)==null?void 0:r.projects)==null?void 0:a[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];f&&(f.lastModified=Date.now());const m=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];m&&(m.lastModified=Date.now())}})),eg=(s,e)=>s(J(t=>{var r,a,i,c,l,d;const n=ja(t);if(n!=null&&n.coreState){n.coreState.arrows.push(e),n.lastModified=Date.now();const p=(c=(i=(a=(r=t.state)==null?void 0:r.projects)==null?void 0:a[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];p&&(p.lastModified=Date.now());const u=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];u&&(u.lastModified=Date.now())}})),tg=(s,e,t,n)=>{s(J(r=>{var l,d;const a=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a!=null&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i!=null&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if((d=c==null?void 0:c.coreState)!=null&&d.arrows){const p=c.coreState.arrows.findIndex(u=>u.id===t);if(p!==-1){if(c.coreState.arrows[p]={...c.coreState.arrows[p],...n},c.coreState.selectedArrows){const f=c.coreState.selectedArrows.findIndex(m=>m.id===t);f!==-1&&(c.coreState.selectedArrows[f]={...c.coreState.selectedArrows[f],...n})}const u=Date.now();c.lastModified=u,i&&(i.lastModified=u),a&&(a.lastModified=u)}}}))},sg=(s,e)=>({setTemporary:t=>Xm(s,t),setAll:t=>Qm(s,t),setSelected:t=>Zm(s,t),add:t=>eg(s,t),update:(t,n)=>tg(s,e,t,n)});function ng(s,e=getComputedStyle(document.body).font){if(!s)return 0;const n=document.createElement("canvas").getContext("2d");return n?(n.font=e,n.measureText(s).width):0}const rg=6;function ag(s,e=getComputedStyle(document.body).font){return s?s.split(/\n|&nbsp;/).map(r=>{const a=_c(r),i=Fc(e,a),c=Mc(r);let l=ng(c,i);return Lc(r)&&(l+=rg),l}).reduce((r,a)=>Math.max(r,a),0):0}function og(s,e=getComputedStyle(document.body).font){const n=document.createElement("canvas").getContext("2d");if(!n)return 0;n.font=e;const r=n.measureText(s),a=r.actualBoundingBoxAscent+r.actualBoundingBoxDescent;if(a&&a>0)return a;const i=n.measureText("M");return i.actualBoundingBoxAscent+i.actualBoundingBoxDescent||parseInt(e,10)*1.2}function ig(s){const e=s.trimStart();return e.startsWith("### ")?1.2:e.startsWith("## ")?1.35:e.startsWith("# ")?1.5:1}function Lc(s){const e=s.trimStart();return!!(e.startsWith("- ")||/^\d+\.\s/.test(e))}function _c(s){const e=s.trimStart();return e.startsWith("### ")?1.125:e.startsWith("## ")?1.25:e.startsWith("# ")?1.5:1}function Mc(s){const e=s.trimStart(),t=s.length-e.length,n=s.substring(0,t);if(e.startsWith("### "))return n+e.slice(4);if(e.startsWith("## "))return n+e.slice(3);if(e.startsWith("# ")||e.startsWith("> ")||e.startsWith("- "))return n+e.slice(2);const r=e.match(/^(\d+)\.\s/);return r?n+e.slice(r[0].length):s}function Fc(s,e){if(e===1)return s;const t=s.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/);if(!t)return s;const n=parseFloat(t[1]),r=t[2],a=n*e;return s.replace(t[0],`${a}${r}`)}function Un(s,e,t=getComputedStyle(document.body).font,n){if(!s)return 0;const a=document.createElement("canvas").getContext("2d");if(!a)return 0;a.font=t;const i=(n??og("M",t))||parseInt(t,10)*1.2;if(i===0)return console.warn("measureWrappedTextHeight: Could not determine line height. Using fallback."),s.split(`
`).length*16;const c=s.split(`
`);let l=0,d=!1,p=!1,u=!0;for(const m of c){if(m.trim()===""){l+=i,p=!1,u=!1;continue}const g=Lc(m);g&&!p&&!u&&(l+=i),p=g,u=!1;const x=ig(m);x>1&&(d=!0);const y=i*x,w=_c(m),v=Fc(t,w);a.font=v;const j=Mc(m).split(" ");let S="",C=1;for(let N=0;N<j.length;N++){const A=j[N],I=S+(S?" ":"")+A;a.measureText(I).width>e&&S!==""?(C++,S=A,a.measureText(A).width>e):S=I}l+=C*y}let f=l+(d?nm:0);return f+=rm,f}function cg(s,e){if(!s)return 0;const{containerWidth:t,textarea:n}=e,r=n||document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(!r)return Un(s,t);const a=window.getComputedStyle(r),i=a.fontSize,c=a.fontFamily,d=`${a.fontWeight} ${i} ${c}`;let p;const u=a.lineHeight;if(u&&u!=="normal"){const y=parseFloat(u);isNaN(y)||(p=y)}const f=parseFloat(a.paddingLeft)||0,m=parseFloat(a.paddingRight)||0,g=f+m,x=t-g;return Un(s,x,d,p)}const{DEFAULT_NODE_WIDTH:Bn,DEFAULT_NODE_HEIGHT:Wn}=rt,fs=s=>{const e=s.x,t=s.y,n=s.width??Bn,r=s.height??Wn;return{x1:e,y1:t,x2:e+n,y2:t+r}},kC=(s,e,t)=>{const n=t?new Set(t):null;for(let r=e.length-1;r>=0;r--){const a=e[r];if(n&&n.has(a.id))continue;const i=fs(a);if(s.x>=i.x1&&s.x<=i.x2&&s.y>=i.y1&&s.y<=i.y2)return a}return null},So=s=>{const e=s.x,t=s.y,n=s.width??Bn,r=s.height??Wn;return{x:e+n/2,y:t+r/2}},IC=(s,e)=>s.x===e.x&&s.y===e.y,lg=()=>{const s=document.querySelector("textarea[data-node-textarea]"),e=document.querySelector(".markdown-textarea[data-node-textarea]"),t=s||e;if(t){const r=window.getComputedStyle(t).lineHeight;if(r&&r!=="normal"){const a=parseFloat(r);if(!isNaN(a))return a}}},dg=(s,e)=>{const t=ag(s)+am.textNodeXPadding,r=cg(s,{containerWidth:t})+rt.NODE_Y_PADDING*2;return{width:t,height:r}},TC=(s,e)=>{const t=fs(s),n=fs(e);return t.x1>=n.x1&&t.y1>=n.y1&&t.x2<=n.x2&&t.y2<=n.y2},ug=(s,e)=>{const t=fs(e);return s.filter(n=>{if(n.id===e.id)return!1;const r=fs(n);return!(r.x2<t.x1||r.x1>t.x2||r.y2<t.y1||r.y1>t.y2)})},pg=(s,e="bottom")=>{if(!s.length)return null;switch(e){case"left":return s.reduce((t,n)=>n.x<t.x?n:t,s[0]);case"right":return s.reduce((t,n)=>n.x+(n.width??Bn)>t.x+(t.width??Bn)?n:t,s[0]);case"top":return s.reduce((t,n)=>n.y<t.y?n:t,s[0]);case"bottom":return s.reduce((t,n)=>n.y+(n.height??Wn)>t.y+(t.height??Wn)?n:t,s[0]);default:return null}},Ts=s=>(e,t)=>{s(n=>{if(!n.state)return n;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,a=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=a&&a.activeCanvasId?a.canvases[a.activeCanvasId]:null;if(!i)return n;const c=i.coreState,l=c.nodes.findIndex(g=>g.id===e);if(l===-1)return n;const d=new Date().toISOString(),p={...t,updatedAt:d},u=[...c.nodes];u[l]={...u[l],...p};const m=c.selectedNodes.some(g=>g.id===e)?c.selectedNodes.map(g=>g.id===e?{...g,...p}:g):c.selectedNodes;return window.__nodes=u,window.__selectedNodes=m,{...n,state:{...n.state,projects:{...n.state.projects,[n.state.activeProjectId]:{...r,lastModified:Date.now(),workspaces:{...r.workspaces,[r.activeWorkspaceId]:{...a,lastModified:Date.now(),canvases:{...a.canvases,[a.activeCanvasId]:{...i,coreState:{...c,nodes:u,selectedNodes:m},lastModified:Date.now()}}}}}}}}})},hg=(s,e)=>s(t=>({uiState:{...t.uiState,mode:e}})),fg=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:e}})),mg=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:t.uiState.zoomSubMode==="zoom:lock"?"zoom":"zoom:lock"}})),gg=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:e}})),xg=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:t.uiState.writeSubMode===Sn.AUDIO?Sn.WRITE:Sn.AUDIO}})),vg=(s,e)=>s(t=>({uiState:{...t.uiState,arrowSubMode:e}})),wg=s=>s(e=>({uiState:{...e.uiState,arrowSubMode:e.uiState.arrowSubMode===Cn.STAY?Cn.DEFAULT:Cn.STAY}})),bg=(s,e)=>s(()=>({mousePosition:e})),yg=(s,e)=>s(t=>({uiState:{...t.uiState,isPanning:e}})),Sg=(s,e)=>s(t=>({uiState:{...t.uiState,selectionBox:e}})),Cg=(s,e)=>s(t=>({uiState:{...t.uiState,pendingSelectionStart:e}})),jg=(s,e)=>s(t=>({uiState:{...t.uiState,writeModeStartPosition:e}})),Ng=(s,e)=>s(t=>({uiState:{...t.uiState,dragInfo:e}})),Eg=(s,e)=>s(t=>({uiState:{...t.uiState,groupDragInfo:e}})),kg=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetGroupId:e}})),Ig=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetVocabNodeId:e}})),Tg=(s,e)=>s(t=>({uiState:{...t.uiState,tableDropTarget:e}})),Ag=(s,e)=>s(t=>({uiState:{...t.uiState,resizingNode:e}})),Pg=(s,e)=>s(t=>({uiState:{...t.uiState,resizingGroup:e}})),Rg=(s,e)=>s(t=>({uiState:{...t.uiState,nodeToFocusId:e}})),Dg=(s,e)=>{var n;if(!e)return;const t=s().projectCanvas.getActive();return(n=t==null?void 0:t.coreState.nodes)==null?void 0:n.find(r=>r.id===e)},Og=(s,e)=>s(t=>({uiState:{...t.uiState,addNodeType:e}})),Lg=(s,e,t)=>s(n=>({uiState:{...n.uiState,canvasWidth:e,canvasHeight:t}})),_g=(s,e)=>s(t=>({uiState:e(t.uiState)})),Mg=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{if(n.nodes.length>0&&e.length===0)return console.trace("NOOO should not happend"),n;const r=typeof e=="function"?e(n.nodes):e;return{...n,nodes:r}}),{})),Fg=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=Array.isArray(e)?e:[],a=new Set(r.map(l=>l.id)),i=n.nodes.map(l=>({...l,isEditing:!1})),c=i.filter(l=>a.has(l.id));return{...n,nodes:i,selectedNodes:c}}),{})),$g=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.selectedNodes.filter(i=>i.id!==e),a=n.nodes.map(i=>i.id===e?{...i,isEditing:!1}:i);return{...n,nodes:a,selectedNodes:r}}),{})),Ug=(s,e,t,n={dontOverlap:!1,dontSelect:!1})=>s(r=>(r.setActiveCanvasCoreState(a=>{var y;const i=new Date().toISOString(),c=a.activeLayerId,l=a.layers??[],d=l.find(w=>w.id===c);let p;if(d&&!d.isLocked)p=c??void 0;else if(l.length>0){const w=l.find(v=>!v.isLocked);p=(w==null?void 0:w.id)??((y=l[0])==null?void 0:y.id)}const u={...e,createdAt:e.createdAt??i,updatedAt:i,...p?{layerId:p}:{}};t!==void 0&&(u.content=t);const f=a.nodes;if(n.dontOverlap){const w=ug(f,e);if(w.length>0){const v=pg(w,"right");if(v){const b=v.x+(v.width??0);u.x=b+rt.nodeSpacing}}}let m;if(!u.groupId&&u.type!==He.GROUP){const w=f.filter(j=>j.type===He.GROUP),v=fs(u),b=w.find(j=>{const S=fs(j),C=v.x1+(v.x2-v.x1)/2,N=v.y1+(v.y2-v.y1)/2;return C>=S.x1&&C<=S.x2&&N>=S.y1&&N<=S.y2});b&&(u.groupId=b.id,m=b.id)}let g=[...f,u];m&&(g=g.map(w=>{if(w.id===m){const v=w.data??{},b=v.childNodeIds??[];return{...w,data:{...v,childNodeIds:[...b,u.id]},updatedAt:i}}return w}));const x=n.dontSelect?a.selectedNodes:[u];return{...a,nodes:g,selectedNodes:x,selectedArrows:n.dontSelect?a.selectedArrows:[]}}),{})),Bg=(s,e)=>s(t=>({state:e(t.state)})),Wg=s=>(e,t)=>Ts(s)(e,{content:t}),zg=s=>(e,t)=>Ts(s)(e,{subContent:t}),Hg=s=>(e,t)=>Ts(s)(e,{title:t}),Gg=s=>(e,t)=>Ts(s)(e,{...t}),qg=s=>{var t;const e=s().projectCanvas.getActive();return(t=e==null?void 0:e.coreState.nodes)==null?void 0:t.find(n=>n.isEditing)},Vg=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.nodes.filter(c=>c.id!==e),a=n.selectedNodes.filter(c=>c.id!==e),i=n.arrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e);return{...n,nodes:r,selectedNodes:a,arrows:i}}),t.uiState.nodeToFocusId===e&&s(n=>({uiState:{...n.uiState,nodeToFocusId:null}})),{})),Kg=s=>s(e=>(e.setActiveCanvasCoreState(t=>({...t,nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]})),{})),Jg=(s,e)=>s(t=>({flags:e(t.flags)})),Yg=s=>s(_n),Xg=s=>s(e=>({uiState:{...e.uiState,isOverlayVisible:!e.uiState.isOverlayVisible}})),Qg=s=>s(e=>({uiState:{...e.uiState,useCurvedArrows:!e.uiState.useCurvedArrows}})),Zg=(s,e)=>s(t=>({uiState:{...t.uiState,customNodeDropdownOpen:e}})),ex=(s,e)=>s(t=>({uiState:{...t.uiState,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[],...t.uiState.nodeUpdateSettings||{},...e}}})),tx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:e.sort((n,r)=>n-r)}})),sx=(s,e)=>s(t=>{const n=t.uiState.zoomMarks||[];return n.includes(e)?t:{uiState:{...t.uiState,zoomMarks:[...n,e].sort((r,a)=>r-a)}}}),nx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:(t.uiState.zoomMarks||[]).filter(n=>n!==e)}})),rx=(s,e)=>s(t=>({uiState:{...t.uiState,activeGlobalOverlay:e}})),ax=(s,e)=>s(t=>({uiState:{...t.uiState,arrangeSnapshot:e}})),ox=s=>s(J(e=>{const t=e.uiState.arrangeSnapshot;if(!t||!e.state)return;const n=e.state.activeProjectId?e.state.projects[e.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,a=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(a){for(const[i,c]of Object.entries(t.nodePositions)){const l=a.coreState.nodes.find(d=>d.id===i);l&&(l.x=c.x,l.y=c.y,c.width!==void 0&&(l.width=c.width),c.height!==void 0&&(l.height=c.height),l.updatedAt=new Date().toISOString())}a.coreState.selectedNodes=a.coreState.selectedNodes.map(i=>{const c=t.nodePositions[i.id];return c?{...i,x:c.x,y:c.y,width:c.width??i.width,height:c.height??i.height,updatedAt:new Date().toISOString()}:i}),e.uiState.arrangeSnapshot=null}})),ix=s=>s(e=>({uiState:{...e.uiState,arrangeSnapshot:null}})),cx=(s,e)=>{s(t=>{if(!t.state)return t;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,a=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!a)return t;const i=e(a.viewState);if(i===a.viewState)return t;const c=Date.now();return{...t,state:{...t.state,projects:{...t.state.projects,[t.state.activeProjectId]:{...n,lastModified:c,workspaces:{...n.workspaces,[n.activeWorkspaceId]:{...r,lastModified:c,canvases:{...r.canvases,[r.activeCanvasId]:{...a,viewState:i,lastModified:c}}}}}}}}})},lx=(s,e)=>s(J(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,a=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;a&&(a.coreState=e(a.coreState),a.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now()))})),dx=s=>{s.forEach(e=>localStorage.removeItem(e)),window.location.reload()},ux=s=>e=>{s(J(t=>{var l;if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,a=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!((l=a==null?void 0:a.coreState)!=null&&l.nodes))return;const i=new Date().toISOString();let c=null;a.coreState.nodes=a.coreState.nodes.map(d=>{const p=e.find(m=>m.id===d.id);if(!p)return d;let u=!1,f=!1;for(const m in p)if(p[m]!==d[m]){u=!0,(m==="x"||m==="y")&&(f=!0);break}return u&&f&&(c=d.id),u?{...d,...p,updatedAt:i}:d}),c&&(t.uiState.lastUpdatedNodeId=c),a.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now())}),!1)},px=s=>(e,t)=>{Ts(s)(e,{styles:t})};function hx(){return Math.random().toString(36).substring(2,9)}let $c=0;function AC(){let s=Date.now().toString(25);return s+=$c++,`${hx()}-${s}`}function fx(){let s=Date.now().toString(25);return s+="_"+$c++,s}const mx=/^c-(\d+_)?(.+)$/;function Uc(s){const e=mx.exec(s),t=fx();return e?`${e[1]?`c-${parseInt(e[1],10)+1}_`:"c-1_"}${e[2]}`+t:`c-${s}`+t}const gx=s=>s(e=>(e.setActiveCanvasCoreState(t=>{const r=t.selectedNodes.map(a=>{const i=a.height??rt.DEFAULT_NODE_HEIGHT,c=a.y+i+rt.nodeSpacing,l=Uc(a.id);return{...a,id:l,y:c,x:a.x+rt.nodeSpacing}});return{...t,nodes:[...t.nodes,...r],selectedNodes:r}}),{})),xx=(s,e)=>({getNodeById:t=>t?Dg(s,t):void 0,setNodes:t=>Mg(e,t),setSelectedNodes:t=>Fg(e,t),unselectNodeById:t=>$g(e,t),addNode:(t,n,r)=>{var a;if(Ug(e,t,n,r),!(r!=null&&r.skipUndo)){const i=(a=s().projectCanvas.getActive())==null?void 0:a.coreState.nodes.find(c=>c.id===t.id);i&&s().undo.commit({type:"node:create",node:i})}},duplicateNodes:()=>gx(e),updateNode:(t,n)=>Ts(e)(t,n),updateNodes:t=>ux(e)(t),updateNodeGeometry:(t,n)=>Gg(e)(t,n),updateNodeContent:(t,n)=>Wg(e)(t,n),updateNodeSubContent:(t,n)=>zg(e)(t,n),updateNodeTitle:(t,n)=>Hg(e)(t,n),updateNodeStyles:(t,n)=>px(e)(t,n),getEditingNode:()=>qg(s),setActiveCanvasCoreState:t=>lx(e,t),setState:t=>Bg(e,t)}),vx=(s,e)=>{const t=e().projectCanvas.getActive();if(!t)return;const n=t.coreState.selectedNodes;if(n.length===0)return;const r=new Set(n.map(l=>l.id)),a=t.coreState.nodes.filter(l=>r.has(l.id)),i=t.coreState.arrows.filter(l=>l.startNodeId&&r.has(l.startNodeId)||l.endNodeId&&r.has(l.endNodeId)),c=new Map;for(const l of i){if(l.startNodeId&&r.has(l.startNodeId)){const d=c.get(l.startNodeId)||[];d.push(l),c.set(l.startNodeId,d)}if(l.endNodeId&&r.has(l.endNodeId)){const d=c.get(l.endNodeId)||[];d.includes(l)||d.push(l),c.set(l.endNodeId,d)}}if(s(l=>(l.setActiveCanvasCoreState(d=>{const p=d.nodes.filter(f=>!r.has(f.id)),u=d.arrows.filter(f=>!(f.startNodeId&&r.has(f.startNodeId)||f.endNodeId&&r.has(f.endNodeId)));return{...d,nodes:p,arrows:u,selectedNodes:[]}}),{})),a.length===1)e().undo.commit({type:"node:delete",node:a[0],connectedArrows:c.get(a[0].id)||[]});else if(a.length>1){const l=a.map(d=>({type:"node:delete",node:d,connectedArrows:c.get(d.id)||[]}));e().undo.commit({type:"batch",label:`Delete ${a.length} nodes`,operations:l})}},wx=(s,e)=>{s(t=>{const n=t.projectCanvas.getActive();if(!n)return{};const r=new Set(n.coreState.selectedArrows.map(a=>a.id));return r.size===0?{}:(t.setActiveCanvasCoreState(a=>{const i=a.arrows.filter(c=>!r.has(c.id));return{...a,arrows:i,selectedArrows:[]}}),{})})},bx=(s,e)=>({deleteSelectedNodes:()=>vx(e,s),deleteSelectedArrows:()=>wx(e),deleteNodeById:t=>{const n=s().projectCanvas.getActive(),r=n==null?void 0:n.coreState.nodes.find(i=>i.id===t),a=n==null?void 0:n.coreState.arrows.filter(i=>i.startNodeId===t||i.endNodeId===t);Vg(e,t),r&&s().undo.commit({type:"node:delete",node:r,connectedArrows:a||[]})},deleteAll:()=>Kg(e)});var rs=(s=>(s.FREEHAND="draw:freehand",s.RECTANGLE="draw:rectangle",s.SQUARE="draw:square",s.CIRCLE="draw:circle",s.ELLIPSE="draw:ellipse",s.LINE="draw:line",s.ARROW="draw:arrow",s))(rs||{});const Bc={strokeColor:"currentColor",strokeWidth:2,strokeStyle:"solid",opacity:1},PC=2,RC=20,yx=(s,e)=>s(t=>({uiState:{...t.uiState,drawSubMode:e}})),Sx=s=>s(e=>{const t=e.uiState.drawSubMode??rs.FREEHAND,n=[rs.FREEHAND,rs.RECTANGLE,rs.CIRCLE,rs.LINE],a=(n.indexOf(t)+1)%n.length;return{uiState:{...e.uiState,drawSubMode:n[a]}}}),Cx=(s,e)=>s(t=>({uiState:{...t.uiState,temporaryDrawing:e}})),jx=(s,e)=>s(t=>({uiState:{...t.uiState,drawStyle:{...t.uiState.drawStyle??Bc,...e}}})),Nx=s=>s().uiState.drawSubMode??rs.FREEHAND,Ex=s=>s().uiState.temporaryDrawing??null,kx=s=>s().uiState.drawStyle??Bc,Ix=(s,e)=>s(t=>({uiState:{...t.uiState,drawAxisLock:e}})),Tx=s=>s().uiState.drawAxisLock??"none",Ax=(s,e)=>({setMode:t=>hg(e,t),setZoomSubMode:t=>fg(e,t),toggleZoomSubMode:()=>mg(e),setWriteSubMode:t=>gg(e,t),toggleWriteSubMode:()=>xg(e),setArrowSubMode:t=>vg(e,t),toggleArrowSubMode:()=>wg(e),setDrawSubMode:t=>yx(e,t),toggleDrawSubMode:()=>Sx(e),setTemporaryDrawing:t=>Cx(e,t),setDrawStyle:t=>jx(e,t),getDrawSubMode:()=>Nx(s),getTemporaryDrawing:()=>Ex(s),getDrawStyle:()=>kx(s),setDrawAxisLock:t=>Ix(e,t),getDrawAxisLock:()=>Tx(s),setActiveCanvasViewState:t=>cx(e,t),setIsPanning:t=>yg(e,t),setSelectionBox:t=>Sg(e,t),setPendingSelectionStart:t=>Cg(e,t),setWriteModeStartPosition:t=>jg(e,t),setDragInfo:t=>Ng(e,t),setGroupDragInfo:t=>Eg(e,t),setHoveredDropTargetGroupId:t=>kg(e,t),setHoveredDropTargetVocabNodeId:t=>Ig(e,t),setTableDropTarget:t=>Tg(e,t),setResizingNode:t=>Ag(e,t),setResizingGroup:t=>Pg(e,t),setNodeToFocusId:t=>Rg(e,t),setAddNodeType:t=>Og(e,t),setCanvasDimensions:(t,n)=>Lg(e,t,n),toggleOverlayVisibility:()=>Xg(e),toggleCurvedArrows:()=>Qg(e),setCustomNodeDropdownOpen:t=>Zg(e,t),setNodeUpdateSettings:t=>ex(e,t),setZoomMarks:t=>tx(e,t),addZoomMark:t=>sx(e,t),removeZoomMark:t=>nx(e,t),setUiState:t=>_g(e,t),setArrangeSnapshot:t=>ax(e,t),revertArrangeSnapshot:()=>ox(e),clearArrangeSnapshot:()=>ix(e),setActiveGlobalOverlay:t=>rx(e,t)}),Vr="gz:";async function Px(s){if(!s)return s;const t=new TextEncoder().encode(s),n=new CompressionStream("gzip"),r=n.writable.getWriter();r.write(t),r.close();const a=[],i=n.readable.getReader();for(;;){const{done:u,value:f}=await i.read();if(u)break;a.push(f)}const c=a.reduce((u,f)=>u+f.length,0),l=new Uint8Array(c);let d=0;for(const u of a)l.set(u,d),d+=u.length;const p=Array.from(l,u=>String.fromCharCode(u)).join("");return Vr+btoa(p)}async function Rx(s){if(!s||!s.startsWith(Vr))return s;const e=s.slice(Vr.length),t=atob(e),n=Uint8Array.from(t,f=>f.charCodeAt(0)),r=new DecompressionStream("gzip"),a=r.writable.getWriter();a.write(n),a.close();const i=[],c=r.readable.getReader();for(;;){const{done:f,value:m}=await c.read();if(f)break;i.push(m)}const l=i.reduce((f,m)=>f+m.length,0),d=new Uint8Array(l);let p=0;for(const f of i)d.set(f,p),p+=f.length;return new TextDecoder().decode(d)}function Co(s){return new Blob([s]).size}function jo(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(2)} MB`}const Dx=s=>{if(!(s!=null&&s.projects))return s;const e={};for(const[t,n]of Object.entries(s.projects)){const r={};for(const[a,i]of Object.entries(n.workspaces)){const c={};for(const[l,d]of Object.entries(i.canvases)){const{undoTree:p,...u}=d;c[l]=u}r[a]={...i,canvases:c}}e[t]={...n,workspaces:r}}return{...s,projects:e}},Ox=(s,e,t)=>({saveStateToLocalStorage:()=>{const n={version:s().version,dataVersion:s().dataVersion,state:Dx(s().state),uiState:s().uiState,flags:s().flags,preferences:s().preferences,extensions:s().extensions,actions:s().actions},{temporaryArrow:r,selectionBox:a,dragInfo:i,resizingNode:c,...l}=n.uiState,d=n.extensions?{registry:n.extensions.registry,settings:n.extensions.settings}:void 0,p={...n,uiState:l,extensions:d},u=JSON.stringify(p);Px(u).then(f=>{const m=Co(u),g=Co(f),x=((1-g/m)*100).toFixed(0);localStorage.setItem(e,f),t.log(`Canvas state saved: ${jo(m)} â†’ ${jo(g)} (${x}% reduction)`)}).catch(f=>{t.error("Failed to save state to localStorage",f),console.log("Failed to save state to localStorage",f),be.error("Save failed",{description:f instanceof Error?f.message:"Failed to save canvas",duration:3e3})})}}),Lx="workflow-templates-project",_x=async(s,e)=>{try{const t=localStorage.getItem(s);if(t){const n=await Rx(t),r=JSON.parse(n);return r.dataVersion!==e?(localStorage.removeItem(s),null):{version:r.version,dataVersion:r.dataVersion,state:r.state,uiState:r.uiState,flags:r.flags,preferences:r.preferences,extensions:r.extensions,actions:r.actions}}}catch(t){console.error("[PERSISTENCE] Failed to load from localStorage:",t),console.warn("[PERSISTENCE] Clearing corrupted localStorage data"),localStorage.removeItem(s)}return null},Mx=(s,e)=>{var n,r;if(e===null)return No(s);const t={...s,...e,uiState:{...s.uiState,...e.uiState||{},temporaryArrow:null,selectionBox:null,dragInfo:null,resizingNode:null},state:{projects:((n=e.state)==null?void 0:n.projects)||((r=s.state)==null?void 0:r.projects)||{},...s.state,...e.state||{}},flags:{...s.flags,...e.flags||{}},preferences:{...s.preferences,...e.preferences||{}},extensions:e.extensions?{registry:e.extensions.registry||{},settings:e.extensions.settings||{}}:s.extensions};return No(t)},No=s=>{var e;return(e=s.state)!=null&&e.projects&&(s.state.projects[Lx]=Ic()),s},Fx=s=>{const e=s==null?void 0:s.canvasConfig;e&&(e.arrows&&(e.arrows.type&&(Le.arrows.type=e.arrows.type),e.arrows.REVERSE_CURVE!==void 0&&(Le.arrows.REVERSE_CURVE=e.arrows.REVERSE_CURVE),e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR!==void 0&&(Le.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR),e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED!==void 0&&(Le.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED),e.arrows.CUBIC_HORIZONTAL_BIAS!==void 0&&(Le.arrows.CUBIC_HORIZONTAL_BIAS=e.arrows.CUBIC_HORIZONTAL_BIAS),e.arrows.reverseArrowOnMultipleConnect!==void 0&&(Le.arrows.reverseArrowOnMultipleConnect=e.arrows.reverseArrowOnMultipleConnect)),e.persistState!==void 0&&(Le.persistState=e.persistState),e.autosave!==void 0&&(Le.autosave=e.autosave),e.hideOverlay!==void 0&&(Le.hideOverlay=e.hideOverlay),e.hideToolbar!==void 0&&(Le.hideToolbar=e.hideToolbar),e.nodeOptions&&(e.nodeOptions.maxNodeWidth!==void 0&&(Le.nodeOptions.maxNodeWidth=e.nodeOptions.maxNodeWidth),e.nodeOptions.resizeBorderWidth!==void 0&&(Le.nodeOptions.resizeBorderWidth=e.nodeOptions.resizeBorderWidth)),e.zoom&&(e.zoom.min!==void 0&&(Le.zoom.min=e.zoom.min),e.zoom.max!==void 0&&(Le.zoom.max=e.zoom.max),e.zoom.intensity!==void 0&&(Le.zoom.intensity=e.zoom.intensity)))};function Wc(s){const{undoTree:e,...t}=s;return t}function zc(s){const e={};for(const[t,n]of Object.entries(s.canvases))e[t]=Wc(n);return{...s,canvases:e}}function Hc(s){const e={};for(const[t,n]of Object.entries(s.workspaces))e[t]=zc(n);return{...s,workspaces:e}}const $x=s=>{var m,g,x;const e=s(),t=e.state;if(!t){console.error("Cannot export: State is not available.");return}const n={};for(const[y,w]of Object.entries(t.projects))n[y]=Hc(w);const r={...t,projects:n},a=e.preferences,i={splitPresets:a==null?void 0:a.splitPresets,arrangePresets:a==null?void 0:a.arrangePresets,arrangeConfigFavorites:a==null?void 0:a.arrangeConfigFavorites,pinnedPaletteItems:a==null?void 0:a.pinnedPaletteItems,canvasConfig:a==null?void 0:a.canvasConfig,keepArrowsOnSplit:a==null?void 0:a.keepArrowsOnSplit,keepSplitMatch:a==null?void 0:a.keepSplitMatch,splitHorizontally:a==null?void 0:a.splitHorizontally,splitNodeGap:a==null?void 0:a.splitNodeGap,borderButton:a==null?void 0:a.borderButton,arrowStyleButton:a==null?void 0:a.arrowStyleButton,arrangeButton:a==null?void 0:a.arrangeButton,segmentedButtons:a==null?void 0:a.segmentedButtons,projectsManagerSearch:a==null?void 0:a.projectsManagerSearch,recentCanvases:a==null?void 0:a.recentCanvases,goToSymbolSearch:a==null?void 0:a.goToSymbolSearch,openTabs:a==null?void 0:a.openTabs},c={sequencePresets:(m=e.actions)==null?void 0:m.sequencePresets,history:(g=e.actions)==null?void 0:g.history,historySelection:(x=e.actions)==null?void 0:x.historySelection},l={...r,preferences:i,actions:c},d=JSON.stringify(l,null,2),p=new Blob([d],{type:"application/json"}),u=URL.createObjectURL(p),f=document.createElement("a");f.href=u,f.download=`markop-canvas-export-${new Date().toISOString()}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u)},Ux=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r,canvasId:a}=e,i=t.projects[n];if(!i){console.error(`Cannot export: Project ${n} not found.`);return}const c=i.workspaces[r];if(!c){console.error(`Cannot export: Workspace ${r} not found.`);return}const l=c.canvases[a];if(!l){console.error(`Cannot export: Canvas ${a} not found.`);return}const d=Wc(l),p={...c,canvases:{[a]:d},activeCanvasId:a},u={...i,workspaces:{[r]:p},activeWorkspaceId:r},f={projects:{[n]:u},activeProjectId:n},m=JSON.stringify(f,null,2),g=new Blob([m],{type:"application/json"}),x=URL.createObjectURL(g),y=l.name.replace(/[^a-zA-Z0-9-_]/g,"_"),w=document.createElement("a");w.href=x,w.download=`canvas-${y}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(x)},Bx=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r}=e,a=t.projects[n];if(!a){console.error(`Cannot export: Project ${n} not found.`);return}const i=a.workspaces[r];if(!i){console.error(`Cannot export: Workspace ${r} not found.`);return}const c=zc(i),l={...a,workspaces:{[r]:c},activeWorkspaceId:r},d={projects:{[n]:l},activeProjectId:n},p=JSON.stringify(d,null,2),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=i.name.replace(/[^a-zA-Z0-9-_]/g,"_"),g=document.createElement("a");g.href=f,g.download=`workspace-${m}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(f)},Wx=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n}=e,r=t.projects[n];if(!r){console.error(`Cannot export: Project ${n} not found.`);return}const a=Hc(r),i={projects:{[n]:a},activeProjectId:n},c=JSON.stringify(i,null,2),l=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(l),p=r.name.replace(/[^a-zA-Z0-9-_]/g,"_"),u=document.createElement("a");u.href=d,u.download=`project-${p}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d)},zx=(s,e,t={})=>{const{replace:n=!1}=t;try{const r=JSON.parse(e);if((!r||typeof r.projects!="object")&&r.projects!==null)throw new Error("Invalid data format: Missing or invalid 'projects' structure.");const a=r.projects??{};let i=0,c=0;if(n){let l=r.activeProjectId;l&&!a[l]?(console.warn("Imported activeProjectId does not exist in the imported projects. Resetting active project."),l=Object.keys(a)[0]??null):!l&&Object.keys(a).length>0&&(l=Object.keys(a)[0]),i=Object.keys(a).length;const d=r.preferences,p=r.actions;s(u=>{var m,g,x,y,w,v,b,j,S,C,N,A,I,k,P,W,R,F,L,T;const f={...u.preferences,splitPresets:(d==null?void 0:d.splitPresets)??((m=u.preferences)==null?void 0:m.splitPresets),arrangePresets:(d==null?void 0:d.arrangePresets)??((g=u.preferences)==null?void 0:g.arrangePresets),arrangeConfigFavorites:(d==null?void 0:d.arrangeConfigFavorites)??((x=u.preferences)==null?void 0:x.arrangeConfigFavorites),pinnedPaletteItems:(d==null?void 0:d.pinnedPaletteItems)??((y=u.preferences)==null?void 0:y.pinnedPaletteItems),canvasConfig:(d==null?void 0:d.canvasConfig)??((w=u.preferences)==null?void 0:w.canvasConfig),keepArrowsOnSplit:(d==null?void 0:d.keepArrowsOnSplit)??((v=u.preferences)==null?void 0:v.keepArrowsOnSplit),keepSplitMatch:(d==null?void 0:d.keepSplitMatch)??((b=u.preferences)==null?void 0:b.keepSplitMatch),splitHorizontally:(d==null?void 0:d.splitHorizontally)??((j=u.preferences)==null?void 0:j.splitHorizontally),splitNodeGap:(d==null?void 0:d.splitNodeGap)??((S=u.preferences)==null?void 0:S.splitNodeGap),borderButton:(d==null?void 0:d.borderButton)??((C=u.preferences)==null?void 0:C.borderButton),arrowStyleButton:(d==null?void 0:d.arrowStyleButton)??((N=u.preferences)==null?void 0:N.arrowStyleButton),arrangeButton:(d==null?void 0:d.arrangeButton)??((A=u.preferences)==null?void 0:A.arrangeButton),segmentedButtons:(d==null?void 0:d.segmentedButtons)??((I=u.preferences)==null?void 0:I.segmentedButtons),projectsManagerSearch:(d==null?void 0:d.projectsManagerSearch)??((k=u.preferences)==null?void 0:k.projectsManagerSearch),recentCanvases:(d==null?void 0:d.recentCanvases)??((P=u.preferences)==null?void 0:P.recentCanvases),goToSymbolSearch:(d==null?void 0:d.goToSymbolSearch)??((W=u.preferences)==null?void 0:W.goToSymbolSearch),openTabs:(d==null?void 0:d.openTabs)??((R=u.preferences)==null?void 0:R.openTabs)};return{...u,state:{projects:a,activeProjectId:l??null,nodes:void 0,arrows:void 0,selectedArrows:void 0},preferences:f,actions:{...u.actions,sequencePresets:(p==null?void 0:p.sequencePresets)??((F=u.actions)==null?void 0:F.sequencePresets),history:(p==null?void 0:p.history)??((L=u.actions)==null?void 0:L.history),historySelection:(p==null?void 0:p.historySelection)??((T=u.actions)==null?void 0:T.historySelection)},uiState:{...u.uiState,dragInfo:null,resizingNode:null,temporaryArrow:null,selectionBox:null,isPanning:!1,nodeToFocusId:null}}}),console.log(`Canvas data replaced: ${i} project(s) imported.`)}else{const l=r.preferences,d=r.actions;s(p=>{var m,g,x,y,w,v,b,j,S,C,N,A,I,k,P,W,R,F,L,T,M;const u=((m=p.state)==null?void 0:m.projects)??{},f={...u};for(const[D,H]of Object.entries(a))u[D]?(c++,console.warn(`Project "${H.name}" (${D}) already exists, skipping.`)):(f[D]=H,i++);return{...p,state:{...p.state,projects:f},...l&&{preferences:{...p.preferences,splitPresets:l.splitPresets??((g=p.preferences)==null?void 0:g.splitPresets),arrangePresets:l.arrangePresets??((x=p.preferences)==null?void 0:x.arrangePresets),arrangeConfigFavorites:l.arrangeConfigFavorites??((y=p.preferences)==null?void 0:y.arrangeConfigFavorites),pinnedPaletteItems:l.pinnedPaletteItems??((w=p.preferences)==null?void 0:w.pinnedPaletteItems),canvasConfig:l.canvasConfig??((v=p.preferences)==null?void 0:v.canvasConfig),keepArrowsOnSplit:l.keepArrowsOnSplit??((b=p.preferences)==null?void 0:b.keepArrowsOnSplit),keepSplitMatch:l.keepSplitMatch??((j=p.preferences)==null?void 0:j.keepSplitMatch),splitHorizontally:l.splitHorizontally??((S=p.preferences)==null?void 0:S.splitHorizontally),splitNodeGap:l.splitNodeGap??((C=p.preferences)==null?void 0:C.splitNodeGap),borderButton:l.borderButton??((N=p.preferences)==null?void 0:N.borderButton),arrowStyleButton:l.arrowStyleButton??((A=p.preferences)==null?void 0:A.arrowStyleButton),arrangeButton:l.arrangeButton??((I=p.preferences)==null?void 0:I.arrangeButton),segmentedButtons:l.segmentedButtons??((k=p.preferences)==null?void 0:k.segmentedButtons),projectsManagerSearch:l.projectsManagerSearch??((P=p.preferences)==null?void 0:P.projectsManagerSearch),recentCanvases:l.recentCanvases??((W=p.preferences)==null?void 0:W.recentCanvases),goToSymbolSearch:l.goToSymbolSearch??((R=p.preferences)==null?void 0:R.goToSymbolSearch),openTabs:l.openTabs??((F=p.preferences)==null?void 0:F.openTabs)}},...d&&{actions:{...p.actions,sequencePresets:d.sequencePresets??((L=p.actions)==null?void 0:L.sequencePresets),history:d.history??((T=p.actions)==null?void 0:T.history),historySelection:d.historySelection??((M=p.actions)==null?void 0:M.historySelection)}}}}),console.log(`Canvas data merged: ${i} project(s) imported, ${c} skipped.`)}return{projectsImported:i,projectsSkipped:c}}catch(r){return console.error("Failed to import canvas project data:",r),{projectsImported:0,projectsSkipped:0}}},Hx=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:a,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Date().toISOString(),u=d.map(f=>({...f,id:Uc(f.id),createdAt:p,updatedAt:p,isSelected:!1,isEditing:!1}));s(J(f=>{var g,x,y,w,v,b;const m=(b=(v=(w=(y=(x=(g=f.state)==null?void 0:g.projects)==null?void 0:x[r])==null?void 0:y.workspaces)==null?void 0:w[a])==null?void 0:v.canvases)==null?void 0:b[i];m!=null&&m.coreState&&(m.coreState.nodes.push(...u),m.lastModified=Date.now())}))},Gx=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:a,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Set(n),u=new Date().toISOString();s(J(f=>{var j,S,C,N,A,I,k,P,W,R,F;const m=(j=f.state)==null?void 0:j.activeProjectId;if(!m)return;const g=(C=(S=f.state)==null?void 0:S.projects)==null?void 0:C[m];if(!g)return;const x=g.activeWorkspaceId;if(!x)return;const y=(N=g.workspaces)==null?void 0:N[x];if(!y)return;const w=y.activeCanvasId;if(!w)return;const v=(A=y.canvases)==null?void 0:A[w];v!=null&&v.coreState&&(v.coreState.nodes=v.coreState.nodes.filter(L=>!p.has(L.id)),v.coreState.selectedNodes=[],v.coreState.arrows=v.coreState.arrows.filter(L=>!(L.startNodeId&&p.has(L.startNodeId)||L.endNodeId&&p.has(L.endNodeId))),v.lastModified=Date.now());const b=(F=(R=(W=(P=(k=(I=f.state)==null?void 0:I.projects)==null?void 0:k[r])==null?void 0:P.workspaces)==null?void 0:W[a])==null?void 0:R.canvases)==null?void 0:F[i];if(b!=null&&b.coreState){const L=d.map(T=>({...T,updatedAt:u,isSelected:!1,isEditing:!1}));b.coreState.nodes.push(...L),b.lastModified=Date.now()}}))},qx=(s,e)=>({exportCanvasData:()=>$x(s),exportSingleCanvas:t=>Ux(s)(t),exportSingleWorkspace:t=>Bx(s)(t),exportSingleProject:t=>Wx(s)(t),importCanvasData:(t,n)=>zx(e,t,n),copyNodesToCanvas:t=>Hx(e,s,t),moveNodesToCanvas:t=>Gx(e,s,t)}),Vx=(s,e,t)=>{const n=Pe(10),r=Date.now(),a=Pe(10),i={id:a,name:"Default Canvas",createdAt:r,lastModified:r,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},c=Pe(10),l={id:c,name:"Default Workspace",createdAt:r,lastModified:r,canvases:{[a]:i},activeCanvasId:a},d={id:n,name:t||"New Project",createdAt:r,lastModified:r,workspaces:{[c]:l},activeWorkspaceId:c};return s(J(p=>{p.state||(p.state={projects:{},activeProjectId:null}),p.state.projects[n]=d,p.state.activeProjectId=n})),n},Kx=(s,e,t)=>{s(J(n=>{var r;(r=n.state)!=null&&r.projects[t]?n.state.activeProjectId=t:console.warn(`Project with ID ${t} not found.`)}))},Jx=(s,e,t)=>{s(J(n=>{var r;if((r=n.state)!=null&&r.projects[t]&&(delete n.state.projects[t],n.state.activeProjectId===t)){const a=Object.keys(n.state.projects);n.state.activeProjectId=a.length>0?a[0]:null}}))},Yx=(s,e,t,n)=>{s(J(r=>{var i;const a=(i=r.state)==null?void 0:i.projects[t];a&&(n.name!==void 0&&(a.name=n.name),n.hideFromSearch!==void 0&&(a.hideFromSearch=n.hideFromSearch),a.lastModified=n.lastModified??Date.now())}))},Gc=s=>{const e=s().state;if(!e)return null;const{projects:t,activeProjectId:n}=e;return n?t[n]??null:null},Xx=(s,e)=>({create:t=>Vx(s,e,t),switch:t=>Kx(s,e,t),delete:t=>Jx(s,e,t),updateMetadata:(t,n)=>Yx(s,e,t,n),getActive:()=>Gc(e)}),Qx=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId;if(!n)return null;const r=Pe(10),a=Date.now(),i=Pe(10),c={id:i,name:"Default Canvas",createdAt:a,lastModified:a,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},l={id:r,name:t||"New Workspace",createdAt:a,lastModified:a,canvases:{[i]:c},activeCanvasId:i};return s(J(p=>{var f;const u=(f=p.state)==null?void 0:f.projects[n];u&&(u.workspaces[r]=l,u.activeWorkspaceId=r,u.lastModified=a)})),r},Zx=(s,e,t)=>{s(J(n=>{var a;const r=(a=n.state)!=null&&a.activeProjectId?n.state.projects[n.state.activeProjectId]:null;r&&r.workspaces[t]?(r.activeWorkspaceId=t,r.lastModified=Date.now()):console.warn(`Workspace with ID ${t} not found in active project.`)}))},ev=(s,e,t)=>{s(J(n=>{var a;const r=(a=n.state)!=null&&a.activeProjectId?n.state.projects[n.state.activeProjectId]:null;if(r&&r.workspaces[t]&&(delete r.workspaces[t],r.lastModified=Date.now(),r.activeWorkspaceId===t)){const i=Object.keys(r.workspaces);r.activeWorkspaceId=i.length>0?i[0]:null}}))},tv=(s,e,t,n)=>{s(J(r=>{var c;const a=(c=r.state)!=null&&c.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a?a.workspaces[t]:null;if(i){n.name!==void 0&&(i.name=n.name),n.hideFromSearch!==void 0&&(i.hideFromSearch=n.hideFromSearch);const l=n.lastModified??Date.now();i.lastModified=l,a&&(a.lastModified=l)}}))},Na=s=>{const e=Gc(s);return e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]??null:null},sv=(s,e)=>({create:t=>Qx(s,e,t),switch:t=>Zx(s,e,t),delete:t=>ev(s,e,t),updateMetadata:(t,n)=>tv(s,e,t,n),getActive:()=>Na(e)}),nv={CanvasStateV2:!1,useSelectionHandler:!1,useArrowDrawingV2:!1,useDrawingV2:!1,useCanvasKeyboardEventsV2:!1,useCanvasMouseEventsV2:!1,WriteModeHandlerV2:!1},Eo=10,rv=(s,e)=>{const t=s.replace(/\s*\(\d+\)$/,"");if(!e.includes(t)&&s!==t)return t;const n=new RegExp(`^${av(t)}\\s*\\((\\d+)\\)$`),r=e.map(c=>{const l=c.match(n);return l?parseInt(l[1],10):0}).filter(c=>c>0),a=e.includes(t);let i=1;return(a||r.length>0)&&(i=Math.max(0,...r)+1),`${t} (${i})`},av=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),ov=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId,r=Na(e),a=r==null?void 0:r.id;if(!n||!a)return null;const i=Pe(10),c=Date.now(),l={id:i,name:t||"New Canvas",createdAt:c,lastModified:c,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}};return s(J(p=>{var m;const u=(m=p.state)==null?void 0:m.projects[n],f=u==null?void 0:u.workspaces[a];f&&(f.canvases[i]=l,f.activeCanvasId=i,f.lastModified=c,u&&(u.lastModified=c))})),i},iv=(s,e,t)=>{s(J(n=>{if(!n.state)return;let r=null,a=null;for(const[p,u]of Object.entries(n.state.projects)){for(const[f,m]of Object.entries(u.workspaces))if(m.canvases[t]){r=p,a=f;break}if(r)break}if(!r||!a){console.warn(`Canvas with ID ${t} not found in any workspace.`);return}const i=Date.now();n.state.activeProjectId!==r&&(n.state.activeProjectId=r);const c=n.state.projects[r];if(!c)return;c.activeWorkspaceId!==a&&(c.activeWorkspaceId=a);const l=c.workspaces[a];if(!l)return;l.activeCanvasId=t,l.lastModified=i,c.lastModified=i;const d=l.canvases[t];if(d){n.preferences||(n.preferences={}),n.preferences.recentCanvases||(n.preferences.recentCanvases=[]);const p={projectId:r,workspaceId:a,canvasId:t,canvasName:d.name,projectName:c.name,workspaceName:l.name,visitedAt:i};if(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(f=>f.canvasId!==t),n.preferences.recentCanvases.unshift(p),n.preferences.recentCanvases.length>Eo&&(n.preferences.recentCanvases=n.preferences.recentCanvases.slice(0,Eo)),n.preferences.openTabs||(n.preferences.openTabs=[]),!n.preferences.openTabs.some(f=>f.canvasId===t)){const f={canvasId:t,projectId:r,workspaceId:a};n.preferences.openTabs.push(f)}}}))},cv=(s,e,t)=>{s(J(n=>{var i,c;const r=(i=n.state)!=null&&i.activeProjectId?n.state.projects[n.state.activeProjectId]:null,a=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null;if(a&&a.canvases[t]){delete a.canvases[t];const l=Date.now();if(a.lastModified=l,r&&(r.lastModified=l),a.activeCanvasId===t){const d=Object.keys(a.canvases);a.activeCanvasId=d.length>0?d[0]:null}}(c=n.preferences)!=null&&c.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(l=>l.canvasId!==t))}))},lv=(s,e,t,n)=>{s(J(r=>{var l;const a=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i?i.canvases[t]:null;if(c){n.name!==void 0&&(c.name=n.name),n.hideFromSearch!==void 0&&(c.hideFromSearch=n.hideFromSearch);const d=n.lastModified??Date.now();c.lastModified=d,i&&(i.lastModified=d),a&&(a.lastModified=d)}}))},dv=(s,e,t,n,r)=>{const a=e().state;if(!a)return null;const i=a.projects[n];if(!i)return null;const c=i.workspaces[r];if(!c)return null;const l=c.canvases[t];if(!l)return null;const d=Object.values(c.canvases).map(g=>g.name),p=rv(l.name,d),u=Pe(10),f=Date.now(),m={id:u,name:p,createdAt:f,lastModified:f,coreState:{nodes:l.coreState.nodes.map(g=>({...g})),arrows:l.coreState.arrows.map(g=>({...g})),selectedNodes:[],selectedArrows:[],layers:(l.coreState.layers??[]).map(g=>({...g})),activeLayerId:l.coreState.activeLayerId??null},viewState:{offset:{...l.viewState.offset},scale:l.viewState.scale}};return s(J(g=>{var w;const x=(w=g.state)==null?void 0:w.projects[n],y=x==null?void 0:x.workspaces[r];y&&(y.canvases[u]=m,y.activeCanvasId=u,y.lastModified=f,x&&(x.lastModified=f))})),u},uv=(s,e,t)=>{s(J(n=>{var r;(r=n.preferences)!=null&&r.recentCanvases&&(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(a=>a.canvasId!==t))}))},pv=s=>{const e=Na(s),t=e&&e.activeCanvasId?e.canvases[e.activeCanvasId]??null:null;return window.activeCanvas=t,t},hv=(s,e)=>({create:t=>ov(s,e,t),switch:t=>iv(s,e,t),delete:t=>cv(s,e,t),duplicate:(t,n,r)=>dv(s,e,t,n,r),updateMetadata:(t,n)=>lv(s,e,t,n),getActive:()=>pv(e),removeRecentCanvas:t=>uv(s,e,t)});class fv{constructor(e,t=!1){Q(this,"enabled");Q(this,"name");this.name=e,this.enabled=t}setEnabled(e){this.enabled=e}formatMessage(e){return[`[${this.name}]`,...e]}log(...e){this.enabled&&console.log(...this.formatMessage(e))}warn(...e){this.enabled&&console.warn(...this.formatMessage(e))}error(...e){this.enabled&&console.error(...this.formatMessage(e))}}const mv=(s,e,t,n)=>{const r=t/2-s.x*e,a=n/2-s.y*e;return{x:r,y:a}},gv=(s,e)=>{const t=e.find(i=>i.id===s.startNodeId),n=e.find(i=>i.id===s.endNodeId),r=t?So(t):s.startPoint,a=n?So(n):s.endPoint;return{x:(r.x+a.x)/2,y:(r.y+a.y)/2}},xv=(s,e,t,n=500)=>{const{uiState:r,projectCanvas:a,setActiveCanvasViewState:i}=e(),c=a.getActive();if(!c){console.warn("Cannot center view: No active canvas.");return}const l=c.coreState.arrows,d=c.coreState.nodes,p=c.viewState.scale,u=r==null?void 0:r.canvasWidth,f=r==null?void 0:r.canvasHeight,m=typeof t=="string"?l==null?void 0:l.find(y=>y.id===t):t;if(!m){console.warn("Cannot center view: Arrow not found.");return}if(!u||!f){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=gv(m,d),x=mv(g,p,u,f);i(y=>({...y,targetView:{targetOffset:x,targetScale:p,animationStartTime:performance.now(),animationDuration:n}}))},hn=20,ko=40;function vv(s){if(s.length===0)return{x:0,y:0,width:100,height:100};let e=1/0,t=1/0,n=-1/0,r=-1/0;return s.forEach(a=>{e=Math.min(e,a.x),t=Math.min(t,a.y),n=Math.max(n,a.x+(a.width??100)),r=Math.max(r,a.y+(a.height??50))}),{x:e-hn,y:t-hn-ko,width:n-e+hn*2,height:r-t+hn*2+ko}}function As(s){return s.type===He.GROUP}function Ea(s){if(As(s))return s.data}const wv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const a=r.coreState.selectedNodes;if(a.length<2)return null;const i=Pe(10),c=vv(a),l=a.map(m=>m.id),d=r.coreState.nodes.filter(As),p=t||`Group ${d.length+1}`,u=new Date().toISOString(),f={id:i,type:He.GROUP,x:c.x,y:c.y,width:c.width,height:c.height,title:p,data:{childNodeIds:l},createdAt:u,updatedAt:u};return s(J(m=>{if(!m.state)return;const g=m.state.activeProjectId?m.state.projects[m.state.activeProjectId]:null,x=g&&g.activeWorkspaceId?g.workspaces[g.activeWorkspaceId]:null,y=x&&x.activeCanvasId?x.canvases[x.activeCanvasId]:null;if(!y)return;y.coreState.nodes.push(f),y.coreState.nodes=y.coreState.nodes.map(v=>l.includes(v.id)?{...v,groupId:i}:v),y.coreState.selectedNodes=[f];const w=Date.now();y.lastModified=w,x&&(x.lastModified=w),g&&(g.lastModified=w)})),i},bv=(s,e,t)=>{s(J(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,a=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=a&&a.activeCanvasId?a.canvases[a.activeCanvasId]:null;if(!i)return;const c=i.coreState.nodes.findIndex(m=>m.id===t&&As(m));if(c===-1)return;const l=i.coreState.nodes[c],d=Ea(l),p=(d==null?void 0:d.childNodeIds)??[];i.coreState.nodes=i.coreState.nodes.map(m=>{if(m.groupId===t){const{groupId:g,...x}=m;return x}return m});const u=i.coreState.nodes.filter(m=>p.includes(m.id));i.coreState.nodes.splice(c,1),i.coreState.selectedNodes=u;const f=Date.now();i.lastModified=f,a&&(a.lastModified=f),r&&(r.lastModified=f)}))},yv=(s,e,t,n)=>{var c;const r=e().getNodeById(t),a=r==null?void 0:r.data,i=(c=a==null?void 0:a.automation)==null?void 0:c.onEnter;if(s(J(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=u.coreState.nodes.findIndex(w=>w.id===t&&As(w));if(f===-1)return;const m=u.coreState.nodes[f],g=Ea(m)??{childNodeIds:[]},x=new Set([...g.childNodeIds,...n]);g.childNodeIds=Array.from(x),m.data=g,u.coreState.nodes=u.coreState.nodes.map(w=>n.includes(w.id)?{...w,groupId:t}:w),m.updatedAt=new Date().toISOString();const y=Date.now();u.lastModified=y,p&&(p.lastModified=y),d&&(d.lastModified=y)})),i!=null&&i.enabled&&i.tags.length>0)for(const l of n)for(const d of i.tags)e().addTagToNode(l,{id:Pe(8),title:d})},Sv=(s,e,t)=>{var r;const n=new Map;for(const a of t){const i=e().getNodeById(a);if(i!=null&&i.groupId){const c=e().getNodeById(i.groupId),l=c==null?void 0:c.data,d=(r=l==null?void 0:l.automation)==null?void 0:r.onLeave;d!=null&&d.enabled&&d.tags.length>0&&n.set(a,{groupId:i.groupId,onLeaveTags:d.tags})}}s(J(a=>{if(!a.state)return;const i=a.state.activeProjectId?a.state.projects[a.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=new Set;l.coreState.nodes.forEach(u=>{t.includes(u.id)&&u.groupId&&d.add(u.groupId)}),l.coreState.nodes=l.coreState.nodes.map(u=>{if(t.includes(u.id)&&u.groupId){const{groupId:f,...m}=u;return m}return u}),d.forEach(u=>{const f=l.coreState.nodes.findIndex(x=>x.id===u&&As(x));if(f===-1)return;const m=l.coreState.nodes[f],g=Ea(m);g&&(g.childNodeIds=g.childNodeIds.filter(x=>!t.includes(x)),m.data=g,m.updatedAt=new Date().toISOString())});const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}));for(const[a,{onLeaveTags:i}]of n){const c=e().getNodeById(a);if(c!=null&&c.tags)for(const l of i){const d=c.tags.find(p=>p.title===l);d&&e().removeTagFromNode(a,d.id)}}},Cv=(s,e,t)=>{s(J(n=>{n.uiState.activeGroupId=t}))},jv=(s,e)=>{const t=s().projectCanvas.getActive();return t?t.coreState.nodes.find(r=>r.id===e&&As(r))??null:null},Nv=(s,e)=>({createFromSelected:t=>wv(s,e,t),ungroup:t=>bv(s,e,t),addNodesToGroup:(t,n)=>yv(s,e,t,n),removeNodesFromGroup:t=>Sv(s,e,t),setActiveGroupId:t=>Cv(s,e,t),getById:t=>jv(e,t)}),Ev=33,Io=24;function qc(s){return s===He.TABLE}function Vc(s){const e=s;return!(e!=null&&e.columns)||!Array.isArray(e.columns)?null:e}const kv=(s,e,t,n,r)=>{let a=!1;return s(J(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=d.coreState.nodes.findIndex(S=>S.id===t&&qc(S.type));if(p===-1)return;const u=d.coreState.nodes[p],f=Vc(u.data);if(!f)return;const m={id:`row-${Date.now()}`};f.columns.forEach(S=>{m[S.key]=S.key===n?r:""}),f.rows.push(m),u.data=f,u.updatedAt=new Date().toISOString();const g=f.columns.find(S=>S.key===n);let x=150;if(g!=null&&g.width){const S=parseInt(g.width,10);isNaN(S)||(x=S)}const y=x-Io,w=Un(r,y),v=Math.max(Ev,w+Io),b=u.height??250;u.height=b+v;const j=Date.now();d.lastModified=j,l&&(l.lastModified=j),c&&(c.lastModified=j),a=!0})),a},Iv=(s,e,t,n,r,a)=>{let i=!1;return s(J(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;if(!p)return;const u=p.coreState.nodes.findIndex(y=>y.id===t&&qc(y.type));if(u===-1)return;const f=p.coreState.nodes[u],m=Vc(f.data);if(!m)return;const g=m.rows.findIndex(y=>y.id===n);if(g===-1)return;m.rows[g][r]=a,f.data=m,f.updatedAt=new Date().toISOString();const x=Date.now();p.lastModified=x,d&&(d.lastModified=x),l&&(l.lastModified=x),i=!0})),i},Tv=(s,e)=>({addRowFromDrop:(t,n,r)=>kv(s,e,t,n,r),updateCellFromDrop:(t,n,r,a)=>Iv(s,e,t,n,r,a)}),is="default-layer",Av="Layer 1";function Pv(s=is,e=Av){const t=new Date().toISOString();return{id:s,name:e,order:0,isVisible:!0,opacity:100,isLocked:!1,createdAt:t,updatedAt:t}}function Kc(s){return[...s].sort((e,t)=>e.order-t.order)}function ka(s){return s.length===0?-1:Math.max(...s.map(e=>e.order))}function zn(s){return s.length===0?[Pv()]:s}const Rv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const a=zn(r.coreState.layers??[]),i=ka(a),c=Pe(10),l=t||`Layer ${a.length+1}`,d=new Date().toISOString(),p={id:c,name:l,order:i+1,isVisible:!0,opacity:100,isLocked:!1,createdAt:d,updatedAt:d};return s(J(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=zn(g.coreState.layers??[]),g.coreState.layers.push(p),g.coreState.activeLayerId=c;const x=Date.now();g.lastModified=x,m&&(m.lastModified=x),f&&(f.lastModified=x)})),c},Dv=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||(r.coreState.layers??[]).length<=1||s(J(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=Kc(d.coreState.layers??[]),u=p.findIndex(g=>g.id===t);if(u===-1)return;let f;u>0?f=p[u-1].id:p.length>1&&(f=p[1].id),f&&(d.coreState.nodes=d.coreState.nodes.map(g=>(g.layerId??is)===t?{...g,layerId:f}:g)),d.coreState.layers=d.coreState.layers.filter(g=>g.id!==t),d.coreState.activeLayerId===t&&(d.coreState.activeLayerId=f??null);const m=Date.now();d.lastModified=m,l&&(l.lastModified=m),c&&(c.lastModified=m)}))},Ov=(s,e,t,n)=>{s(J(r=>{var p;if(!r.state)return;const a=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.name=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),a&&(a.lastModified=d)}))},Lv=(s,e,t,n)=>{s(J(r=>{var p;if(!r.state)return;const a=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isVisible=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),a&&(a.lastModified=d)}))},_v=(s,e,t,n)=>{const r=Math.max(0,Math.min(100,n));s(J(a=>{var u;if(!a.state)return;const i=a.state.activeProjectId?a.state.projects[a.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=(u=l.coreState.layers)==null?void 0:u.find(f=>f.id===t);if(!d)return;d.opacity=r,d.updatedAt=new Date().toISOString();const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}))},Mv=(s,e,t,n)=>{s(J(r=>{var p;if(!r.state)return;const a=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isLocked=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),a&&(a.lastModified=d)}))},Fv=(s,e,t,n)=>{s(J(r=>{var u,f;if(!r.state)return;const a=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(u=c.coreState.layers)==null?void 0:u.find(m=>m.id===t);if(!l)return;const d=l.order;l.order=n,(f=c.coreState.layers)==null||f.forEach(m=>{m.id!==t&&(n>d?m.order>d&&m.order<=n&&m.order--:m.order>=n&&m.order<d&&m.order++)}),l.updatedAt=new Date().toISOString();const p=Date.now();c.lastModified=p,i&&(i.lastModified=p),a&&(a.lastModified=p)}))},$v=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const a=r.coreState.layers??[],i=a.find(d=>d.id===t);if(!i)return;const c=ka(a);if(i.order>=c)return;const l=a.find(d=>d.order===i.order+1);l&&s(J(d=>{var w,v;if(!d.state)return;const p=d.state.activeProjectId?d.state.projects[d.state.activeProjectId]:null,u=p&&p.activeWorkspaceId?p.workspaces[p.activeWorkspaceId]:null,f=u&&u.activeCanvasId?u.canvases[u.activeCanvasId]:null;if(!f)return;const m=(w=f.coreState.layers)==null?void 0:w.find(b=>b.id===t),g=(v=f.coreState.layers)==null?void 0:v.find(b=>b.id===l.id);if(!m||!g)return;const x=new Date().toISOString();g.order=m.order,m.order=m.order+1,m.updatedAt=x,g.updatedAt=x;const y=Date.now();f.lastModified=y,u&&(u.lastModified=y),p&&(p.lastModified=y)}))},Uv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const a=r.coreState.layers??[],i=a.find(l=>l.id===t);if(!i||i.order<=0)return;const c=a.find(l=>l.order===i.order-1);c&&s(J(l=>{var y,w;if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=(y=u.coreState.layers)==null?void 0:y.find(v=>v.id===t),m=(w=u.coreState.layers)==null?void 0:w.find(v=>v.id===c.id);if(!f||!m)return;const g=new Date().toISOString();m.order=f.order,f.order=f.order-1,f.updatedAt=g,m.updatedAt=g;const x=Date.now();u.lastModified=x,p&&(p.lastModified=x),d&&(d.lastModified=x)}))},Bv=(s,e,t)=>{s(J(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,a=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=a&&a.activeCanvasId?a.canvases[a.activeCanvasId]:null;if(!i)return;i.coreState.activeLayerId=t;const c=Date.now();i.lastModified=c,a&&(a.lastModified=c),r&&(r.lastModified=c)}))},Wv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;let a=r.coreState.layers??[];if(a.length===0&&t===is){const u=Pe(10),f=new Date().toISOString(),m={id:u,name:"Layer 1 (Copy)",order:1,isVisible:!0,opacity:100,isLocked:!1,createdAt:f,updatedAt:f};return s(J(g=>{if(!g.state)return;const x=g.state.activeProjectId?g.state.projects[g.state.activeProjectId]:null,y=x&&x.activeWorkspaceId?x.workspaces[x.activeWorkspaceId]:null,w=y&&y.activeCanvasId?y.canvases[y.activeCanvasId]:null;if(!w)return;w.coreState.layers=zn(w.coreState.layers??[]),w.coreState.layers.push(m);const b=w.coreState.nodes.filter(S=>!S.layerId||S.layerId===is).map(S=>({...S,id:Pe(10),layerId:u,createdAt:f,updatedAt:f}));w.coreState.nodes=[...w.coreState.nodes,...b],w.coreState.activeLayerId=u;const j=Date.now();w.lastModified=j,y&&(y.lastModified=j),x&&(x.lastModified=j)})),u}const i=a.find(u=>u.id===t);if(!i)return null;const c=ka(a),l=Pe(10),d=new Date().toISOString(),p={id:l,name:`${i.name} (Copy)`,order:c+1,isVisible:i.isVisible,opacity:i.opacity,isLocked:!1,createdAt:d,updatedAt:d};return s(J(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=zn(g.coreState.layers??[]),g.coreState.layers.push(p);const y=g.coreState.nodes.filter(v=>(v.layerId??is)===t).map(v=>({...v,id:Pe(10),layerId:l,createdAt:d,updatedAt:d}));g.coreState.nodes=[...g.coreState.nodes,...y],g.coreState.activeLayerId=l;const w=Date.now();g.lastModified=w,m&&(m.lastModified=w),f&&(f.lastModified=w)})),l},zv=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const a=r.coreState.layers??[],i=a.find(l=>l.id===t);if(!i)return;const c=a.find(l=>l.order===i.order-1);c&&s(J(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;u.coreState.nodes=u.coreState.nodes.map(m=>(m.layerId??is)===t?{...m,layerId:c.id}:m),u.coreState.layers=u.coreState.layers.filter(m=>m.id!==t),u.coreState.layers.forEach(m=>{m.order>i.order&&m.order--}),u.coreState.activeLayerId===t&&(u.coreState.activeLayerId=c.id);const f=Date.now();u.lastModified=f,p&&(p.lastModified=f),d&&(d.lastModified=f)}))},Hv=(s,e,t,n)=>{s(J(r=>{var p;if(!r.state)return;const a=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c||!((p=c.coreState.layers)==null?void 0:p.find(u=>u.id===n))&&n!==is)return;c.coreState.nodes=c.coreState.nodes.map(u=>t.includes(u.id)?{...u,layerId:n}:u);const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),a&&(a.lastModified=d)}))},Gv=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.coreState.layers)==null?void 0:n.find(r=>r.id===e))??null:null},qv=s=>{const e=s().projectCanvas.getActive();return e?Kc(e.coreState.layers??[]):[]},Vv=s=>{var n;const e=s().projectCanvas.getActive();if(!e)return null;const t=e.coreState.activeLayerId;return t?((n=e.coreState.layers)==null?void 0:n.find(r=>r.id===t))??null:null},Kv=(s,e)=>({create:t=>Rv(s,e,t),delete:t=>Dv(s,e,t),rename:(t,n)=>Ov(s,e,t,n),duplicate:t=>Wv(s,e,t),setVisibility:(t,n)=>Lv(s,e,t,n),setOpacity:(t,n)=>_v(s,e,t,n),setLocked:(t,n)=>Mv(s,e,t,n),reorder:(t,n)=>Fv(s,e,t,n),moveUp:t=>$v(s,e,t),moveDown:t=>Uv(s,e,t),setActive:t=>Bv(s,e,t),mergeDown:t=>zv(s,e,t),moveNodesToLayer:(t,n)=>Hv(s,e,t,n),getById:t=>Gv(e,t),getAll:()=>qv(e),getActive:()=>Vv(e)});function Jv(s,e,t){const n=new Date().toISOString();return{id:s,name:e,nodePositions:[],groupNodes:[],filterConfig:t,createdAt:n,updatedAt:n}}function jt(s){if(!s.state)return{project:null,workspace:null,canvas:null};const e=s.state.activeProjectId?s.state.projects[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]:null,n=t&&t.activeCanvasId?t.canvases[t.activeCanvasId]:null;return{project:e,workspace:t,canvas:n}}function Nt(s,e,t){const n=Date.now();s&&(s.lastModified=n),e&&(e.lastModified=n),t&&(t.lastModified=n)}const Yv=(s,e,t,n)=>{const a=e().projectCanvas.getActive();if(!a)return null;const i=Pe(10),c=Jv(i,t,n);return c.nodePositions=a.coreState.nodes.map(l=>({nodeId:l.id,x:l.x,y:l.y})),s(J(l=>{const{project:d,workspace:p,canvas:u}=jt(l);u&&(u.viewLayers||(u.viewLayers=[]),u.viewLayers.push(c),u.activeViewLayerId=i,Nt(u,p,d))})),i},Xv=(s,e,t)=>{e().projectCanvas.getActive()&&s(J(a=>{const{project:i,workspace:c,canvas:l}=jt(a);!l||!l.viewLayers||(l.viewLayers=l.viewLayers.filter(d=>d.id!==t),l.activeViewLayerId===t&&(l.activeViewLayerId=null),Nt(l,c,i))}))},Qv=(s,e,t,n)=>{s(J(r=>{const{project:a,workspace:i,canvas:c}=jt(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.name=n,l.updatedAt=new Date().toISOString(),Nt(c,i,a))}))},Zv=(s,e,t)=>{var d;const r=e().projectCanvas.getActive();if(!r)return null;const a=(d=r.viewLayers)==null?void 0:d.find(p=>p.id===t);if(!a)return null;const i=Pe(10),c=new Date().toISOString(),l={...a,id:i,name:`${a.name} (Copy)`,nodePositions:[...a.nodePositions],groupNodes:a.groupNodes.map(p=>({...p,id:Pe(10)})),createdAt:c,updatedAt:c};return s(J(p=>{const{project:u,workspace:f,canvas:m}=jt(p);m&&(m.viewLayers||(m.viewLayers=[]),m.viewLayers.push(l),m.activeViewLayerId=i,Nt(m,f,u))})),i},ew=(s,e,t)=>{s(J(n=>{const{project:r,workspace:a,canvas:i}=jt(n);i&&(i.activeViewLayerId=t,Nt(i,a,r))}))},tw=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(J(c=>{const{project:l,workspace:d,canvas:p}=jt(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;const f=u.nodePositions.find(m=>m.nodeId===t);f?(f.x=n,f.y=r):u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Nt(p,d,l)}))},sw=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||!r.activeViewLayerId||s(J(a=>{const{project:i,workspace:c,canvas:l}=jt(a);if(!l||!l.viewLayers||!l.activeViewLayerId)return;const d=l.viewLayers.find(u=>u.id===l.activeViewLayerId);if(!d)return;const p=new Map(d.nodePositions.map((u,f)=>[u.nodeId,f]));for(const u of t){const f=p.get(u.id);f!==void 0?(d.nodePositions[f].x=u.x,d.nodePositions[f].y=u.y):d.nodePositions.push({nodeId:u.id,x:u.x,y:u.y})}d.updatedAt=new Date().toISOString(),Nt(l,c,i)}))},nw=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(J(c=>{const{project:l,workspace:d,canvas:p}=jt(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;u.nodePositions.some(m=>m.nodeId===t)||(u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Nt(p,d,l))}))},rw=(s,e,t)=>{s(J(n=>{const{project:r,workspace:a,canvas:i}=jt(n);if(!i||!i.viewLayers)return;let c=!1;for(const l of i.viewLayers){const d=l.nodePositions.length;l.nodePositions=l.nodePositions.filter(p=>p.nodeId!==t);for(const p of l.groupNodes)p.childNodeIds=p.childNodeIds.filter(u=>u!==t);l.nodePositions.length!==d&&(l.updatedAt=new Date().toISOString(),c=!0)}c&&Nt(i,a,r)}))},aw=(s,e,t,n)=>{s(J(r=>{const{project:a,workspace:i,canvas:c}=jt(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes.push(n),l.updatedAt=new Date().toISOString(),Nt(c,i,a))}))},ow=(s,e,t,n,r)=>{s(J(a=>{const{project:i,workspace:c,canvas:l}=jt(a);if(!l||!l.viewLayers)return;const d=l.viewLayers.find(u=>u.id===t);if(!d)return;const p=d.groupNodes.find(u=>u.id===n);p&&(Object.assign(p,r),d.updatedAt=new Date().toISOString(),Nt(l,c,i))}))},iw=(s,e,t,n)=>{s(J(r=>{const{project:a,workspace:i,canvas:c}=jt(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes=l.groupNodes.filter(d=>d.id!==n),l.updatedAt=new Date().toISOString(),Nt(c,i,a))}))},cw=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.viewLayers)==null?void 0:n.find(r=>r.id===e))??null:null},lw=s=>{const e=s().projectCanvas.getActive();return e?e.viewLayers??[]:[]},dw=s=>{var t;const e=s().projectCanvas.getActive();return!e||!e.activeViewLayerId?null:((t=e.viewLayers)==null?void 0:t.find(n=>n.id===e.activeViewLayerId))??null},uw=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.activeViewLayerId)??null},pw=(s,e)=>{const t=s().projectCanvas.getActive();return(t==null?void 0:t.activeViewLayerId)===e},hw=(s,e)=>{var a;const t=s().projectCanvas.getActive();if(!t||!t.activeViewLayerId)return null;const n=(a=t.viewLayers)==null?void 0:a.find(i=>i.id===t.activeViewLayerId);if(!n)return null;const r=n.nodePositions.find(i=>i.nodeId===e);return r?{x:r.x,y:r.y}:null},fw=s=>{var c;const e=s().projectCanvas.getActive();if(!e)return[];const t=e.coreState.nodes;if(!e.activeViewLayerId)return t;const n=(c=e.viewLayers)==null?void 0:c.find(l=>l.id===e.activeViewLayerId);if(!n)return t;const r=new Map(n.nodePositions.map(l=>[l.nodeId,l])),a=t.map(l=>{const d=r.get(l.id);return d?{...l,x:d.x,y:d.y}:l}),i=n.groupNodes.map(l=>({id:l.id,type:He.GROUP,x:l.x,y:l.y,width:l.width,height:l.height,content:l.name,data:{childNodeIds:l.childNodeIds}}));return[...a,...i]},mw=(s,e)=>({create:(t,n)=>Yv(s,e,t,n),delete:t=>Xv(s,e,t),rename:(t,n)=>Qv(s,e,t,n),duplicate:t=>Zv(s,e,t),setActive:t=>ew(s,e,t),updateNodePosition:(t,n,r)=>tw(s,e,t,n,r),updateNodePositions:t=>sw(s,e,t),addNodeToActiveView:(t,n,r)=>nw(s,e,t,n,r),removeNodeFromAllViews:t=>rw(s,e,t),addGroupNode:(t,n)=>aw(s,e,t,n),updateGroupNode:(t,n,r)=>ow(s,e,t,n,r),removeGroupNode:(t,n)=>iw(s,e,t,n),getById:t=>cw(e,t),getAll:()=>lw(e),getActive:()=>dw(e),getActiveId:()=>uw(e),isActive:t=>pw(e,t),getEffectivePosition:t=>hw(e,t),getNodesWithEffectivePositions:()=>fw(e)});function Ps(s){return s.extensions||(s.extensions={registry:{},settings:{},runtime:{}}),s.extensions.registry||(s.extensions.registry={}),s.extensions.settings||(s.extensions.settings={}),s.extensions.runtime||(s.extensions.runtime={}),s.extensions}const gw=(s,e,t,n)=>{s(J(r=>{const a=Ps(r);a.registry[t]||(a.registry[t]={enabled:!0,installedAt:new Date().toISOString(),version:n})}))},xw=(s,e,t)=>{s(J(n=>{var a;const r=Ps(n);delete r.registry[t],delete r.settings[t],(a=r.runtime)==null||delete a[t]}))},vw=(s,e,t,n)=>{s(J(r=>{const a=Ps(r);a.registry[t]?a.registry[t].enabled=n:a.registry[t]={enabled:n,installedAt:new Date().toISOString()}}))},ww=(s,e)=>{var n,r,a;return((a=(r=(n=s().extensions)==null?void 0:n.registry)==null?void 0:r[e])==null?void 0:a.enabled)??!1},bw=(s,e)=>{var n,r;return!!((r=(n=s().extensions)==null?void 0:n.registry)!=null&&r[e])},yw=(s,e)=>{var r,a;return((a=(r=s().extensions)==null?void 0:r.settings)==null?void 0:a[e])??null},Sw=(s,e,t,n)=>{s(J(r=>{const a=Ps(r);a.settings[t]=n}))},Cw=(s,e,t,n)=>{s(J(r=>{const a=Ps(r),i=a.settings[t]??{};a.settings[t]={...i,...n}}))},jw=(s,e)=>{var r,a;return((a=(r=s().extensions)==null?void 0:r.runtime)==null?void 0:a[e])??null},Nw=(s,e,t,n)=>{s(J(r=>{const a=Ps(r);a.runtime||(a.runtime={}),a.runtime[t]=n}))},Ew=(s,e)=>({register:(t,n)=>gw(s,e,t,n),unregister:t=>xw(s,e,t),setEnabled:(t,n)=>vw(s,e,t,n),isEnabled:t=>ww(e,t),isRegistered:t=>bw(e,t),getSettings:t=>yw(e,t),setSettings:(t,n)=>Sw(s,e,t,n),updateSettings:(t,n)=>Cw(s,e,t,n),getRuntime:t=>jw(e,t),setRuntime:(t,n)=>Nw(s,e,t,n)});function lr(){return{nodes:{},current:null,root:null}}function kw(s){switch(s.type){case"node:move":return"Move node";case"node:resize":return"Resize node";case"node:create":return`Create ${s.node.type.toLowerCase()}`;case"node:delete":return`Delete ${s.node.type.toLowerCase()}`;case"node:update":return"Update node";case"batch":return s.label??`Batch (${s.operations.length} ops)`;case"arrow:create":return"Create arrow";case"arrow:delete":return"Delete arrow";case"arrow:update":return"Update arrow";case"tag:add":return"Add tag";case"tag:remove":return"Remove tag"}}function Iw(){return`hn_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}class Ia{constructor(e){Q(this,"data");this.data=e??lr()}commit(e){const t=Iw(),n={id:t,operation:e,parent:this.data.current,children:[],timestamp:Date.now(),label:kw(e)};if(this.data.nodes[t]=n,this.data.current!==null){const r=this.data.nodes[this.data.current];r&&r.children.push(t)}return this.data.root===null&&(this.data.root=t),this.data.current=t,t}undo(){if(this.data.current===null)return null;const e=this.data.nodes[this.data.current];return e?(this.data.current=e.parent,e.operation):null}redo(e){const t=this.getBranches();if(t.length===0)return null;const n=e??t.length-1,r=t[n];return r?(this.data.current=r.id,r.operation):null}getBranches(){if(this.data.current===null){if(this.data.root!==null){const t=this.data.nodes[this.data.root];return t?[t]:[]}return[]}const e=this.data.nodes[this.data.current];return e?e.children.map(t=>this.data.nodes[t]).filter(t=>t!==void 0):[]}getPath(){const e=[];let t=this.data.current;for(;t!==null;){const n=this.data.nodes[t];if(!n)break;e.unshift(n),t=n.parent}return e}getRedoPath(){const e=[];let t=this.getBranches();for(;t.length>0;){const n=t[t.length-1];e.push(n),t=n.children.map(r=>this.data.nodes[r]).filter(r=>r!==void 0)}return e}jumpTo(e){var u;if(!this.data.nodes[e])return{undo:[],redo:[]};const n=new Set(this.getPath().map(f=>f.id)),r=[];let a=e;for(;a!==null;){const f=this.data.nodes[a];if(!f||(r.unshift(f),n.has(a)))break;a=f.parent}const i=[];let c=this.data.current;const l=((u=r[0])==null?void 0:u.id)??null;for(;c!==null&&c!==l;){const f=this.data.nodes[c];if(!f)break;i.push(f.operation),c=f.parent}const d=[];let p=0;l!==null&&(p=r.findIndex(f=>f.id===l)+1);for(let f=p;f<r.length;f++)d.push(r[f].operation);return this.data.current=e,{undo:i,redo:d}}getCurrent(){return this.data.current===null?null:this.data.nodes[this.data.current]??null}getRoot(){return this.data.root===null?null:this.data.nodes[this.data.root]??null}getSize(){return Object.keys(this.data.nodes).length}canUndo(){return this.data.current!==null}canRedo(){return this.getBranches().length>0}getAllNodes(){return Object.values(this.data.nodes)}serialize(){return structuredClone(this.data)}static deserialize(e){return new Ia(structuredClone(e))}prune(e){if(this.getSize()<=e)return;const n=new Set;this.getPath().forEach(i=>n.add(i.id));const a=this.getAllNodes();a.sort((i,c)=>c.timestamp-i.timestamp);for(const i of a){if(n.size>=e)break;n.add(i.id)}for(const i of Object.keys(this.data.nodes))if(!n.has(i)){const c=this.data.nodes[i];if(c!=null&&c.parent){const l=this.data.nodes[c.parent];l&&(l.children=l.children.filter(d=>d!==i))}if(this.data.root===i){const d=Object.values(this.data.nodes).filter(p=>p.id!==i&&n.has(p.id)).find(p=>p.parent===null||!n.has(p.parent));this.data.root=(d==null?void 0:d.id)??null}delete this.data.nodes[i]}for(const i of Object.values(this.data.nodes))i.children=i.children.filter(c=>this.data.nodes[c]!==void 0)}}function Ta(s,e){switch(e.type){case"node:move":return Jc(s,e.nodeId,e.to);case"node:resize":return Yc(s,e.nodeId,e.to);case"node:create":return Xc(s,e.node);case"node:delete":return Qc(s,e.node.id,e.connectedArrows);case"node:update":return Zc(s,e.nodeId,e.to);case"arrow:create":return Kr(s,e.arrow);case"arrow:delete":return el(s,e.arrow.id);case"arrow:update":return tl(s,e.arrowId,e.to);case"batch":return e.operations.reduce((t,n)=>Ta(t,n),s);case"tag:add":return sl(s,e.nodeId,e.tag,e.autoGroup);case"tag:remove":return Tw(s,e.nodeId,e.tag.id)}}function Aa(s,e){switch(e.type){case"node:move":return Jc(s,e.nodeId,e.from);case"node:resize":return Yc(s,e.nodeId,e.from);case"node:create":return Qc(s,e.node.id);case"node:delete":let t=Xc(s,e.node);if(e.connectedArrows)for(const n of e.connectedArrows)t=Kr(t,n);return t;case"node:update":return Zc(s,e.nodeId,e.from);case"arrow:create":return el(s,e.arrow.id);case"arrow:delete":return Kr(s,e.arrow);case"arrow:update":return tl(s,e.arrowId,e.from);case"batch":return[...e.operations].reverse().reduce((n,r)=>Aa(n,r),s);case"tag:add":return Aw(s,e.nodeId,e.tag.id,e.autoGroup);case"tag:remove":return sl(s,e.nodeId,e.tag)}}function Jc(s,e,t){const n=s.nodes.map(a=>a.id===e?{...a,x:t.x,y:t.y}:a),r=s.selectedNodes.map(a=>a.id===e?{...a,x:t.x,y:t.y}:a);return{...s,nodes:n,selectedNodes:r}}function Yc(s,e,t){const n=s.nodes.map(a=>a.id===e?{...a,x:t.x,y:t.y,width:t.width,height:t.height}:a),r=s.selectedNodes.map(a=>a.id===e?{...a,x:t.x,y:t.y,width:t.width,height:t.height}:a);return{...s,nodes:n,selectedNodes:r}}function Xc(s,e){return s.nodes.some(t=>t.id===e.id)?s:{...s,nodes:[...s.nodes,e]}}function Qc(s,e,t){const n=s.nodes.filter(c=>c.id!==e),r=s.selectedNodes.filter(c=>c.id!==e),a=s.arrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e),i=s.selectedArrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e);return{...s,nodes:n,arrows:a,selectedNodes:r,selectedArrows:i}}function Zc(s,e,t){const n=s.nodes.map(a=>a.id===e?{...a,...t}:a),r=s.selectedNodes.map(a=>a.id===e?{...a,...t}:a);return{...s,nodes:n,selectedNodes:r}}function Kr(s,e){return s.arrows.some(t=>t.id===e.id)?s:{...s,arrows:[...s.arrows,e]}}function el(s,e){const t=s.arrows.filter(r=>r.id!==e),n=s.selectedArrows.filter(r=>r.id!==e);return{...s,arrows:t,selectedArrows:n}}function tl(s,e,t){const n=s.arrows.map(a=>a.id===e?{...a,...t}:a),r=s.selectedArrows.map(a=>a.id===e?{...a,...t}:a);return{...s,arrows:n,selectedArrows:r}}function sl(s,e,t,n){const r=i=>{if(i.id!==e)return i;const c=Array.isArray(i.tags)?i.tags:[];if(c.some(d=>d.id===t.id))return i;let l={...i,tags:[...c,t]};return n&&(l={...l,groupId:n.groupId}),l};let a={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(a=Pw(a,n.groupId,e)),a}function Tw(s,e,t){const n=r=>r.id!==e||!Array.isArray(r.tags)?r:{...r,tags:r.tags.filter(a=>a.id!==t)};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function Aw(s,e,t,n){const r=i=>{if(i.id!==e)return i;let c={...i,tags:Array.isArray(i.tags)?i.tags.filter(l=>l.id!==t):[]};return n&&(c={...c,x:n.previousPosition.x,y:n.previousPosition.y,groupId:n.previousGroupId}),c};let a={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(a=Rw(a,n.groupId,e)),a}function Pw(s,e,t){const n=r=>{if(r.id!==e)return r;const a=r.data??{childNodeIds:[]},i=a.childNodeIds??[];return i.includes(t)?r:{...r,data:{...a,childNodeIds:[...i,t]}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function Rw(s,e,t){const n=r=>{if(r.id!==e)return r;const a=r.data??{childNodeIds:[]},i=a.childNodeIds??[];return{...r,data:{...a,childNodeIds:i.filter(c=>c!==t)}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function To(s,e,t){return{type:"node:move",nodeId:s,from:e,to:t}}function DC(s){return s.length===1?To(s[0].nodeId,s[0].from,s[0].to):{type:"batch",operations:s.map(e=>To(e.nodeId,e.from,e.to)),label:`Move ${s.length} nodes`}}const Dw="UndoArchiveDB",Ow=2,We="archived_nodes",_t="tree_data";class Lw{constructor(){Q(this,"db",null);Q(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,t)=>{const n=indexedDB.open(Dw,Ow);n.onerror=()=>{this.initPromise=null,t(new Error("Failed to open UndoArchiveDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const a=r.target.result;if(!a.objectStoreNames.contains(We)){const i=a.createObjectStore(We,{keyPath:"id"});i.createIndex("canvasId","canvasId",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("canvasId_timestamp",["canvasId","timestamp"],{unique:!1})}a.objectStoreNames.contains(_t)||a.createObjectStore(_t,{keyPath:"canvasId"})}}),this.initPromise)}async ensureInit(){if(this.db||await this.init(),!this.db)throw new Error("Database not initialized")}async archiveNode(e,t){await this.ensureInit();const n={...t,canvasId:e};return new Promise((r,a)=>{const l=this.db.transaction([We],"readwrite").objectStore(We).put(n);l.onsuccess=()=>r(),l.onerror=()=>a(new Error("Failed to archive node"))})}async archiveNodes(e,t){if(t.length!==0)return await this.ensureInit(),new Promise((n,r)=>{const i=this.db.transaction([We],"readwrite").objectStore(We);let c=0,l=!1;for(const d of t){const p={...d,canvasId:e},u=i.put(p);u.onsuccess=()=>{c++,c===t.length&&!l&&n()},u.onerror=()=>{l||(l=!0,r(new Error("Failed to archive nodes")))}}})}async getNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([We],"readonly").objectStore(We).get(e);i.onsuccess=()=>t(i.result??null),i.onerror=()=>n(new Error("Failed to get archived node"))})}async getNodes(e){return e.length===0?[]:(await this.ensureInit(),new Promise((t,n)=>{const a=this.db.transaction([We],"readonly").objectStore(We),i=[];let c=0;for(const l of e){const d=a.get(l);d.onsuccess=()=>{d.result&&i.push(d.result),c++,c===e.length&&t(i)},d.onerror=()=>{c++,c===e.length&&t(i)}}}))}async getAllForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([We],"readonly").objectStore(We).index("canvasId").getAll(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to get archived nodes for canvas"))})}async countForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([We],"readonly").objectStore(We).index("canvasId").count(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to count archived nodes"))})}async deleteNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([We],"readwrite").objectStore(We).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete archived node"))})}async deleteNodes(e){if(e.length!==0)return await this.ensureInit(),new Promise((t,n)=>{const a=this.db.transaction([We],"readwrite").objectStore(We);let i=0;for(const c of e){const l=a.delete(c);l.onsuccess=()=>{i++,i===e.length&&t()},l.onerror=()=>{i++,i===e.length&&t()}}})}async clearForCanvas(e){await this.ensureInit();const n=(await this.getAllForCanvas(e)).map(r=>r.id);await this.deleteNodes(n)}async getOldestForCanvas(e,t){return await this.ensureInit(),new Promise((n,r)=>{const c=this.db.transaction([We],"readonly").objectStore(We).index("canvasId_timestamp"),l=IDBKeyRange.bound([e,0],[e,1/0]),d=[],p=c.openCursor(l);p.onsuccess=u=>{const f=u.target.result;f&&d.length<t?(d.push(f.value),f.continue()):n(d)},p.onerror=()=>r(new Error("Failed to get oldest archived nodes"))})}async pruneForCanvas(e,t){const n=await this.countForCanvas(e);if(n<=t)return 0;const r=n-t,i=(await this.getOldestForCanvas(e,r)).map(c=>c.id);return await this.deleteNodes(i),i.length}async countAll(){return await this.ensureInit(),new Promise((e,t)=>{const a=this.db.transaction([We],"readonly").objectStore(We).count();a.onsuccess=()=>e(a.result),a.onerror=()=>t(new Error("Failed to count all archived nodes"))})}async clearAll(){return await this.ensureInit(),new Promise((e,t)=>{const a=this.db.transaction([We],"readwrite").objectStore(We).clear();a.onsuccess=()=>e(),a.onerror=()=>t(new Error("Failed to clear all archived nodes"))})}async saveTreeData(e,t){await this.ensureInit();const n={canvasId:e,treeData:t,lastModified:Date.now()};return new Promise((r,a)=>{const l=this.db.transaction([_t],"readwrite").objectStore(_t).put(n);l.onsuccess=()=>r(),l.onerror=()=>a(new Error("Failed to save tree data"))})}async loadTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([_t],"readonly").objectStore(_t).get(e);i.onsuccess=()=>{const c=i.result;t((c==null?void 0:c.treeData)??null)},i.onerror=()=>n(new Error("Failed to load tree data"))})}async deleteTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([_t],"readwrite").objectStore(_t).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete tree data"))})}async clearAllTreeData(){return await this.ensureInit(),new Promise((e,t)=>{const a=this.db.transaction([_t],"readwrite").objectStore(_t).clear();a.onsuccess=()=>e(),a.onerror=()=>t(new Error("Failed to clear all tree data"))})}}const Pt=new Lw;function nl(){return typeof window>"u"?!1:window.innerWidth<Le.history.tabletBreakpoint}function rl(){const{archiveLimit:s,tabletArchiveLimit:e}=Le.history;return nl()?e:s}function al(){const{historyLimit:s,tabletHistoryLimit:e}=Le.history;return nl()?e:s}function _w(s){const e=new Set;let t=s.current;for(;t!==null;){e.add(t);const n=s.nodes[t];if(!n)break;t=n.parent}return e}async function Mw(s,e){const t=al(),n=Object.keys(e.nodes).length;if(n<=t)return e;const r=_w(e),a=Object.values(e.nodes);a.sort((f,m)=>f.timestamp-m.timestamp);const i=[],c=n-t;for(const f of a){if(i.length>=c)break;r.has(f.id)||i.push(f)}if(i.length===0)return e;await Pt.archiveNodes(s,i);const l=rl();await Pt.pruneForCanvas(s,l);const d=new Set(i.map(f=>f.id)),p={};for(const[f,m]of Object.entries(e.nodes))d.has(f)||(p[f]={...m,children:m.children.filter(g=>!d.has(g))});let u=e.root;if(u&&d.has(u)){const m=Object.values(p).find(g=>g.parent===null||!p[g.parent]);u=(m==null?void 0:m.id)??null}return{nodes:p,current:e.current,root:u}}function Fw(s,e){return!s.nodes[e]}async function $w(s,e,t){const n=await Pt.getNode(t);if(!n)return null;const r=new Set;r.add(t);let a=n;for(;a;){r.add(a.id);for(const d of a.children)r.add(d);if(a.parent){if(e.nodes[a.parent])break;a=await Pt.getNode(a.parent)}else a=null}const i=await Pt.getNodes(Array.from(r)),c={...e.nodes};for(const d of i)if(!c[d.id]){const{canvasId:p,...u}=d;c[d.id]=u}for(const d of i)if(d.parent&&c[d.parent]){const p=c[d.parent];p.children.includes(d.id)||(p.children=[...p.children,d.id])}let l=e.root;if(!l){const d=Object.values(c).find(p=>p.parent===null||!c[p.parent]);l=(d==null?void 0:d.id)??null}return{nodes:c,current:e.current,root:l}}async function Uw(s){return{archivedCount:await Pt.countForCanvas(s),archiveLimit:rl(),historyLimit:al()}}async function Bw(s){await Pt.clearForCanvas(s),await Pt.deleteTreeData(s)}async function Ww(){await Pt.init()}async function Hn(s,e){await Pt.saveTreeData(s,e)}async function zw(s){return Pt.loadTreeData(s)}function Hw(){return window.innerWidth<Le.history.tabletBreakpoint}function Gw(){const{historyLimit:s,tabletHistoryLimit:e}=Le.history;return Hw()?e:s}function Et(s){const e=s().projectCanvas.getActive();if(!e)return null;const t=e.undoTree??lr();return Ia.deserialize(t)}function gs(s){const e=s().state;if(!e)return null;const t=e.activeProjectId?e.projects[e.activeProjectId]:null,n=t&&t.activeWorkspaceId?t.workspaces[t.activeWorkspaceId]:null;return(n==null?void 0:n.activeCanvasId)??null}function Pa(s,e){s(J(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,a=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;a&&(a.undoTree=e.serialize())}))}const qw=(s,e,t)=>{const n=Et(e);if(!n)return;n.commit(t),Pa(s,n);const r=gs(e),a=Gw();r&&(async()=>{try{const i=n.serialize();if(await Hn(r,i),n.getSize()>a){const c=await Mw(r,i);s(J(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;u&&u.id===r&&(u.undoTree=c)})),await Hn(r,c)}}catch(i){console.warn("Failed to persist undo history:",i)}})()},Vw=(s,e)=>{const t=Et(e);if(!t||!t.canUndo())return!1;const n=t.undo();if(!n)return!1;const r=gs(e);return s(J(a=>{if(!a.state)return;const i=a.state.activeProjectId?a.state.projects[a.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;l.coreState=Aa(l.coreState,n),l.undoTree=t.serialize();const d=Date.now();l.lastModified=d,c&&(c.lastModified=d),i&&(i.lastModified=d)})),r&&Hn(r,t.serialize()).catch(a=>{console.warn("Failed to persist undo position:",a)}),!0},Kw=(s,e,t)=>{const n=Et(e);if(!n||!n.canRedo())return!1;const r=n.redo(t);if(!r)return!1;const a=gs(e);return s(J(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;d.coreState=Ta(d.coreState,r),d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),a&&Hn(a,n.serialize()).catch(i=>{console.warn("Failed to persist redo position:",i)}),!0},ol=(s,e,t)=>{const n=Et(e);if(!n)return!1;const{undo:r,redo:a}=n.jumpTo(t);return r.length===0&&a.length===0?(Pa(s,n),!0):(s(J(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;for(const u of r)d.coreState=Aa(d.coreState,u);for(const u of a)d.coreState=Ta(d.coreState,u);d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),!0)},Jw=async(s,e,t)=>{var a;const n=gs(e);if(!n)return!1;let r=(a=e().projectCanvas.getActive())==null?void 0:a.undoTree;if(r||(r=lr()),Fw(r,t)){const i=await $w(n,r,t);if(!i)return!1;s(J(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;p&&(p.undoTree=i)})),r=i}return ol(s,e,t)},Yw=s=>{const e=Et(s);return(e==null?void 0:e.canUndo())??!1},Xw=s=>{const e=Et(s);return(e==null?void 0:e.canRedo())??!1},Qw=s=>{const e=Et(s);return(e==null?void 0:e.getBranches())??[]},Zw=s=>{const e=Et(s);return(e==null?void 0:e.getCurrent())??null},eb=s=>{const e=Et(s);return(e==null?void 0:e.getPath())??[]},tb=s=>{const e=Et(s);return(e==null?void 0:e.getRedoPath())??[]},sb=s=>{const e=Et(s);return(e==null?void 0:e.getAllNodes())??[]},nb=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.undoTree)??null},rb=(s,e)=>{const t=gs(e);s(J(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,a=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=a&&a.activeCanvasId?a.canvases[a.activeCanvasId]:null;i&&(i.undoTree=lr())})),t&&Bw(t).catch(n=>{console.warn("Failed to clear undo archive:",n)})},ab=(s,e,t)=>{const n=Et(e);n&&(n.prune(t),Pa(s,n))},ob=async s=>{const e=gs(s);return e?Uw(e):null},ib=async()=>{await Ww()},cb=async(s,e)=>{const t=gs(e);if(!t)return!1;try{const n=await zw(t);return n?(s(J(r=>{if(!r.state)return;const a=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;c&&c.id===t&&(c.undoTree=n)})),!0):!1}catch(n){return console.warn("Failed to load undo history from archive:",n),!1}},lb=(s,e)=>({commit:t=>qw(s,e,t),undo:()=>Vw(s,e),redo:t=>Kw(s,e,t),jumpTo:t=>ol(s,e,t),jumpToAsync:t=>Jw(s,e,t),canUndo:()=>Yw(e),canRedo:()=>Xw(e),getBranches:()=>Qw(e),getCurrent:()=>Zw(e),getPath:()=>eb(e),getRedoPath:()=>tb(e),getAllNodes:()=>sb(e),getTreeData:()=>nb(e),clear:()=>rb(s,e),prune:t=>ab(s,e,t),getArchiveStats:()=>ob(e),initArchive:()=>ib(),loadFromArchive:()=>cb(s,e)}),db=s=>{const e={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse","canvas-tag":"tag"};if(e[s])return e[s];const t=s.split("-");return t.length>=2?t[1]:null},ub=(s,e,t,n)=>({getSegmentedButtonAction:r=>{var i,c;return((c=(i=s().preferences)==null?void 0:i.segmentedButtons)==null?void 0:c[r])??null},setSegmentedButtonAction:(r,a,i,c)=>{const l=n(),d=(c==null?void 0:c.skipHistoryUpdate)??!1,p=c==null?void 0:c.actionId,u=c==null?void 0:c.params;if(i){const f=i();f&&t.set(l,f)}e(J(f=>{var y,w,v;if(f.preferences||(f.preferences={segmentedButtons:{}}),f.preferences.segmentedButtons||(f.preferences.segmentedButtons={}),f.preferences.segmentedButtons[r]=a,d){if((w=(y=f.actions)==null?void 0:y.history)!=null&&w.entries){const b=f.actions.history.entries.find(j=>j.source===r&&j.label===a);b&&(b.executorId&&t.delete(b.executorId),b.executorId=l,p&&!b.actionId&&(b.actionId=p),u&&!b.params&&(b.params=u))}return}f.actions||(f.actions={}),f.actions.history||(f.actions.history={entries:[],lastAction:void 0,maxSize:50});const m=f.actions.history.entries,g=m[0];if(g&&g.source===r&&g.label===a)g.executorId&&t.delete(g.executorId),g.executorId=l,g.timestamp=Date.now(),g.actionId=p,g.params=u,f.actions.history.lastAction=g;else{const b={executorId:l,source:r,label:a,timestamp:Date.now(),actionId:p,params:u};for(m.unshift(b);m.length>f.actions.history.maxSize;){const j=m.pop();j!=null&&j.executorId&&t.delete(j.executorId)}f.actions.history.lastAction=b}if((v=f.actions.recording)!=null&&v.isRecording){const b=db(r);if(b&&p){const j={id:Pe(8),action:{facadeKey:b,actionId:p,params:u,label:a},delayMs:0};f.actions.recording.capturedSteps.push(j)}}}))},getKeepArrowsOnSplit:()=>{var a;return((a=s().preferences)==null?void 0:a.keepArrowsOnSplit)??!1},setKeepArrowsOnSplit:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.keepArrowsOnSplit=r}))},getKeepSplitMatch:()=>{var a;return((a=s().preferences)==null?void 0:a.keepSplitMatch)??!1},setKeepSplitMatch:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.keepSplitMatch=r}))},getSplitHorizontally:()=>{var a;return((a=s().preferences)==null?void 0:a.splitHorizontally)??!1},setSplitHorizontally:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.splitHorizontally=r}))},getSplitNodeGap:()=>{var a;return((a=s().preferences)==null?void 0:a.splitNodeGap)??rt.NEW_NODE_SEGMENT_SPACING},setSplitNodeGap:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.splitNodeGap=r}))},getLastUsedBorder:()=>{var r,a,i,c,l,d;return{lastUsedColor:((a=(r=s().preferences)==null?void 0:r.borderButton)==null?void 0:a.lastUsedColor)??"hsl(var(--primary))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.borderButton)==null?void 0:c.lastUsedWidth)??"1px",lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.borderButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedBorder:(r,a,i)=>{e(J(c=>{c.preferences||(c.preferences={}),c.preferences.borderButton||(c.preferences.borderButton={}),c.preferences.borderButton.lastUsedColor=r,c.preferences.borderButton.lastUsedWidth=a,c.preferences.borderButton.lastUsedStyle=i}))},getLastUsedArrowStyle:()=>{var r,a,i,c,l,d;return{lastUsedColor:((a=(r=s().preferences)==null?void 0:r.arrowStyleButton)==null?void 0:a.lastUsedColor)??"hsl(var(--muted-light))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.arrowStyleButton)==null?void 0:c.lastUsedWidth)??1,lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.arrowStyleButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedArrowStyle:(r,a,i)=>{e(J(c=>{c.preferences||(c.preferences={}),c.preferences.arrowStyleButton||(c.preferences.arrowStyleButton={}),c.preferences.arrowStyleButton.lastUsedColor=r,c.preferences.arrowStyleButton.lastUsedWidth=a,c.preferences.arrowStyleButton.lastUsedStyle=i}))},getLastArrangeOption:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:a.lastArrangeOption)??null},setLastArrangeOption:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.lastArrangeOption=r}))},getSortByLastArrange:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:a.sortByLastArrange)??!1},setSortByLastArrange:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.sortByLastArrange=r}))},getArrangeNodeGap:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:a.nodeGap)??Le.arrange.gap},setArrangeNodeGap:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.nodeGap=r}))},getArrangeGridColumns:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:a.gridColumns)??Le.arrange.gridColumns},setArrangeGridColumns:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.gridColumns=r}))},getArrangeGridRows:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:a.gridRows)??Le.arrange.gridRows},setArrangeGridRows:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.gridRows=r}))},getCycleRowBuffer:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:a.cycleRowBuffer)??20},setCycleRowBuffer:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.cycleRowBuffer=r}))},getLastTagTitle:()=>{var r,a;return((a=(r=s().preferences)==null?void 0:r.tagButton)==null?void 0:a.lastTagTitle)??null},setLastTagTitle:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.tagButton||(a.preferences.tagButton={}),a.preferences.tagButton.lastTagTitle=r}))},getGoToSymbolSearch:()=>{var r;return((r=s().preferences)==null?void 0:r.goToSymbolSearch)??null},setGoToSymbolSearchOptions:r=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.goToSymbolSearch?a.preferences.goToSymbolSearch.options=r:a.preferences.goToSymbolSearch={options:r,searchHistory:[]}}))},addGoToSymbolSearchHistory:r=>{r.trim()&&e(J(a=>{a.preferences||(a.preferences={}),a.preferences.goToSymbolSearch||(a.preferences.goToSymbolSearch={options:{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"},searchHistory:[]});const i=a.preferences.goToSymbolSearch.searchHistory.filter(c=>c!==r);i.unshift(r),a.preferences.goToSymbolSearch.searchHistory=i.slice(0,20)}))}}),pb=(s,e)=>({getSplitPresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.presets)??[]},getSplitPresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.splitPresets)==null?void 0:r.presets.find(a=>a.id===t)},getSplitPresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.favoriteIds)??[]},getActiveSplitPresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.activePresetId)??null},createSplitPreset:(t,n)=>{const r=Pe(10);return e(J(a=>{a.preferences||(a.preferences={}),a.preferences.splitPresets||(a.preferences.splitPresets={presets:[],favoriteIds:[]}),a.preferences.splitPresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateSplitPreset:(t,n)=>{e(J(r=>{var i,c;const a=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);a&&Object.assign(a,n)}))},duplicateSplitPreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.splitPresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const a=`split-preset-${Date.now()}`,i={id:a,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(J(d=>{d.preferences||(d.preferences={}),d.preferences.splitPresets||(d.preferences.splitPresets={presets:[],favoriteIds:[]}),d.preferences.splitPresets.presets.push(i)})),a},deleteSplitPreset:t=>{e(J(n=>{var r;(r=n.preferences)!=null&&r.splitPresets&&(n.preferences.splitPresets.presets=n.preferences.splitPresets.presets.filter(a=>a.id!==t),n.preferences.splitPresets.favoriteIds=n.preferences.splitPresets.favoriteIds.filter(a=>a!==t),n.preferences.splitPresets.activePresetId===t&&(n.preferences.splitPresets.activePresetId=void 0))}))},renameSplitPreset:(t,n)=>{e(J(r=>{var i,c;const a=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);a&&(a.name=n)}))},applySplitPreset:t=>{var a,i;const r=(i=(a=s().preferences)==null?void 0:a.splitPresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(J(c=>{c.preferences||(c.preferences={}),c.preferences.keepArrowsOnSplit=r.config.keepArrowsOnSplit,c.preferences.keepSplitMatch=r.config.keepSplitMatch,c.preferences.splitHorizontally=r.config.splitHorizontally,c.preferences.splitNodeGap=r.config.splitNodeGap,c.preferences.splitPresets||(c.preferences.splitPresets={presets:[],favoriteIds:[]}),c.preferences.splitPresets.activePresetId=t}))},toggleSplitPresetFavorite:t=>{e(J(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]});const r=n.preferences.splitPresets.favoriteIds.indexOf(t);r===-1?n.preferences.splitPresets.favoriteIds.push(t):n.preferences.splitPresets.favoriteIds.splice(r,1)}))},setActiveSplitPresetId:t=>{e(J(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]}),n.preferences.splitPresets.activePresetId=t??void 0}))}}),hb=(s,e)=>({getArrangePresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.presets)??[]},getArrangePresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.arrangePresets)==null?void 0:r.presets.find(a=>a.id===t)},getArrangePresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.favoriteIds)??[]},getActiveArrangePresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.activePresetId)??null},createArrangePreset:(t,n)=>{const r=Pe(10);return e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangePresets||(a.preferences.arrangePresets={presets:[],favoriteIds:[]}),a.preferences.arrangePresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateArrangePreset:(t,n)=>{e(J(r=>{var i,c;const a=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);a&&Object.assign(a,n)}))},duplicateArrangePreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.arrangePresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const a=`arrange-preset-${Date.now()}`,i={id:a,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(J(d=>{d.preferences||(d.preferences={}),d.preferences.arrangePresets||(d.preferences.arrangePresets={presets:[],favoriteIds:[]}),d.preferences.arrangePresets.presets.push(i)})),a},deleteArrangePreset:t=>{e(J(n=>{var r;(r=n.preferences)!=null&&r.arrangePresets&&(n.preferences.arrangePresets.presets=n.preferences.arrangePresets.presets.filter(a=>a.id!==t),n.preferences.arrangePresets.favoriteIds=n.preferences.arrangePresets.favoriteIds.filter(a=>a!==t),n.preferences.arrangePresets.activePresetId===t&&(n.preferences.arrangePresets.activePresetId=void 0))}))},renameArrangePreset:(t,n)=>{e(J(r=>{var i,c;const a=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);a&&(a.name=n)}))},applyArrangePreset:t=>{var a,i;const r=(i=(a=s().preferences)==null?void 0:a.arrangePresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(J(c=>{c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),c.preferences.arrangeButton.nodeGap=r.config.nodeGap,c.preferences.arrangeButton.gridColumns=r.config.gridColumns,c.preferences.arrangeButton.sortByLastArrange=r.config.sortByLastArrange,c.preferences.arrangePresets||(c.preferences.arrangePresets={presets:[],favoriteIds:[]}),c.preferences.arrangePresets.activePresetId=t}))},toggleArrangePresetFavorite:t=>{e(J(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]});const r=n.preferences.arrangePresets.favoriteIds.indexOf(t);r===-1?n.preferences.arrangePresets.favoriteIds.push(t):n.preferences.arrangePresets.favoriteIds.splice(r,1)}))},setActiveArrangePresetId:t=>{e(J(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]}),n.preferences.arrangePresets.activePresetId=t??void 0}))}}),fb=(s,e)=>({getArrangeConfigFavorites:()=>{var t;return((t=s().preferences)==null?void 0:t.arrangeConfigFavorites)??[]},getArrangeConfigFavoritesByType:t=>{var n;return(((n=s().preferences)==null?void 0:n.arrangeConfigFavorites)??[]).filter(r=>r.type===t)},addArrangeConfigFavorite:(t,n)=>{const r=Pe(10);return e(J(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeConfigFavorites||(a.preferences.arrangeConfigFavorites=[]),a.preferences.arrangeConfigFavorites.some(c=>c.type===t&&c.value===n)||a.preferences.arrangeConfigFavorites.push({id:r,type:t,value:n})})),r},removeArrangeConfigFavorite:t=>{e(J(n=>{var r;(r=n.preferences)!=null&&r.arrangeConfigFavorites&&(n.preferences.arrangeConfigFavorites=n.preferences.arrangeConfigFavorites.filter(a=>a.id!==t))}))},applyArrangeConfigFavorite:t=>{var a,i;const r=(i=(a=s().preferences)==null?void 0:a.arrangeConfigFavorites)==null?void 0:i.find(c=>c.id===t);r&&e(J(c=>{switch(c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),r.type){case"gap":c.preferences.arrangeButton.nodeGap=r.value;break;case"columns":c.preferences.arrangeButton.gridColumns=r.value;break;case"rows":c.preferences.arrangeButton.gridRows=r.value;break}}))},isArrangeConfigFavorite:(t,n)=>{var r;return(((r=s().preferences)==null?void 0:r.arrangeConfigFavorites)??[]).some(a=>a.type===t&&a.value===n)},toggleArrangeConfigFavorite:(t,n)=>{var c;const r=s(),i=(((c=r.preferences)==null?void 0:c.arrangeConfigFavorites)??[]).find(l=>l.type===t&&l.value===n);i?r.removeArrangeConfigFavorite(i.id):r.addArrangeConfigFavorite(t,n)}}),mb=(s,e)=>({getPinnedPaletteItems:t=>{var n,r;return((r=(n=s().preferences)==null?void 0:n.pinnedPaletteItems)==null?void 0:r[t])??[]},pinPaletteItem:(t,n)=>{e(J(r=>{r.preferences||(r.preferences={}),r.preferences.pinnedPaletteItems||(r.preferences.pinnedPaletteItems={}),r.preferences.pinnedPaletteItems[t]||(r.preferences.pinnedPaletteItems[t]=[]),r.preferences.pinnedPaletteItems[t].includes(n)||r.preferences.pinnedPaletteItems[t].push(n)}))},unpinPaletteItem:(t,n)=>{e(J(r=>{var a,i;(i=(a=r.preferences)==null?void 0:a.pinnedPaletteItems)!=null&&i[t]&&(r.preferences.pinnedPaletteItems[t]=r.preferences.pinnedPaletteItems[t].filter(c=>c!==n))}))},togglePinPaletteItem:(t,n)=>{s().isPaletteItemPinned(t,n)?s().unpinPaletteItem(t,n):s().pinPaletteItem(t,n)},isPaletteItemPinned:(t,n)=>{var r,a,i;return((i=(a=(r=s().preferences)==null?void 0:r.pinnedPaletteItems)==null?void 0:a[t])==null?void 0:i.includes(n))??!1}}),gb=(s,e)=>({getOpenTabs:()=>{var t;return((t=s().preferences)==null?void 0:t.openTabs)??[]},openTab:(t,n,r)=>{e(J(a=>{a.preferences||(a.preferences={}),a.preferences.openTabs||(a.preferences.openTabs=[]),a.preferences.openTabs.some(c=>c.canvasId===t)||a.preferences.openTabs.push({canvasId:t,projectId:n,workspaceId:r})}))},closeTab:t=>{var c;const n=((c=s().preferences)==null?void 0:c.openTabs)??[];if(n.length<=1)return;const r=n.findIndex(l=>l.canvasId===t),a=s().projectCanvas.getActive(),i=(a==null?void 0:a.id)===t;if(e(J(l=>{var d;(d=l.preferences)!=null&&d.openTabs&&(l.preferences.openTabs=l.preferences.openTabs.filter(p=>p.canvasId!==t))})),i){const l=r>=n.length-1?r-1:r,d=n.filter(p=>p.canvasId!==t)[l];d&&s().projectCanvas.switch(d.canvasId)}},closeOtherTabs:t=>{e(J(n=>{var r;(r=n.preferences)!=null&&r.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(a=>a.canvasId===t))}))},closeTabsToRight:t=>{e(J(n=>{var a;if(!((a=n.preferences)!=null&&a.openTabs))return;const r=n.preferences.openTabs.findIndex(i=>i.canvasId===t);r!==-1&&(n.preferences.openTabs=n.preferences.openTabs.slice(0,r+1))}))},reorderTabs:t=>{e(J(n=>{var a;if(!((a=n.preferences)!=null&&a.openTabs))return;const r=new Map(n.preferences.openTabs.map(i=>[i.canvasId,i]));n.preferences.openTabs=t.map(i=>r.get(i)).filter(i=>i!==void 0)}))}}),xb=(s,e,t,n)=>({getGlobalActionHistory:()=>{var r,a;return((a=(r=s().actions)==null?void 0:r.history)==null?void 0:a.entries)??[]},getGlobalLastAction:()=>{var r,a;return(a=(r=s().actions)==null?void 0:r.history)==null?void 0:a.lastAction},executeGlobalLastAction:()=>{var i,c;const r=(c=(i=s().actions)==null?void 0:i.history)==null?void 0:c.lastAction;if(!r)return!1;if(r.actionId){const l=n.get(r.actionId);if(l)return l(r.params),!0}const a=r.executorId?t.get(r.executorId):void 0;return a?(a(),!0):!1},executeActionById:r=>{const a=t.get(r);return a?(a(),!0):!1},hasExecutor:r=>t.has(r),clearGlobalActionHistory:()=>{var a,i;const r=((i=(a=s().actions)==null?void 0:a.history)==null?void 0:i.entries)??[];for(const c of r)c.executorId&&t.delete(c.executorId);e(J(c=>{var l;(l=c.actions)!=null&&l.history&&(c.actions.history.entries=[],c.actions.history.lastAction=void 0)}))}}),vb=(s,e)=>({isRecording:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.isRecording)??!1},startRecording:()=>{e(J(t=>{t.actions||(t.actions={}),t.actions.recording={isRecording:!0,capturedSteps:[],startedAt:Date.now()}}))},stopRecording:()=>{var n,r;const t=((r=(n=s().actions)==null?void 0:n.recording)==null?void 0:r.capturedSteps)??[];return e(J(a=>{var i;(i=a.actions)!=null&&i.recording&&(a.actions.recording.isRecording=!1)})),t},cancelRecording:()=>{e(J(t=>{t.actions&&(t.actions.recording={isRecording:!1,capturedSteps:[]})}))},getRecordingSteps:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.capturedSteps)??[]}}),wb=(s,e)=>({isHistorySelecting:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.isSelecting)??!1},toggleHistorySelectionMode:()=>{e(J(t=>{t.actions||(t.actions={}),t.actions.historySelection||(t.actions.historySelection={isSelecting:!1,selectedIds:[]}),t.actions.historySelection.isSelecting=!t.actions.historySelection.isSelecting,t.actions.historySelection.isSelecting||(t.actions.historySelection.selectedIds=[])}))},toggleHistoryItemSelection:t=>{e(J(n=>{var a;if(!((a=n.actions)!=null&&a.historySelection))return;const r=n.actions.historySelection.selectedIds.indexOf(t);r===-1?n.actions.historySelection.selectedIds.push(t):n.actions.historySelection.selectedIds.splice(r,1)}))},getSelectedHistoryIds:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.selectedIds)??[]},clearHistorySelection:()=>{e(J(t=>{var n;(n=t.actions)!=null&&n.historySelection&&(t.actions.historySelection.selectedIds=[],t.actions.historySelection.isSelecting=!1)}))}}),bb=(s,e)=>({getSequencePresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.presets)??[]},getSequencePresetById:t=>{var n,r;return(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.presets.find(a=>a.id===t)},createSequencePreset:(t,n)=>{const r=Pe(10);return e(J(a=>{a.actions||(a.actions={}),a.actions.sequencePresets||(a.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),a.actions.sequencePresets.presets.push({id:r,name:t,steps:n,createdAt:Date.now()})})),r},updateSequencePreset:(t,n)=>{e(J(r=>{var i,c;const a=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.presets.find(l=>l.id===t);a&&Object.assign(a,n,{updatedAt:Date.now()})}))},deleteSequencePreset:t=>{e(J(n=>{var r;(r=n.actions)!=null&&r.sequencePresets&&(n.actions.sequencePresets.presets=n.actions.sequencePresets.presets.filter(a=>a.id!==t),n.actions.sequencePresets.favoriteIds=n.actions.sequencePresets.favoriteIds.filter(a=>a!==t),n.actions.sequencePresets.activePresetId===t&&(n.actions.sequencePresets.activePresetId=void 0))}))},duplicateSequencePreset:t=>{var a,i;const n=(i=(a=s().actions)==null?void 0:a.sequencePresets)==null?void 0:i.presets.find(c=>c.id===t);if(!n)return"";const r=crypto.randomUUID();return e(J(c=>{c.actions||(c.actions={}),c.actions.sequencePresets||(c.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const l=n.steps.map(d=>({...d,id:crypto.randomUUID()}));c.actions.sequencePresets.presets.push({id:r,name:`${n.name} (copy)`,steps:l,createdAt:Date.now()})})),r},toggleSequencePresetFavorite:t=>{e(J(n=>{n.actions||(n.actions={}),n.actions.sequencePresets||(n.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const r=n.actions.sequencePresets.favoriteIds.indexOf(t);r===-1?n.actions.sequencePresets.favoriteIds.push(t):n.actions.sequencePresets.favoriteIds.splice(r,1)}))},getSequencePresetFavorites:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.favoriteIds)??[]}}),yb=(s,e)=>({getVisualWorkflowPresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.visualWorkflows)??[]},getVisualWorkflowPresetById:t=>{var n,r,a;return(a=(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.visualWorkflows)==null?void 0:a.find(i=>i.id===t)},createVisualWorkflowPreset:(t,n,r)=>{const a=Pe(10);return e(J(i=>{i.actions||(i.actions={}),i.actions.sequencePresets||(i.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),i.actions.sequencePresets.visualWorkflows||(i.actions.sequencePresets.visualWorkflows=[]),i.actions.sequencePresets.visualWorkflows.push({id:a,name:t,steps:n,sourceLocation:r,createdAt:Date.now()})})),a},updateVisualWorkflowPreset:(t,n)=>{e(J(r=>{var i,c,l;const a=(l=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)==null?void 0:l.find(d=>d.id===t);a&&Object.assign(a,n,{updatedAt:Date.now()})}))},deleteVisualWorkflowPreset:t=>{e(J(n=>{var r,a;(a=(r=n.actions)==null?void 0:r.sequencePresets)!=null&&a.visualWorkflows&&(n.actions.sequencePresets.visualWorkflows=n.actions.sequencePresets.visualWorkflows.filter(i=>i.id!==t))}))}}),Sb=(s,e)=>({addTagToNode:(t,n,r)=>{const a=s().getNodeById(t);if(!a)return;const i={x:a.x,y:a.y},c=a.groupId,l=typeof n=="string"?{id:Math.random().toString(36).slice(2,10),title:n}:n,d=Array.isArray(a.tags)?a.tags:[];if(d.some(f=>f.title===l.title))return;s().updateNode(t,{tags:[...d,l]});let u;if(!a.groupId&&a.type!==He.GROUP&&(u=s().getNodesByTag(l.title).find(m=>m.type===He.GROUP&&m.id!==t),u)){const g=a.width??200,x=a.height??100,y=u.width??400,w=u.height??300,v=u.x+y-g-20,b=u.y+w-x-20;s().updateNode(t,{x:v,y:b}),s().group.addNodesToGroup(u.id,[t])}r!=null&&r.skipUndo||s().undo.commit({type:"tag:add",nodeId:t,tag:l,autoGroup:u?{groupId:u.id,previousPosition:i,previousGroupId:c}:void 0})},removeTagFromNode:(t,n,r)=>{const a=s().getNodeById(t);if(!a||!Array.isArray(a.tags))return;const i=a.tags.find(c=>c.id===n);s().updateNode(t,{tags:a.tags.filter(c=>c.id!==n)}),!(r!=null&&r.skipUndo)&&i&&s().undo.commit({type:"tag:remove",nodeId:t,tag:i})},getNodesByTag:t=>{const n=s().projectCanvas.getActive();return n?(n.coreState.nodes||[]).filter(a=>Array.isArray(a.tags)&&a.tags.some(i=>i.title===t)):[]},hasTag:(t,n)=>{const r=s().getNodeById(t);return!r||!Array.isArray(r.tags)?!1:r.tags.some(a=>a.title===n)}}),Ao=new Map,il=new Map,Cb=(s,e)=>{il.set(s,e)},jb=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,Jr="markop-canvas-v2-storage",Yr=new fv("CanvasStateV2",nv.CanvasStateV2),Nb=(s,e)=>({..._n,...Ax(e,s),...xx(e,s),project:Xx(s,e),workspace:sv(s,e),projectCanvas:hv(s,e),arrow:sg(s,e),group:Nv(s,e),table:Tv(s,e),layer:Kv(s,e),viewLayer:mw(s,e),ext:Ew(s,e),undo:lb(s,e),getCanvasMouseCoords:()=>$m(e),...bx(e,s),setFlags:t=>Jg(s,t),...ub(e,s,Ao,jb),...pb(e,s),...hb(e,s),...fb(e,s),...mb(e,s),...gb(e,s),...xb(e,s,Ao,il),...vb(e,s),...wb(e,s),...bb(e,s),...yb(e,s),resetState:()=>Yg(s),resetEverything:()=>dx([Jr,"paper-texture-live-config","paper-texture-saved-presets"]),scrollToNode:(t,n=500,r)=>Mm(s,e,t,n,r),scrollToArrow:(t,n=500)=>xv(s,e,t,n),...Sb(e),...qx(e,s),...Ox(e,Jr,Yr)}),Eb=Nb,Tt=Ec()(Eb);let Ra=!1;(async()=>{try{const s=await _x(Jr,_n.dataVersion);if(s){const e=Mx(_n,s);Fx(e.preferences),Tt.setState({version:e.version,dataVersion:e.dataVersion,state:e.state,uiState:e.uiState,flags:e.flags,preferences:e.preferences,extensions:e.extensions,actions:e.actions}),Yr.log("Canvas state rehydrated from localStorage");try{await Tt.getState().undo.initArchive(),await Tt.getState().undo.loadFromArchive()&&Yr.log("Undo history loaded from IndexedDB")}catch(t){console.warn("[PERSISTENCE] Failed to load undo history from IndexedDB:",t)}}}catch(s){console.error("[PERSISTENCE] Failed to rehydrate from localStorage:",s)}finally{Ra=!0}})();let Sr=null;const kb=1e3;Le.autosave&&Le.persistState&&Tt.subscribe(s=>{Ra&&(Sr&&clearTimeout(Sr),Sr=setTimeout(()=>{s.saveStateToLocalStorage()},kb))});const Ib={mousePosition:null},Tb=(s,e)=>({...Ib,setMousePosition:t=>bg(s,t)}),cl=Ec()(Tb),OC=Object.freeze(Object.defineProperty({__proto__:null,canvasStoreV2:Tt,canvasUiStoreV2:cl,get isRehydrated(){return Ra},registerActionHandler:Cb},Symbol.toStringTag,{value:"Module"}));class Ab{constructor(){Q(this,"activeTranscriptions",new Map);Q(this,"listeners",new Set)}register(e,t){this.activeTranscriptions.set(e,{nodeId:e,sessionName:t,startedAt:Date.now(),status:"recording"}),this.notify()}updateStatus(e,t){const n=this.activeTranscriptions.get(e);n&&(n.status=t,this.notify())}complete(e,t){const n=Tt.getState(),r=n.getNodeById(e);if(r){const a=r.content||"",i=a+(a?`
`:"")+t;n.updateNodeContent(e,i),lg();const{width:c,height:l}=dg(i);n.updateNode(e,{width:c,height:l,options:{...r.options,lockSize:!1}})}this.activeTranscriptions.delete(e),this.notify()}fail(e){this.activeTranscriptions.delete(e),this.notify()}has(e){return this.activeTranscriptions.has(e)}getStatus(e){var t;return((t=this.activeTranscriptions.get(e))==null?void 0:t.status)??null}getAll(){return Array.from(this.activeTranscriptions.values())}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}}const fn=new Ab;var Da=(s=>(s.EN="en",s.VI="vi",s.DE="de",s))(Da||{});const LC={en:"EN",vi:"VI",de:"DE"},_C={en:"English",vi:"Vietnamese",de:"German"},MC={en:"ðŸ‡¬ðŸ‡§",vi:"ðŸ‡»ðŸ‡³",de:"ðŸ‡©ðŸ‡ª"},ll="en",FC=["en","vi","de"];function dl({onTranscriptionComplete:s,className:e="",sessionName:t="audio-button-default",getTextAreaElement:n,variant:r="default",autoStartRecording:a=!1,"data-test":i,style:c,nodeId:l,language:d}){const[p,u]=h.useState(!1),[f,m]=h.useState(0),[g,x]=h.useState(0),[y,w]=h.useState(!1),v=h.useRef(0),b=h.useRef({});v.current++;const j={onTranscriptionComplete:s,sessionName:t,getTextAreaElement:n,variant:r,autoStartRecording:a,nodeId:l,language:d};Object.keys(j).forEach(O=>{b.current[O],j[O]}),b.current=j,h.useEffect(()=>{if(a&&!p){const O=setTimeout(()=>{m(q=>q+1)},100);return()=>clearTimeout(O)}},[a]);const S=h.useCallback(O=>"value"in O?O.value:O.textContent||"",[]),C=h.useCallback((O,q)=>{var G;if("value"in O){const U=(G=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:G.set;U?U.call(O,q):O.value=q}else O.textContent=q;const K=new Event("input",{bubbles:!0});O.dispatchEvent(K)},[]),[N,A]=h.useState([]),[I,k]=h.useState(0),[P,W]=h.useState(!1),R=h.useCallback(O=>{A(q=>[...q,O]),(O.transcriptionStatus==="pending"||O.transcriptionStatus==="processing")&&w(!0)},[]),F=h.useCallback(O=>{A(q=>q.map(K=>K.id===O.id?O:K)),O.transcription?(k(q=>q+1),l?fn.complete(l,O.transcription):s==null||s(O.transcription),w(!1)):O.transcriptionStatus==="failed"&&(l&&fn.fail(l),w(!1))},[s,l]),L=h.useCallback(O=>{u(O),l&&(O?fn.register(l,t):fn.updateStatus(l,"transcribing"))},[l,t]),T=h.useCallback(O=>{O&&(O.preventDefault(),O.stopPropagation()),p?x(q=>q+1):m(q=>q+1)},[p]),M=h.useCallback(O=>{if(O.preventDefault(),O.stopPropagation(),I>0&&n){const q=n();if(!q)return;const K=N[I-1];if(!(K!=null&&K.transcription))return;const G=S(q),U=K.transcription;let Z=G;G.endsWith(U)?Z=G.slice(0,-U.length):G.endsWith(" "+U)&&(Z=G.slice(0,-(U.length+1))),Z=Z.trimEnd(),C(q,Z),k(ue=>ue-1)}},[I,N,n,S,C]),D=h.useCallback(O=>{if(O.preventDefault(),O.stopPropagation(),I<N.length&&n){const q=n();if(!q)return;const K=N[I];if(!(K!=null&&K.transcription))return;const G=S(q),U=G.trim()?" ":"",Z=G+U+K.transcription;C(q,Z),k(ue=>ue+1)}},[I,N,n,S,C]),H=h.useCallback(O=>{const q=N.findIndex(K=>K.id===O);if(q!==-1){if(q<I&&n){const K=n();if(K){const U=N.filter((Z,ue)=>ue<I&&ue!==q).map(Z=>Z.transcription).filter(Boolean).join(" ");C(K,U),k(Z=>Z-1)}}A(K=>K.filter(G=>G.id!==O))}},[N,I,n,C]),Y=h.useCallback(()=>{if(n){const O=n();O&&C(O,"")}A([]),k(0)},[n,C]);return h.useEffect(()=>{const O=q=>{if(q.ctrlKey&&q.shiftKey&&q.key==="A")if(n){const K=n();K&&document.activeElement===K&&(q.preventDefault(),q.stopPropagation(),q.stopImmediatePropagation(),T())}else q.preventDefault(),q.stopPropagation(),q.stopImmediatePropagation(),T()};return window.addEventListener("keydown",O,!0),()=>{window.removeEventListener("keydown",O,!0)}},[T,n]),o.jsxs("div",{className:`audio-button-wrapper flex items-center gap-1 ${e}`,"data-test":i||"audio-button-wrapper",style:c,children:[y&&o.jsx("div",{className:"transcription-spinner","data-test":i?`${i}-transcription-spinner`:"audio-button-transcription-spinner",children:o.jsx(tr,{className:"w-4 h-4 animate-spin text-muted-foreground","data-test":i?`${i}-transcription-spinner-icon`:"audio-button-transcription-spinner-icon"})}),N.length>0&&o.jsxs("div",{className:"chunk-navigation flex items-center gap-0.5","data-test":i?`${i}-chunk-navigation`:"audio-button-chunk-navigation",children:[o.jsx("button",{onMouseDown:O=>O.preventDefault(),onClick:M,disabled:I===0,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Remove previous chunk",type:"button","data-test":i?`${i}-previous-chunk-button`:"audio-button-previous-chunk-button",children:o.jsx(Zs,{className:Qe.sm,"data-test":i?`${i}-previous-chunk-icon`:"audio-button-previous-chunk-icon"})}),o.jsxs(Ye,{open:P,onOpenChange:W,"data-test":i?`${i}-chunk-panel-popover`:"audio-button-chunk-panel-popover",children:[o.jsx(at,{asChild:!0,children:o.jsxs("button",{onMouseDown:O=>O.preventDefault(),onDoubleClick:()=>{Y(),W(!1)},className:"chunk-counter text-xs text-muted-foreground px-1 hover:bg-accent rounded cursor-pointer",title:"View all chunks (double-click to clear)",type:"button","data-test":i?`${i}-chunk-counter-button`:"audio-button-chunk-counter-button",children:[I,"/",N.length]})}),o.jsx(Ge,{className:"w-96 p-0",side:"top",align:"center","data-test":i?`${i}-chunk-panel-content`:"audio-button-chunk-panel-content",children:o.jsx("div",{className:"chunk-panel-popover","data-test":i?`${i}-chunk-panel-wrapper`:"audio-button-chunk-panel-wrapper",children:o.jsx(Nc,{chunks:N,onChunkDelete:H,onChunkTranscribe:()=>{},onClearAll:Y})})})]}),o.jsx("button",{onMouseDown:O=>O.preventDefault(),onClick:D,disabled:I>=N.length,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Add next chunk",type:"button","data-test":i?`${i}-next-chunk-button`:"audio-button-next-chunk-button",children:o.jsx(ds,{className:Qe.sm,"data-test":i?`${i}-next-chunk-icon`:"audio-button-next-chunk-icon"})})]}),o.jsx("button",{onMouseDown:O=>O.preventDefault(),onClick:T,className:r==="muted"?`voice-input-button p-1 rounded-md transition-colors ${p?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"text-muted-foreground/40 hover:text-foreground hover:bg-accent"}`:`voice-input-button p-1.5 rounded-md transition-colors ${p?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"hover:bg-accent"}`,title:p?"Stop recording (Ctrl+Shift+A)":"Start voice input (Ctrl+Shift+A)",type:"button","data-test":i?`${i}-voice-input-button`:"audio-button-voice-input-button",children:o.jsx(Qn,{className:`voice-input-icon ${r==="muted"?Qe.xs:Qe.sm} ${p?"animate-pulse":""}`,"data-test":i?`${i}-voice-input-icon`:"audio-button-voice-input-icon"})}),o.jsx("div",{className:"audio-panel-wrapper hidden","data-test":i?`${i}-audio-panel-wrapper`:"audio-button-audio-panel-wrapper",children:o.jsx(tm,{sessionName:t,enableAutoPersist:!1,loadPersistedChunks:!1,autoStart:!1,startTrigger:f,stopTrigger:g,onChunkCreated:R,onChunkUpdated:F,onRecordingStateChange:L,initialConfig:d?{transcribeOptions:{language:d,...d===Da.VI?{model:"ggml-large-v3"}:{}}}:void 0})})]})}const Po=s=>{const{header:e,itemList:t,maxHeight:n,selectedIndices:r,selectedValues:a,getItemValue:i=(D,H)=>H,onSelectionChange:c,searchable:l=!1,searchPlaceholder:d="Search...",filterItem:p=(D,H)=>String(D).toLowerCase().includes(H.toLowerCase()),showAllOption:u=l,allOptionLabel:f="All",enableDelete:m=!1,onItemDelete:g,itemStyles:x="",moreOptions:y,initiallyCollapsed:w=!1,...v}=s,b=h.useRef({}),j=h.useRef(!1),[S,C]=h.useState(new Set(r)),[N,A]=h.useState(r==null?void 0:r[r.length-1]),[I,k]=h.useState(""),[P,W]=h.useState(w);h.useEffect(()=>{const D=Array.from(S),H=r||[];if(D.length!==H.length||!D.every((Y,O)=>Y===H[O])){j.current=!0,C(new Set(r));const Y=r==null?void 0:r[r.length-1];A(Y)}},[r]),h.useEffect(()=>{if(a===void 0)return;const D=new Set,H=new Set(a);if(t.forEach((Y,O)=>{H.has(i(Y,O))&&D.add(O)}),D.size!==S.size||!Array.from(D).every(Y=>S.has(Y))){j.current=!0,C(D);const Y=a[a.length-1],O=t.findIndex((q,K)=>i(q,K)===Y);A(O!==-1?O:void 0)}},[a,t,i]),h.useEffect(()=>{if(j.current){const D=N;if(D!==void 0&&S.has(D)){const H=b.current[D];H&&H.scrollIntoView({behavior:"smooth",block:"nearest"})}j.current=!1}},[S,N]);const R=(D,H)=>{const Y=M[D],O=t.findIndex(K=>K===Y);if(O===-1)return;let q=new Set(S);if(H.shiftKey&&N!==void 0){const K=Math.min(N,O),G=Math.max(N,O);for(let U=K;U<=G;U++)M.some(ue=>t[U]===ue)&&q.add(U)}else H.ctrlKey||H.metaKey?(q.has(O)?q.delete(O):q.add(O),A(O)):(q=new Set([O]),A(O));if(C(q),c){const K=Array.from(q),G=K.map(U=>i(t[U],U));c(K,G)}},F=(D,H)=>{if(H.stopPropagation(),g){const Y=i(t[D],D);g(D,Y)}},L=()=>{k(""),C(new Set),A(void 0),c&&c([],[])},T=()=>{W(!P)},M=I&&l?t.filter((D,H)=>p(D,I,H)):t;return o.jsxs("div",{id:"UiList","data-test":"ui-list-container",className:"bg-background text-foreground select-none",...v,children:[e?o.jsxs("div",{id:"header-container","data-test":"ui-list-header-container",className:"flex justify-between items-center sticky top-0 bg-background z-10 py-2 px-2 border-b border-border",children:[o.jsx("div",{"data-test":"ui-list-header-content",className:`flex-grow ${typeof e=="string"?"font-bold":""}`,children:e}),y&&o.jsx("div",{className:"flex items-center ml-2 flex-shrink-0","data-test":"ui-list-more-options",children:y}),o.jsx(se,{variant:"ghost",size:"sm",onClick:T,className:"p-1 h-auto flex-shrink-0","aria-label":P?"Expand list":"Collapse list","data-test":"ui-list-collapse-toggle",children:P?o.jsx(ms,{size:16}):o.jsx(Zn,{size:16})})]}):null,!P&&o.jsxs(o.Fragment,{children:[l&&o.jsx("div",{className:"sticky top-0 bg-background z-10 py-2 px-2 border-b border-border","data-test":"ui-list-search-container",children:o.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:d,value:I,onChange:D=>k(D.target.value),"data-test":"ui-list-search-input"})}),o.jsxs("div",{id:"itemList","data-test":"ui-list-items-container",className:Us("space-y-1 py-1 p-2 overflow-auto"),style:{maxHeight:n},children:[l&&u&&o.jsx("div",{className:`p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${!I&&S.size===0?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:L,"data-test":"ui-list-all-option",children:f}),M.map((D,H)=>{const Y=D,O=t.findIndex(K=>K===Y),q=S.has(O);return o.jsxs("div",{ref:K=>b.current[O]=K,className:`flex justify-between items-center p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${q?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:K=>R(H,K),"data-test":`ui-list-item-${O}`,children:[o.jsx("span",{className:"flex-grow","data-test":`ui-list-item-content-${O}`,children:D}),m&&o.jsx($u,{onClick:K=>F(O,K),className:"ml-2 px-1 py-0 text-xs text-destructive-foreground rounded hover:bg-destructive/80 focus:outline-none focus:ring-1 focus:ring-destructive","aria-label":`Delete item ${O+1}`,"data-test":`ui-list-item-delete-${O}`})]},O)})]})]})]})},ul=h.forwardRef(({className:s,onSelectionChange:e,showBuiltInPopover:t=!0,showCopyButton:n=!1,showAudioButton:r=!1,audioButtonVariant:a="default",onAudioTranscription:i,getTextAreaElement:c,keyboard:l,triggerPopover:d,fuzzyAutocomplete:p,"data-test":u,...f},m)=>{const[g,x]=h.useState(""),[y,w]=h.useState(!1),[v,b]=h.useState({top:0,left:0}),[j,S]=h.useState(!1),C=h.useRef(null),N=h.useRef(null),[A,I]=h.useState(!1),[k,P]=h.useState({top:0,left:0}),[W,R]=h.useState(null),[F,L]=h.useState(""),[T,M]=h.useState(0),D=h.useRef(null),[H,Y]=h.useState(!1),[O,q]=h.useState({top:0,left:0}),[K,G]=h.useState(""),[U,Z]=h.useState(0),ue=h.useRef(null),we=h.useMemo(()=>{if(!(d!=null&&d.items))return[];if(!F)return d.items;const _=F.toLowerCase();return d.items.filter(E=>E.label.toLowerCase().includes(_)||E.id.toLowerCase().includes(_))},[d==null?void 0:d.items,F]);h.useEffect(()=>{M(0)},[we.length]);const ae=h.useMemo(()=>{if(!(p!=null&&p.items)||!K)return[];const _=p.filterFn??((E,z)=>E.toLowerCase().includes(z.toLowerCase()));return p.items.filter(E=>_(E,K))},[p==null?void 0:p.items,p==null?void 0:p.filterFn,K]);h.useEffect(()=>{Z(0)},[ae.length]);const Te=h.useCallback(async()=>{const _=C.current;if(!(!_||!_.value))try{await navigator.clipboard.writeText(_.value),S(!0),setTimeout(()=>S(!1),2e3)}catch(E){console.error("Failed to copy text:",E)}},[]),ke=h.useCallback(()=>{I(!1),R(null),L(""),M(0)},[]),Ee=h.useCallback(()=>{Y(!1),G(""),Z(0)},[]),$e=h.useCallback((_,E)=>{const z=window.getComputedStyle(_),pe=_.scrollTop,X=parseInt(z.paddingLeft)||12,ce=parseInt(z.paddingTop)||8,ve=parseInt(z.lineHeight)||20,Ae=_.value.substring(0,E).split(`
`),Oe=Ae[Ae.length-1],De=Ae.length-1,Be=document.createElement("canvas").getContext("2d");if(!Be)return{top:ce+ve,left:X};Be.font=`${z.fontWeight} ${z.fontSize} ${z.fontFamily}`;const et=Be.measureText(Oe).width,pt=(De+1)*ve-pe+ce,Wt=et+X;return{top:pt,left:Wt}},[]),ge=h.useCallback(_=>{if(!d)return;const E=_.selectionStart,z=_.value,pe=d.triggerChar;if(W!==null){if(E<=W||z[W]!==pe){ke();return}const X=z.substring(W+1,E);if(/\s/.test(X)){ke();return}L(X);return}if(E>0&&z[E-1]===pe){const X=E>1?z[E-2]:null;if(X===null||X===" "||X===`
`||X==="	"){const ve=$e(_,E);P(ve),R(E-1),I(!0),L(""),M(0);return}}},[d,W,$e,ke]),ie=h.useCallback(_=>{if(!p)return;const E=_.selectionStart,z=_.value,pe=p.triggerAfterChars??1;if(z.length<pe){H&&Ee();return}if(G(z),z.length>=pe&&!H){const X=$e(_,E);q(X),Y(!0)}},[p,H,$e,Ee]),re=h.useCallback(_=>{var pe,X;const E=C.current;if(!E)return;const z=(pe=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:pe.set;z&&(z.call(E,_),E.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{E.setSelectionRange(_.length,_.length),E.focus()},0),(X=p==null?void 0:p.onSelect)==null||X.call(p,_),Ee()},[p,Ee]),te=h.useCallback(()=>{var E;if(!(p!=null&&p.findLCS)||ae.length===0)return!1;const _=p.findLCS(ae,K);if(_.length>K.length){const z=C.current;if(!z)return!1;const pe=(E=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:E.set;return pe&&(pe.call(z,_),z.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{z.setSelectionRange(_.length,_.length),z.focus()},0),G(_),!0}return!1},[p,ae,K]),$=h.useCallback(()=>{const _=C.current;if(!_)return;const E=_.selectionStart,z=_.selectionEnd,pe=_.value.substring(E,z).trim();if(pe.length>0){x(pe),w(t);const X=_.scrollTop,ce=window.getComputedStyle(_),ve=_.getBoundingClientRect(),ye=parseInt(ce.paddingLeft)||12,Ae=parseInt(ce.paddingTop)||8,Oe=_.value.substring(0,E).split(`
`),De=parseInt(ce.lineHeight)||20,Ue=Oe.length-1,Be=Oe[Ue],pt=document.createElement("canvas").getContext("2d");if(!pt)return;pt.font=`${ce.fontWeight} ${ce.fontSize} ${ce.fontFamily}`;const Wt=parseInt(ce.paddingRight)||12,Dt=ve.width-ye-Wt;let Xe=0,it=0,vt=0;for(;vt<Be.length;){let ht=vt+1;for(;ht<=Be.length;){const pr=Be.substring(vt,ht);if(pt.measureText(pr).width>Dt){let xs=ht-1;for(let vs=ht-1;vs>vt;vs--)if(Be[vs]===" "){xs=vs;break}xs===vt&&ht-vt>1&&(xs=ht-1),ht=xs;break}ht++}Xe=vt;const $a=Math.min(ht,Be.length);if($a>=Be.length){const pr=Be.substring(Xe),Ua=pt.measureText(pr).width,xs=(Ue+it)*De-X+De+Ae,vs=Ua+ye,Ba={top:xs,left:vs};b(Ba),e==null||e(pe,Ba);return}it++,vt=$a,Be[vt]===" "&&vt++}}else w(!1),x(""),e==null||e("",void 0)},[e,t]),V=h.useCallback(()=>{$()},[$]),ee=h.useCallback(_=>{var E;_.shiftKey&&$(),(E=f.onKeyUp)==null||E.call(f,_)},[$,f]),le=h.useCallback(_=>{var Ae,Oe;const E=C.current;if(!E||W===null)return;const z=E.value,pe=z.substring(0,W),X=z.substring(W+1+F.length),ce=pe+_.value+X,ve=(Ae=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Ae.set;ve&&(ve.call(E,ce),E.dispatchEvent(new Event("input",{bubbles:!0})));const ye=W+_.value.length;setTimeout(()=>{E.setSelectionRange(ye,ye),E.focus()},0),(Oe=d==null?void 0:d.onSelect)==null||Oe.call(d,_,{filterText:F,triggerPosition:W}),ke()},[W,F,d,ke]),ne=h.useCallback(_=>{var E;if(A&&d)switch(_.key){case"Escape":_.preventDefault(),ke();return;case"ArrowDown":_.preventDefault(),M(z=>z<we.length-1?z+1:0);return;case"ArrowUp":_.preventDefault(),M(z=>z>0?z-1:we.length-1);return;case"Enter":case"Tab":we.length>0&&(_.preventDefault(),le(we[T]));return}if(H&&p)switch(_.key){case"Escape":_.preventDefault(),Ee();return;case"ArrowDown":_.preventDefault(),Z(z=>z<ae.length-1?z+1:0);return;case"ArrowUp":_.preventDefault(),Z(z=>z>0?z-1:ae.length-1);return;case"Tab":_.preventDefault(),!te()&&ae.length===1&&re(ae[0]);return;case"Enter":ae.length>0&&(_.preventDefault(),re(ae[U]));return}(E=f.onKeyDown)==null||E.call(f,_)},[A,d,ke,we,T,le,H,p,Ee,ae,U,te,re,f]),de=h.useCallback(_=>{var E;ge(_.target),ie(_.target),(E=f.onChange)==null||E.call(f,_)},[ge,ie,f]),fe=h.useCallback(_=>{var E;setTimeout(()=>{w(!1),d!=null&&d.stayOpen||ke(),Ee()},200),(E=f.onBlur)==null||E.call(f,_)},[f,ke,Ee,d==null?void 0:d.stayOpen]),xe=h.useCallback(()=>{if(!g||g.length===0)return"";const _=g[0];return _>="A"&&_<="Z"?"text-red-600":_>="a"&&_<="z"?"text-blue-600":""},[g]),Ce=h.useCallback(_=>{i==null||i(_)},[i]),Se=h.useCallback(()=>C.current,[]);return h.useImperativeHandle(m,()=>({insertTextAtStart:_=>{const E=C.current;if(!E)return;E.focus();const z=E.selectionStart,pe=E.selectionEnd;if(E.setSelectionRange(0,0),!document.execCommand("insertText",!1,_)){const ye=_+E.value;E.value=ye,E.dispatchEvent(new Event("input",{bubbles:!0}))}const ce=z+_.length,ve=pe+_.length;E.setSelectionRange(ce,ve)},getTextArea:()=>C.current,getSelectionPosition:()=>v,closeTriggerPopover:ke,getTriggerPosition:()=>W}),[v,ke,W]),o.jsxs("div",{className:"textarea-container relative w-full h-full","data-test":u?`${u}-container`:"selectable-textarea-container",children:[o.jsxs(Ye,{open:y,"data-test":u?`${u}-popover`:"selectable-textarea-popover",children:[o.jsx(fc,{...f,className:B("flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:C,onChange:de,onKeyDown:ne,onMouseUp:V,onKeyUp:ee,onBlur:fe,"data-node-textarea":"true","data-test":u?`${u}-rich-textarea`:"selectable-textarea-rich-textarea"}),o.jsx(bn,{ref:N,style:{position:"absolute",top:`${v.top}px`,left:`${v.left}px`,width:"1px",height:"1px"},"data-test":u?`${u}-popover-anchor`:"selectable-textarea-popover-anchor"}),o.jsx(Ge,{side:"bottom",align:"start",className:"selection-popover w-auto max-w-md",onOpenAutoFocus:_=>_.preventDefault(),"data-test":u?`${u}-popover-content`:"selectable-textarea-popover-content",children:o.jsxs("div",{className:"popover-content flex flex-col gap-2","data-test":u?`${u}-popover-content-wrapper`:"selectable-textarea-popover-content-wrapper",children:[o.jsx("div",{className:"popover-label text-xs text-muted-foreground font-medium","data-test":u?`${u}-popover-label`:"selectable-textarea-popover-label",children:"Selected Text:"}),o.jsx("div",{className:B("popover-text text-sm font-mono bg-muted px-2 py-1 rounded font-semibold",xe()),"data-test":u?`${u}-popover-text`:"selectable-textarea-popover-text",children:g})]})})]}),d&&o.jsxs(Ye,{open:A,"data-test":u?`${u}-trigger-popover`:"selectable-textarea-trigger-popover",children:[o.jsx(bn,{ref:D,style:{position:"absolute",top:`${k.top}px`,left:`${k.left}px`,width:"1px",height:"1px"},"data-test":u?`${u}-trigger-popover-anchor`:"selectable-textarea-trigger-popover-anchor"}),o.jsx(Ge,{side:"bottom",align:"start",className:B("trigger-popover p-1",d.widthClass??"w-48"),style:d.zIndex?{zIndex:d.zIndex}:void 0,onOpenAutoFocus:_=>_.preventDefault(),"data-test":u?`${u}-trigger-popover-content`:"selectable-textarea-trigger-popover-content",children:o.jsxs("div",{"data-test":"trigger-popover-menu",children:[o.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:d.header??"Select"}),we.length>0?o.jsx(Po,{itemList:we.map(_=>o.jsxs("div",{className:"flex items-center gap-2 px-1","data-test":`trigger-item-${_.id}`,children:[_.icon&&o.jsx("span",{className:"font-mono text-xs w-6 text-muted-foreground",children:_.icon}),o.jsx("span",{className:"text-sm",children:_.label})]},_.id)),selectedIndices:[T],onSelectionChange:_=>{_.length>0&&we[_[0]]&&le(we[_[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"trigger-popover-list"}):o.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"trigger-popover-empty",children:d.emptyMessage??"No matches"})]})})]}),p&&o.jsxs(Ye,{open:H,"data-test":u?`${u}-fuzzy-popover`:"selectable-textarea-fuzzy-popover",children:[o.jsx(bn,{ref:ue,style:{position:"absolute",top:`${O.top}px`,left:`${O.left}px`,width:"1px",height:"1px"},"data-test":u?`${u}-fuzzy-popover-anchor`:"selectable-textarea-fuzzy-popover-anchor"}),o.jsx(Ge,{side:"bottom",align:"start",className:B("fuzzy-popover p-1",p.widthClass??"w-48"),style:p.zIndex?{zIndex:p.zIndex}:void 0,onOpenAutoFocus:_=>_.preventDefault(),"data-test":u?`${u}-fuzzy-popover-content`:"selectable-textarea-fuzzy-popover-content",children:o.jsxs("div",{"data-test":"fuzzy-popover-menu",children:[o.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:p.header??"Suggestions"}),ae.length>0?o.jsx(Po,{itemList:ae.map((_,E)=>o.jsx("div",{className:"flex items-center gap-2 px-1 text-sm","data-test":`fuzzy-item-${E}`,children:o.jsx("span",{className:"truncate",children:_})},E)),selectedIndices:[U],onSelectionChange:_=>{_.length>0&&ae[_[0]]&&re(ae[_[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"fuzzy-popover-list"}):o.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"fuzzy-popover-empty",children:p.emptyMessage??"No matches"})]})})]}),o.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:Je.nodeAudioButton},"data-test":u?`${u}-action-buttons`:"selectable-textarea-action-buttons",children:[n&&o.jsx("button",{type:"button",onClick:Te,className:"p-1 rounded hover:bg-muted/80 text-muted-foreground hover:text-foreground transition-colors",title:j?"Copied!":"Copy text","data-test":u?`${u}-copy-button`:"selectable-textarea-copy-button",children:j?o.jsx(st,{className:"h-4 w-4 text-green-500"}):o.jsx(ha,{className:"h-4 w-4"})}),r&&o.jsx(dl,{onTranscriptionComplete:Ce,sessionName:"selectable-textarea",getTextAreaElement:c||Se,variant:a,language:l,"data-test":u?`${u}-audio-button`:"selectable-textarea-audio-button"})]})]})});ul.displayName="SelectableTextArea";class Pb{constructor(){Q(this,"directoryMapCache",new Map);Q(this,"loadPromiseCache",new Map)}async loadDirectoryMap(e){var c;const t=e??"default",r=(c=oe.getState().ui)==null?void 0:c.directoryMaps;if(r!=null&&r[t])return this.directoryMapCache.set(t,r[t]),r[t];if(this.directoryMapCache.has(t))return this.directoryMapCache.get(t);if(this.loadPromiseCache.has(t))return this.loadPromiseCache.get(t);const a=e?`/directory-map?cwd=${encodeURIComponent(e)}`:"/directoryMap.json",i=fetch("http://localhost:3333"+a).then(l=>{if(!l.ok)throw new Error(`Failed to load directory map: ${l.statusText}`);return l.json()}).then(l=>{const d=l.success?l.data:l;return this.directoryMapCache.set(t,d),this.loadPromiseCache.delete(t),this.saveToGlobalStore(t,d),d}).catch(l=>{throw this.loadPromiseCache.delete(t),l});return this.loadPromiseCache.set(t,i),i}saveToGlobalStore(e,t){var a;const n=oe.getState(),r=((a=n.ui)==null?void 0:a.directoryMaps)??{};oe.updateState({ui:{...n.ui,directoryMaps:{...r,[e]:t}}})}async getFilePath(e,t){const n=await this.loadDirectoryMap(t);if(n[e])return n[e];const r=e.toLowerCase();for(const[a,i]of Object.entries(n))if(a.toLowerCase()===r)return i}async getAllFilenames(e){const t=await this.loadDirectoryMap(e);return Object.keys(t)}async searchFiles(e,t){const n=await this.loadDirectoryMap(t),r=e.toLowerCase();return Object.entries(n).filter(([a])=>a.toLowerCase().includes(r)).map(([a,i])=>({filename:a,path:i}))}clearCache(e){var t;if(e){const n=e;this.directoryMapCache.delete(n),this.loadPromiseCache.delete(n);const r=oe.getState(),i={...((t=r.ui)==null?void 0:t.directoryMaps)??{}};delete i[n],oe.updateState({ui:{...r.ui,directoryMaps:i}})}else{this.directoryMapCache.clear(),this.loadPromiseCache.clear();const n=oe.getState();oe.updateState({ui:{...n.ui,directoryMaps:{}}})}}}const Xr=new Pb;function mn(s,e){const t=s.toLowerCase(),n=e.toLowerCase();if(t==="")return{score:0,matches:[]};let r=0,a=0;const i=[];let c=0,l=0;for(;r<t.length&&a<n.length;)t[r]===n[a]?(i.push(a),l++,c+=1+l,(a===0||/[\s\-_\/\\.]/.test(e[a-1]))&&(c+=10),r++):l=0,a++;if(r!==t.length)return null;if(i.length>0){const d=i[i.length-1]-i[0]-i.length+1;c-=d}return c+=100/(e.length+1),{score:c,matches:i}}function Rb(s,e){if(e.length===0)return[{text:s,isMatch:!1}];const t=[];let n=0;for(const r of e)r>n&&t.push({text:s.substring(n,r),isMatch:!1}),t.push({text:s[r],isMatch:!0}),n=r+1;return n<s.length&&t.push({text:s.substring(n),isMatch:!1}),t}const Gn=h.forwardRef(({className:s,viewportClassName:e,children:t,...n},r)=>o.jsxs(gi,{ref:r,className:B("relative overflow-hidden",s),...n,children:[o.jsx(du,{className:B("h-full w-full rounded-[inherit]",e),children:t}),o.jsx(pl,{}),o.jsx(uu,{})]}));Gn.displayName=gi.displayName;const pl=h.forwardRef(({className:s,orientation:e="vertical",...t},n)=>o.jsx(xi,{ref:n,orientation:e,className:B("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...t,children:o.jsx(pu,{className:"relative flex-1 rounded-full bg-border"})}));pl.displayName=xi.displayName;function Db({items:s,selectedIndex:e,renderItem:t,onItemClick:n,onItemHover:r,className:a,height:i="h-[400px]",emptyMessage:c="No items found",isLoading:l=!1,loadingMessage:d="Loading...",getItemKey:p}){const u=h.useRef(null);return h.useEffect(()=>{u.current&&u.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[e]),o.jsx(Gn,{className:B("scrollable-list rounded-md border",i,a),"data-test":"scrollable-list-container",children:l?o.jsx("div",{className:"loading-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-loading-state",children:o.jsx("span",{"data-test":"scrollable-list-loading-message",children:d})}):s.length===0?o.jsx("div",{className:"empty-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-empty-state",children:o.jsx("span",{"data-test":"scrollable-list-empty-message",children:c})}):o.jsx("div",{className:"list-items","data-test":"scrollable-list-items",children:s.map((f,m)=>{const g=m===e,x=p?p(f,m):m;return t(f,m,g,x,g?u:void 0,()=>n==null?void 0:n(f,m),()=>r==null?void 0:r(m))})})})}function Ob({onFileSelect:s,className:e,maxResults:t=10,placeholder:n="Search files...",mode:r="normal",searchMode:a="filename",cwd:i,"data-test":c}){const[l,d]=h.useState([]),[p,u]=h.useState([]),[f,m]=h.useState(t),[g,x]=h.useState(""),[y,w]=h.useState(!0),[v,b]=h.useState(0),[j,S]=h.useState(a);h.useEffect(()=>{(async()=>{try{w(!0);const M=await Xr.getAllFilenames(i),D=[];for(const H of M){const Y=await Xr.getFilePath(H,i);Y&&D.push({filename:H,path:Y})}d(D),u(D),m(t)}catch(M){console.error("Failed to load files:",M)}finally{w(!1)}})()},[t,i]),h.useEffect(()=>{g.startsWith("/")?j!=="fullPath"&&S("fullPath"):j!=="filename"&&S("filename");const T=g.startsWith("/")?g.slice(1):g;if(!T.trim()){u(l),m(t),b(0);return}let M=l;if(j==="fullPath"){const Y=new Set,O=[];for(const q of l){O.push(q),Y.add(q.path);const K=q.path.split("/").filter(Boolean);for(let G=1;G<K.length;G++){const U=K.slice(0,G).join("/")+"/";Y.has(U)||(Y.add(U),O.push({filename:K[G-1],path:U,isDirectory:!0}))}}M=O}const D=[];for(const Y of M)if(j==="fullPath"){const O=mn(T,Y.path);O&&D.push({file:Y,score:O.score,matches:O.matches})}else{const O=mn(T,Y.filename),q=mn(T,Y.path),K=O&&q?O.score>q.score?O:q:O??q;K&&D.push({file:Y,score:K.score,matches:K.matches})}D.sort((Y,O)=>O.score-Y.score);const H=D.map(Y=>Y.file);u(H),m(t),b(0)},[g,l,t,j]);const C=h.useCallback(T=>{s==null||s(T)},[s]),N=h.useCallback(T=>{switch(p.slice(0,f),T.key){case"Tab":if(T.preventDefault(),p[v]&&g.startsWith("/")){const M=p[v].path,D=g.slice(1),H=M.indexOf("/",D.length);if(H!==-1){const Y=M.substring(0,H+1);x("/"+Y)}else x("/"+M)}break;case"ArrowDown":T.preventDefault(),b(M=>{const D=Math.min(M+1,p.length-1);return D>=f-2&&f<p.length&&m(H=>Math.min(H+t,p.length)),D});break;case"ArrowUp":T.preventDefault(),b(M=>Math.max(M-1,0));break;case"Enter":T.preventDefault(),p[v]&&C(p[v]);break;case"Escape":T.preventDefault(),x("");break}},[p,f,v,C,t,g]),A=(T,M)=>{if(!M.trim())return o.jsx("span",{children:T});const D=mn(M,T);if(!D)return o.jsx("span",{children:T});const H=Rb(T,D.matches);return o.jsx("span",{children:H.map((Y,O)=>o.jsx("span",{className:Y.isMatch?"bg-yellow-200 dark:bg-yellow-900 font-semibold":"",children:Y.text},O))})},I=T=>{var H;const M=(H=T.split(".").pop())==null?void 0:H.toLowerCase(),D="w-4 h-4 flex-shrink-0";return["tsx","ts","jsx","js"].includes(M??"")?o.jsx(Rs,{className:B(D,"text-blue-500")}):["json","yml","yaml"].includes(M??"")?o.jsx(Rs,{className:B(D,"text-yellow-500")}):["md","txt"].includes(M??"")?o.jsx(Rs,{className:B(D,"text-gray-500")}):["css","scss"].includes(M??"")?o.jsx(Rs,{className:B(D,"text-purple-500")}):o.jsx(Rs,{className:B(D,"text-muted-foreground")})},k=T=>T.split("/").slice(0,-1).join("/")||"/",P=r==="compact"||r==="fileNameOnly",W=r==="fileNameOnly",R=g.startsWith("/")?g.slice(1):g,F=p.slice(0,f),L=(T,M,D,H,Y,O,q)=>o.jsxs("button",{ref:Y,onClick:O,onMouseEnter:q,className:B("file-item w-full flex items-start hover:bg-accent text-left transition-colors border-b border-border last:border-b-0",P?"px-2 py-1 gap-2":"px-3 py-2 gap-3",D&&"bg-accent"),children:[!W&&(T.isDirectory?o.jsx(Ga,{className:B("w-4 h-4 flex-shrink-0","text-blue-400")}):I(T.filename)),o.jsx("div",{className:"file-info flex-1 min-w-0",children:j==="fullPath"?o.jsx(o.Fragment,{children:o.jsx("div",{className:B("filename font-medium truncate",P?"text-xs":"text-sm"),children:A(T.path,R)})}):o.jsxs(o.Fragment,{children:[o.jsx("div",{className:B("filename font-medium truncate",P?"text-xs":"text-sm"),children:A(T.filename,R)}),!W&&o.jsxs("div",{className:B("file-path text-muted-foreground truncate flex items-center gap-1",P?"text-[10px]":"text-xs"),children:[o.jsx(Ga,{className:B("flex-shrink-0",P?"w-2.5 h-2.5":"w-3 h-3")}),A(k(T.path),R)]})]})})]},H);return o.jsxs("div",{className:B("file-picker flex flex-col",P?"gap-1.5":"gap-3",e),"data-test":c||"file-picker-container",children:[o.jsxs("div",{className:"search-input-wrapper relative","data-test":c?`${c}-search-wrapper`:"file-picker-search-wrapper",children:[o.jsx(er,{className:B("absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none",P?"w-3 h-3":"w-4 h-4"),"data-test":c?`${c}-search-icon`:"file-picker-search-icon"}),o.jsx(_e,{type:"text",value:g,onChange:T=>x(T.target.value),onKeyDown:N,placeholder:n,className:B("search-input pl-9",P&&"h-8 text-xs"),autoFocus:!0,"data-test":c?`${c}-search-input`:"file-picker-search-input"})]}),!W&&o.jsx("div",{className:B("results-info text-xs text-muted-foreground",P?"px-0.5":"px-1"),"data-test":c?`${c}-results-info`:"file-picker-results-info",children:y?o.jsx("span",{"data-test":c?`${c}-loading-text`:"file-picker-loading-text",children:"Loading files..."}):o.jsxs("span",{"data-test":c?`${c}-results-text`:"file-picker-results-text",children:["Showing ",F.length," of ",p.length," results",p.length<l.length&&` (filtered from ${l.length} total)`]})}),o.jsx(Db,{items:F,selectedIndex:v,renderItem:L,onItemClick:T=>C(T),onItemHover:T=>b(T),getItemKey:T=>T.path,height:P?"h-[300px]":"h-[400px]",className:"file-list",emptyMessage:"No files found",isLoading:y,loadingMessage:"Loading files...","data-test":c?`${c}-file-list`:"file-picker-file-list"}),!W&&o.jsxs("div",{className:B("keyboard-hints text-muted-foreground flex",P?"text-[10px] px-0.5 gap-2":"text-xs px-1 gap-4"),"data-test":c?`${c}-keyboard-hints`:"file-picker-keyboard-hints",children:[o.jsxs("span",{children:[o.jsx("kbd",{className:B("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"â†‘â†“"})," Navigate"]}),o.jsxs("span",{children:[o.jsx("kbd",{className:B("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Tab"})," Autocomplete"]}),o.jsxs("span",{children:[o.jsx("kbd",{className:B("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Enter"})," Select"]}),o.jsxs("span",{children:[o.jsx("kbd",{className:B("bg-muted rounded font-mono",P?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Esc"})," Clear"]})]})]})}const jn="â€‹";function qn(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ht(s){const e=[];let t=0,n=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(r,a,i)=>{const c=`LINKPLACEHOLDER${t}END`,l=qn(a),d=`<a href="${i}" class="text-primary underline hover:text-primary/80 cursor-pointer" target="_blank" rel="noopener noreferrer">${l}</a>`;return e.push({placeholder:c,html:d}),t++,c});n=qn(n).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(new RegExp("(?<!\\w)__(.+?)__(?!\\w)","g"),"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(new RegExp("(?<!\\w)_(.+?)_(?!\\w)","g"),"<em>$1</em>").replace(/~~(.+?)~~/g,"<del>$1</del>").replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm font-mono">$1</code>');for(const{placeholder:r,html:a}of e)n=n.replace(r,a);return n}function Cr(s){function e(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent||"";if(t.nodeType===Node.ELEMENT_NODE){const n=t,r=n.tagName.toLowerCase(),a=Array.from(t.childNodes).map(e).join("");switch(r){case"strong":case"b":return`**${a}**`;case"em":case"i":return`*${a}*`;case"del":case"s":return`~~${a}~~`;case"code":return`\`${a}\``;case"a":{const i=n.getAttribute("href")||"";return`[${a}](${i})`}default:return a}}return""}return Array.from(s.childNodes).map(e).join("").trim()}function Qr(s){const e=s.trim(),t=e.startsWith("|")?e.slice(1):e;return(t.endsWith("|")?t.slice(0,-1):t).split("|").map(r=>r.trim())}function hl(s){return Qr(s).every(t=>/^:?-+:?$/.test(t))}function Ro(s){if(s.length<2)return s.map(qn).join("<br>");const e=s.findIndex(a=>hl(a));if(e===-1||e===0)return s.map(qn).join("<br>");const t=s.slice(0,e),n=s.slice(e+1);let r='<table class="markdown-table border-collapse w-full my-2" data-test="markdown-table">';if(t.length>0){r+="<thead>";for(const a of t){const i=Qr(a);r+="<tr>";for(const c of i)r+=`<th class="border border-border px-2 py-1 h-6 bg-muted font-medium text-left">${Ht(c)}</th>`;r+="</tr>"}r+="</thead>"}if(n.length>0){r+="<tbody>";for(const a of n){if(!a.trim())continue;const i=Qr(a);r+="<tr>";for(const c of i)r+=`<td class="border border-border px-2 py-1 h-6">${Ht(c)}</td>`;r+="</tr>"}r+="</tbody>"}return r+="</table>",r}function Lb(s){const e=s.split(`
`),t=[];let n=[],r=!1;for(let i=0;i<e.length;i++){const c=e[i];if(c.trim().startsWith("|")||c.includes("|")&&hl(c))r||(r=!0),n.push(c);else{if(r){const d=Ro(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(d),n=[],r=!1}t.push(c)}}if(r&&n.length>0){const i=Ro(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(i)}const a=[];for(let i=0;i<t.length;i++)t[i].startsWith("__TABLE_PLACEHOLDER_")?i+1<t.length&&(a.push(t[i+1]),i++):a.push(t[i]);return a.join(`
`)}function _b(s){const e=[];let t=!1;const n=s.querySelector("thead");if(n){t=!0;const c=n.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("th, td")).map(p=>Cr(p));e.push(d)}}const r=s.querySelector("tbody");if(r){const c=r.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>Cr(p));e.push(d)}}if(!n&&!r){const c=s.querySelectorAll(":scope > tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>Cr(p));e.push(d)}}if(e.length===0)return"";const a=[],i=Math.max(...e.map(c=>c.length));for(let c=0;c<e.length;c++){const l=e[c];for(;l.length<i;)l.push("");a.push("| "+l.join(" | ")+" |"),t&&c===0&&a.push("| "+l.map(()=>"---").join(" | ")+" |")}if(!t&&e.length>0){const c=e[0];a.splice(1,0,"| "+c.map(()=>"---").join(" | ")+" |")}return a.join(`
`)+`
`}function Bt(s){if(!s)return"";const e=Lb(s),t=[],r=e.replace(/<table[\s\S]*?<\/table>/g,c=>(t.push(c),`MARKDOWNTABLEPLACEHOLDER${t.length-1}ENDPLACEHOLDER`)).split(`
`),a=[];for(let c=0;c<r.length;c++){const l=r[c],d=/^# (.+)$/.test(l),p=/^## (.+)$/.test(l),u=/^### (.+)$/.test(l),f=/^- (.+)$/.test(l),m=/^(\d+)\. (.+)$/.test(l),g=/^> (.+)$/.test(l),x=/^---$/.test(l),y=/^MARKDOWNTABLEPLACEHOLDER\d+ENDPLACEHOLDER$/.test(l),w=l==="";let v;if(u){const b=l.replace(/^### (.+)$/,"$1");v=`<h3>${Ht(b)}</h3>`}else if(p){const b=l.replace(/^## (.+)$/,"$1");v=`<h2>${Ht(b)}</h2>`}else if(d){const b=l.replace(/^# (.+)$/,"$1");v=`<h1>${Ht(b)}</h1>`}else if(g){const b=l.replace(/^> (.+)$/,"$1");v=`<blockquote class="border-l-2 border-muted-foreground/30 pl-3 m-0 text-muted-foreground italic">${Ht(b)}</blockquote>`}else if(x)v='<hr class="border-t border-muted-foreground/30 m-0">';else if(f){const b=l.replace(/^- (.+)$/,"$1"),j=c>0?r[c-1]:"";v=`<div class="${!(/^- /.test(j)||/^\d+\. /.test(j))&&c>0?"mt-[1lh] ":""}list-item-ul flex"><span class="mr-1.5">â€¢</span><span>${Ht(b)}</span></div>`}else if(m){const b=l.match(/^(\d+)\. (.+)$/),j=b[1],S=b[2],C=c>0?r[c-1]:"";v=`<div class="${!(/^- /.test(C)||/^\d+\. /.test(C))&&c>0?"mt-[1lh] ":""}list-item-ol flex"><span class="mr-1.5">${j}.</span><span>${Ht(S)}</span></div>`}else y?v=l:w?v='<div class="empty-line"><br></div>':v=`<div class="paragraph">${Ht(l)}</div>`;a.push(v)}let i=a.join("");for(let c=0;c<t.length;c++)i=i.replace(`MARKDOWNTABLEPLACEHOLDER${c}ENDPLACEHOLDER`,t[c]);return i}function cs(s){if(!s)return"";const e=document.createElement("div");e.innerHTML=s.replace(new RegExp(jn,"g"),"");function t(c,l=!1){if(c.nodeType===Node.TEXT_NODE)return c.textContent||"";if(c.nodeType===Node.ELEMENT_NODE){const d=c,p=d.tagName.toLowerCase(),u=Array.from(c.childNodes).map(f=>t(f,!1)).join("");switch(p){case"strong":case"b":return`**${u}**`;case"em":case"i":return`*${u}*`;case"del":case"s":return`~~${u}~~`;case"code":return`\`${u}\``;case"a":{const f=d.getAttribute("href")||"";return`[${u}](${f})`}case"br":return`
`;case"blockquote":return`> ${u}
`;case"h1":return`# ${u}
`;case"h2":return`## ${u}
`;case"h3":return`### ${u}
`;case"table":return _b(d);case"div":case"p":if(d.classList.contains("list-item-ul")){const f=d.querySelector("span:last-child");return`- ${f?f.textContent||"":u}
`}if(d.classList.contains("list-item-ol")){const f=d.querySelector("span:first-child"),m=d.querySelector("span:last-child"),g=f?(f.textContent||"1.").replace(".",""):"1",x=m?m.textContent||"":u;return`${g}. ${x}
`}if(d.classList.contains("paragraph"))return u+`
`;if(d.classList.contains("empty-line")){const f=d.textContent||"";return f.trim()?f+`
`:`
`}return l?u:u?u+`
`:"";case"span":return d.classList.contains("text-2xl")?`# ${u}`:d.classList.contains("text-xl")?`## ${u}`:d.classList.contains("text-lg")?`### ${u}`:u;default:return u}}return""}const n=t(e,!0);let r=0;const a=Array.from(e.children);for(let c=a.length-1;c>=0;c--){const l=a[c];if(l.classList.contains("empty-line"))if(!(l.textContent||"").trim())r++;else break;else break}return r>0?n.replace(/\n+$/,"")+`
`.repeat(r):n.replace(/\n+$/,"")}const lt={a:["a","Ã¡","Ã ","áº£","Ã£","áº¡","Äƒ","áº¯","áº±","áº³","áºµ","áº·","Ã¢","áº¥","áº§","áº©","áº«","áº­"],A:["A","Ã","Ã€","áº¢","Ãƒ","áº ","Ä‚","áº®","áº°","áº²","áº´","áº¶","Ã‚","áº¤","áº¦","áº¨","áºª","áº¬"],e:["e","Ã©","Ã¨","áº»","áº½","áº¹","Ãª","áº¿","á»","á»ƒ","á»…","á»‡"],E:["E","Ã‰","Ãˆ","áºº","áº¼","áº¸","ÃŠ","áº¾","á»€","á»‚","á»„","á»†"],i:["i","Ã­","Ã¬","á»‰","Ä©","á»‹"],I:["I","Ã","ÃŒ","á»ˆ","Ä¨","á»Š"],o:["o","Ã³","Ã²","á»","Ãµ","á»","Ã´","á»‘","á»“","á»•","á»—","á»™","Æ¡","á»›","á»","á»Ÿ","á»¡","á»£"],O:["O","Ã“","Ã’","á»Ž","Ã•","á»Œ","Ã”","á»","á»’","á»”","á»–","á»˜","Æ ","á»š","á»œ","á»ž","á» ","á»¢"],u:["u","Ãº","Ã¹","á»§","Å©","á»¥","Æ°","á»©","á»«","á»­","á»¯","á»±"],U:["U","Ãš","Ã™","á»¦","Å¨","á»¤","Æ¯","á»¨","á»ª","á»¬","á»®","á»°"],y:["y","Ã½","á»³","á»·","á»¹","á»µ"],Y:["Y","Ã","á»²","á»¶","á»¸","á»´"],d:["d","Ä‘"],D:["D","Ä"]},Mb={s:"acute",f:"grave",r:"hook",x:"tilde",j:"dot"},Fb={w:"horn",aa:"circumflex",aw:"breve",ee:"circumflex",oo:"circumflex",ow:"horn",uw:"horn",dd:"stroke"},ys={a:null,e:null,i:null,o:null,u:null,y:null,d:null,Äƒ:null,Ã¢:null,Ãª:null,Ã´:null,Æ¡:null,Æ°:null,Ä‘:null,Ã¡:"s",áº¯:"s",áº¥:"s",Ã©:"s",áº¿:"s",Ã­:"s",Ã³:"s",á»‘:"s",á»›:"s",Ãº:"s",á»©:"s",Ã½:"s",Ã :"f",áº±:"f",áº§:"f",Ã¨:"f",á»:"f",Ã¬:"f",Ã²:"f",á»“:"f",á»:"f",Ã¹:"f",á»«:"f",á»³:"f",áº£:"r",áº³:"r",áº©:"r",áº»:"r",á»ƒ:"r",á»‰:"r",á»:"r",á»•:"r",á»Ÿ:"r",á»§:"r",á»­:"r",á»·:"r",Ã£:"x",áºµ:"x",áº«:"x",áº½:"x",á»…:"x",Ä©:"x",Ãµ:"x",á»—:"x",á»¡:"x",Å©:"x",á»¯:"x",á»¹:"x",áº¡:"j",áº·:"j",áº­:"j",áº¹:"j",á»‡:"j",á»‹:"j",á»:"j",á»™:"j",á»£:"j",á»¥:"j",á»±:"j",á»µ:"j"};Object.keys(ys).forEach(s=>{const e=s.toUpperCase(),t=ys[s];e!==s&&(ys[e]=t)});function ns(s,e){const t=s.toLowerCase();switch(e){case"breve":return["Äƒ","áº¯","áº±","áº³","áºµ","áº·"].includes(t);case"circumflex":return["Ã¢","áº¥","áº§","áº©","áº«","áº­","Ãª","áº¿","á»","á»ƒ","á»…","á»‡","Ã´","á»‘","á»“","á»•","á»—","á»™"].includes(t);case"horn":return["Æ¡","á»›","á»","á»Ÿ","á»¡","á»£","Æ°","á»©","á»«","á»­","á»¯","á»±"].includes(t);case"stroke":return["Ä‘"].includes(t);default:return!1}}function Ss(s){return s in Mb}function Vn(s){return s==="w"||s==="a"||s==="e"||s==="o"||s==="u"||s==="d"}function qt(s){const e=s.toLowerCase();if(lt[e]!==void 0&&e!=="d")return e;for(const t of["a","e","i","o","u","y"])if(lt[t].includes(e))return t;return null}function $b(s,e,t){const n=s.substring(e,t).toLowerCase(),r=[];for(let a=0;a<n.length;a++){const i=n[a],c=qt(i);c!==null&&r.push({char:i,pos:e+a,base:c})}if(r.length===0)return-1;if(r.length===1)return r[0].pos;if(r.length===2){const a=r[0].base,i=r[1].base,c=r[1].char;return a==="o"&&["a","e"].includes(i)||a==="u"&&i==="y"||["Ãª","Ã´","Æ¡"].includes(c)?r[1].pos:r[0].pos}return r.length>=3?r[1].pos:r[r.length-1].pos}function os(s){return s?/[\s.,;:!?()[\]{}'"<>\/\\-]/.test(s):!0}function Zr(s,e){return s==="a"&&e.includes("a")&&e.includes("w")||s==="a"&&e.includes("w")&&!e.includes("a")?"aw":s==="o"&&e.includes("w")?"ow":s==="u"&&e.includes("w")?"uw":s==="a"&&e.includes("a")?"aa":s==="e"&&e.includes("e")?"ee":s==="o"&&e.includes("o")?"oo":s==="d"&&e.includes("d")?"dd":e.includes("w")?"w":null}function Ub(s){const e=Fb[s];return e==="breve"?"breve":e.includes("circumflex")?"circumflex":e.includes("horn")?"horn":e==="stroke"?"stroke":null}function bs(s,e){const t=lt[s]||[];if(!e||e===s)return t;const n=e.slice(s.length).toLowerCase();let r=null;n.includes("s")?r="s":n.includes("j")?r="j":n.includes("r")?r="r":n.includes("x")?r="x":n.includes("f")&&(r="f");const a=Zr(s,n),i=a?Ub(a):null;return t.filter(c=>!(r!==null&&ys[c]!==r||i&&!ns(c,i)))}function Bb(s){const e=s.toLowerCase();if(lt[e]!==void 0)return!1;for(const t in lt)if(lt[t].includes(e))return!0;return!1}function Do(s){const e=s.toLowerCase();for(const t in lt)if(lt[t].includes(e))return t;return s}function Wb(s,e){let t=-1,n="";const r=s.charAt(e-1).toLowerCase();if(Ss(r)){let a=0;for(let i=e-2;i>=0;i--)if(os(s.charAt(i))){a=i+1;break}for(let i=a;i<e-1;i++){const c=s.charAt(i),l=qt(c);if(l)return{sequenceStart:a,detectedBaseChar:l,found:!0}}}if(Vn(r)){if(r==="w")for(let a=e-2;a>=Math.max(0,e-6);a--){const i=s.charAt(a).toLowerCase();if(os(i))break;if(i==="o"&&a>0&&s.charAt(a-1).toLowerCase()==="u")return{sequenceStart:a-1,detectedBaseChar:"u",found:!0}}for(let a=e-2;a>=Math.max(0,e-6);a--){const i=s.charAt(a).toLowerCase();if(os(i))break;const c=qt(i);if((i===r||c===r)&&lt[r])return{sequenceStart:a,detectedBaseChar:r,found:!0}}}for(let a=e-2;a>=Math.max(0,e-6);a--){const i=s.charAt(a).toLowerCase(),c=qt(i);if(lt[i]||c){if(c!==null&&c!==i&&!(Ss(r)||r===c||r==="w"))return{sequenceStart:-1,detectedBaseChar:"",found:!1};if(t=a,n=c||i,a>0){const p=s.charAt(a-1).toLowerCase(),u=qt(p);(p===n||u===n)&&lt[n]&&(t=a-1)}const d=s.slice(t+1,e-1).toLowerCase();for(const p of d)if(!Ss(p)&&!Vn(p)&&p!==n)return{sequenceStart:-1,detectedBaseChar:"",found:!1};break}}return{sequenceStart:t,detectedBaseChar:n,found:t>=0}}function zb(s){const e=s.slice(0,-1);return/\s/.test(e)}function Hb(s,e,t,n,r){const a=s.slice(t,e).toLowerCase(),i=s.charAt(e-1).toLowerCase();if(e>=2&&s.charAt(e-2),Ss(i)){let d=0;for(let u=e-2;u>=0;u--)if(os(s.charAt(u))){d=u+1;break}s.substring(d,e-1);const p=$b(s,d,e-1);if(p>=0){const u=s.charAt(p),f=u.toLowerCase(),m=Do(f);if(lt[m]){let g="";ns(f,"breve")?g="w":ns(f,"circumflex")?g=m:ns(f,"horn")&&(g="w");const x=m+g+i,y=bs(m,x);if(y.length>0){const w=y[0],v=u===u.toUpperCase()?w.toUpperCase():w,b=s.substring(0,p),j=s.substring(p+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:b+v+j+S,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let u=e-2;u>=Math.max(0,e-6);u--){const f=s.charAt(u);if(os(f))break;if(Bb(f)){const m=Do(f);let g="";const x=f.toLowerCase();ns(x,"breve")?g="w":ns(x,"circumflex")?g=m:ns(x,"horn")&&(g="w");const y=m+g+i,w=bs(m,y);if(w.length>0){const v=w[0],b=s.substring(0,u),j=s.substring(u+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:b+v+j+S,newCursorPos:e-1,realTimeReplacement:!0}}}if(lt[f.toLowerCase()])break}}if(Vn(i)){if(i==="w"){if(s.substring(0,e),n==="u"){const g=s.substring(t,e).toLowerCase();if(g.startsWith("uo")){const x=g.substring(2,g.length-1),y=s.substring(0,t),w=s.substring(e);return{type:"auto-complete",replacement:y+"Æ°Æ¡"+x+w,newCursorPos:t+2+x.length,realTimeReplacement:!0}}}const d=a.toLowerCase();if(d==="uow"||d.endsWith("uow")){const g=s.substring(0,t),x=s.substring(e);return{type:"auto-complete",replacement:g+"Æ°Æ¡"+x,newCursorPos:t+2,realTimeReplacement:!0}}let p=0;for(let g=e-2;g>=0;g--)if(os(s.charAt(g))){p=g+1;break}const u=s.substring(p,e-1);let f=-1,m="";for(let g=u.length-1;g>=0;g--){const x=u[g];if(qt(x.toLowerCase())==="a"){f=p+g,m="a";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(qt(x.toLowerCase())==="o"){f=p+g,m="o";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(qt(x.toLowerCase())==="u"){f=p+g,m="u";break}}if(f>=0){const g=s.charAt(f),x=g.toLowerCase(),y=ys[x];let w=m;w+="w",y&&(w+=y);const v=bs(m,w);if(v.length>0){const b=v[0],j=g===g.toUpperCase()?b.toUpperCase():b,S=s.substring(0,f),C=s.substring(f+1,e-1),N=s.substring(e);return{type:"auto-complete",replacement:S+j+C+N,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let d=e-2;d>=Math.max(0,e-6);d--){const p=s.charAt(d).toLowerCase();if(os(p))break;const u=qt(p);if((p===i||u===i)&&lt[i]){const f=i+i;if(Zr(i,f)){const g=ys[p],x=g?f+g:f,y=bs(i,x);if(y.length>0){const w=y[0],v=s.substring(0,d),b=s.substring(d+1,e-1),j=s.substring(e);return{type:"auto-complete",replacement:v+w+b+j,newCursorPos:e-1,realTimeReplacement:!0}}}break}}}if(zb(a))return{type:"terminate"};const c=Ss(i)||Vn(i);let l=!1;if(c)if(Ss(i))l=!0;else{const d=a.slice(n.length).toLowerCase();Zr(n,d)===null?(e>=2&&s.charAt(e-2).toLowerCase(),t<e-1&&s.charAt(t).toLowerCase()===i&&(l=!0)):l=!0}if(l){const d=bs(n,a);if(d.length>0){const p=d[0],u=s.substring(0,t),f=s.substring(e);return{type:"auto-complete",replacement:u+p+f,newCursorPos:t+1,realTimeReplacement:!0}}return{type:"terminate"}}else return Gb(s,e,t,n,a)}function Gb(s,e,t,n,r){const i=(t>0?s.charAt(t-1).toLowerCase():"")+r;if(i==="uown"||i==="uow"){const l=s.substring(0,t-1),d=s.substring(e),p=s.charAt(e-1);return{type:"auto-complete",replacement:l+"Æ°Æ¡"+p+d,newCursorPos:t-1+2+1}}const c=bs(n,r.slice(0,-1));if(c.length>0){const l=c[0],d=s.substring(0,t),p=s.substring(e),u=s.charAt(e-1);return{type:"auto-complete",replacement:d+l+u+p,newCursorPos:t+1+1}}return{type:"terminate"}}function $C(s){return s!==""&&lt[s]!==void 0}function UC(s,e,t,n){const r=t-1;switch(e){case"right":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===c?i:s+1}case"left":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===i?c:s-1}case"down":{const a=s%n,i=Math.floor(s/n),c=Math.ceil((r+1)/n),l=i+1;if(l>=c){const d=a;return d<=r?d:s}else{const d=l*n+a;return d<=r?d:s}}case"up":{const a=s%n,i=Math.floor(s/n);if(i===0){const d=(Math.ceil((r+1)/n)-1)*n+a;return d<=r?d:s}else return(i-1)*n+a}default:return s}}class qb{constructor(e){this.apiClient=e}log(e,t){try{const{customLogFile:n,...r}=t||{};this.apiClient.sendLogs(e,r,n)}catch(n){console.error("[ClientLogsService] Failed to log event:",e,n)}}logCritical(e,t){try{return this.apiClient.sendBeacon(e,t)}catch(n){return console.error("[ClientLogsService] Failed to log critical event:",e,n),!1}}async clearLogs(){try{return await this.apiClient.clearLogs()}catch(e){return console.error("[ClientLogsService] Failed to clear logs:",e),!1}}}class Vb{constructor(e){this.client=e}async log(e,t){await this.client.sendLogs(e,t)}logCritical(e,t){return this.client.sendBeacon(e,t)}}class Kb{constructor(e={}){Q(this,"_clientLogsApiClient",null);Q(this,"_clientLogsService",null);Q(this,"_logger",null);Q(this,"_config");this._config={clientLogsApiBaseUrl:e.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",clientLogsEnabled:e.clientLogsEnabled!==!1}}get clientLogsApiClient(){return this._clientLogsApiClient||(this._clientLogsApiClient=new ga(this._config.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",5e3)),this._clientLogsApiClient}get clientLogsService(){return this._clientLogsService||(this._clientLogsService=new qb(this.clientLogsApiClient)),this._clientLogsService}get logger(){return this._logger||(this._logger=new Vb(this.clientLogsApiClient)),this._logger}setConfig(e){this._config={...this._config,...e},this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}setClientLogsApiClient(e){this._clientLogsApiClient=e,this._clientLogsService=null,this._logger=null}reset(){this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}}const jr=new Kb;class he{constructor(e,t,n,r){this.isSuccess=e,this.isFailure=t,this._value=n,this._error=r}get value(){if(!this.isSuccess)throw new Error("Cannot get value from a failure result");return this._value}get error(){if(!this.isFailure)throw new Error("Cannot get error from a success result");return this._error}static success(e){return new he(!0,!1,e,void 0)}static failure(e){return new he(!1,!0,void 0,e)}}class Nr extends Error{constructor(e){super(`User not found: ${e}`),this.userId=e,this.name="UserNotFoundError"}}class Jb extends Error{constructor(){super("Username cannot be empty"),this.name="UsernameEmptyError"}}class Yb extends Error{constructor(e){super(`Username must be at least ${e} characters`),this.minLength=e,this.name="UsernameTooShortError"}}class Xb extends Error{constructor(e){super(`Username cannot exceed ${e} characters`),this.maxLength=e,this.name="UsernameTooLongError"}}function dr(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():typeof crypto<"u"&&typeof crypto.getRandomValues=="function"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return(s==="x"?e:e&3|8).toString(16)}):(console.warn("[UUID] Using Math.random() fallback - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}))}class $t{constructor(e,t,n,r,a,i,c){this.id=e,this.username=t,this.profilePicture=n,this.isOnline=r,this.lastSeen=a,this.createdAt=i,this.updatedAt=c,this.validate()}validate(){if(!this.id.trim())throw new Error("User ID cannot be empty");if(!this.username.trim())throw new Error("Username cannot be empty");if(this.username.length<2)throw new Error("Username must be at least 2 characters");if(this.username.length>50)throw new Error("Username cannot exceed 50 characters")}static create(e,t){const n=new Date().toISOString();return new $t(dr(),e.trim(),t,!1,n,n,n)}static fromData(e){return new $t(e.id,e.username,e.profilePicture,e.isOnline,e.lastSeen,e.createdAt,e.updatedAt)}setOnline(e){return new $t(this.id,this.username,this.profilePicture,e,new Date().toISOString(),this.createdAt,new Date().toISOString())}updateProfile(e,t){return new $t(this.id,(e==null?void 0:e.trim())||this.username,t!==void 0?t:this.profilePicture,this.isOnline,this.lastSeen,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,username:this.username,profilePicture:this.profilePicture,isOnline:this.isOnline,lastSeen:this.lastSeen,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Qb{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;console.log("[CreateUserUseCase] Executing with command:",e);try{const n=e.username.trim();if(n.length===0)return console.log("[CreateUserUseCase] Validation failed: Username is empty"),he.failure(new Jb);if(n.length<2)return console.log("[CreateUserUseCase] Validation failed: Username too short"),he.failure(new Yb(2));if(n.length>50)return console.log("[CreateUserUseCase] Validation failed: Username too long"),he.failure(new Xb(50));console.log("[CreateUserUseCase] Validation passed, creating user entity");const r=$t.create(n,e.profilePicture);console.log("[CreateUserUseCase] User entity created:",r),console.log("[CreateUserUseCase] Calling repository.create...");const a=await this.repository.create(r);return console.log("[CreateUserUseCase] User persisted successfully:",a),(t=this.logger)==null||t.log("user_created",{userId:a.id,usernameLength:n.length,hasProfilePicture:!!e.profilePicture}),console.log("[CreateUserUseCase] Returning success result"),he.success(a)}catch(n){return console.error("[CreateUserUseCase] CAUGHT ERROR:",n),he.failure(n instanceof Error?n:new Error("Failed to create user"))}}}class Es{constructor(e,t,n,r,a,i,c,l,d,p){this.id=e,this.gameId=t,this.senderId=n,this.senderUsername=r,this.senderProfilePicture=a,this.text=i,this.timestamp=c,this.createdAt=l,this.isPersona=d,this.isIntroduction=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Message ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.senderId.trim())throw new Error("Sender ID cannot be empty");if(!this.senderUsername.trim())throw new Error("Sender username cannot be empty");if(!this.text.trim())throw new Error("Message text cannot be empty");if(this.text.length>500)throw new Error("Message text cannot exceed 500 characters")}static create(e,t,n,r,a,i,c){const l=new Date().toISOString();return new Es(dr(),e.trim(),t.trim(),n.trim(),r,a.trim(),l,l,i,c)}static fromData(e){return new Es(e.id,e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,e.text,e.timestamp,e.createdAt,e.isPersona,e.isIntroduction)}toJSON(){return{id:this.id,gameId:this.gameId,senderId:this.senderId,senderUsername:this.senderUsername,senderProfilePicture:this.senderProfilePicture,text:this.text,timestamp:this.timestamp,createdAt:this.createdAt,isPersona:this.isPersona,isIntroduction:this.isIntroduction}}}class Zb{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t,n;try{const r=e.text.trim();if(r.length===0)return he.failure(new Error("Message text cannot be empty"));if(r.length>500)return he.failure(new Error("Message text cannot exceed 500 characters"));if(!e.gameId.trim())return he.failure(new Error("Game ID is required"));if(!e.senderId.trim())return he.failure(new Error("Sender ID is required"));if(!e.senderUsername.trim())return he.failure(new Error("Sender username is required"));const a=Es.create(e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,r),i=await this.repository.create(a);if(i.isFailure)return i;const c=/@(\w+)/g,l=Array.from(r.matchAll(c)).map(p=>p[1]);l.length>0&&!e.isFromPersona&&((t=this.logger)==null||t.log("persona_mentioned",{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,mentionedNames:l,mentionCount:l.length}));const d=e.isFromPersona?"persona_message_sent":"chat_message_sent";return(n=this.logger)==null||n.log(d,{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,messageLength:r.length,isFromPersona:e.isFromPersona||!1,hasMentions:l.length>0}),he.success(i.value)}catch(r){return he.failure(r instanceof Error?r:new Error("Failed to send message"))}}}class ey{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;try{if(!e.gameId.trim())return he.failure(new Error("Game ID is required"));const n=await this.repository.findByGameId(e.gameId);return n.isFailure?n:((t=this.logger)==null||t.log("chat_messages_loaded",{gameId:e.gameId,messageCount:n.value.length}),he.success(n.value))}catch(n){return he.failure(n instanceof Error?n:new Error("Failed to retrieve messages"))}}}class ty{constructor(e,t,n,r){Q(this,"_createUserUseCase");Q(this,"_sendMessageUseCase");Q(this,"_getMessagesUseCase");this.userRepository=e,this.chatRepository=t,this.webSocketService=n,this.logger=r}async createUser(e){var n;this._createUserUseCase||(this._createUserUseCase=new Qb(this.userRepository,this.logger));const t=await this._createUserUseCase.execute(e);if(t.isSuccess){const r=await this.setUserOnline({userId:t.value.id,isOnline:!0});if((n=this.logger)==null||n.log("user_set_online",{userId:t.value.id,isOnline:!0,triggeredBy:"user_creation"}),r.isSuccess)return he.success(r.value)}return t}async updateUser(e){try{const t=await this.userRepository.getById(e.userId);if(!t)return he.failure(new Nr(e.userId));const n=t.updateProfile(e.username,e.profilePicture),r=await this.userRepository.update(n);return he.success(r)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to update user"))}}async setUserOnline(e){var t;try{const n=await this.userRepository.getById(e.userId);if(!n)return he.failure(new Nr(e.userId));const r=n.setOnline(e.isOnline),a=await this.userRepository.update(r);return(t=this.logger)==null||t.log("user_online_status_changed",{userId:e.userId,username:n.username,previousStatus:n.isOnline,newStatus:e.isOnline}),he.success(a)}catch(n){return he.failure(n instanceof Error?n:new Error("Failed to set user online status"))}}async deleteUser(e){try{return await this.userRepository.delete(e.userId),he.success(void 0)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to delete user"))}}async getAllUsers(e){try{let t=await this.userRepository.getAll();return e.onlineOnly&&(t=t.filter(n=>n.isOnline)),he.success(t)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to get users"))}}async getUserById(e){try{const t=await this.userRepository.getById(e.userId);return t?he.success(t):he.failure(new Nr(e.userId))}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to get user"))}}async connect(){if(!this.webSocketService)return he.failure(new Error("WebSocket service not configured"));try{return he.success(void 0)}catch(e){return he.failure(e instanceof Error?e:new Error("Failed to connect"))}}async disconnect(){if(!this.webSocketService)return he.failure(new Error("WebSocket service not configured"));try{return await this.webSocketService.disconnect(),he.success(void 0)}catch(e){return he.failure(e instanceof Error?e:new Error("Failed to disconnect"))}}async joinLobby(){if(!this.webSocketService)return he.failure(new Error("WebSocket service not configured"));try{return he.success(void 0)}catch(e){return he.failure(e instanceof Error?e:new Error("Failed to join lobby"))}}async leaveLobby(){if(!this.webSocketService)return he.failure(new Error("WebSocket service not configured"));try{return he.success(void 0)}catch(e){return he.failure(e instanceof Error?e:new Error("Failed to leave lobby"))}}async sendMessage(e){return this._sendMessageUseCase||(this._sendMessageUseCase=new Zb(this.chatRepository,this.logger)),this._sendMessageUseCase.execute(e)}async clearMessages(e){var t;try{return await this.chatRepository.deleteByGameId(e.gameId),(t=this.logger)==null||t.log("chat_messages_cleared",{gameId:e.gameId}),he.success(void 0)}catch(n){return he.failure(n instanceof Error?n:new Error("Failed to clear messages"))}}async getMessages(e){return this._getMessagesUseCase||(this._getMessagesUseCase=new ey(this.chatRepository,this.logger)),this._getMessagesUseCase.execute(e)}}class yt{constructor(e,t,n,r,a,i,c,l,d,p){this.id=e,this.name=t,this.gameType=n,this.players=r,this.status=a,this.currentTurn=i,this.winner=c,this.gameData=l,this.createdAt=d,this.updatedAt=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Game ID cannot be empty");if(this.players.length===0)throw new Error("Game must have at least one player")}static create(e,t,n){const r=new Date().toISOString(),a={metadata:{}};return new yt(dr(),n,t,[e],"waiting",void 0,void 0,a,r,r)}static fromData(e){return new yt(e.id,e.name,e.gameType,e.players,e.status,e.currentTurn,e.winner,e.gameData,e.createdAt,e.updatedAt)}addPlayer(e){if(this.players.includes(e))throw new Error("Player already in game");if(this.players.length>=10)throw new Error("Lobby is full");const n=[...this.players,e],r=n.length>=2?"ready":"waiting";return new yt(this.id,this.name,this.gameType,n,r,this.currentTurn,this.winner,this.gameData,this.createdAt,new Date().toISOString())}start(){if(this.status!=="ready")throw new Error("Lobby must be in ready state to start");return new yt(this.id,this.name,this.gameType,this.players,"in_progress",this.players[0],this.winner,this.gameData,this.createdAt,new Date().toISOString())}updateGameData(e,t){return new yt(this.id,this.name,this.gameType,this.players,this.status,t!==void 0?t:this.currentTurn,this.winner,e,this.createdAt,new Date().toISOString())}complete(e){return new yt(this.id,this.name,this.gameType,this.players,"completed",void 0,e,this.gameData,this.createdAt,new Date().toISOString())}abandon(){return new yt(this.id,this.name,this.gameType,this.players,"abandoned",void 0,this.winner,this.gameData,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,name:this.name,gameType:this.gameType,players:this.players,status:this.status,currentTurn:this.currentTurn,winner:this.winner,gameData:this.gameData,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class St{constructor(e,t,n,r,a,i,c,l){this.id=e,this.gameId=t,this.name=n,this.description=r,this.emoji=a,this.isActive=i,this.createdAt=c,this.updatedAt=l,this.validate()}validate(){if(!this.id.trim())throw new Error("Persona ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.name.trim())throw new Error("Persona name cannot be empty");if(this.name.length<2)throw new Error("Persona name must be at least 2 characters");if(this.name.length>50)throw new Error("Persona name cannot exceed 50 characters");if(!this.description.trim())throw new Error("Persona description cannot be empty");if(this.description.length<5)throw new Error("Persona description must be at least 5 characters");if(this.description.length>500)throw new Error("Persona description cannot exceed 500 characters")}static create(e,t,n,r){const a=new Date().toISOString();return new St(dr(),e.trim(),t.trim(),n.trim(),r.trim(),!1,a,a)}static fromData(e){return new St(e.id,e.gameId,e.name,e.description,e.emoji,e.isActive,e.createdAt,e.updatedAt)}activate(){return this.isActive?this:new St(this.id,this.gameId,this.name,this.description,this.emoji,!0,this.createdAt,new Date().toISOString())}deactivate(){return this.isActive?new St(this.id,this.gameId,this.name,this.description,this.emoji,!1,this.createdAt,new Date().toISOString()):this}update(e,t,n){return new St(this.id,this.gameId,(e==null?void 0:e.trim())||this.name,(t==null?void 0:t.trim())||this.description,(n==null?void 0:n.trim())||this.emoji,this.isActive,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,gameId:this.gameId,name:this.name,description:this.description,emoji:this.emoji,isActive:this.isActive,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class sy{constructor(e,t=5e3){this.baseUrl=e,this.timeout=t}async createUser(e){const t=`${this.baseUrl}/users`;console.log("[HttpGameService.createUser] Making POST request to:",t),console.log("[HttpGameService.createUser] Request body:",e);try{const n=await this.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("[HttpGameService.createUser] Response received:",n.status);const r=await n.json();return console.log("[HttpGameService.createUser] Response data:",r),{user:$t.fromData(r.user)}}catch(n){throw console.error("[HttpGameService.createUser] ERROR:",n),n}}async getUser(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"GET"})).json();return{user:$t.fromData(n.user)}}async getAllUsers(){return{users:(await(await this.fetchWithTimeout(`${this.baseUrl}/users`,{method:"GET"})).json()).users.map(n=>$t.fromData(n))}}async updateUser(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{user:$t.fromData(r.user)}}async createGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{game:yt.fromData(n.game)}}async getGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"GET"})).json();return{game:yt.fromData(n.game)}}async getAllGames(e){const t=new URLSearchParams;e!=null&&e.status&&t.append("status",e.status),e!=null&&e.gameType&&t.append("gameType",e.gameType),e!=null&&e.playerId&&t.append("playerId",e.playerId);const n=`${this.baseUrl}/games${t.toString()?`?${t.toString()}`:""}`;return{games:(await(await this.fetchWithTimeout(n,{method:"GET"})).json()).games.map(i=>yt.fromData(i))}}async joinGame(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{game:yt.fromData(r.game)}}async startGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/start`,{method:"POST"})}async deleteGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"DELETE"})}async createChatMessage(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e.gameId}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderId:e.senderId,senderUsername:e.senderUsername,text:e.text})})).json();return{message:Es.fromData(n.message)}}async getChatMessages(e){return{messages:(await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"GET"})).json()).messages.map(r=>Es.fromData(r))}}async clearChatMessages(e){return await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"DELETE"})).json()}async createPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{persona:St.fromData(n.persona)}}async getPersonas(e){return{personas:(await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"GET"})).json()).personas.map(r=>St.fromData(r))}}async getPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/detail/${e}`,{method:"GET"})).json();return{persona:St.fromData(n.persona)}}async updatePersona(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{persona:St.fromData(r.persona)}}async deletePersona(e){await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"DELETE"})}async activatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/activate`,{method:"POST"})).json();return{persona:St.fromData(n.persona)}}async deactivatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/deactivate`,{method:"POST"})).json();return{persona:St.fromData(n.persona)}}async fetchWithTimeout(e,t){console.log("[fetchWithTimeout] Starting fetch to:",e),console.log("[fetchWithTimeout] Method:",t.method),console.log("[fetchWithTimeout] Timeout:",this.timeout+"ms");const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const a=await fetch(e,{...t,signal:n.signal});if(console.log("[fetchWithTimeout] Response status:",a.status,a.statusText),!a.ok){const i=`HTTP error! status: ${a.status}`;throw console.error("[fetchWithTimeout]",i),new Error(i)}return a}catch(a){if(a instanceof Error&&a.name==="AbortError"){const i=`Request timeout after ${this.timeout}ms`;throw console.error("[fetchWithTimeout]",i),new Error(i)}throw console.error("[fetchWithTimeout] Network error:",a),a}finally{clearTimeout(r)}}}var bt=(s=>(s.DISCONNECTED="DISCONNECTED",s.CONNECTING="CONNECTING",s.CONNECTED="CONNECTED",s.RECONNECTING="RECONNECTING",s.ERROR="ERROR",s))(bt||{});class ny{constructor(){Q(this,"ws",null);Q(this,"config",null);Q(this,"connectionState",bt.DISCONNECTED);Q(this,"messageHandlers",new Set);Q(this,"stateHandlers",new Set);Q(this,"reconnectAttempts",0);Q(this,"reconnectTimeoutId",null);Q(this,"heartbeatIntervalId",null)}async connect(e){return this.config=e,this.reconnectAttempts=0,this.doConnect()}async disconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null),this.ws&&(this.ws.close(),this.ws=null),this.updateConnectionState(bt.DISCONNECTED)}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");const t={...e,timestamp:new Date().toISOString()};this.ws.send(JSON.stringify(t))}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}onConnectionStateChange(e){return this.stateHandlers.add(e),()=>{this.stateHandlers.delete(e)}}getConnectionState(){return this.connectionState}isConnected(){return this.connectionState===bt.CONNECTED}async doConnect(){if(!this.config)throw new Error("Config not set");return new Promise((e,t)=>{this.updateConnectionState(this.reconnectAttempts>0?bt.RECONNECTING:bt.CONNECTING),this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("[WebSocket] Connected"),this.reconnectAttempts=0,this.updateConnectionState(bt.CONNECTED),this.startHeartbeat(),e()},this.ws.onmessage=n=>{try{const r=JSON.parse(n.data);this.handleMessage(r)}catch(r){console.error("[WebSocket] Failed to parse message:",r)}},this.ws.onerror=n=>{console.error("[WebSocket] Error:",n),this.updateConnectionState(bt.ERROR),t(n)},this.ws.onclose=()=>{console.log("[WebSocket] Disconnected"),this.stopHeartbeat(),this.connectionState!==bt.DISCONNECTED&&this.attemptReconnect()}})}handleMessage(e){e.type!=="pong"&&this.messageHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] Message handler error:",n)}})}attemptReconnect(){if(!this.config)return;const e=this.config.maxReconnectAttempts??10;if(this.reconnectAttempts>=e){console.error(`[WebSocket] Max reconnection attempts (${e}) reached`),this.updateConnectionState(bt.ERROR);return}this.reconnectAttempts++;const t=this.config.reconnectInterval??3e3;console.log(`[WebSocket] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${e})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.doConnect().catch(n=>{console.error("[WebSocket] Reconnection failed:",n)})},t)}startHeartbeat(){if(!this.config)return;const e=this.config.heartbeatInterval??3e4;this.heartbeatIntervalId=window.setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping"}).catch(t=>{console.error("[WebSocket] Failed to send heartbeat:",t)})},e)}stopHeartbeat(){this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null)}updateConnectionState(e){this.connectionState!==e&&(this.connectionState=e,this.stateHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] State handler error:",n)}}))}}class ry{constructor(e){this.httpService=e}async getAll(e){return(await this.httpService.getAllGames(e)).games}async getById(e){try{return(await this.httpService.getGame(e)).game}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){return(await this.httpService.createGame({gameType:e.gameType||"tic-tac-toe",creatorId:e.players[0]})).game}async update(e){return e}async delete(e){await this.httpService.deleteGame(e)}}class ay{constructor(e){this.httpService=e}async getAll(){return(await this.httpService.getAllUsers()).users}async getById(e){try{return(await this.httpService.getUser(e)).user}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){console.log("[HttpUserRepository.create] Creating user:",{username:e.username,id:e.id});try{const t=await this.httpService.createUser({username:e.username,profilePicture:e.profilePicture});return console.log("[HttpUserRepository.create] User created successfully:",t.user),t.user}catch(t){throw console.error("[HttpUserRepository.create] ERROR:",t),t}}async update(e){return(await this.httpService.updateUser(e.id,{isOnline:e.isOnline,profilePicture:e.profilePicture})).user}async delete(e){console.warn("[HttpUserRepository] Delete not implemented")}}class oy{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createChatMessage({gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,text:e.text});return he.success(t.message)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to create chat message"))}}async findByGameId(e){try{const t=await this.httpService.getChatMessages(e);return he.success(t.messages)}catch(t){return t instanceof Error&&t.message.includes("404")?he.success([]):he.failure(t instanceof Error?t:new Error("Failed to retrieve chat messages"))}}async deleteByGameId(e){try{return await this.httpService.clearChatMessages(e),he.success(void 0)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to clear chat messages"))}}}class iy{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createPersona({gameId:e.gameId,name:e.name,description:e.description,emoji:e.emoji});return he.success(t.persona)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to create persona"))}}async findByGameId(e){try{const t=await this.httpService.getPersonas(e);return he.success(t.personas)}catch(t){return t instanceof Error&&t.message.includes("404")?he.success([]):he.failure(t instanceof Error?t:new Error("Failed to retrieve personas"))}}async findById(e){try{const t=await this.httpService.getPersona(e);return he.success(t.persona)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to retrieve persona"))}}async update(e,t){try{const n=await this.httpService.updatePersona(e,{name:t.name,description:t.description,emoji:t.emoji,isActive:t.isActive});return he.success(n.persona)}catch(n){return he.failure(n instanceof Error?n:new Error("Failed to update persona"))}}async delete(e){try{return await this.httpService.deletePersona(e),he.success(void 0)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to delete persona"))}}async activate(e){try{const t=await this.httpService.activatePersona(e);return he.success(t.persona)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to activate persona"))}}async deactivate(e){try{const t=await this.httpService.deactivatePersona(e);return he.success(t.persona)}catch(t){return he.failure(t instanceof Error?t:new Error("Failed to deactivate persona"))}}}class cy{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.create(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_created",{personaId:t.value.id,gameId:e.gameId,name:e.name,description:e.description,isActive:t.value.isActive})),t}}class ly{constructor(e){this.personaRepository=e}async execute(e){return await this.personaRepository.findByGameId(e)}}class dy{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t){var r;const n=await this.personaRepository.update(e,t);return n.isSuccess&&((r=this.logger)==null||r.log("persona_updated",{personaId:e,updates:t,name:n.value.name,gameId:n.value.gameId})),n}}class uy{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.delete(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_deleted",{personaId:e})),t}}class py{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t=!0){var r;const n=t?await this.personaRepository.activate(e):await this.personaRepository.deactivate(e);if(n.isSuccess){const a=t?"persona_activated":"persona_deactivated";(r=this.logger)==null||r.log(a,{personaId:e,isActive:t,name:n.value.name,gameId:n.value.gameId})}return n}}const Oa="CONNECT_REQUEST",fl="CONNECT_SUCCESS",ml="CONNECT_FAILURE",La="DISCONNECT",gl="CONNECTION_STATE_CHANGED",xl="CREATE_USER_REQUEST",vl="CREATE_USER_SUCCESS",wl="CREATE_USER_FAILURE",bl="UPDATE_USER_REQUEST",yl="UPDATE_USER_SUCCESS",Sl="UPDATE_USER_FAILURE",Cl="FETCH_USERS_REQUEST",jl="FETCH_USERS_SUCCESS",Nl="FETCH_USERS_FAILURE",El="SET_USER_ONLINE_REQUEST",kl="SET_USER_ONLINE_SUCCESS",Il="SET_USER_ONLINE_FAILURE",Tl="SET_CURRENT_USER",hy="CREATE_GAME_REQUEST",fy="CREATE_GAME_SUCCESS",my="CREATE_GAME_FAILURE",gy="JOIN_GAME_REQUEST",xy="JOIN_GAME_SUCCESS",vy="JOIN_GAME_FAILURE",wy="START_GAME_REQUEST",by="START_GAME_SUCCESS",yy="START_GAME_FAILURE",Sy="MAKE_MOVE_REQUEST",Cy="MAKE_MOVE_SUCCESS",jy="MAKE_MOVE_FAILURE",Ny="LEAVE_GAME_REQUEST",Ey="LEAVE_GAME_SUCCESS",ky="LEAVE_GAME_FAILURE",Iy="FETCH_GAMES_REQUEST",Ty="FETCH_GAMES_SUCCESS",Ay="FETCH_GAMES_FAILURE",Py="GAME_UPDATED",Ry="GAME_ENDED",Al="USER_LIST_UPDATED",Pl="SEND_MESSAGE_REQUEST",Rl="SEND_MESSAGE_SUCCESS",Dl="SEND_MESSAGE_FAILURE",Ol="FETCH_MESSAGES_REQUEST",Ll="FETCH_MESSAGES_SUCCESS",_l="FETCH_MESSAGES_FAILURE",Ml="CLEAR_MESSAGES_REQUEST",Fl="CLEAR_MESSAGES_SUCCESS",$l="CLEAR_MESSAGES_FAILURE",Ul="CHAT_MESSAGE_RECEIVED",Bl="CREATE_PERSONA_REQUEST",Wl="CREATE_PERSONA_SUCCESS",zl="CREATE_PERSONA_FAILURE",Hl="FETCH_PERSONAS_REQUEST",Gl="FETCH_PERSONAS_SUCCESS",ql="FETCH_PERSONAS_FAILURE",Vl="UPDATE_PERSONA_REQUEST",Kl="UPDATE_PERSONA_SUCCESS",Jl="UPDATE_PERSONA_FAILURE",Yl="DELETE_PERSONA_REQUEST",Xl="DELETE_PERSONA_SUCCESS",Ql="DELETE_PERSONA_FAILURE",Zl="ACTIVATE_PERSONA_REQUEST",ed="ACTIVATE_PERSONA_SUCCESS",td="ACTIVATE_PERSONA_FAILURE",sd="PERSONA_CREATED",nd="PERSONA_UPDATED",rd="PERSONA_DELETED",ad="PERSONA_ACTIVATED",od="PERSONA_DEACTIVATED",Dy="SET_SELECTED_GAME",Oy="CLEAR_ERROR",BC=()=>({type:Oa}),Ly=()=>({type:fl}),Oo=s=>({type:ml,error:s}),_y=s=>({type:gl,payload:s}),WC=()=>({type:La}),My=s=>({type:Tl,payload:s}),Fy=()=>({type:Cl}),$y=s=>({type:jl,payload:s}),Uy=s=>({type:Nl,error:s}),By=s=>({type:Al,payload:s}),zC=(s,e)=>async t=>{console.log("[createUser] Starting user creation for username:",s),t({type:xl});const n=Fe.gameApplicationService;console.log("[createUser] Calling application service...");const r=await n.createUser({username:s,profilePicture:e});console.log("[createUser] Result received:",{isSuccess:r.isSuccess,error:r.isSuccess?null:r.error.message}),r.isSuccess?(console.log("[createUser] Success! User created:",r.value),t({type:vl,payload:r.value}),t(My(r.value))):(console.error("[createUser] FAILURE! Error:",r.error.message),t({type:wl,error:r.error.message}))},HC=(s,e,t)=>async n=>{n({type:bl});const a=await Fe.gameApplicationService.updateUser({userId:s,username:e,profilePicture:t});a.isSuccess?n({type:yl,payload:a.value}):n({type:Sl,error:a.error.message})},GC=(s,e)=>async t=>{t({type:El});const r=await Fe.gameApplicationService.setUserOnline({userId:s,isOnline:e});r.isSuccess?t({type:kl,payload:r.value}):t({type:Il,error:r.error.message})},qC=()=>async s=>{s(Fy());const t=await Fe.gameApplicationService.getAllUsers({onlineOnly:!1});t.isSuccess?s($y(t.value)):s(Uy(t.error.message))},Wy=s=>({type:Ul,payload:s}),zy=(s,e,t,n,r,a)=>async i=>{i({type:Pl});const l=await Fe.gameApplicationService.sendMessage({gameId:s,senderId:e,senderUsername:t,senderProfilePicture:n,text:r,isFromPersona:a});l.isSuccess?i({type:Rl,payload:l.value}):i({type:Dl,error:l.error.message})},VC=s=>async e=>{e({type:Ol});const n=await Fe.gameApplicationService.getMessages({gameId:s});n.isSuccess?e({type:Ll,payload:n.value}):e({type:_l,error:n.error.message})},KC=s=>async e=>{e({type:Ml});const n=await Fe.gameApplicationService.clearMessages({gameId:s});n.isSuccess?e({type:Fl,payload:s}):e({type:$l,error:n.error.message})},Hy={maxContextMessages:10,responseDelay:1e3,maxResponseLength:300};function Gy(s){return`You are ${s.name}, an AI assistant in a multiplayer chat lobby.

Your role and behavior:
${s.description}

Guidelines:
- Stay in character as ${s.name}
- Keep responses concise (under 300 characters)
- Be helpful and engaging
- Respond naturally to the conversation flow
- Don't mention that you're an AI unless directly asked
- Use the persona's personality consistently

Current conversation context will be provided. Respond as ${s.name} would.`}class qy{constructor(e,t,n){Q(this,"isProcessing",!1);Q(this,"config");this.ollamaApi=e,this.store=t,this.config={...Hy,...n}}extractMentions(e){const t=/@(\w+)/g;return Array.from(e.matchAll(t)).map(r=>r[1])}async processMessage(e,t){if(console.log("[PersonaResponseService] ========== PROCESSING MESSAGE =========="),console.log("[PersonaResponseService] Message:",e),console.log("[PersonaResponseService] Game ID:",t),this.isProcessing){console.log("[PersonaResponseService] Already processing, skipping");return}try{this.isProcessing=!0;const n=this.store.getState(),r=n.currentUser;if(console.log("[PersonaResponseService] Current user:",r==null?void 0:r.username),console.log("[PersonaResponseService] Total personas in state:",Object.keys(n.personas.byId).length),this.isPersonaMessage(e,n.personas.byId)){console.log("[PersonaResponseService] Message from persona, skipping");return}const a=this.extractMentions(e.text);if(console.log("[PersonaResponseService] Extracted mentions:",a),a.length===0){console.log("[PersonaResponseService] No @mentions in message, skipping");return}console.log("[PersonaResponseService] âœ… Detected @mentions:",a);const c=(n.personas.byGameId[t]||[]).map(d=>n.personas.byId[d]).filter(d=>d&&d.isActive);if(c.length===0){console.log("[PersonaResponseService] No active personas");return}const l=(n.chatMessages[t]||[]).slice(-this.config.maxContextMessages).map(d=>({sender:d.senderUsername,text:d.text,isPersona:this.isPersonaMessage(d,n.personas.byId)}));for(const d of c)a.some(u=>u.toLowerCase()===d.name.toLowerCase())&&(console.log("[PersonaResponseService] Persona @mentioned, generating AI response:",d.name),await this.generatePersonaResponse(d,l,t,r==null?void 0:r.id))}catch(n){console.error("[PersonaResponseService] Error processing message:",n)}finally{this.isProcessing=!1}}isPersonaMessage(e,t){return Object.values(t).some(n=>n.id===e.senderId)}async generatePersonaResponse(e,t,n,r){var a,i;try{await new Promise(u=>setTimeout(u,this.config.responseDelay));const c=[{role:"system",content:Gy(e)},...t.map(u=>({role:u.isPersona?"assistant":"user",content:`${u.sender}: ${u.text}`}))];console.log("[PersonaResponseService] Generating response for:",e.name);const d=(i=(a=(await this.ollamaApi.chat(c,void 0,{stream:!1})).message)==null?void 0:a.content)==null?void 0:i.trim();if(!d){console.log("[PersonaResponseService] No response generated");return}const p=d.length>this.config.maxResponseLength?d.substring(0,this.config.maxResponseLength-3)+"...":d;console.log("[PersonaResponseService] Generated response:",p),this.store.dispatch(zy(n,e.id,e.name,void 0,p,!0))}catch(c){console.error("[PersonaResponseService] Error generating response for",e.name,c)}}}const JC=["gpt-oss:latest","gemma3:4b","gemma3:27b","qwen2.5:32b","qwen3:4b","qwen3:30b","qwen3-vl:latest","qwen3-vl:4b","granite3.2-vision","granite4:small-h","deepseek-r1:32b"],id="gemma3:27b",Lo="http://192.168.2.70:11434";class Vy{constructor(e=id){this.model=e}async generateStructuredCompletion(e,t,n=this.model,r){return((r==null?void 0:r.useEndpoint)??"chat")==="chat"?this.generateStructuredCompletionWithChat(e,t,n,r):this.generateStructuredCompletionWithGenerate(e,t,n,r)}async generateStructuredCompletionWithChat(e,t,n,r){var l;const a=(r==null?void 0:r.system)??"You are a helpful assistant. Always respond in valid JSON format according to the provided schema.",i=await this.chat([{role:"system",content:a},{role:"user",content:e,images:r==null?void 0:r.images}],n,{format:t,stream:!1,signal:r==null?void 0:r.signal});console.log("ðŸ” Raw chat API result:",i);const c=(l=i.message)==null?void 0:l.content;if(console.log("ðŸ” Response type:",typeof c),console.log("ðŸ” Response value:",c),!c)throw console.error("âŒ Empty response from API:",i),new Error("Received empty response from Ollama API");if(typeof c=="string"){if(c.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(c)}catch(d){throw console.error("âŒ JSON parse error. Response was:",c),new Error(`Failed to parse JSON response: ${d instanceof Error?d.message:"Unknown error"}`)}}return c}async generateStructuredCompletionWithGenerate(e,t,n,r){const a=await this.generateCompletion(e,n,{...r,format:t});if(console.log("ðŸ” Raw generate API result:",a),console.log("ðŸ” Response type:",typeof a.response),console.log("ðŸ” Response value:",a.response),!a.response)throw console.error("âŒ Empty response from API:",a),new Error("Received empty response from Ollama API");if(typeof a.response=="string"){if(a.response.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(a.response)}catch(i){throw console.error("âŒ JSON parse error. Response was:",a.response),new Error(`Failed to parse JSON response: ${i instanceof Error?i.message:"Unknown error"}`)}}return a.response}async generateCompletion(e,t=this.model,n){var w;const{suffix:r,images:a,format:i,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f,onStreamChunk:m,signal:g}=n??{stream:!1},x=`${Lo}/api/generate`,y=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:e,suffix:r,images:a,format:i,options:n==null?void 0:n.options,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f}),signal:g});if(!y.ok)throw new Error(`HTTP error! status: ${y.status}`);if(d&&y.headers.get("Content-Type")==="application/x-ndjson"){const v=(w=y.body)==null?void 0:w.getReader(),b=new TextDecoder("utf-8");let j="",S="";for(;;){const{done:C,value:N}=await(v==null?void 0:v.read())??{};if(C)break;j+=b.decode(N,{stream:!0});const A=j.split(`
`);j=A.pop();for(const I of A)if(I.trim()){const k=JSON.parse(I);k.response&&(S+=k.response,m==null||m(k.response)),console.log(k)}}return{response:S}}else{const v=await y.json();return console.log("ðŸ“¥ Non-streaming API response:",v),v}}async chat(e,t=this.model,n){var u,f;const{stream:r,format:a,keep_alive:i,onStreamChunk:c,signal:l}=n??{},d=`${Lo}/api/chat`,p=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,format:a,stream:r,keep_alive:i}),signal:l});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);if(r&&p.headers.get("Content-Type")==="application/x-ndjson"){const m=(u=p.body)==null?void 0:u.getReader(),g=new TextDecoder("utf-8");let x="",y="";for(;;){const{done:w,value:v}=await(m==null?void 0:m.read())??{};if(w)break;x+=g.decode(v,{stream:!0});const b=x.split(`
`);x=b.pop();for(const j of b)if(j.trim()){const S=JSON.parse(j);(f=S.message)!=null&&f.content&&(y+=S.message.content,c==null||c(S.message.content)),console.log(S)}}return{message:{role:"assistant",content:y}}}else return await p.json()}}const Ky=new Vy(id),ea="game_current_user";function Jy(){try{const s=localStorage.getItem(ea);return s?JSON.parse(s):null}catch(s){return console.error("[gameReducer] Failed to load currentUser from localStorage:",s),null}}function Os(s){try{s?localStorage.setItem(ea,JSON.stringify(s)):localStorage.removeItem(ea)}catch(e){console.error("[gameReducer] Failed to save currentUser to localStorage:",e)}}const Yy={connectionState:"DISCONNECTED",isConnected:!1,currentUser:Jy(),users:[],usersLoading:!1,usersError:null,games:[],gamesLoading:!1,gamesError:null,selectedGameId:null,chatMessages:{},chatLoading:!1,chatError:null,personas:{byId:{},byGameId:{},loading:!1,error:null},loading:!1,error:null};function _o(s=Yy,e){var t,n,r,a,i;switch(e.type){case Oa:return{...s,loading:!0,error:null};case fl:return{...s,loading:!1,isConnected:!0,error:null};case ml:return{...s,loading:!1,isConnected:!1,error:e.error};case La:return{...s,isConnected:!1,connectionState:"DISCONNECTED"};case gl:return{...s,connectionState:e.payload,isConnected:e.payload==="CONNECTED"};case Tl:{const c={...s,currentUser:e.payload};return Os(e.payload),c}case xl:return{...s,usersLoading:!0,usersError:null};case vl:{const c={...s,usersLoading:!1,currentUser:e.payload,users:[...s.users,e.payload],usersError:null};return Os(e.payload),c}case wl:return{...s,usersLoading:!1,usersError:e.error};case bl:return{...s,usersLoading:!0,usersError:null};case yl:{const c=((t=s.currentUser)==null?void 0:t.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((n=s.currentUser)==null?void 0:n.id)===e.payload.id&&Os(e.payload),l}case Sl:return{...s,usersLoading:!1,usersError:e.error};case Cl:return{...s,usersLoading:!0,usersError:null};case jl:{const c=e.payload,l=s.currentUser?c.find(p=>p.id===s.currentUser.id):null,d=l?s.currentUser:null;return!l&&s.currentUser&&(console.warn("[gameReducer] Current user not found in backend, clearing localStorage"),Os(null)),{...s,usersLoading:!1,currentUser:d,users:c,usersError:null}}case Nl:return{...s,usersLoading:!1,usersError:e.error};case El:return{...s,usersLoading:!0,usersError:null};case kl:{const c=((r=s.currentUser)==null?void 0:r.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((a=s.currentUser)==null?void 0:a.id)===e.payload.id&&Os(e.payload),l}case Il:return{...s,usersLoading:!1,usersError:e.error};case Al:return{...s,users:e.payload};case hy:return{...s,gamesLoading:!0,gamesError:null};case fy:return{...s,gamesLoading:!1,games:[...s.games,e.payload],gamesError:null};case my:return{...s,gamesLoading:!1,gamesError:e.error};case gy:return{...s,gamesLoading:!0,gamesError:null};case xy:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case vy:return{...s,gamesLoading:!1,gamesError:e.error};case wy:return{...s,gamesLoading:!0,gamesError:null};case by:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case yy:return{...s,gamesLoading:!1,gamesError:e.error};case Sy:return{...s,gamesLoading:!0,gamesError:null};case Cy:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case jy:return{...s,gamesLoading:!1,gamesError:e.error};case Ny:return{...s,gamesLoading:!0,gamesError:null};case Ey:return{...s,gamesLoading:!1,games:s.games.filter(c=>c.id!==e.payload),gamesError:null};case ky:return{...s,gamesLoading:!1,gamesError:e.error};case Iy:return{...s,gamesLoading:!0,gamesError:null};case Ty:return{...s,gamesLoading:!1,games:e.payload,gamesError:null};case Ay:return{...s,gamesLoading:!1,gamesError:e.error};case Py:return{...s,games:s.games.map(c=>c.id===e.payload.id?e.payload:c)};case Ry:return{...s,games:s.games.filter(c=>c.id!==e.payload)};case Pl:return{...s,chatLoading:!0,chatError:null};case Rl:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]},chatError:null}}case Dl:return{...s,chatLoading:!1,chatError:e.error};case Ol:return{...s,chatLoading:!0,chatError:null};case Ll:{if(e.payload.length===0)return{...s,chatLoading:!1,chatError:null};const c=e.payload[0].gameId;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:e.payload},chatError:null}}case _l:return{...s,chatLoading:!1,chatError:e.error};case Ml:return{...s,chatLoading:!0,chatError:null};case Fl:{const c=e.payload;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:[]},chatError:null}}case $l:return{...s,chatLoading:!1,chatError:e.error};case Ul:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return l.find(d=>d.id===c.id)?s:{...s,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]}}}case Bl:case Hl:case Vl:case Yl:case Zl:return{...s,personas:{...s.personas,loading:!0,error:null}};case Wl:case sd:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},byGameId:{...s.personas.byGameId,[c.gameId]:[...s.personas.byGameId[c.gameId]||[],c.id]},loading:!1}}}case Gl:{const{personas:c}=e.payload,l={},d={};return c.forEach(p=>{l[p.id]=p,d[p.gameId]||(d[p.gameId]=[]),d[p.gameId].push(p.id)}),{...s,personas:{...s.personas,byId:{...s.personas.byId,...l},byGameId:{...s.personas.byGameId,...d},loading:!1}}}case Kl:case nd:case ed:case ad:case od:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},loading:!1}}}case Xl:case rd:{const c="id"in e.payload?e.payload.id:e.payload.personaId,l=s.personas.byId[c];if(!l)return s;const{[c]:d,...p}=s.personas.byId,u=((i=s.personas.byGameId[l.gameId])==null?void 0:i.filter(f=>f!==c))||[];return{...s,personas:{...s.personas,byId:p,byGameId:{...s.personas.byGameId,[l.gameId]:u},loading:!1}}}case zl:case ql:case Jl:case Ql:case td:return{...s,personas:{...s.personas,loading:!1,error:e.payload.error}};case Dy:return{...s,selectedGameId:e.payload};case Oy:return{...s,error:null,gamesError:null,usersError:null};default:return s}}const Xy=()=>({type:Bl}),Qy=s=>({type:Wl,payload:{persona:s}}),Zy=s=>({type:zl,payload:{error:s}}),eS=()=>({type:Hl}),tS=s=>({type:Gl,payload:{personas:s}}),sS=s=>({type:ql,payload:{error:s}}),nS=()=>({type:Vl}),rS=s=>({type:Kl,payload:{persona:s}}),aS=s=>({type:Jl,payload:{error:s}}),oS=()=>({type:Yl}),iS=s=>({type:Xl,payload:{id:s}}),cS=s=>({type:Ql,payload:{error:s}}),cd=()=>({type:Zl}),ld=s=>({type:ed,payload:{persona:s}}),dd=s=>({type:td,payload:{error:s}}),lS=s=>({type:sd,payload:{persona:s}}),dS=s=>({type:nd,payload:{persona:s}}),uS=s=>({type:rd,payload:{personaId:s}}),pS=s=>({type:ad,payload:{persona:s}}),hS=s=>({type:od,payload:{persona:s}}),YC=(s,e,t,n)=>async r=>{r(Xy());const a=await Fe.personaUseCases.createPersona.execute({gameId:s,name:e,description:t,emoji:n});a.isSuccess?r(Qy(a.value.toJSON())):r(Zy(a.error.message))},XC=s=>async e=>{e(eS());const t=await Fe.personaUseCases.getPersonas.execute(s);t.isSuccess?e(tS(t.value.map(n=>n.toJSON()))):e(sS(t.error.message))},QC=(s,e)=>async t=>{t(nS());const n=await Fe.personaUseCases.updatePersona.execute(s,e);n.isSuccess?t(rS(n.value.toJSON())):t(aS(n.error.message))},ZC=s=>async e=>{e(oS());const t=await Fe.personaUseCases.deletePersona.execute(s);t.isSuccess?e(iS(s)):e(cS(t.error.message))},ej=s=>async e=>{e(cd());const t=await Fe.personaUseCases.activatePersona.execute(s,!0);t.isSuccess?e(ld(t.value.toJSON())):e(dd(t.error.message))},tj=s=>async e=>{e(cd());const t=await Fe.personaUseCases.activatePersona.execute(s,!1);t.isSuccess?e(ld(t.value.toJSON())):e(dd(t.error.message))},fS=s=>{let e=!1;return t=>n=>{const r=t(n);if(n.type===Oa){if(e)return console.log("[WebSocket Middleware] Connection already initialized"),r;e=!0;const a=Fe.webSocketService,i=Fe.webSocketConfig;a.onMessage(c=>{switch(console.log("[WebSocket Middleware] Received message:",c.type),c.type){case"chat_message":{const d=c.message;d.isIntroduction&&d.isPersona?console.log(`[WebSocket Middleware] ðŸŽ­ Persona introduction received from ${d.senderUsername}:`,d.text):d.isPersona?console.log(`[WebSocket Middleware] ðŸ¤– Persona message received from ${d.senderUsername}:`,d.text):console.log("[WebSocket Middleware] Chat message received:",d),s.dispatch(Wy(d));break}case"user_list":{const d=c.users;console.log("[WebSocket Middleware] User list updated:",d.length,"users"),s.dispatch(By(d));break}case"game_update":{const d=c.game;console.log("[WebSocket Middleware] Game update received:",d.id);break}case"PERSONA_CREATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona created:",d.id),s.dispatch(lS(d));break}case"PERSONA_UPDATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona updated:",d.id),s.dispatch(dS(d));break}case"PERSONA_DELETED":{const d=c.personaId;console.log("[WebSocket Middleware] Persona deleted:",d),s.dispatch(uS(d));break}case"PERSONA_ACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona activated:",d.id),s.dispatch(pS(d));break}case"PERSONA_DEACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona deactivated:",d.id),s.dispatch(hS(d));break}case"error":{const d=c.message;console.error("[WebSocket Middleware] Error from server:",d);break}}}),a.onConnectionStateChange(c=>{if(s.dispatch(_y(c)),c===bt.CONNECTED){s.dispatch(Ly());const d=s.getState().currentUser;d?(console.log(`[WebSocket Middleware] Sending JOIN message for user ${d.username} (${d.id})`),a.send({type:"join",userId:d.id,username:d.username}).catch(p=>{console.error("[WebSocket Middleware] Failed to send JOIN message:",p)})):console.warn("[WebSocket Middleware] No currentUser available to send JOIN message")}else c===bt.ERROR&&s.dispatch(Oo("WebSocket connection failed"))}),a.connect(i).then(()=>{console.log("[WebSocket Middleware] Successfully connected")}).catch(c=>{console.error("[WebSocket Middleware] Connection error:",c),s.dispatch(Oo(c instanceof Error?c.message:"Unknown connection error")),e=!1})}return n.type===La&&Fe.webSocketService.disconnect().then(()=>{console.log("[WebSocket Middleware] Disconnected"),e=!1}).catch(i=>{console.error("[WebSocket Middleware] Disconnect error:",i),e=!1}),r}},mS=s=>e=>t=>e(t),gS=s=>e=>t=>typeof t=="function"?t(s.dispatch,s.getState):e(t);function xS(s=!0){let e=_o(void 0,{type:"@@INIT"});const t=new Set,n={getState(){return e},dispatch(r){let a=i=>(e=_o(e,i),t.forEach(c=>c()),i);return a=fS(n)(a),a=gS(n)(a),s&&(a=mS()(a)),a(r)},subscribe(r){return t.add(r),()=>{t.delete(r)}}};return n}class vS{constructor(){Q(this,"_httpService",null);Q(this,"_webSocketService",null);Q(this,"_gameRepository",null);Q(this,"_userRepository",null);Q(this,"_chatRepository",null);Q(this,"_personaRepository",null);Q(this,"_store",null);Q(this,"_gameApplicationService",null);Q(this,"_config",null);Q(this,"_personaUseCases",null);Q(this,"_personaResponseService",null);Q(this,"_logger",null)}get config(){if(!this._config){const e=()=>`http://${window.location.hostname}:3030/api/multiplayer`,t=()=>`ws://${window.location.hostname}:3030/multiplayer`;this._config={httpApiBaseUrl:e(),webSocketUrl:t(),enableLogging:!0,webSocketReconnectInterval:parseInt("3000",10),webSocketMaxReconnectAttempts:parseInt("10",10),webSocketHeartbeatInterval:parseInt("30000",10),clientLogsEnabled:!0,clientLogsApiBaseUrl:"http://localhost:3030/client-logs"}}return this._config}get httpService(){return this._httpService||(this._httpService=new sy(this.config.httpApiBaseUrl,5e3)),this._httpService}get webSocketService(){return this._webSocketService||(this._webSocketService=new ny),this._webSocketService}get gameRepository(){return this._gameRepository||(this._gameRepository=new ry(this.httpService)),this._gameRepository}get userRepository(){return this._userRepository||(this._userRepository=new ay(this.httpService)),this._userRepository}get chatRepository(){return this._chatRepository||(this._chatRepository=new oy(this.httpService)),this._chatRepository}get personaRepository(){return this._personaRepository||(this._personaRepository=new iy(this.httpService)),this._personaRepository}get personaUseCases(){if(!this._personaUseCases){const e=this.personaRepository,t=this.logger;this._personaUseCases={createPersona:new cy(e,t),getPersonas:new ly(e),updatePersona:new dy(e,t),deletePersona:new uy(e,t),activatePersona:new py(e,t)}}return this._personaUseCases}get clientLogsApiClient(){return jr.clientLogsApiClient}get clientLogsService(){return jr.clientLogsService}get logger(){return jr.logger}get gameApplicationService(){return this._gameApplicationService||(this._gameApplicationService=new ty(this.userRepository,this.chatRepository,this.webSocketService,this.logger)),this._gameApplicationService}get store(){return this._store||(this._store=xS(this.config.enableLogging)),this._store}get personaResponseService(){return this._personaResponseService||(this._personaResponseService=new qy(Ky,this.store)),this._personaResponseService}get webSocketConfig(){return{url:this.config.webSocketUrl,reconnectInterval:this.config.webSocketReconnectInterval,maxReconnectAttempts:this.config.webSocketMaxReconnectAttempts,heartbeatInterval:this.config.webSocketHeartbeatInterval}}reset(){this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._personaResponseService=null,this._store=null,this._gameApplicationService=null,this._config=null}setHttpService(e){this._httpService=e,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._gameApplicationService=null}setWebSocketService(e){this._webSocketService=e,this._gameApplicationService=null}setGameRepository(e){this._gameRepository=e,this._gameApplicationService=null}setUserRepository(e){this._userRepository=e,this._gameApplicationService=null}setGameApplicationService(e){this._gameApplicationService=e}setLogger(e){this._logger=e,this._gameApplicationService=null}setConfig(e){this._config={...this.config,...e},this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._gameApplicationService=null,this._store=null}}const Fe=new vS,sj=Object.freeze(Object.defineProperty({__proto__:null,container:Fe},Symbol.toStringTag,{value:"Module"}));function Mo(s){let e=s.replace(/<strong>([^<]*)<\/strong>/g,"**$1**");return e=e.replace(/<em>([^<]*)<\/em>/g,"*$1*"),e=e.replace(/<code>([^<]*)<\/code>/g,"`$1`"),e=e.replace(/<[^>]+>/g,""),e}function ud(s){const e=[],t=[],n=/<th[^>]*>([\s\S]*?)<\/th>/g;let r;for(;(r=n.exec(s))!==null;)e.push(Mo(r[1]));const a=s.match(/<tbody>([\s\S]*?)<\/tbody>/);if(a){const i=/<tr>([\s\S]*?)<\/tr>/g;let c;for(;(c=i.exec(a[1]))!==null;){const l=/<td[^>]*>([\s\S]*?)<\/td>/g,d=[];let p;for(;(p=l.exec(c[1]))!==null;)d.push(Mo(p[1]));d.length>0&&t.push(d)}}return{headerCells:e,bodyCells:t}}function pd(s){const{headerCells:e,bodyCells:t}=ud(s);let n=0,r=0;if(e.length>0){const a=e.reduce((i,c)=>i+c.length,0);n+=2+a+(e.length-1)*3+2+1,r++,n+=2+e.length*1+(e.length-1)*3+2+1,r++}for(const a of t){const i=a.reduce((c,l)=>c+l.length,0);n+=2+i+(a.length-1)*3+2+1,r++}return{markdownLength:n,lineCount:r}}function hd(s){const{headerCells:e,bodyCells:t}=ud(s),n=[];let r=0,a=0;if(e.length>0){r+=2;for(let i=0;i<e.length;i++){const c=e[i],l=c.trim().length>0;n.push({markdownStart:r,content:c,textNodeIndex:l?a:-1,isEmpty:!l,rowIndex:0,colIndex:i}),l&&a++,r+=c.length,i<e.length-1&&(r+=3)}r+=3,r+=2;for(let i=0;i<e.length;i++)r+=1,i<e.length-1&&(r+=3);r+=3}for(let i=0;i<t.length;i++){const c=t[i];r+=2;for(let l=0;l<c.length;l++){const d=c[l],p=d.trim().length>0;n.push({markdownStart:r,content:d,textNodeIndex:p?a:-1,isEmpty:!p,rowIndex:i+1,colIndex:l}),p&&a++,r+=d.length,l<c.length-1&&(r+=3)}r+=2,i<t.length-1&&(r+=1)}return{cells:n,totalLength:r}}const wS="backspace-debug.log";function bS(s,e){Fe.clientLogsApiClient.sendLogs(s,e,wS)}function ta(s){var re,te,$,V,ee,le,ne,de,fe,xe,Ce,Se;const e=window.getSelection();if(!e||e.rangeCount===0)return{text:cs(s.innerHTML),cursorPos:0};const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");r.appendChild(n.cloneContents());const a=Array.from(r.children).filter(_=>{const E=_.tagName.toLowerCase();return E==="h1"||E==="h2"||E==="h3"||E==="div"||E==="blockquote"||E==="hr"||E==="table"});a.length>0&&a.length-1;const i=r.querySelectorAll(".empty-line"),c=Array.from(i).filter(_=>{var z;return(((z=_.textContent)==null?void 0:z.trim())||"").length===0});let l=0;const d=t.startContainer;if(d.nodeType===Node.ELEMENT_NODE)(re=d.classList)!=null&&re.contains("empty-line")&&(l=1);else if(d.nodeType===Node.TEXT_NODE){const _=d.parentElement;(te=_==null?void 0:_.classList)!=null&&te.contains("empty-line")&&(l=1)}const p=a.filter(_=>!_.classList.contains("empty-line")),u=c.length,f=(p.length>0?p.length-1:0)+u+l;let m=0;r.querySelectorAll("h1").forEach(()=>{m+=2}),r.querySelectorAll("h2").forEach(()=>{m+=3}),r.querySelectorAll("h3").forEach(()=>{m+=4}),r.querySelectorAll("blockquote").forEach(()=>{m+=2}),r.querySelectorAll("hr").forEach(()=>{m+=3});const g=r.querySelectorAll("h1, h2, h3, blockquote, hr"),x=s.querySelectorAll("h1, h2, h3, blockquote, hr");let y=!1;const w=t.startContainer;for(const _ of x)if(_.contains(w)){y=!0;break}const v=s.querySelectorAll(".list-item-ul, .list-item-ol");for(const _ of v)if(_.contains(w))break;const b=s.querySelectorAll("table");let j=null,S=null;for(const _ of b)if(_.contains(w)){j=_;const E=_.querySelectorAll("th, td");for(const z of E)if(z.contains(w)||z===w){S=z;break}break}const C=0;let N=0;x.forEach(_=>{var z;const E=_.nextSibling||_.nextElementSibling;if(E){const pe=E.nodeName==="BR"||E.nodeType===Node.ELEMENT_NODE&&E.tagName==="BR",X=E.nodeType===Node.ELEMENT_NODE&&((z=E.classList)==null?void 0:z.contains("empty-line")),ce=E.nodeType===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(E.tagName);!pe&&!X&&!ce&&(N+=1)}});let A=g.length;y&&A>0&&(A-=1);const I=Math.min(N,A);m+=I;const k=r.querySelectorAll(":scope > div:not(.list-item-ul):not(.list-item-ol):not(.empty-line):not(.paragraph)");r.querySelectorAll("h1, h2, h3, blockquote, hr, .list-item-ul, .list-item-ol, .paragraph").length===0&&k.length>1&&(m+=k.length-1);const W=r.querySelectorAll(".list-item-ul");W.forEach(()=>{m+=1});const R=r.querySelectorAll(".list-item-ol");R.forEach(()=>{m+=1});const F=W.length+R.length;if(F>1&&(m+=F-1),F>0){let E=(R.length>0?R[R.length-1]:W[W.length-1]).nextSibling;for(;E;){if(E.nodeType===Node.TEXT_NODE){const z=($=E.textContent)==null?void 0:$.replace(new RegExp(jn,"g"),"").trim();if(z&&z.length>0){m+=1;break}}else if(E.nodeType===Node.ELEMENT_NODE)break;E=E.nextSibling}}const T=(r.textContent||"").replace(new RegExp(jn,"g"),""),D=Array.from(r.querySelectorAll(".empty-line")).filter(_=>{var z;return(((z=_.textContent)==null?void 0:z.trim())||"").length>0}).length;let H=0;const Y=w.nodeType===Node.TEXT_NODE&&(((V=w.parentElement)==null?void 0:V.tagName)==="STRONG"||((ee=w.parentElement)==null?void 0:ee.tagName)==="B"),O=w.nodeType===Node.TEXT_NODE&&(((le=w.parentElement)==null?void 0:le.tagName)==="EM"||((ne=w.parentElement)==null?void 0:ne.tagName)==="I"),q=w.nodeType===Node.TEXT_NODE&&((de=w.parentElement)==null?void 0:de.tagName)==="CODE",K=w.nodeType===Node.TEXT_NODE&&(((fe=w.parentElement)==null?void 0:fe.tagName)==="DEL"||((xe=w.parentElement)==null?void 0:xe.tagName)==="S"),G=_=>{const E=r.querySelectorAll(_);let z=0;for(const pe of E)!pe.closest("table")&&pe.textContent&&pe.textContent.length>0&&z++;return z};H+=G("strong, b")*4,H+=G("em, i")*2,H+=G("code")*2,H+=G("del, s")*4;let U=0;const Z=r.querySelectorAll("table");Z.forEach(_=>{var pe,X;const E=_.outerHTML,z=_===Z[Z.length-1];if(j&&S&&z){const ve=Array.from(j.querySelectorAll("th, td")).findIndex(Ae=>Ae===S||Ae.contains(w)),ye=Array.from(_.querySelectorAll("th, td"));if(ve>=0){const Ae=hd(E);if(ve<Ae.cells.length){const Oe=Ae.cells[ve],De=t.startOffset,Ue=Oe.markdownStart+De;let Be=0;for(let et=0;et<ve;et++)Be+=((pe=ye[et].textContent)==null?void 0:pe.length)||0;Be+=De,U+=Ue-Be}}}else{const{markdownLength:ce}=pd(E),ve=(_.textContent||"").length;U+=ce-ve;const ye=_.nextSibling||_.nextElementSibling,Ae=(ye==null?void 0:ye.nodeName)==="BR"||(ye==null?void 0:ye.nodeType)===Node.ELEMENT_NODE&&ye.tagName==="BR",Oe=!ye||ye.nodeType===Node.TEXT_NODE&&!((X=ye.textContent)!=null&&X.trim()),De=(ye==null?void 0:ye.nodeType)===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(ye.tagName);!Ae&&!Oe&&!De&&(U+=1),De&&(U-=1)}});const ue=T.length+f+m+D+U+H+C;let we=cs(s.innerHTML);const Te=s.innerHTML.replace(new RegExp(jn+"$"),""),ke=/(<br>)+$/.exec(Te);if(ke){const _=(ke[0].match(/<br>/g)||[]).length,E=(/\n+$/.exec(we)||[""])[0].length,z=_-E;z>0&&(we=we+`
`.repeat(z))}const Ee=t.startContainer.nodeType===Node.TEXT_NODE&&t.startContainer.textContent==="â€‹",$e=Ee&&(((Se=(Ce=t.startContainer.parentElement)==null?void 0:Ce.classList)==null?void 0:Se.contains("empty-line"))??!1),ge=Ee&&!$e?-1:0,ie=ue+ge;return bS("GET_CURSOR_POS",{cursorPos:ue,textContentLength:T.length,brCount:f,markdownPrefixChars:m,blockNewlinesBeforeCursor:I,emptyLineTextNewlines:D,tableMarkdownDiff:U,formattingOverhead:H,cursorInFormatting:{cursorInStrong:Y,cursorInEm:O,cursorInCode:q,cursorInDel:K},boundaryAdjustment:C,fullTextLength:we.length,context5Before:we.substring(Math.max(0,ue-5),ue),context5After:we.substring(ue,Math.min(we.length,ue+5)),anchorNodeType:t.startContainer.nodeType===Node.TEXT_NODE?"text":"element",anchorOffset:t.startOffset,isInZws:Ee,zwsAdjustment:ge,adjustedCursorPos:ie}),{text:we,cursorPos:ie}}function yS(s){const e=s.match(/<th[^>]*>([^<]*)<\/th>/g)||[],t=s.match(/<td[^>]*>([^<]*)<\/td>/g)||[],n=s.match(/<th[^>]*>(?=.*\S)[\s\S]*?<\/th>/g)||[],r=s.match(/<td[^>]*>(?=.*\S)[\s\S]*?<\/td>/g)||[];let a=0;const i=[...new Set([...e,...n])],c=[...new Set([...t,...r])];for(const l of i)l.replace(/<[^>]+>/g,"").trim().length>0&&a++;for(const l of c)l.replace(/<[^>]+>/g,"").trim().length>0&&a++;return a}function SS(s){const e=/<table[^>]*>[\s\S]*?<\/table>/g,t=[];let n=s,r=0,a;for(;(a=e.exec(s))!==null;){const i=a[0],{markdownLength:c,lineCount:l}=pd(i),d=yS(i);t.push({start:a.index-r,end:a.index+i.length-r,markdownLength:c,lineCount:l,textNodeCount:d,html:i});const p=`__TABLE_${t.length-1}__`;n=n.slice(0,a.index-r)+p+n.slice(a.index+i.length-r),r+=i.length-p.length}return{processedHtml:n,tables:t}}function CS(s){return s==="<strong>"||s==="</strong>"||s==="<b>"||s==="</b>"?{type:"formatting",markdownChars:2}:s==="<em>"||s==="</em>"||s==="<i>"||s==="</i>"?{type:"formatting",markdownChars:1}:s.startsWith("<code")||s==="</code>"?{type:"formatting",markdownChars:1}:s==="<del>"||s==="</del>"||s==="<s>"||s==="</s>"?{type:"formatting",markdownChars:2}:null}function jS(s){const{processedHtml:e,tables:t}=SS(s),n=[];let r=0,a=0,i=0,c=0,l=!1,d=!1,p=!1,u=null;const f=/(__TABLE_(\d+)__)|(<div class="empty-line"><br><\/div>)|(<br>)|(<h([123])>)|(<blockquote[^>]*>)|(<div[^>]*(list-item-(ul|ol))[^>]*>)|(<[^>]+>)|([^<]+)/g;let m;for(;(m=f.exec(e))!==null;)if(m[1]){const g=parseInt(m[2],10),x=t[g];n.push({type:"table",tableIndex:g,markdownLength:x.markdownLength,lineCount:x.lineCount,textNodeCount:x.textNodeCount})}else if(m[3])n.push({type:"br-empty-line",index:i++});else if(m[4])n.push({type:"br-standalone",index:a++});else if(m[5]){const g=parseInt(m[6],10);n.push({type:"header",level:g}),u=g}else if(m[7])n.push({type:"blockquote"});else if(m[8]){const g=m[10];n.push({type:"list-item-start",listType:g,index:c++}),l=g==="ol",p=!0}else if(m[11]){const g=m[11].toLowerCase(),x=m[11],y=CS(g);y&&n.push(y),(x.includes('class="paragraph"')||x.includes("class='paragraph'"))&&(d=!0),x==="</div>"&&(l=!1,d&&(n.push({type:"block-end"}),d=!1),p&&(n.push({type:"block-end"}),p=!1)),/^<\/h[123]>$/.test(x)&&(u=null,n.push({type:"block-end"})),x==="</blockquote>"&&n.push({type:"block-end"})}else if(m[12]){const g=m[12];if(/^\s+$/.test(g)){r++,n.push({type:"whitespace",length:g.length});continue}const x=g==="â€¢",y=l&&/^\d+\.$/.test(g),w=u!==null,v=u;w&&(u=null),n.push({type:"text",content:g,index:r++,isBullet:x,isOlNumber:y,isHeaderText:w,headerLevel:v}),l&&(l=!1)}return{tokens:n,tables:t,processedHtml:e}}function NS(s){const e=(s.match(/<strong>/g)||[]).length,t=(s.match(/<em>/g)||[]).length,n=(s.match(/<code[^>]*>/g)||[]).length,r=e*4+t*2+n*2;return{strongCount:e,emCount:t,codeCount:n,totalOverhead:r}}function ES(s,e,t,n,r,a){const i=s-e,c=hd(t.html);for(let l=0;l<c.cells.length;l++){const d=c.cells[l],p=d.markdownStart,u=p+d.content.length;if(i>=p&&i<=u){if(d.isEmpty)return{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in empty table cell at row ${d.rowIndex}, col ${d.colIndex}`,emptyCellIndex:l,emptyCellRow:d.rowIndex,emptyCellCol:d.colIndex};const f=i-p;return{nodeType:"text",nodeIndex:n+d.textNodeIndex,offset:Math.min(f,d.content.length),expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is within table cell "${d.content.substring(0,20)}" at offset ${f}`}}}if(c.cells.length>0){const l=c.cells[c.cells.length-1],d=l.markdownStart+l.content.length;if(i>=d)return l.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is after last (empty) table cell at row ${l.rowIndex}, col ${l.colIndex}`,emptyCellIndex:c.cells.length-1,emptyCellRow:l.rowIndex,emptyCellCol:l.colIndex}:{nodeType:"text",nodeIndex:n+l.textNodeIndex,offset:l.content.length,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is past last table cell, placing at end of "${l.content.substring(0,20)}"`};{for(let f=0;f<c.cells.length;f++){const m=c.cells[f],g=f>0?c.cells[f-1].markdownStart+c.cells[f-1].content.length:0;if(i>=g&&i<m.markdownStart)return m.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before empty table cell at row ${m.rowIndex}, col ${m.colIndex}`,emptyCellIndex:f,emptyCellRow:m.rowIndex,emptyCellCol:m.colIndex}:{nodeType:"text",nodeIndex:n+m.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before cell "${m.content.substring(0,20)}", placing at start`}}const p=c.cells[0];return p.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing in empty first cell`,emptyCellIndex:0,emptyCellRow:p.rowIndex,emptyCellCol:p.colIndex}:{nodeType:"text",nodeIndex:n+p.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing at start of first cell`}}}return{nodeType:"text",nodeIndex:(n>0?n-1:0)+a,offset:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!1,placeBefore:!1,explanation:`Position ${s} is within table but no cells found`}}function kS(s,e,t,n,r,a){const i=t;let c;s.isBullet?c=2:s.isOlNumber?c=s.content.length+1:c=s.content.length;const l=i,d=i+c;if(s.isBullet||s.isOlNumber?e>=l&&e<d:e>=l&&e<=d){const u=s.index+r;if(s.isBullet){const f=Math.min(e-l,1);return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within bullet text node #${u} at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else if(s.isOlNumber){const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within OL number text node #${u} "${s.content}" at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else{const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within text node #${u} "${s.content.substring(0,20)}..." at offset ${f}`},newPos:d,adjustedPos:i}}}return{placement:null,newPos:d,adjustedPos:i}}function Fo(s,e,t,n,r,a,i){const c=n+1;return t===n?{nodeType:s,nodeIndex:e,offset:0,expectedLine:r-1,tableTextNodeOffset:a,insideTableCell:!1,placeBefore:!0,explanation:`Position ${t} is at ${s} #${e}`}:t===c&&s==="br-standalone"?{nodeType:s,nodeIndex:e,offset:i?1:0,expectedLine:r,tableTextNodeOffset:a,insideTableCell:!1,placeBefore:!1,explanation:`Position ${t} is after ${s} #${e}`}:null}const IS="backspace-debug.log";function Er(s,e){Fe.clientLogsApiClient.sendLogs(s,e,IS)}function TS(s,e){const{tokens:t,tables:n,processedHtml:r}=jS(s),{strongCount:a,emCount:i,codeCount:c,totalOverhead:l}=NS(r),d=t.filter(j=>j.type==="formatting"),p=d.reduce((j,S)=>j+S.markdownChars,0);Er("FORMATTING_OVERHEAD",{strongCount:a,emCount:i,codeCount:c,formattingOverhead:l,targetPos:e,formattingTokensCount:d.length,formattingTokensTotal:p});let u=0,f=1,m=!1,g=!1,x=0,y=0,w=0,v=!1;for(let j=0;j<t.length;j++){const S=t[j];if(S.type==="header"){x=S.level+1,g=!1;continue}if(S.type==="formatting"){const C=u;u+=S.markdownChars,e===727&&Er("BC35_FORMATTING_ADDED",{targetPos:e,tokenIdx:j,chars:S.markdownChars,posBefore:C,posAfter:u});continue}if(S.type==="whitespace"){u+=S.length;continue}if(S.type==="block-end"){v=!0;continue}if(S.type==="blockquote"){u+=2,g=!1;continue}if(S.type==="table"){v&&(u+=1,f++,v=!1);const C=u,N=u+S.markdownLength,A=n[S.tableIndex];if(Er("TABLE_RANGE_CHECK",{targetPos:e,tableStart:C,tableEnd:N,tableMarkdownLength:S.markdownLength,textNodesSeen:w,isTargetInTable:e>=C&&e<N}),e>=C&&e<N){const I=ES(e,C,A,w,f,y);if(I)return I}u=N,f+=S.lineCount,y+=S.textNodeCount,g=!1;continue}if(S.type==="list-item-start"){v?(u+=1,f++,v=!1):m&&!g&&(u+=1,f++),m=!0,g=!1;continue}if(S.type==="text"){if(v){if(e===u)return{nodeType:"text",nodeIndex:S.index+y,offset:0,expectedLine:f,tableTextNodeOffset:y,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at implicit newline after block element`};u+=1,f++,v=!1}x>0&&(u+=x,x=0);const C=kS(S,e,u,f,y);if(C.placement)return C.placement;u=C.newPos,w++,g=!1}else if(S.type==="br-standalone"){v&&(v=!1),f++;const C=Fo("br-standalone",S.index,e,u,f,y,!1);if(C)return C;u+=1,g=!0,m=!1}else if(S.type==="br-empty-line"){v&&(u+=1,f++,v=!1),f++;const C=Fo("br-empty-line",S.index,e,u,f,y,!0);if(C)return C;u+=1,g=!0,m=!1}}const b=t[t.length-1];if((b==null?void 0:b.type)==="text"){const j=b.index+y;return{nodeType:"text",nodeIndex:j,offset:b.content.length,expectedLine:f,tableTextNodeOffset:y,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at end of last text node #${j}`}}return{nodeType:"end",nodeIndex:0,offset:0,expectedLine:f,tableTextNodeOffset:y,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is beyond content (currentPos=${u})`}}const AS="backspace-debug.log";function Jt(s,e){Fe.clientLogsApiClient.sendLogs(s,e,AS)}function Ks(s,e){var a,i;const t=window.getSelection();if(!t)return;const n=TS(s.innerHTML,e);Jt("SET_CURSOR_START",{targetPos:e,placementNodeType:n.nodeType,placementNodeIndex:n.nodeIndex,placementOffset:n.offset,placementExplanation:n.explanation,htmlLength:s.innerHTML.length,htmlSnippet:s.innerHTML.length<300?s.innerHTML:`${s.innerHTML.substring(0,150)}...`});const r=document.createRange();if(n.nodeType==="text"){let c;if(n.insideTableCell)c=n.nodeIndex;else if(n.tableTextNodeOffset===0)c=n.nodeIndex;else{const m=s.querySelectorAll("table");let g=0;m.forEach(y=>{const w=document.createTreeWalker(y,NodeFilter.SHOW_TEXT);for(;w.nextNode()!==null;)g++});const x=n.tableTextNodeOffset;c=n.nodeIndex-x+g}const l=document.createTreeWalker(s,NodeFilter.SHOW_TEXT);let d=null,p=0,u=null;const f=[];for(;(d=l.nextNode())!==null;){u=d;const m=d.textContent||"";if(f.push(`[${p}]: "${m.substring(0,30)}${m.length>30?"...":""}"`),p===c){const g=(d.textContent||"").length,x=Math.min(n.offset,g);if(Jt("SET_CURSOR_TEXT_NODE",{targetPos:e,correctedNodeIndex:c,actualOffset:x,maxOffset:g,placedInNode:m.substring(0,50),allTextNodes:f,atListItemStart:n.atListItemStart}),n.atListItemStart){const y=(a=d.parentElement)==null?void 0:a.closest(".list-item-ul, .list-item-ol");if(y&&y.parentNode){const w=document.createTextNode("â€‹");y.parentNode.insertBefore(w,y),r.setStart(w,1),r.collapse(!0),t.removeAllRanges(),t.addRange(r),Jt("SET_CURSOR_BEFORE_LIST_ITEM",{targetPos:e,listItemClass:y.className,insertedZwsBefore:!0});return}}r.setStart(d,x),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}p++}if(u){const m=(u.textContent||"").length;Jt("SET_CURSOR_FALLBACK_LAST_TEXT",{targetPos:e,correctedNodeIndex:c,textNodeCount:p,fallbackOffset:m,lastNodeContent:(u.textContent||"").substring(0,50),allTextNodes:f}),r.setStart(u,m),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}if(n.nodeType==="empty-table-cell"){const c=s.querySelector("table");if(c){const l=c.querySelectorAll("tr");let d=null,p=null;if(n.emptyCellRow===0)d=l[0],d&&(p=d.querySelectorAll("th")[n.emptyCellCol??0]);else{const u=c.querySelector("tbody");u?d=u.querySelectorAll("tr")[(n.emptyCellRow??1)-1]:d=l[n.emptyCellRow??1],d&&(p=d.querySelectorAll("td")[n.emptyCellCol??0])}if(p){const u=document.createTextNode("â€‹");p.appendChild(u),r.setStart(u,0),r.collapse(!0),t.removeAllRanges(),t.addRange(r),Jt("SET_CURSOR_EMPTY_TABLE_CELL",{targetPos:e,emptyCellRow:n.emptyCellRow,emptyCellCol:n.emptyCellCol,cellFound:!0});return}}Jt("SET_CURSOR_EMPTY_TABLE_CELL_NOT_FOUND",{targetPos:e,emptyCellRow:n.emptyCellRow,emptyCellCol:n.emptyCellCol,tableExists:!!s.querySelector("table")})}if(n.nodeType==="br-standalone"){const c=s.querySelectorAll("br");let l=0;const d=[];for(const p of c){const u=p.parentElement,f=u==null?void 0:u.classList.contains("empty-line"),m=p.closest("table")!==null,g=`BR[${l}]: parent=${u==null?void 0:u.tagName}, emptyLine=${f}, inTable=${m}`;if(d.push(g),!f&&!m){if(l===n.nodeIndex){if(n.placeBefore)r.setStartBefore(p),r.collapse(!0);else{const v=p.nextSibling;if(v)if(v.nodeType===Node.TEXT_NODE)r.setStart(v,0);else if(v.tagName==="BR"){const b=document.createTextNode("â€‹");p.parentNode.insertBefore(b,v),r.setStart(b,1)}else{const b=document.createTextNode("â€‹");p.parentNode.insertBefore(b,v),r.setStart(b,1)}else{const b=document.createTextNode("â€‹");p.parentNode.appendChild(b),r.setStart(b,1)}r.collapse(!0)}t.removeAllRanges(),t.addRange(r);const x=t.getRangeAt(0),y=x.startContainer,w=x.startOffset;Jt("SET_CURSOR_BR_FOUND",{targetPos:e,targetBrIndex:n.nodeIndex,foundAtIndex:l,totalBrs:c.length,verifyNodeType:y.nodeType===Node.TEXT_NODE?"text":"element",verifyNodeName:y.nodeName,verifyOffset:w,verifyParent:((i=y.parentElement)==null?void 0:i.tagName)||"none"});return}l++}}Jt("SET_CURSOR_BR_NOT_FOUND",{targetPos:e,targetBrIndex:n.nodeIndex,totalBrs:c.length,standaloneBrCount:l,brContexts:d})}if(n.nodeType==="br-empty-line"){const l=s.querySelectorAll(".empty-line")[n.nodeIndex];if(l){if(n.placeBefore)r.setStart(l,0);else{const d=l.querySelector("br"),p=document.createTextNode("â€‹");d&&d.nextSibling?l.insertBefore(p,d.nextSibling):l.appendChild(p),r.setStart(p,1)}r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.selectNodeContents(s),r.collapse(!1),t.removeAllRanges(),t.addRange(r)}function _a(s){let e="";function t(n){var r;if(n.nodeType===Node.TEXT_NODE)e+=n.textContent||"";else if(n.nodeType===Node.ELEMENT_NODE){const a=n,i=a.tagName.toLowerCase();if(i==="br")e+=`
`;else if(i==="div"||i==="p"){const c=a.childNodes.length===1&&((r=a.firstChild)==null?void 0:r.nodeName)==="BR";e.length>0&&!e.endsWith(`
`)&&!c&&(e+=`
`),a.childNodes.forEach(t)}else a.childNodes.forEach(t)}}return s.childNodes.forEach(t),e}function PS(s){let e=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return e.endsWith("<br>")&&(e+="â€‹"),e}function RS(s){const e=window.getSelection();if(!e||e.rangeCount===0)return 0;const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");return r.appendChild(n.cloneContents()),_a(r).length}function DS(s,e){const t=window.getSelection();if(!t)return;let n=0;const r=document.createTreeWalker(s,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let a=r.nextNode();for(;a;){if(a.nodeType===Node.TEXT_NODE){const l=(a.textContent||"").length;if(n+l>=e){const d=document.createRange(),p=e-n;d.setStart(a,Math.min(p,l)),d.collapse(!0),t.removeAllRanges(),t.addRange(d);return}n+=l}else a.nodeName==="BR"&&(n+=1);a=r.nextNode()}const i=document.createRange();i.selectNodeContents(s),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}function OS(s){const{editorRef:e,applyingActionRef:t,value:n,isRawMode:r,setInternalValue:a,onChange:i}=s,c=h.useCallback(()=>{if(!e.current)return null;if(r){const d=_a(e.current),p=RS(e.current);return{text:d,cursorPos:p}}else{const{cursorPos:d}=ta(e.current);return{text:n??ta(e.current).text,cursorPos:d}}},[e,r,n]),l=h.useCallback((d,p)=>{if(!e.current)return;t.current=!0;let u;if(d.replaceTextAfterCursor!==void 0?u=p.substring(0,d.selectionStart)+d.textToInsert+d.replaceTextAfterCursor:u=p.substring(0,d.selectionStart)+d.textToInsert+p.substring(d.selectionEnd),r)e.current.innerHTML=PS(u),DS(e.current,d.newCursorPosition);else{const f=Bt(u);e.current.innerHTML=f,Ks(e.current,d.newCursorPosition)}n===void 0&&a(u),i==null||i(u),setTimeout(()=>{t.current=!1},0)},[e,r,n,a,i,t]);return{getTextAndCursor:c,applyAction:l}}function LS(s){const{applyAction:e}=s,t=h.useCallback((a,i,c)=>{if(!c.hasSelection||a.metaKey||a.ctrlKey||a.altKey)return!1;const l=uf(a.key);if(!l)return!1;a.preventDefault();const d=co(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),n=h.useCallback((a,i,c)=>{if(!(a.metaKey||a.ctrlKey)||!c.hasSelection)return!1;const l=df(a.key);if(!l)return!1;a.preventDefault();const d=co(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),r=h.useCallback(a=>(a.metaKey||a.ctrlKey)&&!mf(a.key),[]);return{handleAutoWrap:t,handleFormatShortcut:n,shouldPassThrough:r}}const _S="backspace-debug.log";let MS=0;function $o(){return++MS}function ur(s,e){Fe.clientLogsApiClient.sendLogs(s,e,_S)}function Uo(s,e,t,n,r,a){const i=a.substring(Math.max(0,n-5),n),c=a.substring(n,Math.min(a.length,n+5)),l=n>0?a[n-1]:"<none>";ur(`${e.toUpperCase()}_BEFORE`,{eventId:s,key:e,mode:t,cursorPos:n,selectionEnd:r,hasSelection:n!==r,textLength:a.length,charToDelete:e==="Backspace"?l:void 0,charToDeleteCode:e==="Backspace"&&l!=="<none>"?l.charCodeAt(0):void 0,context5Before:i,context5After:c,contextVisual:`"${i}|${c}"`,fullText:a.length<200?a:`${a.substring(0,100)}...(${a.length} chars)...${a.substring(a.length-50)}`})}function FS(s,e,t,n,r,a){const{text:i,cursorPos:c}=t,l=i.substring(Math.max(0,c-5),c),d=i.substring(c,Math.min(i.length,c+5));ur(`${e.toUpperCase()}_AFTER`,{eventId:s,newCursorPos:c,newTextLength:i.length,context5Before:l,context5After:d,contextVisual:`"${l}|${d}"`,cursorDelta:c-r,textDelta:i.length-a,expectedCursorPos:n,cursorMismatch:c!==n})}function Bo(s,e,t){ur(`${e}_ACTION`,{eventId:s,actionType:e,action:{selectionStart:t.selectionStart,selectionEnd:t.selectionEnd,textToInsert:t.textToInsert,newCursorPosition:t.newCursorPosition}})}function Wo(s,e,t){ur(`BACKSPACE_PREVIEW_${e}`,{eventId:s,...t})}function $S(s){const{editorRef:e,isRawMode:t,getTextAndCursor:n,applyAction:r,useRichEditing:a,setInternalValue:i,onChange:c}=s,l=h.useCallback((m,g,x,y,w)=>{setTimeout(()=>{const v=n();v&&FS(m,g,v,w,x,y)},10)},[n]),d=h.useCallback((m,g,x,y)=>{if(e.current){if(x===y&&x>0){const w=g.substring(0,x-1)+g.substring(x),v=x-1;Wo(m,"DELETE",{deletedChar:g[x-1],deletedCharCode:g.charCodeAt(x-1),oldCursorPos:x,newCursorPos:v,oldTextLength:g.length,newTextLength:w.length});const b=Bt(w);e.current.innerHTML=b,Ks(e.current,v),i(w),c==null||c(w),l(m,"Backspace",x,g.length,v)}else if(x!==y){const w=g.substring(0,x)+g.substring(y),v=x;Wo(m,"DELETE_SELECTION",{deletedText:g.substring(x,y),selectionStart:x,selectionEnd:y,newCursorPos:v});const b=Bt(w);e.current.innerHTML=b,Ks(e.current,v),i(w),c==null||c(w)}}},[e,i,c,l]),p=h.useCallback((m,g,x)=>{const y=$o(),{selectionStart:w,selectionEnd:v}=x;Uo(y,"Backspace",t?"raw":"preview",w,v,g);const b=ff(g,w,v);return b?(m.preventDefault(),Bo(y,"BACKSPACE",{selectionStart:b.selectionStart,selectionEnd:b.selectionEnd,textToInsert:b.textToInsert,newCursorPosition:b.newCursorPosition}),r(b,g),l(y,"Backspace",w,g.length,b.newCursorPosition),!0):t?!1:(m.preventDefault(),d(y,g,w,v),!0)},[t,r,l,d]),u=h.useCallback((m,g,x)=>{if(!a||m.shiftKey)return!1;const y=$o(),{selectionStart:w,selectionEnd:v}=x;Uo(y,"Enter",t?"raw":"preview",w,v,g);const b=uc(g,w,v);return Bo(y,"ENTER",{selectionStart:b.selectionStart,selectionEnd:b.selectionEnd,textToInsert:JSON.stringify(b.textToInsert),newCursorPosition:b.newCursorPosition}),m.preventDefault(),r(b,g),l(y,"Enter",w,g.length,b.newCursorPosition),!0},[a,t,r,l]),f=h.useCallback((m,g,x)=>{if(!a)return!1;m.preventDefault();const y=m.shiftKey?hc(g,x.selectionStart,x.selectionEnd):pc(g,x.selectionStart,x.selectionEnd);return r(y,g),!0},[a,r]);return{handleBackspace:p,handleEnter:u,handleTab:f}}function US(s){switch(s){case"strong":return"**";case"em":return"*";case"code":return"`";case"del":return"~~";case"blockquote":return"> ";default:return""}}function BS(s){const{editorRef:e,editingRawMarkdownRef:t,isRawMode:n,allowRawPreviewOnClick:r,handleInput:a}=s,i=h.useCallback((d,p)=>{var S;d.preventDefault();const u=p.textContent||"",f=p.tagName.toLowerCase(),m=US(f);if(!m)return;t.current=!0;const g=window.getSelection();if(!g||g.rangeCount===0)return;const x=g.getRangeAt(0);let y=0;if(p.contains(x.startContainer)){const C=document.createRange();C.selectNodeContents(p),C.setEnd(x.startContainer,x.startOffset);const N=document.createElement("div");N.appendChild(C.cloneContents()),y=((S=N.textContent)==null?void 0:S.length)||0}const w=f==="blockquote"?`${m}${u}`:`${m}${u}${m}`,v=document.createTextNode(w);p.replaceWith(v);const b=document.createRange(),j=m.length+y;b.setStart(v,j),b.setEnd(v,j),g.removeAllRanges(),g.addRange(b),a()},[t,a]),c=h.useCallback(()=>{var m;if(!e.current)return;t.current=!1;const d=window.getSelection();let p=0;if(d&&d.rangeCount>0){const g=d.getRangeAt(0),x=g.cloneRange();x.selectNodeContents(e.current),x.setEnd(g.startContainer,g.startOffset);const y=document.createElement("div");y.appendChild(x.cloneContents());const w=y.textContent||"";p=w.length;let v=0;for(let b=0;b<Math.min(p,w.length);b++){const j=w[b],S=w[b+1];j==="*"&&S==="*"?(v+=2,b++):(j==="*"||j==="_"||j==="`"||j==="~")&&v++}p=p-v}const u=cs(e.current.innerHTML),f=Bt(u);if(e.current.innerHTML!==f&&(e.current.innerHTML=f,d&&d.rangeCount>0)){let g=0;const x=document.createTreeWalker(e.current,NodeFilter.SHOW_TEXT);let y=x.nextNode(),w=!1;for(;y&&!w;){const v=((m=y.textContent)==null?void 0:m.length)||0;if(g+v>=p){const b=p-g,j=document.createRange();j.setStart(y,b),j.setEnd(y,b),d.removeAllRanges(),d.addRange(j),w=!0}else g+=v,y=x.nextNode()}}},[e,t]);return{handleClick:h.useCallback(d=>{if(!e.current||!r||n)return;const u=d.target.closest("strong, em, code, del, blockquote");u?i(d,u):t.current&&c()},[e,r,n,t,i,c])}}function WS(s){const e=window.getSelection();let t=s;return e&&e.rangeCount>0&&!e.isCollapsed&&(t=s+e.toString().length),{selectionStart:s,selectionEnd:t,hasSelection:s!==t}}function zS(s){const{editorRef:e,editingRawMarkdownRef:t,applyingActionRef:n,value:r,isRawMode:a,useRichEditing:i,keyboard:c,allowRawPreviewOnClick:l,setInternalValue:d,onChange:p,onKeyDown:u}=s,{getTextAndCursor:f,applyAction:m}=OS({editorRef:e,applyingActionRef:n,value:r,isRawMode:a,setInternalValue:d,onChange:p}),{handleAutoWrap:g,handleFormatShortcut:x,shouldPassThrough:y}=LS({applyAction:m}),{handleBackspace:w,handleEnter:v,handleTab:b}=$S({editorRef:e,isRawMode:a,getTextAndCursor:f,applyAction:m,useRichEditing:i,setInternalValue:d,onChange:p}),j=h.useCallback(()=>{if(!e.current)return;if(a){const k=_a(e.current);r===void 0&&d(k),p==null||p(k);return}const A=e.current.innerHTML;let I=cs(A);if(c===Da.VI){const{cursorPos:k}=ta(e.current),P=I,W=k,R=Wb(P,W);if(R.found){const F=Hb(P,W,R.sequenceStart,R.detectedBaseChar);if(F.type==="auto-complete"&&F.replacement){I=F.replacement;const L=F.newCursorPos??I.length;e.current.innerHTML=Bt(I),Ks(e.current,L)}}}r===void 0&&d(I),p==null||p(I)},[p,r,c,a,e,d]),{handleClick:S}=BS({editorRef:e,editingRawMarkdownRef:t,isRawMode:a,allowRawPreviewOnClick:l,handleInput:j}),C=h.useCallback(A=>{const I=f();if(!I||!e.current){u==null||u(A);return}const{text:k,cursorPos:P}=I,W=WS(P);if(g(A,k,W)){u==null||u(A);return}if(x(A,k,W)){u==null||u(A);return}if(y(A)){u==null||u(A);return}if(A.key==="Backspace"&&w(A,k,W)){u==null||u(A);return}if(A.key==="Enter"&&v(A,k,W)){u==null||u(A);return}if(A.key==="Tab"&&b(A,k,W)){u==null||u(A);return}u==null||u(A)},[f,g,x,y,w,v,b,e,u]),N=h.useCallback(A=>{A.preventDefault();const I=A.clipboardData.getData("text/plain");document.execCommand("insertText",!1,I)},[]);return{handleInput:j,handleClick:S,handleKeyDown:C,handlePaste:N}}function Ls(s,e){Fe.clientLogsApiClient.sendLogs(s,e,"backspace-debug.log")}function HS(s){const{editorRef:e,editingRawMarkdownRef:t,currentModeRef:n,applyingActionRef:r,currentValue:a,isFocused:i,allowRawPreviewOnClick:c}=s;h.useEffect(()=>{if(!e.current)return;if(r.current){Ls("SYNC_EFFECT_SKIPPED_APPLYING",{applyingAction:!0});return}const l=n.current,d=l==="raw"?e.current.textContent||"":cs(e.current.innerHTML);if(d===a){Ls("SYNC_EFFECT_SKIPPED_IDENTICAL",{length:a.length});return}const p=a.startsWith(d)&&a.length>d.length;if(Ls("SYNC_EFFECT_CHECK",{isFocused:i,isAppend:p,editorContentLength:d.length,currentValueLength:a.length,diff:a.length-d.length}),(!i||p)&&(Ls("SYNC_EFFECT_WILL_UPDATE",{isFocused:i,isAppend:p,mode:l}),l==="raw"?e.current.textContent=a:e.current.innerHTML=Bt(a),i&&p)){Ls("SYNC_EFFECT_CURSOR_TO_END",{});const u=document.createRange(),f=window.getSelection();u.selectNodeContents(e.current),u.collapse(!1),f==null||f.removeAllRanges(),f==null||f.addRange(u)}},[a,i,e,n,r]),h.useEffect(()=>{if(!i||!e.current||!c)return;const l=()=>{if(t.current)return;const d=window.getSelection();if(!(!d||!e.current)&&d.isCollapsed&&e.current.contains(d.anchorNode)){const p=cs(e.current.innerHTML),u=Bt(p);if(e.current.innerHTML!==u){const f=d.getRangeAt(0),m=f.cloneRange();m.selectNodeContents(e.current),m.setEnd(f.startContainer,f.startOffset);const g=document.createElement("div");g.appendChild(m.cloneContents());const x=cs(g.innerHTML).length;e.current.innerHTML=u,Ks(e.current,x)}}};return document.addEventListener("selectionchange",l),()=>{document.removeEventListener("selectionchange",l)}},[i,a,c,e,t])}const fd=h.forwardRef(({value:s,defaultValue:e,onChange:t,onBlur:n,onKeyDown:r,className:a,style:i,placeholder:c,readOnly:l=!1,useRichEditing:d=!0,allowRawPreviewOnClick:p=!1,showHints:u=!0,showAudioButton:f=!1,audioButtonVariant:m="default",autoStartAudioRecording:g=!1,onAudioTranscription:x,getTextAreaElement:y,audioNodeId:w,keyboard:v=ll,showConfigButton:b=!0,mode:j,onModeChange:S,"data-test":C,...N},A)=>{const[I,k]=h.useState(e||""),[P,W]=h.useState(!1),R=h.useRef(null),F=h.useRef(!1),L=h.useRef("preview"),T=h.useRef(!1),M=h.useRef(!1),D=h.useRef(!1),[H,Y]=h.useState(()=>{try{const V=localStorage.getItem("watcher-markdown-textarea-mode");if(V==="raw"||V==="preview")return V}catch{}return"preview"}),O=j??H,q=j!==void 0?V=>S==null?void 0:S(V):Y,K=O==="raw";h.useEffect(()=>{if(j===void 0)try{localStorage.setItem("watcher-markdown-textarea-mode",O)}catch{}},[O,j]),h.useEffect(()=>{L.current=O,T.current=!1,M.current=!1},[O]);const G=s!==void 0?s:I,U=!G||G.trim()==="",Z=h.useRef(G);M.current||(M.current=!0,Z.current=G);const ue=h.useRef(O),we=h.useRef(s!==void 0?s:I);we.current=s!==void 0?s:I;const ae=h.useRef(null);ae.current||(ae.current=V=>{const le=V.target.closest("a");if(le){V.preventDefault(),V.stopPropagation();const ne=le.getAttribute("href");if(ne){const de=document.createElement("a");de.href=ne,de.target="_blank",de.rel="noopener noreferrer",de.style.display="none",document.body.appendChild(de),de.click(),document.body.removeChild(de)}}});const Te=h.useCallback(V=>{const ee=O!==ue.current;if(ue.current=O,R.current&&ae.current&&R.current.removeEventListener("click",ae.current,!0),R.current=V,V&&O!=="raw"&&ae.current&&V.addEventListener("click",ae.current,!0),V&&(ee||!T.current)){T.current=!0;const le=we.current;O==="raw"?V.textContent=le:V.innerHTML=Bt(le)}},[O]);h.useImperativeHandle(A,()=>({getElement:()=>R.current,getValue:()=>G,setValue:V=>{if(s===void 0&&k(V),R.current){const ee=Bt(V);R.current.innerHTML=ee;const le=document.createRange(),ne=window.getSelection();le.selectNodeContents(R.current),le.collapse(!1),ne==null||ne.removeAllRanges(),ne==null||ne.addRange(le)}t==null||t(V)},focus:()=>{var V;(V=R.current)==null||V.focus()}})),HS({editorRef:R,editingRawMarkdownRef:F,currentModeRef:L,applyingActionRef:D,currentValue:G,isFocused:P,allowRawPreviewOnClick:p});const{handleInput:ke,handleClick:Ee,handleKeyDown:$e,handlePaste:ge}=zS({editorRef:R,editingRawMarkdownRef:F,applyingActionRef:D,value:s,isRawMode:K,useRichEditing:d,keyboard:v,allowRawPreviewOnClick:p,setInternalValue:k,onChange:t,onKeyDown:r}),ie=h.useCallback(()=>{W(!0)},[]),re=h.useCallback(V=>{x==null||x(V)},[x]),te=h.useCallback(()=>R.current,[]),$=h.useCallback(V=>{W(!1);const ee=L.current;R.current&&(ee==="raw"?R.current.textContent!==G&&(R.current.textContent=G):R.current.innerHTML=Bt(G)),n==null||n(V)},[G,n]);return o.jsxs("div",{className:"markdown-textarea-container h-full","data-test":C?`${C}-container`:"markdown-textarea-container",children:[o.jsxs("div",{className:"markdown-textarea-wrapper relative h-full","data-test":C?`${C}-wrapper`:"markdown-textarea-wrapper",children:[o.jsx("div",{ref:Te,contentEditable:!l,onInput:ke,onClick:K?void 0:Ee,onFocus:ie,onBlur:$,spellCheck:!1,onKeyDown:$e,onPaste:ge,className:B("markdown-textarea min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm","ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50",!K&&"[&_strong]:font-bold [&_em]:italic [&_del]:line-through",!K&&"[&_code]:bg-muted [&_code]:px-1 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono",l&&"cursor-default",a),style:{whiteSpace:"pre-wrap",wordBreak:"break-word",...i},suppressContentEditableWarning:!0,"data-node-textarea":N["data-node-textarea"],"data-test":C?`${C}-editor${K?"-raw":""}`:`markdown-textarea-editor${K?"-raw":""}`},O),U&&!P&&c&&o.jsx("div",{className:"absolute top-2 left-3 text-sm text-muted-foreground pointer-events-none","aria-hidden":!0,"data-test":C?`${C}-placeholder`:"markdown-textarea-placeholder",children:c}),o.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:Je.nodeAudioButton},onMouseDownCapture:V=>V.preventDefault(),children:[b&&o.jsx(rr,{compact:!0,label:K?o.jsx(qa,{className:"h-3 w-3"}):o.jsx(Tr,{className:"h-3 w-3"}),onAction:()=>{const V=K?"preview":"raw";q(V),S==null||S(V)},variant:"ghost",size:"icon",buttonClassName:"p-1 h-auto w-auto rounded-md transition-colors text-muted-foreground/40 hover:text-foreground hover:bg-accent",configOptions:[{label:"Preview",value:"preview",icon:o.jsx(Tr,{className:"h-4 w-4"}),onClick:()=>{q("preview"),S==null||S("preview")}},{label:"Raw Markdown",value:"raw",icon:o.jsx(qa,{className:"h-4 w-4"}),onClick:()=>{q("raw"),S==null||S("raw")}}],tooltipText:`${K?"Raw":"Preview"} mode (click to toggle, hold for options)`,ariaLabel:"Toggle markdown display mode","data-test":"markdown-mode-toggle"}),f&&o.jsx(dl,{onTranscriptionComplete:re,sessionName:"markdown-textarea",getTextAreaElement:y||te,variant:m,autoStartRecording:g,nodeId:w,language:v,"data-test":C?`${C}-audio-button`:"markdown-textarea-audio-button"})]})]}),u&&o.jsxs("div",{className:"markdown-hints text-xs text-muted-foreground mt-1 flex gap-3 flex-wrap","data-test":C?`${C}-hints`:"markdown-textarea-hints",children:[o.jsxs("span",{children:[o.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+B"})," Bold"]}),o.jsxs("span",{children:[o.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+I"})," Italic"]}),o.jsx("span",{children:"**bold** *italic* `code` > quote"}),d&&o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"text-muted-foreground/50",children:"|"}),o.jsxs("span",{children:[o.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Tab"})," Indent"]}),o.jsx("span",{children:"Auto-list on Enter"})]})]})]})});fd.displayName="MarkdownTextarea";const GS=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath},zo=(s,e)=>{let t=-1;for(let a=e;a>=0;a--){if(s[a]==="@"){t=a;break}if(s[a]===" "||s[a]===`
`||s[a]==="	")break}if(t===-1)return null;let n=t+1;for(;n<s.length;){const a=s[n];if(a===" "||a===`
`||a==="	")break;n++}const r=s.substring(t,n);return r.startsWith("@")&&r.includes("/")?{start:t,end:n,path:r}:null},Zt=h.forwardRef(({defaultValue:s,value:e,onChange:t,onBlur:n,onKeyDown:r,onMouseDown:a,onClick:i,onPaste:c,className:l,style:d,placeholder:p,onSelectionChange:u,onFileSelect:f,logger:m,showBuiltInPopover:g=!1,showFilePicker:x=!0,showCopyButton:y=!1,showAudioButton:w=!0,showConfigButton:v=!0,audioButtonVariant:b="default",autoStartAudioRecording:j=!1,onAudioTranscriptionComplete:S,audioNodeId:C,readOnly:N=!1,rows:A,useMarkdown:I=!1,showMarkdownHints:k=!1,keyboard:P=ll,onModeChange:W},R)=>{const[F,L]=h.useState(!1),[T,M]=h.useState({top:0,left:0}),[D,H]=h.useState(null),Y=h.useRef(null),O=h.useRef(null),q=h.useRef(null),K=Re(GS);h.useImperativeHandle(R,()=>({getTextArea:()=>{var ie,re;return I?(ie=O.current)==null?void 0:ie.getElement():((re=Y.current)==null?void 0:re.getTextArea())??null},insertTextAtStart:ie=>{var re,te;I?(re=O.current)==null||re.focus():(te=Y.current)==null||te.insertTextAtStart(ie)},focus:()=>{var ie,re,te;I?(ie=O.current)==null||ie.focus():(te=(re=Y.current)==null?void 0:re.getTextArea())==null||te.focus()}}),[I]);const G=h.useCallback(ie=>{var re,te,$,V;if(I){const ee=((re=O.current)==null?void 0:re.getValue())??"",le=ee.trim()?" ":"",ne=ee+le+ie;(te=O.current)==null||te.setValue(ne);const de={target:{value:ne},currentTarget:{value:ne}};t==null||t(de)}else{const ee=($=Y.current)==null?void 0:$.getTextArea();if(!ee)return;const le=ee.value,ne=le.trim()?" ":"",de=le+ne+ie,fe=(V=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:V.set;fe?fe.call(ee,de):ee.value=de;const xe=new Event("input",{bubbles:!0});ee.dispatchEvent(xe)}S==null||S()},[I,t,S]),U=h.useCallback(()=>{var ie;return((ie=O.current)==null?void 0:ie.getElement())??null},[]),Z=h.useCallback(()=>{var ie;return((ie=Y.current)==null?void 0:ie.getTextArea())??null},[]),ue=ie=>{var $;if(!x)return!1;const re=ie.selectionStart,te=ie.value;if(re>0&&te[re-1]==="@"){const V=re>1?te[re-2]:null,ee=re<te.length?te[re]:null;if((V===null||V===" "||V===`
`||V==="	")&&(ee===null||ee===" "||ee===`
`||ee==="	")){const de=($=Y.current)==null?void 0:$.getSelectionPosition();return de&&M(de),H(re-1),L(!0),m==null||m.info("@ character detected at cursor - showing file picker"),!0}}return!1},we=ie=>{const re=ie.target;ue(re),t==null||t(ie)},ae=ie=>{const re=ie.currentTarget;setTimeout(()=>{ue(re)},0)},Te=ie=>{const re=ie.currentTarget;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(ie.key)&&ue(re)},ke=(ie,re)=>{var te;if(u==null||u(ie,re),!!x)if(ie.length>0){const $=ie.toLowerCase()==="file",V=(te=Y.current)==null?void 0:te.getTextArea();let ee=null;if(V){const le=V.value,ne=V.selectionStart;ee=zo(le,ne)}$||ee?(L(!0),re&&M(re),$?(H(null),m==null||m.info('Word "file" selected - showing file picker')):(H(null),m==null||m.info(`File path "${ee==null?void 0:ee.path}" detected - showing file picker to replace`))):(L(!1),H(null))}else L(!1),H(null)},Ee=ie=>{var re;if(L(ie),!ie){const te=(re=Y.current)==null?void 0:re.getTextArea();te&&te.focus()}},$e=ie=>{var Ce;const re=(Ce=Y.current)==null?void 0:Ce.getTextArea();if(!re)return;re.focus();const te=re.value,$=re.selectionStart,ee=re.value.substring(re.selectionStart,re.selectionEnd).toLowerCase()==="file",le=zo(te,$);let ne,de,fe;if(D!==null)ne=D,de=D+1,fe="@"+ie.path;else if(ee)ne=re.selectionStart,de=re.selectionEnd,fe="@"+ie.path;else if(le)ne=le.start,de=le.end,fe="@"+ie.path;else{L(!1),H(null);return}if(re.setSelectionRange(ne,de),!document.execCommand("insertText",!1,fe)){const Se=re.value.substring(0,ne),_=re.value.substring(de);re.value=Se+fe+_,re.setSelectionRange(ne+fe.length,ne+fe.length),re.dispatchEvent(new Event("input",{bubbles:!0}))}D!==null?m==null||m.info(`Replaced "@" with: ${fe}`):ee?m==null||m.info(`Replaced "file" with: ${fe}`):le&&(m==null||m.info(`Replaced "${le.path}" with: ${fe}`)),f==null||f(ie),L(!1),H(null)},ge=h.useCallback(ie=>{const re={target:{value:ie},currentTarget:{value:ie}};t==null||t(re)},[t]);return o.jsxs(Ye,{open:F,onOpenChange:Ee,"data-test":"textarea-file-picker-popover",children:[o.jsxs("div",{className:"textarea-with-file-picker relative w-full h-full","data-test":"textarea-file-picker-container",children:[I?o.jsx("div",{className:"relative w-full h-full",onMouseDown:a,onPaste:c,onClick:ie=>{ae(ie),i==null||i(ie)},onKeyUp:Te,children:o.jsx(fd,{ref:O,defaultValue:s,value:e,onChange:ge,onBlur:n,onKeyDown:r,className:l,style:d,placeholder:p,readOnly:N,useRichEditing:!0,showHints:k,showAudioButton:w,showConfigButton:v,audioButtonVariant:b,autoStartAudioRecording:j,onAudioTranscription:G,getTextAreaElement:U,audioNodeId:C,keyboard:P,onModeChange:W,"data-node-textarea":!0,"data-test":"textarea-file-picker-markdown-textarea"})}):o.jsx(ul,{ref:Y,defaultValue:s,value:e,onChange:we,onBlur:n,onKeyDown:r,onMouseDown:a,onPaste:c,onClick:ie=>{ae(ie),i==null||i(ie)},onKeyUp:Te,className:l,style:d,onSelectionChange:ke,placeholder:p,showBuiltInPopover:g,showCopyButton:y,showAudioButton:w,audioButtonVariant:b,onAudioTranscription:G,getTextAreaElement:Z,readOnly:N,rows:A,keyboard:P,"data-test":"textarea-file-picker-selectable-textarea"}),x&&o.jsx(bn,{ref:q,style:{position:"absolute",top:`${T.top}px`,left:`${T.left}px`,width:"1px",height:"1px"},"data-test":"textarea-file-picker-popover-anchor"})]}),x&&o.jsxs(Ge,{className:"file-picker-popover w-[500px] p-2",side:"bottom",align:"start",style:{zIndex:Je.draggablePopoverDropdown},"data-test":"textarea-file-picker-popover-content",children:[o.jsxs("div",{className:"file-picker-header mb-2","data-test":"textarea-file-picker-popover-header",children:[o.jsx("h3",{className:"font-semibold text-xs","data-test":"textarea-file-picker-popover-title",children:'Replace "file" with a file path'}),o.jsx("p",{className:"text-[10px] text-muted-foreground","data-test":"textarea-file-picker-popover-description",children:'Select a file to replace the word "file" with its path. Type "/" to search by full path.'})]}),o.jsx(Ob,{onFileSelect:$e,maxResults:10,placeholder:"Search for a file...",mode:"fileNameOnly",cwd:K??void 0,"data-test":"textarea-file-picker-file-picker"})]})]})});Zt.displayName="TextareaWithFilePicker";const kr={outputFormat:"text",permissionMode:"acceptEdits"};function md({variant:s="outline",size:e="sm",buttonLabel:t="Options",className:n,children:r}){const a=Re(l=>{var d,p,u;return(u=(p=(d=l.ui)==null?void 0:d.claude)==null?void 0:p.message)==null?void 0:u.options}),i={outputFormat:(a==null?void 0:a.outputFormat)??kr.outputFormat,permissionMode:(a==null?void 0:a.permissionMode)??kr.permissionMode};h.useEffect(()=>{var l,d,p;if(!a){const u=oe.getState();oe.updateState({ui:{...u.ui,claude:{...(l=u.ui)==null?void 0:l.claude,message:{...(p=(d=u.ui)==null?void 0:d.claude)==null?void 0:p.message,options:kr}}}})}},[a]);const c=l=>{var p,u,f;const d=oe.getState();oe.updateState({ui:{...d.ui,claude:{...(p=d.ui)==null?void 0:p.claude,message:{...(f=(u=d.ui)==null?void 0:u.claude)==null?void 0:f.message,options:l}}}})};return o.jsxs(o.Fragment,{children:[o.jsxs(Ye,{children:[o.jsx(at,{asChild:!0,children:o.jsxs(se,{variant:s,size:e,className:n,title:"Message Options","data-test":"message-options-button",children:[o.jsx(Vt,{className:"h-4 w-4"}),t&&o.jsx("span",{className:"ml-2",children:t})]})}),o.jsx(Ge,{className:"w-80",style:{zIndex:Je.draggablePopoverDropdown},onClick:l=>l.stopPropagation(),"data-test":"message-options-popover",children:o.jsxs("div",{className:"message-options-panel space-y-4","data-test":"message-options-panel",children:[o.jsxs("div",{className:"output-format-select","data-test":"output-format-select",children:[o.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Output Format"}),o.jsxs(Ct,{value:i.outputFormat,onValueChange:l=>c({...i,outputFormat:l}),children:[o.jsx(mt,{"data-test":"output-format-trigger",children:o.jsx(Rt,{})}),o.jsxs(gt,{"data-test":"output-format-content",children:[o.jsx(Ne,{value:"text","data-test":"output-format-text",children:"Text"}),o.jsx(Ne,{value:"json","data-test":"output-format-json",children:"JSON"}),o.jsx(Ne,{value:"stream-json","data-test":"output-format-stream-json",children:"Stream JSON"})]})]})]}),o.jsxs("div",{className:"permission-mode-select","data-test":"permission-mode-select",children:[o.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Permission Mode"}),o.jsxs(Ct,{value:i.permissionMode,onValueChange:l=>c({...i,permissionMode:l}),children:[o.jsx(mt,{"data-test":"permission-mode-trigger",children:o.jsx(Rt,{})}),o.jsxs(gt,{"data-test":"permission-mode-content",children:[o.jsx(Ne,{value:"default","data-test":"permission-mode-default",children:"Default"}),o.jsx(Ne,{value:"acceptEdits","data-test":"permission-mode-accept-edits",children:"Accept Edits"}),o.jsx(Ne,{value:"bypassPermissions","data-test":"permission-mode-bypass",children:"Bypass Permissions"}),o.jsx(Ne,{value:"plan","data-test":"permission-mode-plan",children:"Plan Mode"})]})]})]})]})})]}),r(i)]})}const qS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.items)??[]},VS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.loading)??!1},KS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.error)??null},JS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.pagination)??null},YS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.currentPage)??1},XS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.favoritesOnly)??!1},QS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.isInitialized)??!1};function ZS(s={}){const{loadOnMount:e=!1,parentSessionId:t,pageSize:n=20}=s,{update:r,getState:a}=ma(),i=h.useRef(!1),c=Re(qS),l=Re(VS),d=Re(KS),p=Re(JS),u=Re(YS),f=Re(XS),m=Re(QS),g=h.useCallback(async(N=1,A=!1)=>{var I,k,P,W;try{const R=(k=(I=a().app)==null?void 0:I.claude)==null?void 0:k.forks;r("app",{claude:{forks:{...R,loading:!0,error:null,currentPage:N}}});const F={page:N,pageSize:n,sortBy:"createdAt",sortOrder:"desc"};t&&(F.parentSessionId=t),R!=null&&R.favoritesOnly&&(F.favoritesOnly=!0);const L=await Ke.getForks(F),T=(R==null?void 0:R.items)??[],M=A?[...T,...L.forks]:L.forks;r("app",{claude:{forks:{items:M,pagination:L.pagination,currentPage:N,loading:!1,error:null,favoritesOnly:(R==null?void 0:R.favoritesOnly)??!1,isInitialized:!0}}})}catch(R){console.error("[useForks] API request failed:",{error:R,errorMessage:R instanceof Error?R.message:"Unknown error",page:N,append:A,parentSessionId:t,timestamp:new Date().toISOString()});const F=(W=(P=a().app)==null?void 0:P.claude)==null?void 0:W.forks;r("app",{claude:{forks:{items:A?(F==null?void 0:F.items)??[]:[],pagination:null,currentPage:N,loading:!1,error:R instanceof Error?R.message:"Failed to load forks",favoritesOnly:(F==null?void 0:F.favoritesOnly)??!1,isInitialized:!0}}})}},[r,a,t,n]),x=h.useCallback(()=>{var I,k;const N=(k=(I=a().app)==null?void 0:I.claude)==null?void 0:k.forks,A=!(N!=null&&N.favoritesOnly);r("app",{claude:{forks:{...N,favoritesOnly:A}}}),g(1)},[r,a,g]),y=h.useCallback(async N=>{var k,P,W,R,F;const A=((W=(P=(k=a().app)==null?void 0:k.claude)==null?void 0:P.forks)==null?void 0:W.items)??[],I=A.find(L=>L.sessionId===N);if(I)try{const L=await Ke.updateFork(N,{isFavorite:!I.isFavorite}),T=A.map(D=>D.sessionId===N?L.fork:D),M=(F=(R=a().app)==null?void 0:R.claude)==null?void 0:F.forks;r("app",{claude:{forks:{...M,items:T}}})}catch(L){console.error("[useForks] Failed to toggle favorite:",{sessionId:N,error:L,errorMessage:L instanceof Error?L.message:"Unknown error",timestamp:new Date().toISOString()})}},[r,a]),w=h.useCallback(async(N,A)=>{try{return(await Ke.forkSession(N,A)).success?(g(1),!0):!1}catch(I){return console.error("[useForks] Failed to create fork:",{sessionId:N,request:A,error:I,errorMessage:I instanceof Error?I.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[g]),v=h.useCallback(async N=>{var A,I;try{if((await Ke.deleteFork(N)).success){const P=(I=(A=a().app)==null?void 0:A.claude)==null?void 0:I.forks,R=((P==null?void 0:P.items)??[]).filter(F=>F.sessionId!==N);return r("app",{claude:{forks:{...P,items:R}}}),!0}return!1}catch(k){return console.error("[useForks] Failed to delete fork:",{sessionId:N,error:k,errorMessage:k instanceof Error?k.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[r,a]),b=h.useCallback(()=>{p&&u<p.totalPages&&g(u+1,!0)},[p,u,g]),j=h.useCallback(()=>{g(1)},[g]),S=h.useCallback(async(N,A)=>{var I,k;try{const P=await Ke.updateFork(N,A);if(P.success){const W=(k=(I=a().app)==null?void 0:I.claude)==null?void 0:k.forks,F=((W==null?void 0:W.items)??[]).map(L=>L.sessionId===N?P.fork:L);return r("app",{claude:{forks:{...W,items:F}}}),P.fork}return null}catch(P){return console.error("[useForks] Failed to update fork:",{sessionId:N,updates:A,error:P,errorMessage:P instanceof Error?P.message:"Unknown error",timestamp:new Date().toISOString()}),null}},[r,a]),C=h.useCallback((N,A)=>{var R,F;const I=(F=(R=a().app)==null?void 0:R.claude)==null?void 0:F.forks,k=(I==null?void 0:I.items)??[],P=k.findIndex(L=>L.sessionId===N);if(P===-1)return;const W=[...k];W[P]={...W[P],...A},r("app",{claude:{forks:{...I,items:W}}})},[r,a]);return h.useEffect(()=>{e&&(m||i.current||(i.current=!0,g(1)))},[e,m,g]),{forks:c,loading:l,error:d,pagination:p,currentPage:u,favoritesOnly:f,isInitialized:m,loadForks:g,refreshForks:j,handleLoadMore:b,toggleFavoritesOnly:x,toggleFavorite:y,createFork:w,deleteFork:v,updateFork:S,updateSingleFork:C}}const e0="Use @agent-code-worktree-specialist to help with this task.",t0="Please implement this feature following best practices and ensure all tests pass.";function gd({variant:s="ghost",size:e="icon",className:t="create-session-panel-button",disabled:n=!1,icon:r,initialMessage:a,buttonTitle:i="Create New Session with Message",projectPath:c,initialForkSessionId:l,onOpen:d,onCreating:p,onSessionCreated:u,useModal:f=!1}){const[m,g]=h.useState(!1),[x,y]=h.useState(!1),[w,v]=h.useState(a||""),[b,j]=h.useState(a||""),[S,C]=h.useState(void 0),[N,A]=h.useState(!1),[I,k]=h.useState(null),[P,W]=h.useState(l??null),R=h.useRef(null),{forks:F,loading:L}=ZS({loadOnMount:!0}),T=Re(G=>{var U,Z,ue;return(ue=(Z=(U=G.app)==null?void 0:U.claude)==null?void 0:Z.ui)==null?void 0:ue.selectedProjectPath}),M=Re(G=>{var U,Z;return(Z=(U=G.ui)==null?void 0:U.global)==null?void 0:Z.createClaudeSessionPopoverSize}),D=G=>{var Z;const U=oe.getState();oe.updateState({ui:{...U.ui,global:{...(Z=U.ui)==null?void 0:Z.global,createClaudeSessionPopoverSize:G}}})};h.useEffect(()=>{a!==b&&(v(a||""),j(a||""))},[a,b]),h.useEffect(()=>{W(l??null)},[l]),h.useEffect(()=>{var G,U,Z,ue,we,ae;if(m&&c&&c!=="none"){const Te=oe.getState();((Z=(U=(G=Te.app)==null?void 0:G.claude)==null?void 0:U.ui)==null?void 0:Z.selectedProjectPath)!==c&&oe.updateState({app:{...Te.app,claude:{...(ue=Te.app)==null?void 0:ue.claude,ui:{...(ae=(we=Te.app)==null?void 0:we.claude)==null?void 0:ae.ui,selectedProjectPath:c}}}})}},[m,c]);const H=()=>{if(!f&&R.current){const G=R.current.getBoundingClientRect();C({x:G.left,y:G.bottom+8})}g(!0),d&&d()},Y=()=>{g(!1)},O=(G,U)=>{const Z=[];return U.usePrompt1&&U.prompt1Text&&Z.push(U.prompt1Text),U.usePrompt2&&U.prompt2Text&&Z.push(U.prompt2Text),Z.length>0?`${Z.join(`

`)}

${G}`:G},q=G=>{const U=T??c;return{message:w.trim(),cwd:U,projectId:U,options:{outputFormat:G.outputFormat,permissionMode:G.permissionMode}}},K=async G=>{if(console.log("ðŸŽ¯ [ButtonCreateSession] handleSendMessage called",{messageLength:w.trim().length,sessionOptions:G,selectedForkSessionId:P,timestamp:new Date().toISOString()}),!w.trim()){console.log("âš ï¸ [ButtonCreateSession] Message is empty, aborting");return}try{if(console.log("ðŸ“¤ [ButtonCreateSession] Setting sending state to true"),y(!0),p&&(console.log("ðŸ“£ [ButtonCreateSession] Calling onCreating callback"),p()),P){console.log("ðŸ´ [ButtonCreateSession] Creating new fork from selected fork",{parentSessionId:P});const U=await Ke.forkSession(P,{description:`Fork for: ${w.trim().slice(0,50)}...`});if(console.log("âœ… [ButtonCreateSession] New fork created",{success:U.success,newSessionId:U.sessionId,parentSessionId:U.parentSessionId}),!U.success||!U.sessionId)throw new Error("Failed to create fork from selected session");console.log("ðŸ“¤ [ButtonCreateSession] Sending message to new fork",{sessionId:U.sessionId});const Z=await Ke.sendMessage({sessionId:U.sessionId,message:w.trim(),options:{outputFormat:G.outputFormat,permissionMode:G.permissionMode}});if(console.log("âœ… [ButtonCreateSession] Message sent to new fork",{success:Z.success,sessionId:Z.sessionId}),Z.success)u&&u(Z.sessionId,Z.response),Y();else throw new Error("Failed to send message to new fork session")}else{const U=q(G);console.log("ðŸ“¦ [ButtonCreateSession] Request body built",{hasMessage:!!U.message,hasCwd:!!U.cwd,hasProjectId:!!U.projectId,optionsCount:Object.keys(U.options||{}).length}),console.log("ðŸš€ [ButtonCreateSession] Calling claudeAPI.createSession");const Z=await Ke.createSession(U);if(console.log("âœ… [ButtonCreateSession] API response received",{success:Z.success,hasSessionId:!!Z.sessionId,error:Z.error}),Z.success&&Z.sessionId)console.log("ðŸŽ‰ [ButtonCreateSession] Session created successfully",{sessionId:Z.sessionId}),u&&(console.log("ðŸ“ž [ButtonCreateSession] Calling onSessionCreated callback"),u(Z.sessionId,Z.response)),Y();else throw new Error(Z.error??"Failed to create session")}}catch(U){console.error("âŒ [ButtonCreateSession] Failed to create/resume session:",U)}finally{console.log("ðŸ [ButtonCreateSession] Setting sending state to false"),y(!1)}};return o.jsx(en,{storageKey:"claude-session-prompts",initialConfig:{usePrompt1:!1,usePrompt2:!1,prompt1Text:e0,prompt2Text:t0},children:(G,U,Z)=>{const ue=(ae,Te)=>{const ke={...G,[ae]:Te};U(ke);const Ee=O(a||"",ke);v(Ee)},we=o.jsxs("div",{"data-test":"create-session-content",className:"content-wrapper p-4 space-y-4",children:[o.jsxs("div",{"data-test":"create-session-project-selector-section",className:"project-selector-container mb-4",children:[o.jsxs("div",{"data-test":"create-session-header",className:"flex items-center justify-between",children:[o.jsxs("div",{"data-test":"create-session-labels",className:"flex items-center gap-4",children:[o.jsx("label",{"data-test":"create-session-project-label",className:"project-selector-label text-sm font-medium",children:"Select Project"}),o.jsxs("label",{"data-test":"create-session-fork-label",className:"fork-selector-label text-sm font-medium flex items-center gap-1",children:[o.jsx(ls,{className:"h-3 w-3"}),"Fork From"]})]}),o.jsx(Z,{title:"Prompt Configuration",buttonClassName:"prompt-config-button",children:o.jsxs("div",{"data-test":"prompt-config-panel",className:"prompt-config-panel space-y-4",onClick:ae=>ae.stopPropagation(),children:[o.jsxs("div",{"data-test":"prompt-checkbox-1-container",className:"prompt-checkbox-container flex items-center space-x-2",children:[o.jsx(Ft,{"data-test":"prompt-checkbox-1",id:"use-prompt-1",checked:G.usePrompt1,onCheckedChange:ae=>ue("usePrompt1",ae===!0)}),o.jsx(me,{htmlFor:"use-prompt-1",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 1"})]}),o.jsx("div",{"data-test":"prompt-text-display-1",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:G.prompt1Text}),o.jsxs("div",{"data-test":"prompt-checkbox-2-container",className:"prompt-checkbox-container flex items-center space-x-2 mt-4",children:[o.jsx(Ft,{"data-test":"prompt-checkbox-2",id:"use-prompt-2",checked:G.usePrompt2,onCheckedChange:ae=>ue("usePrompt2",ae===!0)}),o.jsx(me,{htmlFor:"use-prompt-2",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 2"})]}),o.jsx("div",{"data-test":"prompt-text-display-2",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:G.prompt2Text})]})})]}),o.jsxs("div",{"data-test":"create-session-selectors",className:"flex gap-2 mt-2",children:[o.jsx("div",{className:`flex-1 ${P?"opacity-50 pointer-events-none":""}`,children:o.jsx(cc,{"data-test":"create-session-project-selector",variant:"select",className:"project-selector w-full"})}),o.jsxs(Ct,{value:P??"none",onValueChange:ae=>W(ae==="none"?null:ae),children:[o.jsx(mt,{"data-test":"create-session-fork-selector",className:"fork-selector flex-1",children:o.jsx(Rt,{placeholder:"No fork (new session)"})}),o.jsxs(gt,{"data-test":"create-session-fork-options",style:{zIndex:Je.draggablePopoverDropdown},children:[o.jsx(Ne,{value:"none","data-test":"fork-option-none",children:o.jsx("span",{className:"text-muted-foreground",children:"No fork (new session)"})}),L?o.jsx(Ne,{value:"loading",disabled:!0,children:"Loading forks..."}):F.map(ae=>o.jsx(Ne,{value:ae.sessionId,"data-test":`fork-option-${ae.id}`,children:o.jsxs("div",{className:"flex flex-col items-start",children:[o.jsx("span",{className:"font-medium",children:ae.sessionName??ae.description??`Fork ${ae.sessionId.slice(0,8)}`}),o.jsxs("span",{className:"text-xs text-muted-foreground",children:[ae.messageCount??0," messages"]})]})},ae.id))]})]})]})]}),o.jsxs("div",{"data-test":"create-session-message-container",className:"new-session-input-container space-y-3",children:[o.jsx(Zt,{"data-test":"create-session-textarea",value:w,onChange:ae=>v(ae.target.value),placeholder:"Type your message...",rows:10,className:"resize-y"}),o.jsx("div",{"data-test":"create-session-actions",className:"flex justify-end gap-2 items-center",children:o.jsx(md,{variant:"outline",size:"sm",buttonLabel:"Options",className:"session-options-button","data-test":"create-session-options-button",children:ae=>o.jsx(rr,{"data-test":"create-session-send-button",label:o.jsxs(o.Fragment,{children:[P?o.jsx(ls,{className:"h-4 w-4 mr-2"}):o.jsx(Ar,{className:"h-4 w-4 mr-2"}),x?P?"Forking...":"Creating Session...":P?"Fork & Send":"Create Session"]}),onAction:()=>{console.log("ðŸ‘† [ButtonCreateSession] ConfigurableButton onAction triggered",{messageLength:w.trim().length,sending:x,selectedForkSessionId:P,disabled:!w.trim()||x,timestamp:new Date().toISOString()}),K(ae)},disabled:!w.trim()||x,variant:"default",configOptions:[{label:"Preview Request Body",value:"preview",onClick:()=>{k(ae),A(!0)},icon:o.jsx(Tr,{className:"h-4 w-4"})}],showHint:!0,tooltipText:P?"Click to fork and send message":"Click to send, hold to preview request",ariaLabel:P?"Fork and Send button":"Create Session button with preview option"})})}),N&&I&&o.jsx(An,{open:N,onOpenChange:A,children:o.jsxs(Pn,{className:"sm:max-w-[600px] max-h-[70vh] overflow-y-auto",children:[o.jsx(Rn,{children:o.jsx(Hs,{children:"Request Body Preview"})}),o.jsx("pre",{className:"request-preview-content bg-muted p-4 rounded-md text-xs font-mono overflow-x-auto whitespace-pre-wrap",children:JSON.stringify(q(I),null,2)}),o.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[o.jsx(se,{variant:"outline",onClick:()=>A(!1),children:"Close"}),o.jsxs(se,{onClick:()=>{A(!1),K(I)},children:[o.jsx(Ar,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})]});return o.jsxs(o.Fragment,{children:[o.jsx(se,{ref:R,"data-test":"create-session-button",variant:s,size:e,disabled:n,className:t,title:i,onClick:H,children:r??o.jsx(Li,{className:"h-4 w-4 hover:text-purple-500 transition-colors"})}),f?o.jsx(An,{open:m,onOpenChange:g,children:o.jsxs(Pn,{"data-test":"create-session-dialog",className:"sm:max-w-[700px] max-h-[80vh] overflow-y-auto",children:[o.jsx(Rn,{children:o.jsx(Hs,{children:"Create New Session"})}),we]})}):o.jsx(us,{"data-test":"create-session-popover",isVisible:m,onClose:Y,title:"Create New Session",className:"max-h-[80vh]",shouldCloseManually:!0,resizable:!0,initialSize:M||{width:700,height:600},onSizeChange:D,triggerPosition:S,children:o.jsx("div",{className:"overflow-y-auto max-h-[calc(80vh-3rem)]",children:we})})]})}})}function s0({buttonLabel:s,icon:e=o.jsx(Qn,{className:"h-5 w-5"}),variant:t="ghost",size:n="icon",buttonClassName:r="",contentClassName:a="",align:i="end",side:c="bottom",title:l="Audio Recorder"}){const[d,p]=h.useState(!1);return o.jsxs(Ye,{open:d,onOpenChange:p,"data-test":"audio-recorder-popover",children:[o.jsx(at,{asChild:!0,children:o.jsx(se,{variant:t,size:n,className:`audio-recorder-button ${r}`,title:l,"data-test":"audio-recorder-trigger-button",children:s?o.jsxs(o.Fragment,{children:[e,s&&o.jsx("span",{className:"ml-2","data-test":"audio-recorder-button-label",children:s})]}):e})}),o.jsxs(Ge,{className:`audio-recorder-panel w-[400px] ${a}`,align:i,side:c,"data-test":"audio-recorder-popover-content",children:[l&&o.jsx("div",{className:"audio-panel-header pb-2 mb-2 border-b border-border","data-test":"audio-recorder-panel-header",children:o.jsx("h3",{className:"text-sm font-semibold","data-test":"audio-recorder-panel-title",children:l})}),o.jsx("div",{className:"audio-panel-content","data-test":"audio-recorder-panel-content",children:o.jsx(Zt,{})})]})]})}const xd=hu,Ma=h.forwardRef(({className:s,...e},t)=>o.jsx(vi,{ref:t,className:B("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",s),...e}));Ma.displayName=vi.displayName;const Js=h.forwardRef(({className:s,...e},t)=>o.jsx(wi,{ref:t,className:B("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",s),...e}));Js.displayName=wi.displayName;const Ys=h.forwardRef(({className:s,...e},t)=>o.jsx(bi,{ref:t,className:B("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...e}));Ys.displayName=bi.displayName;var Ut=(s=>(s.LOW="low",s.MEDIUM="medium",s.HIGH="high",s.URGENT="urgent",s))(Ut||{}),ze=(s=>(s.FREEZER="freezer",s.BACKLOG="backlog",s.SELECTED="selected",s.DOING="doing",s.DONE="done",s.ARCHIVE="archive",s))(ze||{}),Gt=(s=>(s.PERSONAL="personal",s.WORK="work",s.SHOPPING="shopping",s.HEALTH="health",s.OTHER="other",s))(Gt||{});function vd({session:s,segmentsToStrip:e=3,onNameUpdated:t}){const[n,r]=h.useState(!1),[a,i]=h.useState(""),[c,l]=h.useState(!1),d=h.useRef(null),p=h.useMemo(()=>{const{name:x,cwd:y}=s;if(!x.startsWith("-home-"))return x;let v=x;const b=/\/[a-f0-9]{8}[a-f0-9-]*$/i;v=v.replace(b,""),v.startsWith("-")&&(v=v.substring(1));const j="/"+v.replace(/-/g,"/");y&&j.startsWith(y);const S=j.split("/").filter(Boolean);return e>0&&S.length>e?S.slice(e).join("/"):S.length===0?x:S.join("/")},[s,e]),u=s.customName||p;h.useEffect(()=>{n&&d.current&&(d.current.focus(),d.current.select())},[n]);const f=()=>{i(s.customName||""),r(!0)},m=async()=>{if(!c)try{l(!0);const x=a.trim()===""?null:a.trim();await Ke.updateSessionName(s.id,x),t==null||t(),r(!1)}catch(x){console.error("Failed to update session name:",x),alert("Failed to update session name")}finally{l(!1)}},g=x=>{x.key==="Enter"?m():x.key==="Escape"&&r(!1)};return n?o.jsxs("div",{className:"session-name-edit flex items-center gap-2","data-test":"session-name-edit-container",children:[o.jsx("input",{ref:d,type:"text",value:a,onChange:x=>i(x.target.value),onKeyDown:g,onBlur:()=>r(!1),className:"flex-1 px-2 py-1 border rounded",placeholder:p,disabled:c,"data-test":"session-name-input"}),o.jsx("button",{onMouseDown:x=>{x.preventDefault(),m()},disabled:c,className:"session-name-save-btn p-1 hover:bg-gray-100 rounded",title:"Save (Enter)","data-test":"session-name-save-button",children:o.jsx(st,{className:"w-4 h-4"})})]}):o.jsx("span",{className:"session-name-display cursor-pointer hover:underline",onDoubleClick:f,title:"Double-click to edit","data-test":"session-name-display",children:u})}function n0({sessionIds:s=[],className:e="",title:t="Claude session is running",showCount:n=!1,lastActiveTime:r,isCreating:a=!1}){const[i,c]=h.useState({}),[l,d]=h.useState([]),p=h.useRef(s);h.useEffect(()=>{p.current=s},[s]),h.useEffect(()=>{var A,I,k;const C=((k=(I=(A=oe.get("app"))==null?void 0:A.claude)==null?void 0:I.data)==null?void 0:k.sessions)??[];d(C);const N=oe.selectSlice(P=>{var W,R,F;return(F=(R=(W=P.app)==null?void 0:W.claude)==null?void 0:R.data)==null?void 0:F.sessions}).subscribe(P=>{d(P??[])});return()=>N.unsubscribe()},[]);const u=h.useMemo(()=>{if(r!==void 0)return r;if(!s.length||!l.length)return;const C=l.filter(A=>s.includes(A.id));if(!C.length)return;const N=C.reduce((A,I)=>{const k=new Date(I.lastModified).getTime();return k>A?k:A},0);return N>0?N:void 0},[r,s,l]);h.useEffect(()=>{var P,W,R;const C=F=>{if(!F)return{};const L={};for(const T of p.current)F[T]&&(L[T]=F[T]);return L},N=(F,L)=>{const T=Object.keys(F),M=Object.keys(L);if(T.length!==M.length)return!0;for(const D of M)if(!F[D]||F[D].isOpened!==L[D].isOpened||F[D].isProcessing!==L[D].isProcessing)return!0;return!1},A=((R=(W=(P=oe.get("app"))==null?void 0:P.claude)==null?void 0:W.ui)==null?void 0:R.activity)??{},I=C(A);c(I);const k=oe.selectSlice(F=>{var L,T,M;return(M=(T=(L=F.app)==null?void 0:L.claude)==null?void 0:T.ui)==null?void 0:M.activity}).subscribe(F=>{const L=C(F);c(T=>N(T,L)?L:T)});return()=>k.unsubscribe()},[]);const f=h.useCallback(C=>{const N=i[C];if(N!=null&&N.isProcessing)return"running";if(N!=null&&N.isOpened&&!(N!=null&&N.isProcessing))return"opened";if(u){const A=Date.now()-36e5;if(u>A)return"recent"}return"inactive"},[i,u]),m=C=>{switch(C){case"running":return{status:"running",color:"bg-green-500",bgColor:"bg-green-500",textColor:"text-green-600"};case"opened":return{status:"opened",color:"bg-orange-500",bgColor:"bg-orange-500",textColor:"text-orange-600"};case"recent":return{status:"recent",color:"bg-yellow-500",bgColor:"bg-yellow-500",textColor:"text-yellow-600"};case"inactive":default:return{status:"inactive",color:"bg-gray-400",bgColor:"bg-gray-400",textColor:"text-gray-500"}}},g=h.useMemo(()=>s.map(C=>({id:C,status:f(C)})).filter(C=>C.status!=="inactive"),[s,f]),x=g.length>0,y=h.useMemo(()=>g.some(C=>C.status==="running")?"running":g.some(C=>C.status==="opened")?"opened":g.some(C=>C.status==="recent")?"recent":"inactive",[g]),w=m(y),v=h.useMemo(()=>{if(n&&g.length>1){const N={running:"running",opened:"opened",recent:"recently active",inactive:"inactive"}[y];return`${g.length} Claude sessions ${N}`}const C={running:"Claude session is running",opened:"Claude session is opened",recent:"Claude session recently active",inactive:"Claude session inactive"}[y];return t||C},[n,g.length,y,t]);if(!x&&!a)return null;const b=a?"running":y,j=a?m("running"):w,S=a?"Creating Claude session...":v;return o.jsxs("div",{className:`session-activity-indicator flex items-center gap-1 ${e}`,title:S,"data-test":"session-activity-indicator",children:[o.jsx("div",{className:`activity-dot w-2 h-2 ${j.bgColor} rounded-full ${b==="running"?"animate-pulse":""}`,"data-test":"activity-dot","data-activity-status":b,"data-is-creating":a}),n&&g.length>1&&o.jsx("span",{className:`activity-count text-xs ${j.textColor} font-medium`,"data-test":"activity-count",children:g.length})]})}function r0(s,e){if(s.className!==e.className||s.title!==e.title||s.showCount!==e.showCount||s.lastActiveTime!==e.lastActiveTime||s.isCreating!==e.isCreating)return!1;const t=s.sessionIds??[],n=e.sessionIds??[];return t.length!==n.length?!1:t.every((r,a)=>r===n[a])}const Fa=h.memo(n0,r0),wd=h.forwardRef(({searchQuery:s,onSearchChange:e,onAdvancedSearch:t,className:n},r)=>{const[a,i]=h.useState(!1),[c,l]=h.useState({sortOrder:"desc",pageSize:50}),d=h.useMemo(()=>{const{sortOrder:x,pageSize:y,...w}=c;return Object.values(w).some(j=>j!==void 0)||x!=="desc"},[c]),p=(x,y)=>{l(w=>({...w,[x]:y}))},u=()=>{t&&t(s,c),i(!1)},f=()=>{l({sortOrder:"desc",pageSize:50})},m=x=>{x.key==="Enter"&&t&&t(s,c)},g=()=>{e("")};return o.jsx("div",{ref:r,className:B("messages-search-container relative",n),"data-test":"messages-search-container",children:o.jsxs("div",{className:"search-input-wrapper relative flex items-center gap-1","data-test":"messages-search-input-wrapper",children:[o.jsx(er,{className:"search-icon absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10","data-test":"messages-search-icon"}),o.jsx(_e,{type:"text",placeholder:"Search messages...",value:s,onChange:x=>e(x.target.value),onKeyDown:m,className:B("search-input pl-9",s?"pr-16":"pr-10"),"data-test":"messages-search-input"}),s&&o.jsx(se,{variant:"ghost",size:"icon",onClick:g,className:"clear-button absolute right-9 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"messages-search-clear-button",children:o.jsx(ct,{className:"h-4 w-4"})}),d&&o.jsx("div",{className:B("filter-indicator absolute top-1/2 -translate-y-1/2 h-2 w-2 rounded-full bg-primary pointer-events-none z-10",s?"right-17":"right-11"),"data-test":"messages-search-filter-indicator"}),o.jsxs(Ye,{open:a,onOpenChange:i,children:[o.jsx(at,{asChild:!0,children:o.jsx(se,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0","aria-label":a?"Collapse advanced search":"Expand advanced search","data-test":"messages-search-expand-button",children:a?o.jsx(Zn,{className:"h-4 w-4"}):o.jsx(ms,{className:"h-4 w-4"})})}),o.jsxs(Ge,{align:"start",className:"advanced-search-panel w-96 max-h-[600px] overflow-y-auto","data-test":"messages-advanced-search-panel",children:[o.jsxs("div",{className:"panel-header space-y-2 pb-3 border-b","data-test":"messages-panel-header",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),o.jsx(se,{variant:"ghost",size:"sm",onClick:f,className:"h-7 text-xs","data-test":"messages-clear-filters-button",children:"Clear All"})]}),o.jsx("p",{className:"text-xs text-muted-foreground",children:"Search message content with filters"})]}),o.jsxs("div",{className:"panel-content space-y-4 py-4","data-test":"messages-panel-content",children:[o.jsxs("div",{className:"role-filter space-y-2",children:[o.jsx(me,{className:"text-sm font-medium",children:"Message Role"}),o.jsxs(Ct,{value:c.role||"all",onValueChange:x=>p("role",x==="all"?void 0:x),children:[o.jsx(mt,{className:"h-8",children:o.jsx(Rt,{})}),o.jsxs(gt,{children:[o.jsx(Ne,{value:"all",children:"All Messages"}),o.jsx(Ne,{value:"user",children:"User"}),o.jsx(Ne,{value:"assistant",children:"Assistant"})]})]})]}),o.jsxs("div",{className:"timestamp-range-filter space-y-2",children:[o.jsx(me,{className:"text-sm font-medium",children:"Timestamp Range"}),o.jsxs("div",{className:"space-y-2",children:[o.jsxs("div",{className:"timestamp-input-wrapper",children:[o.jsx(me,{htmlFor:"timestamp-after",className:"text-xs text-muted-foreground",children:"After"}),o.jsx(_e,{id:"timestamp-after",type:"datetime-local",value:c.after??"",onChange:x=>p("after",x.target.value||void 0),className:"h-8"})]}),o.jsxs("div",{className:"timestamp-input-wrapper",children:[o.jsx(me,{htmlFor:"timestamp-before",className:"text-xs text-muted-foreground",children:"Before"}),o.jsx(_e,{id:"timestamp-before",type:"datetime-local",value:c.before??"",onChange:x=>p("before",x.target.value||void 0),className:"h-8"})]})]})]}),o.jsxs("div",{className:"sorting-section space-y-2",children:[o.jsx(me,{className:"text-sm font-medium",children:"Sort By Timestamp"}),o.jsxs(Ct,{value:c.sortOrder,onValueChange:x=>p("sortOrder",x),children:[o.jsx(mt,{className:"h-8",children:o.jsx(Rt,{})}),o.jsxs(gt,{children:[o.jsx(Ne,{value:"desc",children:"Newest First"}),o.jsx(Ne,{value:"asc",children:"Oldest First"})]})]})]}),o.jsxs("div",{className:"pagination-section space-y-2",children:[o.jsx(me,{className:"text-sm font-medium",children:"Results Per Page"}),o.jsx(_e,{type:"number",min:"1",max:"100",value:c.pageSize??50,onChange:x=>p("pageSize",x.target.value?parseInt(x.target.value):50),className:"h-8"})]})]}),o.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 border-t","data-test":"messages-panel-footer",children:[o.jsx(se,{onClick:u,className:"flex-1",size:"sm","data-test":"messages-apply-search-button",children:"Apply Search"}),o.jsx(se,{onClick:()=>i(!1),variant:"outline",size:"sm","data-test":"messages-cancel-button",children:"Cancel"})]})]})]})]})})});wd.displayName="MessagesSearch";function Fs({onClick:s,textToCopy:e,title:t="Copy formatted text",size:n="icon",variant:r="ghost"}){const[a,i]=h.useState(!1),c=async()=>{if(s){s();return}if(!e){be.error("No text to copy");return}try{await navigator.clipboard.writeText(e),i(!0),be.success("Copied to clipboard!"),setTimeout(()=>i(!1),2e3)}catch(l){be.error("Failed to copy to clipboard"),console.error("Copy failed:",l)}};return o.jsx(se,{onClick:c,title:t,size:n,variant:r,children:a?o.jsx(st,{}):o.jsx(ha,{})})}const bd=s=>typeof s=="string"?o.jsx("span",{"data-test":"message-content-text",children:s}):Array.isArray(s)?s.map((e,t)=>typeof e=="string"?o.jsx("div",{className:"max-w-full break-words","data-test":"message-content-block-string",children:e},t):typeof e=="object"&&e.type==="text"&&"text"in e?o.jsx("div",{className:"max-w-full break-words","data-test":"message-content-block-text",children:e.text},t):typeof e=="object"&&e.type==="tool_use"?o.jsx("div",{className:"tool-use bg-muted-foreground/10 p-2 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-tool-use",children:o.jsxs("div",{className:"text-xs font-mono truncate","data-test":"tool-use-name",children:["Tool: ","name"in e?e.name??"Unknown":"Unknown"]})},t):o.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded mt-1 overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-block-json",children:JSON.stringify(e,null,2)},t)):typeof s=="object"&&s!==null?s.text?o.jsx("span",{"data-test":"message-content-object-text",children:s.text}):s.content?o.jsx("div",{"data-test":"message-content-recursive",children:bd(s.content)}):o.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-object-json",children:JSON.stringify(s,null,2)}):o.jsx("span",{"data-test":"message-content-fallback",children:String(s)}),sa=h.memo(({message:s,formatTime:e})=>{const[t,n]=h.useState(!1),r=i=>typeof i=="string"?i:Array.isArray(i)?i.map(c=>typeof c=="string"?c:typeof c=="object"&&c.type==="text"&&"text"in c?c.text:"").filter(Boolean).join(`
`):typeof i=="object"&&i!==null?i.text?i.text:i.content?r(i.content):JSON.stringify(i,null,2):String(i),a=async i=>{i.stopPropagation();const c=r(s.content);try{await navigator.clipboard.writeText(c),n(!0),setTimeout(()=>n(!1),2e3)}catch(l){console.error("Failed to copy message:",l)}};return o.jsx("div",{className:`message-item flex w-full ${s.role==="user"?"justify-end":"justify-start"} ${s._isOptimistic?"opacity-60":""}`,"data-test":`message-item-wrapper-${s.role}`,"data-test-message-id":s.id,"data-test-optimistic":s._isOptimistic?"true":void 0,children:o.jsxs("div",{onClick:()=>{console.log("Message clicked:",s)},className:`message-bubble max-w-[85%] rounded-lg p-3 overflow-hidden cursor-pointer ${s.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,"data-test":`message-bubble-${s.role}`,children:[o.jsxs("div",{className:"message-header mb-2 flex items-center gap-2","data-test":"message-header",children:[o.jsx("span",{className:`message-role text-xs font-semibold uppercase ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":`message-role-label-${s.role}`,children:s.role}),o.jsxs("span",{className:`message-id text-xs font-mono ${s.role==="user"?"text-primary-foreground/60":"text-muted-foreground/70"}`,"data-test":"message-id-label",children:["ID: ",s.id]})]}),o.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words overflow-wrap-anywhere word-break max-w-full","data-test":"message-content",children:bd(s.content)}),s.toolCalls&&s.toolCalls.length>0&&o.jsxs("div",{className:"message-tool-calls mt-2 space-y-1","data-test":"message-tool-calls",children:[o.jsx("div",{className:`text-xs font-semibold ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":"message-tool-calls-label",children:"Tool Calls:"}),s.toolCalls.map((i,c)=>o.jsx("div",{className:`tool-call-item p-2 rounded text-xs font-mono ${s.role==="user"?"bg-primary-foreground/10":"bg-muted-foreground/10"}`,"data-test":`tool-call-item-${c}`,children:o.jsx("pre",{className:"whitespace-pre-wrap break-words max-w-full","data-test":"tool-call-json",children:JSON.stringify(i,null,2)})},c))]}),o.jsxs("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"message-footer",children:[o.jsx("div",{className:`message-time text-xs max-w-full ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"} ${s._isOptimistic?"italic":""}`,"data-test":"message-timestamp",children:s._isOptimistic?"Sending...":e(s.timestamp)}),o.jsx("button",{onClick:a,className:`copy-button p-1 rounded hover:bg-opacity-20 transition-colors ${s.role==="user"?"hover:bg-primary-foreground":"hover:bg-foreground"}`,title:"Copy message","data-test":"copy-message-button",children:t?o.jsx(st,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground":"text-muted-foreground"}`,"data-test":"copy-success-icon"}):o.jsx(ha,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"copy-icon"})})]})]})},s.id)});sa.displayName="MessageItem";function a0({messages:s,sessionDetails:e,metadata:t,loading:n,pagination:r,onLoadOlder:a,onSearch:i,onNameUpdated:c,onFork:l,scrollToMessageId:d}){var W,R,F;const p=h.useRef(null),u=h.useRef(null),f=h.useRef(0),m=h.useRef(null),g=h.useRef(0),x=h.useRef(!1),[y,w]=h.useState(""),[v,b]=h.useState(!1);h.useEffect(()=>{const L=(e==null?void 0:e.name)??null;m.current!==L&&(f.current=0,m.current=L)},[e==null?void 0:e.name]);const j=h.useCallback(L=>new Date(L).toLocaleTimeString(),[]),S=h.useCallback(L=>{const T=new Date(L);return T.toLocaleDateString()+" "+T.toLocaleTimeString()},[]),[C,N]=h.useState(((F=(R=(W=oe.getState().app)==null?void 0:W.claude)==null?void 0:R.ui)==null?void 0:F.messageFilters)??["user","assistant","thinking","tools"]);h.useEffect(()=>{var M,D,H,Y,O,q;((H=(D=(M=oe.getState().app)==null?void 0:M.claude)==null?void 0:D.ui)==null?void 0:H.messageFilters)||oe.update("app",{claude:{...(Y=oe.getState().app)==null?void 0:Y.claude,ui:{...(q=(O=oe.getState().app)==null?void 0:O.claude)==null?void 0:q.ui,messageFilters:["user","assistant","thinking","tools"]}}});const T=oe.selectSlice(K=>{var G,U,Z;return(Z=(U=(G=K.app)==null?void 0:G.claude)==null?void 0:U.ui)==null?void 0:Z.messageFilters}).subscribe(K=>{K&&N(K)});return()=>T.unsubscribe()},[]);const A=L=>{var H,Y,O,q,K,G;const T=((O=(Y=(H=oe.getState().app)==null?void 0:H.claude)==null?void 0:Y.ui)==null?void 0:O.messageFilters)??C,M=T.includes(L)?T.filter(U=>U!==L):[...T,L],D=oe.getState();oe.setState({...D,app:{...D.app,claude:{...(q=D.app)==null?void 0:q.claude,ui:{...(G=(K=D.app)==null?void 0:K.claude)==null?void 0:G.ui,messageFilters:M}}}})},I=(L,T)=>{i&&i(L,T)},k=h.useMemo(()=>s.filter(T=>!T.content||T.content===""?!1:Array.isArray(T.content)&&T.content.some(D=>typeof D=="object"&&(D.type==="tool_use"||D.type==="tool_result"))?C.includes("tools"):!!(T.role==="user"&&C.includes("user")||T.role==="assistant"&&C.includes("assistant"))),[s,C]);h.useLayoutEffect(()=>{const L=f.current===0&&k.length>0,T=k.length>f.current&&f.current>0;if(p.current){const M=p.current.querySelector("[data-radix-scroll-area-viewport]");if(L&&M)M.scrollTop=M.scrollHeight,g.current=M.scrollHeight,f.current=k.length,x.current=!1;else if(T&&M){const D=M.scrollHeight,H=D-g.current;M.scrollTop=M.scrollTop+H,g.current=D,f.current=k.length,x.current=!0}}},[k]),h.useEffect(()=>{if(f.current!==0){if(x.current){x.current=!1;return}if(p.current){const L=p.current.querySelector("[data-radix-scroll-area-viewport]");L&&setTimeout(()=>{L.scrollTo({top:L.scrollHeight,behavior:"smooth"})},50)}}},[k]),h.useEffect(()=>{if(v&&u.current){const L=u.current.querySelector("[data-radix-scroll-area-viewport]");L&&setTimeout(()=>{L.scrollTo({top:L.scrollHeight,behavior:"auto"})},100)}},[v]);const P=h.useCallback((L=!0)=>{if(u.current){const T=u.current.querySelector("[data-radix-scroll-area-viewport]");T&&T.scrollTo({top:T.scrollHeight,behavior:L?"smooth":"auto"})}},[]);return h.useEffect(()=>{if(!d||!p.current)return;const L=p.current.querySelector(`[data-test-message-id="${d}"]`);L&&(L.scrollIntoView({behavior:"smooth",block:"center"}),L.classList.add("message-highlight"),setTimeout(()=>{L.classList.remove("message-highlight")},2e3))},[d]),o.jsxs(nn,{className:"chat-interface-card h-full flex flex-col overflow-hidden","data-test":"chat-interface-card",children:[o.jsxs(xa,{className:"chat-header pb-2 pt-4 flex-shrink-0","data-test":"chat-header",children:[o.jsxs("div",{className:"header-title-container flex items-center gap-2 text-sm","data-test":"header-title-container",children:[o.jsx(Fa,{sessionIds:e!=null&&e.id?[e.id]:[]}),o.jsx(va,{className:"text-base truncate","data-test":"chat-title",children:e?o.jsx(vd,{session:e,segmentsToStrip:3,onNameUpdated:c}):"New Conversation"}),t&&o.jsx(Yt,{children:o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:o.jsx("button",{className:"info-button p-1 hover:bg-muted rounded-sm transition-colors","data-test":"session-info-button",children:o.jsx(In,{className:"h-4 w-4 text-muted-foreground"})})}),o.jsx(Kt,{className:"metadata-tooltip","data-test":"session-metadata-tooltip",children:o.jsxs("div",{className:"metadata-section text-xs space-y-1","data-test":"metadata-section",children:[o.jsxs("div",{className:"metadata-item","data-test":"metadata-item-created",children:[o.jsx("span",{className:"font-medium",children:"Created:"})," ",S(t.created)]}),o.jsxs("div",{className:"metadata-item","data-test":"metadata-item-modified",children:[o.jsx("span",{className:"font-medium",children:"Last Modified:"})," ",S(t.lastModified)]}),o.jsxs("div",{className:"metadata-item","data-test":"metadata-item-message-count",children:[o.jsx("span",{className:"font-medium",children:"Messages:"})," ",t.messageCount]}),t.model&&o.jsxs("div",{className:"metadata-item","data-test":"metadata-item-model",children:[o.jsx("span",{className:"font-medium",children:"Model:"})," ",t.model]}),(e==null?void 0:e.id)&&o.jsxs("div",{className:"metadata-item flex items-center gap-1","data-test":"metadata-item-session-id",children:[o.jsx("span",{className:"font-medium",children:"ID:"}),o.jsxs("span",{className:"font-mono",children:[e.id.slice(0,6),"...",e.id.slice(-6)]}),o.jsx(Fs,{textToCopy:e.id,title:"Copy session ID",size:"smIconCompact",variant:"ghost"})]})]})})]})}),l&&o.jsx(Yt,{children:o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:o.jsx("button",{className:"fork-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:L=>l({x:L.clientX,y:L.clientY}),"data-test":"fork-session-button",children:o.jsx(ls,{className:"h-4 w-4 text-muted-foreground"})})}),o.jsx(Kt,{children:o.jsx("p",{children:"Fork this session"})})]})}),o.jsx(Yt,{children:o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:o.jsx("button",{className:"expand-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:()=>b(!0),"data-test":"expand-chat-button",children:o.jsx(Uu,{className:"h-4 w-4 text-muted-foreground"})})}),o.jsx(Kt,{children:o.jsx("p",{children:"Expand chat view"})})]})}),o.jsx(en,{storageKey:"chat-interface-config",title:"Chat Configuration",contentClassName:"chat-config-panel w-64",children:o.jsxs("div",{className:"config-content space-y-4","data-test":"chat-config-content",children:[o.jsxs("div",{className:"project-selector-section space-y-2","data-test":"project-selector-section",children:[o.jsx("div",{className:"section-label text-sm font-medium",children:"Project"}),o.jsx(cc,{variant:"select",className:"w-full"})]}),o.jsxs("div",{className:"filters-section space-y-2","data-test":"message-filters-section",children:[o.jsx("div",{className:"section-label text-sm font-medium",children:"Show messages"}),o.jsxs("div",{className:"filter-options space-y-2","data-test":"filter-options",children:[o.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-user",children:[o.jsx(Ft,{id:"filter-user",checked:C.includes("user"),onCheckedChange:()=>A("user"),"data-test":"filter-checkbox-user"}),o.jsx(me,{htmlFor:"filter-user",className:"text-sm cursor-pointer",children:"User"})]}),o.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-assistant",children:[o.jsx(Ft,{id:"filter-assistant",checked:C.includes("assistant"),onCheckedChange:()=>A("assistant"),"data-test":"filter-checkbox-assistant"}),o.jsx(me,{htmlFor:"filter-assistant",className:"text-sm cursor-pointer",children:"Assistant"})]}),o.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-thinking",children:[o.jsx(Ft,{id:"filter-thinking",checked:C.includes("thinking"),onCheckedChange:()=>A("thinking"),"data-test":"filter-checkbox-thinking"}),o.jsx(me,{htmlFor:"filter-thinking",className:"text-sm cursor-pointer",children:"Thinking"})]}),o.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-tools",children:[o.jsx(Ft,{id:"filter-tools",checked:C.includes("tools"),onCheckedChange:()=>A("tools"),"data-test":"filter-checkbox-tools"}),o.jsx(me,{htmlFor:"filter-tools",className:"text-sm cursor-pointer",children:"Tools"})]})]})]})]})})]}),i&&o.jsx(wd,{searchQuery:y,onSearchChange:w,onAdvancedSearch:I,className:"mt-3"})]}),o.jsx(rn,{className:"chat-content flex-1 min-h-0 overflow-hidden p-0","data-test":"chat-content",children:o.jsx(Gn,{ref:p,className:"chat-scroll-area h-full w-full",viewportClassName:"!block","data-test":"chat-scroll-area",children:o.jsxs("div",{className:"messages-container space-y-4 px-4 pt-2 w-full max-w-full overflow-x-hidden","data-test":"messages-container",children:[a&&r&&o.jsx("div",{className:"load-older-container flex justify-center pb-4 pt-2","data-test":"load-older-container",children:o.jsxs(se,{variant:"outline",size:"sm",onClick:a,disabled:n,className:"load-older-button","data-test":"load-older-button",children:[o.jsx(ms,{className:"h-4 w-4 mr-2 rotate-180"}),"Load Older Messages",r&&o.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(",s.length," of ",r.totalCount,")"]})]})}),n&&k.length===0?o.jsx("div",{className:"loading-message text-sm text-muted-foreground","data-test":"loading-message",children:"Loading messages..."}):k.length===0?o.jsxs("div",{className:"empty-state text-center mt-8","data-test":"empty-state",children:[o.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"New Session"}),o.jsx("p",{className:"text-sm text-muted-foreground",children:"Type your first message below to start the conversation"})]}):k.map(L=>o.jsx(sa,{message:L,formatTime:j,"data-test":`message-item-${L.id}`},L.id))]})})}),o.jsx(us,{isVisible:v,onClose:()=>b(!1),title:e?typeof e.customName=="string"?e.customName:e.name:"Chat Messages",shouldCloseManually:!0,resizable:!0,initialSize:{width:1e3,height:700},initialPosition:{x:100,y:50},children:o.jsxs("div",{className:"expanded-chat-content flex flex-col flex-1 overflow-hidden","data-test":"expanded-chat-view",children:[o.jsxs("div",{className:"expanded-controls-header flex items-center justify-between gap-4 px-4 py-2 border-b border-border flex-shrink-0","data-test":"expanded-controls-header",children:[o.jsxs("div",{className:"filter-controls flex items-center gap-3","data-test":"expanded-filter-controls",children:[o.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Show:"}),o.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[o.jsx(Ft,{id:"expanded-filter-user",checked:C.includes("user"),onCheckedChange:()=>A("user"),"data-test":"expanded-filter-checkbox-user"}),o.jsx(me,{htmlFor:"expanded-filter-user",className:"text-xs cursor-pointer",children:"User"})]}),o.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[o.jsx(Ft,{id:"expanded-filter-assistant",checked:C.includes("assistant"),onCheckedChange:()=>A("assistant"),"data-test":"expanded-filter-checkbox-assistant"}),o.jsx(me,{htmlFor:"expanded-filter-assistant",className:"text-xs cursor-pointer",children:"Assistant"})]}),o.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[o.jsx(Ft,{id:"expanded-filter-tools",checked:C.includes("tools"),onCheckedChange:()=>A("tools"),"data-test":"expanded-filter-checkbox-tools"}),o.jsx(me,{htmlFor:"expanded-filter-tools",className:"text-xs cursor-pointer",children:"Tools"})]})]}),o.jsxs(se,{variant:"outline",size:"sm",onClick:()=>P(!0),className:"scroll-to-bottom-button flex items-center gap-1.5 h-7 text-xs","data-test":"scroll-to-bottom-button",title:"Scroll to latest message",children:[o.jsx(Bu,{className:"h-3 w-3"}),"Latest"]})]}),o.jsx("div",{className:"flex-1 min-h-0 p-4 pt-2",children:o.jsx(Gn,{className:"h-full",ref:u,children:o.jsx("div",{className:"messages-container-expanded space-y-4 pr-4",children:k.length===0?o.jsxs("div",{className:"empty-state text-center mt-8","data-test":"expanded-empty-state",children:[o.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"No Messages"}),o.jsx("p",{className:"text-sm text-muted-foreground",children:"This session has no messages yet"})]}):k.map(L=>o.jsx(sa,{message:L,formatTime:j,"data-test":`expanded-message-item-${L.id}`},L.id))})})})]})})]})}function yd({sessionId:s,message:e,onBeforeSend:t,onSendSuccess:n,onSendError:r,outputFormat:a="text",permissionMode:i="acceptEdits",variant:c="ghost",size:l="icon",className:d="",title:p="Send to Claude session",disabled:u,...f}){const[m,g]=h.useState(!1);h.useEffect(()=>{g(!1)},[s]);const x=h.useCallback(async()=>{if(e.trim()){t==null||t();try{g(!0),await Ke.sendMessage({message:e.trim(),sessionId:s,options:{outputFormat:a,permissionMode:i}}),console.log(`Sent message to Claude session ${s}: ${e}`),n==null||n()}catch(y){console.error("Failed to send message to Claude:",y),r==null||r(y)}finally{g(!1)}}},[e,s,a,i,m,t,n,r]);return o.jsx(se,{variant:c,size:l,onClick:x,className:d,title:p,disabled:u||!e.trim(),"data-test":"claude-send-button","data-test-sending":m?"true":"false",...f,children:m?o.jsx(tr,{className:"h-3 w-3 animate-spin loading-indicator","data-test":"send-button-loading"}):o.jsx(Ar,{className:"h-3 w-3","data-test":"send-button-icon"})})}function o0({sessionId:s,initialMessage:e="",rows:t=3,value:n,onChange:r,onSendSuccess:a,onSendError:i,onAddOptimisticMessage:c,onRemoveOptimisticMessage:l}){const[d,p]=h.useState(e),u=h.useRef(null),f=h.useRef(null),m=n??d,g=r??p;h.useEffect(()=>{var S,C,N;const b=(N=(C=(S=oe.getState().app)==null?void 0:S.claude)==null?void 0:C.ui)==null?void 0:N.messageDrafts,j=b==null?void 0:b[s];p(j||"")},[s]),h.useEffect(()=>{var b,j,S,C,N,A;if(!n){const k={...((S=(j=(b=oe.getState().app)==null?void 0:b.claude)==null?void 0:j.ui)==null?void 0:S.messageDrafts)||{}};d.trim()?k[s]=d:delete k[s],oe.updateState({app:{...oe.getState().app,claude:{...(C=oe.getState().app)==null?void 0:C.claude,ui:{...(A=(N=oe.getState().app)==null?void 0:N.claude)==null?void 0:A.ui,messageDrafts:k}}}})}},[d,s,n]);const x=()=>{var C,N,A,I,k,P,W;if(c&&m.trim()){const R=c(m.trim());f.current=R}g("");const b=(C=u.current)==null?void 0:C.getTextArea();b&&(b.value="",b.dispatchEvent(new Event("input",{bubbles:!0})));const S={...((I=(A=(N=oe.getState().app)==null?void 0:N.claude)==null?void 0:A.ui)==null?void 0:I.messageDrafts)||{}};delete S[s],oe.updateState({app:{...oe.getState().app,claude:{...(k=oe.getState().app)==null?void 0:k.claude,ui:{...(W=(P=oe.getState().app)==null?void 0:P.claude)==null?void 0:W.ui,messageDrafts:S}}}})},y=()=>{f.current=null,a==null||a()},w=b=>{l&&f.current&&(l(f.current),f.current=null),i==null||i(b)},v=b=>{var j;b.key==="Enter"&&!b.shiftKey&&(b.preventDefault(),(j=document.querySelector(".claude-send-button"))==null||j.click())};return o.jsx("div",{className:"message-input-container","data-test":"message-input-container",children:o.jsxs("div",{className:"message-input-area flex gap-2","data-test":"message-input-area",children:[o.jsx(Zt,{ref:u,value:m,onChange:b=>g(b.target.value),onKeyDown:v,placeholder:"Type your message... (Shift+Enter for new line, @ to insert file path)",className:"message-textarea resize-y flex-1",showBuiltInPopover:!1,rows:t,"data-test":"message-textarea"}),o.jsx("div",{className:"send-controls flex flex-col gap-2","data-test":"send-controls",children:o.jsx(md,{variant:"ghost",size:"icon",buttonLabel:"",children:b=>o.jsx(yd,{sessionId:s,message:m,outputFormat:b.outputFormat,permissionMode:b.permissionMode,className:"claude-send-button send-button",size:"icon",onBeforeSend:x,onSendSuccess:y,onSendError:w})})})]})})}function i0({forkCount:s,forkedFromName:e,forkedFromId:t,onClick:n,size:r="default"}){if(!s&&!e)return null;const a=!!e,i=s&&s>0,c=r==="sm"?10:12,l=r==="sm"?"text-[10px] px-1.5 py-0":"",d=p=>{a&&t&&n&&(p.stopPropagation(),n(t))};return a?o.jsx(Yt,{children:o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:o.jsxs(ot,{"data-test":"fork-indicator-forked-from",variant:"secondary",className:`fork-indicator-badge gap-1 cursor-pointer hover:bg-secondary/80 ${l}`,onClick:d,children:[o.jsx(ls,{size:c,"data-test":"fork-indicator-icon"}),o.jsx("span",{"data-test":"fork-indicator-label",children:"Forked"})]})}),o.jsxs(Kt,{"data-test":"fork-indicator-tooltip",children:[o.jsxs("p",{children:["Forked from: ",e]}),n&&o.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to view parent"})]})]})}):i?o.jsx(Yt,{children:o.jsxs(Xt,{children:[o.jsx(Qt,{asChild:!0,children:o.jsxs(ot,{"data-test":"fork-indicator-count",variant:"outline",className:`fork-indicator-badge gap-1 ${l}`,children:[o.jsx(ls,{size:c,"data-test":"fork-indicator-icon"}),o.jsx("span",{"data-test":"fork-indicator-count-value",children:s})]})}),o.jsx(Kt,{"data-test":"fork-indicator-tooltip",children:o.jsxs("p",{children:[s," fork",s>1?"s":""," created from this session"]})})]})}):null}function c0(s){const e=new Date,t=new Date(s),n=e.getTime()-t.getTime(),r=Math.floor(n/(1e3*60)),a=Math.floor(n/(1e3*60*60)),i=Math.floor(n/(1e3*60*60*24)),c=Math.floor(i/7),l=Math.floor(i/365);return r<1?"just now":r<60?`${r} min ago`:a<24?`${a} ${a===1?"hour":"hours"} ago`:i<7?`${i} ${i===1?"day":"days"} ago`:c<52?`${c} ${c===1?"week":"weeks"} ago`:`${l} ${l===1?"year":"years"} ago`}function Sd({session:s,isSelected:e,onClick:t,formatDate:n,formatCwd:r,segmentsToStrip:a=3,onNameUpdated:i,compact:c=!1,forkCount:l,forkedFromName:d,forkedFromId:p,onFork:u,onNavigateToParent:f}){const m=g=>{g.stopPropagation(),u==null||u(s)};return o.jsxs("div",{"data-test":"session-list-item",onClick:()=>{console.log("Session selected:",s),t()},className:`session-item group relative ${c?"p-1.5":"p-3"} rounded-lg border cursor-pointer transition-colors ${e?"bg-primary/10 border-primary":"hover:bg-accent"}`,children:[o.jsx("div",{"data-test":"session-cwd",className:"session-cwd text-xs text-muted-foreground truncate",children:r(s.cwd)}),o.jsxs("div",{"data-test":"session-name-container",className:`session-name-container ${c?"font-medium text-sm":"font-bold text-base"} break-words line-clamp-2 ${c?"":"mt-1"} flex items-center gap-2`,children:[o.jsx(Fa,{sessionIds:[s.id]}),o.jsx(vd,{session:s,segmentsToStrip:a,onNameUpdated:i})]}),(s.latestMessage||s.firstMessage)&&!c&&o.jsx("div",{"data-test":"session-latest-message",className:"session-latest-message text-sm text-muted-foreground truncate mt-1",children:s.latestMessage||s.firstMessage}),o.jsxs("div",{"data-test":"session-meta",className:`session-meta text-xs text-muted-foreground flex items-center gap-2 flex-wrap ${c?"mt-0.5":"mt-1"}`,children:[o.jsxs("span",{children:[s.messageCount," messages"]}),o.jsx("span",{children:"â€¢"}),o.jsx("span",{children:c0(s.lastModified)}),o.jsx("span",{children:"â€¢"}),o.jsx("span",{children:n(s.lastModified)}),(l||d)&&o.jsxs(o.Fragment,{children:[o.jsx("span",{children:"â€¢"}),o.jsx(i0,{forkCount:l,forkedFromName:d,forkedFromId:p,onClick:f,size:"sm"})]})]}),u&&!c&&o.jsx("div",{"data-test":"session-fork-action",className:"session-fork-action absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity",children:o.jsx(se,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:m,title:"Fork this session","data-test":"session-fork-btn",children:o.jsx(ls,{size:14})})})]})}const l0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},d0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1};function Cd({value:s,onChange:e,className:t="",placeholder:n="Select a session",label:r="Claude Session",showLabel:a=!0,multiSelect:i=!1}){const[c,l]=h.useState(!1),d=Re(l0),p=Re(d0),u=Array.isArray(s)?s:s?[s]:[],f=h.useMemo(()=>[...d].sort((w,v)=>{const b=new Date(w.lastModified).getTime();return new Date(v.lastModified).getTime()-b}),[d]),m=f.filter(w=>u.includes(w.id)),g=w=>new Date(w).toLocaleDateString(),x=w=>w?w.split("/").slice(-2).join("/"):"No directory",y=w=>{if(i){const v=u.includes(w)?u.filter(b=>b!==w):[...u,w];e(v)}else e(w===s?"":w),l(!1)};return o.jsxs("div",{"data-test":"session-selector",className:`session-selector-container ${t}`,children:[a&&o.jsx(me,{"data-test":"session-selector-label",className:"session-selector-label",children:r}),o.jsxs(Ye,{open:c,onOpenChange:l,children:[o.jsx(at,{asChild:!0,children:o.jsxs(se,{"data-test":"session-selector-trigger",variant:"outline",role:"combobox","aria-expanded":c,className:"session-selector-trigger w-full justify-between",disabled:p,children:[m.length>0?o.jsx("span",{className:"truncate",children:i?`${m.length} session${m.length>1?"s":""} selected`:m[0].customName||m[0].name}):o.jsx("span",{className:"text-muted-foreground",children:n}),o.jsx(Di,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),o.jsx(Ge,{"data-test":"session-selector-content",className:"session-selector-content w-[400px] p-0",style:{zIndex:Je.draggablePopoverDropdown},children:o.jsxs(sr,{children:[o.jsx(nr,{"data-test":"session-selector-search",placeholder:"Search sessions..."}),o.jsxs(tn,{className:"max-h-[300px]",children:[o.jsx(sn,{children:"No sessions found."}),o.jsxs(js,{children:[!i&&o.jsxs(es,{"data-test":"session-selector-item-none",value:"none",onSelect:()=>{e(""),l(!1)},className:"session-selector-item-none",children:[o.jsx(st,{className:B("mr-2 h-4 w-4",u.length===0?"opacity-100":"opacity-0")}),"No Session"]}),f.map(w=>o.jsx(es,{"data-test":`session-selector-item-${w.id}`,value:w.id,onSelect:()=>y(w.id),className:"session-selector-item p-0 cursor-pointer",children:o.jsxs("div",{className:"flex items-center w-full",children:[o.jsx(st,{className:B("mr-2 h-4 w-4 shrink-0",u.includes(w.id)?"opacity-100":"opacity-0")}),o.jsx("div",{className:"flex-1 min-w-0",children:o.jsx(Sd,{session:w,isSelected:u.includes(w.id),onClick:()=>{},formatDate:g,formatCwd:x,compact:!0})})]})},w.id))]}),f.length===0&&!p&&o.jsx("div",{"data-test":"session-selector-no-sessions",className:"no-sessions text-center py-4 text-sm text-muted-foreground",children:"No sessions available"}),p&&o.jsx("div",{"data-test":"session-selector-loading",className:"loading-sessions text-center py-4 text-sm text-muted-foreground",children:"Loading sessions..."})]})]})})]})]})}const u0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]};function p0({sessionIds:s,currentIndex:e,onIndexChange:t,disabled:n=!1,className:r=""}){const[a,i]=h.useState(!1),[c,l]=h.useState(""),d=Re(u0),p=h.useMemo(()=>s.map(v=>d.find(b=>b.id===v)).filter(v=>v!==void 0),[s,d]),u=p[e],f=p.filter(v=>(v.customName??v.name).toLowerCase().includes(c.toLowerCase())),m=v=>{t(v),i(!1),l("")},g=v=>{if(v.stopPropagation(),n||p.length===0)return;const b=e-1,j=b<0?p.length-1:b;t(j)},x=v=>{if(v.stopPropagation(),n||p.length===0)return;const b=e+1,j=b>=p.length?0:b;t(j)},y=v=>new Date(v).toLocaleDateString(),w=v=>v?v.split("/").slice(-2).join("/"):"No directory";return p.length===0?null:p.length===1?o.jsx(ot,{variant:"outline",className:B("navigable-session-badge bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed",r),"data-test":"navigable-session-badge-single",children:(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"}):o.jsxs("div",{className:B("navigable-session-selector flex items-center gap-1",r),"data-test":"navigable-session-selector",children:[o.jsx("button",{onClick:g,disabled:n,className:B("chevron-left p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous session","data-test":"navigable-session-previous-button",children:o.jsx(Zs,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),o.jsxs(Ye,{open:a,onOpenChange:i,children:[o.jsx(at,{asChild:!0,children:o.jsxs(ot,{variant:"outline",className:B("navigable-badge cursor-pointer hover:opacity-80 transition-opacity bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed"),onClick:v=>{v.stopPropagation(),n&&v.preventDefault()},"data-test":"navigable-session-badge",children:[(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"," (",e+1,"/",p.length,")"]})}),o.jsx(Ge,{className:"popover-content w-[400px] p-2",align:"start","data-test":"navigable-session-popover-content",children:o.jsxs("div",{className:"selector-container space-y-2","data-test":"navigable-session-selector-container",children:[o.jsx(_e,{placeholder:"Search sessions...",value:c,onChange:v=>l(v.target.value),className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"navigable-session-search-input"}),o.jsx("div",{className:"sessions-list max-h-64 overflow-y-auto space-y-1","data-test":"navigable-session-list",children:f.length===0?o.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"navigable-session-empty-state",children:"No sessions found"}):f.map(v=>{const b=p.indexOf(v);return o.jsxs(se,{variant:"ghost",className:B("session-item w-full justify-between h-auto px-2 py-1",b===e&&"bg-accent"),onClick:()=>m(b),"data-test":`navigable-session-item-${v.id}`,children:[o.jsx("div",{className:"flex-1 min-w-0",children:o.jsx(Sd,{session:v,isSelected:b===e,onClick:()=>{},formatDate:y,formatCwd:w,compact:!0})}),b===e&&o.jsx(st,{className:"check-icon h-4 w-4 ml-2 shrink-0","data-test":"navigable-session-check-icon"})]},v.id)})})]})})]}),o.jsx("button",{onClick:x,disabled:n,className:B("chevron-right p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Next session","data-test":"navigable-session-next-button",children:o.jsx(ds,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]})}function h0(s,e={}){const{loadOnMount:t=!0,subscribeToSSE:n=!0,pageSize:r=50,messageType:a,onSessionDeleted:i}=e,[c,l]=h.useState([]),[d,p]=h.useState(null),[u,f]=h.useState(null),[m,g]=h.useState(!1),[x,y]=h.useState(null),[w,v]=h.useState(1),[b,j]=h.useState(""),[S,C]=h.useState(null),[N,A]=h.useState(!1),I=h.useRef(),k=h.useCallback(async(T=1,M=!1,D=!1)=>{var H,Y,O;if(s)try{D||g(!0),j(""),C(null),A(!1);const q=a??((O=(Y=(H=oe.getState().app)==null?void 0:H.claude)==null?void 0:Y.ui)==null?void 0:O.messageFilters),K=await Ke.getSessionDetails(s,{page:T,pageSize:r,messageType:q});l(M?G=>[...K.messages,...G]:G=>{const U=G.filter(ae=>!ae._isOptimistic),Z=G.filter(ae=>ae._isOptimistic),ue=new Set(K.messages.filter(ae=>ae.role==="user").map(ae=>typeof ae.content=="string"?ae.content:JSON.stringify(ae.content))),we=Z.filter(ae=>{const Te=typeof ae.content=="string"?ae.content:JSON.stringify(ae.content);return!ue.has(Te)});return[...K.messages,...we]}),p({id:s,name:K.name,customName:K.customName,cwd:K.cwd}),f(K.metadata),y(K.pagination??null),v(T)}catch(q){console.error("Failed to load session details:",q),l([]),p(null),f(null),y(null)}finally{D||g(!1)}},[s,r,a]),P=h.useCallback(async(T,M,D=!1)=>{if(s)try{g(!0),j(T),C(M),A(!0);const H=await Ke.searchSessionMessages(s,T,M);l(D?Y=>[...H.results,...Y]:H.results),y(H.pagination),v(H.pagination.page)}catch(H){D||l([]),console.error("Failed to search messages:",H)}finally{g(!1)}},[s]),W=h.useCallback(()=>{if(!(!s||!x||w>=x.totalPages))if(N&&b!==void 0){const T={...S,page:w+1};P(b,T,!0)}else k(w+1,!0)},[s,x,w,N,b,S,P,k]),R=h.useCallback(async()=>{s&&(N&&b!==void 0?await P(b,{...S,page:w}):await k(w))},[s,N,b,S,w,P,k]),F=h.useCallback(T=>{const M=`optimistic-${Date.now()}`,D={id:M,role:"user",content:T,timestamp:new Date().toISOString(),_isOptimistic:!0};return l(H=>[...H,D]),M},[]),L=h.useCallback(T=>{l(M=>M.filter(D=>D.id!==T))},[]);return h.useEffect(()=>{l([]),p(null),f(null),y(null),v(1),j(""),C(null),A(!1),s&&t&&k(1)},[s,t]),h.useEffect(()=>{if(!s)return;const T=oe.selectSlice(M=>{var D,H,Y;return(Y=(H=(D=M.app)==null?void 0:D.claude)==null?void 0:H.ui)==null?void 0:Y.messageFilters}).subscribe(M=>{if(JSON.stringify(I.current)!==JSON.stringify(M)&&(I.current=M,!a))if(N&&b!==void 0){const H={...S,messageType:M,page:1};P(b,H)}else k(1,!1,!0)});return()=>T.unsubscribe()},[s,a,N,b,S,P,k]),fa(T=>{T.type!=="batch-modified"&&("sessionId"in T&&T.sessionId!==s||(T.type==="modified"&&(async()=>{var M,D,H;if(s)try{const Y=a??((H=(D=(M=oe.getState().app)==null?void 0:M.claude)==null?void 0:D.ui)==null?void 0:H.messageFilters),O=await Ke.getSessionDetails(s,{page:1,pageSize:r,messageType:Y});l(q=>{const K=new Set(q.filter(ue=>!ue._isOptimistic).map(ue=>ue.id)),G=O.messages.filter(ue=>!K.has(ue.id)),U=new Set(O.messages.filter(ue=>ue.role==="user").map(ue=>typeof ue.content=="string"?ue.content:JSON.stringify(ue.content))),Z=q.filter(ue=>{if(!ue._isOptimistic)return!0;const we=typeof ue.content=="string"?ue.content:JSON.stringify(ue.content);return!U.has(we)});return G.length===0&&Z.length===q.length?q:[...Z,...G]}),f(O.metadata)}catch(Y){console.error("Failed to fetch new messages on SSE update:",Y)}})(),T.type==="deleted"&&(l([]),p(null),f(null),y(null),i==null||i())))},T=>{console.error("SSE connection error in useSessionMessages:",T)},!!s&&n),{messages:c,sessionDetails:d,metadata:u,loading:m,pagination:x,currentPage:w,isSearchActive:N,loadSessionDetails:k,loadOlderMessages:W,searchMessages:P,refreshSession:R,addOptimisticMessage:F,removeOptimisticMessage:L}}function f0({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1}){const[a,i]=h.useState(!1),[c,l]=h.useState(""),d=e.find(x=>x.value===s),p=e.findIndex(x=>x.value===s),u=e.filter(x=>x.label.toLowerCase().includes(c.toLowerCase())),f=x=>{t==null||t(x),i(!1),l("")},m=x=>{if(x.stopPropagation(),r)return;const y=p-1,w=y<0?e.length-1:y;t==null||t(e[w].value)},g=x=>{if(x.stopPropagation(),r)return;const y=p+1,w=y>=e.length?0:y;t==null||t(e[w].value)};return d?o.jsxs("div",{className:"navigable-select-container flex items-center gap-1",children:[o.jsx("button",{onClick:m,disabled:r,className:B("chevron-left p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous option",children:o.jsx(Zs,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),o.jsxs(Ye,{open:a,onOpenChange:i,children:[o.jsx(at,{asChild:!0,children:o.jsx(ot,{variant:d.variant||"secondary",className:B("navigable-badge cursor-pointer hover:opacity-80 transition-opacity",d.className,r&&"opacity-50 cursor-not-allowed"),onClick:x=>{x.stopPropagation(),r&&x.preventDefault()},children:d.label})}),o.jsx(Ge,{className:"popover-content w-64 p-2",align:"start",children:o.jsxs("div",{className:"selector-container space-y-2",children:[o.jsx(_e,{placeholder:n,value:c,onChange:x=>l(x.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),o.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?o.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(x=>o.jsxs(se,{variant:"ghost",className:B("option-item w-full justify-between h-8 px-2",x.value===s&&"bg-accent"),onClick:()=>f(x.value),children:[o.jsx(ot,{variant:x.variant||"secondary",className:B("text-xs",x.className),children:x.label}),x.value===s&&o.jsx(st,{className:"check-icon h-4 w-4"})]},x.value))})]})})]}),o.jsx("button",{onClick:g,disabled:r,className:B("chevron-right p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Next option",children:o.jsx(ds,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]}):null}function $s(){var s;try{const e=(s=oe.getState().app)==null?void 0:s.kanban;return e?{spaces:e.spaces??[],activeSpaceId:e.activeSpaceId??"all",customPresets:e.customPresets??[],activePresetId:e.activePresetId??"all",currentFilters:e.currentFilters??na,customCategories:e.customCategories??[]}:null}catch(e){return console.error("Failed to load persisted Kanban state:",e),null}}function Nn(s){var e;try{const t=oe.getState();oe.updateState({app:{...t.app,kanban:{...(e=t.app)==null?void 0:e.kanban,...s}}})}catch(t){console.error("Failed to save persisted Kanban state:",t)}}function m0(){try{const s=oe.getState();oe.updateState({app:{...s.app,kanban:void 0}})}catch(s){console.error("Failed to clear persisted Kanban state:",s)}}const nj={id:!0,title:!0,description:!0,status:!0,priority:!0,category:!0,space:!0,claudeProjectPath:!0,dueDate:!0,createdAt:!0,updatedAt:!0,completedAt:!0,tags:!0,subtasks:!0},na={searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[ze.FREEZER,ze.BACKLOG,ze.SELECTED,ze.DOING,ze.DONE,ze.ARCHIVE]};function g0(s){return s&&s.version==="4.0"&&"todos"in s&&"spaces"in s}function x0(s){return{version:"4.0",exportedAt:new Date().toISOString(),...s,loading:!1,error:void 0}}const v0=[{value:Gt.PERSONAL,label:"Personal",variant:"secondary",className:"bg-purple-100 text-purple-800 border-purple-200"},{value:Gt.WORK,label:"Work",variant:"secondary",className:"bg-indigo-100 text-indigo-800 border-indigo-200"},{value:Gt.SHOPPING,label:"Shopping",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Gt.HEALTH,label:"Health",variant:"secondary",className:"bg-pink-100 text-pink-800 border-pink-200"},{value:Gt.OTHER,label:"Other",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}],Ir=["bg-red-100 text-red-800 border-red-200","bg-orange-100 text-orange-800 border-orange-200","bg-amber-100 text-amber-800 border-amber-200","bg-yellow-100 text-yellow-800 border-yellow-200","bg-lime-100 text-lime-800 border-lime-200","bg-emerald-100 text-emerald-800 border-emerald-200","bg-teal-100 text-teal-800 border-teal-200","bg-cyan-100 text-cyan-800 border-cyan-200","bg-sky-100 text-sky-800 border-sky-200","bg-blue-100 text-blue-800 border-blue-200","bg-violet-100 text-violet-800 border-violet-200","bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200","bg-rose-100 text-rose-800 border-rose-200"];class w0{getAllCategories(){const e=this.getCustomCategories();return[...v0,...e]}getCustomCategories(){try{const e=$s();return(e==null?void 0:e.customCategories)??[]}catch(e){return console.error("[CategoryFacade] Failed to load custom categories:",e),[]}}createCategory(e){try{if(!e||!e.trim())return{success:!1,error:"Category label cannot be empty"};const t=e.trim();if(this.getAllCategories().find(f=>f.label.toLowerCase()===t.toLowerCase()))return{success:!1,error:`Category "${t}" already exists`};const a=`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=this.getCustomCategories(),c=i.map(f=>f.className||""),l=this.getRandomColorClass(c),d={id:a,value:a,label:t,variant:"secondary",className:l,isCustom:!0},p=$s(),u=[...i,d];return Nn({...p,spaces:(p==null?void 0:p.spaces)??[],activeSpaceId:(p==null?void 0:p.activeSpaceId)??"all",customPresets:(p==null?void 0:p.customPresets)??[],activePresetId:(p==null?void 0:p.activePresetId)??"all",currentFilters:(p==null?void 0:p.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:u}),{success:!0,category:d}}catch(t){return console.error("[CategoryFacade] Failed to create category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}deleteCategory(e){try{if(this.isDefaultCategory(e))return{success:!1,error:"Cannot delete default categories"};const t=this.getCustomCategories();if(!t.find(i=>i.id===e))return{success:!1,error:`Category with ID "${e}" not found`};const r=t.filter(i=>i.id!==e),a=$s();return Nn({...a,spaces:(a==null?void 0:a.spaces)??[],activeSpaceId:(a==null?void 0:a.activeSpaceId)??"all",customPresets:(a==null?void 0:a.customPresets)??[],activePresetId:(a==null?void 0:a.activePresetId)??"all",currentFilters:(a==null?void 0:a.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:r}),{success:!0,deletedId:e}}catch(t){return console.error("[CategoryFacade] Failed to delete category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}isDefaultCategory(e){return Object.values(Gt).includes(e)}categoryExists(e){return this.getAllCategories().some(n=>n.value===e)}getCategoryByValue(e){return this.getAllCategories().find(n=>n.value===e)}clearAllCustomCategories(){try{const e=$s();Nn({...e,spaces:(e==null?void 0:e.spaces)??[],activeSpaceId:(e==null?void 0:e.activeSpaceId)??"all",customPresets:(e==null?void 0:e.customPresets)??[],activePresetId:(e==null?void 0:e.activePresetId)??"all",currentFilters:(e==null?void 0:e.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:[]}),console.info("[CategoryFacade] Cleared all custom categories")}catch(e){console.error("[CategoryFacade] Failed to clear custom categories:",e)}}getRandomColorClass(e){const t=Ir.filter(n=>!e.includes(n));return t.length===0?Ir[Math.floor(Math.random()*Ir.length)]:t[Math.floor(Math.random()*t.length)]}}const ws=new w0,b0=s=>{var e,t;return((t=(e=s.app)==null?void 0:e.kanban)==null?void 0:t.customCategories)??[]};function y0({value:s,onChange:e,placeholder:t="Search categories...",disabled:n=!1}){const[r,a]=h.useState(!1),[i,c]=h.useState(""),l=Re(b0),d=h.useMemo(()=>ws.getAllCategories(),[l]),p=d.find(w=>w.value===s),u=d.filter(w=>w.label.toLowerCase().includes(i.toLowerCase())),f=h.useCallback(w=>{e==null||e(w),a(!1),c("")},[e]),m=h.useCallback(()=>{if(!i.trim())return;const w=ws.createCategory(i.trim());w.success&&w.category?(f(w.category.value),c("")):console.error("[CategorySelector] Failed to create category:",w.error)},[i,f]),g=h.useCallback((w,v)=>{var j;if(w.stopPropagation(),ws.isDefaultCategory(v))return;const b=ws.deleteCategory(v);if(b.success){if(s===v){const S=ws.getAllCategories();f(((j=S[0])==null?void 0:j.value)||"")}}else console.error("[CategorySelector] Failed to delete category:",b.error)},[s,f]),x=h.useCallback(w=>{a(w),w||c("")},[]);if(!p)return null;const y=i.trim()&&u.length===0;return o.jsxs(Ye,{open:r,onOpenChange:x,children:[o.jsx(at,{asChild:!0,children:o.jsx(ot,{"data-test":"category-selector-trigger",variant:p.variant||"secondary",className:B("cursor-pointer hover:opacity-80 transition-opacity",p.className,n&&"opacity-50 cursor-not-allowed"),onClick:w=>{w.stopPropagation(),n&&w.preventDefault()},children:p.label})}),o.jsx(Ge,{className:"popover-content w-64 p-2",align:"start","data-test":"category-selector-popover",children:o.jsxs("div",{className:"selector-container space-y-2","data-test":"category-selector-container",children:[o.jsx(_e,{"data-test":"category-search-input",placeholder:t,value:i,onChange:w=>c(w.target.value),onKeyDown:w=>{w.key==="Enter"&&y&&(w.preventDefault(),m())},className:"search-input h-8 text-sm",autoFocus:!0}),o.jsxs("div",{className:"options-list max-h-64 overflow-y-auto space-y-1","data-test":"category-options-list",children:[u.length===0&&!y&&o.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"category-empty-state",children:"No options found"}),y&&o.jsxs(se,{"data-test":"category-create-button",variant:"ghost",className:"category-create-button w-full justify-start h-8 px-2 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:m,children:[o.jsx(Ws,{className:"create-icon h-4 w-4 mr-2","data-test":"category-create-icon"}),'Create "',i,'"']}),u.map(w=>{const v=!ws.isDefaultCategory(w.value);return o.jsxs("div",{"data-test":`category-option-wrapper-${w.value}`,className:B("option-item-wrapper flex items-center gap-1",w.value===s&&"bg-accent rounded"),children:[o.jsxs(se,{"data-test":`category-option-button-${w.value}`,variant:"ghost",className:B("option-item flex-1 justify-between h-8 px-2"),onClick:()=>f(w.value),children:[o.jsx(ot,{"data-test":`category-option-badge-${w.value}`,variant:w.variant||"secondary",className:B("text-xs",w.className),children:w.label}),w.value===s&&o.jsx(st,{className:"check-icon h-4 w-4","data-test":"category-selected-check"})]}),v&&o.jsx(se,{"data-test":`category-delete-button-${w.value}`,variant:"ghost",size:"icon",className:"category-delete-button h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50",onClick:b=>g(b,w.value),title:"Delete category",children:o.jsx(At,{className:"delete-icon h-4 w-4","data-test":"category-delete-icon"})})]},w.value)})]})]})})]})}function Kn(){return"xxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class rj{constructor(e){Q(this,"items",[]);this.initialItems=e,e&&(e.forEach(t=>{t.id===void 0&&(t.id=Kn())}),this.items=e)}create(e,t={}){const n={id:Kn(),created:new Date().toISOString(),...e},{allowDuplicate:r,uniqueByKey:a}=t;if(r)return this.items.push(n),n;let i=-1;if(a&&(i=this.items.findIndex(p=>p[a]===n[a])),i!==-1)return;const l=this.items.findIndex(p=>p.id===n.id);return l!==-1?(this.items[l]=n,n):(this.items.push(n),n)}insertAt(e,t){const n=structuredClone(this.items);return n.splice(e,0,...t),n}batchCreate(e){this.items.push(...e)}readAll(e=!0){return e?structuredClone(this.items):this.items}readBetween(e,t){const n=[];for(let r=e;r<=t;r++){const a=this.items[r];n.push(a)}return n}readById(e){return this.items.find(t=>t.id===e)}readByKey(e,t){return this.items.find(n=>n[e]===t)}readFirst(){return this.items.length===0?void 0:this.items[0]}readLast(){return this.items.length===0?void 0:this.items[this.items.length-1]}update(e){const t=this.items.findIndex(n=>n.id===e.id);t!==-1&&(this.items[t]=e)}batchUpdate(e){e.forEach(t=>{const n=this.items.findIndex(r=>r.id===t.id);n!==-1&&(this.items[n]=t)})}delete(e){console.log("[CRUDService.ts,123] this.items: ",this.items);const t=this.items.findIndex(n=>n.id===e);console.log("[CRUDService.ts,123] indexToDelete: ",t),t!==-1&&this.items.splice(t,1)}deleteByKey(e,t){this.items=this.items.filter(n=>n[e]!==t)}deleteBetween(e,t){const n=this.items.slice(0,e),r=this.items.slice(t+1,this.items.length);return[...n,...r]}batchDelete(e){this.items=this.items.filter(t=>!e.includes(t.id))}getPreviousItem(e){const n=this.getCurrentItemIndex(e)-1,r=Math.max(n,0);return this.items[r]}getNextItem(e){const n=this.getCurrentItemIndex(e)+1,r=this.count()-1,a=Math.min(n,r);return this.items[a]}getCurrentItemIndex(e){return this.findIndexByKey("id",e)}count(){return this.items.length}clear(){this.items=[]}filterByKey(e,t){return this.items.filter(n=>n[e]===t)}findByKey(e,t){return this.items.find(n=>n[e]===t)}findIndexByKey(e,t){return this.items.findIndex(n=>n[e]===t)}replace(e){e&&(this.items=e)}replaceOne(e,t){console.log(">>>> _ >>>> ~ file: CRUDService.ts:203 ~ replace:",t);const n=structuredClone(this.items);return n[e]=t,n}sort(e,t=!0){this.items.sort((n,r)=>{const a=n[e],i=r[e];return a===i?0:t?a<i?-1:1:a>i?-1:1})}}const S0="TodoDB",C0=2,tt="todos";class j0{constructor(){Q(this,"db",null)}async init(){return new Promise((e,t)=>{const n=indexedDB.open(S0,C0);n.onerror=()=>{t(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const a=r.target.result,i=r.target.transaction,c=r.oldVersion;if(!a.objectStoreNames.contains(tt)){const l=a.createObjectStore(tt,{keyPath:"id.value"});l.createIndex("status","status",{unique:!1}),l.createIndex("priority","priority",{unique:!1}),l.createIndex("category","category",{unique:!1}),l.createIndex("createdAt","createdAt.value",{unique:!1}),l.createIndex("dueDate","dueDate.value",{unique:!1}),l.createIndex("sortOrder","sortOrder",{unique:!1})}if(c<2){const l=i.objectStore(tt);l.indexNames.contains("sortOrder")||l.createIndex("sortOrder","sortOrder",{unique:!1});const d=l.getAll();d.onsuccess=()=>{const p=d.result,u={};p.forEach(f=>{const m=f.status||"backlog";u[m]||(u[m]=[]),u[m].push(f)}),Object.keys(u).forEach(f=>{u[f].forEach((m,g)=>{m.sortOrder===void 0&&(m.sortOrder=g,l.put(m))})})}}}})}async getAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const a=this.db.transaction([tt],"readonly").objectStore(tt).getAll();a.onsuccess=()=>{e(a.result)},a.onerror=()=>{t(new Error("Failed to get todos"))}})}async getById(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([tt],"readonly").objectStore(tt).get(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{n(new Error("Failed to get todo"))}})}async add(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([tt],"readwrite").objectStore(tt).add(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to add todo"))}})}async update(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([tt],"readwrite").objectStore(tt).put(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to update todo"))}})}async delete(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([tt],"readwrite").objectStore(tt).delete(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to delete todo"))}})}async clear(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const a=this.db.transaction([tt],"readwrite").objectStore(tt).clear();a.onsuccess=()=>{e()},a.onerror=()=>{t(new Error("Failed to clear todos"))}})}async count(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const a=this.db.transaction([tt],"readonly").objectStore(tt).count();a.onsuccess=()=>{e(a.result)},a.onerror=()=>{t(new Error("Failed to count todos"))}})}}const nt=new j0;function N0(s){return s&&typeof s=="object"&&("claudeProject"in s||"sessionIds"in s)}class E0{constructor(){Q(this,"initialized",!1)}async init(){if(this.initialized)return;await nt.init(),this.initialized=!0,await nt.count()===0&&await this.seedMockData()}createTodoId(e){return{value:e}}createTimestamp(e){return{value:e??new Date}}async createTodo(e){await this.init();const t=e.status??ze.BACKLOG;let n=e.sortOrder;if(n===void 0){const i=(await nt.getAll()).filter(l=>l.status===t);n=(i.length>0?Math.max(...i.map(l=>l.sortOrder??0)):-1)+1}const r={id:this.createTodoId(Kn()),title:e.title,description:e.description,status:t,priority:e.priority??Ut.MEDIUM,category:e.category??Gt.PERSONAL,space:e.space,sortOrder:n,dueDate:e.dueDate?this.createTimestamp(e.dueDate):void 0,createdAt:this.createTimestamp(),updatedAt:this.createTimestamp(),tags:e.tags??[],subtasks:[],customProps:e.customProps};return await nt.add(r),r}async getTodo(e){await this.init();const t=await nt.getById(e.value);if(!t)throw new Error(`Todo with id ${e.value} not found`);return t}async getAllTodos(e){await this.init();let t=await nt.getAll();if(e!=null&&e.filters){const{status:n,priority:r,category:a,space:i,claudeProjectPath:c,tags:l,searchQuery:d}=e.filters;if(n&&n.length>0&&(t=t.filter(p=>n.includes(p.status))),r&&r.length>0&&(t=t.filter(p=>r.includes(p.priority))),a&&a.length>0&&(t=t.filter(p=>a.includes(p.category))),i&&i.length>0&&(t=t.filter(p=>p.space&&i.includes(p.space))),c&&c.length>0&&(t=t.filter(p=>{if(N0(p.customProps))return p.customProps.claudeProjectPath&&c.includes(p.customProps.claudeProjectPath)})),l&&l.length>0&&(t=t.filter(p=>l.some(u=>p.tags.includes(u)))),d){const p=d.toLowerCase();t=t.filter(u=>{var f;return u.title.toLowerCase().includes(p)||((f=u.description)==null?void 0:f.toLowerCase().includes(p))})}}if(e!=null&&e.sort){const{field:n,direction:r}=e.sort;t.sort((a,i)=>{const c=a[n],l=i[n];if(c==null||l===void 0||l===null)return 0;const d=c<l?-1:c>l?1:0;return r==="asc"?d:-d})}else t.sort((n,r)=>(n.sortOrder??0)-(r.sortOrder??0));if((e==null?void 0:e.offset)!==void 0||(e==null?void 0:e.limit)!==void 0){const n=e.offset??0,r=e.limit??t.length;t=t.slice(n,n+r)}return t}async updateTodo(e,t){await this.init();const n=await this.getTodo(e),r={...n,...t,dueDate:t.dueDate?this.createTimestamp(t.dueDate instanceof Date?t.dueDate:new Date(t.dueDate.value)):n.dueDate,updatedAt:this.createTimestamp(),customProps:t.customProps?{...n.customProps,...t.customProps}:n.customProps};return await nt.update(r),r}async deleteTodo(e){await this.init(),await nt.delete(e.value)}async startTodo(e){return this.updateTodo(e,{status:ze.DOING})}async completeTodo(e){const t=await this.updateTodo(e,{status:ze.DONE});return t.completedAt=this.createTimestamp(),await nt.update(t),t}async cancelTodo(e){return this.updateTodo(e,{status:ze.ARCHIVE})}async addSubtask(e,t){await this.init();const n=await this.getTodo(e),r={id:this.createTodoId(Kn()),title:t.title,isCompleted:!1,createdAt:this.createTimestamp()};return n.subtasks.push(r),n.updatedAt=this.createTimestamp(),await nt.update(n),n}async updateSubtask(e,t,n){await this.init();const r=await this.getTodo(e),a=r.subtasks.find(i=>i.id.value===t.value);if(!a)throw new Error(`Subtask with id ${t.value} not found`);return n.title!==void 0&&(a.title=n.title),n.isCompleted!==void 0&&(a.isCompleted=n.isCompleted),r.updatedAt=this.createTimestamp(),await nt.update(r),r}async toggleSubtask(e,t){await this.init();const n=await this.getTodo(e),r=n.subtasks.find(a=>a.id.value===t.value);if(!r)throw new Error(`Subtask with id ${t.value} not found`);return r.isCompleted=!r.isCompleted,n.updatedAt=this.createTimestamp(),await nt.update(n),n}async removeSubtask(e,t){await this.init();const n=await this.getTodo(e);return n.subtasks=n.subtasks.filter(r=>r.id.value!==t.value),n.updatedAt=this.createTimestamp(),await nt.update(n),n}async bulkUpdateStatus(e,t){await this.init(),await Promise.all(e.map(n=>this.updateTodo(n,{status:t})))}async bulkDelete(e){await this.init(),await Promise.all(e.map(t=>this.deleteTodo(t)))}async seedMockData(){const e=[];for(const n of e){const r=await this.createTodo(n);n.title==="Complete project documentation"&&(await this.addSubtask(r.id,{title:"Write API documentation"}),await this.addSubtask(r.id,{title:"Create usage examples"}),await this.addSubtask(r.id,{title:"Add screenshots"})),n.title==="Buy groceries"&&(await this.addSubtask(r.id,{title:"Check pantry inventory"}),await this.addSubtask(r.id,{title:"Make shopping list"}))}const t=await this.getAllTodos();t.length>0&&await this.startTodo(t[0].id),t.length>3&&await this.completeTodo(t[3].id)}async clearAllTodos(){await this.init(),await nt.clear()}async exportTodos(){await this.init();const e=await this.getAllTodos(),t=$s(),n={todos:e,spaces:(t==null?void 0:t.spaces)??[],activeSpaceId:(t==null?void 0:t.activeSpaceId)??"all",customPresets:(t==null?void 0:t.customPresets)??[],activePresetId:(t==null?void 0:t.activePresetId)??"all",currentFilters:(t==null?void 0:t.currentFilters)??na,customCategories:(t==null?void 0:t.customCategories)??[],loading:!1},r={...n,todos:n.todos.map(i=>({...i,createdAt:{value:i.createdAt.value.toISOString()},updatedAt:{value:i.updatedAt.value.toISOString()},completedAt:i.completedAt?{value:i.completedAt.value.toISOString()}:void 0,dueDate:i.dueDate?{value:i.dueDate.value.toISOString()}:void 0,subtasks:i.subtasks.map(c=>({...c,createdAt:{value:c.createdAt.value.toISOString()}}))}))},a=x0(r);return JSON.stringify(a,null,2)}async importTodos(e,t){var d,p,u;await this.init();const n=[];let r=0,a=0,i=0,c=0,l=0;try{const f=JSON.parse(e);if(!g0(f))throw new Error("Invalid format: Expected KanbanExportData v4.0 format");const m=f;t!=null&&t.replace&&(await this.clearAllTodos(),m0());const g=m.todos??[];for(const x of g)try{const y={...x,createdAt:{value:new Date(x.createdAt.value)},updatedAt:{value:new Date(x.updatedAt.value)},completedAt:x.completedAt?{value:new Date(x.completedAt.value)}:void 0,dueDate:x.dueDate?{value:new Date(x.dueDate.value)}:void 0,subtasks:(x.subtasks??[]).map(v=>({...v,createdAt:{value:new Date(v.createdAt.value)}}))};await nt.getById(y.id.value)&&!(t!=null&&t.replace)?a++:(await nt.add(y),r++)}catch(y){n.push(`Failed to import todo "${x.title}": ${y instanceof Error?y.message:"Unknown error"}`),a++}try{const x={spaces:m.spaces??[],activeSpaceId:m.activeSpaceId??"all",customPresets:m.customPresets??[],activePresetId:m.activePresetId??"all",currentFilters:m.currentFilters??na,customCategories:m.customCategories??[]};Nn(x),c=((d=m.spaces)==null?void 0:d.length)??0,i=((p=m.customPresets)==null?void 0:p.length)??0,l=((u=m.customCategories)==null?void 0:u.length)??0}catch(x){n.push(`Failed to save persisted state: ${x instanceof Error?x.message:"Unknown error"}`)}return{imported:r,skipped:a,errors:n,presetsImported:i,spacesImported:c,categoriesImported:l}}catch(f){throw new Error(`Failed to parse JSON: ${f instanceof Error?f.message:"Unknown error"}`)}}}const Ve=new E0;class k0{async createTicket(e,t){await Ve.createTodo({...t,status:e})}}class I0{async createSessionForTodo(e,t){const n=await Ke.createSession({message:t.message,cwd:t.projectPath,projectId:t.projectPath,options:{outputFormat:t.outputFormat,permissionMode:t.permissionMode}});return n.success&&n.sessionId&&await this.linkSessionToTodo(e,n.sessionId),n}async linkSessionToTodo(e,t,n={mode:"append"}){var c;const r=await Ve.getTodo(e),a=((c=r.customProps)==null?void 0:c.sessionIds)??[],i=n.mode==="replace"?[t]:[...a,t];await Ve.updateTodo(e,{customProps:{...r.customProps,sessionIds:i}})}async unlinkSessionFromTodo(e,t){var i;const n=await Ve.getTodo(e),a=(((i=n.customProps)==null?void 0:i.sessionIds)??[]).filter(c=>c!==t);await Ve.updateTodo(e,{customProps:{...n.customProps,sessionIds:a}})}async getSessionsForTodo(e){var n;return((n=(await Ve.getTodo(e)).customProps)==null?void 0:n.sessionIds)??[]}async hasLinkedSessions(e){return(await this.getSessionsForTodo(e)).length>0}buildInitialMessageFromTodo(e){const t=[];if(t.push(`# ${e.title}
`),e.description&&(t.push("## Description"),t.push(e.description),t.push("")),e.dueDate){const n=new Date(e.dueDate.value);t.push(`**Due Date:** ${n.toLocaleDateString()}`),t.push("")}return e.subtasks&&e.subtasks.length>0&&(t.push("## Subtasks"),e.subtasks.forEach(n=>{const r=n.isCompleted?"[x]":"[ ]";t.push(`${r} ${n.title}`)}),t.push("")),e.tags&&e.tags.length>0&&(t.push(`**Tags:** ${e.tags.join(", ")}`),t.push("")),t.push("---"),t.push("I permit and approve all file changes in this session to help complete this task."),t.join(`
`)}async createSessionWithTodoContext(e,t,n={}){var l;const r=await Ve.getTodo(e),a=this.buildInitialMessageFromTodo(r),i=t?`${a}

---

${t}`:a,c=n.projectPath??((l=r.customProps)==null?void 0:l.claudeProjectPath);return this.createSessionForTodo(e,{message:i,projectPath:c,outputFormat:n.outputFormat,permissionMode:n.permissionMode})}async setProjectPath(e,t){const n=await Ve.getTodo(e);await Ve.updateTodo(e,{customProps:{...n.customProps,claudeProjectPath:t}})}async getProjectPath(e){var n;return(n=(await Ve.getTodo(e)).customProps)==null?void 0:n.claudeProjectPath}}class T0{constructor(){Q(this,"column");Q(this,"claude");this.column=new k0,this.claude=new I0}async createTestFailureTicket(e){const t=this.buildFailureDescription(e),n=`[Test Failure] ${e.scenario}`;await this.column.createTicket(ze.BACKLOG,{title:n,description:t,priority:Ut.HIGH,category:Gt.WORK,tags:["test-failure","bdd",e.feature.toLowerCase().replace(/\s+/g,"-")],customProps:{testFailureId:e.id,feature:e.feature,scenario:e.scenario,failedStep:e.failedStep,stepType:e.stepType,stepIndex:e.stepIndex,timestamp:e.timestamp}})}async sendTestFailureToClaude(e,t){const n=this.buildClaudeMessage(e);return await Ke.createSession({message:n,cwd:t==null?void 0:t.projectPath,projectId:t==null?void 0:t.projectPath,options:{outputFormat:t==null?void 0:t.outputFormat,permissionMode:t==null?void 0:t.permissionMode}})}buildClaudeMessage(e){const t=[];return t.push(`I have a BDD test failure that needs debugging help.
`),t.push("## Test Context"),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Step Type:** ${e.stepType||"Unknown"}`),t.push(`**Step Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Step Text:** \`${e.failedStep}\`
`)),t.push("## Error Details"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
## Request`),t.push("Please help me understand:"),t.push("1. What caused this test failure?"),t.push("2. What is the root cause of the error?"),t.push("3. How can I fix this issue?"),t.push("4. Are there any related issues I should be aware of?"),t.join(`
`)}buildFailureDescription(e){const t=[];return t.push(`# Test Failure Report
`),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Type:** ${e.stepType||"Unknown"}`),t.push(`**Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Text:** ${e.failedStep}
`)),t.push("## Error"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
---`),t.push("**Next Steps:**"),t.push("1. Review the error and failed step"),t.push("2. Reproduce the issue locally"),t.push("3. Send to Claude for analysis (Future: Phase 3)"),t.join(`
`)}}const jd=new T0,A0=[{value:Ut.LOW,label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Ut.MEDIUM,label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Ut.HIGH,label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:Ut.URGENT,label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],P0=[{value:ze.FREEZER,label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:ze.BACKLOG,label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:ze.SELECTED,label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:ze.DOING,label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:ze.DONE,label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:ze.ARCHIVE,label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],R0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},D0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1};function O0({todo:s,mode:e,onUpdate:t,onClose:n,activeSessionId:r,isProcessingAll:a=!1,currentProcessingSubtaskId:i=null,onProcessAll:c,onStopProcessing:l}){const[d,p]=h.useState(""),[u,f]=h.useState(""),[m,g]=h.useState(""),[x,y]=h.useState(""),[w,v]=h.useState(""),[b,j]=h.useState(ze.BACKLOG),[S,C]=h.useState(Ut.MEDIUM),[N,A]=h.useState(""),[I,k]=h.useState([]),[P,W]=h.useState([]),[R,F]=h.useState([]),[L,T]=h.useState(void 0),[M,D]=h.useState(0),[H,Y]=h.useState({}),O=h.useRef(null),q=h.useRef({}),K=Re(R0),G=Re(D0);h.useEffect(()=>{var E,z;s?(p(s.title),f(s.description??""),g(s.dueDate?new Date(s.dueDate.value).toISOString().split("T")[0]:""),j(s.status),C(s.priority),A(s.category),k(s.tags),W(s.subtasks),F(((E=s.customProps)==null?void 0:E.sessionIds)??[]),T((z=s.customProps)==null?void 0:z.claudeProjectPath)):(p(""),f(""),g(""),j(ze.BACKLOG),C(Ut.MEDIUM),A(""),k([]),W([]),F([]),T(void 0))},[s]);const U=h.useCallback((E,z)=>{const pe=q.current[E],X=pe==null?void 0:pe.getTextArea();if(!X||!z)return 1;const ce=X.offsetWidth;if(ce===0)return 1;const ve=window.getComputedStyle(X),ye=ve.font,Ae=ve.lineHeight,Oe=Ae==="normal"?parseFloat(ve.fontSize)*1.2:parseFloat(Ae),De=Un(z,ce,ye,Oe);return Math.max(1,Math.ceil(De/Oe))},[]);h.useEffect(()=>{const E={};P.forEach(z=>{const pe=U(z.id.value,z.title);E[z.id.value]=pe}),Y(E)},[P,U]),h.useEffect(()=>{var z;const E=(z=O.current)==null?void 0:z.getTextArea();if(E){const pe=()=>{const ce=E.offsetWidth;D(ce)};pe();const X=new ResizeObserver(pe);return X.observe(E),()=>{X.disconnect()}}},[]);const Z=h.useCallback(async E=>{if(e==="edit"&&s)try{await Ve.updateTodo(s.id,E),t()}catch(z){console.error("Failed to update todo:",z)}},[e,s,t]),ue=h.useCallback(async()=>{if(e==="create"&&d.trim())try{await jd.column.createTicket(b,{title:d.trim(),description:u.trim()||void 0,priority:S,category:N||void 0,tags:I,dueDate:m?new Date(m):void 0,customProps:{sessionIds:R,claudeProject:L}}),t(),n()}catch(E){console.error("Failed to create todo:",E)}},[e,d,u,b,S,N,I,m,R,L,t,n]);h.useCallback(()=>{e==="edit"&&s&&d!==s.title&&d.trim()&&Z({title:d})},[e,s,d,Z]);const we=h.useCallback(()=>{e==="edit"&&s&&u!==(s.description??"")&&Z({description:u})},[e,s,u,Z]),ae=h.useCallback(E=>{g(E),e==="edit"&&Z(E?{dueDate:{value:new Date(E)}}:{dueDate:void 0})},[e,Z]),Te=h.useCallback(()=>{const E=x.trim();if(E&&!I.includes(E)){const z=[...I,E];k(z),e==="edit"&&Z({tags:z}),y("")}},[x,I,e,Z]),ke=h.useCallback(E=>{const z=I.filter(pe=>pe!==E);k(z),e==="edit"&&Z({tags:z})},[I,e,Z]),Ee=h.useCallback(async()=>{if(w.trim())if(e==="edit"&&s)try{await Ve.addSubtask(s.id,{title:w.trim()}),v(""),t()}catch(E){console.error("Failed to add subtask:",E)}else W([...P,{id:{value:`temp-${Date.now()}`},title:w.trim(),isCompleted:!1}]),v("")},[e,s,w,P,t]),$e=h.useCallback(async E=>{if(e==="edit"&&s)try{await Ve.toggleSubtask(s.id,E),t()}catch(z){console.error("Failed to toggle subtask:",z)}else W(P.map(z=>z.id.value===E.value?{...z,isCompleted:!z.isCompleted}:z))},[e,s,P,t]),ge=h.useCallback(async E=>{if(e==="edit"&&s)try{await Ve.removeSubtask(s.id,E),t()}catch(z){console.error("Failed to remove subtask:",z)}else W(P.filter(z=>z.id.value!==E.value))},[e,s,P,t]),ie=h.useCallback(async()=>{if(u.trim())try{const E=u.split(`
`),z=[];for(const pe of E){const X=pe.trim(),ve=/^-\s*\[([ x])\]\s*(.+)$/i.exec(X);if(ve){const Oe=ve[1].toLowerCase()==="x",De=ve[2].trim();De&&z.push({title:De,isCompleted:Oe});continue}const Ae=/^-\s+(.+)$/.exec(X);if(Ae){const Oe=Ae[1].trim();Oe&&z.push({title:Oe,isCompleted:!1})}}if(e==="edit"&&s){for(const pe of z){const X=await Ve.addSubtask(s.id,{title:pe.title});if(pe.isCompleted){const ce=X.subtasks[X.subtasks.length-1];ce&&await Ve.toggleSubtask(s.id,ce.id)}}t()}else{const pe=z.map((X,ce)=>({id:{value:`temp-${Date.now()}-${ce}`},title:X.title,isCompleted:X.isCompleted}));W([...P,...pe])}}catch(E){console.error("Failed to split tasks:",E)}},[e,s,u,P,t]),re=h.useCallback(E=>{j(E),e==="edit"&&Z({status:E})},[e,Z]),te=h.useCallback(E=>{C(E),e==="edit"&&Z({priority:E})},[e,Z]),$=h.useCallback(E=>{A(E),e==="edit"&&Z({category:E})},[e,Z]),V=h.useCallback(E=>{const z=Array.isArray(E)?E:[E];F(z),e==="edit"&&Z({customProps:{sessionIds:z}})},[e,Z]),ee=h.useCallback(E=>{var pe,X,ce;T(E);const z=oe.getState();oe.updateState({app:{...z.app,claude:{...(pe=z.app)==null?void 0:pe.claude,ui:{...(ce=(X=z.app)==null?void 0:X.claude)==null?void 0:ce.ui,selectedProjectPath:E}}}}),e==="edit"&&Z({customProps:{claudeProjectPath:E}})},[e,Z]),le=h.useMemo(()=>K.map(E=>({value:E.path,label:E.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[K]),ne=h.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...le],[le]);h.useCallback(E=>{p(E.target.value)},[]);const de=h.useCallback(E=>{f(E.target.value)},[]),fe=h.useCallback(E=>{E.key==="Escape"&&E.currentTarget.blur()},[]),xe=h.useCallback(E=>{y(E.target.value)},[]),Ce=h.useCallback(E=>{E.key==="Enter"&&(E.preventDefault(),Te())},[Te]),Se=h.useCallback(E=>{v(E.target.value)},[]),_=h.useCallback(E=>{E.key==="Enter"&&!E.shiftKey&&(E.preventDefault(),Ee())},[Ee]);return o.jsxs("div",{className:"details-grid grid grid-cols-4 gap-6","data-test":"todo-details-form",children:[o.jsxs("div",{className:"left-column col-span-3 space-y-6","data-test":"todo-details-left-column",children:[o.jsxs("div",{className:"form-field-description space-y-2","data-test":"todo-details-description-field",children:[o.jsx(me,{htmlFor:"description","data-test":"todo-details-description-label",children:"Description"}),o.jsx(Zt,{value:u,onChange:de,onBlur:we,onKeyDown:fe,placeholder:"Enter description...",rows:12,className:"description-textarea min-h-[100px] w-full","data-test":"todo-details-description-textarea",useMarkdown:!0}),o.jsxs("div",{className:"description-actions mt-2 flex gap-2 justify-between","data-test":"todo-details-description-actions",children:[o.jsx(se,{onClick:ie,size:"sm",variant:"outline",className:"split-tasks-button",disabled:!u.trim(),"data-test":"todo-details-split-tasks-button",children:"Split Tasks"}),e==="edit"?o.jsx(se,{onClick:we,size:"sm",variant:"outline",className:"save-description-button","data-test":"todo-details-save-description-button",children:"Save"}):o.jsx(se,{onClick:ue,size:"sm",variant:"default",className:"create-todo-button",disabled:!d.trim(),"data-test":"todo-details-create-button",children:"Create Todo"})]})]}),o.jsxs("div",{className:"form-field-subtasks space-y-2","data-test":"todo-details-subtasks-field",children:[o.jsxs("div",{className:"flex items-center justify-between",children:[o.jsx(me,{"data-test":"todo-details-subtasks-label",children:"Subtasks"}),e==="edit"&&r&&P.some(E=>!E.isCompleted)&&(c??l)&&o.jsx(se,{size:"sm",variant:a?"destructive":"outline",onClick:a?l:c,className:"process-all-button","data-test":"todo-details-process-all-button",children:a?o.jsxs(o.Fragment,{children:[o.jsx(ct,{className:"w-3 h-3 mr-1"}),"Stop"]}):"Process All"})]}),o.jsxs("div",{className:"subtasks-container space-y-2","data-test":"todo-details-subtasks-container",children:[o.jsx("div",{className:"subtasks-list space-y-2","data-test":"todo-details-subtasks-list",children:P.map(E=>o.jsxs("div",{className:"subtask-item flex items-center gap-2 p-2 rounded border","data-test":`todo-details-subtask-item-${E.id.value}`,children:[o.jsx("input",{type:"checkbox",checked:E.isCompleted,onChange:()=>$e(E.id),className:"subtask-checkbox",disabled:a,"data-test":`todo-details-subtask-checkbox-${E.id.value}`}),o.jsx("div",{className:B("subtask-title-wrapper flex-1",E.isCompleted&&"line-through text-gray-500"),children:o.jsx(Zt,{ref:z=>{q.current[E.id.value]=z},value:E.title,onChange:async z=>{const pe=z.target.value,X=U(E.id.value,pe);if(Y(ce=>({...ce,[E.id.value]:X})),e==="edit"&&s)try{await Ve.updateSubtask(s.id,E.id,{title:pe}),t()}catch(ce){console.error("Failed to update subtask title:",ce)}else W(P.map(ce=>ce.id.value===E.id.value?{...ce,title:pe}:ce))},placeholder:"Edit subtask...",className:"subtask-title-textarea resize-none w-full",rows:H[E.id.value]||1,"data-test":`todo-details-subtask-textarea-${E.id.value}`})}),i===E.id.value&&o.jsx(tr,{className:"w-4 h-4 animate-spin text-blue-500","data-test":`todo-details-subtask-loading-${E.id.value}`}),e==="edit"&&r&&o.jsx(yd,{sessionId:r,message:E.title,className:"subtask-send h-7 w-7 hover:text-blue-500",disabled:a,"data-test":`todo-details-subtask-send-${E.id.value}`}),o.jsx("button",{onClick:()=>ge(E.id),className:"subtask-remove hover:text-red-500",disabled:a,"data-test":`todo-details-subtask-remove-${E.id.value}`,children:o.jsx(ct,{className:"w-4 h-4"})})]},E.id.value))}),o.jsxs("div",{className:"subtask-input flex gap-2","data-test":"todo-details-subtask-input-container",children:[o.jsx(Zt,{ref:O,value:w,onChange:Se,onKeyDown:_,placeholder:"Add a subtask...",rows:1,className:"flex-1","data-test":"todo-details-subtask-input"}),o.jsx(se,{onClick:()=>void Ee(),size:"sm",className:"subtask-add-button","data-test":"todo-details-subtask-add-button",children:o.jsx(Ws,{className:"w-4 h-4"})})]})]})]}),e==="edit"&&R.length>0&&o.jsxs("div",{className:"form-field-sessions space-y-2","data-test":"todo-details-sessions-field",children:[o.jsxs(me,{"data-test":"todo-details-sessions-label",children:["Claude Session IDs (",R.length,")"]}),R.map((E,z)=>o.jsx(_e,{value:E,readOnly:!0,className:"session-id-input bg-gray-50 mb-1",title:`Session ${z+1}`,"data-test":`todo-details-session-input-${z}`},E))]})]}),o.jsxs("div",{className:"right-column col-span-1 space-y-4","data-test":"todo-details-right-column",children:[o.jsxs("div",{className:"form-field-selectors space-y-4","data-test":"todo-details-selectors",children:[o.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-details-status-selector",children:[o.jsx(me,{"data-test":"todo-details-status-label",children:"Status"}),o.jsx("div",{className:"flex flex-wrap gap-2",children:o.jsx(f0,{value:b,options:P0,onChange:re,placeholder:"Search status...","data-test":"todo-details-status-select"})})]}),o.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-details-priority-selector",children:[o.jsx(me,{"data-test":"todo-details-priority-label",children:"Priority"}),o.jsx("div",{className:"flex flex-wrap gap-2",children:o.jsx(_r,{value:S,options:A0,onChange:te,placeholder:"Search priorities...",contentStyle:{zIndex:Je.draggablePopoverDropdown},"data-test":"todo-details-priority-badge"})})]}),o.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-details-category-selector",children:[o.jsx(me,{"data-test":"todo-details-category-label",children:"Category"}),o.jsx("div",{className:"flex flex-wrap gap-2",children:o.jsx(y0,{value:N||"personal",onChange:$,placeholder:"Search categories...","data-test":"todo-details-category-select"})})]}),!G&&ne.length>1&&o.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-details-project-selector",children:[o.jsx(me,{"data-test":"todo-details-project-label",children:"Claude Project"}),o.jsx("div",{className:"flex flex-wrap gap-2",children:o.jsx(_r,{value:L??"__no_project__",options:ne,onChange:ee,placeholder:"Search projects...",contentStyle:{zIndex:Je.draggablePopoverDropdown},"data-test":"todo-details-project-badge"})})]}),e==="edit"&&o.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-details-session-selector",children:[o.jsx(me,{"data-test":"todo-details-session-selector-label",children:"Claude Sessions"}),o.jsx(Cd,{value:R,onChange:V,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-details-session-select"})]}),o.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-details-tags-selector",children:[o.jsx(me,{"data-test":"todo-details-tags-label",children:"Tags"}),o.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-details-tags-container",children:[o.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-details-tags-list",children:I.map(E=>o.jsxs(ot,{variant:"outline",className:"tag-badge gap-1","data-test":`todo-details-tag-${E}`,children:[E,o.jsx("button",{onClick:()=>ke(E),className:"tag-remove ml-1 hover:text-red-500","data-test":`todo-details-tag-remove-${E}`,children:o.jsx(ct,{className:"w-3 h-3"})})]},E))}),o.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-details-tag-input-container",children:[o.jsx(_e,{value:x,onChange:xe,onKeyDown:Ce,placeholder:"Add a tag...","data-test":"todo-details-tag-input"}),o.jsx(se,{onClick:Te,size:"sm",className:"tag-add-button","data-test":"todo-details-tag-add-button",children:o.jsx(Ws,{className:"w-4 h-4"})})]})]})]})]}),o.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-details-due-date-field",children:[o.jsx(me,{htmlFor:"dueDate","data-test":"todo-details-due-date-label",children:"Due Date"}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(Wu,{className:"w-4 h-4 text-gray-400"}),o.jsx(_e,{id:"dueDate",type:"date",value:m,onChange:E=>ae(E.target.value),"data-test":"todo-details-due-date-input"})]})]})]})]})}function L0({todo:s,isOpen:e,onClose:t,onUpdate:n,currentCardIndex:r,totalCardsInColumn:a,onNavigatePrevious:i,onNavigateNext:c,initialValues:l}){var Ee,$e,ge,ie,re,te;const[d,p]=h.useState("details"),[u,f]=h.useState(""),[m,g]=h.useState(!1),[x,y]=h.useState(null),[w,v]=h.useState(!1),[b,j]=h.useState(!1),[S,C]=h.useState(0),[N,A]=h.useState((s==null?void 0:s.title)??(l==null?void 0:l.title)??""),[I,k]=h.useState(!1),P=!s||s.id.value==="temp-new-todo",W=h.useMemo(()=>P?{id:{value:"temp-create"},title:(l==null?void 0:l.title)??N,description:(l==null?void 0:l.description)??"",status:ze.BACKLOG,priority:Ut.MEDIUM,category:(l==null?void 0:l.category)??"",sortOrder:0,tags:(l==null?void 0:l.tags)??[],subtasks:[],createdAt:{value:new Date},updatedAt:{value:new Date},customProps:{sessionIds:[],claudeProjectPath:l==null?void 0:l.claudeProjectPath}}:null,[P,l==null?void 0:l.title,l==null?void 0:l.description,l==null?void 0:l.category,l==null?void 0:l.tags,l==null?void 0:l.claudeProjectPath,N]),R=($e=(Ee=s==null?void 0:s.customProps)==null?void 0:Ee.sessionIds)==null?void 0:$e[S],F=h.useMemo(()=>{var $;return(($=s==null?void 0:s.customProps)==null?void 0:$.sessionIds)??[]},[(ge=s==null?void 0:s.customProps)==null?void 0:ge.sessionIds]),L=h.useMemo(()=>({loadOnMount:d==="session",subscribeToSSE:d==="session"}),[d]),{messages:T,sessionDetails:M,metadata:D,loading:H,pagination:Y,loadOlderMessages:O,refreshSession:q,addOptimisticMessage:K,removeOptimisticMessage:G}=h0(R,L);h.useLayoutEffect(()=>{var $,V,ee,le,ne,de,fe;if(e&&(($=s==null?void 0:s.customProps)!=null&&$.claudeProjectPath)){const xe=oe.getState();((le=(ee=(V=xe.app)==null?void 0:V.claude)==null?void 0:ee.ui)==null?void 0:le.selectedProjectPath)!==s.customProps.claudeProjectPath&&oe.updateState({app:{...xe.app,claude:{...(ne=xe.app)==null?void 0:ne.claude,ui:{...(fe=(de=xe.app)==null?void 0:de.claude)==null?void 0:fe.ui,selectedProjectPath:s.customProps.claudeProjectPath}}}})}},[e,(ie=s==null?void 0:s.customProps)==null?void 0:ie.claudeProjectPath]),h.useEffect(()=>{p("details"),C(0),A((s==null?void 0:s.title)??(l==null?void 0:l.title)??"")},[s==null?void 0:s.id.value,s==null?void 0:s.title,s==null?void 0:s.description,e,l==null?void 0:l.title]),h.useEffect(()=>{const $=F.length;$>0&&S>=$&&C(0)},[F.length,S]),h.useEffect(()=>{d==="session"&&R&&q()},[S,R,d,q]);const U=h.useCallback($=>{p($),$==="session"&&R&&q()},[R,q]),Z=h.useCallback(()=>{k(!0)},[]),ue=h.useCallback(async $=>{if(!s){k(!1);return}try{await jd.claude.linkSessionToTodo(s.id,$),n(),k(!1),p("session"),await q()}catch(V){console.error("Failed to handle session creation:",V),k(!1)}},[s,n,q]),we=h.useCallback(async()=>{v(!0);try{await q()}finally{v(!1)}},[q]),ae=h.useCallback(async()=>{var V,ee,le,ne,de,fe,xe,Ce,Se,_;if(!s||!R)return;const $=s.subtasks.filter(E=>!E.isCompleted);if($.length!==0){g(!0),j(!1);try{const E=s.id;for(const z of $){if(b)break;y(z.id.value),await Ke.sendMessage({message:z.title,sessionId:R,options:{outputFormat:"text",permissionMode:"acceptEdits"}});let pe=!1;for(let X=0;X<50;X++)if(await new Promise(ve=>setTimeout(ve,100)),(de=(ne=(le=(ee=(V=oe.get("app"))==null?void 0:V.claude)==null?void 0:ee.ui)==null?void 0:le.activity)==null?void 0:ne[R])==null?void 0:de.isProcessing){pe=!0;break}if(!pe)console.warn(`[ProcessAll] ${z.title} - Processing never started, continuing anyway`);else for(let X=0;X<600&&(await new Promise(ve=>setTimeout(ve,100)),!!((_=(Se=(Ce=(xe=(fe=oe.get("app"))==null?void 0:fe.claude)==null?void 0:xe.ui)==null?void 0:Ce.activity)==null?void 0:Se[R])==null?void 0:_.isProcessing));X++);await Ve.toggleSubtask(E,z.id),await new Promise(X=>setTimeout(X,500))}n()}catch(E){console.error("Failed to process all subtasks:",E)}finally{g(!1),y(null),j(!1)}}},[s,R,n,b]),Te=h.useCallback(()=>{j(!0)},[]),ke=h.useCallback(async $=>{const V=$.target.value;if(A(V),!P&&s)try{await Ve.updateTodo(s.id,{title:V}),n()}catch(ee){console.error("Failed to update todo title:",ee)}},[P,s,n]);return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"panel-header","data-test":"kanban-card-details-header",children:o.jsxs("div",{className:"header-title-row flex items-center justify-between gap-4","data-test":"kanban-card-details-title-row",children:[o.jsxs("div",{className:"header-left flex items-center gap-2 flex-1 min-w-0","data-test":"kanban-card-details-header-left",children:[!P&&o.jsx(Fa,{"data-test":"kanban-card-details-session-activity",sessionIds:F,showCount:!0,isCreating:I}),!P&&i&&o.jsx(se,{"data-test":"kanban-card-details-navigate-previous",variant:"ghost",size:"icon",onClick:i,disabled:r===0,className:"navigate-previous-card h-8 w-8 flex-shrink-0",title:"Previous card in column",children:o.jsx(Zs,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-left-icon"})}),o.jsx("div",{className:"flex-1 min-w-0","data-test":"kanban-card-details-title-wrapper",children:o.jsx(Zt,{"data-test":"kanban-card-details-title-textarea",value:N,onChange:ke,placeholder:P?"Enter todo title...":"Edit todo title",className:"todo-title-textarea text-lg font-semibold resize-none w-full",rows:1})}),!P&&c&&o.jsx(se,{"data-test":"kanban-card-details-navigate-next",variant:"ghost",size:"icon",onClick:c,disabled:r!==void 0&&a!==void 0&&r>=a-1,className:"navigate-next-card h-8 w-8 flex-shrink-0",title:"Next card in column",children:o.jsx(ds,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-right-icon"})})]}),!P&&s&&o.jsxs("div",{className:"header-actions flex items-center gap-2 flex-shrink-0","data-test":"kanban-card-details-header-actions",children:[o.jsx(Cd,{"data-test":"kanban-card-details-session-selector",value:((re=s.customProps)==null?void 0:re.sessionIds)??[],onChange:async $=>{const V=Array.isArray($)?$:[];await Ve.updateTodo(s.id,{customProps:{...s.customProps,sessionIds:V}}),n()},className:"session-selector-header",showLabel:!1,placeholder:"Link to sessions",multiSelect:!0}),o.jsx(gd,{"data-test":"kanban-card-details-create-session-button",variant:"ghost",size:"icon",className:"create-session-button-panel",initialMessage:`Working on: ${s.title}

${s.description??""}`,projectPath:(te=s.customProps)==null?void 0:te.claudeProjectPath,onCreating:Z,onSessionCreated:ue,useModal:!0})]})]})}),o.jsxs(xd,{value:d,onValueChange:U,className:"panel-tabs flex-1 flex flex-col overflow-hidden","data-test":"kanban-card-details-tabs",children:[o.jsxs(Ma,{className:B("grid w-full",P?"grid-cols-1":"grid-cols-2"),"data-test":"kanban-card-details-tabs-list",children:[o.jsx(Js,{value:"details","data-test":"kanban-card-details-tab-details",children:"Details"}),!P&&o.jsx(Js,{value:"session",disabled:!R,"data-test":"kanban-card-details-tab-session",children:"Claude Session"})]}),o.jsx(Ys,{value:"details",className:"panel-form mt-4 flex-1 overflow-y-auto data-[state=inactive]:hidden","data-test":"kanban-card-details-details-content",children:o.jsx(O0,{todo:P?W:s,mode:P?"create":"edit",onUpdate:n,onClose:t,activeSessionId:R,isProcessingAll:m,currentProcessingSubtaskId:x,onProcessAll:ae,onStopProcessing:Te})}),!P&&o.jsxs(Ys,{value:"session",className:"session-tab mt-4 flex-1 flex flex-col overflow-hidden data-[state=inactive]:hidden","data-test":"kanban-card-details-session-content",children:[null,H?o.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session",children:"Loading session..."}):R&&!M?o.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session-initial",children:o.jsxs(se,{variant:"outline",size:"sm",onClick:()=>void q(),className:"load-session-button",children:[o.jsx(En,{className:"w-4 h-4 mr-2"}),"Load Session"]})}):M?o.jsxs("div",{className:"session-chat-area flex flex-col gap-4 h-[calc(100vh-220px)]","data-test":"kanban-card-details-chat-area",children:[o.jsxs("div",{className:"session-header flex items-center justify-between","data-test":"kanban-card-details-session-header",children:[o.jsxs("div",{className:"session-header-left flex items-center gap-3","data-test":"kanban-card-details-session-header-left",children:[o.jsx("h3",{className:"session-title text-sm font-medium text-muted-foreground","data-test":"kanban-card-details-session-title",children:"Session Messages"}),F.length>1&&o.jsx(p0,{"data-test":"kanban-card-details-session-navigator",sessionIds:F,currentIndex:S,onIndexChange:C,className:"session-navigator"})]}),o.jsxs(se,{"data-test":"kanban-card-details-refresh-button",onClick:()=>void we(),size:"sm",variant:"outline",disabled:w,className:"refresh-session-button",children:[o.jsx(En,{className:B("w-4 h-4 mr-2",w&&"animate-spin"),"data-test":"kanban-card-details-refresh-icon"}),w?"Refreshing...":"Refresh"]})]}),o.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden","data-test":"kanban-card-details-chat-messages",children:o.jsx(a0,{"data-test":"kanban-card-details-chat-interface",messages:T,sessionDetails:M,metadata:D,loading:H,pagination:Y,onLoadOlder:Y&&Y.page<Y.totalPages?O:void 0})}),o.jsx("div",{className:"chat-input flex-shrink-0","data-test":"kanban-card-details-chat-input",children:o.jsx(o0,{"data-test":"kanban-card-details-message-input",sessionId:R,value:u,onChange:f,onSendSuccess:()=>{q()},onAddOptimisticMessage:K,onRemoveOptimisticMessage:G})})]}):o.jsx("div",{className:"no-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-no-session",children:"No Claude session found"})]})]})]})}function _0({isOpen:s,onClose:e,onUpdate:t,triggerPosition:n,initialValues:r}){var c,l,d;const i={claudeProjectPath:((d=(l=(c=oe.getState().app)==null?void 0:c.claude)==null?void 0:l.ui)==null?void 0:d.selectedProjectPath)??void 0,...r};return o.jsx(us,{isVisible:s,onClose:e,title:"Create New Todo",shouldCloseManually:!0,resizable:!0,initialSize:{width:900,height:600},triggerPosition:n??void 0,className:"add-ticket-popover","data-test":"add-ticket-popover",children:o.jsx("div",{"data-test":"add-ticket-popover-content",className:"popover-content flex flex-col h-full overflow-hidden p-4",children:o.jsx(L0,{todo:null,isOpen:s,onClose:e,onUpdate:t,initialValues:i})})})}function M0({onTicketCreated:s,initialValues:e,variant:t="ghost",size:n="icon",className:r="add-ticket-button",title:a="Add New Ticket","data-test":i}){const[c,l]=h.useState(!1),[d,p]=h.useState(null),u=g=>{const x=g.currentTarget.getBoundingClientRect();p({x:x.left,y:x.top}),l(!0)},f=()=>{l(!1),p(null)},m=()=>{s&&s(),f()};return o.jsxs(o.Fragment,{children:[o.jsx(se,{variant:t,size:n,onClick:u,title:a,className:r,"data-test":i||"add-ticket-button",children:o.jsx(zu,{className:"h-5 w-5","data-test":i?`${i}-icon`:"add-ticket-button-icon"})}),o.jsx(_0,{isOpen:c,onClose:f,onUpdate:m,triggerPosition:d,initialValues:e,"data-test":i?`${i}-popover`:"add-ticket-popover"})]})}function F0({version:s}){const e=aa();if(e.pathname==="/game"||e.pathname==="/new-home")return null;const t=typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port.startsWith("517");return o.jsx("header",{className:"sticky top-0 z-50 bg-black text-white shadow-md",children:o.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[o.jsx(Ki,{}),t&&o.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(Hu,{className:Qe.md}),o.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(Vt,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(Ci,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?o.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?o.jsxs(o.Fragment,{children:[o.jsx(Gu,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?o.jsxs(o.Fragment,{children:[o.jsx(qu,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?o.jsxs(o.Fragment,{children:[o.jsx(Ti,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?o.jsxs(o.Fragment,{children:[o.jsx(Vu,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):o.jsxs(o.Fragment,{children:[o.jsx(Ii,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(ca,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(Ku,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(ji,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(ki,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(Ni,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(Ei,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?o.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[o.jsx(yi,{className:Qe.md}),o.jsxs("h1",{className:"text-xl font-semibold",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):o.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[t&&o.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),o.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&o.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),o.jsx(Yh,{}),o.jsx(M0,{}),o.jsx(s0,{variant:"ghost",size:"icon",title:"Audio Recorder"}),o.jsx(gd,{variant:"ghost",size:"icon",icon:o.jsx(Li,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),o.jsx(Ah,{variant:"ghost",size:"icon"})]})]})})}function $0(){const s=document.activeElement;if(!s)return null;const e=["INPUT","TEXTAREA"].includes(s.nodeName??""),t=s.contentEditable==="true";return e||t}class U0{constructor(){Q(this,"shortcuts",new Map);Q(this,"isListening",!1);this.handleKeyDown=this.handleKeyDown.bind(this)}generateShortcutId(e){const t=[];return e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),`${t.join("+")}-${e.key.toLowerCase()}`}handleKeyDown(e){if($0())return;const t=this.generateShortcutId({key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey}),n=this.shortcuts.get(t);n&&(n.preventDefault!==!1&&e.preventDefault(),n.callback())}register(e){const t=this.generateShortcutId(e);return this.shortcuts.set(t,e),this.isListening||this.startListening(),()=>this.unregister(t)}unregister(e){this.shortcuts.delete(e),this.shortcuts.size===0&&this.stopListening()}unregisterAll(){this.shortcuts.clear(),this.stopListening()}startListening(){this.isListening||(document.addEventListener("keydown",this.handleKeyDown),this.isListening=!0)}stopListening(){this.isListening&&(document.removeEventListener("keydown",this.handleKeyDown),this.isListening=!1)}getRegisteredShortcuts(){return Array.from(this.shortcuts.values())}isShortcutRegistered(e){const t=this.generateShortcutId(e);return this.shortcuts.has(t)}}const Cs=new U0,Ho="command-palette-recently-used",B0=5;function W0({actions:s=[],placeholder:e="Type a command or search..."}){const[t,n]=h.useState(!1),[r,a]=h.useState(""),[i,c]=h.useState(()=>{try{const u=localStorage.getItem(Ho);return u?JSON.parse(u):[]}catch{return[]}});h.useEffect(()=>{const u=Cs.register({key:"q",altKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),f=Cs.register({key:"p",metaKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),m=Cs.register({key:"q",ctrlKey:!0,altKey:!0,preventDefault:!0,callback:()=>{const g=i[0];if(g){const x=s.find(y=>y.id===g);x&&x.action()}}});return()=>{u(),f(),m()}},[i,s]),h.useEffect(()=>{if(!t)return;const u=f=>{if(f.key!=="ArrowUp"&&f.key!=="ArrowDown")return;const m=Array.from(document.querySelectorAll("[cmdk-item]")).filter(w=>w.getAttribute("data-disabled")!=="true");if(m.length===0)return;const g=m.map(w=>w.getAttribute("data-value")||""),x=g.indexOf(r);let y;if(f.key==="ArrowUp"){x<=0&&(f.preventDefault(),f.stopPropagation(),y=m.length-1,a(g[y]));return}else{x>=m.length-1&&(f.preventDefault(),f.stopPropagation(),y=0,a(g[y]));return}};return document.addEventListener("keydown",u,{capture:!0}),()=>document.removeEventListener("keydown",u,{capture:!0})},[t,r]);const l=s.reduce((u,f)=>{const m=f.group??"General";return u[m]||(u[m]=[]),u[m].push(f),u},{}),d=u=>{n(!1),u.action(),c(f=>{const m=f.filter(x=>x!==u.id),g=[u.id,...m].slice(0,B0);try{localStorage.setItem(Ho,JSON.stringify(g))}catch{}return g})},p=i.map(u=>s.find(f=>f.id===u)).filter(u=>u!==void 0);return o.jsxs(ic,{open:t,onOpenChange:n,value:r,onValueChange:a,"data-test":"command-palette-dialog",children:[o.jsx(nr,{"data-test":"command-palette-input",placeholder:e}),o.jsxs(tn,{"data-test":"command-palette-list",children:[o.jsx(sn,{"data-test":"command-palette-empty",children:"No results found."}),p.length>0&&o.jsxs(o.Fragment,{children:[o.jsx(js,{heading:"Recently Used","data-test":"command-group-recent",children:p.map(u=>o.jsxs(es,{value:`recent-${u.id}`,onSelect:()=>d(u),className:"command-item flex justify-between items-center","data-test":`command-item-recent-${u.id}`,children:[o.jsx("span",{"data-test":`command-item-recent-${u.id}-label`,children:u.label}),u.shortcut&&o.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":`command-item-recent-${u.id}-shortcut`,children:u.shortcut})]},`recent-${u.id}`))}),o.jsx(Mr,{"data-test":"command-separator-recent"})]}),Object.entries(l).map(([u,f],m)=>o.jsxs("div",{"data-test":`command-group-container-${u.toLowerCase().replace(/\s+/g,"-")}`,children:[m>0&&o.jsx(Mr,{"data-test":`command-separator-${u.toLowerCase().replace(/\s+/g,"-")}`}),o.jsx(js,{heading:u,"data-test":`command-group-${u.toLowerCase().replace(/\s+/g,"-")}`,children:f.map(g=>o.jsxs(es,{value:g.id,onSelect:()=>d(g),className:"command-item flex justify-between items-center","data-test":`command-item-${g.id}`,children:[o.jsx("span",{"data-test":`command-item-${g.id}-label`,children:g.label}),g.shortcut&&o.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":`command-item-${g.id}-shortcut`,children:g.shortcut})]},g.id))})]},u))]})]})}const z0=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),H0=s=>(e,t)=>{if(!t)return 1;let n=t,r=e;if(s.matchCase||(n=n.toLowerCase(),r=r.toLowerCase()),s.matchWholeWord)return new RegExp(`\\b${z0(n)}\\b`,s.matchCase?"":"i").test(e)?1:0;const a=r.includes(n);if(s.mode==="fuzzy"){if(a)return 2;let i=0;for(let c=0;c<r.length&&i<n.length;c++)r[c]===n[i]&&i++;return i===n.length?1:0}else return a?1:0},G0={matchCase:!1,matchWholeWord:!1,mode:"fuzzy"};function q0({placeholder:s="Search...",initialOptions:e,onSearchOptionsChange:t,onSearchChange:n,onNavigate:r,className:a}){const[i,c]=h.useState(e??G0),l=h.useCallback(f=>{c(f),t==null||t(f)},[t]),d=()=>{const f={...i,matchCase:!i.matchCase};l(f)},p=()=>{const f={...i,matchWholeWord:!i.matchWholeWord};l(f)},u=()=>{const f={...i,mode:i.mode==="fuzzy"?"exact":"fuzzy"};l(f)};return o.jsxs("div",{className:B("flex items-center border-b px-3 pr-12",a),"cmdk-input-wrapper":"","data-test":"search-input-with-options",children:[o.jsx(er,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),o.jsx(dt.Input,{"data-test":"search-input",placeholder:s,onValueChange:n,className:"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"}),o.jsxs("div",{className:"flex items-center gap-0.5 shrink-0","data-test":"search-options",children:[o.jsx("button",{type:"button",onClick:d,className:B("p-1.5 rounded hover:bg-accent transition-colors",i.matchCase&&"bg-accent text-accent-foreground"),title:"Match Case (Aa)","data-test":"search-match-case-button",children:o.jsx(Ju,{className:"h-4 w-4"})}),o.jsx("button",{type:"button",onClick:p,className:B("p-1.5 rounded hover:bg-accent transition-colors",i.matchWholeWord&&"bg-accent text-accent-foreground"),title:"Match Whole Word","data-test":"search-match-whole-word-button",children:o.jsx(Yu,{className:"h-4 w-4"})}),o.jsx("button",{type:"button",onClick:u,className:B("p-1.5 rounded hover:bg-accent transition-colors text-xs font-mono",i.mode==="exact"&&"bg-accent text-accent-foreground"),title:i.mode==="fuzzy"?"Fuzzy Search (click for Exact)":"Exact Search (click for Fuzzy)","data-test":"search-mode-button",children:i.mode==="fuzzy"?"Fz":"Ex"}),o.jsx("div",{className:"w-px h-4 bg-border mx-1","data-test":"search-separator"}),o.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("up"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Previous Result (â†‘)","data-test":"search-navigate-up-button",children:o.jsx(Zn,{className:"h-4 w-4"})}),o.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("down"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Next Result (â†“)","data-test":"search-navigate-down-button",children:o.jsx(ms,{className:"h-4 w-4"})})]})]})}function V0(s,e){return{navigateResults:h.useCallback(n=>{const r=Array.from(document.querySelectorAll("[cmdk-item]")).filter(l=>l.getAttribute("data-disabled")!=="true");if(r.length===0)return;const a=r.map(l=>l.getAttribute("data-value")||""),i=a.indexOf(s);let c;n==="up"?c=i<=0?r.length-1:i-1:c=i>=r.length-1?0:i+1,e(a[c])},[s,e])}}function K0({placeholder:s="Go to node by title or content..."}){const[e,t]=h.useState(!1),[n,r]=h.useState(""),[a,i]=h.useState(""),c=Tt.getState().getGoToSymbolSearch(),[l,d]=h.useState((c==null?void 0:c.options)??{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}),p=h.useCallback(y=>{d(y),Tt.getState().setGoToSymbolSearchOptions(y)},[]),u=h.useMemo(()=>H0(l),[l]),{navigateResults:f}=V0(n,r),m=h.useMemo(()=>{var v;if(!e)return[];const y=Tt.getState();if(!((v=y.state)!=null&&v.projects))return[];const w=[];return Object.values(y.state.projects).forEach(b=>{Object.values(b.workspaces).forEach(j=>{Object.values(j.canvases).forEach(S=>{(S.coreState.nodes||[]).forEach(N=>{var W;const A=(W=N.data)==null?void 0:W.nodeType;if(A==="workflowOrchestration"||A==="workflowSource")return;const I=N.title||"",k=typeof N.content=="string"?N.content:"",P=k.length>80?k.substring(0,80)+"...":k;!I&&!k||w.push({id:`${S.id}:${N.id}`,nodeId:N.id,canvasId:S.id,title:I||P.substring(0,40)||N.id,contentPreview:P,path:`${b.name} / ${j.name} / ${S.name}`,node:N})})})})}),w},[e]),g=h.useMemo(()=>{const y={};return m.forEach(w=>{y[w.path]||(y[w.path]=[]),y[w.path].push(w)}),y},[m]),x=h.useCallback(y=>{a.trim()&&Tt.getState().addGoToSymbolSearchHistory(a.trim()),t(!1),i("");const w=Tt.getState();w.projectCanvas.switch(y.canvasId),setTimeout(()=>{w.scrollToNode(y.nodeId,500),w.setSelectedNodes([y.node])},50)},[a]);return h.useEffect(()=>{const y=Cs.register({key:"o",ctrlKey:!0,preventDefault:!0,callback:()=>t(v=>!v)}),w=Cs.register({key:"o",metaKey:!0,preventDefault:!0,callback:()=>t(v=>!v)});return()=>{y(),w()}},[]),h.useEffect(()=>{if(!e)return;const y=w=>{if(w.key!=="ArrowUp"&&w.key!=="ArrowDown")return;const v=Array.from(document.querySelectorAll("[cmdk-item]")).filter(S=>S.getAttribute("data-disabled")!=="true");if(v.length===0)return;const b=v.map(S=>S.getAttribute("data-value")||""),j=b.indexOf(n);if(w.key==="ArrowUp"){j<=0&&(w.preventDefault(),w.stopPropagation(),r(b[v.length-1]));return}else{j>=v.length-1&&(w.preventDefault(),w.stopPropagation(),r(b[0]));return}};return document.addEventListener("keydown",y,{capture:!0}),()=>document.removeEventListener("keydown",y,{capture:!0})},[e,n]),o.jsxs(ic,{open:e,onOpenChange:t,value:n,onValueChange:r,filter:u,"data-test":"go-to-symbol-dialog",children:[o.jsx(q0,{placeholder:s,initialOptions:l,onSearchOptionsChange:p,onSearchChange:i,onNavigate:f}),o.jsxs(tn,{"data-test":"go-to-symbol-list",children:[o.jsx(sn,{"data-test":"go-to-symbol-empty",children:"No nodes found."}),Object.entries(g).map(([y,w])=>o.jsx(js,{heading:y,"data-test":`go-to-symbol-group-${y.replace(/\s+\/\s+/g,"-").toLowerCase()}`,children:w.map(v=>o.jsxs(es,{value:`${v.title} ${v.contentPreview} ${v.path}`,onSelect:()=>x(v),className:"flex flex-col items-start gap-0.5","data-test":`go-to-symbol-item-${v.nodeId}`,children:[o.jsx("span",{className:"font-medium text-sm","data-test":`go-to-symbol-item-${v.nodeId}-title`,children:v.title}),v.contentPreview&&v.title!==v.contentPreview.substring(0,40)&&o.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-full","data-test":`go-to-symbol-item-${v.nodeId}-preview`,children:v.contentPreview})]},v.id))},y))]})]})}function J0(s){const e=s.split(/[/\\]/),t=e.pop()||"",n=/:(\d+)(?::\d+)?$/.exec(t);let r="",a=t;return n&&(r=n[1],a=t.slice(0,n.index)),{dir:e.join("/"),filename:a,line:r}}function ra(s){return J0(s).filename}function Y0(s,e,t=300,n=15,r=10,a=200){let i=s+n,c=e+n;return i+t>window.innerWidth&&(i=window.innerWidth-t-r),c+a>window.innerHeight&&(c=window.innerHeight-a-r),i<r&&(i=r),c<r&&(c=r),{left:i,top:c}}function X0({onElementClicked:s,onElementHovered:e,onInspectorActivated:t,onInspectorDeactivated:n,shouldInspectElement:r,renderTooltip:a,excludeClassNames:i=[],tooltipOwnerId:c,clickOwnerId:l=null}){const[d,p]=h.useState(!1),[u,f]=h.useState(null),m=h.useRef(null),g=h.useRef(s),x=h.useRef(e),y=h.useRef(t),w=h.useRef(n),v=h.useRef(r),b=h.useRef(null),j=h.useRef(null),S=h.useRef(null);h.useEffect(()=>{g.current=s,x.current=e,y.current=t,w.current=n,v.current=r}),h.useEffect(()=>{if(c)return ut.claimTooltip(c),()=>{ut.releaseTooltip(c)}},[c]);const C=h.useMemo(()=>["inspector-tooltip","collected-elements-popover",...i],[i]),N=h.useRef({}),A=h.useCallback((T,...M)=>{const D=Date.now();(!N.current[T]||D-N.current[T]>500)&&(N.current[T]=D,console.log(...M))},[]),I=h.useCallback((T,M="hover")=>{for(const q of C)if(T.closest(`.${q}`))return A("class-"+q,`[Inspector:${M}] Excluding by class:`,q,T),!0;const D=["word-extractor-app","word-extractor-app-body","word-extractor-mount","watcher-context-menu"];if(T.id&&D.includes(T.id))return A("id-"+T.id,`[Inspector:${M}] Excluding by ID:`,T.id,T),!0;if(T.closest("#word-extractor-app"))return A("closest-app",`[Inspector:${M}] Excluding by closest #word-extractor-app`,T),!0;const H=T.getRootNode();if(H instanceof ShadowRoot){const q=H.host;if(q&&D.includes(q.id))return A("shadow-host",`[Inspector:${M}] Excluding by shadow DOM host:`,q.id),!0}const Y=["custom-capture-controller","custom-capture-content","content-capture-controller","capture-mode-select","custom-selector","field-dialog","array-dialog","draggable-popover-container","draggable-popover-wrapper","schema-panel","preview-panel","watcher-extension-app"];let O=T;for(;O;){const q=O.getAttribute("data-test");if(q){for(const K of Y)if(q===K||q.startsWith(K))return!0}O=O.parentElement}return!!(v.current&&!v.current(T))},[C,A]),k=h.useCallback(T=>{var U;const D=T.composedPath()[0]||T.target;if(D.closest("[data-radix-select-content]")||D.closest("[data-radix-popper-content-wrapper]")||D.closest("[role='option']")||I(D))return;const H=m.current===D;m.current&&!H&&(m.current.style.outline="",m.current.style.outlineOffset=""),D.style.outline="2px solid #06b6d4",D.style.outlineOffset="2px",m.current=D;const Y=D.tagName.toLowerCase(),O=Array.from(D.classList),q=D.getAttribute("data-test")||void 0,K=D.getAttribute("data-react-inspector")||void 0,G={tagName:Y,classes:O,dataTest:q,reactInspectorId:K,resolvedPath:void 0,x:T.clientX,y:T.clientY};H?f(Z=>Z?{...Z,x:T.clientX,y:T.clientY}:G):(f(G),(U=x.current)==null||U.call(x,D,G))},[I]),P=h.useCallback(T=>{var G;const D=T.composedPath()[0]||T.target;if(D.closest("[data-radix-select-content]")||D.closest("[data-radix-popper-content-wrapper]")||D.closest("[role='option']")||I(D,"click")||!ut.canHandleClicks(l))return;T.preventDefault(),T.stopPropagation();const H=D.tagName.toLowerCase(),Y=Array.from(D.classList),O=D.getAttribute("data-test")||void 0,q=D.getAttribute("data-react-inspector")||void 0,K={tagName:H,classes:Y,dataTest:O,reactInspectorId:q,resolvedPath:void 0,x:T.clientX,y:T.clientY};(G=g.current)==null||G.call(g,D,K)},[I,l]),W=h.useCallback(T=>{T.key==="Escape"&&d&&ut.deactivate()},[d]);h.useEffect(()=>(p(ut.getState()),ut.subscribe(M=>{var D,H;p(M),M?(D=y.current)==null||D.call(y):(H=w.current)==null||H.call(w)})),[]),h.useEffect(()=>{var T;return d?(b.current=k,j.current=P,S.current=W,document.body.style.setProperty("cursor","crosshair","important"),document.addEventListener("mousemove",k),document.addEventListener("click",P,!0),document.addEventListener("keydown",W)):(document.body.style.removeProperty("cursor"),b.current&&document.removeEventListener("mousemove",b.current),j.current&&document.removeEventListener("click",j.current,!0),S.current&&document.removeEventListener("keydown",S.current),f(null),(T=x.current)==null||T.call(x,null,null),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)),()=>{document.body.style.removeProperty("cursor"),b.current&&document.removeEventListener("mousemove",b.current),j.current&&document.removeEventListener("click",j.current,!0),S.current&&document.removeEventListener("keydown",S.current),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)}},[d]);const R=u?Y0(u.x,u.y):{left:0,top:0},F=u&&o.jsx("div",{className:"inspector-tooltip fixed z-[9999] bg-black text-white p-3 rounded-lg shadow-xl text-xs font-mono pointer-events-none",style:{left:`${R.left}px`,top:`${R.top}px`,width:"300px"},"data-test":"element-inspector-tooltip",children:o.jsxs("div",{className:"metadata-section space-y-2","data-test":"element-inspector-metadata-section",children:[o.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-tag-row",children:[o.jsx(_i,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-400"}),o.jsxs("div",{children:[o.jsx("div",{className:"text-gray-400 text-[10px]",children:"Tag"}),o.jsxs("div",{className:"text-blue-300","data-test":"element-inspector-tag-value",children:["<",u.tagName,">"]})]})]}),u.dataTest&&o.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-data-test-row",children:[o.jsx(zs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),o.jsxs("div",{children:[o.jsx("div",{className:"text-gray-400 text-[10px]",children:"Data Test"}),o.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-data-test-value",children:u.dataTest})]})]}),!u.dataTest&&u.classes.length>0&&o.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-classes-row",children:[o.jsx(zs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),o.jsxs("div",{children:[o.jsxs("div",{className:"text-gray-400 text-[10px]",children:["Classes (",u.classes.length,")"]}),o.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-classes-value",children:u.classes.join(" ")})]})]}),u.reactInspectorId&&o.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-file-row",children:[o.jsx(In,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-400"}),o.jsxs("div",{children:[o.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Name"}),o.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-name",children:ra(u.resolvedPath||u.reactInspectorId)}),o.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Path"}),o.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-path",children:u.resolvedPath||u.reactInspectorId||"Resolving..."})]})]}),!u.reactInspectorId&&o.jsxs("div",{className:"metadata-row flex items-start gap-2",children:[o.jsx(In,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-gray-600"}),o.jsx("div",{children:o.jsx("div",{className:"text-gray-500 text-[10px] italic",children:"No data-react-inspector attribute"})})]})]})}),L=ut.canRenderTooltip(c??null);return o.jsx(o.Fragment,{children:d&&u&&L&&(a?a(u):F)})}async function Q0(s){if(!s)return;const n=s.split(":")[0].split("/").pop();if(n)try{return await Xr.getFilePath(n)}catch(r){console.error("Failed to resolve inspector path:",r);return}}function Z0({onElementCollected:s,onElementRemoved:e,onElementsCleared:t,renderCollectedItem:n,renderCollectedPanel:r,showDefaultPanel:a=!0,tooltipOwnerId:i,panelOwnerId:c}){const[l,d]=h.useState([]),[p,u]=h.useState(!1),[f,m]=h.useState({x:100,y:100}),g=h.useRef(!1),x=h.useRef({x:0,y:0});h.useEffect(()=>{if(c)return ut.claimPanel(c),()=>{ut.releasePanel(c)}},[c]);const y=h.useCallback((F,L)=>{(async()=>{const M=await Q0(L.reactInspectorId)||L.reactInspectorId,D={id:`${Date.now()}-${Math.random()}`,tagName:L.tagName,classes:L.classes,dataTest:L.dataTest,reactInspectorId:L.reactInspectorId,resolvedPath:M,timestamp:Date.now()};d(H=>[...H,D]),s==null||s(D,F),be.success("Element collected!",{description:`<${L.tagName}>${M?` [${M}]`:""}`,duration:2e3})})()},[s]),w=h.useCallback(()=>{(l.length>0||p)&&u(!0)},[l.length,p]),v=F=>{F.target.closest(".popover-drag-handle")&&(g.current=!0,x.current={x:F.clientX-f.x,y:F.clientY-f.y})},b=h.useCallback(F=>{g.current&&m({x:F.clientX-x.current.x,y:F.clientY-x.current.y})},[]),j=h.useCallback(()=>{g.current=!1},[]);h.useEffect(()=>(p&&(document.addEventListener("mousemove",b),document.addEventListener("mouseup",j)),()=>{document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",j)}),[p,b,j]),h.useEffect(()=>{const F=L=>{L.key==="Escape"&&p&&u(!1)};return p&&document.addEventListener("keydown",F),()=>{document.removeEventListener("keydown",F)}},[p]);const S=F=>{d(L=>L.filter(T=>T.id!==F.id)),e==null||e(F),be.info("Element removed from collection")},C=()=>{d([]),u(!1),t==null||t(),be.info("All collected elements cleared")},N=()=>{u(!1),d([]),t==null||t()},A=()=>l.map((F,L)=>{const T=F.dataTest?`[data-test="${F.dataTest}"]`:F.classes.length>0?`.${F.classes[0]}`:"",M=F.resolvedPath||"unknown";return`${L+1}. ${F.tagName}${T} inside @${M}`}).join(`
`),I=(F,L)=>o.jsxs("div",{className:"collected-element p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors","data-test":`element-inspector-collected-item-${L}`,children:[o.jsxs("div",{className:"element-header flex items-center justify-between mb-2","data-test":`element-inspector-collected-item-${L}-header`,children:[o.jsxs("div",{className:"element-index text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded","data-test":`element-inspector-collected-item-${L}-index`,children:["#",L+1]}),o.jsx("button",{onClick:()=>S(F),className:"remove-btn p-1 hover:bg-red-100 rounded transition-colors",title:"Remove element","data-test":`element-inspector-collected-item-${L}-remove-button`,children:o.jsx(At,{className:"w-4 h-4 text-red-600"})})]}),o.jsxs("div",{className:"element-details space-y-1 text-xs",children:[o.jsxs("div",{className:"detail-row flex items-start gap-2",children:[o.jsx(_i,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-600"}),o.jsxs("div",{children:[o.jsx("span",{className:"text-gray-500",children:"Tag:"})," ",o.jsxs("span",{className:"font-mono text-blue-700",children:["<",F.tagName,">"]})]})]}),F.resolvedPath&&o.jsxs("div",{className:"detail-row flex items-start gap-2",children:[o.jsx(In,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-600"}),o.jsxs("div",{children:[o.jsxs("div",{children:[o.jsx("span",{className:"text-gray-500",children:"File Name:"})," ",o.jsx("span",{className:"font-mono text-purple-700",children:ra(F.resolvedPath)}),o.jsx(Fs,{textToCopy:ra(F.resolvedPath),size:"sm"})]}),o.jsxs("div",{children:[o.jsx("span",{className:"text-gray-500",children:"File Path:"})," ",o.jsx("span",{className:"font-mono text-purple-700",children:F.resolvedPath}),o.jsx(Fs,{textToCopy:F.resolvedPath,size:"sm"})]})]})]}),F.dataTest&&o.jsxs("div",{className:"detail-row flex items-start gap-2",children:[o.jsx(zs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),o.jsxs("div",{className:"flex-1",children:[o.jsx("span",{className:"text-gray-500",children:"Data Test:"})," ",o.jsx("span",{className:"font-mono text-green-700",children:F.dataTest}),o.jsx(Fs,{textToCopy:F.dataTest,size:"sm"})]})]}),!F.dataTest&&F.classes.length>0&&o.jsxs("div",{className:"detail-row flex items-start gap-2",children:[o.jsx(zs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),o.jsxs("div",{className:"flex-1",children:[o.jsxs("span",{className:"text-gray-500",children:["Classes (",F.classes.length,"):"]}),o.jsx("div",{className:"font-mono text-green-700 text-[10px] break-all mt-1",children:F.classes.join(" ")})]})]}),o.jsx("div",{className:"timestamp text-[10px] text-gray-400 mt-2",children:new Date(F.timestamp).toLocaleTimeString()})]})]},F.id),k=o.jsxs("div",{className:"collected-elements-popover fixed z-[9999] bg-white border-2 border-purple-400 rounded-lg shadow-2xl",style:{left:`${f.x}px`,top:`${f.y}px`,width:"550px",maxHeight:"500px"},onMouseDown:v,"data-test":"element-inspector-collected-popover",children:[o.jsxs("div",{className:"popover-drag-handle popover-header bg-purple-500 text-white p-3 rounded-t-lg cursor-move flex items-center justify-between","data-test":"element-inspector-collected-header",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(Xu,{className:"w-5 h-5"}),o.jsxs("h3",{className:"font-semibold","data-test":"element-inspector-collected-title",children:["Collected Elements (",l.length,")"]})]}),o.jsxs("div",{className:"flex items-center gap-2","data-test":"element-inspector-collected-actions",children:[o.jsx(Fs,{textToCopy:A()}),o.jsx("button",{onClick:N,className:"hover:bg-purple-600 rounded p-1 transition-colors",title:"Close","data-test":"element-inspector-collected-close-button",children:o.jsx(ct,{className:"w-5 h-5"})})]})]}),o.jsxs(xd,{defaultValue:"list",className:"popover-tabs px-3","data-test":"element-inspector-collected-tabs",children:[o.jsxs(Ma,{className:"tabs-list grid w-full grid-cols-2 mt-3","data-test":"element-inspector-collected-tabs-list",children:[o.jsx(Js,{value:"list","data-test":"element-inspector-collected-list-tab",children:"List View"}),o.jsx(Js,{value:"text","data-test":"element-inspector-collected-text-tab",children:"Text View"})]}),o.jsxs(Ys,{value:"list",className:"tabs-content m-0","data-test":"element-inspector-collected-list-content",children:[o.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4 space-y-2","data-test":"element-inspector-collected-list",children:l.map((F,L)=>n?n(F,L,()=>I(F,L)):I(F,L))}),o.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-list-footer",children:o.jsxs(se,{onClick:C,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-clear-all-button",children:[o.jsx(At,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]}),o.jsxs(Ys,{value:"text",className:"tabs-content m-0","data-test":"element-inspector-collected-text-content",children:[o.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4","data-test":"element-inspector-collected-text",children:o.jsx("pre",{className:"text-xs font-mono text-gray-800 whitespace-pre-wrap break-words bg-gray-50 p-3 rounded border border-gray-200","data-test":"element-inspector-collected-text-formatted",children:A()})}),o.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-text-footer",children:o.jsxs(se,{onClick:C,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-text-clear-all-button",children:[o.jsx(At,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]})]})]}),P=ut.canRenderPanel(c??null),W=a&&p&&l.length>0&&P,R=r?r(l,k):k;return o.jsxs(o.Fragment,{children:[o.jsx(X0,{tooltipOwnerId:i,onElementClicked:y,onInspectorDeactivated:w}),W&&R]})}const eC=({...s})=>{const{theme:e="system"}=Od();return o.jsx(Ld,{theme:e,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"!text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...s})};function tC({navigate:s}){return[{id:"nav-home",label:"Go to Home",shortcut:"Ctrl+H",action:()=>s("/"),group:"Navigation"},{id:"nav-chat",label:"Go to Chat",action:()=>s("/chat"),group:"Navigation"},{id:"nav-demo",label:"Go to Demo",action:()=>s("/demo"),group:"Navigation"},{id:"nav-settings",label:"Go to Settings",action:()=>s("/settings"),group:"Navigation"},{id:"nav-todo",label:"Go to Todo",action:()=>s("/todo"),group:"Navigation"},{id:"nav-kanban",label:"Go to Kanban Board",action:()=>s("/todo/kanban"),group:"Navigation"},{id:"nav-content",label:"Go to Content",action:()=>s("/content"),group:"Navigation"},{id:"nav-vocabulary",label:"Go to Vocabulary",action:()=>s("/vocabulary"),group:"Navigation"},{id:"nav-live-transcription",label:"Go to Live Transcription",action:()=>s("/live-transcription"),group:"Navigation"},{id:"nav-claude",label:"Go to Claude",action:()=>s("/claude"),group:"Navigation"},{id:"nav-state",label:"Go to Global State",action:()=>s("/state"),group:"Navigation"},{id:"toggle-element-inspector",label:"Toggle Element Inspector",shortcut:"Ctrl+Shift+I",action:()=>{ut.toggle();const e=ut.getState();be.success(`Element Inspector ${e?"activated":"deactivated"}`,{description:e?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})},group:"Tools"},{id:"toggle-fullscreen",label:"Toggle Fullscreen",shortcut:"F11",action:()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{be.success("Fullscreen mode deactivated",{duration:2e3})}).catch(e=>{be.error("Failed to exit fullscreen",{description:e.message,duration:3e3})}):document.documentElement.requestFullscreen().then(()=>{be.success("Fullscreen mode activated",{description:"Press F11 or ESC to exit fullscreen",duration:2e3})}).catch(e=>{be.error("Failed to enter fullscreen",{description:e.message,duration:3e3})})},group:"Tools"}]}function sC(){const{logs:s,actions:e}=Mi(),t=aa(),n=Go(),[r,a]=h.useState(null);lp({loadOnMount:!0,subscribeToSSE:!1}),fp({loadOnMount:!0}),mp(),h.useEffect(()=>{localStorage.getItem("VITE_CLEAR_LOGS_ON_RELOAD"),Fe.clientLogsService.clearLogs(),Fe.clientLogsApiClient.clearLogsAndAddVersion("vim-debug.log",2),Fe.clientLogsApiClient.clearLogsAndAddVersion("backspace-debug.log",33),Fe.clientLogsApiClient.clearLogsAndAddVersion("text-select-debug.log",13)},[t.pathname]);const i=tC({navigate:n});return h.useEffect(()=>{(async()=>{})()},[]),h.useEffect(()=>{const c=Cs.register({key:"c",callback:()=>{console.clear(),be.success("Console cleared",{duration:1500})}});return()=>c()},[]),h.useEffect(()=>{document.title=ih(t.pathname)},[t.pathname]),o.jsxs(qi,{defaultOpen:!1,children:[o.jsx(W0,{actions:i}),o.jsx(K0,{}),o.jsx(Z0,{}),o.jsx(eC,{}),o.jsx(uh,{}),o.jsx(Ji,{className:"h-screen overflow-hidden",children:o.jsxs("div",{className:"h-full bg-background flex flex-col",children:[t.pathname!=="/stt"&&o.jsx(F0,{version:r}),o.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:o.jsx(ch,{logger:e,logs:s})})]})})]})}Ad.createRoot(document.getElementById("root")).render(o.jsx(hh,{defaultTheme:"light",storageKey:"watcher-ui-theme",children:o.jsx(Pd,{children:o.jsx(sC,{})})}));export{Ms as $,tm as A,ot as B,nn as C,wa as D,Ya as E,Mt as F,Qe as G,B as H,_e as I,Wb as J,Hb as K,me as L,$C as M,UC as N,Ja as O,qi as P,Vi as Q,Yi as R,Ct as S,xd as T,Xi as U,lt as V,Rp as W,Dp as X,Lp as Y,Qi as Z,_s as _,se as a,wp as a$,Ji as a0,Ki as a1,us as a2,vf as a3,wf as a4,mc as a5,gc as a6,Ft as a7,ga as a8,$i as a9,Ob as aA,Ze as aB,Ks as aC,Rr as aD,mC as aE,Xr as aF,JC as aG,Ky as aH,fc as aI,He as aJ,Pe as aK,bC as aL,rt as aM,lg as aN,dg as aO,Un as aP,c0 as aQ,ZS as aR,Xt as aS,Qt as aT,Kt as aU,Vy as aV,Sd as aW,gd as aX,pl as aY,Sp as aZ,lC as a_,On as aa,lo as ab,bc as ac,wc as ad,rr as ae,fd as af,ta as ag,ze as ah,Ut as ai,Gn as aj,h0 as ak,a0 as al,o0 as am,Po as an,je as ao,Le as ap,Je as aq,Ye as ar,at as as,Ge as at,ma as au,cc as av,ut as aw,X0 as ax,Z0 as ay,Y0 as az,xa as b,ng as b$,Bi as b0,Cs as b1,Va as b2,Yt as b3,rj as b4,AC as b5,jo as b6,Co as b7,Tt as b8,lr as b9,Th as bA,jd as bB,_r as bC,y0 as bD,L0 as bE,zt as bF,Gt as bG,w0 as bH,An as bI,hC as bJ,Pn as bK,Rn as bL,Hs as bM,tc as bN,Nh as bO,na as bP,$s as bQ,Nn as bR,nj as bS,Ef as bT,ul as bU,nt as bV,T0 as bW,hx as bX,$0 as bY,Kn as bZ,jr as b_,M0 as ba,s0 as bb,mh as bc,Sf as bd,Fe as be,qC as bf,zC as bg,HC as bh,GC as bi,My as bj,BC as bk,WC as bl,zy as bm,VC as bn,KC as bo,YC as bp,XC as bq,QC as br,ZC as bs,ej as bt,tj as bu,sr as bv,tn as bw,sn as bx,js as by,es as bz,va as c,uC as c$,bn as c0,cl as c1,fv as c2,ya as c3,Fm as c4,nv as c5,Bc as c6,rs as c7,ag as c8,cg as c9,Nf as cA,vC as cB,wC as cC,PC as cD,RC as cE,CC as cF,fh as cG,SC as cH,jC as cI,yC as cJ,EC as cK,FC as cL,LC as cM,MC as cN,Da as cO,_C as cP,Pv as cQ,H0 as cR,V0 as cS,ic as cT,q0 as cU,Mr as cV,NC as cW,pC as cX,Wi as cY,zi as cZ,dC as c_,Sn as ca,Cn as cb,fs as cc,So as cd,is as ce,gp as cf,TC as cg,DC as ch,kC as ci,kw as cj,am as ck,fn as cl,gC as cm,xC as cn,sm as co,f0 as cp,Cd as cq,Ec as cr,Cb as cs,IC as ct,kc as cu,J as cv,fC as cw,bf as cx,yf as cy,jf as cz,gf as d,OC as d0,sj as d1,rn as e,ft as f,en as g,mt as h,Rt as i,gt as j,Ne as k,kt as l,Ma as m,Js as n,Ys as o,Nc as p,Fa as q,Ke as r,oe as s,Ve as t,lp as u,gr as v,Re as w,Zt as x,ll as y,Ka as z};
