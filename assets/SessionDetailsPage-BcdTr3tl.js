import{r as s,j as t,u as Ne,d as Pe}from"./react-vendor-Byz07MLO.js";import{t as re}from"./utils-CsrmMPoT.js";import{S as Fe}from"./SessionSidebar-DZrJ4Dp-.js";import{ac as Ie,L as B,I as Ee,T as Re,aj as Le,av as Te,V as Oe,a as ie,r as Ae,u as $e,y as ce,w as le,s as ze,M as De}from"./index-DPqC4dt9.js";import{M as Be,G as Xe}from"./icons-Ce2OFwrV.js";import{u as He}from"./useSessionKeyboardNavigation-lTEDYtsm.js";import"./radix-ui-CdiC0DQF.js";import"./tree-DcQ_KECY.js";import"./ui-utils-BxIQ3qGg.js";function We({isVisible:r,onClose:x,sessionId:I,sessionName:i,messages:j,onFork:X,isSubmitting:l=!1,triggerPosition:H,onMessageSelect:C}){const[E,k]=s.useState(""),[R,L]=s.useState(""),[N,T]=s.useState(null),[P,O]=s.useState(!0),m=s.useMemo(()=>j.filter(n=>n.role==="user"),[j]),W=s.useMemo(()=>m.length===0?null:m[m.length-1].id,[m]),v=N??W,S=n=>{if(n.preventDefault(),!v)return;let a=v;if(P){const b=j.findIndex($=>$.id===v);b>0&&(a=j[b-1].id)}const h={forkPointEntryUuid:a,customName:E.trim()||void 0,description:R.trim()||void 0};X(h)},Y=()=>{k(""),L(""),T(null),O(!0)},A=()=>{Y(),x()},_=n=>{if(typeof n.content=="string")return n.content.slice(0,100);if(Array.isArray(n.content))for(const a of n.content){if(typeof a=="string")return a.slice(0,100);if(typeof a=="object"&&a!==null){if(a.type==="text"&&"text"in a)return a.text.slice(0,100);if(a.type==="tool_result"&&"content"in a){const h=a.content;if(typeof h=="string")return h.slice(0,100)}}}if(typeof n.content=="object"&&n.content!==null){if("text"in n.content)return n.content.text.slice(0,100);if("content"in n.content&&typeof n.content.content=="string")return n.content.content.slice(0,100)}return"Message content"},f=t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx(Xe,{size:14}),"Fork Session"]});return t.jsx(Ie,{isVisible:r,onClose:A,title:f,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,initialPosition:H??"center",initialSize:{width:400,height:500},resizable:!0,children:t.jsxs("form",{"data-test":"fork-session-form",onSubmit:S,className:"fork-session-form flex flex-col h-full",children:[t.jsxs("div",{"data-test":"fork-session-content",className:"fork-session-content p-4 flex-1 min-h-0 flex flex-col gap-4 overflow-auto",children:[t.jsxs("div",{"data-test":"fork-session-name-field",className:"fork-session-name-field space-y-1",children:[t.jsx(B,{htmlFor:"fork-name",children:"Fork Name (optional)"}),t.jsx(Ee,{id:"fork-name","data-test":"fork-session-name-input",placeholder:"e.g., Refactor approach, Bug fix v2...",value:E,onChange:n=>k(n.target.value),disabled:l})]}),t.jsxs("div",{"data-test":"fork-session-description-field",className:"fork-session-description-field space-y-1",children:[t.jsx(B,{htmlFor:"fork-description",children:"Description (optional)"}),t.jsx(Re,{id:"fork-description","data-test":"fork-session-description-input",placeholder:"Why are you creating this fork?",value:R,onChange:n=>L(n.target.value),disabled:l,rows:2,className:"resize-none"})]}),t.jsxs("div",{"data-test":"fork-session-point-field",className:"fork-session-point-field flex-1 flex flex-col gap-2 min-h-0",children:[t.jsx(B,{children:"Fork Point (select a message)"}),t.jsx("div",{className:"text-xs text-muted-foreground",children:P?"The fork will include all messages up to (but not including) the selected message.":"The fork will include all messages up to and including the selected message."}),t.jsxs("div",{"data-test":"fork-session-exclude-checkbox",className:"flex items-center gap-2",children:[t.jsx(Le,{id:"exclude-selected",checked:P,onCheckedChange:n=>O(n===!0),disabled:l}),t.jsx(B,{htmlFor:"exclude-selected",className:"text-sm font-normal cursor-pointer",children:"Exclude selected message (fork before it)"})]}),t.jsx(Te,{"data-test":"fork-session-messages",className:"fork-session-messages flex-1 border rounded-md",children:t.jsx("div",{className:"p-2 space-y-1",children:m.length===0?t.jsx("div",{"data-test":"fork-session-no-messages",className:"text-sm text-muted-foreground text-center py-4",children:"No user messages available to fork from."}):m.map((n,a)=>t.jsx("button",{type:"button","data-test":"fork-session-message",className:Oe("fork-session-message w-full text-left p-2 rounded-md transition-colors","hover:bg-accent",v===n.id&&"bg-primary/10 border border-primary"),onClick:()=>{T(n.id),C==null||C(n.id)},disabled:l,children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(Be,{size:14,className:"mt-0.5 flex-shrink-0 text-muted-foreground"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"text-xs text-muted-foreground",children:["Message ",a+1]}),t.jsx("div",{className:"text-sm truncate",children:_(n)})]})]})},n.id))})})]})]}),t.jsxs("div",{"data-test":"fork-session-actions",className:"fork-session-actions p-4 border-t flex justify-end gap-2",children:[t.jsx(ie,{type:"button",variant:"outline","data-test":"fork-session-cancel",onClick:A,disabled:l,children:"Cancel"}),t.jsx(ie,{type:"submit","data-test":"fork-session-submit",disabled:l||!v,children:l?"Creating Fork...":"Create Fork"})]})]})})}function ts(){const{sessionId:r}=Ne(),x=Pe(),{messages:I,sessionDetails:i,metadata:j,loading:X,pagination:l,currentPage:H,loadOlderMessages:C,searchMessages:E,refreshSession:k,addOptimisticMessage:R,removeOptimisticMessage:L}=Ae(r,{onSessionDeleted:()=>{x("/claude")}}),{sessions:N,loadingSessions:T,sessionsError:P,pagination:O,currentPage:m,excludeAgents:W,searchSessions:v,refreshSessions:S,handlePageChange:Y,handleLoadMore:A,toggleExcludeAgents:_}=$e({loadOnMount:!1,subscribeToSSE:!1});s.useLayoutEffect(()=>{var e,o,u,p,y,g;if(i!=null&&i.cwd){const D=ce.getState();((u=(o=(e=D.app)==null?void 0:e.claude)==null?void 0:o.ui)==null?void 0:u.selectedProjectPath)!==i.cwd&&ce.updateState({app:{...D.app,claude:{...(p=D.app)==null?void 0:p.claude,ui:{...(g=(y=D.app)==null?void 0:y.claude)==null?void 0:g.ui,selectedProjectPath:i.cwd}}}})}},[i==null?void 0:i.cwd]);const[f,n]=s.useState(!!r);s.useRef(null);const[a,h]=s.useState(!1),b=s.useRef(0),$=s.useRef(0),J=s.useRef(0),M=s.useRef(null),d=s.useRef(null),c=s.useRef(null),w=s.useRef(null);s.useEffect(()=>{r&&n(!0)},[r]);const q=s.useCallback(()=>{n(!1)},[]),de=40,ue=.4,Q=s.useMemo(()=>typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches,[]),Z=s.useCallback(e=>{d.current&&(d.current.style.transform=`translateX(calc(-100% + ${e}px))`),c.current&&(c.current.style.transform=`translateX(${e}px)`)},[]),z=s.useCallback(()=>{d.current&&(d.current.style.transform=""),c.current&&(c.current.style.transform="")},[]),F=s.useRef(!1),U=s.useCallback(e=>{if(Q||e.target.closest('input, textarea, button, select, [role="button"], a'))return;const p=e.touches[0];$.current=p.clientX,J.current=p.clientY,M.current=null,b.current=0,p.clientX<=de&&f&&(F.current=!0,h(!0),d.current&&(d.current.style.willChange="transform"),c.current&&(c.current.style.willChange="transform"))},[f,Q]),V=s.useCallback(e=>{if(!F.current)return;const o=e.touches[0],u=o.clientX-$.current,p=o.clientY-J.current;if(M.current===null){const y=Math.abs(u),g=Math.abs(p);if((y>10||g>10)&&(M.current=y>g,!M.current)){F.current=!1,h(!1),z(),d.current&&(d.current.style.willChange=""),c.current&&(c.current.style.willChange="");return}}if(M.current){e.preventDefault();const y=window.innerWidth,g=Math.max(0,Math.min(u,y));b.current=g,w.current&&cancelAnimationFrame(w.current),w.current=requestAnimationFrame(()=>{Z(g)})}},[Z,z]),G=s.useCallback(()=>{if(!F.current)return;w.current&&(cancelAnimationFrame(w.current),w.current=null);const e=window.innerWidth,o=b.current>e*ue;z(),d.current&&(d.current.style.willChange=""),c.current&&(c.current.style.willChange=""),o&&q(),F.current=!1,h(!1),b.current=0,M.current=null},[q,z]);s.useEffect(()=>{const e=c.current;if(!(!e||!f))return e.addEventListener("touchstart",U,{passive:!0}),e.addEventListener("touchmove",V,{passive:!1}),e.addEventListener("touchend",G,{passive:!0}),()=>{e.removeEventListener("touchstart",U),e.removeEventListener("touchmove",V),e.removeEventListener("touchend",G)}},[U,V,G,f]);const fe=s.useMemo(()=>N.map(e=>e.id),[N]),ee=s.useCallback(e=>{n(!0),x(`/claude/${e}`)},[x]),me=s.useCallback(()=>{const e=document.querySelector('[data-test="message-input-container"]'),o=e==null?void 0:e.querySelector("textarea");o==null||o.focus()},[]),{focusedIndex:he,sidebarHasFocus:pe,focusSidebar:ge,sidebarRef:xe}=He({sessionIds:fe,selectedSessionId:r??null,onSessionSelect:ee,onFocusMessageInput:me,enabled:!0}),[Ye,se]=s.useState(null),[_e,te]=s.useState(!1),[ke,ne]=s.useState(!1),[ve,ae]=s.useState(!1),[Se,oe]=s.useState(null),[be,ye]=s.useState(null),je=s.useCallback(e=>{ye(e),ne(!0)},[]),K=s.useCallback(()=>{ne(!1),oe(null)},[]),Me=s.useCallback(e=>{oe(e)},[]),we=s.useCallback(async e=>{if(r){ae(!0);try{const o=await le.forkSession(r,e);re.success("Fork created successfully",{description:`Fork "${e.customName||"Unnamed fork"}" has been created.`}),K(),S(),x(`/claude/${o.sessionId}`)}catch(o){console.error("Failed to create fork:",o),re.error("Failed to create fork",{description:o instanceof Error?o.message:"An unknown error occurred"})}finally{ae(!1)}}},[r,K,S,x]),Ce=async(e,o)=>{try{te(!0);const u=await le.searchMessages(e,o);se(u.results),console.log("Message search results:",u)}catch(u){console.error("Message search failed:",u),se([])}finally{te(!1)}};return t.jsxs("div",{className:"session-details-page h-full overflow-hidden md:p-4","data-test":"session-details-page",children:[t.jsxs("div",{className:"session-layout relative h-full overflow-hidden md:grid md:grid-cols-[350px_1fr] md:gap-4","data-test":"session-layout",children:[t.jsx("div",{ref:d,className:`sessions-sidebar overflow-hidden bg-background
            absolute inset-0 z-10 md:relative md:inset-auto md:z-auto
            ${a?"":"transition-transform duration-300 ease-in-out"}
            ${!a&&f?"-translate-x-full md:translate-x-0":""}
            ${!a&&!f?"translate-x-0":""}
          `,"data-test":"sessions-sidebar-panel",children:t.jsx(Fe,{sessions:N,loading:T,error:P,onSessionSelect:ee,selectedSessionId:r??null,onRefresh:()=>{S(),k()},pagination:O,currentPage:m,onPageChange:Y,onLoadMore:A,onSearch:v,onMessageSearch:Ce,onNameUpdated:()=>{k(),S()},excludeAgents:W,onToggleExcludeAgents:_,focusedIndex:pe?he:-1,sidebarRef:xe,onSidebarClick:ge})}),t.jsxs("div",{ref:c,className:`chat-area flex flex-col gap-4 min-h-0 overflow-hidden bg-background
            absolute inset-0 z-10 md:relative md:inset-auto md:z-auto
            ${a?"":"transition-transform duration-300 ease-in-out"}
            ${!a&&f?"translate-x-0":""}
            ${!a&&!f?"translate-x-full md:translate-x-0 pointer-events-none md:pointer-events-auto":""}
          `,"data-test":"chat-area-panel",children:[t.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden",children:t.jsx(ze,{messages:I,sessionDetails:i,metadata:j,loading:X,pagination:l,onLoadOlder:l&&H<l.totalPages?C:void 0,onSearch:E,onNameUpdated:()=>{k(),S()},onFork:r?je:void 0,scrollToMessageId:Se,onBackClick:q,showBackButton:!0})}),t.jsx("div",{className:"chat-input flex-shrink-0",children:r&&t.jsx(De,{sessionId:r,onSendSuccess:()=>{k()},onAddOptimisticMessage:R,onRemoveOptimisticMessage:L,userMessages:I.filter(e=>e.role==="user"&&!e._isOptimistic)})})]})]}),r&&i&&t.jsx(We,{isVisible:ke,onClose:K,sessionId:r,sessionName:i.customName||i.name,messages:I,onFork:we,isSubmitting:ve,onMessageSelect:Me,triggerPosition:be??void 0})]})}export{ts as SessionDetailsPage};
