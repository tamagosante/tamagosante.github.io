const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePage-CH2r0i2H.js","assets/react-vendor-Byz07MLO.js","assets/icons-vtiX7BHn.js","assets/recordingStorage-XzvoUejy.js","assets/utils-DJ2ViQ2u.js","assets/radix-ui-v9Pxfv0s.js","assets/ui-utils-BxIQ3qGg.js","assets/Chat-kmy79JDa.js","assets/format-utils-CaqrGWxs.js","assets/InputWithAudio-Beg-QK_y.js","assets/TTSApiClient-DHTgyO77.js","assets/systemPromptService-CiGRUnu2.js","assets/Settings-DkLnh0pi.js","assets/Demo-CytqLj06.js","assets/Breadcrumbs-B61dZAu9.js","assets/JsonViewerApp-BHZpouoC.js","assets/Content-B-hwGuVv.js","assets/TablePage-D0cTmJjf.js","assets/data-table-B5hYcgGb.js","assets/table-BMummQ1M.js","assets/VocabularyPage-Ddg4R_Ij.js","assets/definitionHelper-DuYF3Asi.js","assets/useVietnameseTyping-_5CkNDNz.js","assets/TextareaPopoverAtCursor-BhwkV6wH.js","assets/cursorPosition-otMhJ5rZ.js","assets/LiveTranscriptionPage-pLbwSKdE.js","assets/AudioPanelDemo-CSJZIYnP.js","assets/ClaudePage-DPyahOHy.js","assets/SessionSidebar-BExSPAHd.js","assets/useSessionKeyboardNavigation-CJVY-X6Z.js","assets/SessionDetailsPage-BmvpTSj1.js","assets/ForksPage-BTkCQzyO.js","assets/KanbanPage-H08Qd_7j.js","assets/DemoLayout-BPsxBz1L.js","assets/react-hooks-rjLLAVfy.js","assets/DragDropManager-KcuPnjwl.js","assets/SFSService-DoV39QYl.js","assets/KanbanDataPage-D_CbtHwd.js","assets/index-DkA0f1CK.js","assets/GlobalStatePage-DBK0iju4.js","assets/GamePage-BZ6lgrps.js","assets/NewHomeApp-DKZee14y.js","assets/CanvasAppV2-Sc1Hz9kO.js","assets/VimInputHandlerV2-DJs-ook4.js","assets/logging-DNAPNJun.js","assets/string-4WCj7OpV.js","assets/clipboardHtmlToMarkdown-BNZmEbgs.js","assets/VimInputHandlerV2-BfpIuMTm.css","assets/UiButtonWithExpandOption-h1AbWOIL.js","assets/DraggableCrudTree-CyO8j1zi.js","assets/treeHelpers-DUv_6quS.js","assets/globalFacadeRegistry-BlelMPVg.js","assets/WorkflowRowItem-iqt932NO.js","assets/UiDataTable-BJzbkTin.js","assets/markdownToHtml-C-4HvgxL.js","assets/DraggableTree-Dr3LK8bf.js","assets/useOcr-BhvO77pd.js","assets/alert-D9C8hSnn.js","assets/easy-form-DAFxRHyz.js","assets/forms-B7OAPNGv.js","assets/form-DxSbN1YK.js","assets/SlashCommandMenu-DAHzvOSL.js","assets/MobileSheet-8BahCbCX.js","assets/userStoreLocalStorage-D-7v21rP.js","assets/userCanvasStateStorage-B5aouBzz.js","assets/SttPage-Co_X75ao.js"])))=>i.map(i=>d[i]);
var pu=Object.defineProperty;var hu=(s,e,t)=>e in s?pu(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var ee=(s,e,t)=>hu(s,typeof e!="symbol"?e+"":e,t);import{r as h,j as a,e as fu,f as bo,d as Ti,k as _a,b as Oa,R as mu,l as gu,B as xu}from"./react-vendor-Byz07MLO.js";import{B as vu,m as wo,d as bu,t as Ne,_ as gt,z as wu,T as yu}from"./utils-DJ2ViQ2u.js";import{S as Ds,v as Ii,O as sr,d as La,C as cn,t as Ma,T as nr,D as rr,R as Ai,w as Su,x as Pi,y as ju,z as Cu,A as Nu,B as ku,E as Eu,F as Tu,H as Iu,J as Au,K as Pu,M as Ru,N as Ri,Q as Di,U as _i,V as Du,W as _u,X as Ou,Y as Lu,Z as Oi,$ as Mu,a0 as Fu,a1 as Li,a2 as $u,a3 as Mi,a4 as Uu,a5 as Bu,a6 as Fi,a7 as $i,a8 as Wu,a9 as Ui,aa as Bi,ab as Wi,ac as zu,ad as Hu,ae as Gu,af as qu,ag as zi,ah as Hi,ai as Vu,aj as Gi,ak as qi,al as Vi,am as Ki,an as Ji,ao as Yi,ap as Xi,aq as Qi,ar as Ku,as as Ju,at as Yu,au as Zi,av as Xu,aw as Qu,ax as ec,ay as Zu,az as ep,aA as tc,aB as sc,aC as nc,aD as rc,aE as ac,aF as tp}from"./radix-ui-v9Pxfv0s.js";import{t as sp,a as qs,c as ln}from"./ui-utils-BxIQ3qGg.js";import{X as ft,c2 as np,c3 as yo,c4 as rp,f as Ft,N as Br,G as es,bD as ap,aG as op,p as ar,c5 as oc,c6 as ip,bl as ic,aT as cp,bB as Wr,b as lp,c7 as zr,c8 as Hr,c9 as Gr,aJ as qr,A as Vr,a2 as Kr,r as _s,q as yt,w as Ks,F as Js,bt as dp,l as up,ca as pp,cb as hp,a8 as fp,$ as cc,m as mp,bv as gp,cc as xp,D as or,T as St,cd as vp,a as lc,K as Fa,aV as $a,bZ as Ua,o as ut,C as ct,n as ir,u as bp,S as Cn,ai as dc,b3 as wp,ax as yp,aa as Sr,c as Nn,ad as On,a9 as Ys,x as cr,ce as uc,bH as Sp,bh as jp,aw as pc,d as lr,P as Cp,_ as Xs,cf as Np,cg as kp,e as dr,Q as Ep,O as $s,E as Jr,J as So,bu as Ln,b2 as Yr,bY as Tp,a5 as Ip,aA as Qs,ch as Ap,be as Pp,bq as Rp,h as Dp,ba as Xr,ci as _p,b8 as Op,cj as Lp,aP as jo,aQ as Co,a0 as No,bI as ko,ck as Mp,cl as Fp,az as hc,s as $p}from"./icons-vtiX7BHn.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const ls=class ls{constructor(){ee(this,"logs",[]);ee(this,"counter",0);ee(this,"maxLogs",100);ee(this,"listeners",[]);ee(this,"isCollecting",!1);ee(this,"collectedLogs",[]);ee(this,"originalConsole",{log:console.log,warn:console.warn,error:console.error,debug:console.debug})}static getInstance(){return ls.instance||(ls.instance=new ls),ls.instance}log(e,t="info",n){const r=new Date().toLocaleTimeString(),o={id:`log-${this.counter++}`,timestamp:r,message:e,level:t,service:n},i=t==="error"?console.error:t==="warning"?console.warn:t==="debug"?console.debug:console.log,c=n?`[${n}] `:"",l=`[${r}] ${c}${e}`;i(l),this.isCollecting&&this.collectedLogs.push(l),this.logs=[o,...this.logs.slice(0,this.maxLogs-1)],this.notifyListeners()}info(e,t){this.log(e,"info",t)}error(e,t){this.log(e,"error",t)}warning(e,t){this.log(e,"warning",t)}debug(e,t){this.log(e,"debug",t)}getLogs(){return this.logs}clear(){this.logs=[],this.notifyListeners()}export(){return this.logs.slice().reverse().map(e=>{const t=e.service?`[${e.service}] `:"";return`[${e.timestamp}] ${e.level.toUpperCase()}: ${t}${e.message}`}).join(`
`)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}collectLogs(e=!0){this.isCollecting=!0,this.collectedLogs=[],e&&typeof window<"u"&&this.interceptConsole(),console.log("ðŸ“ Log collection started. Call window.printCollectedLogs() to retrieve.")}interceptConsole(){const e=this;console.log=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(n),e.originalConsole.log.apply(console,t)},console.warn=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`WARN: ${n}`),e.originalConsole.warn.apply(console,t)},console.error=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`ERROR: ${n}`),e.originalConsole.error.apply(console,t)},console.debug=function(...t){const n=t.map(r=>typeof r=="object"?JSON.stringify(r,null,2):String(r)).join(" ");e.isCollecting&&e.collectedLogs.push(`DEBUG: ${n}`),e.originalConsole.debug.apply(console,t)}}restoreConsole(){console.log=this.originalConsole.log,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,console.debug=this.originalConsole.debug}stopCollecting(){this.isCollecting=!1,this.restoreConsole();const e=this.collectedLogs.join(`
`);return console.log("ðŸ›‘ Log collection stopped."),e}getCollectedLogs(){return this.collectedLogs.join(`
`)}clearCollectedLogs(){this.collectedLogs=[]}};ee(ls,"instance");let Qr=ls;const Re=Qr.getInstance();typeof window<"u"&&(window.getCollectedLogs=()=>Re.getCollectedLogs(),window.printCollectedLogs=()=>{const s=Re.getCollectedLogs();return console.log(`ðŸ“‹ Collected logs:
`+s),s},window.startCollectingLogs=()=>Re.collectLogs(),window.stopCollectingLogs=()=>Re.stopCollecting(),window.clearCollectedLogs=()=>Re.clearCollectedLogs());const fc=()=>{const[s,e]=h.useState(()=>Re.getLogs());h.useEffect(()=>Re.subscribe(r=>{e(r)}),[]);const t=h.useRef();return t.current||(t.current={log:(n,r,o)=>Re.log(n,r,o),info:(n,r)=>Re.info(n,r),error:(n,r)=>Re.error(n,r),warning:(n,r)=>Re.warning(n,r),debug:(n,r)=>Re.debug(n,r),clear:()=>Re.clear(),export:()=>Re.export()}),{logs:s,actions:t.current}};class Up{constructor(e="http://localhost:3333"){ee(this,"baseUrl");ee(this,"eventSource",null);this.baseUrl=e}async getProjects(e){const t=new URLSearchParams;(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const n=`${this.baseUrl}/claude/projects${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch projects: ${r.statusText}`);return await r.json()}catch(r){throw console.error("[ClaudeAPI.getProjects] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,timestamp:new Date().toISOString()}),r}}async getProjectDetails(e){const t=`${this.baseUrl}/claude/projects/${encodeURIComponent(e)}`,n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch project details: ${n.statusText}`);return n.json()}async getSessions(e){const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.excludeAgents&&t.append("excludeAgents","true");const n=`${this.baseUrl}/claude/sessions-v2${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch sessions: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getSessions] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",errorName:r instanceof Error?r.name:void 0,errorStack:r instanceof Error?r.stack:void 0,timestamp:new Date().toISOString()}),r}}async searchSessions(e,t){const n=new URLSearchParams;e&&(t!=null&&t.messageTypes&&t.messageTypes.length>0?n.append("messageContent",e):n.append("q",e)),t!=null&&t.fields&&t.fields.length>0&&!(t!=null&&t.messageTypes&&t.messageTypes.length>0)&&n.append("fields",t.fields.join(",")),(t==null?void 0:t.isActive)!==void 0&&n.append("isActive",t.isActive.toString()),(t==null?void 0:t.minMessages)!==void 0&&n.append("minMessages",t.minMessages.toString()),(t==null?void 0:t.maxMessages)!==void 0&&n.append("maxMessages",t.maxMessages.toString()),t!=null&&t.modifiedAfter&&n.append("modifiedAfter",t.modifiedAfter),t!=null&&t.modifiedBefore&&n.append("modifiedBefore",t.modifiedBefore),t!=null&&t.messageTypes&&t.messageTypes.length>0&&n.append("messageTypes",t.messageTypes.join(",")),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/sessions/search${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to search sessions: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.searchSessions] Fetch error:",{url:r,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,errorStack:o instanceof Error?o.stack:void 0,timestamp:new Date().toISOString()}),o}}async searchSessionMessages(e,t,n){const r=new URLSearchParams;t&&r.append("content",t),n!=null&&n.messageType&&n.messageType.length>0?r.append("messageType",n.messageType.join(",")):n!=null&&n.role&&r.append("role",n.role),n!=null&&n.after&&r.append("after",n.after),n!=null&&n.before&&r.append("before",n.before),n!=null&&n.sortOrder&&r.append("sortOrder",n.sortOrder),(n==null?void 0:n.page)!==void 0&&r.append("page",n.page.toString()),(n==null?void 0:n.pageSize)!==void 0&&r.append("pageSize",n.pageSize.toString());const o=`${this.baseUrl}/claude/sessions/${e}/search${r.toString()?`?${r.toString()}`:""}`,i=await fetch(o);if(!i.ok)throw new Error(`Failed to search session messages: ${i.statusText}`);return i.json()}async searchMessages(e,t){const n=new URLSearchParams;e&&n.append("q",e),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageTypes",t.messageType.join(",")),t!=null&&t.after&&n.append("after",t.after),t!=null&&t.before&&n.append("before",t.before),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString());const r=`${this.baseUrl}/claude/messages/search${n.toString()?`?${n.toString()}`:""}`,o=await fetch(r);if(!o.ok)throw new Error(`Failed to search messages: ${o.statusText}`);return o.json()}async getSessionDetails(e,t){const n=new URLSearchParams;(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.messageType&&t.messageType.length>0&&n.append("messageType",t.messageType.join(","));const r=`${this.baseUrl}/claude/sessions-v2/${e}${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch session details: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionDetails] Fetch error:",{url:r,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,timestamp:new Date().toISOString()}),o}}async sendMessage(e){const t=await fetch(`${this.baseUrl}/claude/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to send message: ${t.statusText}`);return t.json()}async createSession(e={}){const t=await fetch(`${this.baseUrl}/claude/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to create session: ${t.statusText}`);return t.json()}async updateSessionName(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customName:t})});if(!n.ok)throw new Error(`Failed to update session name: ${n.statusText}`);return n.json()}async updateSessionStatus(e,t){const n=await fetch(`${this.baseUrl}/claude/sessions/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Failed to update session status: ${n.statusText}`);return n.json()}async forkSession(e,t){const n=`${this.baseUrl}/claude/sessions/${e}/fork`;try{const r=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to create fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.forkSession] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForks(e){const t=new URLSearchParams;e!=null&&e.parentSessionId&&t.append("parentSessionId",e.parentSessionId),e!=null&&e.sessionId&&t.append("sessionId",e.sessionId),(e==null?void 0:e.favoritesOnly)!==void 0&&t.append("favoritesOnly",e.favoritesOnly.toString()),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString()),e!=null&&e.sortBy&&t.append("sortBy",e.sortBy),e!=null&&e.sortOrder&&t.append("sortOrder",e.sortOrder),e!=null&&e.category&&t.append("category",e.category),e!=null&&e.tag&&t.append("tag",e.tag),(e==null?void 0:e.includeChildren)!==void 0&&t.append("includeChildren",e.includeChildren.toString());const n=`${this.baseUrl}/claude/forks${t.toString()?`?${t.toString()}`:""}`;try{const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch forks: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.getForks] Fetch error:",{url:n,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async getForkDetails(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch fork details: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getForkDetails] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async updateFork(e,t){const n=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const r=await fetch(n,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to update fork: ${r.statusText}`);return r.json()}catch(r){throw console.error("[ClaudeAPI.updateFork] Fetch error:",{url:n,forkId:e,updates:t,error:r,errorMessage:r instanceof Error?r.message:"Unknown error",timestamp:new Date().toISOString()}),r}}async deleteFork(e){const t=`${this.baseUrl}/claude/forks/${encodeURIComponent(e)}`;try{const n=await fetch(t,{method:"DELETE"});if(!n.ok)throw new Error(`Failed to delete fork: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.deleteFork] Fetch error:",{url:t,forkId:e,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()}),n}}async getForkTags(){const e=`${this.baseUrl}/claude/fork-tags`;try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch fork tags: ${t.statusText}`);return t.json()}catch(t){throw console.error("[ClaudeAPI.getForkTags] Fetch error:",{url:e,error:t,errorMessage:t instanceof Error?t.message:"Unknown error",timestamp:new Date().toISOString()}),t}}async getSessionForks(e,t){const n=new URLSearchParams;(t==null?void 0:t.favoritesOnly)!==void 0&&n.append("favoritesOnly",t.favoritesOnly.toString()),(t==null?void 0:t.page)!==void 0&&n.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&n.append("pageSize",t.pageSize.toString()),t!=null&&t.sortBy&&n.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&n.append("sortOrder",t.sortOrder);const r=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/forks${n.toString()?`?${n.toString()}`:""}`;try{const o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch session forks: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionForks] Fetch error:",{url:r,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()}),o}}async getForkTree(e,t){const n=new URLSearchParams;t!=null&&t.includeMessages&&n.append("includeMessages","true"),t!=null&&t.messageTypes&&n.append("messageTypes",t.messageTypes),(t==null?void 0:t.messageLimit)!==void 0&&n.append("messageLimit",t.messageLimit.toString());const r=n.toString(),o=`${this.baseUrl}/claude/sessions/${encodeURIComponent(e)}/fork-tree${r?`?${r}`:""}`;try{const i=await fetch(o);if(!i.ok)throw new Error(`Failed to fetch fork tree: ${i.statusText}`);return i.json()}catch(i){throw console.error("[ClaudeAPI.getForkTree] Fetch error:",{url:o,sessionId:e,options:t,error:i,errorMessage:i instanceof Error?i.message:"Unknown error",timestamp:new Date().toISOString()}),i}}subscribeToSessionChanges(e,t){const n=`${this.baseUrl}/claude/sessions/events`;return this.eventSource=new EventSource(n),this.eventSource.onopen=()=>{var r;console.log("[ClaudeAPI.subscribeToSessionChanges] SSE connection opened:",{url:n,readyState:(r=this.eventSource)==null?void 0:r.readyState,timestamp:new Date().toISOString()})},this.eventSource.onmessage=r=>{try{const o=JSON.parse(r.data);o.type!=="connected"&&e(o)}catch(o){console.error("[ClaudeAPI.subscribeToSessionChanges] Failed to parse SSE event:",{error:o,eventData:r.data,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=r=>{var o,i,c,l;console.error("[ClaudeAPI.subscribeToSessionChanges] SSE connection error:",{error:r,readyState:(o=this.eventSource)==null?void 0:o.readyState,readyStateText:((i=this.eventSource)==null?void 0:i.readyState)===0?"CONNECTING":((c=this.eventSource)==null?void 0:c.readyState)===1?"OPEN":((l=this.eventSource)==null?void 0:l.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),t&&t(r)},()=>{var r;(r=this.eventSource)==null||r.close(),this.eventSource=null}}}const Ve=new Up;class Bp{constructor(e="http://localhost:3333"){ee(this,"eventSource",null);ee(this,"eventHandlers",new Set);ee(this,"errorHandlers",new Set);ee(this,"baseUrl");ee(this,"reconnectAttempts",0);ee(this,"maxReconnectAttempts",5);ee(this,"reconnectDelay",1e3);this.baseUrl=e}subscribe(e,t){return this.eventHandlers.add(e),t&&this.errorHandlers.add(t),this.eventHandlers.size===1&&!this.eventSource&&this.connect(),()=>{this.eventHandlers.delete(e),t&&this.errorHandlers.delete(t),this.eventHandlers.size===0&&this.disconnect()}}connect(){const e=`${this.baseUrl}/claude/sessions/events`;this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.reconnectAttempts=0},this.eventSource.onmessage=t=>{try{const n=JSON.parse(t.data);if(n.type==="connected")return;this.eventHandlers.forEach(r=>{try{r(n)}catch(o){console.error("[ClaudeSSEManager] Error in event handler:",{error:o,eventType:n.type,timestamp:new Date().toISOString()})}})}catch(n){console.error("[ClaudeSSEManager] Failed to parse SSE event:",{error:n,eventData:t.data,errorMessage:n instanceof Error?n.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=t=>{var n,r,o,i;if(console.error("[ClaudeSSEManager] SSE connection error:",{error:t,readyState:(n=this.eventSource)==null?void 0:n.readyState,readyStateText:((r=this.eventSource)==null?void 0:r.readyState)===0?"CONNECTING":((o=this.eventSource)==null?void 0:o.readyState)===1?"OPEN":((i=this.eventSource)==null?void 0:i.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),this.errorHandlers.forEach(c=>{try{c(t)}catch(l){console.error("[ClaudeSSEManager] Error in error handler:",l)}}),this.eventHandlers.size>0&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const c=this.reconnectDelay*this.reconnectAttempts;setTimeout(()=>{this.eventHandlers.size>0&&(this.disconnect(),this.connect())},c)}}}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null,this.reconnectAttempts=0)}getConnectionState(){var e;return((e=this.eventSource)==null?void 0:e.readyState)??null}getSubscriberCount(){return this.eventHandlers.size}}const Wp=new Bp;function Ba(s,e,t=!0){const n=h.useRef(s),r=h.useRef(e);h.useEffect(()=>{n.current=s},[s]),h.useEffect(()=>{r.current=e},[e]);const o=h.useCallback(l=>{n.current(l)},[]),i=h.useCallback(l=>{var d;(d=r.current)==null||d.call(r,l)},[]),c=h.useRef(!!e);h.useEffect(()=>{c.current=!!e},[e]),h.useEffect(()=>{if(!t)return;const l=Wp.subscribe(o,c.current?i:void 0);return()=>{l()}},[t,o,i])}function mc(s,e){const t={...s};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n],o=t[n];r&&typeof r=="object"&&!Array.isArray(r)&&o&&typeof o=="object"&&!Array.isArray(o)?t[n]=mc(o,r):t[n]=r}return t}class zp{constructor(e={}){ee(this,"STORAGE_KEY","global-store");ee(this,"state$");const t=this.loadFromStorage();this.state$=new vu({...e,...t})}getState(){return this.state$.value}getState$(){return this.state$.asObservable()}get(e){return this.state$.value[e]}select(e){return this.state$.pipe(wo(t=>t[e]),bu())}selectSlice(e){return this.state$.pipe(wo(e))}setState(e){this.state$.next(e),this.saveToStorage()}updateState(e){const t={...this.state$.value,...e};this.state$.next(t),this.saveToStorage()}set(e,t){this.updateState({[e]:t})}update(e,t){const n=this.state$.value[e],r=typeof n=="object"&&n!==null&&typeof t=="object"&&t!==null?mc(n,t):t;this.set(e,r)}remove(e){const t={...this.state$.value};delete t[e],this.state$.next(t),this.saveToStorage()}reset(){this.state$.next({}),this.clearStorage()}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load global store from localStorage:",e),{}}}saveToStorage(){try{const e=this.getStateToPersist(this.state$.value);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save global store to localStorage:",e)}}getStateToPersist(e){var n,r;const t={...e};if(t.ui&&(t.ui={...t.ui,directoryMaps:void 0}),(n=t.app)!=null&&n.claude){const o=t.app.claude;t.app={...t.app,claude:{...o,data:void 0,forks:void 0,ui:o.ui?{...o.ui,isInitialized:void 0,loadingSessions:void 0,sessionsError:void 0,projectsInitialized:void 0,loadingProjects:void 0,projectsError:void 0,activity:void 0}:void 0}}}if((r=t.app)!=null&&r.kanban){const o=t.app.kanban;t.app={...t.app,kanban:{...o,loading:void 0,error:void 0}}}return t}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear global store from localStorage:",e)}}export(){return JSON.stringify(this.state$.value,null,2)}import(e){try{const t=JSON.parse(e);return this.setState(t),!0}catch(t){return console.error("Failed to import global store data:",t),!1}}}const le=new zp;function Le(s){const[e,t]=h.useState(()=>s(le.getState()));return h.useEffect(()=>{const n=le.selectSlice(s).subscribe(t);return()=>n.unsubscribe()},[s]),e}function Wa(){return{get:le.get.bind(le),set:le.set.bind(le),update:le.update.bind(le),updateState:le.updateState.bind(le),remove:le.remove.bind(le),reset:le.reset.bind(le),getState:le.getState.bind(le)}}const Hp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},Gp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1},qp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.sessionsError)??null},Vp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.pagination)??null},Kp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.currentPage)??1},Jp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.isInitialized)??!1},Yp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.excludeAgents)??!1};function Xp(s={}){const{loadOnMount:e=!0,subscribeToSSE:t=!0}=s,{update:n,getState:r}=Wa(),o=h.useRef(!1),i=Le(Hp),c=Le(Gp),l=Le(qp),d=Le(Vp),p=Le(Kp),u=Le(Jp),f=Le(Yp),m=async(S=1,j=!1)=>{var N,E,R,D,T,L;try{const _=(N=r().app)==null?void 0:N.claude;n("app",{claude:{ui:{..._==null?void 0:_.ui,loadingSessions:!0,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1}}});const P=((E=_==null?void 0:_.ui)==null?void 0:E.excludeAgents)??!1,G=await Ve.getSessions({page:S,pageSize:20,excludeAgents:P}),$=[...G.sessions].sort((X,I)=>new Date(I.lastModified).getTime()-new Date(X.lastModified).getTime()),Y=((R=_==null?void 0:_.data)==null?void 0:R.sessions)??[],A=j?[...Y,...$]:$;n("app",{claude:{data:{sessions:A,pagination:G.pagination||null},ui:{loadingSessions:!1,sessionsError:null,currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}})}catch(_){console.error("[SessionLoader] API request failed:",{error:_,errorMessage:_ instanceof Error?_.message:"Unknown error",page:S,append:j,timestamp:new Date().toISOString()}),Re.error(`Session load failed: ${_ instanceof Error?_.message:"Unknown error"}`,"SessionLoader"),n("app",{claude:{data:{sessions:j?((L=(T=(D=r().app)==null?void 0:D.claude)==null?void 0:T.data)==null?void 0:L.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:_ instanceof Error?_.message:"Failed to load sessions",currentPage:S,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}}),Re.error("Store updated with error state","SessionLoader")}},g=async(S,j,N=!1)=>{var E,R,D,T,L;try{const _=(E=r().app)==null?void 0:E.claude;n("app",{claude:{ui:{..._==null?void 0:_.ui,loadingSessions:!0,sessionsError:null,searchQuery:S,searchFilters:j,isSearchActive:!0}}});const P=await Ve.searchSessions(S,j),G=((R=_==null?void 0:_.data)==null?void 0:R.sessions)??[],$=N?[...G,...P.results]:P.results;n("app",{claude:{data:{sessions:$,pagination:P.pagination},ui:{loadingSessions:!1,sessionsError:null,currentPage:P.pagination.page,searchQuery:S,searchFilters:j,isSearchActive:!0}}})}catch(_){console.error("[SessionLoader] API request failed:",{error:_,errorMessage:_ instanceof Error?_.message:"Unknown error",query:S,filters:j,append:N,timestamp:new Date().toISOString()}),n("app",{claude:{data:{sessions:N?((L=(T=(D=r().app)==null?void 0:D.claude)==null?void 0:T.data)==null?void 0:L.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:_ instanceof Error?_.message:"Failed to search sessions",currentPage:1,searchQuery:S,searchFilters:j,isSearchActive:!0}}})}},x=(S,j)=>{var T,L,_;const N=((_=(L=(T=r().app)==null?void 0:T.claude)==null?void 0:L.data)==null?void 0:_.sessions)??[],E=N.findIndex(P=>P.id===S);if(E===-1)return;const R=[...N];R[E]={...R[E],...j};const D=R.sort((P,G)=>new Date(G.lastModified).getTime()-new Date(P.lastModified).getTime());n("app",{claude:{data:{sessions:D},ui:{loadingSessions:!1,sessionsError:null}}})},w=S=>{var E,R,D;const N=(((D=(R=(E=r().app)==null?void 0:E.claude)==null?void 0:R.data)==null?void 0:D.sessions)??[]).filter(T=>T.id!==S);n("app",{claude:{data:{sessions:N},ui:{loadingSessions:!1,sessionsError:null}}})},v=S=>{var N,E;const j=(E=(N=r().app)==null?void 0:N.claude)==null?void 0:E.ui;if(j!=null&&j.isSearchActive&&(j==null?void 0:j.searchQuery)!==void 0){const R={...j.searchFilters,page:S};g(j.searchQuery,R)}else m(S)},b=()=>{var S,j;if(d&&p<d.totalPages){const N=(j=(S=r().app)==null?void 0:S.claude)==null?void 0:j.ui;if(N!=null&&N.isSearchActive&&(N==null?void 0:N.searchQuery)!==void 0){const E={...N.searchFilters,page:p+1};g(N.searchQuery,E,!0)}else m(p+1,!0)}},y=()=>{m(1)},C=()=>{var N,E;const S=(N=r().app)==null?void 0:N.claude,j=!((E=S==null?void 0:S.ui)!=null&&E.excludeAgents);n("app",{claude:{ui:{...S==null?void 0:S.ui,excludeAgents:j}}}),m(1)};return h.useEffect(()=>{e&&(u||o.current||(o.current=!0,m(1)))},[u]),Ba(S=>{S.type==="created"&&m(p),S.type==="modified"&&S.sessionId&&(async()=>{try{const j=await Ve.getSessionDetails(S.sessionId);x(S.sessionId,{name:j.name,lastModified:j.metadata.lastModified,messageCount:j.metadata.messageCount})}catch(j){console.error("[SSE] Failed to fetch modified session:",{sessionId:S.sessionId,error:j,timestamp:new Date().toISOString()})}})(),S.type==="batch-modified"&&S.sessionIds&&m(p),S.type==="deleted"&&S.sessionId&&w(S.sessionId),S.type==="session-input-received"&&S.sessionId&&(async()=>{var j,N,E;try{const R=await Ve.getSessionDetails(S.sessionId),D=(N=(j=R.messages)==null?void 0:j[R.messages.length-1])==null?void 0:N.content,T=typeof D=="string"?D:Array.isArray(D)?(E=D.find(L=>typeof L=="object"&&L!==null&&"type"in L&&L.type==="text"))==null?void 0:E.text:D==null?void 0:D.text;x(S.sessionId,{name:R.name,lastModified:R.metadata.lastModified,messageCount:R.metadata.messageCount,latestMessage:T})}catch(R){console.error("[SSE] Failed to fetch session after input received:",{sessionId:S.sessionId,error:R,timestamp:new Date().toISOString()})}})()},S=>{console.error("[SSE] Connection error:",{error:S,errorMessage:S instanceof Error?S.message:"Unknown error",timestamp:new Date().toISOString()})},t),{sessions:i,loadingSessions:c,sessionsError:l,pagination:d,currentPage:p,isInitialized:u,excludeAgents:f,loadSessions:m,searchSessions:g,refreshSessions:y,handlePageChange:v,handleLoadMore:b,toggleExcludeAgents:C}}const Qp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},Zp=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},eh=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},th=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsInitialized)??!1};function sh(s={}){const{loadOnMount:e=!0}=s,{update:t,getState:n}=Wa(),r=h.useRef(!1),o=Le(Qp),i=Le(Zp),c=Le(eh),l=Le(th),d=async()=>{var u,f,m;try{const g=n(),x=(u=g.app)==null?void 0:u.claude;t("app",{...g.app,claude:{...x,data:{...x==null?void 0:x.data},ui:{...x==null?void 0:x.ui,loadingProjects:!0,projectsError:null}}});const w=await Ve.getProjects({pageSize:100}),v=n(),b=(f=v.app)==null?void 0:f.claude;t("app",{...v.app,claude:{...b,data:{...b==null?void 0:b.data,projects:w.projects},ui:{...b==null?void 0:b.ui,loadingProjects:!1,projectsError:null,projectsInitialized:!0}}})}catch(g){console.error("[ProjectsLoader] API request failed:",{error:g,errorMessage:g instanceof Error?g.message:"Unknown error",timestamp:new Date().toISOString()}),Re.error(`Projects load failed: ${g instanceof Error?g.message:"Unknown error"}`,"ProjectsLoader");const x=n(),w=(m=x.app)==null?void 0:m.claude;t("app",{...x.app,claude:{...w,data:{...w==null?void 0:w.data,projects:[]},ui:{...w==null?void 0:w.ui,loadingProjects:!1,projectsError:g instanceof Error?g.message:"Failed to load projects",projectsInitialized:!0}}}),Re.error("Store updated with error state","ProjectsLoader")}},p=()=>{d()};return h.useEffect(()=>{e&&(l||r.current||(r.current=!0,d()))},[l,e]),{projects:o,loadingProjects:i,projectsError:c,projectsInitialized:l,loadProjects:d,refreshProjects:p}}function nh(){const[s,e]=h.useState(new Set),t=h.useCallback(n=>n?s.has(n):!1,[s]);return Ba(n=>{var o,i,c,l,d,p,u,f,m,g,x,w,v,b,y;if(n.type==="batch-modified")return;const r=n.sessionId;if(r){if(n.type==="session-started"&&e(C=>{const S=new Set(C);return S.add(r),S}),n.type==="session-ended"&&e(C=>{const S=new Set(C);return S.delete(r),S}),n.type==="session-opened"){const C=((c=(i=(o=le.get("app"))==null?void 0:o.claude)==null?void 0:i.ui)==null?void 0:c.activity)??{},S={...C,[r]:{...C[r],isOpened:!0}};le.update("app",{claude:{ui:{activity:S}}}),e(j=>{const N=new Set(j);return N.add(r),N})}if(n.type==="session-closed"){const C=((p=(d=(l=le.get("app"))==null?void 0:l.claude)==null?void 0:d.ui)==null?void 0:p.activity)??{},S=((u=C[r])==null?void 0:u.isOpened)===!0||((f=C[r])==null?void 0:f.isProcessing)===!0,j={...C,[r]:{...C[r],isOpened:!!S,isProcessing:!1}};le.update("app",{claude:{ui:{activity:j}}}),S||e(N=>{const E=new Set(N);return E.delete(r),E}),console.log("[useSessionRunningStatus] Session closed, keeping as opened:",S)}if(n.type==="session-processing-started"){const C=((x=(g=(m=le.get("app"))==null?void 0:m.claude)==null?void 0:g.ui)==null?void 0:x.activity)??{},S={...C,[r]:{...C[r],isProcessing:!0,isOpened:!0}};le.update("app",{claude:{ui:{activity:S}}}),e(j=>{const N=new Set(j);return N.add(r),N})}if(n.type==="session-processing-stopped"){const C=((b=(v=(w=le.get("app"))==null?void 0:w.claude)==null?void 0:v.ui)==null?void 0:b.activity)??{},S={...C,[r]:{...C[r],isProcessing:!1}};le.update("app",{claude:{ui:{activity:S}}}),(((y=S[r])==null?void 0:y.isOpened)??!1)||e(N=>{const E=new Set(N);return E.delete(r),E})}}},n=>{console.error("[useSessionRunningStatus] SSE connection error:",n)}),{isSessionRunning:t,runningSessions:s}}const jr=768,Cr=500;function xs(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=window.matchMedia(`(max-width: ${jr-1}px)`),n=()=>{e(window.innerWidth<jr)};return t.addEventListener("change",n),e(window.innerWidth<jr),()=>t.removeEventListener("change",n)},[]),!!s}function mC(){const[s,e]=h.useState(void 0);return h.useEffect(()=>{const t=()=>{const r=window.innerWidth<Cr,o=window.innerHeight<Cr&&window.innerWidth<window.innerHeight*2;e(r||o)},n=window.matchMedia(`(max-width: ${Cr-1}px)`);return n.addEventListener("change",t),window.addEventListener("orientationchange",t),t(),()=>{n.removeEventListener("change",t),window.removeEventListener("orientationchange",t)}},[]),!!s}function B(...s){return sp(qs(s))}const rh={default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},ah=ln("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive cursor-pointer",{variants:{variant:rh,size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",compact:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-1.2",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",smIcon:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 [&_svg:not([class*='size-'])]:size-3",smIconCompact:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",sic:"rounded-md gap-1.5 p-1.5 [&_svg:not([class*='size-'])]:size-3",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),de=h.forwardRef(({className:s,variant:e,size:t,asChild:n=!1,...r},o)=>{const i=n?Ds:"button";return a.jsx(i,{"data-slot":"button",className:B(ah({variant:e,size:t,className:s})),ref:o,...r})});de.displayName="Button";const We=h.forwardRef(({className:s,type:e,...t},n)=>a.jsx("input",{type:e,className:B("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:n,...t}));We.displayName="Input";const gc=h.forwardRef(({className:s,orientation:e="horizontal",decorative:t=!0,...n},r)=>a.jsx(Ii,{ref:r,decorative:t,orientation:e,className:B("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...n}));gc.displayName=Ii.displayName;const oh=Ai,ih=La,xc=h.forwardRef(({className:s,...e},t)=>a.jsx(sr,{className:B("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...e,ref:t}));xc.displayName=sr.displayName;const ch=ln("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),vc=h.forwardRef(({side:s="right",className:e,children:t,...n},r)=>a.jsxs(ih,{children:[a.jsx(xc,{}),a.jsxs(cn,{ref:r,className:B(ch({side:s}),e),...n,children:[a.jsxs(Ma,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[a.jsx(ft,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]}),t]})]}));vc.displayName=cn.displayName;const bc=({className:s,...e})=>a.jsx("div",{className:B("flex flex-col space-y-2 text-center sm:text-left",s),...e});bc.displayName="SheetHeader";const wc=h.forwardRef(({className:s,...e},t)=>a.jsx(nr,{ref:t,className:B("text-lg font-semibold text-foreground",s),...e}));wc.displayName=nr.displayName;const yc=h.forwardRef(({className:s,...e},t)=>a.jsx(rr,{ref:t,className:B("text-sm text-muted-foreground",s),...e}));yc.displayName=rr.displayName;function Eo({className:s,...e}){return a.jsx("div",{className:B("animate-pulse rounded-md bg-primary/10",s),...e})}const Fe={xs:"w-3 h-3",sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},gC={deleteButton:"text-red-600 hover:text-red-700 hover:bg-red-50"},xC={input:"bg-green-500",process:"bg-blue-500",output:"bg-red-500",text:"bg-blue-500",select:"bg-purple-500",audio:"bg-green-500",default:"bg-gray-500"},vC={base:"absolute w-4 h-4 bg-background rounded-full border-2 border-border transform -translate-y-1/2 cursor-crosshair z-10",input:"node-handle node-handle-input -left-2 top-1/2",output:"node-handle node-handle-output -right-2 top-1/2",hover:"hover:border-blue-400 hover:bg-accent",active:"border-blue-400 bg-accent"},lh={input:"w-full p-2 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background",textarea:"w-full p-3 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring resize-y bg-background",label:"text-xs font-medium text-foreground block mb-1",error:"text-destructive text-xs mt-1"},bC=.2,Je={popover:1500,skipLink:1600,tooltip:1800,backdrop:1550,draggablePopover:1560,slashCommandMenu:1565,draggablePopoverDropdown:1570,canvasGroups:1,canvasArrows:5,canvasNodes:10,canvasResizeHandles:15,nodeTextarea:10,nodeAudioButton:20,nodeQuickPanel:40,canvasChatInput:50,canvasOverlay:55,quickPanelPortal:1020,contextMenu:1030,toolbarDropdown:1510,mobileSheet:1600,commandPalette:1750,elementInspectorCollected:9998,elementInspectorTree:1e4},Es=ju,Ts=Cu,Is=Nu,hs=h.forwardRef(({className:s,sideOffset:e=4,style:t,container:n,...r},o)=>a.jsx(Su,{container:n,children:a.jsx(Pi,{ref:o,sideOffset:e,className:B("overflow-hidden rounded-md border bg-card px-3 py-1.5 text-xs text-card-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",s),style:{zIndex:Je.tooltip,...t},...r})}));hs.displayName=Pi.displayName;class dh{constructor(){ee(this,"STORAGE_KEY","ui-store")}getStore(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to parse UI store from localStorage:",e),{}}}setStore(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save UI store to localStorage:",t)}}get(e){return this.getStore()[e]}set(e,t){const n=this.getStore();n[e]=t,this.setStore(n)}update(e,t){const n=this.getStore(),r=n[e]||{};n[e]={...r,...t},this.setStore(n)}remove(e){const t=this.getStore();delete t[e],this.setStore(t)}clear(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear UI store:",e)}}getAllData(){return this.getStore()}export(){return JSON.stringify(this.getStore(),null,2)}import(e){try{const t=JSON.parse(e);return this.setStore(t),!0}catch(t){return console.error("Failed to import UI store data:",t),!1}}}const Zr=new dh,uh="16rem",ph="18rem",hh="3rem",fh="b",Sc=h.createContext(null);function Os(){const s=h.useContext(Sc);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const jc=h.forwardRef(({defaultOpen:s=!0,open:e,onOpenChange:t,className:n,style:r,children:o,...i},c)=>{const l=xs(),[d,p]=h.useState(!1),[u,f]=h.useState(()=>{const b=Zr.get("sidebar");return(b==null?void 0:b.isOpen)??s}),m=e??u,g=h.useCallback(b=>{const y=typeof b=="function"?b(m):b;t?t(y):f(y),Zr.update("sidebar",{isOpen:y})},[t,m]),x=h.useCallback(()=>l?p(b=>!b):g(b=>!b),[l,g,p]);h.useEffect(()=>{const b=y=>{y.key===fh&&(y.metaKey||y.ctrlKey)&&(y.preventDefault(),x())};return window.addEventListener("keydown",b),()=>window.removeEventListener("keydown",b)},[x]);const w=m?"expanded":"collapsed",v=h.useMemo(()=>({state:w,open:m,setOpen:g,isMobile:l,openMobile:d,setOpenMobile:p,toggleSidebar:x}),[w,m,g,l,d,p,x]);return a.jsx(Sc.Provider,{value:v,children:a.jsx(Es,{delayDuration:0,children:a.jsx("div",{style:{"--sidebar-width":uh,"--sidebar-width-icon":hh,...r},className:B("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",n),ref:c,...i,children:o})})})});jc.displayName="SidebarProvider";const Cc=h.forwardRef(({side:s="left",variant:e="sidebar",collapsible:t="offcanvas",className:n,children:r,...o},i)=>{h.useEffect(()=>{Zr.update("sidebar",{side:s,variant:e})},[s,e]);const{isMobile:c,state:l,openMobile:d,setOpenMobile:p,toggleSidebar:u}=Os();return t==="none"?a.jsx("div",{className:B("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",n),ref:i,...o,children:r}):c?a.jsx(oh,{open:d,onOpenChange:p,...o,children:a.jsxs(vc,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":ph},side:s,children:[a.jsxs(bc,{className:"sr-only",children:[a.jsx(wc,{children:"Sidebar"}),a.jsx(yc,{children:"Displays the mobile sidebar."})]}),a.jsx("div",{className:"flex h-full w-full flex-col",children:r})]})}):a.jsxs("div",{ref:i,className:"group peer hidden text-sidebar-foreground md:block","data-state":l,"data-collapsible":l==="collapsed"?t:"","data-variant":e,"data-side":s,children:[a.jsx("div",{className:B("relative bg-transparent transition-[width] duration-200 ease-linear",e==="floating"?"w-0":"w-[--sidebar-width]","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",e==="floating"||e==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),l==="expanded"&&t==="offcanvas"&&a.jsx("div",{className:"fixed inset-0 z-[55] bg-black/50",onClick:u}),a.jsx("div",{className:B("fixed inset-y-0 z-[60] hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",e==="floating"||e==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",n),...o,children:a.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:r})})]})});Cc.displayName="Sidebar";const ea=h.forwardRef(({className:s,onClick:e,...t},n)=>{const{toggleSidebar:r}=Os();return a.jsxs(de,{ref:n,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:B("h-7 w-7",s),onClick:o=>{e==null||e(o),r()},...t,children:[a.jsx(np,{}),a.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});ea.displayName="SidebarTrigger";const mh=h.forwardRef(({className:s,...e},t)=>{const{toggleSidebar:n}=Os();return a.jsx("button",{ref:t,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:n,title:"Toggle Sidebar",className:B("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...e})});mh.displayName="SidebarRail";const Nc=h.forwardRef(({className:s,...e},t)=>a.jsx("main",{ref:t,className:B("relative flex w-full flex-1 flex-col bg-background","md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow","peer-data-[collapsible=offcanvas]:ml-0 peer-data-[collapsible=offcanvas]:mr-0","peer-data-[variant=floating]:ml-0 peer-data-[variant=floating]:mr-0",s),...e}));Nc.displayName="SidebarInset";const gh=h.forwardRef(({className:s,...e},t)=>a.jsx(We,{ref:t,"data-sidebar":"input",className:B("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...e}));gh.displayName="SidebarInput";const kc=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"header",className:B("flex flex-col gap-2 p-2",s),...e}));kc.displayName="SidebarHeader";const xh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"footer",className:B("flex flex-col gap-2 p-2",s),...e}));xh.displayName="SidebarFooter";const vh=h.forwardRef(({className:s,...e},t)=>a.jsx(gc,{ref:t,"data-sidebar":"separator",className:B("mx-2 w-auto bg-sidebar-border",s),...e}));vh.displayName="SidebarSeparator";const Ec=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"content",className:B("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...e}));Ec.displayName="SidebarContent";const bh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"group",className:B("relative flex w-full min-w-0 flex-col p-2",s),...e}));bh.displayName="SidebarGroup";const wh=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?Ds:"div";return a.jsx(r,{ref:n,"data-sidebar":"group-label",className:B("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...t})});wh.displayName="SidebarGroupLabel";const yh=h.forwardRef(({className:s,asChild:e=!1,...t},n)=>{const r=e?Ds:"button";return a.jsx(r,{ref:n,"data-sidebar":"group-action",className:B("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...t})});yh.displayName="SidebarGroupAction";const Sh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"group-content",className:B("w-full text-sm",s),...e}));Sh.displayName="SidebarGroupContent";const Tc=h.forwardRef(({className:s,...e},t)=>a.jsx("ul",{ref:t,"data-sidebar":"menu",className:B("flex w-full min-w-0 flex-col gap-1",s),...e}));Tc.displayName="SidebarMenu";const Ws=h.forwardRef(({className:s,...e},t)=>a.jsx("li",{ref:t,"data-sidebar":"menu-item",className:B("group/menu-item relative",s),...e}));Ws.displayName="SidebarMenuItem";const jh=ln("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),zs=h.forwardRef(({asChild:s=!1,isActive:e=!1,variant:t="default",size:n="default",tooltip:r,className:o,...i},c)=>{const l=s?Ds:"button",{isMobile:d,state:p}=Os(),u=a.jsx(l,{ref:c,"data-sidebar":"menu-button","data-size":n,"data-active":e,className:B(jh({variant:t,size:n}),o),...i});return r?(typeof r=="string"&&(r={children:r}),a.jsxs(Ts,{children:[a.jsx(Is,{asChild:!0,children:u}),a.jsx(hs,{side:"right",align:"center",hidden:p!=="collapsed"||d,...r})]})):u});zs.displayName="SidebarMenuButton";const Ch=h.forwardRef(({className:s,asChild:e=!1,showOnHover:t=!1,...n},r)=>{const o=e?Ds:"button";return a.jsx(o,{ref:r,"data-sidebar":"menu-action",className:B("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",t&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...n})});Ch.displayName="SidebarMenuAction";const Nh=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,"data-sidebar":"menu-badge",className:B("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...e}));Nh.displayName="SidebarMenuBadge";const kh=h.forwardRef(({className:s,showIcon:e=!1,...t},n)=>{const r=h.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return a.jsxs("div",{ref:n,"data-sidebar":"menu-skeleton",className:B("flex h-8 items-center gap-2 rounded-md px-2",s),...t,children:[e&&a.jsx(Eo,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),a.jsx(Eo,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":r}})]})});kh.displayName="SidebarMenuSkeleton";const ta=h.forwardRef(({className:s,...e},t)=>a.jsx("ul",{ref:t,"data-sidebar":"menu-sub",className:B("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...e}));ta.displayName="SidebarMenuSub";const kn=h.forwardRef(({...s},e)=>a.jsx("li",{ref:e,...s}));kn.displayName="SidebarMenuSubItem";const En=h.forwardRef(({asChild:s=!1,size:e="md",isActive:t,className:n,...r},o)=>{const i=s?Ds:"a";return a.jsx(i,{ref:o,"data-sidebar":"menu-sub-button","data-size":e,"data-active":t,className:B("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",e==="sm"&&"text-xs",e==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",n),...r})});En.displayName="SidebarMenuSubButton";const Eh="audio-chunks-db",Th=1,Ct="chunks",Ze="metadata";class Ih{constructor(){ee(this,"dbPromise");ee(this,"initializationPromise");this.dbPromise=this.initDB(),this.initializationPromise=this.waitForDB()}async waitForDB(){await this.dbPromise}async waitForInitialization(){await this.initializationPromise}async initDB(){return new Promise((e,t)=>{const n=indexedDB.open(Eh,Th);n.onupgradeneeded=r=>{const o=r.target.result;if(o.objectStoreNames.contains(Ct)||o.createObjectStore(Ct),!o.objectStoreNames.contains(Ze)){const i=o.createObjectStore(Ze);i.createIndex("sessionName","sessionName",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1}),i.createIndex("chunkNumber","chunkNumber",{unique:!1})}},n.onsuccess=r=>{e(r.target.result)},n.onerror=r=>{t(new Error(`IndexedDB error: ${r.target.error}`))}})}async saveChunk(e,t){var n;if(await this.waitForInitialization(),!e.blob)throw new Error("Cannot save chunk without blob data");try{const o=(await this.dbPromise).transaction([Ze,Ct],"readwrite"),i=o.objectStore(Ze),c=o.objectStore(Ct),l={id:e.id,chunkNumber:e.chunkNumber,startTime:e.startTime.toISOString(),endTime:(n=e.endTime)==null?void 0:n.toISOString(),duration:e.duration,size:e.size??e.blob.size,name:e.name,sessionName:t,transcription:e.transcription,transcriptionStatus:e.transcriptionStatus,transcriptionError:e.transcriptionError,createdAt:new Date().toISOString(),mimeType:e.blob.type};i.put(l,e.id),c.put(e.blob,e.id),await new Promise((d,p)=>{o.oncomplete=()=>d(),o.onerror=()=>p(new Error(`Transaction failed: ${o.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to save chunk:",r),r}}async loadChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Ze,Ct],"readonly"),r=n.objectStore(Ze),o=n.objectStore(Ct),c=r.index("sessionName").getAll(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to load metadata: ${c.error}`))});if(l.length===0)return[];const d=[];for(const p of l)try{const u=o.get(p.id),f=await new Promise((m,g)=>{u.onsuccess=()=>m(u.result),u.onerror=()=>g(new Error(`Failed to load blob: ${u.error}`))});if(f){const m={id:p.id,chunkNumber:p.chunkNumber,startTime:new Date(p.startTime),endTime:p.endTime?new Date(p.endTime):void 0,duration:p.duration,blob:f,size:p.size,name:p.name,transcription:p.transcription,transcriptionStatus:p.transcriptionStatus,transcriptionError:p.transcriptionError};d.push(m)}}catch(u){console.warn(`ðŸŽ¤ðŸ“¦ðŸ’¾ âš ï¸ Failed to load chunk ${p.id}:`,u)}return d.sort((p,u)=>p.chunkNumber-u.chunkNumber),d}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to load chunks:",t),t}}async updateChunkTranscription(e,t){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Ze],"readwrite"),o=r.objectStore(Ze),i=o.get(e),c=await new Promise((d,p)=>{i.onsuccess=()=>d(i.result),i.onerror=()=>p(new Error(`Failed to get metadata: ${i.error}`))});if(!c)throw new Error(`Chunk not found: ${e}`);const l={...c,transcription:t,transcriptionStatus:"completed"};o.put(l,e),await new Promise((d,p)=>{r.oncomplete=()=>d(),r.onerror=()=>p(new Error(`Transaction failed: ${r.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription:",n),n}}async updateChunkTranscriptionStatus(e,t,n){await this.waitForInitialization();try{const o=(await this.dbPromise).transaction([Ze],"readwrite"),i=o.objectStore(Ze),c=i.get(e),l=await new Promise((p,u)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>u(new Error(`Failed to get metadata: ${c.error}`))});if(!l)throw new Error(`Chunk not found: ${e}`);const d={...l,transcriptionStatus:t,transcriptionError:n};i.put(d,e),await new Promise((p,u)=>{o.oncomplete=()=>p(),o.onerror=()=>u(new Error(`Transaction failed: ${o.error}`))})}catch(r){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription status:",r),r}}async deleteChunk(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Ze,Ct],"readwrite"),r=n.objectStore(Ze),o=n.objectStore(Ct);r.delete(e),o.delete(e),await new Promise((i,c)=>{n.oncomplete=()=>i(),n.onerror=()=>c(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunk:",t),t}}async deleteChunksBySession(e){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([Ze,Ct],"readwrite"),r=n.objectStore(Ze),o=n.objectStore(Ct),c=r.index("sessionName").getAll(e),l=await new Promise((d,p)=>{c.onsuccess=()=>d(c.result),c.onerror=()=>p(new Error(`Failed to load metadata: ${c.error}`))});for(const d of l)r.delete(d.id),o.delete(d.id);await new Promise((d,p)=>{n.oncomplete=()=>d(),n.onerror=()=>p(new Error(`Transaction failed: ${n.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunks by session:",t),t}}async getAllSessions(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Ze],"readonly").objectStore(Ze).getAll(),o=await new Promise((c,l)=>{r.onsuccess=()=>c(r.result),r.onerror=()=>l(new Error(`Failed to load all metadata: ${r.error}`))});return[...new Set(o.map(c=>c.sessionName))].sort()}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get all sessions:",e),e}}async getStorageStats(){await this.waitForInitialization();try{const r=(await this.dbPromise).transaction([Ze],"readonly").objectStore(Ze).getAll(),o=await new Promise((l,d)=>{r.onsuccess=()=>l(r.result),r.onerror=()=>d(new Error(`Failed to load all metadata: ${r.error}`))}),i=o.reduce((l,d)=>l+d.size,0),c=new Set(o.map(l=>l.sessionName)).size;return{totalChunks:o.length,totalSize:i,sessionCount:c}}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get storage stats:",e),e}}async clearAllData(){await this.waitForInitialization();try{const t=(await this.dbPromise).transaction([Ze,Ct],"readwrite"),n=t.objectStore(Ze),r=t.objectStore(Ct);n.clear(),r.clear(),await new Promise((o,i)=>{t.oncomplete=()=>o(),t.onerror=()=>i(new Error(`Transaction failed: ${t.error}`))})}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to clear all data:",e),e}}}const wt=new Ih,Nr="vocabulary-lists",Bt="default";class Ah{getAllLists(){try{const e=localStorage.getItem(Nr);return e?JSON.parse(e).map(n=>({...n,createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt)})):[this.createDefaultList()]}catch(e){return console.error("Failed to load vocabulary lists:",e),[this.createDefaultList()]}}getListById(e){return this.getAllLists().find(n=>n.id===e)??null}createList(e){const t=this.getAllLists(),n={id:`list-${Date.now()}`,name:e,createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}updateList(e,t){const n=this.getAllLists(),r=n.findIndex(o=>o.id===e);return r===-1?null:(n[r]={...n[r],...t,updatedAt:new Date},this.saveLists(n),n[r])}async deleteList(e){const t=this.getAllLists();if(t.length<=1)return console.warn("Cannot delete the last vocabulary list"),!1;if(e===Bt){const r=t.find(o=>o.id===Bt);if(r&&r.entryCount>0&&t.length===1)return console.warn("Cannot delete default list with data when it's the only list"),!1}const n=t.filter(r=>r.id!==e);return this.saveLists(n),localStorage.removeItem(`vocabulary-entries-${e}`),await wt.deleteChunksBySession(`vocabulary-session-${e}`),!0}getDefaultListId(){return this.getAllLists().find(n=>n.id===Bt)||this.createDefaultList(),Bt}updateEntryCount(e,t){this.updateList(e,{entryCount:t})}migrateOldData(){const e="vocabulary-entries",t=localStorage.getItem(e);if(!t)return!1;try{this.getAllLists().find(c=>c.id===Bt)??(r=this.createDefaultList());const o=`vocabulary-entries-${Bt}`;if(!localStorage.getItem(o)){localStorage.setItem(o,t);const c=JSON.parse(t);return this.updateEntryCount(Bt,c.length),localStorage.removeItem(e),console.log("Migrated old vocabulary data to default list"),!0}return localStorage.removeItem(e),!1}catch(n){return console.error("Failed to migrate vocabulary data:",n),!1}}createDefaultList(){const e=localStorage.getItem(Nr);let t=[];if(e)try{t=JSON.parse(e).map(i=>({...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}));const o=t.find(i=>i.id===Bt);if(o)return o}catch(r){console.error("Error parsing stored lists:",r),t=[]}const n={id:Bt,name:"Default",createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(n),this.saveLists(t),n}saveLists(e){localStorage.setItem(Nr,JSON.stringify(e))}}const kr=new Ah,sa=ku,na=Tu,ra=Eu,Ph="modulepreload",Rh=function(s){return"/"+s},To={},Ge=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let i=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=i(t.map(d=>{if(d=Rh(d),d in To)return;To[d]=!0;const p=d.endsWith(".css"),u=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":Ph,p||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),p)return new Promise((m,g)=>{f.addEventListener("load",m),f.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return r.then(i=>{for(const c of i||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})},Er=h.lazy(()=>Ge(()=>import("./HomePage-CH2r0i2H.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>({default:s.HomePage}))),Dh=h.lazy(()=>Ge(()=>import("./Chat-kmy79JDa.js"),__vite__mapDeps([7,1,8,9,2,10,4,5,11,6])).then(s=>({default:s.Chat}))),_h=h.lazy(()=>Ge(()=>import("./Settings-DkLnh0pi.js"),__vite__mapDeps([12,1,8,2,4,5,6])).then(s=>({default:s.Settings}))),Io=h.lazy(()=>Ge(()=>import("./Demo-CytqLj06.js"),__vite__mapDeps([13,1,14,5,2,15,4,6])).then(s=>({default:s.Demo}))),Ao=h.lazy(()=>Ge(()=>import("./Content-B-hwGuVv.js"),__vite__mapDeps([16,1,8,2,4,5,6])).then(s=>({default:s.Content}))),Oh=h.lazy(()=>Ge(()=>import("./TablePage-D0cTmJjf.js"),__vite__mapDeps([17,1,18,19,4,5,6,2])).then(s=>({default:s.TablePage}))),Po=h.lazy(()=>Ge(()=>import("./VocabularyPage-Ddg4R_Ij.js"),__vite__mapDeps([20,1,18,19,21,22,23,24,2,4,5,6])).then(s=>({default:s.VocabularyPage}))),Lh=h.lazy(()=>Ge(()=>import("./LiveTranscriptionPage-pLbwSKdE.js"),__vite__mapDeps([25,1,2,4,5,6])).then(s=>({default:s.LiveTranscriptionPage}))),Mh=h.lazy(()=>Ge(()=>import("./AudioPanelDemo-CSJZIYnP.js"),__vite__mapDeps([26,1,4,5,6,2])).then(s=>({default:s.AudioPanelDemo}))),Fh=h.lazy(()=>Ge(()=>import("./ClaudePage-DPyahOHy.js"),__vite__mapDeps([27,1,28,2,29,4,5,6])).then(s=>({default:s.ClaudePage}))),$h=h.lazy(()=>Ge(()=>import("./SessionDetailsPage-BmvpTSj1.js"),__vite__mapDeps([30,1,4,5,28,2,29,6])).then(s=>({default:s.SessionDetailsPage}))),Uh=h.lazy(()=>Ge(()=>import("./ForksPage-BTkCQzyO.js"),__vite__mapDeps([31,1,4,5,2,6])).then(s=>({default:s.ForksPage}))),Tr=h.lazy(()=>Ge(()=>import("./KanbanPage-H08Qd_7j.js"),__vite__mapDeps([32,1,33,14,5,2,34,35,4,36,6])).then(s=>({default:s.KanbanPage}))),Bh=h.lazy(()=>Ge(()=>import("./KanbanDataPage-D_CbtHwd.js"),__vite__mapDeps([37,1,15,14,5,2,4,6])).then(s=>({default:s.KanbanDataPage}))),Wh=h.lazy(()=>Ge(()=>import("./index-DkA0f1CK.js"),__vite__mapDeps([38,1,2,4,5,6])).then(s=>({default:s.ActionTodoPage}))),zh=h.lazy(()=>Ge(()=>import("./GlobalStatePage-DBK0iju4.js"),__vite__mapDeps([39,1,15,4,5,2,6])).then(s=>({default:s.GlobalStatePage}))),Hh=h.lazy(()=>Ge(()=>import("./GamePage-BZ6lgrps.js"),__vite__mapDeps([40,1,2,4,5,6])).then(s=>({default:s.GamePage}))),Gh=h.lazy(()=>Ge(()=>import("./NewHomeApp-DKZee14y.js"),__vite__mapDeps([41,1,6,4,5,2,42,43,44,45,46,47,48,23,24,21,49,35,50,51,52,53,34,54,55,56,57,15,58,59,60,28,61,62,63,64])).then(s=>({default:s.NewHomeApp}))),qh=h.lazy(()=>Ge(()=>import("./SttPage-Co_X75ao.js"),__vite__mapDeps([65,1,4,5,6,2])).then(s=>({default:s.SttPage})));function Vh(){return a.jsx("div",{className:"page-loader flex items-center justify-center h-full",children:a.jsx("div",{className:"page-loader-spinner animate-pulse text-muted-foreground",children:"Loading..."})})}const Mn=[{path:"/",element:Er,title:"Watcher",icon:yo,label:"Home",showInSidebar:!0},{path:"/new-home",element:Gh,title:"New Home",icon:yo,label:"New Home",showInSidebar:!0},{path:"/chat",element:Dh,title:"Chat with Ollama",icon:rp,label:"Chat",showInSidebar:!0},{path:"/settings",element:_h,title:"Settings",icon:Ft,label:"Settings",showInSidebar:!0},{path:"/claude",element:Fh,title:"Claude",icon:Br,label:"Claude",showInSidebar:!0},{path:"/claude/:sessionId",element:$h,title:"Claude",showInSidebar:!1},{path:"/claude/forks/:forkId?",element:Uh,title:"Session Forks",icon:es,label:"Forks",showInSidebar:!1},{path:"/state",element:zh,title:"Global State",icon:ap,label:"Global State",showInSidebar:!0},{path:"/game",element:Hh,title:"Multiplayer Games",icon:op,label:"Games",showInSidebar:!0},{path:"/stt",element:qh,title:"Speech to Text",icon:ar,label:"STT",showInSidebar:!0},{path:"/todo",element:Tr,title:"Todo",icon:Wr,label:"Todo",showInSidebar:!0,group:"collapsible",children:[{path:"/todo",element:Tr,title:"Todo",icon:oc,label:"Overview",showInSidebar:!0},{path:"/todo/kanban",element:Tr,title:"Kanban Board",icon:ip,label:"Kanban Board",showInSidebar:!0},{path:"/todo/kanban/data",element:Bh,title:"Kanban Data",icon:ic,label:"Data",showInSidebar:!0},{path:"/todo/action",element:Wh,title:"Action Todo",icon:cp,label:"Action-Driven",showInSidebar:!0}]},{path:"/content",element:Ao,title:"Content",icon:lp,label:"Content",showInSidebar:!0},{path:"/content/:contentId",element:Ao,title:"Content",showInSidebar:!1},{path:"/active-recording",element:Er,title:"Active Recording",icon:zr,label:"Active Recording",showInSidebar:!0},{path:"/vocabulary",element:Po,title:"Vocabulary",icon:Hr,label:"Vocabulary",showInSidebar:!0,group:"collapsible-vocabulary"},{path:"/vocabulary/:listId",element:Po,title:"Vocabulary",showInSidebar:!1},{path:"/live-transcription",element:Lh,title:"Live Transcription",icon:Gr,label:"Live Transcription",showInSidebar:!0},{path:"/table",element:Oh,title:"Table Demo",icon:qr,label:"Table Demo",showInSidebar:!0},{path:"/demo",element:Io,title:"Demo",icon:Vr,label:"Demo",showInSidebar:!0},{path:"/demo/*",element:Io,title:"Demo",showInSidebar:!1},{path:"/demo/audio-panel",element:Mh,title:"Audio Panel Demo",icon:Kr,label:"Audio Panel Demo",showInSidebar:!0},{path:"/realtime",element:Er,title:"Real-time Audio",showInSidebar:!1}];function Kh(s){const e=Mn.find(t=>t.children&&t.children.find(r=>r.path===s)?!0:t.path===s);if(e){if(e.children){const t=e.children.find(n=>n.path===s);if(t)return t.title}return e.title}for(const t of Mn){if(s.startsWith(t.path.split("/:")[0]))return t.title;if(t.children){for(const n of t.children)if(s.startsWith(n.path.split("/:")[0]))return n.title}}return"Watcher"}function Jh({logger:s,logs:e}){return a.jsx(h.Suspense,{fallback:a.jsx(Vh,{}),children:a.jsx(fu,{children:Mn.map(t=>{const n=t.element,r=a.jsx(n,{logger:s,logs:e});return t.children?t.children.map(o=>{const i=o.element;return a.jsx(bo,{path:o.path,element:a.jsx(i,{logger:s})},o.path)}):a.jsx(bo,{path:t.path,element:r},t.path)})})})}function Yh(){const{open:s,toggleSidebar:e}=Os();return a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h2",{className:"text-lg font-semibold px-2",children:"Menu"}),s&&a.jsx(de,{variant:"ghost",size:"icon",onClick:e,className:"h-7 w-7",children:a.jsx(_s,{className:"w-4 h-4"})})]})}function Xh(){const s=Ti(),e=_a(),{isMobile:t,setOpen:n,setOpenMobile:r}=Os(),{actions:o}=fc(),[i,c]=h.useState([]),[l,d]=h.useState(!1),[p,u]=h.useState(!1);h.useEffect(()=>{const x=kr.getAllLists();c(x)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/vocabulary")&&d(!0)},[e.pathname]),h.useEffect(()=>{e.pathname.startsWith("/todo")&&u(!0)},[e.pathname]);const f=h.useCallback((x,w)=>{x.ctrlKey||x.metaKey||x.button===1||(x.preventDefault(),s(w),t?r(!1):n(!1))},[s,t,n,r]),m=h.useCallback(async()=>{try{o.info("Fetching logs from /logs endpoint...");const w=await(await fetch("/logs")).json();console.log("Logs response:",w),o.info("Logs endpoint response logged to console")}catch(x){o.error(`Failed to fetch logs: ${x}`),console.error("Failed to fetch logs:",x)}t?r(!1):n(!1)},[o,t,n,r]),g=h.useCallback(()=>{const x=prompt("Enter a name for the new vocabulary list:");if(x!=null&&x.trim()){const w=kr.createList(x.trim());c(kr.getAllLists()),s(`/vocabulary/${w.id}`),t?r(!1):n(!1)}},[s,t,n,r]);return a.jsxs(Tc,{children:[Mn.filter(x=>x.showInSidebar).map(x=>x.group==="collapsible"&&x.children?a.jsx(sa,{open:p,onOpenChange:u,className:"group/collapsible",children:a.jsxs(Ws,{children:[a.jsx(na,{asChild:!0,children:a.jsxs(zs,{children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label,a.jsx(yt,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),a.jsx(ra,{children:a.jsx(ta,{children:x.children.filter(w=>w.showInSidebar).map(w=>a.jsx(kn,{children:a.jsx(En,{asChild:!0,isActive:e.pathname===w.path,children:a.jsxs("a",{href:w.path,onClick:v=>f(v,w.path),children:[w.icon&&a.jsx(w.icon,{className:"w-4 h-4"}),w.label]})})},w.path))})})]})},x.path):x.group==="collapsible-vocabulary"?a.jsx(sa,{open:l,onOpenChange:d,className:"group/collapsible",children:a.jsxs(Ws,{children:[a.jsx(na,{asChild:!0,children:a.jsxs(zs,{children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label,a.jsx(yt,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),a.jsx(ra,{children:a.jsxs(ta,{children:[i.map(w=>a.jsx(kn,{children:a.jsx(En,{asChild:!0,isActive:e.pathname===`/vocabulary/${w.id}`,children:a.jsxs("a",{href:`/vocabulary/${w.id}`,onClick:v=>f(v,`/vocabulary/${w.id}`),children:[w.name,w.entryCount>0&&a.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:w.entryCount})]})})},w.id)),a.jsx(kn,{children:a.jsxs(En,{onClick:g,children:[a.jsx(Ks,{className:"w-4 h-4"}),"Create New List"]})})]})})]})},x.path):a.jsx(Ws,{children:a.jsx(zs,{asChild:!0,isActive:e.pathname===x.path,children:a.jsxs("a",{href:x.path,onClick:w=>f(w,x.path),children:[x.icon&&a.jsx(x.icon,{className:"w-4 h-4"}),x.label]})})},x.path)),a.jsx(Ws,{children:a.jsxs(zs,{onClick:m,children:[a.jsx(Js,{className:"w-4 h-4"}),"Logs"]})})]})}function Qh(){return a.jsxs(Cc,{variant:"floating",collapsible:"offcanvas",children:[a.jsx(kc,{children:a.jsx(Yh,{})}),a.jsx(Ec,{children:a.jsx(Xh,{})})]})}const aa=s=>{if(s==null)return s;if(typeof s=="number")return Math.round(s*10)/10;if(Array.isArray(s))return s.map(aa);if(typeof s=="object"){const e={};for(const[t,n]of Object.entries(s))e[t]=aa(n);return e}return s};class za{constructor(e="http://localhost:3030/client-logs",t=5e3,n=!1){ee(this,"baseUrl");ee(this,"timeout");ee(this,"sessionId");ee(this,"shouldLogToConsole");this.baseUrl=e,this.timeout=t,this.shouldLogToConsole=n,this.sessionId=`todo-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async sendLogs(e,t,n){const r=t?aa(t):void 0;this.shouldLogToConsole&&console.log(`[${n||"client.log"}] ${e}`,r?JSON.stringify(r,null,2):"");try{const o={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),customLogFile:n,logs:{[e]:[`${e}`]},metadata:r},i=await this.fetchWithTimeout(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw console.error("[ClientLogs] HTTP error:",i.status),new Error(`HTTP ${i.status}`);return await i.json()}catch(o){return console.error("[ClientLogs] Failed to send:",o),null}}sendBeacon(e,t){console.log("[ClientLogs] Sending beacon:",{message:e,metadata:t});try{const n={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),logs:{[e]:[`${e}`]},metadata:t};if(typeof navigator<"u"&&navigator.sendBeacon){const r=this.baseUrl.startsWith("http")?this.baseUrl:`${window.location.origin}${this.baseUrl}`,o=new Blob([JSON.stringify(n)],{type:"application/json"}),i=navigator.sendBeacon(r,o);return i?console.log("[ClientLogs] Beacon accepted"):console.warn("[ClientLogs] Beacon rejected (queue full?)"),i}else return console.log("[ClientLogs] sendBeacon not available, using fetch fallback"),fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),keepalive:!0}).catch(r=>{console.error("[ClientLogs] Fetch fallback failed:",r)}),!0}catch(n){return console.error("[ClientLogs] Failed to send beacon:",n),!1}}async clearLogs(e="client.log",t){if(t&&typeof window<"u"&&!window.location.pathname.includes(t))return!1;try{const n=`${this.baseUrl}?customLogFile=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?(await r.json()).success:(console.error("[ClientLogs] Failed to clear logs:",r.status),!1)}catch(n){return console.error("[ClientLogs] Failed to clear logs:",n),!1}}async clearJsonLogs(e){try{const n=`${this.baseUrl.replace("/client-logs","/client-logs-json")}?filename=${encodeURIComponent(e)}&confirm=true`,r=await this.fetchWithTimeout(n,{method:"DELETE",headers:{"Content-Type":"application/json"}});return r.ok?!0:(console.error("[ClientLogs] Failed to clear JSON logs:",r.status),!1)}catch(t){return console.error("[ClientLogs] Failed to clear JSON logs:",t),!1}}async clearLogsAndAddVersion(e,t,n){const r=await this.clearLogs(e,n);return r&&await this.sendLogs("startup",{v:t},e),r}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}new za;const Zh={theme:"system",setTheme:()=>null},Ic=h.createContext(Zh);function ef({children:s,defaultTheme:e="system",storageKey:t="vite-ui-theme",...n}){const[r,o]=h.useState(()=>localStorage.getItem(t)||e);h.useEffect(()=>{const c=window.document.documentElement;if(c.classList.remove("light","dark"),r==="system"){const l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";c.classList.add(l);return}c.classList.add(r)},[r]);const i={theme:r,setTheme:c=>{localStorage.setItem(t,c),o(c)}};return a.jsx(Ic.Provider,{...n,value:i,children:s})}const tf=()=>{const s=h.useContext(Ic);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s};function sf(){const{theme:s,setTheme:e}=tf(),t=()=>{e(s==="dark"?"light":"dark")},n=s==="dark"||s==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return a.jsx(de,{onClick:t,variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","aria-label":n?"Switch to light mode":"Switch to dark mode",children:n?a.jsx(dp,{className:"h-5 w-5"}):a.jsx(up,{className:"h-5 w-5"})})}const st=Iu,pt=Au,Tn=Pu,Qe=h.forwardRef(({className:s,align:e="center",sideOffset:t=4,style:n,...r},o)=>a.jsx(Ru,{children:a.jsx(Ri,{ref:o,align:e,sideOffset:t,style:{zIndex:Je.popover,...n},className:B("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...r})}));Qe.displayName=Ri.displayName;function nf(s){return"initialConfig"in s&&typeof s.children=="function"}function ur(s){if(nf(s)){const{storageKey:m,initialConfig:g,children:x,prefix:w="watcher-"}=s,v=`${w}${m}`,[b,y]=h.useState(()=>{try{const N=localStorage.getItem(v);if(N)return JSON.parse(N)}catch(N){console.error(`Failed to load config from localStorage (${v}):`,N)}return g}),[C,S]=h.useState(!1);h.useEffect(()=>{try{localStorage.setItem(v,JSON.stringify(b))}catch(N){console.error(`Failed to save config to localStorage (${v}):`,N)}},[b,v]);const j=h.useMemo(()=>({buttonLabel:N,icon:E=a.jsx(Ft,{className:"h-4 w-4"}),variant:R="ghost",size:D="icon",buttonClassName:T="",contentClassName:L="",contentStyle:_,align:P="end",side:G="bottom",title:$,children:Y})=>a.jsxs(st,{open:C,onOpenChange:S,"data-test":"config-popover",children:[a.jsx(pt,{asChild:!0,children:a.jsx(de,{variant:R,size:D,className:`config-button ${T}`,title:$||"Configuration","data-test":"config-button",children:N?a.jsxs(a.Fragment,{children:[E,N&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:N})]}):E})}),a.jsxs(Qe,{className:`config-panel ${L}`,style:{zIndex:Je.draggablePopoverDropdown,..._},align:P,side:G,"data-test":"config-panel",onInteractOutside:A=>{A.target.closest(".config-panel")&&A.preventDefault()},onPointerDownOutside:A=>{A.target.closest(".config-panel")&&A.preventDefault()},children:[$&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:$})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:Y})]})]}),[C,S]);return a.jsx(a.Fragment,{children:x(b,y,j)})}const{children:e,buttonLabel:t,icon:n=a.jsx(Ft,{className:"h-4 w-4"}),variant:r="ghost",size:o="icon",buttonClassName:i="",contentClassName:c="",align:l="end",side:d="bottom",title:p}=s,[u,f]=h.useState(!1);return a.jsxs(st,{open:u,onOpenChange:f,"data-test":"config-popover",children:[a.jsx(pt,{asChild:!0,children:a.jsx(de,{variant:r,size:o,className:`config-button ${i}`,title:p||"Configuration","data-test":"config-button",children:t?a.jsxs(a.Fragment,{children:[n,t&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:t})]}):n})}),a.jsxs(Qe,{className:`config-panel ${c}`,style:{zIndex:Je.draggablePopoverDropdown},align:l,side:d,"data-test":"config-panel",onInteractOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},onPointerDownOutside:m=>{m.target.closest(".config-panel")&&m.preventDefault()},children:[p&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:p})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:e})]})]})}const rf=ln("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),je=h.forwardRef(({className:s,...e},t)=>a.jsx(Di,{ref:t,className:B(rf(),s),...e}));je.displayName=Di.displayName;const Ot=h.forwardRef(({className:s,...e},t)=>a.jsx(_i,{className:B("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",s),...e,ref:t,children:a.jsx(Du,{className:B("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));Ot.displayName=_i.displayName;const af=()=>{const s=h.useRef(null),[e,t]=h.useState(!1),[n,r]=h.useState(!1),[o,i]=h.useState(null),c=()=>{try{const p=le.export(),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=document.createElement("a");m.href=f,m.download=`global-state-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(f),Ne.success("Global state exported successfully")}catch(p){console.error("Error exporting state:",p),Ne.error("Failed to export global state")}},l=()=>{var p;(p=s.current)==null||p.click()},d=p=>{var m;const u=(m=p.target.files)==null?void 0:m[0];if(!u)return;t(!0),i(null);const f=new FileReader;f.onload=g=>{var w;const x=(w=g.target)==null?void 0:w.result;if(typeof x=="string")try{n&&le.reset(),le.import(x)?(i({success:!0}),Ne.success("Global state imported successfully")):(i({success:!1,error:"Invalid JSON format"}),Ne.error("Failed to import: invalid JSON format"))}catch(v){console.error("Error importing state:",v);const b=v instanceof Error?v.message:"Unknown error";i({success:!1,error:b}),Ne.error(`Failed to import: ${b}`)}else console.error("Failed to read file content."),Ne.error("Failed to read file content"),i({success:!1,error:"Failed to read file"});t(!1),s.current&&(s.current.value="")},f.onerror=g=>{console.error("Error reading file:",g),Ne.error("Error reading file"),i({success:!1,error:"Error reading file"}),t(!1),s.current&&(s.current.value="")},f.readAsText(u)};return a.jsxs("div",{className:"space-y-4","data-test":"global-state-io-panel",children:[a.jsxs("div",{"data-test":"global-state-export-section",children:[a.jsx(je,{className:"text-sm font-medium",children:"Export"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download global state as JSON"}),a.jsxs(de,{variant:"outline",size:"sm",onClick:c,className:"w-full","data-test":"global-state-export-button",children:[a.jsx(pp,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),a.jsxs("div",{"data-test":"global-state-import-section",children:[a.jsx(je,{className:"text-sm font-medium",children:"Import"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import global state from a JSON file"}),a.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"global-state-replace-mode-control",children:[a.jsxs("div",{children:[a.jsx(je,{htmlFor:"global-state-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),a.jsx(Ot,{id:"global-state-replace-mode",checked:n,onCheckedChange:r,disabled:e,"data-test":"global-state-replace-mode-switch"})]}),a.jsxs(de,{variant:"outline",size:"sm",onClick:l,disabled:e,className:"w-full","data-test":"global-state-import-select-file-button",children:[a.jsx(hp,{className:"h-4 w-4 mr-2"}),e?"Importing...":"Select File"]}),a.jsx("input",{type:"file",ref:s,accept:".json",style:{display:"none"},onChange:d,"data-test":"global-state-import-file-input"})]}),o&&a.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"global-state-import-result",children:[o.success&&a.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"global-state-import-success",children:[a.jsx(fp,{className:"h-3 w-3"}),a.jsx("span",{children:"Import successful"})]}),!o.success&&a.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"global-state-import-error",children:[a.jsx(cc,{className:"h-3 w-3"}),a.jsx("span",{children:o.error||"Import failed"})]})]})]})},of=()=>a.jsx(ur,{storageKey:"global-state-io",title:"State Import/Export",icon:a.jsx(ic,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end","data-test":"global-state-io-button",children:a.jsx(af,{})});new za;const cf={primaryColor:"blue",setPrimaryColor:()=>null},lf=h.createContext(cf),df=()=>{const s=h.useContext(lf);if(s===void 0)throw new Error("usePrimaryColor must be used within a PrimaryColorProvider");return s};function uf({onColorSelect:s,selectedHue:e=217}){const t=h.useRef(null),[n,r]=h.useState(!1),[o,i]=h.useState(e);h.useEffect(()=>{n||i(e)},[e,n]),h.useEffect(()=>{const g=t.current;if(!g)return;const x=g.getContext("2d");if(!x)return;const w=g.width,v=g.height,b=40,y=(v-b)/2,C=`hsl(${o} 70% 90%)`;x.fillStyle=C,x.fillRect(0,0,w,v);for(let j=0;j<w;j+=1){const N=j/w*360;x.fillStyle=`hsl(${N}, 100%, 50%)`,x.fillRect(j,y,1,b)}x.strokeStyle="#ccc",x.lineWidth=2,x.strokeRect(0,y,w,b);const S=o/360*w;x.strokeStyle="#000",x.lineWidth=3,x.beginPath(),x.moveTo(S,y-8),x.lineTo(S,y+b+8),x.stroke(),x.strokeStyle="#fff",x.lineWidth=1,x.beginPath(),x.moveTo(S,y-8),x.lineTo(S,y+b+8),x.stroke()},[o]);const c=g=>{const x=t.current;if(!x)return;const w=x.getBoundingClientRect(),v=g.clientX-w.left,b=Math.round(v/x.width*360),y=Math.max(0,Math.min(360,b));i(y),s(`${y} 70% 60%`)},l=()=>r(!0),d=()=>r(!1),p=g=>{n&&c(g)},u=()=>r(!0),f=()=>r(!1),m=g=>{if(!n)return;const x=t.current;if(!x)return;const w=x.getBoundingClientRect(),v=g.touches[0].clientX-w.left,b=Math.round(v/x.width*360),y=Math.max(0,Math.min(360,b));i(y),s(`${y} 70% 60%`)};return a.jsxs("div",{className:"color-strip-container flex flex-col items-center gap-3",children:[a.jsx("canvas",{ref:t,width:200,height:80,onClick:c,onMouseDown:l,onMouseUp:d,onMouseMove:p,onMouseLeave:()=>r(!1),onTouchStart:u,onTouchEnd:f,onTouchMove:m,className:"color-strip cursor-pointer rounded touch-none"}),a.jsx("div",{className:"color-info text-center",children:a.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hue: ",o,"Â°"]})})]})}const Fn=Ai,wC=_u,pf=La,Ac=h.forwardRef(({className:s,style:e,...t},n)=>a.jsx(sr,{ref:n,className:B("fixed inset-0 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),style:{zIndex:Je.popover,...e},...t}));Ac.displayName=sr.displayName;const $n=h.forwardRef(({className:s,children:e,style:t,...n},r)=>a.jsxs(pf,{children:[a.jsx(Ac,{}),a.jsxs(cn,{ref:r,className:B("fixed left-[50%] top-[50%] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),style:{zIndex:Je.popover,...t},...n,children:[e,a.jsxs(Ma,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ft,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));$n.displayName=cn.displayName;const Un=({className:s,...e})=>a.jsx("div",{className:B("flex flex-col space-y-1.5 text-center sm:text-left",s),...e});Un.displayName="DialogHeader";const hf=({className:s,...e})=>a.jsx("div",{className:B("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...e});hf.displayName="DialogFooter";const Zs=h.forwardRef(({className:s,...e},t)=>a.jsx(nr,{ref:t,className:B("text-lg font-semibold leading-none tracking-tight",s),...e}));Zs.displayName=nr.displayName;const Pc=h.forwardRef(({className:s,...e},t)=>a.jsx(rr,{ref:t,className:B("text-sm text-muted-foreground",s),...e}));Pc.displayName=rr.displayName;const ff=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose","white","black"],mf={slate:"#64748b",gray:"#6b7280",zinc:"#71717a",neutral:"#737373",stone:"#78716c",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e",white:"#ffffff",black:"#000000"},gf={slate:"hsl(215 16% 47%)",gray:"hsl(218 11% 43%)",zinc:"hsl(220 13% 47%)",neutral:"hsl(0 0% 45%)",stone:"hsl(12 6% 44%)",red:"hsl(0 84% 60%)",orange:"hsl(24 97% 61%)",amber:"hsl(45 96% 71%)",yellow:"hsl(54 100% 68%)",lime:"hsl(84 85% 67%)",green:"hsl(142 72% 64%)",emerald:"hsl(160 84% 65%)",teal:"hsl(168 86% 55%)",cyan:"hsl(191 87% 55%)",sky:"hsl(198 93% 60%)",blue:"hsl(217 91% 60%)",indigo:"hsl(226 86% 61%)",violet:"hsl(259 84% 63%)",purple:"hsl(280 85% 64%)",fuchsia:"hsl(289 86% 66%)",pink:"hsl(330 81% 60%)",rose:"hsl(356 84% 61%)",white:"hsl(0 0% 100%)",black:"hsl(0 0% 0%)"};function xf({isOpen:s,onOpenChange:e}){const{primaryColor:t,setPrimaryColor:n}=df(),[r,o]=h.useState(217),[i,c]=h.useState(t),l=p=>{c(p),n(p);const u=gf[p],f=parseInt(u.split(" ")[0].replace("hsl(",""));o(f)},d=p=>{const u=parseInt(p.split(" ")[0]);o(u);const f=`${u} 70% 90%`,m=`${u} 70% 85%`,g=`${u} 70% 80%`,x=`${u} 70% 70%`;n(`hsl-${u}`),c(`hsl-${u}`);const w=window.document.documentElement;w.style.setProperty("--background",f),w.style.setProperty("--card",m),w.style.setProperty("--tab",g),w.style.setProperty("--active",x)};return a.jsx(Fn,{open:s,onOpenChange:e,children:a.jsxs($n,{className:"theme-settings-dialog sm:max-w-3xl",children:[a.jsxs(Un,{children:[a.jsx(Zs,{className:"theme-settings-title",children:"Theme Settings"}),a.jsx(Pc,{className:"theme-settings-description",children:"Choose a predefined color or use the color wheel for custom colors"})]}),a.jsxs("div",{className:"predefined-colors-section mb-6",children:[a.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Predefined Colors"}),a.jsx("div",{className:"predefined-colors-grid grid grid-cols-12 gap-2",children:ff.map(p=>a.jsx("button",{type:"button",title:p,onClick:()=>l(p),className:B("color-button w-8 h-8 rounded-full border-2 cursor-pointer transition-all","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","hover:scale-110",i===p?"ring-2 ring-ring ring-offset-2 scale-110":"border-muted",p==="white"&&"border-neutral-300"),style:{backgroundColor:mf[p]},"aria-label":`Select ${p} theme`},p))})]}),a.jsxs("div",{className:"theme-wheel-container flex gap-6 items-start",children:[a.jsxs("div",{className:"flex-shrink-0",children:[a.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Custom Color"}),a.jsx(uf,{onColorSelect:d,selectedHue:r})]}),a.jsxs("div",{className:"flex-1 space-y-3",children:[a.jsx("div",{className:"theme-preview-title",children:a.jsx("p",{className:"text-sm font-medium text-foreground",children:"Live Preview:"})}),a.jsx("div",{className:"theme-preview-bg p-4 rounded-lg border-2",style:{backgroundColor:`hsl(${r} 70% 90%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-700",children:"Background"})}),a.jsx("div",{className:"theme-preview-card p-4 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 85%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Card"})}),a.jsx("div",{className:"theme-preview-tab p-3 rounded-lg border",style:{backgroundColor:`hsl(${r} 70% 80%)`},children:a.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Tab"})}),a.jsx("div",{className:"theme-preview-active p-3 rounded-lg border font-semibold",style:{backgroundColor:`hsl(${r} 70% 70%)`},children:a.jsx("p",{className:"text-xs text-gray-900",children:"Active/Selected"})})]})]})]})})}function Ro({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1);return a.jsxs(a.Fragment,{children:[a.jsx(ur,{title:"Settings",icon:a.jsx(Ft,{className:"h-5 w-5"}),variant:s,size:e,align:"end",storageKey:"app-settings","data-test":"global-config-button",children:a.jsxs("div",{className:"settings-panel space-y-3","data-test":"config-panel",children:[a.jsxs("div",{className:"theme-toggle-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme"}),a.jsx(sf,{})]}),a.jsxs("div",{className:"theme-settings-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme Colors"}),a.jsxs(de,{variant:"outline",size:"sm",onClick:()=>n(!0),className:"w-full flex items-center gap-2","data-test":"customize-colors-button",children:[a.jsx(mp,{className:"h-4 w-4"}),"Customize Colors"]})]}),a.jsx("div",{className:"divider my-3 border-t"}),a.jsxs("div",{className:"state-import-export-section",children:[a.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Global State"}),a.jsx(of,{})]})]})}),a.jsx(xf,{isOpen:t,onOpenChange:n})]})}class vf{constructor(){ee(this,"isActive",!1);ee(this,"callbacks",new Set);ee(this,"tooltipOwnerId",null);ee(this,"panelOwnerId",null);ee(this,"clickOwnerId",null)}subscribe(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}getState(){return this.isActive}toggle(){this.isActive=!this.isActive,this.notifySubscribers()}setState(e){this.isActive!==e&&(this.isActive=e,this.notifySubscribers())}activate(){this.setState(!0)}deactivate(){this.setState(!1)}claimTooltip(e){this.tooltipOwnerId=e}releaseTooltip(e){this.tooltipOwnerId===e&&(this.tooltipOwnerId=null)}canRenderTooltip(e){return this.tooltipOwnerId===null?e===null:this.tooltipOwnerId===e}claimPanel(e){this.panelOwnerId=e}releasePanel(e){this.panelOwnerId===e&&(this.panelOwnerId=null)}canRenderPanel(e){return this.panelOwnerId===null?e===null:this.panelOwnerId===e}claimClickHandling(e){this.clickOwnerId=e}releaseClickHandling(e){this.clickOwnerId===e&&(this.clickOwnerId=null)}canHandleClicks(e){return this.clickOwnerId===null?e===null:this.clickOwnerId===e}notifySubscribers(){this.callbacks.forEach(e=>e(this.isActive))}}const vt=new vf,Vt=({isVisible:s,onClose:e,title:t,children:n,className:r,initialPosition:o,triggerPosition:i,shouldCloseManually:c=!1,resizable:l=!1,initialSize:d,onSizeChange:p,onPositionChange:u,headerActions:f,footer:m,portalContainer:g,showPinButton:x=!1,showInspectorButton:w=!1,zIndex:v=Je.draggablePopover,anchorOrigin:b="top-left"})=>{const y=i??(typeof o=="object"?o:void 0),C=h.useMemo(()=>{if(!d)return null;const H=window.innerWidth,ce=window.innerHeight,ue=32;return{width:Math.min(d.width,H-ue),height:d.height?Math.min(d.height,ce-ue):void 0}},[d]),S=h.useMemo(()=>{const H=window.innerWidth,ce=window.innerHeight,ue=(C==null?void 0:C.width)??320,pe=(C==null?void 0:C.height)??400;if(!y||o==="center")return{x:Math.max(16,(H-ue)/2),y:Math.max(16,(ce-pe)/2)};let he=y.x,ve=y.y;return he+ue>H&&(he=H-ue-16),he<16&&(he=16),ve+pe>ce&&(ve=ce-pe-32),ve<16&&(ve=16),{x:he,y:ve}},[y,C,o]),[j,N]=h.useState(null),[E,R]=h.useState(C),[D,T]=h.useState(!1),[L,_]=h.useState(!1),[P,G]=h.useState(null),[$,Y]=h.useState({x:0,y:0}),[A,X]=h.useState({x:0,y:0,width:0,height:0,posX:0,posY:0}),[I,k]=h.useState(!1),[M,U]=h.useState(!1),q=h.useRef(null),W=h.useRef(null),V=h.useRef(!1),ie=b!=="top-left"&&typeof o=="object",[K,ne]=h.useState(!ie);h.useEffect(()=>{if(!s||V.current||b==="top-left"){s&&b==="top-left"&&ne(!0);return}typeof o=="object"&&requestAnimationFrame(()=>{if(!W.current)return;const H=W.current.getBoundingClientRect();let ce=o.x,ue=o.y;(b==="top-right"||b==="bottom-right")&&(ce=o.x-H.width),(b==="bottom-left"||b==="bottom-right")&&(ue=o.y-H.height);const pe=16;ce=Math.max(pe,Math.min(ce,window.innerWidth-H.width-pe)),ue=Math.max(pe,Math.min(ue,window.innerHeight-H.height-pe)),N({x:ce,y:ue}),V.current=!0,ne(!0)})},[s,o,b]),h.useEffect(()=>{s||(V.current=!1,ne(!(b!=="top-left"&&typeof o=="object")))},[s,b,o]);const me=H=>{const ce=H.target;if(!(ce.tagName==="INPUT"||ce.tagName==="TEXTAREA"||ce.tagName==="SELECT"||ce.tagName==="BUTTON"||ce.closest("button")!==null||ce.closest("input")!==null||ce.closest("textarea")!==null||ce.closest("select")!==null||ce.classList.contains("resize-handle"))&&(H.preventDefault(),W.current)){const pe=W.current.getBoundingClientRect(),he=pe.left,ve=pe.top;N({x:he,y:ve}),T(!0),Y({x:H.clientX-he,y:H.clientY-ve})}},ge=H=>{const ce=H.target;if(ce.tagName==="INPUT"||ce.tagName==="TEXTAREA"||ce.tagName==="SELECT"||ce.tagName==="BUTTON"||ce.closest("button")!==null||ce.closest("input")!==null||ce.closest("textarea")!==null||ce.closest("select")!==null||ce.classList.contains("resize-handle"))return;const pe=H.touches[0];if(pe&&W.current){const he=W.current.getBoundingClientRect(),ve=he.left,Te=he.top;N({x:ve,y:Te}),T(!0),Y({x:pe.clientX-ve,y:pe.clientY-Te})}},oe=H=>ce=>{if(ce.stopPropagation(),W.current){const ue=W.current.getBoundingClientRect();_(!0),G(H),X({x:ce.clientX,y:ce.clientY,width:ue.width,height:ue.height,posX:ue.left,posY:ue.top})}},Se=H=>ce=>{ce.stopPropagation();const ue=ce.touches[0];if(ue&&W.current){const pe=W.current.getBoundingClientRect();_(!0),G(H),X({x:ue.clientX,y:ue.clientY,width:pe.width,height:pe.height,posX:pe.left,posY:pe.top})}},xe=H=>{H.stopPropagation(),vt.toggle();const ce=vt.getState();Ne.success(`Element Inspector ${ce?"activated":"deactivated"}`,{description:ce?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};h.useEffect(()=>{if(c||!s||I||M){q.current&&(clearTimeout(q.current),q.current=null);return}return q.current=setTimeout(()=>{e()},2e3),()=>{q.current&&(clearTimeout(q.current),q.current=null)}},[s,I,M,e,c]),h.useEffect(()=>{s||(U(!1),N(null))},[s]);const Pe=()=>{U(!0)};h.useEffect(()=>{if(!D)return;const H=document.body.style.userSelect;document.body.style.userSelect="none";const ce=he=>{N({x:he.clientX-$.x,y:he.clientY-$.y})},ue=he=>{const ve=he.touches[0];ve&&(he.preventDefault(),N({x:ve.clientX-$.x,y:ve.clientY-$.y}))},pe=()=>{T(!1),te(!0),j&&u&&u(j)};return document.addEventListener("mousemove",ce),document.addEventListener("mouseup",pe),document.addEventListener("touchmove",ue,{passive:!1}),document.addEventListener("touchend",pe),()=>{document.removeEventListener("mousemove",ce),document.removeEventListener("mouseup",pe),document.removeEventListener("touchmove",ue),document.removeEventListener("touchend",pe),document.body.style.userSelect=H}},[D,$,j,u]),h.useEffect(()=>{if(!L||!P)return;const H=300,ce=200,ue=document.body.style.userSelect;document.body.style.userSelect="none";const pe=(ke,z)=>{const O=ke-A.x,Q=z-A.y;let we=A.width,re=A.height,be=A.posX,J=A.posY;if(P.includes("e"))we=Math.max(H,A.width+O);else if(P.includes("w")){const fe=A.width-O;fe>=H?(we=fe,be=A.posX+O):(we=H,be=A.posX+(A.width-H))}if(P.includes("s"))re=Math.max(ce,A.height+Q);else if(P.includes("n")){const fe=A.height-Q;fe>=ce?(re=fe,J=A.posY+Q):(re=ce,J=A.posY+(A.height-ce))}return{newWidth:we,newHeight:re,newPosX:be,newPosY:J}},he=ke=>{const{newWidth:z,newHeight:O,newPosX:Q,newPosY:we}=pe(ke.clientX,ke.clientY);R({width:z,height:O}),(P.includes("w")||P.includes("n"))&&N({x:Q,y:we})},ve=ke=>{const z=ke.touches[0];if(!z)return;ke.preventDefault();const{newWidth:O,newHeight:Q,newPosX:we,newPosY:re}=pe(z.clientX,z.clientY);R({width:O,height:Q}),(P.includes("w")||P.includes("n"))&&N({x:we,y:re})},Te=()=>{_(!1),G(null),E&&E.height&&p&&p({width:E.width,height:E.height}),j&&u&&u(j)};return document.addEventListener("mousemove",he),document.addEventListener("mouseup",Te),document.addEventListener("touchmove",ve,{passive:!1}),document.addEventListener("touchend",Te),()=>{document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",Te),document.removeEventListener("touchmove",ve),document.removeEventListener("touchend",Te),document.body.style.userSelect=ue}},[L,P,A,E,j,p,u]),h.useEffect(()=>{if(!s||c)return;const H=ce=>{ce.key==="Escape"&&e()};return document.addEventListener("keydown",H),()=>{document.removeEventListener("keydown",H)}},[s,e,c]);const[ae,te]=h.useState(!1);h.useEffect(()=>{s||te(!1)},[s]);const F=(ae||D)&&j?j:S;if(!s)return null;const Z=a.jsxs("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:v},"data-test":"draggable-popover-wrapper",children:[!c&&a.jsx("div",{className:"backdrop-click-outside fixed inset-0",style:{zIndex:Je.backdrop,pointerEvents:"auto"},onClick:e,"aria-hidden":"true","data-test":"draggable-popover-backdrop"}),a.jsxs("div",{ref:W,className:qs("fixed","w-80 bg-background text-foreground border border-border rounded-lg shadow-lg","flex flex-col",l&&"relative",r),style:{zIndex:v,pointerEvents:"auto",fontSize:"16px",opacity:K?1:0,top:F?`${F.y}px`:"auto",right:"auto",left:F?`${F.x}px`:"auto",bottom:"auto",cursor:L&&P?P==="nw"||P==="se"?"nwse-resize":P==="ne"||P==="sw"?"nesw-resize":P==="n"||P==="s"?"ns-resize":P==="e"||P==="w"?"ew-resize":"default":"default",width:E?`${E.width}px`:void 0,height:E!=null&&E.height?`${E.height}px`:void 0,maxHeight:"calc(100vh - 2rem)"},onMouseEnter:Pe,"data-test":"draggable-popover-container",children:[a.jsxs("div",{className:"header px-3 py-2 border-b border-border flex justify-between items-center cursor-grab active:cursor-grabbing",onMouseDown:me,onTouchStart:ge,"data-test":"draggable-popover-header",children:[a.jsx("h3",{className:"title-text text-sm font-semibold select-none","data-test":"draggable-popover-title",children:t}),a.jsxs("div",{className:"action-buttons flex items-center gap-1","data-test":"draggable-popover-actions",children:[f,w&&a.jsx("button",{className:"inspector-button p-1 rounded hover:bg-accent transition-colors",onClick:xe,onMouseDown:H=>H.stopPropagation(),"aria-label":"Toggle Element Inspector",title:"Toggle Element Inspector","data-test":"draggable-popover-inspector-button",children:a.jsx(gp,{size:14})}),x&&a.jsx("button",{className:qs("pin-button p-1 rounded hover:bg-accent transition-colors",I&&"bg-accent text-accent-foreground"),onClick:H=>{H.stopPropagation(),k(!I)},onMouseDown:H=>H.stopPropagation(),"aria-label":I?"Unpin popover":"Pin popover",title:I?"Unpin":"Pin","data-test":"draggable-popover-pin-button",children:a.jsx(xp,{size:14,className:qs(I&&"fill-current")})}),a.jsx("button",{className:"close-button p-1 rounded hover:bg-accent transition-colors",onClick:H=>{H.stopPropagation(),e()},onMouseDown:H=>H.stopPropagation(),"aria-label":"Close popover",title:"Close","data-test":"draggable-popover-close-button",children:a.jsx(ft,{size:14})})]})]}),a.jsx("div",{className:"flex-1 min-h-0 overflow-auto","data-test":"draggable-popover-content",children:n}),m&&a.jsx("div",{className:"flex-shrink-0 border-t border-border","data-test":"draggable-popover-footer",children:m}),l&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"resize-handle absolute top-0 left-0 w-3 h-3 cursor-nwse-resize",onMouseDown:oe("nw"),onTouchStart:Se("nw"),"data-test":"draggable-popover-resize-nw"}),a.jsx("div",{className:"resize-handle absolute top-0 right-0 w-3 h-3 cursor-nesw-resize",onMouseDown:oe("ne"),onTouchStart:Se("ne"),"data-test":"draggable-popover-resize-ne"}),a.jsx("div",{className:"resize-handle absolute bottom-0 left-0 w-3 h-3 cursor-nesw-resize",onMouseDown:oe("sw"),onTouchStart:Se("sw"),"data-test":"draggable-popover-resize-sw"}),a.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-3 h-3 cursor-nwse-resize",onMouseDown:oe("se"),onTouchStart:Se("se"),style:{background:"linear-gradient(135deg, transparent 50%, currentColor 50%)",opacity:.3},"data-test":"draggable-popover-resize-se"}),a.jsx("div",{className:"resize-handle absolute top-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:oe("n"),onTouchStart:Se("n"),"data-test":"draggable-popover-resize-n"}),a.jsx("div",{className:"resize-handle absolute bottom-0 left-3 right-3 h-1 cursor-ns-resize",onMouseDown:oe("s"),onTouchStart:Se("s"),"data-test":"draggable-popover-resize-s"}),a.jsx("div",{className:"resize-handle absolute left-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:oe("w"),onTouchStart:Se("w"),"data-test":"draggable-popover-resize-w"}),a.jsx("div",{className:"resize-handle absolute right-0 top-3 bottom-3 w-1 cursor-ew-resize",onMouseDown:oe("e"),onTouchStart:Se("e"),"data-test":"draggable-popover-resize-e"})]})]})]});return Oa.createPortal(Z,g??document.body)},Do=5,bf=300,wf=800,_o={indicatorBg:"#dc2626",indicatorText:"#ffffff"},Oo={background:"rgba(254, 205, 211, 0.5)",border:"#06b6d4"},oa={success:"#22c55e",hover:"#3b82f6"},Bn={click:{bg:"#dbeafe",text:"#2563eb"},drag:{bg:"#fef3c7",text:"#d97706"},type:{bg:"#dcfce7",text:"#16a34a"}};function Lo(s){const e=s.getAttribute("data-test");if(e)return`[data-test="${e}"]`;const t=s.id;if(t&&!t.match(/^[:\d]|css-/))return`#${t}`;const n=Array.from(s.classList).filter(r=>!r.startsWith("css-")&&!r.match(/^[a-z]+-[\da-f]{6,}/i)).join(".");return n?`.${n}`:s.tagName.toLowerCase()}function yf(s,e,t,n){const r=Math.abs(t-s),o=Math.abs(n-e);return r>Do||o>Do}function Sf({targetRef:s,enabled:e}){const[t,n]=h.useState([]),[r,o]=h.useState(!1),i=h.useRef({isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}),c=h.useRef(null),l=h.useRef(null),d=h.useRef({element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""}),p=h.useCallback(y=>{n(C=>[...C,y])},[]),u=h.useCallback(()=>{const y=d.current;y.element&&(y.element.style.backgroundColor=y.originalBackground,y.element.style.outline=y.originalOutline,y.element.style.outlineOffset=y.originalOutlineOffset,d.current={element:null,originalBackground:"",originalOutline:"",originalOutlineOffset:""})},[]),f=h.useCallback(y=>{if(!r)return;const C=y.target;if(!C||C.closest('[data-test="capture-panel-v2"]')){u();return}const S=Lo(C);i.current={isDragging:!1,startX:y.clientX,startY:y.clientY,startTime:Date.now(),selector:S,element:C}},[r,u]),m=h.useCallback(y=>{if(!r)return;const C=i.current;if(!C.element)return;const S=y.clientX,j=y.clientY,N=Date.now()-C.startTime;yf(C.startX,C.startY,S,j)?p({type:"drag",timestamp:C.startTime,data:{startX:C.startX,startY:C.startY,endX:S,endY:j,selector:C.selector,duration:N}}):p({type:"click",timestamp:C.startTime,data:{x:C.startX,y:C.startY,selector:C.selector}}),i.current={isDragging:!1,startX:0,startY:0,startTime:0,selector:"",element:null}},[r,p]),g=h.useCallback(y=>{if(!r)return;const C=y.target;if(!C||!("value"in C))return;const S=Lo(C),j=C.value;c.current&&window.clearTimeout(c.current),l.current={selector:S,value:j},c.current=window.setTimeout(()=>{l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},bf)},[r,p]),x=h.useCallback(y=>{if(!r)return;const C=y.target;if(C){if(C.closest('[data-test="capture-panel-v2"]')||C.closest('[data-test="recording-panel"]')){u();return}d.current.element!==C&&(u(),d.current={element:C,originalBackground:C.style.backgroundColor,originalOutline:C.style.outline,originalOutlineOffset:C.style.outlineOffset},C.style.backgroundColor=Oo.background,C.style.outline=`2px solid ${Oo.border}`,C.style.outlineOffset="1px")}},[r,u]);h.useEffect(()=>{if(!r)return;const y=document;return y.addEventListener("pointerdown",f),y.addEventListener("pointerup",m),y.addEventListener("pointermove",x),y.addEventListener("input",g,!0),()=>{y.removeEventListener("pointerdown",f),y.removeEventListener("pointerup",m),y.removeEventListener("pointermove",x),y.removeEventListener("input",g,!0),u(),c.current&&window.clearTimeout(c.current)}},[e,r,s,f,m,x,g,u]);const w=h.useCallback(()=>{o(!0)},[]),v=h.useCallback(()=>{o(!1),u(),c.current&&(window.clearTimeout(c.current),c.current=null),l.current&&(p({type:"type",timestamp:Date.now(),data:{selector:l.current.selector,value:l.current.value}}),l.current=null)},[p,u]),b=h.useCallback(()=>{n([])},[]);return{interactions:t,isRecording:r,startRecording:w,stopRecording:v,clearRecording:b}}function Rc(s){try{switch(s.type){case"click":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.click();const n=t.style.outline;t.style.outline=`3px solid ${oa.success}`,setTimeout(()=>{t.style.outline=n},300)},300),Ne.success(`Clicked: ${e.selector}`)):Ne.error(`Element not found: ${e.selector}`);break}case"drag":{const e=s.data,t=document.querySelector(e.selector);t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const n=t.getBoundingClientRect(),r=new PointerEvent("pointerdown",{bubbles:!0,clientX:n.left+(e.startX-n.left),clientY:n.top+(e.startY-n.top)}),o=new PointerEvent("pointerup",{bubbles:!0,clientX:e.endX,clientY:e.endY});t.dispatchEvent(r),setTimeout(()=>{t.dispatchEvent(o)},Math.min(e.duration,500))},300),Ne.success(`Dragged: ${e.selector}`)):Ne.error(`Element not found: ${e.selector}`);break}case"type":{const e=s.data,t=document.querySelector(e.selector);t&&"value"in t?(t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{t.focus(),t.value=e.value,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));const n=t.style.outline;t.style.outline=`3px solid ${oa.success}`,setTimeout(()=>{t.style.outline=n},300)},300),Ne.success(`Typed into: ${e.selector}`)):Ne.error(`Input not found: ${e.selector}`);break}}}catch(e){Ne.error(`Replay failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async function jf(s,e){Ne.info(`Replaying ${e+1} interaction${e>0?"s":""}...`);for(let t=0;t<=e;t++)Rc(s[t]),t<e&&await new Promise(n=>setTimeout(n,wf))}let as=null;function Cf(s){switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function Nf(s){Dc();const e=Cf(s);try{const t=document.querySelector(e);if(t){const n=t.getBoundingClientRect();n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth||t.scrollIntoView({behavior:"smooth",block:"center"}),as={element:t,originalOutline:t.style.outline,originalOutlineOffset:t.style.outlineOffset},t.style.outline=`3px solid ${oa.hover}`,t.style.outlineOffset="2px"}}catch{}}function Dc(){as&&(as.element.style.outline=as.originalOutline,as.element.style.outlineOffset=as.originalOutlineOffset,as=null)}function kf(s,e){const t=s-e;return t<1e3?`+${t}ms`:t<6e4?`+${(t/1e3).toFixed(1)}s`:`+${(t/6e4).toFixed(1)}m`}function Ef({type:s}){switch(s){case"click":return a.jsx(Ua,{className:"w-3 h-3"});case"drag":return a.jsx($a,{className:"w-3 h-3"});case"type":return a.jsx(Fa,{className:"w-3 h-3"})}}function Tf({interaction:s}){switch(s.type){case"click":{const e=s.data;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-click-details",children:["at (",e.x,", ",e.y,") â†’ ",a.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}case"drag":{const e=s.data;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-drag-details",children:["(",e.startX,", ",e.startY,") â†’ (",e.endX,", ",e.endY,") [",e.duration,"ms]"]})}case"type":{const e=s.data,t=e.value.length>30?`${e.value.slice(0,30)}...`:e.value;return a.jsxs("span",{className:"text-xs text-gray-500","data-test":"interaction-type-details",children:['"',t,'" â†’ ',a.jsx("code",{className:"bg-gray-100 px-1 rounded",children:e.selector})]})}}}function If({interactions:s,isRecording:e,onExport:t,onClear:n}){const r=s.length>0?s[0].timestamp:0;return a.jsxs("div",{className:"flex flex-col h-full","data-test":"recording-panel",children:[a.jsxs("div",{className:"flex items-center justify-between p-2 border-b",style:{backgroundColor:"#f9fafb"},"data-test":"recording-panel-header",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium",style:{color:"#6b7280"},children:"Recordings"}),e&&a.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium animate-pulse",style:{backgroundColor:_o.indicatorBg,color:_o.indicatorText},"data-test":"recording-indicator",children:[a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-white"}),"REC"]}),a.jsxs("span",{className:"text-xs",style:{color:"#9ca3af"},"data-test":"interaction-count",children:["(",s.length,")"]})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:t,disabled:s.length===0,title:"Export as JSON","data-test":"export-recording-button",children:a.jsx(or,{className:"w-3 h-3"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:n,disabled:s.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:a.jsx(St,{className:"w-3 h-3"})})]})]}),a.jsx("div",{className:"flex-1 overflow-auto p-2","data-test":"recording-timeline",children:s.length===0?a.jsx("div",{className:"flex items-center justify-center h-full text-xs text-gray-400","data-test":"empty-recordings",children:e?"Recording... Click or type to capture interactions":"No recordings yet"}):a.jsx("div",{className:"space-y-1",children:s.map((o,i)=>a.jsxs("div",{className:"flex items-start gap-2 p-1.5 rounded hover:bg-gray-100 cursor-pointer group transition-colors relative",onClick:()=>Rc(o),onMouseEnter:()=>Nf(o),onMouseLeave:Dc,title:"Click to replay this interaction","data-test":"recorded-interaction",children:[a.jsx("button",{className:"absolute top-1 right-1 w-5 h-5 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-blue-100 hover:bg-blue-200 text-blue-600",onClick:c=>{c.stopPropagation(),jf(s,i)},title:`Replay all ${i+1} interaction${i>0?"s":""} up to here`,"data-test":"replay-up-to-button",children:a.jsx(vp,{className:"w-3 h-3"})}),a.jsxs("div",{className:"flex flex-col items-center",children:[a.jsxs("div",{className:"w-5 h-5 rounded-full flex items-center justify-center relative",style:{backgroundColor:Bn[o.type].bg,color:Bn[o.type].text},"data-test":"interaction-icon",children:[a.jsx("span",{className:"group-hover:hidden",children:a.jsx(Ef,{type:o.type})}),a.jsx(lc,{className:"w-3 h-3 hidden group-hover:block"})]}),i<s.length-1&&a.jsx("div",{className:"w-px h-3 bg-gray-200","data-test":"timeline-connector"})]}),a.jsxs("div",{className:"flex-1 min-w-0 pr-6",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs font-medium capitalize","data-test":"interaction-type",children:o.type}),a.jsx("span",{className:"text-xs text-gray-400","data-test":"interaction-time",children:kf(o.timestamp,r)}),a.jsx("span",{className:"text-xs text-green-600 opacity-0 group-hover:opacity-100 transition-opacity","data-test":"replay-hint",children:"â–¶ replay"})]}),a.jsx(Tf,{interaction:o})]})]},`${o.timestamp}-${i}`))})})]})}const Wt="watcher:recording-sessions";function Af(){const[s,e]=h.useState([]);h.useEffect(()=>{try{const u=localStorage.getItem(Wt);u&&e(JSON.parse(u))}catch(u){console.warn("[SessionStorage] Failed to load from localStorage:",u)}},[]);const t=h.useCallback((u,f,m)=>{const g={id:`session-${Date.now()}`,name:u,description:f,savedAt:Date.now(),interactions:m,sourceUrl:window.location.href};return e(x=>{const w=[...x,g];return localStorage.setItem(Wt,JSON.stringify(w)),w}),Ne.success("Session saved!"),g},[]),n=h.useCallback(u=>{const f=localStorage.getItem(Wt);if(!f)return;const g=JSON.parse(f).find(x=>x.id===u);return g&&Ne.success("Session loaded!"),g},[]),r=h.useCallback(u=>{e(f=>{const m=f.filter(g=>g.id!==u);return localStorage.setItem(Wt,JSON.stringify(m)),m}),Ne.success("Session deleted")},[]),o=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>x.id===u?{...x,...f}:x);return localStorage.setItem(Wt,JSON.stringify(g)),g}),Ne.success("Session updated")},[]),i=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(w=>{if(w.id!==u)return w;const v=[...w.interactions];return v[f]=m,{...w,interactions:v}});return localStorage.setItem(Wt,JSON.stringify(x)),x}),Ne.success("Interaction updated")},[]),c=h.useCallback((u,f)=>{e(m=>{const g=m.map(x=>{if(x.id!==u)return x;const w=x.interactions.filter((v,b)=>b!==f);return{...x,interactions:w}});return localStorage.setItem(Wt,JSON.stringify(g)),g}),Ne.success("Interaction deleted")},[]),l=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(w=>{if(w.id!==u)return w;const v=[...w.interactions];return v.splice(f,0,m),{...w,interactions:v}});return localStorage.setItem(Wt,JSON.stringify(x)),x}),Ne.success("Interaction inserted")},[]),d=h.useCallback((u,f,m)=>{e(g=>{const x=g.map(w=>{if(w.id!==u)return w;const v=[...w.interactions];return v[f]=m,{...w,interactions:v}});return localStorage.setItem(Wt,JSON.stringify(x)),x}),Ne.success("Interaction replaced")},[]),p=h.useCallback(()=>{try{const u=localStorage.getItem(Wt);if(!u)return;const f=JSON.parse(u);return f.length===0?void 0:f[f.length-1]}catch{return}},[]);return{savedSessions:s,saveSession:t,loadSession:n,deleteSession:r,updateSession:o,updateInteraction:i,deleteInteraction:c,insertInteraction:l,replaceInteraction:d,getLastSession:p}}const _c=h.createContext(null);function Ut({open:s,onOpenChange:e,defaultOpen:t,...n}){const[r,o]=h.useState(t??!1),i=s!==void 0,c=i?s:r,l=h.useCallback(u=>{i||o(u),e==null||e(u)},[i,e]),d=h.useCallback(()=>{l(!c)},[c,l]),p=h.useMemo(()=>({toggle:d,isOpen:c}),[d,c]);return a.jsx(_c.Provider,{value:p,children:a.jsx(Lu,{open:c,onOpenChange:l,...n})})}const yC=Wu,Kt=Ou,It=h.forwardRef(({className:s,children:e,onPointerDown:t,hideChevron:n,...r},o)=>{const i=h.useContext(_c),c=h.useCallback(l=>{if(i!=null&&i.isOpen){l.preventDefault(),i.toggle();return}t==null||t(l)},[i,t]);return a.jsxs(Oi,{ref:o,className:B("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),onPointerDown:c,...r,children:[e,!n&&a.jsx(Mu,{asChild:!0,children:a.jsx(ut,{className:"h-4 w-4 opacity-50"})})]})});It.displayName=Oi.displayName;const Oc=h.forwardRef(({className:s,...e},t)=>a.jsx(Fi,{ref:t,className:B("flex cursor-default items-center justify-center py-1",s),...e,children:a.jsx(ir,{className:"h-4 w-4"})}));Oc.displayName=Fi.displayName;const Lc=h.forwardRef(({className:s,...e},t)=>a.jsx($i,{ref:t,className:B("flex cursor-default items-center justify-center py-1",s),...e,children:a.jsx(ut,{className:"h-4 w-4"})}));Lc.displayName=$i.displayName;const At=h.forwardRef(({className:s,children:e,position:t="popper",style:n,container:r,...o},i)=>a.jsx(Fu,{container:r??void 0,children:a.jsxs(Li,{ref:i,style:{zIndex:Je.tooltip,...n},className:B("relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:t,...o,children:[a.jsx(Oc,{}),a.jsx($u,{className:B("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),a.jsx(Lc,{})]})}));At.displayName=Li.displayName;const Pf=h.forwardRef(({className:s,...e},t)=>a.jsx(Ui,{ref:t,className:B("px-2 py-1.5 text-sm font-semibold",s),...e}));Pf.displayName=Ui.displayName;const Oe=h.forwardRef(({className:s,children:e,...t},n)=>a.jsxs(Mi,{ref:n,className:B("relative flex w-full cursor-default select-none items-start rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[a.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center mt-0.5",children:a.jsx(Uu,{children:a.jsx(ct,{className:"h-4 w-4"})})}),a.jsx(Bu,{className:"flex-1",children:e})]}));Oe.displayName=Mi.displayName;const Rf=h.forwardRef(({className:s,...e},t)=>a.jsx(Bi,{ref:t,className:B("-mx-1 my-1 h-px bg-muted",s),...e}));Rf.displayName=Bi.displayName;function Df({onSaveSession:s,onLoadSession:e,onManageSessions:t,disabled:n=!1,portalContainer:r}){const o=i=>{switch(i){case"save":s();break;case"load":e();break;case"manage":t();break}};return a.jsxs(Ut,{value:"",onValueChange:o,children:[a.jsx(It,{className:"h-6 w-6 p-0 border-0 bg-transparent hover:bg-accent rounded",hideChevron:!0,disabled:n,title:"More options","data-test":"recording-more-options-trigger",children:a.jsx(bp,{className:"w-3 h-3"})}),a.jsxs(At,{container:r,"data-test":"recording-more-options-content",children:[a.jsx(Oe,{value:"save","data-test":"recording-option-save",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Cn,{className:"w-3 h-3"}),a.jsx("span",{children:"Save Session"})]})}),a.jsx(Oe,{value:"load","data-test":"recording-option-load",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(dc,{className:"w-3 h-3"}),a.jsx("span",{children:"Load Session"})]})}),a.jsx(Oe,{value:"manage","data-test":"recording-option-manage",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(wp,{className:"w-3 h-3"}),a.jsx("span",{children:"Manage Sessions"})]})})]})]})}function Mo({interaction:s,onSave:e,onCancel:t,onPickSelector:n}){var R,D,T,L,_,P,G,$,Y,A,X,I,k,M,U;const[r,o]=h.useState((s==null?void 0:s.type)??"click"),[i,c]=h.useState(_f(s)??""),[l,d]=h.useState(((D=(R=s==null?void 0:s.data)==null?void 0:R.x)==null?void 0:D.toString())??"0"),[p,u]=h.useState(((L=(T=s==null?void 0:s.data)==null?void 0:T.y)==null?void 0:L.toString())??"0"),[f,m]=h.useState(((P=(_=s==null?void 0:s.data)==null?void 0:_.startX)==null?void 0:P.toString())??"0"),[g,x]=h.useState((($=(G=s==null?void 0:s.data)==null?void 0:G.startY)==null?void 0:$.toString())??"0"),[w,v]=h.useState(((A=(Y=s==null?void 0:s.data)==null?void 0:Y.endX)==null?void 0:A.toString())??"0"),[b,y]=h.useState(((I=(X=s==null?void 0:s.data)==null?void 0:X.endY)==null?void 0:I.toString())??"0"),[C,S]=h.useState(((M=(k=s==null?void 0:s.data)==null?void 0:k.duration)==null?void 0:M.toString())??"100"),[j,N]=h.useState(((U=s==null?void 0:s.data)==null?void 0:U.value)??"");h.useEffect(()=>{s||(c(""),d("0"),u("0"),m("0"),x("0"),v("0"),y("0"),S("100"),N(""))},[r,s]);const E=()=>{const q=(s==null?void 0:s.timestamp)??Date.now();let W;switch(r){case"click":W={x:parseInt(l,10)||0,y:parseInt(p,10)||0,selector:i};break;case"drag":W={startX:parseInt(f,10)||0,startY:parseInt(g,10)||0,endX:parseInt(w,10)||0,endY:parseInt(b,10)||0,selector:i,duration:parseInt(C,10)||100};break;case"type":W={selector:i,value:j};break}e({type:r,timestamp:q,data:W})};return a.jsxs("div",{className:"space-y-3 p-3","data-test":"interaction-editor-form",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"Interaction Type"}),a.jsxs(Ut,{value:r,onValueChange:q=>o(q),children:[a.jsx(It,{className:"h-8","data-test":"interaction-type-select",children:a.jsx(Kt,{})}),a.jsxs(At,{children:[a.jsx(Oe,{value:"click",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ua,{className:"w-3 h-3"}),"Click"]})}),a.jsx(Oe,{value:"drag",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx($a,{className:"w-3 h-3"}),"Drag"]})}),a.jsx(Oe,{value:"type",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Fa,{className:"w-3 h-3"}),"Type"]})})]})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"CSS Selector"}),a.jsxs("div",{className:"flex gap-1",children:[a.jsx(We,{value:i,onChange:q=>c(q.target.value),placeholder:'e.g., [data-test="button"]',className:"h-8 text-xs flex-1","data-test":"interaction-selector-input"}),n&&a.jsx(de,{variant:"outline",size:"sm",className:"h-8 px-2",onClick:n,title:"Pick from page","data-test":"pick-selector-button",children:a.jsx(yp,{className:"w-3 h-3"})})]})]}),r==="click"&&a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"X"}),a.jsx(We,{type:"number",value:l,onChange:q=>d(q.target.value),className:"h-8 text-xs","data-test":"click-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"Y"}),a.jsx(We,{type:"number",value:p,onChange:q=>u(q.target.value),className:"h-8 text-xs","data-test":"click-y-input"})]})]}),r==="drag"&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"Start X"}),a.jsx(We,{type:"number",value:f,onChange:q=>m(q.target.value),className:"h-8 text-xs","data-test":"drag-start-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"Start Y"}),a.jsx(We,{type:"number",value:g,onChange:q=>x(q.target.value),className:"h-8 text-xs","data-test":"drag-start-y-input"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"End X"}),a.jsx(We,{type:"number",value:w,onChange:q=>v(q.target.value),className:"h-8 text-xs","data-test":"drag-end-x-input"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"End Y"}),a.jsx(We,{type:"number",value:b,onChange:q=>y(q.target.value),className:"h-8 text-xs","data-test":"drag-end-y-input"})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"Duration (ms)"}),a.jsx(We,{type:"number",value:C,onChange:q=>S(q.target.value),className:"h-8 text-xs","data-test":"drag-duration-input"})]})]}),r==="type"&&a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-xs",children:"Value to type"}),a.jsx(We,{value:j,onChange:q=>N(q.target.value),placeholder:"Text to type...",className:"h-8 text-xs","data-test":"type-value-input"})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx(de,{variant:"ghost",size:"sm",onClick:t,"data-test":"cancel-edit-button",children:"Cancel"}),a.jsx(de,{size:"sm",onClick:E,disabled:!i,"data-test":"save-edit-button",children:s?"Update":"Add"})]})]})}function _f(s){if(s)switch(s.type){case"click":return s.data.selector;case"drag":return s.data.selector;case"type":return s.data.selector}}function Of({session:s,onBack:e,onUpdateSession:t,onUpdateInteraction:n,onDeleteInteraction:r,onInsertInteraction:o,onStartInsertRecord:i,onStartReplaceRecord:c}){const[l,d]=h.useState(!1),[p,u]=h.useState(!1),[f,m]=h.useState(s.name),[g,x]=h.useState(s.description),[w,v]=h.useState(null),[b,y]=h.useState(null),C=()=>{f.trim()&&(t({name:f.trim()}),d(!1))},S=()=>{t({description:g.trim()}),u(!1)},j=D=>{w!==null?(n(w,D),v(null)):b!==null&&(o(b,D),y(null))},N=D=>{switch(D){case"click":return a.jsx(Ua,{className:"w-3 h-3"});case"drag":return a.jsx($a,{className:"w-3 h-3"});case"type":return a.jsx(Fa,{className:"w-3 h-3"})}},E=D=>{switch(D.type){case"click":{const T=D.data;return`Click at (${T.x}, ${T.y})`}case"drag":return`Drag ${D.data.duration}ms`;case"type":{const T=D.data;return`Type "${T.value.length>20?`${T.value.slice(0,20)}...`:T.value}"`}}},R=D=>{switch(D.type){case"click":return D.data.selector;case"drag":return D.data.selector;case"type":return D.data.selector}};return w!==null?a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-interaction-form",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>v(null),"data-test":"cancel-edit-interaction",children:a.jsx(Sr,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium",children:["Edit Interaction #",w+1]})]}),a.jsx(Mo,{interaction:s.interactions[w],onSave:j,onCancel:()=>v(null)})]}):b!==null?a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-add-form",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>y(null),"data-test":"cancel-add-interaction",children:a.jsx(Sr,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-sm font-medium",children:["Add Interaction at #",b+1]})]}),a.jsx(Mo,{onSave:j,onCancel:()=>y(null)})]}):a.jsxs("div",{className:"flex flex-col h-full","data-test":"session-editor-view",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b",children:[a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:e,"data-test":"session-editor-back",children:a.jsx(Sr,{className:"w-4 h-4"})}),a.jsx("span",{className:"text-sm font-medium",children:"Edit Session"})]}),a.jsxs("div",{className:"flex-1 overflow-auto p-3 space-y-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-gray-500",children:"Name"}),l?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(We,{value:f,onChange:D=>m(D.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:D=>D.key==="Enter"&&C(),"data-test":"session-name-input"}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:C,children:a.jsx(ct,{className:"w-3 h-3 text-green-600"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{d(!1),m(s.name)},children:a.jsx(ft,{className:"w-3 h-3 text-gray-500"})})]}):a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm flex-1","data-test":"session-name-display",children:s.name}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>d(!0),"data-test":"edit-session-name",children:a.jsx(Nn,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("label",{className:"text-xs text-gray-500",children:"Description"}),p?a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(We,{value:g,onChange:D=>x(D.target.value),className:"h-7 text-sm flex-1",autoFocus:!0,onKeyDown:D=>D.key==="Enter"&&S(),"data-test":"session-description-input"}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:S,children:a.jsx(ct,{className:"w-3 h-3 text-green-600"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>{u(!1),x(s.description)},children:a.jsx(ft,{className:"w-3 h-3 text-gray-500"})})]}):a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-sm flex-1 text-gray-600","data-test":"session-description-display",children:s.description||"(no description)"}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>u(!0),"data-test":"edit-session-description",children:a.jsx(Nn,{className:"w-3 h-3"})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("label",{className:"text-xs text-gray-500",children:["Interactions (",s.interactions.length,")"]})}),a.jsxs("div",{className:"space-y-1","data-test":"session-interactions-list",children:[a.jsx(Fo,{index:0,onAddManual:()=>y(0),onAddRecord:()=>i(0)}),s.interactions.map((D,T)=>a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50 group","data-test":"session-interaction",children:[a.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:Bn[D.type].bg,color:Bn[D.type].text},children:N(D.type)}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"text-xs font-medium",children:E(D)}),a.jsx("code",{className:"text-xs text-gray-400 truncate block",children:R(D)})]}),a.jsxs("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:[a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>v(T),title:"Edit","data-test":"edit-interaction-button",children:a.jsx(Nn,{className:"w-3 h-3"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>c(T),title:"Replace by recording","data-test":"replace-interaction-button",children:a.jsx(On,{className:"w-3 h-3"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-red-500 hover:text-red-600",onClick:()=>r(T),title:"Delete","data-test":"delete-interaction-button",children:a.jsx(St,{className:"w-3 h-3"})})]})]}),a.jsx(Fo,{index:T+1,onAddManual:()=>y(T+1),onAddRecord:()=>i(T+1)})]},`${D.timestamp}-${T}`))]})]})]})]})}function Fo({index:s,onAddManual:e,onAddRecord:t}){return a.jsx("div",{className:"flex items-center justify-center py-1 group opacity-0 hover:opacity-100 transition-opacity","data-test":"insert-point",children:a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsxs(de,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-blue-500 hover:text-blue-600 hover:bg-blue-50",onClick:e,title:"Add manually","data-test":"insert-manual-button",children:[a.jsx(Ks,{className:"w-3 h-3 mr-1"}),"Manual"]}),a.jsxs(de,{variant:"ghost",size:"sm",className:"h-5 px-2 text-xs text-green-500 hover:text-green-600 hover:bg-green-50",onClick:t,title:"Record new action","data-test":"insert-record-button",children:[a.jsx(Ys,{className:"w-3 h-3 mr-1"}),"Record"]})]})})}function Lf({isOpen:s,savedSessions:e,onLoad:t,onDelete:n,onUpdateSession:r,onUpdateInteraction:o,onDeleteInteraction:i,onInsertInteraction:c,onStartInsertRecord:l,onStartReplaceRecord:d,onClose:p,portalContainer:u}){const[f,m]=h.useState(null);if(!s)return null;const g=f?e.find(v=>v.id===f):null,x=v=>new Date(v).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),w=()=>{m(null)};return g?a.jsx(Vt,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:500},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:a.jsx(Of,{session:g,onBack:w,onUpdateSession:v=>r(g.id,v),onUpdateInteraction:(v,b)=>o(g.id,v,b),onDeleteInteraction:v=>i(g.id,v),onInsertInteraction:(v,b)=>c(g.id,v,b),onStartInsertRecord:v=>l(g.id,v),onStartReplaceRecord:v=>d(g.id,v)})}):a.jsx(Vt,{isVisible:s,onClose:p,title:"Session Manager",initialPosition:{x:window.innerWidth/2-225,y:80},initialSize:{width:450,height:400},resizable:!0,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,portalContainer:u,children:a.jsx("div",{className:"p-3 h-full overflow-auto","data-test":"session-manager-body",children:e.length===0?a.jsx("div",{className:"text-sm italic text-center py-8 text-gray-400","data-test":"session-manager-empty",children:"No saved sessions yet"}):a.jsx("div",{className:"space-y-2","data-test":"session-manager-list",children:e.map(v=>a.jsxs("div",{className:"flex items-center gap-2 p-2 rounded border hover:bg-gray-50","data-test":"session-item",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"text-sm font-medium truncate","data-test":"session-name",children:v.name}),v.description&&a.jsx("div",{className:"text-xs text-gray-500 truncate","data-test":"session-description",children:v.description}),a.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-2",children:[a.jsx("span",{"data-test":"session-date",children:x(v.savedAt)}),a.jsx("span",{children:"Â·"}),a.jsxs("span",{"data-test":"session-interaction-count",children:[v.interactions.length," interaction",v.interactions.length!==1?"s":""]})]})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>t(v.id),title:"Load session","data-test":"session-load",children:a.jsx(dc,{className:"w-4 h-4 text-blue-500"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>m(v.id),title:"Edit session","data-test":"session-edit",children:a.jsx(Nn,{className:"w-4 h-4 text-gray-500"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>n(v.id),title:"Delete session","data-test":"session-delete",children:a.jsx(St,{className:"w-4 h-4 text-red-500"})})]})]},v.id))})})})}function $o({variant:s="ghost",size:e="icon"}){const[t,n]=h.useState(!1),[r,o]=h.useState(!1),[i,c]=h.useState(!1),[l,d]=h.useState(""),[p,u]=h.useState(""),[f,m]=h.useState({type:"none"}),{interactions:g,isRecording:x,startRecording:w,stopRecording:v,clearRecording:b}=Sf({targetRef:null,enabled:!0}),y=Af();h.useCallback(Y=>{f.type==="insert"?(y.insertInteraction(f.sessionId,f.atIndex,Y),m({type:"none"}),v(),Ne.success("Interaction inserted!")):f.type==="replace"&&(y.replaceInteraction(f.sessionId,f.atIndex,Y),m({type:"none"}),v(),Ne.success("Interaction replaced!"))},[f,y,v]);const C=h.useCallback(()=>{x?(v(),n(!1),Ne.success(`Stopped recording. Captured ${g.length} interactions.`)):(w(),n(!1),Ne.info("Recording started. Click, drag, or type to capture."))},[x,g.length,w,v]),S=h.useCallback(()=>{const Y={interactions:g,exportedAt:new Date().toISOString(),url:window.location.href},A=new Blob([JSON.stringify(Y,null,2)],{type:"application/json"}),X=URL.createObjectURL(A),I=document.createElement("a");I.href=X,I.download=`recording-${Date.now()}.json`,I.click(),URL.revokeObjectURL(X),Ne.success("Recording exported!")},[g]),j=h.useCallback(()=>{b(),Ne.success("Recording cleared")},[b]),N=h.useCallback(()=>{n(!1)},[]),E=h.useCallback(()=>{n(!0)},[]),R=h.useCallback(()=>{if(g.length===0){Ne.error("No interactions to save");return}d(`Session ${new Date().toLocaleString()}`),u(""),c(!0)},[g.length]),D=h.useCallback(()=>{if(!l.trim()){Ne.error("Please enter a name");return}y.saveSession(l.trim(),p.trim(),g),c(!1),d(""),u("")},[l,p,g,y]),T=h.useCallback(()=>{const Y=y.getLastSession();Y?(b(),Ne.info(`Would load session: ${Y.name}`)):Ne.info("No saved sessions. Use 'Manage Sessions' to view all.")},[y,b]),L=h.useCallback(()=>{o(!0)},[]),_=h.useCallback(Y=>{const A=y.loadSession(Y);A&&(b(),Ne.success(`Loaded: ${A.name}`),o(!1))},[y,b]),P=h.useCallback((Y,A)=>{m({type:"insert",sessionId:Y,atIndex:A}),w(),o(!1),Ne.info("Recording... Perform an action to insert it.")},[w]),G=h.useCallback((Y,A)=>{m({type:"replace",sessionId:Y,atIndex:A}),w(),o(!1),Ne.info("Recording... Perform an action to replace.")},[w]),$=a.jsxs(a.Fragment,{children:[a.jsxs(de,{variant:x?"destructive":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:C,"data-test":"record-toggle-button",children:[a.jsx(Ys,{className:"w-3 h-3 mr-1",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0}),x?"Stop":"Record"]}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:S,disabled:g.length===0,title:"Export as JSON","data-test":"export-recording-button",children:a.jsx(or,{className:"w-3 h-3"})}),a.jsx(de,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:j,disabled:g.length===0,title:"Clear recordings","data-test":"clear-recording-button",children:a.jsx(St,{className:"w-3 h-3"})}),a.jsx(Df,{onSaveSession:R,onLoadSession:T,onManageSessions:L})]});return a.jsxs(a.Fragment,{children:[a.jsx(de,{variant:s,size:e,onClick:x?C:E,title:x?"Stop Recording":"Open Recorder","data-test":"global-record-button",className:x?"text-red-500 hover:text-red-400":"",children:a.jsx(Ys,{className:"h-5 w-5",fill:x?"currentColor":"none",style:x?{animation:"pulse 1s infinite"}:void 0})}),x&&a.jsx("div",{className:"fixed inset-0 z-40 pointer-events-none",style:{backgroundColor:"rgba(220, 38, 38, 0.03)"},"data-test":"global-recording-overlay"}),f.type!=="none"&&a.jsxs("div",{className:"fixed top-2 left-1/2 -translate-x-1/2 z-50 bg-blue-500 text-white px-3 py-1 rounded-full text-sm animate-pulse","data-test":"edit-mode-indicator",children:[f.type==="insert"?"Recording to insert...":"Recording to replace...",a.jsx(de,{variant:"ghost",size:"sm",className:"ml-2 h-5 px-2 text-white hover:text-white hover:bg-blue-600",onClick:()=>{m({type:"none"}),v()},children:"Cancel"})]}),a.jsx(Vt,{isVisible:t,onClose:N,title:`Recorder ${g.length>0?`(${g.length})`:""}`,shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth-420,y:60},initialSize:{width:400,height:350},showPinButton:!1,headerActions:$,children:a.jsx(If,{interactions:g,isRecording:x,onExport:S,onClear:j})}),a.jsx(Vt,{isVisible:i,onClose:()=>c(!1),title:"Save Session",initialPosition:{x:window.innerWidth/2-175,y:150},initialSize:{width:350,height:220},shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,children:a.jsxs("div",{className:"p-4 space-y-3","data-test":"save-session-dialog",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-sm",children:"Name"}),a.jsx(We,{value:l,onChange:Y=>d(Y.target.value),placeholder:"Session name",autoFocus:!0,"data-test":"save-session-name"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(je,{className:"text-sm",children:"Description (optional)"}),a.jsx(We,{value:p,onChange:Y=>u(Y.target.value),placeholder:"Brief description","data-test":"save-session-description"})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[a.jsx(de,{variant:"ghost",size:"sm",onClick:()=>c(!1),"data-test":"save-session-cancel",children:"Cancel"}),a.jsxs(de,{size:"sm",onClick:D,"data-test":"save-session-confirm",children:["Save (",g.length," interactions)"]})]})]})}),a.jsx(Lf,{isOpen:r,savedSessions:y.savedSessions,onLoad:_,onDelete:y.deleteSession,onUpdateSession:y.updateSession,onUpdateInteraction:y.updateInteraction,onDeleteInteraction:y.deleteInteraction,onInsertInteraction:y.insertInteraction,onStartInsertRecord:P,onStartReplaceRecord:G,onClose:()=>o(!1)})]})}const kt=h.forwardRef(({className:s,...e},t)=>a.jsx(Wi,{ref:t,className:B("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...e,children:a.jsx(zu,{className:B("flex items-center justify-center text-current"),children:a.jsx(ct,{className:"h-4 w-4"})})}));kt.displayName=Wi.displayName;const Mf=ln("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}}),ht=h.forwardRef(({className:s,variant:e,...t},n)=>a.jsx("div",{ref:n,className:B(Mf({variant:e}),s),...t}));ht.displayName="Badge";function ia({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1,contentStyle:o}){const[i,c]=h.useState(!1),[l,d]=h.useState(""),p=e.find(m=>m.value===s),u=e.filter(m=>m.label.toLowerCase().includes(l.toLowerCase())),f=m=>{t==null||t(m),c(!1),d("")};return p?a.jsxs(st,{open:i,onOpenChange:c,children:[a.jsx(pt,{asChild:!0,children:a.jsx(ht,{variant:p.variant||"secondary",className:B("cursor-pointer hover:opacity-80 transition-opacity",p.className,r&&"opacity-50 cursor-not-allowed"),onClick:m=>{m.stopPropagation(),r&&m.preventDefault()},children:p.label})}),a.jsx(Qe,{className:"popover-content w-64 p-2",align:"start",style:o,children:a.jsxs("div",{className:"selector-container space-y-2",children:[a.jsx(We,{placeholder:n,value:l,onChange:m=>d(m.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),a.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(m=>a.jsxs(de,{variant:"ghost",className:B("option-item w-full justify-between h-8 px-2",m.value===s&&"bg-accent"),onClick:()=>f(m.value),children:[a.jsx(ht,{variant:m.variant||"secondary",className:B("text-xs",m.className),children:m.label}),m.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4"})]},m.value))})]})})]}):null}const pr=h.forwardRef(({className:s,...e},t)=>a.jsx(gt,{ref:t,className:B("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...e}));pr.displayName=gt.displayName;const Mc=({children:s,value:e,onValueChange:t,filter:n,shouldFilter:r,...o})=>a.jsx(Fn,{modal:!1,...o,children:a.jsx(La,{children:a.jsxs(cn,{className:B("overflow-hidden p-0 fixed inset-x-0 top-[10%] mx-auto max-w-2xl w-full","gap-4 border bg-background shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:slide-out-to-top-8 data-[state=open]:slide-in-from-top-8","sm:rounded-lg"),style:{zIndex:Je.commandPalette},"data-test":"command-dialog",children:[a.jsx(Zs,{className:"sr-only",children:"Command Palette"}),a.jsx(pr,{value:e,onValueChange:t,filter:n,shouldFilter:r,className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-1.5 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:s}),a.jsxs(Ma,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[a.jsx(ft,{className:"h-4 w-4"}),a.jsx("span",{className:"sr-only",children:"Close"})]})]})})}),hr=h.forwardRef(({className:s,...e},t)=>a.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[a.jsx(cr,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),a.jsx(gt.Input,{ref:t,className:B("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...e})]}));hr.displayName=gt.Input.displayName;const dn=h.forwardRef(({className:s,...e},t)=>a.jsx(gt.List,{ref:t,className:B("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...e}));dn.displayName=gt.List.displayName;const un=h.forwardRef((s,e)=>a.jsx(gt.Empty,{ref:e,className:"py-6 text-center text-sm",...s}));un.displayName=gt.Empty.displayName;const As=h.forwardRef(({className:s,...e},t)=>a.jsx(gt.Group,{ref:t,className:B("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...e}));As.displayName=gt.Group.displayName;const ca=h.forwardRef(({className:s,...e},t)=>a.jsx(gt.Separator,{ref:t,className:B("-mx-1 h-px bg-border",s),...e}));ca.displayName=gt.Separator.displayName;const rs=h.forwardRef(({className:s,...e},t)=>a.jsx(gt.Item,{ref:t,className:B("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s),...e}));rs.displayName=gt.Item.displayName;const Jt="__no_project__",Ff=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},$f=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1},Uf=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.projectsError)??null},Bf=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath};function Fc({variant:s="badge",className:e,multiSelect:t=!1,value:n,onChange:r}){const[o,i]=h.useState(!1),c=r!==void 0,l=Le(Ff),d=Le($f),p=Le(Uf),u=Le(Bf),f=c?n:u,m=t?Array.isArray(f)?f:f?[f]:[]:null,g=h.useCallback(b=>{var S,j,N;const y=l.find(E=>E.id===b||E.path===b),C=(y==null?void 0:y.path)??b;if(c)r(b);else{const E=le.getState();le.updateState({app:{...E.app,claude:{...(S=E.app)==null?void 0:S.claude,ui:{...(N=(j=E.app)==null?void 0:j.claude)==null?void 0:N.ui,selectedProjectPath:C}}}})}},[c,r,l]),x=h.useCallback(b=>{if(!t||!m)return;const y=l.find(j=>j.id===b||j.path===b),C=(y==null?void 0:y.path)??b,S=m.includes(C)?m.filter(j=>j!==C):[...m,C];c&&r(S)},[t,m,l,c,r]),w=h.useCallback(()=>{var b,y,C;if(c)r(t?[]:void 0);else{const S=le.getState();le.updateState({app:{...S.app,claude:{...(b=S.app)==null?void 0:b.claude,ui:{...(C=(y=S.app)==null?void 0:y.claude)==null?void 0:C.ui,selectedProjectPath:void 0}}}})}},[c,r,t]);if(h.useEffect(()=>{!c&&!d&&l.length>0&&!u&&g(l[0].path)},[c,d,l,u,g]),d)return a.jsx("div",{"data-test":"project-selector-loading",className:e,children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading projects..."})});if(p)return a.jsx("div",{"data-test":"project-selector-error",className:e,children:a.jsx("span",{className:"text-sm text-destructive",children:p})});if(l.length===0)return a.jsx("div",{"data-test":"project-selector-empty",className:e,children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"No projects found"})});const v=t?null:l.find(b=>b.path===f||b.id===f);if(t&&m){const b=l.filter(S=>m.includes(S.path)),y=m.includes(Jt),C=m.length>0;return a.jsxs("div",{"data-test":"project-selector-multi",className:"project-selector-multi-wrapper",children:[a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(pt,{asChild:!0,children:a.jsxs(de,{"data-test":"project-selector-trigger",variant:"outline",role:"combobox","aria-expanded":o,className:B("project-selector-trigger w-full justify-between",C&&"h-auto min-h-[40px] py-2"),disabled:d,children:[a.jsx("div",{className:"flex flex-wrap gap-1 flex-1 mr-2",children:C?a.jsxs(a.Fragment,{children:[y&&a.jsxs(ht,{"data-test":"project-badge-none",variant:"secondary",className:"selected-project-badge gap-1",children:["No project",a.jsx(ft,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:S=>{S.stopPropagation(),x(Jt)}})]}),b.map(S=>a.jsxs(ht,{"data-test":"project-badge",variant:"secondary",className:"selected-project-badge gap-1",children:[S.name,a.jsx(ft,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:j=>{j.stopPropagation(),x(S.path)}})]},S.id))]}):a.jsx("span",{className:"text-muted-foreground",children:"Select projects..."})}),a.jsx(uc,{className:"h-4 w-4 shrink-0 opacity-50"})]})}),a.jsx(Qe,{"data-test":"project-selector-content",className:"project-selector-content w-[400px] p-0",style:{zIndex:Je.tooltip},children:a.jsxs(pr,{children:[a.jsx(hr,{"data-test":"project-selector-search",placeholder:"Search projects..."}),a.jsxs(dn,{className:"max-h-[300px]",children:[a.jsx(un,{children:"No projects found."}),a.jsxs(As,{children:[a.jsxs(rs,{"data-test":"project-selector-item-none",value:Jt,onSelect:()=>x(Jt),className:"project-selector-item cursor-pointer",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4 shrink-0",m.includes(Jt)?"opacity-100":"opacity-0")}),a.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[a.jsx("span",{className:"project-name font-medium",children:"No project"}),a.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})]}),l.map(S=>a.jsxs(rs,{"data-test":"project-selector-item",value:S.path,onSelect:()=>x(S.path),className:"project-selector-item cursor-pointer",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4 shrink-0",m.includes(S.path)?"opacity-100":"opacity-0")}),a.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[a.jsx("span",{className:"project-name font-medium",children:S.name}),a.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[S.sessionCount," sessions"]})]})]},S.id))]})]})]})})]}),C&&a.jsxs(de,{"data-test":"project-selector-clear-all",variant:"outline",size:"sm",onClick:w,className:"clear-all-button w-full mt-2",children:[a.jsx(ft,{className:"h-4 w-4 mr-2"}),"Clear all (",m.length,")"]})]})}if(s==="badge"&&!t){const b=typeof f=="string"?f:void 0,y=[{value:Jt,label:"No project",variant:"secondary"},...l.map(C=>({value:C.path,label:`${C.name} (${C.sessionCount})`,variant:"secondary"}))];return a.jsx(ia,{"data-test":"project-selector-badge",value:b??l[0].path,options:y,onChange:g,placeholder:"Search projects..."})}if(!t){const b=typeof f=="string"?f:void 0;return a.jsxs("div",{"data-test":"project-selector-select",className:"project-selector-wrapper flex gap-2",children:[a.jsxs(Ut,{value:b??l[0].path,onValueChange:g,children:[a.jsx(It,{"data-test":"project-selector-trigger",className:e,children:a.jsx(Kt,{children:b===Jt?"No project":v?`${v.name} (${v.sessionCount})`:"Select project"})}),a.jsxs(At,{children:[a.jsx(Oe,{"data-test":"project-selector-item-none",value:Jt,children:a.jsxs("div",{className:"project-option flex flex-col items-start",children:[a.jsx("span",{className:"project-name font-medium",children:"No project"}),a.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})},Jt),l.map(y=>a.jsx(Oe,{"data-test":"project-selector-item",value:y.path,children:a.jsxs("div",{className:"project-option flex flex-col items-start",children:[a.jsx("span",{className:"project-name font-medium",children:y.name}),a.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[y.sessionCount," sessions"]})]})},y.id))]})]}),b&&a.jsx(de,{"data-test":"project-selector-clear",variant:"outline",size:"icon",onClick:w,className:"clear-project-button shrink-0",title:"Clear project filter",children:a.jsx(ft,{className:"h-4 w-4"})})]})}return null}const fr=h.forwardRef(({label:s,onAction:e,configOptions:t=[],popoverContent:n,longPressDuration:r=400,showStaticGear:o=!1,showHint:i=!1,enableOnboarding:c=!1,tooltipText:l,ariaLabel:d,variant:p="secondary",size:u="default",disabled:f=!1,className:m,compact:g=!1,buttonClassName:x,...w},v)=>{const[b,y]=h.useState(!1),[C,S]=h.useState(!1),[j,N]=h.useState(!1),[E,R]=h.useState(0),[D,T]=h.useState(c),L=h.useRef(null),_=h.useRef(null),P=h.useRef(0),G=h.useRef(!1),$=h.useRef(!1),Y=h.useRef(null),A=h.useRef(null),X=h.useRef(null),I=h.useCallback(()=>{L.current&&(clearTimeout(L.current),L.current=null),_.current&&(clearInterval(_.current),_.current=null),y(!1),R(0)},[]);h.useEffect(()=>I,[I]),h.useEffect(()=>{f&&(I(),S(!1))},[f,I]),h.useEffect(()=>{if(!C||j)return;const xe=Pe=>{var te,F;const ae=Pe.target;(te=X.current)!=null&&te.contains(ae)||(F=A.current)!=null&&F.contains(ae)||S(!1)};return document.addEventListener("mousedown",xe),()=>{document.removeEventListener("mousedown",xe)}},[C,j]);const k=n!==void 0||t.length>0,M=h.useCallback(xe=>{if(!(f||!k)){if(xe.type==="touchstart"&&xe.preventDefault(),y(!0),S(!1),P.current=Date.now(),G.current=!1,$.current=!0,D&&T(!1),!g){const Pe=100/(r/16);_.current=setInterval(()=>{R(ae=>{const te=ae+Pe;return te>100?100:te})},16)}L.current=setTimeout(()=>{g?N(!0):S(!0),R(0),_.current&&(clearInterval(_.current),_.current=null)},r)}},[f,k,r,D,g]),U=h.useCallback(()=>{if(f)return;Date.now()-P.current<r&&!C?(G.current=!0,e()):G.current=!0,I()},[f,r,C,e,I]),q=h.useCallback(()=>{f||($.current||e(),$.current=!1)},[f,e]),W=h.useCallback(()=>{f||C||I()},[f,C,I]),V=h.useCallback(xe=>{xe.stopPropagation(),N(!0)},[]),ie=h.useCallback(xe=>{xe.onClick(),N(!1),S(!1)},[]),K=20,ne=2*Math.PI*K,me=ne-E/100*ne,ge=`${s} (Click) / Configure (Hold)`,oe=l??ge,Se=a.jsxs(de,{ref:Y,variant:p,size:u,disabled:f,className:B("button-main relative transition-all",b&&"scale-95",!g&&i&&k&&"pr-8",x),onPointerDown:M,onPointerUp:U,onPointerLeave:W,onClick:q,"aria-label":d||(typeof s=="string"?`Button: ${s}. Secondary action: long press for configuration`:"Button with configuration options"),"aria-pressed":b,"aria-expanded":j,"aria-haspopup":"menu",...w,children:[s,!g&&i&&k&&a.jsx(Sp,{className:"hint-icon absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 opacity-30"})]});return g?a.jsxs("div",{ref:v,className:B("relative inline-flex items-center",m),children:[a.jsx(Es,{children:a.jsxs(Ts,{children:[a.jsx(Is,{asChild:!0,children:Se}),a.jsx(hs,{children:a.jsx("p",{children:oe})})]})}),a.jsxs(st,{open:j,onOpenChange:xe=>{N(xe)},children:[a.jsx(pt,{asChild:!0,children:a.jsx("span",{className:"absolute inset-0 pointer-events-none","aria-hidden":"true"})}),a.jsx(Qe,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((xe,Pe)=>a.jsxs("button",{onClick:()=>ie(xe),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[xe.icon&&a.jsx("span",{className:"shrink-0",children:xe.icon}),a.jsx("span",{children:xe.label})]},xe.value??Pe))})})]})]}):a.jsxs("div",{ref:v,className:B("relative inline-flex items-center gap-2",m),children:[a.jsx(Es,{children:a.jsxs(Ts,{open:D?!0:C?!1:void 0,children:[a.jsx(Is,{asChild:!0,children:a.jsxs("div",{ref:X,className:"button-container relative inline-block",children:[b&&E>0&&a.jsx("svg",{className:"progress-ring absolute inset-0 pointer-events-none",width:"100%",height:"100%",style:{transform:"rotate(-90deg)"},children:a.jsx("circle",{className:"progress-ring-circle stroke-primary/30",strokeWidth:"3",fill:"transparent",r:K,cx:"50%",cy:"50%",style:{strokeDasharray:ne,strokeDashoffset:me,transition:"stroke-dashoffset 16ms linear"}})}),Se,C&&!o&&a.jsxs(st,{open:j,onOpenChange:xe=>{N(xe),xe||S(!1)},children:[a.jsx(pt,{asChild:!0,children:a.jsx("button",{ref:A,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200","aria-label":"Open configuration",children:a.jsx(Ft,{className:"h-4 w-4"})})}),a.jsx(Qe,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((xe,Pe)=>a.jsxs("button",{onClick:()=>ie(xe),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[xe.icon&&a.jsx("span",{className:"shrink-0",children:xe.icon}),a.jsx("span",{children:xe.label})]},xe.value??Pe))})})]}),C&&o&&a.jsx("button",{ref:A,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200",onClick:V,onTouchEnd:xe=>{xe.preventDefault(),V(xe)},"aria-label":"Open configuration",children:a.jsx(Ft,{className:"h-4 w-4"})})]})}),a.jsx(hs,{children:a.jsx("p",{children:D?"Try holding this button for advanced settings":oe})})]})}),o&&k&&a.jsxs(st,{open:j,onOpenChange:xe=>{N(xe),xe||S(!1)},children:[a.jsx(pt,{asChild:!0,children:a.jsx(de,{variant:"ghost",size:"icon",className:"static-gear h-8 w-8 shrink-0",disabled:f,"aria-label":"Configure",tabIndex:0,children:a.jsx(Ft,{className:"h-4 w-4"})})}),a.jsx(Qe,{align:"end",className:B("config-panel",n?"w-auto":"w-56"),children:n?a.jsx("div",{className:"config-panel-custom-content",children:n}):a.jsx("div",{className:"config-panel-content space-y-1",children:t.map((xe,Pe)=>a.jsxs("button",{onClick:()=>ie(xe),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[xe.icon&&a.jsx("span",{className:"shrink-0",children:xe.icon}),a.jsx("span",{children:xe.label})]},xe.value??Pe))})})]})]})});fr.displayName="ConfigurableButton";const Wf="â€‹";function zf(s){return s.replace(new RegExp(Wf,"g"),"")}function Uo(s){const e=/^(\s*)/.exec(s);return e?e[1]:""}function mr(s){const e=/^(\s*)(\d+)\.\s*(.*)$/.exec(s);if(e)return{type:"numbered",indent:e[1],number:parseInt(e[2],10),fullMatch:e[0].replace(e[3],""),contentAfterPrefix:e[3]};const t=/^(\s*)-\s*(.*)$/.exec(s);return t?{type:"dash",indent:t[1],fullMatch:t[0].replace(t[2],""),contentAfterPrefix:t[2]}:{type:"none",indent:"",fullMatch:"",contentAfterPrefix:s}}function Hf(s,e,t,n){if(s.trim()==="")return{type:"newline",textToInsert:`
`};const r=mr(s);if(r.type==="none")return{type:"continue",textToInsert:`
`+Uo(s)};if(!(r.contentAfterPrefix.trim().length>0)){const l=r.fullMatch.length;if(r.type==="numbered"){const d=Gf(t,n,r.indent,r.number??1);return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l,textAfterCursor:d}}return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l}}if(zf(e.split(`
`)[0]).trim().length>0)return{type:"continue",textToInsert:`
`+Uo(s)};if(r.type==="numbered"){const l=(r.number??0)+1,d=`
${r.indent}${l}. `,p=qf(t,n,r.indent,l);return{type:"continue",textToInsert:d,textAfterCursor:p}}return{type:"continue",textToInsert:`
${r.indent}- `}}function Gf(s,e,t,n){const o=s.substring(e).split(`
`);let i=!1,c=n-1;const l=[];for(let d=0;d<o.length;d++){const p=o[d],u=mr(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...o.slice(d));break}else if(p.trim()===""&&d<o.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...o.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function qf(s,e,t,n){const o=s.substring(e).split(`
`);let i=!1,c=n;const l=[];for(let d=0;d<o.length;d++){const p=o[d],u=mr(p);if(u.type==="numbered"&&u.indent===t)if(c++,u.number!==c){const f=`${u.indent}${c}. ${u.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(u.type==="numbered"&&u.indent.length<t.length){l.push(...o.slice(d));break}else if(p.trim()===""&&d<o.length-1)l.push(p);else if(u.type!=="numbered"){l.push(...o.slice(d));break}else l.push(p)}return i?l.join(`
`):void 0}function $c(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=n===-1?s.length:n;return{lineStart:t,lineEnd:r,currentLine:s.substring(t,r),textBeforeLine:s.substring(0,t),textAfterLine:s.substring(r)}}function Uc(s,e){if(e===0)return{type:"default"};const{lineStart:t,currentLine:n}=$c(s,e),r=e-t,o=mr(n);if(o.type==="none")return{type:"default"};const i=o.fullMatch.length;if(r<=i&&r>0){const c=e-1;return{type:"delete-char",newText:s.substring(0,c)+s.substring(e),newCursorPos:c}}return{type:"default"}}const Vf={b:"**",i:"*","`":"`"},Kf={"*":"*",_:"*","`":"`"};function Bc(s,e,t){const{lineStart:n,textAfterLine:r}=$c(s,e),o=s.substring(n,e),i=s.substring(e,s.indexOf(`
`,e)===-1?s.length:s.indexOf(`
`,e)),c=Hf(o,i+r,s,e);if(c.type==="remove-prefix"){const l=c.charsToRemoveBeforeCursor??0,d=e-l;return{selectionStart:d,selectionEnd:e,textToInsert:c.textToInsert,newCursorPosition:d+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}}return c.type==="continue"?{selectionStart:e,selectionEnd:t,textToInsert:c.textToInsert,newCursorPosition:e+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}:{selectionStart:e,selectionEnd:t,textToInsert:`
`,newCursorPosition:e+1}}function Wc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r="  ",o=e+2;return{selectionStart:n,selectionEnd:n,textToInsert:r,newCursorPosition:o}}function zc(s,e,t){const n=s.lastIndexOf(`
`,e-1)+1,r=s.indexOf(`
`,e),o=r===-1?s.length:r,i=s.substring(n,o);let c=0;for(let d=0;d<Math.min(2,i.length)&&i[d]===" ";d++)c++;if(c===0)return{selectionStart:e,selectionEnd:t,textToInsert:"",newCursorPosition:e};const l=Math.max(n,e-c);return{selectionStart:n,selectionEnd:n+c,textToInsert:"",newCursorPosition:l}}function Bo(s,e,t,n){const r=s.substring(e,t),o=`${n}${r}${n}`;return{selectionStart:e,selectionEnd:t,textToInsert:o,newCursorPosition:e+o.length}}function Jf(s){return Vf[s.toLowerCase()]}function Yf(s){return Kf[s]}function Xf(s,e){const t=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),r=s.substring(t,n===-1?s.length:n),o=r.trim();if(!o.startsWith("|")||!o.endsWith("|"))return null;const i=o.split("|").slice(1,-1);if(i.length===0||i.every(u=>/^\s*:?-+:?\s*$/.test(u)))return null;const l=r.indexOf("|"),d=e-t;let p=l+1;for(let u=0;u<i.length;u++){const f=i[u],m=p+f.length;if(d>=p&&d<=m){const g=f.trim(),x=f.length-f.trimStart().length,w=d-p;if(g.length===0)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(w===x&&x>0)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(w>0&&w<x)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(w===0)if(u>0){const v=i[u-1],y=p-1-v.length+v.trimEnd().length;return{newText:s,newCursorPos:t+y}}else return{newText:s,newCursorPos:e};if(x===0&&w>=1&&g.length>=1){const v=s[e],b=g[w],y=w>=g.length;if(b!==void 0&&v===b||y)if(u>0){const S=i[u-1],N=p-1-S.length+S.trimEnd().length;return{newText:s,newCursorPos:t+N}}else return{newText:s,newCursorPos:e}}break}p=m+1}return null}function Qf(s,e){if(s[e-1]!==`
`)return null;const t=s.substring(0,e-1),n=t.lastIndexOf(`
`)+1,o=t.substring(n).trimEnd();if(!o.endsWith("|")||!o.includes("|")||o.split("|").slice(1,-1).every(v=>/^\s*:?-+:?\s*$/.test(v)))return null;const l=s.substring(e),d=l.indexOf(`
`),p=d===-1?l:l.substring(0,d),u=d===-1?"":l.substring(d),f=n+o.lastIndexOf("|");let m=s.substring(0,f);m.match(/\s+$/)&&(m=m.trimEnd());const x=m+p+" |"+u,w=m.length;return{newText:x,newCursorPos:w}}function Zf(s,e,t){if(e!==t||e===0)return null;const n=Qf(s,e);if(n)return{selectionStart:0,selectionEnd:s.length,textToInsert:n.newText,newCursorPosition:n.newCursorPos};const r=Xf(s,e);if(r)return{selectionStart:0,selectionEnd:s.length,textToInsert:r.newText,newCursorPosition:r.newCursorPos};const o=Uc(s,e);return o.type==="delete-char"&&o.newText!==void 0?{selectionStart:0,selectionEnd:s.length,textToInsert:o.newText,newCursorPosition:o.newCursorPos??e-1}:{selectionStart:e-1,selectionEnd:e,textToInsert:"",newCursorPosition:e-1}}function em(s){return["b","i","`"].includes(s.toLowerCase())}const Hc=h.forwardRef(({value:s,defaultValue:e,onChange:t,placeholder:n,onClick:r,onMouseDown:o,onMouseUp:i,onPaste:c,onKeyDown:l,onKeyUp:d,onBlur:p,rows:u=4,className:f="",readOnly:m=!1,disabled:g=!1,...x},w)=>{const v=b=>{if(l==null||l(b),b.defaultPrevented)return;const y=b.currentTarget,{selectionStart:C,selectionEnd:S}=y,j=y.value;if(b.key==="Enter"){b.preventDefault();const N=Bc(j,C,S);if(y.focus(),y.setSelectionRange(N.selectionStart,N.selectionEnd),N.replaceTextAfterCursor!==void 0){const R=j.substring(0,N.selectionStart)+N.textToInsert+N.replaceTextAfterCursor;y.value=R,y.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:y,currentTarget:y})}else if(N.selectionStart!==N.selectionEnd&&N.textToInsert===""){const E=j.substring(0,N.selectionStart)+j.substring(N.selectionEnd);y.value=E,y.setSelectionRange(N.newCursorPosition,N.newCursorPosition),t&&t({target:y,currentTarget:y})}else{if(!document.execCommand("insertText",!1,N.textToInsert)&&t){const R=j.substring(0,N.selectionStart)+N.textToInsert+j.substring(N.selectionEnd);y.value=R,t({target:y,currentTarget:y})}y.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}}if(b.key==="Backspace"){const N=Uc(j,C);if(N.type==="delete-char"&&N.newText!==void 0&&N.newCursorPos!==void 0){b.preventDefault(),y.value=N.newText,y.setSelectionRange(N.newCursorPos,N.newCursorPos),t&&t({target:y,currentTarget:y});return}}if(b.key==="Tab"){b.preventDefault();const N=b.shiftKey?zc(j,C,S):Wc(j,C);if(y.focus(),y.setSelectionRange(N.selectionStart,N.selectionEnd),!document.execCommand("insertText",!1,N.textToInsert)&&t){const R=j.substring(0,N.selectionStart)+N.textToInsert+j.substring(N.selectionEnd);y.value=R,t({target:y,currentTarget:y})}y.setSelectionRange(N.newCursorPosition,N.newCursorPosition)}};return a.jsx("textarea",{ref:w,value:s,defaultValue:e,onChange:t,onKeyDown:v,autoCorrect:"off",onKeyUp:d,placeholder:n,onClick:r,onMouseDown:o,onMouseUp:i,onPaste:c,onBlur:p,rows:u,className:B(lh.textarea,f),readOnly:m,disabled:g,"data-test":x["data-test"],...x})});Hc.displayName="RichTextarea";const pn=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("rounded-xl border bg-card text-card-foreground shadow",s),...e}));pn.displayName="Card";const Ha=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("flex flex-col space-y-1.5 p-6",s),...e}));Ha.displayName="CardHeader";const Ga=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("font-semibold leading-none tracking-tight",s),...e}));Ga.displayName="CardTitle";const tm=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("text-sm text-muted-foreground",s),...e}));tm.displayName="CardDescription";const hn=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("p-6 pt-0",s),...e}));hn.displayName="CardContent";const sm=h.forwardRef(({className:s,...e},t)=>a.jsx("div",{ref:t,className:B("flex items-center p-6 pt-0",s),...e}));sm.displayName="CardFooter";const nm=Hu,rm=Gu,SC=Vu,am=h.forwardRef(({className:s,inset:e,children:t,...n},r)=>a.jsxs(Ki,{ref:r,className:B("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",s),...n,children:[t,a.jsx(yt,{className:"ml-auto"})]}));am.displayName=Ki.displayName;const om=h.forwardRef(({className:s,...e},t)=>a.jsx(Ji,{ref:t,className:B("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...e}));om.displayName=Ji.displayName;const Gc=h.forwardRef(({className:s,sideOffset:e=4,container:t,...n},r)=>a.jsx(qu,{container:t??void 0,children:a.jsx(zi,{ref:r,sideOffset:e,className:B("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...n})}));Gc.displayName=zi.displayName;const qc=h.forwardRef(({className:s,inset:e,...t},n)=>a.jsx(Hi,{ref:n,className:B("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",s),...t}));qc.displayName=Hi.displayName;const im=h.forwardRef(({className:s,children:e,checked:t,...n},r)=>a.jsxs(Gi,{ref:r,className:B("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),checked:t,...n,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(qi,{children:a.jsx(ct,{className:"h-4 w-4"})})}),e]}));im.displayName=Gi.displayName;const cm=h.forwardRef(({className:s,children:e,...t},n)=>a.jsxs(Xi,{ref:n,className:B("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(qi,{children:a.jsx(Ys,{className:"h-2 w-2 fill-current"})})}),e]}));cm.displayName=Xi.displayName;const lm=h.forwardRef(({className:s,inset:e,...t},n)=>a.jsx(Yi,{ref:n,className:B("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",s),...t}));lm.displayName=Yi.displayName;const dm=h.forwardRef(({className:s,...e},t)=>a.jsx(Vi,{ref:t,className:B("-mx-1 my-1 h-px bg-muted",s),...e}));dm.displayName=Vi.displayName;function um({onClick:s,label:e,icon:t,variant:n="default",size:r="sm",compact:o=!1,options:i=[],showDropdown:c=!0,className:l="",disabled:d=!1,contentStyle:p}){const u=c&&i.length>0,f="w-3 h-3",m=o?"w-2 h-2":"w-3 h-3";return a.jsxs("div",{className:B("split-button-group inline-flex",l),"data-test":"split-button-container",children:[a.jsxs(de,{onClick:s,variant:n,size:r,disabled:d,className:B(o&&"h-5 px-1 min-w-0",u&&"rounded-r-none border-r-0"),"data-test":"split-button-main",children:[t&&a.jsx(t,{className:B(f,e&&"mr-1"),"data-test":"split-button-icon"}),e&&a.jsx("span",{className:o?"text-xs":"",children:e})]}),u&&a.jsxs(nm,{children:[a.jsx(rm,{asChild:!0,children:a.jsx(de,{variant:n,size:r,disabled:d,className:B("rounded-l-none",o?"h-5 px-0.5 min-w-0":"px-1"),"data-test":"split-button-dropdown-trigger",children:a.jsx(ut,{className:m,"data-test":"split-button-dropdown-icon"})})}),a.jsx(Gc,{align:"end",style:p,"data-test":"split-button-dropdown-menu",children:i.map((g,x)=>a.jsx(qc,{onClick:g.onClick,className:"text-xs","data-test":"split-button-dropdown-option",children:g.label},x))})]})]})}async function Wo(s,e){try{e==null||e.info(`Converting ${s.type} (${s.size} bytes) to WAV`);const t=new(window.AudioContext||window.webkitAudioContext),n=await s.arrayBuffer(),r=await t.decodeAudioData(n);e==null||e.debug(`Decoded: ${r.duration}s, ${r.sampleRate}Hz, ${r.numberOfChannels}ch`);const o=r.numberOfChannels,i=r.sampleRate,c=r.length,l=new Float32Array(c*o);for(let u=0;u<o;u++){const f=r.getChannelData(u);for(let m=0;m<c;m++)l[m*o+u]=f[m]}const d=pm(l,i,o),p=new Blob([d],{type:"audio/wav"});if(!p||p.size===0)throw new Error("Failed to create valid WAV blob");return e==null||e.info(`Conversion complete: ${p.size} bytes`),p}catch(t){throw e==null||e.error(`Audio conversion failed: ${t}`),t}}function pm(s,e,t){const n=new ArrayBuffer(44+s.length*2),r=new DataView(n),o=(c,l)=>{for(let d=0;d<l.length;d++)r.setUint8(c+d,l.charCodeAt(d))};o(0,"RIFF"),r.setUint32(4,36+s.length*2,!0),o(8,"WAVE"),o(12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,e,!0),r.setUint32(28,e*t*2,!0),r.setUint16(32,t*2,!0),r.setUint16(34,16,!0),o(36,"data"),r.setUint32(40,s.length*2,!0);let i=44;return s.forEach(c=>{const l=Math.max(-1,Math.min(1,c));r.setInt16(i,l*32767,!0),i+=2}),n}function hm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map((i,c)=>c===0?i.toLowerCase():i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function fm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function mm(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",r=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return r.length===0?s:r.map(i=>i.toLowerCase()).join("_")+t}function jC(s,e){switch(e){case"camel":return hm(s);case"pascal":return fm(s);case"snake":return mm(s);default:return s}}function zo(s){return s.endsWith("...")?s.slice(0,-3).trim():s}function gm(s){return s.trim().endsWith(".")?s.slice(0,-1).trim():s}let xm="transcriptions";const Ho=["ggml-large-v3","ggml-large-v3-q5_0","ggml-large-v3-turbo","ggml-distil-large-v3","distil-large-v3.5"];let vm="ggml-distil-large-v3";const Vc={language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:vm},bm=["CÃ¡c báº¡n","CÃ¡c báº¡n nhá»› Ä‘Äƒng kÃ½ kÃªnh Ä‘á»ƒ á»§ng há»™ kÃªnh cá»§a mÃ¬nh nhÃ©! Háº¹n gáº·p láº¡i cÃ¡c báº¡n trong nhá»¯ng video tiáº¿p theo!","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi, quÃ½ vá»‹","Hi, quÃ½ vá»‹. Xin chÃ o táº¥t cáº£ cÃ¡c báº¡n","HÃ£y subscribe cho kÃªnh","HÃ£y subscribe cho kÃªnh Ghiá»n MÃ¬ GÃµ Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","HÃ£y subscribe cho kÃªnh La La School Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","lalaschool","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Cáº¢M Æ N CÃC Báº N ÄÃƒ THEO DÃ•I VÃ€ ÄÄ‚NG KÃ KÃŠNH NHÃ‰!"];class fn extends Error{constructor(e,t,n,r){super(e),this.code=t,this.statusCode=n,this.detail=r,this.name="PythonTranscribeApiError"}}class wm extends fn{constructor(e){super(e??"Bad Request - invalid file format or missing file","PTApi_BAD_REQUEST",400,e),this.name="PTApiBadRequestError"}}class ym extends fn{constructor(e){super(e??"Payload Too Large - file exceeds size limit","PTApi_PAYLOAD_TOO_LARGE",413,e),this.name="PTApiPayloadTooLargeError"}}class Sm extends fn{constructor(e){super(e??"Internal Server Error - transcription service error","PTApi_INTERNAL_SERVER_ERROR",500,e),this.name="PTApiInternalServerError"}}class jm extends fn{constructor(e,t){super(t??`HTTP error! status: ${e}`,"PTApi_HTTP_ERROR",e,t),this.name="PTApiHttpError"}}class Kc extends fn{constructor(){super("Transcription contains denied phrases.","PTApi_DENIED_PHRASES"),this.name="PTApiDeniedPhrasesError"}}const Cm="PythonTranscribeApiService";class Nm{constructor(){ee(this,"baseUrl");this.baseUrl="http://192.168.2.70:9876"}async transcribeAudio(e,t={}){t={...Vc,...t},Re.info(`ðŸ”¤ Transcription request payload: ${JSON.stringify({file:e.name,size:`${(e.size/1024).toFixed(1)}KB`,...t})}`,Cm);const n=new FormData;t.language!==void 0&&n.append("language",t.language),t.translate!==void 0&&n.append("translate",t.translate.toString()),t.no_timestamps!==void 0&&n.append("no_timestamps",t.no_timestamps.toString()),t.no_prints!==void 0&&n.append("no_prints",t.no_prints.toString()),t.auto_detect_language!==void 0&&n.append("auto_detect_language",t.auto_detect_language.toString()),t.model!==void 0&&n.append("model",t.model),n.append("file",e);try{const r=await fetch(`${this.baseUrl}/${xm}`,{method:"POST",body:n});if(!r.ok){const i=await r.json();switch(r.status){case 400:throw new wm(i.detail);case 413:throw new ym(i.detail);case 500:throw new Sm(i.detail);default:throw new jm(r.status,i.detail)}}const o=await r.json();if(o.transcription=gm(o.transcription),bm.some(i=>o.transcription.toLowerCase().includes(i.toLowerCase())))throw new Kc;return o}catch(r){throw r}}setBaseUrl(e){this.baseUrl=e}}const Jc=new Nm,xn={language:"auto",translate:!1,no_timestamps:!0,auto_detect_language:!0,word_level_timestamps:!1,split:!1},Wn={DEFAULT:{silenceThreshold:-20,minSilenceDuration:40,holdTime:100,padding:-60,waveformSamples:1e3},TIGHT:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3},LOOSE:{silenceThreshold:-30,minSilenceDuration:100,holdTime:200,padding:0,waveformSamples:1e3},WORD_STREAMING:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3}};class km{constructor(e={}){ee(this,"defaultConfig");const t=Wn.DEFAULT;this.defaultConfig={silenceThreshold:e.silenceThreshold??t.silenceThreshold,minSilenceDuration:e.minSilenceDuration??t.minSilenceDuration,holdTime:e.holdTime??t.holdTime,padding:e.padding??t.padding,waveformSamples:e.waveformSamples??t.waveformSamples??1e3}}async analyzeAudio(e,t={}){const n={silenceThreshold:t.silenceThreshold??this.defaultConfig.silenceThreshold,minSilenceDuration:t.minSilenceDuration??this.defaultConfig.minSilenceDuration,holdTime:t.holdTime??this.defaultConfig.holdTime,padding:t.padding??this.defaultConfig.padding,waveformSamples:t.waveformSamples??this.defaultConfig.waveformSamples},r=this._generateWaveform(e,n.waveformSamples),o=this._normalize(r),i=this._toDbfs(o),c=this._detectActiveRegions(i,e.duration,n.silenceThreshold),l=this._mergeCloseRegions(c,n.holdTime),d=this._calculateSilences(l,e.duration*1e3),p=this._filterByDuration(d,n.minSilenceDuration),u=this._applySilencePadding(p,e.duration*1e3,n.padding);return this._getActiveRegions(u,e.duration)}_generateWaveform(e,t){const n=e.numberOfChannels,r=e.length,o=new Float32Array(r);for(let l=0;l<r;l++){let d=0;for(let p=0;p<n;p++)d+=e.getChannelData(p)[l];o[l]=d/n}const i=Math.max(1,Math.floor(r/t)),c=[];for(let l=0;l<t;l++){const d=l*i,p=Math.min(d+i,r);if(d<r&&p>d){let u=0;for(let m=d;m<p;m++)u+=Math.abs(o[m])**2;const f=Math.sqrt(u/(p-d));c.push(f)}else c.push(0)}return c}_normalize(e){const t=e.map(o=>isNaN(o)||!isFinite(o)?0:o),n=Math.max(...t),r=n>0?n:1;return t.map(o=>o/r)}_toDbfs(e){return e.map(n=>20*Math.log10(n+1e-10))}_detectActiveRegions(e,t,n){const r=e.map(l=>l>n),o=[];let i=!1,c=0;for(let l=0;l<r.length;l++)if(r[l]&&!i)c=l,i=!0;else if(!r[l]&&i){const d=l,p=c/e.length*t*1e3,u=d/e.length*t*1e3;o.push([p,u]),i=!1}if(i){const l=t*1e3,d=c/e.length*t*1e3;o.push([d,l])}return o}_mergeCloseRegions(e,t){if(e.length===0)return[];const n=[...e].sort((o,i)=>o[0]-i[0]),r=[n[0]];for(let o=1;o<n.length;o++){const[i,c]=n[o],l=r.length-1,[d,p]=r[l];i-p<=t?r[l]=[d,c]:r.push([i,c])}return r}_calculateSilences(e,t){const n=[];if(e.length===0)return[[0,t]];e[0][0]>0&&n.push([0,e[0][0]]);for(let o=0;o<e.length-1;o++){const i=e[o][1],c=e[o+1][0];c>i&&n.push([i,c])}const r=e[e.length-1][1];return r<t&&n.push([r,t]),n}_filterByDuration(e,t){return e.filter(([n,r])=>r-n>=t)}_applySilencePadding(e,t,n){if(n===0||e.length===0)return e;const r=[];for(let o=0;o<e.length;o++){const[i,c]=e[o];if(i===0){const d=Math.min(t,c+n);d>0&&r.push([0,d])}else if(o===e.length-1&&c===t){const l=Math.max(0,i-n),d=t;d>l&&r.push([l,d])}else{const l=Math.max(0,i-n),d=Math.min(t,c+n);d>l&&r.push([l,d])}}return r}_getActiveRegions(e,t){const n=[];if(e.length===0)return[[0,t]];const r=e.map(([i,c])=>[i/1e3,c/1e3]);r[0][0]>0&&n.push([0,r[0][0]]);for(let i=0;i<r.length-1;i++){const c=r[i][1],l=r[i+1][0];l>c&&n.push([c,l])}const o=r[r.length-1][1];return o<t&&n.push([o,t]),n}}class Yc{constructor(e={}){ee(this,"detector");this.detector=new km(e)}async chunkFile(e){const t=await e.arrayBuffer(),r=await new AudioContext().decodeAudioData(t);return this.chunkAudio(r)}async chunkAudio(e,t){return(await this.detector.analyzeAudio(e,t)).map((o,i)=>{const[c,l]=o,d=this._extractChunk(e,c,l);return{blob:this._audioBufferToWav(d),startTime:c,endTime:l,duration:l-c,index:i+1}})}_extractChunk(e,t,n){const r=e.sampleRate,o=Math.floor(t*r),c=Math.floor(n*r)-o,d=new AudioContext().createBuffer(e.numberOfChannels,c,r);for(let p=0;p<e.numberOfChannels;p++){const u=e.getChannelData(p),f=d.getChannelData(p);for(let m=0;m<c;m++)f[m]=u[o+m]}return d}_audioBufferToWav(e){const t=e.numberOfChannels,n=e.sampleRate,r=1,o=16,i=o/8,c=t*i,l=n*c,d=e.length*c,p=new ArrayBuffer(44+d),u=new DataView(p),f=(x,w)=>{for(let v=0;v<w.length;v++)u.setUint8(x+v,w.charCodeAt(v))};f(0,"RIFF"),u.setUint32(4,36+d,!0),f(8,"WAVE"),f(12,"fmt "),u.setUint32(16,16,!0),u.setUint16(20,r,!0),u.setUint16(22,t,!0),u.setUint32(24,n,!0),u.setUint32(28,l,!0),u.setUint16(32,c,!0),u.setUint16(34,o,!0),f(36,"data"),u.setUint32(40,d,!0);const m=[];for(let x=0;x<t;x++)m.push(e.getChannelData(x));let g=44;for(let x=0;x<e.length;x++)for(let w=0;w<t;w++){const v=Math.max(-1,Math.min(1,m[w][x])),b=v<0?v*32768:v*32767;u.setInt16(g,b,!0),g+=2}return new Blob([p],{type:"audio/wav"})}async getActiveRegions(e,t){return this.detector.analyzeAudio(e,t)}}const He="WebSocketTranscriptionService";class Em{constructor(e){ee(this,"ws",null);ee(this,"wsUrl");ee(this,"eventHandlers",{});ee(this,"isConnected",!1);ee(this,"reconnectAttempts",0);ee(this,"maxReconnectAttempts",3);ee(this,"reconnectDelay",1e3);this.wsUrl=e??"ws://192.168.2.70:9876/ws/transcribe"??"ws://localhost:9876/ws/transcribe"}setEventHandlers(e){this.eventHandlers=e}async connect(){return new Promise((e,t)=>{try{Re.info(`Connecting to WebSocket: ${this.wsUrl}`,He),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var n,r;Re.info("WebSocket connection opened",He),this.isConnected=!0,this.reconnectAttempts=0,(r=(n=this.eventHandlers).onConnectionOpen)==null||r.call(n),e()},this.ws.onmessage=n=>{this.handleMessage(n)},this.ws.onerror=n=>{var r,o;Re.error(`WebSocket error: ${n}`,He),(o=(r=this.eventHandlers).onConnectionError)==null||o.call(r,n),t(n)},this.ws.onclose=n=>{var r,o;Re.info(`WebSocket closed: code=${n.code}, reason=${n.reason}`,He),this.isConnected=!1,(o=(r=this.eventHandlers).onConnectionClose)==null||o.call(r,n.code,n.reason),this.reconnectAttempts<this.maxReconnectAttempts&&n.code!==1e3&&(this.reconnectAttempts++,Re.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,He),setTimeout(()=>{this.connect().catch(i=>{Re.error(`Reconnection failed: ${i}`,He)})},this.reconnectDelay))}}catch(n){Re.error(`Failed to create WebSocket connection: ${n}`,He),t(n)}})}handleMessage(e){var t,n,r,o,i,c,l,d,p,u;try{const f=JSON.parse(e.data);switch(f.type){case"progress":Re.info(`Progress: ${f.data.percentage}% - ${f.data.message}`,He),(n=(t=this.eventHandlers).onProgress)==null||n.call(t,f.data);break;case"word":Re.info(`Word: "${f.data.word}" [${f.data.start_time}s - ${f.data.end_time}s]`,He),(o=(r=this.eventHandlers).onWord)==null||o.call(r,f.data);break;case"segment":Re.info(`Segment ${f.data.segment}: "${f.data.transcription}"`,He),(c=(i=this.eventHandlers).onSegment)==null||c.call(i,f.data);break;case"complete":Re.info("Transcription complete",He),(d=(l=this.eventHandlers).onComplete)==null||d.call(l,f.data);break;case"error":Re.error(`Server error: ${f.data.message} (code: ${f.data.code})`,He),(u=(p=this.eventHandlers).onError)==null||u.call(p,f.data);break;default:Re.error(`Unknown message type: ${f.type}`,He)}}catch(f){Re.error(`Failed to parse message: ${f}`,He)}}async sendConfig(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"config",data:e};Re.info(`Sending config: ${JSON.stringify(e)}`,He),this.ws.send(JSON.stringify(t))}async sendAudioChunk(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"audio_chunk",data:{chunk:e}};Re.info(`Sending audio chunk (${e.length} chars)`,He),this.ws.send(JSON.stringify(t))}async sendAudioChunks(e){for(const t of e)await this.sendAudioChunk(t)}async startTranscription(){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const e={type:"start",data:{}};Re.info("Starting transcription",He),this.ws.send(JSON.stringify(e))}async transcribeAudioFile(e,t=xn){this.isConnected||await this.connect(),await this.sendConfig(t);const n=await e.arrayBuffer(),r=new Uint8Array(n);let o="";const i=r.byteLength;for(let l=0;l<i;l++)o+=String.fromCharCode(r[l]);const c=btoa(o);await this.sendAudioChunk(c),await this.startTranscription()}async transcribeAudioBlob(e,t=xn){const n=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFile(n,t)}async transcribeAudioFileWithChunking(e,t={...xn,word_level_timestamps:!0,split:!1},n=Wn.WORD_STREAMING){this.isConnected||await this.connect(),Re.info("Starting client-side silence-based chunking",He);const o=await new Yc(n).chunkFile(e);Re.info(`Audio split into ${o.length} chunks (client-side)`,He);for(let i=0;i<o.length;i++){const c=o[i];await this._transcribeChunk(c,i+1,o.length,t)}Re.info("All chunks processed",He)}async _transcribeChunk(e,t,n,r){return new Promise((o,i)=>{Re.info(`Processing chunk ${t}/${n} (${e.startTime.toFixed(2)}s - ${e.endTime.toFixed(2)}s)`,He);const c=this.eventHandlers.onComplete,l=this.eventHandlers.onError;this.eventHandlers.onComplete=d=>{if(this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,c){const p={...d,metadata:{...d.metadata,chunk_index:t,chunk_start_time:e.startTime,chunk_end_time:e.endTime}};c(p)}Re.info(`Chunk ${t}/${n} transcription complete`,He),o()},this.eventHandlers.onError=d=>{this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,l&&l(d),Re.error(`Chunk ${t}/${n} transcription failed: ${d.message}`,He),i(new Error(d.message))},this._sendChunkTranscriptionRequest(e,r).catch(i)})}async _sendChunkTranscriptionRequest(e,t){const n={...t,split:!1};await this.sendConfig(n);const r=await e.blob.arrayBuffer(),o=new Uint8Array(r);let i="";const c=o.byteLength;for(let d=0;d<c;d++)i+=String.fromCharCode(o[d]);const l=btoa(i);await this.sendAudioChunk(l),await this.startTranscription()}async transcribeAudioBlobWithChunking(e,t={...xn,word_level_timestamps:!0,split:!1},n=Wn.WORD_STREAMING){const r=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFileWithChunking(r,t,n)}disconnect(){this.ws&&(Re.info("Disconnecting WebSocket",He),this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}setUrl(e){if(this.isConnected)throw Re.error("Cannot update URL while connected. Disconnect first.",He),new Error("Cannot update URL while connected");this.wsUrl=e,Re.info(`WebSocket URL updated to: ${this.wsUrl}`,He)}setMaxReconnectAttempts(e){this.maxReconnectAttempts=e}setReconnectDelay(e){this.reconnectDelay=e}}const Tm=(s={})=>{const{onChunkCreated:e,onChunkUpdated:t,onChunkDeleted:n,onChunksLoaded:r,onError:o,sessionName:i="recording-session",enableAutoPersist:c=!0,enableAutoTranscription:l=!0,minChunkDuration:d=1e3,loadPersistedChunks:p=!0,skipLastSessionChunk:u=!1,transcribeOptions:f,useWebSocket:m=!1,onWordReceived:g,onTranscriptionProgress:x}=s,[w,v]=h.useState(!1),[b,y]=h.useState(!1),[C,S]=h.useState([]),[j,N]=h.useState(0),[E,R]=h.useState(null),D=h.useRef([]);h.useEffect(()=>{D.current=C},[C]);const T=h.useRef(f);h.useEffect(()=>{T.current=f},[f]);const L=h.useRef(null),_=h.useRef(null),P=h.useRef([]),G=h.useRef([]),$=h.useRef(null),Y=h.useRef(null),A=h.useRef(null),X=h.useRef(0),I=h.useRef(!1),k=h.useRef(null),M=h.useRef(null),U=h.useCallback(F=>{const Z=new Date().toISOString().slice(0,19).replace(/[:]/g,"-");return`${i}-chunk-${F.toString().padStart(3,"0")}-${Z}`},[i]),q=h.useCallback(async()=>{if(p)try{const F=await wt.loadChunksBySession(i);if(F.length===0)return;S(F);const Z=Math.max(...F.map(H=>H.chunkNumber),0);N(Z),r==null||r(F)}catch(F){o==null||o(`Failed to load persisted chunks: ${F instanceof Error?F.message:"Unknown error"}`)}},[i,p,r]);h.useEffect(()=>(m&&!k.current&&(k.current=new Em,k.current.setEventHandlers({onWord:F=>{const Z=M.current;Z&&(g==null||g(F,Z))},onProgress:F=>{const Z=M.current;Z&&(x==null||x(F,Z))},onComplete:F=>{const Z=M.current;if(!Z)return;const H=zo(F.transcription);S(ce=>{const ue=ce.find(he=>he.id===Z);if(!ue)return ce;const pe={...ue,transcription:H,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(pe)),ce.map(he=>he.id===Z?pe:he)}),c&&wt.updateChunkTranscription(Z,H).catch(()=>{}),M.current=null},onError:F=>{const Z=M.current;Z&&(S(H=>{const ce=H.find(pe=>pe.id===Z);if(!ce)return H;const ue={...ce,transcriptionStatus:"failed",transcriptionError:F.message};return queueMicrotask(()=>t==null?void 0:t(ue)),H.map(pe=>pe.id===Z?ue:pe)}),c&&wt.updateChunkTranscriptionStatus(Z,"failed",F.message).catch(()=>{})),o==null||o(F.message),M.current=null},onConnectionOpen:()=>{},onConnectionClose:()=>{},onConnectionError:()=>{o==null||o("WebSocket connection error")}})),()=>{k.current&&(k.current.disconnect(),k.current=null)}),[m,g,x,t,o,c]);const W=h.useCallback(async(F,Z,H,ce)=>{const ue=ce||T.current,pe=D.current.find(ve=>ve.id===F);if(!pe||pe.transcriptionStatus==="processing"||pe.transcriptionStatus==="completed"&&pe.transcription)return;const he={...pe,transcriptionStatus:"processing"};if(S(ve=>(queueMicrotask(()=>t==null?void 0:t(he)),ve.map(Te=>Te.id===F?he:Te))),c)try{await wt.updateChunkTranscriptionStatus(F,"processing")}catch{}if(m&&k.current){try{M.current=F,k.current.connected||await k.current.connect(),await k.current.transcribeAudioBlob(Z,{language:(ue==null?void 0:ue.language)||"auto",word_level_timestamps:!0,no_timestamps:(ue==null?void 0:ue.no_timestamps)??!0,translate:(ue==null?void 0:ue.translate)??!1,auto_detect_language:(ue==null?void 0:ue.auto_detect_language)??!0})}catch(ve){const Te=ve instanceof Error?ve.message:"WebSocket transcription error";if(S(ke=>{const z=ke.find(Q=>Q.id===F);if(!z)return ke;const O={...z,transcriptionStatus:"failed",transcriptionError:Te};return queueMicrotask(()=>t==null?void 0:t(O)),ke.map(Q=>Q.id===F?O:Q)}),c)try{await wt.updateChunkTranscriptionStatus(F,"failed",Te)}catch{}o==null||o(`WebSocket transcription failed for ${H}: ${Te}`),M.current=null}return}try{const ve=new File([Z],`${H}.wav`,{type:"audio/wav"}),Te=await Jc.transcribeAudio(ve,ue),ke=zo(Te.transcription);if(S(z=>{const O=z.find(we=>we.id===F);if(!O)return z;const Q={...O,transcription:ke,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(Q)),z.map(we=>we.id===F?Q:we)}),c)try{await wt.updateChunkTranscription(F,ke)}catch{}}catch(ve){if(ve instanceof Kc){if(console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Skipping chunk due to denied phrases:",H),S(ke=>ke.filter(z=>z.id!==F)),c)try{await wt.deleteChunk(F)}catch(ke){console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Failed to delete chunk from storage:",ke)}n==null||n(F);return}const Te=ve instanceof Error?ve.message:"Unknown transcription error";if(S(ke=>{const z=ke.find(Q=>Q.id===F);if(!z)return ke;const O={...z,transcriptionStatus:"failed",transcriptionError:Te};return queueMicrotask(()=>t==null?void 0:t(O)),ke.map(Q=>Q.id===F?O:Q)}),c)try{await wt.updateChunkTranscriptionStatus(F,"failed",Te)}catch{}o==null||o(`Transcription failed for ${H}: ${Te}`)}},[c,t,m]),V=h.useCallback(async()=>{try{const F=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return _.current=F,!0}catch(F){const Z=F instanceof Error?F.message:"Failed to access microphone";return R(Z),o==null||o(Z),!1}},[o]),ie=h.useCallback(async()=>{if(!(!L.current||b))try{const F=X.current+1,Z={id:`segment-${crypto.randomUUID()}`,chunkNumber:F,startTime:new Date,name:U(F)};A.current=Z,y(!0)}catch(F){const Z=F instanceof Error?F.message:"Failed to start segment recording";R(Z),o==null||o(Z),y(!1)}},[b,U,o]),K=h.useCallback(async()=>{if(!(!L.current||!b||!A.current))try{const F=A.current;A.current=null,y(!1),L.current.requestData(),await new Promise(Te=>setTimeout(Te,50));const Z=new Date,H=Z.getTime()-F.startTime.getTime();if(H<d){G.current=[];return}const ce=L.current.mimeType||"audio/webm",ue=[];$.current&&ue.push($.current),ue.push(...G.current);const pe=new Blob(ue,{type:ce});let he;try{he=await Wo(pe)}catch{he=pe}const ve={...F,endTime:Z,duration:H,blob:he,size:he.size,transcriptionStatus:l?"pending":void 0};if(S(Te=>[...Te,ve]),D.current=[...D.current,ve],X.current=F.chunkNumber,N(F.chunkNumber),G.current=[],c)try{await wt.saveChunk(ve,i),e==null||e(ve),l&&W(ve.id,he,ve.name,T.current).catch(()=>{})}catch(Te){const ke=Te instanceof Error?Te.message:"Failed to save segment";R(ke),o==null||o(ke)}else e==null||e(ve),l&&W(ve.id,he,ve.name,T.current).catch(()=>{})}catch(F){const Z=F instanceof Error?F.message:"Failed to stop segment";R(Z),o==null||o(Z),y(!1)}},[b,d,c,l,i,e,o,W]),ne=h.useCallback(async()=>{if(!await V())return;const Z=new Date().toISOString().slice(0,19).replace(/[:]/g,"-"),H={id:`session-${crypto.randomUUID()}`,chunkNumber:0,startTime:new Date,name:`${i}-session-${Z}`};Y.current=H,P.current=[],G.current=[],X.current=0,$.current=null,I.current=!1;const ue=["audio/webm;codecs=opus","audio/webm;codecs=vorbis","audio/webm","audio/ogg;codecs=opus","audio/mp4;codecs=mp4a.40.2","audio/mp4"].find(he=>MediaRecorder.isTypeSupported(he))??"audio/webm",pe=new MediaRecorder(_.current,{mimeType:ue});L.current=pe,pe.ondataavailable=he=>{if(he.data.size>0){if(!I.current){$.current=he.data,I.current=!0,P.current.push(he.data);return}P.current.push(he.data),G.current.push(he.data)}},pe.onstop=async()=>{if(!Y.current)return;if(u){Y.current=null;return}const he=new Blob(P.current,{type:ue}),ve=new Date,Te=ve.getTime()-Y.current.startTime.getTime();let ke;try{ke=await Wo(he)}catch{ke=he}const z={...Y.current,endTime:ve,duration:Te,blob:ke,size:ke.size,transcriptionStatus:l?"pending":void 0};if(S(O=>[...O,z]),D.current=[...D.current,z],c)try{await wt.saveChunk(z,i),e==null||e(z),l&&W(z.id,ke,z.name,T.current).catch(()=>{})}catch(O){const Q=O instanceof Error?O.message:"Failed to save session chunk";R(Q),o==null||o(Q)}else e==null||e(z);Y.current=null},pe.onerror=()=>{R("Session recording failed"),o==null||o("Session recording failed")},pe.start(100),v(!0),R(null)},[V,i,c,l,u,e,o,W]),me=h.useCallback(()=>{L.current&&L.current.state!=="inactive"&&L.current.stop(),v(!1),y(!1),_.current&&(_.current.getTracks().forEach(F=>{F.stop()}),_.current=null)},[]),ge=h.useCallback(()=>{w&&me(),S([]),N(0),R(null),A.current=null,Y.current=null},[w,me]),oe=h.useCallback(()=>{b&&(y(!1),A.current=null,G.current=[])},[b]),Se=h.useCallback(async F=>{if(S(Z=>Z.filter(H=>H.id!==F)),c)try{await wt.deleteChunk(F)}catch(Z){o==null||o(`Failed to delete chunk from storage: ${Z instanceof Error?Z.message:"Unknown error"}`)}},[c]);h.useEffect(()=>{q()},[]),h.useEffect(()=>()=>{_.current&&_.current.getTracks().forEach(F=>F.stop())},[]);const xe=h.useCallback(async()=>{if(!(!m||!k.current)){k.current.disconnect(),await new Promise(F=>setTimeout(F,100));try{await k.current.connect()}catch{o==null||o("Failed to reconnect WebSocket")}}},[m,o]),Pe={isRecording:w,isChunkRecording:b,chunks:C,currentChunkNumber:j,error:E},ae={startRecording:ne,stopRecording:me,resetRecording:ge},te=h.useCallback(async(F,Z)=>{if(S(H=>{const ce=H.find(pe=>pe.id===F);if(!ce)return H;const ue={...ce,transcription:Z,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(ue)),H.map(pe=>pe.id===F?ue:pe)}),c)try{await wt.updateChunkTranscription(F,Z)}catch{}},[c,t]);return{state:Pe,actions:ae,startChunk:ie,stopChunk:K,discardCurrentChunk:oe,deleteChunk:Se,transcribeChunk:W,updateChunkTranscription:te,reconnectWebSocket:xe}};function Im({config:s,isRecording:e,isChunkRecording:t,callbacks:n,cumulativeActiveTimeRef:r,peakAudioLevelRef:o}){const i=h.useRef(null),c=h.useRef(!1),l=h.useRef(null),d=h.useRef({vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold}),p=h.useRef({isRecording:e,isChunkRecording:t});h.useEffect(()=>{d.current={vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold},p.current={isRecording:e,isChunkRecording:t}},[s.vadSilenceTimeout,s.vadMaxChunkDuration,s.silenceDetectionConfig.minActiveDuration,s.silenceDetectionConfig.activationThreshold,e,t]);const u=h.useCallback(()=>{i.current=null,c.current=!1,l.current=null,o.current=0},[o]),f=h.useCallback(async()=>{i.current=Date.now(),c.current=!0,l.current=null,o.current=0,await n.startChunk()},[n,o]),m=h.useCallback(async b=>{b?await n.stopChunk():n.discardCurrentChunk(),u()},[n,u]),g=h.useCallback(async()=>{p.current.isChunkRecording?(c.current=!0,l.current=null):await f()},[f]),x=h.useCallback(async()=>{if(!p.current.isChunkRecording||!c.current)return;const b=Date.now();if(l.current===null){l.current=b;return}if(b-l.current>=d.current.vadSilenceTimeout){const j=r.current>=d.current.minActiveDuration,E=o.current>=d.current.activationThreshold;await m(j&&E)}},[m,r,o]),w=h.useCallback(async()=>{if(!p.current.isChunkRecording||!i.current)return;Date.now()-i.current>=d.current.vadMaxChunkDuration&&(await n.stopChunk(),c.current&&!p.current.isChunkRecording?await f():u())},[n,f,u]);return{processVADAudio:h.useCallback((b,y)=>{if(!p.current.isRecording)return;const C=!b,S=C&&y,j=C&&!p.current.isChunkRecording&&!c.current;(S||j)&&g(),b&&x(),w()},[g,x,w]),resetVADState:u}}const qa={silenceThreshold:.47,minSilenceDuration:0,minActiveDuration:1500,activationThreshold:.67},Vs={enableAutoTranscription:!0,minChunkDuration:500,silenceDetectionConfig:qa,autoStopOnSilence:!1,autoCreateChunks:!0,autoChunkCreationTime:1e3,skipLastSessionChunk:!0,transcribeOptions:Vc,chunkingMode:"time",vadMaxChunkDuration:1e4,vadSilenceTimeout:1500,useWebSocket:!1},In={default:{id:"custom-1759528805538",name:"Default (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:qa.activationThreshold},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},eng:{id:"custom-1759528805538",name:"Eng (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},vi:{name:"VN",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},ws:{name:"WS",description:"WebSocket real-time streaming",config:{silenceDetectionConfig:{minActiveDuration:800,activationThreshold:.67},useWebSocket:!0,chunkingMode:"time",autoCreateChunks:!0,autoChunkCreationTime:1e3,minChunkDuration:500,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,model:"ggml-distil-large-v3"}}}},Xc="audio-panel-custom-presets";function Qc(s,e){if(s===e)return!0;if(typeof s!="object"||typeof e!="object"||s===null||e===null)return!1;const t=Object.keys(s),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!n.includes(r)||!Qc(s[r],e[r]))return!1;return!0}function Zc(s){const e={};return Object.keys(s).forEach(t=>{Qc(s[t],Vs[t])||(e[t]=s[t])}),e}function zn(s){return{...Vs,...s,silenceDetectionConfig:{...Vs.silenceDetectionConfig,...s.silenceDetectionConfig??{}},transcribeOptions:{...Vs.transcribeOptions,...s.transcribeOptions??{}}}}function mn(){try{const s=localStorage.getItem(Xc);return s?JSON.parse(s).map(t=>({...t,createdAt:new Date(t.createdAt)})):[]}catch(s){return console.error("Failed to load custom presets:",s),[]}}function Va(s){try{localStorage.setItem(Xc,JSON.stringify(s))}catch(e){console.error("Failed to save custom presets:",e)}}function Am(s,e,t){const n=Zc(t),r={id:`custom-${Date.now()}`,name:s,description:e,config:n,createdAt:new Date},o=mn();return o.push(r),Va(o),r}function Pm(s,e){const t=mn(),n=t.findIndex(i=>i.id===s);if(n===-1)return console.error(`Preset with id ${s} not found`),null;const r=Zc(e),o={...t[n],config:r};return t[n]=o,Va(t),o}function Rm(s){const t=mn().filter(n=>n.id!==s);Va(t)}function Dm(s={}){const e=h.useMemo(()=>({...qa,...s}),[s]),[t,n]=mu.useState({isSilent:!0,currentLevel:0,silenceThreshold:e.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}),r=h.useCallback(c=>{const l=Math.max(...c),d=Date.now();n(p=>{const u=d-p.lastStateChange,f=l<=p.silenceThreshold;let m=p.isSilent,g=p.silenceDuration,x=p.activeDuration,w=p.lastStateChange;return f?(g+=u,x=0,!p.isSilent&&g>=e.minSilenceDuration&&(m=!0,w=d)):(x+=u,g=0,p.isSilent&&x>=e.minActiveDuration&&(m=!1,w=d)),{isSilent:m,currentLevel:l,silenceThreshold:p.silenceThreshold,silenceDuration:g,activeDuration:x,lastStateChange:w}})},[e.minSilenceDuration,e.minActiveDuration,t.lastStateChange]),o=h.useCallback(c=>{const l=Math.max(0,Math.min(1,c));n(d=>({...d,silenceThreshold:l}))},[]),i=h.useCallback(()=>{n(c=>({isSilent:!0,currentLevel:0,silenceThreshold:c.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}))},[]);return{state:t,processAudioData:r,updateThreshold:o,reset:i}}const _t=h.forwardRef(({className:s,...e},t)=>a.jsxs(Qi,{ref:t,className:B("relative flex w-full touch-none select-none items-center",s),...e,children:[a.jsx(Ku,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:a.jsx(Ju,{className:"absolute h-full bg-primary"})}),a.jsx(Yu,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));_t.displayName=Qi.displayName;const _m=({audioData:s,silenceState:e,onThresholdChange:t,hideSilenceControls:n=!1,duration:r=0,className:o=""})=>{const i=h.useCallback(d=>{t==null||t(d[0])},[t]),c=d=>{const p=d/1e3,u=Math.floor(p/60),f=Math.floor(p%60),m=Math.floor(p%1*10);return`${u}:${f.toString().padStart(2,"0")}.${m}`};return a.jsx("div",{className:`silence-detection-visualizer ${o}`,children:a.jsxs("div",{className:"visualization-container relative flex flex-col p-2 bg-muted/50 rounded-lg",style:{height:"64px"},children:[a.jsxs("div",{className:"top-controls flex justify-between items-center gap-2 mb-1 z-20",children:[a.jsx("div",{className:"time-display flex items-center",children:a.jsx("span",{className:"text-[9px] font-medium text-foreground",children:c(r)})}),a.jsxs("div",{className:"right-controls flex items-center gap-2",children:[a.jsxs("div",{className:"status-display flex items-center gap-1",children:[a.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${e.isSilent?"bg-gray-400":"bg-green-500 animate-pulse"}`}),a.jsx("span",{className:"text-[9px] font-medium",children:e.isSilent?"Silent":"Active"}),a.jsx("span",{className:"text-[9px] text-muted-foreground",children:`${(e.currentLevel*100).toFixed(0)}%`})]}),!n&&a.jsxs("div",{className:"threshold-control flex-1 flex items-center gap-1.5",children:[a.jsx("label",{className:"text-[9px] font-medium shrink-0",children:`T: ${(e.silenceThreshold*100).toFixed(0)}%`}),a.jsx(_t,{min:0,max:1,step:.01,value:[e.silenceThreshold],onValueChange:i,className:"flex-1"})]})]})]}),a.jsxs("div",{className:"bars-container relative flex items-end justify-center flex-1",children:[a.jsx("div",{className:"threshold-line absolute left-0 right-0 border-t border-red-500 border-dashed z-10",style:{bottom:`${e.silenceThreshold*100}%`}}),a.jsx("div",{className:"visualization-bars flex items-end justify-center gap-0.5 h-full w-full max-w-2xl relative z-0",children:s.map((d,p)=>{const u=Math.max(d*100,2),f=d>e.silenceThreshold;return a.jsx("div",{className:"visualization-bar flex-1 max-w-2 rounded-t transition-all duration-75 ease-out",style:{height:`${u}%`,backgroundColor:f?`rgba(34, 197, 94, ${.3+d*.7})`:`rgba(156, 163, 175, ${.3+d*.7})`,minHeight:"2px"}},p)})})]})]})})};function el({transcribeOptions:s,useWebSocket:e,onTranscribeOptionsChange:t,onUseWebSocketChange:n}){return a.jsxs("div",{className:"transcription-options-section space-y-1 pt-2 border-t border-border",children:[a.jsx("h3",{className:"text-[9px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcription Options"}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"use-websocket",className:"text-[9px] font-semibold",children:"Use WebSocket Transcription"}),a.jsx(Ot,{id:"use-websocket",checked:e,onCheckedChange:n,className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:e?"Real-time streaming with progress updates and word-by-word results":"Standard HTTP API with complete results"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsx(je,{className:"text-[9px] font-semibold",children:"Language"}),a.jsxs(Ut,{value:s.language??"auto",onValueChange:r=>t({...s,language:r}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Kt,{placeholder:"Select language"})}),a.jsxs(At,{children:[a.jsx(Oe,{value:"auto",children:"Auto Detect"}),a.jsx(Oe,{value:"en",children:"English"}),a.jsx(Oe,{value:"vi",children:"Vietnamese"}),a.jsx(Oe,{value:"es",children:"Spanish"}),a.jsx(Oe,{value:"fr",children:"French"}),a.jsx(Oe,{value:"de",children:"German"}),a.jsx(Oe,{value:"pt",children:"Portuguese"}),a.jsx(Oe,{value:"ru",children:"Russian"}),a.jsx(Oe,{value:"ja",children:"Japanese"}),a.jsx(Oe,{value:"zh",children:"Chinese"}),a.jsx(Oe,{value:"ko",children:"Korean"}),a.jsx(Oe,{value:"it",children:"Italian"}),a.jsx(Oe,{value:"nl",children:"Dutch"})]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Transcription language"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsx(je,{className:"text-[9px] font-semibold",children:"Model"}),a.jsxs(Ut,{value:s.model??Ho[0],onValueChange:r=>t({...s,model:r}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Kt,{placeholder:"Select model"})}),a.jsx(At,{children:Ho.map(r=>a.jsx(Oe,{value:r,children:r},r))})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Whisper model"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"translate-english",className:"text-[9px] font-semibold",children:"Translate"}),a.jsx(Ot,{id:"translate-english",checked:s.translate??!1,onCheckedChange:r=>t({...s,translate:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Translate to English"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"auto-detect-lang",className:"text-[9px] font-semibold",children:"Auto-Detect"}),a.jsx(Ot,{id:"auto-detect-lang",checked:s.auto_detect_language??!1,onCheckedChange:r=>t({...s,auto_detect_language:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto language detection"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"no-timestamps",className:"text-[9px] font-semibold",children:"No Timestamps"}),a.jsx(Ot,{id:"no-timestamps",checked:s.no_timestamps!==!1,onCheckedChange:r=>t({...s,no_timestamps:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Remove timestamps"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"no-prints",className:"text-[9px] font-semibold",children:"Quiet Mode"}),a.jsx(Ot,{id:"no-prints",checked:s.no_prints!==!1,onCheckedChange:r=>t({...s,no_prints:r}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Suppress verbose output"})]})]})]})}const vn="audio-panel-selected-preset";function Om({config:s,onConfigChange:e}){const[t,n]=h.useState([]),[r,o]=h.useState(!1),[i,c]=h.useState(""),[l,d]=h.useState(!1),[p,u]=h.useState("");h.useEffect(()=>{const b=mn();n(b);let y=localStorage.getItem(vn);y||(y="default",localStorage.setItem(vn,y)),u(y)},[]);const f=b=>{u(b),localStorage.setItem(vn,b);const y=In[b];if(y){const S=zn(y.config);e(S);return}const C=t.find(S=>S.id===b);if(C){const S=zn(C.config);e(S)}},m=()=>{if(!i.trim()){alert("Please enter a preset name");return}const b=Am(i.trim(),"Custom configuration",s);n([...t,b]),c(""),o(!1)},g=()=>{c(""),o(!1)},x=b=>{const y=Pm(b,s);y&&(n(t.map(C=>C.id===b?y:C)),d(!0))},w=b=>{Rm(b),n(t.filter(y=>y.id!==b)),p===b&&(u(""),localStorage.removeItem(vn))},v=()=>{const b=In[p];if(b)return b.name;const y=t.find(C=>C.id===p);return(y==null?void 0:y.name)||""};return a.jsxs("div",{className:"config-view space-y-2 text-[10px]",children:[a.jsxs("div",{className:"preset-selector space-y-1",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{className:"text-[9px] font-semibold",children:"Configuration Preset"}),!r&&a.jsx(de,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>o(!0),title:"Save current configuration as preset",children:a.jsx(Cn,{className:"h-3 w-3"})})]}),r?a.jsxs("div",{className:"flex gap-1",children:[a.jsx(We,{placeholder:"Enter preset name...",value:i,onChange:b=>c(b.target.value),onKeyDown:b=>{b.key==="Enter"&&m(),b.key==="Escape"&&g()},className:"h-8 text-[9px] flex-1",autoFocus:!0}),a.jsx(de,{onClick:m,size:"sm",className:"h-8 px-2",title:"Save preset",children:a.jsx(Cn,{className:"h-3 w-3"})}),a.jsx(de,{onClick:g,size:"sm",variant:"ghost",className:"h-8 px-2",title:"Cancel",children:"âœ•"})]}):a.jsxs(Ut,{value:p,onValueChange:f,open:l,onOpenChange:d,children:[a.jsx(It,{className:"h-8 text-[9px]",children:a.jsx(Kt,{placeholder:"Select a preset...",children:p&&a.jsx("span",{className:"font-medium",children:v()})})}),a.jsxs(At,{children:[Object.entries(In).map(([b,y])=>a.jsxs(Oe,{value:b,children:[a.jsx("span",{className:"font-medium",children:y.name}),a.jsx("span",{className:"text-[8px] text-muted-foreground ml-2",children:y.description})]},b)),t.map(b=>a.jsx(Oe,{value:b.id,children:a.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[a.jsxs("div",{className:"flex flex-col items-start flex-1 min-w-0",children:[a.jsx("span",{className:"font-medium",children:b.name}),a.jsx("span",{className:"text-[8px] text-muted-foreground",children:b.description})]}),a.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[a.jsx(de,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),x(b.id)},onClick:y=>{y.preventDefault(),y.stopPropagation()},title:"Update preset with current settings",children:a.jsx(Cn,{className:"h-3 w-3 text-blue-500"})}),a.jsx(de,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:y=>{y.preventDefault(),y.stopPropagation(),w(b.id)},onClick:y=>{y.preventDefault(),y.stopPropagation()},title:"Delete preset",children:a.jsx(St,{className:"h-3 w-3 text-red-500"})})]})]})},b.id))]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:r?"Enter a name for the current configuration":"Quick apply preset configurations"})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"auto-transcription",className:"text-[9px] font-semibold",children:"Auto-Transcribe"}),a.jsx(Ot,{id:"auto-transcription",checked:s.enableAutoTranscription,onCheckedChange:b=>e({enableAutoTranscription:b}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-transcribe chunks"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Chunk: ",s.minChunkDuration,"ms"]}),a.jsx(_t,{min:500,max:5e3,step:500,value:[s.minChunkDuration],onValueChange:b=>e({minChunkDuration:b[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min chunk duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[a.jsx(je,{className:"text-[9px] font-semibold",children:"Chunking Mode"}),a.jsxs(Ut,{value:s.chunkingMode,onValueChange:b=>e({chunkingMode:b}),children:[a.jsx(It,{className:"h-7 text-[9px]",children:a.jsx(Kt,{})}),a.jsxs(At,{children:[a.jsx(Oe,{value:"time",children:"Time-based"}),a.jsx(Oe,{value:"vad",children:"Voice Activity Detection (VAD)"}),a.jsx(Oe,{value:"silence-based",children:"Silence-based Splitting"})]})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:s.chunkingMode==="time"?"Fixed interval chunking for predictable real-time updates":s.chunkingMode==="vad"?"Speech-driven chunking for natural boundaries and better accuracy":"VAD recording with post-processing silence-based splits for precise segmentation"})]}),s.chunkingMode==="time"&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"auto-create-chunks",className:"text-[9px] font-semibold",children:"Auto-Create"}),a.jsx(Ot,{id:"auto-create-chunks",checked:s.autoCreateChunks,onCheckedChange:b=>e({autoCreateChunks:b}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-create chunks"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Auto-Time: ",s.autoChunkCreationTime,"ms"]}),a.jsx(_t,{min:500,max:5e3,step:500,value:[s.autoChunkCreationTime],onValueChange:b=>e({autoChunkCreationTime:b[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-creation interval"})]})]}),(s.chunkingMode==="vad"||s.chunkingMode==="silence-based")&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Max Duration: ",s.vadMaxChunkDuration,"ms"]}),a.jsx(_t,{min:3e3,max:3e4,step:1e3,value:[s.vadMaxChunkDuration],onValueChange:b=>e({vadMaxChunkDuration:b[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Max VAD chunk duration (safety ceiling)"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Silence Timeout: ",s.vadSilenceTimeout,"ms"]}),a.jsx(_t,{min:500,max:5e3,step:100,value:[s.vadSilenceTimeout],onValueChange:b=>e({vadSilenceTimeout:b[0]}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence duration to end chunk"})]})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"skip-last-chunk",className:"text-[9px] font-semibold",children:"Skip Last Chunk"}),a.jsx(Ot,{id:"skip-last-chunk",checked:s.skipLastSessionChunk,onCheckedChange:b=>e({skipLastSessionChunk:b}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Skip last session chunk"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{htmlFor:"auto-stop-silence",className:"text-[9px] font-semibold",children:"Auto-Stop"}),a.jsx(Ot,{id:"auto-stop-silence",checked:s.autoStopOnSilence,onCheckedChange:b=>e({autoStopOnSilence:b}),className:"scale-75"})]}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Stop on silence"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Silence: ",Math.round(s.silenceDetectionConfig.silenceThreshold*100),"%"]}),a.jsx(_t,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.silenceThreshold],onValueChange:b=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,silenceThreshold:b[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence threshold"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Silent: ",s.silenceDetectionConfig.minSilenceDuration,"ms"]}),a.jsx(_t,{min:100,max:5e3,step:100,value:[s.silenceDetectionConfig.minSilenceDuration],onValueChange:b=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minSilenceDuration:b[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min silence duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Active: ",s.silenceDetectionConfig.minActiveDuration,"ms"]}),a.jsx(_t,{min:100,max:3e3,step:100,value:[s.silenceDetectionConfig.minActiveDuration],onValueChange:b=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minActiveDuration:b[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min active duration"})]}),a.jsxs("div",{className:"config-item space-y-0.5",children:[a.jsxs(je,{className:"text-[9px] font-semibold",children:["Activation: ",Math.round(s.silenceDetectionConfig.activationThreshold*100),"%"]}),a.jsx(_t,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.activationThreshold],onValueChange:b=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,activationThreshold:b[0]}}),className:"w-full"}),a.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Peak level threshold (filters body noise)"})]})]}),a.jsx(el,{transcribeOptions:s.transcribeOptions,useWebSocket:s.useWebSocket,onTranscribeOptionsChange:b=>e({transcribeOptions:b}),onUseWebSocketChange:b=>e({useWebSocket:b})})]})}function Us({audioBlob:s,isPlaying:e=!0,className:t="",height:n=80,barWidth:r=2,barGap:o=1,barColor:i="#94a3b8",progressColor:c="#3b82f6"}){const l=h.useRef(null),[d,p]=h.useState([]),[u,f]=h.useState(!1),[m,g]=h.useState({width:0,height:0});return h.useEffect(()=>{if(!s)return;let x=!1;return f(!0),(async()=>{try{const v=await s.arrayBuffer(),b=new AudioContext,y=await b.decodeAudioData(v);if(x){await b.close();return}const C=y.getChannelData(0),S=100,j=Math.floor(C.length/S),N=[];for(let T=0;T<S;T++){const L=j*T;let _=0;for(let G=0;G<j;G++){const $=C[L+G];_+=$*$}const P=Math.sqrt(_/j);N.push(P)}const E=Math.max(...N),R=1.5,D=N.map(T=>Math.min(1,T/E*R));x||p(D),await b.close()}catch(v){console.error("Failed to generate waveform:",v)}finally{x||f(!1)}})(),()=>{x=!0}},[s]),h.useEffect(()=>{if(u)return;const x=l.current;if(!x||d.length===0)return;const w=x.getContext("2d");if(!w)return;const v=x.width,b=x.height;if(v===0||b===0)return;const y=r+o,C=Math.min(d.length,Math.floor(v/y));w.clearRect(0,0,v,b);for(let S=0;S<C;S++){const j=Math.floor(S/C*d.length),N=d[j],E=Math.max(3,b*.05),R=b*.95,D=Math.max(E,N*R),T=S*y,L=(b-D)/2;w.fillStyle=e?c:i,w.fillRect(T,L,r,D)}},[d,e,r,o,i,c,m,u]),h.useEffect(()=>{const x=l.current;if(!x)return;const w=()=>{const v=x.parentElement;if(!v)return;const b=v.getBoundingClientRect();b.width>0&&b.height>0&&(x.width!==b.width||x.height!==b.height)&&(x.width=b.width,x.height=b.height,g({width:b.width,height:b.height}))};return w(),d.length>0&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{w()})}),window.addEventListener("resize",w),()=>{window.removeEventListener("resize",w)}},[n,d.length]),u?a.jsx("div",{className:`waveform-loading flex items-center justify-center ${t}`,style:{height:n},children:a.jsx("div",{className:"text-xs text-gray-400",children:"Generating waveform..."})}):a.jsx("div",{className:`waveform-container ${t}`,style:{height:n},children:a.jsx("canvas",{ref:l,className:"waveform-visualizer w-full h-full",style:{display:"block"}})})}function Lm({chunk:s,isPlaying:e,onPlay:t,onPause:n,onDownload:r,onDelete:o,onTranscribe:i,variant:c="default",showTranscribe:l=!1}){const d=c==="error"?"hover:bg-red-100":"hover:bg-slate-200";return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(de,{size:"sm",variant:"ghost",onClick:e?n:t,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:e?a.jsx(Cp,{className:"w-3.5 h-3.5"}):a.jsx(lc,{className:"w-3.5 h-3.5"})}),a.jsx(de,{size:"sm",variant:"ghost",onClick:r,className:`h-7 w-7 p-0 ${d}`,disabled:!s.blob,children:a.jsx(or,{className:"w-3.5 h-3.5"})}),l&&i&&a.jsx(de,{size:"sm",variant:"ghost",onClick:i,className:`h-7 w-7 p-0 text-blue-600 hover:text-blue-700 ${c==="error"?"hover:bg-red-100":"hover:bg-blue-50"}`,disabled:!s.blob||s.transcriptionStatus==="processing",title:"Transcribe audio",children:a.jsx(On,{className:"w-3.5 h-3.5"})}),o&&a.jsx(de,{size:"sm",variant:"ghost",onClick:o,className:`h-7 w-7 p-0 text-red-600 hover:text-red-700 ${c==="error"?"hover:bg-red-100":"hover:bg-red-50"}`,children:a.jsx(St,{className:"w-3.5 h-3.5"})})]})}function Mm({duration:s,variant:e="default"}){const t=r=>{const o=r/1e3,i=Math.floor(o),c=Math.floor((o-i)*100);return c>0?`${i}.${c.toString().padStart(2,"0")}s`:`${i}s`},n={completed:"text-xs text-green-600 border-green-600 bg-green-50",processing:"text-xs text-blue-600 border-blue-600 bg-blue-50",failed:"text-xs text-red-600 border-red-600 bg-red-50",pending:"text-xs text-gray-600 border-gray-400 bg-gray-50",default:"text-xs text-gray-600 border-gray-400 bg-gray-50"};return a.jsxs(ht,{variant:"outline",className:n[e],children:[a.jsx(pc,{className:"w-3 h-3 mr-1"}),t(s)]})}const Fm={completed:{className:"bg-card",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx(Us,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsx("div",{className:"text-sm leading-relaxed font-medium",children:s.transcription})]})},processing:{className:"bg-blue-50 border-blue-200",badgeVariant:"processing",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx(Us,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(lr,{className:"w-4 h-4 text-blue-600 animate-spin"}),a.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Transcribing audio..."})]})]})},failed:{className:"bg-red-50 border-red-200",badgeVariant:"failed",controlsVariant:"error",showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx(Us,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(cc,{className:"w-4 h-4 text-red-600"}),a.jsxs("span",{className:"text-sm font-medium text-red-700",children:["Transcription Failed",s.transcriptionError&&a.jsxs("span",{className:"text-xs font-normal ml-1",children:["(",s.transcriptionError,")"]})]})]})]})},pending:{className:"bg-gray-50 border-gray-200",badgeVariant:"pending",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx(Us,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(pc,{className:"w-4 h-4 text-gray-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"Waiting to transcribe..."})]})]})},none:{className:"bg-gray-50 border-gray-200",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>a.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&a.jsx(Us,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Js,{className:"w-4 h-4 text-gray-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"No transcription available"})]})]})}};function $m({chunk:s,isPlaying:e,showWaveform:t,onPlay:n,onPause:r,onDownload:o,onDelete:i,onTranscribe:c}){const d=s.transcription?"completed":s.transcriptionStatus==="processing"?"processing":s.transcriptionStatus==="failed"?"failed":s.transcriptionStatus==="pending"?"pending":"none",p=Fm[d];return a.jsx(pn,{className:"chunk-item shadow-sm",children:a.jsx(hn,{className:"p-0",children:a.jsxs("div",{className:`flex flex-col border rounded-md py-2 px-2 gap-2 ${p.className}`,children:[p.renderContent(s,e,t),a.jsxs("div",{className:"flex justify-between items-center",children:[s.duration&&a.jsx(Mm,{duration:s.duration,variant:p.badgeVariant}),a.jsx(Lm,{chunk:s,isPlaying:e,onPlay:n,onPause:r,onDownload:o,onDelete:i,onTranscribe:c,variant:p.controlsVariant,showTranscribe:p.showTranscribe})]})]})})})}function tl({chunks:s,className:e="",onChunkDelete:t,onChunkTranscribe:n,onTranscribeAll:r,onClearAll:o}){const[i,c]=h.useState(null),[l,d]=h.useState(!1),[p,u]=h.useState({language:"vi",model:"ggml-distil-large-v3",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1}),[f,m]=h.useState(!1),g=h.useRef(null),x=h.useRef(null),w=h.useCallback(R=>{if(!R.blob)return;g.current&&(g.current.pause(),x.current&&URL.revokeObjectURL(x.current));const D=new Audio;g.current=D;const T=URL.createObjectURL(R.blob);x.current=T,D.src=T,D.onplay=()=>{c(R.id)},D.onpause=()=>{c(null)},D.onended=()=>{c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},D.onerror=L=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Audio playback error:",L),c(null),x.current&&(URL.revokeObjectURL(x.current),x.current=null)},D.play().catch(L=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Failed to play audio:",L),c(null)})},[]),v=h.useCallback(()=>{g.current&&g.current.pause()},[]),b=h.useCallback(R=>{if(!R.blob)return;const D=URL.createObjectURL(R.blob),T=document.createElement("a");T.href=D,T.download=`${R.name}.wav`,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(D)},[]),y=h.useCallback(async R=>{i===R&&g.current&&(g.current.pause(),c(null)),await(t==null?void 0:t(R))},[i,t]),C=h.useCallback(async R=>{await(n==null?void 0:n(R))},[n]),S=h.useCallback(async()=>{g.current&&(g.current.pause(),c(null)),await(o==null?void 0:o())},[o]),j=h.useCallback(async()=>{await(r==null?void 0:r(p))},[r,p]);h.useEffect(()=>()=>{g.current&&g.current.pause(),x.current&&URL.revokeObjectURL(x.current)},[]);const N=s.reduce((R,D)=>R+(D.duration??0),0),E=s.reduce((R,D)=>R+(D.size??0),0);return a.jsx("div",{className:`chunks-panel flex flex-col h-full ${e}`,children:a.jsxs(pn,{className:"flex-1 flex flex-col rounded-none",children:[a.jsxs(Ha,{className:"pb-4",children:[a.jsxs(Ga,{className:"flex items-center justify-between",children:[a.jsx("span",{children:"Audio Chunks"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(ht,{variant:"outline",children:s.length}),s.length>0&&r&&a.jsx(ur,{variant:"ghost",size:"sm",buttonClassName:"h-6 w-6 p-0",contentClassName:"w-80",title:"Transcription Options",align:"end",storageKey:"chunks-panel-transcription-options",children:a.jsx("div",{className:"chunk-options-config",children:a.jsx(fr,{label:"Transcribe All",onAction:j,size:"sm",className:"w-full",tooltipText:"Click to transcribe all chunks, or click gear for options",popoverContent:a.jsx(el,{transcribeOptions:p,useWebSocket:f,onTranscribeOptionsChange:u,onUseWebSocketChange:m})})})}),s.length>0&&a.jsx(de,{variant:"ghost",size:"sm",onClick:()=>d(!l),className:`h-6 px-2 text-xs ${l?"bg-blue-50 text-blue-600":"text-gray-600"}`,title:l?"Hide waveforms":"Show waveforms",children:a.jsx(jp,{className:"w-3 h-3"})}),s.length>0&&o&&a.jsx(de,{variant:"ghost",size:"sm",onClick:S,className:"h-6 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",title:"Clear all chunks",children:a.jsx(St,{className:"w-3 h-3"})})]})]}),s.length>0&&a.jsxs("div",{className:"stats-summary text-xs text-gray-600 space-y-1",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Total Duration:"}),a.jsxs("span",{children:[Math.floor(N/1e3),"s"]})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Total Size:"}),a.jsxs("span",{children:[(E/1024).toFixed(1)," KB"]})]})]})]}),a.jsx(hn,{className:"flex-1 overflow-hidden p-4",children:s.length===0?a.jsxs("div",{className:"empty-state flex flex-col items-center justify-center h-full text-center text-gray-500",children:[a.jsx("div",{className:"mb-2",children:"ðŸŽ¤"}),a.jsx("p",{className:"text-sm",children:"No chunks recorded yet"}),a.jsx("p",{className:"text-xs mt-1",children:"Start recording and speak to create chunks"})]}):a.jsx("div",{className:"chunks-list overflow-y-auto h-full space-y-2 pr-2",children:s.slice().reverse().map(R=>a.jsx($m,{chunk:R,isPlaying:i===R.id,showWaveform:l,onPlay:()=>w(R),onPause:v,onDownload:()=>b(R),onDelete:()=>void y(R.id),onTranscribe:n?()=>void C(R.id):void 0},R.id))})})]})})}const Go="audio-panel-config";function Um({sessionName:s="audio-panel-session",enableAutoPersist:e=!0,loadPersistedChunks:t=!1,initialConfig:n,autoStart:r=!1,startTrigger:o,stopTrigger:i,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onSilenceDetected:p,onClearAndRecord:u,onWordReceived:f,onTranscriptionProgress:m,onRecordingStateChange:g,className:x=""}){var Q,we;const[w,v]=h.useState(Array(32).fill(0)),[b,y]=h.useState(0),S=(()=>{try{const re=localStorage.getItem(Go);if(re)return JSON.parse(re)}catch(re){console.error("Failed to load persisted config:",re)}return{}})(),[j,N]=h.useState(()=>{let re={...Vs,...S},be=localStorage.getItem("audio-panel-selected-preset");if(be||(be="default",localStorage.setItem("audio-panel-selected-preset",be)),be)try{const J=In[be];if(J)re=zn(J.config);else{const Ce=mn().find(Ie=>Ie.id===be);Ce&&(re=zn(Ce.config))}}catch(J){console.error("Failed to apply selected preset:",J)}return{...re,...n}}),E=h.useRef(null),R=h.useRef(null),D=h.useRef(null),T=h.useRef(null),L=h.useRef(!1),_=h.useCallback(re=>{console.error("ðŸŽ¤ Recorder error:",re)},[]),P=h.useRef(j.autoStopOnSilence),G=h.useRef(p),$=h.useRef(null),Y=h.useRef(null),A=h.useRef(null),X=h.useRef(!1),I=h.useRef(!0),k=h.useRef(0),M=h.useRef(null),U=h.useRef(0),q=h.useRef(j.chunkingMode);h.useEffect(()=>{P.current=j.autoStopOnSilence},[j.autoStopOnSilence]),h.useEffect(()=>{q.current=j.chunkingMode},[j.chunkingMode]),h.useEffect(()=>{G.current=p},[p]),h.useEffect(()=>{n!=null&&n.transcribeOptions&&N(re=>({...re,transcribeOptions:{...re.transcribeOptions,...n.transcribeOptions}}))},[(Q=n==null?void 0:n.transcribeOptions)==null?void 0:Q.language,(we=n==null?void 0:n.transcribeOptions)==null?void 0:we.model]);const{state:W,actions:V,startChunk:ie,stopChunk:K,discardCurrentChunk:ne,deleteChunk:me,transcribeChunk:ge,updateChunkTranscription:oe,reconnectWebSocket:Se}=Tm({sessionName:s,enableAutoPersist:e,enableAutoTranscription:j.chunkingMode==="silence-based"?!1:j.enableAutoTranscription,minChunkDuration:j.minChunkDuration,loadPersistedChunks:t,skipLastSessionChunk:j.skipLastSessionChunk,transcribeOptions:j.transcribeOptions,useWebSocket:j.useWebSocket,onWordReceived:f,onTranscriptionProgress:m,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:d,onError:_}),xe=h.useCallback(re=>{if(re.length===0)return"";if(re.length===1)return re[0].trim();let be=re[0].trim();for(let J=1;J<re.length;J++){let fe=re[J].trim();if(!fe)continue;!/[.!?â€¦]$/.test(be)&&fe.length>0&&(fe=fe.charAt(0).toLowerCase()+fe.slice(1)),be=`${be} ${fe}`}return be},[]),Pe=h.useCallback(async re=>{if(j.chunkingMode==="silence-based"&&re.blob){console.log(`ðŸŽ¤ Processing chunk for silence-based splitting: ${re.name} (${re.blob.size} bytes)`);try{const be=await re.blob.arrayBuffer(),fe=await new AudioContext().decodeAudioData(be);console.log(`ðŸŽ¤ AudioBuffer duration: ${fe.duration.toFixed(2)}s`);const Ce=Wn.DEFAULT;console.log("ðŸŽ¤ Using DEFAULT preset:",Ce);const Ae=await new Yc(Ce).chunkAudio(fe);if(console.log(`ðŸŽ¤ Silence-based split: ${Ae.length} chunks detected`),console.log("ðŸŽ¤ Chunk details:",Ae.map((Ee,_e)=>({index:_e+1,startTime:Ee.startTime.toFixed(2)+"s",endTime:Ee.endTime.toFixed(2)+"s",duration:Ee.duration.toFixed(2)+"s",blobSize:Ee.blob.size+" bytes"}))),j.enableAutoTranscription&&Ae.length>0){const Ee=[];for(let Me=0;Me<Ae.length;Me++){const Be=Ae[Me],ze=`${re.name}-split-${Me+1}`;console.log(`ðŸŽ¤ Transcribing split ${Me+1}/${Ae.length}: ${ze} (${Be.duration.toFixed(2)}s)`);try{const lt=new File([Be.blob],`${ze}.wav`,{type:"audio/wav"}),Ye=await Jc.transcribeAudio(lt,j.transcribeOptions);Ee.push(Ye.transcription),console.log(`ðŸŽ¤ Split ${Me+1} transcribed: "${Ye.transcription}"`);const nt=xe(Ee);nt&&(await oe(re.id,nt),console.log(`ðŸŽ¤ Progressive update: "${nt}"`))}catch(lt){console.error(`ðŸŽ¤ Failed to transcribe split ${Me+1}:`,lt),Ee.push(`[Error: ${lt instanceof Error?lt.message:"Unknown error"}]`)}}const _e=xe(Ee);console.log(`ðŸŽ¤ Final transcription (${Ae.length} splits): "${_e}"`)}}catch(be){console.error("ðŸŽ¤ Failed to split chunk by silence:",be)}}},[j,oe,xe]);h.useEffect(()=>{if(j.chunkingMode==="silence-based"&&W.chunks.length>0){const re=W.chunks[W.chunks.length-1];!re.transcription&&!re.transcriptionStatus&&Pe(re)}},[W.chunks,j.chunkingMode,Pe]);const ae=Dm(j.silenceDetectionConfig),te=h.useRef(ae);h.useEffect(()=>{te.current=ae},[ae]);const F=Im({config:j.chunkingMode==="silence-based"?{...j,vadSilenceTimeout:100}:j,isRecording:W.isRecording,isChunkRecording:W.isChunkRecording,callbacks:{startChunk:ie,stopChunk:K,discardCurrentChunk:ne},cumulativeActiveTimeRef:k,peakAudioLevelRef:U}),Z=h.useRef(F);h.useEffect(()=>{Z.current=F},[F]);const H=h.useCallback(re=>{var be;N(J=>{const fe={...J,...re};return re.silenceDetectionConfig&&(fe.silenceDetectionConfig={...J.silenceDetectionConfig,...re.silenceDetectionConfig}),re.transcribeOptions&&(fe.transcribeOptions={...J.transcribeOptions,...re.transcribeOptions}),fe}),((be=re.silenceDetectionConfig)==null?void 0:be.silenceThreshold)!==void 0&&ae.updateThreshold(re.silenceDetectionConfig.silenceThreshold)},[ae]);h.useEffect(()=>{try{localStorage.setItem(Go,JSON.stringify(j))}catch(re){console.error("Failed to persist config:",re)}},[j]),h.useEffect(()=>{A.current=ie},[ie]),h.useEffect(()=>{$.current=K},[K]),h.useEffect(()=>{Y.current=ne},[ne]);const ce=h.useRef(W.isRecording);h.useEffect(()=>{ce.current=W.isRecording},[W.isRecording]),h.useEffect(()=>{X.current=W.isChunkRecording},[W.isChunkRecording]);const ue=h.useCallback(async()=>{try{const re=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),be=new AudioContext,J=be.createAnalyser();J.fftSize=256,J.smoothingTimeConstant=.8,be.createMediaStreamSource(re).connect(J),E.current=be,R.current=J;const Ce=()=>{var ze,lt;if(!R.current)return;const Ie=R.current.frequencyBinCount,Ae=new Uint8Array(Ie);R.current.getByteFrequencyData(Ae);const Ee=32,_e=Math.floor(Ie/Ee),Me=[];for(let Ye=0;Ye<Ee;Ye++){let nt=0;for(let bt=0;bt<_e;bt++)nt+=Ae[Ye*_e+bt];const xt=nt/_e/255;Me.push(xt)}if(v(Me),te.current.processAudioData(Me),X.current){const Ye=te.current.state.currentLevel;Ye>U.current&&(U.current=Ye)}if(q.current==="vad"||q.current==="silence-based"){const Ye=te.current.state.isSilent,nt=I.current;Z.current.processVADAudio(Ye,nt)}const Be=Date.now();if(X.current)if(M.current===null)M.current=Be;else{const Ye=Be-M.current;I.current||(k.current+=Ye),M.current=Be}else M.current=null,k.current=0;if(P.current&&W.isChunkRecording){const Ye=te.current.state.isSilent,nt=L.current;!nt&&!Ye?L.current=!0:nt&&Ye&&((ze=G.current)==null||ze.call(G),(lt=$.current)==null||lt.call($),L.current=!1)}I.current=te.current.state.isSilent,D.current=requestAnimationFrame(Ce)};Ce()}catch(re){console.error("ðŸŽ¤ âŒ Failed to setup audio analysis:",re)}},[]),pe=h.useCallback(()=>{D.current&&(cancelAnimationFrame(D.current),D.current=null),E.current&&(E.current.close(),E.current=null),R.current=null,v(Array(32).fill(0)),te.current.reset(),Z.current.resetVADState(),L.current=!1},[]),he=h.useCallback(async()=>{if(W.isRecording){if(W.isChunkRecording){const re=k.current,be=j.silenceDetectionConfig.minActiveDuration,J=U.current,fe=j.silenceDetectionConfig.activationThreshold;re>=be&&J>=fe?await K():ne()}V.stopRecording(),ce.current=!1,pe(),T.current=null}else await V.startRecording(),ce.current=!0,await ue(),T.current=Date.now(),j.chunkingMode==="time"&&(await ie(),L.current=!1)},[W.isRecording,W.isChunkRecording,V,ue,pe,j.chunkingMode,j.silenceDetectionConfig.minActiveDuration,j.silenceDetectionConfig.activationThreshold,ie,K,ne]);h.useEffect(()=>{if(!W.isRecording)return;const re=setInterval(()=>{T.current&&y(Date.now()-T.current)},100);return()=>clearInterval(re)},[W.isRecording]),h.useEffect(()=>()=>{pe()},[pe]);const ve=h.useRef(null);h.useEffect(()=>{ve.current!==null&&ve.current!==W.isRecording&&(g==null||g(W.isRecording)),ve.current=W.isRecording},[W.isRecording,g]),h.useEffect(()=>{r&&!W.isRecording&&he()},[r]),h.useEffect(()=>{o!==void 0&&o>0&&!W.isRecording&&he()},[o]),h.useEffect(()=>{i!==void 0&&i>0&&W.isRecording&&he()},[i]);const Te=h.useCallback(async re=>{const be=W.chunks.find(J=>J.id===re);if(!(be!=null&&be.blob)){console.error("ðŸŽ¤ âŒ Cannot transcribe chunk: blob not found",re);return}await ge(re,be.blob,be.name,j.transcribeOptions)},[W.chunks,ge,j]),ke=h.useCallback(async re=>{await me(re),d==null||d(re)},[me,d]),z=h.useCallback(async()=>{const re=W.chunks.map(be=>be.id);await Promise.all(re.map(be=>ke(be)))},[W.chunks,ke]),O=h.useCallback(async()=>{await z(),u==null||u(),await Se(),W.isRecording||await he()},[z,u,Se,W.isRecording,he]);return h.useEffect(()=>{if(!W.isRecording||j.chunkingMode!=="time")return;const re=setInterval(()=>{var Ie,Ae;const be=k.current,J=j.silenceDetectionConfig.minActiveDuration,fe=U.current,Ce=j.silenceDetectionConfig.activationThreshold;if(be<J||fe<Ce){(Ie=Y.current)==null||Ie.call(Y),setTimeout(()=>{var Ee;(Ee=A.current)==null||Ee.call(A),k.current=0,U.current=0},50);return}(Ae=$.current)==null||Ae.call($),setTimeout(()=>{var Ee;(Ee=A.current)==null||Ee.call(A),k.current=0,U.current=0},50)},j.autoChunkCreationTime);return()=>{clearInterval(re)}},[W.isRecording,j.autoChunkCreationTime,j.silenceDetectionConfig.minActiveDuration,j.silenceDetectionConfig.activationThreshold,j.chunkingMode]),a.jsx("div",{className:`audio-panel ${x}`,children:a.jsx(pn,{children:a.jsxs(hn,{className:"p-3 space-y-1",children:[a.jsxs("div",{className:"controls-section flex justify-between items-center gap-1",children:[a.jsx(um,{onClick:he,label:W.isRecording?"Stop":"Record",icon:W.isRecording?Xs:ar,variant:W.isRecording?"destructive":"default",size:"sm",options:[{label:"Clear and Record",onClick:O}],showDropdown:!W.isRecording,className:"recording-toggle-group"}),a.jsxs(st,{children:[a.jsx(pt,{asChild:!0,children:a.jsx(de,{variant:"secondary",size:"sm",children:a.jsx(Np,{className:"w-3 h-3"})})}),a.jsx(Qe,{className:"w-80 p-3",align:"end",children:a.jsx(Om,{config:j,onConfigChange:H})})]})]}),a.jsx("div",{className:"visualizer-section",children:a.jsx(_m,{audioData:w,silenceState:ae.state,onThresholdChange:ae.updateThreshold,hideSilenceControls:!0,duration:b})}),(j.chunkingMode==="vad"||j.chunkingMode==="silence-based")&&W.isRecording&&a.jsxs("div",{className:"vad-activity-indicator p-2 bg-slate-50 border border-slate-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("span",{className:"text-[9px] font-semibold text-slate-600",children:"VAD Activity"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-[8px] text-slate-500",children:["Level: ",(ae.state.currentLevel*100).toFixed(0),"%"]}),a.jsx("div",{className:`px-1.5 py-0.5 rounded text-[8px] font-medium ${ae.state.isSilent?"bg-gray-100 text-gray-600":"bg-green-100 text-green-700"}`,children:ae.state.isSilent?"ðŸ”‡ Silent":"ðŸŽ™ï¸ Active"})]})]}),a.jsxs("div",{className:"relative h-2 bg-slate-200 rounded-full overflow-hidden",children:[ae.state.silenceThreshold>0&&a.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-400 z-10",style:{left:`${ae.state.silenceThreshold*100}%`},title:`Threshold: ${(ae.state.silenceThreshold*100).toFixed(0)}%`}),a.jsx("div",{className:`h-full transition-all duration-100 ${ae.state.isSilent?"bg-gray-400":"bg-green-500"}`,style:{width:`${ae.state.currentLevel*100}%`}})]}),W.isChunkRecording&&a.jsxs("div",{className:"mt-1 text-[8px] text-blue-600 flex items-center gap-1",children:[a.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-blue-600 rounded-full animate-pulse"}),"Recording chunk..."]})]}),W.error&&a.jsx("div",{className:"error-display p-1.5 bg-red-50 border border-red-200 rounded-lg",children:a.jsx("p",{className:"text-[10px] text-red-600",children:W.error})}),a.jsx(tl,{chunks:W.chunks,onChunkDelete:ke,onChunkTranscribe:Te,onClearAll:z})]})})})}const qo=s=>{let e;const t=new Set,n=(d,p)=>{const u=typeof d=="function"?d(e):d;if(!Object.is(u,e)){const f=e;e=p??(typeof u!="object"||u===null)?u:Object.assign({},e,u),t.forEach(m=>m(e,f))}},r=()=>e,c={setState:n,getState:r,getInitialState:()=>l,subscribe:d=>(t.add(d),()=>t.delete(d))},l=e=s(n,r,c);return c},sl=(s=>s?qo(s):qo);var Ka=(s=>(s.ADD="add",s.DRAW_ARROW="draw_arrow",s.DRAW="draw",s.SELECT="select",s.MOVE="move",s.ZOOM="zoom",s.WRITE="write",s.GRID="grid",s.VIM="vim",s.MESSAGE="message",s))(Ka||{}),An=(s=>(s.WRITE="write",s.AUDIO="write:audio",s))(An||{}),Pn=(s=>(s.DEFAULT="draw_arrow:default",s.STAY="draw_arrow:stay",s))(Pn||{}),Rn=(s=>(s.DEFAULT="message",s.AUTOFOCUS="message:autofocus",s))(Rn||{}),nl=(s=>(s.NONE="none",s.STUDY="study",s.PAIRING="pairing",s))(nl||{}),Ke=(s=>(s.RECT="RECT",s.TABLE="TABLE",s.TEXT="TEXT",s.ARROW="ARROW",s.TEXTCARD="TEXTCARD",s.WORKFLOW_ORCHESTRATION="WORKFLOW_ORCHESTRATION",s.WORKFLOW_SOURCE="WORKFLOW_SOURCE",s.WORKFLOW_DEFINITION="WORKFLOW_DEFINITION",s.WORKFLOW_STEP="WORKFLOW_STEP",s.OCR="OCR",s.IMAGE="IMAGE",s.GROUP="GROUP",s.CHAT="CHAT",s.VOCABULARY="VOCABULARY",s.DRAWING="DRAWING",s))(Ke||{});const CC=["content","title","x","y","width","height","createdAt","updatedAt","id","type"],NC={content:"Content",title:"Title",x:"X Position",y:"Y Position",width:"Width",height:"Height",createdAt:"Created At",updatedAt:"Updated At",id:"ID",type:"Type"},kC=["title","content"],EC={title:"Title",content:"Content"};let Ue=(s=21)=>crypto.getRandomValues(new Uint8Array(s)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class bn{static loadPreset(e){const t=new Map,n=this.convertStepsToRows(e.steps,t),r=t.get(1)||"row_1";return{id:`wf-preset-${e.id}`,x:0,y:0,width:400,height:300,type:Ke.RECT,title:e.name,content:e.description,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:n},inputHandles:[{id:`input_${r}`,name:"All Nodes",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Result",type:"output",dataType:"any"}]}}}static convertStepsToRows(e,t,n){return e.map(r=>{const o=Ue();t.set(r.order,o);const i={id:o,label:r.label,order:r.order,stepType:r.type};if(r.config){const c=JSON.parse(JSON.stringify(r.config));c.dataSource==="row_1"&&(c.dataSource=t.get(1)||"row_1"),i.config=c}return r.children&&r.children.length>0&&(i.children=this.convertStepsToRows(r.children,t,r.order)),i})}}const Bm=8,Wm=0,zm=0,TC="__paste-create__",Ir=4;function Ht(s){const e=Math.round(s*1.5),t=Math.round(s*.25),n=e+t*2;return{fontSize:s,lineHeight:e,padding:t,baseNodeHeight:n,cssFontSize:`${s}px`,cssLineHeight:`${e}px`,cssPadding:`${t}px`}}const et={small:Ht(14),normal:Ht(16),xnormal:Ht(18),large:Ht(20),xlarge:Ht(24),xxlarge:Ht(28),xxxlarge:Ht(32),xxxxlarge:Ht(38),xxxxxlarge:Ht(48)};function Ja(s){if(s===void 0)return et.normal;let e;if(typeof s=="number")e=s;else{const t=parseFloat(s);e=isNaN(t)?et.normal.fontSize:t}for(const t of Object.values(et))if(t.fontSize===e)return t;return Ht(e)}const IC=768,AC=300,PC=30,RC=50,DC=500,ot={DEFAULT_NODE_WIDTH:120,DEFAULT_NODE_HEIGHT:et.normal.baseNodeHeight,VOCAB_NODE_MIN_WIDTH:140,FONT_SIZE_DEFAULT:et.normal.fontSize,FONT_SIZE_SMALL:et.small.fontSize,FONT_SIZE_XS:13,FONT_SIZE_XXS:12,FONT_SIZE_MINI:10,FONT_SIZE_PRESETS:{small:et.small.fontSize,normal:et.normal.fontSize,large:et.large.fontSize,xlarge:et.xlarge.fontSize,xxlarge:et.xxlarge.fontSize,xxxlarge:et.xxxlarge.fontSize,xxxxlarge:et.xxxxlarge.fontSize,xxxxxlarge:et.xxxxxlarge.fontSize},TEXT_PADDING:{default:{horizontal:et.normal.padding,vertical:et.normal.padding},large:{horizontal:et.large.padding,vertical:et.large.padding}},LINE_HEIGHT:et.normal.lineHeight,LINE_HEIGHT_CONFIG:25,LINE_HEIGHT_FIND:20,DEFAULT_PADDING:Ir,NODE_X_PADDING:Ir*2,NODE_Y_PADDING:Ir*2,nodeSpacing:20,NODE_ALIGNMENT_PADDING:16,writeMode:{yRatio:.67},TEXT_MODE_ADJUST_Y:25,NEW_NODE_SEGMENT_SPACING:15,MIN_RESIZE_WIDTH:100,MIN_RESIZE_HEIGHT:100,HANDLE_OFFSET:Bm/2,HANDLE_BG_COLOR:"bg-primary",HANDLE_BORDER_COLOR:"border-primary-foreground",SELECTION_RING_COLOR:"ring-ring",SELECTED_BORDER_COLOR:"border-ring",CUSTOM_CHARACTERS:["?","!"],chatInput:{BOTTOM_VISIBLE:70,BOTTOM_HIDDEN:10,NODE_GAP_TOP:100,NODE_GAP_LEFT:20,NODE_GAP_RIGHT:40,NODE_SCROLL_GAP:20},ARRANGE_NODE_GAP:60,ARRANGE_GRID_COLUMNS:3,PRESET_STEP_DELAY_MS:200},Hm={textNodeXPadding:ot.NODE_X_PADDING*4};function Gm(s){const e=Ja(s);return{horizontal:e.padding,vertical:e.padding}}const qm="capitalize",Vm="Capitalize",Km="Capitalize first letter of text",Jm=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Capitalize",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.capitalize()}}"}]}}]}],Ym={id:qm,name:Vm,description:Km,steps:Jm},Xm="trim-symbols-light",Qm="Trim Symbols (Light)",Zm="Remove punctuation and special characters from start/end of text",eg=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsLight()}}"}]}}]}],tg={id:Xm,name:Qm,description:Zm,steps:eg},sg="trim-symbols-strict",ng="Trim Symbols (Strict)",rg="Remove all non-alphanumeric characters from start/end of text",ag=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsStrict()}}"}]}}]}],og={id:sg,name:ng,description:rg,steps:ag},ig="add-full-stop",cg="Add Full Stop",lg="Add a full stop (.) at the end of text",dg=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Add Full Stop",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title}}."}]}}]}],ug={id:ig,name:cg,description:lg,steps:dg};function rl(){const s="workflow-templates-project",e="workflow-templates-workspace",t=bn.loadPreset(Ym),n=bn.loadPreset(tg),r=bn.loadPreset(og),o=bn.loadPreset(ug),i="canvas-workflow-presets",c={id:i,name:"ðŸŽ¨ Workflow Presets",createdAt:Date.now(),lastModified:Date.now(),coreState:{nodes:[{id:Ue(8),x:50,y:50,type:Ke.TEXT,content:`ðŸŽ¨ Workflow Presets Library

Reusable workflow templates powered by JSON configuration.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How to Use:
1. Copy a preset workflow node below (Ctrl+C / Cmd+C)
2. Paste into your target canvas (Ctrl+V / Cmd+V)
3. Click Execute button on the workflow node
4. Done! All canvas nodes are processed automatically

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Key Features (WF-32):
âœ… Source node is OPTIONAL - workflows iterate through all canvas nodes
âœ… Templates use loop context: {{loop.index}}, {{loop.current.title}}
âœ… Simple mode with field updates or advanced mode with explicit targets

See: _docs/guidelines/canvas/workflow-presets-and-execution.md`,styles:{fontSize:`${ot.FONT_SIZE_SMALL}px`,fontWeight:"bold",textColor:"#1f2937"}},{id:Ue(8),x:50,y:400,type:Ke.TEXT,content:`ðŸ”¤ Capitalize

Capitalize first letter of text.
Template: {{loop.current.title.capitalize()}}

Result: "hello world" â†’ "Hello world"`,styles:{fontSize:`${ot.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...t,x:50,y:550},{id:Ue(8),x:450,y:400,type:Ke.TEXT,content:`âœ‚ï¸ Trim Symbols (Light)

Remove punctuation and special chars from edges.
Template: {{loop.current.title.trimSymbolsLight()}}

Result: "  - hello,  " â†’ "hello"`,styles:{fontSize:`${ot.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...n,x:450,y:550},{id:Ue(8),x:850,y:400,type:Ke.TEXT,content:`ðŸ§¹ Trim Symbols (Strict)

Remove ALL non-alphanumeric from edges.
Template: {{loop.current.title.trimSymbolsStrict()}}

Result: "***hello***" â†’ "hello"`,styles:{fontSize:`${ot.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...r,x:850,y:550},{id:Ue(8),x:1250,y:400,type:Ke.TEXT,content:`ðŸ“ Add Full Stop

Append a full stop (.) to end of text.
Template: {{loop.current.title}}.

Result: "Hello world" â†’ "Hello world."`,styles:{fontSize:`${ot.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...o,x:1250,y:550}],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1,targetView:null}},l={id:e,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),canvases:{[i]:c},activeCanvasId:i};return{id:s,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[e]:l},activeWorkspaceId:e}}const pg=[{id:Ue(8),x:600,y:100,type:Ke.TEXT,content:"Node 2 - Text"}],hg=[{id:"vocab-demo-001",x:100,y:350,width:400,height:320,type:Ke.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"dictionary",term:"CÃ¢u tá»¥c ngá»¯",pronunciation:"/kÉ™ÊŠ tÊŠk Å‹ÊŠ/",partOfSpeech:"noun",definition:"Dieses Sprichwort betont die vietnamesische WertschÃ¤tzung fÃ¼r KreativitÃ¤t, Einfallsreichtum und ProblemlÃ¶sung in schwierigen Situationen",examples:[{id:"ex-001",text:"CÃ¢u tá»¥c ngá»¯ nÃ y nháº¥n máº¡nh sá»± trÃ¢n trá»ng cá»§a ngÆ°á»i Viá»‡t Ä‘á»‘i vá»›i sá»± sÃ¡ng táº¡o, tÃ­nh khÃ©o lÃ©o vÃ  kháº£ nÄƒng giáº£i quyáº¿t váº¥n Ä‘á» trong nhá»¯ng hoÃ n cáº£nh khÃ³ khÄƒn",translation:"This proverb emphasizes Vietnamese appreciation for creativity, resourcefulness and problem-solving in difficult situations"}],relatedWords:[{id:"rw-001",word:"Sprichwort",type:"synonym"},{id:"rw-002",word:"WertschÃ¤tzung",type:"related"}],etymology:{origin:"Vietnamese",language:"Tiáº¿ng Viá»‡t",evolution:"Traditional proverb passed down through generations"},expandedSections:["definition","examples"]}},{id:"vocab-demo-002",x:520,y:350,width:280,height:200,type:Ke.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"flashcard",term:"nháº¥n máº¡nh",pronunciation:"/É²É™n maÉ²/",partOfSpeech:"verb",definition:"betont / emphasize",flashcardBack:"betont (to emphasize, to stress)",isFlipped:!1,expandedSections:[]}},{id:"vocab-demo-003",x:820,y:350,width:320,height:280,type:Ke.VOCABULARY,title:"Vocabulary",content:"",data:{vocabType:"word_list",term:"Sentence Breakdown",definition:"Vietnamese â†’ German word pairs",wordListItems:["CÃ¢u tá»¥c ngá»¯ â†’ Sprichwort","nÃ y â†’ Dieses","nháº¥n máº¡nh â†’ betont","sá»± trÃ¢n trá»ng â†’ WertschÃ¤tzung","cá»§a â†’ (von)","ngÆ°á»i Viá»‡t â†’ Vietnameses"],expandedSections:[]}}],fg=[...hg],mg=[],gg={nodes:fg,arrows:mg,groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},xg={offset:{x:50,y:50},scale:1,targetView:null},la=Ue(10),vg={id:la,name:"My First Canvas",createdAt:Date.now(),lastModified:Date.now(),coreState:gg,viewState:xg},da=Ue(10),bg={id:da,name:"Default Workspace",createdAt:Date.now(),lastModified:Date.now(),canvases:{[la]:vg},activeCanvasId:la},ua=Ue(10),wg={id:ua,name:"My Project",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[da]:bg},activeWorkspaceId:da},Ya={version:"3.6.8",dataVersion:"1.1.0",flags:{debug:{logEvents:!1,showDebugOverlay:!0},feature:{}},preferences:{segmentedButtons:{}},uiState:{mode:Ka.SELECT,addNodeType:Ke.TEXT,isPanning:!1,isDrawing:!1,mouseCursor:"cursor-default",selectionBox:null,temporaryArrow:null,nodeToFocusId:null,isOverlayVisible:!1,useCurvedArrows:!1,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},toolbar:{isVisible:!0,toolbarActions:[]},overlay:{},activeGlobalOverlay:nl.NONE},state:{nodes:pg,projects:{[ua]:wg,"workflow-templates-project":rl()},activeProjectId:ua}},Vo={DISABLED:"disabled",SIMPLE:"simple",COMPREHENSIVE:"comprehensive"};var yg=(s=>(s.TEXT="TEXT",s))(yg||{});const Sg={pasteWidth:200,nodeGap:50,depthOffset:100},_C=["Straight","Quadratic","Cubic","Step","Orthogonal","TreeCubic","TreeLStep","TreeZShape"],OC=["none","subtle","medium","vintage","custom"],LC={none:{baseFrequency:.65,numOctaves:3,opacity:0,bgHue:0,bgSaturation:0,bgLightness:100},subtle:{baseFrequency:.8,numOctaves:3,opacity:.15,bgHue:0,bgSaturation:0,bgLightness:100},medium:{baseFrequency:.65,numOctaves:3,opacity:.3,bgHue:0,bgSaturation:0,bgLightness:100},vintage:{baseFrequency:.5,numOctaves:4,opacity:.4,bgHue:40,bgSaturation:30,bgLightness:96}},MC={none:"None",subtle:"Subtle",medium:"Medium",vintage:"Vintage",custom:"Custom"},FC={none:"",subtle:"paper-texture-subtle",medium:"paper-texture-medium",vintage:"paper-texture-vintage",custom:""},$C={Straight:"Straight",Quadratic:"Quadratic",Cubic:"Cubic",Step:"Step (L-shaped)",Orthogonal:"Orthogonal (Z-shaped)",TreeCubic:"Tree: Cubic",TreeLStep:"Tree: L-Step",TreeZShape:"Tree: Z-Shape"},De=class De{static getSelectionRingClass(e){return e?De._selectionRingClass:""}static getSelectedBorderClass(e){return e?De._selectedBorderClass:""}static getNodePaddingClass(e){return e===Ke.TEXT?"px-2 py-1":"p-2"}static getNodeCursorClass(e,t){return e===Ka.SELECT?t?"cursor-grabbing":"cursor-grab":""}};ee(De,"_debug",{exposeActions:!0}),ee(De,"persistState",!0),ee(De,"autosave",!0),ee(De,"hideToolbar",!1),ee(De,"hideOverlay",!1),ee(De,"background",{paperTexture:"none",customParams:null,savedPresets:[]}),ee(De,"arrows",{styles:{line:"hsl(var(--muted-light))",lineSelected:"hsl(var(--primary))"},type:"Cubic",REVERSE_CURVE:!1,CUBIC_ARROW_S_SHAPE_FACTOR:1,CUBIC_ARROW_S_SHAPE_REVERSED:!1,CUBIC_HORIZONTAL_BIAS:1,CUBIC_CONTROL_DISTANCE_MODE:"scaled-minimum",reverseArrowOnMultipleConnect:!0}),ee(De,"copyMode",{autoDrawArrows:!0}),ee(De,"highlightAndCreate",{createConnectingArrow:!1,createHighlight:!1,addHorizontally:!0}),ee(De,"nodeOptions",{maxNodeWidth:600,resizeBorderWidth:10}),ee(De,"nodeStyles",{textAlign:"left",fontSize:`${ot.FONT_SIZE_DEFAULT}px`,fontWeight:"400",border:"",borderWidth:"",borderStyle:"",borderColor:"",backgroundColor:"",textColor:""}),ee(De,"zoom",{min:.01,max:4,intensity:.1,marks:[.09,.6,1,1.3,2]}),ee(De,"text",{debounceInput:300,fontSize:`${ot.FONT_SIZE_DEFAULT}px`,paddingLeft:4,lineHeight:ot.LINE_HEIGHT_CONFIG}),ee(De,"writeMode",{createAtMousePosition:!0,scrollDuration:3e3,scrollYRatio:.8,scrollVerticalPositionRatio:.75}),ee(De,"paste",{fixedWidth:550,maxWidth:550,adjustSizeOnPaste:!0}),ee(De,"LinterPreset",Vo),ee(De,"lint",{onPastePreset:Vo.SIMPLE}),ee(De,"contentCapture",{pasteWidth:700,nodeGap:80,depthOffset:125}),ee(De,"defaultCaptureLayout",Sg),ee(De,"arrange",{gap:60,gridNodeWidth:550,gridColumns:3,gridRows:3,autoGroupOnArrange:!0,cleanUpGap:14,cleanUpRowThreshold:.5}),ee(De,"animation",{enabled:!0,durationMs:200,easing:"ease-out",splitDelayMs:50}),ee(De,"groups",{autoAddNodesOnExpand:!0}),ee(De,"slice",{laneGap:150,laneHeaderOffset:30,nodeGap:20}),ee(De,"autoScroll",{edgeThreshold:100,edgeThresholdMobile:30,scrollSpeed:15}),ee(De,"keyboardScroll",{animationDuration:300,targetScreenYRatio:.33,minKeyboardHeight:100}),ee(De,"tabBar",{maxTabWidth:150,dragSourceOpacity:.5,dragPreviewOpacity:.2,dropIndicator:{width:2,opacity:.4},holdDelay:500,holdIndicatorDelay:150}),ee(De,"slashCommand",{menuGapAboveInput:24}),ee(De,"dataTable",{dragHandleWidth:32}),ee(De,"claudeChat",{popoverRightGap:30,alignScrollDuration:500,alignNodeWithChatInput:!1,autoFocusOnWindowFocus:!0}),ee(De,"chatInput",{mobile:{bottomOffset:5,nodeGapRight:20,fontConfig:et.xnormal,get nodeFontSize(){return this.fontConfig.cssFontSize}},tabletBreakpoint:1280,maxRows:4}),ee(De,"chatNode",{viewMode:"fullwidth",windowed:{mobileViewportGap:10,desktopViewportGap:20},fullwidth:{contentPadding:12},defaultMaxHeight:600,desktopWidth:500,desktopHeight:400,desktopRightGap:20,messageGap:4,messagePadding:6,scrollSide:"right",scrollAreaWidth:"10vw",zoomFontSize:{enabled:!0,minScale:.4,maxScale:1,fontSize:18}}),ee(De,"nodeUI",{idleOpacity:.1,quickPanelGap:30,resizeHandleIdleOpacity:.3,quickArrowHandleIdleOpacity:.3}),ee(De,"canvasTable",{dropBehavior:"delete"}),ee(De,"history",{historyLimit:100,tabletHistoryLimit:30,archiveLimit:500,tabletArchiveLimit:200,tabletBreakpoint:768,holdRepeatIntervalMs:180}),ee(De,"holdToSelect",{holdDurationMs:800,movementThresholdPx:10,indicatorDelayMs:200,indicatorTopOffset:48,indicatorBottomOffset:80}),ee(De,"holdToDrag",{holdDelayMs:400,movementThresholdPx:10,enableChatNodeHighlight:!1}),ee(De,"drawing",{strokeGroupingTimeoutMs:1500,isRightHandMode:!0,markerOpacity:.3,markerColor:"#facc15",smoothingFactor:0,minPointDistance:0,compression:{enabled:!0,level:30}}),ee(De,"_selectionRingClass","ring-1 ring-ring ring-offset-1"),ee(De,"_selectedBorderClass","border-ring");let $e=De;const jg=(s,e,t,n)=>({left:-s.x/e,top:-s.y/e,right:(-s.x+t)/e,bottom:(-s.y+n)/e}),Cg=(s,e,t,n,r)=>{const o=s.x+(s.width??100)/2,i=s.y+(s.height??50)/2,c=(r==null?void 0:r.verticalPositionRatio)??.5,l=t/2-o*e,d=n*c-i*e;return{x:l,y:d}},Ng=(s,e,t,n=500,r)=>{const{uiState:o,projectCanvas:i,setActiveCanvasViewState:c}=e(),l=i.getActive();if(!l){console.warn("Cannot center view: No active canvas.");return}const d=l.coreState.nodes,p=l.viewState.scale,u=typeof t=="string"?d==null?void 0:d.find(v=>v.id===t):t,f=o==null?void 0:o.canvasWidth,m=o==null?void 0:o.canvasHeight;if(!u){console.warn("Cannot center view: Node dimensions not found.");return}if(!f||!m){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=l.viewState.offset;jg(g,p,f,m);const x=Cg(u,p,f,m,r!=null&&r.verticalOnly?{verticalPositionRatio:$e.writeMode.scrollVerticalPositionRatio}:void 0),w=r!=null&&r.verticalOnly?{x:g.x,y:x.y}:x;c(v=>({...v,targetView:{targetOffset:w,targetScale:p,animationStartTime:0,animationDuration:n}}))},kg=(s,e,t)=>({x:Number(((s.x-t.x)/e).toFixed(3)),y:Number(((s.y-t.y)/e).toFixed(3))}),Eg=s=>{const{projectCanvas:e}=s(),t=Bl.getState(),n=t==null?void 0:t.mousePosition,r=e.getActive(),o=(r==null?void 0:r.viewState.scale)??1,i=(r==null?void 0:r.viewState.offset)??{x:0,y:0};return!n||!r?null:kg(n,o,i)};var al=Symbol.for("immer-nothing"),Ko=Symbol.for("immer-draftable"),jt=Symbol.for("immer-state");function Lt(s,...e){throw new Error(`[Immer] minified error nr: ${s}. Full error at: https://bit.ly/3cXEKWf`)}var en=Object.getPrototypeOf;function Ps(s){return!!s&&!!s[jt]}function fs(s){var e;return s?ol(s)||Array.isArray(s)||!!s[Ko]||!!((e=s.constructor)!=null&&e[Ko])||gn(s)||xr(s):!1}var Tg=Object.prototype.constructor.toString(),Jo=new WeakMap;function ol(s){if(!s||typeof s!="object")return!1;const e=Object.getPrototypeOf(s);if(e===null||e===Object.prototype)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;if(t===Object)return!0;if(typeof t!="function")return!1;let n=Jo.get(t);return n===void 0&&(n=Function.toString.call(t),Jo.set(t,n)),n===Tg}function Hn(s,e,t=!0){gr(s)===0?(t?Reflect.ownKeys(s):Object.keys(s)).forEach(r=>{e(r,s[r],s)}):s.forEach((n,r)=>e(r,n,s))}function gr(s){const e=s[jt];return e?e.type_:Array.isArray(s)?1:gn(s)?2:xr(s)?3:0}function pa(s,e){return gr(s)===2?s.has(e):Object.prototype.hasOwnProperty.call(s,e)}function il(s,e,t){const n=gr(s);n===2?s.set(e,t):n===3?s.add(t):s[e]=t}function Ig(s,e){return s===e?s!==0||1/s===1/e:s!==s&&e!==e}function gn(s){return s instanceof Map}function xr(s){return s instanceof Set}function os(s){return s.copy_||s.base_}function ha(s,e){if(gn(s))return new Map(s);if(xr(s))return new Set(s);if(Array.isArray(s))return Array.prototype.slice.call(s);const t=ol(s);if(e===!0||e==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(s);delete n[jt];let r=Reflect.ownKeys(n);for(let o=0;o<r.length;o++){const i=r[o],c=n[i];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(n[i]={configurable:!0,writable:!0,enumerable:c.enumerable,value:s[i]})}return Object.create(en(s),n)}else{const n=en(s);if(n!==null&&t)return{...s};const r=Object.create(n);return Object.assign(r,s)}}function Xa(s,e=!1){return vr(s)||Ps(s)||!fs(s)||(gr(s)>1&&Object.defineProperties(s,{set:wn,add:wn,clear:wn,delete:wn}),Object.freeze(s),e&&Object.values(s).forEach(t=>Xa(t,!0))),s}function Ag(){Lt(2)}var wn={value:Ag};function vr(s){return s===null||typeof s!="object"?!0:Object.isFrozen(s)}var Pg={};function ms(s){const e=Pg[s];return e||Lt(0,s),e}var tn;function cl(){return tn}function Rg(s,e){return{drafts_:[],parent_:s,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Yo(s,e){e&&(ms("Patches"),s.patches_=[],s.inversePatches_=[],s.patchListener_=e)}function fa(s){ma(s),s.drafts_.forEach(Dg),s.drafts_=null}function ma(s){s===tn&&(tn=s.parent_)}function Xo(s){return tn=Rg(tn,s)}function Dg(s){const e=s[jt];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function Qo(s,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return s!==void 0&&s!==t?(t[jt].modified_&&(fa(e),Lt(4)),fs(s)&&(s=Gn(e,s),e.parent_||qn(e,s)),e.patches_&&ms("Patches").generateReplacementPatches_(t[jt].base_,s,e.patches_,e.inversePatches_)):s=Gn(e,t,[]),fa(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),s!==al?s:void 0}function Gn(s,e,t){if(vr(e))return e;const n=s.immer_.shouldUseStrictIteration(),r=e[jt];if(!r)return Hn(e,(o,i)=>Zo(s,r,e,o,i,t),n),e;if(r.scope_!==s)return e;if(!r.modified_)return qn(s,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const o=r.copy_;let i=o,c=!1;r.type_===3&&(i=new Set(o),o.clear(),c=!0),Hn(i,(l,d)=>Zo(s,r,o,l,d,t,c),n),qn(s,o,!1),t&&s.patches_&&ms("Patches").generatePatches_(r,t,s.patches_,s.inversePatches_)}return r.copy_}function Zo(s,e,t,n,r,o,i){if(r==null||typeof r!="object"&&!i)return;const c=vr(r);if(!(c&&!i)){if(Ps(r)){const l=o&&e&&e.type_!==3&&!pa(e.assigned_,n)?o.concat(n):void 0,d=Gn(s,r,l);if(il(t,n,d),Ps(d))s.canAutoFreeze_=!1;else return}else i&&t.add(r);if(fs(r)&&!c){if(!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||e&&e.base_&&e.base_[n]===r&&c)return;Gn(s,r),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&(gn(t)?t.has(n):Object.prototype.propertyIsEnumerable.call(t,n))&&qn(s,r)}}}function qn(s,e,t=!1){!s.parent_&&s.immer_.autoFreeze_&&s.canAutoFreeze_&&Xa(e,t)}function _g(s,e){const t=Array.isArray(s),n={type_:t?1:0,scope_:e?e.scope_:cl(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:s,draft_:null,copy_:null,revoke_:null,isManual_:!1};let r=n,o=Qa;t&&(r=[n],o=sn);const{revoke:i,proxy:c}=Proxy.revocable(r,o);return n.draft_=c,n.revoke_=i,c}var Qa={get(s,e){if(e===jt)return s;const t=os(s);if(!pa(t,e))return Og(s,t,e);const n=t[e];return s.finalized_||!fs(n)?n:n===Ar(s.base_,e)?(Pr(s),s.copy_[e]=xa(n,s)):n},has(s,e){return e in os(s)},ownKeys(s){return Reflect.ownKeys(os(s))},set(s,e,t){const n=ll(os(s),e);if(n!=null&&n.set)return n.set.call(s.draft_,t),!0;if(!s.modified_){const r=Ar(os(s),e),o=r==null?void 0:r[jt];if(o&&o.base_===t)return s.copy_[e]=t,s.assigned_[e]=!1,!0;if(Ig(t,r)&&(t!==void 0||pa(s.base_,e)))return!0;Pr(s),ga(s)}return s.copy_[e]===t&&(t!==void 0||e in s.copy_)||Number.isNaN(t)&&Number.isNaN(s.copy_[e])||(s.copy_[e]=t,s.assigned_[e]=!0),!0},deleteProperty(s,e){return Ar(s.base_,e)!==void 0||e in s.base_?(s.assigned_[e]=!1,Pr(s),ga(s)):delete s.assigned_[e],s.copy_&&delete s.copy_[e],!0},getOwnPropertyDescriptor(s,e){const t=os(s),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:s.type_!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty(){Lt(11)},getPrototypeOf(s){return en(s.base_)},setPrototypeOf(){Lt(12)}},sn={};Hn(Qa,(s,e)=>{sn[s]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});sn.deleteProperty=function(s,e){return sn.set.call(this,s,e,void 0)};sn.set=function(s,e,t){return Qa.set.call(this,s[0],e,t,s[0])};function Ar(s,e){const t=s[jt];return(t?os(t):s)[e]}function Og(s,e,t){var r;const n=ll(e,t);return n?"value"in n?n.value:(r=n.get)==null?void 0:r.call(s.draft_):void 0}function ll(s,e){if(!(e in s))return;let t=en(s);for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=en(t)}}function ga(s){s.modified_||(s.modified_=!0,s.parent_&&ga(s.parent_))}function Pr(s){s.copy_||(s.copy_=ha(s.base_,s.scope_.immer_.useStrictShallowCopy_))}var Lg=class{constructor(s){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,n)=>{if(typeof e=="function"&&typeof t!="function"){const o=t;t=e;const i=this;return function(l=o,...d){return i.produce(l,p=>t.call(this,p,...d))}}typeof t!="function"&&Lt(6),n!==void 0&&typeof n!="function"&&Lt(7);let r;if(fs(e)){const o=Xo(this),i=xa(e,void 0);let c=!0;try{r=t(i),c=!1}finally{c?fa(o):ma(o)}return Yo(o,n),Qo(r,o)}else if(!e||typeof e!="object"){if(r=t(e),r===void 0&&(r=e),r===al&&(r=void 0),this.autoFreeze_&&Xa(r,!0),n){const o=[],i=[];ms("Patches").generateReplacementPatches_(e,r,o,i),n(o,i)}return r}else Lt(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(i,...c)=>this.produceWithPatches(i,l=>e(l,...c));let n,r;return[this.produce(e,t,(i,c)=>{n=i,r=c}),n,r]},typeof(s==null?void 0:s.autoFreeze)=="boolean"&&this.setAutoFreeze(s.autoFreeze),typeof(s==null?void 0:s.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(s.useStrictShallowCopy),typeof(s==null?void 0:s.useStrictIteration)=="boolean"&&this.setUseStrictIteration(s.useStrictIteration)}createDraft(s){fs(s)||Lt(8),Ps(s)&&(s=Mg(s));const e=Xo(this),t=xa(s,void 0);return t[jt].isManual_=!0,ma(e),t}finishDraft(s,e){const t=s&&s[jt];(!t||!t.isManual_)&&Lt(9);const{scope_:n}=t;return Yo(n,e),Qo(void 0,n)}setAutoFreeze(s){this.autoFreeze_=s}setUseStrictShallowCopy(s){this.useStrictShallowCopy_=s}setUseStrictIteration(s){this.useStrictIteration_=s}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(s,e){let t;for(t=e.length-1;t>=0;t--){const r=e[t];if(r.path.length===0&&r.op==="replace"){s=r.value;break}}t>-1&&(e=e.slice(t+1));const n=ms("Patches").applyPatches_;return Ps(s)?n(s,e):this.produce(s,r=>n(r,e))}};function xa(s,e){const t=gn(s)?ms("MapSet").proxyMap_(s,e):xr(s)?ms("MapSet").proxySet_(s,e):_g(s,e);return(e?e.scope_:cl()).drafts_.push(t),t}function Mg(s){return Ps(s)||Lt(10,s),dl(s)}function dl(s){if(!fs(s)||vr(s))return s;const e=s[jt];let t,n=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=ha(s,e.scope_.immer_.useStrictShallowCopy_),n=e.scope_.immer_.shouldUseStrictIteration()}else t=ha(s,!0);return Hn(t,(r,o)=>{il(t,r,dl(o))},n),e&&(e.finalized_=!1),t}var Fg=new Lg,se=Fg.produce;const Za=s=>{var n,r,o;if(!s.state)return null;const e=s.state.activeProjectId?(n=s.state.projects)==null?void 0:n[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?(r=e.workspaces)==null?void 0:r[e.activeWorkspaceId]:null;return t&&t.activeCanvasId?(o=t.canvases)==null?void 0:o[t.activeCanvasId]:null},$g=(s,e)=>s(se(t=>{t.uiState.temporaryArrow=e})),Ug=(s,e)=>s(se(t=>{var r,o,i,c,l,d;const n=Za(t);if(n!=null&&n.coreState){const p=typeof e=="function"?e(n.coreState.arrows):e;n.coreState.arrows=p,n.coreState.selectedArrows.length>0&&(n.coreState.selectedArrows=n.coreState.selectedArrows.map(m=>p.find(x=>x.id===m.id)||m)),n.lastModified=Date.now();const u=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];u&&(u.lastModified=Date.now());const f=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];f&&(f.lastModified=Date.now())}})),Bg=(s,e)=>s(se(t=>{var r,o,i,c,l,d;const n=Za(t);if(n!=null&&n.coreState){const p=Array.isArray(e)?e:[],u=new Set(p.map(g=>g.id));n.coreState.selectedArrows=n.coreState.arrows.filter(g=>u.has(g.id)),n.lastModified=Date.now();const f=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];f&&(f.lastModified=Date.now());const m=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];m&&(m.lastModified=Date.now())}})),Wg=(s,e)=>s(se(t=>{var r,o,i,c,l,d;const n=Za(t);if(n!=null&&n.coreState){n.coreState.arrows.push(e),n.lastModified=Date.now();const p=(c=(i=(o=(r=t.state)==null?void 0:r.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];p&&(p.lastModified=Date.now());const u=(d=(l=t.state)==null?void 0:l.projects)==null?void 0:d[t.state.activeProjectId];u&&(u.lastModified=Date.now())}})),zg=(s,e,t,n)=>{s(se(r=>{var l,d;const o=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o!=null&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i!=null&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if((d=c==null?void 0:c.coreState)!=null&&d.arrows){const p=c.coreState.arrows.findIndex(u=>u.id===t);if(p!==-1){if(c.coreState.arrows[p]={...c.coreState.arrows[p],...n},c.coreState.selectedArrows){const f=c.coreState.selectedArrows.findIndex(m=>m.id===t);f!==-1&&(c.coreState.selectedArrows[f]={...c.coreState.selectedArrows[f],...n})}const u=Date.now();c.lastModified=u,i&&(i.lastModified=u),o&&(o.lastModified=u)}}}))},Hg=(s,e)=>({setTemporary:t=>$g(s,t),setAll:t=>Ug(s,t),setSelected:t=>Bg(s,t),add:t=>Wg(s,t),update:(t,n)=>zg(s,e,t,n)});function Gg(s,e=getComputedStyle(document.body).font){if(!s)return 0;const n=document.createElement("canvas").getContext("2d");return n?(n.font=e,n.measureText(s).width):0}const qg=6;function Vg(s,e=getComputedStyle(document.body).font){return s?s.split(/\n|&nbsp;/).map(r=>{const o=pl(r),i=fl(e,o),c=hl(r);let l=Gg(c,i);return ul(r)&&(l+=qg),l}).reduce((r,o)=>Math.max(r,o),0):0}function Kg(s){const e=s.trimStart();return e.startsWith("### ")?1.2:e.startsWith("## ")?1.35:e.startsWith("# ")?1.5:1}function ul(s){const e=s.trimStart();return!!(e.startsWith("- ")||/^\d+\.\s/.test(e))}function pl(s){const e=s.trimStart();return e.startsWith("### ")?1.125:e.startsWith("## ")?1.25:e.startsWith("# ")?1.5:1}function hl(s){const e=s.trimStart(),t=s.length-e.length,n=s.substring(0,t);if(e.startsWith("### "))return n+e.slice(4);if(e.startsWith("## "))return n+e.slice(3);if(e.startsWith("# ")||e.startsWith("> ")||e.startsWith("- "))return n+e.slice(2);const r=e.match(/^(\d+)\.\s/);return r?n+e.slice(r[0].length):s}function fl(s,e){if(e===1)return s;const t=s.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/);if(!t)return s;const n=parseFloat(t[1]),r=t[2],o=n*e;return s.replace(t[0],`${o}${r}`)}function Vn(s,e,t=getComputedStyle(document.body).font,n){if(!s)return 0;const o=document.createElement("canvas").getContext("2d");if(!o)return 0;o.font=t;const i=t.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/),l=(i?parseFloat(i[1]):16)*1.5,d=n??l;if(d===0)return console.warn("measureWrappedTextHeight: Could not determine line height. Using fallback."),s.split(`
`).length*16;const p=s.split(`
`);let u=0,f=!1,m=!1,g=!0;for(const w of p){if(w.trim()===""){u+=d,m=!1,g=!1;continue}const v=ul(w);v&&!m&&!g&&(u+=d),m=v,g=!1;const b=Kg(w);b>1&&(f=!0);const y=d*b,C=pl(w),S=fl(t,C);o.font=S;const N=hl(w).split(" ");let E="",R=1;for(let D=0;D<N.length;D++){const T=N[D],L=E+(E?" ":"")+T;o.measureText(L).width>e&&E!==""?(R++,E=T,o.measureText(T).width>e):E=L}u+=R*y}let x=u+(f?Wm:0);return x+=zm,x}function ml(s,e){if(!s)return 0;const{containerWidth:t,textarea:n,fontSize:r,skipPaddingSubtraction:o=!1}=e,i=n||document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(!i)return Vn(s,t);const c=window.getComputedStyle(i),l=r??`${ot.FONT_SIZE_DEFAULT}px`,d=c.fontFamily,u=`${c.fontWeight} ${l} ${d}`,m=Ja(l).lineHeight;let g=t;if(!o){const v=Gm(l).horizontal*2;g=t-v}return Vn(s,g,u,m)}function Jg(s,e,t){const n=gl(t),r=ml(s,{containerWidth:e,fontSize:n,skipPaddingSubtraction:!0}),i=Ja(n).padding*2;return r+i}function gl(s){var e;return(e=s==null?void 0:s.styles)==null?void 0:e.fontSize}function UC(s,e,t){const n=gl(t);return ml(s,{containerWidth:e,fontSize:n,skipPaddingSubtraction:!0})}const{DEFAULT_NODE_WIDTH:Kn,DEFAULT_NODE_HEIGHT:Jn}=ot,gs=s=>{const e=s.x,t=s.y,n=s.width??Kn,r=s.height??Jn;return{x1:e,y1:t,x2:e+n,y2:t+r}},BC=(s,e,t)=>{const n=t?new Set(t):null;for(let r=e.length-1;r>=0;r--){const o=e[r];if(n&&n.has(o.id))continue;const i=gs(o);if(s.x>=i.x1&&s.x<=i.x2&&s.y>=i.y1&&s.y<=i.y2)return o}return null},ei=s=>{const e=s.x,t=s.y,n=s.width??Kn,r=s.height??Jn;return{x:e+n/2,y:t+r/2}},WC=(s,e)=>s.x===e.x&&s.y===e.y,Yg=()=>{const s=document.querySelector("textarea[data-node-textarea]"),e=document.querySelector(".markdown-textarea[data-node-textarea]"),t=s||e;if(t){const r=window.getComputedStyle(t).lineHeight;if(r&&r!=="normal"){const o=parseFloat(r);if(!isNaN(o))return o}}},Xg=(s,e,t)=>{const n=Vg(s)+Hm.textNodeXPadding,r=Jg(s,n,t);return{width:n,height:r}},zC=(s,e)=>{const t=gs(s),n=gs(e);return t.x1>=n.x1&&t.y1>=n.y1&&t.x2<=n.x2&&t.y2<=n.y2},Qg=(s,e)=>{const t=gs(e);return s.filter(n=>{if(n.id===e.id)return!1;const r=gs(n);return!(r.x2<t.x1||r.x1>t.x2||r.y2<t.y1||r.y1>t.y2)})},Zg=(s,e="bottom")=>{if(!s.length)return null;switch(e){case"left":return s.reduce((t,n)=>n.x<t.x?n:t,s[0]);case"right":return s.reduce((t,n)=>n.x+(n.width??Kn)>t.x+(t.width??Kn)?n:t,s[0]);case"top":return s.reduce((t,n)=>n.y<t.y?n:t,s[0]);case"bottom":return s.reduce((t,n)=>n.y+(n.height??Jn)>t.y+(t.height??Jn)?n:t,s[0]);default:return null}},Ls=s=>(e,t)=>{s(n=>{if(!n.state)return n;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return n;const c=i.coreState,l=c.nodes.findIndex(g=>g.id===e);if(l===-1)return n;const d=new Date().toISOString(),p={...t,updatedAt:d},u=[...c.nodes];u[l]={...u[l],...p};const m=c.selectedNodes.some(g=>g.id===e)?c.selectedNodes.map(g=>g.id===e?{...g,...p}:g):c.selectedNodes;return window.__nodes=u,window.__selectedNodes=m,{...n,state:{...n.state,projects:{...n.state.projects,[n.state.activeProjectId]:{...r,lastModified:Date.now(),workspaces:{...r.workspaces,[r.activeWorkspaceId]:{...o,lastModified:Date.now(),canvases:{...o.canvases,[o.activeCanvasId]:{...i,coreState:{...c,nodes:u,selectedNodes:m},lastModified:Date.now()}}}}}}}}})},ex=(s,e)=>s(t=>({uiState:{...t.uiState,mode:e}})),tx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:e}})),sx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:t.uiState.zoomSubMode==="zoom:lock"?"zoom":"zoom:lock"}})),nx=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:e}})),rx=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:t.uiState.writeSubMode===An.AUDIO?An.WRITE:An.AUDIO}})),ax=(s,e)=>s(t=>({uiState:{...t.uiState,arrowSubMode:e}})),ox=s=>s(e=>({uiState:{...e.uiState,arrowSubMode:e.uiState.arrowSubMode===Pn.STAY?Pn.DEFAULT:Pn.STAY}})),ix=(s,e)=>s(t=>({uiState:{...t.uiState,messageSubMode:e}})),cx=s=>s(e=>({uiState:{...e.uiState,messageSubMode:e.uiState.messageSubMode===Rn.AUTOFOCUS?Rn.DEFAULT:Rn.AUTOFOCUS}})),lx=(s,e)=>s(()=>({mousePosition:e})),dx=(s,e)=>s(t=>({uiState:{...t.uiState,isPanning:e}})),ux=(s,e)=>s(t=>({uiState:{...t.uiState,isHoldSelectActive:e}})),px=(s,e)=>s(t=>({uiState:{...t.uiState,holdSelectProgress:e}})),hx=(s,e)=>s(t=>({uiState:{...t.uiState,selectionBox:e}})),fx=(s,e)=>s(t=>({uiState:{...t.uiState,pendingSelectionStart:e}})),mx=(s,e)=>s(t=>({uiState:{...t.uiState,writeModeStartPosition:e}})),gx=(s,e)=>s(t=>({uiState:{...t.uiState,dragInfo:e}})),xx=(s,e)=>s(t=>({uiState:{...t.uiState,groupDragInfo:e}})),vx=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetGroupId:e}})),bx=(s,e)=>s(t=>({uiState:{...t.uiState,hoveredDropTargetVocabNodeId:e}})),wx=s=>s(e=>({uiState:{...e.uiState,dragVersion:(e.uiState.dragVersion??0)+1}})),yx=(s,e)=>s(t=>({uiState:{...t.uiState,tableDropTarget:e}})),Sx=(s,e)=>s(t=>({uiState:{...t.uiState,resizingNode:e}})),jx=(s,e)=>s(t=>({uiState:{...t.uiState,resizingGroup:e}})),Cx=(s,e)=>s(t=>({uiState:{...t.uiState,nodeToFocusId:e}})),Nx=(s,e)=>{var n;if(!e)return;const t=s().projectCanvas.getActive();return(n=t==null?void 0:t.coreState.nodes)==null?void 0:n.find(r=>r.id===e)},kx=(s,e)=>s(t=>({uiState:{...t.uiState,addNodeType:e}})),Ex=(s,e,t=!1)=>s(n=>({uiState:{...n.uiState,activeChatNodeId:e,activeChatNodePinned:t}})),Tx=(s,e)=>s(t=>({uiState:{...t.uiState,chatNodeHoldToDrag:e}})),Ix=(s,e)=>s(t=>({uiState:{...t.uiState,nodeHoldToResize:e}})),Ax=(s,e)=>s(t=>({uiState:{...t.uiState,nodeContextMenu:e}})),Px=(s,e,t)=>s(n=>({uiState:{...n.uiState,canvasWidth:e,canvasHeight:t}})),Rx=(s,e)=>s(t=>({uiState:e(t.uiState)})),Dx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{if(n.nodes.length>0&&e.length===0)return console.trace("NOOO should not happend"),n;const r=typeof e=="function"?e(n.nodes):e;return{...n,nodes:r}}),{})),_x=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=Array.isArray(e)?e:[],o=new Set(r.map(l=>l.id)),i=n.nodes.map(l=>({...l,isEditing:!1})),c=i.filter(l=>o.has(l.id));return{...n,nodes:i,selectedNodes:c}}),{})),Ox=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.selectedNodes.filter(i=>i.id!==e),o=n.nodes.map(i=>i.id===e?{...i,isEditing:!1}:i);return{...n,nodes:o,selectedNodes:r}}),{})),Lx=(s,e,t,n={dontOverlap:!1,dontSelect:!1})=>s(r=>(r.setActiveCanvasCoreState(o=>{var w;const i=new Date().toISOString(),c=o.activeLayerId,l=o.layers??[],d=l.find(v=>v.id===c);let p;if(d&&!d.isLocked)p=c??void 0;else if(l.length>0){const v=l.find(b=>!b.isLocked);p=(v==null?void 0:v.id)??((w=l[0])==null?void 0:w.id)}const u={...e,createdAt:e.createdAt??i,updatedAt:i,...p?{layerId:p}:{}};t!==void 0&&(u.content=t);const f=o.nodes;if(n.dontOverlap){const v=Qg(f,e);if(v.length>0){const b=Zg(v,"right");if(b){const y=b.x+(b.width??0);u.x=y+ot.nodeSpacing}}}let m;if(!u.groupId&&u.type!==Ke.GROUP){const v=f.filter(C=>C.type===Ke.GROUP),b=gs(u),y=v.find(C=>{const S=gs(C),j=b.x1+(b.x2-b.x1)/2,N=b.y1+(b.y2-b.y1)/2;return j>=S.x1&&j<=S.x2&&N>=S.y1&&N<=S.y2});y&&(u.groupId=y.id,m=y.id)}let g=[...f,u];m&&(g=g.map(v=>{if(v.id===m){const b=v.data??{},y=b.childNodeIds??[];return{...v,data:{...b,childNodeIds:[...y,u.id]},updatedAt:i}}return v}));const x=n.dontSelect?o.selectedNodes:[u];return{...o,nodes:g,selectedNodes:x,selectedArrows:n.dontSelect?o.selectedArrows:[]}}),{})),Mx=(s,e)=>s(t=>({state:e(t.state)})),Fx=s=>(e,t)=>Ls(s)(e,{content:t}),$x=s=>(e,t)=>Ls(s)(e,{subContent:t}),Ux=s=>(e,t)=>Ls(s)(e,{title:t}),Bx=s=>(e,t)=>Ls(s)(e,{...t}),Wx=s=>{var t;const e=s().projectCanvas.getActive();return(t=e==null?void 0:e.coreState.nodes)==null?void 0:t.find(n=>n.isEditing)},zx=(s,e)=>s(t=>(t.setActiveCanvasCoreState(n=>{const r=n.nodes.find(d=>d.id===e),o=new Set([e]);if((r==null?void 0:r.type)===Ke.CHAT){const d=r.data;d!=null&&d.childNodeIds&&d.childNodeIds.forEach(p=>o.add(p))}const i=n.nodes.filter(d=>!o.has(d.id)),c=n.selectedNodes.filter(d=>!o.has(d.id)),l=n.arrows.filter(d=>(d.startNodeId===null||!o.has(d.startNodeId))&&(d.endNodeId===null||!o.has(d.endNodeId)));return{...n,nodes:i,selectedNodes:c,arrows:l}}),t.uiState.nodeToFocusId===e&&s(n=>({uiState:{...n.uiState,nodeToFocusId:null}})),{})),Hx=s=>s(e=>(e.setActiveCanvasCoreState(t=>({...t,nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]})),{})),Gx=(s,e)=>s(t=>({flags:e(t.flags)})),qx=s=>s(Ya),Vx=s=>s(e=>({uiState:{...e.uiState,isOverlayVisible:!e.uiState.isOverlayVisible}})),Kx=s=>s(e=>({uiState:{...e.uiState,useCurvedArrows:!e.uiState.useCurvedArrows}})),Jx=(s,e)=>s(t=>({uiState:{...t.uiState,customNodeDropdownOpen:e}})),Yx=(s,e)=>s(t=>({uiState:{...t.uiState,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[],...t.uiState.nodeUpdateSettings||{},...e}}})),Xx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:e.sort((n,r)=>n-r)}})),Qx=(s,e)=>s(t=>{const n=t.uiState.zoomMarks||[];return n.includes(e)?t:{uiState:{...t.uiState,zoomMarks:[...n,e].sort((r,o)=>r-o)}}}),Zx=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:(t.uiState.zoomMarks||[]).filter(n=>n!==e)}})),ev=(s,e)=>s(t=>({uiState:{...t.uiState,activeGlobalOverlay:e}})),tv=(s,e)=>s(t=>({uiState:{...t.uiState,arrangeSnapshot:e}})),sv=s=>s(se(e=>{const t=e.uiState.arrangeSnapshot;if(!t||!e.state)return;const n=e.state.activeProjectId?e.state.projects[e.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(o){for(const[i,c]of Object.entries(t.nodePositions)){const l=o.coreState.nodes.find(d=>d.id===i);l&&(l.x=c.x,l.y=c.y,c.width!==void 0&&(l.width=c.width),c.height!==void 0&&(l.height=c.height),l.updatedAt=new Date().toISOString())}o.coreState.selectedNodes=o.coreState.selectedNodes.map(i=>{const c=t.nodePositions[i.id];return c?{...i,x:c.x,y:c.y,width:c.width??i.width,height:c.height??i.height,updatedAt:new Date().toISOString()}:i}),e.uiState.arrangeSnapshot=null}})),nv=s=>s(e=>({uiState:{...e.uiState,arrangeSnapshot:null}})),rv=(s,e)=>{s(t=>{if(!t.state)return t;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!o)return t;const i=e(o.viewState);if(i===o.viewState)return t;const c=Date.now();return{...t,state:{...t.state,projects:{...t.state.projects,[t.state.activeProjectId]:{...n,lastModified:c,workspaces:{...n.workspaces,[n.activeWorkspaceId]:{...r,lastModified:c,canvases:{...r.canvases,[r.activeCanvasId]:{...o,viewState:i,lastModified:c}}}}}}}}})},av=(s,e)=>s(se(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n!=null&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r!=null&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;o&&(o.coreState=e(o.coreState),o.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now()))})),ov=s=>{s.forEach(e=>localStorage.removeItem(e)),window.location.reload()},iv=s=>e=>{s(se(t=>{var l;if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!((l=o==null?void 0:o.coreState)!=null&&l.nodes))return;const i=new Date().toISOString();let c=null;o.coreState.nodes=o.coreState.nodes.map(d=>{const p=e.find(m=>m.id===d.id);if(!p)return d;let u=!1,f=!1;for(const m in p)if(p[m]!==d[m]){u=!0,(m==="x"||m==="y")&&(f=!0);break}return u&&f&&(c=d.id),u?{...d,...p,updatedAt:i}:d}),c&&(t.uiState.lastUpdatedNodeId=c),o.lastModified=Date.now(),r&&(r.lastModified=Date.now()),n&&(n.lastModified=Date.now())}),!1)},cv=s=>(e,t)=>{Ls(s)(e,{styles:t})};function lv(){return Math.random().toString(36).substring(2,9)}let xl=0;function HC(){let s=Date.now().toString(25);return s+=xl++,`${lv()}-${s}`}function dv(){let s=Date.now().toString(25);return s+="_"+xl++,s}const uv=/^c-(\d+_)?(.+)$/;function va(s){const e=uv.exec(s),t=dv();return e?`${e[1]?`c-${parseInt(e[1],10)+1}_`:"c-1_"}${e[2]}`+t:`c-${s}`+t}const pv=s=>s(e=>(e.setActiveCanvasCoreState(t=>{const n=t.selectedNodes,r=t.nodes,o=[],i=n.map(c=>{const l=c.height??ot.DEFAULT_NODE_HEIGHT,d=c.y+l+ot.nodeSpacing,p=va(c.id);let u=c.data;if(c.data&&(u=JSON.parse(JSON.stringify(c.data))),c.type===Ke.CHAT&&u){const m=u;if(m.childNodeIds&&m.childNodeIds.length>0){const g=new Map;for(const x of m.childNodeIds){const w=r.find(v=>v.id===x);if(w){const v=va(x);g.set(x,v);const b={...w,id:v,data:w.data?JSON.parse(JSON.stringify(w.data)):void 0};o.push(b)}}m.childNodeIds=m.childNodeIds.map(x=>g.get(x)??x)}}return{...c,id:p,y:d,x:c.x+ot.nodeSpacing,data:u}});return{...t,nodes:[...t.nodes,...o,...i],selectedNodes:i}}),{})),hv=(s,e)=>({getNodeById:t=>t?Nx(s,t):void 0,setNodes:t=>Dx(e,t),setSelectedNodes:t=>_x(e,t),unselectNodeById:t=>Ox(e,t),addNode:(t,n,r)=>{var o;if(Lx(e,t,n,r),!(r!=null&&r.skipUndo)){const i=(o=s().projectCanvas.getActive())==null?void 0:o.coreState.nodes.find(c=>c.id===t.id);i&&s().undo.commit({type:"node:create",node:i})}},duplicateNodes:()=>pv(e),updateNode:(t,n)=>Ls(e)(t,n),updateNodes:t=>iv(e)(t),updateNodeGeometry:(t,n)=>Bx(e)(t,n),updateNodeContent:(t,n)=>Fx(e)(t,n),updateNodeSubContent:(t,n)=>$x(e)(t,n),updateNodeTitle:(t,n)=>Ux(e)(t,n),updateNodeStyles:(t,n)=>cv(e)(t,n),getEditingNode:()=>Wx(s),setActiveCanvasCoreState:t=>av(e,t),setState:t=>Mx(e,t)}),fv=(s,e)=>{const t=e().projectCanvas.getActive();if(!t)return;const n=t.coreState.selectedNodes;if(n.length===0)return;const r=new Set(n.map(d=>d.id));for(const d of n)if(d.type===Ke.CHAT){const p=d.data;p!=null&&p.childNodeIds&&p.childNodeIds.forEach(u=>r.add(u))}const o=r,i=t.coreState.nodes.filter(d=>o.has(d.id)),c=t.coreState.arrows.filter(d=>d.startNodeId&&o.has(d.startNodeId)||d.endNodeId&&o.has(d.endNodeId)),l=new Map;for(const d of c){if(d.startNodeId&&o.has(d.startNodeId)){const p=l.get(d.startNodeId)||[];p.push(d),l.set(d.startNodeId,p)}if(d.endNodeId&&o.has(d.endNodeId)){const p=l.get(d.endNodeId)||[];p.includes(d)||p.push(d),l.set(d.endNodeId,p)}}if(s(d=>(d.setActiveCanvasCoreState(p=>{const u=p.nodes.filter(m=>!o.has(m.id)),f=p.arrows.filter(m=>!(m.startNodeId&&o.has(m.startNodeId)||m.endNodeId&&o.has(m.endNodeId)));return{...p,nodes:u,arrows:f,selectedNodes:[]}}),{})),i.length===1)e().undo.commit({type:"node:delete",node:i[0],connectedArrows:l.get(i[0].id)||[]});else if(i.length>1){const d=i.map(p=>({type:"node:delete",node:p,connectedArrows:l.get(p.id)||[]}));e().undo.commit({type:"batch",label:`Delete ${i.length} nodes`,operations:d})}},mv=(s,e)=>{s(t=>{const n=t.projectCanvas.getActive();if(!n)return{};const r=new Set(n.coreState.selectedArrows.map(o=>o.id));return r.size===0?{}:(t.setActiveCanvasCoreState(o=>{const i=o.arrows.filter(c=>!r.has(c.id));return{...o,arrows:i,selectedArrows:[]}}),{})})},gv=(s,e)=>({deleteSelectedNodes:()=>fv(e,s),deleteSelectedArrows:()=>mv(e),deleteNodeById:t=>{const n=s().projectCanvas.getActive(),r=n==null?void 0:n.coreState.nodes.find(i=>i.id===t),o=n==null?void 0:n.coreState.arrows.filter(i=>i.startNodeId===t||i.endNodeId===t);zx(e,t),r&&s().undo.commit({type:"node:delete",node:r,connectedArrows:o||[]})},deleteAll:()=>Hx(e)});var cs=(s=>(s.FREEHAND="draw:freehand",s.RECTANGLE="draw:rectangle",s.SQUARE="draw:square",s.CIRCLE="draw:circle",s.ELLIPSE="draw:ellipse",s.LINE="draw:line",s.ARROW="draw:arrow",s))(cs||{});const vl={strokeColor:"currentColor",strokeWidth:2,strokeStyle:"solid",opacity:1},GC=2,qC=20,xv=(s,e)=>s(t=>({uiState:{...t.uiState,drawSubMode:e}})),vv=s=>s(e=>{const t=e.uiState.drawSubMode??cs.FREEHAND,n=[cs.FREEHAND,cs.RECTANGLE,cs.CIRCLE,cs.LINE],o=(n.indexOf(t)+1)%n.length;return{uiState:{...e.uiState,drawSubMode:n[o]}}}),bv=(s,e)=>s(t=>({uiState:{...t.uiState,temporaryDrawing:e}})),wv=(s,e)=>s(t=>({uiState:{...t.uiState,drawStyle:{...t.uiState.drawStyle??vl,...e}}})),yv=s=>s().uiState.drawSubMode??cs.FREEHAND,Sv=s=>s().uiState.temporaryDrawing??null,jv=s=>s().uiState.drawStyle??vl,Cv=(s,e)=>s(t=>({uiState:{...t.uiState,drawAxisLock:e}})),Nv=s=>s().uiState.drawAxisLock??"none",kv=(s,e)=>({setMode:t=>ex(e,t),setZoomSubMode:t=>tx(e,t),toggleZoomSubMode:()=>sx(e),setWriteSubMode:t=>nx(e,t),toggleWriteSubMode:()=>rx(e),setArrowSubMode:t=>ax(e,t),toggleArrowSubMode:()=>ox(e),setMessageSubMode:t=>ix(e,t),toggleMessageSubMode:()=>cx(e),setDrawSubMode:t=>xv(e,t),toggleDrawSubMode:()=>vv(e),setTemporaryDrawing:t=>bv(e,t),setDrawStyle:t=>wv(e,t),getDrawSubMode:()=>yv(s),getTemporaryDrawing:()=>Sv(s),getDrawStyle:()=>jv(s),setDrawAxisLock:t=>Cv(e,t),getDrawAxisLock:()=>Nv(s),setActiveCanvasViewState:t=>rv(e,t),setIsPanning:t=>dx(e,t),setIsHoldSelectActive:t=>ux(e,t),setHoldSelectProgress:t=>px(e,t),setSelectionBox:t=>hx(e,t),setPendingSelectionStart:t=>fx(e,t),setWriteModeStartPosition:t=>mx(e,t),setDragInfo:t=>gx(e,t),setGroupDragInfo:t=>xx(e,t),setHoveredDropTargetGroupId:t=>vx(e,t),setHoveredDropTargetVocabNodeId:t=>bx(e,t),incrementDragVersion:()=>wx(e),setTableDropTarget:t=>yx(e,t),setResizingNode:t=>Sx(e,t),setResizingGroup:t=>jx(e,t),setNodeToFocusId:t=>Cx(e,t),setAddNodeType:t=>kx(e,t),setCanvasDimensions:(t,n)=>Px(e,t,n),toggleOverlayVisibility:()=>Vx(e),toggleCurvedArrows:()=>Kx(e),setCustomNodeDropdownOpen:t=>Jx(e,t),setNodeUpdateSettings:t=>Yx(e,t),setZoomMarks:t=>Xx(e,t),addZoomMark:t=>Qx(e,t),removeZoomMark:t=>Zx(e,t),setUiState:t=>Rx(e,t),setArrangeSnapshot:t=>tv(e,t),revertArrangeSnapshot:()=>sv(e),clearArrangeSnapshot:()=>nv(e),setActiveGlobalOverlay:t=>ev(e,t),setActiveChatNodeId:(t,n=!1)=>Ex(e,t,n),setChatNodeHoldToDrag:t=>Tx(e,t),setNodeHoldToResize:t=>Ix(e,t),setNodeContextMenu:t=>Ax(e,t)}),ba="gz:";async function Ev(s){if(!s)return s;const t=new TextEncoder().encode(s),n=new CompressionStream("gzip"),r=n.writable.getWriter();r.write(t),r.close();const o=[],i=n.readable.getReader();for(;;){const{done:u,value:f}=await i.read();if(u)break;o.push(f)}const c=o.reduce((u,f)=>u+f.length,0),l=new Uint8Array(c);let d=0;for(const u of o)l.set(u,d),d+=u.length;const p=Array.from(l,u=>String.fromCharCode(u)).join("");return ba+btoa(p)}async function VC(s){if(!s||!s.startsWith(ba))return s;const e=s.slice(ba.length),t=atob(e),n=Uint8Array.from(t,f=>f.charCodeAt(0)),r=new DecompressionStream("gzip"),o=r.writable.getWriter();o.write(n),o.close();const i=[],c=r.readable.getReader();for(;;){const{done:f,value:m}=await c.read();if(f)break;i.push(m)}const l=i.reduce((f,m)=>f+m.length,0),d=new Uint8Array(l);let p=0;for(const f of i)d.set(f,p),p+=f.length;return new TextDecoder().decode(d)}function ti(s){return new Blob([s]).size}function si(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(2)} MB`}const Tv=s=>{if(!(s!=null&&s.projects))return s;const e={};for(const[t,n]of Object.entries(s.projects)){const r={};for(const[o,i]of Object.entries(n.workspaces)){const c={};for(const[l,d]of Object.entries(i.canvases)){const{undoTree:p,...u}=d;c[l]=u}r[o]={...i,canvases:c}}e[t]={...n,workspaces:r}}return{...s,projects:e}},Iv=(s,e,t)=>({saveStateToLocalStorage:()=>{const n={version:s().version,dataVersion:s().dataVersion,state:Tv(s().state),uiState:s().uiState,flags:s().flags,preferences:s().preferences,extensions:s().extensions,actions:s().actions},{temporaryArrow:r,selectionBox:o,dragInfo:i,resizingNode:c,...l}=n.uiState,d=n.extensions?{registry:n.extensions.registry,settings:n.extensions.settings}:void 0,p={...n,uiState:l,extensions:d},u=JSON.stringify(p);Ev(u).then(f=>{const m=ti(u),g=ti(f),x=((1-g/m)*100).toFixed(0);localStorage.setItem(e,f),t.log(`Canvas state saved: ${si(m)} â†’ ${si(g)} (${x}% reduction)`)}).catch(f=>{t.error("Failed to save state to localStorage",f),console.log("Failed to save state to localStorage",f),Ne.error("Save failed",{description:f instanceof Error?f.message:"Failed to save canvas",duration:3e3})})},saveCanvasData:()=>{s().saveStateToLocalStorage(),s().syncToApi()}}),Av="workflow-templates-project",Pv=(s,e)=>{var n,r;if(e===null)return ni(s);const t={...s,...e,uiState:{...s.uiState,...e.uiState||{},temporaryArrow:null,selectionBox:null,dragInfo:null,resizingNode:null},state:{projects:((n=e.state)==null?void 0:n.projects)||((r=s.state)==null?void 0:r.projects)||{},...s.state,...e.state||{}},flags:{...s.flags,...e.flags||{}},preferences:{...s.preferences,...e.preferences||{}},extensions:e.extensions?{registry:e.extensions.registry||{},settings:e.extensions.settings||{}}:s.extensions};return ni(t)},ni=s=>{var e;return(e=s.state)!=null&&e.projects&&(s.state.projects[Av]=rl()),s},Rv=s=>{const e=s==null?void 0:s.canvasConfig;e&&(e.arrows&&(e.arrows.type&&($e.arrows.type=e.arrows.type),e.arrows.REVERSE_CURVE!==void 0&&($e.arrows.REVERSE_CURVE=e.arrows.REVERSE_CURVE),e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR!==void 0&&($e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=e.arrows.CUBIC_ARROW_S_SHAPE_FACTOR),e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED!==void 0&&($e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=e.arrows.CUBIC_ARROW_S_SHAPE_REVERSED),e.arrows.CUBIC_HORIZONTAL_BIAS!==void 0&&($e.arrows.CUBIC_HORIZONTAL_BIAS=e.arrows.CUBIC_HORIZONTAL_BIAS),e.arrows.reverseArrowOnMultipleConnect!==void 0&&($e.arrows.reverseArrowOnMultipleConnect=e.arrows.reverseArrowOnMultipleConnect)),e.persistState!==void 0&&($e.persistState=e.persistState),e.autosave!==void 0&&($e.autosave=e.autosave),e.hideOverlay!==void 0&&($e.hideOverlay=e.hideOverlay),e.hideToolbar!==void 0&&($e.hideToolbar=e.hideToolbar),e.nodeOptions&&(e.nodeOptions.maxNodeWidth!==void 0&&($e.nodeOptions.maxNodeWidth=e.nodeOptions.maxNodeWidth),e.nodeOptions.resizeBorderWidth!==void 0&&($e.nodeOptions.resizeBorderWidth=e.nodeOptions.resizeBorderWidth)),e.zoom&&(e.zoom.min!==void 0&&($e.zoom.min=e.zoom.min),e.zoom.max!==void 0&&($e.zoom.max=e.zoom.max),e.zoom.intensity!==void 0&&($e.zoom.intensity=e.zoom.intensity)))};function bl(s){const{undoTree:e,...t}=s;return t}function wl(s){const e={};for(const[t,n]of Object.entries(s.canvases))e[t]=bl(n);return{...s,canvases:e}}function yl(s){const e={};for(const[t,n]of Object.entries(s.workspaces))e[t]=wl(n);return{...s,workspaces:e}}const Dv=s=>{var m,g,x;const e=s(),t=e.state;if(!t){console.error("Cannot export: State is not available.");return}const n={};for(const[w,v]of Object.entries(t.projects))n[w]=yl(v);const r={...t,projects:n},o=e.preferences,i={splitPresets:o==null?void 0:o.splitPresets,arrangePresets:o==null?void 0:o.arrangePresets,arrangeConfigFavorites:o==null?void 0:o.arrangeConfigFavorites,pinnedPaletteItems:o==null?void 0:o.pinnedPaletteItems,canvasConfig:o==null?void 0:o.canvasConfig,keepArrowsOnSplit:o==null?void 0:o.keepArrowsOnSplit,keepSplitMatch:o==null?void 0:o.keepSplitMatch,splitHorizontally:o==null?void 0:o.splitHorizontally,splitNodeGap:o==null?void 0:o.splitNodeGap,borderButton:o==null?void 0:o.borderButton,arrowStyleButton:o==null?void 0:o.arrowStyleButton,arrangeButton:o==null?void 0:o.arrangeButton,segmentedButtons:o==null?void 0:o.segmentedButtons,projectsManagerSearch:o==null?void 0:o.projectsManagerSearch,recentCanvases:o==null?void 0:o.recentCanvases,goToSymbolSearch:o==null?void 0:o.goToSymbolSearch,openTabs:o==null?void 0:o.openTabs},c={sequencePresets:(m=e.actions)==null?void 0:m.sequencePresets,history:(g=e.actions)==null?void 0:g.history,historySelection:(x=e.actions)==null?void 0:x.historySelection},l={...r,preferences:i,actions:c},d=JSON.stringify(l,null,2),p=new Blob([d],{type:"application/json"}),u=URL.createObjectURL(p),f=document.createElement("a");f.href=u,f.download=`markop-canvas-export-${new Date().toISOString()}.json`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u)},_v=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r,canvasId:o}=e,i=t.projects[n];if(!i){console.error(`Cannot export: Project ${n} not found.`);return}const c=i.workspaces[r];if(!c){console.error(`Cannot export: Workspace ${r} not found.`);return}const l=c.canvases[o];if(!l){console.error(`Cannot export: Canvas ${o} not found.`);return}const d=bl(l),p={...c,canvases:{[o]:d},activeCanvasId:o},u={...i,workspaces:{[r]:p},activeWorkspaceId:r},f={projects:{[n]:u},activeProjectId:n},m=JSON.stringify(f,null,2),g=new Blob([m],{type:"application/json"}),x=URL.createObjectURL(g),w=l.name.replace(/[^a-zA-Z0-9-_]/g,"_"),v=document.createElement("a");v.href=x,v.download=`canvas-${w}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(x)},Ov=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n,workspaceId:r}=e,o=t.projects[n];if(!o){console.error(`Cannot export: Project ${n} not found.`);return}const i=o.workspaces[r];if(!i){console.error(`Cannot export: Workspace ${r} not found.`);return}const c=wl(i),l={...o,workspaces:{[r]:c},activeWorkspaceId:r},d={projects:{[n]:l},activeProjectId:n},p=JSON.stringify(d,null,2),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),m=i.name.replace(/[^a-zA-Z0-9-_]/g,"_"),g=document.createElement("a");g.href=f,g.download=`workspace-${m}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(f)},Lv=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:n}=e,r=t.projects[n];if(!r){console.error(`Cannot export: Project ${n} not found.`);return}const o=yl(r),i={projects:{[n]:o},activeProjectId:n},c=JSON.stringify(i,null,2),l=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(l),p=r.name.replace(/[^a-zA-Z0-9-_]/g,"_"),u=document.createElement("a");u.href=d,u.download=`project-${p}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d)},Mv=(s,e,t={})=>{const{replace:n=!1}=t;try{const r=JSON.parse(e);if((!r||typeof r.projects!="object")&&r.projects!==null)throw new Error("Invalid data format: Missing or invalid 'projects' structure.");const o=r.projects??{};let i=0,c=0;if(n){let l=r.activeProjectId;l&&!o[l]?(console.warn("Imported activeProjectId does not exist in the imported projects. Resetting active project."),l=Object.keys(o)[0]??null):!l&&Object.keys(o).length>0&&(l=Object.keys(o)[0]),i=Object.keys(o).length;const d=r.preferences,p=r.actions;s(u=>{var m,g,x,w,v,b,y,C,S,j,N,E,R,D,T,L,_,P,G,$;const f={...u.preferences,splitPresets:(d==null?void 0:d.splitPresets)??((m=u.preferences)==null?void 0:m.splitPresets),arrangePresets:(d==null?void 0:d.arrangePresets)??((g=u.preferences)==null?void 0:g.arrangePresets),arrangeConfigFavorites:(d==null?void 0:d.arrangeConfigFavorites)??((x=u.preferences)==null?void 0:x.arrangeConfigFavorites),pinnedPaletteItems:(d==null?void 0:d.pinnedPaletteItems)??((w=u.preferences)==null?void 0:w.pinnedPaletteItems),canvasConfig:(d==null?void 0:d.canvasConfig)??((v=u.preferences)==null?void 0:v.canvasConfig),keepArrowsOnSplit:(d==null?void 0:d.keepArrowsOnSplit)??((b=u.preferences)==null?void 0:b.keepArrowsOnSplit),keepSplitMatch:(d==null?void 0:d.keepSplitMatch)??((y=u.preferences)==null?void 0:y.keepSplitMatch),splitHorizontally:(d==null?void 0:d.splitHorizontally)??((C=u.preferences)==null?void 0:C.splitHorizontally),splitNodeGap:(d==null?void 0:d.splitNodeGap)??((S=u.preferences)==null?void 0:S.splitNodeGap),borderButton:(d==null?void 0:d.borderButton)??((j=u.preferences)==null?void 0:j.borderButton),arrowStyleButton:(d==null?void 0:d.arrowStyleButton)??((N=u.preferences)==null?void 0:N.arrowStyleButton),arrangeButton:(d==null?void 0:d.arrangeButton)??((E=u.preferences)==null?void 0:E.arrangeButton),segmentedButtons:(d==null?void 0:d.segmentedButtons)??((R=u.preferences)==null?void 0:R.segmentedButtons),projectsManagerSearch:(d==null?void 0:d.projectsManagerSearch)??((D=u.preferences)==null?void 0:D.projectsManagerSearch),recentCanvases:(d==null?void 0:d.recentCanvases)??((T=u.preferences)==null?void 0:T.recentCanvases),goToSymbolSearch:(d==null?void 0:d.goToSymbolSearch)??((L=u.preferences)==null?void 0:L.goToSymbolSearch),openTabs:(d==null?void 0:d.openTabs)??((_=u.preferences)==null?void 0:_.openTabs)};return{...u,state:{projects:o,activeProjectId:l??null,nodes:void 0,arrows:void 0,selectedArrows:void 0},preferences:f,actions:{...u.actions,sequencePresets:(p==null?void 0:p.sequencePresets)??((P=u.actions)==null?void 0:P.sequencePresets),history:(p==null?void 0:p.history)??((G=u.actions)==null?void 0:G.history),historySelection:(p==null?void 0:p.historySelection)??(($=u.actions)==null?void 0:$.historySelection)},uiState:{...u.uiState,dragInfo:null,resizingNode:null,temporaryArrow:null,selectionBox:null,isPanning:!1,nodeToFocusId:null}}}),console.log(`Canvas data replaced: ${i} project(s) imported.`)}else{const l=r.preferences,d=r.actions;s(p=>{var m,g,x,w,v,b,y,C,S,j,N,E,R,D,T,L,_,P,G,$,Y;const u=((m=p.state)==null?void 0:m.projects)??{},f={...u};for(const[A,X]of Object.entries(o))u[A]?(c++,console.warn(`Project "${X.name}" (${A}) already exists, skipping.`)):(f[A]=X,i++);return{...p,state:{...p.state,projects:f},...l&&{preferences:{...p.preferences,splitPresets:l.splitPresets??((g=p.preferences)==null?void 0:g.splitPresets),arrangePresets:l.arrangePresets??((x=p.preferences)==null?void 0:x.arrangePresets),arrangeConfigFavorites:l.arrangeConfigFavorites??((w=p.preferences)==null?void 0:w.arrangeConfigFavorites),pinnedPaletteItems:l.pinnedPaletteItems??((v=p.preferences)==null?void 0:v.pinnedPaletteItems),canvasConfig:l.canvasConfig??((b=p.preferences)==null?void 0:b.canvasConfig),keepArrowsOnSplit:l.keepArrowsOnSplit??((y=p.preferences)==null?void 0:y.keepArrowsOnSplit),keepSplitMatch:l.keepSplitMatch??((C=p.preferences)==null?void 0:C.keepSplitMatch),splitHorizontally:l.splitHorizontally??((S=p.preferences)==null?void 0:S.splitHorizontally),splitNodeGap:l.splitNodeGap??((j=p.preferences)==null?void 0:j.splitNodeGap),borderButton:l.borderButton??((N=p.preferences)==null?void 0:N.borderButton),arrowStyleButton:l.arrowStyleButton??((E=p.preferences)==null?void 0:E.arrowStyleButton),arrangeButton:l.arrangeButton??((R=p.preferences)==null?void 0:R.arrangeButton),segmentedButtons:l.segmentedButtons??((D=p.preferences)==null?void 0:D.segmentedButtons),projectsManagerSearch:l.projectsManagerSearch??((T=p.preferences)==null?void 0:T.projectsManagerSearch),recentCanvases:l.recentCanvases??((L=p.preferences)==null?void 0:L.recentCanvases),goToSymbolSearch:l.goToSymbolSearch??((_=p.preferences)==null?void 0:_.goToSymbolSearch),openTabs:l.openTabs??((P=p.preferences)==null?void 0:P.openTabs)}},...d&&{actions:{...p.actions,sequencePresets:d.sequencePresets??((G=p.actions)==null?void 0:G.sequencePresets),history:d.history??(($=p.actions)==null?void 0:$.history),historySelection:d.historySelection??((Y=p.actions)==null?void 0:Y.historySelection)}}}}),console.log(`Canvas data merged: ${i} project(s) imported, ${c} skipped.`)}return{projectsImported:i,projectsSkipped:c}}catch(r){return console.error("Failed to import canvas project data:",r),{projectsImported:0,projectsSkipped:0}}},Fv=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Date().toISOString(),u=d.map(f=>({...f,id:va(f.id),createdAt:p,updatedAt:p,isSelected:!1,isEditing:!1}));s(se(f=>{var g,x,w,v,b,y;const m=(y=(b=(v=(w=(x=(g=f.state)==null?void 0:g.projects)==null?void 0:x[r])==null?void 0:w.workspaces)==null?void 0:v[o])==null?void 0:b.canvases)==null?void 0:y[i];m!=null&&m.coreState&&(m.coreState.nodes.push(...u),m.lastModified=Date.now())}))},$v=(s,e,t)=>{const{nodeIds:n,targetProjectId:r,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const d=l.coreState.nodes.filter(f=>n.includes(f.id));if(d.length===0)return;const p=new Set(n),u=new Date().toISOString();s(se(f=>{var C,S,j,N,E,R,D,T,L,_,P;const m=(C=f.state)==null?void 0:C.activeProjectId;if(!m)return;const g=(j=(S=f.state)==null?void 0:S.projects)==null?void 0:j[m];if(!g)return;const x=g.activeWorkspaceId;if(!x)return;const w=(N=g.workspaces)==null?void 0:N[x];if(!w)return;const v=w.activeCanvasId;if(!v)return;const b=(E=w.canvases)==null?void 0:E[v];b!=null&&b.coreState&&(b.coreState.nodes=b.coreState.nodes.filter(G=>!p.has(G.id)),b.coreState.selectedNodes=[],b.coreState.arrows=b.coreState.arrows.filter(G=>!(G.startNodeId&&p.has(G.startNodeId)||G.endNodeId&&p.has(G.endNodeId))),b.lastModified=Date.now());const y=(P=(_=(L=(T=(D=(R=f.state)==null?void 0:R.projects)==null?void 0:D[r])==null?void 0:T.workspaces)==null?void 0:L[o])==null?void 0:_.canvases)==null?void 0:P[i];if(y!=null&&y.coreState){const G=d.map($=>({...$,updatedAt:u,isSelected:!1,isEditing:!1}));y.coreState.nodes.push(...G),y.lastModified=Date.now()}}))},Uv=(s,e)=>({exportCanvasData:()=>Dv(s),exportSingleCanvas:t=>_v(s)(t),exportSingleWorkspace:t=>Ov(s)(t),exportSingleProject:t=>Lv(s)(t),importCanvasData:(t,n)=>Mv(e,t,n),copyNodesToCanvas:t=>Fv(e,s,t),moveNodesToCanvas:t=>$v(e,s,t)}),Bv=(s,e,t)=>{const n=Ue(10),r=Date.now(),o=Ue(10),i={id:o,name:"Default Canvas",createdAt:r,lastModified:r,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},c=Ue(10),l={id:c,name:"Default Workspace",createdAt:r,lastModified:r,canvases:{[o]:i},activeCanvasId:o},d={id:n,name:t||"New Project",createdAt:r,lastModified:r,workspaces:{[c]:l},activeWorkspaceId:c};return s(se(p=>{p.state||(p.state={projects:{},activeProjectId:null}),p.state.projects[n]=d,p.state.activeProjectId=n})),n},Wv=(s,e,t)=>{s(se(n=>{var r;(r=n.state)!=null&&r.projects[t]?n.state.activeProjectId=t:console.warn(`Project with ID ${t} not found.`)}))},zv=(s,e,t)=>{s(se(n=>{var r;if((r=n.state)!=null&&r.projects[t]&&(delete n.state.projects[t],n.state.activeProjectId===t)){const o=Object.keys(n.state.projects);n.state.activeProjectId=o.length>0?o[0]:null}}))},Hv=(s,e,t,n)=>{s(se(r=>{var i;const o=(i=r.state)==null?void 0:i.projects[t];o&&(n.name!==void 0&&(o.name=n.name),n.hideFromSearch!==void 0&&(o.hideFromSearch=n.hideFromSearch),o.lastModified=n.lastModified??Date.now())}))},Sl=s=>{const e=s().state;if(!e)return null;const{projects:t,activeProjectId:n}=e;return n?t[n]??null:null},Gv=(s,e)=>({create:t=>Bv(s,e,t),switch:t=>Wv(s,e,t),delete:t=>zv(s,e,t),updateMetadata:(t,n)=>Hv(s,e,t,n),getActive:()=>Sl(e)}),qv=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId;if(!n)return null;const r=Ue(10),o=Date.now(),i=Ue(10),c={id:i,name:"Default Canvas",createdAt:o,lastModified:o,coreState:{nodes:[],arrows:[],groups:[],selectedNodes:[],selectedArrows:[],selectedGroups:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}},l={id:r,name:t||"New Workspace",createdAt:o,lastModified:o,canvases:{[i]:c},activeCanvasId:i};return s(se(p=>{var f;const u=(f=p.state)==null?void 0:f.projects[n];u&&(u.workspaces[r]=l,u.activeWorkspaceId=r,u.lastModified=o)})),r},Vv=(s,e,t)=>{s(se(n=>{var o;const r=(o=n.state)!=null&&o.activeProjectId?n.state.projects[n.state.activeProjectId]:null;r&&r.workspaces[t]?(r.activeWorkspaceId=t,r.lastModified=Date.now()):console.warn(`Workspace with ID ${t} not found in active project.`)}))},Kv=(s,e,t)=>{s(se(n=>{var o;const r=(o=n.state)!=null&&o.activeProjectId?n.state.projects[n.state.activeProjectId]:null;if(r&&r.workspaces[t]&&(delete r.workspaces[t],r.lastModified=Date.now(),r.activeWorkspaceId===t)){const i=Object.keys(r.workspaces);r.activeWorkspaceId=i.length>0?i[0]:null}}))},Jv=(s,e,t,n)=>{s(se(r=>{var c;const o=(c=r.state)!=null&&c.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o?o.workspaces[t]:null;if(i){n.name!==void 0&&(i.name=n.name),n.hideFromSearch!==void 0&&(i.hideFromSearch=n.hideFromSearch);const l=n.lastModified??Date.now();i.lastModified=l,o&&(o.lastModified=l)}}))},eo=s=>{const e=Sl(s);return e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]??null:null},Yv=(s,e)=>({create:t=>qv(s,e,t),switch:t=>Vv(s,e,t),delete:t=>Kv(s,e,t),updateMetadata:(t,n)=>Jv(s,e,t,n),getActive:()=>eo(e)}),Xv={CanvasStateV2:!1,useSelectionHandler:!1,useArrowDrawingV2:!1,useDrawingV2:!1,useCanvasKeyboardEventsV2:!1,useCanvasMouseEventsV2:!1,WriteModeHandlerV2:!1},ri=10,Qv=(s,e)=>{const t=s.replace(/\s*\(\d+\)$/,"");if(!e.includes(t)&&s!==t)return t;const n=new RegExp(`^${Zv(t)}\\s*\\((\\d+)\\)$`),r=e.map(c=>{const l=c.match(n);return l?parseInt(l[1],10):0}).filter(c=>c>0),o=e.includes(t);let i=1;return(o||r.length>0)&&(i=Math.max(0,...r)+1),`${t} (${i})`},Zv=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),eb=(s,e,t)=>{var d;const n=(d=e().state)==null?void 0:d.activeProjectId,r=eo(e),o=r==null?void 0:r.id;if(!n||!o)return null;const i=Ue(10),c=Date.now(),l={id:i,name:t||"New Canvas",createdAt:c,lastModified:c,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[],layers:[],activeLayerId:null},viewState:{offset:{x:50,y:50},scale:1}};return s(se(p=>{var m;const u=(m=p.state)==null?void 0:m.projects[n],f=u==null?void 0:u.workspaces[o];f&&(f.canvases[i]=l,f.activeCanvasId=i,f.lastModified=c,u&&(u.lastModified=c))})),i},tb=(s,e,t)=>{s(se(n=>{if(!n.state)return;let r=null,o=null;for(const[p,u]of Object.entries(n.state.projects)){for(const[f,m]of Object.entries(u.workspaces))if(m.canvases[t]){r=p,o=f;break}if(r)break}if(!r||!o){console.warn(`Canvas with ID ${t} not found in any workspace.`);return}const i=Date.now();n.state.activeProjectId!==r&&(n.state.activeProjectId=r);const c=n.state.projects[r];if(!c)return;c.activeWorkspaceId!==o&&(c.activeWorkspaceId=o);const l=c.workspaces[o];if(!l)return;l.activeCanvasId=t,l.lastModified=i,c.lastModified=i;const d=l.canvases[t];if(d){n.preferences||(n.preferences={}),n.preferences.recentCanvases||(n.preferences.recentCanvases=[]);const p={projectId:r,workspaceId:o,canvasId:t,canvasName:d.name,projectName:c.name,workspaceName:l.name,visitedAt:i};if(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(f=>f.canvasId!==t),n.preferences.recentCanvases.unshift(p),n.preferences.recentCanvases.length>ri&&(n.preferences.recentCanvases=n.preferences.recentCanvases.slice(0,ri)),n.preferences.openTabs||(n.preferences.openTabs=[]),!n.preferences.openTabs.some(f=>f.canvasId===t)){const f={canvasId:t,projectId:r,workspaceId:o};n.preferences.openTabs.push(f)}}}))},sb=(s,e,t)=>{s(se(n=>{var i,c;const r=(i=n.state)!=null&&i.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null;if(o&&o.canvases[t]){delete o.canvases[t];const l=Date.now();if(o.lastModified=l,r&&(r.lastModified=l),o.activeCanvasId===t){const d=Object.keys(o.canvases);o.activeCanvasId=d.length>0?d[0]:null}}(c=n.preferences)!=null&&c.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(l=>l.canvasId!==t))}))},nb=(s,e,t,n)=>{s(se(r=>{var l;const o=(l=r.state)!=null&&l.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i?i.canvases[t]:null;if(c){n.name!==void 0&&(c.name=n.name),n.hideFromSearch!==void 0&&(c.hideFromSearch=n.hideFromSearch);const d=n.lastModified??Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}}))},rb=(s,e,t,n,r)=>{const o=e().state;if(!o)return null;const i=o.projects[n];if(!i)return null;const c=i.workspaces[r];if(!c)return null;const l=c.canvases[t];if(!l)return null;const d=Object.values(c.canvases).map(g=>g.name),p=Qv(l.name,d),u=Ue(10),f=Date.now(),m={id:u,name:p,createdAt:f,lastModified:f,coreState:{nodes:l.coreState.nodes.map(g=>({...g})),arrows:l.coreState.arrows.map(g=>({...g})),selectedNodes:[],selectedArrows:[],layers:(l.coreState.layers??[]).map(g=>({...g})),activeLayerId:l.coreState.activeLayerId??null},viewState:{offset:{...l.viewState.offset},scale:l.viewState.scale}};return s(se(g=>{var v;const x=(v=g.state)==null?void 0:v.projects[n],w=x==null?void 0:x.workspaces[r];w&&(w.canvases[u]=m,w.activeCanvasId=u,w.lastModified=f,x&&(x.lastModified=f))})),u},ab=(s,e,t)=>{s(se(n=>{var r;(r=n.preferences)!=null&&r.recentCanvases&&(n.preferences.recentCanvases=n.preferences.recentCanvases.filter(o=>o.canvasId!==t))}))},ob=s=>{const e=eo(s),t=e&&e.activeCanvasId?e.canvases[e.activeCanvasId]??null:null;return window.activeCanvas=t,t},ib=(s,e)=>({create:t=>eb(s,e,t),switch:t=>tb(s,e,t),delete:t=>sb(s,e,t),duplicate:(t,n,r)=>rb(s,e,t,n,r),updateMetadata:(t,n)=>nb(s,e,t,n),getActive:()=>ob(e),removeRecentCanvas:t=>ab(s,e,t)});class cb{constructor(e,t=!1){ee(this,"enabled");ee(this,"name");this.name=e,this.enabled=t}setEnabled(e){this.enabled=e}formatMessage(e){return[`[${this.name}]`,...e]}log(...e){this.enabled&&console.log(...this.formatMessage(e))}warn(...e){this.enabled&&console.warn(...this.formatMessage(e))}error(...e){this.enabled&&console.error(...this.formatMessage(e))}}const lb=(s,e,t,n)=>{const r=t/2-s.x*e,o=n/2-s.y*e;return{x:r,y:o}},db=(s,e)=>{const t=e.find(i=>i.id===s.startNodeId),n=e.find(i=>i.id===s.endNodeId),r=t?ei(t):s.startPoint,o=n?ei(n):s.endPoint;return{x:(r.x+o.x)/2,y:(r.y+o.y)/2}},ub=(s,e,t,n=500)=>{const{uiState:r,projectCanvas:o,setActiveCanvasViewState:i}=e(),c=o.getActive();if(!c){console.warn("Cannot center view: No active canvas.");return}const l=c.coreState.arrows,d=c.coreState.nodes,p=c.viewState.scale,u=r==null?void 0:r.canvasWidth,f=r==null?void 0:r.canvasHeight,m=typeof t=="string"?l==null?void 0:l.find(w=>w.id===t):t;if(!m){console.warn("Cannot center view: Arrow not found.");return}if(!u||!f){console.warn("Cannot center view: Canvas dimensions not found.");return}const g=db(m,d),x=lb(g,p,u,f);i(w=>({...w,targetView:{targetOffset:x,targetScale:p,animationStartTime:performance.now(),animationDuration:n}}))},yn=20,ai=40;function pb(s){if(s.length===0)return{x:0,y:0,width:100,height:100};let e=1/0,t=1/0,n=-1/0,r=-1/0;return s.forEach(o=>{e=Math.min(e,o.x),t=Math.min(t,o.y),n=Math.max(n,o.x+(o.width??100)),r=Math.max(r,o.y+(o.height??50))}),{x:e-yn,y:t-yn-ai,width:n-e+yn*2,height:r-t+yn*2+ai}}function Ms(s){return s.type===Ke.GROUP}function to(s){if(Ms(s))return s.data}const hb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const o=r.coreState.selectedNodes;if(o.length<2)return null;const i=Ue(10),c=pb(o),l=o.map(m=>m.id),d=r.coreState.nodes.filter(Ms),p=t||`Group ${d.length+1}`,u=new Date().toISOString(),f={id:i,type:Ke.GROUP,x:c.x,y:c.y,width:c.width,height:c.height,title:p,data:{childNodeIds:l},createdAt:u,updatedAt:u};return s(se(m=>{if(!m.state)return;const g=m.state.activeProjectId?m.state.projects[m.state.activeProjectId]:null,x=g&&g.activeWorkspaceId?g.workspaces[g.activeWorkspaceId]:null,w=x&&x.activeCanvasId?x.canvases[x.activeCanvasId]:null;if(!w)return;w.coreState.nodes.push(f),w.coreState.nodes=w.coreState.nodes.map(b=>l.includes(b.id)?{...b,groupId:i}:b),w.coreState.selectedNodes=[f];const v=Date.now();w.lastModified=v,x&&(x.lastModified=v),g&&(g.lastModified=v)})),i},fb=(s,e,t)=>{s(se(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return;const c=i.coreState.nodes.findIndex(m=>m.id===t&&Ms(m));if(c===-1)return;const l=i.coreState.nodes[c],d=to(l),p=(d==null?void 0:d.childNodeIds)??[];i.coreState.nodes=i.coreState.nodes.map(m=>{if(m.groupId===t){const{groupId:g,...x}=m;return x}return m});const u=i.coreState.nodes.filter(m=>p.includes(m.id));i.coreState.nodes.splice(c,1),i.coreState.selectedNodes=u;const f=Date.now();i.lastModified=f,o&&(o.lastModified=f),r&&(r.lastModified=f)}))},mb=(s,e,t,n)=>{var c;const r=e().getNodeById(t),o=r==null?void 0:r.data,i=(c=o==null?void 0:o.automation)==null?void 0:c.onEnter;if(s(se(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=u.coreState.nodes.findIndex(v=>v.id===t&&Ms(v));if(f===-1)return;const m=u.coreState.nodes[f],g=to(m)??{childNodeIds:[]},x=new Set([...g.childNodeIds,...n]);g.childNodeIds=Array.from(x),m.data=g,u.coreState.nodes=u.coreState.nodes.map(v=>n.includes(v.id)?{...v,groupId:t}:v),m.updatedAt=new Date().toISOString();const w=Date.now();u.lastModified=w,p&&(p.lastModified=w),d&&(d.lastModified=w)})),i!=null&&i.enabled&&i.tags.length>0)for(const l of n)for(const d of i.tags)e().addTagToNode(l,{id:Ue(8),title:d})},gb=(s,e,t)=>{var r;const n=new Map;for(const o of t){const i=e().getNodeById(o);if(i!=null&&i.groupId){const c=e().getNodeById(i.groupId),l=c==null?void 0:c.data,d=(r=l==null?void 0:l.automation)==null?void 0:r.onLeave;d!=null&&d.enabled&&d.tags.length>0&&n.set(o,{groupId:i.groupId,onLeaveTags:d.tags})}}s(se(o=>{if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=new Set;l.coreState.nodes.forEach(u=>{t.includes(u.id)&&u.groupId&&d.add(u.groupId)}),l.coreState.nodes=l.coreState.nodes.map(u=>{if(t.includes(u.id)&&u.groupId){const{groupId:f,...m}=u;return m}return u}),d.forEach(u=>{const f=l.coreState.nodes.findIndex(x=>x.id===u&&Ms(x));if(f===-1)return;const m=l.coreState.nodes[f],g=to(m);g&&(g.childNodeIds=g.childNodeIds.filter(x=>!t.includes(x)),m.data=g,m.updatedAt=new Date().toISOString())});const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}));for(const[o,{onLeaveTags:i}]of n){const c=e().getNodeById(o);if(c!=null&&c.tags)for(const l of i){const d=c.tags.find(p=>p.title===l);d&&e().removeTagFromNode(o,d.id)}}},xb=(s,e,t)=>{s(se(n=>{n.uiState.activeGroupId=t}))},vb=(s,e)=>{const t=s().projectCanvas.getActive();return t?t.coreState.nodes.find(r=>r.id===e&&Ms(r))??null:null},bb=(s,e)=>({createFromSelected:t=>hb(s,e,t),ungroup:t=>fb(s,e,t),addNodesToGroup:(t,n)=>mb(s,e,t,n),removeNodesFromGroup:t=>gb(s,e,t),setActiveGroupId:t=>xb(s,e,t),getById:t=>vb(e,t)}),wb=33,oi=24;function jl(s){return s===Ke.TABLE}function Cl(s){const e=s;return!(e!=null&&e.columns)||!Array.isArray(e.columns)?null:e}const yb=(s,e,t,n,r)=>{let o=!1;return s(se(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=d.coreState.nodes.findIndex(S=>S.id===t&&jl(S.type));if(p===-1)return;const u=d.coreState.nodes[p],f=Cl(u.data);if(!f)return;const m={id:`row-${Date.now()}`};f.columns.forEach(S=>{m[S.key]=S.key===n?r:""}),f.rows.push(m),u.data=f,u.updatedAt=new Date().toISOString();const g=f.columns.find(S=>S.key===n);let x=150;if(g!=null&&g.width){const S=parseInt(g.width,10);isNaN(S)||(x=S)}const w=x-oi,v=Vn(r,w),b=Math.max(wb,v+oi),y=u.height??250;u.height=y+b;const C=Date.now();d.lastModified=C,l&&(l.lastModified=C),c&&(c.lastModified=C),o=!0})),o},Sb=(s,e,t,n,r,o)=>{let i=!1;return s(se(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;if(!p)return;const u=p.coreState.nodes.findIndex(w=>w.id===t&&jl(w.type));if(u===-1)return;const f=p.coreState.nodes[u],m=Cl(f.data);if(!m)return;const g=m.rows.findIndex(w=>w.id===n);if(g===-1)return;m.rows[g][r]=o,f.data=m,f.updatedAt=new Date().toISOString();const x=Date.now();p.lastModified=x,d&&(d.lastModified=x),l&&(l.lastModified=x),i=!0})),i},jb=(s,e)=>({addRowFromDrop:(t,n,r)=>yb(s,e,t,n,r),updateCellFromDrop:(t,n,r,o)=>Sb(s,e,t,n,r,o)}),us="default-layer",Cb="Layer 1";function Nb(s=us,e=Cb){const t=new Date().toISOString();return{id:s,name:e,order:0,isVisible:!0,opacity:100,isLocked:!1,createdAt:t,updatedAt:t}}function Nl(s){return[...s].sort((e,t)=>e.order-t.order)}function so(s){return s.length===0?-1:Math.max(...s.map(e=>e.order))}function Yn(s){return s.length===0?[Nb()]:s}const kb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;const o=Yn(r.coreState.layers??[]),i=so(o),c=Ue(10),l=t||`Layer ${o.length+1}`,d=new Date().toISOString(),p={id:c,name:l,order:i+1,isVisible:!0,opacity:100,isLocked:!1,createdAt:d,updatedAt:d};return s(se(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=Yn(g.coreState.layers??[]),g.coreState.layers.push(p),g.coreState.activeLayerId=c;const x=Date.now();g.lastModified=x,m&&(m.lastModified=x),f&&(f.lastModified=x)})),c},Eb=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||(r.coreState.layers??[]).length<=1||s(se(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;const p=Nl(d.coreState.layers??[]),u=p.findIndex(g=>g.id===t);if(u===-1)return;let f;u>0?f=p[u-1].id:p.length>1&&(f=p[1].id),f&&(d.coreState.nodes=d.coreState.nodes.map(g=>(g.layerId??us)===t?{...g,layerId:f}:g)),d.coreState.layers=d.coreState.layers.filter(g=>g.id!==t),d.coreState.activeLayerId===t&&(d.coreState.activeLayerId=f??null);const m=Date.now();d.lastModified=m,l&&(l.lastModified=m),c&&(c.lastModified=m)}))},Tb=(s,e,t,n)=>{s(se(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.name=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},Ib=(s,e,t,n)=>{s(se(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isVisible=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},Ab=(s,e,t,n)=>{const r=Math.max(0,Math.min(100,n));s(se(o=>{var u;if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;const d=(u=l.coreState.layers)==null?void 0:u.find(f=>f.id===t);if(!d)return;d.opacity=r,d.updatedAt=new Date().toISOString();const p=Date.now();l.lastModified=p,c&&(c.lastModified=p),i&&(i.lastModified=p)}))},Pb=(s,e,t,n)=>{s(se(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(p=c.coreState.layers)==null?void 0:p.find(u=>u.id===t);if(!l)return;l.isLocked=n,l.updatedAt=new Date().toISOString();const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},Rb=(s,e,t,n)=>{s(se(r=>{var u,f;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c)return;const l=(u=c.coreState.layers)==null?void 0:u.find(m=>m.id===t);if(!l)return;const d=l.order;l.order=n,(f=c.coreState.layers)==null||f.forEach(m=>{m.id!==t&&(n>d?m.order>d&&m.order<=n&&m.order--:m.order>=n&&m.order<d&&m.order++)}),l.updatedAt=new Date().toISOString();const p=Date.now();c.lastModified=p,i&&(i.lastModified=p),o&&(o.lastModified=p)}))},Db=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(d=>d.id===t);if(!i)return;const c=so(o);if(i.order>=c)return;const l=o.find(d=>d.order===i.order+1);l&&s(se(d=>{var v,b;if(!d.state)return;const p=d.state.activeProjectId?d.state.projects[d.state.activeProjectId]:null,u=p&&p.activeWorkspaceId?p.workspaces[p.activeWorkspaceId]:null,f=u&&u.activeCanvasId?u.canvases[u.activeCanvasId]:null;if(!f)return;const m=(v=f.coreState.layers)==null?void 0:v.find(y=>y.id===t),g=(b=f.coreState.layers)==null?void 0:b.find(y=>y.id===l.id);if(!m||!g)return;const x=new Date().toISOString();g.order=m.order,m.order=m.order+1,m.updatedAt=x,g.updatedAt=x;const w=Date.now();f.lastModified=w,u&&(u.lastModified=w),p&&(p.lastModified=w)}))},_b=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(l=>l.id===t);if(!i||i.order<=0)return;const c=o.find(l=>l.order===i.order-1);c&&s(se(l=>{var w,v;if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;const f=(w=u.coreState.layers)==null?void 0:w.find(b=>b.id===t),m=(v=u.coreState.layers)==null?void 0:v.find(b=>b.id===c.id);if(!f||!m)return;const g=new Date().toISOString();m.order=f.order,f.order=f.order-1,f.updatedAt=g,m.updatedAt=g;const x=Date.now();u.lastModified=x,p&&(p.lastModified=x),d&&(d.lastModified=x)}))},Ob=(s,e,t)=>{s(se(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return;i.coreState.activeLayerId=t;const c=Date.now();i.lastModified=c,o&&(o.lastModified=c),r&&(r.lastModified=c)}))},Lb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return null;let o=r.coreState.layers??[];if(o.length===0&&t===us){const u=Ue(10),f=new Date().toISOString(),m={id:u,name:"Layer 1 (Copy)",order:1,isVisible:!0,opacity:100,isLocked:!1,createdAt:f,updatedAt:f};return s(se(g=>{if(!g.state)return;const x=g.state.activeProjectId?g.state.projects[g.state.activeProjectId]:null,w=x&&x.activeWorkspaceId?x.workspaces[x.activeWorkspaceId]:null,v=w&&w.activeCanvasId?w.canvases[w.activeCanvasId]:null;if(!v)return;v.coreState.layers=Yn(v.coreState.layers??[]),v.coreState.layers.push(m);const y=v.coreState.nodes.filter(S=>!S.layerId||S.layerId===us).map(S=>({...S,id:Ue(10),layerId:u,createdAt:f,updatedAt:f}));v.coreState.nodes=[...v.coreState.nodes,...y],v.coreState.activeLayerId=u;const C=Date.now();v.lastModified=C,w&&(w.lastModified=C),x&&(x.lastModified=C)})),u}const i=o.find(u=>u.id===t);if(!i)return null;const c=so(o),l=Ue(10),d=new Date().toISOString(),p={id:l,name:`${i.name} (Copy)`,order:c+1,isVisible:i.isVisible,opacity:i.opacity,isLocked:!1,createdAt:d,updatedAt:d};return s(se(u=>{if(!u.state)return;const f=u.state.activeProjectId?u.state.projects[u.state.activeProjectId]:null,m=f&&f.activeWorkspaceId?f.workspaces[f.activeWorkspaceId]:null,g=m&&m.activeCanvasId?m.canvases[m.activeCanvasId]:null;if(!g)return;g.coreState.layers=Yn(g.coreState.layers??[]),g.coreState.layers.push(p);const w=g.coreState.nodes.filter(b=>(b.layerId??us)===t).map(b=>({...b,id:Ue(10),layerId:l,createdAt:d,updatedAt:d}));g.coreState.nodes=[...g.coreState.nodes,...w],g.coreState.activeLayerId=l;const v=Date.now();g.lastModified=v,m&&(m.lastModified=v),f&&(f.lastModified=v)})),l},Mb=(s,e,t)=>{const r=e().projectCanvas.getActive();if(!r)return;const o=r.coreState.layers??[],i=o.find(l=>l.id===t);if(!i)return;const c=o.find(l=>l.order===i.order-1);c&&s(se(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;if(!u)return;u.coreState.nodes=u.coreState.nodes.map(m=>(m.layerId??us)===t?{...m,layerId:c.id}:m),u.coreState.layers=u.coreState.layers.filter(m=>m.id!==t),u.coreState.layers.forEach(m=>{m.order>i.order&&m.order--}),u.coreState.activeLayerId===t&&(u.coreState.activeLayerId=c.id);const f=Date.now();u.lastModified=f,p&&(p.lastModified=f),d&&(d.lastModified=f)}))},Fb=(s,e,t,n)=>{s(se(r=>{var p;if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if(!c||!((p=c.coreState.layers)==null?void 0:p.find(u=>u.id===n))&&n!==us)return;c.coreState.nodes=c.coreState.nodes.map(u=>t.includes(u.id)?{...u,layerId:n}:u);const d=Date.now();c.lastModified=d,i&&(i.lastModified=d),o&&(o.lastModified=d)}))},$b=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.coreState.layers)==null?void 0:n.find(r=>r.id===e))??null:null},Ub=s=>{const e=s().projectCanvas.getActive();return e?Nl(e.coreState.layers??[]):[]},Bb=s=>{var n;const e=s().projectCanvas.getActive();if(!e)return null;const t=e.coreState.activeLayerId;return t?((n=e.coreState.layers)==null?void 0:n.find(r=>r.id===t))??null:null},Wb=(s,e)=>({create:t=>kb(s,e,t),delete:t=>Eb(s,e,t),rename:(t,n)=>Tb(s,e,t,n),duplicate:t=>Lb(s,e,t),setVisibility:(t,n)=>Ib(s,e,t,n),setOpacity:(t,n)=>Ab(s,e,t,n),setLocked:(t,n)=>Pb(s,e,t,n),reorder:(t,n)=>Rb(s,e,t,n),moveUp:t=>Db(s,e,t),moveDown:t=>_b(s,e,t),setActive:t=>Ob(s,e,t),mergeDown:t=>Mb(s,e,t),moveNodesToLayer:(t,n)=>Fb(s,e,t,n),getById:t=>$b(e,t),getAll:()=>Ub(e),getActive:()=>Bb(e)});function zb(s,e,t){const n=new Date().toISOString();return{id:s,name:e,nodePositions:[],groupNodes:[],filterConfig:t,createdAt:n,updatedAt:n}}function Pt(s){if(!s.state)return{project:null,workspace:null,canvas:null};const e=s.state.activeProjectId?s.state.projects[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]:null,n=t&&t.activeCanvasId?t.canvases[t.activeCanvasId]:null;return{project:e,workspace:t,canvas:n}}function Rt(s,e,t){const n=Date.now();s&&(s.lastModified=n),e&&(e.lastModified=n),t&&(t.lastModified=n)}const Hb=(s,e,t,n)=>{const o=e().projectCanvas.getActive();if(!o)return null;const i=Ue(10),c=zb(i,t,n);return c.nodePositions=o.coreState.nodes.map(l=>({nodeId:l.id,x:l.x,y:l.y})),s(se(l=>{const{project:d,workspace:p,canvas:u}=Pt(l);u&&(u.viewLayers||(u.viewLayers=[]),u.viewLayers.push(c),u.activeViewLayerId=i,Rt(u,p,d))})),i},Gb=(s,e,t)=>{e().projectCanvas.getActive()&&s(se(o=>{const{project:i,workspace:c,canvas:l}=Pt(o);!l||!l.viewLayers||(l.viewLayers=l.viewLayers.filter(d=>d.id!==t),l.activeViewLayerId===t&&(l.activeViewLayerId=null),Rt(l,c,i))}))},qb=(s,e,t,n)=>{s(se(r=>{const{project:o,workspace:i,canvas:c}=Pt(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.name=n,l.updatedAt=new Date().toISOString(),Rt(c,i,o))}))},Vb=(s,e,t)=>{var d;const r=e().projectCanvas.getActive();if(!r)return null;const o=(d=r.viewLayers)==null?void 0:d.find(p=>p.id===t);if(!o)return null;const i=Ue(10),c=new Date().toISOString(),l={...o,id:i,name:`${o.name} (Copy)`,nodePositions:[...o.nodePositions],groupNodes:o.groupNodes.map(p=>({...p,id:Ue(10)})),createdAt:c,updatedAt:c};return s(se(p=>{const{project:u,workspace:f,canvas:m}=Pt(p);m&&(m.viewLayers||(m.viewLayers=[]),m.viewLayers.push(l),m.activeViewLayerId=i,Rt(m,f,u))})),i},Kb=(s,e,t)=>{s(se(n=>{const{project:r,workspace:o,canvas:i}=Pt(n);i&&(i.activeViewLayerId=t,Rt(i,o,r))}))},Jb=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(se(c=>{const{project:l,workspace:d,canvas:p}=Pt(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;const f=u.nodePositions.find(m=>m.nodeId===t);f?(f.x=n,f.y=r):u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Rt(p,d,l)}))},Yb=(s,e,t)=>{const r=e().projectCanvas.getActive();!r||!r.activeViewLayerId||s(se(o=>{const{project:i,workspace:c,canvas:l}=Pt(o);if(!l||!l.viewLayers||!l.activeViewLayerId)return;const d=l.viewLayers.find(u=>u.id===l.activeViewLayerId);if(!d)return;const p=new Map(d.nodePositions.map((u,f)=>[u.nodeId,f]));for(const u of t){const f=p.get(u.id);f!==void 0?(d.nodePositions[f].x=u.x,d.nodePositions[f].y=u.y):d.nodePositions.push({nodeId:u.id,x:u.x,y:u.y})}d.updatedAt=new Date().toISOString(),Rt(l,c,i)}))},Xb=(s,e,t,n,r)=>{const i=e().projectCanvas.getActive();!i||!i.activeViewLayerId||s(se(c=>{const{project:l,workspace:d,canvas:p}=Pt(c);if(!p||!p.viewLayers||!p.activeViewLayerId)return;const u=p.viewLayers.find(m=>m.id===p.activeViewLayerId);if(!u)return;u.nodePositions.some(m=>m.nodeId===t)||(u.nodePositions.push({nodeId:t,x:n,y:r}),u.updatedAt=new Date().toISOString(),Rt(p,d,l))}))},Qb=(s,e,t)=>{s(se(n=>{const{project:r,workspace:o,canvas:i}=Pt(n);if(!i||!i.viewLayers)return;let c=!1;for(const l of i.viewLayers){const d=l.nodePositions.length;l.nodePositions=l.nodePositions.filter(p=>p.nodeId!==t);for(const p of l.groupNodes)p.childNodeIds=p.childNodeIds.filter(u=>u!==t);l.nodePositions.length!==d&&(l.updatedAt=new Date().toISOString(),c=!0)}c&&Rt(i,o,r)}))},Zb=(s,e,t,n)=>{s(se(r=>{const{project:o,workspace:i,canvas:c}=Pt(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes.push(n),l.updatedAt=new Date().toISOString(),Rt(c,i,o))}))},ew=(s,e,t,n,r)=>{s(se(o=>{const{project:i,workspace:c,canvas:l}=Pt(o);if(!l||!l.viewLayers)return;const d=l.viewLayers.find(u=>u.id===t);if(!d)return;const p=d.groupNodes.find(u=>u.id===n);p&&(Object.assign(p,r),d.updatedAt=new Date().toISOString(),Rt(l,c,i))}))},tw=(s,e,t,n)=>{s(se(r=>{const{project:o,workspace:i,canvas:c}=Pt(r);if(!c||!c.viewLayers)return;const l=c.viewLayers.find(d=>d.id===t);l&&(l.groupNodes=l.groupNodes.filter(d=>d.id!==n),l.updatedAt=new Date().toISOString(),Rt(c,i,o))}))},sw=(s,e)=>{var n;const t=s().projectCanvas.getActive();return t?((n=t.viewLayers)==null?void 0:n.find(r=>r.id===e))??null:null},nw=s=>{const e=s().projectCanvas.getActive();return e?e.viewLayers??[]:[]},rw=s=>{var t;const e=s().projectCanvas.getActive();return!e||!e.activeViewLayerId?null:((t=e.viewLayers)==null?void 0:t.find(n=>n.id===e.activeViewLayerId))??null},aw=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.activeViewLayerId)??null},ow=(s,e)=>{const t=s().projectCanvas.getActive();return(t==null?void 0:t.activeViewLayerId)===e},iw=(s,e)=>{var o;const t=s().projectCanvas.getActive();if(!t||!t.activeViewLayerId)return null;const n=(o=t.viewLayers)==null?void 0:o.find(i=>i.id===t.activeViewLayerId);if(!n)return null;const r=n.nodePositions.find(i=>i.nodeId===e);return r?{x:r.x,y:r.y}:null},cw=s=>{var c;const e=s().projectCanvas.getActive();if(!e)return[];const t=e.coreState.nodes;if(!e.activeViewLayerId)return t;const n=(c=e.viewLayers)==null?void 0:c.find(l=>l.id===e.activeViewLayerId);if(!n)return t;const r=new Map(n.nodePositions.map(l=>[l.nodeId,l])),o=t.map(l=>{const d=r.get(l.id);return d?{...l,x:d.x,y:d.y}:l}),i=n.groupNodes.map(l=>({id:l.id,type:Ke.GROUP,x:l.x,y:l.y,width:l.width,height:l.height,content:l.name,data:{childNodeIds:l.childNodeIds}}));return[...o,...i]},lw=(s,e)=>({create:(t,n)=>Hb(s,e,t,n),delete:t=>Gb(s,e,t),rename:(t,n)=>qb(s,e,t,n),duplicate:t=>Vb(s,e,t),setActive:t=>Kb(s,e,t),updateNodePosition:(t,n,r)=>Jb(s,e,t,n,r),updateNodePositions:t=>Yb(s,e,t),addNodeToActiveView:(t,n,r)=>Xb(s,e,t,n,r),removeNodeFromAllViews:t=>Qb(s,e,t),addGroupNode:(t,n)=>Zb(s,e,t,n),updateGroupNode:(t,n,r)=>ew(s,e,t,n,r),removeGroupNode:(t,n)=>tw(s,e,t,n),getById:t=>sw(e,t),getAll:()=>nw(e),getActive:()=>rw(e),getActiveId:()=>aw(e),isActive:t=>ow(e,t),getEffectivePosition:t=>iw(e,t),getNodesWithEffectivePositions:()=>cw(e)});function Fs(s){return s.extensions||(s.extensions={registry:{},settings:{},runtime:{}}),s.extensions.registry||(s.extensions.registry={}),s.extensions.settings||(s.extensions.settings={}),s.extensions.runtime||(s.extensions.runtime={}),s.extensions}const dw=(s,e,t,n)=>{s(se(r=>{const o=Fs(r);o.registry[t]||(o.registry[t]={enabled:!0,installedAt:new Date().toISOString(),version:n})}))},uw=(s,e,t)=>{s(se(n=>{var o;const r=Fs(n);delete r.registry[t],delete r.settings[t],(o=r.runtime)==null||delete o[t]}))},pw=(s,e,t,n)=>{s(se(r=>{const o=Fs(r);o.registry[t]?o.registry[t].enabled=n:o.registry[t]={enabled:n,installedAt:new Date().toISOString()}}))},hw=(s,e)=>{var n,r,o;return((o=(r=(n=s().extensions)==null?void 0:n.registry)==null?void 0:r[e])==null?void 0:o.enabled)??!1},fw=(s,e)=>{var n,r;return!!((r=(n=s().extensions)==null?void 0:n.registry)!=null&&r[e])},mw=(s,e)=>{var r,o;return((o=(r=s().extensions)==null?void 0:r.settings)==null?void 0:o[e])??null},gw=(s,e,t,n)=>{s(se(r=>{const o=Fs(r);o.settings[t]=n}))},xw=(s,e,t,n)=>{s(se(r=>{const o=Fs(r),i=o.settings[t]??{};o.settings[t]={...i,...n}}))},vw=(s,e)=>{var r,o;return((o=(r=s().extensions)==null?void 0:r.runtime)==null?void 0:o[e])??null},bw=(s,e,t,n)=>{s(se(r=>{const o=Fs(r);o.runtime||(o.runtime={}),o.runtime[t]=n}))},ww=(s,e)=>({register:(t,n)=>dw(s,e,t,n),unregister:t=>uw(s,e,t),setEnabled:(t,n)=>pw(s,e,t,n),isEnabled:t=>hw(e,t),isRegistered:t=>fw(e,t),getSettings:t=>mw(e,t),setSettings:(t,n)=>gw(s,e,t,n),updateSettings:(t,n)=>xw(s,e,t,n),getRuntime:t=>vw(e,t),setRuntime:(t,n)=>bw(s,e,t,n)});function br(){return{nodes:{},current:null,root:null}}function yw(s){switch(s.type){case"node:move":return"Move node";case"node:resize":return"Resize node";case"node:create":return`Create ${s.node.type.toLowerCase()}`;case"node:delete":return`Delete ${s.node.type.toLowerCase()}`;case"node:update":return"Update node";case"batch":return s.label??`Batch (${s.operations.length} ops)`;case"arrow:create":return"Create arrow";case"arrow:delete":return"Delete arrow";case"arrow:update":return"Update arrow";case"tag:add":return"Add tag";case"tag:remove":return"Remove tag"}}function Sw(){return`hn_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}class no{constructor(e){ee(this,"data");this.data=e??br()}commit(e){const t=Sw(),n={id:t,operation:e,parent:this.data.current,children:[],timestamp:Date.now(),label:yw(e)};if(this.data.nodes[t]=n,this.data.current!==null){const r=this.data.nodes[this.data.current];r&&r.children.push(t)}return this.data.root===null&&(this.data.root=t),this.data.current=t,t}undo(){if(this.data.current===null)return null;const e=this.data.nodes[this.data.current];return e?(this.data.current=e.parent,e.operation):null}redo(e){const t=this.getBranches();if(t.length===0)return null;const n=e??t.length-1,r=t[n];return r?(this.data.current=r.id,r.operation):null}getBranches(){if(this.data.current===null){if(this.data.root!==null){const t=this.data.nodes[this.data.root];return t?[t]:[]}return[]}const e=this.data.nodes[this.data.current];return e?e.children.map(t=>this.data.nodes[t]).filter(t=>t!==void 0):[]}getPath(){const e=[];let t=this.data.current;for(;t!==null;){const n=this.data.nodes[t];if(!n)break;e.unshift(n),t=n.parent}return e}getRedoPath(){const e=[];let t=this.getBranches();for(;t.length>0;){const n=t[t.length-1];e.push(n),t=n.children.map(r=>this.data.nodes[r]).filter(r=>r!==void 0)}return e}jumpTo(e){var u;if(!this.data.nodes[e])return{undo:[],redo:[]};const n=new Set(this.getPath().map(f=>f.id)),r=[];let o=e;for(;o!==null;){const f=this.data.nodes[o];if(!f||(r.unshift(f),n.has(o)))break;o=f.parent}const i=[];let c=this.data.current;const l=((u=r[0])==null?void 0:u.id)??null;for(;c!==null&&c!==l;){const f=this.data.nodes[c];if(!f)break;i.push(f.operation),c=f.parent}const d=[];let p=0;l!==null&&(p=r.findIndex(f=>f.id===l)+1);for(let f=p;f<r.length;f++)d.push(r[f].operation);return this.data.current=e,{undo:i,redo:d}}getCurrent(){return this.data.current===null?null:this.data.nodes[this.data.current]??null}getRoot(){return this.data.root===null?null:this.data.nodes[this.data.root]??null}getSize(){return Object.keys(this.data.nodes).length}canUndo(){return this.data.current!==null}canRedo(){return this.getBranches().length>0}getAllNodes(){return Object.values(this.data.nodes)}serialize(){return structuredClone(this.data)}static deserialize(e){return new no(structuredClone(e))}prune(e){if(this.getSize()<=e)return;const n=new Set;this.getPath().forEach(i=>n.add(i.id));const o=this.getAllNodes();o.sort((i,c)=>c.timestamp-i.timestamp);for(const i of o){if(n.size>=e)break;n.add(i.id)}for(const i of Object.keys(this.data.nodes))if(!n.has(i)){const c=this.data.nodes[i];if(c!=null&&c.parent){const l=this.data.nodes[c.parent];l&&(l.children=l.children.filter(d=>d!==i))}if(this.data.root===i){const d=Object.values(this.data.nodes).filter(p=>p.id!==i&&n.has(p.id)).find(p=>p.parent===null||!n.has(p.parent));this.data.root=(d==null?void 0:d.id)??null}delete this.data.nodes[i]}for(const i of Object.values(this.data.nodes))i.children=i.children.filter(c=>this.data.nodes[c]!==void 0)}}function ro(s,e){switch(e.type){case"node:move":return kl(s,e.nodeId,e.to);case"node:resize":return El(s,e.nodeId,e.to);case"node:create":return Tl(s,e.node);case"node:delete":return Il(s,e.node.id,e.connectedArrows);case"node:update":return Al(s,e.nodeId,e.to);case"arrow:create":return wa(s,e.arrow);case"arrow:delete":return Pl(s,e.arrow.id);case"arrow:update":return Rl(s,e.arrowId,e.to);case"batch":return e.operations.reduce((t,n)=>ro(t,n),s);case"tag:add":return Dl(s,e.nodeId,e.tag,e.autoGroup);case"tag:remove":return jw(s,e.nodeId,e.tag.id)}}function ao(s,e){switch(e.type){case"node:move":return kl(s,e.nodeId,e.from);case"node:resize":return El(s,e.nodeId,e.from);case"node:create":return Il(s,e.node.id);case"node:delete":let t=Tl(s,e.node);if(e.connectedArrows)for(const n of e.connectedArrows)t=wa(t,n);return t;case"node:update":return Al(s,e.nodeId,e.from);case"arrow:create":return Pl(s,e.arrow.id);case"arrow:delete":return wa(s,e.arrow);case"arrow:update":return Rl(s,e.arrowId,e.from);case"batch":return[...e.operations].reverse().reduce((n,r)=>ao(n,r),s);case"tag:add":return Cw(s,e.nodeId,e.tag.id,e.autoGroup);case"tag:remove":return Dl(s,e.nodeId,e.tag)}}function kl(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,x:t.x,y:t.y}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,x:t.x,y:t.y}:o);return{...s,nodes:n,selectedNodes:r}}function El(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,x:t.x,y:t.y,width:t.width,height:t.height}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,x:t.x,y:t.y,width:t.width,height:t.height}:o);return{...s,nodes:n,selectedNodes:r}}function Tl(s,e){return s.nodes.some(t=>t.id===e.id)?s:{...s,nodes:[...s.nodes,e]}}function Il(s,e,t){const n=s.nodes.filter(c=>c.id!==e),r=s.selectedNodes.filter(c=>c.id!==e),o=s.arrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e),i=s.selectedArrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e);return{...s,nodes:n,arrows:o,selectedNodes:r,selectedArrows:i}}function Al(s,e,t){const n=s.nodes.map(o=>o.id===e?{...o,...t}:o),r=s.selectedNodes.map(o=>o.id===e?{...o,...t}:o);return{...s,nodes:n,selectedNodes:r}}function wa(s,e){return s.arrows.some(t=>t.id===e.id)?s:{...s,arrows:[...s.arrows,e]}}function Pl(s,e){const t=s.arrows.filter(r=>r.id!==e),n=s.selectedArrows.filter(r=>r.id!==e);return{...s,arrows:t,selectedArrows:n}}function Rl(s,e,t){const n=s.arrows.map(o=>o.id===e?{...o,...t}:o),r=s.selectedArrows.map(o=>o.id===e?{...o,...t}:o);return{...s,arrows:n,selectedArrows:r}}function Dl(s,e,t,n){const r=i=>{if(i.id!==e)return i;const c=Array.isArray(i.tags)?i.tags:[];if(c.some(d=>d.id===t.id))return i;let l={...i,tags:[...c,t]};return n&&(l={...l,groupId:n.groupId}),l};let o={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(o=Nw(o,n.groupId,e)),o}function jw(s,e,t){const n=r=>r.id!==e||!Array.isArray(r.tags)?r:{...r,tags:r.tags.filter(o=>o.id!==t)};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function Cw(s,e,t,n){const r=i=>{if(i.id!==e)return i;let c={...i,tags:Array.isArray(i.tags)?i.tags.filter(l=>l.id!==t):[]};return n&&(c={...c,x:n.previousPosition.x,y:n.previousPosition.y,groupId:n.previousGroupId}),c};let o={...s,nodes:s.nodes.map(r),selectedNodes:s.selectedNodes.map(r)};return n&&(o=kw(o,n.groupId,e)),o}function Nw(s,e,t){const n=r=>{if(r.id!==e)return r;const o=r.data??{childNodeIds:[]},i=o.childNodeIds??[];return i.includes(t)?r:{...r,data:{...o,childNodeIds:[...i,t]}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function kw(s,e,t){const n=r=>{if(r.id!==e)return r;const o=r.data??{childNodeIds:[]},i=o.childNodeIds??[];return{...r,data:{...o,childNodeIds:i.filter(c=>c!==t)}}};return{...s,nodes:s.nodes.map(n),selectedNodes:s.selectedNodes.map(n)}}function ii(s,e,t){return{type:"node:move",nodeId:s,from:e,to:t}}function KC(s){return s.length===1?ii(s[0].nodeId,s[0].from,s[0].to):{type:"batch",operations:s.map(e=>ii(e.nodeId,e.from,e.to)),label:`Move ${s.length} nodes`}}const Ew="UndoArchiveDB",Tw=2,qe="archived_nodes",zt="tree_data";class Iw{constructor(){ee(this,"db",null);ee(this,"initPromise",null)}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,t)=>{const n=indexedDB.open(Ew,Tw);n.onerror=()=>{this.initPromise=null,t(new Error("Failed to open UndoArchiveDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const o=r.target.result;if(!o.objectStoreNames.contains(qe)){const i=o.createObjectStore(qe,{keyPath:"id"});i.createIndex("canvasId","canvasId",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("canvasId_timestamp",["canvasId","timestamp"],{unique:!1})}o.objectStoreNames.contains(zt)||o.createObjectStore(zt,{keyPath:"canvasId"})}}),this.initPromise)}async ensureInit(){if(this.db||await this.init(),!this.db)throw new Error("Database not initialized")}async archiveNode(e,t){await this.ensureInit();const n={...t,canvasId:e};return new Promise((r,o)=>{const l=this.db.transaction([qe],"readwrite").objectStore(qe).put(n);l.onsuccess=()=>r(),l.onerror=()=>o(new Error("Failed to archive node"))})}async archiveNodes(e,t){if(t.length!==0)return await this.ensureInit(),new Promise((n,r)=>{const i=this.db.transaction([qe],"readwrite").objectStore(qe);let c=0,l=!1;for(const d of t){const p={...d,canvasId:e},u=i.put(p);u.onsuccess=()=>{c++,c===t.length&&!l&&n()},u.onerror=()=>{l||(l=!0,r(new Error("Failed to archive nodes")))}}})}async getNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([qe],"readonly").objectStore(qe).get(e);i.onsuccess=()=>t(i.result??null),i.onerror=()=>n(new Error("Failed to get archived node"))})}async getNodes(e){return e.length===0?[]:(await this.ensureInit(),new Promise((t,n)=>{const o=this.db.transaction([qe],"readonly").objectStore(qe),i=[];let c=0;for(const l of e){const d=o.get(l);d.onsuccess=()=>{d.result&&i.push(d.result),c++,c===e.length&&t(i)},d.onerror=()=>{c++,c===e.length&&t(i)}}}))}async getAllForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([qe],"readonly").objectStore(qe).index("canvasId").getAll(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to get archived nodes for canvas"))})}async countForCanvas(e){return await this.ensureInit(),new Promise((t,n)=>{const c=this.db.transaction([qe],"readonly").objectStore(qe).index("canvasId").count(e);c.onsuccess=()=>t(c.result),c.onerror=()=>n(new Error("Failed to count archived nodes"))})}async deleteNode(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([qe],"readwrite").objectStore(qe).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete archived node"))})}async deleteNodes(e){if(e.length!==0)return await this.ensureInit(),new Promise((t,n)=>{const o=this.db.transaction([qe],"readwrite").objectStore(qe);let i=0;for(const c of e){const l=o.delete(c);l.onsuccess=()=>{i++,i===e.length&&t()},l.onerror=()=>{i++,i===e.length&&t()}}})}async clearForCanvas(e){await this.ensureInit();const n=(await this.getAllForCanvas(e)).map(r=>r.id);await this.deleteNodes(n)}async getOldestForCanvas(e,t){return await this.ensureInit(),new Promise((n,r)=>{const c=this.db.transaction([qe],"readonly").objectStore(qe).index("canvasId_timestamp"),l=IDBKeyRange.bound([e,0],[e,1/0]),d=[],p=c.openCursor(l);p.onsuccess=u=>{const f=u.target.result;f&&d.length<t?(d.push(f.value),f.continue()):n(d)},p.onerror=()=>r(new Error("Failed to get oldest archived nodes"))})}async pruneForCanvas(e,t){const n=await this.countForCanvas(e);if(n<=t)return 0;const r=n-t,i=(await this.getOldestForCanvas(e,r)).map(c=>c.id);return await this.deleteNodes(i),i.length}async countAll(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([qe],"readonly").objectStore(qe).count();o.onsuccess=()=>e(o.result),o.onerror=()=>t(new Error("Failed to count all archived nodes"))})}async clearAll(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([qe],"readwrite").objectStore(qe).clear();o.onsuccess=()=>e(),o.onerror=()=>t(new Error("Failed to clear all archived nodes"))})}async saveTreeData(e,t){await this.ensureInit();const n={canvasId:e,treeData:t,lastModified:Date.now()};return new Promise((r,o)=>{const l=this.db.transaction([zt],"readwrite").objectStore(zt).put(n);l.onsuccess=()=>r(),l.onerror=()=>o(new Error("Failed to save tree data"))})}async loadTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([zt],"readonly").objectStore(zt).get(e);i.onsuccess=()=>{const c=i.result;t((c==null?void 0:c.treeData)??null)},i.onerror=()=>n(new Error("Failed to load tree data"))})}async deleteTreeData(e){return await this.ensureInit(),new Promise((t,n)=>{const i=this.db.transaction([zt],"readwrite").objectStore(zt).delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(new Error("Failed to delete tree data"))})}async clearAllTreeData(){return await this.ensureInit(),new Promise((e,t)=>{const o=this.db.transaction([zt],"readwrite").objectStore(zt).clear();o.onsuccess=()=>e(),o.onerror=()=>t(new Error("Failed to clear all tree data"))})}}const $t=new Iw;function _l(){return typeof window>"u"?!1:window.innerWidth<$e.history.tabletBreakpoint}function Ol(){const{archiveLimit:s,tabletArchiveLimit:e}=$e.history;return _l()?e:s}function Ll(){const{historyLimit:s,tabletHistoryLimit:e}=$e.history;return _l()?e:s}function Aw(s){const e=new Set;let t=s.current;for(;t!==null;){e.add(t);const n=s.nodes[t];if(!n)break;t=n.parent}return e}async function Pw(s,e){const t=Ll(),n=Object.keys(e.nodes).length;if(n<=t)return e;const r=Aw(e),o=Object.values(e.nodes);o.sort((f,m)=>f.timestamp-m.timestamp);const i=[],c=n-t;for(const f of o){if(i.length>=c)break;r.has(f.id)||i.push(f)}if(i.length===0)return e;await $t.archiveNodes(s,i);const l=Ol();await $t.pruneForCanvas(s,l);const d=new Set(i.map(f=>f.id)),p={};for(const[f,m]of Object.entries(e.nodes))d.has(f)||(p[f]={...m,children:m.children.filter(g=>!d.has(g))});let u=e.root;if(u&&d.has(u)){const m=Object.values(p).find(g=>g.parent===null||!p[g.parent]);u=(m==null?void 0:m.id)??null}return{nodes:p,current:e.current,root:u}}function Rw(s,e){return!s.nodes[e]}async function Dw(s,e,t){const n=await $t.getNode(t);if(!n)return null;const r=new Set;r.add(t);let o=n;for(;o;){r.add(o.id);for(const d of o.children)r.add(d);if(o.parent){if(e.nodes[o.parent])break;o=await $t.getNode(o.parent)}else o=null}const i=await $t.getNodes(Array.from(r)),c={...e.nodes};for(const d of i)if(!c[d.id]){const{canvasId:p,...u}=d;c[d.id]=u}for(const d of i)if(d.parent&&c[d.parent]){const p=c[d.parent];p.children.includes(d.id)||(p.children=[...p.children,d.id])}let l=e.root;if(!l){const d=Object.values(c).find(p=>p.parent===null||!c[p.parent]);l=(d==null?void 0:d.id)??null}return{nodes:c,current:e.current,root:l}}async function _w(s){return{archivedCount:await $t.countForCanvas(s),archiveLimit:Ol(),historyLimit:Ll()}}async function Ow(s){await $t.clearForCanvas(s),await $t.deleteTreeData(s)}async function Lw(){await $t.init()}async function Xn(s,e){await $t.saveTreeData(s,e)}async function Mw(s){return $t.loadTreeData(s)}function Fw(){return window.innerWidth<$e.history.tabletBreakpoint}function $w(){const{historyLimit:s,tabletHistoryLimit:e}=$e.history;return Fw()?e:s}function Dt(s){const e=s().projectCanvas.getActive();if(!e)return null;const t=e.undoTree??br();return no.deserialize(t)}function vs(s){const e=s().state;if(!e)return null;const t=e.activeProjectId?e.projects[e.activeProjectId]:null,n=t&&t.activeWorkspaceId?t.workspaces[t.activeWorkspaceId]:null;return(n==null?void 0:n.activeCanvasId)??null}function oo(s,e){s(se(t=>{if(!t.state)return;const n=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,r=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,o=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;o&&(o.undoTree=e.serialize())}))}const Uw=(s,e,t)=>{const n=Dt(e);if(!n)return;n.commit(t),oo(s,n);const r=vs(e),o=$w();r&&(async()=>{try{const i=n.serialize();if(await Xn(r,i),n.getSize()>o){const c=await Pw(r,i);s(se(l=>{if(!l.state)return;const d=l.state.activeProjectId?l.state.projects[l.state.activeProjectId]:null,p=d&&d.activeWorkspaceId?d.workspaces[d.activeWorkspaceId]:null,u=p&&p.activeCanvasId?p.canvases[p.activeCanvasId]:null;u&&u.id===r&&(u.undoTree=c)})),await Xn(r,c)}}catch(i){console.warn("Failed to persist undo history:",i)}})()},Bw=(s,e)=>{const t=Dt(e);if(!t||!t.canUndo())return!1;const n=t.undo();if(!n)return!1;const r=vs(e);return s(se(o=>{if(!o.state)return;const i=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,c=i&&i.activeWorkspaceId?i.workspaces[i.activeWorkspaceId]:null,l=c&&c.activeCanvasId?c.canvases[c.activeCanvasId]:null;if(!l)return;l.coreState=ao(l.coreState,n),l.undoTree=t.serialize();const d=Date.now();l.lastModified=d,c&&(c.lastModified=d),i&&(i.lastModified=d)})),r&&Xn(r,t.serialize()).catch(o=>{console.warn("Failed to persist undo position:",o)}),!0},Ww=(s,e,t)=>{const n=Dt(e);if(!n||!n.canRedo())return!1;const r=n.redo(t);if(!r)return!1;const o=vs(e);return s(se(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;d.coreState=ro(d.coreState,r),d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),o&&Xn(o,n.serialize()).catch(i=>{console.warn("Failed to persist redo position:",i)}),!0},Ml=(s,e,t)=>{const n=Dt(e);if(!n)return!1;const{undo:r,redo:o}=n.jumpTo(t);return r.length===0&&o.length===0?(oo(s,n),!0):(s(se(i=>{if(!i.state)return;const c=i.state.activeProjectId?i.state.projects[i.state.activeProjectId]:null,l=c&&c.activeWorkspaceId?c.workspaces[c.activeWorkspaceId]:null,d=l&&l.activeCanvasId?l.canvases[l.activeCanvasId]:null;if(!d)return;for(const u of r)d.coreState=ao(d.coreState,u);for(const u of o)d.coreState=ro(d.coreState,u);d.undoTree=n.serialize();const p=Date.now();d.lastModified=p,l&&(l.lastModified=p),c&&(c.lastModified=p)})),!0)},zw=async(s,e,t)=>{var o;const n=vs(e);if(!n)return!1;let r=(o=e().projectCanvas.getActive())==null?void 0:o.undoTree;if(r||(r=br()),Rw(r,t)){const i=await Dw(n,r,t);if(!i)return!1;s(se(c=>{if(!c.state)return;const l=c.state.activeProjectId?c.state.projects[c.state.activeProjectId]:null,d=l&&l.activeWorkspaceId?l.workspaces[l.activeWorkspaceId]:null,p=d&&d.activeCanvasId?d.canvases[d.activeCanvasId]:null;p&&(p.undoTree=i)})),r=i}return Ml(s,e,t)},Hw=s=>{const e=Dt(s);return(e==null?void 0:e.canUndo())??!1},Gw=s=>{const e=Dt(s);return(e==null?void 0:e.canRedo())??!1},qw=s=>{const e=Dt(s);return(e==null?void 0:e.getBranches())??[]},Vw=s=>{const e=Dt(s);return(e==null?void 0:e.getCurrent())??null},Kw=s=>{const e=Dt(s);return(e==null?void 0:e.getPath())??[]},Jw=s=>{const e=Dt(s);return(e==null?void 0:e.getRedoPath())??[]},Yw=s=>{const e=Dt(s);return(e==null?void 0:e.getAllNodes())??[]},Xw=s=>{const e=s().projectCanvas.getActive();return(e==null?void 0:e.undoTree)??null},Qw=(s,e)=>{const t=vs(e);s(se(n=>{if(!n.state)return;const r=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,o=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;i&&(i.undoTree=br())})),t&&Ow(t).catch(n=>{console.warn("Failed to clear undo archive:",n)})},Zw=(s,e,t)=>{const n=Dt(e);n&&(n.prune(t),oo(s,n))},ey=async s=>{const e=vs(s);return e?_w(e):null},ty=async()=>{await Lw()},sy=async(s,e)=>{const t=vs(e);if(!t)return!1;try{const n=await Mw(t);return n?(s(se(r=>{if(!r.state)return;const o=r.state.activeProjectId?r.state.projects[r.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;c&&c.id===t&&(c.undoTree=n)})),!0):!1}catch(n){return console.warn("Failed to load undo history from archive:",n),!1}},ny=(s,e)=>({commit:t=>Uw(s,e,t),undo:()=>Bw(s,e),redo:t=>Ww(s,e,t),jumpTo:t=>Ml(s,e,t),jumpToAsync:t=>zw(s,e,t),canUndo:()=>Hw(e),canRedo:()=>Gw(e),getBranches:()=>qw(e),getCurrent:()=>Vw(e),getPath:()=>Kw(e),getRedoPath:()=>Jw(e),getAllNodes:()=>Yw(e),getTreeData:()=>Xw(e),clear:()=>Qw(s,e),prune:t=>Zw(s,e,t),getArchiveStats:()=>ey(e),initArchive:()=>ty(),loadFromArchive:()=>sy(s,e)}),ry=s=>{const e={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse","canvas-tag":"tag"};if(e[s])return e[s];const t=s.split("-");return t.length>=2?t[1]:null},ay=(s,e,t,n)=>({getSegmentedButtonAction:r=>{var i,c;return((c=(i=s().preferences)==null?void 0:i.segmentedButtons)==null?void 0:c[r])??null},setSegmentedButtonAction:(r,o,i,c)=>{var m,g,x;const l=n(),d=(c==null?void 0:c.skipHistoryUpdate)??!1,p=(c==null?void 0:c.skipLabelUpdate)??!1,u=c==null?void 0:c.actionId,f=c==null?void 0:c.params;if(i){const w=i();w&&t.set(l,w)}if(p){const v=(x=(g=(m=s().actions)==null?void 0:m.history)==null?void 0:g.entries)==null?void 0:x.find(b=>b.source===r&&b.label===o);if(v!=null&&v.executorId&&t.has(v.executorId)){t.delete(l);return}return}e(se(w=>{var C,S,j;if(w.preferences||(w.preferences={segmentedButtons:{}}),w.preferences.segmentedButtons||(w.preferences.segmentedButtons={}),w.preferences.segmentedButtons[r]=o,d){if((S=(C=w.actions)==null?void 0:C.history)!=null&&S.entries){const N=w.actions.history.entries.find(E=>E.source===r&&E.label===o);N&&(N.executorId&&t.delete(N.executorId),N.executorId=l,u&&!N.actionId&&(N.actionId=u),f&&!N.params&&(N.params=f))}return}w.actions||(w.actions={}),w.actions.history||(w.actions.history={entries:[],lastAction:void 0,maxSize:50});const v=w.actions.history.entries,b=v[0];if(b&&b.source===r&&b.label===o)b.executorId&&t.delete(b.executorId),b.executorId=l,b.timestamp=Date.now(),b.actionId=u,b.params=f,w.actions.history.lastAction=b;else{const N={executorId:l,source:r,label:o,timestamp:Date.now(),actionId:u,params:f};for(v.unshift(N);v.length>w.actions.history.maxSize;){const E=v.pop();E!=null&&E.executorId&&t.delete(E.executorId)}w.actions.history.lastAction=N}if((j=w.actions.recording)!=null&&j.isRecording){const N=ry(r);if(N&&u){const E={id:Ue(8),action:{facadeKey:N,actionId:u,params:f,label:o},delayMs:0};w.actions.recording.capturedSteps.push(E)}}}))},getKeepArrowsOnSplit:()=>{var o;return((o=s().preferences)==null?void 0:o.keepArrowsOnSplit)??!1},setKeepArrowsOnSplit:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.keepArrowsOnSplit=r}))},getKeepSplitMatch:()=>{var o;return((o=s().preferences)==null?void 0:o.keepSplitMatch)??!1},setKeepSplitMatch:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.keepSplitMatch=r}))},getSplitHorizontally:()=>{var o;return((o=s().preferences)==null?void 0:o.splitHorizontally)??!1},setSplitHorizontally:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.splitHorizontally=r}))},getSplitNodeGap:()=>{var o;return((o=s().preferences)==null?void 0:o.splitNodeGap)??ot.NEW_NODE_SEGMENT_SPACING},setSplitNodeGap:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.splitNodeGap=r}))},getLastUsedBorder:()=>{var r,o,i,c,l,d;return{lastUsedColor:((o=(r=s().preferences)==null?void 0:r.borderButton)==null?void 0:o.lastUsedColor)??"hsl(var(--primary))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.borderButton)==null?void 0:c.lastUsedWidth)??"1px",lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.borderButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedBorder:(r,o,i)=>{e(se(c=>{c.preferences||(c.preferences={}),c.preferences.borderButton||(c.preferences.borderButton={}),c.preferences.borderButton.lastUsedColor=r,c.preferences.borderButton.lastUsedWidth=o,c.preferences.borderButton.lastUsedStyle=i}))},getLastUsedArrowStyle:()=>{var r,o,i,c,l,d;return{lastUsedColor:((o=(r=s().preferences)==null?void 0:r.arrowStyleButton)==null?void 0:o.lastUsedColor)??"hsl(var(--muted-light))",lastUsedWidth:((c=(i=s().preferences)==null?void 0:i.arrowStyleButton)==null?void 0:c.lastUsedWidth)??1,lastUsedStyle:((d=(l=s().preferences)==null?void 0:l.arrowStyleButton)==null?void 0:d.lastUsedStyle)??"solid"}},setLastUsedArrowStyle:(r,o,i)=>{e(se(c=>{c.preferences||(c.preferences={}),c.preferences.arrowStyleButton||(c.preferences.arrowStyleButton={}),c.preferences.arrowStyleButton.lastUsedColor=r,c.preferences.arrowStyleButton.lastUsedWidth=o,c.preferences.arrowStyleButton.lastUsedStyle=i}))},getLastArrangeOption:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.lastArrangeOption)??null},setLastArrangeOption:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.lastArrangeOption=r}))},getSortByLastArrange:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.sortByLastArrange)??!1},setSortByLastArrange:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.sortByLastArrange=r}))},getArrangeNodeGap:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.nodeGap)??$e.arrange.gap},setArrangeNodeGap:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.nodeGap=r}))},getArrangeGridColumns:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.gridColumns)??$e.arrange.gridColumns},setArrangeGridColumns:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.gridColumns=r}))},getArrangeGridRows:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.gridRows)??$e.arrange.gridRows},setArrangeGridRows:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.gridRows=r}))},getCycleRowBuffer:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.arrangeButton)==null?void 0:o.cycleRowBuffer)??20},setCycleRowBuffer:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeButton||(o.preferences.arrangeButton={}),o.preferences.arrangeButton.cycleRowBuffer=r}))},getLastTagTitle:()=>{var r,o;return((o=(r=s().preferences)==null?void 0:r.tagButton)==null?void 0:o.lastTagTitle)??null},setLastTagTitle:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.tagButton||(o.preferences.tagButton={}),o.preferences.tagButton.lastTagTitle=r}))},getGoToSymbolSearch:()=>{var r;return((r=s().preferences)==null?void 0:r.goToSymbolSearch)??null},setGoToSymbolSearchOptions:r=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.goToSymbolSearch?o.preferences.goToSymbolSearch.options=r:o.preferences.goToSymbolSearch={options:r,searchHistory:[]}}))},addGoToSymbolSearchHistory:r=>{r.trim()&&e(se(o=>{o.preferences||(o.preferences={}),o.preferences.goToSymbolSearch||(o.preferences.goToSymbolSearch={options:{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"},searchHistory:[]});const i=o.preferences.goToSymbolSearch.searchHistory.filter(c=>c!==r);i.unshift(r),o.preferences.goToSymbolSearch.searchHistory=i.slice(0,20)}))}}),oy=(s,e)=>({getSplitPresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.presets)??[]},getSplitPresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.splitPresets)==null?void 0:r.presets.find(o=>o.id===t)},getSplitPresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.favoriteIds)??[]},getActiveSplitPresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.splitPresets)==null?void 0:n.activePresetId)??null},createSplitPreset:(t,n)=>{const r=Ue(10);return e(se(o=>{o.preferences||(o.preferences={}),o.preferences.splitPresets||(o.preferences.splitPresets={presets:[],favoriteIds:[]}),o.preferences.splitPresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateSplitPreset:(t,n)=>{e(se(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n)}))},duplicateSplitPreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.splitPresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const o=`split-preset-${Date.now()}`,i={id:o,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(se(d=>{d.preferences||(d.preferences={}),d.preferences.splitPresets||(d.preferences.splitPresets={presets:[],favoriteIds:[]}),d.preferences.splitPresets.presets.push(i)})),o},deleteSplitPreset:t=>{e(se(n=>{var r;(r=n.preferences)!=null&&r.splitPresets&&(n.preferences.splitPresets.presets=n.preferences.splitPresets.presets.filter(o=>o.id!==t),n.preferences.splitPresets.favoriteIds=n.preferences.splitPresets.favoriteIds.filter(o=>o!==t),n.preferences.splitPresets.activePresetId===t&&(n.preferences.splitPresets.activePresetId=void 0))}))},renameSplitPreset:(t,n)=>{e(se(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.splitPresets)==null?void 0:c.presets.find(l=>l.id===t);o&&(o.name=n)}))},applySplitPreset:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.splitPresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(se(c=>{c.preferences||(c.preferences={}),c.preferences.keepArrowsOnSplit=r.config.keepArrowsOnSplit,c.preferences.keepSplitMatch=r.config.keepSplitMatch,c.preferences.splitHorizontally=r.config.splitHorizontally,c.preferences.splitNodeGap=r.config.splitNodeGap,c.preferences.splitPresets||(c.preferences.splitPresets={presets:[],favoriteIds:[]}),c.preferences.splitPresets.activePresetId=t}))},toggleSplitPresetFavorite:t=>{e(se(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]});const r=n.preferences.splitPresets.favoriteIds.indexOf(t);r===-1?n.preferences.splitPresets.favoriteIds.push(t):n.preferences.splitPresets.favoriteIds.splice(r,1)}))},setActiveSplitPresetId:t=>{e(se(n=>{n.preferences||(n.preferences={}),n.preferences.splitPresets||(n.preferences.splitPresets={presets:[],favoriteIds:[]}),n.preferences.splitPresets.activePresetId=t??void 0}))}}),iy=(s,e)=>({getArrangePresets:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.presets)??[]},getArrangePresetById:t=>{var n,r;return(r=(n=s().preferences)==null?void 0:n.arrangePresets)==null?void 0:r.presets.find(o=>o.id===t)},getArrangePresetFavorites:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.favoriteIds)??[]},getActiveArrangePresetId:()=>{var t,n;return((n=(t=s().preferences)==null?void 0:t.arrangePresets)==null?void 0:n.activePresetId)??null},createArrangePreset:(t,n)=>{const r=Ue(10);return e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangePresets||(o.preferences.arrangePresets={presets:[],favoriteIds:[]}),o.preferences.arrangePresets.presets.push({id:r,name:t,config:n,createdAt:Date.now()})})),r},updateArrangePreset:(t,n)=>{e(se(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n)}))},duplicateArrangePreset:t=>{var c,l;const r=(l=(c=s().preferences)==null?void 0:c.arrangePresets)==null?void 0:l.presets.find(d=>d.id===t);if(!r)return null;const o=`arrange-preset-${Date.now()}`,i={id:o,name:`${r.name} (copy)`,config:{...r.config},createdAt:Date.now()};return e(se(d=>{d.preferences||(d.preferences={}),d.preferences.arrangePresets||(d.preferences.arrangePresets={presets:[],favoriteIds:[]}),d.preferences.arrangePresets.presets.push(i)})),o},deleteArrangePreset:t=>{e(se(n=>{var r;(r=n.preferences)!=null&&r.arrangePresets&&(n.preferences.arrangePresets.presets=n.preferences.arrangePresets.presets.filter(o=>o.id!==t),n.preferences.arrangePresets.favoriteIds=n.preferences.arrangePresets.favoriteIds.filter(o=>o!==t),n.preferences.arrangePresets.activePresetId===t&&(n.preferences.arrangePresets.activePresetId=void 0))}))},renameArrangePreset:(t,n)=>{e(se(r=>{var i,c;const o=(c=(i=r.preferences)==null?void 0:i.arrangePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&(o.name=n)}))},applyArrangePreset:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.arrangePresets)==null?void 0:i.presets.find(c=>c.id===t);r&&e(se(c=>{c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),c.preferences.arrangeButton.nodeGap=r.config.nodeGap,c.preferences.arrangeButton.gridColumns=r.config.gridColumns,c.preferences.arrangeButton.sortByLastArrange=r.config.sortByLastArrange,c.preferences.arrangePresets||(c.preferences.arrangePresets={presets:[],favoriteIds:[]}),c.preferences.arrangePresets.activePresetId=t}))},toggleArrangePresetFavorite:t=>{e(se(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]});const r=n.preferences.arrangePresets.favoriteIds.indexOf(t);r===-1?n.preferences.arrangePresets.favoriteIds.push(t):n.preferences.arrangePresets.favoriteIds.splice(r,1)}))},setActiveArrangePresetId:t=>{e(se(n=>{n.preferences||(n.preferences={}),n.preferences.arrangePresets||(n.preferences.arrangePresets={presets:[],favoriteIds:[]}),n.preferences.arrangePresets.activePresetId=t??void 0}))}}),cy=(s,e)=>({getArrangeConfigFavorites:()=>{var t;return((t=s().preferences)==null?void 0:t.arrangeConfigFavorites)??[]},getArrangeConfigFavoritesByType:t=>{var n;return(((n=s().preferences)==null?void 0:n.arrangeConfigFavorites)??[]).filter(r=>r.type===t)},addArrangeConfigFavorite:(t,n)=>{const r=Ue(10);return e(se(o=>{o.preferences||(o.preferences={}),o.preferences.arrangeConfigFavorites||(o.preferences.arrangeConfigFavorites=[]),o.preferences.arrangeConfigFavorites.some(c=>c.type===t&&c.value===n)||o.preferences.arrangeConfigFavorites.push({id:r,type:t,value:n})})),r},removeArrangeConfigFavorite:t=>{e(se(n=>{var r;(r=n.preferences)!=null&&r.arrangeConfigFavorites&&(n.preferences.arrangeConfigFavorites=n.preferences.arrangeConfigFavorites.filter(o=>o.id!==t))}))},applyArrangeConfigFavorite:t=>{var o,i;const r=(i=(o=s().preferences)==null?void 0:o.arrangeConfigFavorites)==null?void 0:i.find(c=>c.id===t);r&&e(se(c=>{switch(c.preferences||(c.preferences={}),c.preferences.arrangeButton||(c.preferences.arrangeButton={}),r.type){case"gap":c.preferences.arrangeButton.nodeGap=r.value;break;case"columns":c.preferences.arrangeButton.gridColumns=r.value;break;case"rows":c.preferences.arrangeButton.gridRows=r.value;break}}))},isArrangeConfigFavorite:(t,n)=>{var r;return(((r=s().preferences)==null?void 0:r.arrangeConfigFavorites)??[]).some(o=>o.type===t&&o.value===n)},toggleArrangeConfigFavorite:(t,n)=>{var c;const r=s(),i=(((c=r.preferences)==null?void 0:c.arrangeConfigFavorites)??[]).find(l=>l.type===t&&l.value===n);i?r.removeArrangeConfigFavorite(i.id):r.addArrangeConfigFavorite(t,n)}}),ly=(s,e)=>({getPinnedPaletteItems:t=>{var n,r;return((r=(n=s().preferences)==null?void 0:n.pinnedPaletteItems)==null?void 0:r[t])??[]},pinPaletteItem:(t,n)=>{e(se(r=>{r.preferences||(r.preferences={}),r.preferences.pinnedPaletteItems||(r.preferences.pinnedPaletteItems={}),r.preferences.pinnedPaletteItems[t]||(r.preferences.pinnedPaletteItems[t]=[]),r.preferences.pinnedPaletteItems[t].includes(n)||r.preferences.pinnedPaletteItems[t].push(n)}))},unpinPaletteItem:(t,n)=>{e(se(r=>{var o,i;(i=(o=r.preferences)==null?void 0:o.pinnedPaletteItems)!=null&&i[t]&&(r.preferences.pinnedPaletteItems[t]=r.preferences.pinnedPaletteItems[t].filter(c=>c!==n))}))},togglePinPaletteItem:(t,n)=>{s().isPaletteItemPinned(t,n)?s().unpinPaletteItem(t,n):s().pinPaletteItem(t,n)},isPaletteItemPinned:(t,n)=>{var r,o,i;return((i=(o=(r=s().preferences)==null?void 0:r.pinnedPaletteItems)==null?void 0:o[t])==null?void 0:i.includes(n))??!1}}),dy=(s,e)=>({getOpenTabs:()=>{var t;return((t=s().preferences)==null?void 0:t.openTabs)??[]},openTab:(t,n,r)=>{e(se(o=>{o.preferences||(o.preferences={}),o.preferences.openTabs||(o.preferences.openTabs=[]),o.preferences.openTabs.some(c=>c.canvasId===t)||o.preferences.openTabs.push({canvasId:t,projectId:n,workspaceId:r})}))},closeTab:t=>{var c;const n=((c=s().preferences)==null?void 0:c.openTabs)??[];if(n.length<=1)return;const r=n.findIndex(l=>l.canvasId===t),o=s().projectCanvas.getActive(),i=(o==null?void 0:o.id)===t;if(e(se(l=>{var d;(d=l.preferences)!=null&&d.openTabs&&(l.preferences.openTabs=l.preferences.openTabs.filter(p=>p.canvasId!==t))})),i){const l=r>=n.length-1?r-1:r,d=n.filter(p=>p.canvasId!==t)[l];d&&s().projectCanvas.switch(d.canvasId)}},closeOtherTabs:t=>{e(se(n=>{var r;(r=n.preferences)!=null&&r.openTabs&&(n.preferences.openTabs=n.preferences.openTabs.filter(o=>o.canvasId===t))}))},closeTabsToRight:t=>{e(se(n=>{var o;if(!((o=n.preferences)!=null&&o.openTabs))return;const r=n.preferences.openTabs.findIndex(i=>i.canvasId===t);r!==-1&&(n.preferences.openTabs=n.preferences.openTabs.slice(0,r+1))}))},reorderTabs:t=>{e(se(n=>{var o;if(!((o=n.preferences)!=null&&o.openTabs))return;const r=new Map(n.preferences.openTabs.map(i=>[i.canvasId,i]));n.preferences.openTabs=t.map(i=>r.get(i)).filter(i=>i!==void 0)}))}}),uy=(s,e,t,n)=>({getGlobalActionHistory:()=>{var r,o;return((o=(r=s().actions)==null?void 0:r.history)==null?void 0:o.entries)??[]},getGlobalLastAction:()=>{var r,o;return(o=(r=s().actions)==null?void 0:r.history)==null?void 0:o.lastAction},executeGlobalLastAction:()=>{var i,c;const r=(c=(i=s().actions)==null?void 0:i.history)==null?void 0:c.lastAction;if(!r)return!1;if(r.actionId){const l=n.get(r.actionId);if(l)return l(r.params),!0}const o=r.executorId?t.get(r.executorId):void 0;return o?(o(),!0):!1},executeActionById:r=>{const o=t.get(r);return o?(o(),!0):!1},hasExecutor:(r,o)=>o&&n.has(o)?!0:t.has(r),clearGlobalActionHistory:()=>{var o,i;const r=((i=(o=s().actions)==null?void 0:o.history)==null?void 0:i.entries)??[];for(const c of r)c.executorId&&t.delete(c.executorId);e(se(c=>{var l;(l=c.actions)!=null&&l.history&&(c.actions.history.entries=[],c.actions.history.lastAction=void 0)}))}}),py=(s,e)=>({isRecording:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.isRecording)??!1},startRecording:()=>{e(se(t=>{t.actions||(t.actions={}),t.actions.recording={isRecording:!0,capturedSteps:[],startedAt:Date.now()}}))},stopRecording:()=>{var n,r;const t=((r=(n=s().actions)==null?void 0:n.recording)==null?void 0:r.capturedSteps)??[];return e(se(o=>{var i;(i=o.actions)!=null&&i.recording&&(o.actions.recording.isRecording=!1)})),t},cancelRecording:()=>{e(se(t=>{t.actions&&(t.actions.recording={isRecording:!1,capturedSteps:[]})}))},getRecordingSteps:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.recording)==null?void 0:n.capturedSteps)??[]}}),hy=(s,e)=>({isHistorySelecting:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.isSelecting)??!1},toggleHistorySelectionMode:()=>{e(se(t=>{t.actions||(t.actions={}),t.actions.historySelection||(t.actions.historySelection={isSelecting:!1,selectedIds:[]}),t.actions.historySelection.isSelecting=!t.actions.historySelection.isSelecting,t.actions.historySelection.isSelecting||(t.actions.historySelection.selectedIds=[])}))},toggleHistoryItemSelection:t=>{e(se(n=>{var o;if(!((o=n.actions)!=null&&o.historySelection))return;const r=n.actions.historySelection.selectedIds.indexOf(t);r===-1?n.actions.historySelection.selectedIds.push(t):n.actions.historySelection.selectedIds.splice(r,1)}))},getSelectedHistoryIds:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.historySelection)==null?void 0:n.selectedIds)??[]},clearHistorySelection:()=>{e(se(t=>{var n;(n=t.actions)!=null&&n.historySelection&&(t.actions.historySelection.selectedIds=[],t.actions.historySelection.isSelecting=!1)}))}}),fy=(s,e)=>({getSequencePresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.presets)??[]},getSequencePresetById:t=>{var n,r;return(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.presets.find(o=>o.id===t)},createSequencePreset:(t,n)=>{const r=Ue(10);return e(se(o=>{o.actions||(o.actions={}),o.actions.sequencePresets||(o.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),o.actions.sequencePresets.presets.push({id:r,name:t,steps:n,createdAt:Date.now()})})),r},updateSequencePreset:(t,n)=>{e(se(r=>{var i,c;const o=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.presets.find(l=>l.id===t);o&&Object.assign(o,n,{updatedAt:Date.now()})}))},deleteSequencePreset:t=>{e(se(n=>{var r;(r=n.actions)!=null&&r.sequencePresets&&(n.actions.sequencePresets.presets=n.actions.sequencePresets.presets.filter(o=>o.id!==t),n.actions.sequencePresets.favoriteIds=n.actions.sequencePresets.favoriteIds.filter(o=>o!==t),n.actions.sequencePresets.activePresetId===t&&(n.actions.sequencePresets.activePresetId=void 0))}))},duplicateSequencePreset:t=>{var o,i;const n=(i=(o=s().actions)==null?void 0:o.sequencePresets)==null?void 0:i.presets.find(c=>c.id===t);if(!n)return"";const r=crypto.randomUUID();return e(se(c=>{c.actions||(c.actions={}),c.actions.sequencePresets||(c.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const l=n.steps.map(d=>({...d,id:crypto.randomUUID()}));c.actions.sequencePresets.presets.push({id:r,name:`${n.name} (copy)`,steps:l,createdAt:Date.now()})})),r},toggleSequencePresetFavorite:t=>{e(se(n=>{n.actions||(n.actions={}),n.actions.sequencePresets||(n.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]});const r=n.actions.sequencePresets.favoriteIds.indexOf(t);r===-1?n.actions.sequencePresets.favoriteIds.push(t):n.actions.sequencePresets.favoriteIds.splice(r,1)}))},getSequencePresetFavorites:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.favoriteIds)??[]}}),my=(s,e)=>({getVisualWorkflowPresets:()=>{var t,n;return((n=(t=s().actions)==null?void 0:t.sequencePresets)==null?void 0:n.visualWorkflows)??[]},getVisualWorkflowPresetById:t=>{var n,r,o;return(o=(r=(n=s().actions)==null?void 0:n.sequencePresets)==null?void 0:r.visualWorkflows)==null?void 0:o.find(i=>i.id===t)},createVisualWorkflowPreset:(t,n,r)=>{const o=Ue(10);return e(se(i=>{i.actions||(i.actions={}),i.actions.sequencePresets||(i.actions.sequencePresets={presets:[],visualWorkflows:[],favoriteIds:[]}),i.actions.sequencePresets.visualWorkflows||(i.actions.sequencePresets.visualWorkflows=[]),i.actions.sequencePresets.visualWorkflows.push({id:o,name:t,steps:n,sourceLocation:r,createdAt:Date.now()})})),o},updateVisualWorkflowPreset:(t,n)=>{e(se(r=>{var i,c,l;const o=(l=(c=(i=r.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)==null?void 0:l.find(d=>d.id===t);o&&Object.assign(o,n,{updatedAt:Date.now()})}))},deleteVisualWorkflowPreset:t=>{e(se(n=>{var r,o;(o=(r=n.actions)==null?void 0:r.sequencePresets)!=null&&o.visualWorkflows&&(n.actions.sequencePresets.visualWorkflows=n.actions.sequencePresets.visualWorkflows.filter(i=>i.id!==t))}))}}),gy=(s,e)=>({addTagToNode:(t,n,r)=>{const o=s().getNodeById(t);if(!o)return;const i={x:o.x,y:o.y},c=o.groupId,l=typeof n=="string"?{id:Math.random().toString(36).slice(2,10),title:n}:n,d=Array.isArray(o.tags)?o.tags:[];if(d.some(f=>f.title===l.title))return;s().updateNode(t,{tags:[...d,l]});let u;if(!o.groupId&&o.type!==Ke.GROUP&&(u=s().getNodesByTag(l.title).find(m=>m.type===Ke.GROUP&&m.id!==t),u)){const g=o.width??200,x=o.height??100,w=u.width??400,v=u.height??300,b=u.x+w-g-20,y=u.y+v-x-20;s().updateNode(t,{x:b,y}),s().group.addNodesToGroup(u.id,[t])}r!=null&&r.skipUndo||s().undo.commit({type:"tag:add",nodeId:t,tag:l,autoGroup:u?{groupId:u.id,previousPosition:i,previousGroupId:c}:void 0})},removeTagFromNode:(t,n,r)=>{const o=s().getNodeById(t);if(!o||!Array.isArray(o.tags))return;const i=o.tags.find(c=>c.id===n);s().updateNode(t,{tags:o.tags.filter(c=>c.id!==n)}),!(r!=null&&r.skipUndo)&&i&&s().undo.commit({type:"tag:remove",nodeId:t,tag:i})},getNodesByTag:t=>{const n=s().projectCanvas.getActive();return n?(n.coreState.nodes||[]).filter(o=>Array.isArray(o.tags)&&o.tags.some(i=>i.title===t)):[]},hasTag:(t,n)=>{const r=s().getNodeById(t);return!r||!Array.isArray(r.tags)?!1:r.tags.some(o=>o.title===n)}}),xy=5e3,Rr={HEALTH:"/api/canvas/health",USER_STATE:"/api/canvas/user"};class Fl{constructor(e="http://localhost:3030",t=xy){ee(this,"baseUrl");ee(this,"timeout");this.baseUrl=e,this.timeout=t}async health(){const e=`${this.baseUrl}${Rr.HEALTH}`;try{const t=await this.fetchWithTimeout(e,{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?await t.json():(console.error("[CanvasApiClient] Health check failed:",t.status),{status:"error",timestamp:new Date().toISOString()})}catch(t){return console.error("[CanvasApiClient] Health check error:",t),{status:"error",timestamp:new Date().toISOString()}}}async getUserState(e){const t=`${this.baseUrl}${Rr.USER_STATE}/${e}/state`;try{const n=await this.fetchWithTimeout(t,{method:"GET",headers:{"Content-Type":"application/json"}});return n.ok?await n.json():(console.error("[CanvasApiClient] Get user state failed:",n.status),{success:!1,error:`HTTP ${n.status}`})}catch(n){return console.error("[CanvasApiClient] Get user state error:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async saveUserState(e,t){const n=`${this.baseUrl}${Rr.USER_STATE}/${e}/state`;try{const r=await this.fetchWithTimeout(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({canvasState:t})});return r.ok?await r.json():(console.error("[CanvasApiClient] Save user state failed:",r.status),{success:!1,error:`HTTP ${r.status}`})}catch(r){return console.error("[CanvasApiClient] Save user state error:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async fetchWithTimeout(e,t){const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}const $l=new Fl,vy=Object.freeze(Object.defineProperty({__proto__:null,CanvasApiClient:Fl,canvasApiClient:$l},Symbol.toStringTag,{value:"Module"})),ys="[ApiSync]",by=s=>{var p,u;const e=s(),t=((p=e.state)==null?void 0:p.projects)??{},n={};for(const[f,m]of Object.entries(t)){const g={};for(const[x,w]of Object.entries(m.workspaces)){const v={};for(const[b,y]of Object.entries(w.canvases)){const{undoTree:C,...S}=y;v[b]=S}g[x]={...w,canvases:v}}n[f]={...m,workspaces:g}}const r=e.uiState,{temporaryArrow:o,selectionBox:i,dragInfo:c,resizingNode:l,...d}=r;return{projects:n,activeProjectId:((u=e.state)==null?void 0:u.activeProjectId)??null,preferences:e.preferences??{},actions:e.actions??{},uiState:d}},wy=(s,e)=>({syncToApi:async()=>{var o;const t=((o=s().preferences)==null?void 0:o.apiSyncEnabled)??!0,{loadActiveUserId:n}=await Ge(async()=>{const{loadActiveUserId:i}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:i}},[]),r=n();if(!t){console.log(ys,"API sync disabled, skipping sync");return}if(!r){console.log(ys,"No active user, skipping API sync");return}try{const i=by(s),c=JSON.stringify(i),l=Object.keys(i.projects).length,d=Object.values(i.projects).flatMap(u=>Object.values(u.workspaces).flatMap(f=>Object.values(f.canvases))).length;if(l===0||d===0){console.warn(ys,"Aborting save: state appears to be empty/initial");return}console.log(ys,`Syncing state to API for user: ${r}...`),(await $l.saveUserState(r,c)).success&&console.log(ys,"State synced successfully")}catch(i){console.error(ys,"Sync error:",i)}},getApiSyncEnabled:()=>{var t;return((t=s().preferences)==null?void 0:t.apiSyncEnabled)??!0},setApiSyncEnabled:t=>{e(se(n=>{n.preferences||(n.preferences={}),n.preferences.apiSyncEnabled=t}))}}),ci=new Map,Ul=new Map,yy=(s,e)=>{Ul.set(s,e)},Sy=()=>`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,li="markop-canvas-v2-storage",Yt=new cb("CanvasStateV2",Xv.CanvasStateV2),jy=(s,e)=>({...Ya,...kv(e,s),...hv(e,s),project:Gv(s,e),workspace:Yv(s,e),projectCanvas:ib(s,e),arrow:Hg(s,e),group:bb(s,e),table:jb(s,e),layer:Wb(s,e),viewLayer:lw(s,e),ext:ww(s,e),undo:ny(s,e),getCanvasMouseCoords:()=>Eg(e),...gv(e,s),setFlags:t=>Gx(s,t),...ay(e,s,ci,Sy),...oy(e,s),...iy(e,s),...cy(e,s),...ly(e,s),...dy(e,s),...uy(e,s,ci,Ul),...py(e,s),...hy(e,s),...fy(e,s),...my(e,s),resetState:()=>qx(s),resetEverything:()=>ov([li,"paper-texture-live-config","paper-texture-saved-presets"]),scrollToNode:(t,n=500,r)=>Ng(s,e,t,n,r),scrollToArrow:(t,n=500)=>ub(s,e,t,n),...gy(e),...Uv(e,s),...Iv(e,li,Yt),...wy(e,s)}),Cy=jy,Mt=sl()(Cy);let Qn=!1;(async()=>{var t,n;const s=typeof document<"u"&&document.currentScript?document.currentScript.src:typeof import.meta<"u"?import.meta.url:"";if(s.startsWith("moz-extension://")||s.startsWith("chrome-extension://")){Qn=!0;return}try{const{loadActiveUserId:r,DEFAULT_USERS:o,saveActiveUserId:i}=await Ge(async()=>{const{loadActiveUserId:u,DEFAULT_USERS:f,saveActiveUserId:m}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:u,DEFAULT_USERS:f,saveActiveUserId:m}},[]),{loadCanvasStateForUser:c,createDefaultCanvasStateForUser:l}=await Ge(async()=>{const{loadCanvasStateForUser:u,createDefaultCanvasStateForUser:f}=await import("./userCanvasStateStorage-B5aouBzz.js");return{loadCanvasStateForUser:u,createDefaultCanvasStateForUser:f}},__vite__mapDeps([64,1,4,5,6,2]));let d=r(),p=null;if(!d&&o.length>0){const u=o[0];d=u.id,i(d),Yt.log(`No active user found, initializing with default: ${u.username}`)}if(d){const u=await c(d);let f=null,m=0;const{canvasApiClient:g}=await Ge(async()=>{const{canvasApiClient:w}=await Promise.resolve().then(()=>vy);return{canvasApiClient:w}},void 0);try{const w=await g.getUserState(d);if(w.success&&((t=w.data)!=null&&t.canvasState)){const v=JSON.parse(w.data.canvasState);f={state:{projects:v.projects??{},activeProjectId:v.activeProjectId??null},preferences:v.preferences??{},actions:v.actions??{},uiState:v.uiState??void 0},m=w.data.lastModified??0,Yt.log(`API state available for user: ${d}, lastModified: ${m}`)}}catch(w){Yt.log(`API fetch failed for user: ${d}`,w)}const x=(n=u==null?void 0:u.state)!=null&&n.projects?Math.max(...Object.values(u.state.projects).map(w=>w.lastModified??0)):0;if(f&&m>=x?(p=f,Yt.log(`Using API state (newer: ${m} >= ${x})`)):u&&(p=u,Yt.log(`Using localStorage state (newer: ${x} > ${m})`)),!p){const w=o.find(b=>b.id===d),v=(w==null?void 0:w.username)??"User";p=l(d,v),Yt.log(`Created default canvas state for user: ${v}`)}}if(p){const u=Pv(Ya,p);Rv(u.preferences),Mt.setState({version:u.version,dataVersion:u.dataVersion,state:u.state,uiState:u.uiState,flags:u.flags,preferences:u.preferences,extensions:u.extensions,actions:u.actions}),Yt.log("Canvas state rehydrated from user-specific storage");try{await Mt.getState().undo.initArchive(),await Mt.getState().undo.loadFromArchive()&&Yt.log("Undo history loaded from IndexedDB")}catch(f){console.warn("[PERSISTENCE] Failed to load undo history from IndexedDB:",f)}}}catch(r){console.error("[PERSISTENCE] Failed to rehydrate from localStorage:",r)}finally{Qn=!0}})();let Dr=null;const Ny=1e3;$e.autosave&&$e.persistState&&Mt.subscribe(s=>{Qn&&(Dr&&clearTimeout(Dr),Dr=setTimeout(async()=>{s.saveStateToLocalStorage(),s.getApiSyncEnabled()&&s.syncToApi();const{loadActiveUserId:e}=await Ge(async()=>{const{loadActiveUserId:r}=await import("./userStoreLocalStorage-D-7v21rP.js");return{loadActiveUserId:r}},[]),{saveCanvasStateForUser:t}=await Ge(async()=>{const{saveCanvasStateForUser:r}=await import("./userCanvasStateStorage-B5aouBzz.js");return{saveCanvasStateForUser:r}},__vite__mapDeps([64,1,4,5,6,2])),n=e();n&&t(n)},Ny))});const ky={mousePosition:null},Ey=(s,e)=>({...ky,setMousePosition:t=>lx(s,t)}),Bl=sl()(Ey),JC=Object.freeze(Object.defineProperty({__proto__:null,canvasStoreV2:Mt,canvasUiStoreV2:Bl,get isRehydrated(){return Qn},registerActionHandler:yy},Symbol.toStringTag,{value:"Module"}));class Ty{constructor(){ee(this,"activeTranscriptions",new Map);ee(this,"listeners",new Set)}register(e,t){this.activeTranscriptions.set(e,{nodeId:e,sessionName:t,startedAt:Date.now(),status:"recording"}),this.notify()}updateStatus(e,t){const n=this.activeTranscriptions.get(e);n&&(n.status=t,this.notify())}complete(e,t){const n=Mt.getState(),r=n.getNodeById(e);if(r){const o=r.content||"",i=o+(o?`
`:"")+t;n.updateNodeContent(e,i),Yg();const{width:c,height:l}=Xg(i);n.updateNode(e,{width:c,height:l,options:{...r.options,lockSize:!1}})}this.activeTranscriptions.delete(e),this.notify()}fail(e){this.activeTranscriptions.delete(e),this.notify()}has(e){return this.activeTranscriptions.has(e)}getStatus(e){var t;return((t=this.activeTranscriptions.get(e))==null?void 0:t.status)??null}getAll(){return Array.from(this.activeTranscriptions.values())}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}}const Sn=new Ty;var io=(s=>(s.EN="en",s.VI="vi",s.DE="de",s))(io||{});const YC={en:"EN",vi:"VI",de:"DE"},XC={en:"English",vi:"Vietnamese",de:"German"},QC={en:"ðŸ‡¬ðŸ‡§",vi:"ðŸ‡»ðŸ‡³",de:"ðŸ‡©ðŸ‡ª"},Wl="en",ZC=["en","vi","de"];function zl({onTranscriptionComplete:s,className:e="",sessionName:t="audio-button-default",getTextAreaElement:n,variant:r="default",autoStartRecording:o=!1,style:i,nodeId:c,language:l}){const[d,p]=h.useState(!1),[u,f]=h.useState(0),[m,g]=h.useState(0),[x,w]=h.useState(!1),v=h.useRef(0),b=h.useRef({});v.current++;const y={onTranscriptionComplete:s,sessionName:t,getTextAreaElement:n,variant:r,autoStartRecording:o,nodeId:c,language:l};Object.keys(y).forEach(I=>{b.current[I],y[I]}),b.current=y,h.useEffect(()=>{if(o&&!d){const I=setTimeout(()=>{f(k=>k+1)},100);return()=>clearTimeout(I)}},[o]);const C=h.useCallback(I=>"value"in I?I.value:I.textContent||"",[]),S=h.useCallback((I,k)=>{var U;if("value"in I){const q=(U=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:U.set;q?q.call(I,k):I.value=k}else I.textContent=k;const M=new Event("input",{bubbles:!0});I.dispatchEvent(M)},[]),[j,N]=h.useState([]),[E,R]=h.useState(0),[D,T]=h.useState(!1),L=h.useCallback(I=>{N(k=>[...k,I]),(I.transcriptionStatus==="pending"||I.transcriptionStatus==="processing")&&w(!0)},[]),_=h.useCallback(I=>{N(k=>k.map(M=>M.id===I.id?I:M)),I.transcription?(R(k=>k+1),c?Sn.complete(c,I.transcription):s==null||s(I.transcription),w(!1)):I.transcriptionStatus==="failed"&&(c&&Sn.fail(c),w(!1))},[s,c]),P=h.useCallback(I=>{p(I),c&&(I?Sn.register(c,t):Sn.updateStatus(c,"transcribing"))},[c,t]),G=h.useCallback(I=>{I&&(I.preventDefault(),I.stopPropagation()),d?g(k=>k+1):f(k=>k+1)},[d]),$=h.useCallback(I=>{if(I.preventDefault(),I.stopPropagation(),E>0&&n){const k=n();if(!k)return;const M=j[E-1];if(!(M!=null&&M.transcription))return;const U=C(k),q=M.transcription;let W=U;U.endsWith(q)?W=U.slice(0,-q.length):U.endsWith(" "+q)&&(W=U.slice(0,-(q.length+1))),W=W.trimEnd(),S(k,W),R(V=>V-1)}},[E,j,n,C,S]),Y=h.useCallback(I=>{if(I.preventDefault(),I.stopPropagation(),E<j.length&&n){const k=n();if(!k)return;const M=j[E];if(!(M!=null&&M.transcription))return;const U=C(k),q=U.trim()?" ":"",W=U+q+M.transcription;S(k,W),R(V=>V+1)}},[E,j,n,C,S]),A=h.useCallback(I=>{const k=j.findIndex(M=>M.id===I);if(k!==-1){if(k<E&&n){const M=n();if(M){const q=j.filter((W,V)=>V<E&&V!==k).map(W=>W.transcription).filter(Boolean).join(" ");S(M,q),R(W=>W-1)}}N(M=>M.filter(U=>U.id!==I))}},[j,E,n,S]),X=h.useCallback(()=>{if(n){const I=n();I&&S(I,"")}N([]),R(0)},[n,S]);return h.useEffect(()=>{const I=k=>{if(k.ctrlKey&&k.shiftKey&&k.key==="A")if(n){const M=n();M&&document.activeElement===M&&(k.preventDefault(),k.stopPropagation(),k.stopImmediatePropagation(),G())}else k.preventDefault(),k.stopPropagation(),k.stopImmediatePropagation(),G()};return window.addEventListener("keydown",I,!0),()=>{window.removeEventListener("keydown",I,!0)}},[G,n]),a.jsxs("div",{className:`audio-button-wrapper flex items-center gap-1 ${e}`,"data-test":"audio-button-wrapper",style:i,children:[x&&a.jsx("div",{className:"transcription-spinner","data-test":"audio-button-transcription-spinner",children:a.jsx(lr,{className:"w-4 h-4 animate-spin text-muted-foreground","data-test":"audio-button-transcription-spinner-icon"})}),j.length>0&&a.jsxs("div",{className:"chunk-navigation flex items-center gap-0.5","data-test":"audio-button-chunk-navigation",children:[a.jsx("button",{onMouseDown:I=>I.preventDefault(),onClick:$,disabled:E===0,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Remove previous chunk",type:"button","data-test":"audio-button-previous-chunk-button",children:a.jsx(_s,{className:Fe.sm,"data-test":"audio-button-previous-chunk-icon"})}),a.jsxs(st,{open:D,onOpenChange:T,"data-test":"audio-button-chunk-panel-popover",children:[a.jsx(pt,{asChild:!0,children:a.jsxs("button",{onMouseDown:I=>I.preventDefault(),onDoubleClick:()=>{X(),T(!1)},className:"chunk-counter text-xs text-muted-foreground px-1 hover:bg-accent rounded cursor-pointer",title:"View all chunks (double-click to clear)",type:"button","data-test":"audio-button-chunk-counter-button",children:[E,"/",j.length]})}),a.jsx(Qe,{className:"w-96 p-0",side:"top",align:"center","data-test":"audio-button-chunk-panel-content",children:a.jsx("div",{className:"chunk-panel-popover","data-test":"audio-button-chunk-panel-wrapper",children:a.jsx(tl,{chunks:j,onChunkDelete:A,onChunkTranscribe:()=>{},onClearAll:X})})})]}),a.jsx("button",{onMouseDown:I=>I.preventDefault(),onClick:Y,disabled:E>=j.length,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Add next chunk",type:"button","data-test":"audio-button-next-chunk-button",children:a.jsx(yt,{className:Fe.sm,"data-test":"audio-button-next-chunk-icon"})})]}),a.jsx("button",{onMouseDown:I=>I.preventDefault(),onClick:G,className:r==="muted"?`voice-input-button p-1 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"text-muted-foreground/40 hover:text-foreground hover:bg-accent"}`:`voice-input-button p-1.5 rounded-md transition-colors ${d?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"hover:bg-accent"}`,title:d?"Stop recording (Ctrl+Shift+A)":"Start voice input (Ctrl+Shift+A)",type:"button","data-test":"audio-button-voice-input-button",children:a.jsx(ar,{className:`voice-input-icon ${r==="muted"?Fe.xs:Fe.sm} ${d?"animate-pulse":""}`,"data-test":"audio-button-voice-input-icon"})}),a.jsx("div",{className:"audio-panel-wrapper hidden","data-test":"audio-button-audio-panel-wrapper",children:a.jsx(Um,{sessionName:t,enableAutoPersist:!1,loadPersistedChunks:!1,autoStart:!1,startTrigger:u,stopTrigger:m,onChunkCreated:L,onChunkUpdated:_,onRecordingStateChange:P,initialConfig:l?{transcribeOptions:{language:l,...l===io.VI?{model:"ggml-large-v3"}:{}}}:void 0})})]})}const di=s=>{const{header:e,itemList:t,maxHeight:n,selectedIndices:r,selectedValues:o,getItemValue:i=(A,X)=>X,onSelectionChange:c,searchable:l=!1,searchPlaceholder:d="Search...",filterItem:p=(A,X)=>String(A).toLowerCase().includes(X.toLowerCase()),showAllOption:u=l,allOptionLabel:f="All",enableDelete:m=!1,onItemDelete:g,itemStyles:x="",moreOptions:w,initiallyCollapsed:v=!1,...b}=s,y=h.useRef({}),C=h.useRef(!1),[S,j]=h.useState(new Set(r)),[N,E]=h.useState(r==null?void 0:r[r.length-1]),[R,D]=h.useState(""),[T,L]=h.useState(v);h.useEffect(()=>{const A=Array.from(S),X=r||[];if(A.length!==X.length||!A.every((I,k)=>I===X[k])){C.current=!0,j(new Set(r));const I=r==null?void 0:r[r.length-1];E(I)}},[r]),h.useEffect(()=>{if(o===void 0)return;const A=new Set,X=new Set(o);if(t.forEach((I,k)=>{X.has(i(I,k))&&A.add(k)}),A.size!==S.size||!Array.from(A).every(I=>S.has(I))){C.current=!0,j(A);const I=o[o.length-1],k=t.findIndex((M,U)=>i(M,U)===I);E(k!==-1?k:void 0)}},[o,t,i]),h.useEffect(()=>{if(C.current){const A=N;if(A!==void 0&&S.has(A)){const X=y.current[A];X&&X.scrollIntoView({behavior:"smooth",block:"nearest"})}C.current=!1}},[S,N]);const _=(A,X)=>{const I=Y[A],k=t.findIndex(U=>U===I);if(k===-1)return;let M=new Set(S);if(X.shiftKey&&N!==void 0){const U=Math.min(N,k),q=Math.max(N,k);for(let W=U;W<=q;W++)Y.some(ie=>t[W]===ie)&&M.add(W)}else X.ctrlKey||X.metaKey?(M.has(k)?M.delete(k):M.add(k),E(k)):(M=new Set([k]),E(k));if(j(M),c){const U=Array.from(M),q=U.map(W=>i(t[W],W));c(U,q)}},P=(A,X)=>{if(X.stopPropagation(),g){const I=i(t[A],A);g(A,I)}},G=()=>{D(""),j(new Set),E(void 0),c&&c([],[])},$=()=>{L(!T)},Y=R&&l?t.filter((A,X)=>p(A,R,X)):t;return a.jsxs("div",{id:"UiList","data-test":"ui-list-container",className:"bg-background text-foreground select-none",...b,children:[e?a.jsxs("div",{id:"header-container","data-test":"ui-list-header-container",className:"flex justify-between items-center sticky top-0 bg-background z-10 py-2 px-2 border-b border-border",children:[a.jsx("div",{"data-test":"ui-list-header-content",className:`flex-grow ${typeof e=="string"?"font-bold":""}`,children:e}),w&&a.jsx("div",{className:"flex items-center ml-2 flex-shrink-0","data-test":"ui-list-more-options",children:w}),a.jsx(de,{variant:"ghost",size:"sm",onClick:$,className:"p-1 h-auto flex-shrink-0","aria-label":T?"Expand list":"Collapse list","data-test":"ui-list-collapse-toggle",children:T?a.jsx(ut,{size:16}):a.jsx(ir,{size:16})})]}):null,!T&&a.jsxs(a.Fragment,{children:[l&&a.jsx("div",{className:"sticky top-0 bg-background z-10 py-2 px-2 border-b border-border","data-test":"ui-list-search-container",children:a.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:d,value:R,onChange:A=>D(A.target.value),"data-test":"ui-list-search-input"})}),a.jsxs("div",{id:"itemList","data-test":"ui-list-items-container",className:qs("space-y-1 py-1 p-2 overflow-auto"),style:{maxHeight:n},children:[l&&u&&a.jsx("div",{className:`p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${!R&&S.size===0?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:G,"data-test":"ui-list-all-option",children:f}),Y.map((A,X)=>{const I=A,k=t.findIndex(U=>U===I),M=S.has(k);return a.jsxs("div",{ref:U=>y.current[k]=U,className:`flex justify-between items-center p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${M?"bg-accent text-accent-foreground font-semibold":""} select-none ${x}`,onClick:U=>_(X,U),"data-test":"ui-list-item",children:[a.jsx("span",{className:"flex-grow","data-test":"ui-list-item-content",children:A}),m&&a.jsx(kp,{onClick:U=>P(k,U),className:"ml-2 px-1 py-0 text-xs text-destructive-foreground rounded hover:bg-destructive/80 focus:outline-none focus:ring-1 focus:ring-destructive","aria-label":`Delete item ${k+1}`,"data-test":"ui-list-item-delete"})]},k)})]})]})]})},Hl=h.forwardRef(({className:s,onSelectionChange:e,showBuiltInPopover:t=!0,showCopyButton:n=!1,showAudioButton:r=!1,audioButtonVariant:o="default",onAudioTranscription:i,getTextAreaElement:c,keyboard:l,triggerPopover:d,fuzzyAutocomplete:p,...u},f)=>{const m=xs(),[g,x]=h.useState(""),[w,v]=h.useState(!1),[b,y]=h.useState({top:0,left:0}),[C,S]=h.useState(!1),j=h.useRef(null),N=h.useRef(null),[E,R]=h.useState(!1),[D,T]=h.useState({top:0,left:0}),[L,_]=h.useState(null),[P,G]=h.useState(""),[$,Y]=h.useState(0),A=h.useRef(null),[X,I]=h.useState(!1),[k,M]=h.useState({top:0,left:0}),[U,q]=h.useState(""),[W,V]=h.useState(0),ie=h.useRef(null),K=h.useMemo(()=>{if(!(d!=null&&d.items))return[];if(!P)return d.items;const z=P.toLowerCase();return d.items.filter(O=>O.label.toLowerCase().includes(z)||O.id.toLowerCase().includes(z))},[d==null?void 0:d.items,P]);h.useEffect(()=>{Y(0)},[K.length]);const ne=h.useMemo(()=>{if(!(p!=null&&p.items)||!U)return[];const z=p.filterFn??((O,Q)=>O.toLowerCase().includes(Q.toLowerCase()));return p.items.filter(O=>z(O,U))},[p==null?void 0:p.items,p==null?void 0:p.filterFn,U]);h.useEffect(()=>{V(0)},[ne.length]);const me=h.useCallback(async()=>{const z=j.current;if(!(!z||!z.value))try{await navigator.clipboard.writeText(z.value),S(!0),setTimeout(()=>S(!1),2e3)}catch(O){console.error("Failed to copy text:",O)}},[]),ge=h.useCallback(()=>{R(!1),_(null),G(""),Y(0)},[]),oe=h.useCallback(()=>{I(!1),q(""),V(0)},[]),Se=h.useCallback((z,O)=>{const Q=window.getComputedStyle(z),we=z.scrollTop,re=parseInt(Q.paddingLeft)||12,be=parseInt(Q.paddingTop)||8,J=parseInt(Q.lineHeight)||20,Ce=z.value.substring(0,O).split(`
`),Ie=Ce[Ce.length-1],Ae=Ce.length-1,_e=document.createElement("canvas").getContext("2d");if(!_e)return{top:be+J,left:re};_e.font=`${Q.fontWeight} ${Q.fontSize} ${Q.fontFamily}`;const Me=_e.measureText(Ie).width,Be=(Ae+1)*J-we+be,ze=Me+re;return{top:Be,left:ze}},[]),xe=h.useCallback(z=>{if(!d)return;const O=z.selectionStart,Q=z.value,we=d.triggerChar;if(L!==null){if(O<=L||Q[L]!==we){ge();return}const re=Q.substring(L+1,O);if(/\s/.test(re)){ge();return}G(re);return}if(O>0&&Q[O-1]===we){const re=O>1?Q[O-2]:null;if(re===null||re===" "||re===`
`||re==="	"){const J=Se(z,O);T(J),_(O-1),R(!0),G(""),Y(0);return}}},[d,L,Se,ge]),Pe=h.useCallback(z=>{if(!p)return;const O=z.selectionStart,Q=z.value,we=p.triggerAfterChars??1;if(Q.length<we){X&&oe();return}if(q(Q),Q.length>=we&&!X){const re=Se(z,O);M(re),I(!0)}},[p,X,Se,oe]),ae=h.useCallback(z=>{var we,re;const O=j.current;if(!O)return;const Q=(we=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:we.set;Q&&(Q.call(O,z),O.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{O.setSelectionRange(z.length,z.length),O.focus()},0),(re=p==null?void 0:p.onSelect)==null||re.call(p,z),oe()},[p,oe]),te=h.useCallback(()=>{var O;if(!(p!=null&&p.findLCS)||ne.length===0)return!1;const z=p.findLCS(ne,U);if(z.length>U.length){const Q=j.current;if(!Q)return!1;const we=(O=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:O.set;return we&&(we.call(Q,z),Q.dispatchEvent(new Event("input",{bubbles:!0}))),setTimeout(()=>{Q.setSelectionRange(z.length,z.length),Q.focus()},0),q(z),!0}return!1},[p,ne,U]),F=h.useCallback(()=>{const z=j.current;if(!z)return;const O=z.selectionStart,Q=z.selectionEnd,we=z.value.substring(O,Q).trim();if(we.length>0){x(we),v(t);const re=z.scrollTop,be=window.getComputedStyle(z),J=z.getBoundingClientRect(),fe=parseInt(be.paddingLeft)||12,Ce=parseInt(be.paddingTop)||8,Ie=z.value.substring(0,O).split(`
`),Ae=parseInt(be.lineHeight)||20,Ee=Ie.length-1,_e=Ie[Ee],Be=document.createElement("canvas").getContext("2d");if(!Be)return;Be.font=`${be.fontWeight} ${be.fontSize} ${be.fontFamily}`;const ze=parseInt(be.paddingRight)||12,lt=J.width-fe-ze;let Ye=0,nt=0,xt=0;for(;xt<_e.length;){let bt=xt+1;for(;bt<=_e.length;){const yr=_e.substring(xt,bt);if(Be.measureText(yr).width>lt){let bs=bt-1;for(let ws=bt-1;ws>xt;ws--)if(_e[ws]===" "){bs=ws;break}bs===xt&&bt-xt>1&&(bs=bt-1),bt=bs;break}bt++}Ye=xt;const go=Math.min(bt,_e.length);if(go>=_e.length){const yr=_e.substring(Ye),xo=Be.measureText(yr).width,bs=(Ee+nt)*Ae-re+Ae+Ce,ws=xo+fe,vo={top:bs,left:ws};y(vo),e==null||e(we,vo);return}nt++,xt=go,_e[xt]===" "&&xt++}}else v(!1),x(""),e==null||e("",void 0)},[e,t]),Z=h.useCallback(()=>{F()},[F]),H=h.useCallback(z=>{var O;z.shiftKey&&F(),(O=u.onKeyUp)==null||O.call(u,z)},[F,u]),ce=h.useCallback(z=>{var Ce,Ie;const O=j.current;if(!O||L===null)return;const Q=O.value,we=Q.substring(0,L),re=Q.substring(L+1+P.length),be=we+z.value+re,J=(Ce=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Ce.set;J&&(J.call(O,be),O.dispatchEvent(new Event("input",{bubbles:!0})));const fe=L+z.value.length;setTimeout(()=>{O.setSelectionRange(fe,fe),O.focus()},0),(Ie=d==null?void 0:d.onSelect)==null||Ie.call(d,z,{filterText:P,triggerPosition:L}),ge()},[L,P,d,ge]),ue=h.useCallback(z=>{var O;if(E&&d)switch(z.key){case"Escape":z.preventDefault(),ge();return;case"ArrowDown":z.preventDefault(),Y(Q=>Q<K.length-1?Q+1:0);return;case"ArrowUp":z.preventDefault(),Y(Q=>Q>0?Q-1:K.length-1);return;case"Enter":case"Tab":K.length>0&&(z.preventDefault(),ce(K[$]));return}if(X&&p)switch(z.key){case"Escape":z.preventDefault(),oe();return;case"ArrowDown":z.preventDefault(),V(Q=>Q<ne.length-1?Q+1:0);return;case"ArrowUp":z.preventDefault(),V(Q=>Q>0?Q-1:ne.length-1);return;case"Tab":z.preventDefault(),!te()&&ne.length===1&&ae(ne[0]);return;case"Enter":ne.length>0&&(z.preventDefault(),ae(ne[W]));return}(O=u.onKeyDown)==null||O.call(u,z)},[E,d,ge,K,$,ce,X,p,oe,ne,W,te,ae,u]),pe=h.useCallback(z=>{var O;xe(z.target),Pe(z.target),(O=u.onChange)==null||O.call(u,z)},[xe,Pe,u]),he=h.useCallback(z=>{var O;setTimeout(()=>{v(!1),d!=null&&d.stayOpen||ge(),oe()},200),(O=u.onBlur)==null||O.call(u,z)},[u,ge,oe,d==null?void 0:d.stayOpen]),ve=h.useCallback(()=>{if(!g||g.length===0)return"";const z=g[0];return z>="A"&&z<="Z"?"text-red-600":z>="a"&&z<="z"?"text-blue-600":""},[g]),Te=h.useCallback(z=>{i==null||i(z)},[i]),ke=h.useCallback(()=>j.current,[]);return h.useImperativeHandle(f,()=>({insertTextAtStart:z=>{const O=j.current;if(!O)return;O.focus();const Q=O.selectionStart,we=O.selectionEnd;if(O.setSelectionRange(0,0),!document.execCommand("insertText",!1,z)){const fe=z+O.value;O.value=fe,O.dispatchEvent(new Event("input",{bubbles:!0}))}const be=Q+z.length,J=we+z.length;O.setSelectionRange(be,J)},getTextArea:()=>j.current,getSelectionPosition:()=>b,closeTriggerPopover:ge,getTriggerPosition:()=>L}),[b,ge,L]),a.jsxs("div",{className:"textarea-container relative w-full h-full","data-test":"selectable-textarea-container",children:[a.jsxs(st,{open:w,"data-test":"selectable-textarea-popover",children:[a.jsx(Hc,{...u,className:B("flex w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),style:{fontSize:m?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:m?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...u.style},ref:j,onChange:pe,onKeyDown:ue,onMouseUp:Z,onKeyUp:H,onBlur:he,"data-node-textarea":"true","data-test":"selectable-textarea-rich-textarea"}),a.jsx(Tn,{ref:N,style:{position:"absolute",top:`${b.top}px`,left:`${b.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-popover-anchor"}),a.jsx(Qe,{side:"bottom",align:"start",className:"selection-popover w-auto max-w-md",onOpenAutoFocus:z=>z.preventDefault(),"data-test":"selectable-textarea-popover-content",children:a.jsxs("div",{className:"popover-content flex flex-col gap-2","data-test":"selectable-textarea-popover-content-wrapper",children:[a.jsx("div",{className:"popover-label text-xs text-muted-foreground font-medium","data-test":"selectable-textarea-popover-label",children:"Selected Text:"}),a.jsx("div",{className:B("popover-text text-sm font-mono bg-muted px-2 py-1 rounded font-semibold",ve()),"data-test":"selectable-textarea-popover-text",children:g})]})})]}),d&&a.jsxs(st,{open:E,"data-test":"selectable-textarea-trigger-popover",children:[a.jsx(Tn,{ref:A,style:{position:"absolute",top:`${D.top}px`,left:`${D.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-trigger-popover-anchor"}),a.jsx(Qe,{side:"bottom",align:"start",className:B("trigger-popover p-1",d.widthClass??"w-48"),style:d.zIndex?{zIndex:d.zIndex}:void 0,onOpenAutoFocus:z=>z.preventDefault(),"data-test":"selectable-textarea-trigger-popover-content",children:a.jsxs("div",{"data-test":"trigger-popover-menu",children:[a.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:d.header??"Select"}),K.length>0?a.jsx(di,{itemList:K.map(z=>a.jsxs("div",{className:"flex items-center gap-2 px-1","data-test":"trigger-item",children:[z.icon&&a.jsx("span",{className:"font-mono text-xs w-6 text-muted-foreground",children:z.icon}),a.jsx("span",{className:"text-sm",children:z.label})]},z.id)),selectedIndices:[$],onSelectionChange:z=>{z.length>0&&K[z[0]]&&ce(K[z[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"trigger-popover-list"}):a.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"trigger-popover-empty",children:d.emptyMessage??"No matches"})]})})]}),p&&a.jsxs(st,{open:X,"data-test":"selectable-textarea-fuzzy-popover",children:[a.jsx(Tn,{ref:ie,style:{position:"absolute",top:`${k.top}px`,left:`${k.left}px`,width:"1px",height:"1px"},"data-test":"selectable-textarea-fuzzy-popover-anchor"}),a.jsx(Qe,{side:"bottom",align:"start",className:B("fuzzy-popover p-1",p.widthClass??"w-48"),style:p.zIndex?{zIndex:p.zIndex}:void 0,onOpenAutoFocus:z=>z.preventDefault(),"data-test":"selectable-textarea-fuzzy-popover-content",children:a.jsxs("div",{"data-test":"fuzzy-popover-menu",children:[a.jsx("div",{className:"text-xs text-muted-foreground border-b pb-1 mb-1",children:p.header??"Suggestions"}),ne.length>0?a.jsx(di,{itemList:ne.map((z,O)=>a.jsx("div",{className:"flex items-center gap-2 px-1 text-sm","data-test":"fuzzy-item",children:a.jsx("span",{className:"truncate",children:z})},O)),selectedIndices:[W],onSelectionChange:z=>{z.length>0&&ne[z[0]]&&ae(ne[z[0]])},maxHeight:"150px",itemStyles:"text-sm","data-test":"fuzzy-popover-list"}):a.jsx("div",{className:"text-xs text-muted-foreground p-2","data-test":"fuzzy-popover-empty",children:p.emptyMessage??"No matches"})]})})]}),a.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:Je.nodeAudioButton},"data-test":"selectable-textarea-action-buttons",children:[n&&a.jsx("button",{type:"button",onClick:me,className:"p-1 rounded hover:bg-muted/80 text-muted-foreground hover:text-foreground transition-colors",title:C?"Copied!":"Copy text","data-test":"selectable-textarea-copy-button",children:C?a.jsx(ct,{className:"h-4 w-4 text-green-500"}):a.jsx(dr,{className:"h-4 w-4"})}),r&&a.jsx(zl,{onTranscriptionComplete:Te,sessionName:"selectable-textarea",getTextAreaElement:c||ke,variant:o,language:l,"data-test":"selectable-textarea-audio-button"})]})]})});Hl.displayName="SelectableTextArea";class Iy{constructor(){ee(this,"directoryMapCache",new Map);ee(this,"loadPromiseCache",new Map)}async loadDirectoryMap(e){var c;const t=e??"default",r=(c=le.getState().ui)==null?void 0:c.directoryMaps;if(r!=null&&r[t])return this.directoryMapCache.set(t,r[t]),r[t];if(this.directoryMapCache.has(t))return this.directoryMapCache.get(t);if(this.loadPromiseCache.has(t))return this.loadPromiseCache.get(t);const o=e?`/directory-map?cwd=${encodeURIComponent(e)}`:"/directoryMap.json",i=fetch("http://localhost:3333"+o).then(l=>{if(!l.ok)throw new Error(`Failed to load directory map: ${l.statusText}`);return l.json()}).then(l=>{const d=l.success?l.data:l;return this.directoryMapCache.set(t,d),this.loadPromiseCache.delete(t),this.saveToGlobalStore(t,d),d}).catch(l=>{throw this.loadPromiseCache.delete(t),l});return this.loadPromiseCache.set(t,i),i}saveToGlobalStore(e,t){var o;const n=le.getState(),r=((o=n.ui)==null?void 0:o.directoryMaps)??{};le.updateState({ui:{...n.ui,directoryMaps:{...r,[e]:t}}})}async getFilePath(e,t){const n=await this.loadDirectoryMap(t);if(n[e])return n[e];const r=e.toLowerCase();for(const[o,i]of Object.entries(n))if(o.toLowerCase()===r)return i}async getAllFilenames(e){const t=await this.loadDirectoryMap(e);return Object.keys(t)}async searchFiles(e,t){const n=await this.loadDirectoryMap(t),r=e.toLowerCase();return Object.entries(n).filter(([o])=>o.toLowerCase().includes(r)).map(([o,i])=>({filename:o,path:i}))}clearCache(e){var t;if(e){const n=e;this.directoryMapCache.delete(n),this.loadPromiseCache.delete(n);const r=le.getState(),i={...((t=r.ui)==null?void 0:t.directoryMaps)??{}};delete i[n],le.updateState({ui:{...r.ui,directoryMaps:i}})}else{this.directoryMapCache.clear(),this.loadPromiseCache.clear();const n=le.getState();le.updateState({ui:{...n.ui,directoryMaps:{}}})}}}const ya=new Iy;function jn(s,e){const t=s.toLowerCase(),n=e.toLowerCase();if(t==="")return{score:0,matches:[]};let r=0,o=0;const i=[];let c=0,l=0;for(;r<t.length&&o<n.length;)t[r]===n[o]?(i.push(o),l++,c+=1+l,(o===0||/[\s\-_\/\\.]/.test(e[o-1]))&&(c+=10),r++):l=0,o++;if(r!==t.length)return null;if(i.length>0){const d=i[i.length-1]-i[0]-i.length+1;c-=d}return c+=100/(e.length+1),{score:c,matches:i}}function Ay(s,e){if(e.length===0)return[{text:s,isMatch:!1}];const t=[];let n=0;for(const r of e)r>n&&t.push({text:s.substring(n,r),isMatch:!1}),t.push({text:s[r],isMatch:!0}),n=r+1;return n<s.length&&t.push({text:s.substring(n),isMatch:!1}),t}const nn=h.forwardRef(({className:s,viewportClassName:e,children:t,...n},r)=>a.jsxs(Zi,{ref:r,className:B("relative overflow-hidden",s),...n,children:[a.jsx(Xu,{className:B("h-full w-full rounded-[inherit]",e),children:t}),a.jsx(Gl,{}),a.jsx(Qu,{})]}));nn.displayName=Zi.displayName;const Gl=h.forwardRef(({className:s,orientation:e="vertical",...t},n)=>a.jsx(ec,{ref:n,orientation:e,className:B("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...t,children:a.jsx(Zu,{className:"relative flex-1 rounded-full bg-border"})}));Gl.displayName=ec.displayName;const Py=50,Ry=150;function Dy({items:s,selectedIndex:e,renderItem:t,onItemClick:n,onItemHover:r,className:o,height:i="h-[400px]",maxHeight:c,emptyMessage:l="No items found",isLoading:d=!1,loadingMessage:p="Loading...",getItemKey:u,onScrollNearEnd:f}){const m=h.useRef(null),g=h.useRef(null),x=h.useRef(0);h.useEffect(()=>{m.current&&m.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[e]);const w=h.useCallback(C=>{if(!f)return;const S=C.currentTarget;S.scrollHeight-S.scrollTop-S.clientHeight<Py&&f()},[f]),v=h.useCallback(C=>{if(!f)return;const S=C.currentTarget,j=S.scrollHeight-S.scrollTop-S.clientHeight<5,N=C.deltaY>0;if(j&&N){const E=Date.now();E-x.current>Ry&&(x.current=E,f())}},[f]),b=c!==void 0||(i==null?void 0:i.startsWith("max-h-")),y=d?a.jsx("div",{className:"loading-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-loading-state",children:a.jsx("span",{"data-test":"scrollable-list-loading-message",children:p})}):s.length===0?a.jsx("div",{className:"empty-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-empty-state",children:a.jsx("span",{"data-test":"scrollable-list-empty-message",children:l})}):a.jsx("div",{className:"list-items","data-test":"scrollable-list-items",children:s.map((C,S)=>{const j=S===e,N=u?u(C,S):S;return t(C,S,j,N,j?m:void 0,()=>n==null?void 0:n(C,S),()=>r==null?void 0:r(S))})});return b?a.jsx("div",{ref:g,onScroll:w,onWheel:v,className:B("scrollable-list rounded-md border overflow-y-auto",!c&&i,o),style:c?{maxHeight:`${c}px`}:void 0,"data-test":"scrollable-list-container",children:y}):a.jsx(nn,{className:B("scrollable-list rounded-md border",i,o),"data-test":"scrollable-list-container",children:y})}const _y=25,Oy=1,Sa=h.forwardRef(({onFileSelect:s,className:e,maxResults:t=10,placeholder:n="Search files...",mode:r="normal",searchMode:o="filename",cwd:i,externalSearchQuery:c,hideSearchInput:l=!1,onTabComplete:d,onLoadComplete:p},u)=>{const[f,m]=h.useState([]),[g,x]=h.useState([]),[w,v]=h.useState(t),[b,y]=h.useState(""),[C,S]=h.useState(!0),[j,N]=h.useState(0),[E,R]=h.useState(o),D=c??b;h.useEffect(()=>{(async()=>{try{S(!0);const ie=await ya.getAllFilenames(i),K=[];for(const ne of ie){const me=await ya.getFilePath(ne,i);me&&K.push({filename:ne,path:me})}m(K),x(K),v(t)}catch(ie){console.error("Failed to load files:",ie)}finally{S(!1),p==null||p()}})()},[t,i,p]),h.useEffect(()=>{D.startsWith("/")?E!=="fullPath"&&R("fullPath"):E!=="filename"&&R("filename");const V=D.startsWith("/")?D.slice(1):D;if(!V.trim()){x(f),v(t),N(0);return}let ie=f;if(E==="fullPath"){const me=new Set,ge=[];for(const oe of f){ge.push(oe),me.add(oe.path);const Se=oe.path.split("/").filter(Boolean);for(let xe=1;xe<Se.length;xe++){const Pe=Se.slice(0,xe).join("/")+"/";me.has(Pe)||(me.add(Pe),ge.push({filename:Se[xe-1],path:Pe,isDirectory:!0}))}}ie=ge}const K=[];for(const me of ie)if(E==="fullPath"){const ge=jn(V,me.path);ge&&K.push({file:me,score:ge.score,matches:ge.matches})}else{const ge=jn(V,me.filename),oe=jn(V,me.path),Se=ge&&oe?ge.score>oe.score?ge:oe:ge??oe;Se&&K.push({file:me,score:Se.score,matches:Se.matches})}K.sort((me,ge)=>ge.score-me.score);const ne=K.map(me=>me.file);x(ne),v(t),N(0)},[D,f,t,E]);const T=h.useCallback(V=>{s==null||s(V)},[s]),L=h.useCallback(V=>{N(V==="down"?ie=>{const K=Math.min(ie+1,g.length-1);return K>=w-2&&w<g.length&&v(ne=>Math.min(ne+t,g.length)),K}:ie=>Math.max(ie-1,0))},[g.length,w,t]),_=h.useCallback(()=>{g[j]&&T(g[j])},[g,j,T]),P=h.useCallback(()=>{if(!g[j]||!D.startsWith("/"))return null;const V=g[j].path,ie=D.slice(1),K=V.indexOf("/",ie.length);let ne;return K!==-1?ne="/"+V.substring(0,K+1):ne="/"+V,c===void 0&&y(ne),d==null||d(ne),ne},[g,j,D,c,d]),G=h.useCallback(()=>g[j]??null,[g,j]);h.useImperativeHandle(u,()=>({navigate:L,selectCurrent:_,tabComplete:P,getSelectedFile:G}),[L,_,P,G]);const $=h.useCallback(V=>{switch(V.key){case"Tab":V.preventDefault(),P();break;case"ArrowDown":V.preventDefault(),L("down");break;case"ArrowUp":V.preventDefault(),L("up");break;case"Enter":V.preventDefault(),_();break;case"Escape":V.preventDefault(),y("");break}},[L,_,P]),Y=(V,ie)=>{if(!ie.trim())return a.jsx("span",{children:V});const K=jn(ie,V);if(!K)return a.jsx("span",{children:V});const ne=Ay(V,K.matches);return a.jsx("span",{children:ne.map((me,ge)=>a.jsx("span",{className:me.isMatch?"bg-yellow-200 dark:bg-yellow-900 font-semibold":"",children:me.text},ge))})},A=V=>{var ne;const ie=(ne=V.split(".").pop())==null?void 0:ne.toLowerCase(),K="w-4 h-4 flex-shrink-0";return["tsx","ts","jsx","js"].includes(ie??"")?a.jsx($s,{className:B(K,"text-blue-500")}):["json","yml","yaml"].includes(ie??"")?a.jsx($s,{className:B(K,"text-yellow-500")}):["md","txt"].includes(ie??"")?a.jsx($s,{className:B(K,"text-gray-500")}):["css","scss"].includes(ie??"")?a.jsx($s,{className:B(K,"text-purple-500")}):a.jsx($s,{className:B(K,"text-muted-foreground")})},X=V=>V.split("/").slice(0,-1).join("/")||"/",I=r==="compact"||r==="fileNameOnly",k=r==="fileNameOnly",M=D.startsWith("/")?D.slice(1):D,U=g.slice(0,w),q=h.useMemo(()=>Math.max(1,t-Oy)*_y,[t]),W=(V,ie,K,ne,me,ge,oe)=>a.jsxs("button",{ref:me,onClick:ge,onMouseEnter:oe,"data-test":"file-picker-item",className:B("file-item w-full flex items-start hover:bg-accent text-left transition-colors border-b border-border last:border-b-0",I?"px-2 py-1 gap-2":"px-3 py-2 gap-3",K&&"bg-accent"),children:[!k&&(V.isDirectory?a.jsx(Ep,{className:B("w-4 h-4 flex-shrink-0","text-blue-400"),"data-test":"file-picker-item-folder-icon"}):A(V.filename)),a.jsx("div",{className:"file-info flex-1 min-w-0","data-test":"file-picker-item-info",children:E==="fullPath"?a.jsx("div",{className:B("filename font-medium truncate",I?"text-xs":"text-sm"),"data-test":"file-picker-item-path",children:Y(V.path,M)}):a.jsxs("div",{className:B("filename truncate flex items-baseline gap-2",I?"text-xs":"text-sm"),"data-test":"file-picker-item-filename",children:[a.jsx("span",{className:"font-medium flex-shrink-0","data-test":"file-picker-item-name",children:Y(V.filename,M)}),a.jsx("span",{className:B("text-muted-foreground overflow-hidden text-ellipsis whitespace-nowrap",I?"text-[10px]":"text-xs"),style:{direction:"rtl",textAlign:"left"},"data-test":"file-picker-item-directory",children:X(V.path)})]})})]},ne);return a.jsxs("div",{className:B("file-picker flex flex-col",I?"gap-1.5":"gap-3",e),"data-test":"file-picker-container",children:[!l&&a.jsxs("div",{className:"search-input-wrapper relative","data-test":"file-picker-search-wrapper",children:[a.jsx(cr,{className:B("absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none",I?"w-3 h-3":"w-4 h-4"),"data-test":"file-picker-search-icon"}),a.jsx(We,{type:"text",value:D,onChange:V=>y(V.target.value),onKeyDown:$,placeholder:n,className:B("search-input pl-9",I&&"h-8 text-xs"),autoFocus:!c,"data-test":"file-picker-search-input"})]}),!k&&a.jsx("div",{className:B("results-info text-xs text-muted-foreground",I?"px-0.5":"px-1"),"data-test":"file-picker-results-info",children:C?a.jsx("span",{"data-test":"file-picker-loading-text",children:"Loading files..."}):a.jsxs("span",{"data-test":"file-picker-results-text",children:["Showing ",U.length," of ",g.length," results",g.length<f.length&&` (filtered from ${f.length} total)`]})}),a.jsx(Dy,{items:U,selectedIndex:j,renderItem:W,onItemClick:V=>T(V),onItemHover:V=>N(V),getItemKey:V=>V.path,maxHeight:q,onScrollNearEnd:()=>{w<g.length&&v(V=>Math.min(V+t,g.length))},className:"file-list",emptyMessage:"No files found",isLoading:C,loadingMessage:"Loading files...","data-test":"file-picker-file-list"}),!k&&!l&&a.jsxs("div",{className:B("keyboard-hints text-muted-foreground flex",I?"text-[10px] px-0.5 gap-2":"text-xs px-1 gap-4"),"data-test":"file-picker-keyboard-hints",children:[a.jsxs("span",{"data-test":"file-picker-hint-navigate",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"â†‘â†“"})," Navigate"]}),a.jsxs("span",{"data-test":"file-picker-hint-autocomplete",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Tab"})," Autocomplete"]}),a.jsxs("span",{"data-test":"file-picker-hint-select",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Enter"})," Select"]}),a.jsxs("span",{"data-test":"file-picker-hint-clear",children:[a.jsx("kbd",{className:B("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Esc"})," Clear"]})]})]})});Sa.displayName="FilePicker";const Dn="â€‹";function Zn(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Xt(s){const e=[];let t=0,n=s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(r,o,i)=>{const c=`LINKPLACEHOLDER${t}END`,l=Zn(o),d=`<a href="${i}" class="text-primary underline hover:text-primary/80 cursor-pointer" target="_blank" rel="noopener noreferrer">${l}</a>`;return e.push({placeholder:c,html:d}),t++,c});n=Zn(n).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(new RegExp("(?<!\\w)__(.+?)__(?!\\w)","g"),"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(new RegExp("(?<!\\w)_(.+?)_(?!\\w)","g"),"<em>$1</em>").replace(/~~(.+?)~~/g,"<del>$1</del>").replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm font-mono">$1</code>');for(const{placeholder:r,html:o}of e)n=n.replace(r,o);return n}function _r(s){function e(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent||"";if(t.nodeType===Node.ELEMENT_NODE){const n=t,r=n.tagName.toLowerCase(),o=Array.from(t.childNodes).map(e).join("");switch(r){case"strong":case"b":return`**${o}**`;case"em":case"i":return`*${o}*`;case"del":case"s":return`~~${o}~~`;case"code":return`\`${o}\``;case"a":{const i=n.getAttribute("href")||"";return`[${o}](${i})`}default:return o}}return""}return Array.from(s.childNodes).map(e).join("").trim()}function ja(s){const e=s.trim(),t=e.startsWith("|")?e.slice(1):e;return(t.endsWith("|")?t.slice(0,-1):t).split("|").map(r=>r.trim())}function ql(s){return ja(s).every(t=>/^:?-+:?$/.test(t))}function ui(s){if(s.length<2)return s.map(Zn).join("<br>");const e=s.findIndex(o=>ql(o));if(e===-1||e===0)return s.map(Zn).join("<br>");const t=s.slice(0,e),n=s.slice(e+1);let r='<table class="markdown-table border-collapse w-full my-2" data-test="markdown-table">';if(t.length>0){r+="<thead>";for(const o of t){const i=ja(o);r+="<tr>";for(const c of i)r+=`<th class="border border-border px-2 py-1 h-6 bg-muted font-medium text-left">${Xt(c)}</th>`;r+="</tr>"}r+="</thead>"}if(n.length>0){r+="<tbody>";for(const o of n){if(!o.trim())continue;const i=ja(o);r+="<tr>";for(const c of i)r+=`<td class="border border-border px-2 py-1 h-6">${Xt(c)}</td>`;r+="</tr>"}r+="</tbody>"}return r+="</table>",r}function Ly(s){const e=s.split(`
`),t=[];let n=[],r=!1;for(let i=0;i<e.length;i++){const c=e[i];if(c.trim().startsWith("|")||c.includes("|")&&ql(c))r||(r=!0),n.push(c);else{if(r){const d=ui(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(d),n=[],r=!1}t.push(c)}}if(r&&n.length>0){const i=ui(n);t.push(`__TABLE_PLACEHOLDER_${t.length}__`),t.push(i)}const o=[];for(let i=0;i<t.length;i++)t[i].startsWith("__TABLE_PLACEHOLDER_")?i+1<t.length&&(o.push(t[i+1]),i++):o.push(t[i]);return o.join(`
`)}function My(s){const e=[];let t=!1;const n=s.querySelector("thead");if(n){t=!0;const c=n.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("th, td")).map(p=>_r(p));e.push(d)}}const r=s.querySelector("tbody");if(r){const c=r.querySelectorAll("tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>_r(p));e.push(d)}}if(!n&&!r){const c=s.querySelectorAll(":scope > tr");for(const l of c){const d=Array.from(l.querySelectorAll("td, th")).map(p=>_r(p));e.push(d)}}if(e.length===0)return"";const o=[],i=Math.max(...e.map(c=>c.length));for(let c=0;c<e.length;c++){const l=e[c];for(;l.length<i;)l.push("");o.push("| "+l.join(" | ")+" |"),t&&c===0&&o.push("| "+l.map(()=>"---").join(" | ")+" |")}if(!t&&e.length>0){const c=e[0];o.splice(1,0,"| "+c.map(()=>"---").join(" | ")+" |")}return o.join(`
`)+`
`}function at(s){if(!s)return"";const e=Ly(s),t=[],r=e.replace(/<table[\s\S]*?<\/table>/g,c=>(t.push(c),`MARKDOWNTABLEPLACEHOLDER${t.length-1}ENDPLACEHOLDER`)).split(`
`),o=[];for(let c=0;c<r.length;c++){const l=r[c],d=/^# (.+)$/.test(l),p=/^## (.+)$/.test(l),u=/^### (.+)$/.test(l),f=/^- (.+)$/.test(l),m=/^(\d+)\. (.+)$/.test(l),g=/^> (.+)$/.test(l),x=/^---$/.test(l),w=/^MARKDOWNTABLEPLACEHOLDER\d+ENDPLACEHOLDER$/.test(l),v=l==="";let b;if(u){const y=l.replace(/^### (.+)$/,"$1");b=`<h3>${Xt(y)}</h3>`}else if(p){const y=l.replace(/^## (.+)$/,"$1");b=`<h2>${Xt(y)}</h2>`}else if(d){const y=l.replace(/^# (.+)$/,"$1");b=`<h1>${Xt(y)}</h1>`}else if(g){const y=l.replace(/^> (.+)$/,"$1");b=`<blockquote class="border-l-2 border-muted-foreground/30 pl-3 m-0 text-muted-foreground italic">${Xt(y)}</blockquote>`}else if(x)b='<hr class="border-t border-muted-foreground/30 m-0">';else if(f){const y=l.replace(/^- (.+)$/,"$1"),C=c>0?r[c-1]:"";b=`<div class="${!(/^- /.test(C)||/^\d+\. /.test(C))&&c>0?"mt-[1lh] ":""}list-item-ul flex"><span class="mr-1.5">â€¢</span><span>${Xt(y)}</span></div>`}else if(m){const y=l.match(/^(\d+)\. (.+)$/),C=y[1],S=y[2],j=c>0?r[c-1]:"";b=`<div class="${!(/^- /.test(j)||/^\d+\. /.test(j))&&c>0?"mt-[1lh] ":""}list-item-ol flex"><span class="mr-1.5">${C}.</span><span>${Xt(S)}</span></div>`}else w?b=l:v?b='<div class="empty-line"><br></div>':b=`<div class="paragraph">${Xt(l)}</div>`;o.push(b)}let i=o.join("");for(let c=0;c<t.length;c++)i=i.replace(`MARKDOWNTABLEPLACEHOLDER${c}ENDPLACEHOLDER`,t[c]);return i}function ps(s){if(!s)return"";const e=document.createElement("div");e.innerHTML=s.replace(new RegExp(Dn,"g"),"");function t(c,l=!1){if(c.nodeType===Node.TEXT_NODE)return c.textContent||"";if(c.nodeType===Node.ELEMENT_NODE){const d=c,p=d.tagName.toLowerCase(),u=Array.from(c.childNodes).map(f=>t(f,!1)).join("");switch(p){case"strong":case"b":return`**${u}**`;case"em":case"i":return`*${u}*`;case"del":case"s":return`~~${u}~~`;case"code":return`\`${u}\``;case"a":{const f=d.getAttribute("href")||"";return`[${u}](${f})`}case"br":return`
`;case"blockquote":return`> ${u}
`;case"h1":return`# ${u}
`;case"h2":return`## ${u}
`;case"h3":return`### ${u}
`;case"table":return My(d);case"div":case"p":if(d.classList.contains("list-item-ul")){const f=d.querySelector("span:last-child");return`- ${f?f.textContent||"":u}
`}if(d.classList.contains("list-item-ol")){const f=d.querySelector("span:first-child"),m=d.querySelector("span:last-child"),g=f?(f.textContent||"1.").replace(".",""):"1",x=m?m.textContent||"":u;return`${g}. ${x}
`}if(d.classList.contains("paragraph"))return u+`
`;if(d.classList.contains("empty-line")){const f=d.textContent||"";return f.trim()?f+`
`:`
`}return l?u:u?u+`
`:"";case"span":return d.classList.contains("text-2xl")?`# ${u}`:d.classList.contains("text-xl")?`## ${u}`:d.classList.contains("text-lg")?`### ${u}`:u;default:return u}}return""}const n=t(e,!0);let r=0;const o=Array.from(e.children);for(let c=o.length-1;c>=0;c--){const l=o[c];if(l.classList.contains("empty-line"))if(!(l.textContent||"").trim())r++;else break;else break}return r>0?n.replace(/\n+$/,"")+`
`.repeat(r):n.replace(/\n+$/,"")}const mt={a:["a","Ã¡","Ã ","áº£","Ã£","áº¡","Äƒ","áº¯","áº±","áº³","áºµ","áº·","Ã¢","áº¥","áº§","áº©","áº«","áº­"],A:["A","Ã","Ã€","áº¢","Ãƒ","áº ","Ä‚","áº®","áº°","áº²","áº´","áº¶","Ã‚","áº¤","áº¦","áº¨","áºª","áº¬"],e:["e","Ã©","Ã¨","áº»","áº½","áº¹","Ãª","áº¿","á»","á»ƒ","á»…","á»‡"],E:["E","Ã‰","Ãˆ","áºº","áº¼","áº¸","ÃŠ","áº¾","á»€","á»‚","á»„","á»†"],i:["i","Ã­","Ã¬","á»‰","Ä©","á»‹"],I:["I","Ã","ÃŒ","á»ˆ","Ä¨","á»Š"],o:["o","Ã³","Ã²","á»","Ãµ","á»","Ã´","á»‘","á»“","á»•","á»—","á»™","Æ¡","á»›","á»","á»Ÿ","á»¡","á»£"],O:["O","Ã“","Ã’","á»Ž","Ã•","á»Œ","Ã”","á»","á»’","á»”","á»–","á»˜","Æ ","á»š","á»œ","á»ž","á» ","á»¢"],u:["u","Ãº","Ã¹","á»§","Å©","á»¥","Æ°","á»©","á»«","á»­","á»¯","á»±"],U:["U","Ãš","Ã™","á»¦","Å¨","á»¤","Æ¯","á»¨","á»ª","á»¬","á»®","á»°"],y:["y","Ã½","á»³","á»·","á»¹","á»µ"],Y:["Y","Ã","á»²","á»¶","á»¸","á»´"],d:["d","Ä‘"],D:["D","Ä"]},Fy={s:"acute",f:"grave",r:"hook",x:"tilde",j:"dot"},$y={w:"horn",aa:"circumflex",aw:"breve",ee:"circumflex",oo:"circumflex",ow:"horn",uw:"horn",dd:"stroke"},Cs={a:null,e:null,i:null,o:null,u:null,y:null,d:null,Äƒ:null,Ã¢:null,Ãª:null,Ã´:null,Æ¡:null,Æ°:null,Ä‘:null,Ã¡:"s",áº¯:"s",áº¥:"s",Ã©:"s",áº¿:"s",Ã­:"s",Ã³:"s",á»‘:"s",á»›:"s",Ãº:"s",á»©:"s",Ã½:"s",Ã :"f",áº±:"f",áº§:"f",Ã¨:"f",á»:"f",Ã¬:"f",Ã²:"f",á»“:"f",á»:"f",Ã¹:"f",á»«:"f",á»³:"f",áº£:"r",áº³:"r",áº©:"r",áº»:"r",á»ƒ:"r",á»‰:"r",á»:"r",á»•:"r",á»Ÿ:"r",á»§:"r",á»­:"r",á»·:"r",Ã£:"x",áºµ:"x",áº«:"x",áº½:"x",á»…:"x",Ä©:"x",Ãµ:"x",á»—:"x",á»¡:"x",Å©:"x",á»¯:"x",á»¹:"x",áº¡:"j",áº·:"j",áº­:"j",áº¹:"j",á»‡:"j",á»‹:"j",á»:"j",á»™:"j",á»£:"j",á»¥:"j",á»±:"j",á»µ:"j"};Object.keys(Cs).forEach(s=>{const e=s.toUpperCase(),t=Cs[s];e!==s&&(Cs[e]=t)});function is(s,e){const t=s.toLowerCase();switch(e){case"breve":return["Äƒ","áº¯","áº±","áº³","áºµ","áº·"].includes(t);case"circumflex":return["Ã¢","áº¥","áº§","áº©","áº«","áº­","Ãª","áº¿","á»","á»ƒ","á»…","á»‡","Ã´","á»‘","á»“","á»•","á»—","á»™"].includes(t);case"horn":return["Æ¡","á»›","á»","á»Ÿ","á»¡","á»£","Æ°","á»©","á»«","á»­","á»¯","á»±"].includes(t);case"stroke":return["Ä‘"].includes(t);default:return!1}}function Ns(s){return s in Fy}function er(s){return s==="w"||s==="a"||s==="e"||s==="o"||s==="u"||s==="d"}function Zt(s){const e=s.toLowerCase();if(mt[e]!==void 0&&e!=="d")return e;for(const t of["a","e","i","o","u","y"])if(mt[t].includes(e))return t;return null}function Uy(s,e,t){const n=s.substring(e,t).toLowerCase(),r=[];for(let o=0;o<n.length;o++){const i=n[o],c=Zt(i);c!==null&&r.push({char:i,pos:e+o,base:c})}if(r.length===0)return-1;if(r.length===1)return r[0].pos;if(r.length===2){const o=r[0].base,i=r[1].base,c=r[1].char;return o==="o"&&["a","e"].includes(i)||o==="u"&&i==="y"||["Ãª","Ã´","Æ¡"].includes(c)?r[1].pos:r[0].pos}return r.length>=3?r[1].pos:r[r.length-1].pos}function ds(s){return s?/[\s.,;:!?()[\]{}'"<>\/\\-]/.test(s):!0}function Ca(s,e){return s==="a"&&e.includes("a")&&e.includes("w")||s==="a"&&e.includes("w")&&!e.includes("a")?"aw":s==="o"&&e.includes("w")?"ow":s==="u"&&e.includes("w")?"uw":s==="a"&&e.includes("a")?"aa":s==="e"&&e.includes("e")?"ee":s==="o"&&e.includes("o")?"oo":s==="d"&&e.includes("d")?"dd":e.includes("w")?"w":null}function By(s){const e=$y[s];return e==="breve"?"breve":e.includes("circumflex")?"circumflex":e.includes("horn")?"horn":e==="stroke"?"stroke":null}function js(s,e){const t=mt[s]||[];if(!e||e===s)return t;const n=e.slice(s.length).toLowerCase();let r=null;n.includes("s")?r="s":n.includes("j")?r="j":n.includes("r")?r="r":n.includes("x")?r="x":n.includes("f")&&(r="f");const o=Ca(s,n),i=o?By(o):null;return t.filter(c=>!(r!==null&&Cs[c]!==r||i&&!is(c,i)))}function Wy(s){const e=s.toLowerCase();if(mt[e]!==void 0)return!1;for(const t in mt)if(mt[t].includes(e))return!0;return!1}function pi(s){const e=s.toLowerCase();for(const t in mt)if(mt[t].includes(e))return t;return s}function zy(s,e){let t=-1,n="";const r=s.charAt(e-1).toLowerCase();if(Ns(r)){let o=0;for(let i=e-2;i>=0;i--)if(ds(s.charAt(i))){o=i+1;break}for(let i=o;i<e-1;i++){const c=s.charAt(i),l=Zt(c);if(l)return{sequenceStart:o,detectedBaseChar:l,found:!0}}}if(er(r)){if(r==="w")for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(ds(i))break;if(i==="o"&&o>0&&s.charAt(o-1).toLowerCase()==="u")return{sequenceStart:o-1,detectedBaseChar:"u",found:!0}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(ds(i))break;const c=Zt(i);if((i===r||c===r)&&mt[r])return{sequenceStart:o,detectedBaseChar:r,found:!0}}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase(),c=Zt(i);if(mt[i]||c){if(c!==null&&c!==i&&!(Ns(r)||r===c||r==="w"))return{sequenceStart:-1,detectedBaseChar:"",found:!1};if(t=o,n=c||i,o>0){const p=s.charAt(o-1).toLowerCase(),u=Zt(p);(p===n||u===n)&&mt[n]&&(t=o-1)}const d=s.slice(t+1,e-1).toLowerCase();for(const p of d)if(!Ns(p)&&!er(p)&&p!==n)return{sequenceStart:-1,detectedBaseChar:"",found:!1};break}}return{sequenceStart:t,detectedBaseChar:n,found:t>=0}}function Hy(s){const e=s.slice(0,-1);return/\s/.test(e)}function Gy(s,e,t,n,r){const o=s.slice(t,e).toLowerCase(),i=s.charAt(e-1).toLowerCase();if(e>=2&&s.charAt(e-2),Ns(i)){let d=0;for(let u=e-2;u>=0;u--)if(ds(s.charAt(u))){d=u+1;break}s.substring(d,e-1);const p=Uy(s,d,e-1);if(p>=0){const u=s.charAt(p),f=u.toLowerCase(),m=pi(f);if(mt[m]){let g="";is(f,"breve")?g="w":is(f,"circumflex")?g=m:is(f,"horn")&&(g="w");const x=m+g+i,w=js(m,x);if(w.length>0){const v=w[0],b=u===u.toUpperCase()?v.toUpperCase():v,y=s.substring(0,p),C=s.substring(p+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:y+b+C+S,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let u=e-2;u>=Math.max(0,e-6);u--){const f=s.charAt(u);if(ds(f))break;if(Wy(f)){const m=pi(f);let g="";const x=f.toLowerCase();is(x,"breve")?g="w":is(x,"circumflex")?g=m:is(x,"horn")&&(g="w");const w=m+g+i,v=js(m,w);if(v.length>0){const b=v[0],y=s.substring(0,u),C=s.substring(u+1,e-1),S=s.substring(e);return{type:"auto-complete",replacement:y+b+C+S,newCursorPos:e-1,realTimeReplacement:!0}}}if(mt[f.toLowerCase()])break}}if(er(i)){if(i==="w"){if(s.substring(0,e),n==="u"){const g=s.substring(t,e).toLowerCase();if(g.startsWith("uo")){const x=g.substring(2,g.length-1),w=s.substring(0,t),v=s.substring(e);return{type:"auto-complete",replacement:w+"Æ°Æ¡"+x+v,newCursorPos:t+2+x.length,realTimeReplacement:!0}}}const d=o.toLowerCase();if(d==="uow"||d.endsWith("uow")){const g=s.substring(0,t),x=s.substring(e);return{type:"auto-complete",replacement:g+"Æ°Æ¡"+x,newCursorPos:t+2,realTimeReplacement:!0}}let p=0;for(let g=e-2;g>=0;g--)if(ds(s.charAt(g))){p=g+1;break}const u=s.substring(p,e-1);let f=-1,m="";for(let g=u.length-1;g>=0;g--){const x=u[g];if(Zt(x.toLowerCase())==="a"){f=p+g,m="a";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(Zt(x.toLowerCase())==="o"){f=p+g,m="o";break}}if(f===-1)for(let g=u.length-1;g>=0;g--){const x=u[g];if(Zt(x.toLowerCase())==="u"){f=p+g,m="u";break}}if(f>=0){const g=s.charAt(f),x=g.toLowerCase(),w=Cs[x];let v=m;v+="w",w&&(v+=w);const b=js(m,v);if(b.length>0){const y=b[0],C=g===g.toUpperCase()?y.toUpperCase():y,S=s.substring(0,f),j=s.substring(f+1,e-1),N=s.substring(e);return{type:"auto-complete",replacement:S+C+j+N,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let d=e-2;d>=Math.max(0,e-6);d--){const p=s.charAt(d).toLowerCase();if(ds(p))break;const u=Zt(p);if((p===i||u===i)&&mt[i]){const f=i+i;if(Ca(i,f)){const g=Cs[p],x=g?f+g:f,w=js(i,x);if(w.length>0){const v=w[0],b=s.substring(0,d),y=s.substring(d+1,e-1),C=s.substring(e);return{type:"auto-complete",replacement:b+v+y+C,newCursorPos:e-1,realTimeReplacement:!0}}}break}}}if(Hy(o))return{type:"terminate"};const c=Ns(i)||er(i);let l=!1;if(c)if(Ns(i))l=!0;else{const d=o.slice(n.length).toLowerCase();Ca(n,d)===null?(e>=2&&s.charAt(e-2).toLowerCase(),t<e-1&&s.charAt(t).toLowerCase()===i&&(l=!0)):l=!0}if(l){const d=js(n,o);if(d.length>0){const p=d[0],u=s.substring(0,t),f=s.substring(e);return{type:"auto-complete",replacement:u+p+f,newCursorPos:t+1,realTimeReplacement:!0}}return{type:"terminate"}}else return qy(s,e,t,n,o)}function qy(s,e,t,n,r){const i=(t>0?s.charAt(t-1).toLowerCase():"")+r;if(i==="uown"||i==="uow"){const l=s.substring(0,t-1),d=s.substring(e),p=s.charAt(e-1);return{type:"auto-complete",replacement:l+"Æ°Æ¡"+p+d,newCursorPos:t-1+2+1}}const c=js(n,r.slice(0,-1));if(c.length>0){const l=c[0],d=s.substring(0,t),p=s.substring(e),u=s.charAt(e-1);return{type:"auto-complete",replacement:d+l+u+p,newCursorPos:t+1+1}}return{type:"terminate"}}function eN(s){return s!==""&&mt[s]!==void 0}function tN(s,e,t,n){const r=t-1;switch(e){case"right":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===c?i:s+1}case"left":{const i=Math.floor(s/n)*n,c=Math.min(i+n-1,r);return s===i?c:s-1}case"down":{const o=s%n,i=Math.floor(s/n),c=Math.ceil((r+1)/n),l=i+1;if(l>=c){const d=o;return d<=r?d:s}else{const d=l*n+o;return d<=r?d:s}}case"up":{const o=s%n,i=Math.floor(s/n);if(i===0){const d=(Math.ceil((r+1)/n)-1)*n+o;return d<=r?d:s}else return(i-1)*n+o}default:return s}}function hi(s){let e=s.replace(/<strong>([^<]*)<\/strong>/g,"**$1**");return e=e.replace(/<em>([^<]*)<\/em>/g,"*$1*"),e=e.replace(/<code>([^<]*)<\/code>/g,"`$1`"),e=e.replace(/<[^>]+>/g,""),e}function Vl(s){const e=[],t=[],n=/<th[^>]*>([\s\S]*?)<\/th>/g;let r;for(;(r=n.exec(s))!==null;)e.push(hi(r[1]));const o=s.match(/<tbody>([\s\S]*?)<\/tbody>/);if(o){const i=/<tr>([\s\S]*?)<\/tr>/g;let c;for(;(c=i.exec(o[1]))!==null;){const l=/<td[^>]*>([\s\S]*?)<\/td>/g,d=[];let p;for(;(p=l.exec(c[1]))!==null;)d.push(hi(p[1]));d.length>0&&t.push(d)}}return{headerCells:e,bodyCells:t}}function Kl(s){const{headerCells:e,bodyCells:t}=Vl(s);let n=0,r=0;if(e.length>0){const o=e.reduce((i,c)=>i+c.length,0);n+=2+o+(e.length-1)*3+2+1,r++,n+=2+e.length*1+(e.length-1)*3+2+1,r++}for(const o of t){const i=o.reduce((c,l)=>c+l.length,0);n+=2+i+(o.length-1)*3+2+1,r++}return{markdownLength:n,lineCount:r}}function Jl(s){const{headerCells:e,bodyCells:t}=Vl(s),n=[];let r=0,o=0;if(e.length>0){r+=2;for(let i=0;i<e.length;i++){const c=e[i],l=c.trim().length>0;n.push({markdownStart:r,content:c,textNodeIndex:l?o:-1,isEmpty:!l,rowIndex:0,colIndex:i}),l&&o++,r+=c.length,i<e.length-1&&(r+=3)}r+=3,r+=2;for(let i=0;i<e.length;i++)r+=1,i<e.length-1&&(r+=3);r+=3}for(let i=0;i<t.length;i++){const c=t[i];r+=2;for(let l=0;l<c.length;l++){const d=c[l],p=d.trim().length>0;n.push({markdownStart:r,content:d,textNodeIndex:p?o:-1,isEmpty:!p,rowIndex:i+1,colIndex:l}),p&&o++,r+=d.length,l<c.length-1&&(r+=3)}r+=2,i<t.length-1&&(r+=1)}return{cells:n,totalLength:r}}function Na(s){var oe,Se,xe,Pe,ae;const e=window.getSelection();if(!e||e.rangeCount===0)return{text:ps(s.innerHTML),cursorPos:0};const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");r.appendChild(n.cloneContents());const o=Array.from(r.children).filter(te=>{const F=te.tagName.toLowerCase();return F==="h1"||F==="h2"||F==="h3"||F==="div"||F==="blockquote"||F==="hr"||F==="table"}),i=r.querySelectorAll(".empty-line"),c=Array.from(i).filter(te=>{var Z;return(((Z=te.textContent)==null?void 0:Z.trim())||"").length===0});let l=0;const d=t.startContainer;if(d.nodeType===Node.ELEMENT_NODE)(oe=d.classList)!=null&&oe.contains("empty-line")&&(l=1);else if(d.nodeType===Node.TEXT_NODE){const te=d.parentElement;(Se=te==null?void 0:te.classList)!=null&&Se.contains("empty-line")&&(l=1)}const p=o.filter(te=>!te.classList.contains("empty-line")),u=c.length,f=(p.length>0?p.length-1:0)+u+l;let m=0;r.querySelectorAll("h1").forEach(()=>{m+=2}),r.querySelectorAll("h2").forEach(()=>{m+=3}),r.querySelectorAll("h3").forEach(()=>{m+=4}),r.querySelectorAll("blockquote").forEach(()=>{m+=2}),r.querySelectorAll("hr").forEach(()=>{m+=3});const g=r.querySelectorAll("h1, h2, h3, blockquote, hr"),x=s.querySelectorAll("h1, h2, h3, blockquote, hr");let w=!1;const v=t.startContainer;for(const te of x)if(te.contains(v)){w=!0;break}const b=s.querySelectorAll(".list-item-ul, .list-item-ol");for(const te of b)if(te.contains(v))break;const y=s.querySelectorAll("table");let C=null,S=null;for(const te of y)if(te.contains(v)){C=te;const F=te.querySelectorAll("th, td");for(const Z of F)if(Z.contains(v)||Z===v){S=Z;break}break}const j=0;let N=0;x.forEach(te=>{var Z;const F=te.nextSibling||te.nextElementSibling;if(F){const H=F.nodeName==="BR"||F.nodeType===Node.ELEMENT_NODE&&F.tagName==="BR",ce=F.nodeType===Node.ELEMENT_NODE&&((Z=F.classList)==null?void 0:Z.contains("empty-line")),ue=F.nodeType===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(F.tagName);!H&&!ce&&!ue&&(N+=1)}});let E=g.length;w&&E>0&&(E-=1);const R=Math.min(N,E);m+=R;const D=r.querySelectorAll(":scope > div:not(.list-item-ul):not(.list-item-ol):not(.empty-line):not(.paragraph)");r.querySelectorAll("h1, h2, h3, blockquote, hr, .list-item-ul, .list-item-ol, .paragraph").length===0&&D.length>1&&(m+=D.length-1);const L=r.querySelectorAll(".list-item-ul");L.forEach(()=>{m+=1});const _=r.querySelectorAll(".list-item-ol");_.forEach(()=>{m+=1});const P=L.length+_.length;if(P>1&&(m+=P-1),P>0){let F=(_.length>0?_[_.length-1]:L[L.length-1]).nextSibling;for(;F;){if(F.nodeType===Node.TEXT_NODE){const Z=(xe=F.textContent)==null?void 0:xe.replace(new RegExp(Dn,"g"),"").trim();if(Z&&Z.length>0){m+=1;break}}else if(F.nodeType===Node.ELEMENT_NODE)break;F=F.nextSibling}}const $=(r.textContent||"").replace(new RegExp(Dn,"g"),""),A=Array.from(r.querySelectorAll(".empty-line")).filter(te=>{var Z;return(((Z=te.textContent)==null?void 0:Z.trim())||"").length>0}).length;let X=0;const I=te=>{const F=r.querySelectorAll(te);let Z=0;for(const H of F)!H.closest("table")&&H.textContent&&H.textContent.length>0&&Z++;return Z};X+=I("strong, b")*4,X+=I("em, i")*2,X+=I("code")*2,X+=I("del, s")*4;let k=0;const M=r.querySelectorAll("table");M.forEach(te=>{var H,ce;const F=te.outerHTML,Z=te===M[M.length-1];if(C&&S&&Z){const pe=Array.from(C.querySelectorAll("th, td")).findIndex(ve=>ve===S||ve.contains(v)),he=Array.from(te.querySelectorAll("th, td"));if(pe>=0){const ve=Jl(F);if(pe<ve.cells.length){const Te=ve.cells[pe],ke=t.startOffset,z=Te.markdownStart+ke;let O=0;for(let Q=0;Q<pe;Q++)O+=((H=he[Q].textContent)==null?void 0:H.length)||0;O+=ke,k+=z-O}}}else{const{markdownLength:ue}=Kl(F),pe=(te.textContent||"").length;k+=ue-pe;const he=te.nextSibling||te.nextElementSibling,ve=(he==null?void 0:he.nodeName)==="BR"||(he==null?void 0:he.nodeType)===Node.ELEMENT_NODE&&he.tagName==="BR",Te=!he||he.nodeType===Node.TEXT_NODE&&!((ce=he.textContent)!=null&&ce.trim()),ke=(he==null?void 0:he.nodeType)===Node.ELEMENT_NODE&&["H1","H2","H3","DIV","BLOCKQUOTE","HR","TABLE"].includes(he.tagName);!ve&&!Te&&!ke&&(k+=1),ke&&(k-=1)}});const U=$.length+f+m+A+k+X+j;let q=ps(s.innerHTML);const V=s.innerHTML.replace(new RegExp(Dn+"$"),""),ie=/(<br>)+$/.exec(V);if(ie){const te=(ie[0].match(/<br>/g)||[]).length,F=(/\n+$/.exec(q)||[""])[0].length,Z=te-F;Z>0&&(q=q+`
`.repeat(Z))}const K=t.startContainer.nodeType===Node.TEXT_NODE&&t.startContainer.textContent==="â€‹",ne=K&&(((ae=(Pe=t.startContainer.parentElement)==null?void 0:Pe.classList)==null?void 0:ae.contains("empty-line"))??!1),ge=U+(K&&!ne?-1:0);return{text:q,cursorPos:ge}}function Vy(s){const e=s.match(/<th[^>]*>([^<]*)<\/th>/g)||[],t=s.match(/<td[^>]*>([^<]*)<\/td>/g)||[],n=s.match(/<th[^>]*>(?=.*\S)[\s\S]*?<\/th>/g)||[],r=s.match(/<td[^>]*>(?=.*\S)[\s\S]*?<\/td>/g)||[];let o=0;const i=[...new Set([...e,...n])],c=[...new Set([...t,...r])];for(const l of i)l.replace(/<[^>]+>/g,"").trim().length>0&&o++;for(const l of c)l.replace(/<[^>]+>/g,"").trim().length>0&&o++;return o}function Ky(s){const e=/<table[^>]*>[\s\S]*?<\/table>/g,t=[];let n=s,r=0,o;for(;(o=e.exec(s))!==null;){const i=o[0],{markdownLength:c,lineCount:l}=Kl(i),d=Vy(i);t.push({start:o.index-r,end:o.index+i.length-r,markdownLength:c,lineCount:l,textNodeCount:d,html:i});const p=`__TABLE_${t.length-1}__`;n=n.slice(0,o.index-r)+p+n.slice(o.index+i.length-r),r+=i.length-p.length}return{processedHtml:n,tables:t}}function Jy(s){return s==="<strong>"||s==="</strong>"||s==="<b>"||s==="</b>"?{type:"formatting",markdownChars:2}:s==="<em>"||s==="</em>"||s==="<i>"||s==="</i>"?{type:"formatting",markdownChars:1}:s.startsWith("<code")||s==="</code>"?{type:"formatting",markdownChars:1}:s==="<del>"||s==="</del>"||s==="<s>"||s==="</s>"?{type:"formatting",markdownChars:2}:null}function Yy(s){const{processedHtml:e,tables:t}=Ky(s),n=[];let r=0,o=0,i=0,c=0,l=!1,d=!1,p=!1,u=null;const f=/(__TABLE_(\d+)__)|(<div class="empty-line"><br><\/div>)|(<br>)|(<h([123])>)|(<blockquote[^>]*>)|(<div[^>]*(list-item-(ul|ol))[^>]*>)|(<[^>]+>)|([^<]+)/g;let m;for(;(m=f.exec(e))!==null;)if(m[1]){const g=parseInt(m[2],10),x=t[g];n.push({type:"table",tableIndex:g,markdownLength:x.markdownLength,lineCount:x.lineCount,textNodeCount:x.textNodeCount})}else if(m[3])n.push({type:"br-empty-line",index:i++});else if(m[4])n.push({type:"br-standalone",index:o++});else if(m[5]){const g=parseInt(m[6],10);n.push({type:"header",level:g}),u=g}else if(m[7])n.push({type:"blockquote"});else if(m[8]){const g=m[10];n.push({type:"list-item-start",listType:g,index:c++}),l=g==="ol",p=!0}else if(m[11]){const g=m[11].toLowerCase(),x=m[11],w=Jy(g);w&&n.push(w),(x.includes('class="paragraph"')||x.includes("class='paragraph'"))&&(d=!0),x==="</div>"&&(l=!1,d&&(n.push({type:"block-end"}),d=!1),p&&(n.push({type:"block-end"}),p=!1)),/^<\/h[123]>$/.test(x)&&(u=null,n.push({type:"block-end"})),x==="</blockquote>"&&n.push({type:"block-end"})}else if(m[12]){const g=m[12];if(/^\s+$/.test(g)){r++,n.push({type:"whitespace",length:g.length});continue}const x=g==="â€¢",w=l&&/^\d+\.$/.test(g),v=u!==null,b=u;v&&(u=null),n.push({type:"text",content:g,index:r++,isBullet:x,isOlNumber:w,isHeaderText:v,headerLevel:b}),l&&(l=!1)}return{tokens:n,tables:t,processedHtml:e}}function Xy(s,e,t,n,r,o){const i=s-e,c=Jl(t.html);for(let l=0;l<c.cells.length;l++){const d=c.cells[l],p=d.markdownStart,u=p+d.content.length;if(i>=p&&i<=u){if(d.isEmpty)return{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in empty table cell at row ${d.rowIndex}, col ${d.colIndex}`,emptyCellIndex:l,emptyCellRow:d.rowIndex,emptyCellCol:d.colIndex};const f=i-p;return{nodeType:"text",nodeIndex:n+d.textNodeIndex,offset:Math.min(f,d.content.length),expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is within table cell "${d.content.substring(0,20)}" at offset ${f}`}}}if(c.cells.length>0){const l=c.cells[c.cells.length-1],d=l.markdownStart+l.content.length;if(i>=d)return l.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is after last (empty) table cell at row ${l.rowIndex}, col ${l.colIndex}`,emptyCellIndex:c.cells.length-1,emptyCellRow:l.rowIndex,emptyCellCol:l.colIndex}:{nodeType:"text",nodeIndex:n+l.textNodeIndex,offset:l.content.length,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is past last table cell, placing at end of "${l.content.substring(0,20)}"`};{for(let f=0;f<c.cells.length;f++){const m=c.cells[f],g=f>0?c.cells[f-1].markdownStart+c.cells[f-1].content.length:0;if(i>=g&&i<m.markdownStart)return m.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before empty table cell at row ${m.rowIndex}, col ${m.colIndex}`,emptyCellIndex:f,emptyCellRow:m.rowIndex,emptyCellCol:m.colIndex}:{nodeType:"text",nodeIndex:n+m.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in padding before cell "${m.content.substring(0,20)}", placing at start`}}const p=c.cells[0];return p.isEmpty?{nodeType:"empty-table-cell",nodeIndex:0,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing in empty first cell`,emptyCellIndex:0,emptyCellRow:p.rowIndex,emptyCellCol:p.colIndex}:{nodeType:"text",nodeIndex:n+p.textNodeIndex,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!0,placeBefore:!1,explanation:`Position ${s} is in table separator, placing at start of first cell`}}}return{nodeType:"text",nodeIndex:(n>0?n-1:0)+o,offset:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!1,explanation:`Position ${s} is within table but no cells found`}}function Qy(s,e,t,n,r,o){const i=t;let c;s.isBullet?c=2:s.isOlNumber?c=s.content.length+1:c=s.content.length;const l=i,d=i+c;if(s.isBullet||s.isOlNumber?e>=l&&e<d:e>=l&&e<=d){const u=s.index+r;if(s.isBullet){const f=Math.min(e-l,1);return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within bullet text node #${u} at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else if(s.isOlNumber){const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within OL number text node #${u} "${s.content}" at offset ${f}`,atListItemStart:f===0},newPos:d,adjustedPos:i}}else{const f=e-l;return{placement:{nodeType:"text",nodeIndex:u,offset:f,expectedLine:n,tableTextNodeOffset:r,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is within text node #${u} "${s.content.substring(0,20)}..." at offset ${f}`},newPos:d,adjustedPos:i}}}return{placement:null,newPos:d,adjustedPos:i}}function fi(s,e,t,n,r,o,i){const c=n+1;return t===n?{nodeType:s,nodeIndex:e,offset:0,expectedLine:r-1,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!0,explanation:`Position ${t} is at ${s} #${e}`}:t===c&&s==="br-standalone"?{nodeType:s,nodeIndex:e,offset:i?1:0,expectedLine:r,tableTextNodeOffset:o,insideTableCell:!1,placeBefore:!1,explanation:`Position ${t} is after ${s} #${e}`}:null}function Zy(s,e){const{tokens:t,tables:n}=Yy(s);let r=0,o=1,i=!1,c=!1,l=0,d=0,p=0,u=!1;for(let m=0;m<t.length;m++){const g=t[m];if(g.type==="header"){l=g.level+1,c=!1;continue}if(g.type==="formatting"){r+=g.markdownChars;continue}if(g.type==="whitespace"){r+=g.length;continue}if(g.type==="block-end"){u=!0;continue}if(g.type==="blockquote"){r+=2,c=!1;continue}if(g.type==="table"){u&&(r+=1,o++,u=!1);const x=r,w=r+g.markdownLength,v=n[g.tableIndex];if(e>=x&&e<w){const b=Xy(e,x,v,p,o,d);if(b)return b}r=w,o+=g.lineCount,d+=g.textNodeCount,c=!1;continue}if(g.type==="list-item-start"){u?(r+=1,o++,u=!1):i&&!c&&(r+=1,o++),i=!0,c=!1;continue}if(g.type==="text"){if(u){if(e===r)return{nodeType:"text",nodeIndex:g.index+d,offset:0,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at implicit newline after block element`};r+=1,o++,u=!1}l>0&&(r+=l,l=0);const x=Qy(g,e,r,o,d);if(x.placement)return x.placement;r=x.newPos,p++,c=!1}else if(g.type==="br-standalone"){u&&(u=!1),o++;const x=fi("br-standalone",g.index,e,r,o,d,!1);if(x)return x;r+=1,c=!0,i=!1}else if(g.type==="br-empty-line"){u&&(r+=1,o++,u=!1),o++;const x=fi("br-empty-line",g.index,e,r,o,d,!0);if(x)return x;r+=1,c=!0,i=!1}}const f=t[t.length-1];if((f==null?void 0:f.type)==="text"){const m=f.index+d;return{nodeType:"text",nodeIndex:m,offset:f.content.length,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is at end of last text node #${m}`}}return{nodeType:"end",nodeIndex:0,offset:0,expectedLine:o,tableTextNodeOffset:d,insideTableCell:!1,placeBefore:!1,explanation:`Position ${e} is beyond content (currentPos=${r})`}}function rn(s,e){var o;const t=window.getSelection();if(!t)return;const n=Zy(s.innerHTML,e),r=document.createRange();if(n.nodeType==="text"){let i;if(n.insideTableCell)i=n.nodeIndex;else if(n.tableTextNodeOffset===0)i=n.nodeIndex;else{const f=s.querySelectorAll("table");let m=0;f.forEach(x=>{const w=document.createTreeWalker(x,NodeFilter.SHOW_TEXT);for(;w.nextNode()!==null;)m++});const g=n.tableTextNodeOffset;i=n.nodeIndex-g+m}const c=document.createTreeWalker(s,NodeFilter.SHOW_TEXT);let l=null,d=0,p=null;const u=[];for(;(l=c.nextNode())!==null;){p=l;const f=l.textContent||"";if(u.push(`[${d}]: "${f.substring(0,30)}${f.length>30?"...":""}"`),d===i){const m=(l.textContent||"").length,g=Math.min(n.offset,m);if(n.atListItemStart){const x=(o=l.parentElement)==null?void 0:o.closest(".list-item-ul, .list-item-ol");if(x!=null&&x.parentNode){const w=document.createTextNode("â€‹");x.parentNode.insertBefore(w,x),r.setStart(w,1),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.setStart(l,g),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}d++}if(p){const f=(p.textContent||"").length;r.setStart(p,f),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}if(n.nodeType==="empty-table-cell"){const i=s.querySelector("table");if(i){const c=i.querySelectorAll("tr");let l=null,d=null;if(n.emptyCellRow===0)l=c[0],l&&(d=l.querySelectorAll("th")[n.emptyCellCol??0]);else{const p=i.querySelector("tbody");p?l=p.querySelectorAll("tr")[(n.emptyCellRow??1)-1]:l=c[n.emptyCellRow??1],l&&(d=l.querySelectorAll("td")[n.emptyCellCol??0])}if(d){const p=document.createTextNode("â€‹");d.appendChild(p),r.setStart(p,0),r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}}if(n.nodeType==="br-standalone"){const i=s.querySelectorAll("br");let c=0;for(const l of i){const d=l.parentElement,p=d==null?void 0:d.classList.contains("empty-line"),u=l.closest("table")!==null;if(`${c}${d==null?void 0:d.tagName}${p}${u}`,!p&&!u){if(c===n.nodeIndex){if(n.placeBefore)r.setStartBefore(l),r.collapse(!0);else{const f=l.nextSibling;if(f)if(f.nodeType===Node.TEXT_NODE)r.setStart(f,0);else if(f.tagName==="BR"){const m=document.createTextNode("â€‹");l.parentNode.insertBefore(m,f),r.setStart(m,1)}else{const m=document.createTextNode("â€‹");l.parentNode.insertBefore(m,f),r.setStart(m,1)}else{const m=document.createTextNode("â€‹");l.parentNode.appendChild(m),r.setStart(m,1)}r.collapse(!0)}t.removeAllRanges(),t.addRange(r);return}c++}}}if(n.nodeType==="br-empty-line"){const c=s.querySelectorAll(".empty-line")[n.nodeIndex];if(c){if(n.placeBefore)r.setStart(c,0);else{const l=c.querySelector("br"),d=document.createTextNode("â€‹");l&&l.nextSibling?c.insertBefore(d,l.nextSibling):c.appendChild(d),r.setStart(d,1)}r.collapse(!0),t.removeAllRanges(),t.addRange(r);return}}r.selectNodeContents(s),r.collapse(!1),t.removeAllRanges(),t.addRange(r)}function co(s){let e="";function t(n){var r;if(n.nodeType===Node.TEXT_NODE)e+=n.textContent||"";else if(n.nodeType===Node.ELEMENT_NODE){const o=n,i=o.tagName.toLowerCase();if(i==="br")e+=`
`;else if(i==="div"||i==="p"){const c=o.childNodes.length===1&&((r=o.firstChild)==null?void 0:r.nodeName)==="BR";e.length>0&&!e.endsWith(`
`)&&!c&&(e+=`
`),o.childNodes.forEach(t)}else o.childNodes.forEach(t)}}return s.childNodes.forEach(t),e}function eS(s){let e=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");return e.endsWith("<br>")&&(e+="â€‹"),e}function tS(s){const e=window.getSelection();if(!e||e.rangeCount===0)return 0;const t=e.getRangeAt(0),n=t.cloneRange();n.selectNodeContents(s),n.setEnd(t.startContainer,t.startOffset);const r=document.createElement("div");return r.appendChild(n.cloneContents()),co(r).length}function sS(s,e){const t=window.getSelection();if(!t)return;let n=0;const r=document.createTreeWalker(s,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let o=r.nextNode();for(;o;){if(o.nodeType===Node.TEXT_NODE){const l=(o.textContent||"").length;if(n+l>=e){const d=document.createRange(),p=e-n;d.setStart(o,Math.min(p,l)),d.collapse(!0),t.removeAllRanges(),t.addRange(d);return}n+=l}else o.nodeName==="BR"&&(n+=1);o=r.nextNode()}const i=document.createRange();i.selectNodeContents(s),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}function nS(s){const{editorRef:e,applyingActionRef:t,value:n,isRawMode:r,setInternalValue:o,onChange:i}=s,c=h.useCallback(()=>{if(!e.current)return null;if(r){const d=co(e.current),p=tS(e.current);return{text:d,cursorPos:p}}else{const{cursorPos:d}=Na(e.current);return{text:n??Na(e.current).text,cursorPos:d}}},[e,r,n]),l=h.useCallback((d,p)=>{if(!e.current)return;t.current=!0;let u;if(d.replaceTextAfterCursor!==void 0?u=p.substring(0,d.selectionStart)+d.textToInsert+d.replaceTextAfterCursor:u=p.substring(0,d.selectionStart)+d.textToInsert+p.substring(d.selectionEnd),r)e.current.innerHTML=eS(u),sS(e.current,d.newCursorPosition);else{const f=at(u);e.current.innerHTML=f,rn(e.current,d.newCursorPosition)}n===void 0&&o(u),i==null||i(u),setTimeout(()=>{t.current=!1},0)},[e,r,n,o,i,t]);return{getTextAndCursor:c,applyAction:l}}function rS(s){const{applyAction:e}=s,t=h.useCallback((o,i,c)=>{if(!c.hasSelection||o.metaKey||o.ctrlKey||o.altKey)return!1;const l=Yf(o.key);if(!l)return!1;o.preventDefault();const d=Bo(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),n=h.useCallback((o,i,c)=>{if(!(o.metaKey||o.ctrlKey)||!c.hasSelection)return!1;const l=Jf(o.key);if(!l)return!1;o.preventDefault();const d=Bo(i,c.selectionStart,c.selectionEnd,l);return e(d,i),!0},[e]),r=h.useCallback(o=>(o.metaKey||o.ctrlKey)&&!em(o.key),[]);return{handleAutoWrap:t,handleFormatShortcut:n,shouldPassThrough:r}}function aS(s){const{editorRef:e,isRawMode:t,applyAction:n,useRichEditing:r,setInternalValue:o,onChange:i}=s,c=h.useCallback((u,f,m)=>{if(e.current){if(f===m&&f>0){const g=u.substring(0,f-1)+u.substring(f),x=f-1,w=at(g);e.current.innerHTML=w,rn(e.current,x),o(g),i==null||i(g)}else if(f!==m){const g=u.substring(0,f)+u.substring(m),x=f,w=at(g);e.current.innerHTML=w,rn(e.current,x),o(g),i==null||i(g)}}},[e,o,i]),l=h.useCallback((u,f,m)=>{const{selectionStart:g,selectionEnd:x}=m,w=Zf(f,g,x);return w?(u.preventDefault(),n(w,f),!0):t?!1:(u.preventDefault(),c(f,g,x),!0)},[t,n,c]),d=h.useCallback((u,f,m)=>{if(!r||u.shiftKey)return!1;const{selectionStart:g,selectionEnd:x}=m,w=Bc(f,g,x);return u.preventDefault(),n(w,f),!0},[r,n]),p=h.useCallback((u,f,m)=>{if(!r)return!1;u.preventDefault();const g=u.shiftKey?zc(f,m.selectionStart,m.selectionEnd):Wc(f,m.selectionStart,m.selectionEnd);return n(g,f),!0},[r,n]);return{handleBackspace:l,handleEnter:d,handleTab:p}}function oS(s){switch(s){case"strong":return"**";case"em":return"*";case"code":return"`";case"del":return"~~";case"blockquote":return"> ";default:return""}}function iS(s){const{editorRef:e,editingRawMarkdownRef:t,isRawMode:n,allowRawPreviewOnClick:r,handleInput:o}=s,i=h.useCallback((d,p)=>{var S;d.preventDefault();const u=p.textContent||"",f=p.tagName.toLowerCase(),m=oS(f);if(!m)return;t.current=!0;const g=window.getSelection();if(!g||g.rangeCount===0)return;const x=g.getRangeAt(0);let w=0;if(p.contains(x.startContainer)){const j=document.createRange();j.selectNodeContents(p),j.setEnd(x.startContainer,x.startOffset);const N=document.createElement("div");N.appendChild(j.cloneContents()),w=((S=N.textContent)==null?void 0:S.length)||0}const v=f==="blockquote"?`${m}${u}`:`${m}${u}${m}`,b=document.createTextNode(v);p.replaceWith(b);const y=document.createRange(),C=m.length+w;y.setStart(b,C),y.setEnd(b,C),g.removeAllRanges(),g.addRange(y),o()},[t,o]),c=h.useCallback(()=>{var m;if(!e.current)return;t.current=!1;const d=window.getSelection();let p=0;if(d&&d.rangeCount>0){const g=d.getRangeAt(0),x=g.cloneRange();x.selectNodeContents(e.current),x.setEnd(g.startContainer,g.startOffset);const w=document.createElement("div");w.appendChild(x.cloneContents());const v=w.textContent||"";p=v.length;let b=0;for(let y=0;y<Math.min(p,v.length);y++){const C=v[y],S=v[y+1];C==="*"&&S==="*"?(b+=2,y++):(C==="*"||C==="_"||C==="`"||C==="~")&&b++}p=p-b}const u=ps(e.current.innerHTML),f=at(u);if(e.current.innerHTML!==f&&(e.current.innerHTML=f,d&&d.rangeCount>0)){let g=0;const x=document.createTreeWalker(e.current,NodeFilter.SHOW_TEXT);let w=x.nextNode(),v=!1;for(;w&&!v;){const b=((m=w.textContent)==null?void 0:m.length)||0;if(g+b>=p){const y=p-g,C=document.createRange();C.setStart(w,y),C.setEnd(w,y),d.removeAllRanges(),d.addRange(C),v=!0}else g+=b,w=x.nextNode()}}},[e,t]);return{handleClick:h.useCallback(d=>{if(!e.current||!r||n)return;const u=d.target.closest("strong, em, code, del, blockquote");u?i(d,u):t.current&&c()},[e,r,n,t,i,c])}}function cS(s){const e=window.getSelection();let t=s;return e&&e.rangeCount>0&&!e.isCollapsed&&(t=s+e.toString().length),{selectionStart:s,selectionEnd:t,hasSelection:s!==t}}function lS(s){const{editorRef:e,editingRawMarkdownRef:t,applyingActionRef:n,value:r,isRawMode:o,useRichEditing:i,keyboard:c,allowRawPreviewOnClick:l,setInternalValue:d,onChange:p,onKeyDown:u,onPaste:f}=s,{getTextAndCursor:m,applyAction:g}=nS({editorRef:e,applyingActionRef:n,value:r,isRawMode:o,setInternalValue:d,onChange:p}),{handleAutoWrap:x,handleFormatShortcut:w,shouldPassThrough:v}=rS({applyAction:g}),{handleBackspace:b,handleEnter:y,handleTab:C}=aS({editorRef:e,isRawMode:o,applyAction:g,useRichEditing:i,setInternalValue:d,onChange:p}),S=h.useCallback(()=>{if(!e.current)return;if(o){const T=co(e.current);r===void 0&&d(T),p==null||p(T);return}const R=e.current.innerHTML;let D=ps(R);if(c===io.VI){const{cursorPos:T}=Na(e.current),L=D,_=T,P=zy(L,_);if(P.found){const G=Gy(L,_,P.sequenceStart,P.detectedBaseChar);if(G.type==="auto-complete"&&G.replacement){D=G.replacement;const $=G.newCursorPos??D.length;e.current.innerHTML=at(D),rn(e.current,$)}}}r===void 0&&d(D),p==null||p(D)},[p,r,c,o,e,d]),{handleClick:j}=iS({editorRef:e,editingRawMarkdownRef:t,isRawMode:o,allowRawPreviewOnClick:l,handleInput:S}),N=h.useCallback(R=>{const D=m();if(!D||!e.current){u==null||u(R);return}const{text:T,cursorPos:L}=D,_=cS(L);if(x(R,T,_)){u==null||u(R);return}if(w(R,T,_)){u==null||u(R);return}if(v(R)){u==null||u(R);return}if(R.key==="Backspace"&&b(R,T,_)){u==null||u(R);return}if(R.key==="Enter"&&y(R,T,_)){u==null||u(R);return}if(R.key==="Tab"&&C(R,T,_)){u==null||u(R);return}u==null||u(R)},[m,x,w,v,b,y,C,e,u]),E=h.useCallback(R=>{R.preventDefault();const D=R.clipboardData.getData("text/plain"),T=D.split(`
`);if(T.length===1)document.execCommand("insertText",!1,D);else{const L=window.getSelection();if(!L||L.rangeCount===0)return;const _=L.getRangeAt(0);_.deleteContents();const P=document.createDocumentFragment();T.forEach(($,Y)=>{Y>0&&P.appendChild(document.createElement("br")),$&&P.appendChild(document.createTextNode($))}),_.insertNode(P),_.collapse(!1),L.removeAllRanges(),L.addRange(_);const G=e.current;G&&G.dispatchEvent(new Event("input",{bubbles:!0}))}f==null||f()},[e,f]);return{handleInput:S,handleClick:j,handleKeyDown:N,handlePaste:E}}function dS(s){const{editorRef:e,editingRawMarkdownRef:t,currentModeRef:n,applyingActionRef:r,currentValue:o,isFocused:i,allowRawPreviewOnClick:c}=s;h.useEffect(()=>{if(!e.current||r.current)return;const l=n.current,d=l==="raw"?e.current.textContent||"":ps(e.current.innerHTML);if(d===o)return;const p=o.startsWith(d)&&o.length>d.length;if((!i||p)&&(l==="raw"?e.current.textContent=o:e.current.innerHTML=at(o),i&&p)){const u=document.createRange(),f=window.getSelection();u.selectNodeContents(e.current),u.collapse(!1),f==null||f.removeAllRanges(),f==null||f.addRange(u)}},[o,i,e,n,r]),h.useEffect(()=>{if(!i||!e.current||!c)return;const l=()=>{if(t.current)return;const d=window.getSelection();if(!(!d||!e.current)&&d.isCollapsed&&e.current.contains(d.anchorNode)){const p=ps(e.current.innerHTML),u=at(p);if(e.current.innerHTML!==u){const f=d.getRangeAt(0),m=f.cloneRange();m.selectNodeContents(e.current),m.setEnd(f.startContainer,f.startOffset);const g=document.createElement("div");g.appendChild(m.cloneContents());const x=ps(g.innerHTML).length;e.current.innerHTML=u,rn(e.current,x)}}};return document.addEventListener("selectionchange",l),()=>{document.removeEventListener("selectionchange",l)}},[i,o,c,e,t])}const Yl=h.forwardRef(({value:s,defaultValue:e,onChange:t,onBlur:n,onKeyDown:r,onPaste:o,className:i,style:c,placeholder:l,readOnly:d=!1,useRichEditing:p=!0,allowRawPreviewOnClick:u=!1,showHints:f=!0,showAudioButton:m=!1,audioButtonVariant:g="default",autoStartAudioRecording:x=!1,onAudioTranscription:w,getTextAreaElement:v,audioNodeId:b,keyboard:y=Wl,showConfigButton:C=!0,mode:S,onModeChange:j,...N},E)=>{const R=xs(),[D,T]=h.useState(e||""),[L,_]=h.useState(!1),P=h.useRef(null),G=h.useRef(!1),$=h.useRef("preview"),Y=h.useRef(!1),A=h.useRef(!1),X=h.useRef(!1),[I,k]=h.useState(()=>{try{const H=localStorage.getItem("watcher-markdown-textarea-mode");if(H==="raw"||H==="preview")return H}catch{}return"preview"}),M=S??I,U=S!==void 0?H=>j==null?void 0:j(H):k,q=M==="raw";h.useEffect(()=>{if(S===void 0)try{localStorage.setItem("watcher-markdown-textarea-mode",M)}catch{}},[M,S]),h.useEffect(()=>{$.current=M,Y.current=!1,A.current=!1},[M]);const W=s!==void 0?s:D,V=!W||W.trim()==="",ie=h.useRef(W);A.current||(A.current=!0,ie.current=W);const K=h.useRef(M),ne=h.useRef(s!==void 0?s:D);ne.current=s!==void 0?s:D;const me=h.useRef(null);me.current||(me.current=H=>{const ue=H.target.closest("a");if(ue){H.preventDefault(),H.stopPropagation();const pe=ue.getAttribute("href");if(pe){const he=document.createElement("a");he.href=pe,he.target="_blank",he.rel="noopener noreferrer",he.style.display="none",document.body.appendChild(he),he.click(),document.body.removeChild(he)}}});const ge=h.useCallback(H=>{const ce=M!==K.current;if(K.current=M,P.current&&me.current&&P.current.removeEventListener("click",me.current,!0),P.current=H,H&&M!=="raw"&&me.current&&H.addEventListener("click",me.current,!0),H&&(ce||!Y.current)){Y.current=!0;const ue=ne.current;M==="raw"?H.textContent=ue:H.innerHTML=at(ue)}},[M]);h.useImperativeHandle(E,()=>({getElement:()=>P.current,getValue:()=>W,setValue:H=>{if(s===void 0&&T(H),P.current){const ce=at(H);P.current.innerHTML=ce;const ue=document.createRange(),pe=window.getSelection();ue.selectNodeContents(P.current),ue.collapse(!1),pe==null||pe.removeAllRanges(),pe==null||pe.addRange(ue)}t==null||t(H)},focus:()=>{var H;(H=P.current)==null||H.focus()}})),dS({editorRef:P,editingRawMarkdownRef:G,currentModeRef:$,applyingActionRef:X,currentValue:W,isFocused:L,allowRawPreviewOnClick:u});const{handleInput:oe,handleClick:Se,handleKeyDown:xe,handlePaste:Pe}=lS({editorRef:P,editingRawMarkdownRef:G,applyingActionRef:X,value:s,isRawMode:q,useRichEditing:p,keyboard:y,allowRawPreviewOnClick:u,setInternalValue:T,onChange:t,onKeyDown:r,onPaste:o}),ae=h.useCallback(()=>{_(!0)},[]),te=h.useCallback(H=>{w==null||w(H)},[w]),F=h.useCallback(()=>P.current,[]),Z=h.useCallback(H=>{_(!1);const ce=$.current;P.current&&(ce==="raw"?P.current.textContent!==W&&(P.current.textContent=W):P.current.innerHTML=at(W)),n==null||n(H)},[W,n]);return a.jsxs("div",{className:"markdown-textarea-container h-full","data-test":"markdown-textarea-container",children:[a.jsxs("div",{className:"markdown-textarea-wrapper relative h-full","data-test":"markdown-textarea-wrapper",children:[a.jsx("div",{ref:ge,contentEditable:!d,onInput:oe,onClick:q?void 0:Se,onFocus:ae,onBlur:Z,spellCheck:!1,onKeyDown:xe,onPaste:Pe,className:B("markdown-textarea min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm","ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50",!q&&"[&_strong]:font-bold [&_em]:italic [&_del]:line-through",!q&&"[&_code]:bg-muted [&_code]:px-1 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono","[&_*]:![font-size:inherit] [&_*]:![line-height:inherit]",d&&"cursor-default",i),style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:R?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:R?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...c},suppressContentEditableWarning:!0,"data-node-textarea":N["data-node-textarea"],"data-test":`markdown-textarea-editor${q?"-raw":""}`},M),V&&!L&&l&&a.jsx("div",{className:"absolute top-2 left-3 text-sm text-muted-foreground pointer-events-none","aria-hidden":!0,"data-test":"markdown-textarea-placeholder",children:l}),a.jsxs("div",{className:"absolute right-2 bottom-1 flex items-center gap-1",style:{zIndex:Je.nodeAudioButton},onMouseDownCapture:H=>H.preventDefault(),children:[C&&a.jsx(fr,{compact:!0,label:q?a.jsx(So,{className:"h-3 w-3"}):a.jsx(Jr,{className:"h-3 w-3"}),onAction:()=>{const H=q?"preview":"raw";U(H),j==null||j(H)},variant:"ghost",size:"icon",buttonClassName:"p-1 h-auto w-auto rounded-md transition-colors text-muted-foreground/40 hover:text-foreground hover:bg-accent",configOptions:[{label:"Preview",value:"preview",icon:a.jsx(Jr,{className:"h-4 w-4"}),onClick:()=>{U("preview"),j==null||j("preview")}},{label:"Raw Markdown",value:"raw",icon:a.jsx(So,{className:"h-4 w-4"}),onClick:()=>{U("raw"),j==null||j("raw")}}],tooltipText:`${q?"Raw":"Preview"} mode (click to toggle, hold for options)`,ariaLabel:"Toggle markdown display mode","data-test":"markdown-mode-toggle"}),m&&a.jsx(zl,{onTranscriptionComplete:te,sessionName:"markdown-textarea",getTextAreaElement:v||F,variant:g,autoStartRecording:x,nodeId:b,language:y,"data-test":"markdown-textarea-audio-button"})]})]}),f&&a.jsxs("div",{className:"markdown-hints text-xs text-muted-foreground mt-1 flex gap-3 flex-wrap","data-test":"markdown-textarea-hints",children:[a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+B"})," Bold"]}),a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+I"})," Italic"]}),a.jsx("span",{children:"**bold** *italic* `code` > quote"}),p&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"text-muted-foreground/50",children:"|"}),a.jsxs("span",{children:[a.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Tab"})," Indent"]}),a.jsx("span",{children:"Auto-list on Enter"})]})]})]})});Yl.displayName="MarkdownTextarea";const uS=Math.round(ot.LINE_HEIGHT*2/3),pS=s=>{var e,t,n;return(n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.selectedProjectPath},hS=(s,e)=>{const t=window.getComputedStyle(s),n=s.scrollTop,r=document.createElement("div");r.style.cssText=`
    position: absolute;
    visibility: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    width: ${s.clientWidth}px;
    font-family: ${t.fontFamily};
    font-size: ${t.fontSize};
    font-weight: ${t.fontWeight};
    line-height: ${t.lineHeight};
    letter-spacing: ${t.letterSpacing};
    padding: ${t.padding};
    border: ${t.border};
    box-sizing: ${t.boxSizing};
  `;const o=s.value.substring(0,e),i=document.createTextNode(o);r.appendChild(i);const c=document.createElement("span");c.textContent="â€‹",r.appendChild(c),document.body.appendChild(r);const l=c.offsetTop,d=c.offsetLeft;document.body.removeChild(r);const p=parseFloat(t.lineHeight)||20,u=d;return{top:l+p/3-n,left:u}},mi=(s,e)=>{let t=-1;for(let o=e;o>=0;o--){if(s[o]==="@"){t=o;break}if(s[o]===" "||s[o]===`
`||s[o]==="	")break}if(t===-1)return null;let n=t+1;for(;n<s.length;){const o=s[n];if(o===" "||o===`
`||o==="	")break;n++}const r=s.substring(t,n);return r.startsWith("@")&&r.includes("/")?{start:t,end:n,path:r}:null},ns=h.forwardRef(({defaultValue:s,value:e,onChange:t,onBlur:n,onFocus:r,onKeyDown:o,onMouseDown:i,onClick:c,onPaste:l,onPasteComplete:d,className:p,style:u,placeholder:f,onSelectionChange:m,onFileSelect:g,logger:x,showBuiltInPopover:w=!1,showFilePicker:v=!0,showCopyButton:b=!1,showAudioButton:y=!0,showConfigButton:C=!0,audioButtonVariant:S="default",autoStartAudioRecording:j=!1,onAudioTranscriptionComplete:N,audioNodeId:E,readOnly:R=!1,rows:D,autoFocus:T=!1,useMarkdown:L=!1,showMarkdownHints:_=!1,keyboard:P=Wl,onModeChange:G},$)=>{const[Y,A]=h.useState(!1),[X,I]=h.useState({top:0,left:0}),[k,M]=h.useState(500),[U,q]=h.useState(null),[W,V]=h.useState(!1),[ie,K]=h.useState(!1),[ne,me]=h.useState(!1),ge=h.useRef(null),oe=h.useRef(null),Se=h.useRef(null),xe=h.useRef(null),Pe=h.useRef(null),ae=h.useCallback(()=>{V(!0),ie&&(A(!0),K(!1))},[ie]),te=Le(pS),F=xs();h.useEffect(()=>{var Ce;const J=(Ce=ge.current)==null?void 0:Ce.getTextArea();if(!J)return;const fe=Ie=>{const Ae=Ie.relatedTarget;!((Ae==null?void 0:Ae.closest('[data-test="textarea-file-picker-popover-content"]'))!==null)&&Y&&(A(!1),q(null),me(!1))};return J.addEventListener("blur",fe),()=>{J.removeEventListener("blur",fe)}},[Y]),h.useImperativeHandle($,()=>({getTextArea:()=>{var J,fe;return L?(J=oe.current)==null?void 0:J.getElement():((fe=ge.current)==null?void 0:fe.getTextArea())??null},insertTextAtStart:J=>{var fe,Ce;L?(fe=oe.current)==null||fe.focus():(Ce=ge.current)==null||Ce.insertTextAtStart(J)},focus:()=>{var J,fe,Ce;L?(J=oe.current)==null||J.focus():(Ce=(fe=ge.current)==null?void 0:fe.getTextArea())==null||Ce.focus()}}),[L]);const Z=h.useCallback(J=>{var fe,Ce,Ie,Ae;if(L){const Ee=((fe=oe.current)==null?void 0:fe.getValue())??"",_e=Ee.trim()?" ":"",Me=Ee+_e+J;(Ce=oe.current)==null||Ce.setValue(Me);const Be={target:{value:Me},currentTarget:{value:Me}};t==null||t(Be)}else{const Ee=(Ie=ge.current)==null?void 0:Ie.getTextArea();if(!Ee)return;const _e=Ee.value,Me=_e.trim()?" ":"",Be=_e+Me+J,ze=(Ae=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Ae.set;ze?ze.call(Ee,Be):Ee.value=Be;const lt=new Event("input",{bubbles:!0});Ee.dispatchEvent(lt)}N==null||N()},[L,t,N]),H=h.useCallback(()=>{var J;return((J=oe.current)==null?void 0:J.getElement())??null},[]),ce=h.useCallback(()=>{var J;return((J=ge.current)==null?void 0:J.getTextArea())??null},[]),ue=h.useCallback(()=>{var Ie;if(U===null)return"";const J=(Ie=ge.current)==null?void 0:Ie.getTextArea();if(!J)return"";const fe=J.value,Ce=J.selectionStart;return fe.substring(U+1,Ce)},[U]),pe=h.useCallback((J,fe)=>{for(let Ce=fe-1;Ce>=0;Ce--){const Ie=J[Ce];if(Ie===" "||Ie===`
`||Ie==="	")return null;if(Ie==="@"){const Ae=Ce>0?J[Ce-1]:null;return Ae===null||Ae===" "||Ae===`
`||Ae==="	"?Ce:null}}return null},[]),he=J=>{var Ae;if(!v)return!1;const fe=J.selectionStart,Ce=J.value,Ie=pe(Ce,fe);if(Ie!==null){const Ee=(Ae=ge.current)==null?void 0:Ae.getTextArea();if(Ee){const _e=Ee.getBoundingClientRect(),Me=hS(Ee,fe);I(Me),M(_e.width),me(!0)}return U!==Ie&&q(Ie),!Y&&!ie&&(W?(A(!0),x==null||x.info("@ character detected - showing file picker")):(K(!0),x==null||x.info("@ character detected - waiting for files to load"))),!0}else(Y||ie)&&(A(!1),K(!1),q(null),me(!1));return!1},ve=J=>{const fe=J.target;he(fe),t==null||t(J)},Te=J=>{const fe=J.currentTarget;setTimeout(()=>{he(fe)},0)},ke=J=>{const fe=J.currentTarget;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(J.key)&&he(fe)},z=h.useCallback(J=>{var Ce,Ie;if(!Y||!xe.current)return!1;const fe=ue();switch(J.key){case"ArrowDown":return J.preventDefault(),xe.current.navigate("down"),!0;case"ArrowUp":return J.preventDefault(),xe.current.navigate("up"),!0;case"Enter":return J.preventDefault(),xe.current.selectCurrent(),!0;case"Tab":if(fe.startsWith("/")){J.preventDefault();const Ae=xe.current.tabComplete();if(Ae&&U!==null){const Ee=(Ce=ge.current)==null?void 0:Ce.getTextArea();if(Ee){const _e=Ee.value.substring(0,U+1),Me=Ee.value.substring(Ee.selectionStart),Be=_e+Ae+Me,ze=U+1+Ae.length,lt=(Ie=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:Ie.set;lt?lt.call(Ee,Be):Ee.value=Be,Ee.setSelectionRange(ze,ze),Ee.dispatchEvent(new Event("input",{bubbles:!0}))}}return!0}return!1;case"Escape":return J.preventDefault(),J.stopPropagation(),A(!1),q(null),me(!1),!0;default:return!1}},[Y,ue,U]),O=h.useCallback(J=>{z(J)||o==null||o(J)},[z,o]),Q=(J,fe)=>{var Ce,Ie;if(m==null||m(J,fe),!!v)if(J.length>0){const Ae=J.toLowerCase()==="file",Ee=(Ce=ge.current)==null?void 0:Ce.getTextArea();let _e=null;if(Ee){const Me=Ee.value,Be=Ee.selectionStart;_e=mi(Me,Be)}Ae||_e?(A(!0),fe&&I(fe),Ae?(q(null),x==null||x.info('Word "file" selected - showing file picker')):(q(null),x==null||x.info(`File path "${_e==null?void 0:_e.path}" detected - showing file picker to replace`))):(A(!1),q(null),me(!1))}else{const Ae=(Ie=ge.current)==null?void 0:Ie.getTextArea();if(Ae&&pe(Ae.value,Ae.selectionStart)!==null)return;A(!1),q(null),me(!1)}},we=J=>{var fe;if(A(J),!J){me(!1);const Ce=(fe=ge.current)==null?void 0:fe.getTextArea();Ce&&Ce.focus()}},re=J=>{var Ye;const fe=(Ye=ge.current)==null?void 0:Ye.getTextArea();if(!fe)return;fe.focus();const Ce=fe.value,Ie=fe.selectionStart,Ee=fe.value.substring(fe.selectionStart,fe.selectionEnd).toLowerCase()==="file",_e=mi(Ce,Ie);let Me,Be,ze;if(U!==null)Me=U,Be=Ie,ze="@"+J.path+" ";else if(Ee)Me=fe.selectionStart,Be=fe.selectionEnd,ze="@"+J.path+" ";else if(_e)Me=_e.start,Be=_e.end,ze="@"+J.path+" ";else{A(!1),q(null),me(!1);return}if(fe.setSelectionRange(Me,Be),!document.execCommand("insertText",!1,ze)){const nt=fe.value.substring(0,Me),xt=fe.value.substring(Be);fe.value=nt+ze+xt,fe.setSelectionRange(Me+ze.length,Me+ze.length),fe.dispatchEvent(new Event("input",{bubbles:!0}))}if(U!==null){const nt=Ce.substring(U,Ie);x==null||x.info(`Replaced "${nt}" with: ${ze}`)}else Ee?x==null||x.info(`Replaced "file" with: ${ze}`):_e&&(x==null||x.info(`Replaced "${_e.path}" with: ${ze}`));g==null||g(J),A(!1),q(null),me(!1)},be=h.useCallback(J=>{const fe={target:{value:J},currentTarget:{value:J}};t==null||t(fe)},[t]);return a.jsxs(st,{open:Y&&ne,onOpenChange:we,modal:!1,"data-test":"textarea-file-picker-popover",children:[a.jsxs("div",{ref:Pe,className:"textarea-with-file-picker relative w-full h-full","data-test":"textarea-file-picker-container",onMouseDown:J=>{J.stopPropagation()},onClick:J=>{J.stopPropagation()},children:[L?a.jsx("div",{className:"relative w-full h-full",onMouseDown:i,onPaste:l,onClick:J=>{Te(J),c==null||c(J)},onKeyUp:ke,children:a.jsx(Yl,{ref:oe,defaultValue:s,value:e,onChange:be,onBlur:n,onKeyDown:o,onPaste:d,className:p,style:u,placeholder:f,readOnly:R,useRichEditing:!0,showHints:_,showAudioButton:y,showConfigButton:C,audioButtonVariant:S,autoStartAudioRecording:j,onAudioTranscription:Z,getTextAreaElement:H,audioNodeId:E,keyboard:P,onModeChange:G,"data-node-textarea":!0,"data-test":"textarea-file-picker-markdown-textarea"})}):a.jsx(Hl,{ref:ge,defaultValue:s,value:e,onChange:ve,onBlur:n,onFocus:r,onKeyDown:O,onMouseDown:i,onPaste:l,onClick:J=>{Te(J),c==null||c(J)},onKeyUp:ke,className:p,style:u,onSelectionChange:Q,placeholder:f,showBuiltInPopover:w,showCopyButton:b,showAudioButton:y,audioButtonVariant:S,onAudioTranscription:Z,getTextAreaElement:ce,readOnly:R,rows:D,autoFocus:T,keyboard:P,"data-test":"textarea-file-picker-selectable-textarea"}),v&&a.jsx(Tn,{ref:Se,style:{position:"absolute",top:`${X.top}px`,left:`${X.left}px`,width:"1px",height:"1px"},"data-test":"textarea-file-picker-popover-anchor"}),v&&!W&&a.jsx("div",{className:"hidden",children:a.jsx(Sa,{maxResults:1,cwd:te??void 0,onLoadComplete:ae,"data-test":"textarea-file-picker-preloader"})})]}),v&&a.jsxs(Qe,{className:"file-picker-popover p-0 border-none",side:"bottom",align:"start",sideOffset:uS,avoidCollisions:!0,collisionPadding:16,style:{zIndex:Je.draggablePopoverDropdown,width:`${Math.round(k*.7)}px`},onOpenAutoFocus:J=>J.preventDefault(),onCloseAutoFocus:J=>J.preventDefault(),onInteractOutside:J=>J.preventDefault(),onPointerDownOutside:J=>J.preventDefault(),onEscapeKeyDown:J=>{J.preventDefault(),A(!1),q(null),me(!1),setTimeout(()=>{var Ce;const fe=(Ce=ge.current)==null?void 0:Ce.getTextArea();fe&&fe.focus()},0)},"data-test":"textarea-file-picker-popover-content",children:[a.jsx(Sa,{ref:xe,onFileSelect:re,maxResults:F?5:10,placeholder:"Search for a file...",mode:"fileNameOnly",cwd:te??void 0,externalSearchQuery:ue(),hideSearchInput:!0,"data-test":"textarea-file-picker-file-picker"}),a.jsx("div",{className:"text-[10px] text-muted-foreground p-1","data-test":"textarea-file-picker-popover-description",children:'Type to filter. Use "/" for directory navigation, Tab to autocomplete.'})]})]})});ns.displayName="TextareaWithFilePicker";const Xl=h.forwardRef(({className:s,style:e,...t},n)=>{const r=xs();return a.jsx("textarea",{className:B("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 md:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),style:{fontSize:r?$e.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:r?$e.chatInput.mobile.fontConfig.cssLineHeight:void 0,...e},ref:n,...t})});Xl.displayName="Textarea";const fS=[];function mS({sessionId:s,isVisible:e,onClose:t,onSendMessage:n,triggerPosition:r}){const o=Le(u=>{var f,m,g,x;return((x=(g=(m=(f=u.app)==null?void 0:f.claude)==null?void 0:m.ui)==null?void 0:g.messageQueues)==null?void 0:x[s])??fS}),i=u=>{var g,x,w,v,b,y;const f=le.getState(),m=((w=(x=(g=f.app)==null?void 0:g.claude)==null?void 0:x.ui)==null?void 0:w.messageQueues)??{};le.updateState({app:{...f.app,claude:{...(v=f.app)==null?void 0:v.claude,ui:{...(y=(b=f.app)==null?void 0:b.claude)==null?void 0:y.ui,messageQueues:{...m,[s]:u}}}}})},c=(u,f)=>{const m=o.map(g=>g.id===u?{...g,content:f}:g);i(m)},l=u=>{const f=o.filter(m=>m.id!==u);i(f)},d=u=>{const f=o.find(m=>m.id===u);f&&(n(f.content),l(u),t())},p=()=>{i([])};return a.jsx(Vt,{isVisible:e,onClose:t,title:`Message Queue (${o.length})`,triggerPosition:r,initialSize:{width:500,height:400},resizable:!0,children:a.jsx("div",{"data-test":"message-queue-content",className:"flex flex-col h-full",children:o.length===0?a.jsx("div",{"data-test":"message-queue-empty",className:"flex-1 flex items-center justify-center text-muted-foreground text-sm",children:'No queued messages. End a message with "qqq" or "queue" to add it here.'}):a.jsxs(a.Fragment,{children:[a.jsx(nn,{className:"flex-1 pr-4",children:a.jsx("div",{"data-test":"message-queue-list",className:"space-y-3 p-2",children:o.map((u,f)=>a.jsxs("div",{"data-test":"queue-item",className:"border rounded-lg p-3 space-y-2 bg-muted/30",children:[a.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[a.jsxs("span",{children:["#",f+1]}),a.jsx("span",{children:new Date(u.createdAt).toLocaleTimeString()})]}),a.jsx(Xl,{"data-test":"queue-item-textarea",value:u.content,onChange:m=>c(u.id,m.target.value),rows:3,className:"resize-y text-sm"}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(de,{"data-test":"queue-item-delete",variant:"ghost",size:"sm",onClick:()=>l(u.id),title:"Delete",children:a.jsx(St,{className:"h-4 w-4 text-destructive"})}),a.jsxs(de,{"data-test":"queue-item-send",variant:"outline",size:"sm",onClick:()=>d(u.id),title:"Send now",children:[a.jsx(Ln,{className:"h-4 w-4 mr-1"}),"Send"]})]})]},u.id))})}),a.jsx("div",{"data-test":"message-queue-footer",className:"flex justify-end gap-2 pt-3 border-t mt-2",children:a.jsx(de,{"data-test":"message-queue-clear-all",variant:"destructive",size:"sm",onClick:p,children:"Clear All"})})]})})})}const Or={outputFormat:"text",permissionMode:"acceptEdits"};function ka({variant:s="outline",size:e="sm",buttonLabel:t="Options",className:n,children:r,sessionId:o,onSendQueuedMessage:i}){const[c,l]=h.useState(!1),[d,p]=h.useState(!1),u=h.useRef(null),[f,m]=h.useState(),g=Le(y=>{var C,S,j,N,E;return o?((E=(N=(j=(S=(C=y.app)==null?void 0:C.claude)==null?void 0:S.ui)==null?void 0:j.messageQueues)==null?void 0:N[o])==null?void 0:E.length)??0:0}),x=()=>{if(u.current){const y=u.current.getBoundingClientRect();m({x:y.left,y:y.bottom+8})}l(!1),p(!0)},w=Le(y=>{var C,S,j;return(j=(S=(C=y.ui)==null?void 0:C.claude)==null?void 0:S.message)==null?void 0:j.options}),v={outputFormat:(w==null?void 0:w.outputFormat)??Or.outputFormat,permissionMode:(w==null?void 0:w.permissionMode)??Or.permissionMode};h.useEffect(()=>{var y,C,S;if(!w){const j=le.getState();le.updateState({ui:{...j.ui,claude:{...(y=j.ui)==null?void 0:y.claude,message:{...(S=(C=j.ui)==null?void 0:C.claude)==null?void 0:S.message,options:Or}}}})}},[w]);const b=y=>{var S,j,N;const C=le.getState();le.updateState({ui:{...C.ui,claude:{...(S=C.ui)==null?void 0:S.claude,message:{...(N=(j=C.ui)==null?void 0:j.claude)==null?void 0:N.message,options:y}}}})};return a.jsxs(a.Fragment,{children:[a.jsxs(st,{open:c,onOpenChange:l,children:[a.jsx(pt,{asChild:!0,children:a.jsxs(de,{variant:s,size:e,className:n,title:"Message Options","data-test":"message-options-button",children:[a.jsx(Ft,{className:"h-4 w-4"}),t&&a.jsx("span",{className:"ml-2",children:t})]})}),a.jsx(Qe,{className:"w-80",style:{zIndex:Je.draggablePopoverDropdown},onClick:y=>y.stopPropagation(),"data-test":"message-options-popover",children:a.jsxs("div",{className:"message-options-panel space-y-4","data-test":"message-options-panel",children:[a.jsxs("div",{className:"output-format-select","data-test":"output-format-select",children:[a.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Output Format"}),a.jsxs(Ut,{value:v.outputFormat,onValueChange:y=>b({...v,outputFormat:y}),children:[a.jsx(It,{"data-test":"output-format-trigger",children:a.jsx(Kt,{})}),a.jsxs(At,{"data-test":"output-format-content",children:[a.jsx(Oe,{value:"text","data-test":"output-format-text",children:"Text"}),a.jsx(Oe,{value:"json","data-test":"output-format-json",children:"JSON"}),a.jsx(Oe,{value:"stream-json","data-test":"output-format-stream-json",children:"Stream JSON"})]})]})]}),a.jsxs("div",{className:"permission-mode-select","data-test":"permission-mode-select",children:[a.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Permission Mode"}),a.jsxs(Ut,{value:v.permissionMode,onValueChange:y=>b({...v,permissionMode:y}),children:[a.jsx(It,{"data-test":"permission-mode-trigger",children:a.jsx(Kt,{})}),a.jsxs(At,{"data-test":"permission-mode-content",children:[a.jsx(Oe,{value:"default","data-test":"permission-mode-default",children:"Default"}),a.jsx(Oe,{value:"acceptEdits","data-test":"permission-mode-accept-edits",children:"Accept Edits"}),a.jsx(Oe,{value:"bypassPermissions","data-test":"permission-mode-bypass",children:"Bypass Permissions"}),a.jsx(Oe,{value:"plan","data-test":"permission-mode-plan",children:"Plan Mode"})]})]})]}),o&&a.jsx("div",{"data-test":"view-queue-section",className:"pt-2 border-t",children:a.jsxs(de,{ref:u,variant:"outline",size:"sm",className:"w-full justify-start",onClick:x,"data-test":"view-queue-button",children:[a.jsx(oc,{className:"h-4 w-4 mr-2"}),"View Queue",g>0&&a.jsx("span",{className:"ml-auto bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full",children:g})]})})]})})]}),o&&i&&a.jsx(mS,{sessionId:o,isVisible:d,onClose:()=>p(!1),onSendMessage:i,triggerPosition:f}),r==null?void 0:r(v)]})}const gS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.items)??[]},xS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.loading)??!1},vS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.error)??null},bS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.pagination)??null},wS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.currentPage)??1},yS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.favoritesOnly)??!1},SS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.forks)==null?void 0:n.isInitialized)??!1};function jS(s={}){const{loadOnMount:e=!1,parentSessionId:t,filterByCategory:n,filterByTag:r,includeChildren:o=!1,pageSize:i=20}=s,{update:c,getState:l}=Wa(),d=h.useRef(!1),p=Le(gS),u=Le(xS),f=Le(vS),m=Le(bS),g=Le(wS),x=Le(yS),w=Le(SS),v=h.useCallback(async(T=1,L=!1)=>{var _,P,G,$;try{const Y=(P=(_=l().app)==null?void 0:_.claude)==null?void 0:P.forks;c("app",{claude:{forks:{...Y,loading:!0,error:null,currentPage:T}}});const A={page:T,pageSize:i,sortBy:"createdAt",sortOrder:"desc"};t&&(A.parentSessionId=t),Y!=null&&Y.favoritesOnly&&(A.favoritesOnly=!0),n&&(A.category=n),r&&(A.tag=r),o!==void 0&&(A.includeChildren=o);const X=await Ve.getForks(A),I=(Y==null?void 0:Y.items)??[],k=L?[...I,...X.forks]:X.forks;c("app",{claude:{forks:{items:k,pagination:X.pagination,currentPage:T,loading:!1,error:null,favoritesOnly:(Y==null?void 0:Y.favoritesOnly)??!1,isInitialized:!0}}})}catch(Y){console.error("[useForks] API request failed:",{error:Y,errorMessage:Y instanceof Error?Y.message:"Unknown error",page:T,append:L,parentSessionId:t,timestamp:new Date().toISOString()});const A=($=(G=l().app)==null?void 0:G.claude)==null?void 0:$.forks;c("app",{claude:{forks:{items:L?(A==null?void 0:A.items)??[]:[],pagination:null,currentPage:T,loading:!1,error:Y instanceof Error?Y.message:"Failed to load forks",favoritesOnly:(A==null?void 0:A.favoritesOnly)??!1,isInitialized:!0}}})}},[c,l,t,n,r,o,i]),b=h.useCallback(()=>{var _,P;const T=(P=(_=l().app)==null?void 0:_.claude)==null?void 0:P.forks,L=!(T!=null&&T.favoritesOnly);c("app",{claude:{forks:{...T,favoritesOnly:L}}}),v(1)},[c,l,v]),y=h.useCallback(async T=>{var P,G,$,Y,A;const L=(($=(G=(P=l().app)==null?void 0:P.claude)==null?void 0:G.forks)==null?void 0:$.items)??[],_=L.find(X=>X.sessionId===T);if(_)try{const X=await Ve.updateFork(T,{isFavorite:!_.isFavorite}),I=L.map(M=>M.sessionId===T?X.fork:M),k=(A=(Y=l().app)==null?void 0:Y.claude)==null?void 0:A.forks;c("app",{claude:{forks:{...k,items:I}}})}catch(X){console.error("[useForks] Failed to toggle favorite:",{sessionId:T,error:X,errorMessage:X instanceof Error?X.message:"Unknown error",timestamp:new Date().toISOString()})}},[c,l]),C=h.useCallback(async(T,L)=>{try{return(await Ve.forkSession(T,L)).success?(v(1),!0):!1}catch(_){return console.error("[useForks] Failed to create fork:",{sessionId:T,request:L,error:_,errorMessage:_ instanceof Error?_.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[v]),S=h.useCallback(async T=>{var L,_;try{if((await Ve.deleteFork(T)).success){const G=(_=(L=l().app)==null?void 0:L.claude)==null?void 0:_.forks,Y=((G==null?void 0:G.items)??[]).filter(A=>A.sessionId!==T);return c("app",{claude:{forks:{...G,items:Y}}}),!0}return!1}catch(P){return console.error("[useForks] Failed to delete fork:",{sessionId:T,error:P,errorMessage:P instanceof Error?P.message:"Unknown error",timestamp:new Date().toISOString()}),!1}},[c,l]),j=h.useCallback(()=>{m&&g<m.totalPages&&v(g+1,!0)},[m,g,v]),N=h.useCallback(()=>{v(1)},[v]),E=h.useCallback(async(T,L)=>{var _,P;try{const G=await Ve.updateFork(T,L);if(G.success){const $=(P=(_=l().app)==null?void 0:_.claude)==null?void 0:P.forks,A=(($==null?void 0:$.items)??[]).map(X=>X.sessionId===T?G.fork:X);return c("app",{claude:{forks:{...$,items:A}}}),G.fork}return null}catch(G){return console.error("[useForks] Failed to update fork:",{sessionId:T,updates:L,error:G,errorMessage:G instanceof Error?G.message:"Unknown error",timestamp:new Date().toISOString()}),null}},[c,l]),R=h.useCallback((T,L)=>{var Y,A;const _=(A=(Y=l().app)==null?void 0:Y.claude)==null?void 0:A.forks,P=(_==null?void 0:_.items)??[],G=P.findIndex(X=>X.sessionId===T);if(G===-1)return;const $=[...P];$[G]={...$[G],...L},c("app",{claude:{forks:{..._,items:$}}})},[c,l]),D=h.useCallback(async()=>{try{return(await Ve.getForkTags()).tags}catch(T){return console.error("[useForks] Failed to get available tags:",{error:T,errorMessage:T instanceof Error?T.message:"Unknown error",timestamp:new Date().toISOString()}),[]}},[]);return h.useEffect(()=>{e&&(w||d.current||(d.current=!0,v(1)))},[e,w,v]),{forks:p,loading:u,error:f,pagination:m,currentPage:g,favoritesOnly:x,isInitialized:w,loadForks:v,refreshForks:N,handleLoadMore:j,toggleFavoritesOnly:b,toggleFavorite:y,createFork:C,deleteFork:S,updateFork:E,updateSingleFork:R,getAvailableTags:D}}const CS="Use @agent-code-worktree-specialist to help with this task.",NS="Please implement this feature following best practices and ensure all tests pass.";function Ea({variant:s="ghost",size:e="icon",className:t="create-session-panel-button",disabled:n=!1,icon:r,initialMessage:o,buttonTitle:i="Create New Session with Message",projectPath:c,initialForkSessionId:l,onOpen:d,onCreating:p,onSessionCreated:u,useModal:f=!1}){const[m,g]=h.useState(!1),[x,w]=h.useState(!1),[v,b]=h.useState(o||""),[y,C]=h.useState(o||""),[S,j]=h.useState(void 0),[N,E]=h.useState(!1),[R,D]=h.useState(null),[T,L]=h.useState(l??null),[_,P]=h.useState(""),G=h.useRef(null),{forks:$,loading:Y}=jS({loadOnMount:!0}),A=Le(ie=>{var K,ne,me;return(me=(ne=(K=ie.app)==null?void 0:K.claude)==null?void 0:ne.ui)==null?void 0:me.selectedProjectPath}),X=Le(ie=>{var K,ne;return(ne=(K=ie.ui)==null?void 0:K.global)==null?void 0:ne.createClaudeSessionPopoverSize}),I=X?{width:X.width}:void 0,k=ie=>{var ne;const K=le.getState();le.updateState({ui:{...K.ui,global:{...(ne=K.ui)==null?void 0:ne.global,createClaudeSessionPopoverSize:{width:ie.width}}}})};h.useEffect(()=>{o!==y&&(b(o||""),C(o||""))},[o,y]),h.useEffect(()=>{L(l??null)},[l]),h.useEffect(()=>{var ie,K,ne,me,ge,oe;if(m&&c&&c!=="none"){const Se=le.getState();((ne=(K=(ie=Se.app)==null?void 0:ie.claude)==null?void 0:K.ui)==null?void 0:ne.selectedProjectPath)!==c&&le.updateState({app:{...Se.app,claude:{...(me=Se.app)==null?void 0:me.claude,ui:{...(oe=(ge=Se.app)==null?void 0:ge.claude)==null?void 0:oe.ui,selectedProjectPath:c}}}})}},[m,c]);const M=()=>{if(!f&&G.current){const ie=G.current.getBoundingClientRect();j({x:ie.left,y:ie.bottom+8})}g(!0),d&&d()},U=()=>{g(!1)},q=(ie,K)=>{const ne=[];return K.usePrompt1&&K.prompt1Text&&ne.push(K.prompt1Text),K.usePrompt2&&K.prompt2Text&&ne.push(K.prompt2Text),ne.length>0?`${ne.join(`

`)}

${ie}`:ie},W=ie=>{const K=A??c;return{message:v.trim(),cwd:K,projectId:K,options:{outputFormat:ie.outputFormat,permissionMode:ie.permissionMode}}},V=async ie=>{if(console.log("ðŸŽ¯ [ButtonCreateSession] handleSendMessage called",{messageLength:v.trim().length,sessionOptions:ie,selectedForkSessionId:T,timestamp:new Date().toISOString()}),!v.trim()){console.log("âš ï¸ [ButtonCreateSession] Message is empty, aborting");return}try{if(console.log("ðŸ“¤ [ButtonCreateSession] Setting sending state to true"),w(!0),p&&(console.log("ðŸ“£ [ButtonCreateSession] Calling onCreating callback"),p()),T){console.log("ðŸ´ [ButtonCreateSession] Creating new fork from selected fork",{parentSessionId:T});const K=await Ve.forkSession(T,{description:`Fork for: ${v.trim().slice(0,50)}...`});if(console.log("âœ… [ButtonCreateSession] New fork created",{success:K.success,newSessionId:K.sessionId,parentSessionId:K.parentSessionId}),!K.success||!K.sessionId)throw new Error("Failed to create fork from selected session");console.log("ðŸ“¤ [ButtonCreateSession] Sending message to new fork",{sessionId:K.sessionId});const ne=await Ve.sendMessage({sessionId:K.sessionId,message:v.trim(),options:{outputFormat:ie.outputFormat,permissionMode:ie.permissionMode}});if(console.log("âœ… [ButtonCreateSession] Message sent to new fork",{success:ne.success,sessionId:ne.sessionId}),ne.success)_.trim()&&(console.log("ðŸ“ [ButtonCreateSession] Setting session title",{sessionId:ne.sessionId,title:_.trim()}),await Ve.updateSessionName(ne.sessionId,_.trim())),u&&u(ne.sessionId,ne.response),P(""),U();else throw new Error("Failed to send message to new fork session")}else{const K=W(ie);console.log("ðŸ“¦ [ButtonCreateSession] Request body built",{hasMessage:!!K.message,hasCwd:!!K.cwd,hasProjectId:!!K.projectId,optionsCount:Object.keys(K.options||{}).length}),console.log("ðŸš€ [ButtonCreateSession] Calling claudeAPI.createSession");const ne=await Ve.createSession(K);if(console.log("âœ… [ButtonCreateSession] API response received",{success:ne.success,hasSessionId:!!ne.sessionId,error:ne.error}),ne.success&&ne.sessionId)console.log("ðŸŽ‰ [ButtonCreateSession] Session created successfully",{sessionId:ne.sessionId}),_.trim()&&(console.log("ðŸ“ [ButtonCreateSession] Setting session title",{sessionId:ne.sessionId,title:_.trim()}),await Ve.updateSessionName(ne.sessionId,_.trim())),u&&(console.log("ðŸ“ž [ButtonCreateSession] Calling onSessionCreated callback"),u(ne.sessionId,ne.response)),P(""),U();else throw new Error(ne.error??"Failed to create session")}}catch(K){console.error("âŒ [ButtonCreateSession] Failed to create/resume session:",K)}finally{console.log("ðŸ [ButtonCreateSession] Setting sending state to false"),w(!1)}};return a.jsx(ur,{storageKey:"claude-session-prompts",initialConfig:{usePrompt1:!1,usePrompt2:!1,prompt1Text:CS,prompt2Text:NS},children:(ie,K,ne)=>{const me=(oe,Se)=>{const xe={...ie,[oe]:Se};K(xe);const Pe=q(o||"",xe);b(Pe)},ge=a.jsxs("div",{"data-test":"create-session-content",className:"content-wrapper p-4 space-y-4",children:[a.jsxs("div",{"data-test":"create-session-project-selector-section",className:"project-selector-container mb-4",children:[a.jsxs("div",{"data-test":"create-session-header",className:"flex items-center justify-between",children:[a.jsxs("div",{"data-test":"create-session-labels",className:"flex items-center gap-4",children:[a.jsx("label",{"data-test":"create-session-project-label",className:"project-selector-label text-sm font-medium",children:"Select Project"}),a.jsxs("label",{"data-test":"create-session-fork-label",className:"fork-selector-label text-sm font-medium flex items-center gap-1",children:[a.jsx(es,{className:"h-3 w-3"}),"Fork From"]})]}),a.jsx(ne,{title:"Prompt Configuration",buttonClassName:"prompt-config-button",children:a.jsxs("div",{"data-test":"prompt-config-panel",className:"prompt-config-panel space-y-4",onClick:oe=>oe.stopPropagation(),children:[a.jsxs("div",{"data-test":"prompt-checkbox-1-container",className:"prompt-checkbox-container flex items-center space-x-2",children:[a.jsx(kt,{"data-test":"prompt-checkbox-1",id:"use-prompt-1",checked:ie.usePrompt1,onCheckedChange:oe=>me("usePrompt1",oe===!0)}),a.jsx(je,{htmlFor:"use-prompt-1",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 1"})]}),a.jsx("div",{"data-test":"prompt-text-display-1",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:ie.prompt1Text}),a.jsxs("div",{"data-test":"prompt-checkbox-2-container",className:"prompt-checkbox-container flex items-center space-x-2 mt-4",children:[a.jsx(kt,{"data-test":"prompt-checkbox-2",id:"use-prompt-2",checked:ie.usePrompt2,onCheckedChange:oe=>me("usePrompt2",oe===!0)}),a.jsx(je,{htmlFor:"use-prompt-2",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 2"})]}),a.jsx("div",{"data-test":"prompt-text-display-2",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:ie.prompt2Text})]})})]}),a.jsxs("div",{"data-test":"create-session-selectors",className:"flex gap-2 mt-2",children:[a.jsx("div",{className:`flex-1 ${T?"opacity-50 pointer-events-none":""}`,children:a.jsx(Fc,{"data-test":"create-session-project-selector",variant:"select",className:"project-selector w-full"})}),a.jsxs(Ut,{value:T??"none",onValueChange:oe=>L(oe==="none"?null:oe),children:[a.jsx(It,{"data-test":"create-session-fork-selector",className:"fork-selector flex-1",children:a.jsx(Kt,{placeholder:"No fork (new session)"})}),a.jsxs(At,{"data-test":"create-session-fork-options",style:{zIndex:Je.draggablePopoverDropdown},children:[a.jsx(Oe,{value:"none","data-test":"fork-option-none",children:a.jsx("span",{className:"text-muted-foreground",children:"No fork (new session)"})}),Y?a.jsx(Oe,{value:"loading",disabled:!0,children:"Loading forks..."}):$.map(oe=>a.jsx(Oe,{value:oe.sessionId,"data-test":"fork-option-item",children:a.jsxs("div",{className:"flex flex-col items-start",children:[a.jsx("span",{className:"font-medium",children:oe.sessionName??oe.description??`Fork ${oe.sessionId.slice(0,8)}`}),a.jsxs("span",{className:"text-xs text-muted-foreground",children:[oe.messageCount??0," messages"]})]})},oe.id))]})]})]}),a.jsx("div",{"data-test":"create-session-title-container",className:"mt-2",onClick:oe=>oe.stopPropagation(),onMouseDown:oe=>oe.stopPropagation(),children:a.jsx(We,{"data-test":"create-session-title-input",value:_,onChange:oe=>P(oe.target.value),placeholder:"Session title (optional)",className:"session-title-input"})})]}),a.jsxs("div",{"data-test":"create-session-message-container",className:"new-session-input-container space-y-3",children:[a.jsx(ns,{"data-test":"create-session-textarea",value:v,onChange:oe=>b(oe.target.value),placeholder:"Type your message...",rows:10,className:"resize-y"}),a.jsx("div",{"data-test":"create-session-actions",className:"flex justify-end gap-2 items-center",children:a.jsx(ka,{variant:"outline",size:"sm",buttonLabel:"Options",className:"session-options-button","data-test":"create-session-options-button",children:oe=>a.jsx(fr,{"data-test":"create-session-send-button",label:a.jsxs(a.Fragment,{children:[T?a.jsx(es,{className:"h-4 w-4 mr-2"}):a.jsx(Ln,{className:"h-4 w-4 mr-2"}),x?T?"Forking...":"Creating Session...":T?"Fork & Send":"Create Session"]}),onAction:()=>{console.log("ðŸ‘† [ButtonCreateSession] ConfigurableButton onAction triggered",{messageLength:v.trim().length,sending:x,selectedForkSessionId:T,disabled:!v.trim()||x,timestamp:new Date().toISOString()}),V(oe)},disabled:!v.trim()||x,variant:"default",configOptions:[{label:"Preview Request Body",value:"preview",onClick:()=>{D(oe),E(!0)},icon:a.jsx(Jr,{className:"h-4 w-4"})}],showHint:!0,tooltipText:T?"Click to fork and send message":"Click to send, hold to preview request",ariaLabel:T?"Fork and Send button":"Create Session button with preview option"})})}),N&&R&&a.jsx(Fn,{open:N,onOpenChange:E,children:a.jsxs($n,{className:"sm:max-w-[600px] max-h-[70vh] overflow-y-auto",children:[a.jsx(Un,{children:a.jsx(Zs,{children:"Request Body Preview"})}),a.jsx("pre",{className:"request-preview-content bg-muted p-4 rounded-md text-xs font-mono overflow-x-auto whitespace-pre-wrap",children:JSON.stringify(W(R),null,2)}),a.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[a.jsx(de,{variant:"outline",onClick:()=>E(!1),children:"Close"}),a.jsxs(de,{onClick:()=>{E(!1),V(R)},children:[a.jsx(Ln,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})]});return a.jsxs(a.Fragment,{children:[a.jsx(de,{ref:G,"data-test":"create-session-button",variant:s,size:e,disabled:n,className:t,title:i,onClick:M,children:r??a.jsx(Yr,{className:"h-4 w-4 hover:text-purple-500 transition-colors"})}),f?a.jsx(Fn,{open:m,onOpenChange:g,children:a.jsxs($n,{"data-test":"create-session-dialog",className:"sm:max-w-[700px] max-h-[80vh] overflow-y-auto",children:[a.jsx(Un,{children:a.jsx(Zs,{children:"Create New Session"})}),ge]})}):a.jsx(Vt,{"data-test":"create-session-popover",isVisible:m,onClose:U,title:"Create New Session",className:"max-h-[80vh]",shouldCloseManually:!0,resizable:!0,initialSize:I||{width:700},onSizeChange:k,triggerPosition:S,children:ge})]})}})}function gi({buttonLabel:s,icon:e=a.jsx(ar,{className:"h-5 w-5"}),variant:t="ghost",size:n="icon",buttonClassName:r="",contentClassName:o="",align:i="end",side:c="bottom",title:l="Audio Recorder"}){const[d,p]=h.useState(!1);return a.jsxs(st,{open:d,onOpenChange:p,"data-test":"audio-recorder-popover",children:[a.jsx(pt,{asChild:!0,children:a.jsx(de,{variant:t,size:n,className:`audio-recorder-button ${r}`,title:l,"data-test":"audio-recorder-trigger-button",children:s?a.jsxs(a.Fragment,{children:[e,s&&a.jsx("span",{className:"ml-2","data-test":"audio-recorder-button-label",children:s})]}):e})}),a.jsxs(Qe,{className:`audio-recorder-panel w-[400px] ${o}`,align:i,side:c,"data-test":"audio-recorder-popover-content",children:[l&&a.jsx("div",{className:"audio-panel-header pb-2 mb-2 border-b border-border","data-test":"audio-recorder-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"audio-recorder-panel-title",children:l})}),a.jsx("div",{className:"audio-panel-content","data-test":"audio-recorder-panel-content",children:a.jsx(ns,{})})]})]})}const Ql=ep,lo=h.forwardRef(({className:s,...e},t)=>a.jsx(tc,{ref:t,className:B("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",s),...e}));lo.displayName=tc.displayName;const an=h.forwardRef(({className:s,...e},t)=>a.jsx(sc,{ref:t,className:B("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",s),...e}));an.displayName=sc.displayName;const on=h.forwardRef(({className:s,...e},t)=>a.jsx(nc,{ref:t,className:B("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...e}));on.displayName=nc.displayName;var Gt=(s=>(s.LOW="low",s.MEDIUM="medium",s.HIGH="high",s.URGENT="urgent",s))(Gt||{}),Xe=(s=>(s.FREEZER="freezer",s.BACKLOG="backlog",s.SELECTED="selected",s.DOING="doing",s.DONE="done",s.ARCHIVE="archive",s))(Xe||{}),Qt=(s=>(s.PERSONAL="personal",s.WORK="work",s.SHOPPING="shopping",s.HEALTH="health",s.OTHER="other",s))(Qt||{});function Zl({trigger:s,children:e,open:t,onOpenChange:n,contentClassName:r,side:o="bottom",align:i="start","data-test":c}){const[l,d]=h.useState(!1),p=h.useRef(null),u=h.useRef(null),[f,m]=h.useState(null),[g,x]=h.useState(!1),w=t!==void 0,v=w?t:l,b=h.useCallback(j=>{w||d(j),n==null||n(j)},[w,n]),y=h.useCallback(()=>{b(!1),m(null),x(!1)},[b]),C=h.useCallback((j,N)=>{var P;const E=(P=p.current)==null?void 0:P.getBoundingClientRect();if(!E||E.width===0||E.height===0)return null;const R=window.innerWidth,D=window.innerHeight,T=8;let L=0,_=0;return o==="bottom"?L=E.bottom+4:o==="top"?L=E.top-N-4:o==="left"?(_=E.left-j-4,L=E.top):o==="right"&&(_=E.right+4,L=E.top),(o==="bottom"||o==="top")&&(i==="start"?_=E.left:i==="center"?_=E.left+E.width/2-j/2:i==="end"&&(_=E.right-j)),(o==="left"||o==="right")&&(i==="start"?L=E.top:i==="center"?L=E.top+E.height/2-N/2:i==="end"&&(L=E.bottom-N)),_+j>R-T&&(_=R-j-T),_<T&&(_=T),L+N>D-T&&(o==="bottom"?L=E.top-N-4:L=D-N-T),L<T&&(o==="top"?L=E.bottom+4:L=T),{top:L,left:_}},[o,i]);h.useLayoutEffect(()=>{if(!v||!p.current||!u.current)return;const j=u.current.offsetWidth,N=u.current.offsetHeight,E=C(j,N);E&&(m(E),requestAnimationFrame(()=>{x(!0)}))},[v,C]),h.useEffect(()=>{if(!v||!g)return;const j=()=>{const N=u.current;if(!N)return;const E=N.offsetWidth,R=N.offsetHeight,D=C(E,R);D&&m(D)};return window.addEventListener("scroll",j,!0),window.addEventListener("resize",j),()=>{window.removeEventListener("scroll",j,!0),window.removeEventListener("resize",j)}},[v,g,C]);const S=h.useCallback(j=>{j.preventDefault(),j.stopPropagation(),v?y():b(!0)},[v,y,b]);return a.jsxs("div",{className:"relative inline-flex flex-shrink-0 cursor-pointer",ref:p,onClick:S,"data-test":c?`${c}-trigger`:void 0,children:[s,v&&Oa.createPortal(a.jsxs(a.Fragment,{children:[g&&a.jsx("div",{className:"fixed inset-0",style:{zIndex:Je.popover-1},onClick:y,"data-test":c?`${c}-backdrop`:void 0}),a.jsx("div",{ref:u,className:B("fixed rounded-md border bg-popover p-3 text-popover-foreground shadow-md",r),style:{zIndex:Je.popover,top:f?`${f.top}px`:0,left:f?`${f.left}px`:0,visibility:g?"visible":"hidden"},onClick:j=>j.stopPropagation(),onPointerDown:j=>j.stopPropagation(),"data-test":c,children:e})]}),document.body)]})}function kS({children:s,buttonLabel:e,icon:t=a.jsx(Ft,{className:"h-4 w-4"}),variant:n="ghost",size:r="icon",buttonClassName:o="",contentClassName:i="",align:c="end",side:l="bottom",title:d}){return a.jsxs(Zl,{"data-test":"config-popover",contentClassName:`config-panel ${i}`,side:l,align:c,trigger:a.jsx(de,{variant:n,size:r,className:`config-button ${o}`,title:d||"Configuration","data-test":"config-button",children:e?a.jsxs(a.Fragment,{children:[t,e&&a.jsx("span",{className:"ml-2","data-test":"config-button-label",children:e})]}):t}),children:[d&&a.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:a.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:d})}),a.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:s})]})}function ed({session:s,segmentsToStrip:e=3,onNameUpdated:t}){const[n,r]=h.useState(!1),[o,i]=h.useState(""),[c,l]=h.useState(!1),d=h.useRef(null),p=h.useRef(0),u=h.useMemo(()=>{const{name:v,cwd:b}=s;if(!v.startsWith("-home-"))return v;let C=v;const S=/\/[a-f0-9]{8}[a-f0-9-]*$/i;C=C.replace(S,""),C.startsWith("-")&&(C=C.substring(1));const j="/"+C.replace(/-/g,"/");b&&j.startsWith(b);const N=j.split("/").filter(Boolean);return e>0&&N.length>e?N.slice(e).join("/"):N.length===0?v:N.join("/")},[s,e]),f=s.customName||u;h.useEffect(()=>{n&&d.current&&(d.current.focus(),d.current.select())},[n]);const m=()=>{i(s.customName||""),r(!0)},g=v=>{const b=Date.now(),y=b-p.current;y<300&&y>0&&(v.preventDefault(),m()),p.current=b},x=async()=>{if(!c)try{l(!0);const v=o.trim()===""?null:o.trim();await Ve.updateSessionName(s.id,v),t==null||t(),r(!1)}catch(v){console.error("Failed to update session name:",v),alert("Failed to update session name")}finally{l(!1)}},w=v=>{v.key==="Enter"?x():v.key==="Escape"&&r(!1)};return n?a.jsxs("div",{className:"session-name-edit flex items-center gap-2","data-test":"session-name-edit-container",children:[a.jsx("input",{ref:d,type:"text",value:o,onChange:v=>i(v.target.value),onKeyDown:w,onBlur:()=>r(!1),className:"flex-1 px-2 py-1 border rounded",placeholder:u,disabled:c,"data-test":"session-name-input"}),a.jsx("button",{onMouseDown:v=>{v.preventDefault(),x()},disabled:c,className:"session-name-save-btn p-1 hover:bg-gray-100 rounded",title:"Save (Enter)","data-test":"session-name-save-button",children:a.jsx(ct,{className:"w-4 h-4"})})]}):a.jsx("span",{className:"session-name-display cursor-pointer hover:underline",style:{touchAction:"manipulation"},onPointerDown:g,onDoubleClick:m,title:"Double-click to edit","data-test":"session-name-display",children:f})}function ES({sessionIds:s=[],className:e="",title:t="Claude session is running",showCount:n=!1,lastActiveTime:r,isCreating:o=!1}){const[i,c]=h.useState({}),[l,d]=h.useState([]),p=h.useRef(s);h.useEffect(()=>{p.current=s},[s]),h.useEffect(()=>{var E,R,D;const j=((D=(R=(E=le.get("app"))==null?void 0:E.claude)==null?void 0:R.data)==null?void 0:D.sessions)??[];d(j);const N=le.selectSlice(T=>{var L,_,P;return(P=(_=(L=T.app)==null?void 0:L.claude)==null?void 0:_.data)==null?void 0:P.sessions}).subscribe(T=>{d(T??[])});return()=>N.unsubscribe()},[]);const u=h.useMemo(()=>{if(r!==void 0)return r;if(!s.length||!l.length)return;const j=l.filter(E=>s.includes(E.id));if(!j.length)return;const N=j.reduce((E,R)=>{const D=new Date(R.lastModified).getTime();return D>E?D:E},0);return N>0?N:void 0},[r,s,l]);h.useEffect(()=>{var T,L,_;const j=P=>{if(!P)return{};const G={};for(const $ of p.current)P[$]&&(G[$]=P[$]);return G},N=(P,G)=>{const $=Object.keys(P),Y=Object.keys(G);if($.length!==Y.length)return!0;for(const A of Y)if(!P[A]||P[A].isOpened!==G[A].isOpened||P[A].isProcessing!==G[A].isProcessing)return!0;return!1},E=((_=(L=(T=le.get("app"))==null?void 0:T.claude)==null?void 0:L.ui)==null?void 0:_.activity)??{},R=j(E);c(R);const D=le.selectSlice(P=>{var G,$,Y;return(Y=($=(G=P.app)==null?void 0:G.claude)==null?void 0:$.ui)==null?void 0:Y.activity}).subscribe(P=>{const G=j(P);c($=>N($,G)?G:$)});return()=>D.unsubscribe()},[]);const f=h.useCallback(j=>{const N=i[j];if(N!=null&&N.isProcessing)return"running";if(N!=null&&N.isOpened&&!(N!=null&&N.isProcessing))return"opened";if(u){const E=Date.now()-36e5;if(u>E)return"recent"}return"inactive"},[i,u]),m=j=>{switch(j){case"running":return{status:"running",color:"bg-green-500",bgColor:"bg-green-500",textColor:"text-green-600"};case"opened":return{status:"opened",color:"bg-orange-500",bgColor:"bg-orange-500",textColor:"text-orange-600"};case"recent":return{status:"recent",color:"bg-yellow-500",bgColor:"bg-yellow-500",textColor:"text-yellow-600"};case"inactive":default:return{status:"inactive",color:"bg-gray-400",bgColor:"bg-gray-400",textColor:"text-gray-500"}}},g=h.useMemo(()=>s.map(j=>({id:j,status:f(j)})).filter(j=>j.status!=="inactive"),[s,f]),x=g.length>0,w=h.useMemo(()=>g.some(j=>j.status==="running")?"running":g.some(j=>j.status==="opened")?"opened":g.some(j=>j.status==="recent")?"recent":"inactive",[g]),v=m(w),b=h.useMemo(()=>{if(n&&g.length>1){const N={running:"running",opened:"opened",recent:"recently active",inactive:"inactive"}[w];return`${g.length} Claude sessions ${N}`}const j={running:"Claude session is running",opened:"Claude session is opened",recent:"Claude session recently active",inactive:"Claude session inactive"}[w];return t||j},[n,g.length,w,t]);if(!x&&!o)return null;const y=o?"running":w,C=o?m("running"):v,S=o?"Creating Claude session...":b;return a.jsxs("div",{className:`session-activity-indicator flex items-center gap-1 ${e}`,title:S,"data-test":"session-activity-indicator",children:[a.jsx("div",{className:`activity-dot w-2 h-2 ${C.bgColor} rounded-full ${y==="running"?"animate-pulse":""}`,"data-test":"activity-dot","data-activity-status":y,"data-is-creating":o}),n&&g.length>1&&a.jsx("span",{className:`activity-count text-xs ${C.textColor} font-medium`,"data-test":"activity-count",children:g.length})]})}function TS(s,e){if(s.className!==e.className||s.title!==e.title||s.showCount!==e.showCount||s.lastActiveTime!==e.lastActiveTime||s.isCreating!==e.isCreating)return!1;const t=s.sessionIds??[],n=e.sessionIds??[];return t.length!==n.length?!1:t.every((r,o)=>r===n[o])}const uo=h.memo(ES,TS),IS=[{value:"user",label:"User Messages",description:"Pure user messages (no tool content)"},{value:"assistant",label:"Assistant Responses",description:"Pure assistant responses (no thinking/tool blocks)"},{value:"thinking",label:"Thinking Blocks",description:"Messages containing thinking blocks"},{value:"tools",label:"Tool Calls/Results",description:"Messages containing tool_use or tool_result blocks"}],td=h.forwardRef(({searchQuery:s,onSearchChange:e,onAdvancedSearch:t,className:n},r)=>{const[o,i]=h.useState(!1),[c,l]=h.useState({messageType:[],sortOrder:"desc",pageSize:50}),d=h.useMemo(()=>{const{sortOrder:w,pageSize:v,messageType:b,...y}=c,C=Object.values(y).some(N=>N!==void 0),S=b&&b.length>0;return C||S||w!=="desc"},[c]),p=(w,v)=>{l(b=>({...b,[w]:v}))},u=(w,v)=>{l(b=>{const y=b.messageType||[],C=v?[...y,w]:y.filter(S=>S!==w);return{...b,messageType:C.length>0?C:[]}})},f=()=>{t&&t(s,c),i(!1)},m=()=>{l({messageType:[],sortOrder:"desc",pageSize:50})},g=w=>{w.key==="Enter"&&t&&t(s,c)},x=()=>{e("")};return a.jsx("div",{ref:r,className:B("messages-search-container relative",n),"data-test":"messages-search-container",children:a.jsxs("div",{className:"search-input-wrapper relative flex items-center gap-1","data-test":"messages-search-input-wrapper",children:[a.jsx(cr,{className:"search-icon absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10","data-test":"messages-search-icon"}),a.jsx(We,{type:"text",placeholder:"Search messages...",value:s,onChange:w=>e(w.target.value),onKeyDown:g,className:B("search-input pl-9",s?"pr-16":"pr-10"),"data-test":"messages-search-input"}),s&&a.jsx(de,{variant:"ghost",size:"icon",onClick:x,className:"clear-button absolute right-9 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"messages-search-clear-button",children:a.jsx(ft,{className:"h-4 w-4"})}),d&&a.jsx("div",{className:B("filter-indicator absolute top-1/2 -translate-y-1/2 h-2 w-2 rounded-full bg-primary pointer-events-none z-10",s?"right-17":"right-11"),"data-test":"messages-search-filter-indicator"}),a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(pt,{asChild:!0,children:a.jsx(de,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0","aria-label":o?"Collapse advanced search":"Expand advanced search","data-test":"messages-search-expand-button",children:o?a.jsx(ir,{className:"h-4 w-4"}):a.jsx(ut,{className:"h-4 w-4"})})}),a.jsxs(Qe,{align:"start",className:"advanced-search-panel w-96 max-h-[600px] overflow-y-auto","data-test":"messages-advanced-search-panel",children:[a.jsxs("div",{className:"panel-header space-y-2 pb-3 border-b","data-test":"messages-panel-header",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),a.jsx(de,{variant:"ghost",size:"sm",onClick:m,className:"h-7 text-xs","data-test":"messages-clear-filters-button",children:"Clear All"})]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Search message content with filters"})]}),a.jsxs("div",{className:"panel-content space-y-4 py-4","data-test":"messages-panel-content",children:[a.jsxs("div",{className:"message-types-filter space-y-2","data-test":"messages-types-section",children:[a.jsx(je,{className:"text-sm font-medium",children:"Message Types"}),a.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Filter by message type"}),a.jsx("div",{className:"message-types-grid space-y-2",children:IS.map(w=>{var v;return a.jsxs("div",{className:"message-type-item flex items-center space-x-2",children:[a.jsx(kt,{id:`msgtype-${w.value}`,checked:(v=c.messageType)==null?void 0:v.includes(w.value),onCheckedChange:b=>u(w.value,b===!0),"data-test":"messages-message-type-checkbox"}),a.jsxs("label",{htmlFor:`msgtype-${w.value}`,className:"text-sm cursor-pointer flex-1",children:[a.jsx("span",{children:w.label}),a.jsx("span",{className:"text-xs text-muted-foreground block",children:w.description})]})]},w.value)})})]}),a.jsxs("div",{className:"timestamp-range-filter space-y-2",children:[a.jsx(je,{className:"text-sm font-medium",children:"Timestamp Range"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"timestamp-input-wrapper",children:[a.jsx(je,{htmlFor:"timestamp-after",className:"text-xs text-muted-foreground",children:"After"}),a.jsx(We,{id:"timestamp-after",type:"datetime-local",value:c.after??"",onChange:w=>p("after",w.target.value||void 0),className:"h-8"})]}),a.jsxs("div",{className:"timestamp-input-wrapper",children:[a.jsx(je,{htmlFor:"timestamp-before",className:"text-xs text-muted-foreground",children:"Before"}),a.jsx(We,{id:"timestamp-before",type:"datetime-local",value:c.before??"",onChange:w=>p("before",w.target.value||void 0),className:"h-8"})]})]})]}),a.jsxs("div",{className:"sorting-section space-y-2",children:[a.jsx(je,{className:"text-sm font-medium",children:"Sort By Timestamp"}),a.jsxs(Ut,{value:c.sortOrder,onValueChange:w=>p("sortOrder",w),children:[a.jsx(It,{className:"h-8",children:a.jsx(Kt,{})}),a.jsxs(At,{children:[a.jsx(Oe,{value:"desc",children:"Newest First"}),a.jsx(Oe,{value:"asc",children:"Oldest First"})]})]})]}),a.jsxs("div",{className:"pagination-section space-y-2",children:[a.jsx(je,{className:"text-sm font-medium",children:"Results Per Page"}),a.jsx(We,{type:"number",min:"1",max:"100",value:c.pageSize??50,onChange:w=>p("pageSize",w.target.value?parseInt(w.target.value):50),className:"h-8"})]})]}),a.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 border-t","data-test":"messages-panel-footer",children:[a.jsx(de,{onClick:f,className:"flex-1",size:"sm","data-test":"messages-apply-search-button",children:"Apply Search"}),a.jsx(de,{onClick:()=>i(!1),variant:"outline",size:"sm","data-test":"messages-cancel-button",children:"Cancel"})]})]})]})]})})});td.displayName="MessagesSearch";function ss({onClick:s,textToCopy:e,title:t="Copy formatted text",size:n="icon",variant:r="ghost"}){const[o,i]=h.useState(!1),c=async()=>{if(s){s();return}if(!e){Ne.error("No text to copy");return}try{await navigator.clipboard.writeText(e),i(!0),Ne.success("Copied to clipboard!"),setTimeout(()=>i(!1),2e3)}catch(l){Ne.error("Failed to copy to clipboard"),console.error("Copy failed:",l)}};return a.jsx(de,{onClick:c,title:t,size:n,variant:r,children:o?a.jsx(ct,{}):a.jsx(dr,{})})}function AS(s){return s.name==="Bash"}function PS(s){return s.name==="TodoWrite"}function sd(s){return s.name==="ExitPlanMode"}function RS(s){return s.name==="Task"}function nd(s){return s.name==="AskUserQuestion"}function rd(s){return typeof s=="object"&&s!==null&&"type"in s&&s.type==="tool_use"}const ad=h.forwardRef(({className:s,...e},t)=>a.jsx(rc,{className:B("grid gap-2",s),...e,ref:t}));ad.displayName=rc.displayName;const od=h.forwardRef(({className:s,...e},t)=>a.jsx(ac,{ref:t,className:B("aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",s),...e,children:a.jsx(tp,{className:"flex items-center justify-center",children:a.jsx(Ys,{className:"h-3.5 w-3.5 fill-primary -translate-y-[2px]"})})}));od.displayName=ac.displayName;const DS=s=>{var t,n,r;const e=le.getState();le.updateState({ui:{...e.ui,claude:{...(t=e.ui)==null?void 0:t.claude,message:{...(r=(n=e.ui)==null?void 0:n.claude)==null?void 0:r.message,prefill:s}}}})},po=h.memo(({toolBlock:s})=>{const{questions:e}=s.input,[t,n]=h.useState({}),r=h.useCallback(c=>{const l=[];e.forEach((d,p)=>{const u=c[p];if(u!==void 0)if(d.multiSelect&&u instanceof Set){const f=Array.from(u).sort().map(m=>d.options[m].label);f.length>0&&l.push(`**${d.header}**: ${f.join(", ")}`)}else typeof u=="number"&&l.push(`**${d.header}**: ${d.options[u].label}`)}),DS(l.join(`
`))},[e]),o=h.useCallback((c,l,d)=>{const p=d.findIndex(u=>u.label===l);p!==-1&&n(u=>{const f={...u,[c]:p};return r(f),f})},[r]),i=h.useCallback((c,l,d)=>{n(p=>{const u=p[c]instanceof Set?p[c]:new Set,f=new Set(u);d?f.add(l):f.delete(l);const m={...p,[c]:f};return r(m),m})},[r]);return a.jsxs("div",{className:"ask-user-question-block bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-ask-user-question",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"ask-user-header",children:[a.jsx(Tp,{className:"h-4 w-4 text-muted-foreground"}),a.jsxs("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:["Question",e.length>1?"s":""]})]}),a.jsx("div",{className:"questions-list space-y-4","data-test":"questions-list",children:e.map((c,l)=>a.jsxs("div",{className:"question-item","data-test":"question-item",children:[a.jsxs("div",{className:"question-header flex items-center gap-2 mb-1",children:[a.jsx("span",{className:"text-xs font-medium text-muted-foreground bg-muted-foreground/10 px-1.5 py-0.5 rounded","data-test":"question-tag",children:c.header}),c.multiSelect&&a.jsx("span",{className:"text-xs text-muted-foreground/70","data-test":"multi-select-indicator",children:"(select multiple)"})]}),a.jsx("p",{className:"question-text text-sm mb-2","data-test":"question-text",children:c.question}),c.multiSelect?a.jsx("div",{className:"options-list space-y-2","data-test":"options-list-checkbox",children:c.options.map((d,p)=>{const u=t[l]instanceof Set?t[l]:new Set;return a.jsxs("div",{className:"option-item flex items-start gap-2","data-test":"option-item",children:[a.jsx(kt,{id:`q${l}-opt${p}`,className:"mt-0.5",checked:u.has(p),onCheckedChange:f=>i(l,p,!!f),"data-test":"option-checkbox"}),a.jsxs(je,{htmlFor:`q${l}-opt${p}`,className:"text-sm cursor-pointer leading-tight",children:[a.jsx("span",{className:"font-medium","data-test":"option-label",children:d.label}),d.description&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1","data-test":"option-description",children:["â€” ",d.description]})]})]},p)})}):a.jsx(ad,{className:"space-y-2",value:typeof t[l]=="number"?c.options[t[l]].label:void 0,onValueChange:d=>o(l,d,c.options),"data-test":"options-list-radio",children:c.options.map((d,p)=>a.jsxs("div",{className:"option-item flex items-start gap-2","data-test":"option-item",children:[a.jsx(od,{value:d.label,id:`q${l}-opt${p}`,className:"mt-0.5","data-test":"option-radio"}),a.jsxs(je,{htmlFor:`q${l}-opt${p}`,className:"text-sm cursor-pointer leading-tight",children:[a.jsx("span",{className:"font-medium","data-test":"option-label",children:d.label}),d.description&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1","data-test":"option-description",children:["â€” ",d.description]})]})]},p))})]},l))})]})});po.displayName="AskUserQuestionBlock";const id=h.memo(({toolBlock:s})=>{const{plan:e}=s.input;return e?a.jsxs("div",{className:"plan-block bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-plan",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"plan-header",children:[a.jsx(Js,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Plan"})]}),a.jsx("div",{className:"plan-content prose prose-sm dark:prose-invert max-w-none text-sm [&_h1]:text-lg [&_h1]:font-bold [&_h1]:mt-3 [&_h1]:mb-2 [&_h2]:text-base [&_h2]:font-semibold [&_h2]:mt-3 [&_h2]:mb-1 [&_h3]:text-sm [&_h3]:font-semibold [&_h3]:mt-2 [&_h3]:mb-1 [&_pre]:bg-background/50 [&_pre]:p-2 [&_pre]:rounded [&_pre]:text-xs [&_pre]:overflow-x-auto [&_code]:text-xs [&_code]:bg-background/50 [&_code]:px-1 [&_code]:rounded [&_.list-item-ul]:flex [&_.list-item-ul]:ml-2 [&_.list-item-ol]:flex [&_.list-item-ol]:ml-2","data-test":"plan-content",dangerouslySetInnerHTML:{__html:at(e)}})]}):null});id.displayName="PlanBlock";const Ta=h.memo(({messages:s,renderMessage:e})=>{const[t,n]=h.useState(!1),{askUserQuestionBlocks:r,planBlocks:o}=h.useMemo(()=>{const p=[],u=[];for(const f of s)if(Array.isArray(f.content))for(const m of f.content)rd(m)&&(nd(m)?p.push(m):sd(m)&&m.input.plan&&u.push(m));return{askUserQuestionBlocks:p,planBlocks:u}},[s]),i=s.map(p=>{if(!Array.isArray(p.content))return"Tool";for(const u of p.content){if(typeof u=="object"&&u.type==="tool_use"&&"name"in u)return u.name;if(typeof u=="object"&&u.type==="tool_result")return"Result"}return"Tool"}),c=h.useMemo(()=>{for(const p of s)if(Array.isArray(p.content)){for(const u of p.content)if(typeof u=="object"&&u.type==="tool_use"&&"name"in u&&u.name==="Bash"&&"input"in u&&typeof u.input=="object"&&u.input!==null&&"command"in u.input&&typeof u.input.command=="string"&&u.input.command.includes("git commit -m"))return!0}return!1},[s]),l=[...new Set(i)];let d=l.length<=3?l.join(", "):`${l.slice(0,2).join(", ")} +${l.length-2} more`;return c&&(d=`Committed, ${d}`),a.jsxs("div",{className:"tool-call-group w-full space-y-2","data-test":"tool-call-group","data-test-tool-count":s.length,children:[a.jsxs("button",{onClick:()=>n(!t),className:"tool-group-header flex items-center gap-2 w-full py-2 rounded-lg hover:bg-muted/50 transition-colors","data-test":"tool-group-toggle",children:[t?a.jsx(ut,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}):a.jsx(yt,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),a.jsxs("span",{className:"text-xs uppercase text-muted-foreground","data-test":"tool-group-label",children:[s.length," Tool Call",s.length!==1?"s":""]}),!t&&a.jsx("span",{className:"text-xs text-muted-foreground/70 font-mono truncate","data-test":"tool-group-summary",children:d})]}),t&&a.jsx("div",{className:"tool-group-content space-y-2 mt-2 pl-4 border-l-2 border-muted-foreground/20","data-test":"tool-group-content",children:s.map(p=>e(p))}),o.length>0&&a.jsx(id,{toolBlock:o[o.length-1]},`plan-${o[o.length-1].id}`),r.length>0&&a.jsx(po,{toolBlock:r[r.length-1]},`ask-user-${r[r.length-1].id}`)]})});Ta.displayName="ToolCallGroup";const Ia=s=>{if(s==null)return s;if(typeof s=="number")return Math.round(s*10)/10;if(Array.isArray(s))return s.map(Ia);if(typeof s=="object"){const e={};for(const[t,n]of Object.entries(s))e[t]=Ia(n);return e}return s};class _S{constructor(){ee(this,"logs",[]);ee(this,"logsByGroup",new Map);ee(this,"maxLogs",200);ee(this,"enabled",!0)}setEnabled(e){this.enabled=e}isEnabled(){return this.enabled}setMaxLogs(e){this.maxLogs=e,this.trimLogs()}debug(e,t,n,r){this.addLog("debug",e,t,n,r)}info(e,t,n,r){this.addLog("info",e,t,n,r)}warn(e,t,n,r){this.addLog("warn",e,t,n,r)}error(e,t,n,r){this.addLog("error",e,t,n,r)}addLog(e,t,n,r,o){if(!this.enabled)return;const i=r?Ia(r):void 0,c={timestamp:Date.now(),level:e,category:t,message:n,data:i,group:o};if(this.logs.push(c),this.trimLogs(),o){this.logsByGroup.has(o)||this.logsByGroup.set(o,[]);const l=this.logsByGroup.get(o);l.push(c),l.length>this.maxLogs&&this.logsByGroup.set(o,l.slice(-this.maxLogs))}}trimLogs(){this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs))}getLogs(){return[...this.logs]}getLogsByCategory(e){return this.logs.filter(t=>t.category===e)}getLogsByLevel(e){return this.logs.filter(t=>t.level===e)}getLogsByGroup(e){return this.logsByGroup.get(e)||[]}getLogGroups(){return Array.from(this.logsByGroup.keys()).sort()}getLogsAsString(){return this.logs.map(e=>{const t=new Date(e.timestamp).toISOString().substr(11,12),n=e.data?` ${JSON.stringify(e.data)}`:"";return`[${t}] [${e.level.toUpperCase()}] [${e.category}] ${e.message}${n}`}).join(`
`)}getLogsAsJSON(){return JSON.stringify(this.logs,null,2)}clear(){this.logs=[],this.logsByGroup.forEach((e,t)=>{this.logsByGroup.set(t,[])})}count(){return this.logs.length}async copyToClipboard(){try{return await navigator.clipboard.writeText(this.getLogsAsString()),!0}catch(e){return console.error("Failed to copy logs to clipboard:",e),!1}}downloadLogs(e="mobile-logs.txt"){const t=new Blob([this.getLogsAsString()],{type:"text/plain"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}}const ts=new _S,xi="mobile-log-viewer-group",vi="mobile-log-viewer-position",bi="mobile-log-viewer-size",wi={width:500,height:400},OS=({defaultVisible:s=!1,autoRefresh:e=!0,refreshInterval:t=500,onClose:n})=>{const[r,o]=h.useState(s),[i,c]=h.useState(""),[l,d]=h.useState("all"),[p,u]=h.useState("all"),[f,m]=h.useState(()=>{try{return localStorage.getItem(xi)||"all"}catch{return"all"}}),[g,x]=h.useState(()=>{try{const P=localStorage.getItem(vi);return P?JSON.parse(P):void 0}catch{return}}),[w,v]=h.useState(()=>{try{const P=localStorage.getItem(bi);return P?JSON.parse(P):wi}catch{return wi}}),b=h.useRef(null);h.useEffect(()=>{try{localStorage.setItem(xi,f)}catch{}},[f]),h.useEffect(()=>{if(!e||!r)return;const P=setInterval(()=>{y()},t);return()=>clearInterval(P)},[e,r,t,l,p,f]),h.useEffect(()=>{r&&y()},[r]);const y=()=>{let P=f!=="all"?ts.getLogsByGroup(f):ts.getLogs();l!=="all"&&(P=P.filter($=>$.level===l)),p!=="all"&&(P=P.filter($=>$.category===p));const G=P.map($=>{const Y=new Date($.timestamp).toISOString().substr(11,12),A=$.data?` ${JSON.stringify($.data)}`:"";return`[${Y}] [${$.level.toUpperCase()}] [${$.category}] ${$.message}${A}`}).join(`
`);c(G)},C=async()=>{let P=await ts.copyToClipboard();if(!P&&b.current)try{b.current.focus(),b.current.select(),b.current.setSelectionRange(0,b.current.value.length),P=document.execCommand("copy"),setTimeout(()=>{P?Ne.success("Logs copied to clipboard!"):Ne.error("Failed to copy. Please use Select Text button and copy manually.")},100)}catch(G){console.error("Copy fallback failed:",G),setTimeout(()=>{Ne.error("Failed to copy. Please use Select Text button and copy manually.")},100)}else setTimeout(P?()=>{Ne.success("Logs copied to clipboard!")}:()=>{Ne.error("Failed to copy. Please use Select Text button and copy manually.")},100)},S=()=>{ts.clear(),c(""),Ne.success("Logs cleared!")},j=()=>{ts.downloadLogs(`mobile-logs-${Date.now()}.txt`),Ne.success("Logs downloaded!")},N=()=>{b.current&&(b.current.focus(),b.current.select(),b.current.setSelectionRange(0,b.current.value.length),setTimeout(()=>{Ne.success("Text selected! Long-press to copy.")},100))},E=()=>{n?n():o(!1)},R=P=>{x(P);try{localStorage.setItem(vi,JSON.stringify(P))}catch{}},D=P=>{v(P);try{localStorage.setItem(bi,JSON.stringify(P))}catch{}},T=["all",...new Set(ts.getLogs().map(P=>P.category))],L=["all",...ts.getLogGroups()],_=a.jsxs(a.Fragment,{children:[a.jsx(de,{onClick:N,variant:"ghost",size:"sm",className:"h-6 w-6 p-0",title:"Select all text","data-test":"mobile-log-viewer-select-text",children:a.jsx(Ip,{className:"h-3.5 w-3.5"})}),a.jsx(de,{onClick:C,variant:"ghost",size:"sm",className:"h-6 w-6 p-0",title:"Copy to clipboard","data-test":"mobile-log-viewer-copy",children:a.jsx(dr,{className:"h-3.5 w-3.5"})}),a.jsx(de,{onClick:j,variant:"ghost",size:"sm",className:"h-6 w-6 p-0",title:"Download logs","data-test":"mobile-log-viewer-download",children:a.jsx(or,{className:"h-3.5 w-3.5"})}),a.jsx(de,{onClick:S,variant:"ghost",size:"sm",className:"h-6 w-6 p-0",title:"Clear logs","data-test":"mobile-log-viewer-clear",children:a.jsx(St,{className:"h-3.5 w-3.5"})})]});return a.jsx(Vt,{isVisible:r||s,onClose:E,title:"Mobile Debug Logs",initialPosition:g||{x:16,y:window.innerHeight-w.height-16},initialSize:w,resizable:!0,shouldCloseManually:!0,onPositionChange:R,onSizeChange:D,headerActions:_,className:"flex flex-col",children:a.jsxs("div",{className:"flex flex-col h-full","data-test":"mobile-log-viewer-container",children:[a.jsxs("div",{className:"flex gap-2 p-2 border-b flex-wrap","data-test":"mobile-log-viewer-filters",children:[a.jsx("select",{value:f,onChange:P=>m(P.target.value),className:"text-xs px-2 py-1 border rounded bg-background font-semibold","data-test":"mobile-log-viewer-filter-group",children:L.map(P=>a.jsx("option",{value:P,children:P==="all"?"All Groups":P},P))}),a.jsxs("select",{value:l,onChange:P=>d(P.target.value),className:"text-xs px-2 py-1 border rounded bg-background","data-test":"mobile-log-viewer-filter-level",children:[a.jsx("option",{value:"all",children:"All Levels"}),a.jsx("option",{value:"debug",children:"Debug"}),a.jsx("option",{value:"info",children:"Info"}),a.jsx("option",{value:"warn",children:"Warn"}),a.jsx("option",{value:"error",children:"Error"})]}),a.jsx("select",{value:p,onChange:P=>u(P.target.value),className:"text-xs px-2 py-1 border rounded bg-background","data-test":"mobile-log-viewer-filter-category",children:T.map(P=>a.jsx("option",{value:P,children:P==="all"?"All Categories":P},P))})]}),a.jsx("div",{className:"flex-1 overflow-auto p-2","data-test":"mobile-log-viewer-logs-container",children:a.jsx("textarea",{ref:b,readOnly:!0,value:i||"No logs yet. Logs will appear here as events occur.",className:"w-full h-full text-xs font-mono bg-muted p-2 rounded border-none resize-none min-h-[200px]",onClick:P=>{P.target.select()},"data-test":"mobile-log-viewer-logs-textarea"})}),a.jsxs("div",{className:"p-2 text-xs text-muted-foreground flex justify-between border-t","data-test":"mobile-log-viewer-footer",children:[a.jsxs("span",{"data-test":"mobile-log-viewer-total-count",children:["Total: ",ts.count()," logs"]}),a.jsxs("span",{"data-test":"mobile-log-viewer-auto-refresh",children:["Auto-refresh: ",e?"ON":"OFF"]})]})]})})},cd=h.memo(({content:s})=>{const[e,t]=h.useState(!1);return a.jsxs("div",{className:"thinking-section","data-test":"thinking-block",children:[a.jsxs("button",{onClick:n=>{n.stopPropagation(),t(!e)},className:"thinking-toggle flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"thinking-toggle",children:[e?a.jsx(ut,{className:"h-3 w-3"}):a.jsx(yt,{className:"h-3 w-3"}),a.jsx("span",{className:"font-semibold uppercase",children:"Thinking"}),!e&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1 truncate max-w-[200px]",children:[s.slice(0,50),"..."]})]}),e&&a.jsx("div",{className:"thinking-content mt-2 p-2 bg-muted-foreground/5 rounded border-l-2 border-muted-foreground/30 text-sm text-muted-foreground whitespace-pre-wrap break-words max-w-full","data-test":"thinking-content",children:s})]})});cd.displayName="ThinkingBlockComponent";const ld=s=>typeof s=="string"?a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-text",dangerouslySetInnerHTML:{__html:at(s)}}):Array.isArray(s)?s.map((e,t)=>{if(typeof e=="string")return a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-block-string",dangerouslySetInnerHTML:{__html:at(e)}},t);if(typeof e=="object"&&e.type==="text"&&"text"in e)return a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-block-text",dangerouslySetInnerHTML:{__html:at(e.text)}},t);if(typeof e=="object"&&e.type==="image"&&"source"in e){const n=e.source;if(n.type==="base64"&&n.media_type&&n.data)return a.jsx("div",{className:"message-image mt-2","data-test":"message-content-block-image",children:a.jsx("img",{src:`data:${n.media_type};base64,${n.data}`,alt:"User uploaded image",className:"max-w-full max-h-96 rounded-lg border border-muted-foreground/20","data-test":"message-image"})},t)}if(typeof e=="object"&&e.type==="thinking"){const n=("thinking"in e?e.thinking:null)||("text"in e?e.text:null);if(n)return a.jsx(cd,{content:n},t)}if(rd(e)){const n=e;if(sd(n)&&n.input.plan)return a.jsxs("div",{className:"tool-use-plan bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-plan",children:[a.jsx("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"plan-header",children:a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Plan"})}),a.jsx("div",{className:"plan-content prose prose-sm dark:prose-invert max-w-none text-sm [&_h1]:text-lg [&_h1]:font-bold [&_h1]:mt-3 [&_h1]:mb-2 [&_h2]:text-base [&_h2]:font-semibold [&_h2]:mt-3 [&_h2]:mb-1 [&_h3]:text-sm [&_h3]:font-semibold [&_h3]:mt-2 [&_h3]:mb-1 [&_pre]:bg-background/50 [&_pre]:p-2 [&_pre]:rounded [&_pre]:text-xs [&_pre]:overflow-x-auto [&_code]:text-xs [&_code]:bg-background/50 [&_code]:px-1 [&_code]:rounded [&_.list-item-ul]:flex [&_.list-item-ul]:ml-2 [&_.list-item-ol]:flex [&_.list-item-ol]:ml-2","data-test":"plan-content",dangerouslySetInnerHTML:{__html:at(n.input.plan)}})]},t);if(PS(n)){const{todos:o}=n.input;return a.jsxs("div",{className:"tool-use-todos bg-muted-foreground/10 p-3 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-todos",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2 pb-2 border-b border-muted-foreground/20","data-test":"todos-header",children:[a.jsx("span",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Todo List"}),a.jsxs("span",{className:"text-xs text-muted-foreground/70",children:["(",o.length," items)"]})]}),a.jsx("ul",{className:"todos-list space-y-1","data-test":"todos-list",children:o.map((i,c)=>a.jsxs("li",{className:"todo-item flex items-start gap-2 text-xs","data-test":"todo-item",children:[a.jsx("span",{className:`todo-status flex-shrink-0 ${i.status==="completed"?"text-green-500":i.status==="in_progress"?"text-yellow-500":"text-muted-foreground/50"}`,"data-test":"todo-status",children:i.status==="completed"?"âœ“":i.status==="in_progress"?"â–¶":"â—‹"}),a.jsx("span",{className:`todo-content ${i.status==="completed"?"line-through text-muted-foreground/70":""}`,"data-test":"todo-content",children:i.content})]},c))})]},t)}if(nd(n))return a.jsx(po,{toolBlock:n},t);let r;return(AS(n)||RS(n))&&(r=n.input.description),a.jsxs("div",{className:"tool-use bg-muted-foreground/10 p-2 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-tool-use",children:[a.jsxs("div",{className:"text-xs font-mono truncate","data-test":"tool-use-name",children:["Tool: ",n.name]}),r&&a.jsx("div",{className:"text-xs text-muted-foreground mt-1 truncate","data-test":"tool-use-description",children:r})]},t)}return a.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded mt-1 overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-block-json",children:JSON.stringify(e,null,2)},t)}):typeof s=="object"&&s!==null?s.text?a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-object-text",dangerouslySetInnerHTML:{__html:at(s.text)}}):s.content?a.jsx("div",{"data-test":"message-content-recursive",children:ld(s.content)}):a.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-object-json",children:JSON.stringify(s,null,2)}):a.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none [&_p]:m-0 [&_ul]:my-1 [&_ol]:my-1 [&_li]:my-0 [&_code]:text-xs [&_code]:bg-muted-foreground/20 [&_code]:px-1 [&_code]:rounded [&_a]:text-primary [&_a]:underline","data-test":"message-content-fallback",dangerouslySetInnerHTML:{__html:at(String(s))}}),yi=s=>{const e=s.match(/<thinking>([\s\S]*?)<\/thinking>/);if(e){const t=e[1].trim(),n=s.replace(/<thinking>[\s\S]*?<\/thinking>/,"").trim();return{thinking:t||null,mainContent:n}}return{thinking:null,mainContent:s}},Lr=/^This session is being continued from a previous conversation/,LS=s=>{if(typeof s=="string")return Lr.test(s);if(Array.isArray(s)){for(const e of s)if(typeof e=="string"&&Lr.test(e)||typeof e=="object"&&e.type==="text"&&"text"in e&&Lr.test(e.text))return!0}return!1},Hs=h.memo(({message:s,formatTime:e})=>{const[t,n]=h.useState(!1),[r,o]=h.useState(!1),i=h.useMemo(()=>LS(s.content),[s.content]),[c,l]=h.useState(!i),d=h.useMemo(()=>Array.isArray(s.content)?s.content.some(v=>typeof v=="object"&&(v.type==="tool_result"||v.type==="tool_use")):!1,[s.content]),{thinkingContent:p,mainContent:u}=h.useMemo(()=>{if(s.role!=="assistant"||d)return{thinkingContent:null,mainContent:s.content};if(Array.isArray(s.content)){const v=[];let b=null;for(const y of s.content)if(typeof y=="object"&&y.type==="text"&&"text"in y){const C=yi(y.text);C.thinking&&(b=C.thinking),C.mainContent&&v.push({type:"text",text:C.mainContent})}else v.push(y);return{thinkingContent:b,mainContent:v.length>0?v:s.content}}if(typeof s.content=="string"){const v=yi(s.content);return{thinkingContent:v.thinking,mainContent:v.mainContent}}return{thinkingContent:null,mainContent:s.content}},[s.content,s.role,d]),f=i?"SUMMARY":d?"TOOL":s.role,m=v=>typeof v=="string"?v:Array.isArray(v)?v.map(b=>typeof b=="string"?b:typeof b=="object"&&b.type==="text"&&"text"in b?b.text:"").filter(Boolean).join(`
`):typeof v=="object"&&v!==null?v.text?v.text:v.content?m(v.content):JSON.stringify(v,null,2):String(v),g=async v=>{v.stopPropagation();const b=m(s.content);try{await navigator.clipboard.writeText(b),n(!0),setTimeout(()=>n(!1),2e3)}catch(y){console.error("Failed to copy message:",y)}},x=()=>{if(!Array.isArray(s.content))return"Tool";for(const v of s.content){if(typeof v=="object"&&v.type==="tool_result")return`Result${"is_error"in v&&v.is_error?" (error)":""}`;if(typeof v=="object"&&v.type==="tool_use"&&"name"in v)return v.name}return"Tool"},w=()=>{var v;if(!Array.isArray(s.content))return"";for(const b of s.content){if(typeof b=="object"&&b.type==="tool_result"&&"tool_use_id"in b){let y="";if("content"in b){const C=b.content;if(typeof C=="string")y=C.slice(0,50)+(C.length>50?"...":"");else if(Array.isArray(C)&&((v=C[0])!=null&&v.text)){const S=C[0].text;y=S.slice(0,50)+(S.length>50?"...":"")}}return y||"(empty)"}if(typeof b=="object"&&b.type==="tool_use"&&"name"in b){const y=b.name,C=[];if("input"in b&&typeof b.input=="object"&&b.input!==null){const S=b.input;if(S.description&&typeof S.description=="string"&&C.push(S.description),y==="Bash"&&S.command&&typeof S.command=="string"){const j=S.command.slice(0,40)+(S.command.length>40?"...":"");C.push(`$ ${j}`)}if(["Read","Write","Edit"].includes(y)&&S.file_path&&typeof S.file_path=="string"){const j=S.file_path.split("/").slice(-3).join("/");C.push(j)}["Grep","Glob"].includes(y)&&S.pattern&&typeof S.pattern=="string"&&C.push(`"${S.pattern}"`)}return C.join(" | ")||""}}return""};return a.jsxs("div",{className:`message-item flex flex-col w-full ${s.role==="user"?"items-end":"items-start"} ${s._isOptimistic?"opacity-60":""}`,"data-test":"message-item-wrapper","data-test-message-id":s.id,"data-test-optimistic":s._isOptimistic?"true":void 0,children:[a.jsxs("div",{className:`message-role-header flex items-center gap-1.5 mb-1 px-1 ${s.role==="user"?"flex-row-reverse":"flex-row"}`,"data-test":"message-role-header",children:[a.jsx("span",{className:"message-role text-xs font-semibold uppercase text-muted-foreground","data-test":"message-role-label",children:f}),a.jsx(Es,{children:a.jsxs(Ts,{children:[a.jsx(Is,{asChild:!0,children:a.jsx("button",{className:"message-info-button p-0.5 hover:bg-muted rounded transition-colors",onClick:v=>v.stopPropagation(),"data-test":"message-info-button",children:a.jsx(Qs,{className:"h-3 w-3 text-muted-foreground/50"})})}),a.jsxs(hs,{className:"flex items-center gap-2","data-test":"message-id-tooltip",children:[a.jsxs("span",{className:"text-xs font-mono",children:["ID: ",s.id]}),a.jsx(ss,{textToCopy:s.id,title:"Copy message ID",size:"smIconCompact",variant:"ghost"})]})]})})]}),a.jsxs("div",{onClick:()=>{console.log("Message clicked:",s)},className:`message-bubble max-w-[85%] rounded-lg p-3 overflow-hidden cursor-pointer ${i?"bg-orange-500/80 text-white border border-orange-600/50":s.role==="user"?"bg-primary text-primary-foreground":d?"bg-muted/50 border border-muted-foreground/20":"bg-muted"}`,"data-test":"message-bubble",children:[d&&a.jsxs("div",{className:"message-tool-header mb-2 flex items-center gap-2","data-test":"message-tool-header",children:[a.jsx("button",{onClick:v=>{v.stopPropagation(),l(!c)},className:"expand-tool-button p-0.5 -ml-1 hover:bg-muted-foreground/10 rounded transition-colors flex-shrink-0","data-test":"expand-tool-button",children:c?a.jsx(ut,{className:"h-3 w-3 text-muted-foreground"}):a.jsx(yt,{className:"h-3 w-3 text-muted-foreground"})}),a.jsx("span",{className:"text-xs text-muted-foreground font-semibold","data-test":"tool-name",children:x()})]}),d&&!c&&a.jsx("div",{className:"tool-summary-content text-xs text-muted-foreground font-mono truncate mb-2","data-test":"tool-summary",children:w()}),i&&a.jsxs("div",{className:"message-compacted-header mb-2 flex items-center gap-2","data-test":"message-compacted-header",children:[a.jsx("button",{onClick:v=>{v.stopPropagation(),l(!c)},className:"expand-compacted-button p-0.5 -ml-1 hover:bg-white/20 rounded transition-colors flex-shrink-0","data-test":"expand-compacted-button",children:c?a.jsx(ut,{className:"h-3 w-3 text-white/80"}):a.jsx(yt,{className:"h-3 w-3 text-white/80"})}),a.jsx("span",{className:"text-xs text-white/90 font-semibold","data-test":"compacted-label",children:"Context Summary"}),!c&&a.jsx("span",{className:"text-xs text-white/70 truncate max-w-[200px]",children:"(click to expand)"})]}),p&&a.jsxs("div",{className:"thinking-section mb-2","data-test":"thinking-section",children:[a.jsxs("button",{onClick:v=>{v.stopPropagation(),o(!r)},className:"thinking-toggle flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"thinking-toggle",children:[r?a.jsx(ut,{className:"h-3 w-3"}):a.jsx(yt,{className:"h-3 w-3"}),a.jsx("span",{className:"font-semibold uppercase",children:"Thinking"}),!r&&a.jsxs("span",{className:"text-muted-foreground/70 ml-1 truncate max-w-[200px]",children:[p.slice(0,50),"..."]})]}),r&&a.jsx("div",{className:"thinking-content mt-2 p-2 bg-muted-foreground/5 rounded border-l-2 border-muted-foreground/30 text-sm text-muted-foreground whitespace-pre-wrap break-words max-w-full","data-test":"thinking-content",children:p})]}),(!d&&!i||c)&&a.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words overflow-wrap-anywhere word-break max-w-full","data-test":"message-content",children:ld(u)}),s.toolCalls&&s.toolCalls.length>0&&a.jsxs("div",{className:"message-tool-calls mt-2 space-y-1","data-test":"message-tool-calls",children:[a.jsx("div",{className:`text-xs font-semibold ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":"message-tool-calls-label",children:"Tool Calls:"}),s.toolCalls.map((v,b)=>a.jsx("div",{className:`tool-call-item p-2 rounded text-xs font-mono ${s.role==="user"?"bg-primary-foreground/10":"bg-muted-foreground/10"}`,"data-test":"tool-call-item",children:a.jsx("pre",{className:"whitespace-pre-wrap break-words max-w-full","data-test":"tool-call-json",children:JSON.stringify(v,null,2)})},b))]}),a.jsxs("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"message-footer",children:[a.jsx("div",{className:`message-time text-xs max-w-full ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"} ${s._isOptimistic?"italic":""}`,"data-test":"message-timestamp",children:s._isOptimistic?"Sending...":e(s.timestamp)}),a.jsx("button",{onClick:g,className:`copy-button p-1 rounded hover:bg-opacity-20 transition-colors ${s.role==="user"?"hover:bg-primary-foreground":"hover:bg-foreground"}`,title:"Copy message","data-test":"copy-message-button",children:t?a.jsx(ct,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground":"text-muted-foreground"}`,"data-test":"copy-success-icon"}):a.jsx(dr,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"copy-icon"})})]})]})]},s.id)});Hs.displayName="MessageItem";const dd=h.memo(({message:s})=>{const e=s.entryType==="user";return a.jsxs("div",{className:`inherited-message-item flex flex-col w-full ${e?"items-end":"items-start"}`,"data-test":"inherited-message-item","data-test-message-id":s.uuid,children:[a.jsxs("div",{className:`message-role-header flex items-center gap-1.5 mb-1 px-1 ${e?"flex-row-reverse":"flex-row"}`,"data-test":"inherited-message-role-header",children:[a.jsx("span",{className:"message-role text-xs font-semibold uppercase text-muted-foreground/70",children:s.entryType}),e?a.jsx(Dp,{className:"h-3 w-3 text-muted-foreground/50"}):a.jsx(Xr,{className:"h-3 w-3 text-muted-foreground/50"})]}),a.jsxs("div",{className:`message-bubble max-w-[85%] rounded-lg p-3 border-dashed border ${e?"bg-primary/30 text-primary-foreground/80 border-primary/30":"bg-muted/30 border-muted-foreground/20"}`,"data-test":"inherited-message-bubble",children:[a.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words","data-test":"inherited-message-content",children:s.preview||"(empty)"}),a.jsx("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"inherited-message-footer",children:a.jsx("div",{className:`message-time text-xs ${e?"text-primary-foreground/50":"text-muted-foreground/50"}`,"data-test":"inherited-message-timestamp",children:new Date(s.timestamp).toLocaleTimeString()})})]})]})});dd.displayName="InheritedMessageItem";function MS({messages:s,sessionDetails:e,metadata:t,loading:n,pagination:r,onLoadOlder:o,onSearch:i,onNameUpdated:c,onFork:l,scrollToMessageId:d,onBackClick:p,showBackButton:u,inheritedMessages:f}){var me,ge,oe,Se,xe,Pe;const m=h.useRef(null),g=h.useRef(null),x=h.useRef(0),w=h.useRef(null),v=h.useRef(0),b=h.useRef(!1),[y,C]=h.useState(""),[S,j]=h.useState(!1),[N,E]=h.useState(!1),R=h.useRef(!1),[D,T]=h.useState(!1),[L,_]=h.useState(((oe=(ge=(me=le.getState().app)==null?void 0:me.claude)==null?void 0:ge.ui)==null?void 0:oe.autoScrollThreshold)??300);h.useEffect(()=>{const ae=(e==null?void 0:e.name)??null;w.current!==ae&&(x.current=0,w.current=ae,R.current=!1,T(!1))},[e==null?void 0:e.name]);const P=h.useCallback(ae=>new Date(ae).toLocaleTimeString(),[]),G=h.useCallback(ae=>{const te=new Date(ae);return te.toLocaleDateString()+" "+te.toLocaleTimeString()},[]),[$,Y]=h.useState(((Pe=(xe=(Se=le.getState().app)==null?void 0:Se.claude)==null?void 0:xe.ui)==null?void 0:Pe.messageFilters)??["user","assistant","thinking","tools"]),A=h.useCallback(ae=>{const{scrollTop:te,scrollHeight:F,clientHeight:Z}=ae,ce=getComputedStyle(ae).flexDirection==="column-reverse";let ue;return ce?ue=Math.abs(te)<=L:ue=F-te-Z<=L,ue},[L]),X=h.useRef(0),I=500,k=h.useCallback(ae=>{const te=ae.target;if(!te)return;const F=A(te),Z=Date.now();Z-X.current>I&&(X.current=Z),F?(R.current=!1,T(!1)):(R.current=!0,T(!0))},[A]);h.useEffect(()=>{const ae=m.current;if(!ae)return;const te=ae.querySelector("[data-radix-scroll-area-viewport]");if(!te)return;const F=setTimeout(()=>{const Z=A(te);T(!Z)},100);return te.addEventListener("scroll",k),()=>{clearTimeout(F),te.removeEventListener("scroll",k)}},[k,A]);const M=h.useCallback(ae=>{var F,Z,H;_(ae);const te=le.getState();le.setState({...te,app:{...te.app,claude:{...(F=te.app)==null?void 0:F.claude,ui:{...(H=(Z=te.app)==null?void 0:Z.claude)==null?void 0:H.ui,autoScrollThreshold:ae}}}})},[]);h.useEffect(()=>{var Z,H,ce,ue,pe,he;((ce=(H=(Z=le.getState().app)==null?void 0:Z.claude)==null?void 0:H.ui)==null?void 0:ce.messageFilters)||le.update("app",{claude:{...(ue=le.getState().app)==null?void 0:ue.claude,ui:{...(he=(pe=le.getState().app)==null?void 0:pe.claude)==null?void 0:he.ui,messageFilters:["user","assistant","thinking","tools"]}}});const te=le.selectSlice(ve=>{var Te,ke,z;return(z=(ke=(Te=ve.app)==null?void 0:Te.claude)==null?void 0:ke.ui)==null?void 0:z.messageFilters}).subscribe(ve=>{ve&&Y(ve)}),F=le.selectSlice(ve=>{var Te,ke,z;return(z=(ke=(Te=ve.app)==null?void 0:Te.claude)==null?void 0:ke.ui)==null?void 0:z.autoScrollThreshold}).subscribe(ve=>{ve!==void 0&&_(ve)});return()=>{te.unsubscribe(),F.unsubscribe()}},[]);const U=ae=>{var H,ce,ue,pe,he,ve;const te=((ue=(ce=(H=le.getState().app)==null?void 0:H.claude)==null?void 0:ce.ui)==null?void 0:ue.messageFilters)??$,F=te.includes(ae)?te.filter(Te=>Te!==ae):[...te,ae],Z=le.getState();le.setState({...Z,app:{...Z.app,claude:{...(pe=Z.app)==null?void 0:pe.claude,ui:{...(ve=(he=Z.app)==null?void 0:he.claude)==null?void 0:ve.ui,messageFilters:F}}}})},q=(ae,te)=>{i&&i(ae,te)},W=h.useMemo(()=>s.filter(te=>!te.content||te.content===""?!1:Array.isArray(te.content)&&te.content.some(Z=>typeof Z=="object"&&(Z.type==="tool_use"||Z.type==="tool_result"))?$.includes("tools"):!!(te.role==="user"&&$.includes("user")||te.role==="assistant"&&$.includes("assistant"))),[s,$]),V=h.useCallback(ae=>Array.isArray(ae.content)?ae.content.some(te=>typeof te=="object"&&(te.type==="tool_use"||te.type==="tool_result")):!1,[]),ie=h.useMemo(()=>{const ae=[];let te=[];for(const F of W)V(F)?te.push(F):(te.length>0&&(ae.push({type:"tool-group",messages:te}),te=[]),ae.push({type:"single",message:F}));return te.length>0&&ae.push({type:"tool-group",messages:te}),ae},[W,V]);h.useLayoutEffect(()=>{const ae=x.current===0&&W.length>0,te=W.length>x.current&&x.current>0;if(m.current){const F=m.current.querySelector("[data-radix-scroll-area-viewport]");if(ae&&F)F.scrollTop=F.scrollHeight,v.current=F.scrollHeight,x.current=W.length,b.current=!1;else if(te&&F){const Z=F.scrollHeight,H=Z-v.current;F.scrollTop=F.scrollTop+H,v.current=Z,x.current=W.length,b.current=!0}}},[W]),h.useEffect(()=>{if(x.current!==0){if(b.current){b.current=!1;return}if(!R.current&&m.current){const te=m.current.querySelector("[data-radix-scroll-area-viewport]");te&&setTimeout(()=>{te.scrollTo({top:te.scrollHeight,behavior:"smooth"})},50)}}},[W]),h.useEffect(()=>{if(S&&g.current){const ae=g.current.querySelector("[data-radix-scroll-area-viewport]");ae&&setTimeout(()=>{ae.scrollTo({top:ae.scrollHeight,behavior:"auto"})},100)}},[S]);const K=h.useCallback((ae=!0,te=!1)=>{const F=te?g:m;if(F.current){const Z=F.current.querySelector("[data-radix-scroll-area-viewport]");Z&&(Z.scrollTo({top:Z.scrollHeight,behavior:ae?"smooth":"auto"}),te||(R.current=!1,T(!1)))}},[]);h.useEffect(()=>{if(!d||!m.current)return;const ae=m.current.querySelector(`[data-test-message-id="${d}"]`);ae&&(ae.scrollIntoView({behavior:"smooth",block:"center"}),ae.classList.add("message-highlight"),setTimeout(()=>{ae.classList.remove("message-highlight")},2e3))},[d]);const ne=(e==null?void 0:e.name)!=null;return a.jsxs(pn,{className:"chat-interface-card h-full flex flex-col overflow-hidden rounded-none border-0 md:rounded-lg md:border","data-test":"chat-interface-card",children:[ne&&a.jsxs(Ha,{className:"chat-header pb-2 pt-2 px-1 md:pt-4 md:px-6 flex-shrink-0","data-test":"chat-header",children:[a.jsxs("div",{className:"header-title-container flex items-center gap-2 text-sm","data-test":"header-title-container",children:[u&&p&&a.jsx(de,{variant:"ghost",size:"icon",onClick:p,className:"md:hidden h-8 w-8 flex-shrink-0","data-test":"back-to-sessions-button",children:a.jsx(_s,{className:"h-5 w-5"})}),a.jsx(uo,{sessionIds:e!=null&&e.id?[e.id]:[]}),a.jsx(Ga,{className:"text-base truncate","data-test":"chat-title",children:e?a.jsx(ed,{session:e,segmentsToStrip:3,onNameUpdated:c}):"New Conversation"}),t&&a.jsx(Zl,{"data-test":"session-metadata-popover",contentClassName:"min-w-[200px]",trigger:a.jsx("button",{className:"info-button p-1 hover:bg-muted rounded-sm transition-colors","data-test":"session-info-button",children:a.jsx(Qs,{className:"h-4 w-4 text-muted-foreground"})}),children:a.jsxs("div",{className:"metadata-section text-xs space-y-1","data-test":"metadata-section",children:[a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-created",children:[a.jsx("span",{className:"font-medium",children:"Created:"})," ",G(t.created)]}),a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-modified",children:[a.jsx("span",{className:"font-medium",children:"Last Modified:"})," ",G(t.lastModified)]}),a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-message-count",children:[a.jsx("span",{className:"font-medium",children:"Messages:"})," ",t.messageCount]}),t.model&&a.jsxs("div",{className:"metadata-item","data-test":"metadata-item-model",children:[a.jsx("span",{className:"font-medium",children:"Model:"})," ",t.model]}),(e==null?void 0:e.id)&&a.jsxs("div",{className:"metadata-item flex items-center gap-1","data-test":"metadata-item-session-id",children:[a.jsx("span",{className:"font-medium",children:"ID:"}),a.jsxs("span",{className:"font-mono",children:[e.id.slice(0,6),"...",e.id.slice(-6)]}),a.jsx(ss,{textToCopy:e.id,title:"Copy session ID",size:"smIconCompact",variant:"ghost"})]})]})}),l&&a.jsx("button",{className:"fork-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:ae=>{l({x:ae.clientX,y:ae.clientY})},"data-test":"fork-session-button",title:"Fork this session",children:a.jsx(es,{className:"h-4 w-4 text-muted-foreground"})}),a.jsx("button",{className:"expand-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:()=>{j(!0)},"data-test":"expand-chat-button",title:"Expand chat view",children:a.jsx(Ap,{className:"h-4 w-4 text-muted-foreground"})}),a.jsx("button",{className:"debug-button p-1 hover:bg-muted rounded-sm transition-colors md:hidden",onClick:()=>{E(!0)},"data-test":"chat-debug-button",title:"Show mobile logs",children:a.jsx(Pp,{className:"h-4 w-4 text-muted-foreground"})}),a.jsx(kS,{storageKey:"chat-interface-config",title:"Chat Configuration",contentClassName:"chat-config-panel w-64",children:a.jsxs("div",{className:"config-content space-y-4","data-test":"chat-config-content",children:[a.jsxs("div",{className:"project-selector-section space-y-2","data-test":"project-selector-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Project"}),a.jsx(Fc,{variant:"select",className:"w-full"})]}),a.jsxs("div",{className:"filters-section space-y-2","data-test":"message-filters-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Show messages"}),a.jsxs("div",{className:"filter-options space-y-2","data-test":"filter-options",children:[a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-user",children:[a.jsx(kt,{id:"filter-user",checked:$.includes("user"),onCheckedChange:()=>U("user"),"data-test":"filter-checkbox-user"}),a.jsx(je,{htmlFor:"filter-user",className:"text-sm cursor-pointer",children:"User"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-assistant",children:[a.jsx(kt,{id:"filter-assistant",checked:$.includes("assistant"),onCheckedChange:()=>U("assistant"),"data-test":"filter-checkbox-assistant"}),a.jsx(je,{htmlFor:"filter-assistant",className:"text-sm cursor-pointer",children:"Assistant"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-thinking",children:[a.jsx(kt,{id:"filter-thinking",checked:$.includes("thinking"),onCheckedChange:()=>U("thinking"),"data-test":"filter-checkbox-thinking"}),a.jsx(je,{htmlFor:"filter-thinking",className:"text-sm cursor-pointer",children:"Thinking"})]}),a.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-tools",children:[a.jsx(kt,{id:"filter-tools",checked:$.includes("tools"),onCheckedChange:()=>U("tools"),"data-test":"filter-checkbox-tools"}),a.jsx(je,{htmlFor:"filter-tools",className:"text-sm cursor-pointer",children:"Tools"})]})]})]}),a.jsxs("div",{className:"auto-scroll-section space-y-2","data-test":"auto-scroll-section",children:[a.jsx("div",{className:"section-label text-sm font-medium",children:"Auto-scroll threshold"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Auto-scroll only when within this distance from bottom (px)"}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(_t,{value:[L],onValueChange:([ae])=>M(ae),min:0,max:500,step:10,className:"flex-1","data-test":"auto-scroll-threshold-slider"}),a.jsx("span",{className:"text-sm font-mono w-12 text-right","data-test":"auto-scroll-threshold-value",children:L})]})]})]})})]}),i&&a.jsx(td,{searchQuery:y,onSearchChange:C,onAdvancedSearch:q,className:"mt-3"})]}),a.jsxs(hn,{className:"chat-content flex-1 min-h-0 overflow-hidden p-0 relative","data-test":"chat-content",children:[a.jsx(nn,{ref:m,className:"chat-scroll-area h-full w-full",viewportClassName:"!block","data-test":"chat-scroll-area",children:a.jsxs("div",{className:"messages-container space-y-4 px-2 md:px-4 pt-2 w-full max-w-full overflow-x-hidden","data-test":"messages-container",children:[o&&r&&a.jsx("div",{className:"load-older-container flex justify-center pb-4 pt-2","data-test":"load-older-container",children:a.jsxs(de,{variant:"outline",size:"sm",onClick:o,disabled:n,className:"load-older-button","data-test":"load-older-button",children:[a.jsx(ut,{className:"h-4 w-4 mr-2 rotate-180"}),"Load Older Messages",r&&a.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(",s.length," of ",r.totalCount,")"]})]})}),f&&f.length>0&&a.jsxs("div",{className:"inherited-messages-section","data-test":"inherited-messages-section",children:[a.jsxs("div",{className:"inherited-messages-header flex items-center gap-2 mb-3 pb-2 border-b border-dashed border-muted-foreground/30",children:[a.jsx(es,{className:"h-4 w-4 text-muted-foreground"}),a.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:["Inherited from parent session (",f.length," messages)"]})]}),a.jsx("div",{className:"inherited-messages-list space-y-4 opacity-70",children:f.map(ae=>a.jsx(dd,{message:ae},ae.uuid))}),a.jsxs("div",{className:"fork-point-divider flex items-center gap-2 my-4 py-2",children:[a.jsx("div",{className:"flex-1 border-t border-dashed border-primary/40"}),a.jsxs("span",{className:"text-xs font-medium text-primary/70 flex items-center gap-1",children:[a.jsx(es,{className:"h-3 w-3"}),"Fork point"]}),a.jsx("div",{className:"flex-1 border-t border-dashed border-primary/40"})]})]}),n&&W.length===0?a.jsx("div",{className:"loading-message text-sm text-muted-foreground","data-test":"loading-message",children:"Loading messages..."}):W.length===0&&(!f||f.length===0)?a.jsxs("div",{className:"empty-state text-center mt-8","data-test":"empty-state",children:[a.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"New Session"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Type your first message below to start the conversation"})]}):ie.map(ae=>ae.type==="tool-group"?a.jsx(Ta,{messages:ae.messages,renderMessage:te=>a.jsx(Hs,{message:te,formatTime:P},te.id)},`tool-group-${ae.messages[0].id}`):a.jsx(Hs,{message:ae.message,formatTime:P},ae.message.id))]})}),D&&a.jsx(de,{variant:"outline",size:"icon",onClick:()=>K(!0),className:"absolute bottom-4 right-4 md:bottom-4 md:right-4 h-10 w-10 md:h-8 md:w-8 rounded-full shadow-lg bg-background/95 backdrop-blur-sm hover:bg-background z-20","data-test":"chat-scroll-to-bottom",title:"Scroll to latest message",children:a.jsx(ut,{className:"h-5 w-5 md:h-4 md:w-4"})})]}),a.jsx(Vt,{isVisible:S,onClose:()=>j(!1),title:e?typeof e.customName=="string"?e.customName:e.name:"Chat Messages",shouldCloseManually:!0,resizable:!0,initialSize:{width:1e3,height:700},initialPosition:{x:100,y:50},children:a.jsxs("div",{className:"expanded-chat-content flex flex-col flex-1 overflow-hidden","data-test":"expanded-chat-view",children:[a.jsxs("div",{className:"expanded-controls-header flex items-center justify-between gap-4 px-4 py-2 border-b border-border flex-shrink-0","data-test":"expanded-controls-header",children:[a.jsxs("div",{className:"filter-controls flex items-center gap-3","data-test":"expanded-filter-controls",children:[a.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Show:"}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(kt,{id:"expanded-filter-user",checked:$.includes("user"),onCheckedChange:()=>U("user"),"data-test":"expanded-filter-checkbox-user"}),a.jsx(je,{htmlFor:"expanded-filter-user",className:"text-xs cursor-pointer",children:"User"})]}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(kt,{id:"expanded-filter-assistant",checked:$.includes("assistant"),onCheckedChange:()=>U("assistant"),"data-test":"expanded-filter-checkbox-assistant"}),a.jsx(je,{htmlFor:"expanded-filter-assistant",className:"text-xs cursor-pointer",children:"Assistant"})]}),a.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[a.jsx(kt,{id:"expanded-filter-tools",checked:$.includes("tools"),onCheckedChange:()=>U("tools"),"data-test":"expanded-filter-checkbox-tools"}),a.jsx(je,{htmlFor:"expanded-filter-tools",className:"text-xs cursor-pointer",children:"Tools"})]})]}),a.jsxs(de,{variant:"outline",size:"sm",onClick:()=>K(!0,!0),className:"scroll-to-bottom-button flex items-center gap-1.5 h-7 text-xs","data-test":"scroll-to-bottom-button",title:"Scroll to latest message",children:[a.jsx(Rp,{className:"h-3 w-3"}),"Latest"]})]}),a.jsx("div",{className:"flex-1 min-h-0 p-4 pt-2",children:a.jsx(nn,{className:"h-full",ref:g,children:a.jsx("div",{className:"messages-container-expanded space-y-4 pr-4",children:W.length===0?a.jsxs("div",{className:"empty-state text-center mt-8","data-test":"expanded-empty-state",children:[a.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"No Messages"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"This session has no messages yet"})]}):ie.map(ae=>ae.type==="tool-group"?a.jsx(Ta,{messages:ae.messages,renderMessage:te=>a.jsx(Hs,{message:te,formatTime:P},te.id)},`expanded-tool-group-${ae.messages[0].id}`):a.jsx(Hs,{message:ae.message,formatTime:P},ae.message.id))})})})]})}),N&&a.jsx(OS,{defaultVisible:!0,autoRefresh:!0,refreshInterval:500,onClose:()=>E(!1)})]})}function Aa({sessionId:s,message:e,onBeforeSend:t,onSendSuccess:n,onSendError:r,outputFormat:o="text",permissionMode:i="acceptEdits",variant:c="ghost",size:l="icon",className:d="",title:p="Send to Claude session",disabled:u,...f}){const[m,g]=h.useState(!1);h.useEffect(()=>{g(!1)},[s]);const x=h.useCallback(async()=>{if(!(!e.trim()||(t==null?void 0:t())===!1))try{g(!0),await Ve.sendMessage({message:e.trim(),sessionId:s,options:{outputFormat:o,permissionMode:i}}),console.log(`Sent message to Claude session ${s}: ${e}`),n==null||n()}catch(v){console.error("Failed to send message to Claude:",v),r==null||r(v)}finally{g(!1)}},[e,s,o,i,m,t,n,r]);return a.jsx(de,{variant:c,size:l,onClick:x,className:d,title:p,disabled:u||!e.trim(),"data-test":"claude-send-button","data-test-sending":m?"true":"false",...f,children:m?a.jsx(lr,{className:"h-3 w-3 animate-spin loading-indicator","data-test":"send-button-loading"}):a.jsx(Ln,{className:"h-3 w-3","data-test":"send-button-icon"})})}const Mr=["acceptEdits","plan","bypassPermissions"],FS={acceptEdits:"Accept Edits",plan:"Plan",bypassPermissions:"Bypass"};function $S({sessionId:s,initialMessage:e="",rows:t=3,value:n,onChange:r,onSendSuccess:o,onSendError:i,onAddOptimisticMessage:c,onRemoveOptimisticMessage:l,userMessages:d}){const[p,u]=h.useState(e),f=h.useRef(null),m=h.useRef(null),[g,x]=h.useState(-1),w=h.useRef(""),v=xs(),[b,y]=h.useState(1),C=Le(I=>{var k,M,U,q;return(q=(U=(M=(k=I.ui)==null?void 0:k.claude)==null?void 0:M.message)==null?void 0:U.options)==null?void 0:q.permissionMode}),S=C==="default"||!C?"acceptEdits":C,j=Le(I=>{var k,M,U;return(U=(M=(k=I.ui)==null?void 0:k.claude)==null?void 0:M.message)==null?void 0:U.prefill});h.useEffect(()=>{var I,k,M;if(j){u(j);const U=le.getState();le.updateState({ui:{...U.ui,claude:{...(I=U.ui)==null?void 0:I.claude,message:{...(M=(k=U.ui)==null?void 0:k.claude)==null?void 0:M.message,prefill:void 0}}}})}},[j]);const N=h.useCallback(()=>{var q,W,V,ie,K,ne;const k=(Mr.indexOf(S)+1)%Mr.length,M=Mr[k],U=le.getState();le.updateState({ui:{...U.ui,claude:{...(q=U.ui)==null?void 0:q.claude,message:{...(V=(W=U.ui)==null?void 0:W.claude)==null?void 0:V.message,options:{...(ne=(K=(ie=U.ui)==null?void 0:ie.claude)==null?void 0:K.message)==null?void 0:ne.options,permissionMode:M}}}}})},[S]),E=n??p,R=r??u,D=h.useMemo(()=>{if(!d)return[];const I=["This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation"];return d.map(k=>typeof k.content=="string"?k.content:"").filter(k=>k&&!I.some(M=>k.startsWith(M))).reverse()},[d]);h.useEffect(()=>{var M,U,q;const I=(q=(U=(M=le.getState().app)==null?void 0:M.claude)==null?void 0:U.ui)==null?void 0:q.messageDrafts,k=I==null?void 0:I[s];u(k||"")},[s]),h.useEffect(()=>{var I,k,M,U,q,W;if(!n){const ie={...((M=(k=(I=le.getState().app)==null?void 0:I.claude)==null?void 0:k.ui)==null?void 0:M.messageDrafts)||{}};p.trim()?ie[s]=p:delete ie[s],le.updateState({app:{...le.getState().app,claude:{...(U=le.getState().app)==null?void 0:U.claude,ui:{...(W=(q=le.getState().app)==null?void 0:q.claude)==null?void 0:W.ui,messageDrafts:ie}}}})}},[p,s,n]);const T=h.useRef(1),[L,_]=h.useState(void 0);h.useEffect(()=>{var Pe;if(!v){y(t),_(void 0);return}const I=(Pe=f.current)==null?void 0:Pe.getTextArea();if(!I)return;const k=1,M=4,U=getComputedStyle(I),q=parseFloat(U.lineHeight)||24,W=parseFloat(U.paddingTop)||0,V=parseFloat(U.paddingBottom)||0,ie=parseFloat(U.borderTopWidth)||0,K=parseFloat(U.borderBottomWidth)||0;if(!E.trim()){const ae=q*k+W+V;T.current=k,y(k),_(`${ae}px`),I.style.overflowY="hidden";return}const ne=I.style.height;I.style.height="auto";const ge=I.scrollHeight-W-V-ie-K,oe=Math.max(1,Math.round(ge/q));I.style.height=ne;const Se=Math.min(M,Math.max(k,oe)),xe=q*Se+W+V;T.current=Se,y(Se),_(`${xe}px`),I.style.overflowY=oe>M?"auto":"hidden"},[E,v,t]);const P=()=>{var W,V,ie,K,ne,me,ge,oe,Se,xe,Pe,ae,te,F;const I=E.trim(),k=I.match(/(qqq|queue)$/i);if(k){const Z=I.slice(0,-k[0].length).trim();if(Z){Y(Z),R("");const H=(W=f.current)==null?void 0:W.getTextArea();H&&(H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})));const ue={...((K=(ie=(V=le.getState().app)==null?void 0:V.claude)==null?void 0:ie.ui)==null?void 0:K.messageDrafts)??{}};delete ue[s],le.updateState({app:{...le.getState().app,claude:{...(ne=le.getState().app)==null?void 0:ne.claude,ui:{...(ge=(me=le.getState().app)==null?void 0:me.claude)==null?void 0:ge.ui,messageDrafts:ue}}}})}return!1}if(c&&E.trim()){const Z=c(E.trim());m.current=Z}x(-1),w.current="",R("");const M=(oe=f.current)==null?void 0:oe.getTextArea();M&&(M.value="",M.dispatchEvent(new Event("input",{bubbles:!0})));const q={...((Pe=(xe=(Se=le.getState().app)==null?void 0:Se.claude)==null?void 0:xe.ui)==null?void 0:Pe.messageDrafts)||{}};return delete q[s],le.updateState({app:{...le.getState().app,claude:{...(ae=le.getState().app)==null?void 0:ae.claude,ui:{...(F=(te=le.getState().app)==null?void 0:te.claude)==null?void 0:F.ui,messageDrafts:q}}}}),!0},G=()=>{m.current=null,o==null||o()},$=I=>{l&&m.current&&(l(m.current),m.current=null),i==null||i(I)},Y=I=>{var ie,K,ne,me,ge,oe;const k=le.getState(),M=((ne=(K=(ie=k.app)==null?void 0:ie.claude)==null?void 0:K.ui)==null?void 0:ne.messageQueues)??{},U=M[s]??[],W={id:(()=>{if(typeof crypto<"u"&&crypto.randomUUID)try{return crypto.randomUUID()}catch{}return`${Date.now()}-${Math.random().toString(36).substring(2,11)}`})(),content:I,createdAt:Date.now()},V={...M,[s]:[...U,W]};le.updateState({app:{...k.app,claude:{...(me=k.app)==null?void 0:me.claude,ui:{...(oe=(ge=k.app)==null?void 0:ge.claude)==null?void 0:oe.ui,messageQueues:V}}}})},A=I=>{R(I),setTimeout(()=>{var k;(k=document.querySelector(".claude-send-button"))==null||k.click()},0)},X=I=>{var k;if(I.key==="Enter"&&!I.shiftKey){I.preventDefault(),(k=document.querySelector(".claude-send-button"))==null||k.click();return}if(I.key==="ArrowUp"&&D.length>0&&(I.currentTarget.selectionStart===0||!E)){I.preventDefault(),g===-1&&(w.current=E);const U=Math.min(g+1,D.length-1);U!==g&&(x(U),R(D[U]))}if(I.key==="ArrowDown"&&g>=0){const M=I.currentTarget;if(M.selectionStart===M.value.length||!E){I.preventDefault();const q=g-1;q<0?(x(-1),R(w.current)):(x(q),R(D[q]))}}};return a.jsxs("div",{className:"message-input-container","data-test":"message-input-container",children:[a.jsxs("div",{className:B("message-input-area flex gap-2",v?"items-end":"items-start"),"data-test":"message-input-area",children:[v&&a.jsx(ka,{variant:"ghost",size:"icon",buttonLabel:"",sessionId:s,onSendQueuedMessage:A,className:"!size-12"}),a.jsx(ns,{ref:f,value:E,onChange:I=>R(I.target.value),onKeyDown:X,placeholder:v?"Type your message...":"Type your message... (Shift+Enter for new line, @ to insert file path)",className:B("message-textarea flex-1",v?"resize-none":"resize-y"),style:L?{height:L,transition:"height 150ms ease-out"}:void 0,showBuiltInPopover:!1,showAudioButton:!v,rows:v?1:b,"data-test":"message-textarea"}),v?a.jsx(Aa,{sessionId:s,message:E,outputFormat:"text",permissionMode:S,className:"claude-send-button send-button !size-12",size:"icon",onBeforeSend:P,onSendSuccess:G,onSendError:$}):a.jsx("div",{className:"send-controls flex flex-col gap-2","data-test":"send-controls",children:a.jsx(ka,{variant:"ghost",size:"icon",buttonLabel:"",sessionId:s,onSendQueuedMessage:A,children:I=>a.jsx(Aa,{sessionId:s,message:E,outputFormat:I.outputFormat,permissionMode:I.permissionMode,className:"claude-send-button send-button",size:"icon",onBeforeSend:P,onSendSuccess:G,onSendError:$})})})]}),a.jsx("div",{className:"message-input-footer flex items-center justify-start mt-1 px-1","data-test":"message-input-footer",children:a.jsx("button",{type:"button",onClick:N,className:"permission-mode-toggle text-xs text-muted-foreground hover:text-foreground transition-colors cursor-pointer","data-test":"permission-mode-toggle",title:"Click to cycle permission mode",children:FS[S]})})]})}function US({forkCount:s,forkedFromName:e,forkedFromId:t,onClick:n,size:r="default"}){if(!s&&!e)return null;const o=!!e,i=s&&s>0,c=r==="sm"?10:12,l=r==="sm"?"text-[10px] px-1.5 py-0":"",d=p=>{o&&t&&n&&(p.stopPropagation(),n(t))};return o?a.jsx(Es,{children:a.jsxs(Ts,{children:[a.jsx(Is,{asChild:!0,children:a.jsxs(ht,{"data-test":"fork-indicator-forked-from",variant:"secondary",className:`fork-indicator-badge gap-1 cursor-pointer hover:bg-secondary/80 ${l}`,onClick:d,children:[a.jsx(es,{size:c,"data-test":"fork-indicator-icon"}),a.jsx("span",{"data-test":"fork-indicator-label",children:"Forked"})]})}),a.jsxs(hs,{"data-test":"fork-indicator-tooltip",children:[a.jsxs("p",{children:["Forked from: ",e]}),n&&a.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to view parent"})]})]})}):i?a.jsx(Es,{children:a.jsxs(Ts,{children:[a.jsx(Is,{asChild:!0,children:a.jsxs(ht,{"data-test":"fork-indicator-count",variant:"outline",className:`fork-indicator-badge gap-1 ${l}`,children:[a.jsx(es,{size:c,"data-test":"fork-indicator-icon"}),a.jsx("span",{"data-test":"fork-indicator-count-value",children:s})]})}),a.jsx(hs,{"data-test":"fork-indicator-tooltip",children:a.jsxs("p",{children:[s," fork",s>1?"s":""," created from this session"]})})]})}):null}function BS(s){const e=new Date,t=new Date(s),n=e.getTime()-t.getTime(),r=Math.floor(n/(1e3*60)),o=Math.floor(n/(1e3*60*60)),i=Math.floor(n/(1e3*60*60*24)),c=Math.floor(i/7),l=Math.floor(i/365);return r<1?"just now":r<60?`${r} min ago`:o<24?`${o} ${o===1?"hour":"hours"} ago`:i<7?`${i} ${i===1?"day":"days"} ago`:c<52?`${c} ${c===1?"week":"weeks"} ago`:`${l} ${l===1?"year":"years"} ago`}function ud({session:s,isSelected:e,isFocused:t=!1,onClick:n,formatDate:r,formatCwd:o,segmentsToStrip:i=3,onNameUpdated:c,compact:l=!1,forkCount:d,forkedFromName:p,forkedFromId:u,onFork:f,onNavigateToParent:m,hasDraft:g=!1}){const x=w=>{w.stopPropagation(),f==null||f(s)};return a.jsxs("div",{"data-test":"session-list-item",onClick:()=>{n()},className:`session-item group relative ${l?"p-1.5":"p-3"} rounded-lg border cursor-pointer transition-colors ${e?"bg-primary/10 border-primary":t?"bg-accent/50 border-accent-foreground/30 ring-2 ring-accent-foreground/20":"hover:bg-accent"}`,children:[a.jsx("div",{"data-test":"session-cwd",className:"session-cwd text-xs text-muted-foreground truncate",children:o(s.cwd)}),a.jsxs("div",{"data-test":"session-name-container",className:`session-name-container ${l?"font-medium text-sm":"font-bold text-base"} break-words line-clamp-2 ${l?"":"mt-1"} flex items-center gap-2`,children:[a.jsx(uo,{sessionIds:[s.id]}),a.jsx(ed,{session:s,segmentsToStrip:i,onNameUpdated:c}),g&&a.jsx("span",{"data-test":"session-draft-indicator",title:"Has draft message",className:"text-amber-500 flex-shrink-0",children:a.jsx(_p,{size:14})})]}),(s.latestMessage||s.firstMessage)&&!l&&a.jsx("div",{"data-test":"session-latest-message",className:"session-latest-message text-sm text-muted-foreground truncate mt-1",children:s.latestMessage||s.firstMessage}),a.jsxs("div",{"data-test":"session-meta",className:`session-meta text-xs text-muted-foreground flex items-center gap-2 flex-wrap ${l?"mt-0.5":"mt-1"}`,children:[a.jsxs("span",{children:[s.messageCount," messages"]}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:BS(s.lastModified)}),a.jsx("span",{children:"â€¢"}),a.jsx("span",{children:r(s.lastModified)}),(d||p)&&a.jsxs(a.Fragment,{children:[a.jsx("span",{children:"â€¢"}),a.jsx(US,{forkCount:d,forkedFromName:p,forkedFromId:u,onClick:m,size:"sm"})]})]}),f&&!l&&a.jsx("div",{"data-test":"session-fork-action",className:"session-fork-action absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity",children:a.jsx(de,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:x,title:"Fork this session","data-test":"session-fork-btn",children:a.jsx(es,{size:14})})})]})}const WS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]},zS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingSessions)??!1};function pd({value:s,onChange:e,className:t="",placeholder:n="Select a session",label:r="Claude Session",showLabel:o=!0,multiSelect:i=!1}){const[c,l]=h.useState(!1),d=Le(WS),p=Le(zS),u=Array.isArray(s)?s:s?[s]:[],f=h.useMemo(()=>[...d].sort((v,b)=>{const y=new Date(v.lastModified).getTime();return new Date(b.lastModified).getTime()-y}),[d]),m=f.filter(v=>u.includes(v.id)),g=v=>new Date(v).toLocaleDateString(),x=v=>v?v.split("/").slice(-2).join("/"):"No directory",w=v=>{if(i){const b=u.includes(v)?u.filter(y=>y!==v):[...u,v];e(b)}else e(v===s?"":v),l(!1)};return a.jsxs("div",{"data-test":"session-selector",className:`session-selector-container ${t}`,children:[o&&a.jsx(je,{"data-test":"session-selector-label",className:"session-selector-label",children:r}),a.jsxs(st,{open:c,onOpenChange:l,children:[a.jsx(pt,{asChild:!0,children:a.jsxs(de,{"data-test":"session-selector-trigger",variant:"outline",role:"combobox","aria-expanded":c,className:"session-selector-trigger w-full justify-between",disabled:p,children:[m.length>0?a.jsx("span",{className:"truncate",children:i?`${m.length} session${m.length>1?"s":""} selected`:m[0].customName||m[0].name}):a.jsx("span",{className:"text-muted-foreground",children:n}),a.jsx(uc,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),a.jsx(Qe,{"data-test":"session-selector-content",className:"session-selector-content w-[400px] p-0",style:{zIndex:Je.draggablePopoverDropdown},children:a.jsxs(pr,{children:[a.jsx(hr,{"data-test":"session-selector-search",placeholder:"Search sessions..."}),a.jsxs(dn,{className:"max-h-[300px]",children:[a.jsx(un,{children:"No sessions found."}),a.jsxs(As,{children:[!i&&a.jsxs(rs,{"data-test":"session-selector-item-none",value:"none",onSelect:()=>{e(""),l(!1)},className:"session-selector-item-none",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4",u.length===0?"opacity-100":"opacity-0")}),"No Session"]}),f.map(v=>a.jsx(rs,{"data-test":"session-selector-item",value:v.id,onSelect:()=>w(v.id),className:"session-selector-item p-0 cursor-pointer",children:a.jsxs("div",{className:"flex items-center w-full",children:[a.jsx(ct,{className:B("mr-2 h-4 w-4 shrink-0",u.includes(v.id)?"opacity-100":"opacity-0")}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx(ud,{session:v,isSelected:u.includes(v.id),onClick:()=>{},formatDate:g,formatCwd:x,compact:!0})})]})},v.id))]}),f.length===0&&!p&&a.jsx("div",{"data-test":"session-selector-no-sessions",className:"no-sessions text-center py-4 text-sm text-muted-foreground",children:"No sessions available"}),p&&a.jsx("div",{"data-test":"session-selector-loading",className:"loading-sessions text-center py-4 text-sm text-muted-foreground",children:"Loading sessions..."})]})]})})]})]})}const HS=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.sessions)??[]};function GS({sessionIds:s,currentIndex:e,onIndexChange:t,disabled:n=!1,className:r=""}){const[o,i]=h.useState(!1),[c,l]=h.useState(""),d=Le(HS),p=h.useMemo(()=>s.map(b=>d.find(y=>y.id===b)).filter(b=>b!==void 0),[s,d]),u=p[e],f=p.filter(b=>(b.customName??b.name).toLowerCase().includes(c.toLowerCase())),m=b=>{t(b),i(!1),l("")},g=b=>{if(b.stopPropagation(),n||p.length===0)return;const y=e-1,C=y<0?p.length-1:y;t(C)},x=b=>{if(b.stopPropagation(),n||p.length===0)return;const y=e+1,C=y>=p.length?0:y;t(C)},w=b=>new Date(b).toLocaleDateString(),v=b=>b?b.split("/").slice(-2).join("/"):"No directory";return p.length===0?null:p.length===1?a.jsx(ht,{variant:"outline",className:B("navigable-session-badge bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed",r),"data-test":"navigable-session-badge-single",children:(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"}):a.jsxs("div",{className:B("navigable-session-selector flex items-center gap-1",r),"data-test":"navigable-session-selector",children:[a.jsx("button",{onClick:g,disabled:n,className:B("chevron-left p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous session","data-test":"navigable-session-previous-button",children:a.jsx(_s,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(pt,{asChild:!0,children:a.jsxs(ht,{variant:"outline",className:B("navigable-badge cursor-pointer hover:opacity-80 transition-opacity bg-purple-50 text-purple-800 border-purple-200",n&&"opacity-50 cursor-not-allowed"),onClick:b=>{b.stopPropagation(),n&&b.preventDefault()},"data-test":"navigable-session-badge",children:[(u==null?void 0:u.customName)??(u==null?void 0:u.name)??"Session"," (",e+1,"/",p.length,")"]})}),a.jsx(Qe,{className:"popover-content w-[400px] p-2",align:"start","data-test":"navigable-session-popover-content",children:a.jsxs("div",{className:"selector-container space-y-2","data-test":"navigable-session-selector-container",children:[a.jsx(We,{placeholder:"Search sessions...",value:c,onChange:b=>l(b.target.value),className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"navigable-session-search-input"}),a.jsx("div",{className:"sessions-list max-h-64 overflow-y-auto space-y-1","data-test":"navigable-session-list",children:f.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"navigable-session-empty-state",children:"No sessions found"}):f.map(b=>{const y=p.indexOf(b);return a.jsxs(de,{variant:"ghost",className:B("session-item w-full justify-between h-auto px-2 py-1",y===e&&"bg-accent"),onClick:()=>m(y),"data-test":"navigable-session-item",children:[a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx(ud,{session:b,isSelected:y===e,onClick:()=>{},formatDate:w,formatCwd:v,compact:!0})}),y===e&&a.jsx(ct,{className:"check-icon h-4 w-4 ml-2 shrink-0","data-test":"navigable-session-check-icon"})]},b.id)})})]})})]}),a.jsx("button",{onClick:x,disabled:n,className:B("chevron-right p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Next session","data-test":"navigable-session-next-button",children:a.jsx(yt,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]})}function qS(s,e={}){const{loadOnMount:t=!0,subscribeToSSE:n=!0,pageSize:r=50,messageType:o,onSessionDeleted:i}=e,[c,l]=h.useState([]),[d,p]=h.useState(null),[u,f]=h.useState(null),[m,g]=h.useState(!1),[x,w]=h.useState(null),[v,b]=h.useState(1),[y,C]=h.useState(""),[S,j]=h.useState(null),[N,E]=h.useState(!1),R=h.useRef(),D=h.useRef(s),T=h.useRef(new Map);h.useEffect(()=>{D.current=s},[s]);const L=h.useCallback(async(A=1,X=!1,I=!1)=>{var M,U,q;if(!s)return;const k=s;try{I||g(!0),C(""),j(null),E(!1);const W=o??((q=(U=(M=le.getState().app)==null?void 0:M.claude)==null?void 0:U.ui)==null?void 0:q.messageFilters),V=await Ve.getSessionDetails(s,{page:A,pageSize:r,messageType:W});if(D.current!==k)return;if(X)l(ie=>[...V.messages,...ie]);else{const ie=new Set(V.messages.filter(me=>me.role==="user").map(me=>typeof me.content=="string"?me.content:JSON.stringify(me.content)));l(me=>{const oe=me.filter(Se=>Se._isOptimistic).filter(Se=>{const xe=typeof Se.content=="string"?Se.content:JSON.stringify(Se.content);return!ie.has(xe)});return[...V.messages,...oe]});const K=T.current.get(s)||[],ne=K.filter(me=>{const ge=typeof me.content=="string"?me.content:JSON.stringify(me.content);return!ie.has(ge)});ne.length!==K.length&&T.current.set(s,ne)}p({id:s,name:V.name,customName:V.customName,cwd:V.cwd}),f(V.metadata),w(V.pagination??null),b(A)}catch(W){console.error("Failed to load session details:",W),l([]),p(null),f(null),w(null)}finally{I||g(!1)}},[s,r,o]),_=h.useCallback(async(A,X,I=!1)=>{if(!s)return;const k=s;try{g(!0),C(A),j(X),E(!0);const M=await Ve.searchSessionMessages(s,A,X);if(D.current!==k)return;l(I?U=>[...M.results,...U]:M.results),w(M.pagination),b(M.pagination.page)}catch(M){I||l([]),console.error("Failed to search messages:",M)}finally{g(!1)}},[s]),P=h.useCallback(()=>{if(!(!s||!x||v>=x.totalPages))if(N&&y!==void 0){const A={...S,page:v+1};_(y,A,!0)}else L(v+1,!0)},[s,x,v,N,y,S,_,L]),G=h.useCallback(async()=>{s&&(N&&y!==void 0?await _(y,{...S,page:v}):await L(v))},[s,N,y,S,v,_,L]),$=h.useCallback(A=>{if(!s)return"";const X=`optimistic-${Date.now()}`,I={id:X,role:"user",content:A,timestamp:new Date().toISOString(),_isOptimistic:!0},k=T.current.get(s)||[];return T.current.set(s,[...k,I]),l(M=>[...M,I]),X},[s]),Y=h.useCallback(A=>{if(s){const X=T.current.get(s)||[];T.current.set(s,X.filter(I=>I.id!==A))}l(X=>X.filter(I=>I.id!==A))},[s]);return h.useEffect(()=>{const A=s?T.current.get(s)||[]:[];l(A),p(null),f(null),w(null),b(1),C(""),j(null),E(!1),s&&t&&L(1)},[s,t]),h.useEffect(()=>{if(!s)return;const A=le.selectSlice(X=>{var I,k,M;return(M=(k=(I=X.app)==null?void 0:I.claude)==null?void 0:k.ui)==null?void 0:M.messageFilters}).subscribe(X=>{if(JSON.stringify(R.current)!==JSON.stringify(X)&&(R.current=X,!o))if(N&&y!==void 0){const k={...S,messageType:X,page:1};_(y,k)}else L(1,!1,!0)});return()=>A.unsubscribe()},[s,o,N,y,S,_,L]),Ba(A=>{A.type!=="batch-modified"&&("sessionId"in A&&A.sessionId!==s||(A.type==="modified"&&(async()=>{var I,k,M;if(!s)return;const X=s;try{const U=o??((M=(k=(I=le.getState().app)==null?void 0:I.claude)==null?void 0:k.ui)==null?void 0:M.messageFilters),q=await Ve.getSessionDetails(s,{page:1,pageSize:r,messageType:U});if(D.current!==X)return;const W=new Set(q.messages.filter(K=>K.role==="user").map(K=>typeof K.content=="string"?K.content:JSON.stringify(K.content)));l(K=>{const ne=new Set(K.filter(oe=>!oe._isOptimistic).map(oe=>oe.id)),me=q.messages.filter(oe=>!ne.has(oe.id)),ge=K.filter(oe=>{if(!oe._isOptimistic)return!0;const Se=typeof oe.content=="string"?oe.content:JSON.stringify(oe.content);return!W.has(Se)});return me.length===0&&ge.length===K.length?K:[...ge,...me]});const V=T.current.get(s)||[],ie=V.filter(K=>{const ne=typeof K.content=="string"?K.content:JSON.stringify(K.content);return!W.has(ne)});ie.length!==V.length&&T.current.set(s,ie),f(q.metadata)}catch(U){console.error("Failed to fetch new messages on SSE update:",U)}})(),A.type==="deleted"&&(l([]),p(null),f(null),w(null),i==null||i())))},A=>{console.error("SSE connection error in useSessionMessages:",A)},!!s&&n),{messages:c,sessionDetails:d,metadata:u,loading:m,pagination:x,currentPage:v,isSearchActive:N,loadSessionDetails:L,loadOlderMessages:P,searchMessages:_,refreshSession:G,addOptimisticMessage:$,removeOptimisticMessage:Y}}function VS({value:s,options:e,onChange:t,placeholder:n="Search...",disabled:r=!1}){const[o,i]=h.useState(!1),[c,l]=h.useState(""),d=e.find(x=>x.value===s),p=e.findIndex(x=>x.value===s),u=e.filter(x=>x.label.toLowerCase().includes(c.toLowerCase())),f=x=>{t==null||t(x),i(!1),l("")},m=x=>{if(x.stopPropagation(),r)return;const w=p-1,v=w<0?e.length-1:w;t==null||t(e[v].value)},g=x=>{if(x.stopPropagation(),r)return;const w=p+1,v=w>=e.length?0:w;t==null||t(e[v].value)};return d?a.jsxs("div",{className:"navigable-select-container flex items-center gap-1",children:[a.jsx("button",{onClick:m,disabled:r,className:B("chevron-left p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous option",children:a.jsx(_s,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),a.jsxs(st,{open:o,onOpenChange:i,children:[a.jsx(pt,{asChild:!0,children:a.jsx(ht,{variant:d.variant||"secondary",className:B("navigable-badge cursor-pointer hover:opacity-80 transition-opacity",d.className,r&&"opacity-50 cursor-not-allowed"),onClick:x=>{x.stopPropagation(),r&&x.preventDefault()},children:d.label})}),a.jsx(Qe,{className:"popover-content w-64 p-2",align:"start",children:a.jsxs("div",{className:"selector-container space-y-2",children:[a.jsx(We,{placeholder:n,value:c,onChange:x=>l(x.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),a.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:u.length===0?a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):u.map(x=>a.jsxs(de,{variant:"ghost",className:B("option-item w-full justify-between h-8 px-2",x.value===s&&"bg-accent"),onClick:()=>f(x.value),children:[a.jsx(ht,{variant:x.variant||"secondary",className:B("text-xs",x.className),children:x.label}),x.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4"})]},x.value))})]})})]}),a.jsx("button",{onClick:g,disabled:r,className:B("chevron-right p-1 rounded hover:bg-accent transition-colors",r&&"opacity-50 cursor-not-allowed"),"aria-label":"Next option",children:a.jsx(yt,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]}):null}function Gs(){var s;try{const e=(s=le.getState().app)==null?void 0:s.kanban;return e?{spaces:e.spaces??[],activeSpaceId:e.activeSpaceId??"all",customPresets:e.customPresets??[],activePresetId:e.activePresetId??"all",currentFilters:e.currentFilters??Pa,customCategories:e.customCategories??[]}:null}catch(e){return console.error("Failed to load persisted Kanban state:",e),null}}function _n(s){var e;try{const t=le.getState();le.updateState({app:{...t.app,kanban:{...(e=t.app)==null?void 0:e.kanban,...s}}})}catch(t){console.error("Failed to save persisted Kanban state:",t)}}function KS(){try{const s=le.getState();le.updateState({app:{...s.app,kanban:void 0}})}catch(s){console.error("Failed to clear persisted Kanban state:",s)}}const sN={id:!0,title:!0,description:!0,status:!0,priority:!0,category:!0,space:!0,claudeProjectPath:!0,dueDate:!0,createdAt:!0,updatedAt:!0,completedAt:!0,tags:!0,subtasks:!0},Pa={searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[Xe.FREEZER,Xe.BACKLOG,Xe.SELECTED,Xe.DOING,Xe.DONE,Xe.ARCHIVE]};function JS(s){return s&&s.version==="4.0"&&"todos"in s&&"spaces"in s}function YS(s){return{version:"4.0",exportedAt:new Date().toISOString(),...s,loading:!1,error:void 0}}const XS=[{value:Qt.PERSONAL,label:"Personal",variant:"secondary",className:"bg-purple-100 text-purple-800 border-purple-200"},{value:Qt.WORK,label:"Work",variant:"secondary",className:"bg-indigo-100 text-indigo-800 border-indigo-200"},{value:Qt.SHOPPING,label:"Shopping",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Qt.HEALTH,label:"Health",variant:"secondary",className:"bg-pink-100 text-pink-800 border-pink-200"},{value:Qt.OTHER,label:"Other",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}],Fr=["bg-red-100 text-red-800 border-red-200","bg-orange-100 text-orange-800 border-orange-200","bg-amber-100 text-amber-800 border-amber-200","bg-yellow-100 text-yellow-800 border-yellow-200","bg-lime-100 text-lime-800 border-lime-200","bg-emerald-100 text-emerald-800 border-emerald-200","bg-teal-100 text-teal-800 border-teal-200","bg-cyan-100 text-cyan-800 border-cyan-200","bg-sky-100 text-sky-800 border-sky-200","bg-blue-100 text-blue-800 border-blue-200","bg-violet-100 text-violet-800 border-violet-200","bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200","bg-rose-100 text-rose-800 border-rose-200"];class QS{getAllCategories(){const e=this.getCustomCategories();return[...XS,...e]}getCustomCategories(){try{const e=Gs();return(e==null?void 0:e.customCategories)??[]}catch(e){return console.error("[CategoryFacade] Failed to load custom categories:",e),[]}}createCategory(e){try{if(!e||!e.trim())return{success:!1,error:"Category label cannot be empty"};const t=e.trim();if(this.getAllCategories().find(f=>f.label.toLowerCase()===t.toLowerCase()))return{success:!1,error:`Category "${t}" already exists`};const o=`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=this.getCustomCategories(),c=i.map(f=>f.className||""),l=this.getRandomColorClass(c),d={id:o,value:o,label:t,variant:"secondary",className:l,isCustom:!0},p=Gs(),u=[...i,d];return _n({...p,spaces:(p==null?void 0:p.spaces)??[],activeSpaceId:(p==null?void 0:p.activeSpaceId)??"all",customPresets:(p==null?void 0:p.customPresets)??[],activePresetId:(p==null?void 0:p.activePresetId)??"all",currentFilters:(p==null?void 0:p.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:u}),{success:!0,category:d}}catch(t){return console.error("[CategoryFacade] Failed to create category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}deleteCategory(e){try{if(this.isDefaultCategory(e))return{success:!1,error:"Cannot delete default categories"};const t=this.getCustomCategories();if(!t.find(i=>i.id===e))return{success:!1,error:`Category with ID "${e}" not found`};const r=t.filter(i=>i.id!==e),o=Gs();return _n({...o,spaces:(o==null?void 0:o.spaces)??[],activeSpaceId:(o==null?void 0:o.activeSpaceId)??"all",customPresets:(o==null?void 0:o.customPresets)??[],activePresetId:(o==null?void 0:o.activePresetId)??"all",currentFilters:(o==null?void 0:o.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:r}),{success:!0,deletedId:e}}catch(t){return console.error("[CategoryFacade] Failed to delete category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}isDefaultCategory(e){return Object.values(Qt).includes(e)}categoryExists(e){return this.getAllCategories().some(n=>n.value===e)}getCategoryByValue(e){return this.getAllCategories().find(n=>n.value===e)}clearAllCustomCategories(){try{const e=Gs();_n({...e,spaces:(e==null?void 0:e.spaces)??[],activeSpaceId:(e==null?void 0:e.activeSpaceId)??"all",customPresets:(e==null?void 0:e.customPresets)??[],activePresetId:(e==null?void 0:e.activePresetId)??"all",currentFilters:(e==null?void 0:e.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:[]}),console.info("[CategoryFacade] Cleared all custom categories")}catch(e){console.error("[CategoryFacade] Failed to clear custom categories:",e)}}getRandomColorClass(e){const t=Fr.filter(n=>!e.includes(n));return t.length===0?Fr[Math.floor(Math.random()*Fr.length)]:t[Math.floor(Math.random()*t.length)]}}const Ss=new QS,ZS=s=>{var e,t;return((t=(e=s.app)==null?void 0:e.kanban)==null?void 0:t.customCategories)??[]};function e0({value:s,onChange:e,placeholder:t="Search categories...",disabled:n=!1}){const[r,o]=h.useState(!1),[i,c]=h.useState(""),l=Le(ZS),d=h.useMemo(()=>Ss.getAllCategories(),[l]),p=d.find(v=>v.value===s),u=d.filter(v=>v.label.toLowerCase().includes(i.toLowerCase())),f=h.useCallback(v=>{e==null||e(v),o(!1),c("")},[e]),m=h.useCallback(()=>{if(!i.trim())return;const v=Ss.createCategory(i.trim());v.success&&v.category?(f(v.category.value),c("")):console.error("[CategorySelector] Failed to create category:",v.error)},[i,f]),g=h.useCallback((v,b)=>{var C;if(v.stopPropagation(),Ss.isDefaultCategory(b))return;const y=Ss.deleteCategory(b);if(y.success){if(s===b){const S=Ss.getAllCategories();f(((C=S[0])==null?void 0:C.value)||"")}}else console.error("[CategorySelector] Failed to delete category:",y.error)},[s,f]),x=h.useCallback(v=>{o(v),v||c("")},[]);if(!p)return null;const w=i.trim()&&u.length===0;return a.jsxs(st,{open:r,onOpenChange:x,children:[a.jsx(pt,{asChild:!0,children:a.jsx(ht,{"data-test":"category-selector-trigger",variant:p.variant||"secondary",className:B("cursor-pointer hover:opacity-80 transition-opacity",p.className,n&&"opacity-50 cursor-not-allowed"),onClick:v=>{v.stopPropagation(),n&&v.preventDefault()},children:p.label})}),a.jsx(Qe,{className:"popover-content w-64 p-2",align:"start","data-test":"category-selector-popover",children:a.jsxs("div",{className:"selector-container space-y-2","data-test":"category-selector-container",children:[a.jsx(We,{"data-test":"category-search-input",placeholder:t,value:i,onChange:v=>c(v.target.value),onKeyDown:v=>{v.key==="Enter"&&w&&(v.preventDefault(),m())},className:"search-input h-8 text-sm",autoFocus:!0}),a.jsxs("div",{className:"options-list max-h-64 overflow-y-auto space-y-1","data-test":"category-options-list",children:[u.length===0&&!w&&a.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"category-empty-state",children:"No options found"}),w&&a.jsxs(de,{"data-test":"category-create-button",variant:"ghost",className:"category-create-button w-full justify-start h-8 px-2 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:m,children:[a.jsx(Ks,{className:"create-icon h-4 w-4 mr-2","data-test":"category-create-icon"}),'Create "',i,'"']}),u.map(v=>{const b=!Ss.isDefaultCategory(v.value);return a.jsxs("div",{"data-test":"category-option-wrapper",className:B("option-item-wrapper flex items-center gap-1",v.value===s&&"bg-accent rounded"),children:[a.jsxs(de,{"data-test":"category-option-button",variant:"ghost",className:B("option-item flex-1 justify-between h-8 px-2"),onClick:()=>f(v.value),children:[a.jsx(ht,{"data-test":"category-option-badge",variant:v.variant||"secondary",className:B("text-xs",v.className),children:v.label}),v.value===s&&a.jsx(ct,{className:"check-icon h-4 w-4","data-test":"category-selected-check"})]}),b&&a.jsx(de,{"data-test":"category-delete-button",variant:"ghost",size:"icon",className:"category-delete-button h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50",onClick:y=>g(y,v.value),title:"Delete category",children:a.jsx(St,{className:"delete-icon h-4 w-4","data-test":"category-delete-icon"})})]},v.value)})]})]})})]})}function tr(){return"xxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class nN{constructor(e){ee(this,"items",[]);this.initialItems=e,e&&(e.forEach(t=>{t.id===void 0&&(t.id=tr())}),this.items=e)}create(e,t={}){const n={id:tr(),created:new Date().toISOString(),...e},{allowDuplicate:r,uniqueByKey:o}=t;if(r)return this.items.push(n),n;let i=-1;if(o&&(i=this.items.findIndex(p=>p[o]===n[o])),i!==-1)return;const l=this.items.findIndex(p=>p.id===n.id);return l!==-1?(this.items[l]=n,n):(this.items.push(n),n)}insertAt(e,t){const n=structuredClone(this.items);return n.splice(e,0,...t),n}batchCreate(e){this.items.push(...e)}readAll(e=!0){return e?structuredClone(this.items):this.items}readBetween(e,t){const n=[];for(let r=e;r<=t;r++){const o=this.items[r];n.push(o)}return n}readById(e){return this.items.find(t=>t.id===e)}readByKey(e,t){return this.items.find(n=>n[e]===t)}readFirst(){return this.items.length===0?void 0:this.items[0]}readLast(){return this.items.length===0?void 0:this.items[this.items.length-1]}update(e){const t=this.items.findIndex(n=>n.id===e.id);t!==-1&&(this.items[t]=e)}batchUpdate(e){e.forEach(t=>{const n=this.items.findIndex(r=>r.id===t.id);n!==-1&&(this.items[n]=t)})}delete(e){console.log("[CRUDService.ts,123] this.items: ",this.items);const t=this.items.findIndex(n=>n.id===e);console.log("[CRUDService.ts,123] indexToDelete: ",t),t!==-1&&this.items.splice(t,1)}deleteByKey(e,t){this.items=this.items.filter(n=>n[e]!==t)}deleteBetween(e,t){const n=this.items.slice(0,e),r=this.items.slice(t+1,this.items.length);return[...n,...r]}batchDelete(e){this.items=this.items.filter(t=>!e.includes(t.id))}getPreviousItem(e){const n=this.getCurrentItemIndex(e)-1,r=Math.max(n,0);return this.items[r]}getNextItem(e){const n=this.getCurrentItemIndex(e)+1,r=this.count()-1,o=Math.min(n,r);return this.items[o]}getCurrentItemIndex(e){return this.findIndexByKey("id",e)}count(){return this.items.length}clear(){this.items=[]}filterByKey(e,t){return this.items.filter(n=>n[e]===t)}findByKey(e,t){return this.items.find(n=>n[e]===t)}findIndexByKey(e,t){return this.items.findIndex(n=>n[e]===t)}replace(e){e&&(this.items=e)}replaceOne(e,t){console.log(">>>> _ >>>> ~ file: CRUDService.ts:203 ~ replace:",t);const n=structuredClone(this.items);return n[e]=t,n}sort(e,t=!0){this.items.sort((n,r)=>{const o=n[e],i=r[e];return o===i?0:t?o<i?-1:1:o>i?-1:1})}}const t0="TodoDB",s0=2,rt="todos";class n0{constructor(){ee(this,"db",null)}async init(){return new Promise((e,t)=>{const n=indexedDB.open(t0,s0);n.onerror=()=>{t(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=r=>{const o=r.target.result,i=r.target.transaction,c=r.oldVersion;if(!o.objectStoreNames.contains(rt)){const l=o.createObjectStore(rt,{keyPath:"id.value"});l.createIndex("status","status",{unique:!1}),l.createIndex("priority","priority",{unique:!1}),l.createIndex("category","category",{unique:!1}),l.createIndex("createdAt","createdAt.value",{unique:!1}),l.createIndex("dueDate","dueDate.value",{unique:!1}),l.createIndex("sortOrder","sortOrder",{unique:!1})}if(c<2){const l=i.objectStore(rt);l.indexNames.contains("sortOrder")||l.createIndex("sortOrder","sortOrder",{unique:!1});const d=l.getAll();d.onsuccess=()=>{const p=d.result,u={};p.forEach(f=>{const m=f.status||"backlog";u[m]||(u[m]=[]),u[m].push(f)}),Object.keys(u).forEach(f=>{u[f].forEach((m,g)=>{m.sortOrder===void 0&&(m.sortOrder=g,l.put(m))})})}}}})}async getAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([rt],"readonly").objectStore(rt).getAll();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to get todos"))}})}async getById(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([rt],"readonly").objectStore(rt).get(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{n(new Error("Failed to get todo"))}})}async add(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([rt],"readwrite").objectStore(rt).add(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to add todo"))}})}async update(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([rt],"readwrite").objectStore(rt).put(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to update todo"))}})}async delete(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,n)=>{const i=this.db.transaction([rt],"readwrite").objectStore(rt).delete(e);i.onsuccess=()=>{t()},i.onerror=()=>{n(new Error("Failed to delete todo"))}})}async clear(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([rt],"readwrite").objectStore(rt).clear();o.onsuccess=()=>{e()},o.onerror=()=>{t(new Error("Failed to clear todos"))}})}async count(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([rt],"readonly").objectStore(rt).count();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to count todos"))}})}}const dt=new n0;function r0(s){return s&&typeof s=="object"&&("claudeProject"in s||"sessionIds"in s)}class a0{constructor(){ee(this,"initialized",!1)}async init(){if(this.initialized)return;await dt.init(),this.initialized=!0,await dt.count()===0&&await this.seedMockData()}createTodoId(e){return{value:e}}createTimestamp(e){return{value:e??new Date}}async createTodo(e){await this.init();const t=e.status??Xe.BACKLOG;let n=e.sortOrder;if(n===void 0){const i=(await dt.getAll()).filter(l=>l.status===t);n=(i.length>0?Math.max(...i.map(l=>l.sortOrder??0)):-1)+1}const r={id:this.createTodoId(tr()),title:e.title,description:e.description,status:t,priority:e.priority??Gt.MEDIUM,category:e.category??Qt.PERSONAL,space:e.space,sortOrder:n,dueDate:e.dueDate?this.createTimestamp(e.dueDate):void 0,createdAt:this.createTimestamp(),updatedAt:this.createTimestamp(),tags:e.tags??[],subtasks:[],customProps:e.customProps};return await dt.add(r),r}async getTodo(e){await this.init();const t=await dt.getById(e.value);if(!t)throw new Error(`Todo with id ${e.value} not found`);return t}async getAllTodos(e){await this.init();let t=await dt.getAll();if(e!=null&&e.filters){const{status:n,priority:r,category:o,space:i,claudeProjectPath:c,tags:l,searchQuery:d}=e.filters;if(n&&n.length>0&&(t=t.filter(p=>n.includes(p.status))),r&&r.length>0&&(t=t.filter(p=>r.includes(p.priority))),o&&o.length>0&&(t=t.filter(p=>o.includes(p.category))),i&&i.length>0&&(t=t.filter(p=>p.space&&i.includes(p.space))),c&&c.length>0&&(t=t.filter(p=>{if(r0(p.customProps))return p.customProps.claudeProjectPath&&c.includes(p.customProps.claudeProjectPath)})),l&&l.length>0&&(t=t.filter(p=>l.some(u=>p.tags.includes(u)))),d){const p=d.toLowerCase();t=t.filter(u=>{var f;return u.title.toLowerCase().includes(p)||((f=u.description)==null?void 0:f.toLowerCase().includes(p))})}}if(e!=null&&e.sort){const{field:n,direction:r}=e.sort;t.sort((o,i)=>{const c=o[n],l=i[n];if(c==null||l===void 0||l===null)return 0;const d=c<l?-1:c>l?1:0;return r==="asc"?d:-d})}else t.sort((n,r)=>(n.sortOrder??0)-(r.sortOrder??0));if((e==null?void 0:e.offset)!==void 0||(e==null?void 0:e.limit)!==void 0){const n=e.offset??0,r=e.limit??t.length;t=t.slice(n,n+r)}return t}async updateTodo(e,t){await this.init();const n=await this.getTodo(e),r={...n,...t,dueDate:t.dueDate?this.createTimestamp(t.dueDate instanceof Date?t.dueDate:new Date(t.dueDate.value)):n.dueDate,updatedAt:this.createTimestamp(),customProps:t.customProps?{...n.customProps,...t.customProps}:n.customProps};return await dt.update(r),r}async deleteTodo(e){await this.init(),await dt.delete(e.value)}async startTodo(e){return this.updateTodo(e,{status:Xe.DOING})}async completeTodo(e){const t=await this.updateTodo(e,{status:Xe.DONE});return t.completedAt=this.createTimestamp(),await dt.update(t),t}async cancelTodo(e){return this.updateTodo(e,{status:Xe.ARCHIVE})}async addSubtask(e,t){await this.init();const n=await this.getTodo(e),r={id:this.createTodoId(tr()),title:t.title,isCompleted:!1,createdAt:this.createTimestamp()};return n.subtasks.push(r),n.updatedAt=this.createTimestamp(),await dt.update(n),n}async updateSubtask(e,t,n){await this.init();const r=await this.getTodo(e),o=r.subtasks.find(i=>i.id.value===t.value);if(!o)throw new Error(`Subtask with id ${t.value} not found`);return n.title!==void 0&&(o.title=n.title),n.isCompleted!==void 0&&(o.isCompleted=n.isCompleted),r.updatedAt=this.createTimestamp(),await dt.update(r),r}async toggleSubtask(e,t){await this.init();const n=await this.getTodo(e),r=n.subtasks.find(o=>o.id.value===t.value);if(!r)throw new Error(`Subtask with id ${t.value} not found`);return r.isCompleted=!r.isCompleted,n.updatedAt=this.createTimestamp(),await dt.update(n),n}async removeSubtask(e,t){await this.init();const n=await this.getTodo(e);return n.subtasks=n.subtasks.filter(r=>r.id.value!==t.value),n.updatedAt=this.createTimestamp(),await dt.update(n),n}async bulkUpdateStatus(e,t){await this.init(),await Promise.all(e.map(n=>this.updateTodo(n,{status:t})))}async bulkDelete(e){await this.init(),await Promise.all(e.map(t=>this.deleteTodo(t)))}async seedMockData(){const e=[];for(const n of e){const r=await this.createTodo(n);n.title==="Complete project documentation"&&(await this.addSubtask(r.id,{title:"Write API documentation"}),await this.addSubtask(r.id,{title:"Create usage examples"}),await this.addSubtask(r.id,{title:"Add screenshots"})),n.title==="Buy groceries"&&(await this.addSubtask(r.id,{title:"Check pantry inventory"}),await this.addSubtask(r.id,{title:"Make shopping list"}))}const t=await this.getAllTodos();t.length>0&&await this.startTodo(t[0].id),t.length>3&&await this.completeTodo(t[3].id)}async clearAllTodos(){await this.init(),await dt.clear()}async exportTodos(){await this.init();const e=await this.getAllTodos(),t=Gs(),n={todos:e,spaces:(t==null?void 0:t.spaces)??[],activeSpaceId:(t==null?void 0:t.activeSpaceId)??"all",customPresets:(t==null?void 0:t.customPresets)??[],activePresetId:(t==null?void 0:t.activePresetId)??"all",currentFilters:(t==null?void 0:t.currentFilters)??Pa,customCategories:(t==null?void 0:t.customCategories)??[],loading:!1},r={...n,todos:n.todos.map(i=>({...i,createdAt:{value:i.createdAt.value.toISOString()},updatedAt:{value:i.updatedAt.value.toISOString()},completedAt:i.completedAt?{value:i.completedAt.value.toISOString()}:void 0,dueDate:i.dueDate?{value:i.dueDate.value.toISOString()}:void 0,subtasks:i.subtasks.map(c=>({...c,createdAt:{value:c.createdAt.value.toISOString()}}))}))},o=YS(r);return JSON.stringify(o,null,2)}async importTodos(e,t){var d,p,u;await this.init();const n=[];let r=0,o=0,i=0,c=0,l=0;try{const f=JSON.parse(e);if(!JS(f))throw new Error("Invalid format: Expected KanbanExportData v4.0 format");const m=f;t!=null&&t.replace&&(await this.clearAllTodos(),KS());const g=m.todos??[];for(const x of g)try{const w={...x,createdAt:{value:new Date(x.createdAt.value)},updatedAt:{value:new Date(x.updatedAt.value)},completedAt:x.completedAt?{value:new Date(x.completedAt.value)}:void 0,dueDate:x.dueDate?{value:new Date(x.dueDate.value)}:void 0,subtasks:(x.subtasks??[]).map(b=>({...b,createdAt:{value:new Date(b.createdAt.value)}}))};await dt.getById(w.id.value)&&!(t!=null&&t.replace)?o++:(await dt.add(w),r++)}catch(w){n.push(`Failed to import todo "${x.title}": ${w instanceof Error?w.message:"Unknown error"}`),o++}try{const x={spaces:m.spaces??[],activeSpaceId:m.activeSpaceId??"all",customPresets:m.customPresets??[],activePresetId:m.activePresetId??"all",currentFilters:m.currentFilters??Pa,customCategories:m.customCategories??[]};_n(x),c=((d=m.spaces)==null?void 0:d.length)??0,i=((p=m.customPresets)==null?void 0:p.length)??0,l=((u=m.customCategories)==null?void 0:u.length)??0}catch(x){n.push(`Failed to save persisted state: ${x instanceof Error?x.message:"Unknown error"}`)}return{imported:r,skipped:o,errors:n,presetsImported:i,spacesImported:c,categoriesImported:l}}catch(f){throw new Error(`Failed to parse JSON: ${f instanceof Error?f.message:"Unknown error"}`)}}}const tt=new a0;class o0{async createTicket(e,t){await tt.createTodo({...t,status:e})}}class i0{async createSessionForTodo(e,t){const n=await Ve.createSession({message:t.message,cwd:t.projectPath,projectId:t.projectPath,options:{outputFormat:t.outputFormat,permissionMode:t.permissionMode}});return n.success&&n.sessionId&&await this.linkSessionToTodo(e,n.sessionId),n}async linkSessionToTodo(e,t,n={mode:"append"}){var c;const r=await tt.getTodo(e),o=((c=r.customProps)==null?void 0:c.sessionIds)??[],i=n.mode==="replace"?[t]:[...o,t];await tt.updateTodo(e,{customProps:{...r.customProps,sessionIds:i}})}async unlinkSessionFromTodo(e,t){var i;const n=await tt.getTodo(e),o=(((i=n.customProps)==null?void 0:i.sessionIds)??[]).filter(c=>c!==t);await tt.updateTodo(e,{customProps:{...n.customProps,sessionIds:o}})}async getSessionsForTodo(e){var n;return((n=(await tt.getTodo(e)).customProps)==null?void 0:n.sessionIds)??[]}async hasLinkedSessions(e){return(await this.getSessionsForTodo(e)).length>0}buildInitialMessageFromTodo(e){const t=[];if(t.push(`# ${e.title}
`),e.description&&(t.push("## Description"),t.push(e.description),t.push("")),e.dueDate){const n=new Date(e.dueDate.value);t.push(`**Due Date:** ${n.toLocaleDateString()}`),t.push("")}return e.subtasks&&e.subtasks.length>0&&(t.push("## Subtasks"),e.subtasks.forEach(n=>{const r=n.isCompleted?"[x]":"[ ]";t.push(`${r} ${n.title}`)}),t.push("")),e.tags&&e.tags.length>0&&(t.push(`**Tags:** ${e.tags.join(", ")}`),t.push("")),t.push("---"),t.push("I permit and approve all file changes in this session to help complete this task."),t.join(`
`)}async createSessionWithTodoContext(e,t,n={}){var l;const r=await tt.getTodo(e),o=this.buildInitialMessageFromTodo(r),i=t?`${o}

---

${t}`:o,c=n.projectPath??((l=r.customProps)==null?void 0:l.claudeProjectPath);return this.createSessionForTodo(e,{message:i,projectPath:c,outputFormat:n.outputFormat,permissionMode:n.permissionMode})}async setProjectPath(e,t){const n=await tt.getTodo(e);await tt.updateTodo(e,{customProps:{...n.customProps,claudeProjectPath:t}})}async getProjectPath(e){var n;return(n=(await tt.getTodo(e)).customProps)==null?void 0:n.claudeProjectPath}}class c0{constructor(){ee(this,"column");ee(this,"claude");this.column=new o0,this.claude=new i0}async createTestFailureTicket(e){const t=this.buildFailureDescription(e),n=`[Test Failure] ${e.scenario}`;await this.column.createTicket(Xe.BACKLOG,{title:n,description:t,priority:Gt.HIGH,category:Qt.WORK,tags:["test-failure","bdd",e.feature.toLowerCase().replace(/\s+/g,"-")],customProps:{testFailureId:e.id,feature:e.feature,scenario:e.scenario,failedStep:e.failedStep,stepType:e.stepType,stepIndex:e.stepIndex,timestamp:e.timestamp}})}async sendTestFailureToClaude(e,t){const n=this.buildClaudeMessage(e);return await Ve.createSession({message:n,cwd:t==null?void 0:t.projectPath,projectId:t==null?void 0:t.projectPath,options:{outputFormat:t==null?void 0:t.outputFormat,permissionMode:t==null?void 0:t.permissionMode}})}buildClaudeMessage(e){const t=[];return t.push(`I have a BDD test failure that needs debugging help.
`),t.push("## Test Context"),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Step Type:** ${e.stepType||"Unknown"}`),t.push(`**Step Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Step Text:** \`${e.failedStep}\`
`)),t.push("## Error Details"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
## Request`),t.push("Please help me understand:"),t.push("1. What caused this test failure?"),t.push("2. What is the root cause of the error?"),t.push("3. How can I fix this issue?"),t.push("4. Are there any related issues I should be aware of?"),t.join(`
`)}buildFailureDescription(e){const t=[];return t.push(`# Test Failure Report
`),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Type:** ${e.stepType||"Unknown"}`),t.push(`**Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Text:** ${e.failedStep}
`)),t.push("## Error"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
---`),t.push("**Next Steps:**"),t.push("1. Review the error and failed step"),t.push("2. Reproduce the issue locally"),t.push("3. Send to Claude for analysis (Future: Phase 3)"),t.join(`
`)}}const hd=new c0,l0=[{value:Gt.LOW,label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Gt.MEDIUM,label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Gt.HIGH,label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:Gt.URGENT,label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],d0=[{value:Xe.FREEZER,label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:Xe.BACKLOG,label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Xe.SELECTED,label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:Xe.DOING,label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Xe.DONE,label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Xe.ARCHIVE,label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],u0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:n.projects)??[]},p0=s=>{var e,t,n;return((n=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:n.loadingProjects)??!1};function h0({todo:s,mode:e,onUpdate:t,onClose:n,activeSessionId:r,isProcessingAll:o=!1,currentProcessingSubtaskId:i=null,onProcessAll:c,onStopProcessing:l}){const[d,p]=h.useState(""),[u,f]=h.useState(""),[m,g]=h.useState(""),[x,w]=h.useState(""),[v,b]=h.useState(""),[y,C]=h.useState(Xe.BACKLOG),[S,j]=h.useState(Gt.MEDIUM),[N,E]=h.useState(""),[R,D]=h.useState([]),[T,L]=h.useState([]),[_,P]=h.useState([]),[G,$]=h.useState(void 0),[Y,A]=h.useState(0),[X,I]=h.useState({}),k=h.useRef(null),M=h.useRef({}),U=Le(u0),q=Le(p0);h.useEffect(()=>{var O,Q;s?(p(s.title),f(s.description??""),g(s.dueDate?new Date(s.dueDate.value).toISOString().split("T")[0]:""),C(s.status),j(s.priority),E(s.category),D(s.tags),L(s.subtasks),P(((O=s.customProps)==null?void 0:O.sessionIds)??[]),$((Q=s.customProps)==null?void 0:Q.claudeProjectPath)):(p(""),f(""),g(""),C(Xe.BACKLOG),j(Gt.MEDIUM),E(""),D([]),L([]),P([]),$(void 0))},[s]);const W=h.useCallback((O,Q)=>{const we=M.current[O],re=we==null?void 0:we.getTextArea();if(!re||!Q)return 1;const be=re.offsetWidth;if(be===0)return 1;const J=window.getComputedStyle(re),fe=J.font,Ce=J.lineHeight,Ie=Ce==="normal"?parseFloat(J.fontSize)*1.2:parseFloat(Ce),Ae=Vn(Q,be,fe,Ie);return Math.max(1,Math.ceil(Ae/Ie))},[]);h.useEffect(()=>{const O={};T.forEach(Q=>{const we=W(Q.id.value,Q.title);O[Q.id.value]=we}),I(O)},[T,W]),h.useEffect(()=>{var Q;const O=(Q=k.current)==null?void 0:Q.getTextArea();if(O){const we=()=>{const be=O.offsetWidth;A(be)};we();const re=new ResizeObserver(we);return re.observe(O),()=>{re.disconnect()}}},[]);const V=h.useCallback(async O=>{if(e==="edit"&&s)try{await tt.updateTodo(s.id,O),t()}catch(Q){console.error("Failed to update todo:",Q)}},[e,s,t]),ie=h.useCallback(async()=>{if(e==="create"&&d.trim())try{await hd.column.createTicket(y,{title:d.trim(),description:u.trim()||void 0,priority:S,category:N||void 0,tags:R,dueDate:m?new Date(m):void 0,customProps:{sessionIds:_,claudeProject:G}}),t(),n()}catch(O){console.error("Failed to create todo:",O)}},[e,d,u,y,S,N,R,m,_,G,t,n]);h.useCallback(()=>{e==="edit"&&s&&d!==s.title&&d.trim()&&V({title:d})},[e,s,d,V]);const K=h.useCallback(()=>{e==="edit"&&s&&u!==(s.description??"")&&V({description:u})},[e,s,u,V]),ne=h.useCallback(O=>{g(O),e==="edit"&&V(O?{dueDate:{value:new Date(O)}}:{dueDate:void 0})},[e,V]),me=h.useCallback(()=>{const O=x.trim();if(O&&!R.includes(O)){const Q=[...R,O];D(Q),e==="edit"&&V({tags:Q}),w("")}},[x,R,e,V]),ge=h.useCallback(O=>{const Q=R.filter(we=>we!==O);D(Q),e==="edit"&&V({tags:Q})},[R,e,V]),oe=h.useCallback(async()=>{if(v.trim())if(e==="edit"&&s)try{await tt.addSubtask(s.id,{title:v.trim()}),b(""),t()}catch(O){console.error("Failed to add subtask:",O)}else L([...T,{id:{value:`temp-${Date.now()}`},title:v.trim(),isCompleted:!1}]),b("")},[e,s,v,T,t]),Se=h.useCallback(async O=>{if(e==="edit"&&s)try{await tt.toggleSubtask(s.id,O),t()}catch(Q){console.error("Failed to toggle subtask:",Q)}else L(T.map(Q=>Q.id.value===O.value?{...Q,isCompleted:!Q.isCompleted}:Q))},[e,s,T,t]),xe=h.useCallback(async O=>{if(e==="edit"&&s)try{await tt.removeSubtask(s.id,O),t()}catch(Q){console.error("Failed to remove subtask:",Q)}else L(T.filter(Q=>Q.id.value!==O.value))},[e,s,T,t]),Pe=h.useCallback(async()=>{if(u.trim())try{const O=u.split(`
`),Q=[];for(const we of O){const re=we.trim(),J=/^-\s*\[([ x])\]\s*(.+)$/i.exec(re);if(J){const Ie=J[1].toLowerCase()==="x",Ae=J[2].trim();Ae&&Q.push({title:Ae,isCompleted:Ie});continue}const Ce=/^-\s+(.+)$/.exec(re);if(Ce){const Ie=Ce[1].trim();Ie&&Q.push({title:Ie,isCompleted:!1})}}if(e==="edit"&&s){for(const we of Q){const re=await tt.addSubtask(s.id,{title:we.title});if(we.isCompleted){const be=re.subtasks[re.subtasks.length-1];be&&await tt.toggleSubtask(s.id,be.id)}}t()}else{const we=Q.map((re,be)=>({id:{value:`temp-${Date.now()}-${be}`},title:re.title,isCompleted:re.isCompleted}));L([...T,...we])}}catch(O){console.error("Failed to split tasks:",O)}},[e,s,u,T,t]),ae=h.useCallback(O=>{C(O),e==="edit"&&V({status:O})},[e,V]),te=h.useCallback(O=>{j(O),e==="edit"&&V({priority:O})},[e,V]),F=h.useCallback(O=>{E(O),e==="edit"&&V({category:O})},[e,V]),Z=h.useCallback(O=>{const Q=Array.isArray(O)?O:[O];P(Q),e==="edit"&&V({customProps:{sessionIds:Q}})},[e,V]),H=h.useCallback(O=>{var we,re,be;$(O);const Q=le.getState();le.updateState({app:{...Q.app,claude:{...(we=Q.app)==null?void 0:we.claude,ui:{...(be=(re=Q.app)==null?void 0:re.claude)==null?void 0:be.ui,selectedProjectPath:O}}}}),e==="edit"&&V({customProps:{claudeProjectPath:O}})},[e,V]),ce=h.useMemo(()=>U.map(O=>({value:O.path,label:O.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[U]),ue=h.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...ce],[ce]);h.useCallback(O=>{p(O.target.value)},[]);const pe=h.useCallback(O=>{f(O.target.value)},[]),he=h.useCallback(O=>{O.key==="Escape"&&O.currentTarget.blur()},[]),ve=h.useCallback(O=>{w(O.target.value)},[]),Te=h.useCallback(O=>{O.key==="Enter"&&(O.preventDefault(),me())},[me]),ke=h.useCallback(O=>{b(O.target.value)},[]),z=h.useCallback(O=>{O.key==="Enter"&&!O.shiftKey&&(O.preventDefault(),oe())},[oe]);return a.jsxs("div",{className:"details-grid grid grid-cols-4 gap-6","data-test":"todo-details-form",children:[a.jsxs("div",{className:"left-column col-span-3 space-y-6","data-test":"todo-details-left-column",children:[a.jsxs("div",{className:"form-field-description space-y-2","data-test":"todo-details-description-field",children:[a.jsx(je,{htmlFor:"description","data-test":"todo-details-description-label",children:"Description"}),a.jsx(ns,{value:u,onChange:pe,onBlur:K,onKeyDown:he,placeholder:"Enter description...",rows:12,className:"description-textarea min-h-[100px] w-full","data-test":"todo-details-description-textarea",useMarkdown:!0}),a.jsxs("div",{className:"description-actions mt-2 flex gap-2 justify-between","data-test":"todo-details-description-actions",children:[a.jsx(de,{onClick:Pe,size:"sm",variant:"outline",className:"split-tasks-button",disabled:!u.trim(),"data-test":"todo-details-split-tasks-button",children:"Split Tasks"}),e==="edit"?a.jsx(de,{onClick:K,size:"sm",variant:"outline",className:"save-description-button","data-test":"todo-details-save-description-button",children:"Save"}):a.jsx(de,{onClick:ie,size:"sm",variant:"default",className:"create-todo-button",disabled:!d.trim(),"data-test":"todo-details-create-button",children:"Create Todo"})]})]}),a.jsxs("div",{className:"form-field-subtasks space-y-2","data-test":"todo-details-subtasks-field",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(je,{"data-test":"todo-details-subtasks-label",children:"Subtasks"}),e==="edit"&&r&&T.some(O=>!O.isCompleted)&&(c??l)&&a.jsx(de,{size:"sm",variant:o?"destructive":"outline",onClick:o?l:c,className:"process-all-button","data-test":"todo-details-process-all-button",children:o?a.jsxs(a.Fragment,{children:[a.jsx(ft,{className:"w-3 h-3 mr-1"}),"Stop"]}):"Process All"})]}),a.jsxs("div",{className:"subtasks-container space-y-2","data-test":"todo-details-subtasks-container",children:[a.jsx("div",{className:"subtasks-list space-y-2","data-test":"todo-details-subtasks-list",children:T.map(O=>a.jsxs("div",{className:"subtask-item flex items-center gap-2 p-2 rounded border","data-test":"todo-details-subtask-item",children:[a.jsx("input",{type:"checkbox",checked:O.isCompleted,onChange:()=>Se(O.id),className:"subtask-checkbox",disabled:o,"data-test":"todo-details-subtask-checkbox"}),a.jsx("div",{className:B("subtask-title-wrapper flex-1",O.isCompleted&&"line-through text-gray-500"),children:a.jsx(ns,{ref:Q=>{M.current[O.id.value]=Q},value:O.title,onChange:async Q=>{const we=Q.target.value,re=W(O.id.value,we);if(I(be=>({...be,[O.id.value]:re})),e==="edit"&&s)try{await tt.updateSubtask(s.id,O.id,{title:we}),t()}catch(be){console.error("Failed to update subtask title:",be)}else L(T.map(be=>be.id.value===O.id.value?{...be,title:we}:be))},placeholder:"Edit subtask...",className:"subtask-title-textarea resize-none w-full",rows:X[O.id.value]||1,"data-test":"todo-details-subtask-textarea"})}),i===O.id.value&&a.jsx(lr,{className:"w-4 h-4 animate-spin text-blue-500","data-test":"todo-details-subtask-loading"}),e==="edit"&&r&&a.jsx(Aa,{sessionId:r,message:O.title,className:"subtask-send h-7 w-7 hover:text-blue-500",disabled:o,"data-test":"todo-details-subtask-send"}),a.jsx("button",{onClick:()=>xe(O.id),className:"subtask-remove hover:text-red-500",disabled:o,"data-test":"todo-details-subtask-remove",children:a.jsx(ft,{className:"w-4 h-4"})})]},O.id.value))}),a.jsxs("div",{className:"subtask-input flex gap-2","data-test":"todo-details-subtask-input-container",children:[a.jsx(ns,{ref:k,value:v,onChange:ke,onKeyDown:z,placeholder:"Add a subtask...",rows:1,className:"flex-1","data-test":"todo-details-subtask-input"}),a.jsx(de,{onClick:()=>void oe(),size:"sm",className:"subtask-add-button","data-test":"todo-details-subtask-add-button",children:a.jsx(Ks,{className:"w-4 h-4"})})]})]})]}),e==="edit"&&_.length>0&&a.jsxs("div",{className:"form-field-sessions space-y-2","data-test":"todo-details-sessions-field",children:[a.jsxs(je,{"data-test":"todo-details-sessions-label",children:["Claude Session IDs (",_.length,")"]}),_.map((O,Q)=>a.jsx(We,{value:O,readOnly:!0,className:"session-id-input bg-gray-50 mb-1",title:`Session ${Q+1}`,"data-test":"todo-details-session-input"},O))]})]}),a.jsxs("div",{className:"right-column col-span-1 space-y-4","data-test":"todo-details-right-column",children:[a.jsxs("div",{className:"form-field-selectors space-y-4","data-test":"todo-details-selectors",children:[a.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-details-status-selector",children:[a.jsx(je,{"data-test":"todo-details-status-label",children:"Status"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(VS,{value:y,options:d0,onChange:ae,placeholder:"Search status...","data-test":"todo-details-status-select"})})]}),a.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-details-priority-selector",children:[a.jsx(je,{"data-test":"todo-details-priority-label",children:"Priority"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(ia,{value:S,options:l0,onChange:te,placeholder:"Search priorities...",contentStyle:{zIndex:Je.draggablePopoverDropdown},"data-test":"todo-details-priority-badge"})})]}),a.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-details-category-selector",children:[a.jsx(je,{"data-test":"todo-details-category-label",children:"Category"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(e0,{value:N||"personal",onChange:F,placeholder:"Search categories...","data-test":"todo-details-category-select"})})]}),!q&&ue.length>1&&a.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-details-project-selector",children:[a.jsx(je,{"data-test":"todo-details-project-label",children:"Claude Project"}),a.jsx("div",{className:"flex flex-wrap gap-2",children:a.jsx(ia,{value:G??"__no_project__",options:ue,onChange:H,placeholder:"Search projects...",contentStyle:{zIndex:Je.draggablePopoverDropdown},"data-test":"todo-details-project-badge"})})]}),e==="edit"&&a.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-details-session-selector",children:[a.jsx(je,{"data-test":"todo-details-session-selector-label",children:"Claude Sessions"}),a.jsx(pd,{value:_,onChange:Z,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-details-session-select"})]}),a.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-details-tags-selector",children:[a.jsx(je,{"data-test":"todo-details-tags-label",children:"Tags"}),a.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-details-tags-container",children:[a.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-details-tags-list",children:R.map(O=>a.jsxs(ht,{variant:"outline",className:"tag-badge gap-1","data-test":"todo-details-tag",children:[O,a.jsx("button",{onClick:()=>ge(O),className:"tag-remove ml-1 hover:text-red-500","data-test":"todo-details-tag-remove",children:a.jsx(ft,{className:"w-3 h-3"})})]},O))}),a.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-details-tag-input-container",children:[a.jsx(We,{value:x,onChange:ve,onKeyDown:Te,placeholder:"Add a tag...","data-test":"todo-details-tag-input"}),a.jsx(de,{onClick:me,size:"sm",className:"tag-add-button","data-test":"todo-details-tag-add-button",children:a.jsx(Ks,{className:"w-4 h-4"})})]})]})]})]}),a.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-details-due-date-field",children:[a.jsx(je,{htmlFor:"dueDate","data-test":"todo-details-due-date-label",children:"Due Date"}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Op,{className:"w-4 h-4 text-gray-400"}),a.jsx(We,{id:"dueDate",type:"date",value:m,onChange:O=>ne(O.target.value),"data-test":"todo-details-due-date-input"})]})]})]})]})}function f0({todo:s,isOpen:e,onClose:t,onUpdate:n,currentCardIndex:r,totalCardsInColumn:o,onNavigatePrevious:i,onNavigateNext:c,initialValues:l}){var oe,Se,xe,Pe,ae,te;const[d,p]=h.useState("details"),[u,f]=h.useState(""),[m,g]=h.useState(!1),[x,w]=h.useState(null),[v,b]=h.useState(!1),[y,C]=h.useState(!1),[S,j]=h.useState(0),[N,E]=h.useState((s==null?void 0:s.title)??(l==null?void 0:l.title)??""),[R,D]=h.useState(!1),T=!s||s.id.value==="temp-new-todo",L=h.useMemo(()=>T?{id:{value:"temp-create"},title:(l==null?void 0:l.title)??N,description:(l==null?void 0:l.description)??"",status:Xe.BACKLOG,priority:Gt.MEDIUM,category:(l==null?void 0:l.category)??"",sortOrder:0,tags:(l==null?void 0:l.tags)??[],subtasks:[],createdAt:{value:new Date},updatedAt:{value:new Date},customProps:{sessionIds:[],claudeProjectPath:l==null?void 0:l.claudeProjectPath}}:null,[T,l==null?void 0:l.title,l==null?void 0:l.description,l==null?void 0:l.category,l==null?void 0:l.tags,l==null?void 0:l.claudeProjectPath,N]),_=(Se=(oe=s==null?void 0:s.customProps)==null?void 0:oe.sessionIds)==null?void 0:Se[S],P=h.useMemo(()=>{var F;return((F=s==null?void 0:s.customProps)==null?void 0:F.sessionIds)??[]},[(xe=s==null?void 0:s.customProps)==null?void 0:xe.sessionIds]),G=h.useMemo(()=>({loadOnMount:d==="session",subscribeToSSE:d==="session"}),[d]),{messages:$,sessionDetails:Y,metadata:A,loading:X,pagination:I,loadOlderMessages:k,refreshSession:M,addOptimisticMessage:U,removeOptimisticMessage:q}=qS(_,G);h.useLayoutEffect(()=>{var F,Z,H,ce,ue,pe,he;if(e&&((F=s==null?void 0:s.customProps)!=null&&F.claudeProjectPath)){const ve=le.getState();((ce=(H=(Z=ve.app)==null?void 0:Z.claude)==null?void 0:H.ui)==null?void 0:ce.selectedProjectPath)!==s.customProps.claudeProjectPath&&le.updateState({app:{...ve.app,claude:{...(ue=ve.app)==null?void 0:ue.claude,ui:{...(he=(pe=ve.app)==null?void 0:pe.claude)==null?void 0:he.ui,selectedProjectPath:s.customProps.claudeProjectPath}}}})}},[e,(Pe=s==null?void 0:s.customProps)==null?void 0:Pe.claudeProjectPath]),h.useEffect(()=>{p("details"),j(0),E((s==null?void 0:s.title)??(l==null?void 0:l.title)??"")},[s==null?void 0:s.id.value,s==null?void 0:s.title,s==null?void 0:s.description,e,l==null?void 0:l.title]),h.useEffect(()=>{const F=P.length;F>0&&S>=F&&j(0)},[P.length,S]),h.useEffect(()=>{d==="session"&&_&&M()},[S,_,d,M]);const W=h.useCallback(F=>{p(F),F==="session"&&_&&M()},[_,M]),V=h.useCallback(()=>{D(!0)},[]),ie=h.useCallback(async F=>{if(!s){D(!1);return}try{await hd.claude.linkSessionToTodo(s.id,F),n(),D(!1),p("session"),await M()}catch(Z){console.error("Failed to handle session creation:",Z),D(!1)}},[s,n,M]),K=h.useCallback(async()=>{b(!0);try{await M()}finally{b(!1)}},[M]),ne=h.useCallback(async()=>{var Z,H,ce,ue,pe,he,ve,Te,ke,z;if(!s||!_)return;const F=s.subtasks.filter(O=>!O.isCompleted);if(F.length!==0){g(!0),C(!1);try{const O=s.id;for(const Q of F){if(y)break;w(Q.id.value),await Ve.sendMessage({message:Q.title,sessionId:_,options:{outputFormat:"text",permissionMode:"acceptEdits"}});let we=!1;for(let re=0;re<50;re++)if(await new Promise(J=>setTimeout(J,100)),(pe=(ue=(ce=(H=(Z=le.get("app"))==null?void 0:Z.claude)==null?void 0:H.ui)==null?void 0:ce.activity)==null?void 0:ue[_])==null?void 0:pe.isProcessing){we=!0;break}if(!we)console.warn(`[ProcessAll] ${Q.title} - Processing never started, continuing anyway`);else for(let re=0;re<600&&(await new Promise(J=>setTimeout(J,100)),!!((z=(ke=(Te=(ve=(he=le.get("app"))==null?void 0:he.claude)==null?void 0:ve.ui)==null?void 0:Te.activity)==null?void 0:ke[_])==null?void 0:z.isProcessing));re++);await tt.toggleSubtask(O,Q.id),await new Promise(re=>setTimeout(re,500))}n()}catch(O){console.error("Failed to process all subtasks:",O)}finally{g(!1),w(null),C(!1)}}},[s,_,n,y]),me=h.useCallback(()=>{C(!0)},[]),ge=h.useCallback(async F=>{const Z=F.target.value;if(E(Z),!T&&s)try{await tt.updateTodo(s.id,{title:Z}),n()}catch(H){console.error("Failed to update todo title:",H)}},[T,s,n]);return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"panel-header","data-test":"kanban-card-details-header",children:a.jsxs("div",{className:"header-title-row flex items-center justify-between gap-4","data-test":"kanban-card-details-title-row",children:[a.jsxs("div",{className:"header-left flex items-center gap-2 flex-1 min-w-0","data-test":"kanban-card-details-header-left",children:[!T&&a.jsx(uo,{"data-test":"kanban-card-details-session-activity",sessionIds:P,showCount:!0,isCreating:R}),!T&&i&&a.jsx(de,{"data-test":"kanban-card-details-navigate-previous",variant:"ghost",size:"icon",onClick:i,disabled:r===0,className:"navigate-previous-card h-8 w-8 flex-shrink-0",title:"Previous card in column",children:a.jsx(_s,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-left-icon"})}),a.jsx("div",{className:"flex-1 min-w-0","data-test":"kanban-card-details-title-wrapper",children:a.jsx(ns,{"data-test":"kanban-card-details-title-textarea",value:N,onChange:ge,placeholder:T?"Enter todo title...":"Edit todo title",className:"todo-title-textarea text-lg font-semibold resize-none w-full",rows:1})}),!T&&c&&a.jsx(de,{"data-test":"kanban-card-details-navigate-next",variant:"ghost",size:"icon",onClick:c,disabled:r!==void 0&&o!==void 0&&r>=o-1,className:"navigate-next-card h-8 w-8 flex-shrink-0",title:"Next card in column",children:a.jsx(yt,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-right-icon"})})]}),!T&&s&&a.jsxs("div",{className:"header-actions flex items-center gap-2 flex-shrink-0","data-test":"kanban-card-details-header-actions",children:[a.jsx(pd,{"data-test":"kanban-card-details-session-selector",value:((ae=s.customProps)==null?void 0:ae.sessionIds)??[],onChange:async F=>{const Z=Array.isArray(F)?F:[];await tt.updateTodo(s.id,{customProps:{...s.customProps,sessionIds:Z}}),n()},className:"session-selector-header",showLabel:!1,placeholder:"Link to sessions",multiSelect:!0}),a.jsx(Ea,{"data-test":"kanban-card-details-create-session-button",variant:"ghost",size:"icon",className:"create-session-button-panel",initialMessage:`Working on: ${s.title}

${s.description??""}`,projectPath:(te=s.customProps)==null?void 0:te.claudeProjectPath,onCreating:V,onSessionCreated:ie,useModal:!0})]})]})}),a.jsxs(Ql,{value:d,onValueChange:W,className:"panel-tabs flex-1 flex flex-col overflow-hidden","data-test":"kanban-card-details-tabs",children:[a.jsxs(lo,{className:B("grid w-full",T?"grid-cols-1":"grid-cols-2"),"data-test":"kanban-card-details-tabs-list",children:[a.jsx(an,{value:"details","data-test":"kanban-card-details-tab-details",children:"Details"}),!T&&a.jsx(an,{value:"session",disabled:!_,"data-test":"kanban-card-details-tab-session",children:"Claude Session"})]}),a.jsx(on,{value:"details",className:"panel-form mt-4 flex-1 overflow-y-auto data-[state=inactive]:hidden","data-test":"kanban-card-details-details-content",children:a.jsx(h0,{todo:T?L:s,mode:T?"create":"edit",onUpdate:n,onClose:t,activeSessionId:_,isProcessingAll:m,currentProcessingSubtaskId:x,onProcessAll:ne,onStopProcessing:me})}),!T&&a.jsxs(on,{value:"session",className:"session-tab mt-4 flex-1 flex flex-col overflow-hidden data-[state=inactive]:hidden","data-test":"kanban-card-details-session-content",children:[null,X?a.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session",children:"Loading session..."}):_&&!Y?a.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session-initial",children:a.jsxs(de,{variant:"outline",size:"sm",onClick:()=>void M(),className:"load-session-button",children:[a.jsx(On,{className:"w-4 h-4 mr-2"}),"Load Session"]})}):Y?a.jsxs("div",{className:"session-chat-area flex flex-col gap-4 h-[calc(100vh-220px)]","data-test":"kanban-card-details-chat-area",children:[a.jsxs("div",{className:"session-header flex items-center justify-between","data-test":"kanban-card-details-session-header",children:[a.jsxs("div",{className:"session-header-left flex items-center gap-3","data-test":"kanban-card-details-session-header-left",children:[a.jsx("h3",{className:"session-title text-sm font-medium text-muted-foreground","data-test":"kanban-card-details-session-title",children:"Session Messages"}),P.length>1&&a.jsx(GS,{"data-test":"kanban-card-details-session-navigator",sessionIds:P,currentIndex:S,onIndexChange:j,className:"session-navigator"})]}),a.jsxs(de,{"data-test":"kanban-card-details-refresh-button",onClick:()=>void K(),size:"sm",variant:"outline",disabled:v,className:"refresh-session-button",children:[a.jsx(On,{className:B("w-4 h-4 mr-2",v&&"animate-spin"),"data-test":"kanban-card-details-refresh-icon"}),v?"Refreshing...":"Refresh"]})]}),a.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden","data-test":"kanban-card-details-chat-messages",children:a.jsx(MS,{"data-test":"kanban-card-details-chat-interface",messages:$,sessionDetails:Y,metadata:A,loading:X,pagination:I,onLoadOlder:I&&I.page<I.totalPages?k:void 0})}),a.jsx("div",{className:"chat-input flex-shrink-0","data-test":"kanban-card-details-chat-input",children:a.jsx($S,{"data-test":"kanban-card-details-message-input",sessionId:_,value:u,onChange:f,onSendSuccess:()=>{M()},onAddOptimisticMessage:U,onRemoveOptimisticMessage:q})})]}):a.jsx("div",{className:"no-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-no-session",children:"No Claude session found"})]})]})]})}function m0({isOpen:s,onClose:e,onUpdate:t,triggerPosition:n,initialValues:r}){var c,l,d;const i={claudeProjectPath:((d=(l=(c=le.getState().app)==null?void 0:c.claude)==null?void 0:l.ui)==null?void 0:d.selectedProjectPath)??void 0,...r};return a.jsx(Vt,{isVisible:s,onClose:e,title:"Create New Todo",shouldCloseManually:!0,resizable:!0,initialSize:{width:900,height:600},triggerPosition:n??void 0,className:"add-ticket-popover","data-test":"add-ticket-popover",children:a.jsx("div",{"data-test":"add-ticket-popover-content",className:"popover-content flex flex-col h-full overflow-hidden p-4",children:a.jsx(f0,{todo:null,isOpen:s,onClose:e,onUpdate:t,initialValues:i})})})}function Si({onTicketCreated:s,initialValues:e,variant:t="ghost",size:n="icon",className:r="add-ticket-button",title:o="Add New Ticket"}){const[i,c]=h.useState(!1),[l,d]=h.useState(null),p=m=>{const g=m.currentTarget.getBoundingClientRect();d({x:g.left,y:g.top}),c(!0)},u=()=>{c(!1),d(null)},f=()=>{s&&s(),u()};return a.jsxs(a.Fragment,{children:[a.jsx(de,{variant:t,size:n,onClick:p,title:o,className:r,"data-test":"add-ticket-button",children:a.jsx(Lp,{className:"h-5 w-5","data-test":"add-ticket-button-icon"})}),a.jsx(m0,{isOpen:i,onClose:u,onUpdate:f,triggerPosition:l,initialValues:e,"data-test":"add-ticket-popover"})]})}function g0({version:s}){const e=_a(),t=xs(),[n,r]=h.useState(!1);if(e.pathname==="/game"||e.pathname==="/new-home")return null;const o=typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port.startsWith("517");if(t)return a.jsxs("header",{"data-test":n?"mobile-header-expanded":"mobile-header-collapsed",className:"sticky top-0 z-50 bg-black text-white shadow-md",children:[a.jsx("div",{className:"overflow-hidden transition-[max-height] duration-300 ease-in-out",style:{maxHeight:n?"200px":"0px"},children:a.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[a.jsx(ea,{}),o&&a.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Xr,{className:Fe.md}),a.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Ft,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Wr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?a.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?a.jsxs(a.Fragment,{children:[a.jsx(jo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?a.jsxs(a.Fragment,{children:[a.jsx(Co,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?a.jsxs(a.Fragment,{children:[a.jsx(Kr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?a.jsxs(a.Fragment,{children:[a.jsx(No,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):a.jsxs(a.Fragment,{children:[a.jsx(Vr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Js,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(ko,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(zr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Hr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Gr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Br,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):a.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&a.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),a.jsx($o,{}),a.jsx(Si,{}),a.jsx(gi,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(Ea,{variant:"ghost",size:"icon",icon:a.jsx(Yr,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),a.jsx(Ro,{variant:"ghost",size:"icon"})]})]})}),a.jsx("button",{"data-test":"mobile-header-toggle-btn",onClick:()=>r(!n),className:"w-full h-[10px] flex items-center justify-center active:bg-gray-800 cursor-pointer",children:a.jsx("div",{className:"transition-transform duration-300",style:{transform:n?"rotate(180deg)":"rotate(0deg)"},children:a.jsx(ut,{className:"h-3 w-3 text-gray-400"})})})]});const i=a.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[a.jsx(ea,{}),o&&a.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Xr,{className:Fe.md}),a.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Ft,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Wr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?a.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?a.jsxs(a.Fragment,{children:[a.jsx(jo,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?a.jsxs(a.Fragment,{children:[a.jsx(Co,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?a.jsxs(a.Fragment,{children:[a.jsx(Kr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?a.jsxs(a.Fragment,{children:[a.jsx(No,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):a.jsxs(a.Fragment,{children:[a.jsx(Vr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Js,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(ko,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(zr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(qr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Hr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Gr,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?a.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[a.jsx(Br,{className:Fe.md}),a.jsxs("h1",{className:"text-xl font-semibold",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):a.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[o&&a.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&a.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),a.jsx($o,{}),a.jsx(Si,{}),a.jsx(gi,{variant:"ghost",size:"icon",title:"Audio Recorder"}),a.jsx(Ea,{variant:"ghost",size:"icon",icon:a.jsx(Yr,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),a.jsx(Ro,{variant:"ghost",size:"icon"})]})]});return a.jsxs("header",{"data-test":n?"desktop-header-expanded":"desktop-header-collapsed",className:"sticky top-0 z-50 bg-black text-white shadow-md",children:[a.jsx("div",{className:"overflow-hidden transition-[max-height] duration-300 ease-in-out",style:{maxHeight:n?"200px":"0px"},children:i}),a.jsx("button",{"data-test":"desktop-header-toggle-btn",onClick:()=>r(!n),className:"w-full h-[10px] flex items-center justify-center hover:bg-gray-800 cursor-pointer",children:a.jsx("div",{className:"transition-transform duration-300",style:{transform:n?"rotate(180deg)":"rotate(0deg)"},children:a.jsx(ut,{className:"h-3 w-3 text-gray-400"})})})]})}function x0(){const s=document.activeElement;if(!s)return null;const e=["INPUT","TEXTAREA"].includes(s.nodeName??""),t=s.contentEditable==="true";return e||t}class v0{constructor(){ee(this,"shortcuts",new Map);ee(this,"isListening",!1);this.handleKeyDown=this.handleKeyDown.bind(this)}generateShortcutId(e){const t=[];return e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),`${t.join("+")}-${e.key.toLowerCase()}`}handleKeyDown(e){if(x0())return;const t=this.generateShortcutId({key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey}),n=this.shortcuts.get(t);n&&(n.preventDefault!==!1&&e.preventDefault(),n.callback())}register(e){const t=this.generateShortcutId(e);return this.shortcuts.set(t,e),this.isListening||this.startListening(),()=>this.unregister(t)}unregister(e){this.shortcuts.delete(e),this.shortcuts.size===0&&this.stopListening()}unregisterAll(){this.shortcuts.clear(),this.stopListening()}startListening(){this.isListening||(document.addEventListener("keydown",this.handleKeyDown),this.isListening=!0)}stopListening(){this.isListening&&(document.removeEventListener("keydown",this.handleKeyDown),this.isListening=!1)}getRegisteredShortcuts(){return Array.from(this.shortcuts.values())}isShortcutRegistered(e){const t=this.generateShortcutId(e);return this.shortcuts.has(t)}}const ks=new v0,ji="command-palette-recently-used",b0=5;function w0({actions:s=[],placeholder:e="Type a command or search..."}){const[t,n]=h.useState(!1),[r,o]=h.useState(""),[i,c]=h.useState(()=>{try{const u=localStorage.getItem(ji);return u?JSON.parse(u):[]}catch{return[]}});h.useEffect(()=>{const u=ks.register({key:"q",altKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),f=ks.register({key:"p",metaKey:!0,preventDefault:!0,callback:()=>n(g=>!g)}),m=ks.register({key:"q",ctrlKey:!0,altKey:!0,preventDefault:!0,callback:()=>{const g=i[0];if(g){const x=s.find(w=>w.id===g);x&&x.action()}}});return()=>{u(),f(),m()}},[i,s]),h.useEffect(()=>{if(!t)return;const u=f=>{if(f.key!=="ArrowUp"&&f.key!=="ArrowDown")return;const m=Array.from(document.querySelectorAll("[cmdk-item]")).filter(v=>v.getAttribute("data-disabled")!=="true");if(m.length===0)return;const g=m.map(v=>v.getAttribute("data-value")||""),x=g.indexOf(r);let w;if(f.key==="ArrowUp"){x<=0&&(f.preventDefault(),f.stopPropagation(),w=m.length-1,o(g[w]));return}else{x>=m.length-1&&(f.preventDefault(),f.stopPropagation(),w=0,o(g[w]));return}};return document.addEventListener("keydown",u,{capture:!0}),()=>document.removeEventListener("keydown",u,{capture:!0})},[t,r]);const l=s.reduce((u,f)=>{const m=f.group??"General";return u[m]||(u[m]=[]),u[m].push(f),u},{}),d=u=>{n(!1),u.action(),c(f=>{const m=f.filter(x=>x!==u.id),g=[u.id,...m].slice(0,b0);try{localStorage.setItem(ji,JSON.stringify(g))}catch{}return g})},p=i.map(u=>s.find(f=>f.id===u)).filter(u=>u!==void 0);return a.jsxs(Mc,{open:t,onOpenChange:n,value:r,onValueChange:o,"data-test":"command-palette-dialog",children:[a.jsx(hr,{"data-test":"command-palette-input",placeholder:e}),a.jsxs(dn,{"data-test":"command-palette-list",children:[a.jsx(un,{"data-test":"command-palette-empty",children:"No results found."}),p.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(As,{heading:"Recently Used","data-test":"command-group-recent",children:p.map(u=>a.jsxs(rs,{value:`recent-${u.id}`,onSelect:()=>d(u),className:"command-item flex justify-between items-center","data-test":"command-item-recent",children:[a.jsx("span",{"data-test":"command-item-recent-label",children:u.label}),u.shortcut&&a.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":"command-item-recent-shortcut",children:u.shortcut})]},`recent-${u.id}`))}),a.jsx(ca,{"data-test":"command-separator-recent"})]}),Object.entries(l).map(([u,f],m)=>a.jsxs("div",{"data-test":"command-group-container",children:[m>0&&a.jsx(ca,{"data-test":"command-separator"}),a.jsx(As,{heading:u,"data-test":"command-group",children:f.map(g=>a.jsxs(rs,{value:g.id,onSelect:()=>d(g),className:"command-item flex justify-between items-center","data-test":"command-item",children:[a.jsx("span",{"data-test":"command-item-label",children:g.label}),g.shortcut&&a.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":"command-item-shortcut",children:g.shortcut})]},g.id))})]},u))]})]})}const y0=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),S0=s=>(e,t)=>{if(!t)return 1;let n=t,r=e;if(s.matchCase||(n=n.toLowerCase(),r=r.toLowerCase()),s.matchWholeWord)return new RegExp(`\\b${y0(n)}\\b`,s.matchCase?"":"i").test(e)?1:0;const o=r.includes(n);if(s.mode==="fuzzy"){if(o)return 2;let i=0;for(let c=0;c<r.length&&i<n.length;c++)r[c]===n[i]&&i++;return i===n.length?1:0}else return o?1:0},j0={matchCase:!1,matchWholeWord:!1,mode:"fuzzy"};function C0({placeholder:s="Search...",initialOptions:e,onSearchOptionsChange:t,onSearchChange:n,onNavigate:r,className:o}){const[i,c]=h.useState(e??j0),l=h.useCallback(f=>{c(f),t==null||t(f)},[t]),d=()=>{const f={...i,matchCase:!i.matchCase};l(f)},p=()=>{const f={...i,matchWholeWord:!i.matchWholeWord};l(f)},u=()=>{const f={...i,mode:i.mode==="fuzzy"?"exact":"fuzzy"};l(f)};return a.jsxs("div",{className:B("flex items-center border-b px-3 pr-12",o),"cmdk-input-wrapper":"","data-test":"search-input-with-options",children:[a.jsx(cr,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),a.jsx(gt.Input,{"data-test":"search-input",placeholder:s,onValueChange:n,className:"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"}),a.jsxs("div",{className:"flex items-center gap-0.5 shrink-0","data-test":"search-options",children:[a.jsx("button",{type:"button",onClick:d,className:B("p-1.5 rounded hover:bg-accent transition-colors",i.matchCase&&"bg-accent text-accent-foreground"),title:"Match Case (Aa)","data-test":"search-match-case-button",children:a.jsx(Mp,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:p,className:B("p-1.5 rounded hover:bg-accent transition-colors",i.matchWholeWord&&"bg-accent text-accent-foreground"),title:"Match Whole Word","data-test":"search-match-whole-word-button",children:a.jsx(Fp,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:u,className:B("p-1.5 rounded hover:bg-accent transition-colors text-xs font-mono",i.mode==="exact"&&"bg-accent text-accent-foreground"),title:i.mode==="fuzzy"?"Fuzzy Search (click for Exact)":"Exact Search (click for Fuzzy)","data-test":"search-mode-button",children:i.mode==="fuzzy"?"Fz":"Ex"}),a.jsx("div",{className:"w-px h-4 bg-border mx-1","data-test":"search-separator"}),a.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("up"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Previous Result (â†‘)","data-test":"search-navigate-up-button",children:a.jsx(ir,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:()=>r==null?void 0:r("down"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Next Result (â†“)","data-test":"search-navigate-down-button",children:a.jsx(ut,{className:"h-4 w-4"})})]})]})}function N0(s,e){return{navigateResults:h.useCallback(n=>{const r=Array.from(document.querySelectorAll("[cmdk-item]")).filter(l=>l.getAttribute("data-disabled")!=="true");if(r.length===0)return;const o=r.map(l=>l.getAttribute("data-value")||""),i=o.indexOf(s);let c;n==="up"?c=i<=0?r.length-1:i-1:c=i>=r.length-1?0:i+1,e(o[c])},[s,e])}}function k0({placeholder:s="Go to node by title or content..."}){const[e,t]=h.useState(!1),[n,r]=h.useState(""),[o,i]=h.useState(""),c=Mt.getState().getGoToSymbolSearch(),[l,d]=h.useState((c==null?void 0:c.options)??{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}),p=h.useCallback(w=>{d(w),Mt.getState().setGoToSymbolSearchOptions(w)},[]),u=h.useMemo(()=>S0(l),[l]),{navigateResults:f}=N0(n,r),m=h.useMemo(()=>{var b;if(!e)return[];const w=Mt.getState();if(!((b=w.state)!=null&&b.projects))return[];const v=[];return Object.values(w.state.projects).forEach(y=>{Object.values(y.workspaces).forEach(C=>{Object.values(C.canvases).forEach(S=>{(S.coreState.nodes||[]).forEach(N=>{var L;const E=(L=N.data)==null?void 0:L.nodeType;if(E==="workflowOrchestration"||E==="workflowSource")return;const R=N.title||"",D=typeof N.content=="string"?N.content:"",T=D.length>80?D.substring(0,80)+"...":D;!R&&!D||v.push({id:`${S.id}:${N.id}`,nodeId:N.id,canvasId:S.id,title:R||T.substring(0,40)||N.id,contentPreview:T,path:`${y.name} / ${C.name} / ${S.name}`,node:N})})})})}),v},[e]),g=h.useMemo(()=>{const w={};return m.forEach(v=>{w[v.path]||(w[v.path]=[]),w[v.path].push(v)}),w},[m]),x=h.useCallback(w=>{o.trim()&&Mt.getState().addGoToSymbolSearchHistory(o.trim()),t(!1),i("");const v=Mt.getState();v.projectCanvas.switch(w.canvasId),setTimeout(()=>{v.scrollToNode(w.nodeId,500),v.setSelectedNodes([w.node])},50)},[o]);return h.useEffect(()=>{const w=ks.register({key:"o",ctrlKey:!0,preventDefault:!0,callback:()=>t(b=>!b)}),v=ks.register({key:"o",metaKey:!0,preventDefault:!0,callback:()=>t(b=>!b)});return()=>{w(),v()}},[]),h.useEffect(()=>{if(!e)return;const w=v=>{if(v.key!=="ArrowUp"&&v.key!=="ArrowDown")return;const b=Array.from(document.querySelectorAll("[cmdk-item]")).filter(S=>S.getAttribute("data-disabled")!=="true");if(b.length===0)return;const y=b.map(S=>S.getAttribute("data-value")||""),C=y.indexOf(n);if(v.key==="ArrowUp"){C<=0&&(v.preventDefault(),v.stopPropagation(),r(y[b.length-1]));return}else{C>=b.length-1&&(v.preventDefault(),v.stopPropagation(),r(y[0]));return}};return document.addEventListener("keydown",w,{capture:!0}),()=>document.removeEventListener("keydown",w,{capture:!0})},[e,n]),a.jsxs(Mc,{open:e,onOpenChange:t,value:n,onValueChange:r,filter:u,"data-test":"go-to-symbol-dialog",children:[a.jsx(C0,{placeholder:s,initialOptions:l,onSearchOptionsChange:p,onSearchChange:i,onNavigate:f}),a.jsxs(dn,{"data-test":"go-to-symbol-list",children:[a.jsx(un,{"data-test":"go-to-symbol-empty",children:"No nodes found."}),Object.entries(g).map(([w,v])=>a.jsx(As,{heading:w,"data-test":"go-to-symbol-group",children:v.map(b=>a.jsxs(rs,{value:`${b.title} ${b.contentPreview} ${b.path}`,onSelect:()=>x(b),className:"flex flex-col items-start gap-0.5","data-test":"go-to-symbol-item",children:[a.jsx("span",{className:"font-medium text-sm","data-test":"go-to-symbol-item-title",children:b.title}),b.contentPreview&&b.title!==b.contentPreview.substring(0,40)&&a.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-full","data-test":"go-to-symbol-item-preview",children:b.contentPreview})]},b.id))},w))]})]})}function E0(s){const e=s.split(/[/\\]/),t=e.pop()||"",n=/:(\d+)(?::\d+)?$/.exec(t);let r="",o=t;return n&&(r=n[1],o=t.slice(0,n.index)),{dir:e.join("/"),filename:o,line:r}}function Ra(s){return E0(s).filename}function T0(s,e,t=300,n=15,r=10,o=200){let i=s+n,c=e+n;return i+t>window.innerWidth&&(i=window.innerWidth-t-r),c+o>window.innerHeight&&(c=window.innerHeight-o-r),i<r&&(i=r),c<r&&(c=r),{left:i,top:c}}function I0({onElementClicked:s,onElementHovered:e,onInspectorActivated:t,onInspectorDeactivated:n,shouldInspectElement:r,renderTooltip:o,excludeClassNames:i=[],tooltipOwnerId:c,clickOwnerId:l=null}){const[d,p]=h.useState(!1),[u,f]=h.useState(null),m=h.useRef(null),g=h.useRef(s),x=h.useRef(e),w=h.useRef(t),v=h.useRef(n),b=h.useRef(r),y=h.useRef(null),C=h.useRef(null),S=h.useRef(null);h.useEffect(()=>{g.current=s,x.current=e,w.current=t,v.current=n,b.current=r}),h.useEffect(()=>{if(c)return vt.claimTooltip(c),()=>{vt.releaseTooltip(c)}},[c]);const j=h.useMemo(()=>["inspector-tooltip","collected-elements-popover",...i],[i]),N=h.useRef({}),E=h.useCallback(($,...Y)=>{const A=Date.now();(!N.current[$]||A-N.current[$]>500)&&(N.current[$]=A,console.log(...Y))},[]),R=h.useCallback(($,Y="hover")=>{for(const M of j)if($.closest(`.${M}`))return E("class-"+M,`[Inspector:${Y}] Excluding by class:`,M,$),!0;const A=["word-extractor-app","word-extractor-app-body","word-extractor-mount","watcher-context-menu"];if($.id&&A.includes($.id))return E("id-"+$.id,`[Inspector:${Y}] Excluding by ID:`,$.id,$),!0;if($.closest("#word-extractor-app"))return E("closest-app",`[Inspector:${Y}] Excluding by closest #word-extractor-app`,$),!0;const X=$.getRootNode();if(X instanceof ShadowRoot){const M=X.host;if(M&&A.includes(M.id))return E("shadow-host",`[Inspector:${Y}] Excluding by shadow DOM host:`,M.id),!0}const I=["custom-capture-controller","custom-capture-content","content-capture-controller","capture-mode-select","custom-selector","field-dialog","array-dialog","draggable-popover-container","draggable-popover-wrapper","schema-panel","preview-panel","watcher-extension-app"];let k=$;for(;k;){const M=k.getAttribute("data-test");if(M){for(const U of I)if(M===U||M.startsWith(U))return!0}k=k.parentElement}return!!(b.current&&!b.current($))},[j,E]),D=h.useCallback($=>{var W;const A=$.composedPath()[0]||$.target;if(A.closest("[data-radix-select-content]")||A.closest("[data-radix-popper-content-wrapper]")||A.closest("[role='option']")||R(A))return;const X=m.current===A;m.current&&!X&&(m.current.style.outline="",m.current.style.outlineOffset=""),A.style.outline="2px solid #06b6d4",A.style.outlineOffset="2px",m.current=A;const I=A.tagName.toLowerCase(),k=Array.from(A.classList),M=A.getAttribute("data-test")||void 0,U=A.getAttribute("data-react-inspector")||void 0,q={tagName:I,classes:k,dataTest:M,reactInspectorId:U,resolvedPath:void 0,x:$.clientX,y:$.clientY};X?f(V=>V?{...V,x:$.clientX,y:$.clientY}:q):(f(q),(W=x.current)==null||W.call(x,A,q))},[R]),T=h.useCallback($=>{var q;const A=$.composedPath()[0]||$.target;if(A.closest("[data-radix-select-content]")||A.closest("[data-radix-popper-content-wrapper]")||A.closest("[role='option']")||R(A,"click")||!vt.canHandleClicks(l))return;$.preventDefault(),$.stopPropagation();const X=A.tagName.toLowerCase(),I=Array.from(A.classList),k=A.getAttribute("data-test")||void 0,M=A.getAttribute("data-react-inspector")||void 0,U={tagName:X,classes:I,dataTest:k,reactInspectorId:M,resolvedPath:void 0,x:$.clientX,y:$.clientY};(q=g.current)==null||q.call(g,A,U)},[R,l]),L=h.useCallback($=>{$.key==="Escape"&&d&&vt.deactivate()},[d]);h.useEffect(()=>(p(vt.getState()),vt.subscribe(Y=>{var A,X;p(Y),Y?(A=w.current)==null||A.call(w):(X=v.current)==null||X.call(v)})),[]),h.useEffect(()=>{var $;return d?(y.current=D,C.current=T,S.current=L,document.body.style.setProperty("cursor","crosshair","important"),document.addEventListener("mousemove",D),document.addEventListener("click",T,!0),document.addEventListener("keydown",L)):(document.body.style.removeProperty("cursor"),y.current&&document.removeEventListener("mousemove",y.current),C.current&&document.removeEventListener("click",C.current,!0),S.current&&document.removeEventListener("keydown",S.current),f(null),($=x.current)==null||$.call(x,null,null),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)),()=>{document.body.style.removeProperty("cursor"),y.current&&document.removeEventListener("mousemove",y.current),C.current&&document.removeEventListener("click",C.current,!0),S.current&&document.removeEventListener("keydown",S.current),m.current&&(m.current.style.outline="",m.current.style.outlineOffset="",m.current=null)}},[d]);const _=u?T0(u.x,u.y):{left:0,top:0},P=u&&a.jsx("div",{className:"inspector-tooltip fixed z-[9999] bg-black text-white p-3 rounded-lg shadow-xl text-xs font-mono pointer-events-none",style:{left:`${_.left}px`,top:`${_.top}px`,width:"300px"},"data-test":"element-inspector-tooltip",children:a.jsxs("div",{className:"metadata-section space-y-2","data-test":"element-inspector-metadata-section",children:[a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-tag-row",children:[a.jsx(hc,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"Tag"}),a.jsxs("div",{className:"text-blue-300","data-test":"element-inspector-tag-value",children:["<",u.tagName,">"]})]})]}),u.dataTest&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-data-test-row",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"Data Test"}),a.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-data-test-value",children:u.dataTest})]})]}),!u.dataTest&&u.classes.length>0&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-classes-row",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),a.jsxs("div",{children:[a.jsxs("div",{className:"text-gray-400 text-[10px]",children:["Classes (",u.classes.length,")"]}),a.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-classes-value",children:u.classes.join(" ")})]})]}),u.reactInspectorId&&a.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-file-row",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-400"}),a.jsxs("div",{children:[a.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Name"}),a.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-name",children:Ra(u.resolvedPath||u.reactInspectorId)}),a.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Path"}),a.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-path",children:u.resolvedPath||u.reactInspectorId||"Resolving..."})]})]}),!u.reactInspectorId&&a.jsxs("div",{className:"metadata-row flex items-start gap-2",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-gray-600"}),a.jsx("div",{children:a.jsx("div",{className:"text-gray-500 text-[10px] italic",children:"No data-react-inspector attribute"})})]})]})}),G=vt.canRenderTooltip(c??null);return a.jsx(a.Fragment,{children:d&&u&&G&&(o?o(u):P)})}function ho({node:s,onItemClick:e,level:t=0,defaultExpandedIds:n,selectedId:r,renderLeaf:o}){var g;const[i,c]=h.useState((n==null?void 0:n.has(s.id))??!1),l=s.children&&s.children.length>0,d=r===s.id,p=h.useRef(null);h.useEffect(()=>{d&&p.current&&p.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[d]);const u=x=>{x.stopPropagation(),l&&c(!i)},f=x=>{x.stopPropagation(),e==null||e(s)},m={paddingLeft:`${t*1.5}rem`};return l?a.jsxs(sa,{open:i,onOpenChange:c,children:[a.jsxs("div",{ref:p,className:B("tree-item-parent flex items-center py-2 px-3 rounded-sm transition-colors",d&&"bg-primary/10 border border-primary"),style:m,children:[a.jsx(na,{asChild:!0,children:a.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0 cursor-pointer hover:bg-accent rounded",onClick:u,"data-test":"tree-item-toggle",children:i?a.jsx(ut,{className:"h-4 w-4"}):a.jsx(yt,{className:"h-4 w-4"})})}),a.jsxs("div",{className:"flex items-center flex-1 cursor-pointer hover:text-accent-foreground",onClick:f,"data-test":"tree-item-label",children:[s.icon&&a.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:s.icon}),a.jsx("span",{className:"tree-item-label flex-1",children:s.label})]})]}),a.jsx(ra,{children:a.jsx("div",{className:"tree-item-children",children:(g=s.children)==null?void 0:g.map(x=>a.jsx(ho,{node:x,onItemClick:e,level:t+1,defaultExpandedIds:n,selectedId:r,renderLeaf:o},x.id))})})]}):o?a.jsx("div",{ref:p,style:m,children:o(s,d,()=>e==null?void 0:e(s))}):a.jsxs("div",{ref:p,className:B("tree-item-leaf flex items-center py-2 px-3 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors",d&&"bg-primary/10 border border-primary"),style:m,onClick:f,children:[a.jsx("div",{className:"tree-item-icon w-4 h-4 mr-2 flex-shrink-0"}),s.icon&&a.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:s.icon}),a.jsx("span",{className:"tree-item-label flex-1",children:s.label})]})}function fd({data:s,onItemClick:e,className:t,defaultExpandedIds:n,selectedId:r,renderLeaf:o}){return a.jsx("div",{className:B("tree-root",t),children:s.map(i=>a.jsx(ho,{node:i,onItemClick:e,defaultExpandedIds:n,selectedId:r,renderLeaf:o},i.id))})}const rN=Object.freeze(Object.defineProperty({__proto__:null,Tree:fd,TreeItem:ho},Symbol.toStringTag,{value:"Module"})),Ci={isVisible:!1,position:{x:0,y:0},treeData:[],targetDataTest:""};function A0(s,e){var l;const t=e??document.querySelector(`[data-test="${s}"]`);if(!t)return[];let n=null,r=t.parentElement;for(;r;){const d=(l=r.dataset)==null?void 0:l.test;if(d){n=d;break}r=r.parentElement}const o=[],i=d=>{for(const p of Array.from(d.children)){const u=p.getAttribute("data-test");u?o.push(u):i(p)}};i(t);const c={id:s,label:s,children:o.map(d=>({id:d,label:d}))};return n?[{id:n,label:n,children:[c]}]:[c]}async function P0(s){if(!s)return;const n=s.split(":")[0].split("/").pop();if(n)try{return await ya.getFilePath(n)}catch(r){console.error("Failed to resolve inspector path:",r);return}}function R0({onElementCollected:s,onElementRemoved:e,onElementsCleared:t,renderCollectedItem:n,renderCollectedPanel:r,showDefaultPanel:o=!0,tooltipOwnerId:i,panelOwnerId:c}){const[l,d]=h.useState([]),[p,u]=h.useState(!1),[f,m]=h.useState({x:100,y:100}),g=h.useRef(!1),x=h.useRef({x:0,y:0}),[w,v]=h.useState(Ci);h.useEffect(()=>{if(c)return vt.claimPanel(c),()=>{vt.releasePanel(c)}},[c]);const b=h.useCallback((k,M)=>{(async()=>{const q=await P0(M.reactInspectorId)||M.reactInspectorId,W={id:`${Date.now()}-${Math.random()}`,tagName:M.tagName,classes:M.classes,dataTest:M.dataTest,reactInspectorId:M.reactInspectorId,resolvedPath:q,timestamp:Date.now(),elementRef:k};d(V=>[...V,W]),s==null||s(W,k),Ne.success("Element collected!",{description:`<${M.tagName}>${q?` [${q}]`:""}`,duration:2e3})})()},[s]),y=h.useCallback(()=>{(l.length>0||p)&&u(!0)},[l.length,p]),C=k=>{k.target.closest(".popover-drag-handle")&&(g.current=!0,x.current={x:k.clientX-f.x,y:k.clientY-f.y})},S=h.useCallback(k=>{g.current&&m({x:k.clientX-x.current.x,y:k.clientY-x.current.y})},[]),j=h.useCallback(()=>{g.current=!1},[]);h.useEffect(()=>(p&&(document.addEventListener("mousemove",S),document.addEventListener("mouseup",j)),()=>{document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",j)}),[p,S,j]),h.useEffect(()=>{const k=M=>{M.key==="Escape"&&p&&u(!1)};return p&&document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}},[p]);const N=k=>{d(M=>M.filter(U=>U.id!==k.id)),e==null||e(k),Ne.info("Element removed from collection")},E=()=>{d([]),u(!1),t==null||t(),Ne.info("All collected elements cleared")},R=()=>{u(!1),d([]),t==null||t()},D=(k,M,U)=>{U.stopPropagation();const q=A0(k,M);v({isVisible:!0,position:{x:U.clientX,y:U.clientY},treeData:q,targetDataTest:k})},T=()=>{v(Ci)},L=()=>l.map((k,M)=>{const U=k.dataTest?`[data-test="${k.dataTest}"]`:k.classes.length>0?`.${k.classes[0]}`:"",q=k.resolvedPath||"unknown";return`${M+1}. ${k.tagName}${U} inside @${q}`}).join(`
`),_=(k,M)=>a.jsxs("div",{className:"collected-element p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors","data-test":"element-inspector-collected-item",children:[a.jsxs("div",{className:"element-header flex items-center justify-between mb-2","data-test":"element-inspector-collected-item-header",children:[a.jsxs("div",{className:"element-index text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded","data-test":"element-inspector-collected-item-index",children:["#",M+1]}),a.jsx("button",{onClick:()=>N(k),className:"remove-btn p-1 hover:bg-red-100 rounded transition-colors",title:"Remove element","data-test":"element-inspector-collected-item-remove-button",children:a.jsx(St,{className:"w-4 h-4 text-red-600"})})]}),a.jsxs("div",{className:"element-details space-y-1 text-xs",children:[a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(hc,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-600"}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"Tag:"})," ",a.jsxs("span",{className:"font-mono text-blue-700",children:["<",k.tagName,">"]})]})]}),k.resolvedPath&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Qs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-600"}),a.jsxs("div",{children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"File Name:"})," ",a.jsx("span",{className:"font-mono text-purple-700",children:Ra(k.resolvedPath)}),a.jsx(ss,{textToCopy:Ra(k.resolvedPath),size:"sm"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500",children:"File Path:"})," ",a.jsx("span",{className:"font-mono text-purple-700",children:k.resolvedPath}),a.jsx(ss,{textToCopy:k.resolvedPath,size:"sm"})]})]})]}),k.dataTest&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("span",{className:"text-gray-500",children:"Data Test:"})," ",a.jsx("span",{className:"font-mono text-green-700 cursor-pointer hover:underline hover:text-green-900",onClick:U=>D(k.dataTest,k.elementRef,U),title:"Click to view hierarchy","data-test":"element-inspector-data-test-clickable",children:k.dataTest}),a.jsx(ss,{textToCopy:k.dataTest,size:"sm"})]})]}),!k.dataTest&&k.classes.length>0&&a.jsxs("div",{className:"detail-row flex items-start gap-2",children:[a.jsx(Xs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("span",{className:"text-gray-500",children:["Classes (",k.classes.length,"):"]}),a.jsx("div",{className:"font-mono text-green-700 text-[10px] break-all mt-1",children:k.classes.join(" ")})]})]}),a.jsx("div",{className:"timestamp text-[10px] text-gray-400 mt-2",children:new Date(k.timestamp).toLocaleTimeString()})]})]},k.id),P=a.jsxs("div",{className:"collected-elements-popover fixed bg-white border-2 border-purple-400 rounded-lg shadow-2xl",style:{zIndex:Je.elementInspectorCollected,left:`${f.x}px`,top:`${f.y}px`,width:"550px",maxHeight:"500px"},onMouseDown:C,"data-test":"element-inspector-collected-popover",children:[a.jsxs("div",{className:"popover-drag-handle popover-header bg-purple-500 text-white p-3 rounded-t-lg cursor-move flex items-center justify-between","data-test":"element-inspector-collected-header",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx($p,{className:"w-5 h-5"}),a.jsxs("h3",{className:"font-semibold","data-test":"element-inspector-collected-title",children:["Collected Elements (",l.length,")"]})]}),a.jsxs("div",{className:"flex items-center gap-2","data-test":"element-inspector-collected-actions",children:[a.jsx(ss,{textToCopy:L()}),a.jsx("button",{onClick:R,className:"hover:bg-purple-600 rounded p-1 transition-colors",title:"Close","data-test":"element-inspector-collected-close-button",children:a.jsx(ft,{className:"w-5 h-5"})})]})]}),a.jsxs(Ql,{defaultValue:"list",className:"popover-tabs px-3","data-test":"element-inspector-collected-tabs",children:[a.jsxs(lo,{className:"tabs-list grid w-full grid-cols-2 mt-3","data-test":"element-inspector-collected-tabs-list",children:[a.jsx(an,{value:"list","data-test":"element-inspector-collected-list-tab",children:"List View"}),a.jsx(an,{value:"text","data-test":"element-inspector-collected-text-tab",children:"Text View"})]}),a.jsxs(on,{value:"list",className:"tabs-content m-0","data-test":"element-inspector-collected-list-content",children:[a.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4 space-y-2","data-test":"element-inspector-collected-list",children:l.map((k,M)=>n?n(k,M,()=>_(k,M)):_(k,M))}),a.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-list-footer",children:a.jsxs(de,{onClick:E,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-clear-all-button",children:[a.jsx(St,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]}),a.jsxs(on,{value:"text",className:"tabs-content m-0","data-test":"element-inspector-collected-text-content",children:[a.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4","data-test":"element-inspector-collected-text",children:a.jsx("pre",{className:"text-xs font-mono text-gray-800 whitespace-pre-wrap break-words bg-gray-50 p-3 rounded border border-gray-200","data-test":"element-inspector-collected-text-formatted",children:L()})}),a.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-text-footer",children:a.jsxs(de,{onClick:E,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-text-clear-all-button",children:[a.jsx(St,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]})]})]}),G=vt.canRenderPanel(c??null),$=o&&p&&l.length>0&&G,Y=r?r(l,P):P,A=h.useCallback((k,M)=>k.map(U=>({...U,icon:a.jsx(ss,{textToCopy:U.label,size:"sm"}),label:U.id===M?`â˜… ${U.label}`:U.label,children:U.children?A(U.children,M):void 0})),[]),X=w.treeData.length>0?A(w.treeData,w.targetDataTest):[],I=(k,M,U)=>{const q=k.id===w.targetDataTest;return a.jsxs("div",{className:`flex items-center py-2 px-3 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors ${M?"bg-primary/10 border border-primary":""} ${q?"bg-green-100 border-l-2 border-l-green-500":""}`,onClick:U,"data-test":"element-inspector-tree-leaf",children:[a.jsx("span",{className:`font-mono text-sm flex-1 ${q?"font-bold text-green-700":""}`,children:k.label}),a.jsx(ss,{textToCopy:k.id,size:"sm"})]})};return a.jsxs(a.Fragment,{children:[a.jsx(I0,{tooltipOwnerId:i,onElementClicked:b,onInspectorDeactivated:y}),$&&Oa.createPortal(Y,document.body),a.jsx(Vt,{isVisible:w.isVisible,onClose:T,title:"Data-Test Hierarchy",initialPosition:w.position,shouldCloseManually:!1,initialSize:{width:350,height:300},resizable:!0,zIndex:Je.elementInspectorTree,"data-test":"element-inspector-data-test-tree-popover",children:a.jsx("div",{className:"p-3","data-test":"element-inspector-data-test-tree-content",children:X.length>0?a.jsx(fd,{data:X,defaultExpandedIds:new Set(w.treeData.map(k=>k.id).concat(w.targetDataTest)),selectedId:w.targetDataTest,renderLeaf:I}):a.jsx("div",{className:"text-gray-500 text-sm","data-test":"element-inspector-data-test-tree-empty",children:"No hierarchy found for this data-test value"})})})]})}const D0=({...s})=>{const{theme:e="system"}=wu();return a.jsx(yu,{theme:e,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"!text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...s})};class _0{constructor(e){this.apiClient=e}log(e,t){try{const{customLogFile:n,...r}=t||{};this.apiClient.sendLogs(e,r,n)}catch(n){console.error("[ClientLogsService] Failed to log event:",e,n)}}logCritical(e,t){try{return this.apiClient.sendBeacon(e,t)}catch(n){return console.error("[ClientLogsService] Failed to log critical event:",e,n),!1}}async clearLogs(){try{return await this.apiClient.clearLogs()}catch(e){return console.error("[ClientLogsService] Failed to clear logs:",e),!1}}}class O0{constructor(e){this.client=e}async log(e,t){await this.client.sendLogs(e,t)}logCritical(e,t){return this.client.sendBeacon(e,t)}}class L0{constructor(e={}){ee(this,"_clientLogsApiClient",null);ee(this,"_clientLogsService",null);ee(this,"_logger",null);ee(this,"_config");this._config={clientLogsApiBaseUrl:e.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",clientLogsEnabled:e.clientLogsEnabled!==!1}}get clientLogsApiClient(){return this._clientLogsApiClient||(this._clientLogsApiClient=new za(this._config.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",5e3)),this._clientLogsApiClient}get clientLogsService(){return this._clientLogsService||(this._clientLogsService=new _0(this.clientLogsApiClient)),this._clientLogsService}get logger(){return this._logger||(this._logger=new O0(this.clientLogsApiClient)),this._logger}setConfig(e){this._config={...this._config,...e},this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}setClientLogsApiClient(e){this._clientLogsApiClient=e,this._clientLogsService=null,this._logger=null}reset(){this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}}const $r=new L0;class ye{constructor(e,t,n,r){this.isSuccess=e,this.isFailure=t,this._value=n,this._error=r}get value(){if(!this.isSuccess)throw new Error("Cannot get value from a failure result");return this._value}get error(){if(!this.isFailure)throw new Error("Cannot get error from a success result");return this._error}static success(e){return new ye(!0,!1,e,void 0)}static failure(e){return new ye(!1,!0,void 0,e)}}class Ur extends Error{constructor(e){super(`User not found: ${e}`),this.userId=e,this.name="UserNotFoundError"}}class M0 extends Error{constructor(){super("Username cannot be empty"),this.name="UsernameEmptyError"}}class F0 extends Error{constructor(e){super(`Username must be at least ${e} characters`),this.minLength=e,this.name="UsernameTooShortError"}}class $0 extends Error{constructor(e){super(`Username cannot exceed ${e} characters`),this.maxLength=e,this.name="UsernameTooLongError"}}function wr(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():typeof crypto<"u"&&typeof crypto.getRandomValues=="function"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return(s==="x"?e:e&3|8).toString(16)}):(console.warn("[UUID] Using Math.random() fallback - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}))}class qt{constructor(e,t,n,r,o,i,c){this.id=e,this.username=t,this.profilePicture=n,this.isOnline=r,this.lastSeen=o,this.createdAt=i,this.updatedAt=c,this.validate()}validate(){if(!this.id.trim())throw new Error("User ID cannot be empty");if(!this.username.trim())throw new Error("Username cannot be empty");if(this.username.length<2)throw new Error("Username must be at least 2 characters");if(this.username.length>50)throw new Error("Username cannot exceed 50 characters")}static create(e,t){const n=new Date().toISOString();return new qt(wr(),e.trim(),t,!1,n,n,n)}static fromData(e){return new qt(e.id,e.username,e.profilePicture,e.isOnline,e.lastSeen,e.createdAt,e.updatedAt)}setOnline(e){return new qt(this.id,this.username,this.profilePicture,e,new Date().toISOString(),this.createdAt,new Date().toISOString())}updateProfile(e,t){return new qt(this.id,(e==null?void 0:e.trim())||this.username,t!==void 0?t:this.profilePicture,this.isOnline,this.lastSeen,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,username:this.username,profilePicture:this.profilePicture,isOnline:this.isOnline,lastSeen:this.lastSeen,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class U0{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;console.log("[CreateUserUseCase] Executing with command:",e);try{const n=e.username.trim();if(n.length===0)return console.log("[CreateUserUseCase] Validation failed: Username is empty"),ye.failure(new M0);if(n.length<2)return console.log("[CreateUserUseCase] Validation failed: Username too short"),ye.failure(new F0(2));if(n.length>50)return console.log("[CreateUserUseCase] Validation failed: Username too long"),ye.failure(new $0(50));console.log("[CreateUserUseCase] Validation passed, creating user entity");const r=qt.create(n,e.profilePicture);console.log("[CreateUserUseCase] User entity created:",r),console.log("[CreateUserUseCase] Calling repository.create...");const o=await this.repository.create(r);return console.log("[CreateUserUseCase] User persisted successfully:",o),(t=this.logger)==null||t.log("user_created",{userId:o.id,usernameLength:n.length,hasProfilePicture:!!e.profilePicture}),console.log("[CreateUserUseCase] Returning success result"),ye.success(o)}catch(n){return console.error("[CreateUserUseCase] CAUGHT ERROR:",n),ye.failure(n instanceof Error?n:new Error("Failed to create user"))}}}class Rs{constructor(e,t,n,r,o,i,c,l,d,p){this.id=e,this.gameId=t,this.senderId=n,this.senderUsername=r,this.senderProfilePicture=o,this.text=i,this.timestamp=c,this.createdAt=l,this.isPersona=d,this.isIntroduction=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Message ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.senderId.trim())throw new Error("Sender ID cannot be empty");if(!this.senderUsername.trim())throw new Error("Sender username cannot be empty");if(!this.text.trim())throw new Error("Message text cannot be empty");if(this.text.length>500)throw new Error("Message text cannot exceed 500 characters")}static create(e,t,n,r,o,i,c){const l=new Date().toISOString();return new Rs(wr(),e.trim(),t.trim(),n.trim(),r,o.trim(),l,l,i,c)}static fromData(e){return new Rs(e.id,e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,e.text,e.timestamp,e.createdAt,e.isPersona,e.isIntroduction)}toJSON(){return{id:this.id,gameId:this.gameId,senderId:this.senderId,senderUsername:this.senderUsername,senderProfilePicture:this.senderProfilePicture,text:this.text,timestamp:this.timestamp,createdAt:this.createdAt,isPersona:this.isPersona,isIntroduction:this.isIntroduction}}}class B0{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t,n;try{const r=e.text.trim();if(r.length===0)return ye.failure(new Error("Message text cannot be empty"));if(r.length>500)return ye.failure(new Error("Message text cannot exceed 500 characters"));if(!e.gameId.trim())return ye.failure(new Error("Game ID is required"));if(!e.senderId.trim())return ye.failure(new Error("Sender ID is required"));if(!e.senderUsername.trim())return ye.failure(new Error("Sender username is required"));const o=Rs.create(e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,r),i=await this.repository.create(o);if(i.isFailure)return i;const c=/@(\w+)/g,l=Array.from(r.matchAll(c)).map(p=>p[1]);l.length>0&&!e.isFromPersona&&((t=this.logger)==null||t.log("persona_mentioned",{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,mentionedNames:l,mentionCount:l.length}));const d=e.isFromPersona?"persona_message_sent":"chat_message_sent";return(n=this.logger)==null||n.log(d,{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,messageLength:r.length,isFromPersona:e.isFromPersona||!1,hasMentions:l.length>0}),ye.success(i.value)}catch(r){return ye.failure(r instanceof Error?r:new Error("Failed to send message"))}}}class W0{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;try{if(!e.gameId.trim())return ye.failure(new Error("Game ID is required"));const n=await this.repository.findByGameId(e.gameId);return n.isFailure?n:((t=this.logger)==null||t.log("chat_messages_loaded",{gameId:e.gameId,messageCount:n.value.length}),ye.success(n.value))}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to retrieve messages"))}}}class z0{constructor(e,t,n,r){ee(this,"_createUserUseCase");ee(this,"_sendMessageUseCase");ee(this,"_getMessagesUseCase");this.userRepository=e,this.chatRepository=t,this.webSocketService=n,this.logger=r}async createUser(e){var n;this._createUserUseCase||(this._createUserUseCase=new U0(this.userRepository,this.logger));const t=await this._createUserUseCase.execute(e);if(t.isSuccess){const r=await this.setUserOnline({userId:t.value.id,isOnline:!0});if((n=this.logger)==null||n.log("user_set_online",{userId:t.value.id,isOnline:!0,triggeredBy:"user_creation"}),r.isSuccess)return ye.success(r.value)}return t}async updateUser(e){try{const t=await this.userRepository.getById(e.userId);if(!t)return ye.failure(new Ur(e.userId));const n=t.updateProfile(e.username,e.profilePicture),r=await this.userRepository.update(n);return ye.success(r)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to update user"))}}async setUserOnline(e){var t;try{const n=await this.userRepository.getById(e.userId);if(!n)return ye.failure(new Ur(e.userId));const r=n.setOnline(e.isOnline),o=await this.userRepository.update(r);return(t=this.logger)==null||t.log("user_online_status_changed",{userId:e.userId,username:n.username,previousStatus:n.isOnline,newStatus:e.isOnline}),ye.success(o)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to set user online status"))}}async deleteUser(e){try{return await this.userRepository.delete(e.userId),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to delete user"))}}async getAllUsers(e){try{let t=await this.userRepository.getAll();return e.onlineOnly&&(t=t.filter(n=>n.isOnline)),ye.success(t)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to get users"))}}async getUserById(e){try{const t=await this.userRepository.getById(e.userId);return t?ye.success(t):ye.failure(new Ur(e.userId))}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to get user"))}}async connect(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to connect"))}}async disconnect(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return await this.webSocketService.disconnect(),ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to disconnect"))}}async joinLobby(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to join lobby"))}}async leaveLobby(){if(!this.webSocketService)return ye.failure(new Error("WebSocket service not configured"));try{return ye.success(void 0)}catch(e){return ye.failure(e instanceof Error?e:new Error("Failed to leave lobby"))}}async sendMessage(e){return this._sendMessageUseCase||(this._sendMessageUseCase=new B0(this.chatRepository,this.logger)),this._sendMessageUseCase.execute(e)}async clearMessages(e){var t;try{return await this.chatRepository.deleteByGameId(e.gameId),(t=this.logger)==null||t.log("chat_messages_cleared",{gameId:e.gameId}),ye.success(void 0)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to clear messages"))}}async getMessages(e){return this._getMessagesUseCase||(this._getMessagesUseCase=new W0(this.chatRepository,this.logger)),this._getMessagesUseCase.execute(e)}}class Et{constructor(e,t,n,r,o,i,c,l,d,p){this.id=e,this.name=t,this.gameType=n,this.players=r,this.status=o,this.currentTurn=i,this.winner=c,this.gameData=l,this.createdAt=d,this.updatedAt=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Game ID cannot be empty");if(this.players.length===0)throw new Error("Game must have at least one player")}static create(e,t,n){const r=new Date().toISOString(),o={metadata:{}};return new Et(wr(),n,t,[e],"waiting",void 0,void 0,o,r,r)}static fromData(e){return new Et(e.id,e.name,e.gameType,e.players,e.status,e.currentTurn,e.winner,e.gameData,e.createdAt,e.updatedAt)}addPlayer(e){if(this.players.includes(e))throw new Error("Player already in game");if(this.players.length>=10)throw new Error("Lobby is full");const n=[...this.players,e],r=n.length>=2?"ready":"waiting";return new Et(this.id,this.name,this.gameType,n,r,this.currentTurn,this.winner,this.gameData,this.createdAt,new Date().toISOString())}start(){if(this.status!=="ready")throw new Error("Lobby must be in ready state to start");return new Et(this.id,this.name,this.gameType,this.players,"in_progress",this.players[0],this.winner,this.gameData,this.createdAt,new Date().toISOString())}updateGameData(e,t){return new Et(this.id,this.name,this.gameType,this.players,this.status,t!==void 0?t:this.currentTurn,this.winner,e,this.createdAt,new Date().toISOString())}complete(e){return new Et(this.id,this.name,this.gameType,this.players,"completed",void 0,e,this.gameData,this.createdAt,new Date().toISOString())}abandon(){return new Et(this.id,this.name,this.gameType,this.players,"abandoned",void 0,this.winner,this.gameData,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,name:this.name,gameType:this.gameType,players:this.players,status:this.status,currentTurn:this.currentTurn,winner:this.winner,gameData:this.gameData,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Tt{constructor(e,t,n,r,o,i,c,l){this.id=e,this.gameId=t,this.name=n,this.description=r,this.emoji=o,this.isActive=i,this.createdAt=c,this.updatedAt=l,this.validate()}validate(){if(!this.id.trim())throw new Error("Persona ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.name.trim())throw new Error("Persona name cannot be empty");if(this.name.length<2)throw new Error("Persona name must be at least 2 characters");if(this.name.length>50)throw new Error("Persona name cannot exceed 50 characters");if(!this.description.trim())throw new Error("Persona description cannot be empty");if(this.description.length<5)throw new Error("Persona description must be at least 5 characters");if(this.description.length>500)throw new Error("Persona description cannot exceed 500 characters")}static create(e,t,n,r){const o=new Date().toISOString();return new Tt(wr(),e.trim(),t.trim(),n.trim(),r.trim(),!1,o,o)}static fromData(e){return new Tt(e.id,e.gameId,e.name,e.description,e.emoji,e.isActive,e.createdAt,e.updatedAt)}activate(){return this.isActive?this:new Tt(this.id,this.gameId,this.name,this.description,this.emoji,!0,this.createdAt,new Date().toISOString())}deactivate(){return this.isActive?new Tt(this.id,this.gameId,this.name,this.description,this.emoji,!1,this.createdAt,new Date().toISOString()):this}update(e,t,n){return new Tt(this.id,this.gameId,(e==null?void 0:e.trim())||this.name,(t==null?void 0:t.trim())||this.description,(n==null?void 0:n.trim())||this.emoji,this.isActive,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,gameId:this.gameId,name:this.name,description:this.description,emoji:this.emoji,isActive:this.isActive,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class H0{constructor(e,t=5e3){this.baseUrl=e,this.timeout=t}async createUser(e){const t=`${this.baseUrl}/users`;console.log("[HttpGameService.createUser] Making POST request to:",t),console.log("[HttpGameService.createUser] Request body:",e);try{const n=await this.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("[HttpGameService.createUser] Response received:",n.status);const r=await n.json();return console.log("[HttpGameService.createUser] Response data:",r),{user:qt.fromData(r.user)}}catch(n){throw console.error("[HttpGameService.createUser] ERROR:",n),n}}async getUser(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"GET"})).json();return{user:qt.fromData(n.user)}}async getAllUsers(){return{users:(await(await this.fetchWithTimeout(`${this.baseUrl}/users`,{method:"GET"})).json()).users.map(n=>qt.fromData(n))}}async updateUser(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{user:qt.fromData(r.user)}}async createGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{game:Et.fromData(n.game)}}async getGame(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"GET"})).json();return{game:Et.fromData(n.game)}}async getAllGames(e){const t=new URLSearchParams;e!=null&&e.status&&t.append("status",e.status),e!=null&&e.gameType&&t.append("gameType",e.gameType),e!=null&&e.playerId&&t.append("playerId",e.playerId);const n=`${this.baseUrl}/games${t.toString()?`?${t.toString()}`:""}`;return{games:(await(await this.fetchWithTimeout(n,{method:"GET"})).json()).games.map(i=>Et.fromData(i))}}async joinGame(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{game:Et.fromData(r.game)}}async startGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/start`,{method:"POST"})}async deleteGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"DELETE"})}async createChatMessage(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e.gameId}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderId:e.senderId,senderUsername:e.senderUsername,text:e.text})})).json();return{message:Rs.fromData(n.message)}}async getChatMessages(e){return{messages:(await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"GET"})).json()).messages.map(r=>Rs.fromData(r))}}async clearChatMessages(e){return await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"DELETE"})).json()}async createPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{persona:Tt.fromData(n.persona)}}async getPersonas(e){return{personas:(await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"GET"})).json()).personas.map(r=>Tt.fromData(r))}}async getPersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/detail/${e}`,{method:"GET"})).json();return{persona:Tt.fromData(n.persona)}}async updatePersona(e,t){const r=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{persona:Tt.fromData(r.persona)}}async deletePersona(e){await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"DELETE"})}async activatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/activate`,{method:"POST"})).json();return{persona:Tt.fromData(n.persona)}}async deactivatePersona(e){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/deactivate`,{method:"POST"})).json();return{persona:Tt.fromData(n.persona)}}async fetchWithTimeout(e,t){console.log("[fetchWithTimeout] Starting fetch to:",e),console.log("[fetchWithTimeout] Method:",t.method),console.log("[fetchWithTimeout] Timeout:",this.timeout+"ms");const n=new AbortController,r=setTimeout(()=>n.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:n.signal});if(console.log("[fetchWithTimeout] Response status:",o.status,o.statusText),!o.ok){const i=`HTTP error! status: ${o.status}`;throw console.error("[fetchWithTimeout]",i),new Error(i)}return o}catch(o){if(o instanceof Error&&o.name==="AbortError"){const i=`Request timeout after ${this.timeout}ms`;throw console.error("[fetchWithTimeout]",i),new Error(i)}throw console.error("[fetchWithTimeout] Network error:",o),o}finally{clearTimeout(r)}}}var Nt=(s=>(s.DISCONNECTED="DISCONNECTED",s.CONNECTING="CONNECTING",s.CONNECTED="CONNECTED",s.RECONNECTING="RECONNECTING",s.ERROR="ERROR",s))(Nt||{});class G0{constructor(){ee(this,"ws",null);ee(this,"config",null);ee(this,"connectionState",Nt.DISCONNECTED);ee(this,"messageHandlers",new Set);ee(this,"stateHandlers",new Set);ee(this,"reconnectAttempts",0);ee(this,"reconnectTimeoutId",null);ee(this,"heartbeatIntervalId",null)}async connect(e){return this.config=e,this.reconnectAttempts=0,this.doConnect()}async disconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null),this.ws&&(this.ws.close(),this.ws=null),this.updateConnectionState(Nt.DISCONNECTED)}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");const t={...e,timestamp:new Date().toISOString()};this.ws.send(JSON.stringify(t))}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}onConnectionStateChange(e){return this.stateHandlers.add(e),()=>{this.stateHandlers.delete(e)}}getConnectionState(){return this.connectionState}isConnected(){return this.connectionState===Nt.CONNECTED}async doConnect(){if(!this.config)throw new Error("Config not set");return new Promise((e,t)=>{this.updateConnectionState(this.reconnectAttempts>0?Nt.RECONNECTING:Nt.CONNECTING),this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("[WebSocket] Connected"),this.reconnectAttempts=0,this.updateConnectionState(Nt.CONNECTED),this.startHeartbeat(),e()},this.ws.onmessage=n=>{try{const r=JSON.parse(n.data);this.handleMessage(r)}catch(r){console.error("[WebSocket] Failed to parse message:",r)}},this.ws.onerror=n=>{console.error("[WebSocket] Error:",n),this.updateConnectionState(Nt.ERROR),t(n)},this.ws.onclose=()=>{console.log("[WebSocket] Disconnected"),this.stopHeartbeat(),this.connectionState!==Nt.DISCONNECTED&&this.attemptReconnect()}})}handleMessage(e){e.type!=="pong"&&this.messageHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] Message handler error:",n)}})}attemptReconnect(){if(!this.config)return;const e=this.config.maxReconnectAttempts??10;if(this.reconnectAttempts>=e){console.error(`[WebSocket] Max reconnection attempts (${e}) reached`),this.updateConnectionState(Nt.ERROR);return}this.reconnectAttempts++;const t=this.config.reconnectInterval??3e3;console.log(`[WebSocket] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${e})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.doConnect().catch(n=>{console.error("[WebSocket] Reconnection failed:",n)})},t)}startHeartbeat(){if(!this.config)return;const e=this.config.heartbeatInterval??3e4;this.heartbeatIntervalId=window.setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping"}).catch(t=>{console.error("[WebSocket] Failed to send heartbeat:",t)})},e)}stopHeartbeat(){this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null)}updateConnectionState(e){this.connectionState!==e&&(this.connectionState=e,this.stateHandlers.forEach(t=>{try{t(e)}catch(n){console.error("[WebSocket] State handler error:",n)}}))}}class q0{constructor(e){this.httpService=e}async getAll(e){return(await this.httpService.getAllGames(e)).games}async getById(e){try{return(await this.httpService.getGame(e)).game}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){return(await this.httpService.createGame({gameType:e.gameType||"tic-tac-toe",creatorId:e.players[0]})).game}async update(e){return e}async delete(e){await this.httpService.deleteGame(e)}}class V0{constructor(e){this.httpService=e}async getAll(){return(await this.httpService.getAllUsers()).users}async getById(e){try{return(await this.httpService.getUser(e)).user}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){console.log("[HttpUserRepository.create] Creating user:",{username:e.username,id:e.id});try{const t=await this.httpService.createUser({username:e.username,profilePicture:e.profilePicture});return console.log("[HttpUserRepository.create] User created successfully:",t.user),t.user}catch(t){throw console.error("[HttpUserRepository.create] ERROR:",t),t}}async update(e){return(await this.httpService.updateUser(e.id,{isOnline:e.isOnline,profilePicture:e.profilePicture})).user}async delete(e){console.warn("[HttpUserRepository] Delete not implemented")}}class K0{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createChatMessage({gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,text:e.text});return ye.success(t.message)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to create chat message"))}}async findByGameId(e){try{const t=await this.httpService.getChatMessages(e);return ye.success(t.messages)}catch(t){return t instanceof Error&&t.message.includes("404")?ye.success([]):ye.failure(t instanceof Error?t:new Error("Failed to retrieve chat messages"))}}async deleteByGameId(e){try{return await this.httpService.clearChatMessages(e),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to clear chat messages"))}}}class J0{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createPersona({gameId:e.gameId,name:e.name,description:e.description,emoji:e.emoji});return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to create persona"))}}async findByGameId(e){try{const t=await this.httpService.getPersonas(e);return ye.success(t.personas)}catch(t){return t instanceof Error&&t.message.includes("404")?ye.success([]):ye.failure(t instanceof Error?t:new Error("Failed to retrieve personas"))}}async findById(e){try{const t=await this.httpService.getPersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to retrieve persona"))}}async update(e,t){try{const n=await this.httpService.updatePersona(e,{name:t.name,description:t.description,emoji:t.emoji,isActive:t.isActive});return ye.success(n.persona)}catch(n){return ye.failure(n instanceof Error?n:new Error("Failed to update persona"))}}async delete(e){try{return await this.httpService.deletePersona(e),ye.success(void 0)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to delete persona"))}}async activate(e){try{const t=await this.httpService.activatePersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to activate persona"))}}async deactivate(e){try{const t=await this.httpService.deactivatePersona(e);return ye.success(t.persona)}catch(t){return ye.failure(t instanceof Error?t:new Error("Failed to deactivate persona"))}}}class Y0{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.create(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_created",{personaId:t.value.id,gameId:e.gameId,name:e.name,description:e.description,isActive:t.value.isActive})),t}}class X0{constructor(e){this.personaRepository=e}async execute(e){return await this.personaRepository.findByGameId(e)}}class Q0{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t){var r;const n=await this.personaRepository.update(e,t);return n.isSuccess&&((r=this.logger)==null||r.log("persona_updated",{personaId:e,updates:t,name:n.value.name,gameId:n.value.gameId})),n}}class Z0{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var n;const t=await this.personaRepository.delete(e);return t.isSuccess&&((n=this.logger)==null||n.log("persona_deleted",{personaId:e})),t}}class ej{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t=!0){var r;const n=t?await this.personaRepository.activate(e):await this.personaRepository.deactivate(e);if(n.isSuccess){const o=t?"persona_activated":"persona_deactivated";(r=this.logger)==null||r.log(o,{personaId:e,isActive:t,name:n.value.name,gameId:n.value.gameId})}return n}}const fo="CONNECT_REQUEST",md="CONNECT_SUCCESS",gd="CONNECT_FAILURE",mo="DISCONNECT",xd="CONNECTION_STATE_CHANGED",vd="CREATE_USER_REQUEST",bd="CREATE_USER_SUCCESS",wd="CREATE_USER_FAILURE",yd="UPDATE_USER_REQUEST",Sd="UPDATE_USER_SUCCESS",jd="UPDATE_USER_FAILURE",Cd="FETCH_USERS_REQUEST",Nd="FETCH_USERS_SUCCESS",kd="FETCH_USERS_FAILURE",Ed="SET_USER_ONLINE_REQUEST",Td="SET_USER_ONLINE_SUCCESS",Id="SET_USER_ONLINE_FAILURE",Ad="SET_CURRENT_USER",tj="CREATE_GAME_REQUEST",sj="CREATE_GAME_SUCCESS",nj="CREATE_GAME_FAILURE",rj="JOIN_GAME_REQUEST",aj="JOIN_GAME_SUCCESS",oj="JOIN_GAME_FAILURE",ij="START_GAME_REQUEST",cj="START_GAME_SUCCESS",lj="START_GAME_FAILURE",dj="MAKE_MOVE_REQUEST",uj="MAKE_MOVE_SUCCESS",pj="MAKE_MOVE_FAILURE",hj="LEAVE_GAME_REQUEST",fj="LEAVE_GAME_SUCCESS",mj="LEAVE_GAME_FAILURE",gj="FETCH_GAMES_REQUEST",xj="FETCH_GAMES_SUCCESS",vj="FETCH_GAMES_FAILURE",bj="GAME_UPDATED",wj="GAME_ENDED",Pd="USER_LIST_UPDATED",Rd="SEND_MESSAGE_REQUEST",Dd="SEND_MESSAGE_SUCCESS",_d="SEND_MESSAGE_FAILURE",Od="FETCH_MESSAGES_REQUEST",Ld="FETCH_MESSAGES_SUCCESS",Md="FETCH_MESSAGES_FAILURE",Fd="CLEAR_MESSAGES_REQUEST",$d="CLEAR_MESSAGES_SUCCESS",Ud="CLEAR_MESSAGES_FAILURE",Bd="CHAT_MESSAGE_RECEIVED",Wd="CREATE_PERSONA_REQUEST",zd="CREATE_PERSONA_SUCCESS",Hd="CREATE_PERSONA_FAILURE",Gd="FETCH_PERSONAS_REQUEST",qd="FETCH_PERSONAS_SUCCESS",Vd="FETCH_PERSONAS_FAILURE",Kd="UPDATE_PERSONA_REQUEST",Jd="UPDATE_PERSONA_SUCCESS",Yd="UPDATE_PERSONA_FAILURE",Xd="DELETE_PERSONA_REQUEST",Qd="DELETE_PERSONA_SUCCESS",Zd="DELETE_PERSONA_FAILURE",eu="ACTIVATE_PERSONA_REQUEST",tu="ACTIVATE_PERSONA_SUCCESS",su="ACTIVATE_PERSONA_FAILURE",nu="PERSONA_CREATED",ru="PERSONA_UPDATED",au="PERSONA_DELETED",ou="PERSONA_ACTIVATED",iu="PERSONA_DEACTIVATED",yj="SET_SELECTED_GAME",Sj="CLEAR_ERROR",aN=()=>({type:fo}),jj=()=>({type:md}),Ni=s=>({type:gd,error:s}),Cj=s=>({type:xd,payload:s}),oN=()=>({type:mo}),Nj=s=>({type:Ad,payload:s}),kj=()=>({type:Cd}),Ej=s=>({type:Nd,payload:s}),Tj=s=>({type:kd,error:s}),Ij=s=>({type:Pd,payload:s}),iN=(s,e)=>async t=>{console.log("[createUser] Starting user creation for username:",s),t({type:vd});const n=it.gameApplicationService;console.log("[createUser] Calling application service...");const r=await n.createUser({username:s,profilePicture:e});console.log("[createUser] Result received:",{isSuccess:r.isSuccess,error:r.isSuccess?null:r.error.message}),r.isSuccess?(console.log("[createUser] Success! User created:",r.value),t({type:bd,payload:r.value}),t(Nj(r.value))):(console.error("[createUser] FAILURE! Error:",r.error.message),t({type:wd,error:r.error.message}))},cN=(s,e,t)=>async n=>{n({type:yd});const o=await it.gameApplicationService.updateUser({userId:s,username:e,profilePicture:t});o.isSuccess?n({type:Sd,payload:o.value}):n({type:jd,error:o.error.message})},lN=(s,e)=>async t=>{t({type:Ed});const r=await it.gameApplicationService.setUserOnline({userId:s,isOnline:e});r.isSuccess?t({type:Td,payload:r.value}):t({type:Id,error:r.error.message})},dN=()=>async s=>{s(kj());const t=await it.gameApplicationService.getAllUsers({onlineOnly:!1});t.isSuccess?s(Ej(t.value)):s(Tj(t.error.message))},Aj=s=>({type:Bd,payload:s}),Pj=(s,e,t,n,r,o)=>async i=>{i({type:Rd});const l=await it.gameApplicationService.sendMessage({gameId:s,senderId:e,senderUsername:t,senderProfilePicture:n,text:r,isFromPersona:o});l.isSuccess?i({type:Dd,payload:l.value}):i({type:_d,error:l.error.message})},uN=s=>async e=>{e({type:Od});const n=await it.gameApplicationService.getMessages({gameId:s});n.isSuccess?e({type:Ld,payload:n.value}):e({type:Md,error:n.error.message})},pN=s=>async e=>{e({type:Fd});const n=await it.gameApplicationService.clearMessages({gameId:s});n.isSuccess?e({type:$d,payload:s}):e({type:Ud,error:n.error.message})},Rj={maxContextMessages:10,responseDelay:1e3,maxResponseLength:300};function Dj(s){return`You are ${s.name}, an AI assistant in a multiplayer chat lobby.

Your role and behavior:
${s.description}

Guidelines:
- Stay in character as ${s.name}
- Keep responses concise (under 300 characters)
- Be helpful and engaging
- Respond naturally to the conversation flow
- Don't mention that you're an AI unless directly asked
- Use the persona's personality consistently

Current conversation context will be provided. Respond as ${s.name} would.`}class _j{constructor(e,t,n){ee(this,"isProcessing",!1);ee(this,"config");this.ollamaApi=e,this.store=t,this.config={...Rj,...n}}extractMentions(e){const t=/@(\w+)/g;return Array.from(e.matchAll(t)).map(r=>r[1])}async processMessage(e,t){if(console.log("[PersonaResponseService] ========== PROCESSING MESSAGE =========="),console.log("[PersonaResponseService] Message:",e),console.log("[PersonaResponseService] Game ID:",t),this.isProcessing){console.log("[PersonaResponseService] Already processing, skipping");return}try{this.isProcessing=!0;const n=this.store.getState(),r=n.currentUser;if(console.log("[PersonaResponseService] Current user:",r==null?void 0:r.username),console.log("[PersonaResponseService] Total personas in state:",Object.keys(n.personas.byId).length),this.isPersonaMessage(e,n.personas.byId)){console.log("[PersonaResponseService] Message from persona, skipping");return}const o=this.extractMentions(e.text);if(console.log("[PersonaResponseService] Extracted mentions:",o),o.length===0){console.log("[PersonaResponseService] No @mentions in message, skipping");return}console.log("[PersonaResponseService] âœ… Detected @mentions:",o);const c=(n.personas.byGameId[t]||[]).map(d=>n.personas.byId[d]).filter(d=>d&&d.isActive);if(c.length===0){console.log("[PersonaResponseService] No active personas");return}const l=(n.chatMessages[t]||[]).slice(-this.config.maxContextMessages).map(d=>({sender:d.senderUsername,text:d.text,isPersona:this.isPersonaMessage(d,n.personas.byId)}));for(const d of c)o.some(u=>u.toLowerCase()===d.name.toLowerCase())&&(console.log("[PersonaResponseService] Persona @mentioned, generating AI response:",d.name),await this.generatePersonaResponse(d,l,t,r==null?void 0:r.id))}catch(n){console.error("[PersonaResponseService] Error processing message:",n)}finally{this.isProcessing=!1}}isPersonaMessage(e,t){return Object.values(t).some(n=>n.id===e.senderId)}async generatePersonaResponse(e,t,n,r){var o,i;try{await new Promise(u=>setTimeout(u,this.config.responseDelay));const c=[{role:"system",content:Dj(e)},...t.map(u=>({role:u.isPersona?"assistant":"user",content:`${u.sender}: ${u.text}`}))];console.log("[PersonaResponseService] Generating response for:",e.name);const d=(i=(o=(await this.ollamaApi.chat(c,void 0,{stream:!1})).message)==null?void 0:o.content)==null?void 0:i.trim();if(!d){console.log("[PersonaResponseService] No response generated");return}const p=d.length>this.config.maxResponseLength?d.substring(0,this.config.maxResponseLength-3)+"...":d;console.log("[PersonaResponseService] Generated response:",p),this.store.dispatch(Pj(n,e.id,e.name,void 0,p,!0))}catch(c){console.error("[PersonaResponseService] Error generating response for",e.name,c)}}}const hN=["gpt-oss:latest","gemma3:4b","gemma3:27b","qwen2.5:32b","qwen3:4b","qwen3:30b","qwen3-vl:latest","qwen3-vl:4b","granite3.2-vision","granite4:small-h","deepseek-r1:32b"],cu="gemma3:27b",ki="http://192.168.2.70:11434";class Oj{constructor(e=cu){this.model=e}async generateStructuredCompletion(e,t,n=this.model,r){return((r==null?void 0:r.useEndpoint)??"chat")==="chat"?this.generateStructuredCompletionWithChat(e,t,n,r):this.generateStructuredCompletionWithGenerate(e,t,n,r)}async generateStructuredCompletionWithChat(e,t,n,r){var l;const o=(r==null?void 0:r.system)??"You are a helpful assistant. Always respond in valid JSON format according to the provided schema.",i=await this.chat([{role:"system",content:o},{role:"user",content:e,images:r==null?void 0:r.images}],n,{format:t,stream:!1,signal:r==null?void 0:r.signal});console.log("ðŸ” Raw chat API result:",i);const c=(l=i.message)==null?void 0:l.content;if(console.log("ðŸ” Response type:",typeof c),console.log("ðŸ” Response value:",c),!c)throw console.error("âŒ Empty response from API:",i),new Error("Received empty response from Ollama API");if(typeof c=="string"){if(c.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(c)}catch(d){throw console.error("âŒ JSON parse error. Response was:",c),new Error(`Failed to parse JSON response: ${d instanceof Error?d.message:"Unknown error"}`)}}return c}async generateStructuredCompletionWithGenerate(e,t,n,r){const o=await this.generateCompletion(e,n,{...r,format:t});if(console.log("ðŸ” Raw generate API result:",o),console.log("ðŸ” Response type:",typeof o.response),console.log("ðŸ” Response value:",o.response),!o.response)throw console.error("âŒ Empty response from API:",o),new Error("Received empty response from Ollama API");if(typeof o.response=="string"){if(o.response.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(o.response)}catch(i){throw console.error("âŒ JSON parse error. Response was:",o.response),new Error(`Failed to parse JSON response: ${i instanceof Error?i.message:"Unknown error"}`)}}return o.response}async generateCompletion(e,t=this.model,n){var v;const{suffix:r,images:o,format:i,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f,onStreamChunk:m,signal:g}=n??{stream:!1},x=`${ki}/api/generate`,w=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:e,suffix:r,images:o,format:i,options:n==null?void 0:n.options,system:c,template:l,stream:d,raw:p,keep_alive:u,context:f}),signal:g});if(!w.ok)throw new Error(`HTTP error! status: ${w.status}`);if(d&&w.headers.get("Content-Type")==="application/x-ndjson"){const b=(v=w.body)==null?void 0:v.getReader(),y=new TextDecoder("utf-8");let C="",S="";for(;;){const{done:j,value:N}=await(b==null?void 0:b.read())??{};if(j)break;C+=y.decode(N,{stream:!0});const E=C.split(`
`);C=E.pop();for(const R of E)if(R.trim()){const D=JSON.parse(R);D.response&&(S+=D.response,m==null||m(D.response)),console.log(D)}}return{response:S}}else{const b=await w.json();return console.log("ðŸ“¥ Non-streaming API response:",b),b}}async chat(e,t=this.model,n){var u,f;const{stream:r,format:o,keep_alive:i,onStreamChunk:c,signal:l}=n??{},d=`${ki}/api/chat`,p=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,format:o,stream:r,keep_alive:i}),signal:l});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);if(r&&p.headers.get("Content-Type")==="application/x-ndjson"){const m=(u=p.body)==null?void 0:u.getReader(),g=new TextDecoder("utf-8");let x="",w="";for(;;){const{done:v,value:b}=await(m==null?void 0:m.read())??{};if(v)break;x+=g.decode(b,{stream:!0});const y=x.split(`
`);x=y.pop();for(const C of y)if(C.trim()){const S=JSON.parse(C);(f=S.message)!=null&&f.content&&(w+=S.message.content,c==null||c(S.message.content)),console.log(S)}}return{message:{role:"assistant",content:w}}}else return await p.json()}}const Lj=new Oj(cu),Da="game_current_user";function Mj(){try{const s=localStorage.getItem(Da);return s?JSON.parse(s):null}catch(s){return console.error("[gameReducer] Failed to load currentUser from localStorage:",s),null}}function Bs(s){try{s?localStorage.setItem(Da,JSON.stringify(s)):localStorage.removeItem(Da)}catch(e){console.error("[gameReducer] Failed to save currentUser to localStorage:",e)}}const Fj={connectionState:"DISCONNECTED",isConnected:!1,currentUser:Mj(),users:[],usersLoading:!1,usersError:null,games:[],gamesLoading:!1,gamesError:null,selectedGameId:null,chatMessages:{},chatLoading:!1,chatError:null,personas:{byId:{},byGameId:{},loading:!1,error:null},loading:!1,error:null};function Ei(s=Fj,e){var t,n,r,o,i;switch(e.type){case fo:return{...s,loading:!0,error:null};case md:return{...s,loading:!1,isConnected:!0,error:null};case gd:return{...s,loading:!1,isConnected:!1,error:e.error};case mo:return{...s,isConnected:!1,connectionState:"DISCONNECTED"};case xd:return{...s,connectionState:e.payload,isConnected:e.payload==="CONNECTED"};case Ad:{const c={...s,currentUser:e.payload};return Bs(e.payload),c}case vd:return{...s,usersLoading:!0,usersError:null};case bd:{const c={...s,usersLoading:!1,currentUser:e.payload,users:[...s.users,e.payload],usersError:null};return Bs(e.payload),c}case wd:return{...s,usersLoading:!1,usersError:e.error};case yd:return{...s,usersLoading:!0,usersError:null};case Sd:{const c=((t=s.currentUser)==null?void 0:t.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((n=s.currentUser)==null?void 0:n.id)===e.payload.id&&Bs(e.payload),l}case jd:return{...s,usersLoading:!1,usersError:e.error};case Cd:return{...s,usersLoading:!0,usersError:null};case Nd:{const c=e.payload,l=s.currentUser?c.find(p=>p.id===s.currentUser.id):null,d=l?s.currentUser:null;return!l&&s.currentUser&&(console.warn("[gameReducer] Current user not found in backend, clearing localStorage"),Bs(null)),{...s,usersLoading:!1,currentUser:d,users:c,usersError:null}}case kd:return{...s,usersLoading:!1,usersError:e.error};case Ed:return{...s,usersLoading:!0,usersError:null};case Td:{const c=((r=s.currentUser)==null?void 0:r.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(d=>d.id===e.payload.id?e.payload:d),usersError:null};return((o=s.currentUser)==null?void 0:o.id)===e.payload.id&&Bs(e.payload),l}case Id:return{...s,usersLoading:!1,usersError:e.error};case Pd:return{...s,users:e.payload};case tj:return{...s,gamesLoading:!0,gamesError:null};case sj:return{...s,gamesLoading:!1,games:[...s.games,e.payload],gamesError:null};case nj:return{...s,gamesLoading:!1,gamesError:e.error};case rj:return{...s,gamesLoading:!0,gamesError:null};case aj:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case oj:return{...s,gamesLoading:!1,gamesError:e.error};case ij:return{...s,gamesLoading:!0,gamesError:null};case cj:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case lj:return{...s,gamesLoading:!1,gamesError:e.error};case dj:return{...s,gamesLoading:!0,gamesError:null};case uj:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case pj:return{...s,gamesLoading:!1,gamesError:e.error};case hj:return{...s,gamesLoading:!0,gamesError:null};case fj:return{...s,gamesLoading:!1,games:s.games.filter(c=>c.id!==e.payload),gamesError:null};case mj:return{...s,gamesLoading:!1,gamesError:e.error};case gj:return{...s,gamesLoading:!0,gamesError:null};case xj:return{...s,gamesLoading:!1,games:e.payload,gamesError:null};case vj:return{...s,gamesLoading:!1,gamesError:e.error};case bj:return{...s,games:s.games.map(c=>c.id===e.payload.id?e.payload:c)};case wj:return{...s,games:s.games.filter(c=>c.id!==e.payload)};case Rd:return{...s,chatLoading:!0,chatError:null};case Dd:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]},chatError:null}}case _d:return{...s,chatLoading:!1,chatError:e.error};case Od:return{...s,chatLoading:!0,chatError:null};case Ld:{if(e.payload.length===0)return{...s,chatLoading:!1,chatError:null};const c=e.payload[0].gameId;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:e.payload},chatError:null}}case Md:return{...s,chatLoading:!1,chatError:e.error};case Fd:return{...s,chatLoading:!0,chatError:null};case $d:{const c=e.payload;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:[]},chatError:null}}case Ud:return{...s,chatLoading:!1,chatError:e.error};case Bd:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return l.find(d=>d.id===c.id)?s:{...s,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]}}}case Wd:case Gd:case Kd:case Xd:case eu:return{...s,personas:{...s.personas,loading:!0,error:null}};case zd:case nu:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},byGameId:{...s.personas.byGameId,[c.gameId]:[...s.personas.byGameId[c.gameId]||[],c.id]},loading:!1}}}case qd:{const{personas:c}=e.payload,l={},d={};return c.forEach(p=>{l[p.id]=p,d[p.gameId]||(d[p.gameId]=[]),d[p.gameId].push(p.id)}),{...s,personas:{...s.personas,byId:{...s.personas.byId,...l},byGameId:{...s.personas.byGameId,...d},loading:!1}}}case Jd:case ru:case tu:case ou:case iu:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},loading:!1}}}case Qd:case au:{const c="id"in e.payload?e.payload.id:e.payload.personaId,l=s.personas.byId[c];if(!l)return s;const{[c]:d,...p}=s.personas.byId,u=((i=s.personas.byGameId[l.gameId])==null?void 0:i.filter(f=>f!==c))||[];return{...s,personas:{...s.personas,byId:p,byGameId:{...s.personas.byGameId,[l.gameId]:u},loading:!1}}}case Hd:case Vd:case Yd:case Zd:case su:return{...s,personas:{...s.personas,loading:!1,error:e.payload.error}};case yj:return{...s,selectedGameId:e.payload};case Sj:return{...s,error:null,gamesError:null,usersError:null};default:return s}}const $j=()=>({type:Wd}),Uj=s=>({type:zd,payload:{persona:s}}),Bj=s=>({type:Hd,payload:{error:s}}),Wj=()=>({type:Gd}),zj=s=>({type:qd,payload:{personas:s}}),Hj=s=>({type:Vd,payload:{error:s}}),Gj=()=>({type:Kd}),qj=s=>({type:Jd,payload:{persona:s}}),Vj=s=>({type:Yd,payload:{error:s}}),Kj=()=>({type:Xd}),Jj=s=>({type:Qd,payload:{id:s}}),Yj=s=>({type:Zd,payload:{error:s}}),lu=()=>({type:eu}),du=s=>({type:tu,payload:{persona:s}}),uu=s=>({type:su,payload:{error:s}}),Xj=s=>({type:nu,payload:{persona:s}}),Qj=s=>({type:ru,payload:{persona:s}}),Zj=s=>({type:au,payload:{personaId:s}}),eC=s=>({type:ou,payload:{persona:s}}),tC=s=>({type:iu,payload:{persona:s}}),fN=(s,e,t,n)=>async r=>{r($j());const o=await it.personaUseCases.createPersona.execute({gameId:s,name:e,description:t,emoji:n});o.isSuccess?r(Uj(o.value.toJSON())):r(Bj(o.error.message))},mN=s=>async e=>{e(Wj());const t=await it.personaUseCases.getPersonas.execute(s);t.isSuccess?e(zj(t.value.map(n=>n.toJSON()))):e(Hj(t.error.message))},gN=(s,e)=>async t=>{t(Gj());const n=await it.personaUseCases.updatePersona.execute(s,e);n.isSuccess?t(qj(n.value.toJSON())):t(Vj(n.error.message))},xN=s=>async e=>{e(Kj());const t=await it.personaUseCases.deletePersona.execute(s);t.isSuccess?e(Jj(s)):e(Yj(t.error.message))},vN=s=>async e=>{e(lu());const t=await it.personaUseCases.activatePersona.execute(s,!0);t.isSuccess?e(du(t.value.toJSON())):e(uu(t.error.message))},bN=s=>async e=>{e(lu());const t=await it.personaUseCases.activatePersona.execute(s,!1);t.isSuccess?e(du(t.value.toJSON())):e(uu(t.error.message))},sC=s=>{let e=!1;return t=>n=>{const r=t(n);if(n.type===fo){if(e)return console.log("[WebSocket Middleware] Connection already initialized"),r;e=!0;const o=it.webSocketService,i=it.webSocketConfig;o.onMessage(c=>{switch(console.log("[WebSocket Middleware] Received message:",c.type),c.type){case"chat_message":{const d=c.message;d.isIntroduction&&d.isPersona?console.log(`[WebSocket Middleware] ðŸŽ­ Persona introduction received from ${d.senderUsername}:`,d.text):d.isPersona?console.log(`[WebSocket Middleware] ðŸ¤– Persona message received from ${d.senderUsername}:`,d.text):console.log("[WebSocket Middleware] Chat message received:",d),s.dispatch(Aj(d));break}case"user_list":{const d=c.users;console.log("[WebSocket Middleware] User list updated:",d.length,"users"),s.dispatch(Ij(d));break}case"game_update":{const d=c.game;console.log("[WebSocket Middleware] Game update received:",d.id);break}case"PERSONA_CREATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona created:",d.id),s.dispatch(Xj(d));break}case"PERSONA_UPDATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona updated:",d.id),s.dispatch(Qj(d));break}case"PERSONA_DELETED":{const d=c.personaId;console.log("[WebSocket Middleware] Persona deleted:",d),s.dispatch(Zj(d));break}case"PERSONA_ACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona activated:",d.id),s.dispatch(eC(d));break}case"PERSONA_DEACTIVATED":{const d=c.persona;console.log("[WebSocket Middleware] Persona deactivated:",d.id),s.dispatch(tC(d));break}case"error":{const d=c.message;console.error("[WebSocket Middleware] Error from server:",d);break}}}),o.onConnectionStateChange(c=>{if(s.dispatch(Cj(c)),c===Nt.CONNECTED){s.dispatch(jj());const d=s.getState().currentUser;d?(console.log(`[WebSocket Middleware] Sending JOIN message for user ${d.username} (${d.id})`),o.send({type:"join",userId:d.id,username:d.username}).catch(p=>{console.error("[WebSocket Middleware] Failed to send JOIN message:",p)})):console.warn("[WebSocket Middleware] No currentUser available to send JOIN message")}else c===Nt.ERROR&&s.dispatch(Ni("WebSocket connection failed"))}),o.connect(i).then(()=>{console.log("[WebSocket Middleware] Successfully connected")}).catch(c=>{console.error("[WebSocket Middleware] Connection error:",c),s.dispatch(Ni(c instanceof Error?c.message:"Unknown connection error")),e=!1})}return n.type===mo&&it.webSocketService.disconnect().then(()=>{console.log("[WebSocket Middleware] Disconnected"),e=!1}).catch(i=>{console.error("[WebSocket Middleware] Disconnect error:",i),e=!1}),r}},nC=s=>e=>t=>e(t),rC=s=>e=>t=>typeof t=="function"?t(s.dispatch,s.getState):e(t);function aC(s=!0){let e=Ei(void 0,{type:"@@INIT"});const t=new Set,n={getState(){return e},dispatch(r){let o=i=>(e=Ei(e,i),t.forEach(c=>c()),i);return o=sC(n)(o),o=rC(n)(o),s&&(o=nC()(o)),o(r)},subscribe(r){return t.add(r),()=>{t.delete(r)}}};return n}class oC{constructor(){ee(this,"_httpService",null);ee(this,"_webSocketService",null);ee(this,"_gameRepository",null);ee(this,"_userRepository",null);ee(this,"_chatRepository",null);ee(this,"_personaRepository",null);ee(this,"_store",null);ee(this,"_gameApplicationService",null);ee(this,"_config",null);ee(this,"_personaUseCases",null);ee(this,"_personaResponseService",null);ee(this,"_logger",null)}get config(){if(!this._config){const e=()=>`http://${window.location.hostname}:3030/api/multiplayer`,t=()=>`ws://${window.location.hostname}:3030/multiplayer`;this._config={httpApiBaseUrl:e(),webSocketUrl:t(),enableLogging:!0,webSocketReconnectInterval:parseInt("3000",10),webSocketMaxReconnectAttempts:parseInt("10",10),webSocketHeartbeatInterval:parseInt("30000",10),clientLogsEnabled:!0,clientLogsApiBaseUrl:"http://localhost:3030/client-logs"}}return this._config}get httpService(){return this._httpService||(this._httpService=new H0(this.config.httpApiBaseUrl,5e3)),this._httpService}get webSocketService(){return this._webSocketService||(this._webSocketService=new G0),this._webSocketService}get gameRepository(){return this._gameRepository||(this._gameRepository=new q0(this.httpService)),this._gameRepository}get userRepository(){return this._userRepository||(this._userRepository=new V0(this.httpService)),this._userRepository}get chatRepository(){return this._chatRepository||(this._chatRepository=new K0(this.httpService)),this._chatRepository}get personaRepository(){return this._personaRepository||(this._personaRepository=new J0(this.httpService)),this._personaRepository}get personaUseCases(){if(!this._personaUseCases){const e=this.personaRepository,t=this.logger;this._personaUseCases={createPersona:new Y0(e,t),getPersonas:new X0(e),updatePersona:new Q0(e,t),deletePersona:new Z0(e,t),activatePersona:new ej(e,t)}}return this._personaUseCases}get clientLogsApiClient(){return $r.clientLogsApiClient}get clientLogsService(){return $r.clientLogsService}get logger(){return $r.logger}get gameApplicationService(){return this._gameApplicationService||(this._gameApplicationService=new z0(this.userRepository,this.chatRepository,this.webSocketService,this.logger)),this._gameApplicationService}get store(){return this._store||(this._store=aC(this.config.enableLogging)),this._store}get personaResponseService(){return this._personaResponseService||(this._personaResponseService=new _j(Lj,this.store)),this._personaResponseService}get webSocketConfig(){return{url:this.config.webSocketUrl,reconnectInterval:this.config.webSocketReconnectInterval,maxReconnectAttempts:this.config.webSocketMaxReconnectAttempts,heartbeatInterval:this.config.webSocketHeartbeatInterval}}reset(){this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._personaResponseService=null,this._store=null,this._gameApplicationService=null,this._config=null}setHttpService(e){this._httpService=e,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._gameApplicationService=null}setWebSocketService(e){this._webSocketService=e,this._gameApplicationService=null}setGameRepository(e){this._gameRepository=e,this._gameApplicationService=null}setUserRepository(e){this._userRepository=e,this._gameApplicationService=null}setGameApplicationService(e){this._gameApplicationService=e}setLogger(e){this._logger=e,this._gameApplicationService=null}setConfig(e){this._config={...this.config,...e},this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._gameApplicationService=null,this._store=null}}const it=new oC;function iC({navigate:s}){return[{id:"nav-home",label:"Go to Home",shortcut:"Ctrl+H",action:()=>s("/"),group:"Navigation"},{id:"nav-chat",label:"Go to Chat",action:()=>s("/chat"),group:"Navigation"},{id:"nav-demo",label:"Go to Demo",action:()=>s("/demo"),group:"Navigation"},{id:"nav-settings",label:"Go to Settings",action:()=>s("/settings"),group:"Navigation"},{id:"nav-todo",label:"Go to Todo",action:()=>s("/todo"),group:"Navigation"},{id:"nav-kanban",label:"Go to Kanban Board",action:()=>s("/todo/kanban"),group:"Navigation"},{id:"nav-content",label:"Go to Content",action:()=>s("/content"),group:"Navigation"},{id:"nav-vocabulary",label:"Go to Vocabulary",action:()=>s("/vocabulary"),group:"Navigation"},{id:"nav-live-transcription",label:"Go to Live Transcription",action:()=>s("/live-transcription"),group:"Navigation"},{id:"nav-claude",label:"Go to Claude",action:()=>s("/claude"),group:"Navigation"},{id:"nav-state",label:"Go to Global State",action:()=>s("/state"),group:"Navigation"},{id:"toggle-element-inspector",label:"Toggle Element Inspector",shortcut:"Ctrl+Shift+I",action:()=>{vt.toggle();const e=vt.getState();Ne.success(`Element Inspector ${e?"activated":"deactivated"}`,{description:e?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})},group:"Tools"},{id:"toggle-fullscreen",label:"Toggle Fullscreen",shortcut:"F11",action:()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{Ne.success("Fullscreen mode deactivated",{duration:2e3})}).catch(e=>{Ne.error("Failed to exit fullscreen",{description:e.message,duration:3e3})}):document.documentElement.requestFullscreen().then(()=>{Ne.success("Fullscreen mode activated",{description:"Press F11 or ESC to exit fullscreen",duration:2e3})}).catch(e=>{Ne.error("Failed to enter fullscreen",{description:e.message,duration:3e3})})},group:"Tools"}]}function cC(){const{logs:s,actions:e}=fc(),t=_a(),n=Ti(),[r,o]=h.useState(null);Xp({loadOnMount:!0,subscribeToSSE:!0}),sh({loadOnMount:!0}),nh(),h.useEffect(()=>{localStorage.getItem("VITE_CLEAR_LOGS_ON_RELOAD"),it.clientLogsService.clearLogs()},[t.pathname]);const i=iC({navigate:n});return h.useEffect(()=>{(async()=>{})()},[]),h.useEffect(()=>{const c=ks.register({key:"c",callback:()=>{console.clear(),Ne.success("Console cleared",{duration:1500})}});return()=>c()},[]),h.useEffect(()=>{document.title=Kh(t.pathname)},[t.pathname]),a.jsxs(jc,{defaultOpen:!1,children:[a.jsx(w0,{actions:i}),a.jsx(k0,{}),a.jsx(R0,{}),a.jsx(D0,{}),a.jsx(Qh,{}),a.jsx(Nc,{className:"h-screen overflow-hidden",children:a.jsxs("div",{className:"h-full bg-background flex flex-col",children:[t.pathname!=="/stt"&&a.jsx(g0,{version:r}),a.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:a.jsx(Jh,{logger:e,logs:s})})]})})]})}gu.createRoot(document.getElementById("root")).render(a.jsx(ef,{defaultTheme:"light",storageKey:"watcher-ui-theme",children:a.jsx(xu,{children:a.jsx(cC,{})})}));export{jc as $,Um as A,ht as B,pn as C,qa as D,ns as E,Wl as F,VC as G,Ev as H,We as I,Ke as J,Ue as K,je as L,$S as M,Mt as N,$l as O,OS as P,sa as Q,ra as R,Ut as S,Xl as T,Fe as U,B as V,zy as W,Gy as X,eN as Y,mt as Z,tN as _,de as a,Is as a$,Cc as a0,kc as a1,Ec as a2,bh as a3,wh as a4,Sh as a5,Tc as a6,Ws as a7,zs as a8,Nc as a9,st as aA,pt as aB,Qe as aC,Wa as aD,Fc as aE,vt as aF,I0 as aG,R0 as aH,T0 as aI,Sa as aJ,Ge as aK,rn as aL,Zr as aM,jC as aN,ya as aO,hN as aP,Lj as aQ,Hc as aR,TC as aS,ot as aT,Yg as aU,Xg as aV,Vn as aW,BS as aX,fd as aY,jS as aZ,Ts as a_,ea as aa,Je as ab,Vt as ac,nm as ad,rm as ae,Gc as af,qc as ag,xs as ah,$e as ai,kt as aj,za as ak,_t as al,gc as am,Wn as an,Wo as ao,Yc as ap,Jc as aq,fr as ar,Yl as as,Na as at,Xe as au,Gt as av,nn as aw,Re as ax,na as ay,di as az,Ha as b,Pa as b$,hs as b0,ud as b1,Ea as b2,ad as b3,od as b4,Gl as b5,Oj as b6,lh as b7,gC as b8,oh as b9,pN as bA,fN as bB,mN as bC,gN as bD,xN as bE,vN as bF,bN as bG,pr as bH,dn as bI,un as bJ,As as bK,rs as bL,xf as bM,hd as bN,ia as bO,e0 as bP,f0 as bQ,Jt as bR,Qt as bS,QS as bT,Fn as bU,wC as bV,$n as bW,Un as bX,Zs as bY,Pc as bZ,hf as b_,vc as ba,ks as bb,Eo as bc,Es as bd,nN as be,HC as bf,Sg as bg,yg as bh,im as bi,si as bj,ti as bk,br as bl,ts as bm,Si as bn,gi as bo,sf as bp,it as bq,dN as br,iN as bs,cN as bt,lN as bu,Nj as bv,aN as bw,oN as bx,Pj as by,uN as bz,Ga as c,LC as c$,Gs as c0,_n as c1,sN as c2,um as c3,Hl as c4,dt as c5,c0 as c6,lv as c7,x0 as c8,tr as c9,zC as cA,KC as cB,BC as cC,yw as cD,Sn as cE,yy as cF,CC as cG,NC as cH,Bm as cI,yC as cJ,Pf as cK,VS as cL,pd as cM,UC as cN,bC as cO,WC as cP,nl as cQ,se as cR,SC as cS,am as cT,om as cU,lm as cV,dm as cW,kC as cX,EC as cY,GC as cZ,qC as c_,$r as ca,Gg as cb,Tn as cc,sl as cd,Bl as ce,RC as cf,cb as cg,Ka as ch,kg as ci,AC as cj,PC as ck,DC as cl,Xv as cm,IC as cn,vl as co,cs as cp,Vg as cq,Hm as cr,Jg as cs,An as ct,Rn as cu,Pn as cv,gs as cw,ei as cx,mC as cy,us as cz,tm as d,tf as d0,OC as d1,MC as d2,_C as d3,$C as d4,ZC as d5,YC as d6,QC as d7,io as d8,XC as d9,Nb as da,S0 as db,N0 as dc,Mc as dd,C0 as de,ca as df,ml as dg,FC as dh,bc as di,wc as dj,xC as dk,vC as dl,JC as dm,rN as dn,hn as e,wt as f,ur as g,It as h,Kt as i,At as j,Oe as k,Ot as l,Ql as m,lo as n,an as o,on as p,tl as q,qS as r,MS as s,uo as t,Xp as u,kr as v,Ve as w,tt as x,le as y,Le as z};
