var S=Object.defineProperty;var E=(n,t,e)=>t in n?S(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var u=(n,t,e)=>E(n,typeof t!="symbol"?t+"":t,e);function H(n){const t=n.getBoundingClientRect();return{width:t.width,height:t.height}}function x(n){const t=n.getBoundingClientRect();return{x:t.left,y:t.top}}function Z(n,t){return n.x>=t.left&&n.x<=t.right&&n.y>=t.top&&n.y<=t.bottom}function A(n,t){return{x:Math.round(n.x/t.x)*t.x,y:Math.round(n.y/t.y)*t.y}}function k(n,t,e){const i={...n};let s=e,o=e;return t.forEach(l=>{const c=x(l),a=H(l),g=[c.x,c.x+a.width],r=[c.y,c.y+a.height];g.forEach(h=>{const m=Math.abs(n.x-h);m<s&&(s=m,i.x=h)}),r.forEach(h=>{const m=Math.abs(n.y-h);m<o&&(o=m,i.y=h)})}),i}function C(n,t,e=[]){if(!t.enabled)return n;let i={...n};return t.snapToGrid&&(i=A(i,t.snapToGrid)),t.snapToElements&&e.length>0&&(i=k(i,e,t.threshold)),i}let d=null,f=null,y=null,D=null;const P=30;function I(n,t){var g;const e=t.filter(r=>Z(n,r.rect));if(e.length===0)return d=null,f=null,null;if(d&&f&&e.length>0){const r=((g=t.find(p=>p.zone.id===(d==null?void 0:d.id)))==null?void 0:g.depth)??-1,h=e.some(p=>p.zone.id===(d==null?void 0:d.id)),m=Math.max(...e.map(p=>p.depth));if(!h&&r>=m){y||(y=f);const p=Math.abs(n.x-y.x),w=Math.abs(n.y-f.y);if(p<P&&w>0)return d;y=null}else y=null}if(e.length===1){if(e[0].depth===0&&d&&f){const r=Math.abs(n.x-f.x),h=Math.abs(n.y-f.y),m=d.id==="root";if(r<P&&h>0&&!m)return d}return d=e[0].zone,f=n,e[0].zone}let i=e[0],s=i.depth,o=i.rect.width*i.rect.height;for(const r of e){const h=r.rect.width*r.rect.height;(r.depth>s||r.depth===s&&h<o)&&(s=r.depth,o=h,i=r)}const c=(D?Math.abs(n.x-D.x):0)>=P;if(d&&f&&i.zone.id!==d.id){const r=e.find(h=>h.zone.id===d.id);if(r&&i.depth!==r.depth&&!c)return d}const a=typeof document<"u"?document.elementFromPoint(n.x,n.y):null;if(a){let r=a,h=null;for(;r&&!h;)h=r.getAttribute("data-drag-handle"),h||(r=r.parentElement);if(h&&r){const m=r.getBoundingClientRect(),p=m.top+m.height/2;if(n.y>=p){const T=t.find(b=>b.zone.id===h&&b.depth>i.depth);T&&T.depth>i.depth&&(D?Math.abs(n.x-D.x):0)>=P&&(i=T)}}}return(!d||d.id!==i.zone.id)&&(D=n),d=i.zone,f=n,i.zone}function M(n,t,e,i,s){if(e.length===0)return 0;const o=i==="vertical",l=[...e].sort((a,g)=>{const r=a.element.getBoundingClientRect(),h=g.element.getBoundingClientRect();return o?r.top-h.top:r.left-h.left}),c=l.filter(a=>a.id!==s.id);if(c.length===0)return 0;for(let a=0;a<c.length;a++){const g=c[a],r=g.element.getBoundingClientRect(),h=o?r.top+r.height/2:r.left+r.width/2;if((o?n.y:n.x)<h)return l.indexOf(g)}return l.length}function v(n){return"touches"in n&&n.touches.length>0?{x:n.touches[0].clientX,y:n.touches[0].clientY}:"clientX"in n?{x:n.clientX,y:n.clientY}:{x:0,y:0}}const L={snap:{enabled:!1,threshold:10},sort:{enabled:!1,orientation:"vertical",threshold:.5},dragThreshold:5,autoScroll:{enabled:!1,speed:10,margin:50}};class _{constructor(t,e){u(this,"draggables",new Map);u(this,"dropZones",new Map);u(this,"config");u(this,"callbacks");u(this,"state");u(this,"animationFrameId",null);u(this,"scrollInterval",null);u(this,"dragPreview",null);u(this,"lastMoveTimestamp",0);u(this,"cachedZoneGeometry",[]);u(this,"lastTouchTime",0);u(this,"pendingTouchStart",null);u(this,"pendingMouseStart",null);u(this,"touchHoldTimer",null);u(this,"touchHoldActivated",!1);u(this,"holdProgressAnimationFrame",null);u(this,"holdStartTime",0);u(this,"holdIndicatorDelayTimer",null);this.config={...L,...t},this.callbacks=e||{},this.state=this.getInitialState(),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this)}getInitialState(){return{isDragging:!1,item:null,startPosition:{x:0,y:0},currentPosition:{x:0,y:0},offset:{x:0,y:0},currentDropZone:null,potentialDropZone:null,sortIndex:null}}registerDraggable(t,e,i){const s={id:t,element:e,data:i};this.draggables.set(t,s),e.style.setProperty("user-select","none","important"),e.style.setProperty("-webkit-user-select","none","important"),e.style.setProperty("-moz-user-select","none","important"),e.style.setProperty("-ms-user-select","none","important"),e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.setProperty("touch-action","manipulation","important"),e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),e.__dndItem=s}unregisterDraggable(t){const e=this.draggables.get(t);e&&(e.element.style.removeProperty("user-select"),e.element.style.removeProperty("-webkit-user-select"),e.element.style.removeProperty("-moz-user-select"),e.element.style.removeProperty("-ms-user-select"),e.element.style.removeProperty("touch-action"),e.element.style.userSelect="",e.element.style.webkitUserSelect="",e.element.removeEventListener("mousedown",this.handleMouseDown),e.element.removeEventListener("touchstart",this.handleTouchStart),delete e.element.__dndItem,this.draggables.delete(t))}registerDropZone(t,e,i,s){const o={id:t,element:e,accepts:i,data:s};this.dropZones.set(t,o),e.__dndZone=o}unregisterDropZone(t){const e=this.dropZones.get(t);e&&(delete e.element.__dndZone,this.dropZones.delete(t))}handleMouseDown(t){if(Date.now()-this.lastTouchTime<500)return;const e=t.currentTarget.__dndItem;if(!e)return;const s=t.target.tagName.toLowerCase();if(s==="input"||s==="textarea"||s==="button"||s==="select")return;const o=v(t);this.pendingMouseStart={item:e,position:o},document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)}handleTouchStart(t){this.lastTouchTime=Date.now();const e=t.currentTarget.__dndItem;if(!e)return;const s=t.target.tagName.toLowerCase();if(s==="input"||s==="textarea"||s==="button"||s==="select")return;const o=v(t);this.pendingTouchStart={item:e,position:o},this.touchHoldActivated=!1,this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null);const l=this.config.touchHoldDelay||0,c=this.config.holdIndicatorDelay||0;l>0?(c>0?this.holdIndicatorDelayTimer=setTimeout(()=>{this.holdIndicatorDelayTimer=null,this.holdStartTime=Date.now();const a=l-c;a>0&&this.startHoldProgressAnimation(e.id,a)},c):(this.holdStartTime=Date.now(),this.startHoldProgressAnimation(e.id,l)),this.touchHoldTimer=setTimeout(()=>{this.touchHoldActivated=!0,this.touchHoldTimer=null,this.stopHoldProgressAnimation(),this.clearHoldIndicatorDelayTimer(),this.callbacks.onHoldProgress&&this.callbacks.onHoldProgress(e.id,1),navigator.vibrate&&navigator.vibrate(50)},l)):this.touchHoldActivated=!0,document.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),document.addEventListener("touchend",this.handleTouchEnd)}startDrag(t,e){const i=x(t.element),s={x:e.x-i.x,y:e.y-i.y};this.cachedZoneGeometry=Array.from(this.dropZones.values()).map(o=>{const l=o.element.getBoundingClientRect();let c=0,a=o.element;for(;a.parentElement&&(a=a.parentElement,a.hasAttribute("data-drop-zone")&&c++,!a.hasAttribute("data-tree-root")););return{id:o.id,rect:{left:l.left,top:l.top,right:l.right,bottom:l.bottom,width:l.width,height:l.height},depth:c,zone:o}}),this.state={isDragging:!1,item:t,startPosition:e,currentPosition:e,offset:s,currentDropZone:null,potentialDropZone:null,sortIndex:null},document.body.style.userSelect="none",document.body.style.webkitUserSelect="none"}createDragPreview(){if(this.state.item)try{const t=this.state.item.element;this.dragPreview=t.cloneNode(!0),this.dragPreview.style.position="fixed",this.dragPreview.style.pointerEvents="none",this.dragPreview.style.zIndex="999999",this.dragPreview.style.opacity="0.4",this.dragPreview.style.transform="rotate(2deg)",this.dragPreview.style.transition="none",this.dragPreview.style.boxShadow="0 2px 8px rgba(0,0,0,0.15)",this.dragPreview.style.display="block",this.dragPreview.style.visibility="visible";const e=t.getBoundingClientRect();this.dragPreview.style.width=`${e.width}px`,this.dragPreview.style.height=`${e.height}px`,this.updateDragPreviewPosition(this.state.currentPosition),document.body.appendChild(this.dragPreview)}catch(t){console.error("[DragDrop] Failed to create drag preview:",t)}}updateDragPreviewPosition(t){if(!this.dragPreview||!this.state.item)return;const e=t.x-this.state.offset.x,i=t.y-this.state.offset.y;this.dragPreview.style.left=`${e}px`,this.dragPreview.style.top=`${i}px`}removeDragPreview(){var t;(t=this.dragPreview)!=null&&t.parentNode&&(this.dragPreview.parentNode.removeChild(this.dragPreview),this.dragPreview=null),document.body.style.userSelect="",document.body.style.webkitUserSelect=""}handleMouseMove(t){const e=v(t);if(this.pendingMouseStart&&!this.state.item){const i=this.config.dragThreshold||5;if(Math.hypot(e.x-this.pendingMouseStart.position.x,e.y-this.pendingMouseStart.position.y)>i)t.preventDefault(),this.startDrag(this.pendingMouseStart.item,this.pendingMouseStart.position),this.pendingMouseStart=null;else return}this.state.item&&this.updateDrag(e)}handleTouchMove(t){const e=v(t);if(this.pendingTouchStart&&!this.state.item){const i=this.config.dragThreshold||5;if(Math.hypot(e.x-this.pendingTouchStart.position.x,e.y-this.pendingTouchStart.position.y)>i){if(!this.touchHoldActivated){const o=this.pendingTouchStart.item.id;this.clearTouchHoldTimer(),this.pendingTouchStart=null,this.callbacks.onHoldProgress&&this.callbacks.onHoldProgress(o,0),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd);return}this.startDrag(this.pendingTouchStart.item,this.pendingTouchStart.position),this.pendingTouchStart=null}else return}this.state.item&&this.updateDrag(e)}clearTouchHoldTimer(){this.touchHoldTimer&&(clearTimeout(this.touchHoldTimer),this.touchHoldTimer=null),this.stopHoldProgressAnimation(),this.clearHoldIndicatorDelayTimer()}clearHoldIndicatorDelayTimer(){this.holdIndicatorDelayTimer&&(clearTimeout(this.holdIndicatorDelayTimer),this.holdIndicatorDelayTimer=null)}startHoldProgressAnimation(t,e){const i=()=>{const s=Date.now()-this.holdStartTime,o=Math.min(s/e,1);this.callbacks.onHoldProgress&&this.callbacks.onHoldProgress(t,o),o<1&&(this.holdProgressAnimationFrame=requestAnimationFrame(i))};this.holdProgressAnimationFrame=requestAnimationFrame(i)}stopHoldProgressAnimation(){this.holdProgressAnimationFrame&&(cancelAnimationFrame(this.holdProgressAnimationFrame),this.holdProgressAnimationFrame=null)}updateDrag(t){var o,l,c;if(!this.state.item)return;const e=this.config.dragThreshold||5,i=Math.hypot(t.x-this.state.startPosition.x,t.y-this.state.startPosition.y);if(!this.state.isDragging&&i>e&&(this.state.isDragging=!0,this.createDragPreview(),this.callbacks.onDragStart&&this.callbacks.onDragStart({item:this.state.item,position:this.state.startPosition})===!1)){this.cancelDrag();return}if(!this.state.isDragging)return;this.updateDragPreviewPosition(t);let s=t;if((o=this.config.snap)!=null&&o.enabled){const a=Array.from(this.draggables.values()).filter(g=>{var r;return g.id!==((r=this.state.item)==null?void 0:r.id)}).map(g=>g.element);s=C(t,this.config.snap,a)}if(this.state.currentPosition=s,this.state.potentialDropZone=I(s,this.cachedZoneGeometry),(l=this.config.sort)!=null&&l.enabled&&this.state.potentialDropZone){const a=this.getItemsInDropZone(this.state.potentialDropZone);this.state.sortIndex=M(s,this.state.potentialDropZone.element,a,this.config.sort.orientation,this.state.item)}this.lastMoveTimestamp=Date.now(),this.callbacks.onDragMove&&this.callbacks.onDragMove({item:this.state.item,position:s,dropZone:this.state.potentialDropZone,sortIndex:this.state.sortIndex}),(c=this.config.autoScroll)!=null&&c.enabled&&this.handleAutoScroll(t)}handleMouseUp(t){if(document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),this.pendingMouseStart&&!this.state.item){this.pendingMouseStart=null;return}if(this.state.item){const e=v(t);this.endDrag(e)}}handleTouchEnd(t){if(document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),this.clearTouchHoldTimer(),this.pendingTouchStart&&!this.state.item){const e=this.pendingTouchStart.item.element,i=this.pendingTouchStart.item.id;this.pendingTouchStart=null,this.touchHoldActivated=!1,this.callbacks.onHoldProgress&&this.callbacks.onHoldProgress(i,0),setTimeout(()=>{const s=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(s)},0);return}if(this.state.item){const e=v(t);this.endDrag(e)}this.touchHoldActivated=!1}endDrag(t){var a;const e=this.state.isDragging,i=this.state.item;let s=this.state.potentialDropZone,o=this.state.sortIndex;if(t){const g=I(t,this.cachedZoneGeometry);if(g&&(s=g,(a=this.config.sort)!=null&&a.enabled&&s&&i)){const r=this.getItemsInDropZone(s);o=M(t,s.element,r,this.config.sort.orientation,i)}}this.removeDragPreview(),this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null);const l=this.state.currentPosition,c=this.state.startPosition;this.state=this.getInitialState(),e&&i&&(s&&this.callbacks.onDrop&&this.callbacks.onDrop({item:i,dropZone:s,position:l,sortIndex:o}),this.callbacks.onDragEnd&&this.callbacks.onDragEnd({item:i,startPosition:c,endPosition:l,dropZone:s,sortIndex:o,cancelled:!1}))}cancelDrag(){const t=this.state.item;this.removeDragPreview(),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),this.pendingTouchStart=null,this.pendingMouseStart=null,this.clearTouchHoldTimer(),this.touchHoldActivated=!1,this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null),t&&this.callbacks.onDragEnd&&this.callbacks.onDragEnd({item:t,startPosition:this.state.startPosition,endPosition:this.state.currentPosition,dropZone:null,sortIndex:null,cancelled:!0}),this.state=this.getInitialState()}getItemsInDropZone(t){const e=[];return this.draggables.forEach(i=>{var s;((s=i.data)==null?void 0:s.dropZoneId)===t.id&&e.push(i)}),e}handleAutoScroll(t){var l;if(!((l=this.config.autoScroll)!=null&&l.enabled))return;const e=this.config.autoScroll.margin,i=this.config.autoScroll.speed;let s=0,o=0;t.x<e?s=-i:t.x>window.innerWidth-e&&(s=i),t.y<e?o=-i:t.y>window.innerHeight-e&&(o=i),s!==0||o!==0?this.scrollInterval||(this.scrollInterval=window.setInterval(()=>{window.scrollBy(s,o)},16)):this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null)}getState(){return{...this.state}}getCachedZoneGeometry(){return this.cachedZoneGeometry}updateConfig(t){this.config={...this.config,...t}}updateCallbacks(t){this.callbacks={...this.callbacks,...t}}destroy(){this.draggables.forEach(t=>this.unregisterDraggable(t.id)),this.dropZones.forEach(t=>this.unregisterDropZone(t.id)),(this.state.isDragging||this.pendingTouchStart||this.pendingMouseStart)&&this.cancelDrag(),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.scrollInterval&&clearInterval(this.scrollInterval)}}export{_ as D};
