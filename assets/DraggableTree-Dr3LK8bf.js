import{r as d,j as l}from"./react-vendor-Byz07MLO.js";import{Q as ce,V as _,ay as ie,R as de}from"./index-eHP58yiE.js";import{D as ue}from"./DragDropManager-KcuPnjwl.js";import{a as te,b as G,c as ge,d as he,e as xe,g as ne,f as E,r as pe,D as fe,i as be}from"./treeHelpers-DUv_6quS.js";import{s as re,o as me,q as ye}from"./icons-vtiX7BHn.js";function le({node:t,level:I,parentId:R,index:Q,defaultExpandedIds:j,renderCustomContent:P,onDragStateChange:B,dragSortIndex:L,dragTargetParent:m,dragOverNode:X,dragX:w,dragY:S,dragExpectedX:A,dragExpectedY:D,draggedNodeId:e,dragNextNodeLabel:M,onTreeStructureChange:W,allNodes:O,onHoverChange:q}){var $,k;const[C,H]=d.useState(()=>(j==null?void 0:j.has(t.id))??!1),T=t.children&&t.children.length>0,u=d.useRef(null),p=d.useRef(null);d.useLayoutEffect(()=>{j!=null&&j.has(t.id)&&!C&&H(!0)},[j,t.id,C,T]);const[h,c]=d.useState(null);d.useEffect(()=>{if(p.current){const g=p.current.parentElement;if(g){const N=g.getBoundingClientRect();c({top:Math.round(N.top),bottom:Math.round(N.bottom)})}}},[C,m,L]);const r=d.useCallback(()=>{H(g=>!g),setTimeout(()=>{W()},0)},[W]),o={paddingLeft:`${I*1.5}rem`},b=L===Q&&m===R&&Q!==0,x=m===t.id&&T&&C,s=R?te(O,R):null,n=R===null?O:(s==null?void 0:s.children)||[],i=R===null?"root":(s==null?void 0:s.label)||R;let a;if(L!==null&&L>0){const g=Math.min(L-1,n.length-1),N=g>=0?n[g]:null;if(N)if(N.id===e){const K=Math.max(0,g-1);a=g>0&&n[K]?n[K].label:i}else a=N.label;else a=n.length>0?n[n.length-1].label:i}else a=i;const v=e?te(O,e):null,y=v?v.label:"",V=b?G({draggedLabel:y,level:I,x:w,y:S,expectedX:A,expectedY:D,zoneId:R||"root",afterLabel:a,beforeLabel:M}):"";return l.jsxs("div",{className:"my-0.5",style:{position:"relative"},children:[b&&l.jsx(ge,{level:I,message:V,nodeId:t.id}),l.jsx("div",{ref:u,children:T?l.jsxs(ce,{open:C,onOpenChange:H,children:[l.jsxs("div",{className:_("flex items-center py-2 px-3 hover:bg-accent rounded-sm transition-colors group",X===t.id&&"bg-blue-50"),style:o,onMouseEnter:()=>q(t.id),onMouseLeave:()=>q(null),children:[l.jsx("div",{ref:p,"data-drag-handle":t.id,"data-parent-id":R,className:"cursor-move text-gray-400 hover:text-gray-600 flex-shrink-0 mr-2 opacity-0 group-hover:opacity-100 transition-opacity",children:l.jsx(re,{size:16})}),l.jsx(ie,{asChild:!0,children:l.jsxs("div",{className:"flex items-center flex-1 cursor-pointer",onClick:r,children:[l.jsx("div",{className:"w-4 h-4 mr-2 flex-shrink-0",children:C?l.jsx(me,{className:"h-4 w-4"}):l.jsx(ye,{className:"h-4 w-4"})}),t.icon&&l.jsx("div",{className:"mr-2 flex-shrink-0",children:t.icon}),P?P(t):l.jsxs("span",{className:"flex-1",children:[t.label,h&&l.jsxs("span",{className:"ml-2 text-xs text-gray-400 font-mono",children:["(y:",h.top,"-",h.bottom,")"]})]})]})})]}),l.jsxs(de,{style:{position:"relative"},children:[x&&L===0&&(()=>{const g=G({draggedLabel:y,level:I+1,x:w,y:S,expectedX:A,expectedY:D,zoneId:t.id,afterLabel:t.label,beforeLabel:M});return l.jsx(he,{level:I,message:g,nodeId:t.id})})(),l.jsx("div",{"data-drop-zone":t.id,"data-node-name":t.label,className:"tree-children py-1",style:{position:"relative",zIndex:I+10},children:($=t.children)==null?void 0:$.map((g,N)=>l.jsx(le,{node:g,level:I+1,parentId:t.id,index:N,defaultExpandedIds:j,renderCustomContent:P,onDragStateChange:B,dragSortIndex:L,dragTargetParent:m,dragOverNode:X,dragX:w,dragY:S,dragExpectedX:A,dragExpectedY:D,draggedNodeId:e,dragNextNodeLabel:M,onTreeStructureChange:W,allNodes:O,onHoverChange:q},g.id))}),x&&L===((k=t.children)==null?void 0:k.length)&&(()=>{const g=t.children&&t.children.length>0?t.children[t.children.length-1].label:t.label,N=G({draggedLabel:y,level:I+1,x:w,y:S,expectedX:A,expectedY:D,zoneId:t.id,afterLabel:g,beforeLabel:M});return l.jsx(xe,{level:I,message:N,nodeId:t.id})})()]})]}):l.jsxs("div",{style:{position:"relative"},children:[l.jsxs("div",{className:_("flex items-center py-2 px-3 hover:bg-accent rounded-sm transition-colors group",X===t.id&&"bg-blue-50"),style:o,onMouseEnter:()=>q(t.id),onMouseLeave:()=>q(null),children:[l.jsx("div",{ref:p,"data-drag-handle":t.id,"data-parent-id":R,className:"cursor-move text-gray-400 hover:text-gray-600 flex-shrink-0 mr-2 opacity-0 group-hover:opacity-100 transition-opacity",children:l.jsx(re,{size:16})}),l.jsx("div",{className:"w-4 h-4 mr-2 flex-shrink-0"}),t.icon&&l.jsx("div",{className:"mr-2 flex-shrink-0",children:t.icon}),P?P(t):l.jsxs("span",{className:"flex-1",children:[t.label,h&&l.jsxs("span",{className:"ml-2 text-xs text-gray-400 font-mono",children:["(y:",h.top,"-",h.bottom,")"]})]})]}),e&&e!==t.id&&l.jsx("div",{"data-drop-zone":t.id,"data-node-name":t.label,className:"tree-children",style:{position:"absolute",left:"60px",right:0,top:"33%",height:"34%",zIndex:999,pointerEvents:"auto"}})]})})]})}function Le({data:t,onReorder:I,className:R,defaultExpandedIds:Q,renderCustomContent:j,onDragStateChange:P}){const B=d.useRef(null),L=d.useRef(null),m=d.useRef(t),X=d.useRef(I),w=d.useRef(null),S=d.useRef([]),A=d.useRef(null),D=d.useRef({targetParent:null,sortIndex:null});d.useEffect(()=>{m.current=t,X.current=I},[t,I]);const[e,M]=d.useState({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),[W,O]=d.useState(null),[q,C]=d.useState(0),H=d.useCallback(()=>{C(u=>u+1)},[]);d.useEffect(()=>{if(P){const u=e.targetParent===null?0:ne(t,e.targetParent)+1;P({isDragging:e.isDragging,nodeId:e.nodeId,targetDepth:e.isDragging?u:null,targetParent:e.targetParent,sortIndex:e.sortIndex,x:e.x,y:e.y})}},[e,P,t]),d.useEffect(()=>{if(e.isDragging&&e.x!==null&&e.y!==null&&e.nodeId){const u=e.targetParent===null?0:ne(t,e.targetParent)+1,p=E(t,e.nodeId),h=(p==null?void 0:p.node.label)||e.nodeId,c=e.targetParent?E(t,e.targetParent):null,r=e.targetParent===null?t:(c==null?void 0:c.node.children)||[],o=e.targetParent===null?"root":(c==null?void 0:c.node.label)||e.targetParent;let b=o;if(e.sortIndex!==null&&e.sortIndex>0){const s=Math.min(e.sortIndex-1,r.length-1),n=s>=0?r[s]:null;n&&n.id!==e.nodeId&&(b=n.label)}let x=e.nextNodeLabel||"end";x==="end"&&(x=`${o} (end)`),e.sortIndex===0&&(b=`${o} (start)`),G({draggedLabel:h,level:u,x:e.x,y:e.y,expectedX:e.expectedX,expectedY:e.expectedY,zoneId:e.targetParent||"root",afterLabel:b,beforeLabel:x})}},[e,t]),d.useEffect(()=>(B.current=new ue({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:({item:u,position:p})=>{const h=u.data.nodeId,c=E(m.current,h);c!=null&&c.node.label,L.current=null,A.current=null,D.current={targetParent:null,sortIndex:null};const r=document.querySelector(`[data-drag-handle="${h}"]`);if(r){const n=r.parentElement;if(n){const i=n.getBoundingClientRect();w.current={top:Math.round(i.top),bottom:Math.round(i.bottom)}}}const o=[];document.querySelectorAll("[data-drag-handle]").forEach(n=>{const i=n.getAttribute("data-drag-handle");if(i){const a=n.parentElement;if(a){const v=a.getBoundingClientRect(),y=E(m.current,i);o.push({id:i,label:(y==null?void 0:y.node.label)||i,rect:{top:Math.round(v.top),bottom:Math.round(v.bottom)}})}}});const x=new Map;o.forEach(n=>{const i=n.rect.bottom-n.rect.top,a=x.get(n.id);if(!a)x.set(n.id,n);else{const v=a.rect.bottom-a.rect.top;i<v&&x.set(n.id,n)}});const s=Array.from(x.values());return s.sort((n,i)=>n.rect.top-i.rect.top),S.current=s,M({isDragging:!0,nodeId:u.id,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),!0},onDragMove:({item:u,position:p})=>{var K,ee;const h=u.data.nodeId,c=Math.round(p.x),r=Math.round(p.y),o=w.current;if(o&&r>=o.top&&r<=o.bottom){M(f=>({...f,x:c,y:r,sortIndex:null,targetParent:null,overNode:null,expectedX:null,expectedY:null,nextNodeLabel:null}));return}const s=S.current.find(f=>r>=f.rect.top&&r<=f.rect.bottom);let n=null;if(s){const f=E(m.current,s.id);if(f){const F=s.rect.bottom-s.rect.top,z=(r-s.rect.top)/F,oe=z>=.33&&z<.66,se=z>=.66;if(oe)n={targetParentId:s.id,sortIndex:0};else if(se){const Y=f.parent,J=(Y===null?m.current:((K=E(m.current,Y))==null?void 0:K.node.children)||[]).findIndex(U=>U.id===s.id);n={targetParentId:Y,sortIndex:J+1}}else{const Y=f.parent,J=(Y===null?m.current:((ee=E(m.current,Y))==null?void 0:ee.node.children)||[]).findIndex(U=>U.id===s.id);n={targetParentId:Y,sortIndex:J}}}n&&(A.current=n)}else A.current&&(n=A.current);const i=(n==null?void 0:n.targetParentId)??null,a=(n==null?void 0:n.sortIndex)??0,v=i?E(m.current,i):null,y=i===null?m.current:(v==null?void 0:v.node.children)||[],V=(v==null?void 0:v.node.label)||"root";let $;if(a!==null&&a<y.length){const f=y[a];f&&f.id===h?a+1<y.length?$=y[a+1].label:$=`${V} (end)`:$=f?f.label:`${V} (end)`}else $=`${V} (end)`;let k=0,g=0;const N=i?document.querySelector(`[data-drop-zone="${i}"]`):document.querySelector('[data-drop-zone="root"]');if(N){const f=N.getBoundingClientRect();if(a!==null&&a>0&&y[a-1]){const F=y[a-1].id,Z=document.querySelector(`[data-drag-handle="${F}"]`);if(Z){const z=Z.getBoundingClientRect();k=Math.round(z.left),g=Math.round(z.bottom+2)}}else if(y[a??0]){const F=y[a??0],Z=document.querySelector(`[data-drag-handle="${F.id}"]`);if(Z){const z=Z.getBoundingClientRect();k=Math.round(z.left),g=Math.round(z.top-2)}}else k=Math.round(f.left),g=Math.round(f.bottom)}D.current={targetParent:i??null,sortIndex:a??null},M(f=>({...f,sortIndex:a??null,targetParent:i??null,overNode:i??null,x:c,y:r,expectedX:k,expectedY:g,nextNodeLabel:$}))},onDrop:({item:u})=>{const p=u.data.nodeId,h=D.current.targetParent,c=D.current.sortIndex;if(c==null)return;const{newNodes:r,removed:o}=pe(m.current,p);if(!o)return;const b=be(r,o,h,c);X.current(b)},onDragEnd:()=>{w.current=null,S.current=[],D.current={targetParent:null,sortIndex:null},M({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null})}}),()=>{var u;(u=B.current)==null||u.destroy()}),[]),d.useEffect(()=>{if(!B.current)return;document.querySelectorAll('[data-dnd-registered="true"]').forEach(r=>r.removeAttribute("data-dnd-registered")),document.querySelectorAll('[data-dnd-zone-registered="true"]').forEach(r=>r.removeAttribute("data-dnd-zone-registered")),document.querySelectorAll("[data-drop-zone]").forEach(r=>{const o=r.getAttribute("data-drop-zone"),b=r.getAttribute("data-node-name");let x=b||o||"unknown";if(o&&o!=="root"){const s=document.querySelector(`[data-drag-handle="${o}"]`);if(s){const n=s.getBoundingClientRect(),i=Math.round(n.top),a=Math.round(n.bottom);x=`${b||o} (y:${i}-${a})`}}o&&(B.current.registerDropZone(o,r,void 0,{nodeName:x}),r.setAttribute("data-dnd-zone-registered","true"),r.setAttribute("data-node-name",x))}),document.querySelectorAll("[data-drag-handle]").forEach(r=>{const o=r.getAttribute("data-drag-handle"),b=r.getAttribute("data-parent-id");let x="root",s=r.parentElement;for(;s;){const n=s.getAttribute("data-drop-zone");if(n){x=n;break}s=s.parentElement}o&&(B.current.registerDraggable(o,r,{nodeId:o,parentId:b||null,dropZoneId:x}),r.setAttribute("data-dnd-registered","true"))})},[t,q]);const T=(u,p=null,h=0)=>u.map((c,r)=>l.jsx(le,{node:c,level:h,parentId:p,index:r,defaultExpandedIds:Q,renderCustomContent:j,onDragStateChange:(o,b)=>M(x=>({...x,isDragging:o,nodeId:b})),dragSortIndex:e.sortIndex,dragTargetParent:e.targetParent,dragOverNode:e.overNode,dragX:e.x,dragY:e.y,dragExpectedX:e.expectedX,dragExpectedY:e.expectedY,draggedNodeId:e.nodeId,dragNextNodeLabel:e.nextNodeLabel,onTreeStructureChange:H,allNodes:t,onHoverChange:O},c.id));return l.jsx("div",{className:_("draggable-tree",R),children:l.jsxs("div",{"data-drop-zone":"root","data-node-name":"root","data-tree-root":!0,style:{position:"relative"},children:[T(t,null,0),e.sortIndex===t.length&&e.targetParent===null&&(()=>{var c;const u=e.nodeId?((c=E(t,e.nodeId))==null?void 0:c.node.label)||e.nodeId:"?",p=t.length>0?t[t.length-1].label:"root",h=G({draggedLabel:u,level:0,x:e.x,y:e.y,expectedX:e.expectedX,expectedY:e.expectedY,zoneId:"root",afterLabel:p,beforeLabel:e.nextNodeLabel});return l.jsx(fe,{message:h})})()]})})}export{Le as D};
