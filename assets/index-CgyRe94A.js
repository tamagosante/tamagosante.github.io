const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HomePage-KyBYgbzI.js","assets/react-vendor-CrhW4DYn.js","assets/icons-6Gjq1X59.js","assets/recordingStorage-XzvoUejy.js","assets/utils-DPdF7W5J.js","assets/radix-ui-BcQf1l4u.js","assets/ui-utils-BxIQ3qGg.js","assets/Chat-Bx6-Bykp.js","assets/format-utils-Ba8uG3XU.js","assets/systemPromptService-CiGRUnu2.js","assets/InputWithAudio-CUvh-Dx_.js","assets/textarea-DhMMW6X3.js","assets/Settings-CTyrB4-B.js","assets/Demo-ChGHWAOm.js","assets/Breadcrumbs-DwpmWO_t.js","assets/Content-pNSnt4ev.js","assets/TablePage-DU9Eh4aH.js","assets/data-table-BJD19zEG.js","assets/table-GtDJTbaS.js","assets/VocabularyPage-CX-nSon9.js","assets/definitionHelper-B6GF8IZ1.js","assets/useVietnameseTyping-jI8BXDui.js","assets/TextareaPopoverAtCursor-D4YPM1uA.js","assets/LiveTranscriptionPage-Cv5ZDf8k.js","assets/AudioPanelDemo-B0ypglEb.js","assets/ClaudePage-BrDFzXLG.js","assets/SessionSidebar-o2c6r3GP.js","assets/radio-group-yyvGmlz8.js","assets/tree-YoeeSzP_.js","assets/SessionDetailsPage-D4Q6KUqx.js","assets/KanbanPage-B9KpW4gx.js","assets/DemoLayout-t6R5WvcA.js","assets/react-hooks-B0JzEvCg.js","assets/DragDropManager-BCQ9eUTy.js","assets/KanbanDataPage-DFk-8cAL.js","assets/JsonViewerApp-BV6Qrni3.js","assets/index-2tJLVElX.js","assets/GlobalStatePage-T70_8ei8.js","assets/GamePage-BcUksn-g.js","assets/NewHomeApp-BLcvfOeC.js","assets/CanvasAppV2-DOnL6IYW.js","assets/logging-3Ta40PMa.js","assets/VimInputHandlerV2-B7glPzRj.js","assets/string-4WCj7OpV.js","assets/VimInputHandlerV2-BfpIuMTm.css","assets/markdownToHtml-C-4HvgxL.js","assets/WorkflowRowItem-BgEfflDF.js","assets/DraggableTree-DZBXXLrp.js","assets/DropIndicator-BK5HbmlC.js","assets/useOcr-D9MNhY6S.js","assets/alert-OFiIdJW_.js","assets/DraggableCrudTree-7toDmunK.js","assets/easy-form-VaGewJJh.js","assets/forms-DJIXVCQp.js","assets/form-CN7M0dLz.js","assets/MobileLogViewerButton-DhrY2Y3H.js"])))=>i.map(i=>d[i]);
var kc=Object.defineProperty;var Tc=(s,e,t)=>e in s?kc(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var J=(s,e,t)=>Tc(s,typeof e!="symbol"?e+"":e,t);import{r as d,j as r,d as Ac,e as Fr,u as Sn,i as gr,b as Ic,R as Rc,k as Pc,B as _c}from"./react-vendor-CrhW4DYn.js";import{B as Dc,m as Wr,d as Oc,_ as Ye,t as Ze,z as Mc,T as Lc}from"./utils-DPdF7W5J.js";import{S as es,k as Cn,O as ma,d as xr,C as Ss,j as br,T as ga,D as xa,R as jn,l as $c,m as Nn,n as Uc,o as Fc,p as Wc,q as zc,r as Bc,s as Hc,t as Gc,v as Vc,w as qc,x as En,A as Kc,y as kn,z as Jc,B as Tn,E as Qc,V as Xc,F as An,G as Yc,H as Zc,J as In,K as el,L as Rn,M as tl,N as sl,Q as Pn,U as _n,W as Dn,X as On,Y as al,Z as rl,$ as nl,a0 as ol,a1 as Mn,a2 as Ln,a3 as $n,a4 as Un,a5 as il,a6 as Fn,a7 as Wn,a8 as zn,a9 as Bn,aa as Hn,ab as Gn,ac as cl,ad as ll,ae as dl,af as Vn,ag as ul,ah as qn,ai as pl,aj as hl,ak as Kn,al as fl,am as ml,an as Jn,ao as Qn,ap as Xn}from"./radix-ui-BcQf1l4u.js";import{t as gl,a as Ws,c as Cs}from"./ui-utils-BxIQ3qGg.js";import{X as rt,bX as xl,bY as zr,bZ as bl,e as At,M as Yn,b_ as vl,aZ as wl,b$ as yl,c0 as Sl,aT as Cl,W as jl,c1 as Zn,I as Nl,c2 as eo,be as to,c3 as so,v as ao,b as ro,c4 as no,aB as js,a7 as Ht,a1 as Ks,F as vr,aX as El,aY as kl,Y as et,a6 as ts,ar as wr,a2 as ba,c5 as oo,c6 as Tl,aF as Al,bL as Il,a0 as Rl,E as Ia,O as Bt,aP as Pl,as as io,ah as _l,y as va,z as Dl,D as Ol,Q as Ml,aI as Ha,S as fs,h as yr,c7 as Ll,a4 as Br,a3 as ns,aq as $l,a as Ga,aA as co,aw as Js,ba as Ul,bt as Fl,_ as lo,c8 as Wl,c9 as zl,B as Bl,N as Hl,L as Gl,i as Vl,b4 as ql,P as Kl,bO as Jl,bd as Ql,av as uo,a9 as Xl}from"./icons-6Gjq1X59.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const Ft=class Ft{constructor(){J(this,"logs",[]);J(this,"counter",0);J(this,"maxLogs",100);J(this,"listeners",[]);J(this,"isCollecting",!1);J(this,"collectedLogs",[]);J(this,"originalConsole",{log:console.log,warn:console.warn,error:console.error,debug:console.debug})}static getInstance(){return Ft.instance||(Ft.instance=new Ft),Ft.instance}log(e,t="info",a){const n=new Date().toLocaleTimeString(),o={id:`log-${this.counter++}`,timestamp:n,message:e,level:t,service:a},i=t==="error"?console.error:t==="warning"?console.warn:t==="debug"?console.debug:console.log,c=a?`[${a}] `:"",l=`[${n}] ${c}${e}`;i(l),this.isCollecting&&this.collectedLogs.push(l),this.logs=[o,...this.logs.slice(0,this.maxLogs-1)],this.notifyListeners()}info(e,t){this.log(e,"info",t)}error(e,t){this.log(e,"error",t)}warning(e,t){this.log(e,"warning",t)}debug(e,t){this.log(e,"debug",t)}getLogs(){return this.logs}clear(){this.logs=[],this.notifyListeners()}export(){return this.logs.slice().reverse().map(e=>{const t=e.service?`[${e.service}] `:"";return`[${e.timestamp}] ${e.level.toUpperCase()}: ${t}${e.message}`}).join(`
`)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.logs))}collectLogs(e=!0){this.isCollecting=!0,this.collectedLogs=[],e&&typeof window<"u"&&this.interceptConsole(),console.log("ðŸ“ Log collection started. Call window.printCollectedLogs() to retrieve.")}interceptConsole(){const e=this;console.log=function(...t){const a=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(a),e.originalConsole.log.apply(console,t)},console.warn=function(...t){const a=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(`WARN: ${a}`),e.originalConsole.warn.apply(console,t)},console.error=function(...t){const a=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(`ERROR: ${a}`),e.originalConsole.error.apply(console,t)},console.debug=function(...t){const a=t.map(n=>typeof n=="object"?JSON.stringify(n,null,2):String(n)).join(" ");e.isCollecting&&e.collectedLogs.push(`DEBUG: ${a}`),e.originalConsole.debug.apply(console,t)}}restoreConsole(){console.log=this.originalConsole.log,console.warn=this.originalConsole.warn,console.error=this.originalConsole.error,console.debug=this.originalConsole.debug}stopCollecting(){this.isCollecting=!1,this.restoreConsole();const e=this.collectedLogs.join(`
`);return console.log("ðŸ›‘ Log collection stopped."),e}getCollectedLogs(){return this.collectedLogs.join(`
`)}clearCollectedLogs(){this.collectedLogs=[]}};J(Ft,"instance");let Va=Ft;const pe=Va.getInstance();typeof window<"u"&&(window.getCollectedLogs=()=>pe.getCollectedLogs(),window.printCollectedLogs=()=>{const s=pe.getCollectedLogs();return console.log(`ðŸ“‹ Collected logs:
`+s),s},window.startCollectingLogs=()=>pe.collectLogs(),window.stopCollectingLogs=()=>pe.stopCollecting(),window.clearCollectedLogs=()=>pe.clearCollectedLogs());const po=()=>{const[s,e]=d.useState(()=>pe.getLogs());d.useEffect(()=>pe.subscribe(n=>{e(n)}),[]);const t=d.useRef();return t.current||(t.current={log:(a,n,o)=>pe.log(a,n,o),info:(a,n)=>pe.info(a,n),error:(a,n)=>pe.error(a,n),warning:(a,n)=>pe.warning(a,n),debug:(a,n)=>pe.debug(a,n),clear:()=>pe.clear(),export:()=>pe.export()}),{logs:s,actions:t.current}};class Yl{constructor(e="http://localhost:3333"){J(this,"baseUrl");J(this,"eventSource",null);this.baseUrl=e}async getProjects(e){const t=new URLSearchParams;(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const a=`${this.baseUrl}/claude/projects${t.toString()?`?${t.toString()}`:""}`;try{const n=await fetch(a);if(!n.ok)throw new Error(`Failed to fetch projects: ${n.statusText}`);return await n.json()}catch(n){throw console.error("[ClaudeAPI.getProjects] Fetch error:",{url:a,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",errorName:n instanceof Error?n.name:void 0,timestamp:new Date().toISOString()}),n}}async getProjectDetails(e){const t=`${this.baseUrl}/claude/projects/${encodeURIComponent(e)}`,a=await fetch(t);if(!a.ok)throw new Error(`Failed to fetch project details: ${a.statusText}`);return a.json()}async getSessions(e){const t=new URLSearchParams;e!=null&&e.search&&t.append("search",e.search),(e==null?void 0:e.page)!==void 0&&t.append("page",e.page.toString()),(e==null?void 0:e.pageSize)!==void 0&&t.append("pageSize",e.pageSize.toString());const a=`${this.baseUrl}/claude/sessions${t.toString()?`?${t.toString()}`:""}`;try{const n=await fetch(a);if(!n.ok)throw new Error(`Failed to fetch sessions: ${n.statusText}`);return n.json()}catch(n){throw console.error("[ClaudeAPI.getSessions] Fetch error:",{url:a,error:n,errorMessage:n instanceof Error?n.message:"Unknown error",errorName:n instanceof Error?n.name:void 0,errorStack:n instanceof Error?n.stack:void 0,timestamp:new Date().toISOString()}),n}}async searchSessions(e,t){const a=new URLSearchParams;e&&(t!=null&&t.messageTypes&&t.messageTypes.length>0?a.append("messageContent",e):a.append("q",e)),t!=null&&t.fields&&t.fields.length>0&&!(t!=null&&t.messageTypes&&t.messageTypes.length>0)&&a.append("fields",t.fields.join(",")),(t==null?void 0:t.isActive)!==void 0&&a.append("isActive",t.isActive.toString()),(t==null?void 0:t.minMessages)!==void 0&&a.append("minMessages",t.minMessages.toString()),(t==null?void 0:t.maxMessages)!==void 0&&a.append("maxMessages",t.maxMessages.toString()),t!=null&&t.modifiedAfter&&a.append("modifiedAfter",t.modifiedAfter),t!=null&&t.modifiedBefore&&a.append("modifiedBefore",t.modifiedBefore),t!=null&&t.messageTypes&&t.messageTypes.length>0&&a.append("messageTypes",t.messageTypes.join(",")),t!=null&&t.sortBy&&a.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&a.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&a.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&a.append("pageSize",t.pageSize.toString());const n=`${this.baseUrl}/claude/sessions/search${a.toString()?`?${a.toString()}`:""}`;try{const o=await fetch(n);if(!o.ok)throw new Error(`Failed to search sessions: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.searchSessions] Fetch error:",{url:n,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,errorStack:o instanceof Error?o.stack:void 0,timestamp:new Date().toISOString()}),o}}async searchSessionMessages(e,t,a){const n=new URLSearchParams;t&&n.append("content",t),a!=null&&a.messageType&&a.messageType.length>0?n.append("messageType",a.messageType.join(",")):a!=null&&a.role&&n.append("role",a.role),a!=null&&a.after&&n.append("after",a.after),a!=null&&a.before&&n.append("before",a.before),a!=null&&a.sortOrder&&n.append("sortOrder",a.sortOrder),(a==null?void 0:a.page)!==void 0&&n.append("page",a.page.toString()),(a==null?void 0:a.pageSize)!==void 0&&n.append("pageSize",a.pageSize.toString());const o=`${this.baseUrl}/claude/sessions/${e}/search${n.toString()?`?${n.toString()}`:""}`,i=await fetch(o);if(!i.ok)throw new Error(`Failed to search session messages: ${i.statusText}`);return i.json()}async searchMessages(e,t){const a=new URLSearchParams;e&&a.append("q",e),t!=null&&t.messageType&&t.messageType.length>0&&a.append("messageTypes",t.messageType.join(",")),t!=null&&t.after&&a.append("after",t.after),t!=null&&t.before&&a.append("before",t.before),t!=null&&t.sortOrder&&a.append("sortOrder",t.sortOrder),(t==null?void 0:t.page)!==void 0&&a.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&a.append("pageSize",t.pageSize.toString());const n=`${this.baseUrl}/claude/messages/search${a.toString()?`?${a.toString()}`:""}`,o=await fetch(n);if(!o.ok)throw new Error(`Failed to search messages: ${o.statusText}`);return o.json()}async getSessionDetails(e,t){const a=new URLSearchParams;(t==null?void 0:t.page)!==void 0&&a.append("page",t.page.toString()),(t==null?void 0:t.pageSize)!==void 0&&a.append("pageSize",t.pageSize.toString()),t!=null&&t.messageType&&t.messageType.length>0&&a.append("messageType",t.messageType.join(","));const n=`${this.baseUrl}/claude/sessions/${e}${a.toString()?`?${a.toString()}`:""}`;try{const o=await fetch(n);if(!o.ok)throw new Error(`Failed to fetch session details: ${o.statusText}`);return o.json()}catch(o){throw console.error("[ClaudeAPI.getSessionDetails] Fetch error:",{url:n,sessionId:e,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",errorName:o instanceof Error?o.name:void 0,timestamp:new Date().toISOString()}),o}}async sendMessage(e){const t=await fetch(`${this.baseUrl}/claude/input`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to send message: ${t.statusText}`);return t.json()}async createSession(e={}){const t=await fetch(`${this.baseUrl}/claude/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Failed to create session: ${t.statusText}`);return t.json()}async updateSessionName(e,t){const a=await fetch(`${this.baseUrl}/claude/sessions/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({customName:t})});if(!a.ok)throw new Error(`Failed to update session name: ${a.statusText}`);return a.json()}async updateSessionStatus(e,t){const a=await fetch(`${this.baseUrl}/claude/sessions/${e}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!a.ok)throw new Error(`Failed to update session status: ${a.statusText}`);return a.json()}subscribeToSessionChanges(e,t){const a=`${this.baseUrl}/claude/sessions/events`;return this.eventSource=new EventSource(a),this.eventSource.onopen=()=>{var n;console.log("[ClaudeAPI.subscribeToSessionChanges] SSE connection opened:",{url:a,readyState:(n=this.eventSource)==null?void 0:n.readyState,timestamp:new Date().toISOString()})},this.eventSource.onmessage=n=>{try{const o=JSON.parse(n.data);o.type!=="connected"&&e(o)}catch(o){console.error("[ClaudeAPI.subscribeToSessionChanges] Failed to parse SSE event:",{error:o,eventData:n.data,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=n=>{var o,i,c,l;console.error("[ClaudeAPI.subscribeToSessionChanges] SSE connection error:",{error:n,readyState:(o=this.eventSource)==null?void 0:o.readyState,readyStateText:((i=this.eventSource)==null?void 0:i.readyState)===0?"CONNECTING":((c=this.eventSource)==null?void 0:c.readyState)===1?"OPEN":((l=this.eventSource)==null?void 0:l.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),t&&t(n)},()=>{var n;(n=this.eventSource)==null||n.close(),this.eventSource=null}}}const nt=new Yl;class Zl{constructor(e="http://localhost:3333"){J(this,"eventSource",null);J(this,"eventHandlers",new Set);J(this,"errorHandlers",new Set);J(this,"baseUrl");J(this,"reconnectAttempts",0);J(this,"maxReconnectAttempts",5);J(this,"reconnectDelay",1e3);this.baseUrl=e}subscribe(e,t){return this.eventHandlers.add(e),t&&this.errorHandlers.add(t),this.eventHandlers.size===1&&!this.eventSource&&this.connect(),()=>{this.eventHandlers.delete(e),t&&this.errorHandlers.delete(t),this.eventHandlers.size===0&&this.disconnect()}}connect(){const e=`${this.baseUrl}/claude/sessions/events`;this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.reconnectAttempts=0},this.eventSource.onmessage=t=>{try{const a=JSON.parse(t.data);if(a.type==="connected")return;this.eventHandlers.forEach(n=>{try{n(a)}catch(o){console.error("[ClaudeSSEManager] Error in event handler:",{error:o,eventType:a.type,timestamp:new Date().toISOString()})}})}catch(a){console.error("[ClaudeSSEManager] Failed to parse SSE event:",{error:a,eventData:t.data,errorMessage:a instanceof Error?a.message:"Unknown error",timestamp:new Date().toISOString()})}},this.eventSource.onerror=t=>{var a,n,o,i;if(console.error("[ClaudeSSEManager] SSE connection error:",{error:t,readyState:(a=this.eventSource)==null?void 0:a.readyState,readyStateText:((n=this.eventSource)==null?void 0:n.readyState)===0?"CONNECTING":((o=this.eventSource)==null?void 0:o.readyState)===1?"OPEN":((i=this.eventSource)==null?void 0:i.readyState)===2?"CLOSED":"UNKNOWN",timestamp:new Date().toISOString()}),this.errorHandlers.forEach(c=>{try{c(t)}catch(l){console.error("[ClaudeSSEManager] Error in error handler:",l)}}),this.eventHandlers.size>0&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const c=this.reconnectDelay*this.reconnectAttempts;setTimeout(()=>{this.eventHandlers.size>0&&(this.disconnect(),this.connect())},c)}}}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null,this.reconnectAttempts=0)}getConnectionState(){var e;return((e=this.eventSource)==null?void 0:e.readyState)??null}getSubscriberCount(){return this.eventHandlers.size}}const ed=new Zl;function Sr(s,e,t=!0){const a=d.useRef(s),n=d.useRef(e);d.useEffect(()=>{a.current=s},[s]),d.useEffect(()=>{n.current=e},[e]);const o=d.useCallback(l=>{a.current(l)},[]),i=d.useCallback(l=>{var u;(u=n.current)==null||u.call(n,l)},[]),c=d.useRef(!!e);d.useEffect(()=>{c.current=!!e},[e]),d.useEffect(()=>{if(!t)return;const l=ed.subscribe(o,c.current?i:void 0);return()=>{l()}},[t,o,i])}function ho(s,e){const t={...s};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){const n=e[a],o=t[a];n&&typeof n=="object"&&!Array.isArray(n)&&o&&typeof o=="object"&&!Array.isArray(o)?t[a]=ho(o,n):t[a]=n}return t}class td{constructor(e={}){J(this,"STORAGE_KEY","global-store");J(this,"state$");const t=this.loadFromStorage();this.state$=new Dc({...e,...t})}getState(){return this.state$.value}getState$(){return this.state$.asObservable()}get(e){return this.state$.value[e]}select(e){return this.state$.pipe(Wr(t=>t[e]),Oc())}selectSlice(e){return this.state$.pipe(Wr(e))}setState(e){this.state$.next(e),this.saveToStorage()}updateState(e){const t={...this.state$.value,...e};this.state$.next(t),this.saveToStorage()}set(e,t){this.updateState({[e]:t})}update(e,t){const a=this.state$.value[e],n=typeof a=="object"&&a!==null&&typeof t=="object"&&t!==null?ho(a,t):t;this.set(e,n)}remove(e){const t={...this.state$.value};delete t[e],this.state$.next(t),this.saveToStorage()}reset(){this.state$.next({}),this.clearStorage()}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load global store from localStorage:",e),{}}}saveToStorage(){try{const e=this.getStateToPersist(this.state$.value);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Failed to save global store to localStorage:",e)}}getStateToPersist(e){var a,n;const t={...e};if(t.ui&&(t.ui={...t.ui,directoryMaps:void 0}),(a=t.app)!=null&&a.claude){const o=t.app.claude;t.app={...t.app,claude:{...o,data:void 0,ui:o.ui?{...o.ui,isInitialized:void 0,loadingSessions:void 0,sessionsError:void 0,projectsInitialized:void 0,loadingProjects:void 0,projectsError:void 0,activity:void 0}:void 0}}}if((n=t.app)!=null&&n.kanban){const o=t.app.kanban;t.app={...t.app,kanban:{...o,loading:void 0,error:void 0}}}return t}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear global store from localStorage:",e)}}export(){return JSON.stringify(this.state$.value,null,2)}import(e){try{const t=JSON.parse(e);return this.setState(t),!0}catch(t){return console.error("Failed to import global store data:",t),!1}}}const Z=new td;function Ae(s){const[e,t]=d.useState(()=>s(Z.getState()));return d.useEffect(()=>{const a=Z.selectSlice(s).subscribe(t);return()=>a.unsubscribe()},[s]),e}function fo(){return{get:Z.get.bind(Z),set:Z.set.bind(Z),update:Z.update.bind(Z),updateState:Z.updateState.bind(Z),remove:Z.remove.bind(Z),reset:Z.reset.bind(Z),getState:Z.getState.bind(Z)}}const sd=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.sessions)??[]},ad=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.loadingSessions)??!1},rd=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.sessionsError)??null},nd=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.pagination)??null},od=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.currentPage)??1},id=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.isInitialized)??!1};function cd(s={}){const{loadOnMount:e=!0,subscribeToSSE:t=!0}=s,{update:a,getState:n}=fo(),o=d.useRef(!1),i=Ae(sd),c=Ae(ad),l=Ae(rd),u=Ae(nd),p=Ae(od),h=Ae(id),f=async(x=1,j=!1)=>{var C,N,S,D,W;try{const E=(C=n().app)==null?void 0:C.claude;a("app",{claude:{ui:{...E==null?void 0:E.ui,loadingSessions:!0,sessionsError:null,currentPage:x,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1}}});const I=await nt.getSessions({page:x,pageSize:20}),_=[...I.sessions].sort((M,O)=>new Date(O.lastModified).getTime()-new Date(M.lastModified).getTime()),U=((N=E==null?void 0:E.data)==null?void 0:N.sessions)??[],k=j?[...U,..._]:_;a("app",{claude:{data:{sessions:k,pagination:I.pagination||null},ui:{loadingSessions:!1,sessionsError:null,currentPage:x,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}})}catch(E){console.error("[SessionLoader] API request failed:",{error:E,errorMessage:E instanceof Error?E.message:"Unknown error",page:x,append:j,timestamp:new Date().toISOString()}),pe.error(`Session load failed: ${E instanceof Error?E.message:"Unknown error"}`,"SessionLoader"),a("app",{claude:{data:{sessions:j?((W=(D=(S=n().app)==null?void 0:S.claude)==null?void 0:D.data)==null?void 0:W.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:E instanceof Error?E.message:"Failed to load sessions",currentPage:x,searchQuery:void 0,searchFilters:void 0,isSearchActive:!1,isInitialized:!0}}}),pe.error("Store updated with error state","SessionLoader")}},b=async(x,j,C=!1)=>{var N,S,D,W,E;try{const I=(N=n().app)==null?void 0:N.claude;a("app",{claude:{ui:{...I==null?void 0:I.ui,loadingSessions:!0,sessionsError:null,searchQuery:x,searchFilters:j,isSearchActive:!0}}});const _=await nt.searchSessions(x,j),U=((S=I==null?void 0:I.data)==null?void 0:S.sessions)??[],k=C?[...U,..._.results]:_.results;a("app",{claude:{data:{sessions:k,pagination:_.pagination},ui:{loadingSessions:!1,sessionsError:null,currentPage:_.pagination.page,searchQuery:x,searchFilters:j,isSearchActive:!0}}})}catch(I){console.error("[SessionLoader] API request failed:",{error:I,errorMessage:I instanceof Error?I.message:"Unknown error",query:x,filters:j,append:C,timestamp:new Date().toISOString()}),a("app",{claude:{data:{sessions:C?((E=(W=(D=n().app)==null?void 0:D.claude)==null?void 0:W.data)==null?void 0:E.sessions)??[]:[],pagination:null},ui:{loadingSessions:!1,sessionsError:I instanceof Error?I.message:"Failed to search sessions",currentPage:1,searchQuery:x,searchFilters:j,isSearchActive:!0}}})}},v=(x,j)=>{var W,E,I;const C=((I=(E=(W=n().app)==null?void 0:W.claude)==null?void 0:E.data)==null?void 0:I.sessions)??[],N=C.findIndex(_=>_.id===x);if(N===-1)return;const S=[...C];S[N]={...S[N],...j};const D=S.sort((_,U)=>new Date(U.lastModified).getTime()-new Date(_.lastModified).getTime());a("app",{claude:{data:{sessions:D},ui:{loadingSessions:!1,sessionsError:null}}})},m=x=>{var N,S,D;const C=(((D=(S=(N=n().app)==null?void 0:N.claude)==null?void 0:S.data)==null?void 0:D.sessions)??[]).filter(W=>W.id!==x);a("app",{claude:{data:{sessions:C},ui:{loadingSessions:!1,sessionsError:null}}})},w=x=>{var C,N;const j=(N=(C=n().app)==null?void 0:C.claude)==null?void 0:N.ui;if(j!=null&&j.isSearchActive&&(j==null?void 0:j.searchQuery)!==void 0){const S={...j.searchFilters,page:x};b(j.searchQuery,S)}else f(x)},y=()=>{var x,j;if(u&&p<u.totalPages){const C=(j=(x=n().app)==null?void 0:x.claude)==null?void 0:j.ui;if(C!=null&&C.isSearchActive&&(C==null?void 0:C.searchQuery)!==void 0){const N={...C.searchFilters,page:p+1};b(C.searchQuery,N,!0)}else f(p+1,!0)}},g=()=>{f(1)};return d.useEffect(()=>{e&&(h||o.current||(o.current=!0,f(1)))},[h]),Sr(x=>{x.type==="created"&&f(p),x.type==="modified"&&x.sessionId&&(async()=>{try{const j=await nt.getSessionDetails(x.sessionId);v(x.sessionId,{name:j.name,lastModified:j.metadata.lastModified,messageCount:j.metadata.messageCount})}catch(j){console.error("[SSE] Failed to fetch modified session:",{sessionId:x.sessionId,error:j,timestamp:new Date().toISOString()})}})(),x.type==="batch-modified"&&x.sessionIds&&f(p),x.type==="deleted"&&x.sessionId&&m(x.sessionId)},x=>{console.error("[SSE] Connection error:",{error:x,errorMessage:x instanceof Error?x.message:"Unknown error",timestamp:new Date().toISOString()})},t),{sessions:i,loadingSessions:c,sessionsError:l,pagination:u,currentPage:p,isInitialized:h,loadSessions:f,searchSessions:b,refreshSessions:g,handlePageChange:w,handleLoadMore:y}}const ld=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.projects)??[]},dd=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.loadingProjects)??!1},ud=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.projectsError)??null},pd=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.projectsInitialized)??!1};function hd(s={}){const{loadOnMount:e=!0}=s,{update:t,getState:a}=fo(),n=d.useRef(!1),o=Ae(ld),i=Ae(dd),c=Ae(ud),l=Ae(pd),u=async()=>{var h,f,b;try{const v=a(),m=(h=v.app)==null?void 0:h.claude;t("app",{...v.app,claude:{...m,data:{...m==null?void 0:m.data},ui:{...m==null?void 0:m.ui,loadingProjects:!0,projectsError:null}}});const w=await nt.getProjects({pageSize:100}),y=a(),g=(f=y.app)==null?void 0:f.claude;t("app",{...y.app,claude:{...g,data:{...g==null?void 0:g.data,projects:w.projects},ui:{...g==null?void 0:g.ui,loadingProjects:!1,projectsError:null,projectsInitialized:!0}}})}catch(v){console.error("[ProjectsLoader] API request failed:",{error:v,errorMessage:v instanceof Error?v.message:"Unknown error",timestamp:new Date().toISOString()}),pe.error(`Projects load failed: ${v instanceof Error?v.message:"Unknown error"}`,"ProjectsLoader");const m=a(),w=(b=m.app)==null?void 0:b.claude;t("app",{...m.app,claude:{...w,data:{...w==null?void 0:w.data,projects:[]},ui:{...w==null?void 0:w.ui,loadingProjects:!1,projectsError:v instanceof Error?v.message:"Failed to load projects",projectsInitialized:!0}}}),pe.error("Store updated with error state","ProjectsLoader")}},p=()=>{u()};return d.useEffect(()=>{e&&(l||n.current||(n.current=!0,u()))},[l,e]),{projects:o,loadingProjects:i,projectsError:c,projectsInitialized:l,loadProjects:u,refreshProjects:p}}function fd(){const[s,e]=d.useState(new Set),t=d.useCallback(a=>a?s.has(a):!1,[s]);return Sr(a=>{var o,i,c,l,u,p,h,f,b,v,m,w,y,g,x;if(a.type==="batch-modified")return;const n=a.sessionId;if(n){if(a.type==="session-started"&&e(j=>{const C=new Set(j);return C.add(n),C}),a.type==="session-ended"&&e(j=>{const C=new Set(j);return C.delete(n),C}),a.type==="session-opened"){const j=((c=(i=(o=Z.get("app"))==null?void 0:o.claude)==null?void 0:i.ui)==null?void 0:c.activity)??{},C={...j,[n]:{...j[n],isOpened:!0}};Z.update("app",{claude:{ui:{activity:C}}}),e(N=>{const S=new Set(N);return S.add(n),S})}if(a.type==="session-closed"){const j=((p=(u=(l=Z.get("app"))==null?void 0:l.claude)==null?void 0:u.ui)==null?void 0:p.activity)??{},C=((h=j[n])==null?void 0:h.isOpened)===!0||((f=j[n])==null?void 0:f.isProcessing)===!0,N={...j,[n]:{...j[n],isOpened:!!C,isProcessing:!1}};Z.update("app",{claude:{ui:{activity:N}}}),C||e(S=>{const D=new Set(S);return D.delete(n),D}),console.log("[useSessionRunningStatus] Session closed, keeping as opened:",C)}if(a.type==="session-processing-started"){const j=((m=(v=(b=Z.get("app"))==null?void 0:b.claude)==null?void 0:v.ui)==null?void 0:m.activity)??{},C={...j,[n]:{...j[n],isProcessing:!0,isOpened:!0}};Z.update("app",{claude:{ui:{activity:C}}}),e(N=>{const S=new Set(N);return S.add(n),S})}if(a.type==="session-processing-stopped"){const j=((g=(y=(w=Z.get("app"))==null?void 0:w.claude)==null?void 0:y.ui)==null?void 0:g.activity)??{},C={...j,[n]:{...j[n],isProcessing:!1}};Z.update("app",{claude:{ui:{activity:C}}}),(((x=C[n])==null?void 0:x.isOpened)??!1)||e(S=>{const D=new Set(S);return D.delete(n),D})}}},a=>{console.error("[useSessionRunningStatus] SSE connection error:",a)}),{isSessionRunning:t,runningSessions:s}}const Ra=768;function md(){const[s,e]=d.useState(void 0);return d.useEffect(()=>{const t=window.matchMedia(`(max-width: ${Ra-1}px)`),a=()=>{e(window.innerWidth<Ra)};return t.addEventListener("change",a),e(window.innerWidth<Ra),()=>t.removeEventListener("change",a)},[]),!!s}function R(...s){return gl(Ws(s))}const gd={default:"bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},xd=Cs("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive cursor-pointer",{variants:{variant:gd,size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",compact:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-1.2",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",smIcon:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 [&_svg:not([class*='size-'])]:size-3",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),ne=d.forwardRef(({className:s,variant:e,size:t,asChild:a=!1,...n},o)=>{const i=a?es:"button";return r.jsx(i,{"data-slot":"button",className:R(xd({variant:e,size:t,className:s})),ref:o,...n})});ne.displayName="Button";const Je=d.forwardRef(({className:s,type:e,...t},a)=>r.jsx("input",{type:e,className:R("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:a,...t}));Je.displayName="Input";const mo=d.forwardRef(({className:s,orientation:e="horizontal",decorative:t=!0,...a},n)=>r.jsx(Cn,{ref:n,decorative:t,orientation:e,className:R("shrink-0 bg-border",e==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...a}));mo.displayName=Cn.displayName;const bd=jn,vd=xr,go=d.forwardRef(({className:s,...e},t)=>r.jsx(ma,{className:R("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...e,ref:t}));go.displayName=ma.displayName;const wd=Cs("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),xo=d.forwardRef(({side:s="right",className:e,children:t,...a},n)=>r.jsxs(vd,{children:[r.jsx(go,{}),r.jsxs(Ss,{ref:n,className:R(wd({side:s}),e),...a,children:[r.jsxs(br,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[r.jsx(rt,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:"Close"})]}),t]})]}));xo.displayName=Ss.displayName;const bo=({className:s,...e})=>r.jsx("div",{className:R("flex flex-col space-y-2 text-center sm:text-left",s),...e});bo.displayName="SheetHeader";const vo=d.forwardRef(({className:s,...e},t)=>r.jsx(ga,{ref:t,className:R("text-lg font-semibold text-foreground",s),...e}));vo.displayName=ga.displayName;const wo=d.forwardRef(({className:s,...e},t)=>r.jsx(xa,{ref:t,className:R("text-sm text-muted-foreground",s),...e}));wo.displayName=xa.displayName;function Hr({className:s,...e}){return r.jsx("div",{className:R("animate-pulse rounded-md bg-primary/10",s),...e})}const Ue={xs:"w-3 h-3",sm:"w-4 h-4",md:"w-5 h-5",lg:"w-6 h-6"},xb={deleteButton:"text-red-600 hover:text-red-700 hover:bg-red-50"},bb={input:"bg-green-500",process:"bg-blue-500",output:"bg-red-500",text:"bg-blue-500",select:"bg-purple-500",audio:"bg-green-500",default:"bg-gray-500"},vb={base:"absolute w-4 h-4 bg-background rounded-full border-2 border-border transform -translate-y-1/2 cursor-crosshair z-10",input:"node-handle node-handle-input -left-2 top-1/2",output:"node-handle node-handle-output -right-2 top-1/2",hover:"hover:border-blue-400 hover:bg-accent",active:"border-blue-400 bg-accent"},yd={input:"w-full p-2 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background",textarea:"w-full p-3 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring resize-y bg-background",label:"text-xs font-medium text-foreground block mb-1",error:"text-destructive text-xs mt-1"},wb=.2,xt={popover:1500,skipLink:1600,tooltip:1800,backdrop:1550,draggablePopover:1560,draggablePopoverDropdown:1570,canvasArrows:1,canvasNodes:10,canvasResizeHandles:15,nodeTextarea:10,nodeAudioButton:20,nodeQuickPanel:40,mobileLogViewer:1650},Qs=Uc,Xs=Fc,Ys=Wc,ms=d.forwardRef(({className:s,sideOffset:e=4,style:t,...a},n)=>r.jsx($c,{children:r.jsx(Nn,{ref:n,sideOffset:e,className:R("overflow-hidden rounded-md border bg-card px-3 py-1.5 text-xs text-card-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",s),style:{zIndex:xt.tooltip,...t},...a})}));ms.displayName=Nn.displayName;class Sd{constructor(){J(this,"STORAGE_KEY","ui-store")}getStore(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to parse UI store from localStorage:",e),{}}}setStore(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save UI store to localStorage:",t)}}get(e){return this.getStore()[e]}set(e,t){const a=this.getStore();a[e]=t,this.setStore(a)}update(e,t){const a=this.getStore(),n=a[e]||{};a[e]={...n,...t},this.setStore(a)}remove(e){const t=this.getStore();delete t[e],this.setStore(t)}clear(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.error("Failed to clear UI store:",e)}}getAllData(){return this.getStore()}export(){return JSON.stringify(this.getStore(),null,2)}import(e){try{const t=JSON.parse(e);return this.setStore(t),!0}catch(t){return console.error("Failed to import UI store data:",t),!1}}}const qa=new Sd,Cd="16rem",jd="18rem",Nd="3rem",Ed="b",yo=d.createContext(null);function ss(){const s=d.useContext(yo);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const So=d.forwardRef(({defaultOpen:s=!0,open:e,onOpenChange:t,className:a,style:n,children:o,...i},c)=>{const l=md(),[u,p]=d.useState(!1),[h,f]=d.useState(()=>{const g=qa.get("sidebar");return(g==null?void 0:g.isOpen)??s}),b=e??h,v=d.useCallback(g=>{const x=typeof g=="function"?g(b):g;t?t(x):f(x),qa.update("sidebar",{isOpen:x})},[t,b]),m=d.useCallback(()=>l?p(g=>!g):v(g=>!g),[l,v,p]);d.useEffect(()=>{const g=x=>{x.key===Ed&&(x.metaKey||x.ctrlKey)&&(x.preventDefault(),m())};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[m]);const w=b?"expanded":"collapsed",y=d.useMemo(()=>({state:w,open:b,setOpen:v,isMobile:l,openMobile:u,setOpenMobile:p,toggleSidebar:m}),[w,b,v,l,u,p,m]);return r.jsx(yo.Provider,{value:y,children:r.jsx(Qs,{delayDuration:0,children:r.jsx("div",{style:{"--sidebar-width":Cd,"--sidebar-width-icon":Nd,...n},className:R("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",a),ref:c,...i,children:o})})})});So.displayName="SidebarProvider";const Co=d.forwardRef(({side:s="left",variant:e="sidebar",collapsible:t="offcanvas",className:a,children:n,...o},i)=>{d.useEffect(()=>{qa.update("sidebar",{side:s,variant:e})},[s,e]);const{isMobile:c,state:l,openMobile:u,setOpenMobile:p,toggleSidebar:h}=ss();return t==="none"?r.jsx("div",{className:R("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",a),ref:i,...o,children:n}):c?r.jsx(bd,{open:u,onOpenChange:p,...o,children:r.jsxs(xo,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":jd},side:s,children:[r.jsxs(bo,{className:"sr-only",children:[r.jsx(vo,{children:"Sidebar"}),r.jsx(wo,{children:"Displays the mobile sidebar."})]}),r.jsx("div",{className:"flex h-full w-full flex-col",children:n})]})}):r.jsxs("div",{ref:i,className:"group peer hidden text-sidebar-foreground md:block","data-state":l,"data-collapsible":l==="collapsed"?t:"","data-variant":e,"data-side":s,children:[r.jsx("div",{className:R("relative bg-transparent transition-[width] duration-200 ease-linear",e==="floating"?"w-0":"w-[--sidebar-width]","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",e==="floating"||e==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),l==="expanded"&&t==="offcanvas"&&r.jsx("div",{className:"fixed inset-0 z-[55] bg-black/50",onClick:h}),r.jsx("div",{className:R("fixed inset-y-0 z-[60] hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",e==="floating"||e==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",a),...o,children:r.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:n})})]})});Co.displayName="Sidebar";const jo=d.forwardRef(({className:s,onClick:e,...t},a)=>{const{toggleSidebar:n}=ss();return r.jsxs(ne,{ref:a,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:R("h-7 w-7",s),onClick:o=>{e==null||e(o),n()},...t,children:[r.jsx(xl,{}),r.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});jo.displayName="SidebarTrigger";const kd=d.forwardRef(({className:s,...e},t)=>{const{toggleSidebar:a}=ss();return r.jsx("button",{ref:t,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:a,title:"Toggle Sidebar",className:R("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...e})});kd.displayName="SidebarRail";const No=d.forwardRef(({className:s,...e},t)=>r.jsx("main",{ref:t,className:R("relative flex w-full flex-1 flex-col bg-background","md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow","peer-data-[collapsible=offcanvas]:ml-0 peer-data-[collapsible=offcanvas]:mr-0","peer-data-[variant=floating]:ml-0 peer-data-[variant=floating]:mr-0",s),...e}));No.displayName="SidebarInset";const Td=d.forwardRef(({className:s,...e},t)=>r.jsx(Je,{ref:t,"data-sidebar":"input",className:R("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...e}));Td.displayName="SidebarInput";const Eo=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,"data-sidebar":"header",className:R("flex flex-col gap-2 p-2",s),...e}));Eo.displayName="SidebarHeader";const Ad=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,"data-sidebar":"footer",className:R("flex flex-col gap-2 p-2",s),...e}));Ad.displayName="SidebarFooter";const Id=d.forwardRef(({className:s,...e},t)=>r.jsx(mo,{ref:t,"data-sidebar":"separator",className:R("mx-2 w-auto bg-sidebar-border",s),...e}));Id.displayName="SidebarSeparator";const ko=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,"data-sidebar":"content",className:R("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...e}));ko.displayName="SidebarContent";const Rd=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,"data-sidebar":"group",className:R("relative flex w-full min-w-0 flex-col p-2",s),...e}));Rd.displayName="SidebarGroup";const Pd=d.forwardRef(({className:s,asChild:e=!1,...t},a)=>{const n=e?es:"div";return r.jsx(n,{ref:a,"data-sidebar":"group-label",className:R("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...t})});Pd.displayName="SidebarGroupLabel";const _d=d.forwardRef(({className:s,asChild:e=!1,...t},a)=>{const n=e?es:"button";return r.jsx(n,{ref:a,"data-sidebar":"group-action",className:R("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...t})});_d.displayName="SidebarGroupAction";const Dd=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,"data-sidebar":"group-content",className:R("w-full text-sm",s),...e}));Dd.displayName="SidebarGroupContent";const To=d.forwardRef(({className:s,...e},t)=>r.jsx("ul",{ref:t,"data-sidebar":"menu",className:R("flex w-full min-w-0 flex-col gap-1",s),...e}));To.displayName="SidebarMenu";const cs=d.forwardRef(({className:s,...e},t)=>r.jsx("li",{ref:t,"data-sidebar":"menu-item",className:R("group/menu-item relative",s),...e}));cs.displayName="SidebarMenuItem";const Od=Cs("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),ls=d.forwardRef(({asChild:s=!1,isActive:e=!1,variant:t="default",size:a="default",tooltip:n,className:o,...i},c)=>{const l=s?es:"button",{isMobile:u,state:p}=ss(),h=r.jsx(l,{ref:c,"data-sidebar":"menu-button","data-size":a,"data-active":e,className:R(Od({variant:t,size:a}),o),...i});return n?(typeof n=="string"&&(n={children:n}),r.jsxs(Xs,{children:[r.jsx(Ys,{asChild:!0,children:h}),r.jsx(ms,{side:"right",align:"center",hidden:p!=="collapsed"||u,...n})]})):h});ls.displayName="SidebarMenuButton";const Md=d.forwardRef(({className:s,asChild:e=!1,showOnHover:t=!1,...a},n)=>{const o=e?es:"button";return r.jsx(o,{ref:n,"data-sidebar":"menu-action",className:R("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",t&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...a})});Md.displayName="SidebarMenuAction";const Ld=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,"data-sidebar":"menu-badge",className:R("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...e}));Ld.displayName="SidebarMenuBadge";const $d=d.forwardRef(({className:s,showIcon:e=!1,...t},a)=>{const n=d.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return r.jsxs("div",{ref:a,"data-sidebar":"menu-skeleton",className:R("flex h-8 items-center gap-2 rounded-md px-2",s),...t,children:[e&&r.jsx(Hr,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),r.jsx(Hr,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":n}})]})});$d.displayName="SidebarMenuSkeleton";const Ka=d.forwardRef(({className:s,...e},t)=>r.jsx("ul",{ref:t,"data-sidebar":"menu-sub",className:R("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...e}));Ka.displayName="SidebarMenuSub";const zs=d.forwardRef(({...s},e)=>r.jsx("li",{ref:e,...s}));zs.displayName="SidebarMenuSubItem";const Bs=d.forwardRef(({asChild:s=!1,size:e="md",isActive:t,className:a,...n},o)=>{const i=s?es:"a";return r.jsx(i,{ref:o,"data-sidebar":"menu-sub-button","data-size":e,"data-active":t,className:R("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",e==="sm"&&"text-xs",e==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",a),...n})});Bs.displayName="SidebarMenuSubButton";const Ud="audio-chunks-db",Fd=1,dt="chunks",De="metadata";class Wd{constructor(){J(this,"dbPromise");J(this,"initializationPromise");this.dbPromise=this.initDB(),this.initializationPromise=this.waitForDB()}async waitForDB(){await this.dbPromise}async waitForInitialization(){await this.initializationPromise}async initDB(){return new Promise((e,t)=>{const a=indexedDB.open(Ud,Fd);a.onupgradeneeded=n=>{const o=n.target.result;if(o.objectStoreNames.contains(dt)||o.createObjectStore(dt),!o.objectStoreNames.contains(De)){const i=o.createObjectStore(De);i.createIndex("sessionName","sessionName",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1}),i.createIndex("chunkNumber","chunkNumber",{unique:!1})}},a.onsuccess=n=>{e(n.target.result)},a.onerror=n=>{t(new Error(`IndexedDB error: ${n.target.error}`))}})}async saveChunk(e,t){var a;if(await this.waitForInitialization(),!e.blob)throw new Error("Cannot save chunk without blob data");try{const o=(await this.dbPromise).transaction([De,dt],"readwrite"),i=o.objectStore(De),c=o.objectStore(dt),l={id:e.id,chunkNumber:e.chunkNumber,startTime:e.startTime.toISOString(),endTime:(a=e.endTime)==null?void 0:a.toISOString(),duration:e.duration,size:e.size??e.blob.size,name:e.name,sessionName:t,transcription:e.transcription,transcriptionStatus:e.transcriptionStatus,transcriptionError:e.transcriptionError,createdAt:new Date().toISOString(),mimeType:e.blob.type};i.put(l,e.id),c.put(e.blob,e.id),await new Promise((u,p)=>{o.oncomplete=()=>u(),o.onerror=()=>p(new Error(`Transaction failed: ${o.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to save chunk:",n),n}}async loadChunksBySession(e){await this.waitForInitialization();try{const a=(await this.dbPromise).transaction([De,dt],"readonly"),n=a.objectStore(De),o=a.objectStore(dt),c=n.index("sessionName").getAll(e),l=await new Promise((p,h)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>h(new Error(`Failed to load metadata: ${c.error}`))});if(l.length===0)return[];const u=[];for(const p of l)try{const h=o.get(p.id),f=await new Promise((b,v)=>{h.onsuccess=()=>b(h.result),h.onerror=()=>v(new Error(`Failed to load blob: ${h.error}`))});if(f){const b={id:p.id,chunkNumber:p.chunkNumber,startTime:new Date(p.startTime),endTime:p.endTime?new Date(p.endTime):void 0,duration:p.duration,blob:f,size:p.size,name:p.name,transcription:p.transcription,transcriptionStatus:p.transcriptionStatus,transcriptionError:p.transcriptionError};u.push(b)}}catch(h){console.warn(`ðŸŽ¤ðŸ“¦ðŸ’¾ âš ï¸ Failed to load chunk ${p.id}:`,h)}return u.sort((p,h)=>p.chunkNumber-h.chunkNumber),u}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to load chunks:",t),t}}async updateChunkTranscription(e,t){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([De],"readwrite"),o=n.objectStore(De),i=o.get(e),c=await new Promise((u,p)=>{i.onsuccess=()=>u(i.result),i.onerror=()=>p(new Error(`Failed to get metadata: ${i.error}`))});if(!c)throw new Error(`Chunk not found: ${e}`);const l={...c,transcription:t,transcriptionStatus:"completed"};o.put(l,e),await new Promise((u,p)=>{n.oncomplete=()=>u(),n.onerror=()=>p(new Error(`Transaction failed: ${n.error}`))})}catch(a){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription:",a),a}}async updateChunkTranscriptionStatus(e,t,a){await this.waitForInitialization();try{const o=(await this.dbPromise).transaction([De],"readwrite"),i=o.objectStore(De),c=i.get(e),l=await new Promise((p,h)=>{c.onsuccess=()=>p(c.result),c.onerror=()=>h(new Error(`Failed to get metadata: ${c.error}`))});if(!l)throw new Error(`Chunk not found: ${e}`);const u={...l,transcriptionStatus:t,transcriptionError:a};i.put(u,e),await new Promise((p,h)=>{o.oncomplete=()=>p(),o.onerror=()=>h(new Error(`Transaction failed: ${o.error}`))})}catch(n){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to update transcription status:",n),n}}async deleteChunk(e){await this.waitForInitialization();try{const a=(await this.dbPromise).transaction([De,dt],"readwrite"),n=a.objectStore(De),o=a.objectStore(dt);n.delete(e),o.delete(e),await new Promise((i,c)=>{a.oncomplete=()=>i(),a.onerror=()=>c(new Error(`Transaction failed: ${a.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunk:",t),t}}async deleteChunksBySession(e){await this.waitForInitialization();try{const a=(await this.dbPromise).transaction([De,dt],"readwrite"),n=a.objectStore(De),o=a.objectStore(dt),c=n.index("sessionName").getAll(e),l=await new Promise((u,p)=>{c.onsuccess=()=>u(c.result),c.onerror=()=>p(new Error(`Failed to load metadata: ${c.error}`))});for(const u of l)n.delete(u.id),o.delete(u.id);await new Promise((u,p)=>{a.oncomplete=()=>u(),a.onerror=()=>p(new Error(`Transaction failed: ${a.error}`))})}catch(t){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to delete chunks by session:",t),t}}async getAllSessions(){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([De],"readonly").objectStore(De).getAll(),o=await new Promise((c,l)=>{n.onsuccess=()=>c(n.result),n.onerror=()=>l(new Error(`Failed to load all metadata: ${n.error}`))});return[...new Set(o.map(c=>c.sessionName))].sort()}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get all sessions:",e),e}}async getStorageStats(){await this.waitForInitialization();try{const n=(await this.dbPromise).transaction([De],"readonly").objectStore(De).getAll(),o=await new Promise((l,u)=>{n.onsuccess=()=>l(n.result),n.onerror=()=>u(new Error(`Failed to load all metadata: ${n.error}`))}),i=o.reduce((l,u)=>l+u.size,0),c=new Set(o.map(l=>l.sessionName)).size;return{totalChunks:o.length,totalSize:i,sessionCount:c}}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to get storage stats:",e),e}}async clearAllData(){await this.waitForInitialization();try{const t=(await this.dbPromise).transaction([De,dt],"readwrite"),a=t.objectStore(De),n=t.objectStore(dt);a.clear(),n.clear(),await new Promise((o,i)=>{t.oncomplete=()=>o(),t.onerror=()=>i(new Error(`Transaction failed: ${t.error}`))})}catch(e){throw console.error("ðŸŽ¤ðŸ“¦ðŸ’¾ âŒ Failed to clear all data:",e),e}}}const st=new Wd,Pa="vocabulary-lists",bt="default";class zd{getAllLists(){try{const e=localStorage.getItem(Pa);return e?JSON.parse(e).map(a=>({...a,createdAt:new Date(a.createdAt),updatedAt:new Date(a.updatedAt)})):[this.createDefaultList()]}catch(e){return console.error("Failed to load vocabulary lists:",e),[this.createDefaultList()]}}getListById(e){return this.getAllLists().find(a=>a.id===e)??null}createList(e){const t=this.getAllLists(),a={id:`list-${Date.now()}`,name:e,createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(a),this.saveLists(t),a}updateList(e,t){const a=this.getAllLists(),n=a.findIndex(o=>o.id===e);return n===-1?null:(a[n]={...a[n],...t,updatedAt:new Date},this.saveLists(a),a[n])}async deleteList(e){const t=this.getAllLists();if(t.length<=1)return console.warn("Cannot delete the last vocabulary list"),!1;if(e===bt){const n=t.find(o=>o.id===bt);if(n&&n.entryCount>0&&t.length===1)return console.warn("Cannot delete default list with data when it's the only list"),!1}const a=t.filter(n=>n.id!==e);return this.saveLists(a),localStorage.removeItem(`vocabulary-entries-${e}`),await st.deleteChunksBySession(`vocabulary-session-${e}`),!0}getDefaultListId(){return this.getAllLists().find(a=>a.id===bt)||this.createDefaultList(),bt}updateEntryCount(e,t){this.updateList(e,{entryCount:t})}migrateOldData(){const e="vocabulary-entries",t=localStorage.getItem(e);if(!t)return!1;try{this.getAllLists().find(c=>c.id===bt)??(n=this.createDefaultList());const o=`vocabulary-entries-${bt}`;if(!localStorage.getItem(o)){localStorage.setItem(o,t);const c=JSON.parse(t);return this.updateEntryCount(bt,c.length),localStorage.removeItem(e),console.log("Migrated old vocabulary data to default list"),!0}return localStorage.removeItem(e),!1}catch(a){return console.error("Failed to migrate vocabulary data:",a),!1}}createDefaultList(){const e=localStorage.getItem(Pa);let t=[];if(e)try{t=JSON.parse(e).map(i=>({...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)}));const o=t.find(i=>i.id===bt);if(o)return o}catch(n){console.error("Error parsing stored lists:",n),t=[]}const a={id:bt,name:"Default",createdAt:new Date,updatedAt:new Date,entryCount:0};return t.push(a),this.saveLists(t),a}saveLists(e){localStorage.setItem(Pa,JSON.stringify(e))}}const _a=new zd,Gr=zc,Vr=Bc,qr=Hc,Bd="modulepreload",Hd=function(s){return"/"+s},Kr={},ze=function(e,t,a){let n=Promise.resolve();if(t&&t.length>0){let i=function(u){return Promise.all(u.map(p=>Promise.resolve(p).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));n=i(t.map(u=>{if(u=Hd(u),u in Kr)return;Kr[u]=!0;const p=u.endsWith(".css"),h=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${h}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":Bd,p||(f.as="script"),f.crossOrigin="",f.href=u,l&&f.setAttribute("nonce",l),document.head.appendChild(f),p)return new Promise((b,v)=>{f.addEventListener("load",b),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function o(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return n.then(i=>{for(const c of i||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})},Da=d.lazy(()=>ze(()=>import("./HomePage-KyBYgbzI.js"),__vite__mapDeps([0,1,2,3,4,5,6])).then(s=>({default:s.HomePage}))),Gd=d.lazy(()=>ze(()=>import("./Chat-Bx6-Bykp.js"),__vite__mapDeps([7,1,8,9,10,11,2,4,5,6])).then(s=>({default:s.Chat}))),Vd=d.lazy(()=>ze(()=>import("./Settings-CTyrB4-B.js"),__vite__mapDeps([12,1,8,2,4,5,6])).then(s=>({default:s.Settings}))),Jr=d.lazy(()=>ze(()=>import("./Demo-ChGHWAOm.js"),__vite__mapDeps([13,1,14,5,2,4,6])).then(s=>({default:s.Demo}))),Qr=d.lazy(()=>ze(()=>import("./Content-pNSnt4ev.js"),__vite__mapDeps([15,1,8,2,4,5,6])).then(s=>({default:s.Content}))),qd=d.lazy(()=>ze(()=>import("./TablePage-DU9Eh4aH.js"),__vite__mapDeps([16,1,17,18,4,5,6,2])).then(s=>({default:s.TablePage}))),Xr=d.lazy(()=>ze(()=>import("./VocabularyPage-CX-nSon9.js"),__vite__mapDeps([19,1,17,18,11,20,21,22,2,4,5,6])).then(s=>({default:s.VocabularyPage}))),Kd=d.lazy(()=>ze(()=>import("./LiveTranscriptionPage-Cv5ZDf8k.js"),__vite__mapDeps([23,1,11,2,4,5,6])).then(s=>({default:s.LiveTranscriptionPage}))),Jd=d.lazy(()=>ze(()=>import("./AudioPanelDemo-B0ypglEb.js"),__vite__mapDeps([24,1,4,5,6,2])).then(s=>({default:s.AudioPanelDemo}))),Qd=d.lazy(()=>ze(()=>import("./ClaudePage-BrDFzXLG.js"),__vite__mapDeps([25,1,26,27,5,2,28,4,6])).then(s=>({default:s.ClaudePage}))),Xd=d.lazy(()=>ze(()=>import("./SessionDetailsPage-D4Q6KUqx.js"),__vite__mapDeps([29,1,26,27,5,2,28,4,6])).then(s=>({default:s.SessionDetailsPage}))),Oa=d.lazy(()=>ze(()=>import("./KanbanPage-B9KpW4gx.js"),__vite__mapDeps([30,1,31,14,5,2,32,33,4,6])).then(s=>({default:s.KanbanPage}))),Yd=d.lazy(()=>ze(()=>import("./KanbanDataPage-DFk-8cAL.js"),__vite__mapDeps([34,1,35,14,5,2,4,6])).then(s=>({default:s.KanbanDataPage}))),Zd=d.lazy(()=>ze(()=>import("./index-2tJLVElX.js"),__vite__mapDeps([36,1,2,4,5,6])).then(s=>({default:s.ActionTodoPage}))),eu=d.lazy(()=>ze(()=>import("./GlobalStatePage-T70_8ei8.js"),__vite__mapDeps([37,1,35,4,5,2,6])).then(s=>({default:s.GlobalStatePage}))),tu=d.lazy(()=>ze(()=>import("./GamePage-BcUksn-g.js"),__vite__mapDeps([38,1,2,11,4,5,6])).then(s=>({default:s.GamePage}))),su=d.lazy(()=>ze(()=>import("./NewHomeApp-BLcvfOeC.js"),__vite__mapDeps([39,1,6,4,5,2,40,41,42,43,44,22,20,11,45,46,33,47,48,49,50,51,52,53,54,35,27,55])).then(s=>({default:s.NewHomeApp})));function au(){return r.jsx("div",{className:"page-loader flex items-center justify-center h-full",children:r.jsx("div",{className:"page-loader-spinner animate-pulse text-muted-foreground",children:"Loading..."})})}const Zs=[{path:"/",element:Da,title:"Watcher",icon:zr,label:"Home",showInSidebar:!0},{path:"/new-home",element:su,title:"New Home",icon:zr,label:"New Home",showInSidebar:!0},{path:"/chat",element:Gd,title:"Chat with Ollama",icon:bl,label:"Chat",showInSidebar:!0},{path:"/settings",element:Vd,title:"Settings",icon:At,label:"Settings",showInSidebar:!0},{path:"/claude",element:Qd,title:"Claude",icon:Yn,label:"Claude",showInSidebar:!0},{path:"/claude/:sessionId",element:Xd,title:"Claude",showInSidebar:!1},{path:"/state",element:eu,title:"Global State",icon:vl,label:"Global State",showInSidebar:!0},{path:"/game",element:tu,title:"Multiplayer Games",icon:wl,label:"Games",showInSidebar:!0},{path:"/todo",element:Oa,title:"Todo",icon:Zn,label:"Todo",showInSidebar:!0,group:"collapsible",children:[{path:"/todo",element:Oa,title:"Todo",icon:yl,label:"Overview",showInSidebar:!0},{path:"/todo/kanban",element:Oa,title:"Kanban Board",icon:Sl,label:"Kanban Board",showInSidebar:!0},{path:"/todo/kanban/data",element:Yd,title:"Kanban Data",icon:Cl,label:"Data",showInSidebar:!0},{path:"/todo/action",element:Zd,title:"Action Todo",icon:jl,label:"Action-Driven",showInSidebar:!0}]},{path:"/content",element:Qr,title:"Content",icon:Nl,label:"Content",showInSidebar:!0},{path:"/content/:contentId",element:Qr,title:"Content",showInSidebar:!1},{path:"/active-recording",element:Da,title:"Active Recording",icon:eo,label:"Active Recording",showInSidebar:!0},{path:"/vocabulary",element:Xr,title:"Vocabulary",icon:to,label:"Vocabulary",showInSidebar:!0,group:"collapsible-vocabulary"},{path:"/vocabulary/:listId",element:Xr,title:"Vocabulary",showInSidebar:!1},{path:"/live-transcription",element:Kd,title:"Live Transcription",icon:so,label:"Live Transcription",showInSidebar:!0},{path:"/table",element:qd,title:"Table Demo",icon:ao,label:"Table Demo",showInSidebar:!0},{path:"/demo",element:Jr,title:"Demo",icon:ro,label:"Demo",showInSidebar:!0},{path:"/demo/*",element:Jr,title:"Demo",showInSidebar:!1},{path:"/demo/audio-panel",element:Jd,title:"Audio Panel Demo",icon:no,label:"Audio Panel Demo",showInSidebar:!0},{path:"/realtime",element:Da,title:"Real-time Audio",showInSidebar:!1}];function ru(s){const e=Zs.find(t=>t.children&&t.children.find(n=>n.path===s)?!0:t.path===s);if(e){if(e.children){const t=e.children.find(a=>a.path===s);if(t)return t.title}return e.title}for(const t of Zs){if(s.startsWith(t.path.split("/:")[0]))return t.title;if(t.children){for(const a of t.children)if(s.startsWith(a.path.split("/:")[0]))return a.title}}return"Watcher"}function nu({logger:s,logs:e}){return r.jsx(d.Suspense,{fallback:r.jsx(au,{}),children:r.jsx(Ac,{children:Zs.map(t=>{const a=t.element,n=r.jsx(a,{logger:s,logs:e});return t.children?t.children.map(o=>{const i=o.element;return r.jsx(Fr,{path:o.path,element:r.jsx(i,{logger:s})},o.path)}):r.jsx(Fr,{path:t.path,element:n},t.path)})})})}function ou(){const{open:s,toggleSidebar:e}=ss();return r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h2",{className:"text-lg font-semibold px-2",children:"Menu"}),s&&r.jsx(ne,{variant:"ghost",size:"icon",onClick:e,className:"h-7 w-7",children:r.jsx(js,{className:"w-4 h-4"})})]})}function iu(){const s=Sn(),e=gr(),{isMobile:t,setOpen:a,setOpenMobile:n}=ss(),{actions:o}=po(),[i,c]=d.useState([]),[l,u]=d.useState(!1),[p,h]=d.useState(!1);d.useEffect(()=>{const m=_a.getAllLists();c(m)},[e.pathname]),d.useEffect(()=>{e.pathname.startsWith("/vocabulary")&&u(!0)},[e.pathname]),d.useEffect(()=>{e.pathname.startsWith("/todo")&&h(!0)},[e.pathname]);const f=d.useCallback((m,w)=>{m.ctrlKey||m.metaKey||m.button===1||(m.preventDefault(),s(w),t?n(!1):a(!1))},[s,t,a,n]),b=d.useCallback(async()=>{try{o.info("Fetching logs from /logs endpoint...");const w=await(await fetch("/logs")).json();console.log("Logs response:",w),o.info("Logs endpoint response logged to console")}catch(m){o.error(`Failed to fetch logs: ${m}`),console.error("Failed to fetch logs:",m)}t?n(!1):a(!1)},[o,t,a,n]),v=d.useCallback(()=>{const m=prompt("Enter a name for the new vocabulary list:");if(m!=null&&m.trim()){const w=_a.createList(m.trim());c(_a.getAllLists()),s(`/vocabulary/${w.id}`),t?n(!1):a(!1)}},[s,t,a,n]);return r.jsxs(To,{children:[Zs.filter(m=>m.showInSidebar).map(m=>m.group==="collapsible"&&m.children?r.jsx(Gr,{open:p,onOpenChange:h,className:"group/collapsible",children:r.jsxs(cs,{children:[r.jsx(Vr,{asChild:!0,children:r.jsxs(ls,{children:[m.icon&&r.jsx(m.icon,{className:"w-4 h-4"}),m.label,r.jsx(Ht,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),r.jsx(qr,{children:r.jsx(Ka,{children:m.children.filter(w=>w.showInSidebar).map(w=>r.jsx(zs,{children:r.jsx(Bs,{asChild:!0,isActive:e.pathname===w.path,children:r.jsxs("a",{href:w.path,onClick:y=>f(y,w.path),children:[w.icon&&r.jsx(w.icon,{className:"w-4 h-4"}),w.label]})})},w.path))})})]})},m.path):m.group==="collapsible-vocabulary"?r.jsx(Gr,{open:l,onOpenChange:u,className:"group/collapsible",children:r.jsxs(cs,{children:[r.jsx(Vr,{asChild:!0,children:r.jsxs(ls,{children:[m.icon&&r.jsx(m.icon,{className:"w-4 h-4"}),m.label,r.jsx(Ht,{className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"})]})}),r.jsx(qr,{children:r.jsxs(Ka,{children:[i.map(w=>r.jsx(zs,{children:r.jsx(Bs,{asChild:!0,isActive:e.pathname===`/vocabulary/${w.id}`,children:r.jsxs("a",{href:`/vocabulary/${w.id}`,onClick:y=>f(y,`/vocabulary/${w.id}`),children:[w.name,w.entryCount>0&&r.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:w.entryCount})]})})},w.id)),r.jsx(zs,{children:r.jsxs(Bs,{onClick:v,children:[r.jsx(Ks,{className:"w-4 h-4"}),"Create New List"]})})]})})]})},m.path):r.jsx(cs,{children:r.jsx(ls,{asChild:!0,isActive:e.pathname===m.path,children:r.jsxs("a",{href:m.path,onClick:w=>f(w,m.path),children:[m.icon&&r.jsx(m.icon,{className:"w-4 h-4"}),m.label]})})},m.path)),r.jsx(cs,{children:r.jsxs(ls,{onClick:b,children:[r.jsx(vr,{className:"w-4 h-4"}),"Logs"]})})]})}function cu(){return r.jsxs(Co,{variant:"floating",collapsible:"offcanvas",children:[r.jsx(Eo,{children:r.jsx(ou,{})}),r.jsx(ko,{children:r.jsx(iu,{})})]})}const Ja=s=>{if(s==null)return s;if(typeof s=="number")return Math.round(s*10)/10;if(Array.isArray(s))return s.map(Ja);if(typeof s=="object"){const e={};for(const[t,a]of Object.entries(s))e[t]=Ja(a);return e}return s};class Cr{constructor(e="http://localhost:3030/client-logs",t=5e3,a=!1){J(this,"baseUrl");J(this,"timeout");J(this,"sessionId");J(this,"shouldLogToConsole");this.baseUrl=e,this.timeout=t,this.shouldLogToConsole=a,this.sessionId=`todo-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}async sendLogs(e,t,a){const n=t?Ja(t):void 0;this.shouldLogToConsole&&console.log(`[${a||"client.log"}] ${e}`,n?JSON.stringify(n,null,2):"");try{const o={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),customLogFile:a,logs:{[e]:[`${e}`]},metadata:n},i=await this.fetchWithTimeout(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw console.error("[ClientLogs] HTTP error:",i.status),new Error(`HTTP ${i.status}`);return await i.json()}catch(o){return console.error("[ClientLogs] Failed to send:",o),null}}sendBeacon(e,t){console.log("[ClientLogs] Sending beacon:",{message:e,metadata:t});try{const a={sessionId:this.sessionId,testFile:"TodoApp",testSuite:"UserActions",timestamp:new Date().toISOString(),logs:{[e]:[`${e}`]},metadata:t};if(typeof navigator<"u"&&navigator.sendBeacon){const n=this.baseUrl.startsWith("http")?this.baseUrl:`${window.location.origin}${this.baseUrl}`,o=new Blob([JSON.stringify(a)],{type:"application/json"}),i=navigator.sendBeacon(n,o);return i?console.log("[ClientLogs] Beacon accepted"):console.warn("[ClientLogs] Beacon rejected (queue full?)"),i}else return console.log("[ClientLogs] sendBeacon not available, using fetch fallback"),fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),keepalive:!0}).catch(n=>{console.error("[ClientLogs] Fetch fallback failed:",n)}),!0}catch(a){return console.error("[ClientLogs] Failed to send beacon:",a),!1}}async clearLogs(e="client.log",t){if(t&&typeof window<"u"&&window.location.pathname!==t)return!1;try{const a=`${this.baseUrl}?customLogFile=${encodeURIComponent(e)}&confirm=true`,n=await this.fetchWithTimeout(a,{method:"DELETE",headers:{"Content-Type":"application/json"}});return n.ok?(await n.json()).success:(console.error("[ClientLogs] Failed to clear logs:",n.status),!1)}catch(a){return console.error("[ClientLogs] Failed to clear logs:",a),!1}}async clearJsonLogs(e){try{const a=`${this.baseUrl.replace("/client-logs","/client-logs-json")}?filename=${encodeURIComponent(e)}&confirm=true`,n=await this.fetchWithTimeout(a,{method:"DELETE",headers:{"Content-Type":"application/json"}});return n.ok?!0:(console.error("[ClientLogs] Failed to clear JSON logs:",n.status),!1)}catch(t){return console.error("[ClientLogs] Failed to clear JSON logs:",t),!1}}async clearLogsAndAddVersion(e,t,a){const n=await this.clearLogs(e,a);return n&&await this.sendLogs("startup",{v:t},e),n}async fetchWithTimeout(e,t){const a=new AbortController,n=setTimeout(()=>a.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:a.signal});return clearTimeout(n),o}catch(o){throw clearTimeout(n),o instanceof Error&&o.name==="AbortError"?new Error("Request timeout"):o}}}new Cr;const lu={theme:"system",setTheme:()=>null},Ao=d.createContext(lu);function du({children:s,defaultTheme:e="system",storageKey:t="vite-ui-theme",...a}){const[n,o]=d.useState(()=>localStorage.getItem(t)||e);d.useEffect(()=>{const c=window.document.documentElement;if(c.classList.remove("light","dark"),n==="system"){const l=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";c.classList.add(l);return}c.classList.add(n)},[n]);const i={theme:n,setTheme:c=>{localStorage.setItem(t,c),o(c)}};return r.jsx(Ao.Provider,{...a,value:i,children:s})}const uu=()=>{const s=d.useContext(Ao);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s};function pu(){const{theme:s,setTheme:e}=uu(),t=()=>{e(s==="dark"?"light":"dark")},a=s==="dark"||s==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;return r.jsx(ne,{onClick:t,variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","aria-label":a?"Switch to light mode":"Switch to dark mode",children:a?r.jsx(El,{className:"h-5 w-5"}):r.jsx(kl,{className:"h-5 w-5"})})}const Ge=Gc,Xe=Vc,Io=Kc,We=d.forwardRef(({className:s,align:e="center",sideOffset:t=4,style:a,...n},o)=>r.jsx(qc,{children:r.jsx(En,{ref:o,align:e,sideOffset:t,style:{zIndex:xt.popover,...a},className:R("w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...n})}));We.displayName=En.displayName;function hu(s){return"initialConfig"in s&&typeof s.children=="function"}function wa(s){if(hu(s)){const{storageKey:b,initialConfig:v,children:m,prefix:w="watcher-"}=s,y=`${w}${b}`,[g,x]=d.useState(()=>{try{const S=localStorage.getItem(y);if(S)return JSON.parse(S)}catch(S){console.error(`Failed to load config from localStorage (${y}):`,S)}return v}),[j,C]=d.useState(!1);d.useEffect(()=>{try{localStorage.setItem(y,JSON.stringify(g))}catch(S){console.error(`Failed to save config to localStorage (${y}):`,S)}},[g,y]);const N=d.useMemo(()=>({buttonLabel:S,icon:D=r.jsx(At,{className:"h-4 w-4"}),variant:W="ghost",size:E="icon",buttonClassName:I="",contentClassName:_="",contentStyle:U,align:k="end",side:M="bottom",title:O,children:A})=>r.jsxs(Ge,{open:j,onOpenChange:C,"data-test":"config-popover",children:[r.jsx(Xe,{asChild:!0,children:r.jsx(ne,{variant:W,size:E,className:`config-button ${I}`,title:O||"Configuration","data-test":"config-button",children:S?r.jsxs(r.Fragment,{children:[D,S&&r.jsx("span",{className:"ml-2","data-test":"config-button-label",children:S})]}):D})}),r.jsxs(We,{className:`config-panel ${_}`,style:U,align:k,side:M,"data-test":"config-panel",onInteractOutside:P=>{P.target.closest(".config-panel")&&P.preventDefault()},onPointerDownOutside:P=>{P.target.closest(".config-panel")&&P.preventDefault()},children:[O&&r.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:r.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:O})}),r.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:A})]})]}),[j,C]);return r.jsx(r.Fragment,{children:m(g,x,N)})}const{children:e,buttonLabel:t,icon:a=r.jsx(At,{className:"h-4 w-4"}),variant:n="ghost",size:o="icon",buttonClassName:i="",contentClassName:c="",align:l="end",side:u="bottom",title:p}=s,[h,f]=d.useState(!1);return r.jsxs(Ge,{open:h,onOpenChange:f,"data-test":"config-popover",children:[r.jsx(Xe,{asChild:!0,children:r.jsx(ne,{variant:n,size:o,className:`config-button ${i}`,title:p||"Configuration","data-test":"config-button",children:t?r.jsxs(r.Fragment,{children:[a,t&&r.jsx("span",{className:"ml-2","data-test":"config-button-label",children:t})]}):a})}),r.jsxs(We,{className:`config-panel ${c}`,align:l,side:u,"data-test":"config-panel",onInteractOutside:b=>{b.target.closest(".config-panel")&&b.preventDefault()},onPointerDownOutside:b=>{b.target.closest(".config-panel")&&b.preventDefault()},children:[p&&r.jsx("div",{className:"config-panel-header pb-2 mb-2 border-b border-border","data-test":"config-panel-header",children:r.jsx("h3",{className:"text-sm font-semibold","data-test":"config-panel-title",children:p})}),r.jsx("div",{className:"config-panel-content","data-test":"config-panel-content",children:e})]})]})}const wt=d.forwardRef(({className:s,...e},t)=>r.jsx(kn,{ref:t,className:R("peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...e,children:r.jsx(Jc,{className:R("flex items-center justify-center text-current"),children:r.jsx(et,{className:"h-4 w-4"})})}));wt.displayName=kn.displayName;const fu=Cs("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),le=d.forwardRef(({className:s,...e},t)=>r.jsx(Tn,{ref:t,className:R(fu(),s),...e}));le.displayName=Tn.displayName;const mu=Cs("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}}),tt=d.forwardRef(({className:s,variant:e,...t},a)=>r.jsx("div",{ref:a,className:R(mu({variant:e}),s),...t}));tt.displayName="Badge";function Qa({value:s,options:e,onChange:t,placeholder:a="Search...",disabled:n=!1}){const[o,i]=d.useState(!1),[c,l]=d.useState(""),u=e.find(f=>f.value===s),p=e.filter(f=>f.label.toLowerCase().includes(c.toLowerCase())),h=f=>{t==null||t(f),i(!1),l("")};return u?r.jsxs(Ge,{open:o,onOpenChange:i,children:[r.jsx(Xe,{asChild:!0,children:r.jsx(tt,{variant:u.variant||"secondary",className:R("cursor-pointer hover:opacity-80 transition-opacity",u.className,n&&"opacity-50 cursor-not-allowed"),onClick:f=>{f.stopPropagation(),n&&f.preventDefault()},children:u.label})}),r.jsx(We,{className:"popover-content w-64 p-2",align:"start",children:r.jsxs("div",{className:"selector-container space-y-2",children:[r.jsx(Je,{placeholder:a,value:c,onChange:f=>l(f.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),r.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:p.length===0?r.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):p.map(f=>r.jsxs(ne,{variant:"ghost",className:R("option-item w-full justify-between h-8 px-2",f.value===s&&"bg-accent"),onClick:()=>h(f.value),children:[r.jsx(tt,{variant:f.variant||"secondary",className:R("text-xs",f.className),children:f.label}),f.value===s&&r.jsx(et,{className:"check-icon h-4 w-4"})]},f.value))})]})})]}):null}const It=Qc,Rt=Xc,jt=d.forwardRef(({className:s,children:e,...t},a)=>r.jsxs(An,{ref:a,className:R("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),...t,children:[e,r.jsx(Yc,{asChild:!0,children:r.jsx(ts,{className:"h-4 w-4 opacity-50"})})]}));jt.displayName=An.displayName;const Ro=d.forwardRef(({className:s,...e},t)=>r.jsx(Pn,{ref:t,className:R("flex cursor-default items-center justify-center py-1",s),...e,children:r.jsx(wr,{className:"h-4 w-4"})}));Ro.displayName=Pn.displayName;const Po=d.forwardRef(({className:s,...e},t)=>r.jsx(_n,{ref:t,className:R("flex cursor-default items-center justify-center py-1",s),...e,children:r.jsx(ts,{className:"h-4 w-4"})}));Po.displayName=_n.displayName;const Nt=d.forwardRef(({className:s,children:e,position:t="popper",style:a,...n},o)=>r.jsx(Zc,{children:r.jsxs(In,{ref:o,style:{zIndex:xt.tooltip,...a},className:R("relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",t==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:t,...n,children:[r.jsx(Ro,{}),r.jsx(el,{className:R("p-1",t==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:e}),r.jsx(Po,{})]})}));Nt.displayName=In.displayName;const gu=d.forwardRef(({className:s,...e},t)=>r.jsx(Dn,{ref:t,className:R("px-2 py-1.5 text-sm font-semibold",s),...e}));gu.displayName=Dn.displayName;const we=d.forwardRef(({className:s,children:e,...t},a)=>r.jsxs(Rn,{ref:a,className:R("relative flex w-full cursor-default select-none items-start rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[r.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center mt-0.5",children:r.jsx(tl,{children:r.jsx(et,{className:"h-4 w-4"})})}),r.jsx(sl,{className:"flex-1",children:e})]}));we.displayName=Rn.displayName;const xu=d.forwardRef(({className:s,...e},t)=>r.jsx(On,{ref:t,className:R("-mx-1 my-1 h-px bg-muted",s),...e}));xu.displayName=On.displayName;const ea=jn,yb=al,bu=xr,_o=d.forwardRef(({className:s,style:e,...t},a)=>r.jsx(ma,{ref:a,className:R("fixed inset-0 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),style:{zIndex:xt.popover,...e},...t}));_o.displayName=ma.displayName;const ta=d.forwardRef(({className:s,children:e,style:t,...a},n)=>r.jsxs(bu,{children:[r.jsx(_o,{}),r.jsxs(Ss,{ref:n,className:R("fixed left-[50%] top-[50%] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),style:{zIndex:xt.popover,...t},...a,children:[e,r.jsxs(br,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[r.jsx(rt,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));ta.displayName=Ss.displayName;const sa=({className:s,...e})=>r.jsx("div",{className:R("flex flex-col space-y-1.5 text-center sm:text-left",s),...e});sa.displayName="DialogHeader";const vu=({className:s,...e})=>r.jsx("div",{className:R("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...e});vu.displayName="DialogFooter";const gs=d.forwardRef(({className:s,...e},t)=>r.jsx(ga,{ref:t,className:R("text-lg font-semibold leading-none tracking-tight",s),...e}));gs.displayName=ga.displayName;const Do=d.forwardRef(({className:s,...e},t)=>r.jsx(xa,{ref:t,className:R("text-sm text-muted-foreground",s),...e}));Do.displayName=xa.displayName;const ya=d.forwardRef(({className:s,...e},t)=>r.jsx(Ye,{ref:t,className:R("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...e}));ya.displayName=Ye.displayName;const Oo=({children:s,value:e,onValueChange:t,filter:a,shouldFilter:n,...o})=>r.jsx(ea,{modal:!1,...o,children:r.jsx(xr,{children:r.jsxs(Ss,{className:R("overflow-hidden p-0 fixed inset-x-0 top-[10%] mx-auto max-w-2xl w-full z-[60]","gap-4 border bg-background shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:slide-out-to-top-8 data-[state=open]:slide-in-from-top-8","sm:rounded-lg"),"data-test":"command-dialog",children:[r.jsx(gs,{className:"sr-only",children:"Command Palette"}),r.jsx(ya,{value:e,onValueChange:t,filter:a,shouldFilter:n,className:"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5",children:s}),r.jsxs(br,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[r.jsx(rt,{className:"h-4 w-4"}),r.jsx("span",{className:"sr-only",children:"Close"})]})]})})}),Sa=d.forwardRef(({className:s,...e},t)=>r.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[r.jsx(ba,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),r.jsx(Ye.Input,{ref:t,className:R("flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...e})]}));Sa.displayName=Ye.Input.displayName;const Ns=d.forwardRef(({className:s,...e},t)=>r.jsx(Ye.List,{ref:t,className:R("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...e}));Ns.displayName=Ye.List.displayName;const Es=d.forwardRef((s,e)=>r.jsx(Ye.Empty,{ref:e,className:"py-6 text-center text-sm",...s}));Es.displayName=Ye.Empty.displayName;const Xt=d.forwardRef(({className:s,...e},t)=>r.jsx(Ye.Group,{ref:t,className:R("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...e}));Xt.displayName=Ye.Group.displayName;const Xa=d.forwardRef(({className:s,...e},t)=>r.jsx(Ye.Separator,{ref:t,className:R("-mx-1 h-px bg-border",s),...e}));Xa.displayName=Ye.Separator.displayName;const Dt=d.forwardRef(({className:s,...e},t)=>r.jsx(Ye.Item,{ref:t,className:R("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s),...e}));Dt.displayName=Ye.Item.displayName;const Et="__no_project__",wu=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.projects)??[]},yu=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.loadingProjects)??!1},Su=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.projectsError)??null},Cu=s=>{var e,t,a;return(a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.selectedProjectPath};function Mo({variant:s="badge",className:e,multiSelect:t=!1,value:a,onChange:n}){const[o,i]=d.useState(!1),c=n!==void 0,l=Ae(wu),u=Ae(yu),p=Ae(Su),h=Ae(Cu),f=c?a:h,b=t?Array.isArray(f)?f:f?[f]:[]:null,v=d.useCallback(g=>{var C,N,S;const x=l.find(D=>D.id===g||D.path===g),j=(x==null?void 0:x.path)??g;if(c)n(g);else{const D=Z.getState();Z.updateState({app:{...D.app,claude:{...(C=D.app)==null?void 0:C.claude,ui:{...(S=(N=D.app)==null?void 0:N.claude)==null?void 0:S.ui,selectedProjectPath:j}}}})}},[c,n,l]),m=d.useCallback(g=>{if(!t||!b)return;const x=l.find(N=>N.id===g||N.path===g),j=(x==null?void 0:x.path)??g,C=b.includes(j)?b.filter(N=>N!==j):[...b,j];c&&n(C)},[t,b,l,c,n]),w=d.useCallback(()=>{var g,x,j;if(c)n(t?[]:void 0);else{const C=Z.getState();Z.updateState({app:{...C.app,claude:{...(g=C.app)==null?void 0:g.claude,ui:{...(j=(x=C.app)==null?void 0:x.claude)==null?void 0:j.ui,selectedProjectPath:void 0}}}})}},[c,n,t]);if(d.useEffect(()=>{!c&&!u&&l.length>0&&!h&&v(l[0].path)},[c,u,l,h,v]),u)return r.jsx("div",{"data-test":"project-selector-loading",className:e,children:r.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading projects..."})});if(p)return r.jsx("div",{"data-test":"project-selector-error",className:e,children:r.jsx("span",{className:"text-sm text-destructive",children:p})});if(l.length===0)return r.jsx("div",{"data-test":"project-selector-empty",className:e,children:r.jsx("span",{className:"text-sm text-muted-foreground",children:"No projects found"})});const y=t?null:l.find(g=>g.path===f||g.id===f);if(t&&b){const g=l.filter(C=>b.includes(C.path)),x=b.includes(Et),j=b.length>0;return r.jsxs("div",{"data-test":"project-selector-multi",className:"project-selector-multi-wrapper",children:[r.jsxs(Ge,{open:o,onOpenChange:i,children:[r.jsx(Xe,{asChild:!0,children:r.jsxs(ne,{"data-test":"project-selector-trigger",variant:"outline",role:"combobox","aria-expanded":o,className:R("project-selector-trigger w-full justify-between",j&&"h-auto min-h-[40px] py-2"),disabled:u,children:[r.jsx("div",{className:"flex flex-wrap gap-1 flex-1 mr-2",children:j?r.jsxs(r.Fragment,{children:[x&&r.jsxs(tt,{"data-test":"project-badge-none",variant:"secondary",className:"selected-project-badge gap-1",children:["No project",r.jsx(rt,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:C=>{C.stopPropagation(),m(Et)}})]}),g.map(C=>r.jsxs(tt,{"data-test":`project-badge-${C.id}`,variant:"secondary",className:"selected-project-badge gap-1",children:[C.name,r.jsx(rt,{className:"h-3 w-3 cursor-pointer hover:text-destructive",onClick:N=>{N.stopPropagation(),m(C.path)}})]},C.id))]}):r.jsx("span",{className:"text-muted-foreground",children:"Select projects..."})}),r.jsx(oo,{className:"h-4 w-4 shrink-0 opacity-50"})]})}),r.jsx(We,{"data-test":"project-selector-content",className:"project-selector-content w-[400px] p-0",style:{zIndex:xt.tooltip},children:r.jsxs(ya,{children:[r.jsx(Sa,{"data-test":"project-selector-search",placeholder:"Search projects..."}),r.jsxs(Ns,{className:"max-h-[300px]",children:[r.jsx(Es,{children:"No projects found."}),r.jsxs(Xt,{children:[r.jsxs(Dt,{"data-test":"project-selector-item-none",value:Et,onSelect:()=>m(Et),className:"project-selector-item cursor-pointer",children:[r.jsx(et,{className:R("mr-2 h-4 w-4 shrink-0",b.includes(Et)?"opacity-100":"opacity-0")}),r.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[r.jsx("span",{className:"project-name font-medium",children:"No project"}),r.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})]}),l.map(C=>r.jsxs(Dt,{"data-test":`project-selector-item-${C.id}`,value:C.path,onSelect:()=>m(C.path),className:"project-selector-item cursor-pointer",children:[r.jsx(et,{className:R("mr-2 h-4 w-4 shrink-0",b.includes(C.path)?"opacity-100":"opacity-0")}),r.jsxs("div",{className:"project-option flex flex-col items-start flex-1",children:[r.jsx("span",{className:"project-name font-medium",children:C.name}),r.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[C.sessionCount," sessions"]})]})]},C.id))]})]})]})})]}),j&&r.jsxs(ne,{"data-test":"project-selector-clear-all",variant:"outline",size:"sm",onClick:w,className:"clear-all-button w-full mt-2",children:[r.jsx(rt,{className:"h-4 w-4 mr-2"}),"Clear all (",b.length,")"]})]})}if(s==="badge"&&!t){const g=typeof f=="string"?f:void 0,x=[{value:Et,label:"No project",variant:"secondary"},...l.map(j=>({value:j.path,label:`${j.name} (${j.sessionCount})`,variant:"secondary"}))];return r.jsx(Qa,{"data-test":"project-selector-badge",value:g??l[0].path,options:x,onChange:v,placeholder:"Search projects..."})}if(!t){const g=typeof f=="string"?f:void 0;return r.jsxs("div",{"data-test":"project-selector-select",className:"project-selector-wrapper flex gap-2",children:[r.jsxs(It,{value:g??l[0].path,onValueChange:v,children:[r.jsx(jt,{"data-test":"project-selector-trigger",className:e,children:r.jsx(Rt,{children:g===Et?"No project":y?`${y.name} (${y.sessionCount})`:"Select project"})}),r.jsxs(Nt,{children:[r.jsx(we,{"data-test":"project-selector-item-none",value:Et,children:r.jsxs("div",{className:"project-option flex flex-col items-start",children:[r.jsx("span",{className:"project-name font-medium",children:"No project"}),r.jsx("span",{className:"project-meta text-xs text-muted-foreground",children:"Todos without a project"})]})},Et),l.map(x=>r.jsx(we,{"data-test":`project-selector-item-${x.id}`,value:x.path,children:r.jsxs("div",{className:"project-option flex flex-col items-start",children:[r.jsx("span",{className:"project-name font-medium",children:x.name}),r.jsxs("span",{className:"project-meta text-xs text-muted-foreground",children:[x.sessionCount," sessions"]})]})},x.id))]})]}),g&&r.jsx(ne,{"data-test":"project-selector-clear",variant:"outline",size:"icon",onClick:w,className:"clear-project-button shrink-0",title:"Clear project filter",children:r.jsx(rt,{className:"h-4 w-4"})})]})}return null}const jr=d.forwardRef(({label:s,onAction:e,configOptions:t=[],popoverContent:a,longPressDuration:n=400,showStaticGear:o=!1,showHint:i=!1,enableOnboarding:c=!1,tooltipText:l,ariaLabel:u,variant:p="secondary",size:h="default",disabled:f=!1,className:b,...v},m)=>{const[w,y]=d.useState(!1),[g,x]=d.useState(!1),[j,C]=d.useState(!1),[N,S]=d.useState(0),[D,W]=d.useState(c),E=d.useRef(null),I=d.useRef(null),_=d.useRef(0),U=d.useRef(!1),k=d.useRef(!1),M=d.useRef(null),O=d.useRef(null),A=d.useRef(null),P=d.useCallback(()=>{E.current&&(clearTimeout(E.current),E.current=null),I.current&&(clearInterval(I.current),I.current=null),y(!1),S(0)},[]);d.useEffect(()=>P,[P]),d.useEffect(()=>{f&&(P(),x(!1))},[f,P]),d.useEffect(()=>{if(!g||j)return;const H=ae=>{var xe,de;const he=ae.target;(xe=A.current)!=null&&xe.contains(he)||(de=O.current)!=null&&de.contains(he)||x(!1)};return document.addEventListener("mousedown",H),()=>{document.removeEventListener("mousedown",H)}},[g,j]);const z=a!==void 0||t.length>0,$=d.useCallback(H=>{if(f||!z)return;H.type==="touchstart"&&H.preventDefault(),y(!0),x(!1),_.current=Date.now(),U.current=!1,k.current=!0,D&&W(!1);const ae=100/(n/16);I.current=setInterval(()=>{S(he=>{const xe=he+ae;return xe>100?100:xe})},16),E.current=setTimeout(()=>{x(!0),S(0),I.current&&(clearInterval(I.current),I.current=null)},n)},[f,z,n,D]),T=d.useCallback(()=>{if(f)return;Date.now()-_.current<n&&!g?(U.current=!0,e()):U.current=!0,P()},[f,n,g,e,P]),L=d.useCallback(()=>{f||(k.current||e(),k.current=!1)},[f,e]),V=d.useCallback(()=>{f||g||P()},[f,g,P]),K=d.useCallback(H=>{H.stopPropagation(),C(!0)},[]),q=d.useCallback(H=>{H.onClick(),C(!1),x(!1)},[]),Q=20,Y=2*Math.PI*Q,oe=Y-N/100*Y,ve=`${s} (Click) / Configure (Hold)`,X=l??ve;return r.jsxs("div",{ref:m,className:R("relative inline-flex items-center gap-2",b),children:[r.jsx(Qs,{children:r.jsxs(Xs,{open:D?!0:g?!1:void 0,children:[r.jsx(Ys,{asChild:!0,children:r.jsxs("div",{ref:A,className:"button-container relative inline-block",children:[w&&N>0&&r.jsx("svg",{className:"progress-ring absolute inset-0 pointer-events-none",width:"100%",height:"100%",style:{transform:"rotate(-90deg)"},children:r.jsx("circle",{className:"progress-ring-circle stroke-primary/30",strokeWidth:"3",fill:"transparent",r:Q,cx:"50%",cy:"50%",style:{strokeDasharray:Y,strokeDashoffset:oe,transition:"stroke-dashoffset 16ms linear"}})}),r.jsxs(ne,{ref:M,variant:p,size:h,disabled:f,className:R("button-main relative transition-all",w&&"scale-95",i&&z&&"pr-8"),onPointerDown:$,onPointerUp:T,onPointerLeave:V,onClick:L,"aria-label":u||(typeof s=="string"?`Button: ${s}. Secondary action: long press for configuration`:"Button with configuration options"),"aria-pressed":w,"aria-expanded":j,"aria-haspopup":"menu",...v,children:[s,i&&z&&r.jsx(Tl,{className:"hint-icon absolute right-2 top-1/2 -translate-y-1/2 h-3 w-3 opacity-30"})]}),g&&!o&&r.jsxs(Ge,{open:j,onOpenChange:H=>{C(H),H||x(!1)},children:[r.jsx(Xe,{asChild:!0,children:r.jsx("button",{ref:O,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200","aria-label":"Open configuration",children:r.jsx(At,{className:"h-4 w-4"})})}),r.jsx(We,{align:"end",className:R("config-panel",a?"w-auto":"w-56"),children:a?r.jsx("div",{className:"config-panel-custom-content",children:a}):r.jsx("div",{className:"config-panel-content space-y-1",children:t.map((H,ae)=>r.jsxs("button",{onClick:()=>q(H),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[H.icon&&r.jsx("span",{className:"shrink-0",children:H.icon}),r.jsx("span",{children:H.label})]},H.value??ae))})})]}),g&&o&&r.jsx("button",{ref:O,className:"gear-icon absolute -top-2 -right-2 z-10 bg-card border border-border text-muted-foreground rounded-full p-1.5 shadow-md hover:bg-accent hover:text-accent-foreground transition-all animate-in fade-in zoom-in duration-200",onClick:K,onTouchEnd:H=>{H.preventDefault(),K(H)},"aria-label":"Open configuration",children:r.jsx(At,{className:"h-4 w-4"})})]})}),r.jsx(ms,{children:r.jsx("p",{children:D?"Try holding this button for advanced settings":X})})]})}),o&&z&&r.jsxs(Ge,{open:j,onOpenChange:H=>{C(H),H||x(!1)},children:[r.jsx(Xe,{asChild:!0,children:r.jsx(ne,{variant:"ghost",size:"icon",className:"static-gear h-8 w-8 shrink-0",disabled:f,"aria-label":"Configure",tabIndex:0,children:r.jsx(At,{className:"h-4 w-4"})})}),r.jsx(We,{align:"end",className:R("config-panel",a?"w-auto":"w-56"),children:a?r.jsx("div",{className:"config-panel-custom-content",children:a}):r.jsx("div",{className:"config-panel-content space-y-1",children:t.map((H,ae)=>r.jsxs("button",{onClick:()=>q(H),className:"w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent transition-colors text-left",children:[H.icon&&r.jsx("span",{className:"shrink-0",children:H.icon}),r.jsx("span",{children:H.label})]},H.value??ae))})})]})]})});jr.displayName="ConfigurableButton";class ju{constructor(){J(this,"isActive",!1);J(this,"callbacks",new Set);J(this,"tooltipOwnerId",null);J(this,"panelOwnerId",null)}subscribe(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}getState(){return this.isActive}toggle(){this.isActive=!this.isActive,this.notifySubscribers()}setState(e){this.isActive!==e&&(this.isActive=e,this.notifySubscribers())}activate(){this.setState(!0)}deactivate(){this.setState(!1)}claimTooltip(e){this.tooltipOwnerId=e}releaseTooltip(e){this.tooltipOwnerId===e&&(this.tooltipOwnerId=null)}canRenderTooltip(e){return this.tooltipOwnerId===null?e===null:this.tooltipOwnerId===e}claimPanel(e){this.panelOwnerId=e}releasePanel(e){this.panelOwnerId===e&&(this.panelOwnerId=null)}canRenderPanel(e){return this.panelOwnerId===null?e===null:this.panelOwnerId===e}notifySubscribers(){this.callbacks.forEach(e=>e(this.isActive))}}const at=new ju,Nr=({isVisible:s,onClose:e,title:t,children:a,className:n,initialPosition:o="bottom-right",triggerPosition:i,shouldCloseManually:c=!1,resizable:l=!1,initialSize:u,onSizeChange:p,headerActions:h,portalContainer:f})=>{const b=d.useMemo(()=>{if(!i||!u)return null;const L=window.innerWidth,V=window.innerHeight,K=u.width,q=u.height;let Q=i.x,Y=i.y;return Q+K>L&&(Q=L-K-16),Q<16&&(Q=16),Y+q>V&&(Y=V-q-16),Y<16&&(Y=16),{x:Q,y:Y}},[i,u]),[v,m]=d.useState(null),[w,y]=d.useState(u||null),[g,x]=d.useState(!1),[j,C]=d.useState(!1),[N,S]=d.useState({x:0,y:0}),[D,W]=d.useState({x:0,y:0,width:0,height:0}),[E,I]=d.useState(!1),[_,U]=d.useState(!1),k=d.useRef(null),M=d.useRef(null),O=L=>{const V=L.target;if(!(V.tagName==="INPUT"||V.tagName==="TEXTAREA"||V.tagName==="SELECT"||V.tagName==="BUTTON"||V.closest("button")!==null||V.closest("input")!==null||V.closest("textarea")!==null||V.closest("select")!==null||V.classList.contains("resize-handle"))&&M.current){const q=M.current.getBoundingClientRect(),Q=q.left,Y=q.top;m({x:Q,y:Y}),x(!0),S({x:L.clientX-Q,y:L.clientY-Y})}},A=L=>{if(L.stopPropagation(),M.current){const V=M.current.getBoundingClientRect();C(!0),W({x:L.clientX,y:L.clientY,width:V.width,height:V.height})}},P=L=>{L.stopPropagation(),at.toggle();const V=at.getState();Ze.success(`Element Inspector ${V?"activated":"deactivated"}`,{description:V?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};d.useEffect(()=>{if(c||!s||E||_){k.current&&(clearTimeout(k.current),k.current=null);return}return k.current=setTimeout(()=>{e()},2e3),()=>{k.current&&(clearTimeout(k.current),k.current=null)}},[s,E,_,e,c]),d.useEffect(()=>{s||U(!1)},[s]);const z=()=>{U(!0)};d.useEffect(()=>{if(!g)return;const L=K=>{m({x:K.clientX-N.x,y:K.clientY-N.y})},V=()=>{x(!1)};return document.addEventListener("mousemove",L),document.addEventListener("mouseup",V),()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",V)}},[g,N]),d.useEffect(()=>{if(!j)return;const L=K=>{const q=K.clientX-D.x,Q=K.clientY-D.y,Y=Math.max(300,D.width+q),oe=Math.max(200,D.height+Q);y({width:Y,height:oe})},V=()=>{C(!1),w&&p&&p(w)};return document.addEventListener("mousemove",L),document.addEventListener("mouseup",V),()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",V)}},[j,D,w,p]),d.useEffect(()=>{if(!s||c)return;const L=V=>{V.key==="Escape"&&e()};return document.addEventListener("keydown",L),()=>{document.removeEventListener("keydown",L)}},[s,e,c]);const $=v||b;if(!s)return null;const T=r.jsxs("div",{style:{position:"fixed",inset:0,pointerEvents:"none",zIndex:xt.backdrop},"data-test":"draggable-popover-wrapper",children:[!c&&r.jsx("div",{className:"backdrop-click-outside fixed inset-0",style:{zIndex:xt.backdrop,pointerEvents:"auto"},onClick:e,"aria-hidden":"true","data-test":"draggable-popover-backdrop"}),r.jsxs("div",{ref:M,className:Ws("fixed","w-80 bg-background text-foreground border border-border rounded-lg shadow-lg","flex flex-col",l&&"relative",n),style:{zIndex:xt.draggablePopover,pointerEvents:"auto",top:$?`${$.y}px`:o==="bottom-right"?"1rem":typeof o=="object"?`${o.y}px`:"auto",right:!$&&o==="bottom-right"?"1rem":"auto",left:$?`${$.x}px`:typeof o=="object"?`${o.x}px`:"auto",bottom:"auto",cursor:j?"nwse-resize":"default",width:w?`${w.width}px`:void 0,height:w?`${w.height}px`:void 0,maxHeight:"calc(100vh - 2rem)"},onMouseEnter:z,"data-test":"draggable-popover-container",children:[r.jsxs("div",{className:"header px-3 py-2 border-b border-border flex justify-between items-center cursor-grab active:cursor-grabbing",onMouseDown:O,"data-test":"draggable-popover-header",children:[r.jsx("h3",{className:"title-text text-sm font-semibold select-none","data-test":"draggable-popover-title",children:t}),r.jsxs("div",{className:"action-buttons flex items-center gap-1","data-test":"draggable-popover-actions",children:[h,r.jsx("button",{className:"inspector-button p-1 rounded hover:bg-accent transition-colors",onClick:P,onMouseDown:L=>L.stopPropagation(),"aria-label":"Toggle Element Inspector",title:"Toggle Element Inspector","data-test":"draggable-popover-inspector-button",children:r.jsx(Al,{size:14})}),r.jsx("button",{className:Ws("pin-button p-1 rounded hover:bg-accent transition-colors",E&&"bg-accent text-accent-foreground"),onClick:L=>{L.stopPropagation(),I(!E)},onMouseDown:L=>L.stopPropagation(),"aria-label":E?"Unpin popover":"Pin popover",title:E?"Unpin":"Pin","data-test":"draggable-popover-pin-button",children:r.jsx(Il,{size:14,className:Ws(E&&"fill-current")})}),r.jsx("button",{className:"close-button p-1 rounded hover:bg-accent transition-colors",onClick:L=>{L.stopPropagation(),e()},onMouseDown:L=>L.stopPropagation(),"aria-label":"Close popover",title:"Close","data-test":"draggable-popover-close-button",children:r.jsx(rt,{size:14})})]})]}),r.jsx("div",{className:"flex-1 min-h-0 overflow-hidden","data-test":"draggable-popover-content",children:a}),l&&r.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize",onMouseDown:A,style:{background:"linear-gradient(135deg, transparent 50%, currentColor 50%)",opacity:.3},title:"Drag to resize","data-test":"draggable-popover-resize-handle"})]})]});return Ic.createPortal(T,f??document.body)};function Ca(s){const e=/^(\s*)(\d+)\.\s*(.*)$/.exec(s);if(e)return{type:"numbered",indent:e[1],number:parseInt(e[2],10),fullMatch:e[0].replace(e[3],""),contentAfterPrefix:e[3]};const t=/^(\s*)-\s*(.*)$/.exec(s);return t?{type:"dash",indent:t[1],fullMatch:t[0].replace(t[2],""),contentAfterPrefix:t[2]}:{type:"none",indent:"",fullMatch:"",contentAfterPrefix:s}}function Lo(s,e,t,a){if(s.trim()==="")return{type:"newline",textToInsert:`
`};const n=Ca(s);if(n.type==="none")return{type:"newline",textToInsert:`
`};if(!(n.contentAfterPrefix.trim().length>0)){const l=n.fullMatch.length;if(n.type==="numbered"){const u=Nu(t,a,n.indent,n.number??1);return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l,textAfterCursor:u}}return{type:"remove-prefix",textToInsert:"",charsToRemoveBeforeCursor:l}}if(e.split(`
`)[0].trim().length>0)return{type:"newline",textToInsert:`
`};if(n.type==="numbered"){const l=(n.number??0)+1,u=`
${n.indent}${l}. `,p=Eu(t,a,n.indent,l);return{type:"continue",textToInsert:u,textAfterCursor:p}}return{type:"continue",textToInsert:`
${n.indent}- `}}function Nu(s,e,t,a){const o=s.substring(e).split(`
`);let i=!1,c=a-1;const l=[];for(let u=0;u<o.length;u++){const p=o[u],h=Ca(p);if(h.type==="numbered"&&h.indent===t)if(c++,h.number!==c){const f=`${h.indent}${c}. ${h.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(h.type==="numbered"&&h.indent.length<t.length){l.push(...o.slice(u));break}else if(p.trim()===""&&u<o.length-1)l.push(p);else if(h.type!=="numbered"){l.push(...o.slice(u));break}else l.push(p)}return i?l.join(`
`):void 0}function Eu(s,e,t,a){const o=s.substring(e).split(`
`);let i=!1,c=a;const l=[];for(let u=0;u<o.length;u++){const p=o[u],h=Ca(p);if(h.type==="numbered"&&h.indent===t)if(c++,h.number!==c){const f=`${h.indent}${c}. ${h.contentAfterPrefix}`;l.push(f),i=!0}else l.push(p);else if(h.type==="numbered"&&h.indent.length<t.length){l.push(...o.slice(u));break}else if(p.trim()===""&&u<o.length-1)l.push(p);else if(h.type!=="numbered"){l.push(...o.slice(u));break}else l.push(p)}return i?l.join(`
`):void 0}function Er(s,e){const t=s.lastIndexOf(`
`,e-1)+1,a=s.indexOf(`
`,e),n=a===-1?s.length:a;return{lineStart:t,lineEnd:n,currentLine:s.substring(t,n),textBeforeLine:s.substring(0,t),textAfterLine:s.substring(n)}}function $o(s,e){if(e===0)return{type:"default"};const{lineStart:t,currentLine:a}=Er(s,e),n=e-t,o=Ca(a);if(o.type==="none")return{type:"default"};const i=o.fullMatch.length;if(n<=i&&n>0){const c=e-1;return{type:"delete-char",newText:s.substring(0,c)+s.substring(e),newCursorPos:c}}return{type:"default"}}function ku(s,e,t){const{lineStart:a,textAfterLine:n}=Er(s,e),o=s.substring(a,e),i=s.substring(e,s.indexOf(`
`,e)===-1?s.length:s.indexOf(`
`,e)),c=Lo(o,i+n,s,e);if(c.type==="remove-prefix"){const l=c.charsToRemoveBeforeCursor??0,u=e-l;return{selectionStart:u,selectionEnd:e,textToInsert:c.textToInsert,newCursorPosition:u+c.textToInsert.length}}return c.type==="continue"?{selectionStart:e,selectionEnd:t,textToInsert:c.textToInsert,newCursorPosition:e+c.textToInsert.length,replaceTextAfterCursor:c.textAfterCursor}:{selectionStart:e,selectionEnd:t,textToInsert:`
`,newCursorPosition:e+1}}function Tu(s,e,t){const a=s.lastIndexOf(`
`,e-1)+1,n="  ",o=e+2;return{selectionStart:a,selectionEnd:a,textToInsert:n,newCursorPosition:o}}function Au(s,e,t){const a=s.lastIndexOf(`
`,e-1)+1,n=s.indexOf(`
`,e),o=n===-1?s.length:n,i=s.substring(a,o);let c=0;for(let u=0;u<Math.min(2,i.length)&&i[u]===" ";u++)c++;if(c===0)return{selectionStart:e,selectionEnd:t,textToInsert:"",newCursorPosition:e};const l=Math.max(a,e-c);return{selectionStart:a,selectionEnd:a+c,textToInsert:"",newCursorPosition:l}}const Uo=d.forwardRef(({value:s,defaultValue:e,onChange:t,placeholder:a,onClick:n,onMouseDown:o,onMouseUp:i,onPaste:c,onKeyDown:l,onKeyUp:u,onBlur:p,rows:h=4,className:f="",readOnly:b=!1,disabled:v=!1,...m},w)=>{const y=g=>{if(l==null||l(g),g.defaultPrevented)return;const x=g.currentTarget,{selectionStart:j,selectionEnd:C}=x,N=x.value;if(g.key==="Enter"){g.preventDefault();const S=ku(N,j,C);if(x.focus(),x.setSelectionRange(S.selectionStart,S.selectionEnd),S.replaceTextAfterCursor!==void 0){const W=N.substring(0,S.selectionStart)+S.textToInsert+S.replaceTextAfterCursor;x.value=W,x.setSelectionRange(S.newCursorPosition,S.newCursorPosition),t&&t({target:x,currentTarget:x})}else if(S.selectionStart!==S.selectionEnd&&S.textToInsert===""){const D=N.substring(0,S.selectionStart)+N.substring(S.selectionEnd);x.value=D,x.setSelectionRange(S.newCursorPosition,S.newCursorPosition),t&&t({target:x,currentTarget:x})}else{if(!document.execCommand("insertText",!1,S.textToInsert)&&t){const W=N.substring(0,S.selectionStart)+S.textToInsert+N.substring(S.selectionEnd);x.value=W,t({target:x,currentTarget:x})}x.setSelectionRange(S.newCursorPosition,S.newCursorPosition)}}if(g.key==="Backspace"){const S=$o(N,j);if(S.type==="delete-char"&&S.newText!==void 0&&S.newCursorPos!==void 0){g.preventDefault(),x.value=S.newText,x.setSelectionRange(S.newCursorPos,S.newCursorPos),t&&t({target:x,currentTarget:x});return}}if(g.key==="Tab"){g.preventDefault();const S=g.shiftKey?Au(N,j,C):Tu(N,j);if(x.focus(),x.setSelectionRange(S.selectionStart,S.selectionEnd),!document.execCommand("insertText",!1,S.textToInsert)&&t){const W=N.substring(0,S.selectionStart)+S.textToInsert+N.substring(S.selectionEnd);x.value=W,t({target:x,currentTarget:x})}x.setSelectionRange(S.newCursorPosition,S.newCursorPosition)}};return r.jsx("textarea",{ref:w,value:s,defaultValue:e,onChange:t,onKeyDown:y,onKeyUp:u,placeholder:a,onClick:n,onMouseDown:o,onMouseUp:i,onPaste:c,onBlur:p,rows:h,className:R(yd.textarea,f),readOnly:b,disabled:v,"data-test":m["data-test"],...m})});Uo.displayName="RichTextarea";const ks=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,className:R("rounded-xl border bg-card text-card-foreground shadow",s),...e}));ks.displayName="Card";const kr=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,className:R("flex flex-col space-y-1.5 p-6",s),...e}));kr.displayName="CardHeader";const Tr=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,className:R("font-semibold leading-none tracking-tight",s),...e}));Tr.displayName="CardTitle";const Iu=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,className:R("text-sm text-muted-foreground",s),...e}));Iu.displayName="CardDescription";const Ts=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,className:R("p-6 pt-0",s),...e}));Ts.displayName="CardContent";const Ru=d.forwardRef(({className:s,...e},t)=>r.jsx("div",{ref:t,className:R("flex items-center p-6 pt-0",s),...e}));Ru.displayName="CardFooter";const Pu=rl,_u=nl,Sb=il,Du=d.forwardRef(({className:s,inset:e,children:t,...a},n)=>r.jsxs(Fn,{ref:n,className:R("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",e&&"pl-8",s),...a,children:[t,r.jsx(Ht,{className:"ml-auto"})]}));Du.displayName=Fn.displayName;const Ou=d.forwardRef(({className:s,...e},t)=>r.jsx(Wn,{ref:t,className:R("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...e}));Ou.displayName=Wn.displayName;const Fo=d.forwardRef(({className:s,sideOffset:e=4,...t},a)=>r.jsx(ol,{children:r.jsx(Mn,{ref:a,sideOffset:e,className:R("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",s),...t})}));Fo.displayName=Mn.displayName;const Wo=d.forwardRef(({className:s,inset:e,...t},a)=>r.jsx(Ln,{ref:a,className:R("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",e&&"pl-8",s),...t}));Wo.displayName=Ln.displayName;const Mu=d.forwardRef(({className:s,children:e,checked:t,...a},n)=>r.jsxs(zn,{ref:n,className:R("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),checked:t,...a,children:[r.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:r.jsx(Bn,{children:r.jsx(et,{className:"h-4 w-4"})})}),e]}));Mu.displayName=zn.displayName;const Lu=d.forwardRef(({className:s,children:e,...t},a)=>r.jsxs(Hn,{ref:a,className:R("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...t,children:[r.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:r.jsx(Bn,{children:r.jsx(Rl,{className:"h-2 w-2 fill-current"})})}),e]}));Lu.displayName=Hn.displayName;const $u=d.forwardRef(({className:s,inset:e,...t},a)=>r.jsx($n,{ref:a,className:R("px-2 py-1.5 text-sm font-semibold",e&&"pl-8",s),...t}));$u.displayName=$n.displayName;const Uu=d.forwardRef(({className:s,...e},t)=>r.jsx(Un,{ref:t,className:R("-mx-1 my-1 h-px bg-muted",s),...e}));Uu.displayName=Un.displayName;function Fu({onClick:s,label:e,icon:t,variant:a="default",size:n="sm",options:o=[],showDropdown:i=!0,className:c="",disabled:l=!1,"data-test":u}){return r.jsxs("div",{className:`split-button-group flex ${c}`,"data-test":u,children:[r.jsxs(ne,{onClick:s,variant:a,size:n,disabled:l,className:`${i&&o.length>0?"rounded-r-none":""}`,"data-test":u?`${u}-main-button`:void 0,children:[t&&r.jsx(t,{className:"w-3 h-3 mr-1","data-test":u?`${u}-icon`:void 0}),e]}),i&&o.length>0&&r.jsxs(Pu,{children:[r.jsx(_u,{asChild:!0,children:r.jsx(ne,{variant:a,size:n,disabled:l,className:"border-l border-l-white/20 rounded-l-none px-1.5","data-test":u?`${u}-dropdown-trigger`:void 0,children:r.jsx(ts,{className:"w-3 h-3","data-test":u?`${u}-dropdown-icon`:void 0})})}),r.jsx(Fo,{align:"start","data-test":u?`${u}-dropdown-menu`:void 0,children:o.map((p,h)=>r.jsx(Wo,{onClick:p.onClick,"data-test":u?`${u}-option-${p.label.toLowerCase().replace(/\s+/g,"-")}`:void 0,children:p.label},h))})]})]})}async function Yr(s,e){try{e==null||e.info(`Converting ${s.type} (${s.size} bytes) to WAV`);const t=new(window.AudioContext||window.webkitAudioContext),a=await s.arrayBuffer(),n=await t.decodeAudioData(a);e==null||e.debug(`Decoded: ${n.duration}s, ${n.sampleRate}Hz, ${n.numberOfChannels}ch`);const o=n.numberOfChannels,i=n.sampleRate,c=n.length,l=new Float32Array(c*o);for(let h=0;h<o;h++){const f=n.getChannelData(h);for(let b=0;b<c;b++)l[b*o+h]=f[b]}const u=Wu(l,i,o),p=new Blob([u],{type:"audio/wav"});if(!p||p.size===0)throw new Error("Failed to create valid WAV blob");return e==null||e.info(`Conversion complete: ${p.size} bytes`),p}catch(t){throw e==null||e.error(`Audio conversion failed: ${t}`),t}}function Wu(s,e,t){const a=new ArrayBuffer(44+s.length*2),n=new DataView(a),o=(c,l)=>{for(let u=0;u<l.length;u++)n.setUint8(c+u,l.charCodeAt(u))};o(0,"RIFF"),n.setUint32(4,36+s.length*2,!0),o(8,"WAVE"),o(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,t,!0),n.setUint32(24,e,!0),n.setUint32(28,e*t*2,!0),n.setUint16(32,t*2,!0),n.setUint16(34,16,!0),o(36,"data"),n.setUint32(40,s.length*2,!0);let i=44;return s.forEach(c=>{const l=Math.max(-1,Math.min(1,c));n.setInt16(i,l*32767,!0),i+=2}),a}function zu(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",n=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return n.length===0?s:n.map((i,c)=>c===0?i.toLowerCase():i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function Bu(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",n=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return n.length===0?s:n.map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join("")+t}function Hu(s){const e=/\.[a-zA-Z0-9]+$/.exec(s),t=e?e[0]:"",n=(t?s.slice(0,-t.length):s).replace(/([a-z])([A-Z])/g,"$1 $2").split(/[\s._-]+/).filter(Boolean);return n.length===0?s:n.map(i=>i.toLowerCase()).join("_")+t}function Cb(s,e){switch(e){case"camel":return zu(s);case"pascal":return Bu(s);case"snake":return Hu(s);default:return s}}function Zr(s){return s.endsWith("...")?s.slice(0,-3).trim():s}function Gu(s){return s.trim().endsWith(".")?s.slice(0,-1).trim():s}let Vu="transcriptions";const en=["ggml-large-v3","ggml-large-v3-q5_0","ggml-large-v3-turbo","ggml-distil-large-v3","distil-large-v3.5"];let qu="ggml-distil-large-v3";const zo={language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:qu},Ku=["CÃ¡c báº¡n","CÃ¡c báº¡n nhá»› Ä‘Äƒng kÃ½ kÃªnh Ä‘á»ƒ á»§ng há»™ kÃªnh cá»§a mÃ¬nh nhÃ©! Háº¹n gáº·p láº¡i cÃ¡c báº¡n trong nhá»¯ng video tiáº¿p theo!","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi, quÃ½ vá»‹","Hi, quÃ½ vá»‹. Xin chÃ o táº¥t cáº£ cÃ¡c báº¡n","HÃ£y subscribe cho kÃªnh","HÃ£y subscribe cho kÃªnh Ghiá»n MÃ¬ GÃµ Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","HÃ£y subscribe cho kÃªnh La La School Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","lalaschool","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho","Hi! CÃ¡c báº¡n hÃ£y Ä‘Äƒng kÃ­ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi","Hi xin cáº£m Æ¡n cÃ¡c báº¡n Ä‘Ã£ theo dÃµi vÃ  á»§ng há»™ cho kÃªnh lalaschool Äá»ƒ khÃ´ng bá» lá»¡ nhá»¯ng video háº¥p dáº«n","Cáº¢M Æ N CÃC Báº N ÄÃƒ THEO DÃ•I VÃ€ ÄÄ‚NG KÃ KÃŠNH NHÃ‰!"];class As extends Error{constructor(e,t,a,n){super(e),this.code=t,this.statusCode=a,this.detail=n,this.name="PythonTranscribeApiError"}}class Ju extends As{constructor(e){super(e??"Bad Request - invalid file format or missing file","PTApi_BAD_REQUEST",400,e),this.name="PTApiBadRequestError"}}class Qu extends As{constructor(e){super(e??"Payload Too Large - file exceeds size limit","PTApi_PAYLOAD_TOO_LARGE",413,e),this.name="PTApiPayloadTooLargeError"}}class Xu extends As{constructor(e){super(e??"Internal Server Error - transcription service error","PTApi_INTERNAL_SERVER_ERROR",500,e),this.name="PTApiInternalServerError"}}class Yu extends As{constructor(e,t){super(t??`HTTP error! status: ${e}`,"PTApi_HTTP_ERROR",e,t),this.name="PTApiHttpError"}}class Bo extends As{constructor(){super("Transcription contains denied phrases.","PTApi_DENIED_PHRASES"),this.name="PTApiDeniedPhrasesError"}}class Zu{constructor(){J(this,"baseUrl");this.baseUrl="http://192.168.2.70:9876"}async transcribeAudio(e,t={}){t={...zo,...t};const a=new FormData;t.language!==void 0&&a.append("language",t.language),t.translate!==void 0&&a.append("translate",t.translate.toString()),t.no_timestamps!==void 0&&a.append("no_timestamps",t.no_timestamps.toString()),t.no_prints!==void 0&&a.append("no_prints",t.no_prints.toString()),t.auto_detect_language!==void 0&&a.append("auto_detect_language",t.auto_detect_language.toString()),t.model!==void 0&&a.append("model",t.model),a.append("file",e);try{const n=await fetch(`${this.baseUrl}/${Vu}`,{method:"POST",body:a});if(!n.ok){const i=await n.json();switch(n.status){case 400:throw new Ju(i.detail);case 413:throw new Qu(i.detail);case 500:throw new Xu(i.detail);default:throw new Yu(n.status,i.detail)}}const o=await n.json();if(o.transcription=Gu(o.transcription),Ku.some(i=>o.transcription.toLowerCase().includes(i.toLowerCase())))throw new Bo;return o}catch(n){throw n}}setBaseUrl(e){this.baseUrl=e}}const Ho=new Zu,_s={language:"auto",translate:!1,no_timestamps:!0,auto_detect_language:!0,word_level_timestamps:!1,split:!1},aa={DEFAULT:{silenceThreshold:-20,minSilenceDuration:40,holdTime:100,padding:-60,waveformSamples:1e3},TIGHT:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3},LOOSE:{silenceThreshold:-30,minSilenceDuration:100,holdTime:200,padding:0,waveformSamples:1e3},WORD_STREAMING:{silenceThreshold:-25,minSilenceDuration:30,holdTime:40,padding:0,waveformSamples:1e3}};class ep{constructor(e={}){J(this,"defaultConfig");const t=aa.DEFAULT;this.defaultConfig={silenceThreshold:e.silenceThreshold??t.silenceThreshold,minSilenceDuration:e.minSilenceDuration??t.minSilenceDuration,holdTime:e.holdTime??t.holdTime,padding:e.padding??t.padding,waveformSamples:e.waveformSamples??t.waveformSamples??1e3}}async analyzeAudio(e,t={}){const a={silenceThreshold:t.silenceThreshold??this.defaultConfig.silenceThreshold,minSilenceDuration:t.minSilenceDuration??this.defaultConfig.minSilenceDuration,holdTime:t.holdTime??this.defaultConfig.holdTime,padding:t.padding??this.defaultConfig.padding,waveformSamples:t.waveformSamples??this.defaultConfig.waveformSamples},n=this._generateWaveform(e,a.waveformSamples),o=this._normalize(n),i=this._toDbfs(o),c=this._detectActiveRegions(i,e.duration,a.silenceThreshold),l=this._mergeCloseRegions(c,a.holdTime),u=this._calculateSilences(l,e.duration*1e3),p=this._filterByDuration(u,a.minSilenceDuration),h=this._applySilencePadding(p,e.duration*1e3,a.padding);return this._getActiveRegions(h,e.duration)}_generateWaveform(e,t){const a=e.numberOfChannels,n=e.length,o=new Float32Array(n);for(let l=0;l<n;l++){let u=0;for(let p=0;p<a;p++)u+=e.getChannelData(p)[l];o[l]=u/a}const i=Math.max(1,Math.floor(n/t)),c=[];for(let l=0;l<t;l++){const u=l*i,p=Math.min(u+i,n);if(u<n&&p>u){let h=0;for(let b=u;b<p;b++)h+=Math.abs(o[b])**2;const f=Math.sqrt(h/(p-u));c.push(f)}else c.push(0)}return c}_normalize(e){const t=e.map(o=>isNaN(o)||!isFinite(o)?0:o),a=Math.max(...t),n=a>0?a:1;return t.map(o=>o/n)}_toDbfs(e){return e.map(a=>20*Math.log10(a+1e-10))}_detectActiveRegions(e,t,a){const n=e.map(l=>l>a),o=[];let i=!1,c=0;for(let l=0;l<n.length;l++)if(n[l]&&!i)c=l,i=!0;else if(!n[l]&&i){const u=l,p=c/e.length*t*1e3,h=u/e.length*t*1e3;o.push([p,h]),i=!1}if(i){const l=t*1e3,u=c/e.length*t*1e3;o.push([u,l])}return o}_mergeCloseRegions(e,t){if(e.length===0)return[];const a=[...e].sort((o,i)=>o[0]-i[0]),n=[a[0]];for(let o=1;o<a.length;o++){const[i,c]=a[o],l=n.length-1,[u,p]=n[l];i-p<=t?n[l]=[u,c]:n.push([i,c])}return n}_calculateSilences(e,t){const a=[];if(e.length===0)return[[0,t]];e[0][0]>0&&a.push([0,e[0][0]]);for(let o=0;o<e.length-1;o++){const i=e[o][1],c=e[o+1][0];c>i&&a.push([i,c])}const n=e[e.length-1][1];return n<t&&a.push([n,t]),a}_filterByDuration(e,t){return e.filter(([a,n])=>n-a>=t)}_applySilencePadding(e,t,a){if(a===0||e.length===0)return e;const n=[];for(let o=0;o<e.length;o++){const[i,c]=e[o];if(i===0){const u=Math.min(t,c+a);u>0&&n.push([0,u])}else if(o===e.length-1&&c===t){const l=Math.max(0,i-a),u=t;u>l&&n.push([l,u])}else{const l=Math.max(0,i-a),u=Math.min(t,c+a);u>l&&n.push([l,u])}}return n}_getActiveRegions(e,t){const a=[];if(e.length===0)return[[0,t]];const n=e.map(([i,c])=>[i/1e3,c/1e3]);n[0][0]>0&&a.push([0,n[0][0]]);for(let i=0;i<n.length-1;i++){const c=n[i][1],l=n[i+1][0];l>c&&a.push([c,l])}const o=n[n.length-1][1];return o<t&&a.push([o,t]),a}}class Go{constructor(e={}){J(this,"detector");this.detector=new ep(e)}async chunkFile(e){const t=await e.arrayBuffer(),n=await new AudioContext().decodeAudioData(t);return this.chunkAudio(n)}async chunkAudio(e,t){return(await this.detector.analyzeAudio(e,t)).map((o,i)=>{const[c,l]=o,u=this._extractChunk(e,c,l);return{blob:this._audioBufferToWav(u),startTime:c,endTime:l,duration:l-c,index:i+1}})}_extractChunk(e,t,a){const n=e.sampleRate,o=Math.floor(t*n),c=Math.floor(a*n)-o,u=new AudioContext().createBuffer(e.numberOfChannels,c,n);for(let p=0;p<e.numberOfChannels;p++){const h=e.getChannelData(p),f=u.getChannelData(p);for(let b=0;b<c;b++)f[b]=h[o+b]}return u}_audioBufferToWav(e){const t=e.numberOfChannels,a=e.sampleRate,n=1,o=16,i=o/8,c=t*i,l=a*c,u=e.length*c,p=new ArrayBuffer(44+u),h=new DataView(p),f=(m,w)=>{for(let y=0;y<w.length;y++)h.setUint8(m+y,w.charCodeAt(y))};f(0,"RIFF"),h.setUint32(4,36+u,!0),f(8,"WAVE"),f(12,"fmt "),h.setUint32(16,16,!0),h.setUint16(20,n,!0),h.setUint16(22,t,!0),h.setUint32(24,a,!0),h.setUint32(28,l,!0),h.setUint16(32,c,!0),h.setUint16(34,o,!0),f(36,"data"),h.setUint32(40,u,!0);const b=[];for(let m=0;m<t;m++)b.push(e.getChannelData(m));let v=44;for(let m=0;m<e.length;m++)for(let w=0;w<t;w++){const y=Math.max(-1,Math.min(1,b[w][m])),g=y<0?y*32768:y*32767;h.setInt16(v,g,!0),v+=2}return new Blob([p],{type:"audio/wav"})}async getActiveRegions(e,t){return this.detector.analyzeAudio(e,t)}}const ke="WebSocketTranscriptionService";class tp{constructor(e){J(this,"ws",null);J(this,"wsUrl");J(this,"eventHandlers",{});J(this,"isConnected",!1);J(this,"reconnectAttempts",0);J(this,"maxReconnectAttempts",3);J(this,"reconnectDelay",1e3);this.wsUrl=e??"ws://192.168.2.70:9876/ws/transcribe"??"ws://localhost:9876/ws/transcribe"}setEventHandlers(e){this.eventHandlers=e}async connect(){return new Promise((e,t)=>{try{pe.info(`Connecting to WebSocket: ${this.wsUrl}`,ke),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{var a,n;pe.info("WebSocket connection opened",ke),this.isConnected=!0,this.reconnectAttempts=0,(n=(a=this.eventHandlers).onConnectionOpen)==null||n.call(a),e()},this.ws.onmessage=a=>{this.handleMessage(a)},this.ws.onerror=a=>{var n,o;pe.error(`WebSocket error: ${a}`,ke),(o=(n=this.eventHandlers).onConnectionError)==null||o.call(n,a),t(a)},this.ws.onclose=a=>{var n,o;pe.info(`WebSocket closed: code=${a.code}, reason=${a.reason}`,ke),this.isConnected=!1,(o=(n=this.eventHandlers).onConnectionClose)==null||o.call(n,a.code,a.reason),this.reconnectAttempts<this.maxReconnectAttempts&&a.code!==1e3&&(this.reconnectAttempts++,pe.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,ke),setTimeout(()=>{this.connect().catch(i=>{pe.error(`Reconnection failed: ${i}`,ke)})},this.reconnectDelay))}}catch(a){pe.error(`Failed to create WebSocket connection: ${a}`,ke),t(a)}})}handleMessage(e){var t,a,n,o,i,c,l,u,p,h;try{const f=JSON.parse(e.data);switch(f.type){case"progress":pe.info(`Progress: ${f.data.percentage}% - ${f.data.message}`,ke),(a=(t=this.eventHandlers).onProgress)==null||a.call(t,f.data);break;case"word":pe.info(`Word: "${f.data.word}" [${f.data.start_time}s - ${f.data.end_time}s]`,ke),(o=(n=this.eventHandlers).onWord)==null||o.call(n,f.data);break;case"segment":pe.info(`Segment ${f.data.segment}: "${f.data.transcription}"`,ke),(c=(i=this.eventHandlers).onSegment)==null||c.call(i,f.data);break;case"complete":pe.info("Transcription complete",ke),(u=(l=this.eventHandlers).onComplete)==null||u.call(l,f.data);break;case"error":pe.error(`Server error: ${f.data.message} (code: ${f.data.code})`,ke),(h=(p=this.eventHandlers).onError)==null||h.call(p,f.data);break;default:pe.error(`Unknown message type: ${f.type}`,ke)}}catch(f){pe.error(`Failed to parse message: ${f}`,ke)}}async sendConfig(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"config",data:e};pe.info(`Sending config: ${JSON.stringify(e)}`,ke),this.ws.send(JSON.stringify(t))}async sendAudioChunk(e){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const t={type:"audio_chunk",data:{chunk:e}};pe.info(`Sending audio chunk (${e.length} chars)`,ke),this.ws.send(JSON.stringify(t))}async sendAudioChunks(e){for(const t of e)await this.sendAudioChunk(t)}async startTranscription(){if(!this.isConnected||!this.ws)throw new Error("WebSocket not connected");const e={type:"start",data:{}};pe.info("Starting transcription",ke),this.ws.send(JSON.stringify(e))}async transcribeAudioFile(e,t=_s){this.isConnected||await this.connect(),await this.sendConfig(t);const a=await e.arrayBuffer(),n=new Uint8Array(a);let o="";const i=n.byteLength;for(let l=0;l<i;l++)o+=String.fromCharCode(n[l]);const c=btoa(o);await this.sendAudioChunk(c),await this.startTranscription()}async transcribeAudioBlob(e,t=_s){const a=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFile(a,t)}async transcribeAudioFileWithChunking(e,t={..._s,word_level_timestamps:!0,split:!1},a=aa.WORD_STREAMING){this.isConnected||await this.connect(),pe.info("Starting client-side silence-based chunking",ke);const o=await new Go(a).chunkFile(e);pe.info(`Audio split into ${o.length} chunks (client-side)`,ke);for(let i=0;i<o.length;i++){const c=o[i];await this._transcribeChunk(c,i+1,o.length,t)}pe.info("All chunks processed",ke)}async _transcribeChunk(e,t,a,n){return new Promise((o,i)=>{pe.info(`Processing chunk ${t}/${a} (${e.startTime.toFixed(2)}s - ${e.endTime.toFixed(2)}s)`,ke);const c=this.eventHandlers.onComplete,l=this.eventHandlers.onError;this.eventHandlers.onComplete=u=>{if(this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,c){const p={...u,metadata:{...u.metadata,chunk_index:t,chunk_start_time:e.startTime,chunk_end_time:e.endTime}};c(p)}pe.info(`Chunk ${t}/${a} transcription complete`,ke),o()},this.eventHandlers.onError=u=>{this.eventHandlers.onComplete=c,this.eventHandlers.onError=l,l&&l(u),pe.error(`Chunk ${t}/${a} transcription failed: ${u.message}`,ke),i(new Error(u.message))},this._sendChunkTranscriptionRequest(e,n).catch(i)})}async _sendChunkTranscriptionRequest(e,t){const a={...t,split:!1};await this.sendConfig(a);const n=await e.blob.arrayBuffer(),o=new Uint8Array(n);let i="";const c=o.byteLength;for(let u=0;u<c;u++)i+=String.fromCharCode(o[u]);const l=btoa(i);await this.sendAudioChunk(l),await this.startTranscription()}async transcribeAudioBlobWithChunking(e,t={..._s,word_level_timestamps:!0,split:!1},a=aa.WORD_STREAMING){const n=new File([e],"audio.webm",{type:e.type});await this.transcribeAudioFileWithChunking(n,t,a)}disconnect(){this.ws&&(pe.info("Disconnecting WebSocket",ke),this.ws.close(1e3,"Client disconnecting"),this.ws=null,this.isConnected=!1)}get connected(){return this.isConnected}setUrl(e){if(this.isConnected)throw pe.error("Cannot update URL while connected. Disconnect first.",ke),new Error("Cannot update URL while connected");this.wsUrl=e,pe.info(`WebSocket URL updated to: ${this.wsUrl}`,ke)}setMaxReconnectAttempts(e){this.maxReconnectAttempts=e}setReconnectDelay(e){this.reconnectDelay=e}}const sp=(s={})=>{const{onChunkCreated:e,onChunkUpdated:t,onChunkDeleted:a,onChunksLoaded:n,onError:o,sessionName:i="recording-session",enableAutoPersist:c=!0,enableAutoTranscription:l=!0,minChunkDuration:u=1e3,loadPersistedChunks:p=!0,skipLastSessionChunk:h=!1,transcribeOptions:f,useWebSocket:b=!1,onWordReceived:v,onTranscriptionProgress:m}=s,[w,y]=d.useState(!1),[g,x]=d.useState(!1),[j,C]=d.useState([]),[N,S]=d.useState(0),[D,W]=d.useState(null),E=d.useRef([]);d.useEffect(()=>{E.current=j},[j]);const I=d.useRef(null),_=d.useRef(null),U=d.useRef([]),k=d.useRef([]),M=d.useRef(null),O=d.useRef(null),A=d.useRef(null),P=d.useRef(0),z=d.useRef(!1),$=d.useRef(null),T=d.useRef(null),L=d.useCallback(G=>{const ee=new Date().toISOString().slice(0,19).replace(/[:]/g,"-");return`${i}-chunk-${G.toString().padStart(3,"0")}-${ee}`},[i]),V=d.useCallback(async()=>{if(p)try{const G=await st.loadChunksBySession(i);if(G.length===0)return;C(G);const ee=Math.max(...G.map(ie=>ie.chunkNumber),0);S(ee),n==null||n(G)}catch(G){o==null||o(`Failed to load persisted chunks: ${G instanceof Error?G.message:"Unknown error"}`)}},[i,p,n]);d.useEffect(()=>(b&&!$.current&&($.current=new tp,$.current.setEventHandlers({onWord:G=>{const ee=T.current;ee&&(v==null||v(G,ee))},onProgress:G=>{const ee=T.current;ee&&(m==null||m(G,ee))},onComplete:G=>{const ee=T.current;if(!ee)return;const ie=Zr(G.transcription);C(Ne=>{const ue=Ne.find(fe=>fe.id===ee);if(!ue)return Ne;const me={...ue,transcription:ie,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(me)),Ne.map(fe=>fe.id===ee?me:fe)}),c&&st.updateChunkTranscription(ee,ie).catch(()=>{}),T.current=null},onError:G=>{const ee=T.current;ee&&(C(ie=>{const Ne=ie.find(me=>me.id===ee);if(!Ne)return ie;const ue={...Ne,transcriptionStatus:"failed",transcriptionError:G.message};return queueMicrotask(()=>t==null?void 0:t(ue)),ie.map(me=>me.id===ee?ue:me)}),c&&st.updateChunkTranscriptionStatus(ee,"failed",G.message).catch(()=>{})),o==null||o(G.message),T.current=null},onConnectionOpen:()=>{},onConnectionClose:()=>{},onConnectionError:()=>{o==null||o("WebSocket connection error")}})),()=>{$.current&&($.current.disconnect(),$.current=null)}),[b,v,m,t,o,c]);const K=d.useCallback(async(G,ee,ie,Ne)=>{const ue=Ne||f,me=E.current.find(be=>be.id===G);if(!me||me.transcriptionStatus==="processing"||me.transcriptionStatus==="completed"&&me.transcription)return;const fe={...me,transcriptionStatus:"processing"};if(C(be=>(queueMicrotask(()=>t==null?void 0:t(fe)),be.map(je=>je.id===G?fe:je))),c)try{await st.updateChunkTranscriptionStatus(G,"processing")}catch{}if(b&&$.current){try{T.current=G,$.current.connected||await $.current.connect(),await $.current.transcribeAudioBlob(ee,{language:(ue==null?void 0:ue.language)||"auto",word_level_timestamps:!0,no_timestamps:(ue==null?void 0:ue.no_timestamps)??!0,translate:(ue==null?void 0:ue.translate)??!1,auto_detect_language:(ue==null?void 0:ue.auto_detect_language)??!0})}catch(be){const je=be instanceof Error?be.message:"WebSocket transcription error";if(C(ye=>{const Se=ye.find(F=>F.id===G);if(!Se)return ye;const Te={...Se,transcriptionStatus:"failed",transcriptionError:je};return queueMicrotask(()=>t==null?void 0:t(Te)),ye.map(F=>F.id===G?Te:F)}),c)try{await st.updateChunkTranscriptionStatus(G,"failed",je)}catch{}o==null||o(`WebSocket transcription failed for ${ie}: ${je}`),T.current=null}return}try{const be=new File([ee],`${ie}.wav`,{type:"audio/wav"}),je=await Ho.transcribeAudio(be,ue),ye=Zr(je.transcription);if(C(Se=>{const Te=Se.find(B=>B.id===G);if(!Te)return Se;const F={...Te,transcription:ye,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(F)),Se.map(B=>B.id===G?F:B)}),c)try{await st.updateChunkTranscription(G,ye)}catch{}}catch(be){if(be instanceof Bo){if(console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Skipping chunk due to denied phrases:",ie),C(ye=>ye.filter(Se=>Se.id!==G)),c)try{await st.deleteChunk(G)}catch(ye){console.warn("ðŸŽ¤ðŸ“¦ðŸ”¤ âš ï¸ Failed to delete chunk from storage:",ye)}a==null||a(G);return}const je=be instanceof Error?be.message:"Unknown transcription error";if(C(ye=>{const Se=ye.find(F=>F.id===G);if(!Se)return ye;const Te={...Se,transcriptionStatus:"failed",transcriptionError:je};return queueMicrotask(()=>t==null?void 0:t(Te)),ye.map(F=>F.id===G?Te:F)}),c)try{await st.updateChunkTranscriptionStatus(G,"failed",je)}catch{}o==null||o(`Transcription failed for ${ie}: ${je}`)}},[c,t,b]),q=d.useCallback(async()=>{try{const G=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});return _.current=G,!0}catch(G){const ee=G instanceof Error?G.message:"Failed to access microphone";return W(ee),o==null||o(ee),!1}},[o]),Q=d.useCallback(async()=>{if(!(!I.current||g))try{const G=P.current+1,ee={id:`segment-${crypto.randomUUID()}`,chunkNumber:G,startTime:new Date,name:L(G)};A.current=ee,x(!0)}catch(G){const ee=G instanceof Error?G.message:"Failed to start segment recording";W(ee),o==null||o(ee),x(!1)}},[g,L,o]),Y=d.useCallback(async()=>{if(!(!I.current||!g||!A.current))try{const G=A.current;A.current=null,x(!1),I.current.requestData(),await new Promise(je=>setTimeout(je,50));const ee=new Date,ie=ee.getTime()-G.startTime.getTime();if(ie<u){k.current=[];return}const Ne=I.current.mimeType||"audio/webm",ue=[];M.current&&ue.push(M.current),ue.push(...k.current);const me=new Blob(ue,{type:Ne});let fe;try{fe=await Yr(me)}catch{fe=me}const be={...G,endTime:ee,duration:ie,blob:fe,size:fe.size,transcriptionStatus:l?"pending":void 0};if(C(je=>[...je,be]),E.current=[...E.current,be],P.current=G.chunkNumber,S(G.chunkNumber),k.current=[],c)try{await st.saveChunk(be,i),e==null||e(be),l&&K(be.id,fe,be.name,f).catch(()=>{})}catch(je){const ye=je instanceof Error?je.message:"Failed to save segment";W(ye),o==null||o(ye)}else e==null||e(be),l&&K(be.id,fe,be.name,f).catch(()=>{})}catch(G){const ee=G instanceof Error?G.message:"Failed to stop segment";W(ee),o==null||o(ee),x(!1)}},[g,u,c,l,i,e,o,K]),oe=d.useCallback(async()=>{if(!await q())return;const ee=new Date().toISOString().slice(0,19).replace(/[:]/g,"-"),ie={id:`session-${crypto.randomUUID()}`,chunkNumber:0,startTime:new Date,name:`${i}-session-${ee}`};O.current=ie,U.current=[],k.current=[],P.current=0,M.current=null,z.current=!1;const ue=["audio/webm;codecs=opus","audio/webm;codecs=vorbis","audio/webm","audio/ogg;codecs=opus","audio/mp4;codecs=mp4a.40.2","audio/mp4"].find(fe=>MediaRecorder.isTypeSupported(fe))??"audio/webm",me=new MediaRecorder(_.current,{mimeType:ue});I.current=me,me.ondataavailable=fe=>{if(fe.data.size>0){if(!z.current){M.current=fe.data,z.current=!0,U.current.push(fe.data);return}U.current.push(fe.data),k.current.push(fe.data)}},me.onstop=async()=>{if(!O.current)return;if(h){O.current=null;return}const fe=new Blob(U.current,{type:ue}),be=new Date,je=be.getTime()-O.current.startTime.getTime();let ye;try{ye=await Yr(fe)}catch{ye=fe}const Se={...O.current,endTime:be,duration:je,blob:ye,size:ye.size,transcriptionStatus:l?"pending":void 0};if(C(Te=>[...Te,Se]),E.current=[...E.current,Se],c)try{await st.saveChunk(Se,i),e==null||e(Se),l&&K(Se.id,ye,Se.name,f).catch(()=>{})}catch(Te){const F=Te instanceof Error?Te.message:"Failed to save session chunk";W(F),o==null||o(F)}else e==null||e(Se);O.current=null},me.onerror=()=>{W("Session recording failed"),o==null||o("Session recording failed")},me.start(100),y(!0),W(null)},[q,i,c,l,h,e,o,K]),ve=d.useCallback(()=>{I.current&&I.current.state!=="inactive"&&I.current.stop(),y(!1),x(!1),_.current&&(_.current.getTracks().forEach(G=>{G.stop()}),_.current=null)},[]),X=d.useCallback(()=>{w&&ve(),C([]),S(0),W(null),A.current=null,O.current=null},[w,ve]),H=d.useCallback(()=>{g&&(x(!1),A.current=null,k.current=[])},[g]),ae=d.useCallback(async G=>{if(C(ee=>ee.filter(ie=>ie.id!==G)),c)try{await st.deleteChunk(G)}catch(ee){o==null||o(`Failed to delete chunk from storage: ${ee instanceof Error?ee.message:"Unknown error"}`)}},[c]);d.useEffect(()=>{V()},[]),d.useEffect(()=>()=>{_.current&&_.current.getTracks().forEach(G=>G.stop())},[]);const he=d.useCallback(async()=>{if(!(!b||!$.current)){$.current.disconnect(),await new Promise(G=>setTimeout(G,100));try{await $.current.connect()}catch{o==null||o("Failed to reconnect WebSocket")}}},[b,o]),xe={isRecording:w,isChunkRecording:g,chunks:j,currentChunkNumber:N,error:D},de={startRecording:oe,stopRecording:ve,resetRecording:X},te=d.useCallback(async(G,ee)=>{if(C(ie=>{const Ne=ie.find(me=>me.id===G);if(!Ne)return ie;const ue={...Ne,transcription:ee,transcriptionStatus:"completed"};return queueMicrotask(()=>t==null?void 0:t(ue)),ie.map(me=>me.id===G?ue:me)}),c)try{await st.updateChunkTranscription(G,ee)}catch{}},[c,t]);return{state:xe,actions:de,startChunk:Q,stopChunk:Y,discardCurrentChunk:H,deleteChunk:ae,transcribeChunk:K,updateChunkTranscription:te,reconnectWebSocket:he}};function ap({config:s,isRecording:e,isChunkRecording:t,callbacks:a,cumulativeActiveTimeRef:n,peakAudioLevelRef:o}){const i=d.useRef(null),c=d.useRef(!1),l=d.useRef(null),u=d.useRef({vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold}),p=d.useRef({isRecording:e,isChunkRecording:t});d.useEffect(()=>{u.current={vadSilenceTimeout:s.vadSilenceTimeout,vadMaxChunkDuration:s.vadMaxChunkDuration,minActiveDuration:s.silenceDetectionConfig.minActiveDuration,activationThreshold:s.silenceDetectionConfig.activationThreshold},p.current={isRecording:e,isChunkRecording:t}},[s.vadSilenceTimeout,s.vadMaxChunkDuration,s.silenceDetectionConfig.minActiveDuration,s.silenceDetectionConfig.activationThreshold,e,t]);const h=d.useCallback(()=>{i.current=null,c.current=!1,l.current=null,o.current=0},[o]),f=d.useCallback(async()=>{i.current=Date.now(),c.current=!0,l.current=null,o.current=0,await a.startChunk()},[a,o]),b=d.useCallback(async g=>{g?await a.stopChunk():a.discardCurrentChunk(),h()},[a,h]),v=d.useCallback(async()=>{p.current.isChunkRecording?(c.current=!0,l.current=null):await f()},[f]),m=d.useCallback(async()=>{if(!p.current.isChunkRecording||!c.current)return;const g=Date.now();if(l.current===null){l.current=g;return}if(g-l.current>=u.current.vadSilenceTimeout){const N=n.current>=u.current.minActiveDuration,D=o.current>=u.current.activationThreshold;await b(N&&D)}},[b,n,o]),w=d.useCallback(async()=>{if(!p.current.isChunkRecording||!i.current)return;Date.now()-i.current>=u.current.vadMaxChunkDuration&&(await a.stopChunk(),c.current&&!p.current.isChunkRecording?await f():h())},[a,f,h]);return{processVADAudio:d.useCallback((g,x)=>{if(!p.current.isRecording)return;const j=!g,C=j&&x,N=j&&!p.current.isChunkRecording&&!c.current;(C||N)&&v(),g&&m(),w()},[v,m,w]),resetVADState:h}}const Ar={silenceThreshold:.47,minSilenceDuration:0,minActiveDuration:1500,activationThreshold:.67},ps={enableAutoTranscription:!0,minChunkDuration:500,silenceDetectionConfig:Ar,autoStopOnSilence:!1,autoCreateChunks:!0,autoChunkCreationTime:1e3,skipLastSessionChunk:!0,transcribeOptions:zo,chunkingMode:"time",vadMaxChunkDuration:1e4,vadSilenceTimeout:1500,useWebSocket:!1},Hs={default:{id:"custom-1759528805538",name:"Default (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:Ar.activationThreshold},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},eng:{id:"custom-1759528805538",name:"Eng (VAD)",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-distil-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},vi:{name:"VN",description:"Custom configuration",config:{silenceDetectionConfig:{silenceThreshold:.47,minSilenceDuration:1e3,minActiveDuration:500,activationThreshold:.67},autoCreateChunks:!1,transcribeOptions:{language:"vi",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1,model:"ggml-large-v3"},chunkingMode:"vad",vadMaxChunkDuration:3e4,vadSilenceTimeout:500}},ws:{name:"WS",description:"WebSocket real-time streaming",config:{silenceDetectionConfig:{minActiveDuration:800,activationThreshold:.67},useWebSocket:!0,chunkingMode:"time",autoCreateChunks:!0,autoChunkCreationTime:1e3,minChunkDuration:500,transcribeOptions:{language:"en",translate:!1,no_timestamps:!0,no_prints:!0,model:"ggml-distil-large-v3"}}}},Vo="audio-panel-custom-presets";function qo(s,e){if(s===e)return!0;if(typeof s!="object"||typeof e!="object"||s===null||e===null)return!1;const t=Object.keys(s),a=Object.keys(e);if(t.length!==a.length)return!1;for(const n of t)if(!a.includes(n)||!qo(s[n],e[n]))return!1;return!0}function Ko(s){const e={};return Object.keys(s).forEach(t=>{qo(s[t],ps[t])||(e[t]=s[t])}),e}function ra(s){return{...ps,...s,silenceDetectionConfig:{...ps.silenceDetectionConfig,...s.silenceDetectionConfig??{}},transcribeOptions:{...ps.transcribeOptions,...s.transcribeOptions??{}}}}function Is(){try{const s=localStorage.getItem(Vo);return s?JSON.parse(s).map(t=>({...t,createdAt:new Date(t.createdAt)})):[]}catch(s){return console.error("Failed to load custom presets:",s),[]}}function Ir(s){try{localStorage.setItem(Vo,JSON.stringify(s))}catch(e){console.error("Failed to save custom presets:",e)}}function rp(s,e,t){const a=Ko(t),n={id:`custom-${Date.now()}`,name:s,description:e,config:a,createdAt:new Date},o=Is();return o.push(n),Ir(o),n}function np(s,e){const t=Is(),a=t.findIndex(i=>i.id===s);if(a===-1)return console.error(`Preset with id ${s} not found`),null;const n=Ko(e),o={...t[a],config:n};return t[a]=o,Ir(t),o}function op(s){const t=Is().filter(a=>a.id!==s);Ir(t)}function ip(s={}){const e=d.useMemo(()=>({...Ar,...s}),[s]),[t,a]=Rc.useState({isSilent:!0,currentLevel:0,silenceThreshold:e.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}),n=d.useCallback(c=>{const l=Math.max(...c),u=Date.now();a(p=>{const h=u-p.lastStateChange,f=l<=p.silenceThreshold;let b=p.isSilent,v=p.silenceDuration,m=p.activeDuration,w=p.lastStateChange;return f?(v+=h,m=0,!p.isSilent&&v>=e.minSilenceDuration&&(b=!0,w=u)):(m+=h,v=0,p.isSilent&&m>=e.minActiveDuration&&(b=!1,w=u)),{isSilent:b,currentLevel:l,silenceThreshold:p.silenceThreshold,silenceDuration:v,activeDuration:m,lastStateChange:w}})},[e.minSilenceDuration,e.minActiveDuration,t.lastStateChange]),o=d.useCallback(c=>{const l=Math.max(0,Math.min(1,c));a(u=>({...u,silenceThreshold:l}))},[]),i=d.useCallback(()=>{a(c=>({isSilent:!0,currentLevel:0,silenceThreshold:c.silenceThreshold,silenceDuration:0,activeDuration:0,lastStateChange:Date.now()}))},[]);return{state:t,processAudioData:n,updateThreshold:o,reset:i}}const vt=d.forwardRef(({className:s,...e},t)=>r.jsxs(Gn,{ref:t,className:R("relative flex w-full touch-none select-none items-center",s),...e,children:[r.jsx(cl,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:r.jsx(ll,{className:"absolute h-full bg-primary"})}),r.jsx(dl,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));vt.displayName=Gn.displayName;const cp=({audioData:s,silenceState:e,onThresholdChange:t,hideSilenceControls:a=!1,duration:n=0,className:o=""})=>{const i=d.useCallback(u=>{t==null||t(u[0])},[t]),c=u=>{const p=u/1e3,h=Math.floor(p/60),f=Math.floor(p%60),b=Math.floor(p%1*10);return`${h}:${f.toString().padStart(2,"0")}.${b}`};return r.jsx("div",{className:`silence-detection-visualizer ${o}`,children:r.jsxs("div",{className:"visualization-container relative flex flex-col p-2 bg-muted/50 rounded-lg",style:{height:"64px"},children:[r.jsxs("div",{className:"top-controls flex justify-between items-center gap-2 mb-1 z-20",children:[r.jsx("div",{className:"time-display flex items-center",children:r.jsx("span",{className:"text-[9px] font-medium text-foreground",children:c(n)})}),r.jsxs("div",{className:"right-controls flex items-center gap-2",children:[r.jsxs("div",{className:"status-display flex items-center gap-1",children:[r.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${e.isSilent?"bg-gray-400":"bg-green-500 animate-pulse"}`}),r.jsx("span",{className:"text-[9px] font-medium",children:e.isSilent?"Silent":"Active"}),r.jsx("span",{className:"text-[9px] text-muted-foreground",children:`${(e.currentLevel*100).toFixed(0)}%`})]}),!a&&r.jsxs("div",{className:"threshold-control flex-1 flex items-center gap-1.5",children:[r.jsx("label",{className:"text-[9px] font-medium shrink-0",children:`T: ${(e.silenceThreshold*100).toFixed(0)}%`}),r.jsx(vt,{min:0,max:1,step:.01,value:[e.silenceThreshold],onValueChange:i,className:"flex-1"})]})]})]}),r.jsxs("div",{className:"bars-container relative flex items-end justify-center flex-1",children:[r.jsx("div",{className:"threshold-line absolute left-0 right-0 border-t border-red-500 border-dashed z-10",style:{bottom:`${e.silenceThreshold*100}%`}}),r.jsx("div",{className:"visualization-bars flex items-end justify-center gap-0.5 h-full w-full max-w-2xl relative z-0",children:s.map((u,p)=>{const h=Math.max(u*100,2),f=u>e.silenceThreshold;return r.jsx("div",{className:"visualization-bar flex-1 max-w-2 rounded-t transition-all duration-75 ease-out",style:{height:`${h}%`,backgroundColor:f?`rgba(34, 197, 94, ${.3+u*.7})`:`rgba(156, 163, 175, ${.3+u*.7})`,minHeight:"2px"}},p)})})]})]})})},yt=d.forwardRef(({className:s,...e},t)=>r.jsx(Vn,{className:R("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",s),...e,ref:t,children:r.jsx(ul,{className:R("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));yt.displayName=Vn.displayName;function Jo({transcribeOptions:s,useWebSocket:e,onTranscribeOptionsChange:t,onUseWebSocketChange:a}){return r.jsxs("div",{className:"transcription-options-section space-y-1 pt-2 border-t border-border",children:[r.jsx("h3",{className:"text-[9px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcription Options"}),r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"use-websocket",className:"text-[9px] font-semibold",children:"Use WebSocket Transcription"}),r.jsx(yt,{id:"use-websocket",checked:e,onCheckedChange:a,className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:e?"Real-time streaming with progress updates and word-by-word results":"Standard HTTP API with complete results"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsx(le,{className:"text-[9px] font-semibold",children:"Language"}),r.jsxs(It,{value:s.language??"auto",onValueChange:n=>t({...s,language:n}),children:[r.jsx(jt,{className:"h-7 text-[9px]",children:r.jsx(Rt,{placeholder:"Select language"})}),r.jsxs(Nt,{children:[r.jsx(we,{value:"auto",children:"Auto Detect"}),r.jsx(we,{value:"en",children:"English"}),r.jsx(we,{value:"vi",children:"Vietnamese"}),r.jsx(we,{value:"es",children:"Spanish"}),r.jsx(we,{value:"fr",children:"French"}),r.jsx(we,{value:"de",children:"German"}),r.jsx(we,{value:"pt",children:"Portuguese"}),r.jsx(we,{value:"ru",children:"Russian"}),r.jsx(we,{value:"ja",children:"Japanese"}),r.jsx(we,{value:"zh",children:"Chinese"}),r.jsx(we,{value:"ko",children:"Korean"}),r.jsx(we,{value:"it",children:"Italian"}),r.jsx(we,{value:"nl",children:"Dutch"})]})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Transcription language"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsx(le,{className:"text-[9px] font-semibold",children:"Model"}),r.jsxs(It,{value:s.model??en[0],onValueChange:n=>t({...s,model:n}),children:[r.jsx(jt,{className:"h-7 text-[9px]",children:r.jsx(Rt,{placeholder:"Select model"})}),r.jsx(Nt,{children:en.map(n=>r.jsx(we,{value:n,children:n},n))})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Whisper model"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"translate-english",className:"text-[9px] font-semibold",children:"Translate"}),r.jsx(yt,{id:"translate-english",checked:s.translate??!1,onCheckedChange:n=>t({...s,translate:n}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Translate to English"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"auto-detect-lang",className:"text-[9px] font-semibold",children:"Auto-Detect"}),r.jsx(yt,{id:"auto-detect-lang",checked:s.auto_detect_language??!1,onCheckedChange:n=>t({...s,auto_detect_language:n}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto language detection"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"no-timestamps",className:"text-[9px] font-semibold",children:"No Timestamps"}),r.jsx(yt,{id:"no-timestamps",checked:s.no_timestamps!==!1,onCheckedChange:n=>t({...s,no_timestamps:n}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Remove timestamps"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"no-prints",className:"text-[9px] font-semibold",children:"Quiet Mode"}),r.jsx(yt,{id:"no-prints",checked:s.no_prints!==!1,onCheckedChange:n=>t({...s,no_prints:n}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Suppress verbose output"})]})]})]})}const Ds="audio-panel-selected-preset";function lp({config:s,onConfigChange:e}){const[t,a]=d.useState([]),[n,o]=d.useState(!1),[i,c]=d.useState(""),[l,u]=d.useState(!1),[p,h]=d.useState("");d.useEffect(()=>{const g=Is();a(g);let x=localStorage.getItem(Ds);x||(x="default",localStorage.setItem(Ds,x)),h(x)},[]);const f=g=>{h(g),localStorage.setItem(Ds,g);const x=Hs[g];if(x){const C=ra(x.config);e(C);return}const j=t.find(C=>C.id===g);if(j){const C=ra(j.config);e(C)}},b=()=>{if(!i.trim()){alert("Please enter a preset name");return}const g=rp(i.trim(),"Custom configuration",s);a([...t,g]),c(""),o(!1)},v=()=>{c(""),o(!1)},m=g=>{const x=np(g,s);x&&(a(t.map(j=>j.id===g?x:j)),u(!0))},w=g=>{op(g),a(t.filter(x=>x.id!==g)),p===g&&(h(""),localStorage.removeItem(Ds))},y=()=>{const g=Hs[p];if(g)return g.name;const x=t.find(j=>j.id===p);return(x==null?void 0:x.name)||""};return r.jsxs("div",{className:"config-view space-y-2 text-[10px]",children:[r.jsxs("div",{className:"preset-selector space-y-1",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{className:"text-[9px] font-semibold",children:"Configuration Preset"}),!n&&r.jsx(ne,{variant:"ghost",size:"icon",className:"h-5 w-5 p-0",onClick:()=>o(!0),title:"Save current configuration as preset",children:r.jsx(Ia,{className:"h-3 w-3"})})]}),n?r.jsxs("div",{className:"flex gap-1",children:[r.jsx(Je,{placeholder:"Enter preset name...",value:i,onChange:g=>c(g.target.value),onKeyDown:g=>{g.key==="Enter"&&b(),g.key==="Escape"&&v()},className:"h-8 text-[9px] flex-1",autoFocus:!0}),r.jsx(ne,{onClick:b,size:"sm",className:"h-8 px-2",title:"Save preset",children:r.jsx(Ia,{className:"h-3 w-3"})}),r.jsx(ne,{onClick:v,size:"sm",variant:"ghost",className:"h-8 px-2",title:"Cancel",children:"âœ•"})]}):r.jsxs(It,{value:p,onValueChange:f,open:l,onOpenChange:u,children:[r.jsx(jt,{className:"h-8 text-[9px]",children:r.jsx(Rt,{placeholder:"Select a preset...",children:p&&r.jsx("span",{className:"font-medium",children:y()})})}),r.jsxs(Nt,{children:[Object.entries(Hs).map(([g,x])=>r.jsxs(we,{value:g,children:[r.jsx("span",{className:"font-medium",children:x.name}),r.jsx("span",{className:"text-[8px] text-muted-foreground ml-2",children:x.description})]},g)),t.map(g=>r.jsx(we,{value:g.id,children:r.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[r.jsxs("div",{className:"flex flex-col items-start flex-1 min-w-0",children:[r.jsx("span",{className:"font-medium",children:g.name}),r.jsx("span",{className:"text-[8px] text-muted-foreground",children:g.description})]}),r.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[r.jsx(ne,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:x=>{x.preventDefault(),x.stopPropagation(),m(g.id)},onClick:x=>{x.preventDefault(),x.stopPropagation()},title:"Update preset with current settings",children:r.jsx(Ia,{className:"h-3 w-3 text-blue-500"})}),r.jsx(ne,{variant:"ghost",size:"icon",className:"h-4 w-4 p-0",onPointerDown:x=>{x.preventDefault(),x.stopPropagation(),w(g.id)},onClick:x=>{x.preventDefault(),x.stopPropagation()},title:"Delete preset",children:r.jsx(Bt,{className:"h-3 w-3 text-red-500"})})]})]})},g.id))]})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:n?"Enter a name for the current configuration":"Quick apply preset configurations"})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"auto-transcription",className:"text-[9px] font-semibold",children:"Auto-Transcribe"}),r.jsx(yt,{id:"auto-transcription",checked:s.enableAutoTranscription,onCheckedChange:g=>e({enableAutoTranscription:g}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-transcribe chunks"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Chunk: ",s.minChunkDuration,"ms"]}),r.jsx(vt,{min:500,max:5e3,step:500,value:[s.minChunkDuration],onValueChange:g=>e({minChunkDuration:g[0]}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min chunk duration"})]}),r.jsxs("div",{className:"config-item space-y-0.5 col-span-2",children:[r.jsx(le,{className:"text-[9px] font-semibold",children:"Chunking Mode"}),r.jsxs(It,{value:s.chunkingMode,onValueChange:g=>e({chunkingMode:g}),children:[r.jsx(jt,{className:"h-7 text-[9px]",children:r.jsx(Rt,{})}),r.jsxs(Nt,{children:[r.jsx(we,{value:"time",children:"Time-based"}),r.jsx(we,{value:"vad",children:"Voice Activity Detection (VAD)"}),r.jsx(we,{value:"silence-based",children:"Silence-based Splitting"})]})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:s.chunkingMode==="time"?"Fixed interval chunking for predictable real-time updates":s.chunkingMode==="vad"?"Speech-driven chunking for natural boundaries and better accuracy":"VAD recording with post-processing silence-based splits for precise segmentation"})]}),s.chunkingMode==="time"&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"auto-create-chunks",className:"text-[9px] font-semibold",children:"Auto-Create"}),r.jsx(yt,{id:"auto-create-chunks",checked:s.autoCreateChunks,onCheckedChange:g=>e({autoCreateChunks:g}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-create chunks"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Auto-Time: ",s.autoChunkCreationTime,"ms"]}),r.jsx(vt,{min:500,max:5e3,step:500,value:[s.autoChunkCreationTime],onValueChange:g=>e({autoChunkCreationTime:g[0]}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Auto-creation interval"})]})]}),(s.chunkingMode==="vad"||s.chunkingMode==="silence-based")&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Max Duration: ",s.vadMaxChunkDuration,"ms"]}),r.jsx(vt,{min:3e3,max:3e4,step:1e3,value:[s.vadMaxChunkDuration],onValueChange:g=>e({vadMaxChunkDuration:g[0]}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Max VAD chunk duration (safety ceiling)"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Silence Timeout: ",s.vadSilenceTimeout,"ms"]}),r.jsx(vt,{min:500,max:5e3,step:100,value:[s.vadSilenceTimeout],onValueChange:g=>e({vadSilenceTimeout:g[0]}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence duration to end chunk"})]})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"skip-last-chunk",className:"text-[9px] font-semibold",children:"Skip Last Chunk"}),r.jsx(yt,{id:"skip-last-chunk",checked:s.skipLastSessionChunk,onCheckedChange:g=>e({skipLastSessionChunk:g}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Skip last session chunk"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{htmlFor:"auto-stop-silence",className:"text-[9px] font-semibold",children:"Auto-Stop"}),r.jsx(yt,{id:"auto-stop-silence",checked:s.autoStopOnSilence,onCheckedChange:g=>e({autoStopOnSilence:g}),className:"scale-75"})]}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Stop on silence"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Silence: ",Math.round(s.silenceDetectionConfig.silenceThreshold*100),"%"]}),r.jsx(vt,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.silenceThreshold],onValueChange:g=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,silenceThreshold:g[0]}}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Silence threshold"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Silent: ",s.silenceDetectionConfig.minSilenceDuration,"ms"]}),r.jsx(vt,{min:100,max:5e3,step:100,value:[s.silenceDetectionConfig.minSilenceDuration],onValueChange:g=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minSilenceDuration:g[0]}}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min silence duration"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Active: ",s.silenceDetectionConfig.minActiveDuration,"ms"]}),r.jsx(vt,{min:100,max:3e3,step:100,value:[s.silenceDetectionConfig.minActiveDuration],onValueChange:g=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,minActiveDuration:g[0]}}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Min active duration"})]}),r.jsxs("div",{className:"config-item space-y-0.5",children:[r.jsxs(le,{className:"text-[9px] font-semibold",children:["Activation: ",Math.round(s.silenceDetectionConfig.activationThreshold*100),"%"]}),r.jsx(vt,{min:0,max:1,step:.01,value:[s.silenceDetectionConfig.activationThreshold],onValueChange:g=>e({silenceDetectionConfig:{...s.silenceDetectionConfig,activationThreshold:g[0]}}),className:"w-full"}),r.jsx("p",{className:"text-[8px] text-muted-foreground leading-tight",children:"Peak level threshold (filters body noise)"})]})]}),r.jsx(Jo,{transcribeOptions:s.transcribeOptions,useWebSocket:s.useWebSocket,onTranscribeOptionsChange:g=>e({transcribeOptions:g}),onUseWebSocketChange:g=>e({useWebSocket:g})})]})}function os({audioBlob:s,isPlaying:e=!0,className:t="",height:a=80,barWidth:n=2,barGap:o=1,barColor:i="#94a3b8",progressColor:c="#3b82f6"}){const l=d.useRef(null),[u,p]=d.useState([]),[h,f]=d.useState(!1),[b,v]=d.useState({width:0,height:0});return d.useEffect(()=>{if(!s)return;let m=!1;return f(!0),(async()=>{try{const y=await s.arrayBuffer(),g=new AudioContext,x=await g.decodeAudioData(y);if(m){await g.close();return}const j=x.getChannelData(0),C=100,N=Math.floor(j.length/C),S=[];for(let I=0;I<C;I++){const _=N*I;let U=0;for(let M=0;M<N;M++){const O=j[_+M];U+=O*O}const k=Math.sqrt(U/N);S.push(k)}const D=Math.max(...S),W=1.5,E=S.map(I=>Math.min(1,I/D*W));m||p(E),await g.close()}catch(y){console.error("Failed to generate waveform:",y)}finally{m||f(!1)}})(),()=>{m=!0}},[s]),d.useEffect(()=>{if(h)return;const m=l.current;if(!m||u.length===0)return;const w=m.getContext("2d");if(!w)return;const y=m.width,g=m.height;if(y===0||g===0)return;const x=n+o,j=Math.min(u.length,Math.floor(y/x));w.clearRect(0,0,y,g);for(let C=0;C<j;C++){const N=Math.floor(C/j*u.length),S=u[N],D=Math.max(3,g*.05),W=g*.95,E=Math.max(D,S*W),I=C*x,_=(g-E)/2;w.fillStyle=e?c:i,w.fillRect(I,_,n,E)}},[u,e,n,o,i,c,b,h]),d.useEffect(()=>{const m=l.current;if(!m)return;const w=()=>{const y=m.parentElement;if(!y)return;const g=y.getBoundingClientRect();g.width>0&&g.height>0&&(m.width!==g.width||m.height!==g.height)&&(m.width=g.width,m.height=g.height,v({width:g.width,height:g.height}))};return w(),u.length>0&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{w()})}),window.addEventListener("resize",w),()=>{window.removeEventListener("resize",w)}},[a,u.length]),h?r.jsx("div",{className:`waveform-loading flex items-center justify-center ${t}`,style:{height:a},children:r.jsx("div",{className:"text-xs text-gray-400",children:"Generating waveform..."})}):r.jsx("div",{className:`waveform-container ${t}`,style:{height:a},children:r.jsx("canvas",{ref:l,className:"waveform-visualizer w-full h-full",style:{display:"block"}})})}function dp({chunk:s,isPlaying:e,onPlay:t,onPause:a,onDownload:n,onDelete:o,onTranscribe:i,variant:c="default",showTranscribe:l=!1}){const u=c==="error"?"hover:bg-red-100":"hover:bg-slate-200";return r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(ne,{size:"sm",variant:"ghost",onClick:e?a:t,className:`h-7 w-7 p-0 ${u}`,disabled:!s.blob,children:e?r.jsx(Dl,{className:"w-3.5 h-3.5"}):r.jsx(Ol,{className:"w-3.5 h-3.5"})}),r.jsx(ne,{size:"sm",variant:"ghost",onClick:n,className:`h-7 w-7 p-0 ${u}`,disabled:!s.blob,children:r.jsx(Ml,{className:"w-3.5 h-3.5"})}),l&&i&&r.jsx(ne,{size:"sm",variant:"ghost",onClick:i,className:`h-7 w-7 p-0 text-blue-600 hover:text-blue-700 ${c==="error"?"hover:bg-red-100":"hover:bg-blue-50"}`,disabled:!s.blob||s.transcriptionStatus==="processing",title:"Transcribe audio",children:r.jsx(Ha,{className:"w-3.5 h-3.5"})}),o&&r.jsx(ne,{size:"sm",variant:"ghost",onClick:o,className:`h-7 w-7 p-0 text-red-600 hover:text-red-700 ${c==="error"?"hover:bg-red-100":"hover:bg-red-50"}`,children:r.jsx(Bt,{className:"w-3.5 h-3.5"})})]})}function up({duration:s,variant:e="default"}){const t=n=>{const o=n/1e3,i=Math.floor(o),c=Math.floor((o-i)*100);return c>0?`${i}.${c.toString().padStart(2,"0")}s`:`${i}s`},a={completed:"text-xs text-green-600 border-green-600 bg-green-50",processing:"text-xs text-blue-600 border-blue-600 bg-blue-50",failed:"text-xs text-red-600 border-red-600 bg-red-50",pending:"text-xs text-gray-600 border-gray-400 bg-gray-50",default:"text-xs text-gray-600 border-gray-400 bg-gray-50"};return r.jsxs(tt,{variant:"outline",className:a[e],children:[r.jsx(io,{className:"w-3 h-3 mr-1"}),t(s)]})}const pp={completed:{className:"bg-card",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>r.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&r.jsx(os,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),r.jsx("div",{className:"text-sm leading-relaxed font-medium",children:s.transcription})]})},processing:{className:"bg-blue-50 border-blue-200",badgeVariant:"processing",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>r.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&r.jsx(os,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(va,{className:"w-4 h-4 text-blue-600 animate-spin"}),r.jsx("span",{className:"text-sm font-medium text-blue-700",children:"Transcribing audio..."})]})]})},failed:{className:"bg-red-50 border-red-200",badgeVariant:"failed",controlsVariant:"error",showTranscribe:!0,renderContent:(s,e,t)=>r.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&r.jsx(os,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(_l,{className:"w-4 h-4 text-red-600"}),r.jsxs("span",{className:"text-sm font-medium text-red-700",children:["Transcription Failed",s.transcriptionError&&r.jsxs("span",{className:"text-xs font-normal ml-1",children:["(",s.transcriptionError,")"]})]})]})]})},pending:{className:"bg-gray-50 border-gray-200",badgeVariant:"pending",controlsVariant:void 0,showTranscribe:!1,renderContent:(s,e,t)=>r.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&r.jsx(os,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(io,{className:"w-4 h-4 text-gray-500"}),r.jsx("span",{className:"text-sm text-gray-600",children:"Waiting to transcribe..."})]})]})},none:{className:"bg-gray-50 border-gray-200",badgeVariant:"default",controlsVariant:void 0,showTranscribe:!0,renderContent:(s,e,t)=>r.jsxs("div",{className:"flex-1 space-y-2",children:[t&&s.blob&&r.jsx(os,{audioBlob:s.blob,isPlaying:e,className:"w-full",height:60}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(vr,{className:"w-4 h-4 text-gray-500"}),r.jsx("span",{className:"text-sm text-gray-600",children:"No transcription available"})]})]})}};function hp({chunk:s,isPlaying:e,showWaveform:t,onPlay:a,onPause:n,onDownload:o,onDelete:i,onTranscribe:c}){const u=s.transcription?"completed":s.transcriptionStatus==="processing"?"processing":s.transcriptionStatus==="failed"?"failed":s.transcriptionStatus==="pending"?"pending":"none",p=pp[u];return r.jsx(ks,{className:"chunk-item shadow-sm",children:r.jsx(Ts,{className:"p-0",children:r.jsxs("div",{className:`flex flex-col border rounded-md py-2 px-2 gap-2 ${p.className}`,children:[p.renderContent(s,e,t),r.jsxs("div",{className:"flex justify-between items-center",children:[s.duration&&r.jsx(up,{duration:s.duration,variant:p.badgeVariant}),r.jsx(dp,{chunk:s,isPlaying:e,onPlay:a,onPause:n,onDownload:o,onDelete:i,onTranscribe:c,variant:p.controlsVariant,showTranscribe:p.showTranscribe})]})]})})})}function Qo({chunks:s,className:e="",onChunkDelete:t,onChunkTranscribe:a,onTranscribeAll:n,onClearAll:o}){const[i,c]=d.useState(null),[l,u]=d.useState(!1),[p,h]=d.useState({language:"vi",model:"ggml-distil-large-v3",translate:!1,no_timestamps:!0,no_prints:!0,auto_detect_language:!1}),[f,b]=d.useState(!1),v=d.useRef(null),m=d.useRef(null),w=d.useCallback(W=>{if(!W.blob)return;v.current&&(v.current.pause(),m.current&&URL.revokeObjectURL(m.current));const E=new Audio;v.current=E;const I=URL.createObjectURL(W.blob);m.current=I,E.src=I,E.onplay=()=>{c(W.id)},E.onpause=()=>{c(null)},E.onended=()=>{c(null),m.current&&(URL.revokeObjectURL(m.current),m.current=null)},E.onerror=_=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Audio playback error:",_),c(null),m.current&&(URL.revokeObjectURL(m.current),m.current=null)},E.play().catch(_=>{console.error("ðŸŽ¤ðŸ“¦ðŸ”Š âŒ Failed to play audio:",_),c(null)})},[]),y=d.useCallback(()=>{v.current&&v.current.pause()},[]),g=d.useCallback(W=>{if(!W.blob)return;const E=URL.createObjectURL(W.blob),I=document.createElement("a");I.href=E,I.download=`${W.name}.wav`,document.body.appendChild(I),I.click(),document.body.removeChild(I),URL.revokeObjectURL(E)},[]),x=d.useCallback(async W=>{i===W&&v.current&&(v.current.pause(),c(null)),await(t==null?void 0:t(W))},[i,t]),j=d.useCallback(async W=>{await(a==null?void 0:a(W))},[a]),C=d.useCallback(async()=>{v.current&&(v.current.pause(),c(null)),await(o==null?void 0:o())},[o]),N=d.useCallback(async()=>{await(n==null?void 0:n(p))},[n,p]);d.useEffect(()=>()=>{v.current&&v.current.pause(),m.current&&URL.revokeObjectURL(m.current)},[]);const S=s.reduce((W,E)=>W+(E.duration??0),0),D=s.reduce((W,E)=>W+(E.size??0),0);return r.jsx("div",{className:`chunks-panel flex flex-col h-full ${e}`,children:r.jsxs(ks,{className:"flex-1 flex flex-col",children:[r.jsxs(kr,{className:"pb-4",children:[r.jsxs(Tr,{className:"flex items-center justify-between",children:[r.jsx("span",{children:"Audio Chunks"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(tt,{variant:"outline",children:s.length}),s.length>0&&n&&r.jsx(wa,{variant:"ghost",size:"sm",buttonClassName:"h-6 w-6 p-0",contentClassName:"w-80",title:"Transcription Options",align:"end",storageKey:"chunks-panel-transcription-options",children:r.jsx("div",{className:"chunk-options-config",children:r.jsx(jr,{label:"Transcribe All",onAction:N,size:"sm",className:"w-full",tooltipText:"Click to transcribe all chunks, or click gear for options",popoverContent:r.jsx(Jo,{transcribeOptions:p,useWebSocket:f,onTranscribeOptionsChange:h,onUseWebSocketChange:b})})})}),s.length>0&&r.jsx(ne,{variant:"ghost",size:"sm",onClick:()=>u(!l),className:`h-6 px-2 text-xs ${l?"bg-blue-50 text-blue-600":"text-gray-600"}`,title:l?"Hide waveforms":"Show waveforms",children:r.jsx(Pl,{className:"w-3 h-3"})}),s.length>0&&o&&r.jsx(ne,{variant:"ghost",size:"sm",onClick:C,className:"h-6 px-2 text-xs text-red-600 hover:text-red-700 hover:bg-red-50",title:"Clear all chunks",children:r.jsx(Bt,{className:"w-3 h-3"})})]})]}),s.length>0&&r.jsxs("div",{className:"stats-summary text-xs text-gray-600 space-y-1",children:[r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Total Duration:"}),r.jsxs("span",{children:[Math.floor(S/1e3),"s"]})]}),r.jsxs("div",{className:"flex justify-between",children:[r.jsx("span",{children:"Total Size:"}),r.jsxs("span",{children:[(D/1024).toFixed(1)," KB"]})]})]})]}),r.jsx(Ts,{className:"flex-1 overflow-hidden p-4",children:s.length===0?r.jsxs("div",{className:"empty-state flex flex-col items-center justify-center h-full text-center text-gray-500",children:[r.jsx("div",{className:"mb-2",children:"ðŸŽ¤"}),r.jsx("p",{className:"text-sm",children:"No chunks recorded yet"}),r.jsx("p",{className:"text-xs mt-1",children:"Start recording and speak to create chunks"})]}):r.jsx("div",{className:"chunks-list overflow-y-auto h-full space-y-2 pr-2",children:s.slice().reverse().map(W=>r.jsx(hp,{chunk:W,isPlaying:i===W.id,showWaveform:l,onPlay:()=>w(W),onPause:y,onDownload:()=>g(W),onDelete:()=>void x(W.id),onTranscribe:a?()=>void j(W.id):void 0},W.id))})})]})})}const tn="audio-panel-config";function fp({sessionName:s="audio-panel-session",enableAutoPersist:e=!0,loadPersistedChunks:t=!1,initialConfig:a,autoStart:n=!1,startTrigger:o,stopTrigger:i,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:u,onSilenceDetected:p,onClearAndRecord:h,onWordReceived:f,onTranscriptionProgress:b,onRecordingStateChange:v,className:m=""}){const[w,y]=d.useState(Array(32).fill(0)),[g,x]=d.useState(0),C=(()=>{try{const B=localStorage.getItem(tn);if(B)return JSON.parse(B)}catch(B){console.error("Failed to load persisted config:",B)}return{}})(),[N,S]=d.useState(()=>{let B={...ps,...C},re=localStorage.getItem("audio-panel-selected-preset");if(re||(re="default",localStorage.setItem("audio-panel-selected-preset",re)),re)try{const ce=Hs[re];if(ce)B=ra(ce.config);else{const Le=Is().find(mt=>mt.id===re);Le&&(B=ra(Le.config))}}catch(ce){console.error("Failed to apply selected preset:",ce)}return{...B,...a}}),D=d.useRef(null),W=d.useRef(null),E=d.useRef(null),I=d.useRef(null),_=d.useRef(!1),U=d.useCallback(B=>{console.error("ðŸŽ¤ Recorder error:",B)},[]),k=d.useRef(N.autoStopOnSilence),M=d.useRef(p),O=d.useRef(null),A=d.useRef(null),P=d.useRef(null),z=d.useRef(!1),$=d.useRef(!0),T=d.useRef(0),L=d.useRef(null),V=d.useRef(0),K=d.useRef(N.chunkingMode);d.useEffect(()=>{k.current=N.autoStopOnSilence},[N.autoStopOnSilence]),d.useEffect(()=>{K.current=N.chunkingMode},[N.chunkingMode]),d.useEffect(()=>{M.current=p},[p]);const{state:q,actions:Q,startChunk:Y,stopChunk:oe,discardCurrentChunk:ve,deleteChunk:X,transcribeChunk:H,updateChunkTranscription:ae,reconnectWebSocket:he}=sp({sessionName:s,enableAutoPersist:e,enableAutoTranscription:N.chunkingMode==="silence-based"?!1:N.enableAutoTranscription,minChunkDuration:N.minChunkDuration,loadPersistedChunks:t,skipLastSessionChunk:N.skipLastSessionChunk,transcribeOptions:N.transcribeOptions,useWebSocket:N.useWebSocket,onWordReceived:f,onTranscriptionProgress:b,onChunkCreated:c,onChunkUpdated:l,onChunkDeleted:u,onError:U}),xe=d.useCallback(B=>{if(B.length===0)return"";if(B.length===1)return B[0].trim();let re=B[0].trim();for(let ce=1;ce<B.length;ce++){let ge=B[ce].trim();if(!ge)continue;!/[.!?â€¦]$/.test(re)&&ge.length>0&&(ge=ge.charAt(0).toLowerCase()+ge.slice(1)),re=`${re} ${ge}`}return re},[]),de=d.useCallback(async B=>{if(N.chunkingMode==="silence-based"&&B.blob){console.log(`ðŸŽ¤ Processing chunk for silence-based splitting: ${B.name} (${B.blob.size} bytes)`);try{const re=await B.blob.arrayBuffer(),ge=await new AudioContext().decodeAudioData(re);console.log(`ðŸŽ¤ AudioBuffer duration: ${ge.duration.toFixed(2)}s`);const Le=aa.DEFAULT;console.log("ðŸŽ¤ Using DEFAULT preset:",Le);const $e=await new Go(Le).chunkAudio(ge);if(console.log(`ðŸŽ¤ Silence-based split: ${$e.length} chunks detected`),console.log("ðŸŽ¤ Chunk details:",$e.map((Ee,it)=>({index:it+1,startTime:Ee.startTime.toFixed(2)+"s",endTime:Ee.endTime.toFixed(2)+"s",duration:Ee.duration.toFixed(2)+"s",blobSize:Ee.blob.size+" bytes"}))),N.enableAutoTranscription&&$e.length>0){const Ee=[];for(let ct=0;ct<$e.length;ct++){const qt=$e[ct],rs=`${B.name}-split-${ct+1}`;console.log(`ðŸŽ¤ Transcribing split ${ct+1}/${$e.length}: ${rs} (${qt.duration.toFixed(2)}s)`);try{const Pt=new File([qt.blob],`${rs}.wav`,{type:"audio/wav"}),Ve=await Ho.transcribeAudio(Pt,N.transcribeOptions);Ee.push(Ve.transcription),console.log(`ðŸŽ¤ Split ${ct+1} transcribed: "${Ve.transcription}"`);const lt=xe(Ee);lt&&(await ae(B.id,lt),console.log(`ðŸŽ¤ Progressive update: "${lt}"`))}catch(Pt){console.error(`ðŸŽ¤ Failed to transcribe split ${ct+1}:`,Pt),Ee.push(`[Error: ${Pt instanceof Error?Pt.message:"Unknown error"}]`)}}const it=xe(Ee);console.log(`ðŸŽ¤ Final transcription (${$e.length} splits): "${it}"`)}}catch(re){console.error("ðŸŽ¤ Failed to split chunk by silence:",re)}}},[N,ae,xe]);d.useEffect(()=>{if(N.chunkingMode==="silence-based"&&q.chunks.length>0){const B=q.chunks[q.chunks.length-1];!B.transcription&&!B.transcriptionStatus&&de(B)}},[q.chunks,N.chunkingMode,de]);const te=ip(N.silenceDetectionConfig),G=d.useRef(te);d.useEffect(()=>{G.current=te},[te]);const ee=ap({config:N.chunkingMode==="silence-based"?{...N,vadSilenceTimeout:100}:N,isRecording:q.isRecording,isChunkRecording:q.isChunkRecording,callbacks:{startChunk:Y,stopChunk:oe,discardCurrentChunk:ve},cumulativeActiveTimeRef:T,peakAudioLevelRef:V}),ie=d.useRef(ee);d.useEffect(()=>{ie.current=ee},[ee]);const Ne=d.useCallback(B=>{var re;S(ce=>{const ge={...ce,...B};return B.silenceDetectionConfig&&(ge.silenceDetectionConfig={...ce.silenceDetectionConfig,...B.silenceDetectionConfig}),B.transcribeOptions&&(ge.transcribeOptions={...ce.transcribeOptions,...B.transcribeOptions}),ge}),((re=B.silenceDetectionConfig)==null?void 0:re.silenceThreshold)!==void 0&&te.updateThreshold(B.silenceDetectionConfig.silenceThreshold)},[te]);d.useEffect(()=>{try{localStorage.setItem(tn,JSON.stringify(N))}catch(B){console.error("Failed to persist config:",B)}},[N]),d.useEffect(()=>{P.current=Y},[Y]),d.useEffect(()=>{O.current=oe},[oe]),d.useEffect(()=>{A.current=ve},[ve]);const ue=d.useRef(q.isRecording);d.useEffect(()=>{ue.current=q.isRecording},[q.isRecording]),d.useEffect(()=>{z.current=q.isChunkRecording},[q.isChunkRecording]);const me=d.useCallback(async()=>{try{const B=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),re=new AudioContext,ce=re.createAnalyser();ce.fftSize=256,ce.smoothingTimeConstant=.8,re.createMediaStreamSource(B).connect(ce),D.current=re,W.current=ce;const Le=()=>{var rs,Pt;if(!W.current)return;const mt=W.current.frequencyBinCount,$e=new Uint8Array(mt);W.current.getByteFrequencyData($e);const Ee=32,it=Math.floor(mt/Ee),ct=[];for(let Ve=0;Ve<Ee;Ve++){let lt=0;for(let Aa=0;Aa<it;Aa++)lt+=$e[Ve*it+Aa];const Ec=lt/it/255;ct.push(Ec)}if(y(ct),G.current.processAudioData(ct),z.current){const Ve=G.current.state.currentLevel;Ve>V.current&&(V.current=Ve)}if(K.current==="vad"||K.current==="silence-based"){const Ve=G.current.state.isSilent,lt=$.current;ie.current.processVADAudio(Ve,lt)}const qt=Date.now();if(z.current)if(L.current===null)L.current=qt;else{const Ve=qt-L.current;$.current||(T.current+=Ve),L.current=qt}else L.current=null,T.current=0;if(k.current&&q.isChunkRecording){const Ve=G.current.state.isSilent,lt=_.current;!lt&&!Ve?_.current=!0:lt&&Ve&&((rs=M.current)==null||rs.call(M),(Pt=O.current)==null||Pt.call(O),_.current=!1)}$.current=G.current.state.isSilent,E.current=requestAnimationFrame(Le)};Le()}catch(B){console.error("ðŸŽ¤ âŒ Failed to setup audio analysis:",B)}},[]),fe=d.useCallback(()=>{E.current&&(cancelAnimationFrame(E.current),E.current=null),D.current&&(D.current.close(),D.current=null),W.current=null,y(Array(32).fill(0)),G.current.reset(),ie.current.resetVADState(),_.current=!1},[]),be=d.useCallback(async()=>{if(q.isRecording){if(q.isChunkRecording){const B=T.current,re=N.silenceDetectionConfig.minActiveDuration,ce=V.current,ge=N.silenceDetectionConfig.activationThreshold;B>=re&&ce>=ge?await oe():ve()}Q.stopRecording(),ue.current=!1,fe(),I.current=null}else await Q.startRecording(),ue.current=!0,await me(),I.current=Date.now(),N.chunkingMode==="time"&&(await Y(),_.current=!1)},[q.isRecording,q.isChunkRecording,Q,me,fe,N.chunkingMode,N.silenceDetectionConfig.minActiveDuration,N.silenceDetectionConfig.activationThreshold,Y,oe,ve]);d.useEffect(()=>{if(!q.isRecording)return;const B=setInterval(()=>{I.current&&x(Date.now()-I.current)},100);return()=>clearInterval(B)},[q.isRecording]),d.useEffect(()=>()=>{fe()},[fe]);const je=d.useRef(null);d.useEffect(()=>{je.current!==null&&je.current!==q.isRecording&&(v==null||v(q.isRecording)),je.current=q.isRecording},[q.isRecording,v]),d.useEffect(()=>{n&&!q.isRecording&&be()},[n]),d.useEffect(()=>{o!==void 0&&o>0&&!q.isRecording&&be()},[o]),d.useEffect(()=>{i!==void 0&&i>0&&q.isRecording&&be()},[i]);const ye=d.useCallback(async B=>{const re=q.chunks.find(ce=>ce.id===B);if(!(re!=null&&re.blob)){console.error("ðŸŽ¤ âŒ Cannot transcribe chunk: blob not found",B);return}await H(B,re.blob,re.name,N.transcribeOptions)},[q.chunks,H,N]),Se=d.useCallback(async B=>{await X(B),u==null||u(B)},[X,u]),Te=d.useCallback(async()=>{const B=q.chunks.map(re=>re.id);await Promise.all(B.map(re=>Se(re)))},[q.chunks,Se]),F=d.useCallback(async()=>{await Te(),h==null||h(),await he(),q.isRecording||await be()},[Te,h,he,q.isRecording,be]);return d.useEffect(()=>{if(!q.isRecording||N.chunkingMode!=="time")return;const B=setInterval(()=>{var mt,$e;const re=T.current,ce=N.silenceDetectionConfig.minActiveDuration,ge=V.current,Le=N.silenceDetectionConfig.activationThreshold;if(re<ce||ge<Le){(mt=A.current)==null||mt.call(A),setTimeout(()=>{var Ee;(Ee=P.current)==null||Ee.call(P),T.current=0,V.current=0},50);return}($e=O.current)==null||$e.call(O),setTimeout(()=>{var Ee;(Ee=P.current)==null||Ee.call(P),T.current=0,V.current=0},50)},N.autoChunkCreationTime);return()=>{clearInterval(B)}},[q.isRecording,N.autoChunkCreationTime,N.silenceDetectionConfig.minActiveDuration,N.silenceDetectionConfig.activationThreshold,N.chunkingMode]),r.jsx("div",{className:`audio-panel ${m}`,children:r.jsx(ks,{children:r.jsxs(Ts,{className:"p-3 space-y-1",children:[r.jsxs("div",{className:"controls-section flex justify-between items-center gap-1",children:[r.jsx(Fu,{onClick:be,label:q.isRecording?"Stop":"Record",icon:q.isRecording?fs:yr,variant:q.isRecording?"destructive":"default",size:"sm",options:[{label:"Clear and Record",onClick:F}],showDropdown:!q.isRecording,className:"recording-toggle-group"}),r.jsxs(Ge,{children:[r.jsx(Xe,{asChild:!0,children:r.jsx(ne,{variant:"secondary",size:"sm",children:r.jsx(Ll,{className:"w-3 h-3"})})}),r.jsx(We,{className:"w-80 p-3",align:"end",children:r.jsx(lp,{config:N,onConfigChange:Ne})})]})]}),r.jsx("div",{className:"visualizer-section",children:r.jsx(cp,{audioData:w,silenceState:te.state,onThresholdChange:te.updateThreshold,hideSilenceControls:!0,duration:g})}),(N.chunkingMode==="vad"||N.chunkingMode==="silence-based")&&q.isRecording&&r.jsxs("div",{className:"vad-activity-indicator p-2 bg-slate-50 border border-slate-200 rounded-lg",children:[r.jsxs("div",{className:"flex items-center justify-between mb-1",children:[r.jsx("span",{className:"text-[9px] font-semibold text-slate-600",children:"VAD Activity"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("span",{className:"text-[8px] text-slate-500",children:["Level: ",(te.state.currentLevel*100).toFixed(0),"%"]}),r.jsx("div",{className:`px-1.5 py-0.5 rounded text-[8px] font-medium ${te.state.isSilent?"bg-gray-100 text-gray-600":"bg-green-100 text-green-700"}`,children:te.state.isSilent?"ðŸ”‡ Silent":"ðŸŽ™ï¸ Active"})]})]}),r.jsxs("div",{className:"relative h-2 bg-slate-200 rounded-full overflow-hidden",children:[te.state.silenceThreshold>0&&r.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-400 z-10",style:{left:`${te.state.silenceThreshold*100}%`},title:`Threshold: ${(te.state.silenceThreshold*100).toFixed(0)}%`}),r.jsx("div",{className:`h-full transition-all duration-100 ${te.state.isSilent?"bg-gray-400":"bg-green-500"}`,style:{width:`${te.state.currentLevel*100}%`}})]}),q.isChunkRecording&&r.jsxs("div",{className:"mt-1 text-[8px] text-blue-600 flex items-center gap-1",children:[r.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-blue-600 rounded-full animate-pulse"}),"Recording chunk..."]})]}),q.error&&r.jsx("div",{className:"error-display p-1.5 bg-red-50 border border-red-200 rounded-lg",children:r.jsx("p",{className:"text-[10px] text-red-600",children:q.error})}),r.jsx(Qo,{chunks:q.chunks,onChunkDelete:Se,onChunkTranscribe:ye,onClearAll:Te})]})})})}const sn=s=>{let e;const t=new Set,a=(u,p)=>{const h=typeof u=="function"?u(e):u;if(!Object.is(h,e)){const f=e;e=p??(typeof h!="object"||h===null)?h:Object.assign({},e,h),t.forEach(b=>b(e,f))}},n=()=>e,c={setState:a,getState:n,getInitialState:()=>l,subscribe:u=>(t.add(u),()=>t.delete(u))},l=e=s(a,n,c);return c},Xo=(s=>s?sn(s):sn);var Rr=(s=>(s.ADD="add",s.DRAW_ARROW="draw_arrow",s.SELECT="select",s.MOVE="move",s.ZOOM="zoom",s.WRITE="write",s.GRID="grid",s.VIM="vim",s))(Rr||{}),Gs=(s=>(s.WRITE="write",s.AUDIO="write:audio",s))(Gs||{}),Ke=(s=>(s.RECT="RECT",s.TABLE="TABLE",s.TEXT="TEXT",s.ARROW="ARROW",s.TEXTCARD="TEXTCARD",s.WORKFLOW_ORCHESTRATION="WORKFLOW_ORCHESTRATION",s.WORKFLOW_SOURCE="WORKFLOW_SOURCE",s.WORKFLOW_DEFINITION="WORKFLOW_DEFINITION",s.OCR="OCR",s.IMAGE="IMAGE",s))(Ke||{});const jb=["content","title","x","y","width","height","createdAt","updatedAt","id","type"],Nb={content:"Content",title:"Title",x:"X Position",y:"Y Position",width:"Width",height:"Height",createdAt:"Created At",updatedAt:"Updated At",id:"ID",type:"Type"},Eb=["title","content"],kb={title:"Title",content:"Content"};let Fe=(s=21)=>crypto.getRandomValues(new Uint8Array(s)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class Os{static loadPreset(e){const t=new Map,a=this.convertStepsToRows(e.steps,t),n=t.get(1)||"row_1";return{id:`wf-preset-${e.id}`,x:0,y:0,width:400,height:300,type:Ke.RECT,title:e.name,content:e.description,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:a},inputHandles:[{id:`input_${n}`,name:"All Nodes",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Result",type:"output",dataType:"any"}]}}}static convertStepsToRows(e,t,a){return e.map(n=>{const o=Fe();t.set(n.order,o);const i={id:o,label:n.label,order:n.order,stepType:n.type};if(n.config){const c=JSON.parse(JSON.stringify(n.config));c.dataSource==="row_1"&&(c.dataSource=t.get(1)||"row_1"),i.config=c}return n.children&&n.children.length>0&&(i.children=this.convertStepsToRows(n.children,t,n.order)),i})}static async loadPresetFromFile(e){const t=await ze(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),a=JSON.parse(t.readFileSync(e,"utf-8"));return this.loadPreset(a)}}const mp=8,gp=0,xp=-5,Tb="__paste-create__",Ma=4,He={DEFAULT_NODE_WIDTH:120,DEFAULT_NODE_HEIGHT:31,FONT_SIZE_DEFAULT:16,FONT_SIZE_SMALL:14,FONT_SIZE_XS:13,FONT_SIZE_XXS:12,FONT_SIZE_MINI:10,LINE_HEIGHT:24,LINE_HEIGHT_CONFIG:25,LINE_HEIGHT_FIND:20,DEFAULT_PADDING:Ma,NODE_X_PADDING:Ma*2,NODE_Y_PADDING:Ma*2,nodeSpacing:20,NODE_ALIGNMENT_PADDING:16,writeMode:{yRatio:.67},TEXT_MODE_ADJUST_Y:25,NEW_NODE_SEGMENT_SPACING:15,MIN_RESIZE_WIDTH:100,MIN_RESIZE_HEIGHT:100,HANDLE_OFFSET:mp/2,HANDLE_BG_COLOR:"bg-primary",HANDLE_BORDER_COLOR:"border-primary-foreground",SELECTION_RING_COLOR:"ring-ring",SELECTED_BORDER_COLOR:"border-ring",CUSTOM_CHARACTERS:["?","!"]},Ab={textNodeXPadding:He.NODE_X_PADDING*4},bp="capitalize",vp="Capitalize",wp="Capitalize first letter of text",yp=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Capitalize",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.capitalize()}}"}]}}]}],Sp={id:bp,name:vp,description:wp,steps:yp},Cp="trim-symbols-light",jp="Trim Symbols (Light)",Np="Remove punctuation and special characters from start/end of text",Ep=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsLight()}}"}]}}]}],kp={id:Cp,name:jp,description:Np,steps:Ep},Tp="trim-symbols-strict",Ap="Trim Symbols (Strict)",Ip="Remove all non-alphanumeric characters from start/end of text",Rp=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Trim Symbols",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title.trimSymbolsStrict()}}"}]}}]}],Pp={id:Tp,name:Ap,description:Ip,steps:Rp},_p="add-full-stop",Dp="Add Full Stop",Op="Add a full stop (.) at the end of text",Mp=[{type:"source",label:"Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Add Full Stop",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.current.title}}."}]}}]}],Lp={id:_p,name:Dp,description:Op,steps:Mp};function Yo(){const s="workflow-templates-project",e="workflow-templates-workspace",t=Os.loadPreset(Sp),a=Os.loadPreset(kp),n=Os.loadPreset(Pp),o=Os.loadPreset(Lp),i="canvas-workflow-presets",c={id:i,name:"ðŸŽ¨ Workflow Presets",createdAt:Date.now(),lastModified:Date.now(),coreState:{nodes:[{id:Fe(8),x:50,y:50,type:Ke.TEXT,content:`ðŸŽ¨ Workflow Presets Library

Reusable workflow templates powered by JSON configuration.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How to Use:
1. Copy a preset workflow node below (Ctrl+C / Cmd+C)
2. Paste into your target canvas (Ctrl+V / Cmd+V)
3. Click Execute button on the workflow node
4. Done! All canvas nodes are processed automatically

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Key Features (WF-32):
âœ… Source node is OPTIONAL - workflows iterate through all canvas nodes
âœ… Templates use loop context: {{loop.index}}, {{loop.current.title}}
âœ… Simple mode with field updates or advanced mode with explicit targets

See: _docs/guidelines/canvas/workflow-presets-and-execution.md`,styles:{fontSize:`${He.FONT_SIZE_SMALL}px`,fontWeight:"bold",textColor:"#1f2937"}},{id:Fe(8),x:50,y:400,type:Ke.TEXT,content:`ðŸ”¤ Capitalize

Capitalize first letter of text.
Template: {{loop.current.title.capitalize()}}

Result: "hello world" â†’ "Hello world"`,styles:{fontSize:`${He.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...t,x:50,y:550},{id:Fe(8),x:450,y:400,type:Ke.TEXT,content:`âœ‚ï¸ Trim Symbols (Light)

Remove punctuation and special chars from edges.
Template: {{loop.current.title.trimSymbolsLight()}}

Result: "  - hello,  " â†’ "hello"`,styles:{fontSize:`${He.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...a,x:450,y:550},{id:Fe(8),x:850,y:400,type:Ke.TEXT,content:`ðŸ§¹ Trim Symbols (Strict)

Remove ALL non-alphanumeric from edges.
Template: {{loop.current.title.trimSymbolsStrict()}}

Result: "***hello***" â†’ "hello"`,styles:{fontSize:`${He.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...n,x:850,y:550},{id:Fe(8),x:1250,y:400,type:Ke.TEXT,content:`ðŸ“ Add Full Stop

Append a full stop (.) to end of text.
Template: {{loop.current.title}}.

Result: "Hello world" â†’ "Hello world."`,styles:{fontSize:`${He.FONT_SIZE_XS}px`,textColor:"#1f2937"}},{...o,x:1250,y:550}],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1,targetView:null}},l={id:e,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),canvases:{[i]:c},activeCanvasId:i};return{id:s,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[e]:l},activeWorkspaceId:e}}const $p=[{id:Fe(8),x:600,y:100,type:Ke.TEXT,content:"Node 2 - Text"}],Wt={nameInput:"wf-name-input-001",orchestration:"wf-orchestration-001",output:"wf-output-001"},Up=[{id:Wt.nameInput,x:100,y:350,width:200,height:80,type:Ke.TEXT,title:"âœï¸ Processing {{loop.current}}",content:`Alice
Bob
Carol`,data:{nodeType:"textInput",parameters:{label:"Enter your name",placeholder:"Type your name here...",defaultValue:"John"},inputHandles:[],outputHandles:[{id:"output_main",name:"User Input",type:"output",dataType:"string"}]},styles:{backgroundColor:"#3b82f6",textColor:"#ffffff",borderColor:"#2563eb"}},{id:Wt.orchestration,x:400,y:250,width:200,height:360,type:Ke.RECT,title:"ðŸ”€ Workflow: {{loop.current}}",content:"Orchestrate steps",data:{nodeType:"workflowOrchestration",showExecuteButton:!0,executeButtonPosition:"top-right",parameters:{rows:[{id:"row_1",label:"Step 1: Source",order:1,stepType:"source"},{id:"row_2",label:"Step 2: Loop",order:2,stepType:"loop",children:[{id:"row_3",label:"Step 3: Update Nodes",order:3,stepType:"nodeUpdate",config:{dataSource:"row_1",targets:[{nodeId:"wf-name-input-001",updates:{title:"âœï¸ Processing {{loop.current}}"}},{nodeId:"wf-orchestration-001",updates:{title:"ðŸ”€ Workflow: {{loop.current}}"}},{nodeId:"wf-output-001",updates:{title:"ðŸ“¤ Output: {{loop.current}}"}}]}}]}]},inputHandles:[{id:"input_row_1",name:"Step 1 Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Combined Output",type:"output",dataType:"object"}]},styles:{backgroundColor:"#8b5cf6",textColor:"#ffffff",borderColor:"#7c3aed"}},{id:"wf-email-input-001",x:100,y:470,width:200,height:80,type:Ke.TEXT,title:"ðŸ“§ Item {{loop.index}}/{{loop.total}}",content:"john@example.com",data:{nodeType:"textInput",parameters:{label:"Enter your email",placeholder:"Type your email here...",defaultValue:"john@example.com"},inputHandles:[],outputHandles:[{id:"output_main",name:"Email",type:"output",dataType:"string"}]},styles:{backgroundColor:"#3b82f6",textColor:"#ffffff",borderColor:"#2563eb"}},{id:"wf-source-001",x:100,y:600,width:200,height:120,type:Ke.TEXT,title:"ðŸ“¦ Data Source",content:'{"users": ["Alice", "Bob", "Carol"], "count": 3, "timestamp": "2025-11-12"}',data:{nodeType:"workflowSource",displayFormat:"json",inputHandles:[],outputHandles:[{id:"output_main",name:"Source Data",type:"output",dataType:"object"}]},styles:{backgroundColor:"#10b981",textColor:"#ffffff",borderColor:"#059669"}},{id:Wt.output,x:700,y:250,width:200,height:180,type:Ke.TEXT,title:"ðŸ“¤ Output: {{loop.current}}",content:"Display result",data:{nodeType:"textOutput",parameters:{template:"{{input}}"},inputHandles:[{id:"input_main",name:"Data",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Formatted Output",type:"output",dataType:"string"}]},styles:{backgroundColor:"#f59e0b",textColor:"#ffffff",borderColor:"#d97706"}},{id:Fe(8),x:100,y:50,type:Ke.TEXT,content:`ðŸ“‹ Workflow Demo: nodeUpdate Step Type
Source â†’ Loop â†’ nodeUpdate step updates any node fields (title, content, styles, etc.)
Click play button (top right of workflow node) â†’ Titles show {{loop.current}} = Alice`,styles:{fontSize:`${He.FONT_SIZE_SMALL}px`,fontWeight:"bold",textColor:"#1f2937"}}],Fp=[{id:"wf-arrow-001",startNodeId:Wt.nameInput,endNodeId:Wt.orchestration,startPoint:{x:300,y:390},endPoint:{x:400,y:290},label:"step 1"},{id:"wf-arrow-003",startNodeId:Wt.orchestration,endNodeId:Wt.output,startPoint:{x:600,y:320},endPoint:{x:700,y:320},label:"combined"}],Wp={nodes:Up,arrows:Fp,selectedNodes:[],selectedArrows:[]},zp={offset:{x:50,y:50},scale:1,targetView:null},Ya=Fe(10),Bp={id:Ya,name:"My First Canvas",createdAt:Date.now(),lastModified:Date.now(),coreState:Wp,viewState:zp},Za=Fe(10),Hp={id:Za,name:"Default Workspace",createdAt:Date.now(),lastModified:Date.now(),canvases:{[Ya]:Bp},activeCanvasId:Ya},er=Fe(10),Gp={id:er,name:"My Project",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[Za]:Hp},activeWorkspaceId:Za},kt={version:"3.6.8",dataVersion:"1.0.0",flags:{debug:{logEvents:!1,showDebugOverlay:!0},feature:{}},preferences:{segmentedButtons:{}},uiState:{mode:Rr.SELECT,addNodeType:Ke.TEXT,isPanning:!1,isDrawing:!1,mouseCursor:"cursor-default",selectionBox:null,temporaryArrow:null,nodeToFocusId:null,isOverlayVisible:!1,useCurvedArrows:!1,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},toolbar:{isVisible:!0,toolbarActions:[]},overlay:{}},state:{nodes:$p,projects:{[er]:Gp,"workflow-templates-project":Yo()},activeProjectId:er}},Ib=["Straight","Quadratic","Cubic","Step","Orthogonal","TreeCubic","TreeLStep","TreeZShape"],Rb={Straight:"Straight",Quadratic:"Quadratic",Cubic:"Cubic",Step:"Step (L-shaped)",Orthogonal:"Orthogonal (Z-shaped)",TreeCubic:"Tree: Cubic",TreeLStep:"Tree: L-Step",TreeZShape:"Tree: Z-Shape"},Re=class Re{static getSelectionRingClass(e){return e?Re._selectionRingClass:""}static getSelectedBorderClass(e){return e?Re._selectedBorderClass:""}static getNodePaddingClass(e){return e===Ke.TEXT?"px-2 py-1":"p-2"}static getNodeCursorClass(e,t){return e===Rr.SELECT?t?"cursor-grabbing":"cursor-grab":""}};J(Re,"_debug",{exposeActions:!0}),J(Re,"persistState",!0),J(Re,"autosave",!0),J(Re,"hideToolbar",!1),J(Re,"hideOverlay",!1),J(Re,"arrows",{styles:{line:"hsl(var(--muted-light))",lineSelected:"hsl(var(--primary))"},type:"Quadratic",REVERSE_CURVE:!1,CUBIC_ARROW_S_SHAPE_FACTOR:1,CUBIC_ARROW_S_SHAPE_REVERSED:!0,CUBIC_HORIZONTAL_BIAS:1,reverseArrowOnMultipleConnect:!0}),J(Re,"copyMode",{autoDrawArrows:!0}),J(Re,"nodeOptions",{maxNodeWidth:600,resizeBorderWidth:10}),J(Re,"nodeStyles",{textAlign:"left",fontSize:`${He.FONT_SIZE_DEFAULT}px`,fontWeight:"400",border:"",borderWidth:"",borderStyle:"",borderColor:"",backgroundColor:"",textColor:""}),J(Re,"zoom",{min:.01,max:4,intensity:.1,marks:[.09,.6,1,1.3,2]}),J(Re,"text",{debounceInput:300,fontSize:`${He.FONT_SIZE_DEFAULT}px`,paddingLeft:4,lineHeight:He.LINE_HEIGHT_CONFIG}),J(Re,"writeMode",{createAtMousePosition:!0,scrollDuration:3e3,scrollYRatio:.8,scrollVerticalPositionRatio:.75}),J(Re,"contentCapture",{pasteWidth:700,nodeGap:20,depthOffset:125}),J(Re,"arrange",{gap:60,gridNodeWidth:550,gridColumns:3}),J(Re,"autoScroll",{edgeThreshold:100,edgeThresholdMobile:30,scrollSpeed:15}),J(Re,"keyboardScroll",{animationDuration:300,targetScreenYRatio:.33,minKeyboardHeight:100}),J(Re,"_selectionRingClass","ring-1 ring-ring ring-offset-1"),J(Re,"_selectedBorderClass","border-ring");let Oe=Re;class Vp{constructor(e){this.apiClient=e}log(e,t){try{const{customLogFile:a,...n}=t||{};this.apiClient.sendLogs(e,n,a)}catch(a){console.error("[ClientLogsService] Failed to log event:",e,a)}}logCritical(e,t){try{return this.apiClient.sendBeacon(e,t)}catch(a){return console.error("[ClientLogsService] Failed to log critical event:",e,a),!1}}async clearLogs(){try{return await this.apiClient.clearLogs()}catch(e){return console.error("[ClientLogsService] Failed to clear logs:",e),!1}}}class qp{constructor(e){this.client=e}async log(e,t){await this.client.sendLogs(e,t)}logCritical(e,t){return this.client.sendBeacon(e,t)}}class Kp{constructor(e={}){J(this,"_clientLogsApiClient",null);J(this,"_clientLogsService",null);J(this,"_logger",null);J(this,"_config");this._config={clientLogsApiBaseUrl:e.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",clientLogsEnabled:e.clientLogsEnabled!==!1}}get clientLogsApiClient(){return this._clientLogsApiClient||(this._clientLogsApiClient=new Cr(this._config.clientLogsApiBaseUrl||"http://localhost:3030/client-logs",5e3)),this._clientLogsApiClient}get clientLogsService(){return this._clientLogsService||(this._clientLogsService=new Vp(this.clientLogsApiClient)),this._clientLogsService}get logger(){return this._logger||(this._logger=new qp(this.clientLogsApiClient)),this._logger}setConfig(e){this._config={...this._config,...e},this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}setClientLogsApiClient(e){this._clientLogsApiClient=e,this._clientLogsService=null,this._logger=null}reset(){this._clientLogsApiClient=null,this._clientLogsService=null,this._logger=null}}const La=new Kp;class se{constructor(e,t,a,n){this.isSuccess=e,this.isFailure=t,this._value=a,this._error=n}get value(){if(!this.isSuccess)throw new Error("Cannot get value from a failure result");return this._value}get error(){if(!this.isFailure)throw new Error("Cannot get error from a success result");return this._error}static success(e){return new se(!0,!1,e,void 0)}static failure(e){return new se(!1,!0,void 0,e)}}class $a extends Error{constructor(e){super(`User not found: ${e}`),this.userId=e,this.name="UserNotFoundError"}}class Jp extends Error{constructor(){super("Username cannot be empty"),this.name="UsernameEmptyError"}}class Qp extends Error{constructor(e){super(`Username must be at least ${e} characters`),this.minLength=e,this.name="UsernameTooShortError"}}class Xp extends Error{constructor(e){super(`Username cannot exceed ${e} characters`),this.maxLength=e,this.name="UsernameTooLongError"}}function ja(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():typeof crypto<"u"&&typeof crypto.getRandomValues=="function"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return(s==="x"?e:e&3|8).toString(16)}):(console.warn("[UUID] Using Math.random() fallback - not cryptographically secure"),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}))}class St{constructor(e,t,a,n,o,i,c){this.id=e,this.username=t,this.profilePicture=a,this.isOnline=n,this.lastSeen=o,this.createdAt=i,this.updatedAt=c,this.validate()}validate(){if(!this.id.trim())throw new Error("User ID cannot be empty");if(!this.username.trim())throw new Error("Username cannot be empty");if(this.username.length<2)throw new Error("Username must be at least 2 characters");if(this.username.length>50)throw new Error("Username cannot exceed 50 characters")}static create(e,t){const a=new Date().toISOString();return new St(ja(),e.trim(),t,!1,a,a,a)}static fromData(e){return new St(e.id,e.username,e.profilePicture,e.isOnline,e.lastSeen,e.createdAt,e.updatedAt)}setOnline(e){return new St(this.id,this.username,this.profilePicture,e,new Date().toISOString(),this.createdAt,new Date().toISOString())}updateProfile(e,t){return new St(this.id,(e==null?void 0:e.trim())||this.username,t!==void 0?t:this.profilePicture,this.isOnline,this.lastSeen,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,username:this.username,profilePicture:this.profilePicture,isOnline:this.isOnline,lastSeen:this.lastSeen,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class Yp{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;console.log("[CreateUserUseCase] Executing with command:",e);try{const a=e.username.trim();if(a.length===0)return console.log("[CreateUserUseCase] Validation failed: Username is empty"),se.failure(new Jp);if(a.length<2)return console.log("[CreateUserUseCase] Validation failed: Username too short"),se.failure(new Qp(2));if(a.length>50)return console.log("[CreateUserUseCase] Validation failed: Username too long"),se.failure(new Xp(50));console.log("[CreateUserUseCase] Validation passed, creating user entity");const n=St.create(a,e.profilePicture);console.log("[CreateUserUseCase] User entity created:",n),console.log("[CreateUserUseCase] Calling repository.create...");const o=await this.repository.create(n);return console.log("[CreateUserUseCase] User persisted successfully:",o),(t=this.logger)==null||t.log("user_created",{userId:o.id,usernameLength:a.length,hasProfilePicture:!!e.profilePicture}),console.log("[CreateUserUseCase] Returning success result"),se.success(o)}catch(a){return console.error("[CreateUserUseCase] CAUGHT ERROR:",a),se.failure(a instanceof Error?a:new Error("Failed to create user"))}}}class Yt{constructor(e,t,a,n,o,i,c,l,u,p){this.id=e,this.gameId=t,this.senderId=a,this.senderUsername=n,this.senderProfilePicture=o,this.text=i,this.timestamp=c,this.createdAt=l,this.isPersona=u,this.isIntroduction=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Message ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.senderId.trim())throw new Error("Sender ID cannot be empty");if(!this.senderUsername.trim())throw new Error("Sender username cannot be empty");if(!this.text.trim())throw new Error("Message text cannot be empty");if(this.text.length>500)throw new Error("Message text cannot exceed 500 characters")}static create(e,t,a,n,o,i,c){const l=new Date().toISOString();return new Yt(ja(),e.trim(),t.trim(),a.trim(),n,o.trim(),l,l,i,c)}static fromData(e){return new Yt(e.id,e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,e.text,e.timestamp,e.createdAt,e.isPersona,e.isIntroduction)}toJSON(){return{id:this.id,gameId:this.gameId,senderId:this.senderId,senderUsername:this.senderUsername,senderProfilePicture:this.senderProfilePicture,text:this.text,timestamp:this.timestamp,createdAt:this.createdAt,isPersona:this.isPersona,isIntroduction:this.isIntroduction}}}class Zp{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t,a;try{const n=e.text.trim();if(n.length===0)return se.failure(new Error("Message text cannot be empty"));if(n.length>500)return se.failure(new Error("Message text cannot exceed 500 characters"));if(!e.gameId.trim())return se.failure(new Error("Game ID is required"));if(!e.senderId.trim())return se.failure(new Error("Sender ID is required"));if(!e.senderUsername.trim())return se.failure(new Error("Sender username is required"));const o=Yt.create(e.gameId,e.senderId,e.senderUsername,e.senderProfilePicture,n),i=await this.repository.create(o);if(i.isFailure)return i;const c=/@(\w+)/g,l=Array.from(n.matchAll(c)).map(p=>p[1]);l.length>0&&!e.isFromPersona&&((t=this.logger)==null||t.log("persona_mentioned",{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,mentionedNames:l,mentionCount:l.length}));const u=e.isFromPersona?"persona_message_sent":"chat_message_sent";return(a=this.logger)==null||a.log(u,{messageId:i.value.id,gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,messageLength:n.length,isFromPersona:e.isFromPersona||!1,hasMentions:l.length>0}),se.success(i.value)}catch(n){return se.failure(n instanceof Error?n:new Error("Failed to send message"))}}}class eh{constructor(e,t){this.repository=e,this.logger=t}async execute(e){var t;try{if(!e.gameId.trim())return se.failure(new Error("Game ID is required"));const a=await this.repository.findByGameId(e.gameId);return a.isFailure?a:((t=this.logger)==null||t.log("chat_messages_loaded",{gameId:e.gameId,messageCount:a.value.length}),se.success(a.value))}catch(a){return se.failure(a instanceof Error?a:new Error("Failed to retrieve messages"))}}}class th{constructor(e,t,a,n){J(this,"_createUserUseCase");J(this,"_sendMessageUseCase");J(this,"_getMessagesUseCase");this.userRepository=e,this.chatRepository=t,this.webSocketService=a,this.logger=n}async createUser(e){var a;this._createUserUseCase||(this._createUserUseCase=new Yp(this.userRepository,this.logger));const t=await this._createUserUseCase.execute(e);if(t.isSuccess){const n=await this.setUserOnline({userId:t.value.id,isOnline:!0});if((a=this.logger)==null||a.log("user_set_online",{userId:t.value.id,isOnline:!0,triggeredBy:"user_creation"}),n.isSuccess)return se.success(n.value)}return t}async updateUser(e){try{const t=await this.userRepository.getById(e.userId);if(!t)return se.failure(new $a(e.userId));const a=t.updateProfile(e.username,e.profilePicture),n=await this.userRepository.update(a);return se.success(n)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to update user"))}}async setUserOnline(e){var t;try{const a=await this.userRepository.getById(e.userId);if(!a)return se.failure(new $a(e.userId));const n=a.setOnline(e.isOnline),o=await this.userRepository.update(n);return(t=this.logger)==null||t.log("user_online_status_changed",{userId:e.userId,username:a.username,previousStatus:a.isOnline,newStatus:e.isOnline}),se.success(o)}catch(a){return se.failure(a instanceof Error?a:new Error("Failed to set user online status"))}}async deleteUser(e){try{return await this.userRepository.delete(e.userId),se.success(void 0)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to delete user"))}}async getAllUsers(e){try{let t=await this.userRepository.getAll();return e.onlineOnly&&(t=t.filter(a=>a.isOnline)),se.success(t)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to get users"))}}async getUserById(e){try{const t=await this.userRepository.getById(e.userId);return t?se.success(t):se.failure(new $a(e.userId))}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to get user"))}}async connect(){if(!this.webSocketService)return se.failure(new Error("WebSocket service not configured"));try{return se.success(void 0)}catch(e){return se.failure(e instanceof Error?e:new Error("Failed to connect"))}}async disconnect(){if(!this.webSocketService)return se.failure(new Error("WebSocket service not configured"));try{return await this.webSocketService.disconnect(),se.success(void 0)}catch(e){return se.failure(e instanceof Error?e:new Error("Failed to disconnect"))}}async joinLobby(){if(!this.webSocketService)return se.failure(new Error("WebSocket service not configured"));try{return se.success(void 0)}catch(e){return se.failure(e instanceof Error?e:new Error("Failed to join lobby"))}}async leaveLobby(){if(!this.webSocketService)return se.failure(new Error("WebSocket service not configured"));try{return se.success(void 0)}catch(e){return se.failure(e instanceof Error?e:new Error("Failed to leave lobby"))}}async sendMessage(e){return this._sendMessageUseCase||(this._sendMessageUseCase=new Zp(this.chatRepository,this.logger)),this._sendMessageUseCase.execute(e)}async clearMessages(e){var t;try{return await this.chatRepository.deleteByGameId(e.gameId),(t=this.logger)==null||t.log("chat_messages_cleared",{gameId:e.gameId}),se.success(void 0)}catch(a){return se.failure(a instanceof Error?a:new Error("Failed to clear messages"))}}async getMessages(e){return this._getMessagesUseCase||(this._getMessagesUseCase=new eh(this.chatRepository,this.logger)),this._getMessagesUseCase.execute(e)}}class ht{constructor(e,t,a,n,o,i,c,l,u,p){this.id=e,this.name=t,this.gameType=a,this.players=n,this.status=o,this.currentTurn=i,this.winner=c,this.gameData=l,this.createdAt=u,this.updatedAt=p,this.validate()}validate(){if(!this.id.trim())throw new Error("Game ID cannot be empty");if(this.players.length===0)throw new Error("Game must have at least one player")}static create(e,t,a){const n=new Date().toISOString(),o={metadata:{}};return new ht(ja(),a,t,[e],"waiting",void 0,void 0,o,n,n)}static fromData(e){return new ht(e.id,e.name,e.gameType,e.players,e.status,e.currentTurn,e.winner,e.gameData,e.createdAt,e.updatedAt)}addPlayer(e){if(this.players.includes(e))throw new Error("Player already in game");if(this.players.length>=10)throw new Error("Lobby is full");const a=[...this.players,e],n=a.length>=2?"ready":"waiting";return new ht(this.id,this.name,this.gameType,a,n,this.currentTurn,this.winner,this.gameData,this.createdAt,new Date().toISOString())}start(){if(this.status!=="ready")throw new Error("Lobby must be in ready state to start");return new ht(this.id,this.name,this.gameType,this.players,"in_progress",this.players[0],this.winner,this.gameData,this.createdAt,new Date().toISOString())}updateGameData(e,t){return new ht(this.id,this.name,this.gameType,this.players,this.status,t!==void 0?t:this.currentTurn,this.winner,e,this.createdAt,new Date().toISOString())}complete(e){return new ht(this.id,this.name,this.gameType,this.players,"completed",void 0,e,this.gameData,this.createdAt,new Date().toISOString())}abandon(){return new ht(this.id,this.name,this.gameType,this.players,"abandoned",void 0,this.winner,this.gameData,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,name:this.name,gameType:this.gameType,players:this.players,status:this.status,currentTurn:this.currentTurn,winner:this.winner,gameData:this.gameData,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class ft{constructor(e,t,a,n,o,i,c,l){this.id=e,this.gameId=t,this.name=a,this.description=n,this.emoji=o,this.isActive=i,this.createdAt=c,this.updatedAt=l,this.validate()}validate(){if(!this.id.trim())throw new Error("Persona ID cannot be empty");if(!this.gameId.trim())throw new Error("Game ID cannot be empty");if(!this.name.trim())throw new Error("Persona name cannot be empty");if(this.name.length<2)throw new Error("Persona name must be at least 2 characters");if(this.name.length>50)throw new Error("Persona name cannot exceed 50 characters");if(!this.description.trim())throw new Error("Persona description cannot be empty");if(this.description.length<5)throw new Error("Persona description must be at least 5 characters");if(this.description.length>500)throw new Error("Persona description cannot exceed 500 characters")}static create(e,t,a,n){const o=new Date().toISOString();return new ft(ja(),e.trim(),t.trim(),a.trim(),n.trim(),!1,o,o)}static fromData(e){return new ft(e.id,e.gameId,e.name,e.description,e.emoji,e.isActive,e.createdAt,e.updatedAt)}activate(){return this.isActive?this:new ft(this.id,this.gameId,this.name,this.description,this.emoji,!0,this.createdAt,new Date().toISOString())}deactivate(){return this.isActive?new ft(this.id,this.gameId,this.name,this.description,this.emoji,!1,this.createdAt,new Date().toISOString()):this}update(e,t,a){return new ft(this.id,this.gameId,(e==null?void 0:e.trim())||this.name,(t==null?void 0:t.trim())||this.description,(a==null?void 0:a.trim())||this.emoji,this.isActive,this.createdAt,new Date().toISOString())}toJSON(){return{id:this.id,gameId:this.gameId,name:this.name,description:this.description,emoji:this.emoji,isActive:this.isActive,createdAt:this.createdAt,updatedAt:this.updatedAt}}}class sh{constructor(e,t=5e3){this.baseUrl=e,this.timeout=t}async createUser(e){const t=`${this.baseUrl}/users`;console.log("[HttpGameService.createUser] Making POST request to:",t),console.log("[HttpGameService.createUser] Request body:",e);try{const a=await this.fetchWithTimeout(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});console.log("[HttpGameService.createUser] Response received:",a.status);const n=await a.json();return console.log("[HttpGameService.createUser] Response data:",n),{user:St.fromData(n.user)}}catch(a){throw console.error("[HttpGameService.createUser] ERROR:",a),a}}async getUser(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"GET"})).json();return{user:St.fromData(a.user)}}async getAllUsers(){return{users:(await(await this.fetchWithTimeout(`${this.baseUrl}/users`,{method:"GET"})).json()).users.map(a=>St.fromData(a))}}async updateUser(e,t){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/users/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{user:St.fromData(n.user)}}async createGame(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/games`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{game:ht.fromData(a.game)}}async getGame(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"GET"})).json();return{game:ht.fromData(a.game)}}async getAllGames(e){const t=new URLSearchParams;e!=null&&e.status&&t.append("status",e.status),e!=null&&e.gameType&&t.append("gameType",e.gameType),e!=null&&e.playerId&&t.append("playerId",e.playerId);const a=`${this.baseUrl}/games${t.toString()?`?${t.toString()}`:""}`;return{games:(await(await this.fetchWithTimeout(a,{method:"GET"})).json()).games.map(i=>ht.fromData(i))}}async joinGame(e,t){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{game:ht.fromData(n.game)}}async startGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/start`,{method:"POST"})}async deleteGame(e){await this.fetchWithTimeout(`${this.baseUrl}/games/${e}`,{method:"DELETE"})}async createChatMessage(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e.gameId}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({senderId:e.senderId,senderUsername:e.senderUsername,text:e.text})})).json();return{message:Yt.fromData(a.message)}}async getChatMessages(e){return{messages:(await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"GET"})).json()).messages.map(n=>Yt.fromData(n))}}async clearChatMessages(e){return await(await this.fetchWithTimeout(`${this.baseUrl}/games/${e}/messages`,{method:"DELETE"})).json()}async createPersona(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/personas`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();return{persona:ft.fromData(a.persona)}}async getPersonas(e){return{personas:(await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"GET"})).json()).personas.map(n=>ft.fromData(n))}}async getPersona(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/detail/${e}`,{method:"GET"})).json();return{persona:ft.fromData(a.persona)}}async updatePersona(e,t){const n=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();return{persona:ft.fromData(n.persona)}}async deletePersona(e){await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}`,{method:"DELETE"})}async activatePersona(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/activate`,{method:"POST"})).json();return{persona:ft.fromData(a.persona)}}async deactivatePersona(e){const a=await(await this.fetchWithTimeout(`${this.baseUrl}/personas/${e}/deactivate`,{method:"POST"})).json();return{persona:ft.fromData(a.persona)}}async fetchWithTimeout(e,t){console.log("[fetchWithTimeout] Starting fetch to:",e),console.log("[fetchWithTimeout] Method:",t.method),console.log("[fetchWithTimeout] Timeout:",this.timeout+"ms");const a=new AbortController,n=setTimeout(()=>a.abort(),this.timeout);try{const o=await fetch(e,{...t,signal:a.signal});if(console.log("[fetchWithTimeout] Response status:",o.status,o.statusText),!o.ok){const i=`HTTP error! status: ${o.status}`;throw console.error("[fetchWithTimeout]",i),new Error(i)}return o}catch(o){if(o instanceof Error&&o.name==="AbortError"){const i=`Request timeout after ${this.timeout}ms`;throw console.error("[fetchWithTimeout]",i),new Error(i)}throw console.error("[fetchWithTimeout] Network error:",o),o}finally{clearTimeout(n)}}}var pt=(s=>(s.DISCONNECTED="DISCONNECTED",s.CONNECTING="CONNECTING",s.CONNECTED="CONNECTED",s.RECONNECTING="RECONNECTING",s.ERROR="ERROR",s))(pt||{});class ah{constructor(){J(this,"ws",null);J(this,"config",null);J(this,"connectionState",pt.DISCONNECTED);J(this,"messageHandlers",new Set);J(this,"stateHandlers",new Set);J(this,"reconnectAttempts",0);J(this,"reconnectTimeoutId",null);J(this,"heartbeatIntervalId",null)}async connect(e){return this.config=e,this.reconnectAttempts=0,this.doConnect()}async disconnect(){this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null),this.ws&&(this.ws.close(),this.ws=null),this.updateConnectionState(pt.DISCONNECTED)}async send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("WebSocket is not connected");const t={...e,timestamp:new Date().toISOString()};this.ws.send(JSON.stringify(t))}onMessage(e){return this.messageHandlers.add(e),()=>{this.messageHandlers.delete(e)}}onConnectionStateChange(e){return this.stateHandlers.add(e),()=>{this.stateHandlers.delete(e)}}getConnectionState(){return this.connectionState}isConnected(){return this.connectionState===pt.CONNECTED}async doConnect(){if(!this.config)throw new Error("Config not set");return new Promise((e,t)=>{this.updateConnectionState(this.reconnectAttempts>0?pt.RECONNECTING:pt.CONNECTING),this.ws=new WebSocket(this.config.url),this.ws.onopen=()=>{console.log("[WebSocket] Connected"),this.reconnectAttempts=0,this.updateConnectionState(pt.CONNECTED),this.startHeartbeat(),e()},this.ws.onmessage=a=>{try{const n=JSON.parse(a.data);this.handleMessage(n)}catch(n){console.error("[WebSocket] Failed to parse message:",n)}},this.ws.onerror=a=>{console.error("[WebSocket] Error:",a),this.updateConnectionState(pt.ERROR),t(a)},this.ws.onclose=()=>{console.log("[WebSocket] Disconnected"),this.stopHeartbeat(),this.connectionState!==pt.DISCONNECTED&&this.attemptReconnect()}})}handleMessage(e){e.type!=="pong"&&this.messageHandlers.forEach(t=>{try{t(e)}catch(a){console.error("[WebSocket] Message handler error:",a)}})}attemptReconnect(){if(!this.config)return;const e=this.config.maxReconnectAttempts??10;if(this.reconnectAttempts>=e){console.error(`[WebSocket] Max reconnection attempts (${e}) reached`),this.updateConnectionState(pt.ERROR);return}this.reconnectAttempts++;const t=this.config.reconnectInterval??3e3;console.log(`[WebSocket] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${e})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.doConnect().catch(a=>{console.error("[WebSocket] Reconnection failed:",a)})},t)}startHeartbeat(){if(!this.config)return;const e=this.config.heartbeatInterval??3e4;this.heartbeatIntervalId=window.setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping"}).catch(t=>{console.error("[WebSocket] Failed to send heartbeat:",t)})},e)}stopHeartbeat(){this.heartbeatIntervalId!==null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=null)}updateConnectionState(e){this.connectionState!==e&&(this.connectionState=e,this.stateHandlers.forEach(t=>{try{t(e)}catch(a){console.error("[WebSocket] State handler error:",a)}}))}}class rh{constructor(e){this.httpService=e}async getAll(e){return(await this.httpService.getAllGames(e)).games}async getById(e){try{return(await this.httpService.getGame(e)).game}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){return(await this.httpService.createGame({gameType:e.gameType||"tic-tac-toe",creatorId:e.players[0]})).game}async update(e){return e}async delete(e){await this.httpService.deleteGame(e)}}class nh{constructor(e){this.httpService=e}async getAll(){return(await this.httpService.getAllUsers()).users}async getById(e){try{return(await this.httpService.getUser(e)).user}catch(t){if(t instanceof Error&&t.message.includes("404"))return null;throw t}}async create(e){console.log("[HttpUserRepository.create] Creating user:",{username:e.username,id:e.id});try{const t=await this.httpService.createUser({username:e.username,profilePicture:e.profilePicture});return console.log("[HttpUserRepository.create] User created successfully:",t.user),t.user}catch(t){throw console.error("[HttpUserRepository.create] ERROR:",t),t}}async update(e){return(await this.httpService.updateUser(e.id,{isOnline:e.isOnline,profilePicture:e.profilePicture})).user}async delete(e){console.warn("[HttpUserRepository] Delete not implemented")}}class oh{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createChatMessage({gameId:e.gameId,senderId:e.senderId,senderUsername:e.senderUsername,text:e.text});return se.success(t.message)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to create chat message"))}}async findByGameId(e){try{const t=await this.httpService.getChatMessages(e);return se.success(t.messages)}catch(t){return t instanceof Error&&t.message.includes("404")?se.success([]):se.failure(t instanceof Error?t:new Error("Failed to retrieve chat messages"))}}async deleteByGameId(e){try{return await this.httpService.clearChatMessages(e),se.success(void 0)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to clear chat messages"))}}}class ih{constructor(e){this.httpService=e}async create(e){try{const t=await this.httpService.createPersona({gameId:e.gameId,name:e.name,description:e.description,emoji:e.emoji});return se.success(t.persona)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to create persona"))}}async findByGameId(e){try{const t=await this.httpService.getPersonas(e);return se.success(t.personas)}catch(t){return t instanceof Error&&t.message.includes("404")?se.success([]):se.failure(t instanceof Error?t:new Error("Failed to retrieve personas"))}}async findById(e){try{const t=await this.httpService.getPersona(e);return se.success(t.persona)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to retrieve persona"))}}async update(e,t){try{const a=await this.httpService.updatePersona(e,{name:t.name,description:t.description,emoji:t.emoji,isActive:t.isActive});return se.success(a.persona)}catch(a){return se.failure(a instanceof Error?a:new Error("Failed to update persona"))}}async delete(e){try{return await this.httpService.deletePersona(e),se.success(void 0)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to delete persona"))}}async activate(e){try{const t=await this.httpService.activatePersona(e);return se.success(t.persona)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to activate persona"))}}async deactivate(e){try{const t=await this.httpService.deactivatePersona(e);return se.success(t.persona)}catch(t){return se.failure(t instanceof Error?t:new Error("Failed to deactivate persona"))}}}class ch{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var a;const t=await this.personaRepository.create(e);return t.isSuccess&&((a=this.logger)==null||a.log("persona_created",{personaId:t.value.id,gameId:e.gameId,name:e.name,description:e.description,isActive:t.value.isActive})),t}}class lh{constructor(e){this.personaRepository=e}async execute(e){return await this.personaRepository.findByGameId(e)}}class dh{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t){var n;const a=await this.personaRepository.update(e,t);return a.isSuccess&&((n=this.logger)==null||n.log("persona_updated",{personaId:e,updates:t,name:a.value.name,gameId:a.value.gameId})),a}}class uh{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e){var a;const t=await this.personaRepository.delete(e);return t.isSuccess&&((a=this.logger)==null||a.log("persona_deleted",{personaId:e})),t}}class ph{constructor(e,t){this.personaRepository=e,this.logger=t}async execute(e,t=!0){var n;const a=t?await this.personaRepository.activate(e):await this.personaRepository.deactivate(e);if(a.isSuccess){const o=t?"persona_activated":"persona_deactivated";(n=this.logger)==null||n.log(o,{personaId:e,isActive:t,name:a.value.name,gameId:a.value.gameId})}return a}}const Pr="CONNECT_REQUEST",Zo="CONNECT_SUCCESS",ei="CONNECT_FAILURE",_r="DISCONNECT",ti="CONNECTION_STATE_CHANGED",si="CREATE_USER_REQUEST",ai="CREATE_USER_SUCCESS",ri="CREATE_USER_FAILURE",ni="UPDATE_USER_REQUEST",oi="UPDATE_USER_SUCCESS",ii="UPDATE_USER_FAILURE",ci="FETCH_USERS_REQUEST",li="FETCH_USERS_SUCCESS",di="FETCH_USERS_FAILURE",ui="SET_USER_ONLINE_REQUEST",pi="SET_USER_ONLINE_SUCCESS",hi="SET_USER_ONLINE_FAILURE",fi="SET_CURRENT_USER",hh="CREATE_GAME_REQUEST",fh="CREATE_GAME_SUCCESS",mh="CREATE_GAME_FAILURE",gh="JOIN_GAME_REQUEST",xh="JOIN_GAME_SUCCESS",bh="JOIN_GAME_FAILURE",vh="START_GAME_REQUEST",wh="START_GAME_SUCCESS",yh="START_GAME_FAILURE",Sh="MAKE_MOVE_REQUEST",Ch="MAKE_MOVE_SUCCESS",jh="MAKE_MOVE_FAILURE",Nh="LEAVE_GAME_REQUEST",Eh="LEAVE_GAME_SUCCESS",kh="LEAVE_GAME_FAILURE",Th="FETCH_GAMES_REQUEST",Ah="FETCH_GAMES_SUCCESS",Ih="FETCH_GAMES_FAILURE",Rh="GAME_UPDATED",Ph="GAME_ENDED",mi="USER_LIST_UPDATED",gi="SEND_MESSAGE_REQUEST",xi="SEND_MESSAGE_SUCCESS",bi="SEND_MESSAGE_FAILURE",vi="FETCH_MESSAGES_REQUEST",wi="FETCH_MESSAGES_SUCCESS",yi="FETCH_MESSAGES_FAILURE",Si="CLEAR_MESSAGES_REQUEST",Ci="CLEAR_MESSAGES_SUCCESS",ji="CLEAR_MESSAGES_FAILURE",Ni="CHAT_MESSAGE_RECEIVED",Ei="CREATE_PERSONA_REQUEST",ki="CREATE_PERSONA_SUCCESS",Ti="CREATE_PERSONA_FAILURE",Ai="FETCH_PERSONAS_REQUEST",Ii="FETCH_PERSONAS_SUCCESS",Ri="FETCH_PERSONAS_FAILURE",Pi="UPDATE_PERSONA_REQUEST",_i="UPDATE_PERSONA_SUCCESS",Di="UPDATE_PERSONA_FAILURE",Oi="DELETE_PERSONA_REQUEST",Mi="DELETE_PERSONA_SUCCESS",Li="DELETE_PERSONA_FAILURE",$i="ACTIVATE_PERSONA_REQUEST",Ui="ACTIVATE_PERSONA_SUCCESS",Fi="ACTIVATE_PERSONA_FAILURE",Wi="PERSONA_CREATED",zi="PERSONA_UPDATED",Bi="PERSONA_DELETED",Hi="PERSONA_ACTIVATED",Gi="PERSONA_DEACTIVATED",_h="SET_SELECTED_GAME",Dh="CLEAR_ERROR",Pb=()=>({type:Pr}),Oh=()=>({type:Zo}),an=s=>({type:ei,error:s}),Mh=s=>({type:ti,payload:s}),_b=()=>({type:_r}),Lh=s=>({type:fi,payload:s}),$h=()=>({type:ci}),Uh=s=>({type:li,payload:s}),Fh=s=>({type:di,error:s}),Wh=s=>({type:mi,payload:s}),Db=(s,e)=>async t=>{console.log("[createUser] Starting user creation for username:",s),t({type:si});const a=Ie.gameApplicationService;console.log("[createUser] Calling application service...");const n=await a.createUser({username:s,profilePicture:e});console.log("[createUser] Result received:",{isSuccess:n.isSuccess,error:n.isSuccess?null:n.error.message}),n.isSuccess?(console.log("[createUser] Success! User created:",n.value),t({type:ai,payload:n.value}),t(Lh(n.value))):(console.error("[createUser] FAILURE! Error:",n.error.message),t({type:ri,error:n.error.message}))},Ob=(s,e,t)=>async a=>{a({type:ni});const o=await Ie.gameApplicationService.updateUser({userId:s,username:e,profilePicture:t});o.isSuccess?a({type:oi,payload:o.value}):a({type:ii,error:o.error.message})},Mb=(s,e)=>async t=>{t({type:ui});const n=await Ie.gameApplicationService.setUserOnline({userId:s,isOnline:e});n.isSuccess?t({type:pi,payload:n.value}):t({type:hi,error:n.error.message})},Lb=()=>async s=>{s($h());const t=await Ie.gameApplicationService.getAllUsers({onlineOnly:!1});t.isSuccess?s(Uh(t.value)):s(Fh(t.error.message))},zh=s=>({type:Ni,payload:s}),Bh=(s,e,t,a,n,o)=>async i=>{i({type:gi});const l=await Ie.gameApplicationService.sendMessage({gameId:s,senderId:e,senderUsername:t,senderProfilePicture:a,text:n,isFromPersona:o});l.isSuccess?i({type:xi,payload:l.value}):i({type:bi,error:l.error.message})},$b=s=>async e=>{e({type:vi});const a=await Ie.gameApplicationService.getMessages({gameId:s});a.isSuccess?e({type:wi,payload:a.value}):e({type:yi,error:a.error.message})},Ub=s=>async e=>{e({type:Si});const a=await Ie.gameApplicationService.clearMessages({gameId:s});a.isSuccess?e({type:Ci,payload:s}):e({type:ji,error:a.error.message})},Hh={maxContextMessages:10,responseDelay:1e3,maxResponseLength:300};function Gh(s){return`You are ${s.name}, an AI assistant in a multiplayer chat lobby.

Your role and behavior:
${s.description}

Guidelines:
- Stay in character as ${s.name}
- Keep responses concise (under 300 characters)
- Be helpful and engaging
- Respond naturally to the conversation flow
- Don't mention that you're an AI unless directly asked
- Use the persona's personality consistently

Current conversation context will be provided. Respond as ${s.name} would.`}class Vh{constructor(e,t,a){J(this,"isProcessing",!1);J(this,"config");this.ollamaApi=e,this.store=t,this.config={...Hh,...a}}extractMentions(e){const t=/@(\w+)/g;return Array.from(e.matchAll(t)).map(n=>n[1])}async processMessage(e,t){if(console.log("[PersonaResponseService] ========== PROCESSING MESSAGE =========="),console.log("[PersonaResponseService] Message:",e),console.log("[PersonaResponseService] Game ID:",t),this.isProcessing){console.log("[PersonaResponseService] Already processing, skipping");return}try{this.isProcessing=!0;const a=this.store.getState(),n=a.currentUser;if(console.log("[PersonaResponseService] Current user:",n==null?void 0:n.username),console.log("[PersonaResponseService] Total personas in state:",Object.keys(a.personas.byId).length),this.isPersonaMessage(e,a.personas.byId)){console.log("[PersonaResponseService] Message from persona, skipping");return}const o=this.extractMentions(e.text);if(console.log("[PersonaResponseService] Extracted mentions:",o),o.length===0){console.log("[PersonaResponseService] No @mentions in message, skipping");return}console.log("[PersonaResponseService] âœ… Detected @mentions:",o);const c=(a.personas.byGameId[t]||[]).map(u=>a.personas.byId[u]).filter(u=>u&&u.isActive);if(c.length===0){console.log("[PersonaResponseService] No active personas");return}const l=(a.chatMessages[t]||[]).slice(-this.config.maxContextMessages).map(u=>({sender:u.senderUsername,text:u.text,isPersona:this.isPersonaMessage(u,a.personas.byId)}));for(const u of c)o.some(h=>h.toLowerCase()===u.name.toLowerCase())&&(console.log("[PersonaResponseService] Persona @mentioned, generating AI response:",u.name),await this.generatePersonaResponse(u,l,t,n==null?void 0:n.id))}catch(a){console.error("[PersonaResponseService] Error processing message:",a)}finally{this.isProcessing=!1}}isPersonaMessage(e,t){return Object.values(t).some(a=>a.id===e.senderId)}async generatePersonaResponse(e,t,a,n){var o,i;try{await new Promise(h=>setTimeout(h,this.config.responseDelay));const c=[{role:"system",content:Gh(e)},...t.map(h=>({role:h.isPersona?"assistant":"user",content:`${h.sender}: ${h.text}`}))];console.log("[PersonaResponseService] Generating response for:",e.name);const u=(i=(o=(await this.ollamaApi.chat(c,void 0,{stream:!1})).message)==null?void 0:o.content)==null?void 0:i.trim();if(!u){console.log("[PersonaResponseService] No response generated");return}const p=u.length>this.config.maxResponseLength?u.substring(0,this.config.maxResponseLength-3)+"...":u;console.log("[PersonaResponseService] Generated response:",p),this.store.dispatch(Bh(a,e.id,e.name,void 0,p,!0))}catch(c){console.error("[PersonaResponseService] Error generating response for",e.name,c)}}}const Fb=["gpt-oss:latest","gemma3:4b","gemma3:27b","qwen2.5:32b","qwen3:4b","qwen3:30b","qwen3-vl:latest","qwen3-vl:4b","granite3.2-vision","granite4:small-h","deepseek-r1:32b"],Vi="gemma3:27b",rn="http://192.168.2.70:11434";class qh{constructor(e=Vi){this.model=e}async generateStructuredCompletion(e,t,a=this.model,n){return((n==null?void 0:n.useEndpoint)??"chat")==="chat"?this.generateStructuredCompletionWithChat(e,t,a,n):this.generateStructuredCompletionWithGenerate(e,t,a,n)}async generateStructuredCompletionWithChat(e,t,a,n){var l;const o=(n==null?void 0:n.system)??"You are a helpful assistant. Always respond in valid JSON format according to the provided schema.",i=await this.chat([{role:"system",content:o},{role:"user",content:e,images:n==null?void 0:n.images}],a,{format:t,stream:!1,signal:n==null?void 0:n.signal});console.log("ðŸ” Raw chat API result:",i);const c=(l=i.message)==null?void 0:l.content;if(console.log("ðŸ” Response type:",typeof c),console.log("ðŸ” Response value:",c),!c)throw console.error("âŒ Empty response from API:",i),new Error("Received empty response from Ollama API");if(typeof c=="string"){if(c.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(c)}catch(u){throw console.error("âŒ JSON parse error. Response was:",c),new Error(`Failed to parse JSON response: ${u instanceof Error?u.message:"Unknown error"}`)}}return c}async generateStructuredCompletionWithGenerate(e,t,a,n){const o=await this.generateCompletion(e,a,{...n,format:t});if(console.log("ðŸ” Raw generate API result:",o),console.log("ðŸ” Response type:",typeof o.response),console.log("ðŸ” Response value:",o.response),!o.response)throw console.error("âŒ Empty response from API:",o),new Error("Received empty response from Ollama API");if(typeof o.response=="string"){if(o.response.trim()==="")throw console.error("âŒ Empty string response from API"),new Error("Received empty string response from Ollama API");try{return JSON.parse(o.response)}catch(i){throw console.error("âŒ JSON parse error. Response was:",o.response),new Error(`Failed to parse JSON response: ${i instanceof Error?i.message:"Unknown error"}`)}}return o.response}async generateCompletion(e,t=this.model,a){var y;const{suffix:n,images:o,format:i,system:c,template:l,stream:u,raw:p,keep_alive:h,context:f,onStreamChunk:b,signal:v}=a??{stream:!1},m=`${rn}/api/generate`,w=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:e,suffix:n,images:o,format:i,options:a==null?void 0:a.options,system:c,template:l,stream:u,raw:p,keep_alive:h,context:f}),signal:v});if(!w.ok)throw new Error(`HTTP error! status: ${w.status}`);if(u&&w.headers.get("Content-Type")==="application/x-ndjson"){const g=(y=w.body)==null?void 0:y.getReader(),x=new TextDecoder("utf-8");let j="",C="";for(;;){const{done:N,value:S}=await(g==null?void 0:g.read())??{};if(N)break;j+=x.decode(S,{stream:!0});const D=j.split(`
`);j=D.pop();for(const W of D)if(W.trim()){const E=JSON.parse(W);E.response&&(C+=E.response,b==null||b(E.response)),console.log(E)}}return{response:C}}else{const g=await w.json();return console.log("ðŸ“¥ Non-streaming API response:",g),g}}async chat(e,t=this.model,a){var h,f;const{stream:n,format:o,keep_alive:i,onStreamChunk:c,signal:l}=a??{},u=`${rn}/api/chat`,p=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:e,format:o,stream:n,keep_alive:i}),signal:l});if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);if(n&&p.headers.get("Content-Type")==="application/x-ndjson"){const b=(h=p.body)==null?void 0:h.getReader(),v=new TextDecoder("utf-8");let m="",w="";for(;;){const{done:y,value:g}=await(b==null?void 0:b.read())??{};if(y)break;m+=v.decode(g,{stream:!0});const x=m.split(`
`);m=x.pop();for(const j of x)if(j.trim()){const C=JSON.parse(j);(f=C.message)!=null&&f.content&&(w+=C.message.content,c==null||c(C.message.content)),console.log(C)}}return{message:{role:"assistant",content:w}}}else return await p.json()}}const Kh=new qh(Vi),tr="game_current_user";function Jh(){try{const s=localStorage.getItem(tr);return s?JSON.parse(s):null}catch(s){return console.error("[gameReducer] Failed to load currentUser from localStorage:",s),null}}function is(s){try{s?localStorage.setItem(tr,JSON.stringify(s)):localStorage.removeItem(tr)}catch(e){console.error("[gameReducer] Failed to save currentUser to localStorage:",e)}}const Qh={connectionState:"DISCONNECTED",isConnected:!1,currentUser:Jh(),users:[],usersLoading:!1,usersError:null,games:[],gamesLoading:!1,gamesError:null,selectedGameId:null,chatMessages:{},chatLoading:!1,chatError:null,personas:{byId:{},byGameId:{},loading:!1,error:null},loading:!1,error:null};function nn(s=Qh,e){var t,a,n,o,i;switch(e.type){case Pr:return{...s,loading:!0,error:null};case Zo:return{...s,loading:!1,isConnected:!0,error:null};case ei:return{...s,loading:!1,isConnected:!1,error:e.error};case _r:return{...s,isConnected:!1,connectionState:"DISCONNECTED"};case ti:return{...s,connectionState:e.payload,isConnected:e.payload==="CONNECTED"};case fi:{const c={...s,currentUser:e.payload};return is(e.payload),c}case si:return{...s,usersLoading:!0,usersError:null};case ai:{const c={...s,usersLoading:!1,currentUser:e.payload,users:[...s.users,e.payload],usersError:null};return is(e.payload),c}case ri:return{...s,usersLoading:!1,usersError:e.error};case ni:return{...s,usersLoading:!0,usersError:null};case oi:{const c=((t=s.currentUser)==null?void 0:t.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(u=>u.id===e.payload.id?e.payload:u),usersError:null};return((a=s.currentUser)==null?void 0:a.id)===e.payload.id&&is(e.payload),l}case ii:return{...s,usersLoading:!1,usersError:e.error};case ci:return{...s,usersLoading:!0,usersError:null};case li:{const c=e.payload,l=s.currentUser?c.find(p=>p.id===s.currentUser.id):null,u=l?s.currentUser:null;return!l&&s.currentUser&&(console.warn("[gameReducer] Current user not found in backend, clearing localStorage"),is(null)),{...s,usersLoading:!1,currentUser:u,users:c,usersError:null}}case di:return{...s,usersLoading:!1,usersError:e.error};case ui:return{...s,usersLoading:!0,usersError:null};case pi:{const c=((n=s.currentUser)==null?void 0:n.id)===e.payload.id?e.payload:s.currentUser,l={...s,usersLoading:!1,currentUser:c,users:s.users.map(u=>u.id===e.payload.id?e.payload:u),usersError:null};return((o=s.currentUser)==null?void 0:o.id)===e.payload.id&&is(e.payload),l}case hi:return{...s,usersLoading:!1,usersError:e.error};case mi:return{...s,users:e.payload};case hh:return{...s,gamesLoading:!0,gamesError:null};case fh:return{...s,gamesLoading:!1,games:[...s.games,e.payload],gamesError:null};case mh:return{...s,gamesLoading:!1,gamesError:e.error};case gh:return{...s,gamesLoading:!0,gamesError:null};case xh:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case bh:return{...s,gamesLoading:!1,gamesError:e.error};case vh:return{...s,gamesLoading:!0,gamesError:null};case wh:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case yh:return{...s,gamesLoading:!1,gamesError:e.error};case Sh:return{...s,gamesLoading:!0,gamesError:null};case Ch:return{...s,gamesLoading:!1,games:s.games.map(c=>c.id===e.payload.id?e.payload:c),gamesError:null};case jh:return{...s,gamesLoading:!1,gamesError:e.error};case Nh:return{...s,gamesLoading:!0,gamesError:null};case Eh:return{...s,gamesLoading:!1,games:s.games.filter(c=>c.id!==e.payload),gamesError:null};case kh:return{...s,gamesLoading:!1,gamesError:e.error};case Th:return{...s,gamesLoading:!0,gamesError:null};case Ah:return{...s,gamesLoading:!1,games:e.payload,gamesError:null};case Ih:return{...s,gamesLoading:!1,gamesError:e.error};case Rh:return{...s,games:s.games.map(c=>c.id===e.payload.id?e.payload:c)};case Ph:return{...s,games:s.games.filter(c=>c.id!==e.payload)};case gi:return{...s,chatLoading:!0,chatError:null};case xi:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]},chatError:null}}case bi:return{...s,chatLoading:!1,chatError:e.error};case vi:return{...s,chatLoading:!0,chatError:null};case wi:{if(e.payload.length===0)return{...s,chatLoading:!1,chatError:null};const c=e.payload[0].gameId;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:e.payload},chatError:null}}case yi:return{...s,chatLoading:!1,chatError:e.error};case Si:return{...s,chatLoading:!0,chatError:null};case Ci:{const c=e.payload;return{...s,chatLoading:!1,chatMessages:{...s.chatMessages,[c]:[]},chatError:null}}case ji:return{...s,chatLoading:!1,chatError:e.error};case Ni:{const c=e.payload,l=s.chatMessages[c.gameId]||[];return l.find(u=>u.id===c.id)?s:{...s,chatMessages:{...s.chatMessages,[c.gameId]:[...l,c]}}}case Ei:case Ai:case Pi:case Oi:case $i:return{...s,personas:{...s.personas,loading:!0,error:null}};case ki:case Wi:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},byGameId:{...s.personas.byGameId,[c.gameId]:[...s.personas.byGameId[c.gameId]||[],c.id]},loading:!1}}}case Ii:{const{personas:c}=e.payload,l={},u={};return c.forEach(p=>{l[p.id]=p,u[p.gameId]||(u[p.gameId]=[]),u[p.gameId].push(p.id)}),{...s,personas:{...s.personas,byId:{...s.personas.byId,...l},byGameId:{...s.personas.byGameId,...u},loading:!1}}}case _i:case zi:case Ui:case Hi:case Gi:{const{persona:c}=e.payload;return{...s,personas:{...s.personas,byId:{...s.personas.byId,[c.id]:c},loading:!1}}}case Mi:case Bi:{const c="id"in e.payload?e.payload.id:e.payload.personaId,l=s.personas.byId[c];if(!l)return s;const{[c]:u,...p}=s.personas.byId,h=((i=s.personas.byGameId[l.gameId])==null?void 0:i.filter(f=>f!==c))||[];return{...s,personas:{...s.personas,byId:p,byGameId:{...s.personas.byGameId,[l.gameId]:h},loading:!1}}}case Ti:case Ri:case Di:case Li:case Fi:return{...s,personas:{...s.personas,loading:!1,error:e.payload.error}};case _h:return{...s,selectedGameId:e.payload};case Dh:return{...s,error:null,gamesError:null,usersError:null};default:return s}}const Xh=()=>({type:Ei}),Yh=s=>({type:ki,payload:{persona:s}}),Zh=s=>({type:Ti,payload:{error:s}}),ef=()=>({type:Ai}),tf=s=>({type:Ii,payload:{personas:s}}),sf=s=>({type:Ri,payload:{error:s}}),af=()=>({type:Pi}),rf=s=>({type:_i,payload:{persona:s}}),nf=s=>({type:Di,payload:{error:s}}),of=()=>({type:Oi}),cf=s=>({type:Mi,payload:{id:s}}),lf=s=>({type:Li,payload:{error:s}}),qi=()=>({type:$i}),Ki=s=>({type:Ui,payload:{persona:s}}),Ji=s=>({type:Fi,payload:{error:s}}),df=s=>({type:Wi,payload:{persona:s}}),uf=s=>({type:zi,payload:{persona:s}}),pf=s=>({type:Bi,payload:{personaId:s}}),hf=s=>({type:Hi,payload:{persona:s}}),ff=s=>({type:Gi,payload:{persona:s}}),Wb=(s,e,t,a)=>async n=>{n(Xh());const o=await Ie.personaUseCases.createPersona.execute({gameId:s,name:e,description:t,emoji:a});o.isSuccess?n(Yh(o.value.toJSON())):n(Zh(o.error.message))},zb=s=>async e=>{e(ef());const t=await Ie.personaUseCases.getPersonas.execute(s);t.isSuccess?e(tf(t.value.map(a=>a.toJSON()))):e(sf(t.error.message))},Bb=(s,e)=>async t=>{t(af());const a=await Ie.personaUseCases.updatePersona.execute(s,e);a.isSuccess?t(rf(a.value.toJSON())):t(nf(a.error.message))},Hb=s=>async e=>{e(of());const t=await Ie.personaUseCases.deletePersona.execute(s);t.isSuccess?e(cf(s)):e(lf(t.error.message))},Gb=s=>async e=>{e(qi());const t=await Ie.personaUseCases.activatePersona.execute(s,!0);t.isSuccess?e(Ki(t.value.toJSON())):e(Ji(t.error.message))},Vb=s=>async e=>{e(qi());const t=await Ie.personaUseCases.activatePersona.execute(s,!1);t.isSuccess?e(Ki(t.value.toJSON())):e(Ji(t.error.message))},mf=s=>{let e=!1;return t=>a=>{const n=t(a);if(a.type===Pr){if(e)return console.log("[WebSocket Middleware] Connection already initialized"),n;e=!0;const o=Ie.webSocketService,i=Ie.webSocketConfig;o.onMessage(c=>{switch(console.log("[WebSocket Middleware] Received message:",c.type),c.type){case"chat_message":{const u=c.message;u.isIntroduction&&u.isPersona?console.log(`[WebSocket Middleware] ðŸŽ­ Persona introduction received from ${u.senderUsername}:`,u.text):u.isPersona?console.log(`[WebSocket Middleware] ðŸ¤– Persona message received from ${u.senderUsername}:`,u.text):console.log("[WebSocket Middleware] Chat message received:",u),s.dispatch(zh(u));break}case"user_list":{const u=c.users;console.log("[WebSocket Middleware] User list updated:",u.length,"users"),s.dispatch(Wh(u));break}case"game_update":{const u=c.game;console.log("[WebSocket Middleware] Game update received:",u.id);break}case"PERSONA_CREATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona created:",u.id),s.dispatch(df(u));break}case"PERSONA_UPDATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona updated:",u.id),s.dispatch(uf(u));break}case"PERSONA_DELETED":{const u=c.personaId;console.log("[WebSocket Middleware] Persona deleted:",u),s.dispatch(pf(u));break}case"PERSONA_ACTIVATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona activated:",u.id),s.dispatch(hf(u));break}case"PERSONA_DEACTIVATED":{const u=c.persona;console.log("[WebSocket Middleware] Persona deactivated:",u.id),s.dispatch(ff(u));break}case"error":{const u=c.message;console.error("[WebSocket Middleware] Error from server:",u);break}}}),o.onConnectionStateChange(c=>{if(s.dispatch(Mh(c)),c===pt.CONNECTED){s.dispatch(Oh());const u=s.getState().currentUser;u?(console.log(`[WebSocket Middleware] Sending JOIN message for user ${u.username} (${u.id})`),o.send({type:"join",userId:u.id,username:u.username}).catch(p=>{console.error("[WebSocket Middleware] Failed to send JOIN message:",p)})):console.warn("[WebSocket Middleware] No currentUser available to send JOIN message")}else c===pt.ERROR&&s.dispatch(an("WebSocket connection failed"))}),o.connect(i).then(()=>{console.log("[WebSocket Middleware] Successfully connected")}).catch(c=>{console.error("[WebSocket Middleware] Connection error:",c),s.dispatch(an(c instanceof Error?c.message:"Unknown connection error")),e=!1})}return a.type===_r&&Ie.webSocketService.disconnect().then(()=>{console.log("[WebSocket Middleware] Disconnected"),e=!1}).catch(i=>{console.error("[WebSocket Middleware] Disconnect error:",i),e=!1}),n}},gf=s=>e=>t=>e(t),xf=s=>e=>t=>typeof t=="function"?t(s.dispatch,s.getState):e(t);function bf(s=!0){let e=nn(void 0,{type:"@@INIT"});const t=new Set,a={getState(){return e},dispatch(n){let o=i=>(e=nn(e,i),t.forEach(c=>c()),i);return o=mf(a)(o),o=xf(a)(o),s&&(o=gf()(o)),o(n)},subscribe(n){return t.add(n),()=>{t.delete(n)}}};return a}class vf{constructor(){J(this,"_httpService",null);J(this,"_webSocketService",null);J(this,"_gameRepository",null);J(this,"_userRepository",null);J(this,"_chatRepository",null);J(this,"_personaRepository",null);J(this,"_store",null);J(this,"_gameApplicationService",null);J(this,"_config",null);J(this,"_personaUseCases",null);J(this,"_personaResponseService",null);J(this,"_logger",null)}get config(){if(!this._config){const e=()=>`http://${window.location.hostname}:3030/api/multiplayer`,t=()=>`ws://${window.location.hostname}:3030/multiplayer`;this._config={httpApiBaseUrl:e(),webSocketUrl:t(),enableLogging:!0,webSocketReconnectInterval:parseInt("3000",10),webSocketMaxReconnectAttempts:parseInt("10",10),webSocketHeartbeatInterval:parseInt("30000",10),clientLogsEnabled:!0,clientLogsApiBaseUrl:"http://localhost:3030/client-logs"}}return this._config}get httpService(){return this._httpService||(this._httpService=new sh(this.config.httpApiBaseUrl,5e3)),this._httpService}get webSocketService(){return this._webSocketService||(this._webSocketService=new ah),this._webSocketService}get gameRepository(){return this._gameRepository||(this._gameRepository=new rh(this.httpService)),this._gameRepository}get userRepository(){return this._userRepository||(this._userRepository=new nh(this.httpService)),this._userRepository}get chatRepository(){return this._chatRepository||(this._chatRepository=new oh(this.httpService)),this._chatRepository}get personaRepository(){return this._personaRepository||(this._personaRepository=new ih(this.httpService)),this._personaRepository}get personaUseCases(){if(!this._personaUseCases){const e=this.personaRepository,t=this.logger;this._personaUseCases={createPersona:new ch(e,t),getPersonas:new lh(e),updatePersona:new dh(e,t),deletePersona:new uh(e,t),activatePersona:new ph(e,t)}}return this._personaUseCases}get clientLogsApiClient(){return La.clientLogsApiClient}get clientLogsService(){return La.clientLogsService}get logger(){return La.logger}get gameApplicationService(){return this._gameApplicationService||(this._gameApplicationService=new th(this.userRepository,this.chatRepository,this.webSocketService,this.logger)),this._gameApplicationService}get store(){return this._store||(this._store=bf(this.config.enableLogging)),this._store}get personaResponseService(){return this._personaResponseService||(this._personaResponseService=new Vh(Kh,this.store)),this._personaResponseService}get webSocketConfig(){return{url:this.config.webSocketUrl,reconnectInterval:this.config.webSocketReconnectInterval,maxReconnectAttempts:this.config.webSocketMaxReconnectAttempts,heartbeatInterval:this.config.webSocketHeartbeatInterval}}reset(){this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._personaResponseService=null,this._store=null,this._gameApplicationService=null,this._config=null}setHttpService(e){this._httpService=e,this._gameRepository=null,this._userRepository=null,this._chatRepository=null,this._personaRepository=null,this._personaUseCases=null,this._gameApplicationService=null}setWebSocketService(e){this._webSocketService=e,this._gameApplicationService=null}setGameRepository(e){this._gameRepository=e,this._gameApplicationService=null}setUserRepository(e){this._userRepository=e,this._gameApplicationService=null}setGameApplicationService(e){this._gameApplicationService=e}setLogger(e){this._logger=e,this._gameApplicationService=null}setConfig(e){this._config={...this.config,...e},this._httpService=null,this._webSocketService=null,this._gameRepository=null,this._userRepository=null,this._gameApplicationService=null,this._store=null}}const Ie=new vf,on="client.log",wf=(s,e,t,a)=>({left:-s.x/e,top:-s.y/e,right:(-s.x+t)/e,bottom:(-s.y+a)/e}),yf=(s,e)=>{const t=s.x+(s.width??100),a=s.y+(s.height??50),n=s.x<e.right&&t>e.left&&s.y<e.bottom&&a>e.top,o=s.x>=e.right?s.x-e.right:t<=e.left?e.left-t:0,i=s.y>=e.bottom?s.y-e.bottom:a<=e.top?e.top-a:0;return{visible:n,offBy:{x:o,y:i}}},Sf=(s,e,t,a,n)=>{const o=s.x+(s.width??100)/2,i=s.y+(s.height??50)/2,c=(n==null?void 0:n.verticalPositionRatio)??.5,l=t/2-o*e,u=a*c-i*e;return{x:l,y:u}},Cf=(s,e,t,a=500,n)=>{const{uiState:o,projectCanvas:i,setActiveCanvasViewState:c}=e(),l=i.getActive();if(!l){console.warn("Cannot center view: No active canvas.");return}const u=l.coreState.nodes,p=l.viewState.scale,h=typeof t=="string"?u==null?void 0:u.find(j=>j.id===t):t,f=o==null?void 0:o.canvasWidth,b=o==null?void 0:o.canvasHeight;if(!h){console.warn("Cannot center view: Node dimensions not found.");return}if(!f||!b){console.warn("Cannot center view: Canvas dimensions not found.");return}const v=l.viewState.offset,m=wf(v,p,f,b),{visible:w,offBy:y}=yf(h,m);Ie.clientLogsApiClient.sendLogs("1_scrollToNode_START",{nodeId:h.id,nodePosition:{x:h.x,y:h.y},nodeDimensions:{width:h.width??100,height:h.height??50},viewport:m,isNodeVisible:w,offViewportBy:w?null:y,scale:p},on);const g=Sf(h,p,f,b,n!=null&&n.verticalOnly?{verticalPositionRatio:Oe.writeMode.scrollVerticalPositionRatio}:void 0),x=n!=null&&n.verticalOnly?{x:v.x,y:g.y}:g;Ie.clientLogsApiClient.sendLogs("2_scrollToNode_TARGET",{nodeId:h.id,currentOffset:v,targetOffset:x,duration:a,verticalOnly:!!(n!=null&&n.verticalOnly)},on),c(j=>({...j,targetView:{targetOffset:x,targetScale:p,animationStartTime:0,animationDuration:a}}))},jf=(s,e)=>{s(t=>{const a=t.projectCanvas.getActive();if(!a)return{};const n=new Set(a.coreState.selectedNodes.map(o=>o.id));return n.size===0?{}:(t.setActiveCanvasCoreState(o=>{const i=o.nodes.filter(l=>!n.has(l.id)),c=o.arrows.filter(l=>!(l.startNodeId&&n.has(l.startNodeId)||l.endNodeId&&n.has(l.endNodeId)));return{...o,nodes:i,arrows:c,selectedNodes:[]}}),{})})},Nf=(s,e)=>{s(t=>{const a=t.projectCanvas.getActive();if(!a)return{};const n=new Set(a.coreState.selectedArrows.map(o=>o.id));return n.size===0?{}:(t.setActiveCanvasCoreState(o=>{const i=o.arrows.filter(c=>!n.has(c.id));return{...o,arrows:i,selectedArrows:[]}}),{})})},as=s=>(e,t)=>{s(a=>{if(!a.state)return a;const n=a.state.activeProjectId?a.state.projects[a.state.activeProjectId]:null,o=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return a;const c=i.coreState,l=c.nodes.findIndex(v=>v.id===e);if(l===-1)return a;const u=new Date().toISOString(),p={...t,updatedAt:u},h=[...c.nodes];h[l]={...h[l],...p};const b=c.selectedNodes.some(v=>v.id===e)?c.selectedNodes.map(v=>v.id===e?{...v,...p}:v):c.selectedNodes;return window.__nodes=h,window.__selectedNodes=b,{...a,state:{...a.state,projects:{...a.state.projects,[a.state.activeProjectId]:{...n,lastModified:Date.now(),workspaces:{...n.workspaces,[n.activeWorkspaceId]:{...o,lastModified:Date.now(),canvases:{...o.canvases,[o.activeCanvasId]:{...i,coreState:{...c,nodes:h,selectedNodes:b},lastModified:Date.now()}}}}}}}}})},Ef=(s,e,t)=>({x:Number(((s.x-t.x)/e).toFixed(3)),y:Number(((s.y-t.y)/e).toFixed(3))}),kf=s=>{const{projectCanvas:e}=s(),t=$g.getState(),a=t==null?void 0:t.mousePosition,n=e.getActive(),o=(n==null?void 0:n.viewState.scale)??1,i=(n==null?void 0:n.viewState.offset)??{x:0,y:0};return!a||!n?null:Ef(a,o,i)};var Qi=Symbol.for("immer-nothing"),cn=Symbol.for("immer-draftable"),ot=Symbol.for("immer-state");function gt(s,...e){throw new Error(`[Immer] minified error nr: ${s}. Full error at: https://bit.ly/3cXEKWf`)}var xs=Object.getPrototypeOf;function Zt(s){return!!s&&!!s[ot]}function Gt(s){var e;return s?Xi(s)||Array.isArray(s)||!!s[cn]||!!((e=s.constructor)!=null&&e[cn])||Rs(s)||Ea(s):!1}var Tf=Object.prototype.constructor.toString(),ln=new WeakMap;function Xi(s){if(!s||typeof s!="object")return!1;const e=Object.getPrototypeOf(s);if(e===null||e===Object.prototype)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;if(t===Object)return!0;if(typeof t!="function")return!1;let a=ln.get(t);return a===void 0&&(a=Function.toString.call(t),ln.set(t,a)),a===Tf}function na(s,e,t=!0){Na(s)===0?(t?Reflect.ownKeys(s):Object.keys(s)).forEach(n=>{e(n,s[n],s)}):s.forEach((a,n)=>e(n,a,s))}function Na(s){const e=s[ot];return e?e.type_:Array.isArray(s)?1:Rs(s)?2:Ea(s)?3:0}function sr(s,e){return Na(s)===2?s.has(e):Object.prototype.hasOwnProperty.call(s,e)}function Yi(s,e,t){const a=Na(s);a===2?s.set(e,t):a===3?s.add(t):s[e]=t}function Af(s,e){return s===e?s!==0||1/s===1/e:s!==s&&e!==e}function Rs(s){return s instanceof Map}function Ea(s){return s instanceof Set}function Lt(s){return s.copy_||s.base_}function ar(s,e){if(Rs(s))return new Map(s);if(Ea(s))return new Set(s);if(Array.isArray(s))return Array.prototype.slice.call(s);const t=Xi(s);if(e===!0||e==="class_only"&&!t){const a=Object.getOwnPropertyDescriptors(s);delete a[ot];let n=Reflect.ownKeys(a);for(let o=0;o<n.length;o++){const i=n[o],c=a[i];c.writable===!1&&(c.writable=!0,c.configurable=!0),(c.get||c.set)&&(a[i]={configurable:!0,writable:!0,enumerable:c.enumerable,value:s[i]})}return Object.create(xs(s),a)}else{const a=xs(s);if(a!==null&&t)return{...s};const n=Object.create(a);return Object.assign(n,s)}}function Dr(s,e=!1){return ka(s)||Zt(s)||!Gt(s)||(Na(s)>1&&Object.defineProperties(s,{set:Ms,add:Ms,clear:Ms,delete:Ms}),Object.freeze(s),e&&Object.values(s).forEach(t=>Dr(t,!0))),s}function If(){gt(2)}var Ms={value:If};function ka(s){return s===null||typeof s!="object"?!0:Object.isFrozen(s)}var Rf={};function Vt(s){const e=Rf[s];return e||gt(0,s),e}var bs;function Zi(){return bs}function Pf(s,e){return{drafts_:[],parent_:s,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function dn(s,e){e&&(Vt("Patches"),s.patches_=[],s.inversePatches_=[],s.patchListener_=e)}function rr(s){nr(s),s.drafts_.forEach(_f),s.drafts_=null}function nr(s){s===bs&&(bs=s.parent_)}function un(s){return bs=Pf(bs,s)}function _f(s){const e=s[ot];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function pn(s,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return s!==void 0&&s!==t?(t[ot].modified_&&(rr(e),gt(4)),Gt(s)&&(s=oa(e,s),e.parent_||ia(e,s)),e.patches_&&Vt("Patches").generateReplacementPatches_(t[ot].base_,s,e.patches_,e.inversePatches_)):s=oa(e,t,[]),rr(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),s!==Qi?s:void 0}function oa(s,e,t){if(ka(e))return e;const a=s.immer_.shouldUseStrictIteration(),n=e[ot];if(!n)return na(e,(o,i)=>hn(s,n,e,o,i,t),a),e;if(n.scope_!==s)return e;if(!n.modified_)return ia(s,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const o=n.copy_;let i=o,c=!1;n.type_===3&&(i=new Set(o),o.clear(),c=!0),na(i,(l,u)=>hn(s,n,o,l,u,t,c),a),ia(s,o,!1),t&&s.patches_&&Vt("Patches").generatePatches_(n,t,s.patches_,s.inversePatches_)}return n.copy_}function hn(s,e,t,a,n,o,i){if(n==null||typeof n!="object"&&!i)return;const c=ka(n);if(!(c&&!i)){if(Zt(n)){const l=o&&e&&e.type_!==3&&!sr(e.assigned_,a)?o.concat(a):void 0,u=oa(s,n,l);if(Yi(t,a,u),Zt(u))s.canAutoFreeze_=!1;else return}else i&&t.add(n);if(Gt(n)&&!c){if(!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1||e&&e.base_&&e.base_[a]===n&&c)return;oa(s,n),(!e||!e.scope_.parent_)&&typeof a!="symbol"&&(Rs(t)?t.has(a):Object.prototype.propertyIsEnumerable.call(t,a))&&ia(s,n)}}}function ia(s,e,t=!1){!s.parent_&&s.immer_.autoFreeze_&&s.canAutoFreeze_&&Dr(e,t)}function Df(s,e){const t=Array.isArray(s),a={type_:t?1:0,scope_:e?e.scope_:Zi(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:s,draft_:null,copy_:null,revoke_:null,isManual_:!1};let n=a,o=Or;t&&(n=[a],o=vs);const{revoke:i,proxy:c}=Proxy.revocable(n,o);return a.draft_=c,a.revoke_=i,c}var Or={get(s,e){if(e===ot)return s;const t=Lt(s);if(!sr(t,e))return Of(s,t,e);const a=t[e];return s.finalized_||!Gt(a)?a:a===Ua(s.base_,e)?(Fa(s),s.copy_[e]=ir(a,s)):a},has(s,e){return e in Lt(s)},ownKeys(s){return Reflect.ownKeys(Lt(s))},set(s,e,t){const a=ec(Lt(s),e);if(a!=null&&a.set)return a.set.call(s.draft_,t),!0;if(!s.modified_){const n=Ua(Lt(s),e),o=n==null?void 0:n[ot];if(o&&o.base_===t)return s.copy_[e]=t,s.assigned_[e]=!1,!0;if(Af(t,n)&&(t!==void 0||sr(s.base_,e)))return!0;Fa(s),or(s)}return s.copy_[e]===t&&(t!==void 0||e in s.copy_)||Number.isNaN(t)&&Number.isNaN(s.copy_[e])||(s.copy_[e]=t,s.assigned_[e]=!0),!0},deleteProperty(s,e){return Ua(s.base_,e)!==void 0||e in s.base_?(s.assigned_[e]=!1,Fa(s),or(s)):delete s.assigned_[e],s.copy_&&delete s.copy_[e],!0},getOwnPropertyDescriptor(s,e){const t=Lt(s),a=Reflect.getOwnPropertyDescriptor(t,e);return a&&{writable:!0,configurable:s.type_!==1||e!=="length",enumerable:a.enumerable,value:t[e]}},defineProperty(){gt(11)},getPrototypeOf(s){return xs(s.base_)},setPrototypeOf(){gt(12)}},vs={};na(Or,(s,e)=>{vs[s]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});vs.deleteProperty=function(s,e){return vs.set.call(this,s,e,void 0)};vs.set=function(s,e,t){return Or.set.call(this,s[0],e,t,s[0])};function Ua(s,e){const t=s[ot];return(t?Lt(t):s)[e]}function Of(s,e,t){var n;const a=ec(e,t);return a?"value"in a?a.value:(n=a.get)==null?void 0:n.call(s.draft_):void 0}function ec(s,e){if(!(e in s))return;let t=xs(s);for(;t;){const a=Object.getOwnPropertyDescriptor(t,e);if(a)return a;t=xs(t)}}function or(s){s.modified_||(s.modified_=!0,s.parent_&&or(s.parent_))}function Fa(s){s.copy_||(s.copy_=ar(s.base_,s.scope_.immer_.useStrictShallowCopy_))}var Mf=class{constructor(s){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(e,t,a)=>{if(typeof e=="function"&&typeof t!="function"){const o=t;t=e;const i=this;return function(l=o,...u){return i.produce(l,p=>t.call(this,p,...u))}}typeof t!="function"&&gt(6),a!==void 0&&typeof a!="function"&&gt(7);let n;if(Gt(e)){const o=un(this),i=ir(e,void 0);let c=!0;try{n=t(i),c=!1}finally{c?rr(o):nr(o)}return dn(o,a),pn(n,o)}else if(!e||typeof e!="object"){if(n=t(e),n===void 0&&(n=e),n===Qi&&(n=void 0),this.autoFreeze_&&Dr(n,!0),a){const o=[],i=[];Vt("Patches").generateReplacementPatches_(e,n,o,i),a(o,i)}return n}else gt(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(i,...c)=>this.produceWithPatches(i,l=>e(l,...c));let a,n;return[this.produce(e,t,(i,c)=>{a=i,n=c}),a,n]},typeof(s==null?void 0:s.autoFreeze)=="boolean"&&this.setAutoFreeze(s.autoFreeze),typeof(s==null?void 0:s.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(s.useStrictShallowCopy),typeof(s==null?void 0:s.useStrictIteration)=="boolean"&&this.setUseStrictIteration(s.useStrictIteration)}createDraft(s){Gt(s)||gt(8),Zt(s)&&(s=Lf(s));const e=un(this),t=ir(s,void 0);return t[ot].isManual_=!0,nr(e),t}finishDraft(s,e){const t=s&&s[ot];(!t||!t.isManual_)&&gt(9);const{scope_:a}=t;return dn(a,e),pn(void 0,a)}setAutoFreeze(s){this.autoFreeze_=s}setUseStrictShallowCopy(s){this.useStrictShallowCopy_=s}setUseStrictIteration(s){this.useStrictIteration_=s}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(s,e){let t;for(t=e.length-1;t>=0;t--){const n=e[t];if(n.path.length===0&&n.op==="replace"){s=n.value;break}}t>-1&&(e=e.slice(t+1));const a=Vt("Patches").applyPatches_;return Zt(s)?a(s,e):this.produce(s,n=>a(n,e))}};function ir(s,e){const t=Rs(s)?Vt("MapSet").proxyMap_(s,e):Ea(s)?Vt("MapSet").proxySet_(s,e):Df(s,e);return(e?e.scope_:Zi()).drafts_.push(t),t}function Lf(s){return Zt(s)||gt(10,s),tc(s)}function tc(s){if(!Gt(s)||ka(s))return s;const e=s[ot];let t,a=!0;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=ar(s,e.scope_.immer_.useStrictShallowCopy_),a=e.scope_.immer_.shouldUseStrictIteration()}else t=ar(s,!0);return na(t,(n,o)=>{Yi(t,n,tc(o))},a),e&&(e.finalized_=!1),t}var $f=new Mf,Ce=$f.produce;const Mr=s=>{var a,n,o;if(!s.state)return null;const e=s.state.activeProjectId?(a=s.state.projects)==null?void 0:a[s.state.activeProjectId]:null,t=e&&e.activeWorkspaceId?(n=e.workspaces)==null?void 0:n[e.activeWorkspaceId]:null;return t&&t.activeCanvasId?(o=t.canvases)==null?void 0:o[t.activeCanvasId]:null},Uf=(s,e)=>s(Ce(t=>{t.uiState.temporaryArrow=e})),Ff=(s,e)=>s(Ce(t=>{var n,o,i,c,l,u;const a=Mr(t);if(a!=null&&a.coreState){const p=typeof e=="function"?e(a.coreState.arrows):e;a.coreState.arrows=p,a.coreState.selectedArrows.length>0&&(a.coreState.selectedArrows=a.coreState.selectedArrows.map(b=>p.find(m=>m.id===b.id)||b)),a.lastModified=Date.now();const h=(c=(i=(o=(n=t.state)==null?void 0:n.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];h&&(h.lastModified=Date.now());const f=(u=(l=t.state)==null?void 0:l.projects)==null?void 0:u[t.state.activeProjectId];f&&(f.lastModified=Date.now())}})),Wf=(s,e)=>s(Ce(t=>{var n,o,i,c,l,u;const a=Mr(t);if(a!=null&&a.coreState){const p=Array.isArray(e)?e:[],h=new Set(p.map(v=>v.id));a.coreState.selectedArrows=a.coreState.arrows.filter(v=>h.has(v.id)),a.lastModified=Date.now();const f=(c=(i=(o=(n=t.state)==null?void 0:n.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];f&&(f.lastModified=Date.now());const b=(u=(l=t.state)==null?void 0:l.projects)==null?void 0:u[t.state.activeProjectId];b&&(b.lastModified=Date.now())}})),zf=(s,e)=>s(Ce(t=>{var n,o,i,c,l,u;const a=Mr(t);if(a!=null&&a.coreState){a.coreState.arrows.push(e),a.lastModified=Date.now();const p=(c=(i=(o=(n=t.state)==null?void 0:n.projects)==null?void 0:o[t.state.activeProjectId])==null?void 0:i.workspaces)==null?void 0:c[t.state.projects[t.state.activeProjectId].activeWorkspaceId];p&&(p.lastModified=Date.now());const h=(u=(l=t.state)==null?void 0:l.projects)==null?void 0:u[t.state.activeProjectId];h&&(h.lastModified=Date.now())}})),Bf=(s,e,t,a)=>{s(Ce(n=>{var l,u;const o=(l=n.state)!=null&&l.activeProjectId?n.state.projects[n.state.activeProjectId]:null,i=o!=null&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i!=null&&i.activeCanvasId?i.canvases[i.activeCanvasId]:null;if((u=c==null?void 0:c.coreState)!=null&&u.arrows){const p=c.coreState.arrows.findIndex(h=>h.id===t);if(p!==-1){if(c.coreState.arrows[p]={...c.coreState.arrows[p],...a},c.coreState.selectedArrows){const f=c.coreState.selectedArrows.findIndex(b=>b.id===t);f!==-1&&(c.coreState.selectedArrows[f]={...c.coreState.selectedArrows[f],...a})}const h=Date.now();c.lastModified=h,i&&(i.lastModified=h),o&&(o.lastModified=h)}}}))},Hf=(s,e)=>({setTemporary:t=>Uf(s,t),setAll:t=>Ff(s,t),setSelected:t=>Wf(s,t),add:t=>zf(s,t),update:(t,a)=>Bf(s,e,t,a)});function Gf(s,e=getComputedStyle(document.body).font){if(!s)return 0;const a=document.createElement("canvas").getContext("2d");return a?(a.font=e,a.measureText(s).width):0}function Vf(s,e=getComputedStyle(document.body).font){return s?s.split(/\n|&nbsp;/).map(n=>{const o=sc(n),i=ac(e,o);return Gf(n,i)}).reduce((n,o)=>Math.max(n,o),0):0}function qf(s,e=getComputedStyle(document.body).font){const a=document.createElement("canvas").getContext("2d");if(!a)return 0;a.font=e;const n=a.measureText(s),o=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent;if(o&&o>0)return o;const i=a.measureText("M");return i.actualBoundingBoxAscent+i.actualBoundingBoxDescent||parseInt(e,10)*1.2}function Kf(s){const e=s.trimStart();return e.startsWith("### ")?1.2:e.startsWith("## ")?1.35:e.startsWith("# ")?1.5:1}function sc(s){const e=s.trimStart();return e.startsWith("### ")?1.125:e.startsWith("## ")?1.25:e.startsWith("# ")?1.5:1}function ac(s,e){if(e===1)return s;const t=s.match(/(\d+(?:\.\d+)?)(px|rem|em|pt)/);if(!t)return s;const a=parseFloat(t[1]),n=t[2],o=a*e;return s.replace(t[0],`${o}${n}`)}function ca(s,e,t=getComputedStyle(document.body).font,a){if(!s)return 0;const o=document.createElement("canvas").getContext("2d");if(!o)return 0;o.font=t;const i=(a??qf("M",t))||parseInt(t,10)*1.2;if(i===0)return console.warn("measureWrappedTextHeight: Could not determine line height. Using fallback."),s.split(`
`).length*16;const c=s.split(`
`);let l=0,u=!1;for(const h of c){if(h.trim()===""){l+=i;continue}const f=Kf(h);f>1&&(u=!0);const b=i*f,v=sc(h),m=ac(t,v);o.font=m;const w=h.split(" ");let y="",g=1;for(let x=0;x<w.length;x++){const j=w[x],C=y+(y?" ":"")+j;o.measureText(C).width>e&&y!==""?(g++,y=j,o.measureText(j).width>e):y=C}l+=g*b}let p=l+(u?gp:0);return p+=xp,p}function qb(s,e){if(!s)return 0;const{containerWidth:t,textarea:a}=e,n=a||document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(!n)return ca(s,t);const o=window.getComputedStyle(n),i=o.fontSize,c=o.fontFamily,u=`${o.fontWeight} ${i} ${c}`;let p;const h=o.lineHeight;if(h&&h!=="normal"){const w=parseFloat(h);isNaN(w)||(p=w)}const f=parseFloat(o.paddingLeft)||0,b=parseFloat(o.paddingRight)||0,v=f+b,m=t-v;return ca(s,m,u,p)}const{DEFAULT_NODE_WIDTH:la,DEFAULT_NODE_HEIGHT:da}=He,cr=s=>{const e=s.x,t=s.y,a=s.width??la,n=s.height??da;return{x1:e,y1:t,x2:e+a,y2:t+n}},Kb=(s,e)=>{for(let t=e.length-1;t>=0;t--){const a=e[t],n=cr(a);if(s.x>=n.x1&&s.x<=n.x2&&s.y>=n.y1&&s.y<=n.y2)return a}return null},fn=s=>{const e=s.x,t=s.y,a=s.width??la,n=s.height??da;return{x:e+a/2,y:t+n/2}},Jb=(s,e)=>s.x===e.x&&s.y===e.y,rc=()=>{const s=document.querySelector("textarea[data-node-textarea]"),e=document.querySelector(".markdown-textarea[data-node-textarea]"),t=s||e;if(t){const n=window.getComputedStyle(t).lineHeight;if(n&&n!=="normal"){const o=parseFloat(n);if(!isNaN(o))return o}}},Jf=(s,e)=>{const t=e??rc(),a=Vf(s)+He.NODE_X_PADDING*2,o=ca(s,a,void 0,t)+He.NODE_Y_PADDING*2;return{width:a,height:o}},Qf=(s,e)=>{const t=cr(e);return s.filter(a=>{if(a.id===e.id)return!1;const n=cr(a);return!(n.x2<t.x1||n.x1>t.x2||n.y2<t.y1||n.y1>t.y2)})},Xf=(s,e="bottom")=>{if(!s.length)return null;switch(e){case"left":return s.reduce((t,a)=>a.x<t.x?a:t,s[0]);case"right":return s.reduce((t,a)=>a.x+(a.width??la)>t.x+(t.width??la)?a:t,s[0]);case"top":return s.reduce((t,a)=>a.y<t.y?a:t,s[0]);case"bottom":return s.reduce((t,a)=>a.y+(a.height??da)>t.y+(t.height??da)?a:t,s[0]);default:return null}},Yf=(s,e)=>s(t=>({uiState:{...t.uiState,mode:e}})),Zf=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:e}})),em=(s,e)=>s(t=>({uiState:{...t.uiState,zoomSubMode:t.uiState.zoomSubMode==="zoom:lock"?"zoom":"zoom:lock"}})),tm=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:e}})),sm=(s,e)=>s(t=>({uiState:{...t.uiState,writeSubMode:t.uiState.writeSubMode===Gs.AUDIO?Gs.WRITE:Gs.AUDIO}})),am=(s,e)=>s(()=>({mousePosition:e})),rm=(s,e)=>s(t=>({uiState:{...t.uiState,isPanning:e}})),nm=(s,e)=>s(t=>({uiState:{...t.uiState,selectionBox:e}})),om=(s,e)=>s(t=>({uiState:{...t.uiState,pendingSelectionStart:e}})),im=(s,e)=>s(t=>({uiState:{...t.uiState,writeModeStartPosition:e}})),cm=(s,e)=>s(t=>({uiState:{...t.uiState,dragInfo:e}})),lm=(s,e)=>s(t=>({uiState:{...t.uiState,resizingNode:e}})),dm=(s,e)=>s(t=>({uiState:{...t.uiState,nodeToFocusId:e}})),um=(s,e)=>{var a;if(!e)return;const t=s().projectCanvas.getActive();return(a=t==null?void 0:t.coreState.nodes)==null?void 0:a.find(n=>n.id===e)},pm=(s,e)=>s(t=>({uiState:{...t.uiState,addNodeType:e}})),hm=(s,e,t)=>s(a=>({uiState:{...a.uiState,canvasWidth:e,canvasHeight:t}})),fm=(s,e)=>s(t=>({uiState:e(t.uiState)})),mm=(s,e)=>s(t=>(t.setActiveCanvasCoreState(a=>{if(a.nodes.length>0&&e.length===0)return console.trace("NOOO should not happend"),a;const n=typeof e=="function"?e(a.nodes):e;return{...a,nodes:n}}),{})),gm=(s,e)=>s(t=>(t.setActiveCanvasCoreState(a=>{const n=Array.isArray(e)?e:[],o=new Set(n.map(l=>l.id)),i=a.nodes.map(l=>({...l,isEditing:!1})),c=i.filter(l=>o.has(l.id));return{...a,nodes:i,selectedNodes:c}}),{})),xm=(s,e)=>s(t=>(t.setActiveCanvasCoreState(a=>{const n=a.selectedNodes.filter(i=>i.id!==e),o=a.nodes.map(i=>i.id===e?{...i,isEditing:!1}:i);return{...a,nodes:o,selectedNodes:n}}),{})),bm=(s,e,t,a={dontOverlap:!1,dontSelect:!1})=>s(n=>(n.setActiveCanvasCoreState(o=>{const i=new Date().toISOString(),c={...e,createdAt:e.createdAt??i,updatedAt:i};t!==void 0&&(c.content=t);let l=e.y;const u=o.nodes;if(a.dontOverlap){const f=Qf(u,e),b=Xf(f);b&&(l=b.y+(b.height??0)),c.y=l+He.nodeSpacing}const p=[...u,c],h=a.dontSelect?o.selectedNodes:[c];return{...o,nodes:p,selectedNodes:h,selectedArrows:a.dontSelect?o.selectedArrows:[]}}),{})),vm=(s,e)=>s(t=>({state:e(t.state)})),wm=s=>(e,t)=>as(s)(e,{content:t}),ym=s=>(e,t)=>as(s)(e,{subContent:t}),Sm=s=>(e,t)=>as(s)(e,{title:t}),Cm=s=>(e,t)=>as(s)(e,{...t}),jm=s=>{var t;const e=s().projectCanvas.getActive();return(t=e==null?void 0:e.coreState.nodes)==null?void 0:t.find(a=>a.isEditing)},Nm=(s,e)=>s(t=>(t.setActiveCanvasCoreState(a=>{const n=a.nodes.filter(c=>c.id!==e),o=a.selectedNodes.filter(c=>c.id!==e),i=a.arrows.filter(c=>c.startNodeId!==e&&c.endNodeId!==e);return{...a,nodes:n,selectedNodes:o,arrows:i}}),t.uiState.nodeToFocusId===e&&s(a=>({uiState:{...a.uiState,nodeToFocusId:null}})),{})),Em=s=>s(e=>(e.setActiveCanvasCoreState(t=>({...t,nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]})),{})),km=(s,e)=>s(t=>({flags:e(t.flags)})),Tm=s=>s(kt),Am=s=>s(e=>({uiState:{...e.uiState,isOverlayVisible:!e.uiState.isOverlayVisible}})),Im=s=>s(e=>({uiState:{...e.uiState,useCurvedArrows:!e.uiState.useCurvedArrows}})),Rm=(s,e)=>s(t=>({uiState:{...t.uiState,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[],...t.uiState.nodeUpdateSettings||{},...e}}})),Pm=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:e.sort((a,n)=>a-n)}})),_m=(s,e)=>s(t=>{const a=t.uiState.zoomMarks||[];return a.includes(e)?t:{uiState:{...t.uiState,zoomMarks:[...a,e].sort((n,o)=>n-o)}}}),Dm=(s,e)=>s(t=>({uiState:{...t.uiState,zoomMarks:(t.uiState.zoomMarks||[]).filter(a=>a!==e)}})),Om=s=>{const e=s().state;if(!e){console.error("Cannot export: State is not available.");return}const a=JSON.stringify(e,null,2),n=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`markop-canvas-export-${new Date().toISOString()}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)},Mm=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:a,workspaceId:n,canvasId:o}=e,i=t.projects[a];if(!i){console.error(`Cannot export: Project ${a} not found.`);return}const c=i.workspaces[n];if(!c){console.error(`Cannot export: Workspace ${n} not found.`);return}const l=c.canvases[o];if(!l){console.error(`Cannot export: Canvas ${o} not found.`);return}const u={...c,canvases:{[o]:l},activeCanvasId:o},p={...i,workspaces:{[n]:u},activeWorkspaceId:n},h={projects:{[a]:p},activeProjectId:a},f=JSON.stringify(h,null,2),b=new Blob([f],{type:"application/json"}),v=URL.createObjectURL(b),m=l.name.replace(/[^a-zA-Z0-9-_]/g,"_"),w=document.createElement("a");w.href=v,w.download=`canvas-${m}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(v)},Lm=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:a,workspaceId:n}=e,o=t.projects[a];if(!o){console.error(`Cannot export: Project ${a} not found.`);return}const i=o.workspaces[n];if(!i){console.error(`Cannot export: Workspace ${n} not found.`);return}const c={...o,workspaces:{[n]:i},activeWorkspaceId:n},l={projects:{[a]:c},activeProjectId:a},u=JSON.stringify(l,null,2),p=new Blob([u],{type:"application/json"}),h=URL.createObjectURL(p),f=i.name.replace(/[^a-zA-Z0-9-_]/g,"_"),b=document.createElement("a");b.href=h,b.download=`workspace-${f}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(h)},$m=s=>e=>{const t=s().state;if(!t){console.error("Cannot export: State is not available.");return}const{projectId:a}=e,n=t.projects[a];if(!n){console.error(`Cannot export: Project ${a} not found.`);return}const o={projects:{[a]:n},activeProjectId:a},i=JSON.stringify(o,null,2),c=new Blob([i],{type:"application/json"}),l=URL.createObjectURL(c),u=n.name.replace(/[^a-zA-Z0-9-_]/g,"_"),p=document.createElement("a");p.href=l,p.download=`project-${u}-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(l)},Um=(s,e,t={})=>{const{replace:a=!1}=t;try{const n=JSON.parse(e);if((!n||typeof n.projects!="object")&&n.projects!==null)throw new Error("Invalid data format: Missing or invalid 'projects' structure.");const o=n.projects??{};let i=0,c=0;if(a){let l=n.activeProjectId;l&&!o[l]?(console.warn("Imported activeProjectId does not exist in the imported projects. Resetting active project."),l=Object.keys(o)[0]??null):!l&&Object.keys(o).length>0&&(l=Object.keys(o)[0]),i=Object.keys(o).length,s(u=>({...u,state:{projects:o,activeProjectId:l??null,nodes:void 0,arrows:void 0,selectedArrows:void 0},uiState:{...u.uiState,dragInfo:null,resizingNode:null,temporaryArrow:null,selectionBox:null,isPanning:!1,nodeToFocusId:null}})),console.log(`Canvas data replaced: ${i} project(s) imported.`)}else s(l=>{var h;const u=((h=l.state)==null?void 0:h.projects)??{},p={...u};for(const[f,b]of Object.entries(o))u[f]?(c++,console.warn(`Project "${b.name}" (${f}) already exists, skipping.`)):(p[f]=b,i++);return{...l,state:{...l.state,projects:p}}}),console.log(`Canvas data merged: ${i} project(s) imported, ${c} skipped.`);return{projectsImported:i,projectsSkipped:c}}catch(n){return console.error("Failed to import canvas project data:",n),{projectsImported:0,projectsSkipped:0}}},Fm=(s,e,t)=>{const a=Fe(10),n=Date.now(),o=Fe(10),i={id:o,name:"Default Canvas",createdAt:n,lastModified:n,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1}},c=Fe(10),l={id:c,name:"Default Workspace",createdAt:n,lastModified:n,canvases:{[o]:i},activeCanvasId:o},u={id:a,name:t||"New Project",createdAt:n,lastModified:n,workspaces:{[c]:l},activeWorkspaceId:c};return s(Ce(p=>{p.state||(p.state={projects:{},activeProjectId:null}),p.state.projects[a]=u,p.state.activeProjectId=a})),a},Wm=(s,e,t)=>{s(Ce(a=>{var n;(n=a.state)!=null&&n.projects[t]?a.state.activeProjectId=t:console.warn(`Project with ID ${t} not found.`)}))},zm=(s,e,t)=>{s(Ce(a=>{var n;if((n=a.state)!=null&&n.projects[t]&&(delete a.state.projects[t],a.state.activeProjectId===t)){const o=Object.keys(a.state.projects);a.state.activeProjectId=o.length>0?o[0]:null}}))},Bm=(s,e,t,a)=>{s(Ce(n=>{var i;const o=(i=n.state)==null?void 0:i.projects[t];o&&(a.name!==void 0&&(o.name=a.name),a.hideFromSearch!==void 0&&(o.hideFromSearch=a.hideFromSearch),o.lastModified=a.lastModified??Date.now())}))},nc=s=>{const e=s().state;if(!e)return null;const{projects:t,activeProjectId:a}=e;return a?t[a]??null:null},Hm=(s,e)=>({create:t=>Fm(s,e,t),switch:t=>Wm(s,e,t),delete:t=>zm(s,e,t),updateMetadata:(t,a)=>Bm(s,e,t,a),getActive:()=>nc(e)}),Gm=(s,e,t)=>{var u;const a=(u=e().state)==null?void 0:u.activeProjectId;if(!a)return null;const n=Fe(10),o=Date.now(),i=Fe(10),c={id:i,name:"Default Canvas",createdAt:o,lastModified:o,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1}},l={id:n,name:t||"New Workspace",createdAt:o,lastModified:o,canvases:{[i]:c},activeCanvasId:i};return s(Ce(p=>{var f;const h=(f=p.state)==null?void 0:f.projects[a];h&&(h.workspaces[n]=l,h.activeWorkspaceId=n,h.lastModified=o)})),n},Vm=(s,e,t)=>{s(Ce(a=>{var o;const n=(o=a.state)!=null&&o.activeProjectId?a.state.projects[a.state.activeProjectId]:null;n&&n.workspaces[t]?(n.activeWorkspaceId=t,n.lastModified=Date.now()):console.warn(`Workspace with ID ${t} not found in active project.`)}))},qm=(s,e,t)=>{s(Ce(a=>{var o;const n=(o=a.state)!=null&&o.activeProjectId?a.state.projects[a.state.activeProjectId]:null;if(n&&n.workspaces[t]&&(delete n.workspaces[t],n.lastModified=Date.now(),n.activeWorkspaceId===t)){const i=Object.keys(n.workspaces);n.activeWorkspaceId=i.length>0?i[0]:null}}))},Km=(s,e,t,a)=>{s(Ce(n=>{var c;const o=(c=n.state)!=null&&c.activeProjectId?n.state.projects[n.state.activeProjectId]:null,i=o?o.workspaces[t]:null;if(i){a.name!==void 0&&(i.name=a.name),a.hideFromSearch!==void 0&&(i.hideFromSearch=a.hideFromSearch);const l=a.lastModified??Date.now();i.lastModified=l,o&&(o.lastModified=l)}}))},Lr=s=>{const e=nc(s);return e&&e.activeWorkspaceId?e.workspaces[e.activeWorkspaceId]??null:null},Jm=(s,e)=>({create:t=>Gm(s,e,t),switch:t=>Vm(s,e,t),delete:t=>qm(s,e,t),updateMetadata:(t,a)=>Km(s,e,t,a),getActive:()=>Lr(e)}),Qm={CanvasStateV2:!1,useSelectionHandler:!1,useArrowDrawingV2:!1,useCanvasKeyboardEventsV2:!1,useCanvasMouseEventsV2:!1,WriteModeHandlerV2:!1},mn=10,Xm=(s,e)=>{const t=s.replace(/\s*\(\d+\)$/,"");if(!e.includes(t)&&s!==t)return t;const a=new RegExp(`^${Ym(t)}\\s*\\((\\d+)\\)$`),n=e.map(c=>{const l=c.match(a);return l?parseInt(l[1],10):0}).filter(c=>c>0),o=e.includes(t);let i=1;return(o||n.length>0)&&(i=Math.max(0,...n)+1),`${t} (${i})`},Ym=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Zm=(s,e,t)=>{var u;const a=(u=e().state)==null?void 0:u.activeProjectId,n=Lr(e),o=n==null?void 0:n.id;if(!a||!o)return null;const i=Fe(10),c=Date.now(),l={id:i,name:t||"New Canvas",createdAt:c,lastModified:c,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1}};return s(Ce(p=>{var b;const h=(b=p.state)==null?void 0:b.projects[a],f=h==null?void 0:h.workspaces[o];f&&(f.canvases[i]=l,f.activeCanvasId=i,f.lastModified=c,h&&(h.lastModified=c))})),i},eg=(s,e,t)=>{s(Ce(a=>{if(!a.state)return;let n=null,o=null;for(const[p,h]of Object.entries(a.state.projects)){for(const[f,b]of Object.entries(h.workspaces))if(b.canvases[t]){n=p,o=f;break}if(n)break}if(!n||!o){console.warn(`Canvas with ID ${t} not found in any workspace.`);return}const i=Date.now();a.state.activeProjectId!==n&&(a.state.activeProjectId=n);const c=a.state.projects[n];if(!c)return;c.activeWorkspaceId!==o&&(c.activeWorkspaceId=o);const l=c.workspaces[o];if(!l)return;l.activeCanvasId=t,l.lastModified=i,c.lastModified=i;const u=l.canvases[t];if(u){a.preferences||(a.preferences={}),a.preferences.recentCanvases||(a.preferences.recentCanvases=[]);const p={projectId:n,workspaceId:o,canvasId:t,canvasName:u.name,projectName:c.name,workspaceName:l.name,visitedAt:i};a.preferences.recentCanvases=a.preferences.recentCanvases.filter(h=>h.canvasId!==t),a.preferences.recentCanvases.unshift(p),a.preferences.recentCanvases.length>mn&&(a.preferences.recentCanvases=a.preferences.recentCanvases.slice(0,mn))}}))},tg=(s,e,t)=>{s(Ce(a=>{var i;const n=(i=a.state)!=null&&i.activeProjectId?a.state.projects[a.state.activeProjectId]:null,o=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null;if(o&&o.canvases[t]){delete o.canvases[t];const c=Date.now();if(o.lastModified=c,n&&(n.lastModified=c),o.activeCanvasId===t){const l=Object.keys(o.canvases);o.activeCanvasId=l.length>0?l[0]:null}}}))},sg=(s,e,t,a)=>{s(Ce(n=>{var l;const o=(l=n.state)!=null&&l.activeProjectId?n.state.projects[n.state.activeProjectId]:null,i=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,c=i?i.canvases[t]:null;if(c){a.name!==void 0&&(c.name=a.name),a.hideFromSearch!==void 0&&(c.hideFromSearch=a.hideFromSearch);const u=a.lastModified??Date.now();c.lastModified=u,i&&(i.lastModified=u),o&&(o.lastModified=u)}}))},ag=(s,e,t,a,n)=>{const o=e().state;if(!o)return null;const i=o.projects[a];if(!i)return null;const c=i.workspaces[n];if(!c)return null;const l=c.canvases[t];if(!l)return null;const u=Object.values(c.canvases).map(v=>v.name),p=Xm(l.name,u),h=Fe(10),f=Date.now(),b={id:h,name:p,createdAt:f,lastModified:f,coreState:{nodes:l.coreState.nodes.map(v=>({...v})),arrows:l.coreState.arrows.map(v=>({...v})),selectedNodes:[],selectedArrows:[]},viewState:{offset:{...l.viewState.offset},scale:l.viewState.scale}};return s(Ce(v=>{var y;const m=(y=v.state)==null?void 0:y.projects[a],w=m==null?void 0:m.workspaces[n];w&&(w.canvases[h]=b,w.activeCanvasId=h,w.lastModified=f,m&&(m.lastModified=f))})),h},rg=(s,e,t)=>{s(Ce(a=>{var n;(n=a.preferences)!=null&&n.recentCanvases&&(a.preferences.recentCanvases=a.preferences.recentCanvases.filter(o=>o.canvasId!==t))}))},ng=s=>{const e=Lr(s),t=e&&e.activeCanvasId?e.canvases[e.activeCanvasId]??null:null;return window.activeCanvas=t,t},og=(s,e)=>({create:t=>Zm(s,e,t),switch:t=>eg(s,e,t),delete:t=>tg(s,e,t),duplicate:(t,a,n)=>ag(s,e,t,a,n),updateMetadata:(t,a)=>sg(s,e,t,a),getActive:()=>ng(e),removeRecentCanvas:t=>rg(s,e,t)}),ig=s=>(e,t)=>{as(s)(e,{styles:t})};class cg{constructor(e,t=!1){J(this,"enabled");J(this,"name");this.name=e,this.enabled=t}setEnabled(e){this.enabled=e}formatMessage(e){return[`[${this.name}]`,...e]}log(...e){this.enabled&&console.log(...this.formatMessage(e))}warn(...e){this.enabled&&console.warn(...this.formatMessage(e))}error(...e){this.enabled&&console.error(...this.formatMessage(e))}}const lg=(s,e,t,a)=>{const n=t/2-s.x*e,o=a/2-s.y*e;return{x:n,y:o}},dg=(s,e)=>{const t=e.find(i=>i.id===s.startNodeId),a=e.find(i=>i.id===s.endNodeId),n=t?fn(t):s.startPoint,o=a?fn(a):s.endPoint;return{x:(n.x+o.x)/2,y:(n.y+o.y)/2}},ug=(s,e,t,a=500)=>{const{uiState:n,projectCanvas:o,setActiveCanvasViewState:i}=e(),c=o.getActive();if(!c){console.warn("Cannot center view: No active canvas.");return}const l=c.coreState.arrows,u=c.coreState.nodes,p=c.viewState.scale,h=n==null?void 0:n.canvasWidth,f=n==null?void 0:n.canvasHeight,b=typeof t=="string"?l==null?void 0:l.find(w=>w.id===t):t;if(!b){console.warn("Cannot center view: Arrow not found.");return}if(!h||!f){console.warn("Cannot center view: Canvas dimensions not found.");return}const v=dg(b,u),m=lg(v,p,h,f);i(w=>({...w,targetView:{targetOffset:m,targetScale:p,animationStartTime:performance.now(),animationDuration:a}}))},pg=s=>e=>{s(Ce(t=>{var l;if(!t.state)return;const a=t.state.activeProjectId?t.state.projects[t.state.activeProjectId]:null,n=a&&a.activeWorkspaceId?a.workspaces[a.activeWorkspaceId]:null,o=n&&n.activeCanvasId?n.canvases[n.activeCanvasId]:null;if(!((l=o==null?void 0:o.coreState)!=null&&l.nodes))return;const i=new Date().toISOString();let c=null;o.coreState.nodes=o.coreState.nodes.map(u=>{const p=e.find(b=>b.id===u.id);if(!p)return u;let h=!1,f=!1;for(const b in p)if(p[b]!==u[b]){h=!0,(b==="x"||b==="y")&&(f=!0);break}return h&&f&&(c=u.id),h?{...u,...p,updatedAt:i}:u}),c&&(t.uiState.lastUpdatedNodeId=c),o.lastModified=Date.now(),n&&(n.lastModified=Date.now()),a&&(a.lastModified=Date.now())}),!1)},hg={preserveLineBreaks:!0,convertLinks:!0,convertLists:!0,convertTables:!0};function fg(s){const e=s.match(/font-size:\s*([\d.]+)pt/i);if(e)return parseFloat(e[1]);const t=s.match(/font-size:\s*([\d.]+)px/i);return t?parseFloat(t[1])/1.333:null}function mg(s){const e=s.getAttribute("style")||"",t=s.tagName.toLowerCase();return t==="b"||t==="strong"?!e.includes("font-weight:normal"):!!(e.includes("font-weight:700")||e.includes("font-weight:bold"))}function gg(s){const e=s.getAttribute("style")||"",t=s.tagName.toLowerCase();return!!(t==="i"||t==="em"||e.includes("font-style:italic"))}function xg(s){const e=s.getAttribute("style")||"",t=s.tagName.toLowerCase();return!!(t==="s"||t==="strike"||t==="del"||e.includes("text-decoration:line-through")||e.includes("text-decoration: line-through"))}function bg(s){const e=s.getAttribute("style")||"",t=s.tagName.toLowerCase();return!!(t==="code"||t==="pre"||t==="tt"||e.includes("font-family")&&(e.includes("monospace")||e.includes("Consolas")||e.includes("Courier")||e.includes("Monaco")))}function vg(s){return s>=20?1:s>=15?2:s>=12.5?3:null}function oc(s,e,t={}){const a=s.tagName.toLowerCase(),n=s.getAttribute("style")||"";switch(a){case"h1":return`# ${Pe(s,e,{insideHeading:!0})}
`;case"h2":return`## ${Pe(s,e,{insideHeading:!0})}
`;case"h3":return`### ${Pe(s,e,{insideHeading:!0})}
`;case"h4":return`#### ${Pe(s,e,{insideHeading:!0})}
`;case"h5":return`##### ${Pe(s,e,{insideHeading:!0})}
`;case"h6":return`###### ${Pe(s,e,{insideHeading:!0})}
`;case"p":return`${Pe(s,e)}
`;case"br":return`
`;case"hr":return`---
`;case"blockquote":return`> ${Pe(s,e).trim().replace(/\n/g,`
> `)}
`;case"a":if(e.convertLinks){const p=s.getAttribute("href")||"";return`[${Pe(s,e)}](${p})`}return Pe(s,e);case"ul":return e.convertLists?ic(s,e):Pe(s,e);case"ol":return e.convertLists?cc(s,e):Pe(s,e);case"li":return Pe(s,e);case"table":return e.convertTables?wg(s,e):Pe(s,e);case"code":case"pre":return`\`${s.textContent||""}\``;case"strong":case"b":return n.includes("font-weight:normal")?Pe(s,e):`**${Pe(s,e)}**`;case"em":case"i":return`*${Pe(s,e)}*`;case"s":case"strike":case"del":return`~~${Pe(s,e)}~~`;case"meta":case"style":case"script":return""}let o=Pe(s,e,t);if(!t.insideHeading){const p=fg(n);if(p){const h=vg(p);if(h){const f="#".repeat(h);return o=o.replace(/^\*\*(.+)\*\*$/,"$1"),`${f} ${o.trim()}
`}}}const i=!t.insideHeading&&mg(s),c=gg(s),l=xg(s);return bg(s)?`\`${s.textContent||""}\``:(l&&(o=`~~${o}~~`),c&&(o=`*${o}*`),i&&(o=`**${o}**`),o)}function Pe(s,e,t={}){let a="";for(const n of Array.from(s.childNodes))n.nodeType===Node.TEXT_NODE?a+=n.textContent||"":n.nodeType===Node.ELEMENT_NODE&&(a+=oc(n,e,t));return a}function ic(s,e,t=0){const a=s.querySelectorAll(":scope > li");let n="";const o="  ".repeat(t);return a.forEach(i=>{const c=lc(i,e,t);n+=`${o}- ${c}
`}),n}function cc(s,e,t=0){const a=s.querySelectorAll(":scope > li");let n="";const o="  ".repeat(t);return a.forEach((i,c)=>{const l=lc(i,e,t);n+=`${o}${c+1}. ${l}
`}),n}function lc(s,e,t){let a="",n="";for(const o of Array.from(s.childNodes))if(o.nodeType===Node.TEXT_NODE)a+=o.textContent||"";else if(o.nodeType===Node.ELEMENT_NODE){const i=o,c=i.tagName.toLowerCase();c==="ul"?n+=ic(i,e,t+1):c==="ol"?n+=cc(i,e,t+1):a+=oc(i,e)}return a.trim()+(n?`
`+n.trimEnd():"")}function wg(s,e){const t=s.querySelectorAll("tr");if(t.length===0)return"";let a="",n=!0,o=0;return t.forEach(i=>{const c=i.querySelectorAll("td, th"),l=[];c.forEach(u=>{const p=Pe(u,e).trim().replace(/\n/g," ");l.push(p)}),n&&(o=l.length),a+=`| ${l.join(" | ")} |
`,n&&(a+=`| ${Array(o).fill("---").join(" | ")} |
`,n=!1)}),a}function yg(s){return s.replace(/\n{3,}/g,`

`).split(`
`).map(e=>e.trimEnd()).join(`
`).trim()}function Sg(s,e={}){const t={...hg,...e},a=document.createElement("div");a.innerHTML=s;const n=Pe(a,t);return yg(n)}function Qb(s){return s.includes("docs-internal-guid")||s.includes('id="docs-internal-guid')}async function Xb(){try{const s=await navigator.clipboard.read();for(const e of s){if(e.types.includes("text/html")){const a=await(await e.getType("text/html")).text();return Sg(a)}if(e.types.includes("text/plain"))return await(await e.getType("text/plain")).text()}return await navigator.clipboard.readText()}catch{return await navigator.clipboard.readText()}}async function Cg(s){var e;if((e=window.clipboardData)!=null&&e.setData)return window.clipboardData.setData("Text",s);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){const t=document.createElement("textarea");t.textContent=s,t.style.position="fixed",document.body.appendChild(t),t.select();try{return document.execCommand("copy")}catch(a){return console.warn("Copy to clipboard failed.",a),prompt("Copy to clipboard: Ctrl+C, Enter",s)}finally{document.body.removeChild(t)}}}function jg(){return Math.random().toString(36).substring(2,9)}let dc=0;function Yb(){let s=Date.now().toString(25);return s+=dc++,`${jg()}-${s}`}function Ng(){let s=Date.now().toString(25);return s+="_"+dc++,s}const Eg=/^c-(\d+_)?(.+)$/;function Ps(s){const e=Eg.exec(s),t=Ng();return e?`${e[1]?`c-${parseInt(e[1],10)+1}_`:"c-1_"}${e[2]}`+t:`c-${s}`+t}Ps("abc");Ps("c-abc");Ps("c-1_abc");const kg=s=>s(e=>(e.setActiveCanvasCoreState(t=>{const a=t.selectedNodes,n=a.map(i=>i.content).join(`
`);Cg(n);const o=a.map(i=>{const c=i.height??He.DEFAULT_NODE_HEIGHT,l=i.y+c+He.nodeSpacing,u=Ps(i.id);return{...i,id:u,y:l,x:i.x+He.nodeSpacing}});return{...t,nodes:[...t.nodes,...o],selectedNodes:o}}),{})),Tg=(s,e,t)=>{const{nodeIds:a,targetProjectId:n,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const u=l.coreState.nodes.filter(f=>a.includes(f.id));if(u.length===0)return;const p=new Date().toISOString(),h=u.map(f=>({...f,id:Ps(f.id),createdAt:p,updatedAt:p,isSelected:!1,isEditing:!1}));s(Ce(f=>{var v,m,w,y,g,x;const b=(x=(g=(y=(w=(m=(v=f.state)==null?void 0:v.projects)==null?void 0:m[n])==null?void 0:w.workspaces)==null?void 0:y[o])==null?void 0:g.canvases)==null?void 0:x[i];b!=null&&b.coreState&&(b.coreState.nodes.push(...h),b.lastModified=Date.now())}))},Ag=(s,e,t)=>{const{nodeIds:a,targetProjectId:n,targetWorkspaceId:o,targetCanvasId:i}=t,l=e().projectCanvas.getActive();if(!l)return;const u=l.coreState.nodes.filter(f=>a.includes(f.id));if(u.length===0)return;const p=new Set(a),h=new Date().toISOString();s(Ce(f=>{var j,C,N,S,D,W,E,I,_,U,k;const b=(j=f.state)==null?void 0:j.activeProjectId;if(!b)return;const v=(N=(C=f.state)==null?void 0:C.projects)==null?void 0:N[b];if(!v)return;const m=v.activeWorkspaceId;if(!m)return;const w=(S=v.workspaces)==null?void 0:S[m];if(!w)return;const y=w.activeCanvasId;if(!y)return;const g=(D=w.canvases)==null?void 0:D[y];g!=null&&g.coreState&&(g.coreState.nodes=g.coreState.nodes.filter(M=>!p.has(M.id)),g.coreState.selectedNodes=[],g.coreState.arrows=g.coreState.arrows.filter(M=>!(M.startNodeId&&p.has(M.startNodeId)||M.endNodeId&&p.has(M.endNodeId))),g.lastModified=Date.now());const x=(k=(U=(_=(I=(E=(W=f.state)==null?void 0:W.projects)==null?void 0:E[n])==null?void 0:I.workspaces)==null?void 0:_[o])==null?void 0:U.canvases)==null?void 0:k[i];if(x!=null&&x.coreState){const M=u.map(O=>({...O,updatedAt:h,isSelected:!1,isEditing:!1}));x.coreState.nodes.push(...M),x.lastModified=Date.now()}}))},lr="markop-canvas-v2-storage",gn=new cg("CanvasStateV2",Qm.CanvasStateV2),Ig=()=>{try{const s=localStorage.getItem(lr);if(s){const e=JSON.parse(s);return e.dataVersion!==kt.dataVersion?(localStorage.removeItem(lr),null):{version:e.version,dataVersion:e.dataVersion,state:e.state,uiState:e.uiState,flags:e.flags,preferences:e.preferences}}}catch(s){console.error("[PERSISTENCE] Failed to load from localStorage:",s)}return null},Ot=Ig();var vn,wn;const ua=Ot===null?kt:{...kt,...Ot,uiState:{...kt.uiState,...Ot.uiState||{},temporaryArrow:null,selectionBox:null,dragInfo:null,resizingNode:null},state:{projects:((vn=Ot.state)==null?void 0:vn.projects)||((wn=kt.state)==null?void 0:wn.projects)||{},...kt.state,...Ot.state||{}},flags:{...kt.flags,...Ot.flags||{}},preferences:{...kt.preferences,...Ot.preferences||{}}},Rg="workflow-templates-project";var yn;(yn=ua.state)!=null&&yn.projects&&(ua.state.projects[Rg]=Yo());const Pg=()=>{var e;const s=(e=ua.preferences)==null?void 0:e.canvasConfig;s&&(s.arrows&&(s.arrows.type&&(Oe.arrows.type=s.arrows.type),s.arrows.REVERSE_CURVE!==void 0&&(Oe.arrows.REVERSE_CURVE=s.arrows.REVERSE_CURVE),s.arrows.CUBIC_ARROW_S_SHAPE_FACTOR!==void 0&&(Oe.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=s.arrows.CUBIC_ARROW_S_SHAPE_FACTOR),s.arrows.CUBIC_ARROW_S_SHAPE_REVERSED!==void 0&&(Oe.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=s.arrows.CUBIC_ARROW_S_SHAPE_REVERSED),s.arrows.CUBIC_HORIZONTAL_BIAS!==void 0&&(Oe.arrows.CUBIC_HORIZONTAL_BIAS=s.arrows.CUBIC_HORIZONTAL_BIAS),s.arrows.reverseArrowOnMultipleConnect!==void 0&&(Oe.arrows.reverseArrowOnMultipleConnect=s.arrows.reverseArrowOnMultipleConnect)),s.persistState!==void 0&&(Oe.persistState=s.persistState),s.autosave!==void 0&&(Oe.autosave=s.autosave),s.hideOverlay!==void 0&&(Oe.hideOverlay=s.hideOverlay),s.hideToolbar!==void 0&&(Oe.hideToolbar=s.hideToolbar),s.nodeOptions&&(s.nodeOptions.maxNodeWidth!==void 0&&(Oe.nodeOptions.maxNodeWidth=s.nodeOptions.maxNodeWidth),s.nodeOptions.resizeBorderWidth!==void 0&&(Oe.nodeOptions.resizeBorderWidth=s.nodeOptions.resizeBorderWidth)),s.zoom&&(s.zoom.min!==void 0&&(Oe.zoom.min=s.zoom.min),s.zoom.max!==void 0&&(Oe.zoom.max=s.zoom.max),s.zoom.intensity!==void 0&&(Oe.zoom.intensity=s.zoom.intensity)))};Pg();const _g=(s,e)=>({...ua,setMode:t=>Yf(s,t),setZoomSubMode:t=>Zf(s,t),toggleZoomSubMode:()=>em(s),setWriteSubMode:t=>tm(s,t),toggleWriteSubMode:()=>sm(s),setActiveCanvasViewState:t=>{s(a=>{if(!a.state)return a;const n=a.state.activeProjectId?a.state.projects[a.state.activeProjectId]:null,o=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;if(!i)return a;const c=t(i.viewState);if(c===i.viewState)return a;const l=Date.now();return{...a,state:{...a.state,projects:{...a.state.projects,[a.state.activeProjectId]:{...n,lastModified:l,workspaces:{...n.workspaces,[n.activeWorkspaceId]:{...o,lastModified:l,canvases:{...o.canvases,[o.activeCanvasId]:{...i,viewState:c,lastModified:l}}}}}}}}})},setIsPanning:t=>rm(s,t),setSelectionBox:t=>nm(s,t),setPendingSelectionStart:t=>om(s,t),setWriteModeStartPosition:t=>im(s,t),setDragInfo:t=>cm(s,t),setResizingNode:t=>lm(s,t),setNodeToFocusId:t=>dm(s,t),getNodeById:t=>um(e,t),setAddNodeType:t=>pm(s,t),setCanvasDimensions:(t,a)=>hm(s,t,a),toggleOverlayVisibility:()=>Am(s),toggleCurvedArrows:()=>Im(s),setNodeUpdateSettings:t=>Rm(s,t),setZoomMarks:t=>Pm(s,t),addZoomMark:t=>_m(s,t),removeZoomMark:t=>Dm(s,t),setUiState:t=>fm(s,t),setActiveCanvasCoreState:t=>s(Ce(a=>{if(!a.state)return;const n=a.state.activeProjectId?a.state.projects[a.state.activeProjectId]:null,o=n&&n.activeWorkspaceId?n.workspaces[n.activeWorkspaceId]:null,i=o&&o.activeCanvasId?o.canvases[o.activeCanvasId]:null;i&&(i.coreState=t(i.coreState),i.lastModified=Date.now(),o&&(o.lastModified=Date.now()),n&&(n.lastModified=Date.now()))})),setNodes:t=>mm(s,t),setSelectedNodes:t=>gm(s,t),unselectNodeById:t=>xm(s,t),addNode:(t,a,n)=>bm(s,t,a,n),copyNodes:()=>kg(s),setState:t=>vm(s,t),updateNode:(t,a)=>as(s)(t,a),updateNodes:t=>pg(s)(t),updateNodeContent:(t,a)=>wm(s)(t,a),updateNodeSubContent:(t,a)=>ym(s)(t,a),updateNodeTitle:(t,a)=>Sm(s)(t,a),updateNodeGeometry:(t,a)=>Cm(s)(t,a),updateNodeStyles:(t,a)=>ig(s)(t,a),getEditingNode:()=>jm(e),project:Hm(s,e),workspace:Jm(s,e),projectCanvas:og(s,e),arrow:Hf(s,e),getCanvasMouseCoords:()=>kf(e),deleteSelectedNodes:()=>jf(s),deleteSelectedArrows:()=>Nf(s),deleteNodeById:t=>Nm(s,t),deleteAll:()=>Em(s),setFlags:t=>km(s,t),getSegmentedButtonAction:t=>{var n,o;return((o=(n=e().preferences)==null?void 0:n.segmentedButtons)==null?void 0:o[t])??null},setSegmentedButtonAction:(t,a)=>{s(Ce(n=>{n.preferences||(n.preferences={segmentedButtons:{}}),n.preferences.segmentedButtons||(n.preferences.segmentedButtons={}),n.preferences.segmentedButtons[t]=a}))},getKeepArrowsOnSplit:()=>{var a;return((a=e().preferences)==null?void 0:a.keepArrowsOnSplit)??!0},setKeepArrowsOnSplit:t=>{s(Ce(a=>{a.preferences||(a.preferences={}),a.preferences.keepArrowsOnSplit=t}))},getKeepSplitMatch:()=>{var a;return((a=e().preferences)==null?void 0:a.keepSplitMatch)??!1},setKeepSplitMatch:t=>{s(Ce(a=>{a.preferences||(a.preferences={}),a.preferences.keepSplitMatch=t}))},getLastUsedBorder:()=>{var t,a,n,o,i,c;return{lastUsedColor:((a=(t=e().preferences)==null?void 0:t.borderButton)==null?void 0:a.lastUsedColor)??"hsl(var(--primary))",lastUsedWidth:((o=(n=e().preferences)==null?void 0:n.borderButton)==null?void 0:o.lastUsedWidth)??"1px",lastUsedStyle:((c=(i=e().preferences)==null?void 0:i.borderButton)==null?void 0:c.lastUsedStyle)??"solid"}},setLastUsedBorder:(t,a,n)=>{s(Ce(o=>{o.preferences||(o.preferences={}),o.preferences.borderButton||(o.preferences.borderButton={}),o.preferences.borderButton.lastUsedColor=t,o.preferences.borderButton.lastUsedWidth=a,o.preferences.borderButton.lastUsedStyle=n}))},getLastUsedArrowStyle:()=>{var t,a,n,o,i,c;return{lastUsedColor:((a=(t=e().preferences)==null?void 0:t.arrowStyleButton)==null?void 0:a.lastUsedColor)??"hsl(var(--muted-light))",lastUsedWidth:((o=(n=e().preferences)==null?void 0:n.arrowStyleButton)==null?void 0:o.lastUsedWidth)??1,lastUsedStyle:((c=(i=e().preferences)==null?void 0:i.arrowStyleButton)==null?void 0:c.lastUsedStyle)??"solid"}},setLastUsedArrowStyle:(t,a,n)=>{s(Ce(o=>{o.preferences||(o.preferences={}),o.preferences.arrowStyleButton||(o.preferences.arrowStyleButton={}),o.preferences.arrowStyleButton.lastUsedColor=t,o.preferences.arrowStyleButton.lastUsedWidth=a,o.preferences.arrowStyleButton.lastUsedStyle=n}))},getLastArrangeOption:()=>{var t,a;return((a=(t=e().preferences)==null?void 0:t.arrangeButton)==null?void 0:a.lastArrangeOption)??null},setLastArrangeOption:t=>{s(Ce(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.lastArrangeOption=t}))},getSortByLastArrange:()=>{var t,a;return((a=(t=e().preferences)==null?void 0:t.arrangeButton)==null?void 0:a.sortByLastArrange)??!1},setSortByLastArrange:t=>{s(Ce(a=>{a.preferences||(a.preferences={}),a.preferences.arrangeButton||(a.preferences.arrangeButton={}),a.preferences.arrangeButton.sortByLastArrange=t}))},getGoToSymbolSearch:()=>{var t;return((t=e().preferences)==null?void 0:t.goToSymbolSearch)??null},setGoToSymbolSearchOptions:t=>{s(Ce(a=>{a.preferences||(a.preferences={}),a.preferences.goToSymbolSearch?a.preferences.goToSymbolSearch.options=t:a.preferences.goToSymbolSearch={options:t,searchHistory:[]}}))},addGoToSymbolSearchHistory:t=>{t.trim()&&s(Ce(a=>{a.preferences||(a.preferences={}),a.preferences.goToSymbolSearch||(a.preferences.goToSymbolSearch={options:{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"},searchHistory:[]});const n=a.preferences.goToSymbolSearch.searchHistory.filter(o=>o!==t);n.unshift(t),a.preferences.goToSymbolSearch.searchHistory=n.slice(0,20)}))},resetState:()=>Tm(s),scrollToNode:(t,a=500,n)=>Cf(s,e,t,a,n),scrollToArrow:(t,a=500)=>ug(s,e,t,a),addTagToNode:(t,a)=>{const n=e().getNodeById(t);if(!n)return;const o=typeof a=="string"?{id:Math.random().toString(36).slice(2,10),title:a}:a,i=Array.isArray(n.tags)?n.tags:[];i.some(l=>l.title===o.title)||e().updateNode(t,{tags:[...i,o]})},removeTagFromNode:(t,a)=>{const n=e().getNodeById(t);!n||!Array.isArray(n.tags)||e().updateNode(t,{tags:n.tags.filter(o=>o.id!==a)})},getNodesByTag:t=>{const a=e().projectCanvas.getActive();return a?(a.coreState.nodes||[]).filter(o=>Array.isArray(o.tags)&&o.tags.some(i=>i.title===t)):[]},hasTag:(t,a)=>{const n=e().getNodeById(t);return!n||!Array.isArray(n.tags)?!1:n.tags.some(o=>o.title===a)},exportCanvasData:()=>Om(e),exportSingleCanvas:t=>Mm(e)(t),exportSingleWorkspace:t=>Lm(e)(t),exportSingleProject:t=>$m(e)(t),importCanvasData:(t,a)=>Um(s,t,a),saveStateToLocalStorage:()=>{try{const t={version:e().version,dataVersion:e().dataVersion,state:e().state,uiState:e().uiState,flags:e().flags,preferences:e().preferences},{temporaryArrow:a,selectionBox:n,dragInfo:o,resizingNode:i,...c}=t.uiState,l={...t,uiState:c};localStorage.setItem(lr,JSON.stringify(l)),gn.log("Canvas state saved to localStorage.")}catch(t){gn.error("Failed to save state to localStorage",t),Ze.error("Save failed",{description:t instanceof Error?t.message:"Failed to save canvas",duration:3e3})}},copyNodesToCanvas:t=>Tg(s,e,t),moveNodesToCanvas:t=>Ag(s,e,t)}),Dg=_g,Ut=Xo()(Dg);let Wa=null;const Og=1e3;Oe.autosave&&Oe.persistState&&Ut.subscribe(s=>{Wa&&clearTimeout(Wa),Wa=setTimeout(()=>{s.saveStateToLocalStorage()},Og)});const Mg={mousePosition:null},Lg=(s,e)=>({...Mg,setMousePosition:t=>am(s,t)}),$g=Xo()(Lg);class Ug{constructor(){J(this,"activeTranscriptions",new Map);J(this,"listeners",new Set)}register(e,t){this.activeTranscriptions.set(e,{nodeId:e,sessionName:t,startedAt:Date.now(),status:"recording"}),this.notify()}updateStatus(e,t){const a=this.activeTranscriptions.get(e);a&&(a.status=t,this.notify())}complete(e,t){const a=Ut.getState(),n=a.getNodeById(e);if(n){const o=n.content||"",i=o+(o?`
`:"")+t;a.updateNodeContent(e,i);const c=rc(),{width:l,height:u}=Jf(i,c);a.updateNode(e,{width:l,height:u,options:{...n.options,lockSize:!1}})}this.activeTranscriptions.delete(e),this.notify()}fail(e){this.activeTranscriptions.delete(e),this.notify()}has(e){return this.activeTranscriptions.has(e)}getStatus(e){var t;return((t=this.activeTranscriptions.get(e))==null?void 0:t.status)??null}getAll(){return Array.from(this.activeTranscriptions.values())}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e())}}const Ls=new Ug;function uc({onTranscriptionComplete:s,className:e="",sessionName:t="audio-button-default",getTextAreaElement:a,variant:n="default",autoStartRecording:o=!1,"data-test":i,style:c,nodeId:l}){const[u,p]=d.useState(!1),[h,f]=d.useState(0),[b,v]=d.useState(0),[m,w]=d.useState(!1);d.useEffect(()=>{if(o&&!u){const A=setTimeout(()=>{f(P=>P+1)},100);return()=>clearTimeout(A)}},[o]);const y=d.useCallback(A=>"value"in A?A.value:A.textContent||"",[]),g=d.useCallback((A,P)=>{var $;if("value"in A){const T=($=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:$.set;T?T.call(A,P):A.value=P}else A.textContent=P;const z=new Event("input",{bubbles:!0});A.dispatchEvent(z)},[]),[x,j]=d.useState([]),[C,N]=d.useState(0),[S,D]=d.useState(!1),W=d.useCallback(A=>{j(P=>[...P,A]),(A.transcriptionStatus==="pending"||A.transcriptionStatus==="processing")&&w(!0)},[]),E=d.useCallback(A=>{j(P=>P.map(z=>z.id===A.id?A:z)),A.transcription?(N(P=>P+1),l?Ls.complete(l,A.transcription):s==null||s(A.transcription),w(!1)):A.transcriptionStatus==="failed"&&(l&&Ls.fail(l),w(!1))},[s,l]),I=d.useCallback(A=>{p(A),l&&(A?Ls.register(l,t):Ls.updateStatus(l,"transcribing"))},[l,t]),_=d.useCallback(A=>{A&&(A.preventDefault(),A.stopPropagation()),u?v(P=>P+1):f(P=>P+1)},[u]),U=d.useCallback(A=>{if(A.preventDefault(),A.stopPropagation(),C>0&&a){const P=a();if(!P)return;const z=x[C-1];if(!(z!=null&&z.transcription))return;const $=y(P),T=z.transcription;let L=$;$.endsWith(T)?L=$.slice(0,-T.length):$.endsWith(" "+T)&&(L=$.slice(0,-(T.length+1))),L=L.trimEnd(),g(P,L),N(V=>V-1)}},[C,x,a,y,g]),k=d.useCallback(A=>{if(A.preventDefault(),A.stopPropagation(),C<x.length&&a){const P=a();if(!P)return;const z=x[C];if(!(z!=null&&z.transcription))return;const $=y(P),T=$.trim()?" ":"",L=$+T+z.transcription;g(P,L),N(V=>V+1)}},[C,x,a,y,g]),M=d.useCallback(A=>{const P=x.findIndex(z=>z.id===A);if(P!==-1){if(P<C&&a){const z=a();if(z){const T=x.filter((L,V)=>V<C&&V!==P).map(L=>L.transcription).filter(Boolean).join(" ");g(z,T),N(L=>L-1)}}j(z=>z.filter($=>$.id!==A))}},[x,C,a,g]),O=d.useCallback(()=>{if(a){const A=a();A&&g(A,"")}j([]),N(0)},[a,g]);return d.useEffect(()=>{const A=P=>{if(P.ctrlKey&&P.shiftKey&&P.key==="A")if(a){const z=a();z&&document.activeElement===z&&(P.preventDefault(),P.stopPropagation(),P.stopImmediatePropagation(),_())}else P.preventDefault(),P.stopPropagation(),P.stopImmediatePropagation(),_()};return window.addEventListener("keydown",A,!0),()=>{window.removeEventListener("keydown",A,!0)}},[_,a]),r.jsxs("div",{className:`audio-button-wrapper flex items-center gap-1 ${e}`,"data-test":i||"audio-button-wrapper",style:c,children:[m&&r.jsx("div",{className:"transcription-spinner","data-test":i?`${i}-transcription-spinner`:"audio-button-transcription-spinner",children:r.jsx(va,{className:"w-4 h-4 animate-spin text-muted-foreground","data-test":i?`${i}-transcription-spinner-icon`:"audio-button-transcription-spinner-icon"})}),x.length>0&&r.jsxs("div",{className:"chunk-navigation flex items-center gap-0.5","data-test":i?`${i}-chunk-navigation`:"audio-button-chunk-navigation",children:[r.jsx("button",{onMouseDown:A=>A.preventDefault(),onClick:U,disabled:C===0,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Remove previous chunk",type:"button","data-test":i?`${i}-previous-chunk-button`:"audio-button-previous-chunk-button",children:r.jsx(js,{className:Ue.sm,"data-test":i?`${i}-previous-chunk-icon`:"audio-button-previous-chunk-icon"})}),r.jsxs(Ge,{open:S,onOpenChange:D,"data-test":i?`${i}-chunk-panel-popover`:"audio-button-chunk-panel-popover",children:[r.jsx(Xe,{asChild:!0,children:r.jsxs("button",{onMouseDown:A=>A.preventDefault(),className:"chunk-counter text-xs text-muted-foreground px-1 hover:bg-accent rounded cursor-pointer",title:"View all chunks",type:"button","data-test":i?`${i}-chunk-counter-button`:"audio-button-chunk-counter-button",children:[C,"/",x.length]})}),r.jsx(We,{className:"w-96 p-3",side:"top",align:"center","data-test":i?`${i}-chunk-panel-content`:"audio-button-chunk-panel-content",children:r.jsxs("div",{className:"chunk-panel-popover","data-test":i?`${i}-chunk-panel-wrapper`:"audio-button-chunk-panel-wrapper",children:[r.jsx("h3",{className:"text-sm font-semibold mb-2","data-test":i?`${i}-chunk-panel-title`:"audio-button-chunk-panel-title",children:"Recorded Chunks"}),r.jsx(Qo,{chunks:x,onChunkDelete:M,onChunkTranscribe:()=>{},onClearAll:O})]})})]}),r.jsx("button",{onMouseDown:A=>A.preventDefault(),onClick:k,disabled:C>=x.length,className:"nav-button p-1 rounded hover:bg-accent disabled:opacity-30 disabled:cursor-not-allowed",title:"Add next chunk",type:"button","data-test":i?`${i}-next-chunk-button`:"audio-button-next-chunk-button",children:r.jsx(Ht,{className:Ue.sm,"data-test":i?`${i}-next-chunk-icon`:"audio-button-next-chunk-icon"})})]}),r.jsx("button",{onMouseDown:A=>A.preventDefault(),onClick:_,className:n==="muted"?`voice-input-button p-1 rounded-md transition-colors ${u?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"text-muted-foreground/40 hover:text-foreground hover:bg-accent"}`:`voice-input-button p-1.5 rounded-md transition-colors ${u?"bg-destructive text-destructive-foreground hover:bg-destructive/90":"hover:bg-accent"}`,title:u?"Stop recording (Ctrl+Shift+A)":"Start voice input (Ctrl+Shift+A)",type:"button","data-test":i?`${i}-voice-input-button`:"audio-button-voice-input-button",children:r.jsx(yr,{className:`voice-input-icon ${n==="muted"?Ue.xs:Ue.sm} ${u?"animate-pulse":""}`,"data-test":i?`${i}-voice-input-icon`:"audio-button-voice-input-icon"})}),r.jsx("div",{className:"audio-panel-wrapper hidden","data-test":i?`${i}-audio-panel-wrapper`:"audio-button-audio-panel-wrapper",children:r.jsx(fp,{sessionName:t,enableAutoPersist:!1,loadPersistedChunks:!1,autoStart:!1,startTrigger:h,stopTrigger:b,onChunkCreated:W,onChunkUpdated:E,onRecordingStateChange:I})})]})}const pc=d.forwardRef(({className:s,onSelectionChange:e,showBuiltInPopover:t=!0,showAudioButton:a=!1,audioButtonVariant:n="default",onAudioTranscription:o,getTextAreaElement:i,"data-test":c,...l},u)=>{const[p,h]=d.useState(""),[f,b]=d.useState(!1),[v,m]=d.useState({top:0,left:0}),w=d.useRef(null),y=d.useRef(null),g=d.useCallback(()=>{const S=w.current;if(!S)return;const D=S.selectionStart,W=S.selectionEnd,E=S.value.substring(D,W).trim();if(E.length>0){h(E),b(t);const I=S.scrollTop,_=window.getComputedStyle(S),U=S.getBoundingClientRect(),k=parseInt(_.paddingLeft)||12,M=parseInt(_.paddingTop)||8,O=S.value.substring(0,D).split(`
`),A=parseInt(_.lineHeight)||20,P=O.length-1,z=O[P],T=document.createElement("canvas").getContext("2d");if(!T)return;T.font=`${_.fontWeight} ${_.fontSize} ${_.fontFamily}`;const L=parseInt(_.paddingRight)||12,V=U.width-k-L;let K=0,q=0,Q=0;for(;Q<z.length;){let Y=Q+1;for(;Y<=z.length;){const ve=z.substring(Q,Y);if(T.measureText(ve).width>V){let H=Y-1;for(let ae=Y-1;ae>Q;ae--)if(z[ae]===" "){H=ae;break}H===Q&&Y-Q>1&&(H=Y-1),Y=H;break}Y++}K=Q;const oe=Math.min(Y,z.length);if(oe>=z.length){const ve=z.substring(K),X=T.measureText(ve).width,H=(P+q)*A-I+A+M,ae=X+k,he={top:H,left:ae};m(he),e==null||e(E,he);return}q++,Q=oe,z[Q]===" "&&Q++}}else b(!1),h(""),e==null||e("",void 0)},[e,t]),x=d.useCallback(()=>{g()},[g]),j=d.useCallback(S=>{var D;S.shiftKey&&g(),(D=l.onKeyUp)==null||D.call(l,S)},[g,l]),C=d.useCallback(S=>{var D;setTimeout(()=>b(!1),200),(D=l.onBlur)==null||D.call(l,S)},[l]),N=d.useCallback(()=>{if(!p||p.length===0)return"";const S=p[0];return S>="A"&&S<="Z"?"text-red-600":S>="a"&&S<="z"?"text-blue-600":""},[p]);return d.useImperativeHandle(u,()=>({insertTextAtStart:S=>{const D=w.current;if(!D)return;D.focus();const W=D.selectionStart,E=D.selectionEnd;if(D.setSelectionRange(0,0),!document.execCommand("insertText",!1,S)){const k=S+D.value;D.value=k,D.dispatchEvent(new Event("input",{bubbles:!0}))}const _=W+S.length,U=E+S.length;D.setSelectionRange(_,U)},getTextArea:()=>w.current,getSelectionPosition:()=>v}),[v]),r.jsxs("div",{className:"textarea-container relative w-full h-full","data-test":c?`${c}-container`:"selectable-textarea-container",children:[r.jsxs(Ge,{open:f,"data-test":c?`${c}-popover`:"selectable-textarea-popover",children:[r.jsx(Uo,{className:R("flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:w,onMouseUp:x,onKeyUp:j,onBlur:C,"data-node-textarea":"true","data-test":c?`${c}-rich-textarea`:"selectable-textarea-rich-textarea",...l}),r.jsx(Io,{ref:y,style:{position:"absolute",top:`${v.top}px`,left:`${v.left}px`,width:"1px",height:"1px"},"data-test":c?`${c}-popover-anchor`:"selectable-textarea-popover-anchor"}),r.jsx(We,{side:"bottom",align:"start",className:"selection-popover w-auto max-w-md",onOpenAutoFocus:S=>S.preventDefault(),"data-test":c?`${c}-popover-content`:"selectable-textarea-popover-content",children:r.jsxs("div",{className:"popover-content flex flex-col gap-2","data-test":c?`${c}-popover-content-wrapper`:"selectable-textarea-popover-content-wrapper",children:[r.jsx("div",{className:"popover-label text-xs text-muted-foreground font-medium","data-test":c?`${c}-popover-label`:"selectable-textarea-popover-label",children:"Selected Text:"}),r.jsx("div",{className:R("popover-text text-sm font-mono bg-muted px-2 py-1 rounded font-semibold",N()),"data-test":c?`${c}-popover-text`:"selectable-textarea-popover-text",children:p})]})})]}),a&&r.jsx(uc,{onTranscriptionComplete:S=>{o==null||o(S)},sessionName:"selectable-textarea",className:"absolute right-2 bottom-1",style:{zIndex:xt.nodeAudioButton},getTextAreaElement:i||(()=>w.current),variant:n,"data-test":c?`${c}-audio-button`:"selectable-textarea-audio-button"})]})});pc.displayName="SelectableTextArea";class Fg{constructor(){J(this,"directoryMapCache",new Map);J(this,"loadPromiseCache",new Map)}async loadDirectoryMap(e){var c;const t=e??"default",n=(c=Z.getState().ui)==null?void 0:c.directoryMaps;if(n!=null&&n[t])return this.directoryMapCache.set(t,n[t]),n[t];if(this.directoryMapCache.has(t))return this.directoryMapCache.get(t);if(this.loadPromiseCache.has(t))return this.loadPromiseCache.get(t);const o=e?`/directory-map?cwd=${encodeURIComponent(e)}`:"/directoryMap.json",i=fetch("http://localhost:3333"+o).then(l=>{if(!l.ok)throw new Error(`Failed to load directory map: ${l.statusText}`);return l.json()}).then(l=>{const u=l.success?l.data:l;return this.directoryMapCache.set(t,u),this.loadPromiseCache.delete(t),this.saveToGlobalStore(t,u),u}).catch(l=>{throw this.loadPromiseCache.delete(t),l});return this.loadPromiseCache.set(t,i),i}saveToGlobalStore(e,t){var o;const a=Z.getState(),n=((o=a.ui)==null?void 0:o.directoryMaps)??{};Z.updateState({ui:{...a.ui,directoryMaps:{...n,[e]:t}}})}async getFilePath(e,t){const a=await this.loadDirectoryMap(t);if(a[e])return a[e];const n=e.toLowerCase();for(const[o,i]of Object.entries(a))if(o.toLowerCase()===n)return i}async getAllFilenames(e){const t=await this.loadDirectoryMap(e);return Object.keys(t)}async searchFiles(e,t){const a=await this.loadDirectoryMap(t),n=e.toLowerCase();return Object.entries(a).filter(([o])=>o.toLowerCase().includes(n)).map(([o,i])=>({filename:o,path:i}))}clearCache(e){var t;if(e){const a=e;this.directoryMapCache.delete(a),this.loadPromiseCache.delete(a);const n=Z.getState(),i={...((t=n.ui)==null?void 0:t.directoryMaps)??{}};delete i[a],Z.updateState({ui:{...n.ui,directoryMaps:i}})}else{this.directoryMapCache.clear(),this.loadPromiseCache.clear();const a=Z.getState();Z.updateState({ui:{...a.ui,directoryMaps:{}}})}}}const dr=new Fg;function $s(s,e){const t=s.toLowerCase(),a=e.toLowerCase();if(t==="")return{score:0,matches:[]};let n=0,o=0;const i=[];let c=0,l=0;for(;n<t.length&&o<a.length;)t[n]===a[o]?(i.push(o),l++,c+=1+l,(o===0||/[\s\-_\/\\.]/.test(e[o-1]))&&(c+=10),n++):l=0,o++;if(n!==t.length)return null;if(i.length>0){const u=i[i.length-1]-i[0]-i.length+1;c-=u}return c+=100/(e.length+1),{score:c,matches:i}}function Wg(s,e){if(e.length===0)return[{text:s,isMatch:!1}];const t=[];let a=0;for(const n of e)n>a&&t.push({text:s.substring(a,n),isMatch:!1}),t.push({text:s[n],isMatch:!0}),a=n+1;return a<s.length&&t.push({text:s.substring(a),isMatch:!1}),t}const pa=d.forwardRef(({className:s,children:e,...t},a)=>r.jsxs(qn,{ref:a,className:R("relative overflow-hidden",s),...t,children:[r.jsx(pl,{className:"h-full w-full rounded-[inherit]",children:e}),r.jsx(hc,{}),r.jsx(hl,{})]}));pa.displayName=qn.displayName;const hc=d.forwardRef(({className:s,orientation:e="vertical",...t},a)=>r.jsx(Kn,{ref:a,orientation:e,className:R("flex touch-none select-none transition-colors",e==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",e==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...t,children:r.jsx(fl,{className:"relative flex-1 rounded-full bg-border"})}));hc.displayName=Kn.displayName;function zg({items:s,selectedIndex:e,renderItem:t,onItemClick:a,onItemHover:n,className:o,height:i="h-[400px]",emptyMessage:c="No items found",isLoading:l=!1,loadingMessage:u="Loading...",getItemKey:p}){const h=d.useRef(null);return d.useEffect(()=>{h.current&&h.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[e]),r.jsx(pa,{className:R("scrollable-list rounded-md border",i,o),"data-test":"scrollable-list-container",children:l?r.jsx("div",{className:"loading-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-loading-state",children:r.jsx("span",{"data-test":"scrollable-list-loading-message",children:u})}):s.length===0?r.jsx("div",{className:"empty-state flex items-center justify-center h-full text-muted-foreground","data-test":"scrollable-list-empty-state",children:r.jsx("span",{"data-test":"scrollable-list-empty-message",children:c})}):r.jsx("div",{className:"list-items","data-test":"scrollable-list-items",children:s.map((f,b)=>{const v=b===e,m=p?p(f,b):b;return t(f,b,v,m,v?h:void 0,()=>a==null?void 0:a(f,b),()=>n==null?void 0:n(b))})})})}function Bg({onFileSelect:s,className:e,maxResults:t=10,placeholder:a="Search files...",mode:n="normal",searchMode:o="filename",cwd:i,"data-test":c}){const[l,u]=d.useState([]),[p,h]=d.useState([]),[f,b]=d.useState(t),[v,m]=d.useState(""),[w,y]=d.useState(!0),[g,x]=d.useState(0),[j,C]=d.useState(o);d.useEffect(()=>{(async()=>{try{y(!0);const A=await dr.getAllFilenames(i),P=[];for(const z of A){const $=await dr.getFilePath(z,i);$&&P.push({filename:z,path:$})}u(P),h(P),b(t)}catch(A){console.error("Failed to load files:",A)}finally{y(!1)}})()},[t,i]),d.useEffect(()=>{v.startsWith("/")?j!=="fullPath"&&C("fullPath"):j!=="filename"&&C("filename");const O=v.startsWith("/")?v.slice(1):v;if(!O.trim()){h(l),b(t),x(0);return}let A=l;if(j==="fullPath"){const $=new Set,T=[];for(const L of l){T.push(L),$.add(L.path);const V=L.path.split("/").filter(Boolean);for(let K=1;K<V.length;K++){const q=V.slice(0,K).join("/")+"/";$.has(q)||($.add(q),T.push({filename:V[K-1],path:q,isDirectory:!0}))}}A=T}const P=[];for(const $ of A)if(j==="fullPath"){const T=$s(O,$.path);T&&P.push({file:$,score:T.score,matches:T.matches})}else{const T=$s(O,$.filename),L=$s(O,$.path),V=T&&L?T.score>L.score?T:L:T??L;V&&P.push({file:$,score:V.score,matches:V.matches})}P.sort(($,T)=>T.score-$.score);const z=P.map($=>$.file);h(z),b(t),x(0)},[v,l,t,j]);const N=d.useCallback(O=>{s==null||s(O)},[s]),S=d.useCallback(O=>{switch(p.slice(0,f),O.key){case"Tab":if(O.preventDefault(),p[g]&&v.startsWith("/")){const A=p[g].path,P=v.slice(1),z=A.indexOf("/",P.length);if(z!==-1){const $=A.substring(0,z+1);m("/"+$)}else m("/"+A)}break;case"ArrowDown":O.preventDefault(),x(A=>{const P=Math.min(A+1,p.length-1);return P>=f-2&&f<p.length&&b(z=>Math.min(z+t,p.length)),P});break;case"ArrowUp":O.preventDefault(),x(A=>Math.max(A-1,0));break;case"Enter":O.preventDefault(),p[g]&&N(p[g]);break;case"Escape":O.preventDefault(),m("");break}},[p,f,g,N,t,v]),D=(O,A)=>{if(!A.trim())return r.jsx("span",{children:O});const P=$s(A,O);if(!P)return r.jsx("span",{children:O});const z=Wg(O,P.matches);return r.jsx("span",{children:z.map(($,T)=>r.jsx("span",{className:$.isMatch?"bg-yellow-200 dark:bg-yellow-900 font-semibold":"",children:$.text},T))})},W=O=>{var z;const A=(z=O.split(".").pop())==null?void 0:z.toLowerCase(),P="w-4 h-4 flex-shrink-0";return["tsx","ts","jsx","js"].includes(A??"")?r.jsx(ns,{className:R(P,"text-blue-500")}):["json","yml","yaml"].includes(A??"")?r.jsx(ns,{className:R(P,"text-yellow-500")}):["md","txt"].includes(A??"")?r.jsx(ns,{className:R(P,"text-gray-500")}):["css","scss"].includes(A??"")?r.jsx(ns,{className:R(P,"text-purple-500")}):r.jsx(ns,{className:R(P,"text-muted-foreground")})},E=O=>O.split("/").slice(0,-1).join("/")||"/",I=n==="compact"||n==="fileNameOnly",_=n==="fileNameOnly",U=v.startsWith("/")?v.slice(1):v,k=p.slice(0,f),M=(O,A,P,z,$,T,L)=>r.jsxs("button",{ref:$,onClick:T,onMouseEnter:L,className:R("file-item w-full flex items-start hover:bg-accent text-left transition-colors border-b border-border last:border-b-0",I?"px-2 py-1 gap-2":"px-3 py-2 gap-3",P&&"bg-accent"),children:[!_&&(O.isDirectory?r.jsx(Br,{className:R("w-4 h-4 flex-shrink-0","text-blue-400")}):W(O.filename)),r.jsx("div",{className:"file-info flex-1 min-w-0",children:j==="fullPath"?r.jsx(r.Fragment,{children:r.jsx("div",{className:R("filename font-medium truncate",I?"text-xs":"text-sm"),children:D(O.path,U)})}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:R("filename font-medium truncate",I?"text-xs":"text-sm"),children:D(O.filename,U)}),!_&&r.jsxs("div",{className:R("file-path text-muted-foreground truncate flex items-center gap-1",I?"text-[10px]":"text-xs"),children:[r.jsx(Br,{className:R("flex-shrink-0",I?"w-2.5 h-2.5":"w-3 h-3")}),D(E(O.path),U)]})]})})]},z);return r.jsxs("div",{className:R("file-picker flex flex-col",I?"gap-1.5":"gap-3",e),"data-test":c||"file-picker-container",children:[r.jsxs("div",{className:"search-input-wrapper relative","data-test":c?`${c}-search-wrapper`:"file-picker-search-wrapper",children:[r.jsx(ba,{className:R("absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none",I?"w-3 h-3":"w-4 h-4"),"data-test":c?`${c}-search-icon`:"file-picker-search-icon"}),r.jsx(Je,{type:"text",value:v,onChange:O=>m(O.target.value),onKeyDown:S,placeholder:a,className:R("search-input pl-9",I&&"h-8 text-xs"),autoFocus:!0,"data-test":c?`${c}-search-input`:"file-picker-search-input"})]}),!_&&r.jsx("div",{className:R("results-info text-xs text-muted-foreground",I?"px-0.5":"px-1"),"data-test":c?`${c}-results-info`:"file-picker-results-info",children:w?r.jsx("span",{"data-test":c?`${c}-loading-text`:"file-picker-loading-text",children:"Loading files..."}):r.jsxs("span",{"data-test":c?`${c}-results-text`:"file-picker-results-text",children:["Showing ",k.length," of ",p.length," results",p.length<l.length&&` (filtered from ${l.length} total)`]})}),r.jsx(zg,{items:k,selectedIndex:g,renderItem:M,onItemClick:O=>N(O),onItemHover:O=>x(O),getItemKey:O=>O.path,height:I?"h-[300px]":"h-[400px]",className:"file-list",emptyMessage:"No files found",isLoading:w,loadingMessage:"Loading files...","data-test":c?`${c}-file-list`:"file-picker-file-list"}),!_&&r.jsxs("div",{className:R("keyboard-hints text-muted-foreground flex",I?"text-[10px] px-0.5 gap-2":"text-xs px-1 gap-4"),"data-test":c?`${c}-keyboard-hints`:"file-picker-keyboard-hints",children:[r.jsxs("span",{children:[r.jsx("kbd",{className:R("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"â†‘â†“"})," Navigate"]}),r.jsxs("span",{children:[r.jsx("kbd",{className:R("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Tab"})," Autocomplete"]}),r.jsxs("span",{children:[r.jsx("kbd",{className:R("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Enter"})," Select"]}),r.jsxs("span",{children:[r.jsx("kbd",{className:R("bg-muted rounded font-mono",I?"px-0.5 py-0 text-[9px]":"px-1 py-0.5"),children:"Esc"})," Clear"]})]})]})}const Qe={a:["a","Ã¡","Ã ","áº£","Ã£","áº¡","Äƒ","áº¯","áº±","áº³","áºµ","áº·","Ã¢","áº¥","áº§","áº©","áº«","áº­"],A:["A","Ã","Ã€","áº¢","Ãƒ","áº ","Ä‚","áº®","áº°","áº²","áº´","áº¶","Ã‚","áº¤","áº¦","áº¨","áºª","áº¬"],e:["e","Ã©","Ã¨","áº»","áº½","áº¹","Ãª","áº¿","á»","á»ƒ","á»…","á»‡"],E:["E","Ã‰","Ãˆ","áºº","áº¼","áº¸","ÃŠ","áº¾","á»€","á»‚","á»„","á»†"],i:["i","Ã­","Ã¬","á»‰","Ä©","á»‹"],I:["I","Ã","ÃŒ","á»ˆ","Ä¨","á»Š"],o:["o","Ã³","Ã²","á»","Ãµ","á»","Ã´","á»‘","á»“","á»•","á»—","á»™","Æ¡","á»›","á»","á»Ÿ","á»¡","á»£"],O:["O","Ã“","Ã’","á»Ž","Ã•","á»Œ","Ã”","á»","á»’","á»”","á»–","á»˜","Æ ","á»š","á»œ","á»ž","á» ","á»¢"],u:["u","Ãº","Ã¹","á»§","Å©","á»¥","Æ°","á»©","á»«","á»­","á»¯","á»±"],U:["U","Ãš","Ã™","á»¦","Å¨","á»¤","Æ¯","á»¨","á»ª","á»¬","á»®","á»°"],y:["y","Ã½","á»³","á»·","á»¹","á»µ"],Y:["Y","Ã","á»²","á»¶","á»¸","á»´"],d:["d","Ä‘"],D:["D","Ä"]},Hg={s:"acute",f:"grave",r:"hook",x:"tilde",j:"dot"},Gg={w:"horn",aa:"circumflex",aw:"breve",ee:"circumflex",oo:"circumflex",ow:"horn",uw:"horn",dd:"stroke"},Vs={a:null,e:null,i:null,o:null,u:null,y:null,d:null,Äƒ:null,Ã¢:null,Ãª:null,Ã´:null,Æ¡:null,Æ°:null,Ä‘:null,Ã¡:"s",áº¯:"s",áº¥:"s",Ã©:"s",áº¿:"s",Ã­:"s",Ã³:"s",á»‘:"s",á»›:"s",Ãº:"s",á»©:"s",Ã½:"s",Ã :"f",áº±:"f",áº§:"f",Ã¨:"f",á»:"f",Ã¬:"f",Ã²:"f",á»“:"f",á»:"f",Ã¹:"f",á»«:"f",á»³:"f",áº£:"r",áº³:"r",áº©:"r",áº»:"r",á»ƒ:"r",á»‰:"r",á»:"r",á»•:"r",á»Ÿ:"r",á»§:"r",á»­:"r",á»·:"r",Ã£:"x",áºµ:"x",áº«:"x",áº½:"x",á»…:"x",Ä©:"x",Ãµ:"x",á»—:"x",á»¡:"x",Å©:"x",á»¯:"x",á»¹:"x",áº¡:"j",áº·:"j",áº­:"j",áº¹:"j",á»‡:"j",á»‹:"j",á»:"j",á»™:"j",á»£:"j",á»¥:"j",á»±:"j",á»µ:"j"};Object.keys(Vs).forEach(s=>{const e=s.toUpperCase(),t=Vs[s];e!==s&&(Vs[e]=t)});function $t(s,e){const t=s.toLowerCase();switch(e){case"breve":return["Äƒ","áº¯","áº±","áº³","áºµ","áº·"].includes(t);case"circumflex":return["Ã¢","áº¥","áº§","áº©","áº«","áº­","Ãª","áº¿","á»","á»ƒ","á»…","á»‡","Ã´","á»‘","á»“","á»•","á»—","á»™"].includes(t);case"horn":return["Æ¡","á»›","á»","á»Ÿ","á»¡","á»£","Æ°","á»©","á»«","á»­","á»¯","á»±"].includes(t);case"stroke":return["Ä‘"].includes(t);default:return!1}}function hs(s){return s in Hg}function ha(s){return s==="w"||s==="a"||s==="e"||s==="o"||s==="u"||s==="d"}function Vg(s){const e=s.toLowerCase();if(Qe[e]!==void 0&&e!=="d")return e;for(const t of["a","e","i","o","u","y"])if(Qe[t].includes(e))return t;return null}function qg(s,e,t){const a=s.substring(e,t).toLowerCase(),n=[];for(let o=0;o<a.length;o++){const i=a[o],c=Vg(i);c!==null&&n.push({char:i,pos:e+o,base:c})}return n.length===0?-1:n.length===1?n[0].pos:n.length>=2?n[1].pos:n[n.length-1].pos}function zt(s){return s?/[\s.,;:!?()[\]{}'"<>\/\\-]/.test(s):!0}function ur(s,e){return s==="a"&&e.includes("a")&&e.includes("w")||s==="a"&&e==="w"?"aw":s==="o"&&e.includes("w")?"ow":s==="u"&&e.includes("w")?"uw":s==="a"&&e.includes("a")?"aa":s==="e"&&e.includes("e")?"ee":s==="o"&&e.includes("o")?"oo":s==="d"&&e.includes("d")?"dd":e.includes("w")?"w":null}function Kg(s){const e=Gg[s];return e==="breve"?"breve":e.includes("circumflex")?"circumflex":e.includes("horn")?"horn":e==="stroke"?"stroke":null}function ds(s,e){const t=Qe[s]||[];if(!e||e===s)return t;const a=e.slice(s.length).toLowerCase();let n=null;a.includes("s")?n="s":a.includes("j")?n="j":a.includes("r")?n="r":a.includes("x")?n="x":a.includes("f")&&(n="f");const o=ur(s,a),i=o?Kg(o):null;return t.filter(c=>!(n!==null&&Vs[c]!==n||i&&!$t(c,i)))}function fc(s){const e=s.toLowerCase();for(const t in Qe)if(Qe[t].includes(e))return!0;return!1}function pr(s){const e=s.toLowerCase();for(const t in Qe)if(Qe[t].includes(e))return t;return s}function Jg(s,e){let t=-1,a="";const n=s.charAt(e-1).toLowerCase();if(hs(n))for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o);if(zt(i))break;if(fc(i))return{sequenceStart:o,detectedBaseChar:pr(i),found:!0};if(Qe[i.toLowerCase()])break}if(ha(n)){if(n==="w")for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(zt(i))break;if(i==="o"&&o>0&&s.charAt(o-1).toLowerCase()==="u")return{sequenceStart:o-1,detectedBaseChar:"u",found:!0}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(zt(i))break;if(i===n&&Qe[i])return{sequenceStart:o,detectedBaseChar:i,found:!0}}}for(let o=e-2;o>=Math.max(0,e-6);o--){const i=s.charAt(o).toLowerCase();if(Qe[i]){if(t=o,a=i,o>0){const l=s.charAt(o-1).toLowerCase();l===i&&Qe[l]&&(t=o-1,a=l)}const c=s.slice(t+1,e-1).toLowerCase();for(const l of c)if(!hs(l)&&!ha(l)&&l!==a)return{sequenceStart:-1,detectedBaseChar:"",found:!1};break}}return{sequenceStart:t,detectedBaseChar:a,found:t>=0}}function Qg(s){const e=s.slice(0,-1);return/\s/.test(e)}function Xg(s,e,t,a,n){const o=s.slice(t,e).toLowerCase(),i=s.charAt(e-1).toLowerCase();if(e>=2&&s.charAt(e-2),hs(i)){let u=0;for(let h=e-2;h>=0;h--)if(zt(s.charAt(h))){u=h+1;break}s.substring(u,e-1);const p=qg(s,u,e-1);if(p>=0){const h=s.charAt(p),f=h.toLowerCase(),b=pr(f);if(Qe[b]){let v="";$t(f,"breve")||$t(f,"circumflex")?v=b:$t(f,"horn")&&(v="w");const m=b+v+i,w=ds(b,m);if(w.length>0){const y=w[0],g=h===h.toUpperCase()?y.toUpperCase():y,x=s.substring(0,p),j=s.substring(p+1,e-1),C=s.substring(e);return{type:"auto-complete",replacement:x+g+j+C,newCursorPos:e-1,realTimeReplacement:!0}}}}for(let h=e-2;h>=Math.max(0,e-6);h--){const f=s.charAt(h);if(zt(f))break;if(fc(f)){const b=pr(f);let v="";const m=f.toLowerCase();$t(m,"breve")||$t(m,"circumflex")?v=b:$t(m,"horn")&&(v="w");const w=b+v+i,y=ds(b,w);if(y.length>0){const g=y[0],x=s.substring(0,h),j=s.substring(h+1,e-1),C=s.substring(e);return{type:"auto-complete",replacement:x+g+j+C,newCursorPos:e-1,realTimeReplacement:!0}}}if(Qe[f.toLowerCase()])break}}if(ha(i)){if(i==="w"){if(s.substring(0,e),a==="u"){const v=s.substring(t,e).toLowerCase();if(v.startsWith("uo")){const m=v.substring(2,v.length-1),w=s.substring(0,t),y=s.substring(e);return{type:"auto-complete",replacement:w+"Æ°Æ¡"+m+y,newCursorPos:t+2+m.length,realTimeReplacement:!0}}}const u=o.toLowerCase();if(u==="uow"||u.endsWith("uow")){const v=s.substring(0,t),m=s.substring(e);return{type:"auto-complete",replacement:v+"Æ°Æ¡"+m,newCursorPos:t+2,realTimeReplacement:!0}}let p=0;for(let v=e-2;v>=0;v--)if(zt(s.charAt(v))){p=v+1;break}const h=s.substring(p,e-1);let f=-1,b="";for(let v=h.length-1;v>=0;v--)if(h[v].toLowerCase()==="o"){f=p+v,b="o";break}if(f===-1){for(let v=h.length-1;v>=0;v--)if(h[v].toLowerCase()==="u"){f=p+v,b="u";break}}if(f>=0){const v=b==="o"?"Æ¡":"Æ°",m=s.charAt(f),w=m===m.toUpperCase()?v.toUpperCase():v,y=s.substring(0,f),g=s.substring(f+1,e-1),x=s.substring(e);return{type:"auto-complete",replacement:y+w+g+x,newCursorPos:e-1,realTimeReplacement:!0}}}for(let u=e-2;u>=Math.max(0,e-6);u--){const p=s.charAt(u).toLowerCase();if(zt(p))break;if(p===i&&Qe[p]){const h=i+i;if(ur(p,h)){const b=ds(p,h);if(b.length>0){const v=b[0],m=s.substring(0,u),w=s.substring(u+1,e-1),y=s.substring(e);return{type:"auto-complete",replacement:m+v+w+y,newCursorPos:e-1,realTimeReplacement:!0}}}break}}}if(Qg(o))return{type:"terminate"};const c=hs(i)||ha(i);let l=!1;if(c)if(hs(i))l=!0;else{const u=o.slice(a.length).toLowerCase();ur(a,u)===null?(e>=2&&s.charAt(e-2).toLowerCase(),t<e-1&&s.charAt(t).toLowerCase()===i&&(l=!0)):l=!0}if(l){const u=ds(a,o);if(u.length>0){const p=u[0],h=s.substring(0,t),f=s.substring(e);return{type:"auto-complete",replacement:h+p+f,newCursorPos:t+1,realTimeReplacement:!0}}return{type:"terminate"}}else return Yg(s,e,t,a,o)}function Yg(s,e,t,a,n){const i=(t>0?s.charAt(t-1).toLowerCase():"")+n;if(i==="uown"||i==="uow"){const l=s.substring(0,t-1),u=s.substring(e),p=s.charAt(e-1);return{type:"auto-complete",replacement:l+"Æ°Æ¡"+p+u,newCursorPos:t-1+2+1}}const c=ds(a,n.slice(0,-1));if(c.length>0){const l=c[0],u=s.substring(0,t),p=s.substring(e),h=s.charAt(e-1);return{type:"auto-complete",replacement:u+l+h+p,newCursorPos:t+1+1}}return{type:"terminate"}}function Zb(s){return s!==""&&Qe[s]!==void 0}function ev(s,e,t,a){const n=t-1;switch(e){case"right":{const i=Math.floor(s/a)*a,c=Math.min(i+a-1,n);return s===c?i:s+1}case"left":{const i=Math.floor(s/a)*a,c=Math.min(i+a-1,n);return s===i?c:s-1}case"down":{const o=s%a,i=Math.floor(s/a),c=Math.ceil((n+1)/a),l=i+1;if(l>=c){const u=o;return u<=n?u:s}else{const u=l*a+o;return u<=n?u:s}}case"up":{const o=s%a,i=Math.floor(s/a);if(i===0){const u=(Math.ceil((n+1)/a)-1)*a+o;return u<=n?u:s}else return(i-1)*a+o}default:return s}}const Ta="â€‹";function ut(s){if(!s)return"";let e=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(new RegExp("(?<!\\w)__(.+?)__(?!\\w)","g"),"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(new RegExp("(?<!\\w)_(.+?)_(?!\\w)","g"),"<em>$1</em>").replace(/~~(.+?)~~/g,"<del>$1</del>").replace(/`([^`]+)`/g,'<code class="bg-muted px-1 rounded text-sm font-mono">$1</code>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^&gt; (.+)$/gm,'<blockquote class="border-l-2 border-muted-foreground/30 pl-3 m-0 text-muted-foreground italic">$1</blockquote>').replace(/^---$/gm,'<hr class="border-t border-muted-foreground/30 m-0">').replace(/\n/g,"<br>");return e=e.replace(/(<hr[^>]*>)<br>/g,"$1"),e.endsWith("<br>")&&(e+=Ta),e}function Jt(s){if(!s)return"";const e=document.createElement("div");e.innerHTML=s.replace(new RegExp(Ta,"g"),"");function t(o,i=!1){if(o.nodeType===Node.TEXT_NODE)return o.textContent||"";if(o.nodeType===Node.ELEMENT_NODE){const c=o,l=c.tagName.toLowerCase(),u=Array.from(o.childNodes).map(p=>t(p,!1)).join("");switch(l){case"strong":case"b":return`**${u}**`;case"em":case"i":return`*${u}*`;case"del":case"s":return`~~${u}~~`;case"code":return`\`${u}\``;case"br":return`
`;case"blockquote":return`> ${u}`;case"div":case"p":return i?u:u?u+`
`:"";case"h1":return`# ${u}`;case"h2":return`## ${u}`;case"h3":return`### ${u}`;case"span":return c.classList.contains("text-2xl")?`# ${u}`:c.classList.contains("text-xl")?`## ${u}`:c.classList.contains("text-lg")?`### ${u}`:u;default:return u}}return""}return t(e,!0).replace(/\n+$/,"")}function Us(s){const e=window.getSelection();if(!e||e.rangeCount===0)return{text:Jt(s.innerHTML),cursorPos:0};const t=e.getRangeAt(0),a=t.cloneRange();a.selectNodeContents(s),a.setEnd(t.startContainer,t.startOffset);const n=document.createElement("div");n.appendChild(a.cloneContents());const o=n.querySelectorAll("br").length,c=(n.textContent||"").replace(new RegExp(Ta,"g"),"").length+o;return{text:Jt(s.innerHTML),cursorPos:c}}function Zg(s,e){const t=s.lastIndexOf(`
`,e-1)+1,a=s.indexOf(`
`,e),n=a===-1?s.length:a,o=s.substring(t,n);return{lineStart:t,currentLine:o}}function Mt(s,e){const t=window.getSelection();if(!t)return;let a=0;const n=document.createTreeWalker(s,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let o=n.nextNode();for(;o;){if(o.nodeType===Node.TEXT_NODE){const c=o.textContent??"";if(c===Ta){if(a===e){const u=document.createRange();u.setStart(o,0),u.collapse(!0),t.removeAllRanges(),t.addRange(u);return}o=n.nextNode();continue}const l=c.length;if(a+l>=e){const u=document.createRange();u.setStart(o,e-a),u.collapse(!0),t.removeAllRanges(),t.addRange(u);return}a+=l}else if(o.nodeName==="BR"){if(a+1>=e){const c=n.nextNode();if(c&&c.nodeType===Node.TEXT_NODE){const p=document.createRange();p.setStart(c,0),p.collapse(!0),t.removeAllRanges(),t.addRange(p);return}const l=document.createRange(),u=o.parentNode;if(u){const p=Array.from(u.childNodes).indexOf(o);l.setStart(u,p+1),l.collapse(!0),t.removeAllRanges(),t.addRange(l)}return}a+=1}o=n.nextNode()}const i=document.createRange();i.selectNodeContents(s),i.collapse(!1),t.removeAllRanges(),t.addRange(i)}const mc=d.forwardRef(({value:s,defaultValue:e,onChange:t,onBlur:a,onKeyDown:n,className:o,style:i,placeholder:c,readOnly:l=!1,useRichEditing:u=!1,allowRawPreviewOnClick:p=!1,showHints:h=!0,showAudioButton:f=!1,audioButtonVariant:b="default",autoStartAudioRecording:v=!1,onAudioTranscription:m,getTextAreaElement:w,audioNodeId:y,keyboard:g="english","data-test":x,...j},C)=>{const[N,S]=d.useState(e||""),[D,W]=d.useState(!1),E=d.useRef(null),I=d.useRef(!1),_=d.useRef(!1),U=s!==void 0?s:N,k=!U||U.trim()==="";d.useImperativeHandle(C,()=>({getElement:()=>E.current,getValue:()=>U,setValue:T=>{if(s===void 0&&S(T),E.current){const L=ut(T);E.current.innerHTML=L;const V=document.createRange(),K=window.getSelection();V.selectNodeContents(E.current),V.collapse(!1),K==null||K.removeAllRanges(),K==null||K.addRange(V)}t==null||t(T)},focus:()=>{var T;(T=E.current)==null||T.focus()}})),d.useEffect(()=>{E.current&&!I.current&&(E.current.innerHTML=ut(U),I.current=!0)},[]),d.useEffect(()=>{if(E.current&&!D&&I.current){const T=ut(U);E.current.innerHTML!==T&&(E.current.innerHTML=T)}},[U,D]),d.useEffect(()=>{if(!D||!E.current||!p)return;const T=()=>{if(_.current)return;const L=window.getSelection();if(!(!L||!E.current)&&L.isCollapsed&&E.current.contains(L.anchorNode)){const V=Jt(E.current.innerHTML),K=ut(V);if(E.current.innerHTML!==K){const q=L.getRangeAt(0),Q=q.cloneRange();Q.selectNodeContents(E.current),Q.setEnd(q.startContainer,q.startOffset);const Y=document.createElement("div");Y.appendChild(Q.cloneContents());const oe=Jt(Y.innerHTML).length;E.current.innerHTML=K,Mt(E.current,oe)}}};return document.addEventListener("selectionchange",T),()=>{document.removeEventListener("selectionchange",T)}},[D,U,p]);const M=d.useCallback(()=>{if(!E.current)return;const T=E.current.innerHTML;let L=Jt(T);if(g==="viet"){const{text:V,cursorPos:K}=Us(E.current),q=L,Q=K,Y=Jg(q,Q);if(Y.found){const oe=Xg(q,Q,Y.sequenceStart,Y.detectedBaseChar);if(oe.type==="auto-complete"&&oe.replacement){L=oe.replacement;const ve=oe.newCursorPos??L.length;E.current.innerHTML=ut(L),Mt(E.current,ve)}}}s===void 0&&S(L),t==null||t(L)},[t,s,g]),O=d.useCallback(T=>{var K,q;if(!E.current||!p)return;const V=T.target.closest("strong, em, code, del, blockquote");if(V){T.preventDefault();const Q=V.textContent||"";let Y="";const oe=V.tagName.toLowerCase();switch(oe){case"strong":Y="**";break;case"em":Y="*";break;case"code":Y="`";break;case"del":Y="~~";break;case"blockquote":Y="> ";break}if(Y){_.current=!0;const ve=window.getSelection();if(!ve||ve.rangeCount===0)return;const X=ve.getRangeAt(0);let H=0;if(V.contains(X.startContainer)){const te=document.createRange();te.selectNodeContents(V),te.setEnd(X.startContainer,X.startOffset);const G=document.createElement("div");G.appendChild(te.cloneContents()),H=((K=G.textContent)==null?void 0:K.length)||0}const ae=oe==="blockquote"?`${Y}${Q}`:`${Y}${Q}${Y}`,he=document.createTextNode(ae);V.replaceWith(he);const xe=document.createRange(),de=Y.length+H;xe.setStart(he,de),xe.setEnd(he,de),ve.removeAllRanges(),ve.addRange(xe),M()}}else if(_.current&&(_.current=!1,E.current)){const Q=window.getSelection();let Y=0;if(Q&&Q.rangeCount>0){const X=Q.getRangeAt(0),H=X.cloneRange();H.selectNodeContents(E.current),H.setEnd(X.startContainer,X.startOffset);const ae=document.createElement("div");ae.appendChild(H.cloneContents());const he=ae.textContent||"";Y=he.length;let xe=0;for(let de=0;de<Math.min(Y,he.length);de++){const te=he[de],G=he[de+1];te==="*"&&G==="*"?(xe+=2,de++):(te==="*"||te==="_"||te==="`"||te==="~")&&xe++}Y=Y-xe}const oe=Jt(E.current.innerHTML),ve=ut(oe);if(E.current.innerHTML!==ve&&(E.current.innerHTML=ve,Q&&Q.rangeCount>0)){let X=0;const H=document.createTreeWalker(E.current,NodeFilter.SHOW_TEXT);let ae=H.nextNode(),he=!1;for(;ae&&!he;){const xe=((q=ae.textContent)==null?void 0:q.length)||0;if(X+xe>=Y){const de=Y-X,te=document.createRange();te.setStart(ae,de),te.setEnd(ae,de),Q.removeAllRanges(),Q.addRange(te),he=!0}else X+=xe,ae=H.nextNode()}}}},[M,p]),A=d.useCallback(()=>{W(!0)},[]),P=d.useCallback(T=>{W(!1),E.current&&(E.current.innerHTML=ut(U)),a==null||a(T)},[U,a]),z=d.useCallback(T=>{const L=window.getSelection();if(L&&L.rangeCount>0&&!L.isCollapsed){const V=L.toString();if((T.key==="*"||T.key==="_"||T.key==="`")&&!T.metaKey&&!T.ctrlKey&&!T.altKey){T.preventDefault();const K=L.getRangeAt(0);K.deleteContents();const q=document.createTextNode(T.key);K.insertNode(q);const Q=document.createTextNode(V);K.setStartAfter(q),K.insertNode(Q);const Y=document.createTextNode(T.key);K.setStartAfter(Q),K.insertNode(Y);const oe=document.createRange();oe.setStartAfter(q),oe.setEndBefore(Y),L.removeAllRanges(),L.addRange(oe),M(),n==null||n(T);return}}if(T.metaKey||T.ctrlKey){if(!["b","i","`"].includes(T.key.toLowerCase())){n==null||n(T);return}const K=window.getSelection();if(!K||K.rangeCount===0){n==null||n(T);return}const q=K.toString();if(!q){n==null||n(T);return}let Q="";switch(T.key){case"b":Q="**";break;case"i":Q="*";break;case"`":Q="`";break}if(Q){T.preventDefault();const Y=K.getRangeAt(0);Y.deleteContents();const oe=document.createTextNode(`${Q}${q}${Q}`);Y.insertNode(oe),Y.setStartAfter(oe),Y.setEndAfter(oe),K.removeAllRanges(),K.addRange(Y),M(),n==null||n(T);return}}if(u&&E.current){if(T.key==="Backspace"){const{text:V,cursorPos:K}=Us(E.current),q=$o(V,K);if(q.type==="delete-char"&&q.newText!==void 0){T.preventDefault();const Q=q.newCursorPos??K-1;E.current.innerHTML=ut(q.newText),Mt(E.current,Q),s===void 0&&S(q.newText),t==null||t(q.newText),n==null||n(T);return}}if(T.key==="Enter"&&!T.shiftKey){const{text:V,cursorPos:K}=Us(E.current),{lineStart:q,textAfterLine:Q}=Er(V,K),Y=V.substring(q,K),oe=V.indexOf(`
`,K),ve=V.substring(K,oe===-1?V.length:oe),X=Lo(Y,ve+Q,V,K);if(X.type==="remove-prefix"){T.preventDefault();const H=X.charsToRemoveBeforeCursor??0;let ae;X.textAfterCursor!==void 0?ae=V.substring(0,K-H)+X.textToInsert+X.textAfterCursor:ae=V.substring(0,K-H)+X.textToInsert+V.substring(K);const he=K-H+X.textToInsert.length;E.current.innerHTML=ut(ae),Mt(E.current,he),s===void 0&&S(ae),t==null||t(ae),n==null||n(T);return}if(X.type==="continue"){T.preventDefault();let H;X.textAfterCursor!==void 0?H=V.substring(0,K)+X.textToInsert+X.textAfterCursor:H=V.substring(0,K)+X.textToInsert+V.substring(K);const ae=K+X.textToInsert.length;E.current.innerHTML=ut(H),Mt(E.current,ae),s===void 0&&S(H),t==null||t(H),n==null||n(T);return}if(X.type==="newline"){T.preventDefault(),document.execCommand("insertLineBreak"),M(),n==null||n(T);return}}if(T.key==="Tab"){T.preventDefault();const{text:V,cursorPos:K}=Us(E.current),{lineStart:q,currentLine:Q}=Zg(V,K);if(T.shiftKey){let Y=0;for(let oe=0;oe<Math.min(2,Q.length)&&Q[oe]===" ";oe++)Y++;if(Y>0){const oe=V.substring(0,q)+V.substring(q+Y),ve=Math.max(q,K-Y);E.current.innerHTML=ut(oe),Mt(E.current,ve),s===void 0&&S(oe),t==null||t(oe)}}else{const Y=V.substring(0,q)+"  "+V.substring(q),oe=K+2;E.current.innerHTML=ut(Y),Mt(E.current,oe),s===void 0&&S(Y),t==null||t(Y)}n==null||n(T);return}}n==null||n(T)},[M,n,u,s,t]),$=d.useCallback(T=>{T.preventDefault();const L=T.clipboardData.getData("text/plain");document.execCommand("insertText",!1,L)},[]);return r.jsxs("div",{className:"markdown-textarea-container h-full","data-test":x?`${x}-container`:"markdown-textarea-container",children:[r.jsxs("div",{className:"markdown-textarea-wrapper relative h-full","data-test":x?`${x}-wrapper`:"markdown-textarea-wrapper",children:[r.jsx("div",{ref:E,contentEditable:!l,onInput:M,onClick:O,onFocus:A,onBlur:P,onKeyDown:z,onPaste:$,className:R("markdown-textarea min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm","ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50","[&_strong]:font-bold [&_em]:italic [&_del]:line-through","[&_code]:bg-muted [&_code]:px-1 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono",l&&"cursor-default",o),style:{whiteSpace:"pre-wrap",wordBreak:"break-word",...i},suppressContentEditableWarning:!0,"data-node-textarea":j["data-node-textarea"],"data-test":x?`${x}-editor`:"markdown-textarea-editor"}),k&&!D&&c&&r.jsx("div",{className:"absolute top-2 left-3 text-sm text-muted-foreground pointer-events-none","aria-hidden":!0,"data-test":x?`${x}-placeholder`:"markdown-textarea-placeholder",children:c}),f&&r.jsx(uc,{onTranscriptionComplete:T=>{m==null||m(T)},sessionName:"markdown-textarea",className:"absolute right-2 bottom-1",style:{zIndex:xt.nodeAudioButton},getTextAreaElement:w||(()=>E.current),variant:b,autoStartRecording:v,nodeId:y,"data-test":x?`${x}-audio-button`:"markdown-textarea-audio-button"})]}),h&&r.jsxs("div",{className:"markdown-hints text-xs text-muted-foreground mt-1 flex gap-3 flex-wrap","data-test":x?`${x}-hints`:"markdown-textarea-hints",children:[r.jsxs("span",{children:[r.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+B"})," Bold"]}),r.jsxs("span",{children:[r.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Ctrl+I"})," Italic"]}),r.jsx("span",{children:"**bold** *italic* `code` > quote"}),u&&r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"text-muted-foreground/50",children:"|"}),r.jsxs("span",{children:[r.jsx("kbd",{className:"px-1 bg-muted rounded",children:"Tab"})," Indent"]}),r.jsx("span",{children:"Auto-list on Enter"})]})]})]})});mc.displayName="MarkdownTextarea";const ex=s=>{var e,t,a;return(a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.selectedProjectPath},xn=(s,e)=>{let t=-1;for(let o=e;o>=0;o--){if(s[o]==="@"){t=o;break}if(s[o]===" "||s[o]===`
`||s[o]==="	")break}if(t===-1)return null;let a=t+1;for(;a<s.length;){const o=s[a];if(o===" "||o===`
`||o==="	")break;a++}const n=s.substring(t,a);return n.startsWith("@")&&n.includes("/")?{start:t,end:a,path:n}:null},_t=d.forwardRef(({defaultValue:s,value:e,onChange:t,onBlur:a,onKeyDown:n,onMouseDown:o,onClick:i,onPaste:c,className:l,style:u,placeholder:p,onSelectionChange:h,onFileSelect:f,logger:b,showBuiltInPopover:v=!1,showFilePicker:m=!0,showAudioButton:w=!0,audioButtonVariant:y="default",autoStartAudioRecording:g=!1,onAudioTranscriptionComplete:x,audioNodeId:j,readOnly:C=!1,rows:N,useMarkdown:S=!1,showMarkdownHints:D=!1,keyboard:W="english"},E)=>{const[I,_]=d.useState(!1),[U,k]=d.useState({top:0,left:0}),[M,O]=d.useState(null),A=d.useRef(null),P=d.useRef(null),z=d.useRef(null),$=Ae(ex);d.useImperativeHandle(E,()=>({getTextArea:()=>{var X,H;return S?(X=P.current)==null?void 0:X.getElement():((H=A.current)==null?void 0:H.getTextArea())??null},insertTextAtStart:X=>{var H,ae;S?(H=P.current)==null||H.focus():(ae=A.current)==null||ae.insertTextAtStart(X)},focus:()=>{var X,H,ae;S?(X=P.current)==null||X.focus():(ae=(H=A.current)==null?void 0:H.getTextArea())==null||ae.focus()}}),[S]);const T=d.useCallback(X=>{var H,ae,he,xe;if(S){const de=((H=P.current)==null?void 0:H.getValue())??"",te=de.trim()?" ":"",G=de+te+X;(ae=P.current)==null||ae.setValue(G);const ee={target:{value:G},currentTarget:{value:G}};t==null||t(ee)}else{const de=(he=A.current)==null?void 0:he.getTextArea();if(!de)return;const te=de.value,G=te.trim()?" ":"",ee=te+G+X,ie=(xe=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:xe.set;ie?ie.call(de,ee):de.value=ee;const Ne=new Event("input",{bubbles:!0});de.dispatchEvent(Ne)}x==null||x()},[S,t,x]),L=X=>{var he;if(!m)return!1;const H=X.selectionStart,ae=X.value;if(H>0&&ae[H-1]==="@"){const xe=H>1?ae[H-2]:null,de=H<ae.length?ae[H]:null;if((xe===null||xe===" "||xe===`
`||xe==="	")&&(de===null||de===" "||de===`
`||de==="	")){const ee=(he=A.current)==null?void 0:he.getSelectionPosition();return ee&&k(ee),O(H-1),_(!0),b==null||b.info("@ character detected at cursor - showing file picker"),!0}}return!1},V=X=>{const H=X.target;L(H),t==null||t(X)},K=X=>{const H=X.currentTarget;setTimeout(()=>{L(H)},0)},q=X=>{const H=X.currentTarget;["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(X.key)&&L(H)},Q=(X,H)=>{var ae;if(h==null||h(X,H),!!m)if(X.length>0){const he=X.toLowerCase()==="file",xe=(ae=A.current)==null?void 0:ae.getTextArea();let de=null;if(xe){const te=xe.value,G=xe.selectionStart;de=xn(te,G)}he||de?(_(!0),H&&k(H),he?(O(null),b==null||b.info('Word "file" selected - showing file picker')):(O(null),b==null||b.info(`File path "${de==null?void 0:de.path}" detected - showing file picker to replace`))):(_(!1),O(null))}else _(!1),O(null)},Y=X=>{var H;if(_(X),!X){const ae=(H=A.current)==null?void 0:H.getTextArea();ae&&ae.focus()}},oe=X=>{var ue;const H=(ue=A.current)==null?void 0:ue.getTextArea();if(!H)return;H.focus();const ae=H.value,he=H.selectionStart,de=H.value.substring(H.selectionStart,H.selectionEnd).toLowerCase()==="file",te=xn(ae,he);let G,ee,ie;if(M!==null)G=M,ee=M+1,ie="@"+X.path;else if(de)G=H.selectionStart,ee=H.selectionEnd,ie="@"+X.path;else if(te)G=te.start,ee=te.end,ie="@"+X.path;else{_(!1),O(null);return}if(H.setSelectionRange(G,ee),!document.execCommand("insertText",!1,ie)){const me=H.value.substring(0,G),fe=H.value.substring(ee);H.value=me+ie+fe,H.setSelectionRange(G+ie.length,G+ie.length),H.dispatchEvent(new Event("input",{bubbles:!0}))}M!==null?b==null||b.info(`Replaced "@" with: ${ie}`):de?b==null||b.info(`Replaced "file" with: ${ie}`):te&&(b==null||b.info(`Replaced "${te.path}" with: ${ie}`)),f==null||f(X),_(!1),O(null)},ve=d.useCallback(X=>{const H={target:{value:X},currentTarget:{value:X}};t==null||t(H)},[t]);return r.jsxs(Ge,{open:I,onOpenChange:Y,"data-test":"textarea-file-picker-popover",children:[r.jsxs("div",{className:"textarea-with-file-picker relative w-full h-full","data-test":"textarea-file-picker-container",children:[S?r.jsx("div",{className:"relative w-full h-full",onMouseDown:o,onPaste:c,onClick:X=>{K(X),i==null||i(X)},onKeyUp:q,children:r.jsx(mc,{ref:P,defaultValue:s,value:e,onChange:ve,onBlur:a,onKeyDown:n,className:l,style:u,placeholder:p,readOnly:C,useRichEditing:!0,showHints:D,showAudioButton:w,audioButtonVariant:y,autoStartAudioRecording:g,onAudioTranscription:T,getTextAreaElement:()=>{var X;return((X=P.current)==null?void 0:X.getElement())??null},audioNodeId:j,keyboard:W,"data-node-textarea":!0,"data-test":"textarea-file-picker-markdown-textarea"})}):r.jsx(pc,{ref:A,defaultValue:s,value:e,onChange:V,onBlur:a,onKeyDown:n,onMouseDown:o,onPaste:c,onClick:X=>{K(X),i==null||i(X)},onKeyUp:q,className:l,style:u,onSelectionChange:Q,placeholder:p,showBuiltInPopover:v,showAudioButton:w,audioButtonVariant:y,onAudioTranscription:T,getTextAreaElement:()=>{var X;return((X=A.current)==null?void 0:X.getTextArea())??null},readOnly:C,rows:N,"data-test":"textarea-file-picker-selectable-textarea"}),m&&r.jsx(Io,{ref:z,style:{position:"absolute",top:`${U.top}px`,left:`${U.left}px`,width:"1px",height:"1px"},"data-test":"textarea-file-picker-popover-anchor"})]}),m&&r.jsxs(We,{className:"file-picker-popover w-[500px] p-2",side:"bottom",align:"start","data-test":"textarea-file-picker-popover-content",children:[r.jsxs("div",{className:"file-picker-header mb-2","data-test":"textarea-file-picker-popover-header",children:[r.jsx("h3",{className:"font-semibold text-xs","data-test":"textarea-file-picker-popover-title",children:'Replace "file" with a file path'}),r.jsx("p",{className:"text-[10px] text-muted-foreground","data-test":"textarea-file-picker-popover-description",children:'Select a file to replace the word "file" with its path. Type "/" to search by full path.'})]}),r.jsx(Bg,{onFileSelect:oe,maxResults:10,placeholder:"Search for a file...",mode:"fileNameOnly",cwd:$??void 0,"data-test":"textarea-file-picker-file-picker"})]})]})});_t.displayName="TextareaWithFilePicker";const za={outputFormat:"text",permissionMode:"acceptEdits"};function gc({variant:s="outline",size:e="sm",buttonLabel:t="Options",className:a,children:n}){const o=Ae(l=>{var u,p,h;return(h=(p=(u=l.ui)==null?void 0:u.claude)==null?void 0:p.message)==null?void 0:h.options}),i={outputFormat:(o==null?void 0:o.outputFormat)??za.outputFormat,permissionMode:(o==null?void 0:o.permissionMode)??za.permissionMode};d.useEffect(()=>{var l,u,p;if(!o){const h=Z.getState();Z.updateState({ui:{...h.ui,claude:{...(l=h.ui)==null?void 0:l.claude,message:{...(p=(u=h.ui)==null?void 0:u.claude)==null?void 0:p.message,options:za}}}})}},[o]);const c=l=>{var p,h,f;const u=Z.getState();Z.updateState({ui:{...u.ui,claude:{...(p=u.ui)==null?void 0:p.claude,message:{...(f=(h=u.ui)==null?void 0:h.claude)==null?void 0:f.message,options:l}}}})};return r.jsxs(r.Fragment,{children:[r.jsxs(Ge,{children:[r.jsx(Xe,{asChild:!0,children:r.jsxs(ne,{variant:s,size:e,className:a,title:"Message Options","data-test":"message-options-button",children:[r.jsx(At,{className:"h-4 w-4"}),t&&r.jsx("span",{className:"ml-2",children:t})]})}),r.jsx(We,{className:"w-80",onClick:l=>l.stopPropagation(),"data-test":"message-options-popover",children:r.jsxs("div",{className:"message-options-panel space-y-4","data-test":"message-options-panel",children:[r.jsxs("div",{className:"output-format-select","data-test":"output-format-select",children:[r.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Output Format"}),r.jsxs(It,{value:i.outputFormat,onValueChange:l=>c({...i,outputFormat:l}),children:[r.jsx(jt,{"data-test":"output-format-trigger",children:r.jsx(Rt,{})}),r.jsxs(Nt,{"data-test":"output-format-content",children:[r.jsx(we,{value:"text","data-test":"output-format-text",children:"Text"}),r.jsx(we,{value:"json","data-test":"output-format-json",children:"JSON"}),r.jsx(we,{value:"stream-json","data-test":"output-format-stream-json",children:"Stream JSON"})]})]})]}),r.jsxs("div",{className:"permission-mode-select","data-test":"permission-mode-select",children:[r.jsx("label",{className:"text-sm font-medium mb-1 block",children:"Permission Mode"}),r.jsxs(It,{value:i.permissionMode,onValueChange:l=>c({...i,permissionMode:l}),children:[r.jsx(jt,{"data-test":"permission-mode-trigger",children:r.jsx(Rt,{})}),r.jsxs(Nt,{"data-test":"permission-mode-content",children:[r.jsx(we,{value:"default","data-test":"permission-mode-default",children:"Default"}),r.jsx(we,{value:"acceptEdits","data-test":"permission-mode-accept-edits",children:"Accept Edits"}),r.jsx(we,{value:"bypassPermissions","data-test":"permission-mode-bypass",children:"Bypass Permissions"}),r.jsx(we,{value:"plan","data-test":"permission-mode-plan",children:"Plan Mode"})]})]})]})]})})]}),n(i)]})}const tx="Use @agent-code-worktree-specialist to help with this task.",sx="Please implement this feature following best practices and ensure all tests pass.";function xc({variant:s="ghost",size:e="icon",className:t="create-session-panel-button",disabled:a=!1,icon:n,initialMessage:o,buttonTitle:i="Create New Session with Message",projectPath:c,onOpen:l,onCreating:u,onSessionCreated:p,useModal:h=!1}){const[f,b]=d.useState(!1),[v,m]=d.useState(!1),[w,y]=d.useState(o||""),[g,x]=d.useState(o||""),[j,C]=d.useState(void 0),[N,S]=d.useState(!1),[D,W]=d.useState(null),E=d.useRef(null),I=Ae(z=>{var $,T,L;return(L=(T=($=z.app)==null?void 0:$.claude)==null?void 0:T.ui)==null?void 0:L.selectedProjectPath}),_=Ae(z=>{var $,T;return(T=($=z.ui)==null?void 0:$.global)==null?void 0:T.createClaudeSessionPopoverSize}),U=z=>{var T;const $=Z.getState();Z.updateState({ui:{...$.ui,global:{...(T=$.ui)==null?void 0:T.global,createClaudeSessionPopoverSize:z}}})};d.useEffect(()=>{o!==g&&(y(o||""),x(o||""))},[o,g]),d.useEffect(()=>{var z,$,T,L,V,K;if(f&&c&&c!=="none"){const q=Z.getState();((T=($=(z=q.app)==null?void 0:z.claude)==null?void 0:$.ui)==null?void 0:T.selectedProjectPath)!==c&&Z.updateState({app:{...q.app,claude:{...(L=q.app)==null?void 0:L.claude,ui:{...(K=(V=q.app)==null?void 0:V.claude)==null?void 0:K.ui,selectedProjectPath:c}}}})}},[f,c]);const k=()=>{if(!h&&E.current){const z=E.current.getBoundingClientRect();C({x:z.left,y:z.bottom+8})}b(!0),l&&l()},M=()=>{b(!1)},O=(z,$)=>{const T=[];return $.usePrompt1&&$.prompt1Text&&T.push($.prompt1Text),$.usePrompt2&&$.prompt2Text&&T.push($.prompt2Text),T.length>0?`${T.join(`

`)}

${z}`:z},A=z=>{const $=I??c;return{message:w.trim(),cwd:$,projectId:$,options:{outputFormat:z.outputFormat,permissionMode:z.permissionMode}}},P=async z=>{if(console.log("ðŸŽ¯ [ButtonCreateSession] handleSendMessage called",{messageLength:w.trim().length,sessionOptions:z,timestamp:new Date().toISOString()}),!w.trim()){console.log("âš ï¸ [ButtonCreateSession] Message is empty, aborting");return}try{console.log("ðŸ“¤ [ButtonCreateSession] Setting sending state to true"),m(!0),u&&(console.log("ðŸ“£ [ButtonCreateSession] Calling onCreating callback"),u());const $=A(z);console.log("ðŸ“¦ [ButtonCreateSession] Request body built",{hasMessage:!!$.message,hasCwd:!!$.cwd,hasProjectId:!!$.projectId,optionsCount:Object.keys($.options||{}).length}),console.log("ðŸš€ [ButtonCreateSession] Calling claudeAPI.createSession");const T=await nt.createSession($);if(console.log("âœ… [ButtonCreateSession] API response received",{success:T.success,hasSessionId:!!T.sessionId,error:T.error}),T.success&&T.sessionId)console.log("ðŸŽ‰ [ButtonCreateSession] Session created successfully",{sessionId:T.sessionId}),p&&(console.log("ðŸ“ž [ButtonCreateSession] Calling onSessionCreated callback"),p(T.sessionId,T.response)),console.log("ðŸšª [ButtonCreateSession] Closing popover"),M();else throw new Error(T.error??"Failed to create session")}catch($){console.error("âŒ [ButtonCreateSession] Failed to create session:",$)}finally{console.log("ðŸ [ButtonCreateSession] Setting sending state to false"),m(!1)}};return r.jsx(wa,{storageKey:"claude-session-prompts",initialConfig:{usePrompt1:!1,usePrompt2:!1,prompt1Text:tx,prompt2Text:sx},children:(z,$,T)=>{const L=(K,q)=>{const Q={...z,[K]:q};$(Q);const Y=O(o||"",Q);y(Y)},V=r.jsxs("div",{"data-test":"create-session-content",className:"content-wrapper p-4 space-y-4",children:[r.jsxs("div",{"data-test":"create-session-project-selector-section",className:"project-selector-container mb-4",children:[r.jsxs("div",{"data-test":"create-session-header",className:"flex items-center justify-between",children:[r.jsx("label",{"data-test":"create-session-project-label",className:"project-selector-label text-sm font-medium block",children:"Select Project"}),r.jsx(T,{title:"Prompt Configuration",buttonClassName:"prompt-config-button",children:r.jsxs("div",{"data-test":"prompt-config-panel",className:"prompt-config-panel space-y-4",onClick:K=>K.stopPropagation(),children:[r.jsxs("div",{"data-test":"prompt-checkbox-1-container",className:"prompt-checkbox-container flex items-center space-x-2",children:[r.jsx(wt,{"data-test":"prompt-checkbox-1",id:"use-prompt-1",checked:z.usePrompt1,onCheckedChange:K=>L("usePrompt1",K===!0)}),r.jsx(le,{htmlFor:"use-prompt-1",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 1"})]}),r.jsx("div",{"data-test":"prompt-text-display-1",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:z.prompt1Text}),r.jsxs("div",{"data-test":"prompt-checkbox-2-container",className:"prompt-checkbox-container flex items-center space-x-2 mt-4",children:[r.jsx(wt,{"data-test":"prompt-checkbox-2",id:"use-prompt-2",checked:z.usePrompt2,onCheckedChange:K=>L("usePrompt2",K===!0)}),r.jsx(le,{htmlFor:"use-prompt-2",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Use Prompt 2"})]}),r.jsx("div",{"data-test":"prompt-text-display-2",className:"prompt-text-display text-xs text-muted-foreground p-2 bg-muted rounded",children:z.prompt2Text})]})})]}),r.jsx(Mo,{"data-test":"create-session-project-selector",variant:"select",className:"project-selector w-full"})]}),r.jsxs("div",{"data-test":"create-session-message-container",className:"new-session-input-container space-y-3",children:[r.jsx(_t,{"data-test":"create-session-textarea",value:w,onChange:K=>y(K.target.value),placeholder:"Type your message...",rows:10,className:"resize-y"}),r.jsx("div",{"data-test":"create-session-actions",className:"flex justify-end gap-2 items-center",children:r.jsx(gc,{variant:"outline",size:"sm",buttonLabel:"Options",className:"session-options-button","data-test":"create-session-options-button",children:K=>r.jsx(jr,{"data-test":"create-session-send-button",label:r.jsxs(r.Fragment,{children:[r.jsx(Ga,{className:"h-4 w-4 mr-2"}),v?"Creating Session...":"Create Session"]}),onAction:()=>{console.log("ðŸ‘† [ButtonCreateSession] ConfigurableButton onAction triggered",{messageLength:w.trim().length,sending:v,disabled:!w.trim()||v,timestamp:new Date().toISOString()}),P(K)},disabled:!w.trim()||v,variant:"default",configOptions:[{label:"Preview Request Body",value:"preview",onClick:()=>{W(K),S(!0)},icon:r.jsx($l,{className:"h-4 w-4"})}],showHint:!0,tooltipText:"Click to send, hold to preview request",ariaLabel:"Create Session button with preview option"})})}),N&&D&&r.jsx(ea,{open:N,onOpenChange:S,children:r.jsxs(ta,{className:"sm:max-w-[600px] max-h-[70vh] overflow-y-auto",children:[r.jsx(sa,{children:r.jsx(gs,{children:"Request Body Preview"})}),r.jsx("pre",{className:"request-preview-content bg-muted p-4 rounded-md text-xs font-mono overflow-x-auto whitespace-pre-wrap",children:JSON.stringify(A(D),null,2)}),r.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[r.jsx(ne,{variant:"outline",onClick:()=>S(!1),children:"Close"}),r.jsxs(ne,{onClick:()=>{S(!1),P(D)},children:[r.jsx(Ga,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})]});return r.jsxs(r.Fragment,{children:[r.jsx(ne,{ref:E,"data-test":"create-session-button",variant:s,size:e,disabled:a,className:t,title:i,onClick:k,children:n??r.jsx(co,{className:"h-4 w-4 hover:text-purple-500 transition-colors"})}),h?r.jsx(ea,{open:f,onOpenChange:b,children:r.jsxs(ta,{"data-test":"create-session-dialog",className:"sm:max-w-[700px] max-h-[80vh] overflow-y-auto",children:[r.jsx(sa,{children:r.jsx(gs,{children:"Create New Session"})}),V]})}):r.jsx(Nr,{"data-test":"create-session-popover",isVisible:f,onClose:M,title:"Create New Session",className:"max-h-[80vh]",shouldCloseManually:!0,resizable:!0,initialSize:_||{width:700,height:600},onSizeChange:U,triggerPosition:j,children:r.jsx("div",{className:"overflow-y-auto max-h-[calc(80vh-3rem)]",children:V})})]})}})}function ax({buttonLabel:s,icon:e=r.jsx(yr,{className:"h-5 w-5"}),variant:t="ghost",size:a="icon",buttonClassName:n="",contentClassName:o="",align:i="end",side:c="bottom",title:l="Audio Recorder"}){const[u,p]=d.useState(!1);return r.jsxs(Ge,{open:u,onOpenChange:p,"data-test":"audio-recorder-popover",children:[r.jsx(Xe,{asChild:!0,children:r.jsx(ne,{variant:t,size:a,className:`audio-recorder-button ${n}`,title:l,"data-test":"audio-recorder-trigger-button",children:s?r.jsxs(r.Fragment,{children:[e,s&&r.jsx("span",{className:"ml-2","data-test":"audio-recorder-button-label",children:s})]}):e})}),r.jsxs(We,{className:`audio-recorder-panel w-[400px] ${o}`,align:i,side:c,"data-test":"audio-recorder-popover-content",children:[l&&r.jsx("div",{className:"audio-panel-header pb-2 mb-2 border-b border-border","data-test":"audio-recorder-panel-header",children:r.jsx("h3",{className:"text-sm font-semibold","data-test":"audio-recorder-panel-title",children:l})}),r.jsx("div",{className:"audio-panel-content","data-test":"audio-recorder-panel-content",children:r.jsx(_t,{})})]})]})}const bc=ml,$r=d.forwardRef(({className:s,...e},t)=>r.jsx(Jn,{ref:t,className:R("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",s),...e}));$r.displayName=Jn.displayName;const ws=d.forwardRef(({className:s,...e},t)=>r.jsx(Qn,{ref:t,className:R("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",s),...e}));ws.displayName=Qn.displayName;const ys=d.forwardRef(({className:s,...e},t)=>r.jsx(Xn,{ref:t,className:R("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...e}));ys.displayName=Xn.displayName;var Ct=(s=>(s.LOW="low",s.MEDIUM="medium",s.HIGH="high",s.URGENT="urgent",s))(Ct||{}),_e=(s=>(s.FREEZER="freezer",s.BACKLOG="backlog",s.SELECTED="selected",s.DOING="doing",s.DONE="done",s.ARCHIVE="archive",s))(_e||{}),Tt=(s=>(s.PERSONAL="personal",s.WORK="work",s.SHOPPING="shopping",s.HEALTH="health",s.OTHER="other",s))(Tt||{});function vc({session:s,segmentsToStrip:e=3,onNameUpdated:t}){const[a,n]=d.useState(!1),[o,i]=d.useState(""),[c,l]=d.useState(!1),u=d.useRef(null),p=d.useMemo(()=>{const{name:m,cwd:w}=s;if(!m.startsWith("-home-"))return m;let g=m;const x=/\/[a-f0-9]{8}[a-f0-9-]*$/i;g=g.replace(x,""),g.startsWith("-")&&(g=g.substring(1));const j="/"+g.replace(/-/g,"/");w&&j.startsWith(w);const C=j.split("/").filter(Boolean);return e>0&&C.length>e?C.slice(e).join("/"):C.length===0?m:C.join("/")},[s,e]),h=s.customName||p;d.useEffect(()=>{a&&u.current&&(u.current.focus(),u.current.select())},[a]);const f=()=>{i(s.customName||""),n(!0)},b=async()=>{if(!c)try{l(!0);const m=o.trim()===""?null:o.trim();await nt.updateSessionName(s.id,m),t==null||t(),n(!1)}catch(m){console.error("Failed to update session name:",m),alert("Failed to update session name")}finally{l(!1)}},v=m=>{m.key==="Enter"?b():m.key==="Escape"&&n(!1)};return a?r.jsxs("div",{className:"session-name-edit flex items-center gap-2","data-test":"session-name-edit-container",children:[r.jsx("input",{ref:u,type:"text",value:o,onChange:m=>i(m.target.value),onKeyDown:v,onBlur:()=>n(!1),className:"flex-1 px-2 py-1 border rounded",placeholder:p,disabled:c,"data-test":"session-name-input"}),r.jsx("button",{onMouseDown:m=>{m.preventDefault(),b()},disabled:c,className:"session-name-save-btn p-1 hover:bg-gray-100 rounded",title:"Save (Enter)","data-test":"session-name-save-button",children:r.jsx(et,{className:"w-4 h-4"})})]}):r.jsx("span",{className:"session-name-display cursor-pointer hover:underline",onDoubleClick:f,title:"Double-click to edit","data-test":"session-name-display",children:h})}function rx({sessionIds:s=[],className:e="",title:t="Claude session is running",showCount:a=!1,lastActiveTime:n,isCreating:o=!1}){const[i,c]=d.useState({}),[l,u]=d.useState([]),p=d.useRef(s);d.useEffect(()=>{p.current=s},[s]),d.useEffect(()=>{var D,W,E;const N=((E=(W=(D=Z.get("app"))==null?void 0:D.claude)==null?void 0:W.data)==null?void 0:E.sessions)??[];u(N);const S=Z.selectSlice(I=>{var _,U,k;return(k=(U=(_=I.app)==null?void 0:_.claude)==null?void 0:U.data)==null?void 0:k.sessions}).subscribe(I=>{u(I??[])});return()=>S.unsubscribe()},[]);const h=d.useMemo(()=>{if(n!==void 0)return n;if(!s.length||!l.length)return;const N=l.filter(D=>s.includes(D.id));if(!N.length)return;const S=N.reduce((D,W)=>{const E=new Date(W.lastModified).getTime();return E>D?E:D},0);return S>0?S:void 0},[n,s,l]);d.useEffect(()=>{var I,_,U;const N=k=>{if(!k)return{};const M={};for(const O of p.current)k[O]&&(M[O]=k[O]);return M},S=(k,M)=>{const O=Object.keys(k),A=Object.keys(M);if(O.length!==A.length)return!0;for(const P of A)if(!k[P]||k[P].isOpened!==M[P].isOpened||k[P].isProcessing!==M[P].isProcessing)return!0;return!1},D=((U=(_=(I=Z.get("app"))==null?void 0:I.claude)==null?void 0:_.ui)==null?void 0:U.activity)??{},W=N(D);c(W);const E=Z.selectSlice(k=>{var M,O,A;return(A=(O=(M=k.app)==null?void 0:M.claude)==null?void 0:O.ui)==null?void 0:A.activity}).subscribe(k=>{const M=N(k);c(O=>S(O,M)?M:O)});return()=>E.unsubscribe()},[]);const f=d.useCallback(N=>{const S=i[N];if(S!=null&&S.isProcessing)return"running";if(S!=null&&S.isOpened&&!(S!=null&&S.isProcessing))return"opened";if(h){const D=Date.now()-36e5;if(h>D)return"recent"}return"inactive"},[i,h]),b=N=>{switch(N){case"running":return{status:"running",color:"bg-green-500",bgColor:"bg-green-500",textColor:"text-green-600"};case"opened":return{status:"opened",color:"bg-orange-500",bgColor:"bg-orange-500",textColor:"text-orange-600"};case"recent":return{status:"recent",color:"bg-yellow-500",bgColor:"bg-yellow-500",textColor:"text-yellow-600"};case"inactive":default:return{status:"inactive",color:"bg-gray-400",bgColor:"bg-gray-400",textColor:"text-gray-500"}}},v=d.useMemo(()=>s.map(N=>({id:N,status:f(N)})).filter(N=>N.status!=="inactive"),[s,f]),m=v.length>0,w=d.useMemo(()=>v.some(N=>N.status==="running")?"running":v.some(N=>N.status==="opened")?"opened":v.some(N=>N.status==="recent")?"recent":"inactive",[v]),y=b(w),g=d.useMemo(()=>{if(a&&v.length>1){const S={running:"running",opened:"opened",recent:"recently active",inactive:"inactive"}[w];return`${v.length} Claude sessions ${S}`}const N={running:"Claude session is running",opened:"Claude session is opened",recent:"Claude session recently active",inactive:"Claude session inactive"}[w];return t||N},[a,v.length,w,t]);if(!m&&!o)return null;const x=o?"running":w,j=o?b("running"):y,C=o?"Creating Claude session...":g;return r.jsxs("div",{className:`session-activity-indicator flex items-center gap-1 ${e}`,title:C,"data-test":"session-activity-indicator",children:[r.jsx("div",{className:`activity-dot w-2 h-2 ${j.bgColor} rounded-full ${x==="running"?"animate-pulse":""}`,"data-test":"activity-dot","data-activity-status":x,"data-is-creating":o}),a&&v.length>1&&r.jsx("span",{className:`activity-count text-xs ${j.textColor} font-medium`,"data-test":"activity-count",children:v.length})]})}function nx(s,e){if(s.className!==e.className||s.title!==e.title||s.showCount!==e.showCount||s.lastActiveTime!==e.lastActiveTime||s.isCreating!==e.isCreating)return!1;const t=s.sessionIds??[],a=e.sessionIds??[];return t.length!==a.length?!1:t.every((n,o)=>n===a[o])}const Ur=d.memo(rx,nx),wc=d.forwardRef(({searchQuery:s,onSearchChange:e,onAdvancedSearch:t,className:a},n)=>{const[o,i]=d.useState(!1),[c,l]=d.useState({sortOrder:"desc",pageSize:50}),u=d.useMemo(()=>{const{sortOrder:m,pageSize:w,...y}=c;return Object.values(y).some(j=>j!==void 0)||m!=="desc"},[c]),p=(m,w)=>{l(y=>({...y,[m]:w}))},h=()=>{t&&t(s,c),i(!1)},f=()=>{l({sortOrder:"desc",pageSize:50})},b=m=>{m.key==="Enter"&&t&&t(s,c)},v=()=>{e("")};return r.jsx("div",{ref:n,className:R("messages-search-container relative",a),"data-test":"messages-search-container",children:r.jsxs("div",{className:"search-input-wrapper relative flex items-center gap-1","data-test":"messages-search-input-wrapper",children:[r.jsx(ba,{className:"search-icon absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none z-10","data-test":"messages-search-icon"}),r.jsx(Je,{type:"text",placeholder:"Search messages...",value:s,onChange:m=>e(m.target.value),onKeyDown:b,className:R("search-input pl-9",s?"pr-16":"pr-10"),"data-test":"messages-search-input"}),s&&r.jsx(ne,{variant:"ghost",size:"icon",onClick:v,className:"clear-button absolute right-9 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"messages-search-clear-button",children:r.jsx(rt,{className:"h-4 w-4"})}),u&&r.jsx("div",{className:R("filter-indicator absolute top-1/2 -translate-y-1/2 h-2 w-2 rounded-full bg-primary pointer-events-none z-10",s?"right-17":"right-11"),"data-test":"messages-search-filter-indicator"}),r.jsxs(Ge,{open:o,onOpenChange:i,children:[r.jsx(Xe,{asChild:!0,children:r.jsx(ne,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 shrink-0","aria-label":o?"Collapse advanced search":"Expand advanced search","data-test":"messages-search-expand-button",children:o?r.jsx(wr,{className:"h-4 w-4"}):r.jsx(ts,{className:"h-4 w-4"})})}),r.jsxs(We,{align:"start",className:"advanced-search-panel w-96 max-h-[600px] overflow-y-auto","data-test":"messages-advanced-search-panel",children:[r.jsxs("div",{className:"panel-header space-y-2 pb-3 border-b","data-test":"messages-panel-header",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),r.jsx(ne,{variant:"ghost",size:"sm",onClick:f,className:"h-7 text-xs","data-test":"messages-clear-filters-button",children:"Clear All"})]}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Search message content with filters"})]}),r.jsxs("div",{className:"panel-content space-y-4 py-4","data-test":"messages-panel-content",children:[r.jsxs("div",{className:"role-filter space-y-2",children:[r.jsx(le,{className:"text-sm font-medium",children:"Message Role"}),r.jsxs(It,{value:c.role||"all",onValueChange:m=>p("role",m==="all"?void 0:m),children:[r.jsx(jt,{className:"h-8",children:r.jsx(Rt,{})}),r.jsxs(Nt,{children:[r.jsx(we,{value:"all",children:"All Messages"}),r.jsx(we,{value:"user",children:"User"}),r.jsx(we,{value:"assistant",children:"Assistant"})]})]})]}),r.jsxs("div",{className:"timestamp-range-filter space-y-2",children:[r.jsx(le,{className:"text-sm font-medium",children:"Timestamp Range"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"timestamp-input-wrapper",children:[r.jsx(le,{htmlFor:"timestamp-after",className:"text-xs text-muted-foreground",children:"After"}),r.jsx(Je,{id:"timestamp-after",type:"datetime-local",value:c.after??"",onChange:m=>p("after",m.target.value||void 0),className:"h-8"})]}),r.jsxs("div",{className:"timestamp-input-wrapper",children:[r.jsx(le,{htmlFor:"timestamp-before",className:"text-xs text-muted-foreground",children:"Before"}),r.jsx(Je,{id:"timestamp-before",type:"datetime-local",value:c.before??"",onChange:m=>p("before",m.target.value||void 0),className:"h-8"})]})]})]}),r.jsxs("div",{className:"sorting-section space-y-2",children:[r.jsx(le,{className:"text-sm font-medium",children:"Sort By Timestamp"}),r.jsxs(It,{value:c.sortOrder,onValueChange:m=>p("sortOrder",m),children:[r.jsx(jt,{className:"h-8",children:r.jsx(Rt,{})}),r.jsxs(Nt,{children:[r.jsx(we,{value:"desc",children:"Newest First"}),r.jsx(we,{value:"asc",children:"Oldest First"})]})]})]}),r.jsxs("div",{className:"pagination-section space-y-2",children:[r.jsx(le,{className:"text-sm font-medium",children:"Results Per Page"}),r.jsx(Je,{type:"number",min:"1",max:"100",value:c.pageSize??50,onChange:m=>p("pageSize",m.target.value?parseInt(m.target.value):50),className:"h-8"})]})]}),r.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 border-t","data-test":"messages-panel-footer",children:[r.jsx(ne,{onClick:h,className:"flex-1",size:"sm","data-test":"messages-apply-search-button",children:"Apply Search"}),r.jsx(ne,{onClick:()=>i(!1),variant:"outline",size:"sm","data-test":"messages-cancel-button",children:"Cancel"})]})]})]})]})})});wc.displayName="MessagesSearch";const yc=s=>typeof s=="string"?r.jsx("span",{"data-test":"message-content-text",children:s}):Array.isArray(s)?s.map((e,t)=>typeof e=="string"?r.jsx("div",{className:"max-w-full break-words","data-test":"message-content-block-string",children:e},t):typeof e=="object"&&e.type==="text"&&"text"in e?r.jsx("div",{className:"max-w-full break-words","data-test":"message-content-block-text",children:e.text},t):typeof e=="object"&&e.type==="tool_use"?r.jsx("div",{className:"tool-use bg-muted-foreground/10 p-2 rounded mt-1 max-w-full overflow-hidden","data-test":"message-content-block-tool-use",children:r.jsxs("div",{className:"text-xs font-mono truncate","data-test":"tool-use-name",children:["Tool: ","name"in e?e.name??"Unknown":"Unknown"]})},t):r.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded mt-1 overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-block-json",children:JSON.stringify(e,null,2)},t)):typeof s=="object"&&s!==null?s.text?r.jsx("span",{"data-test":"message-content-object-text",children:s.text}):s.content?r.jsx("div",{"data-test":"message-content-recursive",children:yc(s.content)}):r.jsx("pre",{className:"text-xs bg-muted-foreground/10 p-2 rounded overflow-x-auto max-w-full whitespace-pre-wrap break-words","data-test":"message-content-object-json",children:JSON.stringify(s,null,2)}):r.jsx("span",{"data-test":"message-content-fallback",children:String(s)}),hr=d.memo(({message:s,formatTime:e})=>{const[t,a]=d.useState(!1),n=i=>typeof i=="string"?i:Array.isArray(i)?i.map(c=>typeof c=="string"?c:typeof c=="object"&&c.type==="text"&&"text"in c?c.text:"").filter(Boolean).join(`
`):typeof i=="object"&&i!==null?i.text?i.text:i.content?n(i.content):JSON.stringify(i,null,2):String(i),o=async i=>{i.stopPropagation();const c=n(s.content);try{await navigator.clipboard.writeText(c),a(!0),setTimeout(()=>a(!1),2e3)}catch(l){console.error("Failed to copy message:",l)}};return r.jsx("div",{className:`message-item flex w-full ${s.role==="user"?"justify-end":"justify-start"}`,"data-test":`message-item-wrapper-${s.role}`,"data-test-message-id":s.id,children:r.jsxs("div",{onClick:()=>{console.log("Message clicked:",s)},className:`message-bubble max-w-[85%] rounded-lg p-3 overflow-hidden cursor-pointer ${s.role==="user"?"bg-primary text-primary-foreground":"bg-muted"}`,"data-test":`message-bubble-${s.role}`,children:[r.jsxs("div",{className:"message-header mb-2 flex items-center gap-2","data-test":"message-header",children:[r.jsx("span",{className:`message-role text-xs font-semibold uppercase ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":`message-role-label-${s.role}`,children:s.role}),r.jsxs("span",{className:`message-id text-xs font-mono ${s.role==="user"?"text-primary-foreground/60":"text-muted-foreground/70"}`,"data-test":"message-id-label",children:["ID: ",s.id]})]}),r.jsx("div",{className:"message-content text-sm whitespace-pre-wrap break-words overflow-wrap-anywhere word-break max-w-full","data-test":"message-content",children:yc(s.content)}),s.toolCalls&&s.toolCalls.length>0&&r.jsxs("div",{className:"message-tool-calls mt-2 space-y-1","data-test":"message-tool-calls",children:[r.jsx("div",{className:`text-xs font-semibold ${s.role==="user"?"text-primary-foreground/80":"text-muted-foreground"}`,"data-test":"message-tool-calls-label",children:"Tool Calls:"}),s.toolCalls.map((i,c)=>r.jsx("div",{className:`tool-call-item p-2 rounded text-xs font-mono ${s.role==="user"?"bg-primary-foreground/10":"bg-muted-foreground/10"}`,"data-test":`tool-call-item-${c}`,children:r.jsx("pre",{className:"whitespace-pre-wrap break-words max-w-full","data-test":"tool-call-json",children:JSON.stringify(i,null,2)})},c))]}),r.jsxs("div",{className:"message-footer flex items-center justify-between mt-2 gap-2","data-test":"message-footer",children:[r.jsx("div",{className:`message-time text-xs max-w-full ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"message-timestamp",children:e(s.timestamp)}),r.jsx("button",{onClick:o,className:`copy-button p-1 rounded hover:bg-opacity-20 transition-colors ${s.role==="user"?"hover:bg-primary-foreground":"hover:bg-foreground"}`,title:"Copy message","data-test":"copy-message-button",children:t?r.jsx(et,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground":"text-muted-foreground"}`,"data-test":"copy-success-icon"}):r.jsx(lo,{className:`h-3 w-3 ${s.role==="user"?"text-primary-foreground/70":"text-muted-foreground"}`,"data-test":"copy-icon"})})]})]})},s.id)});hr.displayName="MessageItem";function ox({messages:s,sessionDetails:e,metadata:t,loading:a,pagination:n,onLoadOlder:o,onSearch:i,onNameUpdated:c}){var W,E,I;const l=d.useRef(null),u=d.useRef(null),p=d.useRef(0),h=d.useRef(null),f=d.useRef(0),[b,v]=d.useState(""),[m,w]=d.useState(!1);d.useEffect(()=>{const _=(e==null?void 0:e.name)??null;h.current!==_&&(p.current=0,h.current=_)},[e==null?void 0:e.name]);const y=d.useCallback(_=>new Date(_).toLocaleTimeString(),[]),g=d.useCallback(_=>{const U=new Date(_);return U.toLocaleDateString()+" "+U.toLocaleTimeString()},[]),[x,j]=d.useState(((I=(E=(W=Z.getState().app)==null?void 0:W.claude)==null?void 0:E.ui)==null?void 0:I.messageFilters)??["user","assistant","thinking","tools"]);d.useEffect(()=>{var k,M,O,A,P,z;((O=(M=(k=Z.getState().app)==null?void 0:k.claude)==null?void 0:M.ui)==null?void 0:O.messageFilters)||Z.update("app",{claude:{...(A=Z.getState().app)==null?void 0:A.claude,ui:{...(z=(P=Z.getState().app)==null?void 0:P.claude)==null?void 0:z.ui,messageFilters:["user","assistant","thinking","tools"]}}});const U=Z.selectSlice($=>{var T,L,V;return(V=(L=(T=$.app)==null?void 0:T.claude)==null?void 0:L.ui)==null?void 0:V.messageFilters}).subscribe($=>{$&&j($)});return()=>U.unsubscribe()},[]);const C=_=>{var O,A,P,z,$,T;const U=((P=(A=(O=Z.getState().app)==null?void 0:O.claude)==null?void 0:A.ui)==null?void 0:P.messageFilters)??x,k=U.includes(_)?U.filter(L=>L!==_):[...U,_],M=Z.getState();Z.setState({...M,app:{...M.app,claude:{...(z=M.app)==null?void 0:z.claude,ui:{...(T=($=M.app)==null?void 0:$.claude)==null?void 0:T.ui,messageFilters:k}}}})},N=(_,U)=>{i&&i(_,U)},S=d.useMemo(()=>s.filter(U=>!U.content||U.content===""?!1:Array.isArray(U.content)&&U.content.some(M=>typeof M=="object"&&(M.type==="tool_use"||M.type==="tool_result"))?x.includes("tools"):!!(U.role==="user"&&x.includes("user")||U.role==="assistant"&&x.includes("assistant"))).reverse(),[s,x]);d.useLayoutEffect(()=>{const _=p.current===0&&S.length>0,U=S.length>p.current&&p.current>0;if(l.current){const k=l.current.querySelector("[data-radix-scroll-area-viewport]");if(_&&k)k.scrollTop=k.scrollHeight,f.current=k.scrollHeight,p.current=S.length;else if(U&&k){const M=k.scrollHeight,O=M-f.current;k.scrollTop=k.scrollTop+O,f.current=M,p.current=S.length}}},[S]),d.useEffect(()=>{if(p.current!==0&&l.current){const _=l.current.querySelector("[data-radix-scroll-area-viewport]");_&&setTimeout(()=>{_.scrollTo({top:_.scrollHeight,behavior:"smooth"})},50)}},[S]),d.useEffect(()=>{if(m&&u.current){const _=u.current.querySelector("[data-radix-scroll-area-viewport]");_&&setTimeout(()=>{_.scrollTo({top:_.scrollHeight,behavior:"auto"})},100)}},[m]);const D=d.useCallback((_=!0)=>{if(u.current){const U=u.current.querySelector("[data-radix-scroll-area-viewport]");U&&U.scrollTo({top:U.scrollHeight,behavior:_?"smooth":"auto"})}},[]);return r.jsxs(ks,{className:"chat-interface-card h-full flex flex-col overflow-hidden","data-test":"chat-interface-card",children:[r.jsxs(kr,{className:"chat-header pb-2 pt-4 flex-shrink-0","data-test":"chat-header",children:[r.jsxs("div",{className:"header-title-container flex items-center gap-2 text-sm","data-test":"header-title-container",children:[r.jsx(Ur,{sessionIds:e!=null&&e.id?[e.id]:[]}),r.jsx(Tr,{className:"text-base truncate","data-test":"chat-title",children:e?r.jsx(vc,{session:e,segmentsToStrip:3,onNameUpdated:c}):"New Conversation"}),t&&r.jsx(Qs,{children:r.jsxs(Xs,{children:[r.jsx(Ys,{asChild:!0,children:r.jsx("button",{className:"info-button p-1 hover:bg-muted rounded-sm transition-colors","data-test":"session-info-button",children:r.jsx(Js,{className:"h-4 w-4 text-muted-foreground"})})}),r.jsx(ms,{className:"metadata-tooltip","data-test":"session-metadata-tooltip",children:r.jsxs("div",{className:"metadata-section text-xs space-y-1","data-test":"metadata-section",children:[r.jsxs("div",{className:"metadata-item","data-test":"metadata-item-created",children:[r.jsx("span",{className:"font-medium",children:"Created:"})," ",g(t.created)]}),r.jsxs("div",{className:"metadata-item","data-test":"metadata-item-modified",children:[r.jsx("span",{className:"font-medium",children:"Last Modified:"})," ",g(t.lastModified)]}),r.jsxs("div",{className:"metadata-item","data-test":"metadata-item-message-count",children:[r.jsx("span",{className:"font-medium",children:"Messages:"})," ",t.messageCount]}),t.model&&r.jsxs("div",{className:"metadata-item","data-test":"metadata-item-model",children:[r.jsx("span",{className:"font-medium",children:"Model:"})," ",t.model]})]})})]})}),r.jsx(Qs,{children:r.jsxs(Xs,{children:[r.jsx(Ys,{asChild:!0,children:r.jsx("button",{className:"expand-button p-1 hover:bg-muted rounded-sm transition-colors",onClick:()=>w(!0),"data-test":"expand-chat-button",children:r.jsx(Ul,{className:"h-4 w-4 text-muted-foreground"})})}),r.jsx(ms,{children:r.jsx("p",{children:"Expand chat view"})})]})}),r.jsx(wa,{storageKey:"chat-interface-config",title:"Chat Configuration",contentClassName:"chat-config-panel w-64",children:r.jsxs("div",{className:"config-content space-y-4","data-test":"chat-config-content",children:[r.jsxs("div",{className:"project-selector-section space-y-2","data-test":"project-selector-section",children:[r.jsx("div",{className:"section-label text-sm font-medium",children:"Project"}),r.jsx(Mo,{variant:"select",className:"w-full"})]}),r.jsxs("div",{className:"filters-section space-y-2","data-test":"message-filters-section",children:[r.jsx("div",{className:"section-label text-sm font-medium",children:"Show messages"}),r.jsxs("div",{className:"filter-options space-y-2","data-test":"filter-options",children:[r.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-user",children:[r.jsx(wt,{id:"filter-user",checked:x.includes("user"),onCheckedChange:()=>C("user"),"data-test":"filter-checkbox-user"}),r.jsx(le,{htmlFor:"filter-user",className:"text-sm cursor-pointer",children:"User"})]}),r.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-assistant",children:[r.jsx(wt,{id:"filter-assistant",checked:x.includes("assistant"),onCheckedChange:()=>C("assistant"),"data-test":"filter-checkbox-assistant"}),r.jsx(le,{htmlFor:"filter-assistant",className:"text-sm cursor-pointer",children:"Assistant"})]}),r.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-thinking",children:[r.jsx(wt,{id:"filter-thinking",checked:x.includes("thinking"),onCheckedChange:()=>C("thinking"),"data-test":"filter-checkbox-thinking"}),r.jsx(le,{htmlFor:"filter-thinking",className:"text-sm cursor-pointer",children:"Thinking"})]}),r.jsxs("div",{className:"filter-option flex items-center space-x-2","data-test":"filter-option-tools",children:[r.jsx(wt,{id:"filter-tools",checked:x.includes("tools"),onCheckedChange:()=>C("tools"),"data-test":"filter-checkbox-tools"}),r.jsx(le,{htmlFor:"filter-tools",className:"text-sm cursor-pointer",children:"Tools"})]})]})]})]})})]}),i&&r.jsx(wc,{searchQuery:b,onSearchChange:v,onAdvancedSearch:N,className:"mt-3"})]}),r.jsx(Ts,{className:"chat-content flex-1 min-h-0 overflow-hidden p-0","data-test":"chat-content",children:r.jsx(pa,{ref:l,className:"chat-scroll-area h-full w-full","data-test":"chat-scroll-area",children:r.jsxs("div",{className:"messages-container space-y-4 px-4 pt-2 w-full","data-test":"messages-container",children:[o&&n&&r.jsx("div",{className:"load-older-container flex justify-center pb-4 pt-2","data-test":"load-older-container",children:r.jsxs(ne,{variant:"outline",size:"sm",onClick:o,disabled:a,className:"load-older-button","data-test":"load-older-button",children:[r.jsx(ts,{className:"h-4 w-4 mr-2 rotate-180"}),"Load Older Messages",n&&r.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["(",s.length," of ",n.totalCount,")"]})]})}),a&&S.length===0?r.jsx("div",{className:"loading-message text-sm text-muted-foreground","data-test":"loading-message",children:"Loading messages..."}):S.length===0?r.jsxs("div",{className:"empty-state text-center mt-8","data-test":"empty-state",children:[r.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"New Session"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Type your first message below to start the conversation"})]}):S.map(_=>r.jsx(hr,{message:_,formatTime:y,"data-test":`message-item-${_.id}`},_.id))]})})}),r.jsx(Nr,{isVisible:m,onClose:()=>w(!1),title:e?typeof e.customName=="string"?e.customName:e.name:"Chat Messages",shouldCloseManually:!0,resizable:!0,initialSize:{width:1e3,height:700},initialPosition:{x:100,y:50},children:r.jsxs("div",{className:"expanded-chat-content flex flex-col flex-1 overflow-hidden","data-test":"expanded-chat-view",children:[r.jsxs("div",{className:"expanded-controls-header flex items-center justify-between gap-4 px-4 py-2 border-b border-border flex-shrink-0","data-test":"expanded-controls-header",children:[r.jsxs("div",{className:"filter-controls flex items-center gap-3","data-test":"expanded-filter-controls",children:[r.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Show:"}),r.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[r.jsx(wt,{id:"expanded-filter-user",checked:x.includes("user"),onCheckedChange:()=>C("user"),"data-test":"expanded-filter-checkbox-user"}),r.jsx(le,{htmlFor:"expanded-filter-user",className:"text-xs cursor-pointer",children:"User"})]}),r.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[r.jsx(wt,{id:"expanded-filter-assistant",checked:x.includes("assistant"),onCheckedChange:()=>C("assistant"),"data-test":"expanded-filter-checkbox-assistant"}),r.jsx(le,{htmlFor:"expanded-filter-assistant",className:"text-xs cursor-pointer",children:"Assistant"})]}),r.jsxs("div",{className:"filter-option flex items-center gap-1.5",children:[r.jsx(wt,{id:"expanded-filter-tools",checked:x.includes("tools"),onCheckedChange:()=>C("tools"),"data-test":"expanded-filter-checkbox-tools"}),r.jsx(le,{htmlFor:"expanded-filter-tools",className:"text-xs cursor-pointer",children:"Tools"})]})]}),r.jsxs(ne,{variant:"outline",size:"sm",onClick:()=>D(!0),className:"scroll-to-bottom-button flex items-center gap-1.5 h-7 text-xs","data-test":"scroll-to-bottom-button",title:"Scroll to latest message",children:[r.jsx(Fl,{className:"h-3 w-3"}),"Latest"]})]}),r.jsx("div",{className:"flex-1 min-h-0 p-4 pt-2",children:r.jsx(pa,{className:"h-full",ref:u,children:r.jsx("div",{className:"messages-container-expanded space-y-4 pr-4",children:S.length===0?r.jsxs("div",{className:"empty-state text-center mt-8","data-test":"expanded-empty-state",children:[r.jsx("p",{className:"text-lg font-medium text-muted-foreground mb-2",children:"No Messages"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"This session has no messages yet"})]}):S.map(_=>r.jsx(hr,{message:_,formatTime:y,"data-test":`expanded-message-item-${_.id}`},_.id))})})})]})})]})}function Sc({sessionId:s,message:e,onBeforeSend:t,onSendSuccess:a,onSendError:n,outputFormat:o="text",permissionMode:i="acceptEdits",variant:c="ghost",size:l="icon",className:u="",title:p="Send to Claude session",disabled:h,...f}){const[b,v]=d.useState(!1);d.useEffect(()=>{v(!1)},[s]);const m=d.useCallback(async()=>{if(e.trim()){t==null||t();try{v(!0),await nt.sendMessage({message:e.trim(),sessionId:s,options:{outputFormat:o,permissionMode:i}}),console.log(`Sent message to Claude session ${s}: ${e}`),a==null||a()}catch(w){console.error("Failed to send message to Claude:",w),n==null||n(w)}finally{v(!1)}}},[e,s,o,i,b,t,a,n]);return r.jsx(ne,{variant:c,size:l,onClick:m,className:u,title:p,disabled:h||!e.trim(),"data-test":"claude-send-button","data-test-sending":b?"true":"false",...f,children:b?r.jsx(va,{className:"h-3 w-3 animate-spin loading-indicator","data-test":"send-button-loading"}):r.jsx(Ga,{className:"h-3 w-3","data-test":"send-button-icon"})})}function ix({sessionId:s,initialMessage:e="",rows:t=3,value:a,onChange:n,onSendSuccess:o,onSendError:i}){const[c,l]=d.useState(e),u=d.useRef(null),p=a??c,h=n??l;d.useEffect(()=>{var y,g,x;const m=(x=(g=(y=Z.getState().app)==null?void 0:y.claude)==null?void 0:g.ui)==null?void 0:x.messageDrafts,w=m==null?void 0:m[s];l(w||"")},[s]),d.useEffect(()=>{var m,w,y,g,x,j;if(!a){const N={...((y=(w=(m=Z.getState().app)==null?void 0:m.claude)==null?void 0:w.ui)==null?void 0:y.messageDrafts)||{}};c.trim()?N[s]=c:delete N[s],Z.updateState({app:{...Z.getState().app,claude:{...(g=Z.getState().app)==null?void 0:g.claude,ui:{...(j=(x=Z.getState().app)==null?void 0:x.claude)==null?void 0:j.ui,messageDrafts:N}}}})}},[c,s,a]);const f=()=>{var g,x,j,C,N,S,D;h("");const m=(g=u.current)==null?void 0:g.getTextArea();m&&(m.value="",m.dispatchEvent(new Event("input",{bubbles:!0})));const y={...((C=(j=(x=Z.getState().app)==null?void 0:x.claude)==null?void 0:j.ui)==null?void 0:C.messageDrafts)||{}};delete y[s],Z.updateState({app:{...Z.getState().app,claude:{...(N=Z.getState().app)==null?void 0:N.claude,ui:{...(D=(S=Z.getState().app)==null?void 0:S.claude)==null?void 0:D.ui,messageDrafts:y}}}})},b=()=>{o==null||o()},v=m=>{var w;m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),(w=document.querySelector(".claude-send-button"))==null||w.click())};return r.jsx("div",{className:"message-input-container","data-test":"message-input-container",children:r.jsxs("div",{className:"message-input-area flex gap-2","data-test":"message-input-area",children:[r.jsx(_t,{ref:u,value:p,onChange:m=>h(m.target.value),onKeyDown:v,placeholder:"Type your message... (Shift+Enter for new line, @ to insert file path)",className:"message-textarea resize-y flex-1",showBuiltInPopover:!1,rows:t,"data-test":"message-textarea"}),r.jsx("div",{className:"send-controls flex flex-col gap-2","data-test":"send-controls",children:r.jsx(gc,{variant:"ghost",size:"icon",buttonLabel:"",children:m=>r.jsx(Sc,{sessionId:s,message:p,outputFormat:m.outputFormat,permissionMode:m.permissionMode,className:"claude-send-button send-button",size:"icon",onBeforeSend:f,onSendSuccess:b,onSendError:i})})})]})})}function cx(s){const e=new Date,t=new Date(s),a=e.getTime()-t.getTime(),n=Math.floor(a/(1e3*60)),o=Math.floor(a/(1e3*60*60)),i=Math.floor(a/(1e3*60*60*24)),c=Math.floor(i/7),l=Math.floor(i/365);return n<1?"just now":n<60?`${n} min ago`:o<24?`${o} ${o===1?"hour":"hours"} ago`:i<7?`${i} ${i===1?"day":"days"} ago`:c<52?`${c} ${c===1?"week":"weeks"} ago`:`${l} ${l===1?"year":"years"} ago`}function Cc({session:s,isSelected:e,onClick:t,formatDate:a,formatCwd:n,segmentsToStrip:o=3,onNameUpdated:i,compact:c=!1}){return r.jsxs("div",{"data-test":"session-list-item",onClick:()=>{console.log("Session selected:",s),t()},className:`session-item ${c?"p-1.5":"p-3"} rounded-lg border cursor-pointer transition-colors ${e?"bg-primary/10 border-primary":"hover:bg-accent"}`,children:[r.jsx("div",{"data-test":"session-cwd",className:"session-cwd text-xs text-muted-foreground truncate",children:n(s.cwd)}),r.jsxs("div",{"data-test":"session-name-container",className:`session-name-container ${c?"font-medium text-sm":"font-bold text-base"} break-words line-clamp-2 ${c?"":"mt-1"} flex items-center gap-2`,children:[r.jsx(Ur,{sessionIds:[s.id]}),r.jsx(vc,{session:s,segmentsToStrip:o,onNameUpdated:i})]}),s.firstMessage&&!c&&r.jsx("div",{"data-test":"session-first-message",className:"session-first-message text-sm text-muted-foreground truncate mt-1",children:s.firstMessage}),r.jsxs("div",{"data-test":"session-meta",className:`session-meta text-xs text-muted-foreground flex items-center gap-2 ${c?"mt-0.5":"mt-1"}`,children:[r.jsxs("span",{children:[s.messageCount," messages"]}),r.jsx("span",{children:"â€¢"}),r.jsx("span",{children:cx(s.lastModified)}),r.jsx("span",{children:"â€¢"}),r.jsx("span",{children:a(s.lastModified)})]})]})}const lx=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.sessions)??[]},dx=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.loadingSessions)??!1};function jc({value:s,onChange:e,className:t="",placeholder:a="Select a session",label:n="Claude Session",showLabel:o=!0,multiSelect:i=!1}){const[c,l]=d.useState(!1),u=Ae(lx),p=Ae(dx),h=Array.isArray(s)?s:s?[s]:[],f=d.useMemo(()=>[...u].sort((y,g)=>{const x=new Date(y.lastModified).getTime();return new Date(g.lastModified).getTime()-x}),[u]),b=f.filter(y=>h.includes(y.id)),v=y=>new Date(y).toLocaleDateString(),m=y=>y?y.split("/").slice(-2).join("/"):"No directory",w=y=>{if(i){const g=h.includes(y)?h.filter(x=>x!==y):[...h,y];e(g)}else e(y===s?"":y),l(!1)};return r.jsxs("div",{"data-test":"session-selector",className:`session-selector-container ${t}`,children:[o&&r.jsx(le,{"data-test":"session-selector-label",className:"session-selector-label",children:n}),r.jsxs(Ge,{open:c,onOpenChange:l,children:[r.jsx(Xe,{asChild:!0,children:r.jsxs(ne,{"data-test":"session-selector-trigger",variant:"outline",role:"combobox","aria-expanded":c,className:"session-selector-trigger w-full justify-between",disabled:p,children:[b.length>0?r.jsx("span",{className:"truncate",children:i?`${b.length} session${b.length>1?"s":""} selected`:b[0].customName||b[0].name}):r.jsx("span",{className:"text-muted-foreground",children:a}),r.jsx(oo,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),r.jsx(We,{"data-test":"session-selector-content",className:"session-selector-content w-[400px] p-0",children:r.jsxs(ya,{children:[r.jsx(Sa,{"data-test":"session-selector-search",placeholder:"Search sessions..."}),r.jsxs(Ns,{className:"max-h-[300px]",children:[r.jsx(Es,{children:"No sessions found."}),r.jsxs(Xt,{children:[!i&&r.jsxs(Dt,{"data-test":"session-selector-item-none",value:"none",onSelect:()=>{e(""),l(!1)},className:"session-selector-item-none",children:[r.jsx(et,{className:R("mr-2 h-4 w-4",h.length===0?"opacity-100":"opacity-0")}),"No Session"]}),f.map(y=>r.jsx(Dt,{"data-test":`session-selector-item-${y.id}`,value:y.id,onSelect:()=>w(y.id),className:"session-selector-item p-0 cursor-pointer",children:r.jsxs("div",{className:"flex items-center w-full",children:[r.jsx(et,{className:R("mr-2 h-4 w-4 shrink-0",h.includes(y.id)?"opacity-100":"opacity-0")}),r.jsx("div",{className:"flex-1 min-w-0",children:r.jsx(Cc,{session:y,isSelected:h.includes(y.id),onClick:()=>{},formatDate:v,formatCwd:m,compact:!0})})]})},y.id))]}),f.length===0&&!p&&r.jsx("div",{"data-test":"session-selector-no-sessions",className:"no-sessions text-center py-4 text-sm text-muted-foreground",children:"No sessions available"}),p&&r.jsx("div",{"data-test":"session-selector-loading",className:"loading-sessions text-center py-4 text-sm text-muted-foreground",children:"Loading sessions..."})]})]})})]})]})}const ux=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.sessions)??[]};function px({sessionIds:s,currentIndex:e,onIndexChange:t,disabled:a=!1,className:n=""}){const[o,i]=d.useState(!1),[c,l]=d.useState(""),u=Ae(ux),p=d.useMemo(()=>s.map(g=>u.find(x=>x.id===g)).filter(g=>g!==void 0),[s,u]),h=p[e],f=p.filter(g=>(g.customName??g.name).toLowerCase().includes(c.toLowerCase())),b=g=>{t(g),i(!1),l("")},v=g=>{if(g.stopPropagation(),a||p.length===0)return;const x=e-1,j=x<0?p.length-1:x;t(j)},m=g=>{if(g.stopPropagation(),a||p.length===0)return;const x=e+1,j=x>=p.length?0:x;t(j)},w=g=>new Date(g).toLocaleDateString(),y=g=>g?g.split("/").slice(-2).join("/"):"No directory";return p.length===0?null:p.length===1?r.jsx(tt,{variant:"outline",className:R("navigable-session-badge bg-purple-50 text-purple-800 border-purple-200",a&&"opacity-50 cursor-not-allowed",n),"data-test":"navigable-session-badge-single",children:(h==null?void 0:h.customName)??(h==null?void 0:h.name)??"Session"}):r.jsxs("div",{className:R("navigable-session-selector flex items-center gap-1",n),"data-test":"navigable-session-selector",children:[r.jsx("button",{onClick:v,disabled:a,className:R("chevron-left p-1 rounded hover:bg-accent transition-colors",a&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous session","data-test":"navigable-session-previous-button",children:r.jsx(js,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),r.jsxs(Ge,{open:o,onOpenChange:i,children:[r.jsx(Xe,{asChild:!0,children:r.jsxs(tt,{variant:"outline",className:R("navigable-badge cursor-pointer hover:opacity-80 transition-opacity bg-purple-50 text-purple-800 border-purple-200",a&&"opacity-50 cursor-not-allowed"),onClick:g=>{g.stopPropagation(),a&&g.preventDefault()},"data-test":"navigable-session-badge",children:[(h==null?void 0:h.customName)??(h==null?void 0:h.name)??"Session"," (",e+1,"/",p.length,")"]})}),r.jsx(We,{className:"popover-content w-[400px] p-2",align:"start","data-test":"navigable-session-popover-content",children:r.jsxs("div",{className:"selector-container space-y-2","data-test":"navigable-session-selector-container",children:[r.jsx(Je,{placeholder:"Search sessions...",value:c,onChange:g=>l(g.target.value),className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"navigable-session-search-input"}),r.jsx("div",{className:"sessions-list max-h-64 overflow-y-auto space-y-1","data-test":"navigable-session-list",children:f.length===0?r.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"navigable-session-empty-state",children:"No sessions found"}):f.map(g=>{const x=p.indexOf(g);return r.jsxs(ne,{variant:"ghost",className:R("session-item w-full justify-between h-auto px-2 py-1",x===e&&"bg-accent"),onClick:()=>b(x),"data-test":`navigable-session-item-${g.id}`,children:[r.jsx("div",{className:"flex-1 min-w-0",children:r.jsx(Cc,{session:g,isSelected:x===e,onClick:()=>{},formatDate:w,formatCwd:y,compact:!0})}),x===e&&r.jsx(et,{className:"check-icon h-4 w-4 ml-2 shrink-0","data-test":"navigable-session-check-icon"})]},g.id)})})]})})]}),r.jsx("button",{onClick:m,disabled:a,className:R("chevron-right p-1 rounded hover:bg-accent transition-colors",a&&"opacity-50 cursor-not-allowed"),"aria-label":"Next session","data-test":"navigable-session-next-button",children:r.jsx(Ht,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]})}function hx(s,e={}){const{loadOnMount:t=!0,subscribeToSSE:a=!0,pageSize:n=50,messageType:o,onSessionDeleted:i}=e,[c,l]=d.useState([]),[u,p]=d.useState(null),[h,f]=d.useState(null),[b,v]=d.useState(!1),[m,w]=d.useState(null),[y,g]=d.useState(1),[x,j]=d.useState(""),[C,N]=d.useState(null),[S,D]=d.useState(!1),W=d.useRef(),E=d.useCallback(async(k=1,M=!1,O=!1)=>{var A,P,z;if(s)try{O||v(!0),j(""),N(null),D(!1);const $=o??((z=(P=(A=Z.getState().app)==null?void 0:A.claude)==null?void 0:P.ui)==null?void 0:z.messageFilters),T=await nt.getSessionDetails(s,{page:k,pageSize:n,messageType:$});l(M?L=>[...T.messages,...L]:T.messages),p({id:s,name:T.name,customName:T.customName,cwd:T.cwd}),f(T.metadata),w(T.pagination??null),g(k)}catch($){console.error("Failed to load session details:",$),l([]),p(null),f(null),w(null)}finally{O||v(!1)}},[s,n,o]),I=d.useCallback(async(k,M,O=!1)=>{if(s)try{v(!0),j(k),N(M),D(!0);const A=await nt.searchSessionMessages(s,k,M);l(O?P=>[...A.results,...P]:A.results),w(A.pagination),g(A.pagination.page)}catch(A){O||l([]),console.error("Failed to search messages:",A)}finally{v(!1)}},[s]),_=d.useCallback(()=>{if(!(!s||!m||y>=m.totalPages))if(S&&x!==void 0){const k={...C,page:y+1};I(x,k,!0)}else E(y+1,!0)},[s,m,y,S,x,C,I,E]),U=d.useCallback(async()=>{s&&(S&&x!==void 0?await I(x,{...C,page:y}):await E(y))},[s,S,x,C,y,I,E]);return d.useEffect(()=>{l([]),p(null),f(null),w(null),g(1),j(""),N(null),D(!1),s&&t&&E(1)},[s,t]),d.useEffect(()=>{if(!s)return;const k=Z.selectSlice(M=>{var O,A,P;return(P=(A=(O=M.app)==null?void 0:O.claude)==null?void 0:A.ui)==null?void 0:P.messageFilters}).subscribe(M=>{if(JSON.stringify(W.current)!==JSON.stringify(M)&&(W.current=M,!o))if(S&&x!==void 0){const A={...C,messageType:M,page:1};I(x,A)}else E(1,!1,!0)});return()=>k.unsubscribe()},[s,o,S,x,C,I,E]),Sr(k=>{k.type!=="batch-modified"&&("sessionId"in k&&k.sessionId!==s||(k.type==="modified"&&(async()=>{var M,O,A;if(s)try{const P=o??((A=(O=(M=Z.getState().app)==null?void 0:M.claude)==null?void 0:O.ui)==null?void 0:A.messageFilters),z=await nt.getSessionDetails(s,{page:1,pageSize:n,messageType:P});l($=>{const T=new Set($.map(V=>V.id)),L=z.messages.filter(V=>!T.has(V.id));return L.length===0?$:[...$,...L]}),f(z.metadata)}catch(P){console.error("Failed to fetch new messages on SSE update:",P)}})(),k.type==="deleted"&&(l([]),p(null),f(null),w(null),i==null||i())))},k=>{console.error("SSE connection error in useSessionMessages:",k)},!!s&&a),{messages:c,sessionDetails:u,metadata:h,loading:b,pagination:m,currentPage:y,isSearchActive:S,loadSessionDetails:E,loadOlderMessages:_,searchMessages:I,refreshSession:U}}function fx({value:s,options:e,onChange:t,placeholder:a="Search...",disabled:n=!1}){const[o,i]=d.useState(!1),[c,l]=d.useState(""),u=e.find(m=>m.value===s),p=e.findIndex(m=>m.value===s),h=e.filter(m=>m.label.toLowerCase().includes(c.toLowerCase())),f=m=>{t==null||t(m),i(!1),l("")},b=m=>{if(m.stopPropagation(),n)return;const w=p-1,y=w<0?e.length-1:w;t==null||t(e[y].value)},v=m=>{if(m.stopPropagation(),n)return;const w=p+1,y=w>=e.length?0:w;t==null||t(e[y].value)};return u?r.jsxs("div",{className:"navigable-select-container flex items-center gap-1",children:[r.jsx("button",{onClick:b,disabled:n,className:R("chevron-left p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Previous option",children:r.jsx(js,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})}),r.jsxs(Ge,{open:o,onOpenChange:i,children:[r.jsx(Xe,{asChild:!0,children:r.jsx(tt,{variant:u.variant||"secondary",className:R("navigable-badge cursor-pointer hover:opacity-80 transition-opacity",u.className,n&&"opacity-50 cursor-not-allowed"),onClick:m=>{m.stopPropagation(),n&&m.preventDefault()},children:u.label})}),r.jsx(We,{className:"popover-content w-64 p-2",align:"start",children:r.jsxs("div",{className:"selector-container space-y-2",children:[r.jsx(Je,{placeholder:a,value:c,onChange:m=>l(m.target.value),className:"search-input h-8 text-sm",autoFocus:!0}),r.jsx("div",{className:"options-list max-h-64 overflow-y-auto space-y-1",children:h.length===0?r.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4",children:"No options found"}):h.map(m=>r.jsxs(ne,{variant:"ghost",className:R("option-item w-full justify-between h-8 px-2",m.value===s&&"bg-accent"),onClick:()=>f(m.value),children:[r.jsx(tt,{variant:m.variant||"secondary",className:R("text-xs",m.className),children:m.label}),m.value===s&&r.jsx(et,{className:"check-icon h-4 w-4"})]},m.value))})]})})]}),r.jsx("button",{onClick:v,disabled:n,className:R("chevron-right p-1 rounded hover:bg-accent transition-colors",n&&"opacity-50 cursor-not-allowed"),"aria-label":"Next option",children:r.jsx(Ht,{className:"w-4 h-4 text-muted-foreground hover:text-foreground"})})]}):null}function us(){var s;try{const e=(s=Z.getState().app)==null?void 0:s.kanban;return e?{spaces:e.spaces??[],activeSpaceId:e.activeSpaceId??"all",customPresets:e.customPresets??[],activePresetId:e.activePresetId??"all",currentFilters:e.currentFilters??fr,customCategories:e.customCategories??[]}:null}catch(e){return console.error("Failed to load persisted Kanban state:",e),null}}function qs(s){var e;try{const t=Z.getState();Z.updateState({app:{...t.app,kanban:{...(e=t.app)==null?void 0:e.kanban,...s}}})}catch(t){console.error("Failed to save persisted Kanban state:",t)}}function mx(){try{const s=Z.getState();Z.updateState({app:{...s.app,kanban:void 0}})}catch(s){console.error("Failed to clear persisted Kanban state:",s)}}const tv={id:!0,title:!0,description:!0,status:!0,priority:!0,category:!0,space:!0,claudeProjectPath:!0,dueDate:!0,createdAt:!0,updatedAt:!0,completedAt:!0,tags:!0,subtasks:!0},fr={searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[_e.FREEZER,_e.BACKLOG,_e.SELECTED,_e.DOING,_e.DONE,_e.ARCHIVE]};function gx(s){return s&&s.version==="4.0"&&"todos"in s&&"spaces"in s}function xx(s){return{version:"4.0",exportedAt:new Date().toISOString(),...s,loading:!1,error:void 0}}const bx=[{value:Tt.PERSONAL,label:"Personal",variant:"secondary",className:"bg-purple-100 text-purple-800 border-purple-200"},{value:Tt.WORK,label:"Work",variant:"secondary",className:"bg-indigo-100 text-indigo-800 border-indigo-200"},{value:Tt.SHOPPING,label:"Shopping",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:Tt.HEALTH,label:"Health",variant:"secondary",className:"bg-pink-100 text-pink-800 border-pink-200"},{value:Tt.OTHER,label:"Other",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"}],Ba=["bg-red-100 text-red-800 border-red-200","bg-orange-100 text-orange-800 border-orange-200","bg-amber-100 text-amber-800 border-amber-200","bg-yellow-100 text-yellow-800 border-yellow-200","bg-lime-100 text-lime-800 border-lime-200","bg-emerald-100 text-emerald-800 border-emerald-200","bg-teal-100 text-teal-800 border-teal-200","bg-cyan-100 text-cyan-800 border-cyan-200","bg-sky-100 text-sky-800 border-sky-200","bg-blue-100 text-blue-800 border-blue-200","bg-violet-100 text-violet-800 border-violet-200","bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200","bg-rose-100 text-rose-800 border-rose-200"];class vx{getAllCategories(){const e=this.getCustomCategories();return[...bx,...e]}getCustomCategories(){try{const e=us();return(e==null?void 0:e.customCategories)??[]}catch(e){return console.error("[CategoryFacade] Failed to load custom categories:",e),[]}}createCategory(e){try{if(!e||!e.trim())return{success:!1,error:"Category label cannot be empty"};const t=e.trim();if(this.getAllCategories().find(f=>f.label.toLowerCase()===t.toLowerCase()))return{success:!1,error:`Category "${t}" already exists`};const o=`custom_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=this.getCustomCategories(),c=i.map(f=>f.className||""),l=this.getRandomColorClass(c),u={id:o,value:o,label:t,variant:"secondary",className:l,isCustom:!0},p=us(),h=[...i,u];return qs({...p,spaces:(p==null?void 0:p.spaces)??[],activeSpaceId:(p==null?void 0:p.activeSpaceId)??"all",customPresets:(p==null?void 0:p.customPresets)??[],activePresetId:(p==null?void 0:p.activePresetId)??"all",currentFilters:(p==null?void 0:p.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:h}),{success:!0,category:u}}catch(t){return console.error("[CategoryFacade] Failed to create category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}deleteCategory(e){try{if(this.isDefaultCategory(e))return{success:!1,error:"Cannot delete default categories"};const t=this.getCustomCategories();if(!t.find(i=>i.id===e))return{success:!1,error:`Category with ID "${e}" not found`};const n=t.filter(i=>i.id!==e),o=us();return qs({...o,spaces:(o==null?void 0:o.spaces)??[],activeSpaceId:(o==null?void 0:o.activeSpaceId)??"all",customPresets:(o==null?void 0:o.customPresets)??[],activePresetId:(o==null?void 0:o.activePresetId)??"all",currentFilters:(o==null?void 0:o.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:n}),{success:!0,deletedId:e}}catch(t){return console.error("[CategoryFacade] Failed to delete category:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}isDefaultCategory(e){return Object.values(Tt).includes(e)}categoryExists(e){return this.getAllCategories().some(a=>a.value===e)}getCategoryByValue(e){return this.getAllCategories().find(a=>a.value===e)}clearAllCustomCategories(){try{const e=us();qs({...e,spaces:(e==null?void 0:e.spaces)??[],activeSpaceId:(e==null?void 0:e.activeSpaceId)??"all",customPresets:(e==null?void 0:e.customPresets)??[],activePresetId:(e==null?void 0:e.activePresetId)??"all",currentFilters:(e==null?void 0:e.currentFilters)??{searchQuery:"",fieldConditions:[],conditionLogic:"OR",statuses:[],priorities:[],categories:[],claudeProjectPaths:[],sortBy:"createdAt",sortOrder:"desc",visibleColumns:[]},customCategories:[]}),console.info("[CategoryFacade] Cleared all custom categories")}catch(e){console.error("[CategoryFacade] Failed to clear custom categories:",e)}}getRandomColorClass(e){const t=Ba.filter(a=>!e.includes(a));return t.length===0?Ba[Math.floor(Math.random()*Ba.length)]:t[Math.floor(Math.random()*t.length)]}}const Kt=new vx,wx=s=>{var e,t;return((t=(e=s.app)==null?void 0:e.kanban)==null?void 0:t.customCategories)??[]};function yx({value:s,onChange:e,placeholder:t="Search categories...",disabled:a=!1}){const[n,o]=d.useState(!1),[i,c]=d.useState(""),l=Ae(wx),u=d.useMemo(()=>Kt.getAllCategories(),[l]),p=u.find(y=>y.value===s),h=u.filter(y=>y.label.toLowerCase().includes(i.toLowerCase())),f=d.useCallback(y=>{e==null||e(y),o(!1),c("")},[e]),b=d.useCallback(()=>{if(!i.trim())return;const y=Kt.createCategory(i.trim());y.success&&y.category?(f(y.category.value),c("")):console.error("[CategorySelector] Failed to create category:",y.error)},[i,f]),v=d.useCallback((y,g)=>{var j;if(y.stopPropagation(),Kt.isDefaultCategory(g))return;const x=Kt.deleteCategory(g);if(x.success){if(s===g){const C=Kt.getAllCategories();f(((j=C[0])==null?void 0:j.value)||"")}}else console.error("[CategorySelector] Failed to delete category:",x.error)},[s,f]),m=d.useCallback(y=>{o(y),y||c("")},[]);if(!p)return null;const w=i.trim()&&h.length===0;return r.jsxs(Ge,{open:n,onOpenChange:m,children:[r.jsx(Xe,{asChild:!0,children:r.jsx(tt,{"data-test":"category-selector-trigger",variant:p.variant||"secondary",className:R("cursor-pointer hover:opacity-80 transition-opacity",p.className,a&&"opacity-50 cursor-not-allowed"),onClick:y=>{y.stopPropagation(),a&&y.preventDefault()},children:p.label})}),r.jsx(We,{className:"popover-content w-64 p-2",align:"start","data-test":"category-selector-popover",children:r.jsxs("div",{className:"selector-container space-y-2","data-test":"category-selector-container",children:[r.jsx(Je,{"data-test":"category-search-input",placeholder:t,value:i,onChange:y=>c(y.target.value),onKeyDown:y=>{y.key==="Enter"&&w&&(y.preventDefault(),b())},className:"search-input h-8 text-sm",autoFocus:!0}),r.jsxs("div",{className:"options-list max-h-64 overflow-y-auto space-y-1","data-test":"category-options-list",children:[h.length===0&&!w&&r.jsx("div",{className:"empty-state text-sm text-gray-500 text-center py-4","data-test":"category-empty-state",children:"No options found"}),w&&r.jsxs(ne,{"data-test":"category-create-button",variant:"ghost",className:"category-create-button w-full justify-start h-8 px-2 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:b,children:[r.jsx(Ks,{className:"create-icon h-4 w-4 mr-2","data-test":"category-create-icon"}),'Create "',i,'"']}),h.map(y=>{const g=!Kt.isDefaultCategory(y.value);return r.jsxs("div",{"data-test":`category-option-wrapper-${y.value}`,className:R("option-item-wrapper flex items-center gap-1",y.value===s&&"bg-accent rounded"),children:[r.jsxs(ne,{"data-test":`category-option-button-${y.value}`,variant:"ghost",className:R("option-item flex-1 justify-between h-8 px-2"),onClick:()=>f(y.value),children:[r.jsx(tt,{"data-test":`category-option-badge-${y.value}`,variant:y.variant||"secondary",className:R("text-xs",y.className),children:y.label}),y.value===s&&r.jsx(et,{className:"check-icon h-4 w-4","data-test":"category-selected-check"})]}),g&&r.jsx(ne,{"data-test":`category-delete-button-${y.value}`,variant:"ghost",size:"icon",className:"category-delete-button h-8 w-8 p-0 text-red-500 hover:text-red-700 hover:bg-red-50",onClick:x=>v(x,y.value),title:"Delete category",children:r.jsx(Bt,{className:"delete-icon h-4 w-4","data-test":"category-delete-icon"})})]},y.value)})]})]})})]})}function fa(){return"xxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class sv{constructor(e){J(this,"items",[]);this.initialItems=e,e&&(e.forEach(t=>{t.id===void 0&&(t.id=fa())}),this.items=e)}create(e,t={}){const a={id:fa(),created:new Date().toISOString(),...e},{allowDuplicate:n,uniqueByKey:o}=t;if(n)return this.items.push(a),a;let i=-1;if(o&&(i=this.items.findIndex(p=>p[o]===a[o])),i!==-1)return;const l=this.items.findIndex(p=>p.id===a.id);return l!==-1?(this.items[l]=a,a):(this.items.push(a),a)}insertAt(e,t){const a=structuredClone(this.items);return a.splice(e,0,...t),a}batchCreate(e){this.items.push(...e)}readAll(e=!0){return e?structuredClone(this.items):this.items}readBetween(e,t){const a=[];for(let n=e;n<=t;n++){const o=this.items[n];a.push(o)}return a}readById(e){return this.items.find(t=>t.id===e)}readByKey(e,t){return this.items.find(a=>a[e]===t)}readFirst(){return this.items.length===0?void 0:this.items[0]}readLast(){return this.items.length===0?void 0:this.items[this.items.length-1]}update(e){const t=this.items.findIndex(a=>a.id===e.id);t!==-1&&(this.items[t]=e)}batchUpdate(e){e.forEach(t=>{const a=this.items.findIndex(n=>n.id===t.id);a!==-1&&(this.items[a]=t)})}delete(e){console.log("[CRUDService.ts,123] this.items: ",this.items);const t=this.items.findIndex(a=>a.id===e);console.log("[CRUDService.ts,123] indexToDelete: ",t),t!==-1&&this.items.splice(t,1)}deleteByKey(e,t){this.items=this.items.filter(a=>a[e]!==t)}deleteBetween(e,t){const a=this.items.slice(0,e),n=this.items.slice(t+1,this.items.length);return[...a,...n]}batchDelete(e){this.items=this.items.filter(t=>!e.includes(t.id))}getPreviousItem(e){const a=this.getCurrentItemIndex(e)-1,n=Math.max(a,0);return this.items[n]}getNextItem(e){const a=this.getCurrentItemIndex(e)+1,n=this.count()-1,o=Math.min(a,n);return this.items[o]}getCurrentItemIndex(e){return this.findIndexByKey("id",e)}count(){return this.items.length}clear(){this.items=[]}filterByKey(e,t){return this.items.filter(a=>a[e]===t)}findByKey(e,t){return this.items.find(a=>a[e]===t)}findIndexByKey(e,t){return this.items.findIndex(a=>a[e]===t)}replace(e){e&&(this.items=e)}replaceOne(e,t){console.log(">>>> _ >>>> ~ file: CRUDService.ts:203 ~ replace:",t);const a=structuredClone(this.items);return a[e]=t,a}sort(e,t=!0){this.items.sort((a,n)=>{const o=a[e],i=n[e];return o===i?0:t?o<i?-1:1:o>i?-1:1})}}const Sx="TodoDB",Cx=2,Be="todos";class jx{constructor(){J(this,"db",null)}async init(){return new Promise((e,t)=>{const a=indexedDB.open(Sx,Cx);a.onerror=()=>{t(new Error("Failed to open IndexedDB"))},a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=n=>{const o=n.target.result,i=n.target.transaction,c=n.oldVersion;if(!o.objectStoreNames.contains(Be)){const l=o.createObjectStore(Be,{keyPath:"id.value"});l.createIndex("status","status",{unique:!1}),l.createIndex("priority","priority",{unique:!1}),l.createIndex("category","category",{unique:!1}),l.createIndex("createdAt","createdAt.value",{unique:!1}),l.createIndex("dueDate","dueDate.value",{unique:!1}),l.createIndex("sortOrder","sortOrder",{unique:!1})}if(c<2){const l=i.objectStore(Be);l.indexNames.contains("sortOrder")||l.createIndex("sortOrder","sortOrder",{unique:!1});const u=l.getAll();u.onsuccess=()=>{const p=u.result,h={};p.forEach(f=>{const b=f.status||"backlog";h[b]||(h[b]=[]),h[b].push(f)}),Object.keys(h).forEach(f=>{h[f].forEach((b,v)=>{b.sortOrder===void 0&&(b.sortOrder=v,l.put(b))})})}}}})}async getAll(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([Be],"readonly").objectStore(Be).getAll();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to get todos"))}})}async getById(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,a)=>{const i=this.db.transaction([Be],"readonly").objectStore(Be).get(e);i.onsuccess=()=>{t(i.result)},i.onerror=()=>{a(new Error("Failed to get todo"))}})}async add(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,a)=>{const i=this.db.transaction([Be],"readwrite").objectStore(Be).add(e);i.onsuccess=()=>{t()},i.onerror=()=>{a(new Error("Failed to add todo"))}})}async update(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,a)=>{const i=this.db.transaction([Be],"readwrite").objectStore(Be).put(e);i.onsuccess=()=>{t()},i.onerror=()=>{a(new Error("Failed to update todo"))}})}async delete(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,a)=>{const i=this.db.transaction([Be],"readwrite").objectStore(Be).delete(e);i.onsuccess=()=>{t()},i.onerror=()=>{a(new Error("Failed to delete todo"))}})}async clear(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([Be],"readwrite").objectStore(Be).clear();o.onsuccess=()=>{e()},o.onerror=()=>{t(new Error("Failed to clear todos"))}})}async count(){if(!this.db)throw new Error("Database not initialized");return new Promise((e,t)=>{const o=this.db.transaction([Be],"readonly").objectStore(Be).count();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to count todos"))}})}}const qe=new jx;function Nx(s){return s&&typeof s=="object"&&("claudeProject"in s||"sessionIds"in s)}class Ex{constructor(){J(this,"initialized",!1)}async init(){if(this.initialized)return;await qe.init(),this.initialized=!0,await qe.count()===0&&await this.seedMockData()}createTodoId(e){return{value:e}}createTimestamp(e){return{value:e??new Date}}async createTodo(e){await this.init();const t=e.status??_e.BACKLOG;let a=e.sortOrder;if(a===void 0){const i=(await qe.getAll()).filter(l=>l.status===t);a=(i.length>0?Math.max(...i.map(l=>l.sortOrder??0)):-1)+1}const n={id:this.createTodoId(fa()),title:e.title,description:e.description,status:t,priority:e.priority??Ct.MEDIUM,category:e.category??Tt.PERSONAL,space:e.space,sortOrder:a,dueDate:e.dueDate?this.createTimestamp(e.dueDate):void 0,createdAt:this.createTimestamp(),updatedAt:this.createTimestamp(),tags:e.tags??[],subtasks:[],customProps:e.customProps};return await qe.add(n),n}async getTodo(e){await this.init();const t=await qe.getById(e.value);if(!t)throw new Error(`Todo with id ${e.value} not found`);return t}async getAllTodos(e){await this.init();let t=await qe.getAll();if(e!=null&&e.filters){const{status:a,priority:n,category:o,space:i,claudeProjectPath:c,tags:l,searchQuery:u}=e.filters;if(a&&a.length>0&&(t=t.filter(p=>a.includes(p.status))),n&&n.length>0&&(t=t.filter(p=>n.includes(p.priority))),o&&o.length>0&&(t=t.filter(p=>o.includes(p.category))),i&&i.length>0&&(t=t.filter(p=>p.space&&i.includes(p.space))),c&&c.length>0&&(t=t.filter(p=>{if(Nx(p.customProps))return p.customProps.claudeProjectPath&&c.includes(p.customProps.claudeProjectPath)})),l&&l.length>0&&(t=t.filter(p=>l.some(h=>p.tags.includes(h)))),u){const p=u.toLowerCase();t=t.filter(h=>{var f;return h.title.toLowerCase().includes(p)||((f=h.description)==null?void 0:f.toLowerCase().includes(p))})}}if(e!=null&&e.sort){const{field:a,direction:n}=e.sort;t.sort((o,i)=>{const c=o[a],l=i[a];if(c==null||l===void 0||l===null)return 0;const u=c<l?-1:c>l?1:0;return n==="asc"?u:-u})}else t.sort((a,n)=>(a.sortOrder??0)-(n.sortOrder??0));if((e==null?void 0:e.offset)!==void 0||(e==null?void 0:e.limit)!==void 0){const a=e.offset??0,n=e.limit??t.length;t=t.slice(a,a+n)}return t}async updateTodo(e,t){await this.init();const a=await this.getTodo(e),n={...a,...t,dueDate:t.dueDate?this.createTimestamp(t.dueDate instanceof Date?t.dueDate:new Date(t.dueDate.value)):a.dueDate,updatedAt:this.createTimestamp(),customProps:t.customProps?{...a.customProps,...t.customProps}:a.customProps};return await qe.update(n),n}async deleteTodo(e){await this.init(),await qe.delete(e.value)}async startTodo(e){return this.updateTodo(e,{status:_e.DOING})}async completeTodo(e){const t=await this.updateTodo(e,{status:_e.DONE});return t.completedAt=this.createTimestamp(),await qe.update(t),t}async cancelTodo(e){return this.updateTodo(e,{status:_e.ARCHIVE})}async addSubtask(e,t){await this.init();const a=await this.getTodo(e),n={id:this.createTodoId(fa()),title:t.title,isCompleted:!1,createdAt:this.createTimestamp()};return a.subtasks.push(n),a.updatedAt=this.createTimestamp(),await qe.update(a),a}async updateSubtask(e,t,a){await this.init();const n=await this.getTodo(e),o=n.subtasks.find(i=>i.id.value===t.value);if(!o)throw new Error(`Subtask with id ${t.value} not found`);return a.title!==void 0&&(o.title=a.title),a.isCompleted!==void 0&&(o.isCompleted=a.isCompleted),n.updatedAt=this.createTimestamp(),await qe.update(n),n}async toggleSubtask(e,t){await this.init();const a=await this.getTodo(e),n=a.subtasks.find(o=>o.id.value===t.value);if(!n)throw new Error(`Subtask with id ${t.value} not found`);return n.isCompleted=!n.isCompleted,a.updatedAt=this.createTimestamp(),await qe.update(a),a}async removeSubtask(e,t){await this.init();const a=await this.getTodo(e);return a.subtasks=a.subtasks.filter(n=>n.id.value!==t.value),a.updatedAt=this.createTimestamp(),await qe.update(a),a}async bulkUpdateStatus(e,t){await this.init(),await Promise.all(e.map(a=>this.updateTodo(a,{status:t})))}async bulkDelete(e){await this.init(),await Promise.all(e.map(t=>this.deleteTodo(t)))}async seedMockData(){const e=[];for(const a of e){const n=await this.createTodo(a);a.title==="Complete project documentation"&&(await this.addSubtask(n.id,{title:"Write API documentation"}),await this.addSubtask(n.id,{title:"Create usage examples"}),await this.addSubtask(n.id,{title:"Add screenshots"})),a.title==="Buy groceries"&&(await this.addSubtask(n.id,{title:"Check pantry inventory"}),await this.addSubtask(n.id,{title:"Make shopping list"}))}const t=await this.getAllTodos();t.length>0&&await this.startTodo(t[0].id),t.length>3&&await this.completeTodo(t[3].id)}async clearAllTodos(){await this.init(),await qe.clear()}async exportTodos(){await this.init();const e=await this.getAllTodos(),t=us(),a={todos:e,spaces:(t==null?void 0:t.spaces)??[],activeSpaceId:(t==null?void 0:t.activeSpaceId)??"all",customPresets:(t==null?void 0:t.customPresets)??[],activePresetId:(t==null?void 0:t.activePresetId)??"all",currentFilters:(t==null?void 0:t.currentFilters)??fr,customCategories:(t==null?void 0:t.customCategories)??[],loading:!1},n={...a,todos:a.todos.map(i=>({...i,createdAt:{value:i.createdAt.value.toISOString()},updatedAt:{value:i.updatedAt.value.toISOString()},completedAt:i.completedAt?{value:i.completedAt.value.toISOString()}:void 0,dueDate:i.dueDate?{value:i.dueDate.value.toISOString()}:void 0,subtasks:i.subtasks.map(c=>({...c,createdAt:{value:c.createdAt.value.toISOString()}}))}))},o=xx(n);return JSON.stringify(o,null,2)}async importTodos(e,t){var u,p,h;await this.init();const a=[];let n=0,o=0,i=0,c=0,l=0;try{const f=JSON.parse(e);if(!gx(f))throw new Error("Invalid format: Expected KanbanExportData v4.0 format");const b=f;t!=null&&t.replace&&(await this.clearAllTodos(),mx());const v=b.todos??[];for(const m of v)try{const w={...m,createdAt:{value:new Date(m.createdAt.value)},updatedAt:{value:new Date(m.updatedAt.value)},completedAt:m.completedAt?{value:new Date(m.completedAt.value)}:void 0,dueDate:m.dueDate?{value:new Date(m.dueDate.value)}:void 0,subtasks:(m.subtasks??[]).map(g=>({...g,createdAt:{value:new Date(g.createdAt.value)}}))};await qe.getById(w.id.value)&&!(t!=null&&t.replace)?o++:(await qe.add(w),n++)}catch(w){a.push(`Failed to import todo "${m.title}": ${w instanceof Error?w.message:"Unknown error"}`),o++}try{const m={spaces:b.spaces??[],activeSpaceId:b.activeSpaceId??"all",customPresets:b.customPresets??[],activePresetId:b.activePresetId??"all",currentFilters:b.currentFilters??fr,customCategories:b.customCategories??[]};qs(m),c=((u=b.spaces)==null?void 0:u.length)??0,i=((p=b.customPresets)==null?void 0:p.length)??0,l=((h=b.customCategories)==null?void 0:h.length)??0}catch(m){a.push(`Failed to save persisted state: ${m instanceof Error?m.message:"Unknown error"}`)}return{imported:n,skipped:o,errors:a,presetsImported:i,spacesImported:c,categoriesImported:l}}catch(f){throw new Error(`Failed to parse JSON: ${f instanceof Error?f.message:"Unknown error"}`)}}}const Me=new Ex;class kx{async createTicket(e,t){await Me.createTodo({...t,status:e})}}class Tx{async createSessionForTodo(e,t){const a=await nt.createSession({message:t.message,cwd:t.projectPath,projectId:t.projectPath,options:{outputFormat:t.outputFormat,permissionMode:t.permissionMode}});return a.success&&a.sessionId&&await this.linkSessionToTodo(e,a.sessionId),a}async linkSessionToTodo(e,t,a={mode:"append"}){var c;const n=await Me.getTodo(e),o=((c=n.customProps)==null?void 0:c.sessionIds)??[],i=a.mode==="replace"?[t]:[...o,t];await Me.updateTodo(e,{customProps:{...n.customProps,sessionIds:i}})}async unlinkSessionFromTodo(e,t){var i;const a=await Me.getTodo(e),o=(((i=a.customProps)==null?void 0:i.sessionIds)??[]).filter(c=>c!==t);await Me.updateTodo(e,{customProps:{...a.customProps,sessionIds:o}})}async getSessionsForTodo(e){var a;return((a=(await Me.getTodo(e)).customProps)==null?void 0:a.sessionIds)??[]}async hasLinkedSessions(e){return(await this.getSessionsForTodo(e)).length>0}buildInitialMessageFromTodo(e){const t=[];if(t.push(`# ${e.title}
`),e.description&&(t.push("## Description"),t.push(e.description),t.push("")),e.dueDate){const a=new Date(e.dueDate.value);t.push(`**Due Date:** ${a.toLocaleDateString()}`),t.push("")}return e.subtasks&&e.subtasks.length>0&&(t.push("## Subtasks"),e.subtasks.forEach(a=>{const n=a.isCompleted?"[x]":"[ ]";t.push(`${n} ${a.title}`)}),t.push("")),e.tags&&e.tags.length>0&&(t.push(`**Tags:** ${e.tags.join(", ")}`),t.push("")),t.push("---"),t.push("I permit and approve all file changes in this session to help complete this task."),t.join(`
`)}async createSessionWithTodoContext(e,t,a={}){var l;const n=await Me.getTodo(e),o=this.buildInitialMessageFromTodo(n),i=t?`${o}

---

${t}`:o,c=a.projectPath??((l=n.customProps)==null?void 0:l.claudeProjectPath);return this.createSessionForTodo(e,{message:i,projectPath:c,outputFormat:a.outputFormat,permissionMode:a.permissionMode})}async setProjectPath(e,t){const a=await Me.getTodo(e);await Me.updateTodo(e,{customProps:{...a.customProps,claudeProjectPath:t}})}async getProjectPath(e){var a;return(a=(await Me.getTodo(e)).customProps)==null?void 0:a.claudeProjectPath}}class Ax{constructor(){J(this,"column");J(this,"claude");this.column=new kx,this.claude=new Tx}async createTestFailureTicket(e){const t=this.buildFailureDescription(e),a=`[Test Failure] ${e.scenario}`;await this.column.createTicket(_e.BACKLOG,{title:a,description:t,priority:Ct.HIGH,category:Tt.WORK,tags:["test-failure","bdd",e.feature.toLowerCase().replace(/\s+/g,"-")],customProps:{testFailureId:e.id,feature:e.feature,scenario:e.scenario,failedStep:e.failedStep,stepType:e.stepType,stepIndex:e.stepIndex,timestamp:e.timestamp}})}async sendTestFailureToClaude(e,t){const a=this.buildClaudeMessage(e);return await nt.createSession({message:a,cwd:t==null?void 0:t.projectPath,projectId:t==null?void 0:t.projectPath,options:{outputFormat:t==null?void 0:t.outputFormat,permissionMode:t==null?void 0:t.permissionMode}})}buildClaudeMessage(e){const t=[];return t.push(`I have a BDD test failure that needs debugging help.
`),t.push("## Test Context"),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Step Type:** ${e.stepType||"Unknown"}`),t.push(`**Step Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Step Text:** \`${e.failedStep}\`
`)),t.push("## Error Details"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
## Request`),t.push("Please help me understand:"),t.push("1. What caused this test failure?"),t.push("2. What is the root cause of the error?"),t.push("3. How can I fix this issue?"),t.push("4. Are there any related issues I should be aware of?"),t.join(`
`)}buildFailureDescription(e){const t=[];return t.push(`# Test Failure Report
`),t.push(`**Feature:** ${e.feature}`),t.push(`**Scenario:** ${e.scenario}`),t.push(`**Time:** ${new Date(e.timestamp).toLocaleString()}
`),e.failedStep&&(t.push("## Failed Step"),t.push(`**Type:** ${e.stepType||"Unknown"}`),t.push(`**Index:** ${e.stepIndex!==void 0?e.stepIndex:"Unknown"}`),t.push(`**Text:** ${e.failedStep}
`)),t.push("## Error"),t.push(`\`\`\`
${e.error}
\`\`\``),e.errorStack&&(t.push(`
**Stack Trace:**`),t.push(`\`\`\`
${e.errorStack}
\`\`\``)),e.facadeState&&(t.push(`
## Facade State at Failure`),t.push(`\`\`\`json
${JSON.stringify(e.facadeState,null,2)}
\`\`\``)),t.push(`
---`),t.push("**Next Steps:**"),t.push("1. Review the error and failed step"),t.push("2. Reproduce the issue locally"),t.push("3. Send to Claude for analysis (Future: Phase 3)"),t.join(`
`)}}const Nc=new Ax,Ix=[{value:Ct.LOW,label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:Ct.MEDIUM,label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:Ct.HIGH,label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:Ct.URGENT,label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],Rx=[{value:_e.FREEZER,label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:_e.BACKLOG,label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:_e.SELECTED,label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:_e.DOING,label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:_e.DONE,label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:_e.ARCHIVE,label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],Px=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.data)==null?void 0:a.projects)??[]},_x=s=>{var e,t,a;return((a=(t=(e=s.app)==null?void 0:e.claude)==null?void 0:t.ui)==null?void 0:a.loadingProjects)??!1};function Dx({todo:s,mode:e,onUpdate:t,onClose:a,activeSessionId:n,isProcessingAll:o=!1,currentProcessingSubtaskId:i=null,onProcessAll:c,onStopProcessing:l}){const[u,p]=d.useState(""),[h,f]=d.useState(""),[b,v]=d.useState(""),[m,w]=d.useState(""),[y,g]=d.useState(""),[x,j]=d.useState(_e.BACKLOG),[C,N]=d.useState(Ct.MEDIUM),[S,D]=d.useState(""),[W,E]=d.useState([]),[I,_]=d.useState([]),[U,k]=d.useState([]),[M,O]=d.useState(void 0),[A,P]=d.useState(0),[z,$]=d.useState({}),T=d.useRef(null),L=d.useRef({}),V=Ae(Px),K=Ae(_x);d.useEffect(()=>{var F,B;s?(p(s.title),f(s.description??""),v(s.dueDate?new Date(s.dueDate.value).toISOString().split("T")[0]:""),j(s.status),N(s.priority),D(s.category),E(s.tags),_(s.subtasks),k(((F=s.customProps)==null?void 0:F.sessionIds)??[]),O((B=s.customProps)==null?void 0:B.claudeProjectPath)):(p(""),f(""),v(""),j(_e.BACKLOG),N(Ct.MEDIUM),D(""),E([]),_([]),k([]),O(void 0))},[s]);const q=d.useCallback((F,B)=>{const re=L.current[F],ce=re==null?void 0:re.getTextArea();if(!ce||!B)return 1;const ge=ce.offsetWidth;if(ge===0)return 1;const Le=window.getComputedStyle(ce),mt=Le.font,$e=Le.lineHeight,Ee=$e==="normal"?parseFloat(Le.fontSize)*1.2:parseFloat($e),it=ca(B,ge,mt,Ee);return Math.max(1,Math.ceil(it/Ee))},[]);d.useEffect(()=>{const F={};I.forEach(B=>{const re=q(B.id.value,B.title);F[B.id.value]=re}),$(F)},[I,q]),d.useEffect(()=>{var B;const F=(B=T.current)==null?void 0:B.getTextArea();if(F){const re=()=>{const ge=F.offsetWidth;P(ge)};re();const ce=new ResizeObserver(re);return ce.observe(F),()=>{ce.disconnect()}}},[]);const Q=d.useCallback(async F=>{if(e==="edit"&&s)try{await Me.updateTodo(s.id,F),t()}catch(B){console.error("Failed to update todo:",B)}},[e,s,t]),Y=d.useCallback(async()=>{if(e==="create"&&u.trim())try{await Nc.column.createTicket(x,{title:u.trim(),description:h.trim()||void 0,priority:C,category:S||void 0,tags:W,dueDate:b?new Date(b):void 0,customProps:{sessionIds:U,claudeProject:M}}),t(),a()}catch(F){console.error("Failed to create todo:",F)}},[e,u,h,x,C,S,W,b,U,M,t,a]);d.useCallback(()=>{e==="edit"&&s&&u!==s.title&&u.trim()&&Q({title:u})},[e,s,u,Q]);const oe=d.useCallback(()=>{e==="edit"&&s&&h!==(s.description??"")&&Q({description:h})},[e,s,h,Q]),ve=d.useCallback(F=>{v(F),e==="edit"&&Q(F?{dueDate:{value:new Date(F)}}:{dueDate:void 0})},[e,Q]),X=d.useCallback(()=>{const F=m.trim();if(F&&!W.includes(F)){const B=[...W,F];E(B),e==="edit"&&Q({tags:B}),w("")}},[m,W,e,Q]),H=d.useCallback(F=>{const B=W.filter(re=>re!==F);E(B),e==="edit"&&Q({tags:B})},[W,e,Q]),ae=d.useCallback(async()=>{if(y.trim())if(e==="edit"&&s)try{await Me.addSubtask(s.id,{title:y.trim()}),g(""),t()}catch(F){console.error("Failed to add subtask:",F)}else _([...I,{id:{value:`temp-${Date.now()}`},title:y.trim(),isCompleted:!1}]),g("")},[e,s,y,I,t]),he=d.useCallback(async F=>{if(e==="edit"&&s)try{await Me.toggleSubtask(s.id,F),t()}catch(B){console.error("Failed to toggle subtask:",B)}else _(I.map(B=>B.id.value===F.value?{...B,isCompleted:!B.isCompleted}:B))},[e,s,I,t]),xe=d.useCallback(async F=>{if(e==="edit"&&s)try{await Me.removeSubtask(s.id,F),t()}catch(B){console.error("Failed to remove subtask:",B)}else _(I.filter(B=>B.id.value!==F.value))},[e,s,I,t]),de=d.useCallback(async()=>{if(h.trim())try{const F=h.split(`
`),B=[];for(const re of F){const ce=re.trim(),Le=/^-\s*\[([ x])\]\s*(.+)$/i.exec(ce);if(Le){const Ee=Le[1].toLowerCase()==="x",it=Le[2].trim();it&&B.push({title:it,isCompleted:Ee});continue}const $e=/^-\s+(.+)$/.exec(ce);if($e){const Ee=$e[1].trim();Ee&&B.push({title:Ee,isCompleted:!1})}}if(e==="edit"&&s){for(const re of B){const ce=await Me.addSubtask(s.id,{title:re.title});if(re.isCompleted){const ge=ce.subtasks[ce.subtasks.length-1];ge&&await Me.toggleSubtask(s.id,ge.id)}}t()}else{const re=B.map((ce,ge)=>({id:{value:`temp-${Date.now()}-${ge}`},title:ce.title,isCompleted:ce.isCompleted}));_([...I,...re])}}catch(F){console.error("Failed to split tasks:",F)}},[e,s,h,I,t]),te=d.useCallback(F=>{j(F),e==="edit"&&Q({status:F})},[e,Q]),G=d.useCallback(F=>{N(F),e==="edit"&&Q({priority:F})},[e,Q]),ee=d.useCallback(F=>{D(F),e==="edit"&&Q({category:F})},[e,Q]),ie=d.useCallback(F=>{const B=Array.isArray(F)?F:[F];k(B),e==="edit"&&Q({customProps:{sessionIds:B}})},[e,Q]),Ne=d.useCallback(F=>{var re,ce,ge;O(F);const B=Z.getState();Z.updateState({app:{...B.app,claude:{...(re=B.app)==null?void 0:re.claude,ui:{...(ge=(ce=B.app)==null?void 0:ce.claude)==null?void 0:ge.ui,selectedProjectPath:F}}}}),e==="edit"&&Q({customProps:{claudeProjectPath:F}})},[e,Q]),ue=d.useMemo(()=>V.map(F=>({value:F.path,label:F.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[V]),me=d.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...ue],[ue]);d.useCallback(F=>{p(F.target.value)},[]);const fe=d.useCallback(F=>{f(F.target.value)},[]),be=d.useCallback(F=>{F.key==="Escape"&&F.currentTarget.blur()},[]),je=d.useCallback(F=>{w(F.target.value)},[]),ye=d.useCallback(F=>{F.key==="Enter"&&(F.preventDefault(),X())},[X]),Se=d.useCallback(F=>{g(F.target.value)},[]),Te=d.useCallback(F=>{F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),ae())},[ae]);return r.jsxs("div",{className:"details-grid grid grid-cols-4 gap-6","data-test":"todo-details-form",children:[r.jsxs("div",{className:"left-column col-span-3 space-y-6","data-test":"todo-details-left-column",children:[r.jsxs("div",{className:"form-field-description space-y-2","data-test":"todo-details-description-field",children:[r.jsx(le,{htmlFor:"description","data-test":"todo-details-description-label",children:"Description"}),r.jsx(_t,{value:h,onChange:fe,onBlur:oe,onKeyDown:be,placeholder:"Enter description...",rows:12,className:"description-textarea min-h-[100px] w-full","data-test":"todo-details-description-textarea"}),r.jsxs("div",{className:"description-actions mt-2 flex gap-2 justify-between","data-test":"todo-details-description-actions",children:[r.jsx(ne,{onClick:de,size:"sm",variant:"outline",className:"split-tasks-button",disabled:!h.trim(),"data-test":"todo-details-split-tasks-button",children:"Split Tasks"}),e==="edit"?r.jsx(ne,{onClick:oe,size:"sm",variant:"outline",className:"save-description-button","data-test":"todo-details-save-description-button",children:"Save"}):r.jsx(ne,{onClick:Y,size:"sm",variant:"default",className:"create-todo-button",disabled:!u.trim(),"data-test":"todo-details-create-button",children:"Create Todo"})]})]}),r.jsxs("div",{className:"form-field-subtasks space-y-2","data-test":"todo-details-subtasks-field",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(le,{"data-test":"todo-details-subtasks-label",children:"Subtasks"}),e==="edit"&&n&&I.some(F=>!F.isCompleted)&&(c??l)&&r.jsx(ne,{size:"sm",variant:o?"destructive":"outline",onClick:o?l:c,className:"process-all-button","data-test":"todo-details-process-all-button",children:o?r.jsxs(r.Fragment,{children:[r.jsx(rt,{className:"w-3 h-3 mr-1"}),"Stop"]}):"Process All"})]}),r.jsxs("div",{className:"subtasks-container space-y-2","data-test":"todo-details-subtasks-container",children:[r.jsx("div",{className:"subtasks-list space-y-2","data-test":"todo-details-subtasks-list",children:I.map(F=>r.jsxs("div",{className:"subtask-item flex items-center gap-2 p-2 rounded border","data-test":`todo-details-subtask-item-${F.id.value}`,children:[r.jsx("input",{type:"checkbox",checked:F.isCompleted,onChange:()=>he(F.id),className:"subtask-checkbox",disabled:o,"data-test":`todo-details-subtask-checkbox-${F.id.value}`}),r.jsx("div",{className:R("subtask-title-wrapper flex-1",F.isCompleted&&"line-through text-gray-500"),children:r.jsx(_t,{ref:B=>{L.current[F.id.value]=B},value:F.title,onChange:async B=>{const re=B.target.value,ce=q(F.id.value,re);if($(ge=>({...ge,[F.id.value]:ce})),e==="edit"&&s)try{await Me.updateSubtask(s.id,F.id,{title:re}),t()}catch(ge){console.error("Failed to update subtask title:",ge)}else _(I.map(ge=>ge.id.value===F.id.value?{...ge,title:re}:ge))},placeholder:"Edit subtask...",className:"subtask-title-textarea resize-none w-full",rows:z[F.id.value]||1,"data-test":`todo-details-subtask-textarea-${F.id.value}`})}),i===F.id.value&&r.jsx(va,{className:"w-4 h-4 animate-spin text-blue-500","data-test":`todo-details-subtask-loading-${F.id.value}`}),e==="edit"&&n&&r.jsx(Sc,{sessionId:n,message:F.title,className:"subtask-send h-7 w-7 hover:text-blue-500",disabled:o,"data-test":`todo-details-subtask-send-${F.id.value}`}),r.jsx("button",{onClick:()=>xe(F.id),className:"subtask-remove hover:text-red-500",disabled:o,"data-test":`todo-details-subtask-remove-${F.id.value}`,children:r.jsx(rt,{className:"w-4 h-4"})})]},F.id.value))}),r.jsxs("div",{className:"subtask-input flex gap-2","data-test":"todo-details-subtask-input-container",children:[r.jsx(_t,{ref:T,value:y,onChange:Se,onKeyDown:Te,placeholder:"Add a subtask...",rows:1,className:"flex-1","data-test":"todo-details-subtask-input"}),r.jsx(ne,{onClick:()=>void ae(),size:"sm",className:"subtask-add-button","data-test":"todo-details-subtask-add-button",children:r.jsx(Ks,{className:"w-4 h-4"})})]})]})]}),e==="edit"&&U.length>0&&r.jsxs("div",{className:"form-field-sessions space-y-2","data-test":"todo-details-sessions-field",children:[r.jsxs(le,{"data-test":"todo-details-sessions-label",children:["Claude Session IDs (",U.length,")"]}),U.map((F,B)=>r.jsx(Je,{value:F,readOnly:!0,className:"session-id-input bg-gray-50 mb-1",title:`Session ${B+1}`,"data-test":`todo-details-session-input-${B}`},F))]})]}),r.jsxs("div",{className:"right-column col-span-1 space-y-4","data-test":"todo-details-right-column",children:[r.jsxs("div",{className:"form-field-selectors space-y-4","data-test":"todo-details-selectors",children:[r.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-details-status-selector",children:[r.jsx(le,{"data-test":"todo-details-status-label",children:"Status"}),r.jsx("div",{className:"flex flex-wrap gap-2",children:r.jsx(fx,{value:x,options:Rx,onChange:te,placeholder:"Search status...","data-test":"todo-details-status-select"})})]}),r.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-details-priority-selector",children:[r.jsx(le,{"data-test":"todo-details-priority-label",children:"Priority"}),r.jsx("div",{className:"flex flex-wrap gap-2",children:r.jsx(Qa,{value:C,options:Ix,onChange:G,placeholder:"Search priorities...","data-test":"todo-details-priority-badge"})})]}),r.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-details-category-selector",children:[r.jsx(le,{"data-test":"todo-details-category-label",children:"Category"}),r.jsx("div",{className:"flex flex-wrap gap-2",children:r.jsx(yx,{value:S||"personal",onChange:ee,placeholder:"Search categories...","data-test":"todo-details-category-select"})})]}),!K&&me.length>1&&r.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-details-project-selector",children:[r.jsx(le,{"data-test":"todo-details-project-label",children:"Claude Project"}),r.jsx("div",{className:"flex flex-wrap gap-2",children:r.jsx(Qa,{value:M??"__no_project__",options:me,onChange:Ne,placeholder:"Search projects...","data-test":"todo-details-project-badge"})})]}),e==="edit"&&r.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-details-session-selector",children:[r.jsx(le,{"data-test":"todo-details-session-selector-label",children:"Claude Sessions"}),r.jsx(jc,{value:U,onChange:ie,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-details-session-select"})]}),r.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-details-tags-selector",children:[r.jsx(le,{"data-test":"todo-details-tags-label",children:"Tags"}),r.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-details-tags-container",children:[r.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-details-tags-list",children:W.map(F=>r.jsxs(tt,{variant:"outline",className:"tag-badge gap-1","data-test":`todo-details-tag-${F}`,children:[F,r.jsx("button",{onClick:()=>H(F),className:"tag-remove ml-1 hover:text-red-500","data-test":`todo-details-tag-remove-${F}`,children:r.jsx(rt,{className:"w-3 h-3"})})]},F))}),r.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-details-tag-input-container",children:[r.jsx(Je,{value:m,onChange:je,onKeyDown:ye,placeholder:"Add a tag...","data-test":"todo-details-tag-input"}),r.jsx(ne,{onClick:X,size:"sm",className:"tag-add-button","data-test":"todo-details-tag-add-button",children:r.jsx(Ks,{className:"w-4 h-4"})})]})]})]})]}),r.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-details-due-date-field",children:[r.jsx(le,{htmlFor:"dueDate","data-test":"todo-details-due-date-label",children:"Due Date"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Wl,{className:"w-4 h-4 text-gray-400"}),r.jsx(Je,{id:"dueDate",type:"date",value:b,onChange:F=>ve(F.target.value),"data-test":"todo-details-due-date-input"})]})]})]})]})}function Ox({todo:s,isOpen:e,onClose:t,onUpdate:a,currentCardIndex:n,totalCardsInColumn:o,onNavigatePrevious:i,onNavigateNext:c,initialValues:l}){var X,H,ae,he,xe,de;const[u,p]=d.useState("details"),[h,f]=d.useState(""),[b,v]=d.useState(!1),[m,w]=d.useState(null),[y,g]=d.useState(!1),[x,j]=d.useState(!1),[C,N]=d.useState(0),[S,D]=d.useState((s==null?void 0:s.title)??(l==null?void 0:l.title)??""),[W,E]=d.useState(!1),I=!s||s.id.value==="temp-new-todo",_=d.useMemo(()=>I?{id:{value:"temp-create"},title:(l==null?void 0:l.title)??S,description:(l==null?void 0:l.description)??"",status:_e.BACKLOG,priority:Ct.MEDIUM,category:(l==null?void 0:l.category)??"",sortOrder:0,tags:(l==null?void 0:l.tags)??[],subtasks:[],createdAt:{value:new Date},updatedAt:{value:new Date},customProps:{sessionIds:[]}}:null,[I,l==null?void 0:l.title,l==null?void 0:l.description,l==null?void 0:l.category,l==null?void 0:l.tags,S]),U=(H=(X=s==null?void 0:s.customProps)==null?void 0:X.sessionIds)==null?void 0:H[C],k=d.useMemo(()=>{var te;return((te=s==null?void 0:s.customProps)==null?void 0:te.sessionIds)??[]},[(ae=s==null?void 0:s.customProps)==null?void 0:ae.sessionIds]),M=d.useMemo(()=>({loadOnMount:u==="session",subscribeToSSE:u==="session"}),[u]),{messages:O,sessionDetails:A,metadata:P,loading:z,pagination:$,loadOlderMessages:T,refreshSession:L}=hx(U,M);d.useLayoutEffect(()=>{var te,G,ee,ie,Ne,ue,me;if(e&&((te=s==null?void 0:s.customProps)!=null&&te.claudeProjectPath)){const fe=Z.getState();((ie=(ee=(G=fe.app)==null?void 0:G.claude)==null?void 0:ee.ui)==null?void 0:ie.selectedProjectPath)!==s.customProps.claudeProjectPath&&Z.updateState({app:{...fe.app,claude:{...(Ne=fe.app)==null?void 0:Ne.claude,ui:{...(me=(ue=fe.app)==null?void 0:ue.claude)==null?void 0:me.ui,selectedProjectPath:s.customProps.claudeProjectPath}}}})}},[e,(he=s==null?void 0:s.customProps)==null?void 0:he.claudeProjectPath]),d.useEffect(()=>{p("details"),N(0),D((s==null?void 0:s.title)??(l==null?void 0:l.title)??"")},[s==null?void 0:s.id.value,s==null?void 0:s.title,s==null?void 0:s.description,e,l==null?void 0:l.title]),d.useEffect(()=>{const te=k.length;te>0&&C>=te&&N(0)},[k.length,C]),d.useEffect(()=>{u==="session"&&U&&L()},[C,U,u,L]);const V=d.useCallback(te=>{p(te),te==="session"&&U&&L()},[U,L]),K=d.useCallback(()=>{E(!0)},[]),q=d.useCallback(async te=>{if(!s){E(!1);return}try{await Nc.claude.linkSessionToTodo(s.id,te),a(),E(!1),p("session"),await L()}catch(G){console.error("Failed to handle session creation:",G),E(!1)}},[s,a,L]),Q=d.useCallback(async()=>{g(!0);try{await L()}finally{g(!1)}},[L]),Y=d.useCallback(async()=>{var G,ee,ie,Ne,ue,me,fe,be,je,ye;if(!s||!U)return;const te=s.subtasks.filter(Se=>!Se.isCompleted);if(te.length!==0){v(!0),j(!1);try{const Se=s.id;for(const Te of te){if(x)break;w(Te.id.value),await nt.sendMessage({message:Te.title,sessionId:U,options:{outputFormat:"text",permissionMode:"acceptEdits"}});let F=!1;for(let B=0;B<50;B++)if(await new Promise(ce=>setTimeout(ce,100)),(ue=(Ne=(ie=(ee=(G=Z.get("app"))==null?void 0:G.claude)==null?void 0:ee.ui)==null?void 0:ie.activity)==null?void 0:Ne[U])==null?void 0:ue.isProcessing){F=!0;break}if(!F)console.warn(`[ProcessAll] ${Te.title} - Processing never started, continuing anyway`);else for(let B=0;B<600&&(await new Promise(ce=>setTimeout(ce,100)),!!((ye=(je=(be=(fe=(me=Z.get("app"))==null?void 0:me.claude)==null?void 0:fe.ui)==null?void 0:be.activity)==null?void 0:je[U])==null?void 0:ye.isProcessing));B++);await Me.toggleSubtask(Se,Te.id),await new Promise(B=>setTimeout(B,500))}a()}catch(Se){console.error("Failed to process all subtasks:",Se)}finally{v(!1),w(null),j(!1)}}},[s,U,a,x]),oe=d.useCallback(()=>{j(!0)},[]),ve=d.useCallback(async te=>{const G=te.target.value;if(D(G),!I&&s)try{await Me.updateTodo(s.id,{title:G}),a()}catch(ee){console.error("Failed to update todo title:",ee)}},[I,s,a]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"panel-header","data-test":"kanban-card-details-header",children:r.jsxs("div",{className:"header-title-row flex items-center justify-between gap-4","data-test":"kanban-card-details-title-row",children:[r.jsxs("div",{className:"header-left flex items-center gap-2 flex-1 min-w-0","data-test":"kanban-card-details-header-left",children:[!I&&r.jsx(Ur,{"data-test":"kanban-card-details-session-activity",sessionIds:k,showCount:!0,isCreating:W}),!I&&i&&r.jsx(ne,{"data-test":"kanban-card-details-navigate-previous",variant:"ghost",size:"icon",onClick:i,disabled:n===0,className:"navigate-previous-card h-8 w-8 flex-shrink-0",title:"Previous card in column",children:r.jsx(js,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-left-icon"})}),r.jsx("div",{className:"flex-1 min-w-0","data-test":"kanban-card-details-title-wrapper",children:r.jsx(_t,{"data-test":"kanban-card-details-title-textarea",value:S,onChange:ve,placeholder:I?"Enter todo title...":"Edit todo title",className:"todo-title-textarea text-lg font-semibold resize-none w-full",rows:1})}),!I&&c&&r.jsx(ne,{"data-test":"kanban-card-details-navigate-next",variant:"ghost",size:"icon",onClick:c,disabled:n!==void 0&&o!==void 0&&n>=o-1,className:"navigate-next-card h-8 w-8 flex-shrink-0",title:"Next card in column",children:r.jsx(Ht,{className:"h-4 w-4","data-test":"kanban-card-details-chevron-right-icon"})})]}),!I&&s&&r.jsxs("div",{className:"header-actions flex items-center gap-2 flex-shrink-0","data-test":"kanban-card-details-header-actions",children:[r.jsx(jc,{"data-test":"kanban-card-details-session-selector",value:((xe=s.customProps)==null?void 0:xe.sessionIds)??[],onChange:async te=>{const G=Array.isArray(te)?te:[];await Me.updateTodo(s.id,{customProps:{...s.customProps,sessionIds:G}}),a()},className:"session-selector-header",showLabel:!1,placeholder:"Link to sessions",multiSelect:!0}),r.jsx(xc,{"data-test":"kanban-card-details-create-session-button",variant:"ghost",size:"icon",className:"create-session-button-panel",initialMessage:`Working on: ${s.title}

${s.description??""}`,projectPath:(de=s.customProps)==null?void 0:de.claudeProjectPath,onCreating:K,onSessionCreated:q,useModal:!0})]})]})}),r.jsxs(bc,{value:u,onValueChange:V,className:"panel-tabs flex-1 flex flex-col overflow-hidden","data-test":"kanban-card-details-tabs",children:[r.jsxs($r,{className:R("grid w-full",I?"grid-cols-1":"grid-cols-2"),"data-test":"kanban-card-details-tabs-list",children:[r.jsx(ws,{value:"details","data-test":"kanban-card-details-tab-details",children:"Details"}),!I&&r.jsx(ws,{value:"session",disabled:!U,"data-test":"kanban-card-details-tab-session",children:"Claude Session"})]}),r.jsx(ys,{value:"details",className:"panel-form mt-4 flex-1 overflow-y-auto data-[state=inactive]:hidden","data-test":"kanban-card-details-details-content",children:r.jsx(Dx,{todo:I?_:s,mode:I?"create":"edit",onUpdate:a,onClose:t,activeSessionId:U,isProcessingAll:b,currentProcessingSubtaskId:m,onProcessAll:Y,onStopProcessing:oe})}),!I&&r.jsxs(ys,{value:"session",className:"session-tab mt-4 flex-1 flex flex-col overflow-hidden data-[state=inactive]:hidden","data-test":"kanban-card-details-session-content",children:[null,z?r.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session",children:"Loading session..."}):U&&!A?r.jsx("div",{className:"loading-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-loading-session-initial",children:r.jsxs(ne,{variant:"outline",size:"sm",onClick:()=>void L(),className:"load-session-button",children:[r.jsx(Ha,{className:"w-4 h-4 mr-2"}),"Load Session"]})}):A?r.jsxs("div",{className:"session-chat-area flex flex-col gap-4 h-[calc(100vh-220px)]","data-test":"kanban-card-details-chat-area",children:[r.jsxs("div",{className:"session-header flex items-center justify-between","data-test":"kanban-card-details-session-header",children:[r.jsxs("div",{className:"session-header-left flex items-center gap-3","data-test":"kanban-card-details-session-header-left",children:[r.jsx("h3",{className:"session-title text-sm font-medium text-muted-foreground","data-test":"kanban-card-details-session-title",children:"Session Messages"}),k.length>1&&r.jsx(px,{"data-test":"kanban-card-details-session-navigator",sessionIds:k,currentIndex:C,onIndexChange:N,className:"session-navigator"})]}),r.jsxs(ne,{"data-test":"kanban-card-details-refresh-button",onClick:()=>void Q(),size:"sm",variant:"outline",disabled:y,className:"refresh-session-button",children:[r.jsx(Ha,{className:R("w-4 h-4 mr-2",y&&"animate-spin"),"data-test":"kanban-card-details-refresh-icon"}),y?"Refreshing...":"Refresh"]})]}),r.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden","data-test":"kanban-card-details-chat-messages",children:r.jsx(ox,{"data-test":"kanban-card-details-chat-interface",messages:O,sessionDetails:A,metadata:P,loading:z,pagination:$,onLoadOlder:$&&$.page<$.totalPages?T:void 0})}),r.jsx("div",{className:"chat-input flex-shrink-0","data-test":"kanban-card-details-chat-input",children:r.jsx(ix,{"data-test":"kanban-card-details-message-input",sessionId:U,value:h,onChange:f,onSendSuccess:()=>{L()}})})]}):r.jsx("div",{className:"no-session text-center py-8 text-muted-foreground","data-test":"kanban-card-details-no-session",children:"No Claude session found"})]})]})]})}function Mx({isOpen:s,onClose:e,onUpdate:t,triggerPosition:a,initialValues:n}){return r.jsx(Nr,{isVisible:s,onClose:e,title:"Create New Todo",shouldCloseManually:!0,resizable:!0,initialSize:{width:900,height:600},triggerPosition:a??void 0,className:"add-ticket-popover","data-test":"add-ticket-popover",children:r.jsx("div",{"data-test":"add-ticket-popover-content",className:"popover-content flex flex-col h-full overflow-hidden p-4",children:r.jsx(Ox,{todo:null,isOpen:s,onClose:e,onUpdate:t,initialValues:n})})})}function Lx({onTicketCreated:s,initialValues:e,variant:t="ghost",size:a="icon",className:n="add-ticket-button",title:o="Add New Ticket","data-test":i}){const[c,l]=d.useState(!1),[u,p]=d.useState(null),h=v=>{const m=v.currentTarget.getBoundingClientRect();p({x:m.left,y:m.top}),l(!0)},f=()=>{l(!1),p(null)},b=()=>{s&&s(),f()};return r.jsxs(r.Fragment,{children:[r.jsx(ne,{variant:t,size:a,onClick:h,title:o,className:n,"data-test":i||"add-ticket-button",children:r.jsx(zl,{className:"h-5 w-5","data-test":i?`${i}-icon`:"add-ticket-button-icon"})}),r.jsx(Mx,{isOpen:c,onClose:f,onUpdate:b,triggerPosition:u,initialValues:e,"data-test":i?`${i}-popover`:"add-ticket-popover"})]})}new Cr;const $x={primaryColor:"blue",setPrimaryColor:()=>null},Ux=d.createContext($x),Fx=()=>{const s=d.useContext(Ux);if(s===void 0)throw new Error("usePrimaryColor must be used within a PrimaryColorProvider");return s};function Wx({onColorSelect:s,selectedHue:e=217}){const t=d.useRef(null),[a,n]=d.useState(!1),[o,i]=d.useState(e);d.useEffect(()=>{a||i(e)},[e,a]),d.useEffect(()=>{const v=t.current;if(!v)return;const m=v.getContext("2d");if(!m)return;const w=v.width,y=v.height,g=40,x=(y-g)/2,j=`hsl(${o} 70% 90%)`;m.fillStyle=j,m.fillRect(0,0,w,y);for(let N=0;N<w;N+=1){const S=N/w*360;m.fillStyle=`hsl(${S}, 100%, 50%)`,m.fillRect(N,x,1,g)}m.strokeStyle="#ccc",m.lineWidth=2,m.strokeRect(0,x,w,g);const C=o/360*w;m.strokeStyle="#000",m.lineWidth=3,m.beginPath(),m.moveTo(C,x-8),m.lineTo(C,x+g+8),m.stroke(),m.strokeStyle="#fff",m.lineWidth=1,m.beginPath(),m.moveTo(C,x-8),m.lineTo(C,x+g+8),m.stroke()},[o]);const c=v=>{const m=t.current;if(!m)return;const w=m.getBoundingClientRect(),y=v.clientX-w.left,g=Math.round(y/m.width*360),x=Math.max(0,Math.min(360,g));i(x),s(`${x} 70% 60%`)},l=()=>n(!0),u=()=>n(!1),p=v=>{a&&c(v)},h=()=>n(!0),f=()=>n(!1),b=v=>{if(!a)return;const m=t.current;if(!m)return;const w=m.getBoundingClientRect(),y=v.touches[0].clientX-w.left,g=Math.round(y/m.width*360),x=Math.max(0,Math.min(360,g));i(x),s(`${x} 70% 60%`)};return r.jsxs("div",{className:"color-strip-container flex flex-col items-center gap-3",children:[r.jsx("canvas",{ref:t,width:200,height:80,onClick:c,onMouseDown:l,onMouseUp:u,onMouseMove:p,onMouseLeave:()=>n(!1),onTouchStart:h,onTouchEnd:f,onTouchMove:b,className:"color-strip cursor-pointer rounded touch-none"}),r.jsx("div",{className:"color-info text-center",children:r.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hue: ",o,"Â°"]})})]})}const zx=["slate","gray","zinc","neutral","stone","red","orange","amber","yellow","lime","green","emerald","teal","cyan","sky","blue","indigo","violet","purple","fuchsia","pink","rose","white","black"],Bx={slate:"#64748b",gray:"#6b7280",zinc:"#71717a",neutral:"#737373",stone:"#78716c",red:"#ef4444",orange:"#f97316",amber:"#f59e0b",yellow:"#eab308",lime:"#84cc16",green:"#22c55e",emerald:"#10b981",teal:"#14b8a6",cyan:"#06b6d4",sky:"#0ea5e9",blue:"#3b82f6",indigo:"#6366f1",violet:"#8b5cf6",purple:"#a855f7",fuchsia:"#d946ef",pink:"#ec4899",rose:"#f43f5e",white:"#ffffff",black:"#000000"},Hx={slate:"hsl(215 16% 47%)",gray:"hsl(218 11% 43%)",zinc:"hsl(220 13% 47%)",neutral:"hsl(0 0% 45%)",stone:"hsl(12 6% 44%)",red:"hsl(0 84% 60%)",orange:"hsl(24 97% 61%)",amber:"hsl(45 96% 71%)",yellow:"hsl(54 100% 68%)",lime:"hsl(84 85% 67%)",green:"hsl(142 72% 64%)",emerald:"hsl(160 84% 65%)",teal:"hsl(168 86% 55%)",cyan:"hsl(191 87% 55%)",sky:"hsl(198 93% 60%)",blue:"hsl(217 91% 60%)",indigo:"hsl(226 86% 61%)",violet:"hsl(259 84% 63%)",purple:"hsl(280 85% 64%)",fuchsia:"hsl(289 86% 66%)",pink:"hsl(330 81% 60%)",rose:"hsl(356 84% 61%)",white:"hsl(0 0% 100%)",black:"hsl(0 0% 0%)"};function Gx({isOpen:s,onOpenChange:e}){const{primaryColor:t,setPrimaryColor:a}=Fx(),[n,o]=d.useState(217),[i,c]=d.useState(t),l=p=>{c(p),a(p);const h=Hx[p],f=parseInt(h.split(" ")[0].replace("hsl(",""));o(f)},u=p=>{const h=parseInt(p.split(" ")[0]);o(h);const f=`${h} 70% 90%`,b=`${h} 70% 85%`,v=`${h} 70% 80%`,m=`${h} 70% 70%`;a(`hsl-${h}`),c(`hsl-${h}`);const w=window.document.documentElement;w.style.setProperty("--background",f),w.style.setProperty("--card",b),w.style.setProperty("--tab",v),w.style.setProperty("--active",m)};return r.jsx(ea,{open:s,onOpenChange:e,children:r.jsxs(ta,{className:"theme-settings-dialog sm:max-w-3xl",children:[r.jsxs(sa,{children:[r.jsx(gs,{className:"theme-settings-title",children:"Theme Settings"}),r.jsx(Do,{className:"theme-settings-description",children:"Choose a predefined color or use the color wheel for custom colors"})]}),r.jsxs("div",{className:"predefined-colors-section mb-6",children:[r.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Predefined Colors"}),r.jsx("div",{className:"predefined-colors-grid grid grid-cols-12 gap-2",children:zx.map(p=>r.jsx("button",{type:"button",title:p,onClick:()=>l(p),className:R("color-button w-8 h-8 rounded-full border-2 cursor-pointer transition-all","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","hover:scale-110",i===p?"ring-2 ring-ring ring-offset-2 scale-110":"border-muted",p==="white"&&"border-neutral-300"),style:{backgroundColor:Bx[p]},"aria-label":`Select ${p} theme`},p))})]}),r.jsxs("div",{className:"theme-wheel-container flex gap-6 items-start",children:[r.jsxs("div",{className:"flex-shrink-0",children:[r.jsx("p",{className:"text-sm font-medium text-foreground mb-3",children:"Custom Color"}),r.jsx(Wx,{onColorSelect:u,selectedHue:n})]}),r.jsxs("div",{className:"flex-1 space-y-3",children:[r.jsx("div",{className:"theme-preview-title",children:r.jsx("p",{className:"text-sm font-medium text-foreground",children:"Live Preview:"})}),r.jsx("div",{className:"theme-preview-bg p-4 rounded-lg border-2",style:{backgroundColor:`hsl(${n} 70% 90%)`},children:r.jsx("p",{className:"text-xs font-semibold text-gray-700",children:"Background"})}),r.jsx("div",{className:"theme-preview-card p-4 rounded-lg border",style:{backgroundColor:`hsl(${n} 70% 85%)`},children:r.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Card"})}),r.jsx("div",{className:"theme-preview-tab p-3 rounded-lg border",style:{backgroundColor:`hsl(${n} 70% 80%)`},children:r.jsx("p",{className:"text-xs font-semibold text-gray-800",children:"Tab"})}),r.jsx("div",{className:"theme-preview-active p-3 rounded-lg border font-semibold",style:{backgroundColor:`hsl(${n} 70% 70%)`},children:r.jsx("p",{className:"text-xs text-gray-900",children:"Active/Selected"})})]})]})]})})}function Vx({version:s}){const e=gr(),[t,a]=d.useState(!1);if(e.pathname==="/game"||e.pathname==="/new-home")return null;const n=typeof window<"u"&&window.location.hostname==="localhost"&&window.location.port.startsWith("517");return r.jsxs("header",{className:"sticky top-0 z-50 bg-black text-white shadow-md",children:[r.jsxs("div",{className:"px-4 py-3 flex items-center gap-2 justify-between",children:[r.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[r.jsx(jo,{}),n&&r.jsx("div",{className:"px-2 py-1 bg-yellow-500 text-black text-xs font-bold rounded",children:"PREVIEW"}),e.pathname==="/chat"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(Bl,{className:Ue.md}),r.jsx("h1",{className:"text-xl font-semibold",children:"Chat with Ollama"})]}):e.pathname==="/settings"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(At,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Settings"]})]}):e.pathname==="/todo"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(Zn,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Todo"]})]}):e.pathname.startsWith("/demo")?r.jsx("div",{className:"flex-1 flex items-center justify-center gap-2",children:e.pathname==="/demo/node-editor"?r.jsxs(r.Fragment,{children:[r.jsx(Hl,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Editor"]})]}):e.pathname==="/demo/node-types"?r.jsxs(r.Fragment,{children:[r.jsx(Gl,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Node Types"]})]}):e.pathname==="/demo/audio-panel"?r.jsxs(r.Fragment,{children:[r.jsx(no,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Audio Panel Demo"]})]}):e.pathname==="/demo/silence-chunking"?r.jsxs(r.Fragment,{children:[r.jsx(Vl,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Silence Chunking Demo"]})]}):r.jsxs(r.Fragment,{children:[r.jsx(ro,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Demo"]})]})}):e.pathname==="/content"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(vr,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Content"]})]}):e.pathname==="/realtime"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(ql,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Real-time Audio"]})]}):e.pathname==="/active-recording"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(eo,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Active Recording"]})]}):e.pathname==="/table"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(ao,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Table Demo"]})]}):e.pathname.startsWith("/vocabulary")?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(to,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Vocabulary"]})]}):e.pathname==="/live-transcription"?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(so,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Live Transcription"]})]}):e.pathname.startsWith("/claude")?r.jsxs("div",{className:"flex-1 flex items-center justify-center gap-2",children:[r.jsx(Yn,{className:Ue.md}),r.jsxs("h1",{className:"text-xl font-semibold",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Claude"]})]}):r.jsxs("h1",{className:"text-xl font-semibold flex-1 text-center",children:[n&&r.jsx("span",{className:"text-yellow-300",children:"[PREVIEW] "}),"Watcher"]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[e.pathname==="/"&&s&&r.jsxs("span",{className:"text-xs text-gray-200",children:["Version: ",s]}),r.jsx(Lx,{}),r.jsx(ax,{variant:"ghost",size:"icon",title:"Audio Recorder"}),r.jsx(xc,{variant:"ghost",size:"icon",icon:r.jsx(co,{className:"h-5 w-5"}),buttonTitle:"Ask Claude"}),r.jsx(wa,{title:"Settings",icon:r.jsx(At,{className:"h-5 w-5"}),variant:"ghost",size:"icon",align:"end",storageKey:"app-settings",children:r.jsxs("div",{className:"settings-panel space-y-3",children:[r.jsxs("div",{className:"theme-toggle-section",children:[r.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme"}),r.jsx(pu,{})]}),r.jsxs("div",{className:"theme-settings-section",children:[r.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Theme Colors"}),r.jsxs(ne,{variant:"outline",size:"sm",onClick:()=>a(!0),className:"w-full flex items-center gap-2",children:[r.jsx(Kl,{className:"h-4 w-4"}),"Customize Colors"]})]})]})})]})]}),r.jsx(Gx,{isOpen:t,onOpenChange:a})]})}function qx(){const s=document.activeElement;if(!s)return null;const e=["INPUT","TEXTAREA"].includes(s.nodeName??""),t=s.contentEditable==="true";return e||t}class Kx{constructor(){J(this,"shortcuts",new Map);J(this,"isListening",!1);this.handleKeyDown=this.handleKeyDown.bind(this)}generateShortcutId(e){const t=[];return e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),`${t.join("+")}-${e.key.toLowerCase()}`}handleKeyDown(e){if(qx())return;const t=this.generateShortcutId({key:e.key,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,altKey:e.altKey}),a=this.shortcuts.get(t);a&&(a.preventDefault!==!1&&e.preventDefault(),a.callback())}register(e){const t=this.generateShortcutId(e);return this.shortcuts.set(t,e),this.isListening||this.startListening(),()=>this.unregister(t)}unregister(e){this.shortcuts.delete(e),this.shortcuts.size===0&&this.stopListening()}unregisterAll(){this.shortcuts.clear(),this.stopListening()}startListening(){this.isListening||(document.addEventListener("keydown",this.handleKeyDown),this.isListening=!0)}stopListening(){this.isListening&&(document.removeEventListener("keydown",this.handleKeyDown),this.isListening=!1)}getRegisteredShortcuts(){return Array.from(this.shortcuts.values())}isShortcutRegistered(e){const t=this.generateShortcutId(e);return this.shortcuts.has(t)}}const Qt=new Kx,bn="command-palette-recently-used",Jx=5;function Qx({actions:s=[],placeholder:e="Type a command or search..."}){const[t,a]=d.useState(!1),[n,o]=d.useState(""),[i,c]=d.useState(()=>{try{const h=localStorage.getItem(bn);return h?JSON.parse(h):[]}catch{return[]}});d.useEffect(()=>{const h=Qt.register({key:"q",altKey:!0,preventDefault:!0,callback:()=>a(v=>!v)}),f=Qt.register({key:"p",metaKey:!0,preventDefault:!0,callback:()=>a(v=>!v)}),b=Qt.register({key:"q",ctrlKey:!0,altKey:!0,preventDefault:!0,callback:()=>{const v=i[0];if(v){const m=s.find(w=>w.id===v);m&&m.action()}}});return()=>{h(),f(),b()}},[i,s]),d.useEffect(()=>{if(!t)return;const h=f=>{if(f.key!=="ArrowUp"&&f.key!=="ArrowDown")return;const b=Array.from(document.querySelectorAll("[cmdk-item]")).filter(y=>y.getAttribute("data-disabled")!=="true");if(b.length===0)return;const v=b.map(y=>y.getAttribute("data-value")||""),m=v.indexOf(n);let w;if(f.key==="ArrowUp"){m<=0&&(f.preventDefault(),f.stopPropagation(),w=b.length-1,o(v[w]));return}else{m>=b.length-1&&(f.preventDefault(),f.stopPropagation(),w=0,o(v[w]));return}};return document.addEventListener("keydown",h,{capture:!0}),()=>document.removeEventListener("keydown",h,{capture:!0})},[t,n]);const l=s.reduce((h,f)=>{const b=f.group??"General";return h[b]||(h[b]=[]),h[b].push(f),h},{}),u=h=>{a(!1),h.action(),c(f=>{const b=f.filter(m=>m!==h.id),v=[h.id,...b].slice(0,Jx);try{localStorage.setItem(bn,JSON.stringify(v))}catch{}return v})},p=i.map(h=>s.find(f=>f.id===h)).filter(h=>h!==void 0);return r.jsxs(Oo,{open:t,onOpenChange:a,value:n,onValueChange:o,"data-test":"command-palette-dialog",children:[r.jsx(Sa,{"data-test":"command-palette-input",placeholder:e}),r.jsxs(Ns,{"data-test":"command-palette-list",children:[r.jsx(Es,{"data-test":"command-palette-empty",children:"No results found."}),p.length>0&&r.jsxs(r.Fragment,{children:[r.jsx(Xt,{heading:"Recently Used","data-test":"command-group-recent",children:p.map(h=>r.jsxs(Dt,{value:`recent-${h.id}`,onSelect:()=>u(h),className:"command-item flex justify-between items-center","data-test":`command-item-recent-${h.id}`,children:[r.jsx("span",{"data-test":`command-item-recent-${h.id}-label`,children:h.label}),h.shortcut&&r.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":`command-item-recent-${h.id}-shortcut`,children:h.shortcut})]},`recent-${h.id}`))}),r.jsx(Xa,{"data-test":"command-separator-recent"})]}),Object.entries(l).map(([h,f],b)=>r.jsxs("div",{"data-test":`command-group-container-${h.toLowerCase().replace(/\s+/g,"-")}`,children:[b>0&&r.jsx(Xa,{"data-test":`command-separator-${h.toLowerCase().replace(/\s+/g,"-")}`}),r.jsx(Xt,{heading:h,"data-test":`command-group-${h.toLowerCase().replace(/\s+/g,"-")}`,children:f.map(v=>r.jsxs(Dt,{value:v.id,onSelect:()=>u(v),className:"command-item flex justify-between items-center","data-test":`command-item-${v.id}`,children:[r.jsx("span",{"data-test":`command-item-${v.id}-label`,children:v.label}),v.shortcut&&r.jsx("kbd",{className:"shortcut-display pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground opacity-100","data-test":`command-item-${v.id}-shortcut`,children:v.shortcut})]},v.id))})]},h))]})]})}const Xx=s=>s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Yx=s=>(e,t)=>{if(!t)return 1;let a=t,n=e;if(s.matchCase||(a=a.toLowerCase(),n=n.toLowerCase()),s.matchWholeWord)return new RegExp(`\\b${Xx(a)}\\b`,s.matchCase?"":"i").test(e)?1:0;const o=n.includes(a);if(s.mode==="fuzzy"){if(o)return 2;let i=0;for(let c=0;c<n.length&&i<a.length;c++)n[c]===a[i]&&i++;return i===a.length?1:0}else return o?1:0},Zx={matchCase:!1,matchWholeWord:!1,mode:"fuzzy"};function eb({placeholder:s="Search...",initialOptions:e,onSearchOptionsChange:t,onSearchChange:a,onNavigate:n,className:o}){const[i,c]=d.useState(e??Zx),l=d.useCallback(f=>{c(f),t==null||t(f)},[t]),u=()=>{const f={...i,matchCase:!i.matchCase};l(f)},p=()=>{const f={...i,matchWholeWord:!i.matchWholeWord};l(f)},h=()=>{const f={...i,mode:i.mode==="fuzzy"?"exact":"fuzzy"};l(f)};return r.jsxs("div",{className:R("flex items-center border-b px-3 pr-12",o),"cmdk-input-wrapper":"","data-test":"search-input-with-options",children:[r.jsx(ba,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),r.jsx(Ye.Input,{"data-test":"search-input",placeholder:s,onValueChange:a,className:"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50"}),r.jsxs("div",{className:"flex items-center gap-0.5 shrink-0","data-test":"search-options",children:[r.jsx("button",{type:"button",onClick:u,className:R("p-1.5 rounded hover:bg-accent transition-colors",i.matchCase&&"bg-accent text-accent-foreground"),title:"Match Case (Aa)","data-test":"search-match-case-button",children:r.jsx(Jl,{className:"h-4 w-4"})}),r.jsx("button",{type:"button",onClick:p,className:R("p-1.5 rounded hover:bg-accent transition-colors",i.matchWholeWord&&"bg-accent text-accent-foreground"),title:"Match Whole Word","data-test":"search-match-whole-word-button",children:r.jsx(Ql,{className:"h-4 w-4"})}),r.jsx("button",{type:"button",onClick:h,className:R("p-1.5 rounded hover:bg-accent transition-colors text-xs font-mono",i.mode==="exact"&&"bg-accent text-accent-foreground"),title:i.mode==="fuzzy"?"Fuzzy Search (click for Exact)":"Exact Search (click for Fuzzy)","data-test":"search-mode-button",children:i.mode==="fuzzy"?"Fz":"Ex"}),r.jsx("div",{className:"w-px h-4 bg-border mx-1","data-test":"search-separator"}),r.jsx("button",{type:"button",onClick:()=>n==null?void 0:n("up"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Previous Result (â†‘)","data-test":"search-navigate-up-button",children:r.jsx(wr,{className:"h-4 w-4"})}),r.jsx("button",{type:"button",onClick:()=>n==null?void 0:n("down"),className:"p-1.5 rounded hover:bg-accent transition-colors",title:"Next Result (â†“)","data-test":"search-navigate-down-button",children:r.jsx(ts,{className:"h-4 w-4"})})]})]})}function tb(s,e){return{navigateResults:d.useCallback(a=>{const n=Array.from(document.querySelectorAll("[cmdk-item]")).filter(l=>l.getAttribute("data-disabled")!=="true");if(n.length===0)return;const o=n.map(l=>l.getAttribute("data-value")||""),i=o.indexOf(s);let c;a==="up"?c=i<=0?n.length-1:i-1:c=i>=n.length-1?0:i+1,e(o[c])},[s,e])}}function sb({placeholder:s="Go to node by title or content..."}){const[e,t]=d.useState(!1),[a,n]=d.useState(""),[o,i]=d.useState(""),c=Ut.getState().getGoToSymbolSearch(),[l,u]=d.useState((c==null?void 0:c.options)??{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}),p=d.useCallback(w=>{u(w),Ut.getState().setGoToSymbolSearchOptions(w)},[]),h=d.useMemo(()=>Yx(l),[l]),{navigateResults:f}=tb(a,n),b=d.useMemo(()=>{var g;if(!e)return[];const w=Ut.getState();if(!((g=w.state)!=null&&g.projects))return[];const y=[];return Object.values(w.state.projects).forEach(x=>{Object.values(x.workspaces).forEach(j=>{Object.values(j.canvases).forEach(C=>{(C.coreState.nodes||[]).forEach(S=>{var _;const D=(_=S.data)==null?void 0:_.nodeType;if(D==="workflowOrchestration"||D==="workflowSource")return;const W=S.title||"",E=typeof S.content=="string"?S.content:"",I=E.length>80?E.substring(0,80)+"...":E;!W&&!E||y.push({id:`${C.id}:${S.id}`,nodeId:S.id,canvasId:C.id,title:W||I.substring(0,40)||S.id,contentPreview:I,path:`${x.name} / ${j.name} / ${C.name}`,node:S})})})})}),y},[e]),v=d.useMemo(()=>{const w={};return b.forEach(y=>{w[y.path]||(w[y.path]=[]),w[y.path].push(y)}),w},[b]),m=d.useCallback(w=>{o.trim()&&Ut.getState().addGoToSymbolSearchHistory(o.trim()),t(!1),i("");const y=Ut.getState();y.projectCanvas.switch(w.canvasId),setTimeout(()=>{y.scrollToNode(w.nodeId,500),y.setSelectedNodes([w.node])},50)},[o]);return d.useEffect(()=>{const w=Qt.register({key:"o",ctrlKey:!0,preventDefault:!0,callback:()=>t(g=>!g)}),y=Qt.register({key:"o",metaKey:!0,preventDefault:!0,callback:()=>t(g=>!g)});return()=>{w(),y()}},[]),d.useEffect(()=>{if(!e)return;const w=y=>{if(y.key!=="ArrowUp"&&y.key!=="ArrowDown")return;const g=Array.from(document.querySelectorAll("[cmdk-item]")).filter(C=>C.getAttribute("data-disabled")!=="true");if(g.length===0)return;const x=g.map(C=>C.getAttribute("data-value")||""),j=x.indexOf(a);if(y.key==="ArrowUp"){j<=0&&(y.preventDefault(),y.stopPropagation(),n(x[g.length-1]));return}else{j>=g.length-1&&(y.preventDefault(),y.stopPropagation(),n(x[0]));return}};return document.addEventListener("keydown",w,{capture:!0}),()=>document.removeEventListener("keydown",w,{capture:!0})},[e,a]),r.jsxs(Oo,{open:e,onOpenChange:t,value:a,onValueChange:n,filter:h,"data-test":"go-to-symbol-dialog",children:[r.jsx(eb,{placeholder:s,initialOptions:l,onSearchOptionsChange:p,onSearchChange:i,onNavigate:f}),r.jsxs(Ns,{"data-test":"go-to-symbol-list",children:[r.jsx(Es,{"data-test":"go-to-symbol-empty",children:"No nodes found."}),Object.entries(v).map(([w,y])=>r.jsx(Xt,{heading:w,"data-test":`go-to-symbol-group-${w.replace(/\s+\/\s+/g,"-").toLowerCase()}`,children:y.map(g=>r.jsxs(Dt,{value:`${g.title} ${g.contentPreview} ${g.path}`,onSelect:()=>m(g),className:"flex flex-col items-start gap-0.5","data-test":`go-to-symbol-item-${g.nodeId}`,children:[r.jsx("span",{className:"font-medium text-sm","data-test":`go-to-symbol-item-${g.nodeId}-title`,children:g.title}),g.contentPreview&&g.title!==g.contentPreview.substring(0,40)&&r.jsx("span",{className:"text-xs text-muted-foreground truncate max-w-full","data-test":`go-to-symbol-item-${g.nodeId}-preview`,children:g.contentPreview})]},g.id))},w))]})]})}function ab(s){const e=s.split(/[/\\]/),t=e.pop()||"",a=/:(\d+)(?::\d+)?$/.exec(t);let n="",o=t;return a&&(n=a[1],o=t.slice(0,a.index)),{dir:e.join("/"),filename:o,line:n}}function mr(s){return ab(s).filename}function Fs({onClick:s,textToCopy:e,title:t="Copy formatted text",size:a="icon",variant:n="ghost"}){const[o,i]=d.useState(!1),c=async()=>{if(s){s();return}if(!e){Ze.error("No text to copy");return}try{await navigator.clipboard.writeText(e),i(!0),Ze.success("Copied to clipboard!"),setTimeout(()=>i(!1),2e3)}catch(l){Ze.error("Failed to copy to clipboard"),console.error("Copy failed:",l)}};return r.jsx(ne,{onClick:c,title:t,size:a,variant:n,children:o?r.jsx(et,{}):r.jsx(lo,{})})}function rb(s,e,t=300,a=15,n=10,o=200){let i=s+a,c=e+a;return i+t>window.innerWidth&&(i=window.innerWidth-t-n),c+o>window.innerHeight&&(c=window.innerHeight-o-n),i<n&&(i=n),c<n&&(c=n),{left:i,top:c}}function nb({onElementClicked:s,onElementHovered:e,onInspectorActivated:t,onInspectorDeactivated:a,shouldInspectElement:n,renderTooltip:o,excludeClassNames:i=[],tooltipOwnerId:c}){const[l,u]=d.useState(!1),[p,h]=d.useState(null),f=d.useRef(null),b=d.useRef(s),v=d.useRef(e),m=d.useRef(t),w=d.useRef(a),y=d.useRef(n),g=d.useRef(null),x=d.useRef(null),j=d.useRef(null);d.useEffect(()=>{b.current=s,v.current=e,m.current=t,w.current=a,y.current=n}),d.useEffect(()=>{if(c)return at.claimTooltip(c),()=>{at.releaseTooltip(c)}},[c]);const C=d.useMemo(()=>["inspector-tooltip","collected-elements-popover",...i],[i]),N=d.useCallback(U=>{for(const k of C)if(U.closest(`.${k}`))return!0;return!!(y.current&&!y.current(U))},[C]),S=d.useCallback(U=>{var T;const k=U.target;if(N(k))return;const M=f.current===k;f.current&&!M&&(f.current.style.outline="",f.current.style.outlineOffset=""),k.style.outline="2px solid #06b6d4",k.style.outlineOffset="2px",f.current=k;const O=k.tagName.toLowerCase(),A=Array.from(k.classList),P=k.getAttribute("data-test")||void 0,z=k.getAttribute("data-react-inspector")||void 0,$={tagName:O,classes:A,dataTest:P,reactInspectorId:z,resolvedPath:void 0,x:U.clientX,y:U.clientY};M?h(L=>L?{...L,x:U.clientX,y:U.clientY}:$):(h($),(T=v.current)==null||T.call(v,k,$))},[N]),D=d.useCallback(U=>{var $;const k=U.target;if(N(k))return;U.preventDefault(),U.stopPropagation();const M=k.tagName.toLowerCase(),O=Array.from(k.classList),A=k.getAttribute("data-test")||void 0,P=k.getAttribute("data-react-inspector")||void 0,z={tagName:M,classes:O,dataTest:A,reactInspectorId:P,resolvedPath:void 0,x:U.clientX,y:U.clientY};($=b.current)==null||$.call(b,k,z)},[N]),W=d.useCallback(U=>{U.key==="Escape"&&l&&at.deactivate()},[l]);d.useEffect(()=>(u(at.getState()),at.subscribe(k=>{var M,O;u(k),k?(M=m.current)==null||M.call(m):(O=w.current)==null||O.call(w)})),[]),d.useEffect(()=>{var U;return l?(g.current=S,x.current=D,j.current=W,document.body.style.setProperty("cursor","crosshair","important"),document.addEventListener("mousemove",S),document.addEventListener("click",D,!0),document.addEventListener("keydown",W)):(document.body.style.removeProperty("cursor"),g.current&&document.removeEventListener("mousemove",g.current),x.current&&document.removeEventListener("click",x.current,!0),j.current&&document.removeEventListener("keydown",j.current),h(null),(U=v.current)==null||U.call(v,null,null),f.current&&(f.current.style.outline="",f.current.style.outlineOffset="",f.current=null)),()=>{document.body.style.removeProperty("cursor"),g.current&&document.removeEventListener("mousemove",g.current),x.current&&document.removeEventListener("click",x.current,!0),j.current&&document.removeEventListener("keydown",j.current),f.current&&(f.current.style.outline="",f.current.style.outlineOffset="",f.current=null)}},[l]);const E=p?rb(p.x,p.y):{left:0,top:0},I=p&&r.jsx("div",{className:"inspector-tooltip fixed z-[9999] bg-black text-white p-3 rounded-lg shadow-xl text-xs font-mono pointer-events-none",style:{left:`${E.left}px`,top:`${E.top}px`,width:"300px"},"data-test":"element-inspector-tooltip",children:r.jsxs("div",{className:"metadata-section space-y-2","data-test":"element-inspector-metadata-section",children:[r.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-tag-row",children:[r.jsx(uo,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-400"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-gray-400 text-[10px]",children:"Tag"}),r.jsxs("div",{className:"text-blue-300","data-test":"element-inspector-tag-value",children:["<",p.tagName,">"]})]})]}),p.dataTest&&r.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-data-test-row",children:[r.jsx(fs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-gray-400 text-[10px]",children:"Data Test"}),r.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-data-test-value",children:p.dataTest})]})]}),!p.dataTest&&p.classes.length>0&&r.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-classes-row",children:[r.jsx(fs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-400"}),r.jsxs("div",{children:[r.jsxs("div",{className:"text-gray-400 text-[10px]",children:["Classes (",p.classes.length,")"]}),r.jsx("div",{className:"text-green-300 break-all","data-test":"element-inspector-classes-value",children:p.classes.join(" ")})]})]}),p.reactInspectorId&&r.jsxs("div",{className:"metadata-row flex items-start gap-2","data-test":"element-inspector-file-row",children:[r.jsx(Js,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-400"}),r.jsxs("div",{children:[r.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Name"}),r.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-name",children:mr(p.resolvedPath||p.reactInspectorId)}),r.jsx("div",{className:"text-gray-400 text-[10px]",children:"File Path"}),r.jsx("div",{className:"text-purple-300 break-all","data-test":"element-inspector-file-path",children:p.resolvedPath||p.reactInspectorId||"Resolving..."})]})]}),!p.reactInspectorId&&r.jsxs("div",{className:"metadata-row flex items-start gap-2",children:[r.jsx(Js,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-gray-600"}),r.jsx("div",{children:r.jsx("div",{className:"text-gray-500 text-[10px] italic",children:"No data-react-inspector attribute"})})]})]})}),_=at.canRenderTooltip(c??null);return r.jsx(r.Fragment,{children:l&&p&&_&&(o?o(p):I)})}async function ob(s){if(!s)return;const a=s.split(":")[0].split("/").pop();if(a)try{return await dr.getFilePath(a)}catch(n){console.error("Failed to resolve inspector path:",n);return}}function ib({onElementCollected:s,onElementRemoved:e,onElementsCleared:t,renderCollectedItem:a,renderCollectedPanel:n,showDefaultPanel:o=!0,tooltipOwnerId:i,panelOwnerId:c}){const[l,u]=d.useState([]),[p,h]=d.useState(!1),[f,b]=d.useState({x:100,y:100}),v=d.useRef(!1),m=d.useRef({x:0,y:0});d.useEffect(()=>{if(c)return at.claimPanel(c),()=>{at.releasePanel(c)}},[c]);const w=d.useCallback((k,M)=>{(async()=>{const A=await ob(M.reactInspectorId)||M.reactInspectorId,P={id:`${Date.now()}-${Math.random()}`,tagName:M.tagName,classes:M.classes,dataTest:M.dataTest,reactInspectorId:M.reactInspectorId,resolvedPath:A,timestamp:Date.now()};u(z=>[...z,P]),s==null||s(P,k),Ze.success("Element collected!",{description:`<${M.tagName}>${A?` [${A}]`:""}`,duration:2e3})})()},[s]),y=d.useCallback(()=>{(l.length>0||p)&&h(!0)},[l.length,p]),g=k=>{k.target.closest(".popover-drag-handle")&&(v.current=!0,m.current={x:k.clientX-f.x,y:k.clientY-f.y})},x=d.useCallback(k=>{v.current&&b({x:k.clientX-m.current.x,y:k.clientY-m.current.y})},[]),j=d.useCallback(()=>{v.current=!1},[]);d.useEffect(()=>(p&&(document.addEventListener("mousemove",x),document.addEventListener("mouseup",j)),()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",j)}),[p,x,j]),d.useEffect(()=>{const k=M=>{M.key==="Escape"&&p&&h(!1)};return p&&document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}},[p]);const C=k=>{u(M=>M.filter(O=>O.id!==k.id)),e==null||e(k),Ze.info("Element removed from collection")},N=()=>{u([]),h(!1),t==null||t(),Ze.info("All collected elements cleared")},S=()=>{h(!1),u([]),t==null||t()},D=()=>l.map((k,M)=>{const O=k.dataTest?`[data-test="${k.dataTest}"]`:k.classes.length>0?`.${k.classes[0]}`:"",A=k.resolvedPath||"unknown";return`${M+1}. ${k.tagName}${O} inside @${A}`}).join(`
`),W=(k,M)=>r.jsxs("div",{className:"collected-element p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors","data-test":`element-inspector-collected-item-${M}`,children:[r.jsxs("div",{className:"element-header flex items-center justify-between mb-2","data-test":`element-inspector-collected-item-${M}-header`,children:[r.jsxs("div",{className:"element-index text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded","data-test":`element-inspector-collected-item-${M}-index`,children:["#",M+1]}),r.jsx("button",{onClick:()=>C(k),className:"remove-btn p-1 hover:bg-red-100 rounded transition-colors",title:"Remove element","data-test":`element-inspector-collected-item-${M}-remove-button`,children:r.jsx(Bt,{className:"w-4 h-4 text-red-600"})})]}),r.jsxs("div",{className:"element-details space-y-1 text-xs",children:[r.jsxs("div",{className:"detail-row flex items-start gap-2",children:[r.jsx(uo,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-blue-600"}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500",children:"Tag:"})," ",r.jsxs("span",{className:"font-mono text-blue-700",children:["<",k.tagName,">"]})]})]}),k.resolvedPath&&r.jsxs("div",{className:"detail-row flex items-start gap-2",children:[r.jsx(Js,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-purple-600"}),r.jsxs("div",{children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500",children:"File Name:"})," ",r.jsx("span",{className:"font-mono text-purple-700",children:mr(k.resolvedPath)}),r.jsx(Fs,{textToCopy:mr(k.resolvedPath),size:"sm"})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500",children:"File Path:"})," ",r.jsx("span",{className:"font-mono text-purple-700",children:k.resolvedPath}),r.jsx(Fs,{textToCopy:k.resolvedPath,size:"sm"})]})]})]}),k.dataTest&&r.jsxs("div",{className:"detail-row flex items-start gap-2",children:[r.jsx(fs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("span",{className:"text-gray-500",children:"Data Test:"})," ",r.jsx("span",{className:"font-mono text-green-700",children:k.dataTest}),r.jsx(Fs,{textToCopy:k.dataTest,size:"sm"})]})]}),!k.dataTest&&k.classes.length>0&&r.jsxs("div",{className:"detail-row flex items-start gap-2",children:[r.jsx(fs,{className:"w-3 h-3 mt-0.5 flex-shrink-0 text-green-600"}),r.jsxs("div",{className:"flex-1",children:[r.jsxs("span",{className:"text-gray-500",children:["Classes (",k.classes.length,"):"]}),r.jsx("div",{className:"font-mono text-green-700 text-[10px] break-all mt-1",children:k.classes.join(" ")})]})]}),r.jsx("div",{className:"timestamp text-[10px] text-gray-400 mt-2",children:new Date(k.timestamp).toLocaleTimeString()})]})]},k.id),E=r.jsxs("div",{className:"collected-elements-popover fixed z-[9999] bg-white border-2 border-purple-400 rounded-lg shadow-2xl",style:{left:`${f.x}px`,top:`${f.y}px`,width:"550px",maxHeight:"500px"},onMouseDown:g,"data-test":"element-inspector-collected-popover",children:[r.jsxs("div",{className:"popover-drag-handle popover-header bg-purple-500 text-white p-3 rounded-t-lg cursor-move flex items-center justify-between","data-test":"element-inspector-collected-header",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(Xl,{className:"w-5 h-5"}),r.jsxs("h3",{className:"font-semibold","data-test":"element-inspector-collected-title",children:["Collected Elements (",l.length,")"]})]}),r.jsxs("div",{className:"flex items-center gap-2","data-test":"element-inspector-collected-actions",children:[r.jsx(Fs,{textToCopy:D()}),r.jsx("button",{onClick:S,className:"hover:bg-purple-600 rounded p-1 transition-colors",title:"Close","data-test":"element-inspector-collected-close-button",children:r.jsx(rt,{className:"w-5 h-5"})})]})]}),r.jsxs(bc,{defaultValue:"list",className:"popover-tabs","data-test":"element-inspector-collected-tabs",children:[r.jsxs($r,{className:"tabs-list grid w-full grid-cols-2 mx-3 mt-3","data-test":"element-inspector-collected-tabs-list",children:[r.jsx(ws,{value:"list","data-test":"element-inspector-collected-list-tab",children:"List View"}),r.jsx(ws,{value:"text","data-test":"element-inspector-collected-text-tab",children:"Text View"})]}),r.jsxs(ys,{value:"list",className:"tabs-content m-0","data-test":"element-inspector-collected-list-content",children:[r.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4 space-y-2","data-test":"element-inspector-collected-list",children:l.map((k,M)=>a?a(k,M,()=>W(k,M)):W(k,M))}),r.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-list-footer",children:r.jsxs(ne,{onClick:N,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-clear-all-button",children:[r.jsx(Bt,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]}),r.jsxs(ys,{value:"text",className:"tabs-content m-0","data-test":"element-inspector-collected-text-content",children:[r.jsx("div",{className:"popover-content max-h-[330px] overflow-y-auto p-4","data-test":"element-inspector-collected-text",children:r.jsx("pre",{className:"text-xs font-mono text-gray-800 whitespace-pre-wrap break-words bg-gray-50 p-3 rounded border border-gray-200","data-test":"element-inspector-collected-text-formatted",children:D()})}),r.jsx("div",{className:"popover-footer p-3 border-t border-gray-200 bg-gray-50","data-test":"element-inspector-collected-text-footer",children:r.jsxs(ne,{onClick:N,variant:"destructive",size:"sm",className:"w-full","data-test":"element-inspector-collected-text-clear-all-button",children:[r.jsx(Bt,{className:"w-4 h-4 mr-2"}),"Clear All (",l.length,")"]})})]})]})]}),I=at.canRenderPanel(c??null),_=o&&p&&l.length>0&&I,U=n?n(l,E):E;return r.jsxs(r.Fragment,{children:[r.jsx(nb,{tooltipOwnerId:i,onElementClicked:w,onInspectorDeactivated:y}),_&&U]})}const cb=({...s})=>{const{theme:e="system"}=Mc();return r.jsx(Lc,{theme:e,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...s})};function lb({navigate:s}){return[{id:"nav-home",label:"Go to Home",shortcut:"Ctrl+H",action:()=>s("/"),group:"Navigation"},{id:"nav-chat",label:"Go to Chat",action:()=>s("/chat"),group:"Navigation"},{id:"nav-demo",label:"Go to Demo",action:()=>s("/demo"),group:"Navigation"},{id:"nav-settings",label:"Go to Settings",action:()=>s("/settings"),group:"Navigation"},{id:"nav-todo",label:"Go to Todo",action:()=>s("/todo"),group:"Navigation"},{id:"nav-kanban",label:"Go to Kanban Board",action:()=>s("/todo/kanban"),group:"Navigation"},{id:"nav-content",label:"Go to Content",action:()=>s("/content"),group:"Navigation"},{id:"nav-vocabulary",label:"Go to Vocabulary",action:()=>s("/vocabulary"),group:"Navigation"},{id:"nav-live-transcription",label:"Go to Live Transcription",action:()=>s("/live-transcription"),group:"Navigation"},{id:"nav-claude",label:"Go to Claude",action:()=>s("/claude"),group:"Navigation"},{id:"nav-state",label:"Go to Global State",action:()=>s("/state"),group:"Navigation"},{id:"toggle-element-inspector",label:"Toggle Element Inspector",shortcut:"Ctrl+Shift+I",action:()=>{at.toggle();const e=at.getState();Ze.success(`Element Inspector ${e?"activated":"deactivated"}`,{description:e?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})},group:"Tools"},{id:"toggle-fullscreen",label:"Toggle Fullscreen",shortcut:"F11",action:()=>{document.fullscreenElement?document.exitFullscreen().then(()=>{Ze.success("Fullscreen mode deactivated",{duration:2e3})}).catch(e=>{Ze.error("Failed to exit fullscreen",{description:e.message,duration:3e3})}):document.documentElement.requestFullscreen().then(()=>{Ze.success("Fullscreen mode activated",{description:"Press F11 or ESC to exit fullscreen",duration:2e3})}).catch(e=>{Ze.error("Failed to enter fullscreen",{description:e.message,duration:3e3})})},group:"Tools"}]}function db(){const{logs:s,actions:e}=po(),t=gr(),a=Sn(),[n,o]=d.useState(null);cd({loadOnMount:!0,subscribeToSSE:!1}),hd({loadOnMount:!0}),fd(),d.useEffect(()=>{localStorage.getItem("VITE_CLEAR_LOGS_ON_RELOAD"),Ie.clientLogsService.clearLogs(),Ie.clientLogsApiClient.clearLogs("spec-view-debug.log"),Ie.clientLogsApiClient.clearLogs("write-mode-debug.log","/new-home"),Ie.clientLogsApiClient.clearLogs("vim-client.log"),Ie.clientLogsApiClient.clearJsonLogs("arrow-debug.json"),Ie.clientLogsApiClient.clearJsonLogs("arrow-fixture.json")},[t.pathname]);const i=lb({navigate:a});return d.useEffect(()=>{(async()=>{})()},[]),d.useEffect(()=>{const c=Qt.register({key:"c",callback:()=>{console.clear(),Ze.success("Console cleared",{duration:1500})}});return()=>c()},[]),d.useEffect(()=>{document.title=ru(t.pathname)},[t.pathname]),r.jsxs(So,{defaultOpen:!1,children:[r.jsx(Qx,{actions:i}),r.jsx(sb,{}),r.jsx(ib,{}),r.jsx(cb,{}),r.jsx(cu,{}),r.jsx(No,{className:"h-screen overflow-hidden",children:r.jsxs("div",{className:"h-full bg-background flex flex-col",children:[r.jsx(Vx,{version:n}),r.jsx("main",{className:"flex-1 flex flex-col min-h-0",children:r.jsx(nu,{logger:e,logs:s})})]})})]})}Pc.createRoot(document.getElementById("root")).render(r.jsx(du,{defaultTheme:"light",storageKey:"watcher-ui-theme",children:r.jsx(_c,{children:r.jsx(db,{})})}));export{Qe as $,fp as A,ne as B,ks as C,Ar as D,yt as E,$r as F,ws as G,ys as H,Ue as I,Qo as J,cd as K,Fb as L,Ur as M,nt as N,qh as O,hx as P,Z as Q,ox as R,It as S,bc as T,ix as U,Me as V,R as W,Jg as X,Xg as Y,Zb as Z,ze as _,jt as a,Xs as a$,ev as a0,Gr as a1,Vr as a2,qr as a3,Pu as a4,_u as a5,Fo as a6,Wo as a7,wt as a8,Cr as a9,Cb as aA,dr as aB,Kh as aC,Uo as aD,Ke as aE,Fe as aF,Tb as aG,He as aH,rc as aI,Jf as aJ,ca as aK,xt as aL,md as aM,Lx as aN,ax as aO,xc as aP,pu as aQ,Cc as aR,hc as aS,yd as aT,xb as aU,pe as aV,bd as aW,xo as aX,Qt as aY,Hr as aZ,Qs as a_,mo as aa,aa as ab,vt as ac,Yr as ad,Go as ae,Ho as af,jr as ag,_t as ah,mc as ai,_e as aj,Ct as ak,pa as al,Qb as am,Sg as an,Ge as ao,Xe as ap,We as aq,fo as ar,Ae as as,Mo as at,at as au,nb as av,ib as aw,rb as ax,Bg as ay,qa as az,Rt as b,Xb as b$,Ys as b0,ms as b1,Yb as b2,Nr as b3,Oe as b4,Ie as b5,Lb as b6,Db as b7,Ob as b8,Mb as b9,yb as bA,ta as bB,sa as bC,gs as bD,Do as bE,vu as bF,fr as bG,us as bH,qs as bI,sv as bJ,tv as bK,qe as bL,Ax as bM,Fu as bN,jg as bO,qx as bP,fa as bQ,Cg as bR,La as bS,Gf as bT,$g as bU,Ut as bV,cg as bW,Rr as bX,Ef as bY,Qm as bZ,Vf as b_,Lh as ba,Pb as bb,_b as bc,Bh as bd,$b as be,Ub as bf,Wb as bg,zb as bh,Bb as bi,Hb as bj,Gb as bk,Vb as bl,ya as bm,Ns as bn,Es as bo,Xt as bp,Dt as bq,Gx as br,Nc as bs,Qa as bt,yx as bu,Ox as bv,Et as bw,Tt as bx,vx as by,ea as bz,Nt as c,qb as c0,Gs as c1,cr as c2,fn as c3,Kb as c4,Ls as c5,Ab as c6,jb as c7,Nb as c8,mp as c9,Xo as ca,Jb as cb,Ce as cc,Sb as cd,Du as ce,Ou as cf,$u as cg,Uu as ch,Eb as ci,kb as cj,Ib as ck,Rb as cl,wb as cm,bb as cn,vb as co,we as d,So as e,Co as f,Eo as g,ko as h,Rd as i,Pd as j,Dd as k,To as l,cs as m,ls as n,No as o,jo as p,tt as q,kr as r,Tr as s,Iu as t,Ts as u,_a as v,Je as w,st as x,wa as y,le as z};
