import{j as e,d as K,r as i,h as we,u as Se}from"./react-vendor-Byz07MLO.js";import{t as P}from"./utils-G1l1U0hd.js";import{H as T,aQ as X,a as x,r as ee,aR as Ie,ak as ze,C as q,b as Q,c as Y,l as Fe,L,e as Z,aj as Pe,aS as Te,aT as Me,aU as Ee,a2 as J,al as Le,am as Oe,I as Ae}from"./index-hTFRJyrx.js";import{T as $e}from"./textarea-ZFIB_HyS.js";import{G as w,aY as O,M as Re,aZ as De,c as He,T as Ue,F as Ve,a_ as We,l as Be,V as Ge,O as _e,e as qe}from"./icons-yhbeTEay.js";import{Tree as Qe}from"./tree-CNsSXVP0.js";import"./radix-ui-9f16WUVy.js";import"./ui-utils-BxIQ3qGg.js";function Ye({fork:a,isSelected:n=!1,onClick:l,onToggleFavorite:t,onEdit:d,onDelete:c,sessionName:p,messageCount:u}){const g=()=>{l==null||l(a)},m=f=>{f.stopPropagation(),t==null||t(a)},r=f=>{f.stopPropagation(),d==null||d(a)},o=f=>{f.stopPropagation(),c==null||c(a)};return e.jsxs("div",{"data-test":"fork-list-item",className:T("fork-list-item group relative p-3 rounded-lg border cursor-pointer transition-colors",n?"bg-primary/10 border-primary":"hover:bg-accent border-transparent hover:border-border"),onClick:g,children:[e.jsxs("div",{"data-test":"fork-list-item-header",className:"fork-list-item-header flex items-start gap-2",children:[e.jsx(w,{size:16,className:"mt-0.5 flex-shrink-0 text-muted-foreground","data-test":"fork-list-item-icon"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{"data-test":"fork-list-item-name",className:"fork-list-item-name font-medium text-sm truncate",children:a.sessionName||a.description||"Unnamed Fork"}),a.isFavorite&&e.jsx(O,{size:12,className:"flex-shrink-0 fill-yellow-400 text-yellow-400","data-test":"fork-list-item-favorite-icon"})]}),p&&e.jsx("div",{"data-test":"fork-list-item-session",className:"fork-list-item-session text-xs text-muted-foreground truncate",children:p})]})]}),e.jsxs("div",{"data-test":"fork-list-item-meta",className:"fork-list-item-meta mt-2 flex items-center gap-3 text-xs text-muted-foreground",children:[u!==void 0&&e.jsxs("span",{className:"flex items-center gap-1","data-test":"fork-list-item-message-count",children:[e.jsx(Re,{size:10}),u," messages"]}),e.jsxs("span",{className:"flex items-center gap-1","data-test":"fork-list-item-date",children:[e.jsx(De,{size:10}),X(a.forkedAt)]})]}),e.jsxs("div",{"data-test":"fork-list-item-actions",className:T("fork-list-item-actions absolute right-2 top-2 flex gap-1","opacity-0 group-hover:opacity-100 transition-opacity"),children:[t&&e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:m,"data-test":"fork-list-item-favorite-btn",title:a.isFavorite?"Remove from favorites":"Add to favorites",children:e.jsx(O,{size:12,className:T(a.isFavorite&&"fill-yellow-400 text-yellow-400")})}),d&&e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:r,"data-test":"fork-list-item-edit-btn",title:"Edit fork",children:e.jsx(He,{size:12})}),c&&e.jsx(x,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:text-destructive",onClick:o,"data-test":"fork-list-item-delete-btn",title:"Delete fork",children:e.jsx(Ue,{size:12})})]})]})}function se(a){const l=!!a.forkedAt?e.jsx(w,{size:14,className:"text-muted-foreground"}):e.jsx(Ve,{size:14,className:"text-muted-foreground"});return{id:a.sessionId,label:a.customName||a.name||`Session ${a.sessionId.slice(0,8)}`,icon:l,data:a,children:a.children.map(se)}}function te(a){const n=new Set([a.sessionId]);for(const l of a.children)te(l).forEach(d=>n.add(d));return n}function Ze({tree:a,selectedSessionId:n,loading:l=!1,error:t,onSessionSelect:d}){const c=K(),p=i.useMemo(()=>a?[se(a)]:[],[a]),u=i.useMemo(()=>a?te(a):new Set,[a]),g=r=>{d?d(r.id):c(`/claude/${r.id}`)},m=(r,o,f)=>{const h=r.data;return e.jsxs("div",{"data-test":`fork-tree-node-${r.id}`,className:T("fork-tree-node flex items-center py-2 px-3 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors",o&&"bg-primary/10 border border-primary"),onClick:f,children:[e.jsx("div",{className:"fork-tree-node-icon w-4 h-4 mr-2 flex-shrink-0"}),r.icon&&e.jsx("div",{className:"fork-tree-node-custom-icon mr-2 flex-shrink-0","data-test":"fork-tree-node-icon",children:r.icon}),e.jsxs("div",{className:"fork-tree-node-content flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"fork-tree-node-label truncate","data-test":"fork-tree-node-label",children:r.label}),(h==null?void 0:h.isFavorite)&&e.jsx(O,{size:12,className:"flex-shrink-0 fill-yellow-400 text-yellow-400","data-test":"fork-tree-node-favorite"})]}),(h==null?void 0:h.forkedAt)&&e.jsx("div",{className:"text-xs text-muted-foreground","data-test":"fork-tree-node-meta",children:X(h.forkedAt)})]})]})};return l?e.jsx("div",{"data-test":"fork-tree-loading",className:"fork-tree-loading flex items-center justify-center h-full",children:e.jsx("div",{className:"text-muted-foreground animate-pulse",children:"Loading fork tree..."})}):t?e.jsx("div",{"data-test":"fork-tree-error",className:"fork-tree-error flex items-center justify-center h-full text-destructive",children:t}):!a||p.length===0?e.jsxs("div",{"data-test":"fork-tree-empty",className:"fork-tree-empty flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(w,{size:48,className:"mb-4 opacity-50"}),e.jsx("p",{children:"No fork tree available"}),e.jsx("p",{className:"text-sm",children:"Select a session to view its fork hierarchy"})]}):e.jsx("div",{"data-test":"fork-tree-visualization",className:"fork-tree-visualization h-full",children:e.jsx(Qe,{data:p,onItemClick:g,defaultExpandedIds:u,selectedId:n,renderLeaf:m,className:"p-2"})})}function Je(){const[a,n]=i.useState(null),[l,t]=i.useState(0),[d,c]=i.useState(!1),[p,u]=i.useState(null),g=i.useCallback(async r=>{c(!0),u(null);try{const o=await ee.getForkTree(r);n(o.root),t(o.totalNodes)}catch(o){console.error("[useForkTree] Failed to load fork tree:",{sessionId:r,error:o,errorMessage:o instanceof Error?o.message:"Unknown error",timestamp:new Date().toISOString()}),u(o instanceof Error?o.message:"Failed to load fork tree"),n(null),t(0)}finally{c(!1)}},[]),m=i.useCallback(()=>{n(null),t(0),u(null)},[]);return{tree:a,totalNodes:l,loading:d,error:p,loadTree:g,clearTree:m}}function os(){const[a]=we(),{forkId:n}=Se(),l=K(),[t,d]=i.useState(null),[c,p]=i.useState(null),[u,g]=i.useState(!1),[m,r]=i.useState(null),[o,f]=i.useState(""),[h,M]=i.useState(""),[N,A]=i.useState(!1),b=a.get("sessionId"),{forks:y,loading:E,error:$,pagination:k,currentPage:C,favoritesOnly:R,refreshForks:S,loadForks:D,toggleFavoritesOnly:H,toggleFavorite:U,updateFork:V,deleteFork:W}=Ie({loadOnMount:!0,parentSessionId:b??void 0,pageSize:20}),{tree:ae,loading:ie,error:re,loadTree:I}=Je(),{messages:oe,sessionDetails:j,metadata:ne,loading:le,pagination:de,loadOlderMessages:ce,refreshSession:B,addOptimisticMessage:me,removeOptimisticMessage:fe}=ze(c,{loadOnMount:!0,subscribeToSSE:!0}),G=i.useMemo(()=>{const s=Math.round(window.innerWidth*.6),v=Math.round(window.innerHeight*.8),F=Math.round((window.innerWidth-s)/2),Ce=Math.round((window.innerHeight-v)/2);return{size:{width:s,height:v},position:{x:F,y:Ce}}},[]);i.useEffect(()=>{if(n&&y.length>0){const s=y.find(v=>String(v.id)===n);s&&(t==null?void 0:t.id)!==s.id&&d(s)}},[n,y,t==null?void 0:t.id]),i.useEffect(()=>{const s=(t==null?void 0:t.sessionId)??b;s&&I(s)},[t==null?void 0:t.sessionId,b,I]);const he=i.useCallback(s=>{d(s),l(`/claude/forks/${s.id}`)},[l]),ue=i.useCallback(s=>{U(s.sessionId)},[U]),xe=i.useCallback(async s=>{window.confirm(`Are you sure you want to delete this fork${s.description?` "${s.description}"`:""}?`)&&(await W(s.sessionId),(t==null?void 0:t.id)===s.id&&d(null))},[W,t]),pe=i.useCallback(s=>{r(s),f(s.sessionName??""),M(s.description??"")},[]),z=i.useCallback(()=>{r(null),f(""),M("")},[]),ge=i.useCallback(async()=>{if(m){A(!0);try{const s=[],v=h.trim()||void 0;v!==m.description&&s.push(V(m.sessionId,{description:v}));const F=o.trim()||null;F!==(m.sessionName??null)&&s.push(ee.updateSessionName(m.sessionId,F)),s.length>0&&(await Promise.all(s),P.success("Fork updated"),S()),z()}catch{P.error("Failed to update fork")}finally{A(!1)}}},[m,o,h,V,S,z]),ke=i.useCallback(s=>{p(s),g(!0)},[]),je=i.useCallback(()=>{g(!1)},[]),ve=i.useCallback(()=>{S();const s=(t==null?void 0:t.sessionId)??b;s&&I(s)},[S,I,t==null?void 0:t.sessionId,b]),_=i.useCallback(s=>{D(s)},[D]),Ne=i.useCallback(()=>{H()},[H]),be=i.useCallback(s=>s.length<=19?s:`${s.slice(0,8)}...${s.slice(-8)}`,[]),ye=i.useCallback(async s=>{try{await navigator.clipboard.writeText(s),P.success("Session ID copied")}catch{P.error("Failed to copy")}},[]);return e.jsxs("div",{"data-test":"forks-page",className:"forks-page h-full p-4 overflow-hidden",children:[e.jsxs("div",{className:"forks-page-layout grid grid-cols-[350px_1fr] gap-4 h-full overflow-hidden",children:[e.jsxs(q,{"data-test":"forks-sidebar",className:"forks-sidebar flex flex-col overflow-hidden",children:[e.jsxs(Q,{className:"flex-shrink-0 pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Y,{className:"flex items-center gap-2 text-lg",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>l("/claude"),"data-test":"forks-back-btn",title:"Back to Sessions",children:e.jsx(We,{size:16})}),e.jsx(w,{size:18}),"Forks",k&&k.totalCount>0&&e.jsxs("span",{"data-test":"forks-count",className:"text-sm font-normal text-muted-foreground",children:["(",k.totalCount,")"]})]}),e.jsx(x,{variant:"ghost",size:"icon",onClick:ve,disabled:E,"data-test":"forks-refresh-btn",title:"Refresh",children:e.jsx(Be,{size:16,className:E?"animate-spin":""})})]}),e.jsx("div",{className:"flex items-center gap-4 mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{id:"favorites-only",checked:R,onCheckedChange:()=>Ne(),"data-test":"forks-favorites-toggle"}),e.jsx(L,{htmlFor:"favorites-only",className:"text-sm",children:"Favorites only"})]})})]}),e.jsx(Z,{className:"flex-1 min-h-0 p-0",children:e.jsx(Pe,{"data-test":"forks-list",className:"forks-list h-full px-4",children:E?e.jsx("div",{"data-test":"forks-loading",className:"flex items-center justify-center py-8 text-muted-foreground",children:"Loading forks..."}):$?e.jsx("div",{"data-test":"forks-error",className:"flex items-center justify-center py-8 text-destructive",children:$}):y.length===0?e.jsxs("div",{"data-test":"forks-empty",className:"flex flex-col items-center justify-center py-8 text-muted-foreground",children:[e.jsx(w,{size:32,className:"mb-2 opacity-50"}),e.jsx("p",{children:R?"No favorite forks":"No forks yet"}),e.jsx("p",{className:"text-sm",children:"Create a fork from any session to start exploring alternatives"})]}):e.jsx("div",{className:"space-y-2 py-2",children:y.map(s=>e.jsx(Ye,{fork:s,isSelected:(t==null?void 0:t.id)===s.id,onClick:he,onToggleFavorite:ue,onEdit:pe,onDelete:xe},s.id))})})}),k&&k.totalPages>1&&e.jsxs("div",{"data-test":"forks-pagination",className:"forks-pagination flex items-center justify-between px-4 py-2 border-t",children:[e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>_(C-1),disabled:C<=1,"data-test":"forks-prev-page",children:[e.jsx(Ge,{size:16}),"Previous"]}),e.jsxs("span",{className:"text-sm text-muted-foreground","data-test":"forks-page-info",children:["Page ",C," of ",k.totalPages]}),e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>_(C+1),disabled:C>=k.totalPages,"data-test":"forks-next-page",children:["Next",e.jsx(_e,{size:16})]})]})]}),e.jsxs(q,{"data-test":"forks-tree-panel",className:"forks-tree-panel flex flex-col overflow-hidden",children:[e.jsxs(Q,{className:"flex-shrink-0 pb-2",children:[e.jsx(Y,{className:"text-lg",children:"Fork Tree"}),t&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground","data-test":"forks-tree-panel-selected",children:["Viewing: ",t.sessionName||t.description||`Fork ${t.sessionId.slice(0,8)}`]}),e.jsxs("div",{className:"flex items-center gap-1","data-test":"forks-tree-panel-session-id",children:[e.jsxs(Te,{children:[e.jsx(Me,{asChild:!0,children:e.jsx("span",{className:"text-xs font-mono text-muted-foreground cursor-default",children:be(t.sessionId)})}),e.jsx(Ee,{children:e.jsx("span",{className:"font-mono text-xs",children:t.sessionId})})]}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-5 w-5",onClick:()=>ye(t.sessionId),"data-test":"forks-tree-panel-copy-id",title:"Copy session ID",children:e.jsx(qe,{size:12})})]})]})]}),e.jsx(Z,{className:"flex-1 min-h-0 p-0",children:e.jsx(Ze,{tree:ae,selectedSessionId:t==null?void 0:t.sessionId,loading:ie,error:re??void 0,onSessionSelect:ke})})]})]}),e.jsx(J,{isVisible:u,onClose:je,title:(j==null?void 0:j.customName)??(j==null?void 0:j.name)??"Session Chat",shouldCloseManually:!0,resizable:!0,initialSize:G.size,initialPosition:G.position,children:e.jsxs("div",{className:"flex flex-col h-full","data-test":"fork-chat-popover-content",children:[e.jsx("div",{className:"flex-1 overflow-auto","data-test":"fork-chat-messages-area",children:e.jsx(Le,{messages:oe,sessionDetails:j,metadata:ne,loading:le,pagination:de,onLoadOlder:ce,onNameUpdated:B})}),c&&e.jsx("div",{className:"border-t p-2","data-test":"fork-chat-input-area",children:e.jsx(Oe,{sessionId:c,onSendSuccess:()=>{B()},onAddOptimisticMessage:me,onRemoveOptimisticMessage:fe})})]})}),e.jsx(J,{isVisible:m!==null,onClose:z,title:"Edit Fork",shouldCloseManually:!0,resizable:!1,initialSize:{width:400,height:380},initialPosition:{x:Math.round((window.innerWidth-400)/2),y:Math.round((window.innerHeight-380)/2)},children:e.jsxs("div",{className:"p-4 flex flex-col gap-4","data-test":"fork-edit-popover-content",children:[e.jsxs("div",{"data-test":"fork-edit-name-field",className:"space-y-2",children:[e.jsx(L,{htmlFor:"fork-edit-name",children:"Name"}),e.jsx(Ae,{id:"fork-edit-name","data-test":"fork-edit-name-input",placeholder:"Fork name...",value:o,onChange:s=>f(s.target.value),disabled:N})]}),e.jsxs("div",{"data-test":"fork-edit-description-field",className:"space-y-2",children:[e.jsx(L,{htmlFor:"fork-edit-description",children:"Description"}),e.jsx($e,{id:"fork-edit-description","data-test":"fork-edit-description-input",placeholder:"Why was this fork created?",value:h,onChange:s=>M(s.target.value),disabled:N,rows:3,className:"resize-none"})]}),e.jsxs("div",{"data-test":"fork-edit-actions",className:"flex justify-end gap-2",children:[e.jsx(x,{variant:"outline",onClick:z,disabled:N,"data-test":"fork-edit-cancel",children:"Cancel"}),e.jsx(x,{onClick:ge,disabled:N,"data-test":"fork-edit-submit",children:N?"Saving...":"Save"})]})]})})]})}export{os as ForksPage};
