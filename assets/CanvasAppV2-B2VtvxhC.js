const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-hTFRJyrx.js","assets/react-vendor-Byz07MLO.js","assets/utils-G1l1U0hd.js","assets/radix-ui-9f16WUVy.js","assets/ui-utils-BxIQ3qGg.js","assets/icons-yhbeTEay.js","assets/index-DQUCd7wI.css"])))=>i.map(i=>d[i]);
var cd=Object.defineProperty;var ld=(e,s,n)=>s in e?cd(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n;var Oe=(e,s,n)=>ld(e,typeof s!="symbol"?s+"":s,n);import{R as Ce,j as t,r as p,b as Ys}from"./react-vendor-Byz07MLO.js";import{c1 as xn,b8 as E,c2 as xs,c3 as Q,c4 as xt,aK as Re,aJ as de,c5 as ws,ap as se,c6 as Ct,c7 as be,c8 as Ls,aM as pe,aP as dd,aL as ud,aO as gs,c9 as ct,ca as Ws,cb as ro,cc as wn,cd as Ge,ce as mt,aB as ic,cf as Rn,cg as cc,ch as hd,ci as io,be as Tt,aq as ke,a as ee,H as we,b3 as Xt,aS as Lt,aT as Wt,aU as $t,cj as pd,ck as Ba,aN as gr,cl as fr,w as co,y as Ha,b$ as lo,x as lc,bI as dc,bJ as gd,bK as uc,bL as hc,bM as pc,a2 as Be,I as Ae,aH as fd,ar as ot,as as at,at as rt,cm as md,cn as gc,S as lt,h as dt,i as ut,j as ht,k as Ue,a7 as De,a3 as uo,a4 as ho,a5 as po,a6 as It,L as je,T as xd,m as wd,n as mr,o as xr,co as Zt,B as qe,l as go,aR as yd,cp as vd,bC as wr,bD as bd,cq as Nd,aX as Sd,g as Oo,an as Fa,b4 as fc,cr as Cd,z as ls,O as ds,E as us,cs as jd,ct as kd,cu as hs,F as Vt,a9 as yr,aj as $s,cv as Ad,cw as Id,cx as Td,cy as Ed,cz as Rd,cA as Ko,cB as Md,cC as Pd,cD as wa,cE as Dd,cF as mc,cG as xc,cH as Jn,cI as wc,cJ as Od,cK as Ld,s as Qs,cL as Wd,ae as $d,cM as Xo,cN as Bd,cO as Hd,cP as Fd,cQ as yc,u as _d,ak as zd,al as Ud,am as Vd,r as ya,cR as Gd,cS as Yd,b1 as vr,cT as Kd,cU as Xd,bw as qd,bx as Zd,by as qo,bz as Zo,cV as Jo,av as Jd,bN as Qd,bO as eu,cW as tu,cX as $n,a$ as su,b0 as nu,cY as ou,cZ as au}from"./index-hTFRJyrx.js";import{g as ru,c as Xe,V as hn,I as vc,K as iu,S as cu,C as lu,R as du,a as uu,d as hu}from"./VimInputHandlerV2-CJwq8Ehj.js";import{t as ve}from"./utils-G1l1U0hd.js";import{a as Se}from"./ui-utils-BxIQ3qGg.js";import{b3 as br,y as Mn,b2 as _a,as as fo,c0 as vn,g as Et,C as Bs,az as pu,b as gu,I as fu,aS as Qn,bS as Lo,aJ as fs,b9 as bc,a as Ze,ac as mu,N as xu,c3 as wu,af as Nc,T as pt,c4 as yu,c5 as vu,a7 as Sc,Z as bu,aR as Nu,c6 as Su,aX as Kt,c as Hs,br as za,c7 as Cc,S as qt,e as Mt,h as bn,c8 as jc,bq as Cu,c9 as ju,aY as Es,bs as kc,a2 as wt,ca as ku,cb as Ua,cc as Au,cd as Iu,ce as Tu,cf as Eu,cg as Ru,ch as Mu,Q as Pu,aG as Pn,ab as mo,ci as Va,cj as Du,B as Ac,o as Ic,ck as Tc,cl as Ec,cm as Rc,cn as Mc,ag as Ga,co as Nn,cp as Pc,cq as Dc,cr as Ou,M as Lu,L as Nr,cs as Ht,ct as ps,bd as Sn,be as Cn,a_ as Fs,cu as Wo,cv as va,aL as Wu,cw as Sr,ae as Oc,bu as Dn,A as jn,J as kn,cx as Ya,cy as Ka,H as Lc,cz as eo,bh as An,cA as Wc,aM as Xa,l as qa,bC as $u,cB as Bu,W as $o,bt as Za,ao as ns,R as Bo,cC as Hu,cD as Fu,cE as _u,bK as zu,cF as Uu,cG as Vu,cH as $c,cI as Ja,X as We,ar as In,bW as Bc,cJ as Hc,G as Gu,aZ as Yu,bP as Ku,O as Ks,c2 as Xu,a3 as ms,b0 as Ho,d as On,q as qu,$ as Fc,E as os,cK as Fo,aW as Zu,a4 as Ju,U as Tn,ai as ba,cL as Qu,cM as _c,cN as Na,F as eh,cO as Cr,cP as jr,cQ as xo,aO as th,z as Rs,D as to,_ as zc,b6 as sh,cR as nh,aa as Uc,aH as oh,b1 as ah,cS as rh,cT as ih,cU as ch,cV as lh,cW as dh,bi as uh,bj as hh,bZ as ph,cX as gh,bU as fh,bV as mh,a1 as xh,am as wh,cY as yh,cZ as vh,bk as bh,c_ as Nh,V as Sh,c$ as Ch,bl as jh}from"./icons-yhbeTEay.js";import{V as Ot,E as kh,D as Ah}from"./logging-CYRX986s.js";import{U as En}from"./UiButtonWithExpandOption-CPX53qLO.js";import{T as Ih}from"./TextareaPopoverAtCursor-DB-dMS5D.js";import{d as Th,t as kr}from"./definitionHelper-CZKT8hW2.js";import{T as Qa}from"./textarea-ZFIB_HyS.js";import{D as _s}from"./DraggableCrudTree-BWkC8K4c.js";import{globalFacadeRegistry as tt}from"./globalFacadeRegistry-BlelMPVg.js";import{W as zs,S as yn,C as Eh,a as Rh,N as Mh,I as Ph,e as Ar}from"./WorkflowRowItem-D-fkRf8u.js";import{a as Dh,U as Oh}from"./UiDataTable-Dfde_OFA.js";import{R as Lh,a as Ir,S as Wh}from"./SessionSidebar-CSfwOUNw.js";import{a as Tr}from"./markdownToHtml-C-4HvgxL.js";import{D as $h}from"./DragDropManager-CacIWg_Z.js";import{D as Bh}from"./DraggableTree-h_RnWs_o.js";import{u as Hh}from"./useOcr-7vtWixZN.js";import{A as Fh,a as _h}from"./alert-BYqYRHel.js";import{J as Vc}from"./JsonViewerApp-BHZpouoC.js";import{b as zh,c as en,e as Qo,h as Uh,i as Vh,j as Gh,C as Yh,a as Kh}from"./context-menu-VDENXG3G.js";import{a as Xh,b as qh}from"./easy-form-gMDj6oBZ.js";import{u as Zh,S as Jh}from"./SlashCommandMenu-bphscUeq.js";import{g as Qh}from"./cursorPosition-otMhJ5rZ.js";import{a as Er}from"./string-4WCj7OpV.js";import{u as ep,b as tp,a as sp}from"./react-hooks-CNdHs55p.js";const np=e=>e;function jt(e,s=np){const n=Ce.useSyncExternalStore(e.subscribe,Ce.useCallback(()=>s(e.getState()),[e,s]),Ce.useCallback(()=>s(e.getInitialState()),[e,s]));return Ce.useDebugValue(n),n}const ys=[],H=e=>jt(E,e),Us=e=>jt(xn,e),op=(e,s)=>e.replace(/(\d+\.\d+)/g,n=>parseFloat(n).toFixed(s)),ap=(e,s,n)=>{var a,i;if(s===0&&n===0)return e;let o="",r=0;for(;r<e.length;){const c=e[r];if(/[A-Za-z]/.test(c)){o+=c,r++;continue}if(/[\s,]/.test(c)){o+=c,r++;continue}let l="";for(;r<e.length&&/[\d.\-+eE]/.test(e[r]);)l+=e[r],r++;if(l){const d=((i=(a=o.match(/[A-Za-z](?=[^A-Za-z]*$)/))==null?void 0:a[0])==null?void 0:i.toUpperCase())||"M",h=(o.slice(o.lastIndexOf(d)+1).match(/-?\d+\.?\d*/g)||[]).length,f=parseFloat(l);let g=f;if(d==="H")g=f+s;else if(d==="V")g=f+n;else if(d==="A"){const y=h%7;y===5?g=f+s:y===6&&(g=f+n)}else h%2===0?g=f+s:g=f+n;o+=g}}return o},rp=(e,s)=>{if(s>=1||e.length<=2)return e;const n=Math.max(1,Math.floor(1/s)),o=[];o.push(e[0]);for(let r=n;r<e.length-1;r+=n)o.push(e[r]);return e.length>1&&o.push(e[e.length-1]),o},Gc=(e,s)=>{const n=s/100,o=Math.max(0,Math.floor(s/100*4));return{points:rp(e.points,n),smoothedPath:op(e.smoothedPath,o)}},Yc=(e,s)=>e.type==="freehand"&&e.stroke?{...e,stroke:Gc(e.stroke,s)}:e,Kc=(e,s)=>{if(s>=100)return e;const n={...e};return e.stroke&&(n.stroke=Gc(e.stroke,s)),e.elements&&(n.elements=e.elements.map(o=>Yc(o,s))),n},Xc=p.createContext(null),ip=({children:e,value:s})=>t.jsx(Xc.Provider,{value:s,children:e}),er=()=>{const e=p.useContext(Xc);if(e===null)throw new Error("useCanvasRef must be used within a CanvasRefProvider");return e},cp=e=>{const s=er(),n=p.useRef(e);p.useEffect(()=>{n.current=e},[e]),p.useEffect(()=>{const o=s.current;if(!o)return;const r=N=>{var C,R;const j=["[data-prevent-canvas-click]"],k=N.target;j.some(I=>k.closest(I))||(R=(C=n.current.pointer)==null?void 0:C.onPointerDown)==null||R.call(C,N)},a=N=>{var R,I;const j=['[data-prevent-canvas-click="true"]'],k=N.target;if(j.some(M=>k.closest(M)))return;const C=N;(I=(R=n.current.pointer)==null?void 0:R.onDblClick)==null||I.call(R,C)},i=N=>{var j,k;return(k=(j=n.current.pointer)==null?void 0:j.onPointerMove)==null?void 0:k.call(j,N)},c=N=>{var j,k;return(k=(j=n.current.pointer)==null?void 0:j.onPointerUp)==null?void 0:k.call(j,N)},l=N=>{var j,k;return(k=(j=n.current.pointer)==null?void 0:j.onPointerLeave)==null?void 0:k.call(j,N)},d=N=>{var C,R;const j=["#itemList"],k=N.target;j.some(I=>k.closest(I))||(R=(C=n.current).wheel)==null||R.call(C,N)},u=N=>{var j,k;return(k=(j=n.current.keyboard)==null?void 0:j.onKeyDown)==null?void 0:k.call(j,N)},h=N=>{var j,k;return(k=(j=n.current.keyboard)==null?void 0:j.onKeyUp)==null?void 0:k.call(j,N)},f=N=>{var j,k;return(k=(j=n.current.keyboard)==null?void 0:j.onCopy)==null?void 0:k.call(j,N)},g=N=>{var j,k;return(k=(j=n.current.touch)==null?void 0:j.onTouchStart)==null?void 0:k.call(j,N)},y=N=>{var j,k;return(k=(j=n.current.touch)==null?void 0:j.onTouchMove)==null?void 0:k.call(j,N)},m=N=>{var j,k;return(k=(j=n.current.touch)==null?void 0:j.onTouchEnd)==null?void 0:k.call(j,N)},{pointer:x,wheel:w,touch:v,keyboard:b}=e;return x!=null&&x.onPointerDown&&o.addEventListener("pointerdown",r),x!=null&&x.onDblClick&&o.addEventListener("dblclick",a),x!=null&&x.onPointerMove&&o.addEventListener("pointermove",i),x!=null&&x.onPointerUp&&window.addEventListener("pointerup",c),x!=null&&x.onPointerLeave&&o.addEventListener("pointerleave",l),w&&o.addEventListener("wheel",d,{passive:!1}),v!=null&&v.onTouchStart&&o.addEventListener("touchstart",g,{passive:!1}),v!=null&&v.onTouchMove&&o.addEventListener("touchmove",y,{passive:!1}),v!=null&&v.onTouchEnd&&o.addEventListener("touchend",m,{passive:!1}),b!=null&&b.onKeyDown&&window.addEventListener("keydown",u),b!=null&&b.onKeyUp&&window.addEventListener("keyup",h),b!=null&&b.onCopy&&window.addEventListener("copy",f),()=>{x!=null&&x.onPointerDown&&o.removeEventListener("pointerdown",r),x!=null&&x.onPointerMove&&o.removeEventListener("pointermove",i),x!=null&&x.onPointerUp&&window.removeEventListener("pointerup",c),x!=null&&x.onPointerLeave&&o.removeEventListener("pointerleave",l),w&&o.removeEventListener("wheel",d),v!=null&&v.onTouchStart&&o.removeEventListener("touchstart",g),v!=null&&v.onTouchMove&&o.removeEventListener("touchmove",y),v!=null&&v.onTouchEnd&&o.removeEventListener("touchend",m),b!=null&&b.onKeyDown&&window.removeEventListener("keydown",u),b!=null&&b.onKeyUp&&window.removeEventListener("keyup",h)}},[s])},tr=()=>{const e=er();return p.useCallback(s=>{const n=e.current;if(!n)return console.error("Canvas container ref not available in useGetRelativeMousePos"),{x:0,y:0};const o=n.getBoundingClientRect();return{x:s.clientX-o.left,y:s.clientY-o.top}},[e])};function lp(e){var a,i;const s=e;if(!s){(a=window.getSelection())==null||a.removeAllRanges();return}const n=s.tagName==="TEXTAREA",o=s.tagName==="INPUT",r=s.isContentEditable||!!s.closest('[contenteditable="true"]');n||o||r||(i=window.getSelection())==null||i.removeAllRanges()}const Ft=new xs("useCanvasMouseEventsV2",ws.useCanvasMouseEventsV2),dp=e=>{const s=e.target,n=s.closest("[data-canvas-container]");return!n||s.closest("[data-ui-panel]")?null:n},up=()=>{p.useEffect(()=>{const e=()=>{if(document.pointerLockElement===null){const s=E.getState().uiState.mode,n=E.getState().uiState.zoomSubMode;if(s===Q.ZOOM&&n==="zoom:lock"){const o=E.getState().setZoomSubMode;o("zoom"),Ft.log("Pointer lock released, reset to zoom mode")}}};return document.addEventListener("pointerlockchange",e),()=>{document.removeEventListener("pointerlockchange",e)}},[])},hp=e=>{const s=tr(),n=Us(i=>i.setMousePosition),o=E.getState(),r=o.uiState.mode,a=o.setIsPanning;return p.useCallback(i=>{const c=s(i);n(c),Ft.log("Generic Pointer Down:",c.x,c.y),lp(i.target);const l=E.getState().uiState.mode,d=E.getState().uiState.zoomSubMode;if(l===Q.ZOOM&&i.button===0){const x=dp(i);if(x){const w=E.getState().setZoomSubMode;d==="zoom:lock"?document.exitPointerLock():(x.requestPointerLock(),w("zoom:lock")),i.preventDefault();return}}if(!(i.button===1||i.button===0&&r===Q.MOVE||i.button===-1))return;const h=i.target,f=h.closest("[data-node-id]"),g=h.id.includes("resize-handle-"),y=h.closest("[data-ui-panel]");if(g||y)return;let m=!1;r===Q.MOVE?m=!0:f||(m=!0),m&&(Ft.log("Starting Panning"),a(!0),e(c),i.preventDefault())},[s,n,a,e,r])},pp=()=>{var i;const e=tr(),s=E.getState(),n=(i=s.uiState)==null?void 0:i.isPanning,o=Us(c=>c.setMousePosition),r=s.setActiveCanvasViewState,a=Us(c=>c.mousePosition);return p.useCallback(c=>{const l=E.getState().uiState.mode,d=E.getState().uiState.zoomSubMode,u=document.pointerLockElement!==null;if(l===Q.ZOOM&&d==="zoom:lock"&&u){const g=c.movementX,y=c.movementY;r(m=>({...m,offset:{x:m.offset.x+g,y:m.offset.y+y}}));return}const f=e(c);if(n&&a){const g=f.x-a.x,y=f.y-a.y;r(m=>({...m,offset:{x:m.offset.x+g,y:m.offset.y+y}}))}o(f)},[e,o,n,a,r])},gp=e=>{var a;const s=tr(),n=E.getState(),o=(a=n.uiState)==null?void 0:a.isPanning,r=n.setIsPanning;return p.useCallback(i=>{const c=s(i);Ft.log("Generic Pointer Up:",c.x,c.y),o&&(r(!1),e(null),Ft.log("Stopped Panning"))},[s,o,r,e])},fp=e=>{var a;const s=E.getState(),n=(a=s.uiState)==null?void 0:a.isPanning,o=s.setIsPanning,r=Us(i=>i.setMousePosition);return p.useCallback(()=>{n&&(o(!1),e(null),Ft.log("Stopped Panning (Mouse Leave)")),r(null)},[n,o,e,r])},tn={current:null},ea={current:null},ta={current:0},mp=()=>{const e=E.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=Us(r=>r.mousePosition);return p.useCallback(r=>{r.preventDefault();const a=s();if(!a)return;const{scale:i,offset:c}=a.viewState,d=E.getState().uiState.mode===Q.ZOOM;if(r.ctrlKey||r.metaKey||d){if(!o)return;const{min:u,max:h,intensity:f}=se.zoom,g=r.deltaY<0?1:-1;let y;if(i<=.1){const S=i+g*.01;y=Math.max(u,Math.min(h,S)),y=Math.round(y*100)/100}else{const S=i+g*f*i,C=Math.max(u,Math.min(h,S));y=(g>0?Math.ceil:Math.floor)(C*10)/10}if(y===i)return;const m=xt(o,i,c),x=o.x-m.x*y,w=o.y-m.y*y,v=isNaN(x)?0:x,b=isNaN(w)?0:w,N=isNaN(y)?1:y,j=performance.now(),k=j-ta.current;tn.current={newScale:N,newOffsetX:v,newOffsetY:b},k>=16?(n(S=>({...S,scale:N,offset:{x:v,y:b}})),ta.current=j,tn.current=null):(ea.current&&clearTimeout(ea.current),ea.current=setTimeout(()=>{if(tn.current){const{newScale:S,newOffsetX:C,newOffsetY:R}=tn.current;n(I=>({...I,scale:S,offset:{x:C,y:R}})),ta.current=performance.now(),tn.current=null}},16-k))}else n(u=>{var w,v;let h=r.deltaX,f=r.deltaY;r.shiftKey&&(h=f,f=0);const g=(((w=u.offset)==null?void 0:w.x)??0)-h,y=(((v=u.offset)==null?void 0:v.y)??0)-f,m=isNaN(g)?0:g,x=isNaN(y)?0:y;return{...u,offset:{x:m,y:x}}})},[s,n,o])},xp=()=>{const e=E.getState(),s=e.uiState.mode,n=e.getCanvasMouseCoords,o=e.addNode,r=e.setNodeToFocusId;return p.useCallback(a=>{if(s!==Q.SELECT){Ft.log("Double Click ignored: Not in SELECT mode.");return}if(a.target.closest("[data-node-id], [data-arrow-id], [data-test='canvas-chat-input-container'], [data-prevent-canvas-click]")){Ft.log("Double Click ignored: Clicked on existing element or UI component.");return}const c=n();if(!c){Ft.log("Double Click ignored: Could not get canvas coordinates.");return}Ft.log("Double Click on background: Adding node at",c);const l=Re(10);o({id:l,x:c.x,y:c.y,content:"",type:de.TEXT}),r(l),a.preventDefault(),a.stopPropagation()},[s,n,o])},ze={createTemporaryDrawing:(e,s,n=Ct)=>{const o=e===be.FREEHAND;return{subMode:e,points:o?[s]:[],startPoint:o?void 0:s,endPoint:o?void 0:s,style:n}},updateFreehandPoints:(e,s)=>({...e,points:[...e.points,s]}),updateShapeEndPoint:(e,s)=>({...e,endPoint:s}),canFinalizeDraw:e=>e.subMode===be.FREEHAND?e.points.length>=2:!e.startPoint||!e.endPoint?!1:Math.hypot(e.endPoint.x-e.startPoint.x,e.endPoint.y-e.startPoint.y)>=5,simplifyPoints:(e,s=2)=>{if(e.length<=2)return e;const n=s*s,o=(i,c,l)=>{let d=0,u=c;const h=i[c],f=i[l],g=f.x-h.x,y=f.y-h.y,m=g*g+y*y;for(let x=c+1;x<l;x++){const w=i[x];let v;if(m===0)v=(w.x-h.x)**2+(w.y-h.y)**2;else{const b=Math.max(0,Math.min(1,((w.x-h.x)*g+(w.y-h.y)*y)/m)),N=h.x+b*g,j=h.y+b*y;v=(w.x-N)**2+(w.y-j)**2}v>d&&(d=v,u=x)}return{index:u,distance:d}},r=(i,c,l,d)=>{const{index:u,distance:h}=o(i,c,l);h>n&&(d[u]=!0,r(i,c,u,d),r(i,u,l,d))},a=new Array(e.length).fill(!1);return a[0]=!0,a[e.length-1]=!0,r(e,0,e.length-1,a),e.filter((i,c)=>a[c])},smoothToSVGPath:(e,s=.5)=>{if(e.length===0)return"";if(e.length===1)return`M ${e[0].x} ${e[0].y}`;if(e.length===2)return`M ${e[0].x} ${e[0].y} L ${e[1].x} ${e[1].y}`;const n=(r,a,i,c)=>{const l=s,d=a.x+(i.x-r.x)*l/6,u=a.y+(i.y-r.y)*l/6,h=i.x-(c.x-a.x)*l/6,f=i.y-(c.y-a.y)*l/6;return`C ${d} ${u}, ${h} ${f}, ${i.x} ${i.y}`};let o=`M ${e[0].x} ${e[0].y}`;o+=" "+n(e[0],e[0],e[1],e[2]||e[1]);for(let r=1;r<e.length-2;r++)o+=" "+n(e[r-1],e[r],e[r+1],e[r+2]);if(e.length>2){const r=e.length-1;o+=" "+n(e[r-2],e[r-1],e[r],e[r])}return o},pointsToPolylinePath:e=>e.length===0?"":e.length===1?`M ${e[0].x} ${e[0].y}`:`M ${e[0].x} ${e[0].y} `+e.slice(1).map(s=>`L ${s.x} ${s.y}`).join(" "),generateShapeSVGPath:e=>{const{shapeType:s,startPoint:n,endPoint:o}=e;switch(s){case"line":return`M ${n.x} ${n.y} L ${o.x} ${o.y}`;case"rectangle":{const r=Math.min(n.x,o.x),a=Math.min(n.y,o.y),i=Math.abs(o.x-n.x),c=Math.abs(o.y-n.y);return`M ${r} ${a} h ${i} v ${c} h ${-i} Z`}case"square":{const r=Math.min(Math.abs(o.x-n.x),Math.abs(o.y-n.y)),a=o.x>=n.x?n.x:n.x-r,i=o.y>=n.y?n.y:n.y-r;return`M ${a} ${i} h ${r} v ${r} h ${-r} Z`}case"circle":{const r=(n.x+o.x)/2,a=(n.y+o.y)/2,i=Math.hypot(o.x-n.x,o.y-n.y)/2;return`M ${r-i} ${a} A ${i} ${i} 0 1 0 ${r+i} ${a} A ${i} ${i} 0 1 0 ${r-i} ${a}`}case"ellipse":{const r=Math.abs(o.x-n.x),a=Math.abs(o.y-n.y),i=o.x>=n.x?1:-1,c=o.y>=n.y?1:-1,l=n.x+i*r/2,d=n.y+c*a/2,u=r/2,h=a/2;return`M ${l-u} ${d} A ${u} ${h} 0 1 0 ${l+u} ${d} A ${u} ${h} 0 1 0 ${l-u} ${d}`}case"arrow":{const r=o.x-n.x,a=o.y-n.y,i=Math.hypot(r,a);if(i<1)return"";const c=r/i,l=a/i,d=Math.min(20,Math.max(8,i*.2)),u=d*.6,h=o.x-c*d,f=o.y-l*d,g=-l,y=c,m=h+g*u,x=f+y*u,w=h-g*u,v=f-y*u;return`M ${n.x} ${n.y} L ${h} ${f} M ${o.x} ${o.y} L ${m} ${x} L ${w} ${v} Z`}default:return""}},calculateFreehandBounds:e=>{if(e.length===0)return{x:0,y:0,width:0,height:0};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e)a.x<s&&(s=a.x),a.y<n&&(n=a.y),a.x>o&&(o=a.x),a.y>r&&(r=a.y);return{x:s,y:n,width:o-s,height:r-n}},calculateShapeBounds:(e,s,n)=>{if(n==="circle"){const c=(e.x+s.x)/2,l=(e.y+s.y)/2,d=Math.hypot(s.x-e.x,s.y-e.y)/2;return{x:c-d,y:l-d,width:d*2,height:d*2}}if(n==="square"){const c=Math.min(Math.abs(s.x-e.x),Math.abs(s.y-e.y)),l=s.x>=e.x?e.x:e.x-c,d=s.y>=e.y?e.y:e.y-c;return{x:l,y:d,width:c,height:c}}const o=Math.min(e.x,s.x),r=Math.min(e.y,s.y),a=Math.abs(s.x-e.x),i=Math.abs(s.y-e.y);return{x:o,y:r,width:a,height:i}},calculateBounds:e=>e.drawType==="freehand"&&e.stroke?ze.calculateFreehandBounds(e.stroke.points):e.drawType==="shape"&&e.shape?ze.calculateShapeBounds(e.shape.startPoint,e.shape.endPoint,e.shape.shapeType):{x:0,y:0,width:0,height:0},normalizePoints:(e,s)=>e.map(n=>({x:n.x-s.x,y:n.y-s.y})),finalizeDrawing:e=>{if(!ze.canFinalizeDraw(e))return null;const s=(e.style.strokeWidth??2)/2;if(e.subMode===be.FREEHAND){const c=ze.calculateFreehandBounds(e.points),l={x:c.x-s,y:c.y-s},u=e.points.length>20?ze.simplifyPoints(e.points,2):e.points,h=ze.normalizePoints(u,l),f=ze.smoothToSVGPath(h);return{drawType:"freehand",stroke:{points:ze.normalizePoints(e.points,l),smoothedPath:f},style:e.style}}if(!e.startPoint||!e.endPoint)return null;const o={[be.RECTANGLE]:"rectangle",[be.SQUARE]:"square",[be.CIRCLE]:"circle",[be.ELLIPSE]:"ellipse",[be.LINE]:"line",[be.ARROW]:"arrow",[be.FREEHAND]:"rectangle"}[e.subMode],r=ze.calculateShapeBounds(e.startPoint,e.endPoint,o),a={x:r.x-s,y:r.y-s};return{drawType:"shape",shape:{shapeType:o,startPoint:{x:e.startPoint.x-a.x,y:e.startPoint.y-a.y},endPoint:{x:e.endPoint.x-a.x,y:e.endPoint.y-a.y}},style:e.style}},getSubModeFromKey:e=>{switch(e){case"1":return be.FREEHAND;case"2":return be.RECTANGLE;case"3":return be.SQUARE;case"4":return be.CIRCLE;case"5":return be.ELLIPSE;case"6":return be.LINE;case"7":return be.ARROW;default:return null}},getSubModeLabel:e=>{switch(e){case be.FREEHAND:return"Freehand";case be.RECTANGLE:return"Rectangle";case be.SQUARE:return"Square";case be.CIRCLE:return"Circle";case be.ELLIPSE:return"Ellipse";case be.LINE:return"Line";case be.ARROW:return"Arrow";default:return"Draw"}}};class Le{static buildTextNode(s,n,o){return{id:Re(10),type:de.TEXT,content:n,x:s.x,y:s.y,width:s.width,height:s.height,styles:o}}static buildTextNodeV2(s){return{id:Re(10),type:de.TEXT,content:s.content||"",x:s.x||0,y:s.y||0,width:s.width||100,height:s.height||100,styles:s.styles||{},options:s.options||{lockSize:!0},...s}}static buildTableNode(s){return{id:Re(10),type:de.TABLE,content:null,data:{columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},x:s.x,y:s.y,width:s.width||400,height:s.height||250,styles:{textAlign:"left"}}}static buildTextCardNode(s){return{id:Re(10),type:de.TEXTCARD,title:"",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||150,styles:{textAlign:"left"}}}static buildWorkflowOrchestrationNode(s){return{id:`wf-orchestration-${Re(6)}`,type:de.WORKFLOW_ORCHESTRATION,title:"Workflow",content:"",x:s.x,y:s.y,width:s.width||400,height:s.height||500,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:[{id:"row_1",label:"Step 1",order:1,stepType:"source",children:[]}]}}}}static buildWorkflowSourceNode(s){return{id:`wf-source-${Re(6)}`,type:de.WORKFLOW_SOURCE,title:"Source",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||200,data:{displayFormat:"raw"}}}static buildWorkflowDefinitionNode(s){return{id:`wf-def-${Re(6)}`,type:de.WORKFLOW_DEFINITION,title:"Workflow Runner",content:"",x:s.x,y:s.y,width:s.width||280,height:s.height||180,data:{definitionId:void 0,instanceId:void 0,lastExecutionStatus:"idle"}}}static buildOCRNode(s){return{id:`ocr-${Re(6)}`,type:de.OCR,title:"OCR",content:"",x:s.x,y:s.y,width:s.width||350,height:s.height||500,data:{image:void 0,extractedText:void 0,detectedLanguage:void 0,confidence:void 0}}}static buildImageNode(s){return{id:`img-${Re(6)}`,type:de.IMAGE,title:"Image",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||250,data:{image:void 0}}}static buildWorkflowStepNode(s){return{id:`wf-step-${Re(6)}`,type:de.WORKFLOW_STEP,title:"Workflow Step",content:"",x:s.x,y:s.y,width:s.width||260,height:s.height||180,data:{stepType:void 0,config:{}}}}static buildVocabularyNode(s){return{id:`vocab-${Re(6)}`,type:de.VOCABULARY,title:"Vocabulary",content:"",x:s.x,y:s.y,width:s.width||320,height:s.height||280,data:{vocabType:"vocabulary",term:"",definition:"",sourceWord:"",translationWord:""}}}static buildDrawingNode(s,n){return{id:`draw-${Re(6)}`,type:de.DRAWING,content:"",x:s.x,y:s.y,width:s.width||100,height:s.height||100,data:n}}}const wp=Object.freeze(Object.defineProperty({__proto__:null,CanvasNodeBuilderV2:Le},Symbol.toStringTag,{value:"Module"}));function _o(e,s,n="right",o={}){var u;const{shouldFocus:r=!0,createArrow:a=!0}=o,i=E.getState();let c=e.width,l=e.height;if(!c||!l){const h=se.nodeOptions.maxNodeWidth;c=Math.min(Ls(e.content),h)+pe.NODE_X_PADDING*2,l=Math.min(dd(e.content,h))+pe.NODE_Y_PADDING*2}switch((u=i.projectCanvas.getActive())==null||u.viewState.offset,n){case"left":e.x=s.x-c-pe.nodeSpacing*3,e.y=s.y;break;case"right":e.x=s.x+(s.width??0)+pe.nodeSpacing*3,e.y=s.y;break;case"above":e.y=s.y-pe.nodeSpacing*3;break;case"below":e.y=s.y+(s.height??0)+pe.nodeSpacing;break}const d={...e,width:c,height:l};if(i.addNode(d,void 0,{dontOverlap:!0,dontSelect:!0}),r&&i.setNodeToFocusId(s.id),a){const h=()=>Math.random().toString(36).slice(2,10),f=g=>({x:(g.x??0)+(g.width??0)/2,y:(g.y??0)+(g.height??0)/2});window.setTimeout(()=>{i.arrow.add({id:h(),startNodeId:s.id,endNodeId:d.id,startPoint:f(s),endPoint:f(d)})},0)}}function qc(e,s,n){let o=e;for(;o&&!o.hasAttribute("data-text-position-container");)o=o.parentElement;if(!o)return null;const r=window.getComputedStyle(e),a=document.createElement("div");a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.visibility="hidden",a.style.font=r.font,a.style.fontSize=r.fontSize,a.style.fontFamily=r.fontFamily,a.style.fontWeight=r.fontWeight,a.style.lineHeight=r.lineHeight,a.style.letterSpacing=r.letterSpacing,a.style.wordSpacing=r.wordSpacing,a.style.padding=r.padding,a.style.width=`${e.clientWidth}px`,a.style.border="none",a.style.whiteSpace=r.whiteSpace,a.style.wordWrap=r.wordWrap,a.style.overflowWrap=r.overflowWrap,a.textContent=e.value,o?o.appendChild(a):document.body.appendChild(a);try{const i=document.createRange(),c=a.firstChild;if(!c||c.nodeType!==Node.TEXT_NODE)return null;i.setStart(c,s),i.setEnd(c,n);const l=i.getClientRects();if(l.length===0)return null;const d=l[0],u=o==null?void 0:o.getBoundingClientRect();if(!u)return null;const h={top:d.top-u.top,left:d.left-u.left},f=parseFloat(r.paddingTop)||0,g=parseFloat(r.paddingLeft)||0,y=h.top-f,m=h.left-g;return{top:y,left:m,width:d.width,height:d.height}}finally{o&&a.parentNode===o?o.removeChild(a):a.parentNode===document.body&&document.body.removeChild(a)}}const Rt=e=>/[\w\u00C0-\u024F]/.test(e);function Rr(e,s){if(!e||s<0||s>e.length)return!1;const n=e[s]||"",o=e[s-1]||"",r=Rt(o),a=Rt(n);return r&&!a||!r&&a}function yp(e,s){if(!e||s<0||s>e.length)return null;const n=e[s]||"",o=e[s-1]||"";if(!Rt(n)&&!Rt(o))return null;let r=s;for(;r>0&&Rt(e[r-1]);)r--;let a=s;for(;a<e.length&&Rt(e[a]);)a++;return r<a?{start:r,end:a,word:e.substring(r,a)}:null}function Mr(e,s){const n=yp(e,s);return n?{start:n.start,end:n.end}:null}function Pr(e,s){if(!e||s<0||s>e.length)return null;let n=s;for(;n>0&&!Rt(e[n-1]);)n--;if(n===0)return null;let o=n;for(;o>0&&Rt(e[o-1]);)o--;let r=s;for(;r<e.length&&!Rt(e[r]);)r++;if(r>=e.length)return null;let a=r;for(;a<e.length&&Rt(e[a]);)a++;return{start:o,end:a}}function Dr(e,s){for(;s>0&&Rt(e[s-1]);)s--;return s}function Or(e,s){for(;s<e.length&&Rt(e[s]);)s++;return s}function vp(e,s,n){var h;const o=document.createRange(),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let a=0,i=null,c=0,l=null,d=0,u;for(;u=r.nextNode();){const f=((h=u.textContent)==null?void 0:h.length)||0;if(!i&&a+f>=s&&(i=u,c=s-a),!l&&a+f>=n){l=u,d=n-a;break}a+=f}if(i&&l)try{return o.setStart(i,c),o.setEnd(l,d),o}catch(f){return console.warn("Failed to create text range:",f),null}return null}var Sa=(e=>(e.CONTENT_CAPTURE="content-capture",e.REGULAR="regular",e))(Sa||{});const Zc=(e,s)=>{const n=new Set(s.map(o=>o.id));return e.filter(o=>o.startNodeId&&o.endNodeId&&n.has(o.startNodeId)&&n.has(o.endNodeId))},bp=e=>e.type===de.GROUP||e.type==="GROUP",Np=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=[...e];for(const r of e)if(bp(r)){const a=r.data,i=(a==null?void 0:a.childNodeIds)??[];for(const c of i)if(!n.has(c)){const l=s.find(d=>d.id===c);l&&(o.push(l),n.add(c))}}return o},Sp=(e,s,n)=>{const o=Zc(s,e),r={nodes:e};return o.length>0&&(r.arrows=o),n!=null&&n.canvasConfig&&(r.canvasConfig=n.canvasConfig),r},Jc=e=>{var l;const s=E.getState(),n=s.projectCanvas.getActive();if(!n)return null;const{nodes:o,arrows:r,selectedNodes:a}=n.coreState,i=a.length>0?Np(a,o):o;if(i.length===0)return null;const c=e!=null&&e.includeConfig?(l=s.preferences)==null?void 0:l.canvasConfig:void 0;return Sp(i,r,{canvasConfig:c})},Qc=async(e,s)=>{var n;try{if(await navigator.clipboard.writeText(JSON.stringify(e,null,2)),(s==null?void 0:s.showToast)!==!1){const o=(n=e.arrows)!=null&&n.length?` and ${e.arrows.length} arrow(s)`:"";ve.success(`Copied ${e.nodes.length} node(s)${o}`)}return!0}catch(o){return console.error("Failed to copy to clipboard:",o),(s==null?void 0:s.showToast)!==!1&&ve.error("Failed to copy to clipboard"),!1}},el=async e=>{const s=Jc({includeConfig:e==null?void 0:e.includeConfig});return s?Qc(s,{showToast:e==null?void 0:e.showToast}):(ve.info("No nodes to copy"),!1)},Cp=e=>{try{const s=JSON.parse(e);if(!s)return null;const n=Array.isArray(s.nodes)&&s.nodes.length>0,o=Array.isArray(s.arrows)&&s.arrows.length>0;return n||o?s:null}catch{return null}};function jp(e){const s=e.split(ud);if(s.length===2)try{return{type:"content-capture",data:JSON.parse(s[1])}}catch{}const n=Cp(e);return n?{type:"content-capture",data:n}:{type:"regular",content:s[0]}}const kp={id:"noDuplicateHeaders",name:"No Duplicate Headers",description:"Warn when same header text appears multiple times",defaultSeverity:"warning",check:(e,s)=>{const n=[],o=new Map;for(let r=0;r<s.length;r++){const a=s[r].match(/^#{1,6}\s+(.+)$/);if(a){const i=a[1].trim().toLowerCase(),c=o.get(i);c!==void 0?n.push({ruleId:"no-duplicate-headers",severity:"warning",message:`Duplicate header "${a[1].trim()}" (first seen on line ${c})`,line:r+1}):o.set(i,r+1)}}return n}},Ap={id:"headerIncrement",name:"Header Increment",description:"Headers should only increment by one level",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=0;r<s.length;r++){const a=s[r].match(/^(#{1,6})\s+/);if(a){const i=a[1].length;o>0&&i>o+1&&n.push({ruleId:"header-increment",severity:"warning",message:`Header level jumped from H${o} to H${i} (should be H${o+1})`,line:r+1}),o=i}}return n}},Ip={id:"noEmptyHeaders",name:"No Empty Headers",description:"Headers must have content after the # markers",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^#{1,6}\s*$/.test(r)&&n.push({ruleId:"no-empty-headers",severity:"error",message:"Header has no content",line:o+1})}return n}},Tp={id:"firstHeaderH1",name:"First Header H1",description:"Document should start with H1",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].match(/^(#{1,6})\s+/);if(r){const a=r[1].length;a!==1&&n.push({ruleId:"first-header-h1",severity:"info",message:`First header should be H1, found H${a}`,line:o+1});break}}return n}},Ep={id:"noTrailingSpaces",name:"No Trailing Spaces",description:"Lines shouldn't end with trailing spaces",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];r.endsWith(" ")&&!r.endsWith("  ")&&n.push({ruleId:"no-trailing-spaces",severity:"warning",message:"Line has trailing spaces",line:o+1,column:r.trimEnd().length+1})}return n}},Rp={id:"noMultipleBlanks",name:"No Multiple Blanks",description:"No more than 1 consecutive blank line",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0,r=0;for(let a=0;a<s.length;a++)s[a].trim()===""?(o===0&&(r=a+1),o++):(o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:a}),o=0);return o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:s.length}),n}},Mp={id:"noLeadingWhitespace",name:"No Leading Whitespace",description:"Content shouldn't start with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let a=0;a<s.length&&s[a].trim()==="";a++)o++;o>0&&n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`Content starts with ${o} blank line(s)`,line:1,endLine:o});const r=s.find(a=>a.trim()!=="");if(r&&/^\s+/.test(r)){const a=r.match(/^(\s+)/),i=a?a[1].length:0;n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`First content line starts with ${i} whitespace character(s)`,line:o+1,column:1})}return n}},Pp={id:"noTrailingWhitespace",name:"No Trailing Whitespace",description:"Content shouldn't end with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=s.length-1;r>=0&&s[r].trim()==="";r--)o++;return o>0&&n.push({ruleId:"no-trailing-whitespace",severity:"warning",message:`Content ends with ${o} blank line(s)`,line:s.length-o+1,endLine:s.length}),n}},Dp={id:"consistentEmphasis",name:"Consistent Emphasis",description:"Use same style for emphasis (* vs _)",defaultSeverity:"info",check:e=>{const s=[],n=e.match(new RegExp("(?<!\\*)\\*(?!\\*)([^*]+)(?<!\\*)\\*(?!\\*)","g")),o=e.match(new RegExp("(?<!_)_(?!_)([^_]+)(?<!_)_(?!_)","g"));n&&o&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both *italic* and _italic_",line:1});const r=e.match(/\*\*([^*]+)\*\*/g),a=e.match(/__([^_]+)__/g);return r&&a&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both **bold** and __bold__",line:1}),s}},Op={id:"noSpaceInEmphasis",name:"No Space in Emphasis",description:"No spaces inside emphasis markers",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\*\*\s+[^*]+\*\*|\*\*[^*]+\s+\*\*/);a&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside bold markers: ** text ** should be **text**",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(new RegExp("(?<!\\*)\\*\\s+[^*]+\\*(?!\\*)|\\*[^*]+\\s+\\*(?!\\*)"));i&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside italic markers: * text * should be *text*",line:o+1,column:r.indexOf(i[0])+1})}return n}},Lp={id:"noEmptyLinks",name:"No Empty Links",description:"Links must have both text and URL",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\[\]\([^)]+\)/);a&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no text: [](url)",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(/\[[^\]]+\]\(\s*\)/);i&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no URL: [text]()",line:o+1,column:r.indexOf(i[0])+1})}return n}},Wp={id:"noBareUrls",name:"No Bare URLs",description:"URLs should be wrapped in link syntax [text](url)",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=new RegExp("(?<!\\]\\()https?:\\/\\/[^\\s\\)]+","g");let i;for(;(i=a.exec(r))!==null;)r.substring(0,i.index).endsWith("](")||n.push({ruleId:"no-bare-urls",severity:"info",message:`Bare URL found: ${i[0].substring(0,30)}...`,line:o+1,column:i.index+1})}return n}},$p={id:"consistentListMarker",name:"Consistent List Marker",description:"Use same marker for unordered lists (- vs * vs +)",defaultSeverity:"info",check:(e,s)=>{const n=[],o=new Set;let r=0,a="";for(let i=0;i<s.length;i++){const c=s[i].match(/^(\s*)([*+-])\s+/);if(c){const l=c[2];o.size===0&&(r=i+1,a=l),o.add(l)}}return o.size>1&&n.push({ruleId:"consistent-list-marker",severity:"info",message:`Mixed list markers: using ${Array.from(o).join(", ")} (first "${a}" on line ${r})`,line:1}),n}},Bp={id:"noEmptyListItems",name:"No Empty List Items",description:"List items must have content",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^\s*[*+-]\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty list item",line:o+1}),/^\s*\d+\.\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty ordered list item",line:o+1})}return n}},Hp={id:"orderedListPrefix",name:"Ordered List Prefix",description:"Ordered lists should use 1. or sequential numbering",defaultSeverity:"info",check:(e,s)=>{const n=[];let o=1,r=!1;for(let a=0;a<s.length;a++){const i=s[a].match(/^(\s*)(\d+)\.\s+/);if(i){const c=parseInt(i[2],10);r||(r=!0,o=1),c!==1&&c!==o&&n.push({ruleId:"ordered-list-prefix",severity:"info",message:`Ordered list item ${c}. should be ${o}. (or use 1. for all)`,line:a+1}),o++}else s[a].trim()===""&&(r=!1,o=1)}return n}},Fp={id:"tableColumnCount",name:"Table Column Count",description:"All table rows should have the same column count",defaultSeverity:"error",check:(e,s)=>{const n=[];let o=-1,r=0;for(let a=0;a<s.length;a++){const i=s[a].trim();if(i.startsWith("|")||i.includes("|")&&/\|.+\|/.test(i)){const c=i.split("|").filter(l=>l.trim()!=="").length;o===-1?(o=a+1,r=c):c!==r&&(/^[\s|:-]+$/.test(i)||n.push({ruleId:"table-column-count",severity:"error",message:`Table row has ${c} columns, expected ${r}`,line:a+1}))}else o!==-1&&i===""&&(o=-1,r=0)}return n}},_p={id:"noEmptyTableCells",name:"No Empty Table Cells",description:"Warn on empty table cells",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].trim();if(!/^[\s|:-]+$/.test(r)&&(r.startsWith("|")||r.includes("|")&&/\|.+\|/.test(r))){const a=r.split("|");for(let i=1;i<a.length-1;i++)a[i].trim()===""&&n.push({ruleId:"no-empty-table-cells",severity:"info",message:`Empty table cell in column ${i}`,line:o+1})}}return n}},zp=[kp,Ap,Ip,Tp,Ep,Rp,Mp,Pp,Dp,Op,Lp,Wp,$p,Bp,Hp,Fp,_p],Up=Object.fromEntries(zp.map(e=>[e.id,e]));function Vp(e,s){const n=[],o=e.split(`
`);for(const[r,a]of Object.entries(s)){if(!(a!=null&&a.enabled))continue;const i=Up[r];if(!i){console.warn(`Unknown lint rule: ${r}`);continue}const c=i.check(e,o),l=a.severity??i.defaultSeverity;for(const d of c)n.push({...d,severity:l})}return n.sort((r,a)=>r.line!==a.line?r.line-a.line:(r.column??0)-(a.column??0)),n}function Gp(e){return{total:e.length,errors:e.filter(s=>s.severity==="error").length,warnings:e.filter(s=>s.severity==="warning").length,infos:e.filter(s=>s.severity==="info").length}}function Yp(e){if(e.length===0)return"No issues found.";const s=e.map(o=>{const r=o.column?`${o.line}:${o.column}`:`${o.line}`,a=o.severity.toUpperCase().padEnd(7);return`  ${r.padEnd(8)} ${a} ${o.message} (${o.ruleId})`}),n=Gp(e);return s.push(""),s.push(`Found ${n.total} issue(s): ${n.errors} error(s), ${n.warnings} warning(s), ${n.infos} info(s)`),s.join(`
`)}function Kp(e){let s=e.split(`
`);for(;s.length>0&&s[0].trim()==="";)s.shift();for(s.length>0&&(s[0]=s[0].trimStart());s.length>0&&s[s.length-1].trim()==="";)s.pop();const n=[];let o=!1;for(const r of s)if(r.trim()==="")o||n.push(r),o=!0;else{const i=o?r.trimStart():r;n.push(i),o=!1}return n.join(`
`)}const Lr={noEmptyHeaders:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},noEmptyLinks:{enabled:!0},noEmptyListItems:{enabled:!0},tableColumnCount:{enabled:!0}},Xp={noDuplicateHeaders:{enabled:!0},headerIncrement:{enabled:!0},noEmptyHeaders:{enabled:!0},firstHeaderH1:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},consistentEmphasis:{enabled:!0},noSpaceInEmphasis:{enabled:!0},noEmptyLinks:{enabled:!0},noBareUrls:{enabled:!0},consistentListMarker:{enabled:!0},noEmptyListItems:{enabled:!0},orderedListPrefix:{enabled:!0},tableColumnCount:{enabled:!0},noEmptyTableCells:{enabled:!0}};function qp(e){switch(e){case"disabled":return null;case"simple":return{...Lr};case"comprehensive":return{...Xp};default:return{...Lr}}}function Wr(e,s,n){let o=0,r=!1;const a=[];function i(c){var l,d,u,h,f,g,y;if(r)return!0;if(c===s)return c.nodeType===Node.TEXT_NODE?(a.push(`FOUND target text node "${(l=c.textContent)==null?void 0:l.substring(0,20)}", adding targetOffset ${n}`),o+=n):a.push(`FOUND target element node, type=${c.tagName}`),r=!0,!0;if(c.nodeType===Node.TEXT_NODE){const m=((d=c.textContent)==null?void 0:d.length)||0;a.push(`text "${(u=c.textContent)==null?void 0:u.substring(0,20)}" +${m} → ${o+m}`),o+=m}else if(c.nodeType===Node.ELEMENT_NODE){const m=c,x=m.tagName;if(x==="BR")return a.push(`BR +1 → ${o+1}`),o+=1,!1;let w=0,v=!1,b=!1;if(x==="H1")w=2;else if(x==="H2")w=3;else if(x==="H3")w=4;else if(x==="BLOCKQUOTE")w=2;else if(m.classList.contains("list-item-ul"))w=2,v=!0,((h=m.previousElementSibling)!=null&&h.classList.contains("list-item-ul")||(f=m.previousElementSibling)!=null&&f.classList.contains("list-item-ol"))&&(b=!0);else if(m.classList.contains("list-item-ol")){const j=m.querySelector("span:first-child");w=((j==null?void 0:j.textContent)||"1.").length+1,v=!0,((g=m.previousElementSibling)!=null&&g.classList.contains("list-item-ul")||(y=m.previousElementSibling)!=null&&y.classList.contains("list-item-ol"))&&(b=!0)}else if(m.classList.contains("empty-line"))return a.push(`empty-line +1 → ${o+1}`),o+=1,!1;b&&(a.push(`newline before block +1 → ${o+1}`),o+=1),w>0&&a.push(`${x} prefix +${w} → ${o+w}`),o+=w;const N=Array.from(c.childNodes);for(let j=0;j<N.length;j++)if(!(v&&j===0&&N[j].nodeName==="SPAN")&&i(N[j]))return!0}return!1}return i(e),o}let Ke=null,sa=!1;typeof window<"u"&&(window.addEventListener("keydown",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(sa=!0)},!0),window.addEventListener("keyup",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(sa=!1)},!0),document.addEventListener("selectionchange",()=>{const e=window.getSelection();sa||!e||e.isCollapsed||(Ke={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,text:e.toString(),timestamp:Date.now()})}));const _e=class _e{static lintPastedContent(s){const n=se.lint.onPastePreset,o=qp(n);if(!o)return;const r=Vp(s,o);r.length>0&&(console.warn(`[Markdown Linter] Found ${r.length} issue(s) in pasted content:`),console.warn(Yp(r)))}onMouseDown(s){const n=E.getState(),o=n.uiState,{mode:r,addNodeType:a}=o,i=n.getCanvasMouseCoords();if(r!==Q.ADD||a!==de.TEXT||!i)return!1;const c=Le.buildTextNode(i,"");return n.addNode(c),n.setNodeToFocusId(c.id),!0}async onPaste(s){var y,m;const n=E.getState(),o=await ru();if(!o)return!1;const r=jp(o);if(r.type===Sa.CONTENT_CAPTURE){const x=n.getCanvasMouseCoords();if(x)return this.createNodesFromContentCapture(r.data,x),n.setNodeToFocusId(null),s.preventDefault(),!0}const a=r.type===Sa.REGULAR?r.content:o,i=Kp(a),{mode:c,addNodeType:l,nodeToFocusId:d}=n.uiState,u=((y=n.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??[];if(d){const x=n.getNodeById(d);if(x&&typeof x.content=="string"&&u.length>0){const v=(x.content||"")+i;if(!((m=x.options)!=null&&m.lockSize)){const N=document.querySelector("textarea[data-node-textarea]");N&&window.getComputedStyle(N).lineHeight;const j=gs(v),k=Math.min(j.width,se.paste.maxWidth);let S=j.height;k<j.width&&(S=ct(v,{containerWidth:k})+pe.NODE_Y_PADDING*2),n.updateNode(x.id,{...x,content:v,width:k,height:S})}else n.updateNode(x.id,{...x,content:v});return s.preventDefault(),_e.lintPastedContent(i),!0}}const h=n.getCanvasMouseCoords(),f=c===Q.ADD&&l===de.TEXT&&h,g=!d&&h;if(f){const x=Le.buildTextNode(h,i);return n.addNode(x),n.setNodeToFocusId(x.id),n.setMode(Q.SELECT),n.setAddNodeType(null),s.preventDefault(),_e.lintPastedContent(i),!0}else if(g){const x=n.getSegmentedButtonAction("canvas-fit-width");let w=null;if(x){const k=/Set width to (\d+)px/.exec(x);k&&(w=parseInt(k[1],10))}let v,b,N;if(w)b=ct(i,{containerWidth:w})+pe.NODE_Y_PADDING*2,v=w,N=!0;else{const k=document.querySelector("textarea[data-node-textarea]");k&&window.getComputedStyle(k).lineHeight;const S=gs(i);v=Math.min(S.width,se.paste.maxWidth),v<S.width?b=ct(i,{containerWidth:v})+pe.NODE_Y_PADDING*2:b=S.height,N=!1}const j=Le.buildTextNodeV2({x:h.x,y:h.y,width:v,height:b,content:i,styles:{textAlign:"left"},options:{lockSize:N}});return n.addNode(j),n.setNodeToFocusId(j.id),s.preventDefault(),_e.lintPastedContent(i),!0}return!1}isGroupNodeType(s){return s.type===de.GROUP||s.type==="GROUP"}createNodesFromContentCapture(s,n){const o=E.getState(),{pasteWidth:r,nodeGap:a}=se.contentCapture,i=Math.min(...s.nodes.map(w=>w.x)),c=Math.min(...s.nodes.map(w=>w.y)),l=n.x-i,d=n.y-c,u=new Map,h=s.nodes.every(w=>w.width&&w.height);let f=n.y;const g=[];for(const w of s.nodes){const v=w.content||"",b=this.isGroupNodeType(w);let N,j,k;w.width&&w.height?(N=w.width,j=w.height,k=h?w.y+d:f):(N=r,j=ct(v,{containerWidth:r})+pe.NODE_Y_PADDING*2,k=f);let S;if(b){const C=new Date().toISOString();S={...w,id:Re(10),type:de.GROUP,x:w.x+l,y:k,width:N,height:j,createdAt:C,updatedAt:C}}else S={...w,id:Re(10),x:w.x+l,y:k,width:N,height:j,content:v,styles:w.styles??{textAlign:"left"},options:w.options??{lockSize:!h},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};u.set(w.id,S.id),g.push({oldNode:w,newNode:S}),h||(f+=j+a)}for(const{oldNode:w,newNode:v}of g){if(w.groupId){const b=u.get(w.groupId);b?v.groupId=b:delete v.groupId}else delete v.groupId;if(this.isGroupNodeType(w)){const b=w.data,j=((b==null?void 0:b.childNodeIds)??[]).map(k=>u.get(k)).filter(k=>k!==void 0);v.data={...b??{},childNodeIds:j}}o.addNode(v,void 0,{skipUndo:!0})}const y=g.map(({newNode:w})=>({type:"node:create",node:w})),m=[];for(const w of s.arrows??[]){const v=w.startNodeId?u.get(w.startNodeId):null,b=w.endNodeId?u.get(w.endNodeId):null;if(v&&b){const N={id:Re(10),startNodeId:v,endNodeId:b,startPoint:{x:0,y:0},endPoint:{x:0,y:0}};o.arrow.add(N),m.push(N),y.push({type:"arrow:create",arrow:N})}}y.length>0&&o.undo.commit({type:"batch",label:`Paste ${g.length} node${g.length!==1?"s":""}${m.length>0?` and ${m.length} arrow${m.length!==1?"s":""}`:""}`,operations:y});const x=g.map(w=>w.newNode);o.setSelectedNodes(x),m.length>0&&o.arrow.setSelected(m)}onCopy(s){var h,f;const{focus:n,sourceNode:o,side:r="right"}=s||{focus:!0},a=E.getState(),{mode:i,nodeToFocusId:c}=a.uiState;if(!i)return null;const l=((h=a.projectCanvas.getActive())==null?void 0:h.coreState.selectedNodes)??[],d=Date.now();let u=!1;if(_e.lastCopyTimestamp&&d-_e.lastCopyTimestamp<_e.DOUBLE_COPY_INTERVAL_MS&&(u=!0),_e.lastCopyTimestamp=d,u)return null;{let g=o;return g||(g=l[0],g||(g=(((f=a.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??[]).find(w=>w.id===c))),Zp(g,n?c:null,n,r)}}highlightAndCreateNode(s,n="right"){var d;const o=E.getState(),r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c=!1,l=null;if(a){const u=r,h=u.value;let f=u.selectionStart,g=u.selectionEnd;if(f===g)if(Rr(h,f)){const y=Pr(h,f);y&&(f=y.start,g=y.end)}else{const y=Mr(h,f);y&&(f=y.start,g=y.end)}else f=Dr(h,f),g=Or(h,g);(f!==u.selectionStart||g!==u.selectionEnd)&&u.setSelectionRange(f,g),c=f!==g}else if(i){const u=window.getSelection(),h=r.textContent||"";let f=!!(u&&!u.isCollapsed&&u.toString().trim());if(u&&u.rangeCount>0){const g=u.getRangeAt(0),y=document.createRange();y.setStart(r,0),y.setEnd(g.startContainer,g.startOffset);let m=y.toString().length;const x=document.createRange();x.setStart(r,0),x.setEnd(g.endContainer,g.endOffset);let w=x.toString().length;if(m===w)if(Rr(h,m)){const v=Pr(h,m);v&&(m=v.start,w=v.end)}else{const v=Mr(h,m);v&&(m=v.start,w=v.end)}else m=Dr(h,m),w=Or(h,w);if(m!==w){const v=vp(r,m,w);v&&(u.removeAllRanges(),u.addRange(v),l=v.cloneRange(),f=!0)}}c=f,c&&u&&u.rangeCount>0&&!l&&(l=u.getRangeAt(0).cloneRange())}if(c){s.preventDefault();const{nodeToFocusId:u}=o.uiState,h=o.projectCanvas.getActive();let g=((h==null?void 0:h.coreState.selectedNodes)??[])[0];!g&&u&&(g=((h==null?void 0:h.coreState.nodes)??[]).find(v=>v.id===u));const y=a?r.selectionStart:0,m=a?r.selectionEnd:0;_e.dismissPopoverCallback&&_e.dismissPopoverCallback();const x=this.onCopy({focus:!1,sourceNode:g,side:n});if(setTimeout(()=>{if(r.focus(),a)r.setSelectionRange(y,m);else if(i&&l){const w=window.getSelection();w&&(w.removeAllRanges(),w.addRange(l))}},0),g!=null&&g.highlights&&g.highlights.length>1&&x){const v=(((d=o.projectCanvas.getActive())==null?void 0:d.coreState.nodes)??[]).find(N=>N.id===g.id),b=window.__showLinkedNodesPopover;b&&v&&b(v,x)}}else{const{nodeToFocusId:u}=o.uiState,h=o.projectCanvas.getActive();let g=((h==null?void 0:h.coreState.selectedNodes)??[])[0];if(!g&&u&&(g=((h==null?void 0:h.coreState.nodes)??[]).find(m=>m.id===u)),g!=null&&g.highlights&&g.highlights.length>0){s.preventDefault();const y=window.__showLinkedNodesPopover;y&&y(g,null)}}}static registerSelectionCallback(s){_e.selectionChangeCallback=s}static unregisterSelectionCallback(){_e.selectionChangeCallback=null}static registerDismissPopoverCallback(s){_e.dismissPopoverCallback=s}static unregisterDismissPopoverCallback(){_e.dismissPopoverCallback=null}onTextSelect(s,n,o){const r=n!==o;_e.selectionChangeCallback&&_e.selectionChangeCallback(r)}};Oe(_e,"lastCopyTimestamp",null),Oe(_e,"DOUBLE_COPY_INTERVAL_MS",400),Oe(_e,"selectionChangeCallback",null),Oe(_e,"dismissPopoverCallback",null);let Gt=_e;function Zp(e,s,n=!0,o="right"){var M,W,B,F;if(!e)return console.warn("No target node found for copy action."),null;const r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c="",l=null,d=0,u=0;if(a){const D=r;d=D.selectionStart,u=D.selectionEnd,c=D.value.substring(d,u);const L=qc(D,d,u);if(L)l=new DOMRect(0,L.top,L.width,L.height);else{const A=pe.LINE_HEIGHT,T=4,_=D.value.substring(0,d).split(`
`).length-1,G=T+_*A;l=new DOMRect(0,G,0,A)}}else if(i){const D=window.getSelection(),L=5e3,A=Ke&&((M=Ke.anchorNode)==null?void 0:M.nodeType)===Node.TEXT_NODE&&Ke.text.length>0,T=Ke&&A&&Date.now()-Ke.timestamp<L;let O,$,_;if(T&&Ke)O=Ke.anchorNode,$=Ke.focusNode,_=Ke.focusOffset,c=Ke.text;else if(D)O=D.anchorNode,$=D.focusNode,_=D.focusOffset,c=D.toString();else return null;const G=D;if(G&&G.rangeCount>0){const X=G.getRangeAt(0),J=r.getBoundingClientRect(),P=X.getClientRects();if(P.length>0){const he=P[0],ue=he.top-J.top;l=new DOMRect(0,ue,he.width,he.height)}const z=e.content||"",U=he=>{let ue=he;for(;ue&&ue!==r;){if(ue.nodeType===Node.ELEMENT_NODE){const me=ue.parentElement;if(me&&(me.classList.contains("list-item-ul")||me.classList.contains("list-item-ol"))){const ye=me.querySelector("span:first-child");if(ye&&(ue===ye||ye.contains(he)))return!0}}ue=ue.parentNode}return!1},K=he=>{let ue=he;for(;ue&&ue!==r;){const xe=ue.parentElement;if(xe&&(xe.classList.contains("list-item-ul")||xe.classList.contains("list-item-ol"))){const me=xe.querySelector("span:nth-child(2)");if(me!=null&&me.firstChild)return me.firstChild}ue=ue.parentNode}return null};let re,ne,V,oe;if(T&&(Ke!=null&&Ke.anchorNode)?(re=Ke.anchorNode,ne=Ke.anchorOffset,V=Ke.anchorNode,oe=Ke.anchorOffset+Ke.text.length):(re=X.startContainer,ne=X.startOffset,V=X.endContainer,oe=X.endOffset),U(re)){const he=K(re);he&&(re=he,ne=0)}const le=he=>{let ue=he;for(;ue&&ue!==r;){if(ue.nodeType===Node.ELEMENT_NODE){const xe=ue,me=xe.tagName;if(me==="H1"||me==="H2"||me==="H3"||me==="DIV"||me==="P"||me==="BLOCKQUOTE"||xe.classList.contains("list-item-ul")||xe.classList.contains("list-item-ol"))return xe}ue=ue.parentNode}return null},Z=le(re),q=le(V),Y=$?le($):null,te=O?le(O):null,ae=c.includes(`
`);if(Z&&Z!==q&&ae&&!(O===$)){const he=te!==Y;if(he&&te&&!Y){const ue=($==null?void 0:$.textContent)||"",xe=_;let me=xe,ye=xe;for(;me>0&&/\S/.test(ue[me-1]);)me--;for(;ye<ue.length&&/\S/.test(ue[ye]);)ye++;if(me===ye&&xe>0)for(ye=xe,me=xe-1;me>0&&/\S/.test(ue[me-1]);)me--;me<ye&&$&&(re=$,ne=me,V=$,oe=ye)}else if(he&&!te&&Y){const xe=document.createTreeWalker(Y,NodeFilter.SHOW_TEXT).nextNode();xe&&(re=xe,ne=0)}else if(he&&Y&&te){const ue=document.createTreeWalker(Z,NodeFilter.SHOW_TEXT);let xe=null,me;for(;me=ue.nextNode();)xe=me;xe&&(V=xe,oe=((W=xe.textContent)==null?void 0:W.length)||0)}else{const ue=document.createTreeWalker(Z,NodeFilter.SHOW_TEXT);let xe=null,me;for(;me=ue.nextNode();)xe=me;xe&&(V=xe,oe=((B=xe.textContent)==null?void 0:B.length)||0)}}const ie=Wr(r,re,ne),fe=Wr(r,V,oe);d=Math.min(ie,fe),u=Math.max(ie,fe),c=z.substring(d,u)}}else{const D=window.getSelection();if(c=(D==null?void 0:D.toString())||"",D&&D.rangeCount>0){const L=D.getRangeAt(0).cloneRange(),A=document.createElement("span");A.style.position="absolute",A.textContent="​",L.insertNode(A),l=A.getBoundingClientRect(),(F=A.parentNode)==null||F.removeChild(A)}}const h=E.getState();let f;const g="rgb(198, 183, 0)";if(se.highlightAndCreate.createHighlight&&(a||i)&&d!==u){const D=e.highlights||[],L=D.find(A=>A.start===d&&A.end===u);if(L)f=L.id;else{f=Math.random().toString(36).slice(2,10);const A={id:f,start:d,end:u,color:g,createdAt:Date.now()},T=[...D,A];h.updateNode(e.id,{highlights:T})}}const m=h.getSegmentedButtonAction("canvas-fit-width");let x=null;if(m){const D=/Set width to (\d+)px/.exec(m);D&&(x=parseInt(D[1],10))}let w,v,b;const N=document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(N&&window.getComputedStyle(N).lineHeight,x)v=ct(c,{containerWidth:x})+pe.NODE_Y_PADDING*2,w=x,b=!0;else{const D=gs(c);w=D.width,v=D.height,b=!1}const j=Le.buildTextNodeV2({content:c,width:w,height:v,linkedHighlightId:f,linkedSourceNodeId:e.id,options:{lockSize:b}});let k=e.y;if(l){const D=l.top;k=e.y+D,l.height&&(k+=l.height/2)}const S=j.height??v,C=k-S/2,R=s||e.id,I=se.highlightAndCreate.createConnectingArrow;if(_o(j,{...e,y:C,id:R},o,{shouldFocus:n,createArrow:I}),f){const D=h.getNodeById(e.id),A=((D==null?void 0:D.highlights)||[]).map(T=>T.id===f?{...T,linkedNodeId:j.id}:T);h.updateNode(e.id,{highlights:A})}return j.id}const Jp=1e3,Qp=500,eg=500,tg=250,sg=2e3,ng=1e3,og=500;class ag{handleArrowKey(s,n=!1,o=!1){const r=E.getState(),a=r.projectCanvas.getActive();if(!a)return!1;const i=a.coreState.selectedNodes??[];if(i.length===0)return!1;const c=a.coreState.nodes??[],l=new Set(i.map(g=>g.id)),d=c.filter(g=>l.has(g.id));let u=Jp,h=Qp;o?(u=sg,h=ng):n&&(u=eg,h=tg);const f=d.map(g=>{const y={id:g.id};switch(s.key){case"ArrowLeft":{const m=g.x,w=Math.round(m/u)-1;y.x=w*u;break}case"ArrowRight":{const m=g.x,w=Math.round(m/u)+1;y.x=w*u;break}case"ArrowUp":{const m=g.y,w=Math.round(m/h)-1;y.y=w*h;break}case"ArrowDown":{const m=g.y,w=Math.round(m/h)+1;y.y=w*h;break}}return y});return r.updateNodes(f),this.animateViewportToCenter(f,a),s.preventDefault(),!0}animateViewportToCenter(s,n){if(s.length===0||!n)return;const r=E.getState().setActiveCanvasViewState,a=n.viewState,i=a.scale,c=a.offset,l=n.coreState.nodes??[],d=new Map(l.map(k=>[k.id,k]));let u=0,h=0;s.forEach(k=>{const S=d.get(k.id);if(S){const C=k.x??S.x,R=k.y??S.y;u+=C,h+=R}});const f=u/s.length,g=h/s.length,y=window.innerWidth,m=window.innerHeight,x=y/2-f*i,w=m/2-g*i,v=performance.now(),b=c.x,N=c.y,j=k=>{const S=k-v,C=Math.min(S/og,1),R=1-Math.pow(1-C,3),I=b+(x-b)*R,M=N+(w-N)*R;r(W=>({...W,offset:{x:I,y:M}})),C<1&&requestAnimationFrame(j)};requestAnimationFrame(j)}}const $r=!0,rg=1/3;function ig(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}class cg{async onPaste(s){try{const n=await navigator.clipboard.read();for(const o of n){const r=o.types.find(h=>h.startsWith("image/"));if(!r)continue;const a=await o.getType(r);if(!a)continue;const i=Math.round(a.size/1024),c=await this.blobToDataUrl(a);let l,d;if($r){const h=await ig(c,rg);l=h.dataUrl,d=h.size}const u=$r?Math.round(l.length*3/4/1024):i;return this.createImageNode(l,d,u),s.preventDefault(),!0}}catch(n){console.debug("ImageModeHandler: Clipboard read failed",n)}return!1}blobToDataUrl(s){return new Promise((n,o)=>{const r=new FileReader;r.onload=()=>n(r.result),r.onerror=o,r.readAsDataURL(s)})}createImageNode(s,n,o){const r=E.getState(),a=r.getCanvasMouseCoords();if(!a){console.warn("ImageModeHandler: No mouse position available");return}const i=300,c=n.height/n.width,l=Math.round(i*c),d=Le.buildImageNode({x:a.x,y:a.y,width:i,height:Math.max(l,100)});d.data={image:s,imageSize:n,fileSizeKB:o},r.addNode(d),r.setNodeToFocusId(d.id)}}function lg(){const e=document.activeElement;if(!e)return null;const s=["INPUT","TEXTAREA"].includes(e.nodeName??""),n=e.contentEditable==="true";return s||n}class dg{constructor(){Oe(this,"activeCallback",null)}registerCallback(s){this.activeCallback=s}unregisterCallback(s){this.activeCallback===s&&(this.activeCallback=null)}applyHighlight(s){return this.activeCallback?(this.activeCallback(s),!0):!1}hasActiveCallback(){return this.activeCallback!==null}}const pn=new dg,ug=new xs("useCanvasKeyboardEventsV2",ws.useCanvasKeyboardEventsV2),hg=["q","Q","$","%","5"],pg=()=>{const e=E.getState(),s=e.uiState.mode,n=e.setMode,o=e.setZoomSubMode,r=e.setWriteSubMode,a=e.toggleWriteSubMode,i=e.setArrowSubMode,c=e.toggleArrowSubMode,l=e.setDrawSubMode,d=e.toggleDrawSubMode,u=e.setAddNodeType,h=e.setNodeToFocusId,f=e.duplicateNodes,g=e.setSelectedNodes,y=e.arrow.setSelected,m=e.deleteSelectedNodes,x=e.deleteSelectedArrows,w=e.setActiveCanvasViewState,v=e.toggleOverlayVisibility,b=p.useRef(new Gt),N=p.useRef(new ag),j=p.useRef(new cg),k=p.useRef(0);return p.useCallback(S=>{var F;const C=E.getState().uiState.mode;if(C===Q.VIM)return;if(S.key==="Escape"){const D=Date.now(),A=D-k.current<400;if(k.current=D,A){const O=document.querySelector('[data-test="canvas-chat-input-container"] textarea');O==null||O.focus();return}if(E.getState().uiState.activeGroupId){E.getState().group.setActiveGroupId(null);return}C===Q.SELECT&&g([]),n(Q.SELECT),h(null),u(null);return}if((S.key==="h"||S.key==="H")&&(S.ctrlKey||S.metaKey)){S.preventDefault(),pn.applyHighlight();return}const R=S.key==="Enter"&&S.ctrlKey,I=S.key==="a"&&C===Q.WRITE;if(C===Q.WRITE&&!R&&!I)return;const M=lg(),W=hg.includes(S.key);if(M&&!W)return;if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(S.key)){const D=e.projectCanvas.getActive(),L=(D==null?void 0:D.coreState.selectedNodes)??[];if(C===Q.GRID&&L.length>0){const A=S.ctrlKey,T=S.shiftKey;if(N.current.handleArrowKey(S,A,T))return}if(S.ctrlKey&&L.length>0&&C!==Q.GRID){const A=e.uiState.lastUpdatedNodeId;if(!A)return;const T=(F=D==null?void 0:D.coreState.nodes)==null?void 0:F.find($=>$.id===A);if(!T)return;const O=L.map($=>{const _={id:$.id};switch(S.key){case"ArrowLeft":case"ArrowRight":_.x=T.x;break;case"ArrowUp":case"ArrowDown":_.y=T.y;break}return _});e.updateNodes(O),S.preventDefault();return}if(L.length===0){const A=S.shiftKey?100:30;w(T=>{let O=0,$=0;switch(S.key){case"ArrowUp":$=A;break;case"ArrowDown":$=-A;break;case"ArrowLeft":O=A;break;case"ArrowRight":O=-A;break}return{...T,offset:{x:T.offset.x+O,y:T.offset.y+$}}}),S.preventDefault();return}}switch(S.key){case".":{S.preventDefault();break}case"a":{if(S.preventDefault(),S.ctrlKey||S.metaKey){const A=e.projectCanvas.getActive(),T=(A==null?void 0:A.coreState.nodes)??[];g(T);break}const D=e.uiState.addNodeType;C===Q.ADD&&D===de.TEXT?(n(Q.WRITE),r(Ws.AUDIO)):C===Q.WRITE?a():C===Q.DRAW_ARROW?c():(n(Q.DRAW_ARROW),i(ro.DEFAULT));break}case"c":if(S.ctrlKey||S.metaKey){const D=window.getSelection();if(D&&D.toString().trim().length>0)break;S.preventDefault(),el();break}S.preventDefault(),console.clear();break;case"d":if(S.preventDefault(),S.ctrlKey){f();break}g([]),y([]),n(Q.DRAW);break;case"v":if(S.ctrlKey){const D=e.projectCanvas.getActive();if(((D==null?void 0:D.coreState.selectedNodes)??[]).some(T=>T.type===de.OCR||T.type===de.IMAGE))break;(async()=>await j.current.onPaste(S)||b.current.onPaste(S))();break}n(Q.SELECT);break;case"g":if(S.ctrlKey){E.getState().group.createFromSelected()&&S.preventDefault();break}n(Q.GRID);break;case"h":case"H":C===Q.MOVE?(n(Q.ZOOM),o("zoom")):C===Q.ZOOM?n(Q.MOVE):n(Q.MOVE);break;case"i":n(Q.VIM);break;case"n":{E.getState().setCustomNodeDropdownOpen(!0);break}case"q":if(S.ctrlKey){b.current.onCopy();break}break;case"r":S.altKey&&(S.preventDefault(),E.getState().executeGlobalLastAction());break;case"s":(S.ctrlKey||S.metaKey)&&(S.preventDefault(),E.getState().saveStateToLocalStorage());break;case"Q":if(S.ctrlKey&&S.shiftKey){b.current.onCopy();break}break;case"$":{b.current.highlightAndCreateNode(S,"right");break}case"%":case"5":{b.current.highlightAndCreateNode(S,"left");break}case"t":n(Q.ADD),u(de.TEXT);break;case"w":{const D=e.uiState.addNodeType;C===Q.ADD&&D===de.TEXT&&(n(Q.WRITE),r(Ws.WRITE));break}case"u":case"U":(S.ctrlKey||S.metaKey)&&S.shiftKey&&(S.preventDefault(),E.getState().setUiState(D=>({...D,undoTreeExplorerOpen:!D.undoTreeExplorerOpen})));break;case"y":(S.ctrlKey||S.metaKey)&&(S.preventDefault(),E.getState().undo.redo());break;case"z":if(S.ctrlKey||S.metaKey){S.preventDefault(),S.shiftKey?E.getState().undo.redo():E.getState().undo.undo();break}v();break;case"1":case"2":case"3":case"4":if(C===Q.DRAW){S.preventDefault();const D=ze.getSubModeFromKey(S.key);D&&l(D)}break;case"Tab":C===Q.DRAW&&(S.preventDefault(),d());break;case"Delete":case"Backspace":m(),x(),S.preventDefault();break}},[s,n,o,r,a,i,c,l,d,u,m,x,w,v,e])},gg=()=>p.useCallback(e=>{ug.log("Key Up:",e.key)},[]),wo=(e,s)=>e.x<s.x+s.width&&e.x+e.width>s.x&&e.y<s.y+s.height&&e.y+e.height>s.y,yo=e=>({x:e.x,y:e.y,width:e.width??100,height:e.height??50}),fg=(e,s,n)=>{const{x1:o,y1:r,x2:a,y2:i}=n,{x:c,y:l}=e,{x:d,y:u}=s,h=d-c,f=u-l;let g=-1/0,y=1/0;const m=(w,v,b,N)=>{if(Math.abs(v)<1e-6)return w>=b&&w<=N;let j=(b-w)/v,k=(N-w)/v;return j>k&&([j,k]=[k,j]),g=Math.max(g,j),y=Math.min(y,k),g<=y};if(!m(c,h,o,a)||!m(l,f,r,i)||g>1||y<0)return null;const x=Math.max(0,g);return x<=1?{x:c+x*h,y:l+x*f}:null},et=(e,s,n,o,r)=>{var d;if(!e)return s;const a=o.find(u=>u.id===e);if((a==null?void 0:a.width)===void 0||a.height===void 0)return s;if(r){const u=`[data-row-connector="${r}"][data-node-id="${e}"]`,h=document.querySelector(u);if(h){const f=h.getBoundingClientRect(),g=document.querySelector("[data-canvas-content]");if(g){const y=g.getBoundingClientRect(),m=f.left+f.width/2-y.left,x=f.top+f.height/2-y.top,v=(d=E.getState().projectCanvas.getActive())==null?void 0:d.viewState;return v?xt({x:m,y:x},v.scale,v.offset):{x:m,y:x}}}else return s}const i=wn(a),c=Ge(a);return fg(n,c,i)??c},mg=(e,s,n,o,r)=>{if(r===0){const a=n/o;return Math.abs(e)*a>=Math.abs(s)}return Math.abs(e)*r>=Math.abs(s)},Ms=(e,s,n,o,r=0,a=se.arrows.CUBIC_HORIZONTAL_BIAS)=>{if(!e)return s;const i=o.find(h=>h.id===e);if(!(i!=null&&i.width)||!i.height)return s;const c=Ge(i),l=n.x-c.x,d=n.y-c.y;return mg(l,d,i.width,i.height,a)?l>0?{x:i.x+i.width-r,y:c.y}:{x:i.x+r,y:c.y}:d>0?{x:c.x,y:i.y+i.height-r}:{x:c.x,y:i.y+r}};function Br(e,s,n){switch(s){case"fixed-minimum":return Math.max(e*.5,50)*n;case"no-minimum":return e*.5*n;case"scaled-minimum":const o=Math.min(e*.3,50);return Math.max(e*.5,o)*n;case"proportional":return Math.max(e*.4,10)*n;default:return Math.max(e*.5,50)*n}}function xg(e,s,n,o){const r=s.x-e.x,a=s.y-e.y,i=Math.abs(r),c=Math.abs(a),l=(o==null?void 0:o.dx)??r,d=(o==null?void 0:o.dy)??a,u=se.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,h=se.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,f=se.arrows.CUBIC_CONTROL_DISTANCE_MODE;let g,y;if(n==="horizontal"){const m=Br(i,f,u),x=l>0?1:-1,w=h?-1:1;g={x:e.x+x*m*w,y:e.y},y={x:s.x-x*m*w,y:s.y}}else{const m=Br(c,f,u),x=d>0?1:-1,w=h?-1:1;g={x:e.x,y:e.y+x*m*w},y={x:s.x,y:s.y-x*m*w}}return[g,y]}const vo=(e,s,n,o,r=0)=>{if(!e)return s;const a=o.find(l=>l.id===e);if(!(a!=null&&a.width)||!a.height)return s;const i=Ge(a);return n.x-i.x>0?{x:a.x+a.width-r,y:i.y}:{x:a.x+r,y:i.y}},tl=(e,s,n)=>{if(!e)return s;const o=n.find(a=>a.id===e);return!(o!=null&&o.width)||!o.height?s:{x:Ge(o).x,y:o.y+o.height}};function sl(e,s,n){const o=e.type??se.arrows.type,r=se.arrows.CUBIC_HORIZONTAL_BIAS,a=-10,i=s.find(h=>h.id===e.startNodeId),c=s.find(h=>h.id===e.endNodeId),l=o==="TreeCubic"||o==="TreeLStep"||o==="TreeZShape";let d;if(l&&i&&c){const h=Ge(i);d=vo(e.endNodeId,e.endPoint,h,s,a)}else if((o==="Cubic"||o==="Orthogonal")&&i&&c){const h=Ge(i);d=Ms(e.endNodeId,e.endPoint,h,s,a,r)}else if(o==="Step"&&i&&c){const h=Ge(i),f=Ge(c),g=f.x-h.x,y=f.y-h.y,x=Math.abs(g)*r>=Math.abs(y)?.001:1e3;d=Ms(e.endNodeId,e.endPoint,h,s,a,x)}else{const h=i?et(e.startNodeId,e.startPoint,e.endPoint,s,e.startRowId):e.startPoint;d=c?et(e.endNodeId,e.endPoint,h,s,e.endRowId):e.endPoint}let u;if(o==="TreeLStep"&&i)u=tl(e.startNodeId,e.startPoint,s);else if((o==="TreeCubic"||o==="TreeZShape")&&i&&c){const h=Ge(c);u=vo(e.startNodeId,e.startPoint,h,s,0)}else if((o==="Cubic"||o==="Step"||o==="Orthogonal")&&i&&c){const h=Ge(c);u=Ms(e.startNodeId,e.startPoint,h,s,0,r)}else{const h=c?et(e.endNodeId,e.endPoint,e.startPoint,s,e.endRowId):e.endPoint;u=i?et(e.startNodeId,e.startPoint,h,s,e.startRowId):e.startPoint}return{actualStartPoint:u,actualEndPoint:d}}function wg(e,s,n){const{actualStartPoint:o,actualEndPoint:r}=sl(e,s),a=Math.min(o.x,r.x),i=Math.min(o.y,r.y),c=Math.max(o.x,r.x),l=Math.max(o.y,r.y);return{x:a,y:i,width:c-a,height:l-i}}const Hr={SELECTION_BOX_END:"selectionBoxEnd"};class yg{constructor(){Oe(this,"listeners",{})}subscribe(s,n){return this.listeners[s]||(this.listeners[s]=[]),this.listeners[s].push(n),()=>{this.unsubscribe(s,n)}}unsubscribe(s,n){this.listeners[s]&&(this.listeners[s]=this.listeners[s].filter(o=>o!==n))}dispatch(s,n){this.listeners[s]&&this.listeners[s].forEach(o=>{try{o(n)}catch(r){console.error(`Error in event listener for ${s} event:`,r)}})}}const vg=new yg,is=new xs("useSelectionHandler",ws.useSelectionHandler),bg=e=>e?se.autoScroll.edgeThresholdMobile:se.autoScroll.edgeThreshold,Bn=se.autoScroll.scrollSpeed,sr=e=>{const n=e.target.closest("[data-canvas-container]");if(!n)return console.warn("Canvas container not found, falling back to offsetX/Y"),{x:e.offsetX,y:e.offsetY};const o=n.getBoundingClientRect();return{x:e.clientX-o.left,y:e.clientY-o.top}},Ng=()=>{var l;const e=E.getState(),s=e.uiState.mode,n=(l=e.uiState)==null?void 0:l.isPanning,o=e.setSelectionBox,r=e.setPendingSelectionStart,a=e.setSelectedNodes,i=e.setNodeToFocusId,c=e.arrow.setSelected;return p.useCallback(d=>{var N,j,k,S;const u=sr(d);if(s===Q.MOVE||((N=E.getState().uiState)==null?void 0:N.dragInfo))return;const f=d.target,g=f.closest("[data-node-id]"),y=f.closest("[data-arrow-id]"),m=f.closest("[data-group-id]"),x=f.closest("[data-ui-panel]"),w=f.closest("[data-grid-svg]"),v=w&&w.getAttribute("data-grid-active")==="true",b=!!f.closest("foreignObject");if((s===Q.SELECT||s===Q.GRID||s===Q.WRITE||s===Q.VIM)&&(d.button===0||d.button===-1)&&!n){if(g||y||m||x||v||b)return;const C=d.shiftKey&&!d.ctrlKey&&!d.metaKey,R=e.projectCanvas.getActive();if((j=R==null?void 0:R.coreState.nodes)==null?void 0:j.some(T=>T.isEditing))return;const M=(R==null?void 0:R.coreState.selectedNodes)??[],W=(R==null?void 0:R.coreState.nodes)??[],B=(R==null?void 0:R.viewState.scale)??1,F=(R==null?void 0:R.viewState.offset)??{x:0,y:0};if(C&&M.length>0){const T=xt(u,B,F),O=M[M.length-1],$=[{x:O.x,y:O.y},{x:O.x+(O.width??0),y:O.y},{x:O.x,y:O.y+(O.height??0)},{x:O.x+(O.width??0),y:O.y+(O.height??0)}];let _=$[0],G=0;$.forEach(re=>{const ne=Math.sqrt(Math.pow(re.x-T.x,2)+Math.pow(re.y-T.y,2));ne>G&&(G=ne,_=re)});const X={x:Math.min(_.x,T.x),y:Math.min(_.y,T.y),width:Math.abs(_.x-T.x),height:Math.abs(_.y-T.y)},J=(R==null?void 0:R.coreState.activeLayerId)??mt,P=W.filter(re=>{if((re.layerId??mt)!==J)return!1;const V=yo(re);return wo(V,X)}),z=new Set(M.map(re=>re.id)),U=P.filter(re=>!z.has(re.id)),K=[...M,...U];a(K);return}if(is.log("Selection Mouse Down on Background:",u.x,u.y),s===Q.WRITE){const T=e.projectCanvas.getActive(),O=(T==null?void 0:T.viewState.scale)??1,$=(T==null?void 0:T.viewState.offset)??{x:0,y:0},_=xt(u,O,$);ic(async()=>{const{CanvasNodeBuilderV2:G}=await Promise.resolve().then(()=>wp);return{CanvasNodeBuilderV2:G}},void 0).then(({CanvasNodeBuilderV2:G})=>{const X=G.buildTextNode(_,"");X.isEditing=!0,e.addNode(X,""),e.setNodeToFocusId(X.id)});return}const D=(k=E.getState().uiState)==null?void 0:k.pendingSelectionStart,L=(S=E.getState().uiState)==null?void 0:S.selectionBox;if(D&&L){r(null);return}const A=xt(u,B,F);r(A),a([]),c([]),i(null),o({start:u,end:u})}},[s,n,o,r,a,i,c,e])},Sg=()=>{const e=E.getState(),s=e.setSelectionBox,n=e.setActiveCanvasViewState,o=H(d=>d.uiState.selectionBox),r=Rn(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useCallback(()=>{var y,m;const d=E.getState().projectCanvas.getActive(),u=(y=E.getState().uiState)==null?void 0:y.selectionBox;if(!d||!u){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const h=d.viewState.offset;let f=0,g=0;if(f=i.current.x,g=i.current.y,f!==0||g!==0){n(w=>({...w,offset:{x:h.x+f,y:h.y+g}}));const x=(m=E.getState().uiState)==null?void 0:m.selectionBox;if(x){const w={x:x.start.x+f,y:x.start.y+g};s({start:w,end:x.end})}}a.current=requestAnimationFrame(l)},[n,s]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useEffect(()=>{o||(c.current=null)},[o]),p.useCallback(d=>{var D,L,A,T,O;if((D=E.getState().uiState)==null?void 0:D.dragInfo)return;const h=sr(d),f=(L=E.getState().uiState)==null?void 0:L.pendingSelectionStart,g=E.getState().projectCanvas.getActive(),y=(g==null?void 0:g.viewState.scale)??1,m=(g==null?void 0:g.viewState.offset)??{x:0,y:0};if((A=g==null?void 0:g.coreState.nodes)==null?void 0:A.some($=>$.isEditing))return;const w=(d.buttons&1)!==0;if(f&&d.shiftKey&&!w){const $=f.x*y+m.x,_=f.y*y+m.y;s({start:{x:$,y:_},end:h});return}if(f&&!d.shiftKey&&!w){((T=E.getState().uiState)==null?void 0:T.selectionBox)&&s(null);return}if(!o)return;const v=(O=E.getState().uiState)==null?void 0:O.selectionBox;if(!v)return;const b=window.innerWidth,N=window.innerHeight;let j=0,k=0;c.current&&(j=h.x-c.current.x,k=h.y-c.current.y),c.current={x:h.x,y:h.y},s({start:v.start,end:h});const S=d.clientX,C=d.clientY,R=bg(r),I=C<R&&k<0,M=C>N-R&&k>0,W=S<R&&j<0,B=S>b-R&&j>0,F=I||M||W||B;if(F){let $=0,_=0;I&&(_=Bn),M&&(_=-Bn),W&&($=Bn),B&&($=-Bn),i.current={x:$,y:_},a.current===null&&(a.current=requestAnimationFrame(l))}else!F&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null,i.current={x:0,y:0})},[s,o,l,r])},Cg=()=>{var c;const e=E.getState(),s=e.setSelectionBox,n=e.setPendingSelectionStart,o=(c=e.uiState)==null?void 0:c.selectionBox,r=e.projectCanvas.getActive,a=e.setSelectedNodes,i=e.arrow.setSelected;return p.useCallback(l=>{var v,b,N;if((v=E.getState().uiState)==null?void 0:v.dragInfo)return;const u=sr(l),h=r(),f=(h==null?void 0:h.coreState.nodes)??[],g=(h==null?void 0:h.coreState.arrows)??[],y=(h==null?void 0:h.viewState.scale)??1,m=(h==null?void 0:h.viewState.offset)??{x:0,y:0},x=(b=E.getState().uiState)==null?void 0:b.selectionBox,w=(N=E.getState().uiState)==null?void 0:N.pendingSelectionStart;if(x){is.log("Selection Mouse Up:",u.x,u.y),is.log("Stopped Marquee Selection");const j={x:Math.min(x.start.x,u.x),y:Math.min(x.start.y,u.y),width:Math.abs(x.start.x-u.x),height:Math.abs(x.start.y-u.y)},k=xt({x:j.x,y:j.y},y,m),S=xt({x:j.x+j.width,y:j.y+j.height},y,m),C={x:k.x,y:k.y,width:S.x-k.x,height:S.y-k.y},R=5;if(j.width<R&&j.height<R){const F=E.getState().uiState.activeGroupId;if(F){const D=f.find(L=>L.id===F);if(D){const L=yo(D),A=xt(u,y,m);A.x>=L.x&&A.x<=L.x+L.width&&A.y>=L.y&&A.y<=L.y+L.height||E.getState().group.setActiveGroupId(null)}else E.getState().group.setActiveGroupId(null)}w||(s(null),a([]),i([]));return}const I=E.getState().uiState.activeGroupId,M=(h==null?void 0:h.coreState.activeLayerId)??mt,W=f.filter(F=>{if(I&&F.id===I||(F.layerId??mt)!==M)return!1;const L=yo(F);return wo(L,C)});is.log("Selected Nodes by Marquee:",W.map(F=>F.content)),a(W);const B=g.filter(F=>{const D=wg(F,f),L=wo(D,C);return is.log(">>>> _ >>>> ~ useSelectionHandler.ts:164 ~ arrowBBox:",D),L});is.log("Selected Arrows by Marquee:",B.map(F=>F.id)),i(B),W.length>0&&(vg.dispatch(Hr.SELECTION_BOX_END,{selectedNodes:W}),is.log(`Dispatched ${Hr.SELECTION_BOX_END} event with nodes:`,W.map(F=>F.id))),s(null),n(null)}},[o,r,s,n,a,i])},jg=()=>{const e=xn.getState().mousePosition??null,n=E.getState().projectCanvas.getActive,o=n(),r=(o==null?void 0:o.viewState.scale)??1,a=(o==null?void 0:o.viewState.offset)??{x:0,y:0},i=p.useMemo(()=>e?xt(e,r,a):null,[e,r,a]);return{screenCoords:e,canvasCoords:i}},gt={"I am dragging a node near the <edge> edge":"I am dragging a node near the <edge> edge","I am dragging a node near the top edge":"I am dragging a node near the top edge","I am dragging a node toward the <edge> edge":"I am dragging a node toward the <edge> edge","I am in GRID mode":"I am in GRID mode","I am in MOVE mode":"I am in MOVE mode","I am in SELECT mode":"I am in SELECT mode","I am in WRITE mode":"I am in WRITE mode","I have a canvas with nodes":"I have a canvas with nodes","I have selected a node":"I have selected a node","auto-scroll is active":"auto-scroll is active"},zt={"I click on a node":"I click on a node","I hold Ctrl and click on another node":"I hold Ctrl and click on another node","I hold Ctrl and click on one of the selected nodes":"I hold Ctrl and click on one of the selected nodes","I hold Shift and click on a node":"I hold Shift and click on a node"},kg=e=>e?se.autoScroll.edgeThresholdMobile:se.autoScroll.edgeThreshold,so=se.autoScroll.edgeThreshold;let nl=!1;const Ag=e=>{nl=e};let Ca=0,ol=0;const no={[gt["I have a canvas with nodes"]]:()=>{const e=E.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.nodes.length)??0)>0},[gt["I have selected a node"]]:()=>{const e=E.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.selectedNodes.length)??0)>0},[gt["I am dragging a node near the top edge"]]:(e,s=so)=>E.getState().uiState.dragInfo?(e??Ca)<s:!1,[gt["I am dragging a node near the <edge> edge"]]:(e,s,n,o=so)=>{if(!E.getState().uiState.dragInfo)return!1;const i=s??ol,c=n??Ca;switch(e){case"top":return c<o;case"bottom":return c>window.innerHeight-o;case"left":return i<o;case"right":return i>window.innerWidth-o;default:return!1}},[gt["auto-scroll is active"]]:()=>nl,[gt["I am dragging a node toward the <edge> edge"]]:(e,s,n,o=so)=>{if(!E.getState().uiState.dragInfo)return!1;const i=no[gt["I am dragging a node near the <edge> edge"]](e,void 0,void 0,o);if(!i)return!1;if(s===void 0&&n===void 0)return i;switch(e){case"top":return(n??0)<0;case"bottom":return(n??0)>0;case"left":return(s??0)<0;case"right":return(s??0)>0;default:return!1}}},Ig=(e,s)=>{ol=e,Ca=s},es=se.autoScroll.scrollSpeed,al=(e,s,n=so)=>{if(e===null||s===null)return{x:0,y:0};let o=0,r=0;const a=window.innerWidth,i=window.innerHeight;return e<n?o=es:e>a-n&&(o=-es),s<n?r=es:s>i-n&&(r=-es),{x:o,y:r}},Tg=(e,s)=>({x:-e.x/s,y:-e.y/s}),Hn={getScrollDeltaForMousePosition:(e,s)=>al(e,s),shouldScroll:e=>e.x!==0||e.y!==0,applyDeltaToPosition:(e,s,n)=>({x:Number((e+n.x).toFixed(2)),y:Number((s+n.y).toFixed(2))})},Ss={calculateScrollDelta:(e,s)=>{if(e){const n=al(e.x,e.y),o=Hn.shouldScroll(n);return{delta:n,shouldUpdateLastDelta:o}}return{delta:s,shouldUpdateLastDelta:!1}},calculateNewOffset:(e,s)=>({x:e.x+s.x,y:e.y+s.y}),updateNodesForScroll:(e,s,n)=>e.map(o=>{if(s.has(o.id)){const r=Hn.applyDeltaToPosition(o.x,o.y,n);return{...o,...r}}return o}),updateSelectedNodesForScroll:(e,s)=>e.map(n=>{const o=Hn.applyDeltaToPosition(n.x,n.y,s);return{...n,...o}}),updateArrowsForScroll:(e,s,n)=>e.map(o=>{let r=o.startPoint,a=o.endPoint;return o.startNodeId&&s.has(o.startNodeId)&&(r={x:Number((o.startPoint.x+n.x).toFixed(2)),y:Number((o.startPoint.y+n.y).toFixed(2))}),o.endNodeId&&s.has(o.endNodeId)&&(a={x:Number((o.endPoint.x+n.x).toFixed(2)),y:Number((o.endPoint.y+n.y).toFixed(2))}),r!==o.startPoint||a!==o.endPoint?{...o,startPoint:r,endPoint:a}:o}),processAutoScrollFrame:e=>{const{mousePosition:s,lastScrollDelta:n,currentOffset:o,scale:r,nodes:a,selectedNodes:i,arrows:c=[]}=e,{delta:l}=Ss.calculateScrollDelta(s,n);if(!Hn.shouldScroll(l))return{shouldScroll:!1,scrollDelta:l,newOffset:o,updatedNodes:a,updatedSelectedNodes:i,updatedArrows:c};const u=Ss.calculateNewOffset(o,l),h=Tg(l,r),f=new Set(i.map(x=>x.id)),g=Ss.updateNodesForScroll(a,f,h),y=Ss.updateSelectedNodesForScroll(i,h),m=Ss.updateArrowsForScroll(c,f,h);return{shouldScroll:!0,scrollDelta:l,newOffset:u,updatedNodes:g,updatedSelectedNodes:y,updatedArrows:m}}},ja={isShiftPressed:e=>e.shiftKey&&!e.ctrlKey&&!e.metaKey,isCtrlPressed:e=>e.ctrlKey||e.metaKey,noModifiersPressed:e=>!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey},Eg=e=>{const s=E.getState().projectCanvas.getActive();return(s==null?void 0:s.coreState.selectedNodes.some(n=>n.id===e))??!1},Fn=()=>{const e=E.getState().projectCanvas.getActive();return(e==null?void 0:e.coreState.selectedNodes)??[]},ka={isClickOnEditingElement:e=>!!e.closest("[data-is-editing='true']"),hasActiveTextSelection:()=>{const e=window.getSelection();return e!==null&&!e.isCollapsed&&e.toString().length>0},getSelectedText:()=>{const e=window.getSelection();return(e==null?void 0:e.toString())??""},isInsideTextInput:e=>{const s=e.tagName.toLowerCase();return s==="textarea"||s==="input"?!0:!!e.closest('textarea, input, [contenteditable="true"]')}},Rg=(e,s)=>{const n=[];for(const o of s)o.startNodeId===e&&o.endNodeId&&n.push(o.endNodeId);return n},Mg=(e,s)=>s.filter(n=>n.endNodeId===e).length,rl=(e,s,n,o=!1)=>{const r=new Set(e),a=new Set,i=[...e],c=new Set(e);for(;i.length>0;){const d=i.shift(),u=Rg(d,n);for(const h of u)c.has(h)||s.some(f=>f.id===h)&&(c.add(h),!(o&&Mg(h,n)>1)&&(a.add(h),i.push(h)))}return s.filter(d=>a.has(d.id)&&!r.has(d.id))},Pg=(e,s)=>{const n=new Set,o=e.filter(r=>r.isCollapsed);for(const r of o)rl([r.id],e,s,!0).forEach(i=>n.add(i.id));return n};let Dg=!0;const Fr={isDragInProgress:()=>{var s;const e=(s=E.getState().uiState)==null?void 0:s.dragInfo;return e!=null},isDragWithSelectedNodes:()=>{var o;const e=E.getState();if(!((o=e.uiState)==null?void 0:o.dragInfo))return!1;const n=e.projectCanvas.getActive();return((n==null?void 0:n.coreState.selectedNodes.length)??0)>0},isFirstMoveEvent:()=>Dg,[gt["I am in SELECT mode"]]:()=>E.getState().uiState.mode===Q.SELECT,[gt["I am in GRID mode"]]:()=>E.getState().uiState.mode===Q.GRID,[gt["I am in MOVE mode"]]:()=>E.getState().uiState.mode===Q.MOVE,[gt["I am in WRITE mode"]]:()=>E.getState().uiState.mode===Q.WRITE,canDragInCurrentMode:()=>{const e=E.getState().uiState.mode;return e===Q.SELECT||e===Q.GRID||e===Q.WRITE||e===Q.VIM},isPrimaryButton:e=>e.button===0||e.button===-1},sn={calculateScreenDelta:e=>{const{screenCoords:s,prevScreenPos:n}=e;if(!s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:null,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!0};if(s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:s,newDragDirection:null,isFirstMoveEvent:!0,shouldSkipFrame:!0};if(s&&n){const o={x:s.x-n.x,y:s.y-n.y},r=o.x!==0||o.y!==0?o:null;return{screenDelta:o,newPrevScreenPos:s,newDragDirection:r,isFirstMoveEvent:!1,shouldSkipFrame:!1}}return{screenDelta:{x:0,y:0},newPrevScreenPos:n,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!1}},screenDeltaToCanvasDelta:(e,s)=>({x:e.x/s,y:e.y/s}),checkAutoScrollEdges:e=>{const{screenCoords:s,dragDirection:n,draggedNode:o,scale:r,offset:a,edgeThreshold:i}=e;let c=!1;o&&(c=o.y*r+a.y<=0&&n.y<0);const l=c,d=no[gt["I am dragging a node toward the <edge> edge"]]("bottom",n.x,n.y,i),u=no[gt["I am dragging a node toward the <edge> edge"]]("left",n.x,n.y,i),h=no[gt["I am dragging a node toward the <edge> edge"]]("right",n.x,n.y,i);return{shouldAutoScroll:l||d||u||h}},calculateMouseLeftWindowDelta:e=>{const{lastCoords:s,viewportWidth:n,viewportHeight:o}=e;if(!s)return{shouldStartAutoScroll:!1,scrollDelta:{x:0,y:0}};let r=0,a=0;return s.x<n/2?r=es:r=-es,s.y<o/2?a=es:a=-es,{shouldStartAutoScroll:!0,scrollDelta:{x:r,y:a}}},calculateNodeMoves:e=>{const{canvasDelta:s,draggedNodeId:n,selectedNodes:o,nodes:r,arrows:a,isCtrlPressed:i,isShiftPressed:c}=e;if(Math.abs(s.x)<.1&&Math.abs(s.y)<.1)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const l=new Set(o.map(m=>m.id));let d=new Set(l);if(i){const m=c??!1;rl(Array.from(l),r,a,m).forEach(w=>d.add(w.id))}for(const m of o)if(m.type===de.GROUP){const x=m.data,w=x==null?void 0:x.childNodeIds;if(w)for(const v of w)d.add(v)}if(d.size===0)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const u=s.x,h=s.y;let f=null;for(let m=0;m<r.length;m++){const x=r[m];d.has(x.id)&&(f||(f=r.slice()),f[m]={...x,x:x.x+u,y:x.y+h})}let g=null;for(let m=0;m<o.length;m++){const x=o[m];d.has(x.id)&&(g||(g=o.slice()),g[m]={...x,x:x.x+u,y:x.y+h})}let y=null;for(let m=0;m<a.length;m++){const x=a[m],w=x.startNodeId&&d.has(x.startNodeId),v=x.endNodeId&&d.has(x.endNodeId);(w||v)&&(y||(y=a.slice()),y[m]={...x,startPoint:w?{x:x.startPoint.x+u,y:x.startPoint.y+h}:x.startPoint,endPoint:v?{x:x.endPoint.x+u,y:x.endPoint.y+h}:x.endPoint})}return{shouldUpdate:!0,updatedNodes:f??r,updatedSelectedNodes:g??o,updatedArrows:y??a}}},Og=(e,s)=>{const n=[{x:e.x,y:e.y},{x:e.x+(e.width??0),y:e.y},{x:e.x,y:e.y+(e.height??0)},{x:e.x+(e.width??0),y:e.y+(e.height??0)}];let o=n[0],r=0;return n.forEach(a=>{const i=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2));i>r&&(r=i,o=a)}),o},Lg=(e,s)=>({x:Math.min(e.x,s.x),y:Math.min(e.y,s.y),width:Math.abs(e.x-s.x),height:Math.abs(e.y-s.y)}),Wg=(e,s)=>e.filter(n=>{const o=yo(n);return wo(o,s)}),$g=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=s.filter(r=>!n.has(r.id));return[...e,...o]},Cs={[zt["I hold Shift and click on a node"]]:(e,s)=>{const o=E.getState().projectCanvas.getActive(),r=(o==null?void 0:o.coreState.selectedNodes)??[],a=(o==null?void 0:o.coreState.nodes)??[];if(r.length===0)return[e];const i=r[r.length-1],c=Og(i,s),l=Lg(c,s),d=Wg(a,l);return $g(r,d)},[zt["I hold Ctrl and click on one of the selected nodes"]]:e=>Fn().filter(n=>n.id!==e.id),[zt["I hold Ctrl and click on another node"]]:e=>[...Fn(),e],[zt["I click on a node"]]:(e,s)=>s?Fn():[e],handleNodeMouseDown:e=>{const{node:s,event:n,canvasCoords:o}=e,r=E.getState(),a=r.projectCanvas.getActive(),i=Fn(),c=Eg(s.id),l=(a==null?void 0:a.coreState.activeLayerId)??mt,d=s.layerId??mt;if(d!==l)return{action:"wrong_layer",shouldStartDrag:!1,newSelection:i,targetLayerId:d,clickedNode:s};const u=s.groupId,h=r.uiState.activeGroupId,f=(a==null?void 0:a.coreState.nodes)??[];if(s.type===de.GROUP&&c&&i.length===1&&h!==s.id)return r.group.setActiveGroupId(s.id),{action:"keep_selection",shouldStartDrag:!0,newSelection:i,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};if(u&&u!==h){const m=f.find(x=>x.id===u&&x.type===de.GROUP);if(m)return i.length===1&&i[0].id===m.id?(r.group.setActiveGroupId(u),{action:"replace_selection",shouldStartDrag:!0,newSelection:Cs[zt["I click on a node"]](s,c),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}):{action:"select_group",shouldStartDrag:!1,newSelection:[m],selectedGroup:m}}if(ja.isShiftPressed(n)&&i.length>0)return{action:"shift_select",shouldStartDrag:!1,newSelection:Cs[zt["I hold Shift and click on a node"]](s,o)};if(ja.isCtrlPressed(n))return c?{action:"ctrl_toggle_remove",shouldStartDrag:!1,newSelection:Cs[zt["I hold Ctrl and click on one of the selected nodes"]](s)}:{action:"ctrl_toggle_add",shouldStartDrag:!0,newSelection:Cs[zt["I hold Ctrl and click on another node"]](s),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};h&&u!==h&&r.group.setActiveGroupId(null);const y=Cs[zt["I click on a node"]](s,c);return{action:c?"keep_selection":"replace_selection",shouldStartDrag:!0,newSelection:y,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}}},bt={isNodeInsideGroup:(e,s)=>cc(e,s),isNodeInGroup:e=>e.groupId!==void 0&&e.groupId!==null,isGroupNode:e=>e.type===de.GROUP,canBeAddedToGroup:e=>!bt.isGroupNode(e)&&!bt.isNodeInGroup(e),isValidDropCandidate:e=>!bt.isGroupNode(e)},na={filterValidDropCandidates:e=>e.filter(bt.canBeAddedToGroup),filterNodesInGroups:e=>e.filter(bt.isNodeInGroup),filterGroupNodes:e=>e.filter(bt.isGroupNode),getCurrentGroupForNode:(e,s)=>{if(e.groupId)return s.find(n=>n.id===e.groupId)},findGroupDropTargets:(e,s)=>e.filter(n=>n.type===de.GROUP&&!s.has(n.id))},il={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Set(s.map(i=>i.id)),a=na.findGroupDropTargets(n,r);for(const i of s){if(bt.isGroupNode(i)||bt.isNodeInGroup(i))continue;const c=a.find(l=>l.id===o?!1:bt.isNodeInsideGroup(i,l));if(c)return{hoveredGroupId:c.id,hasValidDropTarget:!0}}return{hoveredGroupId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Map,a=[],i=new Set(s.map(d=>d.id)),c=na.findGroupDropTargets(n,i);for(const d of s){if(bt.isGroupNode(d))continue;if(bt.isNodeInGroup(d)){const h=na.getCurrentGroupForNode(d,c);h&&!bt.isNodeInsideGroup(d,h)&&a.push(d.id);continue}const u=c.find(h=>h.id===o?!1:bt.isNodeInsideGroup(d,h));if(u){const h=r.get(u.id)||[];h.push(d.id),r.set(u.id,h)}}const l=r.size>0||a.length>0;return{nodesToAddToGroups:r,nodesToRemoveFromGroups:a,hasChanges:l}}},Bg=69,Hg=41,Fg=45,Aa={isTableNode:e=>e.type===de.TABLE,isPointInsideNode:(e,s)=>{const n=wn(s);return e.x>=n.x1&&e.x<=n.x2&&e.y>=n.y1&&e.y<=n.y2},hasValidTableData:e=>{const s=e.data;return!!(s!=null&&s.columns)&&Array.isArray(s.columns)&&s.columns.length>0}},gn={getNodeCenter:e=>{const s=wn(e);return{x:(s.x1+s.x2)/2,y:(s.y1+s.y2)/2}},findTableDropTargets:(e,s)=>e.filter(n=>Aa.isTableNode(n)&&!s.has(n.id)),calculateTargetColumn:(e,s)=>{const n=s.data;if(!(n!=null&&n.columns)||n.columns.length===0)return null;const o=wn(s),r=o.x2-o.x1,a=e-o.x1,i=n.columnOrder&&n.columnOrder.length>0?n.columnOrder.map(f=>n.columns.find(g=>g.key===f)).filter(f=>f!==void 0):n.columns;let c=0;for(const f of i)c+=f.width?parseInt(f.width,10):150;const l=r/c;let d=0;const u=[];for(let f=0;f<i.length;f++){const g=i[f],m=(g.width?parseInt(g.width,10):150)*l,x=d;d+=m,u.push({key:g.key,relStart:Math.round(x),relEnd:Math.round(d),absStart:Math.round(o.x1+x),absEnd:Math.round(o.x1+d)})}for(let f=0;f<u.length;f++){const g=u[f];if(a<g.relEnd)return{columnIndex:f,columnKey:g.key}}const h=i[i.length-1];return{columnIndex:i.length-1,columnKey:h.key}},calculateTargetRow:(e,s)=>{const n=s.data;if(!(n!=null&&n.rows)||n.rows.length===0)return null;const o=wn(s),r=e-o.y1,a=Bg+Hg;if(r<a)return null;const i=Math.floor((r-a)/Fg);if(i<0)return null;if(i>=n.rows.length){const c=n.rows[n.rows.length-1];return{rowIndex:n.rows.length-1,rowId:c.id}}return{rowIndex:i,rowId:n.rows[i].id}},extractNodeContent:e=>e.content===null||e.content===void 0?"":String(e.content)},cl={calculateTableDropTarget:e=>{const{droppedNode:s,allNodes:n,mousePosition:o}=e,r=o??gn.getNodeCenter(s),a=new Set([s.id]),i=gn.findTableDropTargets(n,a);for(const c of i){if(!Aa.isPointInsideNode(r,c)||!Aa.hasValidTableData(c))continue;const l=gn.calculateTargetColumn(r.x,c);if(!l)continue;const d=gn.calculateTargetRow(r.y,c);return{targetTableId:c.id,columnIndex:l.columnIndex,columnKey:l.columnKey,rowIndex:(d==null?void 0:d.rowIndex)??null,rowId:(d==null?void 0:d.rowId)??null}}return{targetTableId:null,columnIndex:null,columnKey:null,rowIndex:null,rowId:null}}};var He=(e=>(e.DICTIONARY="dictionary",e.FLASHCARD="flashcard",e.WORD_LIST="word_list",e.ETYMOLOGY="etymology",e.VOCABULARY="vocabulary",e))(He||{});const Ps={isVocabularyNode:e=>e.type===de.VOCABULARY,isVocabularyMode:e=>{if(!Ps.isVocabularyNode(e))return!1;const s=e.data;return(s==null?void 0:s.vocabType)===He.VOCABULARY},isTextNode:e=>e.type===de.TEXT,canBeDroppedOnVocab:e=>Ps.isTextNode(e),isNodeInsideVocabNode:(e,s)=>cc(e,s)},nn={findVocabularyDropTargets:(e,s)=>e.filter(n=>Ps.isVocabularyMode(n)&&!s.has(n.id)),extractNodeContent:e=>typeof e.content=="string"?e.content.trim():"",sortNodesByPosition:e=>[...e].sort((s,n)=>s.x+s.y-(n.x+n.y))},ll={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n}=e,o=new Set(s.map(a=>a.id)),r=nn.findVocabularyDropTargets(n,o);for(const a of s){if(!Ps.canBeDroppedOnVocab(a))continue;const i=r.find(c=>Ps.isNodeInsideVocabNode(a,c));if(i)return{hoveredVocabNodeId:i.id,hasValidDropTarget:!0}}return{hoveredVocabNodeId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,targetVocabNode:n}=e,o=s.filter(Ps.canBeDroppedOnVocab);if(o.length===0)return{sourceWord:"",translationWord:"",nodeIdsToDelete:[],hasChanges:!1};const r=n.data,a=(r==null?void 0:r.sourceWord)||"",i=(r==null?void 0:r.translationWord)||"";let c=a,l=i;const d=[];if(o.length>=2){const h=nn.sortNodesByPosition(o);c=nn.extractNodeContent(h[0]),l=nn.extractNodeContent(h[h.length-1]),d.push(...o.map(f=>f.id))}else{const h=nn.extractNodeContent(o[0]);a?l=h:c=h,d.push(o[0].id)}return{sourceWord:c,translationWord:l,nodeIdsToDelete:d,hasChanges:c!==a||l!==i}}},Nt=new xs("useNodeDragHandler",ws.useCanvasMouseEventsV2),ts=new Map,_g=e=>{const s=E.getState(),n=s.setDragInfo,o=s.setSelectedNodes;return p.useCallback(r=>{const a=E.getState().getCanvasMouseCoords();if(!Fr.canDragInCurrentMode()||!Fr.isPrimaryButton(r))return;r.stopPropagation();const i=r.target;if(ka.isClickOnEditingElement(i)){Nt.log("Node Mouse Down: Clicked on editing node, skipping drag initialization");return}if(!a){Nt.warn("Node Mouse Down: Canvas coordinates not available.");return}const c=Cs.handleNodeMouseDown({node:e,event:r,canvasCoords:a});if(c.action==="wrong_layer"&&c.targetLayerId&&c.clickedNode){s.setUiState(l=>({...l,switchLayerDialog:{isOpen:!0,targetLayerId:c.targetLayerId,clickedNodeId:c.clickedNode.id}})),Nt.log(`Node Mouse Down: Node ${e.id} is on layer ${c.targetLayerId}, not current layer`);return}if(c.action==="select_group"&&c.selectedGroup){o([c.selectedGroup]),Nt.log("Node Mouse Down: Selected parent group node",c.selectedGroup.id,"instead of node",e.id);return}if(o(c.newSelection),Nt.log(`Node Mouse Down: ${c.action}`,e.id,"Selection count:",c.newSelection.length),c.shouldStartDrag&&c.dragStartOffset){const l={};for(const d of c.newSelection)l[d.id]={x:d.x,y:d.y};l[e.id]||(l[e.id]={x:e.x,y:e.y}),n({draggedNodeId:e.id,dragStartOffset:c.dragStartOffset,initialNodePosition:{x:e.x,y:e.y},initialPositions:l}),Nt.log("Node Drag Start on:",e.id,"tracking",Object.keys(l).length,"nodes")}},[e,n,o])},zg=()=>{const e=E.getState(),s=H(h=>h.uiState.dragInfo),n=e.setActiveCanvasCoreState,o=e.setActiveCanvasViewState,{canvasCoords:r}=jg(),a=Rn(),i=p.useRef(null),c=p.useRef({x:0,y:0}),l=p.useRef(null),d=p.useRef({x:0,y:0});p.useEffect(()=>{s&&(l.current=null)},[s]);const u=p.useCallback(()=>{var y;const h=E.getState().projectCanvas.getActive(),f=(y=E.getState().uiState)==null?void 0:y.dragInfo;if(!h||!f){i.current!==null&&(cancelAnimationFrame(i.current),i.current=null);return}const g=Ss.processAutoScrollFrame({mousePosition:xn.getState().mousePosition??null,lastScrollDelta:c.current,currentOffset:h.viewState.offset,scale:h.viewState.scale,nodes:h.coreState.nodes,selectedNodes:h.coreState.selectedNodes,arrows:h.coreState.arrows||[]});g.shouldScroll&&(c.current=g.scrollDelta,o(m=>({...m,offset:g.newOffset})),n(m=>({...m,nodes:g.updatedNodes,selectedNodes:g.updatedSelectedNodes,arrows:g.updatedArrows}))),i.current=requestAnimationFrame(u)},[o,n]);return p.useEffect(()=>()=>{i.current!==null&&cancelAnimationFrame(i.current)},[]),p.useCallback(h=>{var I,M,W;const f=(I=E.getState().uiState)==null?void 0:I.dragInfo;if(!f)return;const g=E.getState().viewLayer.getActiveId();let y;if(g){const B=((M=E.getState().projectCanvas.getActive())==null?void 0:M.coreState.selectedNodes)??[],F=E.getState().viewLayer.getNodesWithEffectivePositions();if(B.length>0)y=B.map(D=>F.find(A=>A.id===D.id)??D);else if(f.draggedNodeId){const D=F.find(L=>L.id===f.draggedNodeId);y=D?[D]:[]}else y=[]}else y=((W=E.getState().projectCanvas.getActive())==null?void 0:W.coreState.selectedNodes)??[];if(y.length===0)return;const m=xn.getState().mousePosition??null,x=sn.calculateScreenDelta({screenCoords:m,prevScreenPos:l.current});if(x.newPrevScreenPos!==null&&(l.current=x.newPrevScreenPos),x.newDragDirection&&(d.current=x.newDragDirection),x.shouldSkipFrame)return;const w=E.getState().projectCanvas.getActive();if(!w)return;const v=w.viewState.scale,b=sn.screenDeltaToCanvasDelta(x.screenDelta,v);if(m){Ig(m.x,m.y);const B=w.coreState.nodes.find(L=>L.id===f.draggedNodeId),F=kg(a),D=sn.checkAutoScrollEdges({screenCoords:m,dragDirection:d.current,draggedNode:B,scale:v,offset:w.viewState.offset,edgeThreshold:F});Ag(D.shouldAutoScroll),D.shouldAutoScroll&&i.current===null?i.current=requestAnimationFrame(u):!D.shouldAutoScroll&&i.current!==null&&(cancelAnimationFrame(i.current),i.current=null)}else if(i.current===null){const B=sn.calculateMouseLeftWindowDelta({lastCoords:xn.getState().mousePosition??null,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight});B.shouldStartAutoScroll&&(c.current=B.scrollDelta,i.current=requestAnimationFrame(u))}const N=h.target;if(ka.isClickOnEditingElement(N)||ka.hasActiveTextSelection())return;const j=E.getState().viewLayer.getActiveId(),k=j?E.getState().viewLayer.getNodesWithEffectivePositions():w.coreState.nodes,S=j?k:k.map(B=>{const F=ts.get(B.id);return F?{...B,x:B.x+F.dx,y:B.y+F.dy}:B}),C=j?y:y.map(B=>{const F=ts.get(B.id);return F?{...B,x:B.x+F.dx,y:B.y+F.dy}:B}),R=sn.calculateNodeMoves({canvasDelta:b,draggedNodeId:f.draggedNodeId,selectedNodes:C,nodes:S,arrows:w.coreState.arrows||[],isCtrlPressed:ja.isCtrlPressed(h),isShiftPressed:h.shiftKey});if(R.shouldUpdate){if(j){const T=[],O=[];for(const _ of R.updatedSelectedNodes)_.type===de.GROUP?O.push({id:_.id,x:_.x,y:_.y}):T.push({id:_.id,x:_.x,y:_.y});const $=new Set(R.updatedSelectedNodes.map(_=>_.id));for(const _ of R.updatedNodes){if($.has(_.id)||_.type===de.GROUP)continue;const G=k.find(X=>X.id===_.id);G&&(G.x!==_.x||G.y!==_.y)&&T.push({id:_.id,x:_.x,y:_.y})}T.length>0&&E.getState().viewLayer.updateNodePositions(T);for(const _ of O)E.getState().viewLayer.updateGroupNode(j,_.id,{x:_.x,y:_.y});n(_=>({..._,selectedNodes:R.updatedSelectedNodes,arrows:R.updatedArrows}))}else for(const T of R.updatedSelectedNodes){const O=k.find($=>$.id===T.id);if(O){const $=T.x-O.x,_=T.y-O.y;ts.set(T.id,{dx:$,dy:_});const G=document.getElementById(`NodeContainerV2-${T.id}`);G&&(G.style.transform=`translate(${T.x}px, ${T.y}px)`)}}const B=il.calculateHoveredDropTarget({draggedNodes:R.updatedSelectedNodes,allNodes:R.updatedNodes,activeGroupId:E.getState().uiState.activeGroupId??null}),F=E.getState().uiState.hoveredDropTargetGroupId;B.hoveredGroupId!==F&&E.getState().setHoveredDropTargetGroupId(B.hoveredGroupId);const D=ll.calculateHoveredDropTarget({draggedNodes:R.updatedSelectedNodes,allNodes:R.updatedNodes}),L=E.getState().uiState.hoveredDropTargetVocabNodeId;D.hoveredVocabNodeId!==L&&E.getState().setHoveredDropTargetVocabNodeId(D.hoveredVocabNodeId);const A=R.updatedSelectedNodes.length===1?R.updatedSelectedNodes[0]:null;if(A){const T=document.querySelector("[data-canvas-container]"),O=T==null?void 0:T.getBoundingClientRect(),$=O?{x:h.clientX-O.left,y:h.clientY-O.top}:null,_=(w==null?void 0:w.viewState.scale)??1,G=(w==null?void 0:w.viewState.offset)??{x:0,y:0},X=$?{x:($.x-G.x)/_,y:($.y-G.y)/_}:null,J=cl.calculateTableDropTarget({droppedNode:A,allNodes:R.updatedNodes,mousePosition:X??void 0}),P=E.getState().uiState.tableDropTarget,z=J.targetTableId&&J.columnKey?{tableId:J.targetTableId,columnKey:J.columnKey,rowId:J.rowId,rowIndex:J.rowIndex}:null;((P==null?void 0:P.tableId)!==(z==null?void 0:z.tableId)||(P==null?void 0:P.columnKey)!==(z==null?void 0:z.columnKey)||(P==null?void 0:P.rowId)!==(z==null?void 0:z.rowId))&&E.getState().setTableDropTarget(z)}else E.getState().uiState.tableDropTarget&&E.getState().setTableDropTarget(null)}},[r,n,u,a])},Ug=()=>{const e=E.getState(),s=H(o=>o.uiState.dragInfo),n=e.setDragInfo;return p.useCallback(o=>{var r,a,i;if(s){Nt.log("Node Drag End (Pointer Up on):",s.draggedNodeId);const c=E.getState().projectCanvas.getActive(),l=(c==null?void 0:c.coreState.nodes)??[],d=l.find(h=>h.id===s.draggedNodeId);if(d){const f=E.getState().viewLayer.getActiveId()?E.getState().viewLayer.getNodesWithEffectivePositions():l,g=f.find(j=>j.id===d.id)??d,y=document.querySelector("[data-canvas-container]"),m=y==null?void 0:y.getBoundingClientRect(),x=(c==null?void 0:c.viewState.scale)??1,w=(c==null?void 0:c.viewState.offset)??{x:0,y:0},v=m?{x:o.clientX-m.left,y:o.clientY-m.top}:null,b=v?{x:(v.x-w.x)/x,y:(v.y-w.y)/x}:null,N=cl.calculateTableDropTarget({droppedNode:g,allNodes:f,mousePosition:b??void 0});if(N.targetTableId&&N.columnKey){const j=gn.extractNodeContent(d);let k=!1;if(N.rowId!==null?(k=E.getState().table.updateCellFromDrop(N.targetTableId,N.rowId,N.columnKey,j),k&&Nt.log(`Updated cell in table ${N.targetTableId}, row: ${N.rowId}, column: ${N.columnKey}`)):(k=E.getState().table.addRowFromDrop(N.targetTableId,N.columnKey,j),k&&Nt.log(`Dropped node ${d.id} onto table ${N.targetTableId}, column: ${N.columnKey}`)),k){let S=se.canvasTable.dropBehavior;try{const C=localStorage.getItem("watcher-table-node-drop-config");C&&(S=JSON.parse(C).dropBehavior)}catch{}S==="delete"?(E.getState().deleteNodeById(d.id),E.getState().setSelectedNodes([])):S==="copy"&&s.initialNodePosition&&E.getState().updateNode(d.id,{x:s.initialNodePosition.x,y:s.initialNodePosition.y}),E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),n(null);return}}}const u=E.getState().uiState.hoveredDropTargetVocabNodeId;if(u&&d){const h=(c==null?void 0:c.coreState.selectedNodes)??[],f=h.length>0?h:[d],g=l.find(y=>y.id===u);if(g){const y=ll.calculateDropResult({droppedNodes:f,targetVocabNode:g});if(y.hasChanges){const m=g.data??{};E.getState().updateNode(u,{data:{...m,sourceWord:y.sourceWord,translationWord:y.translationWord}});for(const x of y.nodeIdsToDelete)E.getState().deleteNodeById(x);E.getState().setSelectedNodes([]),Nt.log(`Dropped nodes onto vocab node ${u}: source="${y.sourceWord}", translation="${y.translationWord}"`),E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),E.getState().setTableDropTarget(null),n(null);return}}}if(d){const h=(c==null?void 0:c.coreState.selectedNodes)??[],f=h.length>0?h:[d],g=il.calculateDropResult({droppedNodes:f,allNodes:l,activeGroupId:E.getState().uiState.activeGroupId??null});if(g.hasChanges){for(const[y,m]of g.nodesToAddToGroups)Nt.log(`Adding nodes ${m.join(", ")} to group ${y}`),E.getState().group.addNodesToGroup(y,m);g.nodesToRemoveFromGroups.length>0&&(Nt.log(`Removing nodes ${g.nodesToRemoveFromGroups.join(", ")} from their groups`),E.getState().group.removeNodesFromGroup(g.nodesToRemoveFromGroups))}}if(E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),E.getState().setTableDropTarget(null),ts.size>0){const h=((r=E.getState().projectCanvas.getActive())==null?void 0:r.coreState.nodes)??[],f=((a=E.getState().projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],g=h.map(m=>{const x=ts.get(m.id);return x?{...m,x:m.x+x.dx,y:m.y+x.dy}:m}),y=f.map(m=>{const x=ts.get(m.id);return x?{...m,x:m.x+x.dx,y:m.y+x.dy}:m});E.getState().setActiveCanvasCoreState(m=>({...m,nodes:g,selectedNodes:y})),ts.clear()}if(s.initialPositions){const h=((i=E.getState().projectCanvas.getActive())==null?void 0:i.coreState.nodes)??[],f=[];for(const[g,y]of Object.entries(s.initialPositions)){const m=h.find(x=>x.id===g);m&&(m.x!==y.x||m.y!==y.y)&&f.push({nodeId:g,from:y,to:{x:m.x,y:m.y}})}if(f.length>0){const g=hd(f);E.getState().undo.commit(g),Nt.log("Committed move operation for",f.length,"nodes")}}n(null)}},[s,n])},Ia=new Map,_n=20,Jt=(e,s)=>{const n=E.getState(),o=n.uiState.mode,r=n.setResizingNode;return p.useCallback(a=>{if(o!==Q.SELECT||a.button!==0&&a.button!==-1)return;a.stopPropagation();const i=n.projectCanvas.getActive(),c=(i==null?void 0:i.viewState.scale)??1,l=(i==null?void 0:i.viewState.offset)??{x:0,y:0},d={x:a.clientX,y:a.clientY},u=xt(d,c,l),h=i==null?void 0:i.coreState.nodes.find(g=>g.id===e.id),f={x:(h==null?void 0:h.x)??e.x,y:(h==null?void 0:h.y)??e.y,width:(h==null?void 0:h.width)??e.width??100,height:(h==null?void 0:h.height)??e.height??50};r({id:e.id,handle:s,startNodeRect:f,startPointerPos:u})},[e,s,o,r])},Vg=()=>{var n;const e=E.getState(),s=(n=e.uiState)==null?void 0:n.resizingNode;return p.useCallback(o=>{if(!s)return;const{id:r,handle:a,startNodeRect:i,startPointerPos:c}=s,l=e.projectCanvas.getActive(),d=(l==null?void 0:l.viewState.scale)??1,u=(l==null?void 0:l.viewState.offset)??{x:0,y:0},h={x:o.clientX,y:o.clientY},f=xt(h,d,u),g=f.x-c.x,y=f.y-c.y;let m=i.x,x=i.y,w=i.width,v=i.height;a.includes("left")&&(w=Math.round(Math.max(_n,i.width-g)),m=i.x+i.width-w),a.includes("right")&&(w=Math.round(Math.max(_n,i.width+g))),a.includes("top")&&(v=Math.round(Math.max(_n,i.height-y)),x=i.y+i.height-v),a.includes("bottom")&&(v=Math.round(Math.max(_n,i.height+y))),Ia.set(r,{x:m,y:x,width:w,height:v});const b=document.getElementById(`NodeContainerV2-${r}`);if(b){b.style.transform=`translate(${m}px, ${x}px)`,b.style.width=`${w}px`,b.style.height=`${v}px`;const N=b.querySelector('[data-test="draw-node-svg"]');N&&(N.style.width=`${w}px`,N.style.height=`${v}px`)}},[s,e])};function Gg(e,s){const n=e.x+(e.width??100),o=e.y+(e.height??50),r=s.x+s.width,a=s.y+s.height;return e.x>=s.x&&e.y>=s.y&&n<=r&&o<=a}const Yg=()=>{var r;const e=E.getState(),s=(r=e.uiState)==null?void 0:r.resizingNode,n=e.setResizingNode,o=e.updateNode;return p.useCallback(a=>{var i;if(s){const{id:c,handle:l,startNodeRect:d}=s,u=Ia.get(c),h=l.includes("top")||l.includes("bottom"),f=l.includes("left")||l.includes("right"),g=e.projectCanvas.getActive(),y=g==null?void 0:g.coreState.nodes.find(m=>m.id===c);if(u)if(h)o(c,{x:u.x,y:u.y,width:u.width,height:u.height,options:{lockSize:!0}});else if(f){const m=((i=y==null?void 0:y.data)==null?void 0:i.nodeType)==="workflowOrchestration";if(y&&y.content&&!m){const x=ct(y.content,{containerWidth:u.width})+pe.NODE_Y_PADDING*2;o(c,{x:u.x,y:u.y,width:u.width,height:x,options:{lockSize:!0}})}else o(c,{x:u.x,y:u.y,width:u.width,height:u.height})}else o(c,{x:u.x,y:u.y,width:u.width,height:u.height});if(y&&y.type===de.GROUP&&se.groups.autoAddNodesOnExpand){const m=y.data,x=new Set((m==null?void 0:m.childNodeIds)??[]),w=(g==null?void 0:g.coreState.nodes)??[],v=u??{x:y.x,y:y.y,width:y.width??100,height:y.height??50},b=w.filter(N=>N.id===c||N.type===de.GROUP||x.has(N.id)||N.groupId&&N.groupId!==c?!1:Gg(N,v));if(b.length>0){const N=b.map(j=>j.id);e.group.addNodesToGroup(c,N)}}if(u&&(u.x!==d.x||u.y!==d.y||u.width!==d.width||u.height!==d.height)){const x={type:"node:resize",nodeId:c,from:d,to:u};E.getState().undo.commit(x)}Ia.delete(c),n(null)}},[s,n,o,e])};class dl{}Oe(dl,"arrows",{canDrawArrow:s=>s.length<=1});const Kg=30,bo=(e,s)=>{const n=document.elementsFromPoint(e,s);for(const a of n){const i=a.getAttribute("data-row-connector"),c=a.getAttribute("data-node-id");if(i&&c)return{nodeId:c,rowId:i}}const o=document.querySelectorAll("[data-row-connector]");let r=null;return o.forEach(a=>{const i=a.getBoundingClientRect(),c=i.left+i.width/2,l=i.top+i.height/2,d=Math.sqrt(Math.pow(e-c,2)+Math.pow(s-l,2));if(d<=Kg){const u=a.getAttribute("data-row-connector")??"",h=a.getAttribute("data-node-id")??"";u&&h&&(!r||d<r.distance)&&(r={nodeId:h,rowId:u,distance:d})}}),r},Xg=se.arrows.reverseArrowOnMultipleConnect,Qe=new xs("useArrowDrawingV2",ws.useArrowDrawingV2),qg=()=>{const e=E.getState(),s=e.uiState.mode,n=e.projectCanvas.getActive(),o=e.arrow.setTemporary,r=e.getCanvasMouseCoords,a=(n==null?void 0:n.coreState.nodes)??[];return p.useCallback(i=>{if(s!==Q.DRAW_ARROW)return;Qe.log("Fired in DRAW_ARROW mode.");const c=r();if(!c){Qe.log("No start point found.");return}const l=E.getState().uiState.activeGroupId,u=io(c,a,l?[l]:void 0),h=(u==null?void 0:u.id)??null;h?Qe.log(`Starting arrow draw from within node: ${h}`):Qe.log("Starting arrow draw from background."),Qe.log("Setting temporary arrow at",c,"with startNodeId:",h),o({startPoint:c,endPoint:c,startNodeId:h}),i.stopPropagation()},[s,r,o,a])},Zg=()=>{const e=E.getState(),s=e.uiState.mode,n=e.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.nodes)??[],r=e.arrow.setTemporary,a=e.uiState.temporaryArrow,i=e.getCanvasMouseCoords;return p.useCallback(c=>{if(s!==Q.DRAW_ARROW||!a)return;let l=i();if(!l)return;const d=bo(c.clientX,c.clientY);d&&(l=et(d.nodeId,l,a.startPoint,o,d.rowId)),r({...a,endPoint:l}),c.stopPropagation()},[s,a,i,r,o])},zn=(e,s)=>{const n=E.getState(),o=n.setMode,r=n.arrow.setTemporary,a=n.uiState.mode;return p.useCallback(i=>{if(a!==Q.SELECT)return;Qe.log(`useQuickArrowHandleMouseDownHandler: Fired on node ${e.id}, handle ${s}.`),i.stopPropagation();const c=e.width??100,l=e.height??50;let d;switch(s){case"top":d={x:e.x+c/2,y:e.y};break;case"bottom":d={x:e.x+c/2,y:e.y+l};break;case"left":d={x:e.x,y:e.y+l/2};break;case"right":d={x:e.x+c,y:e.y+l/2};break}Qe.log("Switching to DRAW_ARROW mode."),o(Q.DRAW_ARROW),Qe.log("Setting temporary arrow from node",e.id),r({startPoint:d,endPoint:d,startNodeId:e.id})},[e,s,r,o,a])},Jg=()=>{const e=E.getState(),s=e.uiState.mode,n=e.projectCanvas.getActive(),o=e.arrow.setTemporary,r=e.arrow.add,a=e.uiState.temporaryArrow,i=e.setMode,c=(n==null?void 0:n.coreState.nodes)??[],l=(n==null?void 0:n.coreState.selectedNodes)??[],d=e.getCanvasMouseCoords;return p.useCallback(u=>{var S;if(s!==Q.DRAW_ARROW||!a)return;Qe.log("useArrowMouseUpHandler: Fired.");const h=d();if(!h){Qe.log("No final mouse coords found, resetting."),k();return}const{startPoint:f,startNodeId:g}=a,y=c.find(C=>C.id===g);let m=null,x=null,w=h;const v=E.getState().uiState.activeGroupId,b=v?[v]:void 0,N=bo(u.clientX,u.clientY);if(N)m=N.nodeId,x=N.rowId,Qe.log("Row connector found:",N);else{const C=io(h,c,b);C&&(((S=C.data)==null?void 0:S.nodeType)==="workflowOrchestration"||(m=C.id)),Qe.log("Target node found:",(C==null?void 0:C.id)??"None")}if(l.forEach(C=>{if(m&&m!==C.id)if(w=et(m,h,f,c,x),Xg&&l.length>1){Qe.log(`Creating arrow from target node ${m} to selected node ${C.id}`);const I={id:Re(10),startPoint:w,endPoint:f,startNodeId:m,endNodeId:C.id??null,startRowId:x,label:""};r(I)}else{Qe.log(`Creating arrow from selected node ${C.id} to target node ${m}`);const I={id:Re(10),startPoint:f,endPoint:w,startNodeId:C.id??null,endNodeId:m,endRowId:x,label:""};r(I)}}),l.length===0&&!m){Qe.log("Creating naked arrow.");const C={id:Re(10),startPoint:f,endPoint:w,startNodeId:g??null,endNodeId:null,label:""};r(C)}if(m&&m!==(y==null?void 0:y.id)&&l.length===0){w=et(m,h,f,c,x),Qe.log(`Creating arrow from selected node ${y==null?void 0:y.id} to target node ${m}`);const C={id:Re(10),startPoint:f,endPoint:w,startNodeId:(y==null?void 0:y.id)??null,endNodeId:m,endRowId:x,label:""};dl.arrows.canDrawArrow(l)&&r(C)}k();function k(){Qe.log("Resetting state."),o(null),E.getState().uiState.arrowSubMode!==ro.STAY&&i(Q.SELECT),u.stopPropagation()}},[s,a,r,o,i,c,l,d])};let oo=null;const nr=()=>oo,ul=()=>{const e=p.useRef(null),s=p.useRef([]),n=p.useRef(null),o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),i=p.useRef(!1),c=H(u=>u.uiState.canvasWidth??0),l=H(u=>u.uiState.canvasHeight??0),d=H(u=>u.uiState.mode);return p.useEffect(()=>{const u=e.current;if(!u)return;const h=u.getBoundingClientRect();if(h.width===0||h.height===0)return;const f=window.devicePixelRatio||1;u.width=h.width*f,u.height=h.height*f;const g=u.getContext("2d");g&&g.scale(f,f)},[c,l,d]),p.useEffect(()=>{const u=e.current;if(!u){oo=null;return}const h=()=>{const m=E.getState().projectCanvas.getActive();return(m==null?void 0:m.viewState)??{offset:{x:0,y:0},scale:1}},f=(m,x)=>{const w=u.getBoundingClientRect();return{x:m-w.left,y:x-w.top}},g=m=>{if(!a.current||s.current.length<2)return;const{scale:x}=h(),w=window.devicePixelRatio||1;m.clearRect(0,0,u.width/w,u.height/w);const v=(a.current.opacity??1)<1;m.beginPath(),m.strokeStyle=a.current.strokeColor,m.lineWidth=a.current.strokeWidth*x,m.globalAlpha=a.current.opacity??1,m.lineCap=v?"butt":"round",m.lineJoin=v?"bevel":"round";const b=s.current;m.moveTo(b[0].x,b[0].y);for(let N=1;N<b.length;N++)m.lineTo(b[N].x,b[N].y);m.stroke(),m.globalAlpha=1},y=m=>{if(!a.current||s.current.length<2)return;const{scale:x}=h(),w=s.current,v=w[w.length-2],b=w[w.length-1];m.beginPath(),m.strokeStyle=a.current.strokeColor,m.lineWidth=a.current.strokeWidth*x,m.globalAlpha=a.current.opacity??1,m.lineCap="round",m.lineJoin="round",m.moveTo(v.x,v.y),m.lineTo(b.x,b.y),m.stroke(),m.globalAlpha=1};return oo={startStroke:(m,x,w)=>{const v=u==null?void 0:u.getContext("2d");if(!v||!u)return;const b=window.devicePixelRatio||1;v.clearRect(0,0,u.width/b,u.height/b),a.current=w;const N=f(m,x);s.current=[N],n.current=N,o.current=N,r.current=N,i.current=!0},addPoint:(m,x)=>{var R;if(!i.current||!o.current||!r.current)return;const w=u==null?void 0:u.getContext("2d");if(!w)return;let v=f(m,x);const b=(((R=a.current)==null?void 0:R.opacity)??1)<1;if(b){const I=E.getState().getDrawAxisLock();I==="horizontal"?v={x:v.x,y:r.current.y}:I==="vertical"&&(v={x:r.current.x,y:v.y})}const N=se.drawing.minPointDistance,j=v,k=j.x-o.current.x,S=j.y-o.current.y;Math.sqrt(k*k+S*S)>=N&&(s.current.push({...j}),o.current=j,b?g(w):y(w))},endStroke:()=>{if(!i.current)return null;const m=u==null?void 0:u.getContext("2d");if(m&&u){const b=window.devicePixelRatio||1;m.clearRect(0,0,u.width/b,u.height/b)}const{offset:x,scale:w}=h(),v=s.current.map(b=>({x:(b.x-x.x)/w,y:(b.y-x.y)/w}));return s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1,v.length>1?v:null},clear:()=>{const m=u==null?void 0:u.getContext("2d");if(m&&u){const x=window.devicePixelRatio||1;m.clearRect(0,0,u.width/x,u.height/x)}s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1}},()=>{oo=null}},[d]),d!==Q.DRAW?null:t.jsx("canvas",{ref:e,"data-test":"temporary-drawing-canvas","data-temporary-drawing-canvas":!0,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",touchAction:"none",zIndex:9999}})};ul.displayName="TemporaryDrawingCanvas";const ft=new xs("useDrawingV2",ws.useDrawingV2);let fn=null,Is=null,No=null,Ts=null,So=[],Co=!1,jo=0;const Qg=3;let oa=null,_r=null,aa=null,zr=null;const Vs=new Map,hl=()=>{Co||(Ts=document.querySelector("[data-temporary-drawing-canvas]"),So=Array.from(document.querySelectorAll(".markdown-textarea")),So.forEach(e=>{const s=e;Vs.has(e)||Vs.set(e,s.getAttribute("contenteditable")||""),s.style.setProperty("pointer-events","auto","important"),s.style.setProperty("user-select","text","important"),s.setAttribute("contenteditable","true"),s.setAttribute("inputmode","none")}),Co=!0,jo=0)},ef=()=>{So.forEach(e=>{const s=e;s.style.removeProperty("pointer-events"),s.style.removeProperty("user-select")}),Ts=null,So=[],Co=!1,jo=0},tf=(e,s)=>{var o,r,a,i,c;if(jo++,jo%Qg!==1)return;Co||hl(),Ts&&(Ts.style.visibility="hidden");let n=null;if(typeof document.caretRangeFromPoint=="function")n=document.caretRangeFromPoint(e,s);else{const l=(o=document.caretPositionFromPoint)==null?void 0:o.call(document,e,s);l!=null&&l.offsetNode&&(n=document.createRange(),n.setStart(l.offsetNode,l.offset),n.setEnd(l.offsetNode,l.offset))}if(Tt.clientLogsApiClient.sendLogs("0_trySelect",{screenX:e,screenY:s,rangeFound:!!n,isTextNode:(n==null?void 0:n.startContainer.nodeType)===Node.TEXT_NODE,textContent:(r=n==null?void 0:n.startContainer.textContent)==null?void 0:r.substring(0,20)},"marker-debug.log"),n&&n.startContainer.nodeType===Node.TEXT_NODE){const l=n.startContainer.parentElement;if((l==null?void 0:l.closest("[data-node-id]"))!==null){const u=window.getSelection();if(u)if(fn){const h=fn.screenX,f=fn.screenY,g=Ta(h,f);if(!g){Tt.clientLogsApiClient.sendLogs("0b_anchor_lost",{anchorScreenX:h,anchorScreenY:f},"marker-debug.log");return}try{const y=document.createRange(),m=g.node,x=g.offset,w=n.startContainer,v=n.startOffset,b=m.compareDocumentPosition(w),N=m===w,j=N?x<=v:!(b&Node.DOCUMENT_POSITION_PRECEDING);j?(y.setStart(m,x),y.setEnd(w,v)):(y.setStart(w,v),y.setEnd(m,x)),u.removeAllRanges(),u.addRange(y),Tt.clientLogsApiClient.sendLogs("0b_selection_extended",{screenX:e,screenY:s,anchorNodeText:(i=m.textContent)==null?void 0:i.substring(0,20),anchorOffset:x,focusNodeText:(c=w.textContent)==null?void 0:c.substring(0,20),focusOffset:v,sameNode:N,anchorBeforeFocus:j,rangeText:y.toString().substring(0,50),currentSelection:u.toString().substring(0,50)},"marker-debug.log")}catch(y){Tt.clientLogsApiClient.sendLogs("0b_selection_error",{error:String(y)},"marker-debug.log")}}else{fn={node:n.startContainer,offset:n.startOffset,screenX:e,screenY:s},u.removeAllRanges();const h=document.createRange();h.setStart(n.startContainer,n.startOffset),h.setEnd(n.startContainer,n.startOffset),u.addRange(h),Tt.clientLogsApiClient.sendLogs("0a_anchor_set",{screenX:e,screenY:s,anchorText:(a=n.startContainer.textContent)==null?void 0:a.substring(0,30),anchorOffset:n.startOffset},"marker-debug.log")}}}Ts&&(Ts.style.visibility="")},pl=()=>{fn=null,Is=null,No=null,ef(),Vs.forEach((e,s)=>{const n=s;e?n.setAttribute("contenteditable",e):n.removeAttribute("contenteditable"),n.removeAttribute("inputmode")}),Vs.clear()},Ta=(e,s)=>{const n=typeof document.caretRangeFromPoint=="function",o=typeof document.caretPositionFromPoint=="function";if(n){const r=document.caretRangeFromPoint(e,s);if(r&&r.startContainer.nodeType===Node.TEXT_NODE)return{node:r.startContainer,offset:r.startOffset}}else if(o){const r=document.caretPositionFromPoint(e,s);if(r!=null&&r.offsetNode&&r.offsetNode.nodeType===Node.TEXT_NODE)return{node:r.offsetNode,offset:r.offset}}return null},sf=(e,s,n,o)=>{var d,u;const r=document.querySelector("[data-temporary-drawing-canvas]"),a=r==null?void 0:r.style.visibility;r&&(r.style.visibility="hidden"),document.querySelectorAll(".markdown-textarea").forEach(h=>{const f=h;Vs.has(h)||Vs.set(h,f.getAttribute("contenteditable")||""),f.setAttribute("contenteditable","true"),f.setAttribute("inputmode","none")});const c=Ta(e,s),l=Ta(n,o);if(Tt.clientLogsApiClient.sendLogs("0_selectTextBetweenPoints",{startX:e,startY:s,endX:n,endY:o,startCaretFound:!!c,endCaretFound:!!l,startCaretText:(d=c==null?void 0:c.node.textContent)==null?void 0:d.substring(0,20),endCaretText:(u=l==null?void 0:l.node.textContent)==null?void 0:u.substring(0,20)},"marker-debug.log"),r&&(r.style.visibility=a||""),c&&l){const h=window.getSelection();if(h){h.removeAllRanges();const f=document.createRange(),g=c.node.compareDocumentPosition(l.node);(c.node===l.node?c.offset<=l.offset:!(g&Node.DOCUMENT_POSITION_PRECEDING))?(f.setStart(c.node,c.offset),f.setEnd(l.node,l.offset)):(f.setStart(l.node,l.offset),f.setEnd(c.node,c.offset)),h.addRange(f)}}},nf=(e,s)=>{var R,I,M;const n=window.getSelection();if(!n||n.isCollapsed){Tt.clientLogsApiClient.sendLogs("1_no_selection",{isCollapsed:n==null?void 0:n.isCollapsed},"marker-debug.log");return}const o=n.toString().trim();if(!o){Tt.clientLogsApiClient.sendLogs("2_empty_selection",{},"marker-debug.log");return}const r=((R=n.anchorNode)==null?void 0:R.nodeType)===Node.TEXT_NODE?n.anchorNode.parentElement:n.anchorNode,a=((I=n.focusNode)==null?void 0:I.nodeType)===Node.TEXT_NODE?n.focusNode.parentElement:n.focusNode,i=(r==null?void 0:r.closest("[data-node-id]"))??(a==null?void 0:a.closest("[data-node-id]"));if(!i){Tt.clientLogsApiClient.sendLogs("3_no_source_element",{},"marker-debug.log");return}const c=i.getAttribute("data-node-id");if(!c){Tt.clientLogsApiClient.sendLogs("4_no_source_id",{},"marker-debug.log");return}const l=E.getState(),d=l.getNodeById(c);if(!d){Tt.clientLogsApiClient.sendLogs("5_no_source_node",{sourceNodeId:c},"marker-debug.log");return}const u=gs(o),h=Le.buildTextNodeV2({content:o,width:u.width,height:u.height,linkedSourceNodeId:d.id,options:{lockSize:!1}});let f=d;if(e==="left"&&_r===d.id&&oa){const W=l.getNodeById(oa);W&&(f=W)}else if(e==="right"&&zr===d.id&&aa){const W=l.getNodeById(aa);W&&(f=W)}const g=(M=l.projectCanvas.getActive())==null?void 0:M.viewState,y=(g==null?void 0:g.offset)??{x:0,y:0},m=(g==null?void 0:g.scale)??1,x=document.querySelector("[data-canvas-container]"),w=x==null?void 0:x.getBoundingClientRect(),v=(w==null?void 0:w.top)??0,b=l.uiState.mousePosition,N=s-v,j=(N-y.y)/m;s-y.y,(s-y.y)/m,b&&b.y-y.y;const k=se.highlightAndCreate.createConnectingArrow,S=h.height??u.height,C=j-S/2;Tt.clientLogsApiClient.sendLogs("6_creating_node_from_marker",{selectedText:o.substring(0,50),side:e,sourceNodeId:d.id,sourceNodeY:d.y,screenY:s,containerTop:v,relativeY:N,canvasY:j,nodeHeight:S,centeredY:C,offset:y,scale:m,configCreateArrow:k},"marker-debug.log"),_o(h,{...f,y:C},e,{shouldFocus:!1,createArrow:k}),e==="left"?(oa=h.id,_r=d.id):(aa=h.id,zr=d.id)};let ra=null,ia=0;const of=e=>{const{level:s}=se.drawing.compression;return Kc(e,s)},af=e=>{const{level:s}=se.drawing.compression;return Yc(e,s)};let Yt=null,ko=!1;const rf=()=>{const e=E.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getDrawSubMode,r=e.getDrawStyle;return p.useCallback(a=>{if(a.pointerType==="pen"&&a.button===1&&(ko=!0),E.getState().uiState.mode!==Q.DRAW||a.button!==0&&a.button!==-1||a.buttons&4||a.pointerType==="pen"&&ko)return;a.preventDefault(),ft.log("Fired in DRAW mode.");const c=nr();if(a.pointerType==="touch"&&Yt!==null&&a.pointerId!==Yt){ft.log("Second touch detected, canceling drawing."),c==null||c.clear(),n(null),Yt=null;return}const l=s();if(!l){ft.log("No start point found.");return}const d=o(),u=r();ft.log(`Starting draw with sub-mode: ${d}, pointerId: ${a.pointerId}`),Yt=a.pointerId;const h=ze.createTemporaryDrawing(d,l,u);n(h),d===be.FREEHAND&&(ft.log(`canvasAPI available: ${!!c}`),c?(c.startStroke(a.clientX,a.clientY,u),pl(),Is=a.clientX,No=a.clientY,(u.opacity??1)<1&&hl()):ft.log("WARNING: canvasAPI is null in mouseDown!")),a.stopPropagation()},[s,n,o,r])},cf=()=>{const e=E.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getTemporaryDrawing;return p.useCallback(r=>{var c;if(E.getState().uiState.mode!==Q.DRAW)return;const i=o();if(i&&!(Yt!==null&&r.pointerId!==Yt)){if(i.subMode===be.FREEHAND){const l=nr();if(l){const d=((c=r.getCoalescedEvents)==null?void 0:c.call(r))??[r];for(const h of d)l.addPoint(h.clientX,h.clientY);(i.style.opacity??1)<1&&tf(r.clientX,r.clientY)}else ft.log("WARNING: canvasAPI is null in mouseMove!")}else{const l=s();if(!l)return;const d=ze.updateShapeEndPoint(i,l);n(d)}r.stopPropagation()}},[s,n,o])},lf=e=>e.elements&&e.elements.length>0?e.elements:e.drawType&&e.style?[{type:e.drawType,stroke:e.stroke,shape:e.shape,style:e.style}]:[],df=(e,s)=>{const n=Math.min(e.x,s.x),o=Math.min(e.y,s.y),r=Math.max(e.x+(e.width??0),s.x+s.width),a=Math.max(e.y+(e.height??0),s.y+s.height);return{x:n,y:o,width:r-n,height:a-o}},uf=(e,s,n)=>e.map(o=>({x:o.x+s,y:o.y+n})),hf=()=>{const e=E.getState(),s=e.addNode,n=e.updateNode,o=e.getNodeById,r=e.setTemporaryDrawing,a=e.getTemporaryDrawing,i=e.undo.commit;return p.useCallback(c=>{var I;if(c.pointerType==="pen"&&ko&&(c.buttons&4||(ko=!1)),E.getState().uiState.mode!==Q.DRAW)return;const d=a();if(!d||Yt!==null&&c.pointerId!==Yt)return;const u=Is!==null&&c.clientX<Is?"left":"right",h=window.getSelection(),f=(h==null?void 0:h.toString().trim())||"";Is!==null&&No!==null&&f.length===0&&sf(Is,No,c.clientX,c.clientY),nf(u,c.clientY),(I=window.getSelection())==null||I.removeAllRanges(),pl(),ft.log("useDrawMouseUpHandler: Fired.");const g=nr(),y=(g==null?void 0:g.endStroke())??null;if(d.subMode===be.FREEHAND&&(!y||y.length<2)){ft.log("Freehand drawing too short, discarding."),R();return}const x={[be.RECTANGLE]:"rectangle",[be.SQUARE]:"square",[be.CIRCLE]:"circle",[be.ELLIPSE]:"ellipse",[be.LINE]:"line",[be.ARROW]:"arrow",[be.FREEHAND]:"line"}[d.subMode],w=d.subMode===be.FREEHAND?ze.calculateFreehandBounds(y):ze.calculateShapeBounds(d.startPoint,d.endPoint,x),v=d.style.strokeWidth??2,b={x:w.x-v,y:w.y-v,width:w.width+v*2,height:w.height+v*2};if(d.subMode!==be.FREEHAND&&!ze.canFinalizeDraw(d)){ft.log("Shape too small or invalid, discarding."),R();return}const N=Date.now(),j=se.drawing.strokeGroupingTimeoutMs,k=ra?o(ra):void 0;if(N-ia<j&&k&&k.type===de.DRAWING&&k){ft.log("Grouping with existing node:",k.id);const M=k.data,W=lf(M),B=df(k,b),F=k.x-B.x,D=k.y-B.y,L=W.map(G=>{if(G.type==="freehand"&&G.stroke){const X=uf(G.stroke.points,F,D),J=ap(G.stroke.smoothedPath,F,D);return{...G,stroke:{points:X,smoothedPath:J}}}return G.type==="shape"&&G.shape?{...G,shape:{...G.shape,startPoint:{x:G.shape.startPoint.x+F,y:G.shape.startPoint.y+D},endPoint:{x:G.shape.endPoint.x+F,y:G.shape.endPoint.y+D}}}:G}),A=Ur(d,b,B,y),T=af(A),O={elements:[...L,T],intrinsicWidth:B.width,intrinsicHeight:B.height},$={x:k.x,y:k.y,width:k.width,height:k.height,data:M},_={x:B.x,y:B.y,width:B.width,height:B.height,data:O};n(k.id,_),i({type:"node:update",nodeId:k.id,from:$,to:_}),ia=N,ft.log("Merged into node:",k.id)}else{const M=Ur(d,b,b,y),W=of({elements:[M],intrinsicWidth:b.width,intrinsicHeight:b.height}),B={id:Re(10),x:b.x,y:b.y,width:b.width,height:b.height,type:de.DRAWING,data:W,content:""};s(B,void 0,{dontSelect:!0}),ra=B.id,ia=N,ft.log("Created DRAWING node:",B.id)}R();function R(){ft.log("Resetting temporary drawing state."),r(null),Yt=null,c.stopPropagation()}},[s,n,o,r,a,i])};function Ur(e,s,n,o=null){if(s.x-n.x,s.y-n.y,e.subMode===be.FREEHAND){const d=(o??e.points).map(h=>({x:h.x-n.x,y:h.y-n.y})),u=ze.smoothToSVGPath(d);return{type:"freehand",stroke:{points:d,smoothedPath:u},style:e.style}}const r=e.startPoint,a=e.endPoint;return{type:"shape",shape:{shapeType:{[be.RECTANGLE]:"rectangle",[be.SQUARE]:"square",[be.CIRCLE]:"circle",[be.ELLIPSE]:"ellipse",[be.LINE]:"line",[be.ARROW]:"arrow",[be.FREEHAND]:"line"}[e.subMode],startPoint:{x:r.x-n.x,y:r.y-n.y},endPoint:{x:a.x-n.x,y:a.y-n.y}},style:e.style}}const Vr=(e,s)=>{const n=e.clientX-s.clientX,o=e.clientY-s.clientY;return Math.sqrt(n*n+o*o)},Gr=(e,s)=>({x:(e.clientX+s.clientX)/2,y:(e.clientY+s.clientY)/2}),pf=()=>{const e=E.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=e.setIsPanning,r=e.setSelectionBox,a=e.setPendingSelectionStart,i=p.useRef(null),c=20,l=p.useRef(null),d=p.useCallback(f=>{const g=s();if(!g)return;const y=E.getState().uiState.mode;if(f.touches.length===1){if(y===Q.DRAW||y===Q.SELECT){l.current=null;return}const m=f.touches[0],x=f.target,w=x.closest("[data-node-id]"),v=x.id.includes("resize-handle-"),b=x.closest("[data-ui-panel]");if(w||v||b){l.current=null;return}l.current={startX:m.clientX,startY:m.clientY,initialOffsetX:g.viewState.offset.x,initialOffsetY:g.viewState.offset.y},o(!0),i.current=null}else if(f.touches.length===2){r(null),a(null);const m=f.touches[0],x=f.touches[1];i.current={initialDistance:Vr(m,x),initialScale:g.viewState.scale,initialOffsetX:g.viewState.offset.x,initialOffsetY:g.viewState.offset.y,center:Gr(m,x),gestureType:"undetermined"},l.current=null,o(!1)}else i.current=null,l.current=null,o(!1)},[s,o,r,a]),u=p.useCallback(f=>{const g=s();if(g){if(f.touches.length===1&&l.current){f.preventDefault();const y=f.touches[0],m=y.clientX-l.current.startX,x=y.clientY-l.current.startY;n(w=>({...w,offset:{x:l.current.initialOffsetX+m,y:l.current.initialOffsetY+x}}))}else if(f.touches.length===2&&i.current){f.preventDefault();const{scale:y,offset:m}=g.viewState,x=f.touches[0],w=f.touches[1],v=Vr(x,w),b=Gr(x,w),N=Math.abs(v-i.current.initialDistance);if(i.current.gestureType==="undetermined")if(N>c)i.current.gestureType="zoom";else{const j=Math.abs(b.x-i.current.center.x),k=Math.abs(b.y-i.current.center.y);(j>c||k>c)&&(i.current.gestureType="pan",o(!0))}if(i.current.gestureType==="zoom"){const j=v/i.current.initialDistance;let k=i.current.initialScale*j;const{min:S,max:C}=se.zoom;k=Math.max(S,Math.min(C,k)),k<=.1?k=Math.round(k*100)/100:k=Math.round(k*10)/10;const R=xt(i.current.center,y,m),I=i.current.center.x-R.x*k,M=i.current.center.y-R.y*k;n(W=>({...W,scale:k,offset:{x:I,y:M}}))}else if(i.current.gestureType==="pan"){const j=b.x-i.current.center.x,k=b.y-i.current.center.y;n(S=>({...S,offset:{x:i.current.initialOffsetX+j,y:i.current.initialOffsetY+k}}))}}}},[s,n,o]),h=p.useCallback(f=>{const g=E.getState().uiState.mode;if(f.touches.length===0)i.current=null,l.current=null,o(!1);else if(f.touches.length===1){if(i.current=null,g===Q.DRAW||g===Q.SELECT){l.current=null,o(!1);return}if(!l.current){const y=E.getState().projectCanvas.getActive();if(y){const m=f.touches[0];l.current={startX:m.clientX,startY:m.clientY,initialOffsetX:y.viewState.offset.x,initialOffsetY:y.viewState.offset.y},o(!0)}}}else f.touches.length>=2&&(l.current=null,o(!1))},[o]);return{handleTouchStart:d,handleTouchMove:u,handleTouchEnd:h}},Ao=new Map;let gl={targetScreenYRatio:.8,animationDuration:300,stabilizationDelay:10,minKeyboardHeight:100,listenerTimeout:2e3};function fl(e){var u;const{nodeId:s,nodeY:n,source:o}=e,r=gl,a=document.querySelector(`[data-node-id="${s}"]`);a==null||a.getBoundingClientRect().top;let i=0,c=null;const l=()=>{var y;const h=window.innerHeight,f=((y=window.visualViewport)==null?void 0:y.height)||window.innerHeight,g=h-f;if(g>r.minKeyboardHeight&&g!==i){i=g,c&&clearTimeout(c),c=setTimeout(()=>{var m;(m=window.visualViewport)==null||m.removeEventListener("resize",l),d()},r.stabilizationDelay);return}},d=()=>{var j;const h=((j=window.visualViewport)==null?void 0:j.height)||window.innerHeight,f=E.getState(),g=f.projectCanvas.getActive(),y=(g==null?void 0:g.viewState.offset)||{x:0,y:0},m=(g==null?void 0:g.viewState.scale)||1,x=document.querySelector(`[data-node-id="${s}"]`),w=x==null?void 0:x.getBoundingClientRect(),v=(w==null?void 0:w.top)??n*m+y.y,N=h*r.targetScreenYRatio-v;f.setActiveCanvasViewState(k=>({...k,targetView:{targetOffset:{x:y.x,y:y.y+N},targetScale:m,animationStartTime:0,animationDuration:r.animationDuration}})),Ao.set(s,N)};(u=window.visualViewport)==null||u.addEventListener("resize",l),setTimeout(()=>{var h;(h=window.visualViewport)==null||h.removeEventListener("resize",l),c&&clearTimeout(c)},r.listenerTimeout)}function gf(e){var i,c;const s=gl,n=Ao.get(e);if(!n)return;Ao.delete(e);let o=window.innerHeight-(((i=window.visualViewport)==null?void 0:i.height)||window.innerHeight),r=null;const a=()=>{var h;const l=window.innerHeight,d=((h=window.visualViewport)==null?void 0:h.height)||window.innerHeight,u=l-d;u!==o&&(o=u,r&&clearTimeout(r),r=setTimeout(()=>{var f;if(u<s.minKeyboardHeight){(f=window.visualViewport)==null||f.removeEventListener("resize",a);const g=E.getState(),y=g.projectCanvas.getActive(),{scale:m,offset:x}=(y==null?void 0:y.viewState)||{scale:1,offset:{x:0,y:0}};g.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:{x:x.x,y:x.y-n},targetScale:m,animationStartTime:0,animationDuration:s.animationDuration}}))}},s.stabilizationDelay))};(c=window.visualViewport)==null||c.addEventListener("resize",a),setTimeout(()=>{var l;(l=window.visualViewport)==null||l.removeEventListener("resize",a),r&&clearTimeout(r)},s.listenerTimeout)}function ml(e){var n;const s=((n=window.visualViewport)==null?void 0:n.height)||window.innerHeight;return e>s/2}const ff=300,mf=30,xf=()=>{const e=p.useRef(null),s=er();return p.useCallback(n=>{const o=E.getState(),r=o.uiState.mode;o.getCanvasMouseCoords;const a=o.addNode,i=o.setNodeToFocusId;if(r!==Q.SELECT){e.current=null;return}if(n.target.closest("[data-node-id], [data-arrow-id]")){e.current=null;return}if(n.touches.length===0&&n.changedTouches.length>0){const d=n.changedTouches[0],u={timestamp:Date.now(),x:d.clientX,y:d.clientY};if(e.current){const h=u.timestamp-e.current.timestamp,f=Math.sqrt(Math.pow(u.x-e.current.x,2)+Math.pow(u.y-e.current.y,2));if(h<ff&&f<mf){const g=o.projectCanvas.getActive();if(!g){e.current=null;return}const{scale:y,offset:m}=g.viewState,x=s.current;if(!x){e.current=null;return}const w=x.getBoundingClientRect(),v=u.x-w.left,b=u.y-w.top,N=xt({x:v,y:b},y,m);if(!N){e.current=null;return}const j=Re(10);a({id:j,x:N.x,y:N.y,content:"",type:de.TEXT,isEditing:!0}),i(j),requestAnimationFrame(()=>{const k=document.querySelector(`#NodeContainerV2-${j} .markdown-textarea`);k&&(k.contentEditable="true",k.focus({preventScroll:!0}))}),ml(u.y)&&fl({nodeId:j,nodeY:N.y,source:"doubleTap"}),n.preventDefault(),n.stopPropagation(),e.current=null;return}}e.current=u}},[s])},wf=e=>1-Math.pow(1-e,3),yf={offset:{x:0,y:0},scale:1,targetView:null},vf=()=>{const e=H(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.viewState)??yf}),s=E.getState(),n=s.projectCanvas.getActive,o=s.setActiveCanvasViewState,r=p.useRef(null),a=p.useRef({x:0,y:0}),i=p.useRef(1),c=p.useRef(!1);p.useEffect(()=>{const l=e.offset,d=e.scale,u=e.targetView;if(u){if(u.animationStartTime===0){const f=performance.now();o(g=>({...g,targetView:g.targetView?{...g.targetView,animationStartTime:f}:null}));return}c.current||(a.current=l,i.current=d,c.current=!0);const h=f=>{var j;const g=(j=n())==null?void 0:j.viewState,y=g==null?void 0:g.targetView;if(!y){r.current&&(cancelAnimationFrame(r.current),r.current=null);return}const m=f-y.animationStartTime,x=Math.min(m/y.animationDuration,1),w=wf(x),v=a.current.x+(y.targetOffset.x-a.current.x)*w,b=a.current.y+(y.targetOffset.y-a.current.y)*w,N=i.current+(y.targetScale-i.current)*w;o(k=>({...k,offset:{x:v,y:b},scale:N})),x<1?r.current=requestAnimationFrame(h):(o(k=>({...k,offset:y.targetOffset,scale:y.targetScale,targetView:null})),c.current=!1,r.current=null)};r.current=requestAnimationFrame(h)}return()=>{r.current&&(cancelAnimationFrame(r.current),r.current=null)}},[e,n,o])};class Ea{static isInGivenAreaInCanvas(s,n,o){if(n.x===void 0||n.y===void 0)return!1;let r=!0,a=!0;if(o.xRatio!==void 0){const i=s.x+o.xRatio*s.width;r=n.x>=i}if(o.yRatio!==void 0){const i=s.y+o.yRatio*s.height;a=n.y>=i}return r&&a}static createGridForCanvas(s,n=3){const{width:o,height:r}=s,a=[],i=o/n,c=r/n;for(let l=0;l<=n;l++){const d=[];for(let u=0;u<=n;u++)d.push({x:u*i,y:l*c});a.push(d)}return a}static focusElementAndMoveCursorToEnd(s){if(!s)return;s.hasAttribute("tabindex")||s.setAttribute("tabindex","-1"),s.focus();const n=document.createRange(),o=window.getSelection();if(o)try{n.selectNodeContents(s),n.collapse(!1),o.removeAllRanges(),o.addRange(n)}catch(r){console.error("Failed to set cursor position:",r)}}}Oe(Ea,"getCanvasCenter",(s,n,o)=>{if(!s)return console.warn("Container not available for center calculation."),{x:0,y:0};if(!n)return console.warn("Offset not available for center calculation."),{x:0,y:0};const{clientWidth:r,clientHeight:a}=s,i=r/2,c=a/2,l=(i-n.x)/o,d=(c-n.y)/o;return{x:l,y:d}});const Un=new xs("WriteModeHandlerV2",ws.WriteModeHandlerV2);class bf{constructor(){Oe(this,"s")}onKeyDown(s){const n=E.getState();this.s=n;const o=this.s.uiState,a=s.target.closest("#CanvasAppV2"),i=this.s.projectCanvas.getActive(),c=i==null?void 0:i.viewState,l=(c==null?void 0:c.offset)??{x:0,y:0},d=(c==null?void 0:c.scale)??1;if(!a||!c)return Un.warn("Canvas or active canvas viewState not available."),!0;if(s.key==="Enter"&&s.ctrlKey){const m=this.s.getEditingNode();if(!m)return!0;this.s.unselectNodeById(m.id);const x={x:m.x,y:m.y+(m.height??30)+30},w=Le.buildTextNode(x,""),v={x:(0-l.x)/d,y:(0-l.y)/d,width:a.clientWidth/d,height:a.clientHeight/d},b=Ea.isInGivenAreaInCanvas(v,w,{yRatio:se.writeMode.scrollYRatio});return this.addNode(w),b&&setTimeout(()=>{n.scrollToNode(w,se.writeMode.scrollDuration,{verticalOnly:!0})},50),!0}if(o.nodeToFocusId)return!0;const{mode:f}=o;if(f!==Q.WRITE)return!1;const g=s.key,y=s.ctrlKey||s.metaKey;if(g.length===1&&!y&&g!=="Enter"){const m=E.getState(),x=m.uiState.writeModeStartPosition,w=x??Ea.getCanvasCenter(a,l,d),v=Le.buildTextNode(w,"");return this.addNode(v),x&&m.setWriteModeStartPosition(null),Un.log(`WRITE Mode: Key "${g}" pressed. Created node ${v.id} at position (${w.x}, ${w.y}) and requested focus.`),!0}return g==="Escape"?(Un.log("WRITE Mode: Escape pressed. Global handler will switch mode."),!1):(Un.log(`WRITE Mode: Key "${g}" ignored by WriteModeHandler.`),!0)}onKeyUp(s){return!0}addNode(s){s.isEditing=!0,this.s.addNode(s,""),this.s.setNodeToFocusId(s.id)}}class Nf{onMouseDown(s){const n=E.getState(),o=n.uiState,{mode:r,addNodeType:a}=o;if(r!==Q.ADD)return!1;const i=n.getCanvasMouseCoords();if(!i)return!1;let c=!1;if(a===de.TABLE){const l=Le.buildTableNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.TEXTCARD){const l=Le.buildTextCardNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.WORKFLOW_ORCHESTRATION){const l=Le.buildWorkflowOrchestrationNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.WORKFLOW_SOURCE){const l=Le.buildWorkflowSourceNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.WORKFLOW_DEFINITION){const l=Le.buildWorkflowDefinitionNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.OCR){const l=Le.buildOCRNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.IMAGE){const l=Le.buildImageNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.WORKFLOW_STEP){const l=Le.buildWorkflowStepNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===de.VOCABULARY){const l=Le.buildVocabularyNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}return c?(n.setMode(Q.SELECT),n.setAddNodeType(null),s.stopPropagation(),!0):!1}}const Sf=()=>{const[e,s]=p.useState(null),n=p.useRef(new bf),o=p.useRef(new Gt),r=p.useRef(new Nf),a=hp(s),i=pp(),c=gp(s),l=fp(s),d=mp(),u=xp(),h=pg(),f=gg(),g=Ng(),y=Sg(),m=Cg(),x=zg(),w=Ug(),v=Vg(),b=Yg(),N=qg(),j=Zg(),k=Jg(),S=rf(),C=cf(),R=hf(),{handleTouchStart:I,handleTouchMove:M,handleTouchEnd:W}=pf(),B=xf(),F=E.getState(),D=F.setMode,L=F.setAddNodeType,A=F.uiState,T=Ce.useMemo(()=>({pointer:{onPointerDown:O=>{const $=E.getState().uiState.mode;$===Q.DRAW&&O.preventDefault(),!($===Q.ADD&&r.current.onMouseDown(O))&&(a(O),g(O),N(O),S(O),o.current.onMouseDown(O))},onPointerMove:O=>{i(O),y(O),x(O),v(O),j(O),C(O)},onPointerUp:O=>{c(O),m(O),w(O),b(O),k(O),R(O)},onPointerLeave:l,onDblClick:u},wheel:d,touch:{onTouchStart:I,onTouchMove:M,onTouchEnd:O=>{W(O),B(O)}},keyboard:{onKeyDown:O=>{n.current.onKeyDown(O),h(O)},onKeyUp:f}}),[a,g,N,S,i,y,x,v,j,C,c,m,w,b,k,R,l,d,I,M,W,h,f,u,B,D,L,A.mode,A.addNodeType,r]);return cp(T),vf(),up(),null},Cf=1280,jf=({top:e,bottom:s,left:n,right:o,topLeft:r,topRight:a,bottomLeft:i,bottomRight:c,alwaysVisibleBottomLeft:l,isContentVisible:d=!0,topMargin:u})=>{const h=Rn(),[f,g]=p.useState(!1);p.useEffect(()=>{const v=()=>g(window.innerWidth<Cf);return v(),window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[]);const[y,m]=p.useState({top:!1,bottom:!1,left:!1,right:!1,topLeft:!1,topRight:!1,bottomLeft:!1,alwaysVisibleBottomLeft:!1}),x=v=>{m(b=>({...b,[v]:!b[v]}))},w=(v,b,N)=>t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>x(v),className:`h-11 w-11 bg-background/30 backdrop-blur-sm hover:bg-background/50 transition-colors ${N}`,"data-prevent-canvas-click":!0,"data-ui-panel":!0,title:`Toggle ${v}`,"data-test":`mobile-toggle-${v}`,children:t.jsx(b,{className:"h-5 w-5 opacity-70"})});return t.jsxs("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:ke.canvasOverlay},"data-ui-panel":"canvas-overlay","data-test":"canvas-overlay-container",children:[e&&t.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{top:u||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top",children:e}),d&&s&&t.jsxs("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom",children:[t.jsx("div",{className:"hidden md:block","data-test":"canvas-overlay-bottom-desktop",children:s}),t.jsxs("div",{className:"flex flex-col items-center gap-2 md:hidden","data-test":"canvas-overlay-bottom-mobile",children:[y.bottom&&t.jsx("div",{children:s}),w("bottom",br,"")]})]}),d&&n&&t.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-left",children:h?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[w("left",br,""),y.left&&t.jsx("div",{children:n})]}):n}),d&&o&&t.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-right",children:h?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[y.right&&t.jsx("div",{children:o}),w("right",Mn,"")]}):o}),d&&r&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{top:u||"1rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-left",children:h?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[w("topLeft",_a,""),y.topLeft&&t.jsx("div",{children:r})]}):r}),d&&a&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{top:u||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-right",children:h?t.jsxs("div",{className:"flex flex-col items-end gap-1",children:[w("topRight",fo,""),y.topRight&&t.jsx("div",{children:a})]}):a}),d&&i&&t.jsx("div",{className:"absolute bottom-2 left-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-left",children:h?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[y.bottomLeft&&t.jsx("div",{children:i}),w("bottomLeft",vn,"")]}):i}),l&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:d&&i?"5rem":"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-always-visible-bottom-left",children:h?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[y.alwaysVisibleBottomLeft&&t.jsx("div",{children:l}),w("alwaysVisibleBottomLeft",vn,"")]}):l}),c&&t.jsx("div",{className:"absolute bottom-2 right-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-right",children:c})]})},kf={offset:{x:0,y:0},scale:1,targetView:null},Af=()=>{var d,u;const e=H(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.viewState)??kf}),s=H(h=>h.uiState.selectionBox),n=Us(h=>h.mousePosition)??null,o=e.scale??1,r=e.offset??{x:0,y:0},a=h=>{const f=Math.max(.01,Math.min(4,h));E.getState().setActiveCanvasViewState(g=>({...g,scale:f}))},i=h=>{let f;h==="up"?o<.1?f=Math.round((o+.01)*100)/100:f=Math.round((o+.1)*10)/10:o<=.1?f=Math.round((o-.01)*100)/100:f=Math.round((o-.1)*10)/10,a(f)},c=h=>{h.key==="ArrowUp"?(h.preventDefault(),i("up")):h.key==="ArrowDown"&&(h.preventDefault(),i("down"))},l=()=>{E.getState().setActiveCanvasViewState(h=>({...h,offset:{x:0,y:0},scale:1,targetView:null}))};return t.jsxs("div",{className:"text-xs p-1 bg-background/30 backdrop-blur-sm rounded pointer-events-auto",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("label",{className:"opacity-70",children:"Zoom:"}),t.jsx("input",{type:"number",value:o.toFixed(2),onChange:h=>a(parseFloat(h.target.value)||1),onKeyDown:c,min:"0.01",max:"4.0",step:"any",className:"w-16 px-1 py-0.5 text-xs border-0 rounded bg-background/50","data-test":"canvas-debug-zoom-input"}),t.jsx("button",{onClick:l,className:"px-1.5 py-0.5 text-xs border-0 rounded bg-background/50 hover:bg-background/70 transition-colors",title:"Reset view to 0,0","data-test":"canvas-debug-reset-button",children:"Reset"})]}),t.jsxs("div",{children:["Offset: X: ",((d=r==null?void 0:r.x)==null?void 0:d.toFixed(0))??0,", Y: ",((u=r==null?void 0:r.y)==null?void 0:u.toFixed(0))??0]}),t.jsxs("div",{children:["Mouse:"," ",n?`X: ${n.x.toFixed(0)}, Y: ${n.y.toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["M+O:"," ",n&&r?`X: ${(n.x-r.x).toFixed(0)}, Y: ${(n.y-r.y).toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["SelBox:",s?t.jsxs(t.Fragment,{children:[t.jsx("div",{children:`S:(${s.start.x.toFixed(0)},${s.start.y.toFixed(0)})`}),t.jsx("div",{children:` E:(${s.end.x.toFixed(0)},${s.end.y.toFixed(0)})`})]}):"N/A"]})]})},Ye=e=>{const{className:s,mainAction:n,dropdownActions:o=[],dropdownColumns:r,variant:a,size:i,dropdownMenuClassName:c,dropdownTriggerButtonId:l="options-menu-button",dropdownPosition:d="bottom",dropdownHorizontalAlign:u="container-right",persistenceKey:h,isOpen:f,onOpenChange:g,dropdownVerticalOffset:y=0,restoreRepeatAction:m,facade:x,...w}=e,v=r&&r.length>0,b=v?r.flatMap(Y=>Y.actions):o,[N,j]=p.useState(!1),k=f!==void 0,S=k?f:N,C=Y=>{const te=typeof Y=="function"?Y(S):Y;k||j(te),g==null||g(te)},R=p.useRef(null),I=p.useRef(null),[M,W]=p.useState(u),[B,F]=p.useState(d),[D,L]=p.useState(!1),[A,T]=p.useState({top:0,left:0}),O=()=>h?E.getState().getSegmentedButtonAction(h):null,[$,_]=p.useState(O),[G,X]=p.useState(null),J=p.useRef(null),P=p.useRef(!1);p.useEffect(()=>{var ce,ie,fe;if(P.current||!h)return;const Y=E.getState().getSegmentedButtonAction(h),ae=(((ie=(ce=E.getState().actions)==null?void 0:ce.history)==null?void 0:ie.entries)??[]).filter(ge=>ge.source===h);for(const ge of ae){const he=b.find(ue=>ue.label===ge.label&&ue.onClick);if(he){E.getState().setSegmentedButtonAction(h,ge.label,()=>he.onClick,{skipHistoryUpdate:!0});continue}if(x){const ue=x.getActions();let xe=!1;const me=ue.find(ye=>ye.label===ge.label);if(me&&(E.getState().setSegmentedButtonAction(h,ge.label,()=>()=>x.execute(me.id),{skipHistoryUpdate:!0,actionId:me.id}),xe=!0),!xe)for(const ye of ue){const Ie=(fe=ye.subActions)==null?void 0:fe.find(Ne=>Ne.title===ge.label);if(Ie){E.getState().setSegmentedButtonAction(h,ge.label,()=>()=>x.execute(Ie.id),{skipHistoryUpdate:!0,actionId:Ie.id}),xe=!0;break}}if(xe)continue}if(m){const ue=m(ge.label);ue&&E.getState().setSegmentedButtonAction(h,ge.label,()=>ue,{skipHistoryUpdate:!0})}}if(Y){const ge=b.find(he=>he.label===Y&&he.onClick);if(ge)J.current=ge.onClick,_(Y);else if(m){const he=m(Y);he&&(X({label:Y,execute:he}),_(null),J.current=he,E.getState().setSegmentedButtonAction(h,Y,()=>J.current,{skipHistoryUpdate:!0}))}}P.current=!0},[h,m,b]);const z=Y=>{Y.stopPropagation(),C(te=>(te||L(!1),!te))},U=Y=>{var ce;if(!x)return;const te=x.getActions(),ae=te.find(ie=>ie.label===Y);if(ae)return ae.id;for(const ie of te){const fe=(ce=ie.subActions)==null?void 0:ce.find(ge=>ge.title===Y);if(fe)return fe.id}},K=()=>{if(G){if(G.execute(),h){const Y=U(G.label);E.getState().setSegmentedButtonAction(h,G.label,()=>J.current,{actionId:Y})}return}if($){const Y=b.find(te=>te.label===$);if(Y&&!Y.disabled&&Y.onClick){if(Y.onClick(),J.current=Y.onClick,h){const te=U($);E.getState().setSegmentedButtonAction(h,$,()=>J.current,{actionId:te})}}else n.onClick()}else n.onClick()},re=(Y,te)=>{if(Y(),_(te),X(null),J.current=Y,h){const ae=U(te);E.getState().setSegmentedButtonAction(h,te,()=>J.current,{actionId:ae})}C(!1)},V={registerRepeatAction:(Y,te)=>{if(X({label:Y,execute:te}),_(null),J.current=te,h){const ae=U(Y);E.getState().setSegmentedButtonAction(h,Y,()=>J.current,{actionId:ae})}C(!1)},closeDropdown:()=>C(!1)};p.useEffect(()=>{if(S&&R.current){const Y=R.current.getBoundingClientRect(),te=window.innerWidth,ae=window.innerHeight,ce=16,ie=224,fe=200;let ge=0,he=0;d==="top"?ge=Y.top-fe-8+y:ge=Y.bottom+4+y,u==="container-right"?he=Y.right-ie:(u==="container-edge-right"||u==="middle-right")&&(he=Y.right,u==="middle-right"&&(he-=ie/2)),he+ie>te-ce?(he=te-ce-ie,W("container-right")):he<ce?(he=ce,W("container-edge-right")):W(u),ge+fe>ae-ce?(ge=Y.top-fe-8,F("top")):ge<ce?(ge=Y.bottom+4,F("bottom")):F(d),T({top:ge,left:he}),L(!0)}},[S,u,d,y]);const oe=p.useRef(!1);p.useEffect(()=>{const Y=ae=>{var ie,fe;const ce=ae.target;oe.current||(ie=R.current)!=null&&ie.contains(ce)||(fe=I.current)!=null&&fe.contains(ce)||ce.closest("[data-radix-popper-content-wrapper]")||ce.closest("[data-radix-select-viewport]")||ce.closest('[role="listbox"]')||ce.closest('[data-test="draggable-popover-wrapper"]')||ce.closest("[data-radix-select-trigger]")||ce.closest('[role="combobox"]')||C(!1)},te=new MutationObserver(ae=>{for(const ce of ae)if(ce.type==="childList"){const ie=Array.from(ce.addedNodes),fe=Array.from(ce.removedNodes);ie.some(ge=>ge instanceof HTMLElement&&ge.hasAttribute("data-radix-popper-content-wrapper"))&&(oe.current=!0),fe.some(ge=>ge instanceof HTMLElement&&ge.hasAttribute("data-radix-popper-content-wrapper"))&&setTimeout(()=>{oe.current=!1},100)}});return S&&(document.addEventListener("pointerdown",Y,!0),te.observe(document.body,{childList:!0})),()=>{document.removeEventListener("pointerdown",Y,!0),te.disconnect()}},[S]);const le=b&&b.length>0;let Z=n.text||n.label;if(n.disabled&&n.disabledTooltip)Z=n.disabledTooltip;else if(G)Z=G.label;else if($){const Y=b.find(te=>te.label===$);Y&&(Z=Y.label)}const q=Y=>{const te=Y.target;te.closest("[data-radix-select-trigger]")||te.closest('[role="combobox"]')||Y.stopPropagation()};return t.jsxs("div",{id:"UiSegmentedButton",ref:R,"data-prevent-canvas-click":!0,className:we("ui-segmented-button","relative inline-flex items-stretch",s),...w,children:[t.jsx(Xt,{delayDuration:300,children:t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"main-action-tooltip-wrapper",children:t.jsxs(ee,{variant:a,size:i,onClick:Y=>{Y.stopPropagation(),K()},"aria-label":n.label,disabled:n.disabled,className:we("ui-segmented-button__main-action",{"rounded-r-none":le,"border-r-0":le&&a==="outline","focus:z-10":le,"!opacity-40":n.disabled}),children:[n.icon,n.text&&t.jsx("span",{children:n.text})]})})}),t.jsx($t,{children:t.jsx("p",{children:Z})})]})}),le&&t.jsxs(t.Fragment,{children:[t.jsx(ee,{id:l,variant:a,size:i,onClick:z,"aria-haspopup":"true","aria-expanded":S,"aria-label":"Toggle dropdown options",disabled:n.disabled||!b.some(Y=>!Y.disabled),className:we("ui-segmented-button__dropdown-trigger","rounded-l-none",i!=="icon"&&"px-1",{"focus:z-10":le}),children:t.jsx(Et,{className:"ui-segmented-button__caret-icon w-1.5 h-2.5"})}),S&&Ys.createPortal(t.jsx("div",{ref:I,onPointerDown:q,onPointerUp:q,onClick:q,className:we("ui-segmented-button__dropdown-menu","fixed rounded-md shadow-lg",v?"w-auto":"w-56","bg-popover text-popover-foreground border","transition-opacity duration-75",{"opacity-0 pointer-events-none":!D,"opacity-100":D},c),style:{zIndex:ke.toolbarDropdown,top:A.top,left:A.left},role:"menu","aria-orientation":"vertical","aria-labelledby":l,"data-test":"segmented-button-dropdown-portal",children:v?t.jsx("div",{className:"grid gap-2 p-2",style:{gridTemplateColumns:r.some(Y=>Y.width)?r.map(Y=>Y.width||"1fr").join(" "):`repeat(${r.length}, 1fr)`},role:"none","data-test":"segmented-button-multi-column",children:r.map((Y,te)=>t.jsxs("div",{className:"flex flex-col gap-1","data-test":`segmented-button-column-${te}`,children:[Y.header&&t.jsx("span",{className:"text-xs font-medium text-muted-foreground px-1",children:Y.header}),Y.actions.map((ae,ce)=>ae.customRender?t.jsx("div",{children:ae.customRender(V)},ce):t.jsxs(ee,{variant:"ghost",size:"sm",onClick:()=>re(ae.onClick,ae.label),disabled:ae.disabled,className:"h-7 px-2 justify-start",role:"menuitem",title:ae.label,"data-test":`segmented-button-action-${ae.label.toLowerCase().replace(/\s+/g,"-")}`,children:[ae.icon&&t.jsx("span",{className:"mr-1",children:ae.icon}),t.jsx("span",{className:"text-xs",children:ae.label}),ae.selected&&t.jsx(Bs,{className:"ml-auto h-3 w-3"})]},ce))]},te))}):t.jsx("div",{className:"py-1",role:"none",children:o.map((Y,te)=>Y.customRender?t.jsx("div",{children:Y.customRender(V)},te):t.jsxs(ee,{variant:"ghost",size:"sm",onClick:()=>re(Y.onClick,Y.label),disabled:Y.disabled,className:we("ui-segmented-button__dropdown-item","w-full justify-start text-left font-normal"),role:"menuitem",children:[Y.icon&&t.jsx("span",{className:"mr-2",children:Y.icon})," ",Y.label,Y.selected&&t.jsx(Bs,{className:"ml-auto h-4 w-4"})]},te))})}),document.body)]})]})},If={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8},Tf=e=>{const{className:s,variant:n}=e,o=E.getState(),r=o.setMode,a=o.setAddNodeType,i=o.setSelectionBox,c=H(S=>S.uiState.customNodeDropdownOpen??!1),l=S=>{E.getState().setCustomNodeDropdownOpen(S)},d=()=>{r(Q.ADD),a(de.TABLE),i(null)},u=()=>{r(Q.ADD),a(de.TEXTCARD),i(null)},h=()=>{r(Q.ADD),a(de.WORKFLOW_ORCHESTRATION),i(null)},f=()=>{r(Q.ADD),a(de.WORKFLOW_SOURCE),i(null)},g=()=>{r(Q.ADD),a(de.WORKFLOW_DEFINITION),i(null)},y=()=>{r(Q.ADD),a(de.OCR),i(null)},m=()=>{r(Q.ADD),a(de.IMAGE),i(null)},x=()=>{r(Q.ADD),a(de.WORKFLOW_STEP),i(null)},w=()=>{r(Q.ADD),a(de.VOCABULARY),i(null)},v=[{label:"1: Table",icon:t.jsx(pu,{className:"h-2.5 w-2.5"}),onClick:d},{label:"2: Text Card",icon:t.jsx(gu,{className:"h-2.5 w-2.5"}),onClick:u},{label:"3: Image",icon:t.jsx(fu,{className:"h-2.5 w-2.5"}),onClick:m},{label:"4: OCR",icon:t.jsx(Qn,{className:"h-2.5 w-2.5"}),onClick:y},{label:"5: Vocabulary",icon:t.jsx(Lo,{className:"h-2.5 w-2.5"}),onClick:w},{label:"6: Workflow",icon:t.jsx(fs,{className:"h-2.5 w-2.5"}),onClick:h},{label:"7: Source",icon:t.jsx(bc,{className:"h-2.5 w-2.5"}),onClick:f},{label:"8: WF Runner",icon:t.jsx(Ze,{className:"h-2.5 w-2.5"}),onClick:g},{label:"9: WF Step",icon:t.jsx(mu,{className:"h-2.5 w-2.5"}),onClick:x}],[b,N]=p.useState(v[0]),j=S=>{N(S),S.onClick(),l(!1)},k=()=>{b.onClick()};return p.useEffect(()=>{if(!c)return;const S=C=>{const R=If[C.key];R!==void 0&&R<v.length?(C.preventDefault(),j(v[R])):C.key==="Escape"&&l(!1)};return window.addEventListener("keydown",S),()=>window.removeEventListener("keydown",S)},[c,v]),t.jsx("div",{id:"ToolbarAddCustomNode",className:Se("",s),"data-test":"toolbar-add-custom-node-button",children:t.jsx(Ye,{size:"sm",variant:n??"default",mainAction:{icon:b.icon,onClick:k,text:"(n)",label:`Add ${b.label}`},dropdownActions:v.map(S=>({...S,onClick:()=>j(S)})),dropdownPosition:"top",dropdownHorizontalAlign:"middle-right",dropdownVerticalOffset:-30,isOpen:c,onOpenChange:l})})},Ef=()=>{const e=H(h=>h.uiState.mode),s=H(h=>h.uiState.addNodeType),n=H(h=>h.uiState.writeSubMode),o=e===Q.ADD&&s===de.TEXT,r=e===Q.WRITE,a=r&&n===Ws.AUDIO,i=()=>{const h=E.getState();r?h.toggleWriteSubMode():o?(h.setMode(Q.WRITE),h.setWriteSubMode(Ws.WRITE)):(h.setMode(Q.ADD),h.setAddNodeType(de.TEXT))},c=o||r,l=()=>a?t.jsx(xu,{className:"h-4 w-4"}):r?t.jsx(wu,{className:"h-4 w-4"}):t.jsx(Nc,{className:"h-4 w-4"}),d=()=>a?"Audio Mode (click to toggle)":r?"Write Mode (click for audio)":o?"Text Mode (click for write, or w/a)":"Text (t)",u=()=>a?"(a)":r?"(w)":"(T)";return t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-text-mode-wrapper",children:[t.jsxs(ee,{variant:c?"default":"secondary",size:"sm",className:Se(a&&"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 text-white"),onClick:i,title:d(),"data-test":"canvas-toolbar-text-mode-button",children:[l(),t.jsx("span",{className:"hidden md:inline ml-1",children:u()})]}),t.jsx(Xt,{children:t.jsxs(Lt,{delayDuration:200,children:[t.jsx(Wt,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-text-mode-info-icon",children:t.jsx(fo,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx($t,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-text-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-text-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Text Mode (t):"})," Click to add text nodes"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Write Mode (t→w):"})," Create nodes with Ctrl+Enter"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Audio Mode (t→a):"})," Auto-starts voice recording"]}),t.jsx("p",{className:"text-muted-foreground",children:"Click button to cycle through modes"})]})})]})})]})};class Rf{constructor(){Oe(this,"currentNodeId",null);Oe(this,"nodes",[]);Oe(this,"yBandThreshold",100)}setNodes(s){this.nodes=s}setCurrentNode(s){this.currentNodeId=s}getCurrentNodeId(){return this.currentNodeId}getCurrentNode(){return this.currentNodeId?this.nodes.find(s=>s.id===this.currentNodeId)??null:null}getSortedNodes(){return[...this.nodes].sort((s,n)=>s.x!==n.x?s.x-n.x:s.y-n.y)}getCurrentIndex(){return this.getSortedNodes().findIndex(n=>n.id===this.currentNodeId)}getNodesInSameRow(s){return this.nodes.filter(n=>Math.abs(n.y-s.y)<=this.yBandThreshold)}moveLeft(){const s=this.getCurrentIndex();return s<=0?null:this.getSortedNodes()[s-1]??null}moveRight(){const s=this.getCurrentIndex(),n=this.getSortedNodes();return s<0||s>=n.length-1?null:n[s+1]??null}moveUp(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y<s.y-this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?r.y-o.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveDown(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y>s.y+this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?o.y-r.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveToLineStart(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>o.x-r.x),n[0]??null)}moveToLineEnd(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>r.x-o.x),n[0]??null)}moveToDocumentStart(){return this.getSortedNodes()[0]??null}moveToDocumentEnd(){const s=this.getSortedNodes();return s[s.length-1]??null}moveNext(){return this.moveRight()}movePrev(){return this.moveLeft()}}const Ve=new Rf;function Mf(e){const s=E.getState();s.setSelectedNodes([e]),Ve.setCurrentNode(e.id),s.scrollToNode(e.id,300)}function At(e,s){const n=e();return n?(Mf(n),!0):!1}let ao=null;function Yr(e){ao=e}function Kr(){return E.getState().setMode(Q.SELECT),ao==null||ao.popIdIf(Ot.canvasVim),!0}function Pf(e){const s=E.getState(),n=s.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.selectedNodes)??[];return o.length>0&&s.setNodeToFocusId(o[0].id),e==null||e.executeCommand(Xe.enterInsertMode,""),!0}function Df(e){return E.getState().setNodeToFocusId(null),e==null||e.executeCommand(Xe.enterNormalMode,""),!0}const Of=[{key:"i",command:Xe.enterInsertMode,desc:"Enter insert mode - edit selected node",execute:(e,s,n)=>Pf(n),preventUndoRedo:!0},{key:"h",command:Xe.cursorLeft,desc:"Move to previous node (left in spatial order)",execute:()=>At(()=>Ve.moveLeft()),preventUndoRedo:!0},{key:"l",command:Xe.cursorRight,desc:"Move to next node (right in spatial order)",execute:()=>At(()=>Ve.moveRight()),preventUndoRedo:!0},{key:"k",command:Xe.cursorUp,desc:"Move to node above",execute:()=>At(()=>Ve.moveUp()),preventUndoRedo:!0},{key:"j",command:Xe.cursorDown,desc:"Move to node below",execute:()=>At(()=>Ve.moveDown()),preventUndoRedo:!0},{key:"0",command:Xe.cursorLineStart,desc:"Move to first node in row",execute:()=>At(()=>Ve.moveToLineStart()),preventUndoRedo:!0},{key:"$",command:Xe.cursorLineEnd,desc:"Move to last node in row",execute:()=>At(()=>Ve.moveToLineEnd()),preventUndoRedo:!0},{key:"<Shift>$",command:Xe.cursorLineEnd,desc:"Move to last node in row",execute:()=>At(()=>Ve.moveToLineEnd()),preventUndoRedo:!0},{key:"gg",command:Xe.goToFirstLine,desc:"Move to first node",execute:()=>At(()=>Ve.moveToDocumentStart()),preventUndoRedo:!0},{key:"<Shift>G",command:Xe.goToLastLine,desc:"Move to last node",execute:()=>At(()=>Ve.moveToDocumentEnd()),preventUndoRedo:!0},{key:"G",command:Xe.goToLastLine,desc:"Move to last node",execute:()=>At(()=>Ve.moveToDocumentEnd()),preventUndoRedo:!0},{key:"w",command:Xe.cursorWordForwardStart,desc:"Move to next node",execute:()=>At(()=>Ve.moveNext()),preventUndoRedo:!0},{key:"b",command:Xe.cursorBackwordsStartWord,desc:"Move to previous node",execute:()=>At(()=>Ve.movePrev()),preventUndoRedo:!0},{key:"q",command:Xe.enterNormalMode,desc:"Exit vim mode",execute:()=>Kr(),preventUndoRedo:!0},{key:"<Escape>",command:Xe.enterNormalMode,desc:"Exit vim mode",execute:()=>Kr(),preventUndoRedo:!0}],Lf=[{key:"<Escape>",command:Xe.enterNormalMode,desc:"Exit insert mode - return to normal mode",execute:(e,s,n)=>Df(n),preventUndoRedo:!0}];function Wf(){return{[hn.NORMAL]:Of,[hn.INSERT]:Lf,[hn.VISUAL]:[],[hn.ALL]:[]}}function js(e){var c,l;const s=((c=e.state)==null?void 0:c.activeProjectId)??null,n=s?((l=e.state)==null?void 0:l.projects[s])??null:null,o=(n==null?void 0:n.activeWorkspaceId)??null,r=o?(n==null?void 0:n.workspaces[o])??null:null,a=(r==null?void 0:r.activeCanvasId)??null,i=a?(r==null?void 0:r.canvases[a])??null:null;return{project:n,workspace:r,canvas:i,path:{projectId:s,workspaceId:o,canvasId:a}}}const Xr=[],qr=[],Me={selectMode:e=>e.uiState.mode,selectIsSelectMode:e=>e.uiState.mode===Q.SELECT,selectIsMoveMode:e=>e.uiState.mode===Q.MOVE,selectIsDrawArrowMode:e=>e.uiState.mode===Q.DRAW_ARROW,selectIsAddTextMode:e=>e.uiState.mode===Q.ADD,selectIsAddTableMode:e=>e.uiState.mode===Q.ADD,selectIsWriteMode:e=>e.uiState.mode===Q.WRITE,selectActiveCanvas:e=>{const{canvas:s}=js(e);return s},selectActiveCanvasId:e=>{const{path:s}=js(e);return s.canvasId},selectActiveProjectId:e=>{var s;return((s=e.state)==null?void 0:s.activeProjectId)??null},selectActiveWorkspaceId:e=>{const{path:s}=js(e);return s.workspaceId},selectAllNodes:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.coreState.nodes)??Xr},selectNode:e=>s=>Me.selectAllNodes(s).find(o=>o.id===e)??null,selectSelectedNodes:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedNodes)??Xr},selectIsNodeSelected:e=>s=>Me.selectSelectedNodes(s).some(o=>o.id===e),selectAllArrows:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.coreState.arrows)??qr},selectArrow:e=>s=>Me.selectAllArrows(s).find(o=>o.id===e)??null,selectSelectedArrows:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedArrows)??qr},selectIsArrowSelected:e=>s=>Me.selectSelectedArrows(s).some(o=>o.id===e),selectArrowsConnectedToNode:e=>s=>Me.selectAllArrows(s).filter(o=>o.startNodeId===e||o.endNodeId===e),selectCanvasOffset:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.viewState.offset)??{x:0,y:0}},selectCanvasScale:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.viewState.scale)??1},selectCanvasDimensions:e=>({width:e.uiState.canvasWidth??0,height:e.uiState.canvasHeight??0}),selectViewState:e=>{const s=Me.selectActiveCanvas(e);return(s==null?void 0:s.viewState)??null},selectTemporaryArrow:e=>e.uiState.temporaryArrow,selectSelectionBox:e=>e.uiState.selectionBox,selectDragInfo:e=>e.uiState.dragInfo,selectResizingNode:e=>e.uiState.resizingNode,selectAddNodeType:e=>e.uiState.addNodeType,selectIsDragging:e=>e.uiState.dragInfo!==null,selectIsResizing:e=>e.uiState.resizingNode!==null,selectIsSelectionBoxActive:e=>e.uiState.selectionBox!==null,selectIsDrawingArrow:e=>e.uiState.temporaryArrow!==null,selectHasSelectedNodes:e=>Me.selectSelectedNodes(e).length>0,selectHasSelectedArrows:e=>Me.selectSelectedArrows(e).length>0,selectNodeCount:e=>Me.selectAllNodes(e).length,selectArrowCount:e=>Me.selectAllArrows(e).length,selectSelectedNodeCount:e=>Me.selectSelectedNodes(e).length,selectSelectedArrowCount:e=>Me.selectSelectedArrows(e).length,selectHasContent:e=>{const s=Me.selectNodeCount(e),n=Me.selectArrowCount(e);return s>0||n>0},selectIsCanvasEmpty:e=>!Me.selectHasContent(e),selectCanvasStats:e=>({nodeCount:Me.selectNodeCount(e),arrowCount:Me.selectArrowCount(e),selectedNodeCount:Me.selectSelectedNodeCount(e),selectedArrowCount:Me.selectSelectedArrowCount(e),hasContent:Me.selectHasContent(e)}),selectAllProjects:e=>{var s;return((s=e.state)==null?void 0:s.projects)??{}},selectActiveProject:e=>{const{project:s}=js(e);return s},selectActiveWorkspace:e=>{const{workspace:s}=js(e);return s}};let Zr=!1;function $f(){const e=window.__vimContainer;if(e)return e;const s=Ah.createContainer();return kh.register(s),iu.register(s),cu.register(s),lu.register(s),du.register(s),uu.register(s),window.__vimContainer=s,s}function Bf(e){if(Zr)return;const s=e.get(hu),n=Wf();s.registerCommands(Ot.canvasVim,n),Zr=!0}function Jr(e){if(e.getInstanceMap(Ot.canvasVim))return;const n={id:Ot.canvasVim,mode:hn.NORMAL,cursor:{line:0,col:0},lines:[]};e.registerAndInit({vimId:Ot.canvasVim,vimState:n})}function Hf(){const[e,s]=p.useState(!1),n=p.useRef(null),o=p.useRef(null),r=H(Me.selectAllNodes),a=H(Me.selectSelectedNodes),i=H(d=>d.uiState.mode);p.useEffect(()=>{const d=$f();return n.current=d.get(vc),Bf(d),Yr(n.current),()=>{Yr(null)}},[]),p.useEffect(()=>{Ve.setNodes(r)},[r]),p.useEffect(()=>{var u;const d=((u=a[0])==null?void 0:u.id)??null;Ve.setCurrentNode(d)},[a]),p.useEffect(()=>{const d=n.current;if(!d)return;const u=i===Q.VIM;if(u&&!e){Jr(d),d.setActiveId(Ot.canvasVim);const h=E.getState();h.setNodeToFocusId(null);const f=h.getEditingNode();f&&h.updateNode(f.id,{isEditing:!1});const g=d.getVimCore(Ot.canvasVim);if(g&&g.executeCommand(Xe.enterNormalMode,""),a.length===0&&r.length>0){const y=o.current,m=y?r.find(x=>x.id===y):null;if(m)E.getState().setSelectedNodes([m]),Ve.setCurrentNode(m.id),E.getState().scrollToNode(m.id,se.writeMode.scrollDuration);else{const x=Ve.moveToDocumentStart();x&&(E.getState().setSelectedNodes([x]),Ve.setCurrentNode(x.id))}}s(!0)}else!u&&e&&(a.length>0&&(o.current=a[0].id),d.popIdIf(Ot.canvasVim),s(!1))},[i,e,r,a]);const c=p.useCallback(d=>{const u=n.current;if(u){if(d){if(Jr(u),u.setActiveId(Ot.canvasVim),a.length===0&&r.length>0){const h=Ve.moveToDocumentStart();h&&(E.getState().setSelectedNodes([h]),Ve.setCurrentNode(h.id))}}else u.popIdIf(Ot.canvasVim);s(d)}},[r,a]),l=p.useCallback(()=>{c(!e)},[e,c]);return{vimEnabled:e,setVimEnabled:c,toggleVimMode:l}}const Io=({onSelect:e})=>{const s=H(c=>{var l;return(l=c.undo.getCurrent())==null?void 0:l.id}),{undoPath:n,redoPath:o}=p.useMemo(()=>{const c=E.getState();return{undoPath:c.undo.getPath(),redoPath:c.undo.getRedoPath()}},[s]),r=p.useMemo(()=>{const c=[...o].reverse(),l=[...n].reverse();return[...c,...l]},[n,o]);if(r.length===0)return t.jsx("div",{className:"p-3 text-sm text-muted-foreground","data-test":"unified-history-empty",children:"No history available"});const a=c=>new Date(c).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=o.length;return t.jsx("div",{className:"flex flex-col h-full overflow-y-auto","data-test":"unified-history-list",children:r.map((c,l)=>{const d=l<i,u=c.id===s;return t.jsxs("button",{type:"button",onClick:()=>e(c.id),className:Se("flex items-center gap-2 px-3 py-2 text-left transition-colors border-b border-border last:border-b-0",u&&"bg-accent/50",d&&"opacity-50",!d&&"hover:bg-accent",d&&"hover:bg-accent/30"),"data-test":`unified-history-${l}`,"data-redo":d,"data-current":u,children:[t.jsx("span",{className:"text-xs text-muted-foreground w-16 shrink-0",children:a(c.timestamp)}),t.jsx("span",{className:"text-sm truncate flex-1",children:c.label??pd(c.operation)}),u&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"●"})]},c.id)})})},To=({size:e="icon"})=>{const s=()=>{window.confirm("Clear all undo/redo history? This cannot be undone.")&&E.getState().undo.clear()};return t.jsx(ee,{variant:"ghost",size:e,onClick:s,title:"Clear history",className:"h-6 w-6 p-0","data-test":"clear-history-button",children:t.jsx(pt,{className:"h-3.5 w-3.5 text-muted-foreground hover:text-destructive"})})},Eo=({size:e="icon"})=>{const s=()=>{const n=E.getState().undo.getPath();n.length>0&&E.getState().undo.jumpTo(n[0].id)};return t.jsx(ee,{variant:"ghost",size:e,onClick:s,title:"Jump to start",className:"h-6 w-6 p-0","data-test":"jump-to-start-button",children:t.jsx(yu,{className:"h-3.5 w-3.5 text-muted-foreground"})})},Ro=({size:e="icon"})=>{const s=()=>{const n=E.getState().undo.getRedoPath();n.length>0&&E.getState().undo.jumpTo(n[n.length-1].id)};return t.jsx(ee,{variant:"ghost",size:e,onClick:s,title:"Jump to end",className:"h-6 w-6 p-0","data-test":"jump-to-end-button",children:t.jsx(vu,{className:"h-3.5 w-3.5 text-muted-foreground"})})},Ff=e=>{const{className:s,style:n}=e;Rn();const o=H(w=>w.uiState.mode),r=H(w=>w.uiState.addNodeType),a=H(w=>w.uiState.zoomSubMode),i=H(w=>w.uiState.arrowSubMode),c=H(w=>w.undo.canUndo()),l=H(w=>w.undo.canRedo()),{setVimEnabled:d}=Hf(),u=E.getState(),h=u.setMode,f=u.setZoomSubMode,g=u.saveStateToLocalStorage,y=()=>{E.getState().undo.undo()},m=()=>{E.getState().undo.redo()},x=w=>{o===Q.VIM&&w!==Q.VIM&&d(!1),w===Q.VIM&&d(!0),h(w)};return t.jsxs("div",{className:Se("p-2 bg-background border shadow pointer-events-auto rounded flex items-center","max-md:flex-wrap max-md:gap-2 max-md:w-full max-md:max-w-lg md:space-x-2",s),style:{...n},onMouseDown:w=>w.stopPropagation(),"data-ui-panel":"canvas-toolbar",children:[t.jsxs(ee,{variant:o===Q.SELECT?"default":"secondary",size:"sm",onClick:()=>x(Q.SELECT),title:"Select (v)","data-test":"canvas-toolbar-select-mode-button",children:[t.jsx(Sc,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(v)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-move-mode-wrapper",children:[t.jsxs(ee,{variant:o===Q.MOVE||o===Q.ZOOM?"default":"secondary",size:"sm",className:Se(o===Q.ZOOM&&a==="zoom:lock"&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{o===Q.MOVE?(x(Q.ZOOM),f("zoom")):o===Q.ZOOM?(document.pointerLockElement&&document.exitPointerLock(),x(Q.MOVE)):x(Q.MOVE)},title:o===Q.ZOOM&&a==="zoom:lock"?"Zoom:Lock Mode (click or Esc to exit)":o===Q.ZOOM?"Zoom Mode (h to toggle Pan)":"Pan Mode (h to toggle Zoom)","data-test":"canvas-toolbar-move-mode-button",children:[o===Q.ZOOM?t.jsx(bu,{className:"h-4 w-4"}):t.jsx(Nu,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(h)"})]}),t.jsx(Xt,{children:t.jsxs(Lt,{delayDuration:200,children:[t.jsx(Wt,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-move-mode-info-icon",children:t.jsx(fo,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx($t,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-move-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-move-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Pan Mode (h):"})," Drag to pan the canvas"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom Mode (h again):"})," Scroll or drag to zoom"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom:Lock:"})," Double-click canvas to lock zoom, move mouse to zoom"]}),t.jsx("p",{className:"text-muted-foreground",children:"Press 'h' to toggle between Pan and Zoom"})]})})]})})]}),t.jsxs(ee,{variant:o===Q.GRID?"default":"secondary",size:"sm",onClick:()=>x(Q.GRID),title:"Grid Mode (g)","data-test":"canvas-toolbar-grid-mode-button",children:[t.jsx(Su,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(g)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-vim-mode-wrapper",children:[t.jsxs(ee,{variant:o===Q.VIM?"default":"secondary",size:"sm",onClick:()=>x(Q.VIM),title:"Vim Navigation Mode (i)","data-test":"canvas-toolbar-vim-mode-button",children:[t.jsx("span",{className:"text-sm font-bold","data-test":"vim-mode-icon",children:"V"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(i)"})]}),t.jsx(Xt,{children:t.jsxs(Lt,{delayDuration:200,children:[t.jsx(Wt,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-vim-mode-info-icon",children:t.jsx(fo,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx($t,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-vim-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-vim-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Vim Mode:"})," Navigate nodes with vim keybindings"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"h/l:"})," Previous/next node (X-first order)"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"j/k:"})," Node below/above"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"0/$:"})," First/last node in row"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"gg/G:"})," First/last node"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"w/b:"})," Next/previous node"]})]})})]})})]}),t.jsxs(ee,{variant:o===Q.DRAW_ARROW?"default":"secondary",size:"sm",className:Se(o===Q.DRAW_ARROW&&i===ro.STAY&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>x(Q.DRAW_ARROW),title:o===Q.DRAW_ARROW&&i===ro.STAY?"Draw Arrow: Stay Mode (a to toggle, Esc to exit)":"Draw Arrow (a)","data-test":"canvas-toolbar-draw-arrow-button",children:[t.jsx(Kt,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(a)"})]}),t.jsxs(ee,{variant:o===Q.DRAW?"default":"secondary",size:"sm",onClick:()=>x(Q.DRAW),title:"Draw Mode (d) - Freehand, Rectangle, Circle, Line","data-test":"canvas-toolbar-draw-mode-button",children:[t.jsx(Hs,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(d)"})]}),t.jsx(Ef,{}),t.jsx(Tf,{variant:o===Q.ADD&&(r===de.TABLE||r===de.TEXTCARD||r===de.OCR||r===de.VOCABULARY||r===de.WORKFLOW_ORCHESTRATION||r===de.WORKFLOW_SOURCE||r===de.WORKFLOW_DEFINITION)?"default":"secondary"}),t.jsx(En,{expandContent:t.jsx(Io,{onSelect:w=>E.getState().undo.jumpTo(w)}),expandTitle:"History",onClick:y,onHoldRepeat:y,holdRepeatInterval:se.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!c,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"canvas-toolbar-undo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Eo,{}),t.jsx(Ro,{}),t.jsx(To,{})]}),children:t.jsx(za,{className:"h-4 w-4"})}),t.jsx(En,{expandContent:t.jsx(Io,{onSelect:w=>E.getState().undo.jumpTo(w)}),expandTitle:"History",onClick:m,onHoldRepeat:m,holdRepeatInterval:se.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!l,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"canvas-toolbar-redo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Eo,{}),t.jsx(Ro,{}),t.jsx(To,{})]}),children:t.jsx(Cc,{className:"h-4 w-4"})}),t.jsx(ee,{variant:"secondary",size:"sm",onClick:g,title:"Save to Local Storage","data-test":"canvas-toolbar-save-button",children:t.jsx(qt,{className:"h-4 w-4"})})]})},_f=({startX:e,startY:s,endX:n,endY:o})=>{const r=Math.min(e,n),a=Math.min(s,o),i=Math.abs(e-n),c=Math.abs(s-o);return i===0||c===0?null:t.jsx("div",{className:"absolute border border-ring bg-ring/20 pointer-events-none",style:{left:`${r}px`,top:`${a}px`,width:`${i}px`,height:`${c}px`,zIndex:20}})},zf=Ce.memo(_f),Uf=()=>{const e=H(s=>s.uiState.selectionBox);return e?t.jsx(zf,{startX:e.start.x,startY:e.start.y,endX:e.end.x,endY:e.end.y}):null},Vf=({node:e})=>t.jsxs("div",{className:Se("bg-background border border-foreground p-2",e.className),style:{width:e.width?`${e.width}px`:"100px",height:e.height?`${e.height}px`:"50px",whiteSpace:"pre-line"},children:[e.content||"Rect"," "]});class Gf{createHighlight(s,n,o){return{id:n??Re(),start:s.start,end:s.end,color:s.color,createdAt:o??Date.now()}}validateHighlight(s,n){return s.start<0?{valid:!1,error:"Highlight start cannot be negative"}:s.end>n?{valid:!1,error:`Highlight end (${s.end}) exceeds text length (${n})`}:s.start>=s.end?{valid:!1,error:"Highlight start must be less than end"}:{valid:!0}}findOverlapping(s,n,o,r){const a=(r==null?void 0:r.includeTouching)??!1;return s.filter(i=>a?!(i.end<n||i.start>o):!(i.end<=n||i.start>=o))}deleteHighlight(s,n){return s.filter(o=>o.id!==n)}sortHighlights(s){return[...s].sort((n,o)=>n.start!==o.start?n.start-o.start:n.end-o.end)}}function Qr(e,s,n){let o=0,r=!1;function a(i){var c;if(r)return!0;if(i===s)return i.nodeType===Node.TEXT_NODE&&(o+=n),r=!0,!0;if(i.nodeType===Node.TEXT_NODE)o+=((c=i.textContent)==null?void 0:c.length)||0;else if(i.nodeType===Node.ELEMENT_NODE){const l=i,d=l.tagName;if(d==="BR")return o+=1,!1;let u=0,h=!1;if(d==="H1")u=2;else if(d==="H2")u=3;else if(d==="H3")u=4;else if(d==="BLOCKQUOTE")u=2;else if(l.classList.contains("list-item-ul"))u=2,h=!0;else if(l.classList.contains("list-item-ol")){const g=l.querySelector("span:first-child");u=((g==null?void 0:g.textContent)||"1.").length+1,h=!0}else if(l.classList.contains("empty-line"))return o+=1,!1;o+=u;const f=Array.from(i.childNodes);for(let g=0;g<f.length;g++)if(!(h&&g===0&&f[g].nodeName==="SPAN")&&a(f[g]))return!0}return!1}return a(e),o}function Yf(e){if(e instanceof HTMLTextAreaElement){const s=e.selectionStart,n=e.selectionEnd;return s===n?null:{start:s,end:n}}if(e.isContentEditable){const s=window.getSelection();if(!s||s.isCollapsed||s.rangeCount===0)return null;const n=s.getRangeAt(0),o=Qr(e,n.startContainer,n.startOffset),r=Qr(e,n.endContainer,n.endOffset);return o===r?null:{start:o,end:r}}return null}const Kf="rgb(198, 183, 0)";function Xf({textareaRef:e,node:s,updateNode:n,enabled:o=!0,defaultColor:r=Kf}){const a=p.useRef(new Gf),i=p.useCallback(d=>{if(!e.current||!o)return;const u=Yf(e.current);if(!u)return;const h=s.highlights||[],f=a.current.findOverlapping(h,u.start,u.end);if(f.length>0){let v=h;for(const b of f)v=a.current.deleteHighlight(v,b.id);if(n(s.id,{highlights:v.length>0?v:void 0}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const b=window.getSelection();b&&b.collapseToEnd()}console.log("🗑️ Highlights removed:",f.length);return}const g=a.current.createHighlight({start:u.start,end:u.end,color:d||r}),y=s.content||"",m=a.current.validateHighlight(g,y.length);if(!m.valid){console.error("useTextHighlighting: Invalid highlight",m.error);return}const x=[...h,g],w=a.current.sortHighlights(x);if(n(s.id,{highlights:w}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const v=window.getSelection();v&&v.collapseToEnd()}console.log("✨ Highlight applied:",{start:u.start,end:u.end,color:g.color})},[e,o,s,n,r]),c=d=>{const u=s.highlights||[],h=a.current.deleteHighlight(u,d);n(s.id,{highlights:h.length>0?h:void 0}),console.log("🗑️ Highlight removed:",d)},l=()=>{n(s.id,{highlights:void 0}),console.log("🧹 All highlights cleared")};return p.useEffect(()=>{if(!o||!e.current)return;const d=()=>{pn.registerCallback(i)},u=()=>{pn.unregisterCallback(i)},h=e.current;return h.addEventListener("focus",d),h.addEventListener("blur",u),document.activeElement===h&&pn.registerCallback(i),()=>{h.removeEventListener("focus",d),h.removeEventListener("blur",u),pn.unregisterCallback(i)}},[o,e,i]),{applyHighlight:i,removeHighlight:c,clearAllHighlights:l}}function Gs(e,s="content"){const n=p.useRef(null),o=p.useCallback(a=>{n.current=a},[]),r=p.useCallback(a=>{const i=n.current;i!==null&&i!==a&&E.getState().undo.commit({type:"node:update",nodeId:e,from:{[s]:i},to:{[s]:a}}),n.current=null},[e,s]);return{onEditStart:o,onEditEnd:r}}function Ln(e,s={}){var x;const{duration:n=500,targetScale:o,highlightYOffset:r}=s,a=E.getState(),i=(x=a.projectCanvas.getActive())==null?void 0:x.viewState;if(!i)return;const c=document.getElementById("CanvasAppV2");if(!c)return;const l=c.getBoundingClientRect(),d=l.width/2,u=l.height/2,h=o??i.scale,f=e.x*h,g=e.y*h,y=r!==void 0?g+r*h:g+(e.height||0)*h/2,m={x:d-f-(e.width||0)*h/2,y:u-y};a.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:m,targetScale:h,animationStartTime:performance.now(),animationDuration:n}})),a.setSelectedNodes([e]),a.setNodeToFocusId(e.id)}function ei(e,s){let n=0;function o(r){var a,i,c,l,d;if(r.nodeType===Node.TEXT_NODE){const u=((a=r.textContent)==null?void 0:a.length)||0;if(n+u>=s){const h=s-n,f=Math.min(h,u);return{node:r,offset:f}}return n+=u,null}if(r.nodeType===Node.ELEMENT_NODE){const u=r,h=u.tagName;if(h==="BR")return n+1>s?{node:r.parentNode,offset:Array.from(r.parentNode.childNodes).indexOf(r)}:(n+=1,null);let f=0,g=!1,y=!1;if(h==="H1")f=2;else if(h==="H2")f=3;else if(h==="H3")f=4;else if(h==="BLOCKQUOTE")f=2;else if(u.classList.contains("list-item-ul"))f=2,g=!0,((i=u.previousElementSibling)!=null&&i.classList.contains("list-item-ul")||(c=u.previousElementSibling)!=null&&c.classList.contains("list-item-ol"))&&(y=!0);else if(u.classList.contains("list-item-ol")){const x=u.querySelector("span:first-child");f=((x==null?void 0:x.textContent)||"1.").length+1,g=!0,((l=u.previousElementSibling)!=null&&l.classList.contains("list-item-ul")||(d=u.previousElementSibling)!=null&&d.classList.contains("list-item-ol"))&&(y=!0)}else if(u.classList.contains("empty-line"))return n+1>s?{node:u,offset:0}:(n+=1,null);y&&(n+=1),n+=f;const m=Array.from(r.childNodes);for(let x=0;x<m.length;x++){if(g&&x===0&&m[x].nodeName==="SPAN")continue;const w=o(m[x]);if(w)return w}}return null}return o(e)}const qf=({text:e,highlights:s,className:n})=>!s||s.length===0?null:t.jsx(Zf,{text:e,highlights:s,className:n}),Zf=({text:e,highlights:s,className:n})=>{const o=p.useRef(null),r=p.useRef(null),[a,i]=p.useState([]),[c,l]=p.useState(0),[d,u]=p.useState(1);p.useEffect(()=>{var m;const f=E.subscribe(x=>{var b;const w=(b=x.projectCanvas.getActive())==null?void 0:b.viewState,v=(w==null?void 0:w.scale)??1;u(v)}),y=(m=E.getState().projectCanvas.getActive())==null?void 0:m.viewState;return u((y==null?void 0:y.scale)??1),f},[]);const h=f=>{var x;if(!f)return;const m=(((x=E.getState().projectCanvas.getActive())==null?void 0:x.coreState.nodes)??[]).find(w=>w.id===f);if(!m){console.warn(`Linked node ${f} not found`);return}Ln(m,{duration:400})};return p.useEffect(()=>{var m,x;const f=o.current;if(!f)return;const g=((m=f.parentElement)==null?void 0:m.querySelector("textarea"))||((x=f.parentElement)==null?void 0:x.querySelector(".markdown-textarea"));if(!g)return;l(g.clientWidth);const y=new ResizeObserver(w=>{for(const v of w)v.target===g&&l(g.clientWidth)});return y.observe(g),()=>{y.disconnect()}},[]),p.useEffect(()=>{if(!o.current||!r.current||!s||s.length===0){i([]);return}const f=requestAnimationFrame(()=>{var S,C,R,I;if(!o.current||!r.current)return;const g=o.current,y=((S=g.parentElement)==null?void 0:S.querySelector("textarea"))||((C=g.parentElement)==null?void 0:C.querySelector(".markdown-textarea"));if(!y){i([]);return}const m=r.current,x=window.getComputedStyle(y);m.style.font=x.font,m.style.fontSize=x.fontSize,m.style.fontFamily=x.fontFamily,m.style.fontWeight=x.fontWeight,m.style.lineHeight=x.lineHeight,m.style.letterSpacing=x.letterSpacing,m.style.wordSpacing=x.wordSpacing,m.style.padding=x.padding,m.style.paddingLeft=x.paddingLeft,m.style.paddingRight=x.paddingRight,m.style.paddingTop=x.paddingTop,m.style.paddingBottom=x.paddingBottom,m.style.width=`${y.clientWidth}px`,m.style.border="none";const w=parseFloat(x.borderTopWidth)||0,v=parseFloat(x.borderLeftWidth)||0;m.style.top=`${w}px`,m.style.left=`${v}px`,m.style.wordWrap=x.wordWrap,m.style.whiteSpace=x.whiteSpace,m.style.overflowWrap=x.overflowWrap,m.style.boxSizing=x.boxSizing,m.style.textAlign=x.textAlign,m.style.direction=x.direction,m.style.wordBreak=x.wordBreak,m.textContent=e;const b=y.getBoundingClientRect(),N=g.getBoundingClientRect(),j=y.classList.contains("markdown-textarea"),k=[];for(const M of s){const W=Math.min(M.start,e.length),B=Math.min(M.end,e.length);if(W>=B)continue;const F=e.substring(W,B);try{let D;if(j){const L=ei(y,W),A=ei(y,B),T=((R=L==null?void 0:L.node.textContent)==null?void 0:R.length)??0,O=((I=A==null?void 0:A.node.textContent)==null?void 0:I.length)??0,$=L&&L.offset>=0&&L.offset<=T,_=A&&A.offset>=0&&A.offset<=O;if(!L||!A||!$||!_)continue;const G=document.createRange();G.setStart(L.node,L.offset),G.setEnd(A.node,A.offset),D=G.getClientRects()}else{const L=document.createRange(),A=m.firstChild;if(!A||A.nodeType!==Node.TEXT_NODE)continue;L.setStart(A,W),L.setEnd(A,B),D=L.getClientRects()}for(let L=0;L<D.length;L++){const A=D[L],T={top:A.top-N.top,left:A.left-N.left},O={top:A.top-b.top,left:A.left-b.left},$=parseFloat(x.borderTopWidth)||0,_=T.top-$,G=parseFloat(x.paddingLeft)||0,X=j?O.left:O.left-G,J=A.width,P=A.height;if(J<1)continue;const z=_/d,U=X/d,K=J/d+8,re=P/d;k.push({id:`${M.id}-${L}`,top:z,left:U,width:K,height:re,color:M.color,linkedNodeId:M.linkedNodeId,highlightedText:F})}}catch(D){console.error("Error calculating highlight rect:",D)}}i(k)});return()=>{cancelAnimationFrame(f)}},[e,s,c,d]),t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:r,className:Se("mirror-div absolute inset-0 pointer-events-none whitespace-pre-wrap"),"aria-hidden":"true"}),t.jsx("div",{ref:o,className:Se("highlight-renderer","absolute inset-0","z-20","pointer-events-none",n),"aria-hidden":"true",children:a.map(f=>t.jsx("mark",{"data-test":"highlight-mark",className:Se("absolute",f.linkedNodeId?"cursor-pointer pointer-events-auto":"pointer-events-none"),onClick:f.linkedNodeId?()=>h(f.linkedNodeId):void 0,style:{top:`${f.top}px`,left:`${f.left}px`,width:`${f.width}px`,height:`${f.height}px`,backgroundColor:f.color,opacity:.4,borderRadius:"2px"}},f.id))})]})};function Jf(e,s){const n=e.split(`
`);let o=0;for(let r=0;r<n.length;r++){const a=n[r].length,i=o+a;if(s<=i)return r;o=i+1}return n.length-1}function Qf(e,s,n=pe.DEFAULT_PADDING,o=pe.LINE_HEIGHT){const r=Jf(e,s.start);return n+r*o+o/2}function em({textareaRef:e,onCopy:s,onHighlight:n,onDelete:o,onLink:r,onHighlightAndCreateNode:a,onDefine:i}){const[c,l]=p.useState(!1),[d,u]=p.useState({start:0,end:0}),h=p.useRef({start:0,end:0}),f=p.useRef(null),g=p.useRef(!1);p.useEffect(()=>{const x=()=>{g.current=!0,l(!1)};return Gt.registerDismissPopoverCallback(x),()=>{Gt.unregisterDismissPopoverCallback()}},[]),p.useEffect(()=>(Gt.registerSelectionCallback(x=>{l(x)}),f.current=setInterval(()=>{const x=e.current;if(!x)return;const w=x.selectionStart,v=x.selectionEnd,b=w!==v;b&&((w!==h.current.start||v!==h.current.end)&&(g.current=!1),h.current={start:w,end:v},u({start:w,end:v})),g.current||l(b)},100),()=>{Gt.unregisterSelectionCallback(),f.current&&clearInterval(f.current)}),[e]);const y=()=>{const x=e.current;return x?(x.value??"").substring(d.start,d.end):""},m=(x,w)=>{x.preventDefault(),x.stopPropagation(),g.current=!0;const v=e.current;v&&(v.focus(),v.setSelectionRange(d.start,d.end)),w&&w(),setTimeout(()=>{l(!1)},20)};return t.jsx(Ih,{inputRef:e,show:c,updateOn:d,offset:{top:4,left:0},children:t.jsxs("div",{className:"text-selection-popover bg-popover text-popover-foreground border border-border rounded-md shadow-lg p-1","data-test":"text-selection-popover",onPointerDown:x=>{x.preventDefault()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center gap-1",children:[s&&t.jsx("button",{"data-test":"text-selection-copy-button",onPointerDown:x=>m(x,s),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Create linked node",children:t.jsx(Mt,{className:"w-4 h-4"})}),a&&t.jsx("button",{"data-test":"text-selection-highlight-create-button",onPointerDown:x=>m(x,a),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight & create linked node",children:t.jsx(bn,{className:"w-4 h-4"})}),i&&t.jsx("button",{"data-test":"text-selection-define-button",onPointerDown:x=>m(x,i),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Define word",children:t.jsx(Lo,{className:"w-4 h-4"})}),n&&t.jsx("button",{"data-test":"text-selection-highlight-button",onPointerDown:x=>m(x,n),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight text",children:t.jsx(jc,{className:"w-4 h-4"})}),r&&t.jsx("button",{"data-test":"text-selection-link-button",onPointerDown:x=>m(x,r),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Link to node",children:t.jsx(Cu,{className:"w-4 h-4"})}),o&&t.jsx("button",{"data-test":"text-selection-delete-button",onPointerDown:x=>m(x,o),className:"action-button p-2 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors",title:"Delete selection",children:t.jsx(pt,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"selection-preview text-xs text-muted-foreground mt-1 px-2 py-1 max-w-[200px] truncate",children:['"',y(),'"']})]})})}function tm({input:e,lastKeyWasEnter:s=!1,pendingNewlines:n=0,computedLineHeight:o=pe.LINE_HEIGHT,currentNodeHeight:r=0}){const a=e.split(/\n|&nbsp;/);let i=a.length,c=pe.DEFAULT_NODE_HEIGHT;if(i===1&&!s&&n===0)return c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:0,headerExtraLines:0};i+=n;let l=0,d=!1,u=!0;const h=n>0;let f=0;for(let g=0;g<a.length;g++){const m=a[g].trimStart(),x=m.startsWith("- ")||/^\d+\.\s/.test(m),w=g===a.length-1;x&&!d&&!u&&(!w||h)&&(l+=1),(!w||h)&&(m.startsWith("# ")?f+=.5:m.startsWith("## ")?f+=.3:m.startsWith("### ")&&(f+=.1)),d=x,u=!1}return i+=l+f,c+=(i-1)*o,c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:l,headerExtraLines:f}}const ti=(e,s)=>{const o=E.getState().projectCanvas.getActive();if(!o)return null;const a=(o.coreState.nodes||[]).filter(c=>c.linkedSourceNodeId===e&&Array.isArray(c.tags)&&c.tags.some(l=>l.title===s));return a.length===0?null:Math.max(...a.map(c=>(c.y??0)+(c.height??0)))},si=e=>({id:Math.random().toString(36).slice(2,10),title:e}),ni=e=>({x:(e.x??0)+(e.width??0)/2,y:(e.y??0)+(e.height??0)/2}),oi=(e,s)=>{const n=E.getState(),o=()=>Math.random().toString(36).slice(2,10);window.setTimeout(()=>{n.arrow.add({id:o(),startNodeId:e.id,endNodeId:s.id,startPoint:ni(e),endPoint:ni(s),type:"TreeLStep"})},0)},sm=Ce.memo(({node:e,isEditing:s,preventEdit:n})=>{const o=p.useCallback(()=>{const i=E.getState(),c=i.getNodeById(e.id);if(!c)return;const l=pe.DEFAULT_NODE_WIDTH,d=pe.DEFAULT_NODE_HEIGHT,u=40,h=c.x-l/2,f=ti(c.id,"left"),g=f!==null?f+u:c.y+(c.height??0)+u,y=Le.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});y.x=h,y.y=g,y.width=l,y.height=d,y.tags=[si("left")],i.addNode(y,void 0,{dontOverlap:!0}),i.setNodeToFocusId(y.id),oi(c,y)},[e.id]),r=p.useCallback(()=>{const i=E.getState(),c=i.getNodeById(e.id);if(!c)return;const l=pe.DEFAULT_NODE_WIDTH,d=pe.DEFAULT_NODE_HEIGHT,u=40,h=c.x+(c.width??0)-l/2,f=ti(c.id,"right"),g=f!==null?f+u:c.y+(c.height??0)+u,y=Le.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});y.x=h,y.y=g,y.width=l,y.height=d,y.tags=[si("right")],i.addNode(y,void 0,{dontOverlap:!0}),i.setNodeToFocusId(y.id),oi(c,y)},[e.id]);return!s||n||!(e.content&&e.content.trim().length>0)?null:t.jsxs(t.Fragment,{children:[t.jsx(ee,{"data-test":"create-left-child-node-button",size:"icon",variant:"ghost",className:"create-left-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),o()},title:"Create linked node on the left",children:"+"}),t.jsx(ee,{"data-test":"create-right-child-node-button",size:"icon",variant:"ghost",className:"create-right-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${2*(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),r()},title:"Create linked node on the right",children:"+"})]})}),xl=new Map;function nm(e){const s=e.data;if((s==null?void 0:s.vocabType)!==He.VOCABULARY)return null;const n=s.sourceWord||"",o=s.translationWord||"",r=Ls(n),a=Ls(o),i=Math.max(r,a);return{width:Math.max(i+Ba.textNodeXPadding,pe.VOCAB_NODE_MIN_WIDTH),height:null}}xl.set(de.VOCABULARY,nm);function ai(e){const s=xl.get(e.type);return s?s(e):null}const ca=()=>{var e;return((e=E.getState().projectCanvas.getActive())==null?void 0:e.coreState.selectedNodes)??[]},la=()=>E.getState().updateNode;function Xs(){const e=p.useCallback(r=>{const a=r||ca(),i=la();if(a.length===0)return;gr();const c=a.map(l=>{if(!(l!=null&&l.id))return null;const d=ai(l);if(d){const f={...l,width:d.width};return d.height!==null&&(f.height=d.height),{id:l.id,payload:f}}if(!l.content||typeof l.content!="string")return null;const{width:u,height:h}=gs(l.content);return u>0?{id:l.id,payload:{...l,width:u,height:h}}:null}).filter(l=>l!==null);c.length>0&&c.forEach(l=>{const d={width:l.payload.width,options:{...l.payload.options,lockSize:!0}};l.payload.height!==void 0&&(d.height=l.payload.height),i(l.id,d)})},[]),s=p.useCallback((r,a)=>{const i=a||ca(),c=la(),l=i.map(d=>{if(!(d!=null&&d.id))return null;const u=ai(d);if(u){const y={...d,width:r,options:{...d.options,lockSize:!0}};return u.height!==null&&(y.height=u.height),{id:d.id,payload:y}}const h=d.content||"",g=ct(h,{containerWidth:r})+pe.NODE_Y_PADDING*2;return{id:d.id,payload:{...d,width:r,height:g,options:{...d.options,lockSize:!0}}}}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const u={width:d.payload.width,options:d.payload.options};d.payload.height!==void 0&&(u.height=d.payload.height),c(d.id,u)})},[]),n=p.useCallback((r,a,i)=>{if(r.length===0)return;const c=la(),l=i??se.arrange.gap;gr(),r.map(u=>{if(!(u!=null&&u.id)||!u.content||typeof u.content!="string")return null;const{width:h,height:f}=gs(u.content);return h>0?{id:u.id,width:h,height:f}:null}).filter(u=>u!==null).forEach(u=>{c(u.id,{width:u.width,height:u.height,options:{lockSize:!1}})}),setTimeout(()=>{const u=E.getState();let h=a;r.forEach(f=>{const g=u.getNodeById(f.id);g&&(u.updateNode(f.id,{y:h}),h+=(g.height??0)+l)})},10)},[]);return p.useMemo(()=>({fitNodeDimensions:e,setFixedWidth:s,fitAndRepositionNodes:n,get selectedNodes(){return ca()}}),[e,s,n])}function om(e){const s=p.useCallback(()=>fr.has(e),[e]);return p.useSyncExternalStore(n=>fr.subscribe(n),s,s)}const am="type here...",rm=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??Ha},im=Ce.memo(({node:e})=>{var X,J,P,z;const s=p.useRef(null),n=p.useRef(null),[o,r]=p.useState(!1),[a,i]=p.useState(e.content||""),c=p.useRef(0),l=Rn(),d=co(rm),u=om(e.id),{onEditStart:h,onEditEnd:f}=Gs(e.id,"content");p.useEffect(()=>{if(s.current){const U=s.current.getTextArea();U&&(n.current=U)}},[s.current]);const{updateNodeContent:g,updateNode:y,setMode:m}=E.getState(),x=H(U=>U.uiState.nodeToFocusId),w=H(U=>U.uiState.mode),v=H(U=>U.uiState.writeSubMode);H(U=>{var K;return((K=U.uiState.dragInfo)==null?void 0:K.draggedNodeId)===e.id});const b=H(U=>{var K,re;return((re=(K=U.projectCanvas.getActive())==null?void 0:K.coreState.selectedNodes)==null?void 0:re.some(ne=>ne.id===e.id))??!1}),N=H(U=>{var K,re;return((re=(K=U.projectCanvas.getActive())==null?void 0:K.coreState.selectedNodes)==null?void 0:re.length)??0}),j=b&&x===e.id,{fitNodeDimensions:k,setFixedWidth:S}=Xs(),C=U=>{const K=U.target.value,re=(a.match(/\n/g)||[]).length,V=(K.match(/\n/g)||[]).length-re;V>0&&(c.current=Math.max(0,c.current-V)),i(K),g(e.id,K)},R=p.useCallback(U=>{var Y;U.preventDefault();const K=U.clipboardData.getData("text"),re=(Y=s.current)==null?void 0:Y.getTextArea();if(!re)return;const ne=re.selectionStart,V=re.selectionEnd,oe=re.value;if(!oe)return;const le=oe.substring(0,ne)+K+oe.substring(V);re.value=le;const Z=ne+K.length;re.setSelectionRange(Z,Z),i(le),g(e.id,le);const q=se.paste.fixedWidth;setTimeout(()=>{const ae=E.getState().getNodeById(e.id);ae&&S(q,[ae])},10)},[e.id,g,S]),I=p.useCallback(()=>{setTimeout(()=>{const K=E.getState().getNodeById(e.id);K&&k([K])},10)},[e.id,k]),M=p.useCallback(()=>{setTimeout(()=>{const K=E.getState().getNodeById(e.id);K!=null&&K.width&&S(K.width,[K])},10)},[e.id,S]);Xf({textareaRef:n,node:e,updateNode:y,enabled:o,defaultColor:void 0});const W=p.useCallback(U=>{r(U),y(e.id,{isEditing:U})},[y,e.id]),B=p.useCallback(()=>{var U,K;document.querySelector("[data-radix-popper-content-wrapper]")||(c.current=0,g(e.id,a),f(a),W(!1),y(e.id,{isEditing:!1}),(U=window.getSelection())==null||U.removeAllRanges(),(K=e.options)!=null&&K.lockSize||setTimeout(()=>{const ne=E.getState().getNodeById(e.id);ne!=null&&ne.width&&S(ne.width,[ne])},10),Ao.has(e.id)&&gf(e.id))},[e.id,e.width,e.height,(X=e.options)==null?void 0:X.lockSize,g,a,y,S,f]),F=p.useCallback(U=>{var V,oe,le;const K=window.getSelection();K==null||K.rangeCount,(V=K==null?void 0:K.anchorNode)==null||V.nodeName,K==null||K.anchorOffset,(oe=K==null?void 0:K.focusNode)==null||oe.nodeName,K==null||K.focusOffset,K==null||K.isCollapsed,(le=K==null?void 0:K.toString())==null||le.substring(0,30);const ne=U.currentTarget.getBoundingClientRect();U.clientX,U.clientY,Math.round(ne.left),Math.round(ne.top),Math.round(ne.right),Math.round(ne.bottom),U.clientX>=ne.left&&U.clientX<=ne.right&&U.clientY>=ne.top&&U.clientY<=ne.bottom,e.isEditing&&U.shiftKey},[e.isEditing,e.id]),D=p.useCallback(()=>{var K;if(!e.isEditing)return;const U=(K=s.current)==null?void 0:K.getTextArea();U&&U.focus()},[e.isEditing]),L=p.useCallback(U=>{if(!U)return"";if("value"in U&&typeof U.value=="string")return U.value;const K=V=>{let oe="";for(const le of V.childNodes)if(le.nodeType===Node.TEXT_NODE)oe+=le.textContent||"";else if(le.nodeType===Node.ELEMENT_NODE){const Z=le;if(Z.tagName==="BR")oe+=`
`;else if(Z.tagName==="DIV"||Z.tagName==="P"){const q=K(Z);oe+=q+`
`}else oe+=K(Z)}return oe};return K(U).replace(/\n+$/,"")},[]),A=p.useCallback(U=>{var Y,te,ae,ce;if(U.key==="Escape"){B(),W(!1),E.getState().uiState.mode!==Q.VIM&&m(Q.SELECT),(te=(Y=s.current)==null?void 0:Y.getTextArea())==null||te.blur();return}if(U.key==="Enter"&&U.ctrlKey){const ie=(ae=s.current)==null?void 0:ae.getTextArea(),fe=L(ie);g(e.id,fe);return}const K=a;if(U.key==="Enter"){const ie=K.split(`
`),fe=ie[ie.length-1].replace(/\u200B/g,"");/^(\s*)-\s*$/.test(fe)||/^(\s*)(\d+)\.\s*$/.test(fe)?c.current=0:c.current+=1}else c.current=0;const re=le();let ne=Z(K,U.key==="Enter",c.current,re);const V=q(K),oe=(ce=e.options)!=null&&ce.lockSize?e.width:V;if(U.key==="Enter"&&c.current>0){const ie=(e.height??0)+re;ne=Math.max(ne,ie)}y(e.id,{width:oe,height:ne,isEditing:!0});function le(){var fe;const ie=(fe=s.current)==null?void 0:fe.getTextArea();if(ie){const he=window.getComputedStyle(ie).lineHeight;if(he&&he!=="normal"){const ue=parseFloat(he);if(!isNaN(ue))return ue}}return pe.LINE_HEIGHT}function Z(ie,fe=!1,ge=0,he=pe.LINE_HEIGHT){return tm({input:ie,lastKeyWasEnter:fe,pendingNewlines:ge,computedLineHeight:he,currentNodeHeight:e.height??0}).finalHeight}function q(ie,fe=pe.DEFAULT_NODE_WIDTH,ge=Ba.textNodeXPadding){const xe=ie.split(/\n/).map(Ie=>lo(Ie)).reduce((Ie,Ne)=>Math.max(Ie,Ne),0)+ge,me=Math.max(xe,fe);return Math.max(me,e.width??0)}},[B,g,y,e.id,e.width,e.height,(J=e.options)==null?void 0:J.lockSize,a,m]);p.useEffect(()=>{x||W(!1)},[x]),p.useEffect(()=>{!b&&o&&W(!1)},[b,o,W]),p.useEffect(()=>{var ne,V;if(!j)return;const U=!o,K=e.content||"";if(W(!0),i(K),U&&h(K),!U)return;const re=(ne=s.current)==null?void 0:ne.getTextArea();if(re){re.readOnly=!1,re.focus({preventScroll:!0}),re.click();const oe=((V=re.value)==null?void 0:V.length)??0;re.selectionStart=re.selectionEnd=oe}window.setTimeout(()=>{var Z,q;const oe=(Z=s.current)==null?void 0:Z.getTextArea();if(oe&&document.activeElement!==oe){oe.readOnly=!1,oe.focus({preventScroll:!0}),oe.click();const Y=((q=oe.value)==null?void 0:q.length)??0;oe.selectionStart=oe.selectionEnd=Y}},50)},[j,e.content,o,h]),p.useEffect(()=>{var K;const U=(K=s.current)==null?void 0:K.getTextArea();if(U)return U.addEventListener("blur",B),()=>{U.removeEventListener("blur",B)}},[B,e.id,e.width,e.height,(P=e.options)==null?void 0:P.lockSize]),p.useEffect(()=>{i(e.content||"")},[e.content]);const T=p.useCallback(()=>{const K=E.getState().TextModeHandler;if(K){const re=new K;re&&typeof re.onCopy=="function"&&re.onCopy()}},[]),O=p.useCallback(()=>{var K,re;const U=new KeyboardEvent("keydown",{key:"h",ctrlKey:!0,bubbles:!0});(re=(K=s.current)==null?void 0:K.getTextArea())==null||re.dispatchEvent(U)},[]),$=p.useCallback(()=>{var V;const U=(V=s.current)==null?void 0:V.getTextArea();if(!U)return;const K=U.selectionStart,re=U.selectionEnd,ne=a.substring(0,K)+a.substring(re);i(ne),g(e.id,ne),setTimeout(()=>{var oe,le;(le=(oe=s.current)==null?void 0:oe.getTextArea())==null||le.setSelectionRange(K,K)},0)},[a,e.id,g]),_=p.useCallback(()=>{var ne;if(!((ne=s.current)==null?void 0:ne.getTextArea()))return;const K=new Gt,re=new KeyboardEvent("keydown",{key:"!"});K.highlightAndCreateNode(re)},[]),G=p.useCallback(async()=>{var ge,he;const U=(ge=s.current)==null?void 0:ge.getTextArea();if(!U)return;const K=U.selectionStart,re=U.selectionEnd,V=U.value.substring(K,re);if(!V.trim())return;const oe=E.getState(),le="rgb(198, 183, 0)",Z=await Th(V.trim(),"English");let q;if(K!==re){const ue=e.highlights||[],xe=ue.find(me=>me.start===K&&me.end===re);if(xe)q=xe.id;else{q=Math.random().toString(36).slice(2,10);const me={id:q,start:K,end:re,color:le,createdAt:Date.now()},ye=[...ue,me];oe.updateNode(e.id,{highlights:ye})}}const Y=`${V}

${Z.definition}`,te=Le.buildTextNodeV2({content:Y,linkedHighlightId:q,linkedSourceNodeId:e.id}),ae=qc(U,K,re),ce=(he=oe.projectCanvas.getActive())==null?void 0:he.viewState,ie=(ce==null?void 0:ce.scale)??1;let fe=e.y;if(ae){const ue=ae.top/ie;fe=e.y+ue}if(_o(te,{...e,y:fe,id:e.id}),q){const ue=oe.getNodeById(e.id),me=((ue==null?void 0:ue.highlights)||[]).map(ye=>ye.id===q?{...ye,linkedNodeId:te.id}:ye);oe.updateNode(e.id,{highlights:me})}},[e]);return t.jsxs(t.Fragment,{children:[e.linkedHighlightId&&e.linkedSourceNodeId&&b&&N===1&&t.jsx("div",{className:"absolute z-50 cursor-pointer","data-test":`text-node-linked-highlight-indicator-${e.id}`,style:{left:`${(e.width||0)+8}px`,top:"4px"},onClick:U=>{var le;U.stopPropagation();const ne=(((le=E.getState().projectCanvas.getActive())==null?void 0:le.coreState.nodes)??[]).find(Z=>Z.id===e.linkedSourceNodeId);if(!ne)return;const V=(ne.highlights||[]).find(Z=>Z.id===e.linkedHighlightId);let oe;V&&typeof ne.content=="string"&&(oe=Qf(ne.content,V,4,pe.LINE_HEIGHT)),Ln(ne,{duration:400,highlightYOffset:oe})},title:"Navigate to source highlight",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18","data-test":`text-node-linked-highlight-icon-${e.id}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-600 hover:text-yellow-700",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}),t.jsx(sm,{node:e,isEditing:!!o,preventEdit:!1}),u&&!o&&t.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 z-50",title:"Transcription in progress...","data-test":`text-node-transcription-indicator-${e.id}`}),t.jsxs("div",{className:"relative w-full h-full","data-text-position-container":"true","data-test":`text-node-position-container-${e.id}`,children:[!o&&b&&N<=1&&l&&t.jsx("div",{className:"absolute inset-0 z-20 cursor-pointer",onClick:D,onTouchEnd:U=>{U.preventDefault(),D()},"data-text-node-click-overlay":"true","data-test":`text-node-mobile-click-overlay-${e.id}`}),o&&t.jsx(em,{textareaRef:n,onCopy:T,onHighlight:O,onDelete:$,onHighlightAndCreateNode:_,onDefine:G,"data-test":`text-node-selection-popover-${e.id}`}),t.jsx(qf,{text:a,highlights:e.highlights,"data-test":`text-node-highlight-renderer-${e.id}`}),t.jsx(lc,{ref:s,value:a,onChange:C,onPaste:R,onBlur:B,onKeyDown:A,onMouseDown:F,onClick:D,placeholder:am,readOnly:!o,showFilePicker:!1,showAudioButton:o||u,showConfigButton:o||u,audioButtonVariant:"muted",autoStartAudioRecording:j&&w===Q.WRITE&&v===Ws.AUDIO,onAudioTranscriptionComplete:I,audioNodeId:e.id,useMarkdown:!0,showBuiltInPopover:!1,keyboard:d,onModeChange:M,"data-test":`text-node-textarea-${e.id}`,className:Se("relative","m-0 p-1 w-full h-full","min-h-0","resize-none","border","rounded-[3px]",e.className,{"overflow-hidden":!l||!o,"overflow-y-auto":l&&o,"pointer-events-none":!o&&!b||N>1,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!a&&!o},"bg-primary/1"),style:{zIndex:ke.nodeTextarea,textAlign:(z=e.styles)==null?void 0:z.textAlign}})]})]})}),cm=()=>{var a;const e=E.getState(),s=((a=e.projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],n=e.updateNodes,o=p.useMemo(()=>{var i;if(s.length===1)return(i=s[0].styles)==null?void 0:i.textAlign},[s]);return{handleAlignmentChange:p.useCallback(i=>{if(s.length===0)return;const c=s.map(l=>({...l,id:l.id,styles:{...l.styles,textAlign:i}}));n(c)},[s,n]),currentAlignment:o}},qs=p.forwardRef((e,s)=>{const{className:n,children:o}=e;return t.jsx(ee,{ref:s,id:"ConfigurationButton",variant:"secondary",size:"icon","aria-label":"Configuration button",className:`h-6 w-6 p-0.5 rounded hover:bg-secondary/80 flex-shrink-0 flex items-center justify-center ${n||null}`,...e,children:o})});qs.displayName="ConfigurationButton";function lm(e,s,n=!1){let o=null;const r=function(...a){const i=this,c=()=>{o=null,n||e.apply(i,a)},l=n&&!o;o!==null&&clearTimeout(o),o=setTimeout(c,s),l&&e.apply(i,a)};return r.cancel=()=>{o!==null&&(clearTimeout(o),o=null)},r}const dm=se.text.debounceInput,um=e=>{const{className:s,content:n,onValueChange:o}=e,[r,a]=p.useState(n),i=p.useCallback(lm(l=>{o==null||o(l)},dm),[o]),c=l=>{const d=l.target.value;a(d),i(d)};return t.jsx(Qa,{id:"CanvasTextEditor",className:Se("h-[90%]","bg-background",s),style:{fontSize:se.text.fontSize},value:r,onChange:c,"data-test":"canvas-text-editor-textarea"})},wl=e=>{var u;const{className:s}=e,n=E.getState(),o=n.projectCanvas.getActive(),r=o==null?void 0:o.coreState,a=n.updateNodeSubContent,c=((r==null?void 0:r.selectedNodes)??[])[0],l=(u=c==null?void 0:c.content)==null?void 0:u.toString().slice(0,30),d=p.useCallback(h=>{c&&a(c.id,h)},[c,a]);return t.jsxs(dc,{children:[t.jsx(gd,{asChild:!0,children:t.jsx(qs,{id:"CanvasTextEditorButton",className:s,tooltip:"Open Text Editor",variant:"ghost","data-test":"canvas-text-editor-button",children:t.jsx(ju,{})})}),t.jsxs(uc,{id:"canvas-text-editor-dialog",className:"sm:max-w-[70vw] h-[80vh] bg-secondary",style:{display:"unset"},"aria-describedby":"Text editor dialog",children:[t.jsx(hc,{children:t.jsx(pc,{children:l})}),t.jsx(um,{content:c==null?void 0:c.subContent,onValueChange:d})]})]})},hm={width:380,height:500},pm="Presets",gm="No presets yet. Create one from current settings.";function yl({isVisible:e,onClose:s,triggerPosition:n,renderConfigSection:o,getCurrentConfig:r,presetActions:a,onApplyPreset:i,title:c=pm,initialSize:l=hm,emptyMessage:d=gm,headerActions:u}){const[h,f]=p.useState(null),[g,y]=p.useState(""),[m,x]=p.useState(null),[w,v]=p.useState(!1),b=a.getAll(),N=a.getFavoriteIds(),j=a.getActiveId(),k=h?a.getById(h):null,S=m??r(),C=p.useMemo(()=>{const J=b.filter(z=>N.includes(z.id)),P=b.filter(z=>!N.includes(z.id));return[...J,...P]},[b,N]),R=p.useMemo(()=>C.map(J=>({id:J.id,label:J.name,icon:N.includes(J.id)?t.jsx(Es,{className:"h-3 w-3 fill-yellow-400 text-yellow-400"}):void 0,data:J})),[C,N]),I=p.useCallback(J=>{x(P=>({...P??r(),...J}))},[r]),M=p.useCallback(()=>{v(!0),f(null),y("New Preset"),x(r())},[r]),W=p.useCallback(()=>{if(!g.trim()||!m)return;const J=a.create(g.trim(),m);v(!1),y(""),x(null),a.apply(J);const P=a.getById(J);P&&i&&i(P)},[g,m,a,i]),B=p.useCallback(()=>{v(!1),y(""),x(null)},[]),F=p.useCallback(J=>{f(J.id),v(!1),x(J.config)},[]),D=p.useCallback(()=>{!h||!m||(a.updateConfig(h,m),f(null),x(null))},[h,m,a]),L=p.useCallback(()=>{f(null),x(null)},[]),A=p.useCallback(J=>{const P=J.data;a.apply(P.id),i&&i(P)},[a,i]),T=p.useCallback((J,P)=>{a.rename(J,P)},[a]),O=p.useCallback(J=>{a.delete(J),h===J&&(f(null),x(null))},[a,h]),$=p.useCallback(J=>{const P=J.map(z=>z.id);a.reorder(P)},[a]),_=p.useCallback(J=>{const P=J.data;return[{id:"apply-execute",icon:t.jsx(Ze,{className:"h-3 w-3"}),title:"Apply & Execute",onClick:()=>{a.apply(P.id),i&&i(P)}}]},[a,i]),G=p.useCallback(J=>{const P=J.data,z=N.includes(P.id);return[{id:"toggle-favorite",label:z?"Remove from favorites":"Add to favorites",icon:t.jsx(Es,{className:`h-4 w-4 mr-2 ${z?"fill-yellow-400 text-yellow-400":""}`}),onClick:()=>a.toggleFavorite(P.id)},{id:"rename",label:"Rename",icon:t.jsx(Hs,{className:"h-4 w-4 mr-2"}),onClick:()=>{const U=window.prompt("Rename preset:",P.name);U&&U.trim()&&U!==P.name&&a.rename(P.id,U.trim())}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Mt,{className:"h-4 w-4 mr-2"}),onClick:()=>a.duplicate(P.id)},{id:"edit-settings",label:"Edit settings",icon:t.jsx(kc,{className:"h-4 w-4 mr-2"}),onClick:()=>F(P)}]},[N,a,F]),X=w||h!==null;return t.jsx(Be,{isVisible:e,onClose:s,title:c,triggerPosition:n,initialSize:l,resizable:!0,shouldCloseManually:!0,headerActions:u,children:t.jsxs("div",{className:"flex flex-col h-full overflow-hidden","data-test":"preset-manager-popover",children:[t.jsx("div",{className:"px-3 py-2 border-b border-border","data-test":"preset-create-section",children:w?t.jsx("div",{className:"space-y-2","data-test":"preset-create-form",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx(Ae,{value:g,onChange:J=>y(J.target.value),placeholder:"Preset name",className:"flex-1 h-8 text-sm",autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(ee,{size:"sm",onClick:W,disabled:!g.trim(),"data-test":"preset-save-button",children:"Save"}),t.jsx(ee,{size:"sm",variant:"ghost",onClick:B,"data-test":"preset-cancel-button",children:"Cancel"})]})}):k?t.jsx("div",{className:"space-y-2","data-test":"preset-edit-form",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-sm font-medium truncate",children:["Editing: ",k.name]}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx(ee,{size:"sm",onClick:D,"data-test":"preset-update-button",children:"Update"}),t.jsx(ee,{size:"sm",variant:"ghost",onClick:L,"data-test":"preset-cancel-edit-button",children:"Cancel"})]})]})}):t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:M,"data-test":"preset-create-button",children:[t.jsx(wt,{className:"h-4 w-4 mr-2"}),"New from current settings"]})}),X&&t.jsx("div",{className:"px-3 py-2 border-b border-border overflow-auto max-h-[75%] shrink-0","data-test":"preset-config-section",children:o({currentConfig:S,onConfigChange:I,isEditingPreset:h!==null,editingPresetName:k==null?void 0:k.name})}),t.jsx("div",{className:"flex-1 overflow-auto px-1 py-2","data-test":"preset-list-section",children:R.length===0?t.jsx("div",{className:"text-center text-muted-foreground text-sm py-8 px-4","data-test":"preset-empty-message",children:d}):t.jsx(_s,{data:R,selectedId:j,onItemClick:A,onUpdate:T,onDelete:O,onReorder:$,quickActions:_,moreOptionsItems:G,dropdownZIndex:ke.draggablePopoverDropdown,enableEdit:!1,enableDelete:!0,enableDrag:!0,deleteConfirmMessage:J=>`Delete preset "${J.label}"? This cannot be undone.`})})]})})}const{animation:ri}=se,fm=(e=!1,s=!0,n=!1,o=20)=>{const{fitAndRepositionNodes:r}=Xs(),a=p.useCallback(g=>{const y=E.getState(),m=y.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],w=y.addNode,v=y.deleteSelectedNodes,b=y.setSelectedNodes,N=y.updateNodes,j=y.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const k=x[0];if(!k.content||typeof k.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}const S=g==="paragraph"?/(\n\n)/:g==="line"?/(\n)/:g==="comma"?/(,)/:g==="period"?/(\.)/:g==="whitespace"?/(\s+)/:new RegExp(`([${pe.CUSTOM_CHARACTERS.join("")}])`),C=k.content.split(S),R=[];for(let T=0;T<C.length;T+=2){const O=C[T],$=C[T+1];(O||$)&&R.push(s?(O||"")+($||""):O||"")}if(R.length===0){console.warn("useNodeSplitter: No segments found after split.");return}if(R.length===1&&R[0]===k.content){console.warn(`useNodeSplitter: No ${g==="paragraph"?"double newline":g==="line"?"single newline":g==="comma"?"comma":g==="period"?"period":g==="whitespace"?"whitespace":"custom character"} found to split content. Original node not modified.`);return}const I=k.x,M=k.y;k.width;const W=k.id;e||v();let B=n?I:M,F=0;const D=[],L=new Map;let A=n?I:M;R.forEach((T,O)=>{const $=g==="comma"||g==="paragraph"||g==="period"||g==="custom"||g==="whitespace"?T.trim():T;if((g==="paragraph"||g==="comma"||g==="period"||g==="custom"||g==="whitespace")&&$===""&&R.length>1)return;const _=Math.min(Ls($),se.nodeOptions.maxNodeWidth)+pe.NODE_X_PADDING*2,G=ct($,{containerWidth:_})+pe.NODE_Y_PADDING*2;let X,J;if(n?(J=M,O===0?X=I:X=B+F+o):(X=I,O===0?J=M:J=B+F+o),e&&O===0){N([{id:W,content:$,width:_,height:G}]),B=n?X:J,F=n?_:G,A=(n?X+_:J+G)+o;return}const P=W+"-split-"+O,z=Le.buildTextNodeV2({...k,id:P,title:"",x:I,y:M,width:_,height:G,content:$});L.set(P,{x:X,y:J}),w(z),D.push(z),e&&j({id:Re(10),startNodeId:W,endNodeId:z.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),B=n?X:J,F=n?_:G}),D.length>0&&(b(D),setTimeout(()=>{const O=E.getState().updateNodes,$=[];L.forEach((_,G)=>{$.push({id:G,x:_.x,y:_.y})}),$.length>0&&O($),n||r(D,A,o)},ri.splitDelayMs))},[r,e,s,n,o]),i=p.useCallback(()=>{a("paragraph")},[a]),c=p.useCallback(()=>{a("line")},[a]),l=p.useCallback(()=>{a("comma")},[a]),d=p.useCallback(()=>{a("period")},[a]),u=p.useCallback(()=>{a("custom")},[a]),h=p.useCallback(()=>{a("whitespace")},[a]),f=p.useCallback(g=>{const y=E.getState(),m=y.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],w=y.addNode,v=y.deleteSelectedNodes,b=y.setSelectedNodes,N=y.updateNodes,j=y.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const k=x[0];if(!k.content||typeof k.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}let S;try{S=new RegExp(`(${g})`,"g")}catch(T){console.error("useNodeSplitter: Invalid regex pattern",T);return}const C=k.content.split(S),R=[];for(let T=0;T<C.length;T+=2){const O=C[T]||"",$=C[T+1]||"",_=s?(O+$).trim():O.trim();_&&R.push(_)}if(R.length===0){console.warn("useNodeSplitter: No segments found with regex pattern.");return}if(R.length===1&&R[0]===k.content.trim()){console.warn("useNodeSplitter: Regex pattern did not match content.");return}const I=k.x,M=k.y,W=k.id;e||v();let B=n?I:M,F=0;const D=[],L=new Map;let A=n?I:M;R.forEach((T,O)=>{if(T==="")return;const $=Math.min(Ls(T),se.nodeOptions.maxNodeWidth)+pe.NODE_X_PADDING*2,_=ct(T,{containerWidth:$})+pe.NODE_Y_PADDING*2;let G,X;if(n?(X=M,O===0?G=I:G=B+F+o):(G=I,O===0?X=M:X=B+F+o),e&&O===0){N([{id:W,content:T,width:$,height:_}]),B=n?G:X,F=n?$:_,A=(n?G+$:X+_)+o;return}const J=W+"-split-"+O,P=Le.buildTextNodeV2({...k,id:J,title:"",x:I,y:M,width:$,height:_,content:T});L.set(J,{x:G,y:X}),w(P),D.push(P),e&&j({id:Re(10),startNodeId:W,endNodeId:P.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),B=n?G:X,F=n?$:_}),D.length>0&&(b(D),setTimeout(()=>{const O=E.getState().updateNodes,$=[];L.forEach((_,G)=>{$.push({id:G,x:_.x,y:_.y})}),$.length>0&&O($),n||r(D,A,o)},ri.splitDelayMs))},[e,s,n,o,r]);return{splitNodeContentByParagraph:i,splitNodeContentByLine:c,splitNodeContentByComma:l,splitNodeContentByPeriod:d,splitNodeContentByCustomCharacter:u,splitNodeContentByWhitespace:h,splitNodeContentByRegex:f}};function mm(e){return!e||e.trim()===""?0:e.trim().split(/\s+/).filter(s=>s.length>0).length}const xm=[".","!","?",":",";"],wm=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","Ph.D","M.D","B.A","M.A","B.S","M.S","Inc","Ltd","Co","Corp","etc","vs","e.g","i.e","a.m","p.m","St","Ave","Blvd","Rd","vol","no"];function ym(e,s){if(s<=0||s>=e.length-1)return!1;let n=s-1;for(;n>=0&&/[a-zA-Z.]/.test(e[n]);)n--;n++;const o=e.substring(n,s);return!!(wm.includes(o)||o.length===1&&/[A-Z]/.test(o)||s>1&&e[s-2]===".")}function vm(e,s){const n=[".","!","?",","];let o=e.length;for(const r of n){const a=e.indexOf(r,s);a!==-1&&a<o&&(o=a)}return o}function bm(e,s){const n=[];for(let r=0;r<e.length;r++)e[r]===","&&n.push(r);const o=[];for(let r=0;r<n.length;r++){const a=n[r],i=vm(e,a+1),c=e.substring(a+1,i).trim();mm(c)>=s&&o.push(a)}return o}function ii(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(xm.includes(o)){if(o==="."&&ym(e,n)){s+=o,n++;continue}for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}function ci(e,s=3){if(!e)return e;const n=bm(e,s);if(n.length===0)return e;let o=e;for(let r=n.length-1;r>=0;r--){const a=n[r];let i=a+1;for(;i<o.length&&o[i]===" ";)i++;o=o.substring(0,a+1)+`
`+o.substring(i)}return o}const Nm=["&",";","-",":"];function li(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(Nm.includes(o)){for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}const Sm=()=>{const e=p.useCallback((a,i=3)=>{const c=E.getState(),l=c.projectCanvas.getActive(),d=(l==null?void 0:l.coreState.selectedNodes)??[],u=c.updateNodeContent;if(d.length===0){console.warn("useNodeInsideSplitter: No nodes selected.");return}d.forEach(h=>{if(!h.content||typeof h.content!="string"){console.warn(`useNodeInsideSplitter: Node ${h.id} has no content to split.`);return}let f;if(a==="sentence")f=ii(h.content);else if(a==="smartComma")f=ci(h.content,i);else if(a==="smartCharacter")f=li(h.content);else if(a==="all")f=ii(h.content),f=ci(f,i),f=li(f);else{console.warn(`useNodeInsideSplitter: Unknown mode "${a}"`);return}if(f===h.content){console.warn(`useNodeInsideSplitter: No ${a==="sentence"?"sentence endings":"qualifying commas"} found in node ${h.id}. Content not modified.`);return}u(h.id,f);const g=c.getSegmentedButtonAction("canvas-fit-width");let y=null;if(g){const v=g.match(/Set width to (\d+)px/);v&&(y=parseInt(v[1],10))}let m,x,w;if(y)x=ct(f,{containerWidth:y})+pe.NODE_Y_PADDING*2,m=y,w=!0;else{const v=document.querySelector("textarea[data-node-textarea]");v&&window.getComputedStyle(v).lineHeight;const b=gs(f);m=b.width,x=b.height,w=!1}c.updateNode(h.id,{content:f,width:m,height:x,options:{...h.options,lockSize:w}})})},[]),s=p.useCallback(()=>{e("sentence")},[e]),n=p.useCallback((a=3)=>{e("smartComma",a)},[e]),o=p.useCallback(()=>{e("smartCharacter")},[e]),r=p.useCallback((a=3)=>{e("all",a)},[e]);return{splitInsideBySentence:s,splitInsideBySmartComma:n,splitInsideBySmartCharacter:o,splitInsideByAll:r}};function Cm({action:e,mode:s,isSelected:n,onSelect:o,onSplitRegex:r,selectedNodeContent:a}){const[i,c]=p.useState(""),[l,d]=p.useState([]),u=s==="record",h=g=>{if(c(g),g&&a)try{const y=new RegExp(g,"g"),m=a.match(y)||[];d(m.slice(0,3))}catch{d([])}else d([])},f=()=>{i&&(u?o(e.id,{pattern:i}):r(i))};return t.jsxs("div",{"data-test":"regex-action-section",children:[t.jsx("div",{className:we("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",u&&n&&"bg-primary/10 border border-primary",!u&&"hover:bg-accent"),"data-test":"regex-action-row",children:t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]})}),t.jsxs("div",{className:"px-3 py-1.5 space-y-1","data-test":"regex-input-section",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ae,{type:"text",value:i,onChange:g=>h(g.target.value),placeholder:"Enter regex pattern...",className:"h-6 text-xs flex-1",onClick:g=>g.stopPropagation(),"data-test":"regex-pattern-input"}),t.jsx(ee,{size:"sm",variant:"secondary",className:"h-6 text-xs px-2",onClick:g=>{g.stopPropagation(),f()},disabled:!i,"data-test":"regex-split-button",children:"Split"})]}),l.length>0&&t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:["Matches: ",l.map(g=>`"${g}"`).join(", "),l.length===3&&"..."]})]})]})}function jm({action:e,mode:s,isSelected:n,onSelect:o,onSplitSmartComma:r}){const[a,i]=p.useState(3),c=s==="record",l=()=>{c?o(e.id,{minWords:a}):r(a)};return t.jsxs("div",{"data-test":"smart-comma-action-section",className:"px-3 py-1.5",children:[t.jsxs("div",{className:we("flex items-center gap-2 text-sm",c&&n&&"text-primary"),"data-test":"smart-comma-action-row",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 mt-1",onPointerDown:d=>d.stopPropagation(),children:[t.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Min words:"}),t.jsx(Ae,{type:"number",min:"1",max:"20",value:a,onChange:d=>i(Math.max(1,parseInt(d.target.value)||3)),className:"h-5 w-10 text-xs px-1",onClick:d=>d.stopPropagation(),"data-test":"smart-comma-min-words-input"}),t.jsx(ee,{size:"sm",variant:"secondary",className:"h-5 text-[10px] px-2",onClick:d=>{d.stopPropagation(),l()},"data-test":"smart-comma-split-button",children:"Split"})]})]})}class km{constructor(s,n,o=""){Oe(this,"namespace","canvas.split");this.hooks=s,this.storeActions=n,this.selectedNodeContent=o}getActions(){return[{id:"byParagraph",label:"Paragraph",category:"Node Split",icon:t.jsx(ku,{className:"h-3.5 w-3.5"})},{id:"byLine",label:"Line",category:"Node Split",icon:t.jsx(Ua,{className:"h-3.5 w-3.5"})},{id:"byComma",label:"Comma",category:"Node Split",icon:t.jsx(Au,{className:"h-3.5 w-3.5"})},{id:"byPeriod",label:"Period",category:"Node Split",icon:t.jsx(Iu,{className:"h-3.5 w-3.5"})},{id:"bySpecial",label:"Special",category:"Node Split",icon:t.jsx(bn,{className:"h-3.5 w-3.5"})},{id:"byWhitespace",label:"Whitespace",category:"Node Split",icon:t.jsx(Tu,{className:"h-3.5 w-3.5"})},{id:"byRegex",label:"Regex",category:"Node Split",icon:t.jsx(Eu,{className:"h-3.5 w-3.5"}),params:[{name:"pattern",type:"string",label:"Regex Pattern",default:""}],customRender:s=>t.jsx(Cm,{...s,onSplitRegex:this.hooks.splitByRegex,selectedNodeContent:this.selectedNodeContent})},{id:"textBySentence",label:"Sentence",category:"Text Split",icon:t.jsx(Ru,{className:"h-3.5 w-3.5"})},{id:"textBySmartComma",label:"Smart Comma",category:"Text Split",icon:t.jsx(Mu,{className:"h-3.5 w-3.5"}),params:[{name:"minWords",type:"number",label:"Minimum Words",default:3}],customRender:s=>t.jsx(jm,{...s,onSplitSmartComma:this.hooks.textSplitBySmartComma})},{id:"textBySmartChar",label:"Smart Char",category:"Text Split",icon:t.jsx(Pu,{className:"h-3.5 w-3.5"})},{id:"textByAll",label:"All",category:"Text Split",icon:t.jsx(Pn,{className:"h-3.5 w-3.5"})}]}getConfig(){return{keepArrows:this.storeActions.getKeepArrows(),keepMatch:this.storeActions.getKeepMatch(),horizontal:this.storeActions.getHorizontal(),gap:this.storeActions.getGap()}}setConfig(s){s.keepArrows!==void 0&&this.storeActions.setKeepArrows(s.keepArrows),s.keepMatch!==void 0&&this.storeActions.setKeepMatch(s.keepMatch),s.horizontal!==void 0&&this.storeActions.setHorizontal(s.horizontal),s.gap!==void 0&&this.storeActions.setGap(s.gap)}execute(s,n){switch(s){case"byParagraph":this.hooks.splitByParagraph();break;case"byLine":this.hooks.splitByLine();break;case"byComma":this.hooks.splitByComma();break;case"byPeriod":this.hooks.splitByPeriod();break;case"byWhitespace":this.hooks.splitByWhitespace();break;case"bySpecial":this.hooks.splitBySpecial();break;case"byRegex":n!=null&&n.pattern&&this.hooks.splitByRegex(n.pattern);break;case"textBySentence":this.hooks.textSplitBySentence();break;case"textBySmartComma":this.hooks.textSplitBySmartComma((n==null?void 0:n.minWords)??3);break;case"textBySmartChar":this.hooks.textSplitBySmartChar();break;case"textByAll":this.hooks.textSplitByAll(3);break;default:console.warn(`Unknown split action: ${s}`)}}}class Am{constructor(){Oe(this,"sources",new Map)}register(s,n){this.sources.set(s,n)}unregister(s){this.sources.delete(s)}has(s){return this.sources.has(s)}getAllActions(){return Array.from(this.sources.values()).map(s=>({source:s.name,actions:s.getActions()}))}get size(){return this.sources.size}getKeys(){return Array.from(this.sources.keys())}}const st=new Am;function vl(){const e=H(w=>{var v;return((v=w.preferences)==null?void 0:v.keepArrowsOnSplit)??!1}),s=H(w=>{var v;return((v=w.preferences)==null?void 0:v.keepSplitMatch)??!1}),n=H(w=>{var v;return((v=w.preferences)==null?void 0:v.splitHorizontally)??!1}),o=H(w=>{var v;return((v=w.preferences)==null?void 0:v.splitNodeGap)??15}),r=H(w=>w.setKeepArrowsOnSplit),a=H(w=>w.setKeepSplitMatch),i=H(w=>w.setSplitHorizontally),c=H(w=>w.setSplitNodeGap),l=fm(e,s,n,o),d=Sm(),h=E.getState().projectCanvas.getActive(),f=(h==null?void 0:h.coreState.selectedNodes)??[],g=f.length===1&&typeof f[0].content=="string"?f[0].content:"",y=p.useMemo(()=>({splitByParagraph:l.splitNodeContentByParagraph,splitByLine:l.splitNodeContentByLine,splitByComma:l.splitNodeContentByComma,splitByPeriod:l.splitNodeContentByPeriod,splitByWhitespace:l.splitNodeContentByWhitespace,splitBySpecial:l.splitNodeContentByCustomCharacter,splitByRegex:l.splitNodeContentByRegex,textSplitBySentence:d.splitInsideBySentence,textSplitBySmartComma:d.splitInsideBySmartComma,textSplitBySmartChar:d.splitInsideBySmartCharacter,textSplitByAll:d.splitInsideByAll}),[l.splitNodeContentByParagraph,l.splitNodeContentByLine,l.splitNodeContentByComma,l.splitNodeContentByPeriod,l.splitNodeContentByWhitespace,l.splitNodeContentByCustomCharacter,l.splitNodeContentByRegex,d.splitInsideBySentence,d.splitInsideBySmartComma,d.splitInsideBySmartCharacter,d.splitInsideByAll]),m=p.useMemo(()=>({getKeepArrows:()=>{var w;return((w=E.getState().preferences)==null?void 0:w.keepArrowsOnSplit)??!1},setKeepArrows:r,getKeepMatch:()=>{var w;return((w=E.getState().preferences)==null?void 0:w.keepSplitMatch)??!1},setKeepMatch:a,getHorizontal:()=>{var w;return((w=E.getState().preferences)==null?void 0:w.splitHorizontally)??!1},setHorizontal:i,getGap:()=>{var w;return((w=E.getState().preferences)==null?void 0:w.splitNodeGap)??15},setGap:c}),[r,a,i,c]),x=p.useMemo(()=>new km(y,m,g),[y,m,g]);return p.useEffect(()=>(st.register("split",{name:"Split",getActions:()=>x.getActions()}),tt.register("split",x),()=>{st.unregister("split"),tt.unregister("split")}),[x]),x}function Im({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a}){const i=s==="record",c=e.subActions&&e.subActions.length>0;return t.jsxs("div",{className:we("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",i&&n&&"bg-primary/10 border border-primary",!i&&"hover:bg-accent"),"data-test":`action-row-${e.id}`,children:[t.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>o(e.id),"data-test":`action-button-${e.id}`,children:[e.icon,t.jsx("span",{children:e.label})]}),c&&t.jsx("div",{className:"flex items-center gap-0.5 ml-2",children:e.subActions.map(l=>t.jsx(ee,{variant:"outline",size:"icon",className:we("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",i&&n&&l.id===e.id&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),o(l.id)},title:l.title,"data-test":`sub-action-${l.id}`,children:l.icon},l.id))})]})}function Mo({facade:e,mode:s,selectedActionId:n,selectedActionParams:o,onActionSelect:r,onActionExecuted:a,showConfig:i=!1,configOverride:c,onConfigChange:l,categories:d,className:u}){const h=e.getActions(),f=d?h.filter(b=>d.includes(b.category||"Other")):h,g=e.getConfig(),y=c??g,m=(b,N)=>{var j,k;if(s==="execute"){if(e.execute(b,N),a){const S=f.find(R=>{var I;return R.id===b||((I=R.subActions)==null?void 0:I.some(M=>M.id===b))}),C=((k=(j=S==null?void 0:S.subActions)==null?void 0:j.find(R=>R.id===b))==null?void 0:k.title)??(S==null?void 0:S.label)??b;a(C,()=>e.execute(b,N))}}else r==null||r(b,N)},x=b=>{l?l(b):e.setConfig(b)},w=f.reduce((b,N)=>{const j=N.category||"Other";return b[j]||(b[j]=[]),b[j].push(N),b},{}),v=Object.keys(w);return t.jsx("div",{className:we("flex flex-col",u),"data-test":"toolbar-actions-panel",children:v.map((b,N)=>t.jsxs("div",{"data-test":`action-category-${b.toLowerCase().replace(/\s+/g,"-")}`,children:[N>0&&t.jsx("div",{className:"h-px bg-border my-1"}),v.length>1&&t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:b}),w[b].map(j=>{var S;const k=n===j.id||(((S=j.subActions)==null?void 0:S.some(C=>C.id===n))??!1);return j.customRender?t.jsx(Ce.Fragment,{children:j.customRender({action:j,mode:s,isSelected:k,onSelect:m,config:y,onConfigChange:x})},j.id):t.jsx(Im,{action:j,mode:s,isSelected:k,onSelect:m,config:y,onConfigChange:x},j.id)})]},b))})}const Tm=[],Em=[];function Rm({currentConfig:e,onConfigChange:s,facade:n,onExecuteSplit:o,canExecute:r}){const a=p.useCallback((l,d)=>{const h={byParagraph:"paragraph",byLine:"line",byComma:"comma",byPeriod:"period",bySpecial:"custom",byWhitespace:"whitespace",byRegex:"regex"}[l];h&&(s({splitMode:h}),d!=null&&d.pattern&&s({regexPattern:d.pattern}))},[s]),i=p.useMemo(()=>({keepArrows:e.keepArrowsOnSplit,keepMatch:e.keepSplitMatch,horizontal:e.splitHorizontally,gap:e.splitNodeGap}),[e]),c={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex"};return t.jsxs("div",{className:"space-y-2","data-test":"split-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"split-action-selector",children:t.jsx(Mo,{facade:n,mode:"record",selectedActionId:c[e.splitMode],onActionSelect:a,configOverride:i,onConfigChange:l=>{l.keepArrows!==void 0&&s({keepArrowsOnSplit:l.keepArrows}),l.keepMatch!==void 0&&s({keepSplitMatch:l.keepMatch}),l.horizontal!==void 0&&s({splitHorizontally:l.horizontal}),l.gap!==void 0&&s({splitNodeGap:l.gap})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepArrowsOnSplit,onChange:l=>s({keepArrowsOnSplit:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Arrows"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepSplitMatch,onChange:l=>s({keepSplitMatch:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Match"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.splitHorizontally,onChange:l=>s({splitHorizontally:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Horiz"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Gap:"}),t.jsx(Ae,{type:"number",min:"0",max:"100",value:e.splitNodeGap,onChange:l=>s({splitNodeGap:Math.max(0,parseInt(l.target.value)||15)}),className:"h-5 w-12 text-[10px] px-1","data-test":"split-config-gap"})]})]}),t.jsxs(ee,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(c[e.splitMode]),disabled:!r,"data-test":"split-execute-button",children:[t.jsx(Ze,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function Mm({isVisible:e,onClose:s,triggerPosition:n,currentSplitMode:o,currentRegexPattern:r,onSplitAction:a}){const i=vl(),c=p.useCallback(L=>{var A,T;return((T=(A=L.preferences)==null?void 0:A.splitPresets)==null?void 0:T.presets)??Tm},[]),l=H(c),d=H(L=>{var A,T;return((T=(A=L.preferences)==null?void 0:A.splitPresets)==null?void 0:T.favoriteIds)??Em}),u=H(L=>{var A,T;return((T=(A=L.preferences)==null?void 0:A.splitPresets)==null?void 0:T.activePresetId)??null}),h=H(L=>{var A;return((A=L.preferences)==null?void 0:A.keepArrowsOnSplit)??!1}),f=H(L=>{var A;return((A=L.preferences)==null?void 0:A.keepSplitMatch)??!1}),g=H(L=>{var A;return((A=L.preferences)==null?void 0:A.splitHorizontally)??!1}),y=H(L=>{var A;return((A=L.preferences)==null?void 0:A.splitNodeGap)??15}),m=H(L=>L.setKeepArrowsOnSplit),x=H(L=>L.setKeepSplitMatch),w=H(L=>L.setSplitHorizontally),v=H(L=>L.setSplitNodeGap),b=H(L=>L.createSplitPreset),N=H(L=>L.updateSplitPreset),j=H(L=>L.duplicateSplitPreset),k=H(L=>L.deleteSplitPreset),S=H(L=>L.renameSplitPreset),C=H(L=>L.applySplitPreset),R=H(L=>L.toggleSplitPresetFavorite),I=H(L=>L.setActiveSplitPresetId),M=p.useMemo(()=>({getAll:()=>l,getById:L=>l.find(A=>A.id===L),getFavorites:()=>l.filter(L=>d.includes(L.id)),getFavoriteIds:()=>d,getActiveId:()=>u,create:(L,A)=>b(L,A),update:(L,A)=>{N(L,A)},updateConfig:(L,A)=>{const T=l.find(O=>O.id===L);T&&N(L,{config:{...T.config,...A}})},duplicate:L=>j(L),delete:L=>{k(L)},rename:(L,A)=>{S(L,A)},reorder:L=>{},apply:L=>{C(L)},setActive:L=>{I(L)},toggleFavorite:L=>{R(L)},isFavorite:L=>d.includes(L)}),[l,d,u,b,N,j,k,S,C,I,R]),W=p.useCallback(()=>({splitMode:o,regexPattern:o==="regex"?r:void 0,keepArrowsOnSplit:h,keepSplitMatch:f,splitHorizontally:g,splitNodeGap:y}),[o,r,h,f,g,y]),B=p.useCallback(L=>{a&&(a(L),ve.success("Executed split action"))},[a]),F=p.useCallback(L=>{a?(requestAnimationFrame(()=>{a(L.config.splitMode)}),ve.success(`Applied and executed "${L.name}" (${L.config.splitMode})`)):ve.success(`Applied preset "${L.name}" settings`)},[a]),D=p.useCallback(L=>{const A=T=>{L.onConfigChange(T),T.keepArrowsOnSplit!==void 0&&m(T.keepArrowsOnSplit),T.keepSplitMatch!==void 0&&x(T.keepSplitMatch),T.splitHorizontally!==void 0&&w(T.splitHorizontally),T.splitNodeGap!==void 0&&v(T.splitNodeGap)};return t.jsx(Rm,{...L,onConfigChange:A,facade:i,onExecuteSplit:B,canExecute:!!a})},[i,B,a,m,x,w,v]);return t.jsx(yl,{isVisible:e,onClose:s,triggerPosition:n,title:"Split Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:D,getCurrentConfig:W,presetActions:M,onApplyPreset:F})}const di="canvas-split-regex-history",ui="canvas-split-before-enabled",Pm=10,Dm=({onSplit:e,selectedNodeContent:s=""})=>{const n=p.useCallback(()=>{try{const m=localStorage.getItem(di);return m?JSON.parse(m):[]}catch{return[]}},[]),[o,r]=p.useState(()=>n()[0]||""),[a,i]=p.useState(()=>{try{return localStorage.getItem(ui)==="true"}catch{return!1}}),[c,l]=p.useState(null),[d,u]=p.useState(0);p.useEffect(()=>{try{localStorage.setItem(ui,String(a))}catch(m){console.warn("Failed to save split before preference",m)}},[a]);const h=p.useCallback((m,x)=>m?x?`\\n(?=${m})`:m:"",[]),f=p.useCallback(m=>{if(!m)return;const w=n().filter(b=>b!==m),v=[m,...w].slice(0,Pm);try{localStorage.setItem(di,JSON.stringify(v))}catch(b){console.warn("Failed to save regex history",b)}},[n]);p.useEffect(()=>{if(!o){l(null),u(0);return}try{const m=h(o,a),x=new RegExp(`(${m})`,"g");if(l(!0),s){const w=s.match(x);u(w?w.length:0)}else u(0)}catch{l(!1),u(0)}},[o,s,a,h]);const g=p.useCallback(()=>{if(!o||!c)return;f(o);const m=h(o,a);e(m)},[o,c,e,f,a,h]),y=p.useCallback(m=>{m.key==="Enter"&&(m.preventDefault(),m.stopPropagation(),g())},[g]);return t.jsxs("div",{className:"regex-split-item px-1 py-1 space-y-0.5",onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsx("span",{className:"text-xs text-foreground",children:"Regex"}),t.jsx("button",{onPointerDown:m=>{m.stopPropagation(),g()},disabled:!c,className:we("p-0.5 rounded transition-colors",c?"hover:bg-accent text-accent-foreground cursor-pointer":"opacity-50 cursor-not-allowed"),title:"Execute split",style:{touchAction:"none"},"data-test":"regex-split-execute-button",children:t.jsx(Ze,{className:"h-2.5 w-2.5"})})]}),t.jsxs("div",{className:"relative px-1",children:[t.jsx("input",{type:"text",value:o,onChange:m=>r(m.target.value),onKeyDown:y,placeholder:"Art \\d+",className:we("w-full px-1.5 py-0.5 text-[10px] border rounded h-5","bg-background text-foreground","focus:outline-none focus:ring-1 focus:ring-primary",c===!1&&"border-destructive focus:ring-destructive",c===!0&&"border-green-500 focus:ring-green-500"),onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"auto"},"data-test":"regex-split-pattern-input"}),t.jsxs("div",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none",children:[c===!0&&t.jsx(Bs,{className:"h-2 w-2 text-green-500"}),c===!1&&t.jsx(mo,{className:"h-2 w-2 text-destructive"})]})]}),t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsxs("label",{className:"flex items-center gap-1 text-[9px] cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:m=>i(m.target.checked),className:"w-2 h-2 cursor-pointer",onPointerDown:m=>{m.stopPropagation()},"data-test":"regex-split-before-checkbox"}),t.jsx("span",{className:"text-muted-foreground",children:"Before"})]}),c&&d>0&&t.jsx("span",{className:"text-[9px] text-muted-foreground",children:d}),c===!1&&o&&t.jsx("span",{className:"text-[9px] text-destructive",children:"!"})]})]})},Om=[],Lm=[],Wm=e=>{const{className:s}=e,n=vl(),o=H(A=>{var T;return((T=A.preferences)==null?void 0:T.keepArrowsOnSplit)??!1}),r=H(A=>A.setKeepArrowsOnSplit),a=H(A=>{var T;return((T=A.preferences)==null?void 0:T.keepSplitMatch)??!1}),i=H(A=>A.setKeepSplitMatch),c=H(A=>{var T;return((T=A.preferences)==null?void 0:T.splitHorizontally)??!1}),l=H(A=>A.setSplitHorizontally),d=H(A=>{var T;return((T=A.preferences)==null?void 0:T.splitNodeGap)??15}),u=H(A=>A.setSplitNodeGap),h=H(A=>{var T,O;return((O=(T=A.preferences)==null?void 0:T.splitPresets)==null?void 0:O.presets)??Om}),f=H(A=>{var T,O;return((O=(T=A.preferences)==null?void 0:T.splitPresets)==null?void 0:O.favoriteIds)??Lm}),g=H(A=>A.applySplitPreset),y=p.useMemo(()=>h.filter(A=>f.includes(A.id)),[h,f]),[m,x]=p.useState(!1),[w,v]=p.useState(),b=p.useRef(null),N=p.useCallback(()=>{if(b.current){const A=b.current.getBoundingClientRect();v({x:A.left,y:A.bottom+4})}x(!0)},[]),j=p.useCallback(()=>{x(!1)},[]),k=p.useCallback(A=>{const O={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex","text:sentence":"textBySentence","text:smartComma":"textBySmartComma","text:smartChar":"textBySmartChar","text:all":"textByAll"}[A]||A;n.execute(O)},[n]),S=p.useCallback(A=>{const T=h.find(O=>O.name===A);return T?()=>{g(T.id),k(T.config.splitMode)}:null},[h,g,k]),R=E.getState().projectCanvas.getActive(),I=(R==null?void 0:R.coreState.selectedNodes)??[],M=I.length===1&&typeof I[0].content=="string"?I[0].content:"",W=n.getActions(),B=W.filter(A=>A.category==="Node Split"&&A.id!=="byRegex"),F=W.filter(A=>A.category==="Text Split"),D=[{header:"Node",width:"150px",actions:[...B.map(A=>({label:A.label,icon:A.icon,onClick:()=>n.execute(A.id)})),{label:"Regex",customRender:()=>t.jsx(Dm,{onSplit:A=>n.execute("byRegex",{pattern:A}),selectedNodeContent:M})}]},{header:"Text",width:"150px",actions:F.map(A=>A.customRender?{label:A.label,customRender:()=>A.customRender({action:A,mode:"execute",isSelected:!1,onSelect:(T,O)=>n.execute(T,O),config:{},onConfigChange:()=>{}})}:{label:A.label,icon:A.icon,onClick:()=>n.execute(A.id)})},{header:"Config",width:"150px",actions:[{label:"Presets",customRender:({registerRepeatAction:A})=>t.jsxs("div",{"data-test":"split-presets-section",className:"mt-1 pt-1",children:[t.jsxs("button",{ref:b,className:"flex items-center gap-2 w-full px-1 py-1 text-sm rounded-sm hover:bg-accent text-left",onClick:N,"data-test":"split-presets-button",children:[t.jsx(Va,{className:"h-3 w-3"}),t.jsx("span",{className:"text-xs",children:"Presets"})]}),y.length>0&&t.jsxs("div",{className:"px-1 py-1","data-test":"split-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"split-favorite-presets-grid",children:y.map(T=>t.jsxs(ee,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:O=>{O.stopPropagation(),g(T.id),k(T.config.splitMode),A(T.name,()=>{g(T.id),k(T.config.splitMode)})},title:`Apply & Execute: ${T.name}`,"data-test":`split-favorite-preset-${T.id}`,children:[t.jsx(Ze,{className:"h-2 w-2 mr-1"}),T.name]},T.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},{label:"Keep arrows",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:A=>r(A.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-[10px]",children:"Keep arrows"})]})},{label:"Keep match",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:A=>i(A.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-[10px]",children:"Keep match"})]})},{label:"Horizontal",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:A=>l(A.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-[10px]",children:"Horizontal"})]})},{label:"Gap",customRender:()=>t.jsxs("div",{className:"flex items-center gap-1 px-1 py-0.5",children:[t.jsx("span",{className:"text-[10px]",children:"Gap:"}),t.jsx(Ae,{type:"number",min:"0",max:"100",value:d,onChange:A=>u(Math.max(0,parseInt(A.target.value)||15)),className:"h-5 w-12 text-[10px] px-1",onClick:A=>A.stopPropagation(),"data-test":"split-config-gap"}),t.jsx("span",{className:"text-[10px]",children:"px"})]})}]}],L={label:"Split",icon:t.jsx(Du,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("byParagraph")};return t.jsxs(t.Fragment,{children:[t.jsx("div",{id:"CanvasTextSplitButtonContainer",className:we("flex items-center",s),"data-test":"toolbar-split-button",children:t.jsx(Ye,{mainAction:L,dropdownColumns:D,variant:"outline",size:"compact",persistenceKey:"toolbar-split-button",facade:n,restoreRepeatAction:S,"data-test":"canvas-split-nodes-button"})}),t.jsx(Mm,{isVisible:m,onClose:j,triggerPosition:w,currentSplitMode:"paragraph",onSplitAction:k})]})};class $m{constructor(s,n){Oe(this,"namespace","canvas.textFormatting");this.hooks=s,this.storeActions=n}getActions(){return[{id:"style:bold",label:"Bold",category:"Style",icon:t.jsx(Ac,{className:"h-3 w-3"})},{id:"style:italic",label:"Italic",category:"Style",icon:t.jsx(Ic,{className:"h-3 w-3"})},{id:"style:strikethrough",label:"Strikethrough",category:"Style",icon:t.jsx(Tc,{className:"h-3 w-3"})},{id:"heading:h1",label:"Heading 1",category:"Headings",icon:t.jsx(Ec,{className:"h-3 w-3"})},{id:"heading:h2",label:"Heading 2",category:"Headings",icon:t.jsx(Rc,{className:"h-3 w-3"})},{id:"heading:h3",label:"Heading 3",category:"Headings",icon:t.jsx(Mc,{className:"h-3 w-3"})},{id:"list:bullet",label:"Bullet list",category:"Lists",icon:t.jsx(Ga,{className:"h-3 w-3"})},{id:"list:numbered",label:"Numbered list",category:"Lists",icon:t.jsx(Nn,{className:"h-3 w-3"})},{id:"list:indent",label:"Indent",category:"Lists",icon:t.jsx(Pc,{className:"h-3 w-3"})},{id:"list:outdent",label:"Outdent",category:"Lists",icon:t.jsx(Dc,{className:"h-3 w-3"})}]}getConfig(){return{firstLineOnly:this.storeActions.getFirstLineOnly()}}setConfig(s){s.firstLineOnly!==void 0&&this.storeActions.setFirstLineOnly(s.firstLineOnly)}execute(s,n){switch(s){case"style:bold":this.hooks.applyBold();break;case"style:italic":this.hooks.applyItalic();break;case"style:strikethrough":this.hooks.applyStrikethrough();break;case"heading:h1":this.hooks.applyH1();break;case"heading:h2":this.hooks.applyH2();break;case"heading:h3":this.hooks.applyH3();break;case"list:bullet":this.hooks.applyUnorderedList();break;case"list:numbered":this.hooks.applyOrderedList();break;case"list:indent":this.hooks.applyIndent();break;case"list:outdent":this.hooks.applyOutdent();break;default:console.warn(`TextFormattingFacade: Unknown action "${s}"`)}}}function da(e,s,n,o,r){const a=e.substring(0,s),i=e.substring(s,n),c=e.substring(n),l=o.length,d=r.length;return s>=l&&a.endsWith(o)&&c.startsWith(r)?{newText:a.substring(0,a.length-l)+i+c.substring(d),newStart:s-l,newEnd:n-l}:{newText:a+o+i+r+c,newStart:s+l,newEnd:n+l}}function Bm(e,s,n){const o=s==="1. "&&n!==void 0?`${n}. `:s;if(s==="1. "){const i=e.match(/^\d+\.\s/);if(i)return e.substring(i[0].length)}else if(e.startsWith(s))return e.substring(s.length);const r=e.match(/^(#{1,3}\s)/);if(r&&s.startsWith("#"))return o+e.substring(r[1].length);const a=e.match(/^(\s*[-*]\s|\s*\d+\.\s)/);return a&&(s==="- "||s.match(/^\d+\.\s/))?o+e.substring(a[1].length):o+e}function on(e,s,n,o=!1){const r=e.split(`
`);if(o){const h=n==="1. ",f=r.every(y=>h?/^\d+\.\s/.test(y):y.startsWith(n));return{newText:r.map((y,m)=>{if(f){if(h){const x=y.match(/^\d+\.\s/);return x?y.substring(x[0].length):y}return y.startsWith(n)?y.substring(n.length):y}return Bm(y,n,h?m+1:void 0)}).join(`
`),newCursorPos:0}}let a=0,i=0;for(let h=0;h<r.length;h++){if(a+r[h].length>=s){i=h;break}a+=r[h].length+1}const c=r[i],l=a;if(c.startsWith(n)){r[i]=c.substring(n.length);const h=Math.max(l,s-n.length);return{newText:r.join(`
`),newCursorPos:h}}const d=c.match(/^(#{1,3}\s)/);if(d&&n.startsWith("#")){r[i]=n+c.substring(d[1].length);const h=n.length-d[1].length;return{newText:r.join(`
`),newCursorPos:s+h}}const u=c.match(/^(\s*[-*]\s|\s*\d+\.\s)/);if(u&&(n==="- "||n.match(/^\d+\.\s/))){r[i]=n+c.substring(u[1].length);const h=n.length-u[1].length;return{newText:r.join(`
`),newCursorPos:s+h}}return r[i]=n+c,{newText:r.join(`
`),newCursorPos:s+n.length}}function Hm(e,s){if(s)return"  "+e;{let n=0;for(let o=0;o<Math.min(2,e.length)&&e[o]===" ";o++)n++;return n>0?e.substring(n):e}}function hi(e,s,n,o=!1){const r=e.split(`
`);if(o)return{newText:r.map(d=>Hm(d,n)).join(`
`),newCursorPos:0};let a=0,i=0;for(let l=0;l<r.length;l++){if(a+r[l].length>=s){i=l;break}a+=r[l].length+1}const c=r[i];if(n)return r[i]="  "+c,{newText:r.join(`
`),newCursorPos:s+2};{let l=0;for(let d=0;d<Math.min(2,c.length)&&c[d]===" ";d++)l++;return l>0?(r[i]=c.substring(l),{newText:r.join(`
`),newCursorPos:Math.max(a,s-l)}):{newText:e,newCursorPos:s}}}const Fm=(e=!0)=>{const{fitNodeDimensions:s}=Xs(),n=p.useCallback(o=>{const r=E.getState(),a=r.projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[];if(i.length!==1){console.warn("useTextFormatting: Expected exactly one selected node");return}const c=i[0],l=typeof c.content=="string"?c.content:"",d=0,u=l.length,h=!e;let f;switch(o){case"bold":f=da(l,d,u,"**","**");break;case"italic":f=da(l,d,u,"_","_");break;case"strikethrough":f=da(l,d,u,"~~","~~");break;case"h1":{const g=on(l,d,"# ",h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}case"h2":{const g=on(l,d,"## ",h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}case"h3":{const g=on(l,d,"### ",h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}case"unorderedList":{const g=on(l,d,"- ",h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}case"orderedList":{const g=on(l,d,"1. ",h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}case"indent":{const g=hi(l,d,!0,h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}case"outdent":{const g=hi(l,d,!1,h);f={newText:g.newText,newCursorPos:g.newCursorPos};break}default:return}r.updateNodeContent(c.id,f.newText),setTimeout(()=>{const g=E.getState().getNodeById(c.id);g&&s([g])},10)},[s,e]);return{applyBold:p.useCallback(()=>n("bold"),[n]),applyItalic:p.useCallback(()=>n("italic"),[n]),applyStrikethrough:p.useCallback(()=>n("strikethrough"),[n]),applyH1:p.useCallback(()=>n("h1"),[n]),applyH2:p.useCallback(()=>n("h2"),[n]),applyH3:p.useCallback(()=>n("h3"),[n]),applyUnorderedList:p.useCallback(()=>n("unorderedList"),[n]),applyOrderedList:p.useCallback(()=>n("orderedList"),[n]),applyIndent:p.useCallback(()=>n("indent"),[n]),applyOutdent:p.useCallback(()=>n("outdent"),[n])}};function _m(){const[e,s]=p.useState(!1),{applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:u,applyOutdent:h}=Fm(e),f=p.useMemo(()=>({applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:u,applyOutdent:h}),[n,o,r,a,i,c,l,d,u,h]),g=p.useCallback(()=>e,[e]),y=p.useMemo(()=>({getFirstLineOnly:g,setFirstLineOnly:s}),[g]),m=p.useMemo(()=>new $m(f,y),[f,y]);return p.useEffect(()=>(st.register("textFormatting",{name:"Text Formatting",getActions:()=>m.getActions()}),tt.register("textFormatting",m),()=>{st.unregister("textFormatting"),tt.unregister("textFormatting")}),[m]),{facade:m,firstLineOnly:e,setFirstLineOnly:s}}const zm=e=>{const{className:s}=e,{facade:n,firstLineOnly:o,setFirstLineOnly:r}=_m(),a={icon:t.jsx(Nc,{className:"h-4 w-4"}),onClick:()=>n.execute("style:bold"),label:"Text formatting"},i=[{header:"Style",width:"120px",actions:[{label:"Bold",icon:t.jsx(Ac,{className:"h-3 w-3"}),onClick:()=>n.execute("style:bold")},{label:"Italic",icon:t.jsx(Ic,{className:"h-3 w-3"}),onClick:()=>n.execute("style:italic")},{label:"Strikethrough",icon:t.jsx(Tc,{className:"h-3 w-3"}),onClick:()=>n.execute("style:strikethrough")}]},{header:"Headings",width:"120px",actions:[{label:"Heading 1",icon:t.jsx(Ec,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h1")},{label:"Heading 2",icon:t.jsx(Rc,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h2")},{label:"Heading 3",icon:t.jsx(Mc,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h3")}]},{header:"Lists",width:"130px",actions:[{label:"Bullet list",icon:t.jsx(Ga,{className:"h-3 w-3"}),onClick:()=>n.execute("list:bullet")},{label:"Numbered list",icon:t.jsx(Nn,{className:"h-3 w-3"}),onClick:()=>n.execute("list:numbered")},{label:"Indent",icon:t.jsx(Pc,{className:"h-3 w-3"}),onClick:()=>n.execute("list:indent")},{label:"Outdent",icon:t.jsx(Dc,{className:"h-3 w-3"}),onClick:()=>n.execute("list:outdent")},{label:"First line only",icon:null,customRender:()=>t.jsx("div",{className:"px-2 py-1",onPointerDown:c=>c.stopPropagation(),children:t.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:c=>r(c.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:c=>c.stopPropagation(),"data-test":"toolbar-formatting-first-line-only-checkbox"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"First line only"})]})})}]}];return t.jsx("div",{className:we("flex items-center",s),"data-test":"toolbar-text-formatting-button",children:t.jsx(Ye,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-text-formatting",facade:n,dropdownMenuClassName:"w-auto min-w-0"})})},ua=e=>{let s="";if(typeof e.content=="string"&&(s+=e.content+`
`),e.subContent){if(typeof e.subContent=="string")s+=e.subContent+`
`;else if(typeof e.subContent=="object"&&"lines"in e.subContent){const{lines:n}=e.subContent;typeof n=="string"?s+=n+`
`:Array.isArray(n)&&n.forEach(o=>{typeof o=="string"?s+=o+`
`:o&&Array.isArray(o.words)&&(s+=o.words.join(" ")+`
`)})}}return s.trim()},Um=e=>{const{className:s,variant:n}=e,o=E.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.selectedNodes)??[],i=o.addNode,c=o.setNodeToFocusId,l=async(m,x)=>{if(a.length===0){console.log(`AI ${m}: No nodes selected.`);return}let w=a.map(ua).join(`

---

`);if(x&&(w=`${x}:

${w}`),!w.trim()){console.log(`AI ${m}: Selected nodes have no text content.`);return}console.log(`AI ${m} - Prompt:`,w);try{const v=await fd.generateCompletion(w,void 0,{stream:!1});console.log(`AI ${m} - Response:`,v);const b=v==null?void 0:v.response;if(typeof b=="string"&&b.trim()){let N={x:100,y:100};if(a.length>0){const k=a[0];N={x:k.x,y:k.y+(k.height??pe.DEFAULT_NODE_HEIGHT)+pe.nodeSpacing}}const j=Le.buildTextNode(N,b);i(j),c(j.id),console.log(`AI ${m}: Created new node ${j.id} with AI response.`)}else(typeof b!="string"||!b.trim())&&console.log(`AI ${m}: Received empty or invalid response from AI.`)}catch(v){console.error(`AI ${m} - Error:`,v)}},d=()=>{l("Generate Text","Continue writing based on the following text")},u=()=>{l("Summarize Selection","Summarize the following text")},h=()=>{l("Ask Question","Based on the following, answer any implied questions or provide information")},f=async()=>{if(a.length===0){console.log("Translate to VN: No nodes selected.");return}const m=a.map(ua).join(`

`);if(!m.trim()){console.log("Translate to VN: Selected nodes have no text content.");return}console.log("Translate to VN - Input:",m);try{const x=await kr(m,"English","Vietnamese");console.log("Translate to VN - Response:",x);const w=x.output;if(w!=null&&w.trim()){let v={x:100,y:100};if(a.length>0){const N=a[0];v={x:N.x,y:N.y+(N.height??pe.DEFAULT_NODE_HEIGHT)+pe.nodeSpacing}}const b=Le.buildTextNode(v,w);i(b),c(b.id),console.log(`Translate to VN: Created new node ${b.id} with Vietnamese translation.`)}else console.log("Translate to VN: Received empty translation.")}catch(x){console.error("Translate to VN - Error:",x)}},g=async()=>{if(a.length===0){console.log("Translate to EN: No nodes selected.");return}const m=a.map(ua).join(`

`);if(!m.trim()){console.log("Translate to EN: Selected nodes have no text content.");return}console.log("Translate to EN - Input:",m);try{const x=await kr(m,"Vietnamese","English");console.log("Translate to EN - Response:",x);const w=x.output;if(w!=null&&w.trim()){let v={x:100,y:100};if(a.length>0){const N=a[0];v={x:N.x,y:N.y+(N.height??pe.DEFAULT_NODE_HEIGHT)+pe.nodeSpacing}}const b=Le.buildTextNode(v,w);i(b),c(b.id),console.log(`Translate to EN: Created new node ${b.id} with English translation.`)}else console.log("Translate to EN: Received empty translation.")}catch(x){console.error("Translate to EN - Error:",x)}},y=[{label:"Generate Text",icon:t.jsx(bn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Summarize",icon:t.jsx(Ou,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Ask Question",icon:t.jsx(Lu,{className:"h-2.5 w-2.5"}),onClick:h},{label:"Translate to VN",icon:t.jsx(Nr,{className:"h-2.5 w-2.5"}),onClick:f},{label:"Translate to EN",icon:t.jsx(Nr,{className:"h-2.5 w-2.5"}),onClick:g}];return t.jsx("div",{id:"ToolbarAi",className:Se("ToolbarAi",s),"data-test":"toolbar-ai-button",children:t.jsx(Ye,{size:"compact",variant:n??"secondary",mainAction:{icon:t.jsx(bn,{className:"h-2.5 w-2.5"}),onClick:()=>{console.log("Main AI Action clicked")},text:"AI",label:"Trigger AI actions"},dropdownActions:y,dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})};class Vm{constructor(s){Oe(this,"namespace","canvas.fitWidth");this.hooks=s}getActions(){return[{id:"width:350",label:"Set width to 350px",category:"Width",icon:t.jsx(Ht,{className:"h-3 w-3"})},{id:"width:550",label:"Set width to 550px",category:"Width",icon:t.jsx(Ht,{className:"h-3 w-3"})},{id:"width:700",label:"Set width to 700px",category:"Width",icon:t.jsx(Ht,{className:"h-3 w-3"})},{id:"width:850",label:"Set width to 850px",category:"Width",icon:t.jsx(Ht,{className:"h-3 w-3"})},{id:"fit:dimensions",label:"Fit node dimensions",category:"Fit",icon:t.jsx(ps,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"width:350":this.hooks.setWidth350();break;case"width:550":this.hooks.setWidth550();break;case"width:700":this.hooks.setWidth700();break;case"width:850":this.hooks.setWidth850();break;case"fit:dimensions":this.hooks.fitDimensions();break;default:console.warn(`FitWidthFacade: Unknown action "${s}"`)}}}function Gm(){const{setFixedWidth:e,fitNodeDimensions:s}=Xs(),n=p.useCallback(()=>e(350),[e]),o=p.useCallback(()=>e(550),[e]),r=p.useCallback(()=>e(700),[e]),a=p.useCallback(()=>e(850),[e]),i=p.useCallback(()=>s(),[s]),c=p.useMemo(()=>({setWidth350:n,setWidth550:o,setWidth700:r,setWidth850:a,fitDimensions:i}),[n,o,r,a,i]),l=p.useMemo(()=>new Vm(c),[c]);return p.useEffect(()=>(st.register("fitWidth",{name:"Fit Width",getActions:()=>l.getActions()}),tt.register("fitWidth",l),()=>{st.unregister("fitWidth"),tt.unregister("fitWidth")}),[l]),l}const Ym=()=>{const{selectedNodes:e}=Xs(),s=Gm(),n=e.length===0,o=[{label:"Set width to 350px",icon:t.jsx(Ht,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:350"),disabled:n},{label:"Set width to 550px",icon:t.jsx(Ht,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:550"),disabled:n},{label:"Set width to 700px",icon:t.jsx(Ht,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:700"),disabled:n},{label:"Set width to 850px",icon:t.jsx(Ht,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:850"),disabled:n},{label:"Fit node dimensions",icon:t.jsx(ps,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("fit:dimensions"),disabled:n}],r=o[0];return t.jsx(Ye,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"canvas-fit-width",facade:s,"data-test":"canvas-fit-width-button"})},Ut=50,bl=()=>{const s=E.getState().projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=p.useCallback((f,g)=>{const y=E.getState(),m=y.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],w=(m==null?void 0:m.coreState.nodes)??{},v=y.updateNode;if(x.length!==1){console.warn("useNodePusher: Exactly one node must be selected to push/pull other nodes.");return}const b=x[0],N=[],j=Object.values(w),k=g==="pull"?f==="up"?"down":f==="down"?"up":f==="left"?"right":"left":f;j.forEach(S=>{if(S.id===b.id)return;let C=!1;const R={id:S.id};switch(k){case"down":S.y>=b.y+(b.height??0)&&(R.y=S.y+(g==="push"?Ut:-Ut),C=!0);break;case"up":S.y+(S.height??0)<=(b.y??0)&&(R.y=S.y+(g==="push"?-Ut:Ut),C=!0);break;case"right":S.x>=b.x+(b.width??0)&&(R.x=S.x+(g==="push"?Ut:-Ut),C=!0);break;case"left":S.x+(S.width??0)<=b.x&&(R.x=S.x+(g==="push"?-Ut:Ut),C=!0);break}C&&N.push(R)}),N.length>0?(N.forEach(S=>v(S.id,S)),console.log(`${g==="push"?"Pushed":"Pulled"} ${N.length} nodes ${f} by ${Ut}px.`)):console.warn(`No nodes found to ${g} ${f}.`)},[]),r=p.useCallback(()=>o("down","push"),[o]),a=p.useCallback(()=>o("up","push"),[o]),i=p.useCallback(()=>o("left","push"),[o]),c=p.useCallback(()=>o("right","push"),[o]),l=p.useCallback(()=>o("down","pull"),[o]),d=p.useCallback(()=>o("up","pull"),[o]),u=p.useCallback(()=>o("left","pull"),[o]),h=p.useCallback(()=>o("right","pull"),[o]);return{pushNodesDown:r,pushNodesUp:a,pushNodesLeft:i,pushNodesRight:c,pullNodesDown:l,pullNodesUp:d,pullNodesLeft:u,pullNodesRight:h,selectedNodes:n}};class Km{constructor(s){Oe(this,"namespace","canvas.nodeOperations");this.hooks=s}getActions(){return[{id:"push:up",label:"Push up",category:"Push",icon:t.jsx(Sn,{className:"h-3 w-3"})},{id:"push:down",label:"Push down",category:"Push",icon:t.jsx(Cn,{className:"h-3 w-3"})},{id:"push:left",label:"Push left",category:"Push",icon:t.jsx(Fs,{className:"h-3 w-3"})},{id:"push:right",label:"Push right",category:"Push",icon:t.jsx(Kt,{className:"h-3 w-3"})},{id:"pull:up",label:"Pull up",category:"Pull",icon:t.jsx(Sn,{className:"h-3 w-3"})},{id:"pull:down",label:"Pull down",category:"Pull",icon:t.jsx(Cn,{className:"h-3 w-3"})},{id:"pull:left",label:"Pull left",category:"Pull",icon:t.jsx(Fs,{className:"h-3 w-3"})},{id:"pull:right",label:"Pull right",category:"Pull",icon:t.jsx(Kt,{className:"h-3 w-3"})},{id:"join:newline",label:"Join with newline",category:"Join",icon:t.jsx(Ua,{className:"h-3 w-3"})},{id:"join:space",label:"Join with space",category:"Join",icon:t.jsx(Wo,{className:"h-3 w-3"})},{id:"lines:remove-extra",label:"Remove extra lines",category:"Lines",icon:t.jsx(va,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"push:up":this.hooks.pushUp();break;case"push:down":this.hooks.pushDown();break;case"push:left":this.hooks.pushLeft();break;case"push:right":this.hooks.pushRight();break;case"pull:up":this.hooks.pullUp();break;case"pull:down":this.hooks.pullDown();break;case"pull:left":this.hooks.pullLeft();break;case"pull:right":this.hooks.pullRight();break;case"join:newline":this.hooks.joinWithNewline();break;case"join:space":this.hooks.joinWithSpace();break;case"lines:remove-extra":this.hooks.removeExtraLines();break;default:console.warn(`NodeOperationsFacade: Unknown action "${s}"`)}}}const Nl=()=>{const e=E.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=(s==null?void 0:s.coreState.arrows)??[];e.addNode,e.deleteSelectedNodes;const r=e.deleteNodeById,a=e.setSelectedNodes,i=e.updateNodes,c=e.arrow.setAll,l=p.useCallback(h=>{if(n.length<2){console.warn("useNodeJoiner: At least two nodes must be selected to join.");return}const f=[...n].sort((b,N)=>b.y<N.y?-1:b.y>N.y?1:b.x<N.x?-1:b.x>N.x?1:0),g=f[0],y=f.slice(1),m=f.reduce((b,N)=>(N.width??0)>(b.width??0)?N:b,f[0]),x=f.map(b=>typeof b.content=="string"?b.content.trim():"").filter(b=>b.length>0).join(h);if(x.length===0&&f.every(b=>!(typeof b.content=="string"&&b.content.trim()))){console.warn("useNodeJoiner: All selected nodes have empty content. No node created.");return}const w=m.width??pe.DEFAULT_NODE_WIDTH,v=ct(x,{containerWidth:w})+pe.NODE_Y_PADDING*2;i([{id:g.id,content:x,width:m.width,height:v}]);{const b=new Set(y.map(k=>k.id)),j=o.map(k=>{const S=k.startNodeId&&b.has(k.startNodeId),C=k.endNodeId&&b.has(k.endNodeId);return S&&C||S&&k.endNodeId===g.id||C&&k.startNodeId===g.id?null:S||C?{...k,startNodeId:S?g.id:k.startNodeId,endNodeId:C?g.id:k.endNodeId}:k}).filter(k=>k!==null).filter((k,S,C)=>k?S===C.findIndex(R=>R&&R.startNodeId===k.startNodeId&&R.endNodeId===k.endNodeId):!1);c(j)}y.forEach(b=>{r(b.id)}),a([g]),console.log("Nodes joined into first node:",g.id)},[n,o,i,r,a,c]),d=p.useCallback(()=>{l(" ")},[l]),u=p.useCallback(()=>{l(`
`)},[l]);return{joinNodes:d,joinNodesWithNewline:u,selectedNodes:n}},Xm=()=>{const e=E.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=e.updateNode;return{removeExtraNewLines:p.useCallback(()=>{if(n.length!==1){console.warn("useNodeLineManipulation: Exactly one node must be selected.");return}const a=n[0];if(!a.content||typeof a.content!="string"){console.warn("useNodeLineManipulation: Selected node has no content to modify.");return}const i=a.content.replace(/\n\n+/g,`
`);if(i===a.content){console.warn("useNodeLineManipulation: No extra new lines found. Node content not changed.");return}const c=ct(i,{containerWidth:a.width??0-pe.NODE_X_PADDING})+pe.NODE_Y_PADDING*2,l={id:a.id,content:i,height:c};o(l.id,l),console.log("Action: Removed extra new lines from node content.")},[n,o])}};function or(){const{pushNodesUp:e,pushNodesDown:s,pushNodesLeft:n,pushNodesRight:o,pullNodesUp:r,pullNodesDown:a,pullNodesLeft:i,pullNodesRight:c}=bl(),{joinNodes:l,joinNodesWithNewline:d}=Nl(),{removeExtraNewLines:u}=Xm(),h=p.useMemo(()=>({pushUp:e,pushDown:s,pushLeft:n,pushRight:o,pullUp:r,pullDown:a,pullLeft:i,pullRight:c,joinWithNewline:d,joinWithSpace:l,removeExtraLines:u}),[e,s,n,o,r,a,i,c,d,l,u]),f=p.useMemo(()=>new Km(h),[h]);return p.useEffect(()=>(st.register("nodeOperations",{name:"Node Operations",getActions:()=>f.getActions()}),tt.register("nodeOperations",f),()=>{st.unregister("nodeOperations"),tt.unregister("nodeOperations")}),[f]),f}const qm=e=>{const{className:s}=e,{selectedNodes:n}=bl(),o=or(),r=n.length!==1,a={icon:t.jsx(Wu,{className:"h-4 w-4"}),onClick:()=>o.execute("push:down"),label:"Push/Pull nodes",disabled:r},i=[{header:"Push",actions:[{label:"Push Up",icon:t.jsx(Sn,{className:"h-3 w-3"}),onClick:()=>o.execute("push:up"),disabled:r},{label:"Push Down",icon:t.jsx(Cn,{className:"h-3 w-3"}),onClick:()=>o.execute("push:down"),disabled:r},{label:"Push Left",icon:t.jsx(Fs,{className:"h-3 w-3"}),onClick:()=>o.execute("push:left"),disabled:r},{label:"Push Right",icon:t.jsx(Kt,{className:"h-3 w-3"}),onClick:()=>o.execute("push:right"),disabled:r}]},{header:"Pull",actions:[{label:"Pull Up",icon:t.jsx(Sn,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:up"),disabled:r},{label:"Pull Down",icon:t.jsx(Cn,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:down"),disabled:r},{label:"Pull Left",icon:t.jsx(Fs,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:left"),disabled:r},{label:"Pull Right",icon:t.jsx(Kt,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:right"),disabled:r}]}];return t.jsx("div",{id:"PushNodesButtonContainer",className:we("flex items-center",s),"data-test":"toolbar-push-pull-nodes-button",children:t.jsx(Ye,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-push-nodes",facade:o,dropdownMenuClassName:"w-auto min-w-0"})})},Zm=()=>{const{selectedNodes:e}=Nl(),s=or(),n=e.length<2,o=[{label:"Join with newline",icon:t.jsx(Ua,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:newline"),disabled:n},{label:"Join with space",icon:t.jsx(Wo,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:space"),disabled:n}],r={...o[0]};return t.jsx(Ye,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"toolbar-join-nodes",facade:s,"data-test":"canvas-join-nodes-button"})},zo=[{name:"Red",value:"#ef4444",twClass:"bg-red-500"},{name:"Orange",value:"#f97316",twClass:"bg-orange-500"},{name:"Yellow",value:"#eab308",twClass:"bg-yellow-500"},{name:"Green",value:"#22c55e",twClass:"bg-green-500"},{name:"Teal",value:"#14b8a6",twClass:"bg-teal-500"},{name:"Cyan",value:"#06b6d4",twClass:"bg-cyan-500"},{name:"Blue",value:"#3b82f6",twClass:"bg-blue-500"},{name:"Violet",value:"#8b5cf6",twClass:"bg-violet-500"},{name:"Purple",value:"#a855f7",twClass:"bg-purple-500"},{name:"Pink",value:"#ec4899",twClass:"bg-pink-500"},{name:"White",value:"#ffffff",twClass:"bg-white"},{name:"Border",value:"hsl(240 5.9% 90%)",twClass:"bg-border"},{name:"Muted",value:"hsl(var(--muted-light))",twClass:"bg-muted"},{name:"Black",value:"#000000",twClass:"bg-black"},{name:"Transparent",value:"transparent",twClass:"bg-transparent border-dashed border-neutral-400"}],Uo=e=>{if(e.startsWith("hsl(")){const s=/hsl\(\s*(\d+)\s*,\s*(\d+%)\s*,\s*(\d+%)\s*\)/.exec(e);if(s){const n=parseInt(s[1]),o=parseInt(s[2])/100,r=parseInt(s[3])/100;if(o===0){const d=Math.round(r*255).toString(16).padStart(2,"0");return`#${d}${d}${d}`}const a=d=>(d+n/30)%12,i=o*Math.min(r,1-r),c=d=>r-i*Math.max(-1,Math.min(a(d)-3,Math.min(9-a(d),1))),l=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${l(c(0))}${l(c(8))}${l(c(4))}`}}return console.warn(`convertHslToHex: Could not convert HSL string "${e}" to HEX. Returning as is or black.`),e.startsWith("#")?e:"#000000"},Jm=({currentColor:e,onColorSelect:s,currentBorderWidth:n,onBorderWidthChange:o})=>{const[r,a]=p.useState(e),[i,c]=p.useState(n);p.useEffect(()=>{a(e)},[e]),p.useEffect(()=>{c(n)},[n]);const l=u=>{a(u),s(u)},d=u=>{const h=parseInt(u.target.value,10);isNaN(h)||(c(h),o(h))};return t.jsxs("div",{className:"p-2 grid grid-cols-5 gap-2 bg-popover rounded-md shadow-md",children:[zo.map(u=>t.jsx("button",{type:"button",title:u.name,onClick:()=>l(u.value),className:we("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",u.twClass,u.value===r?"ring-2 ring-ring ring-offset-2":"border-muted ring-0",u.value==="white"&&"border-neutral-300"),style:u.value.startsWith("hsl(")?{backgroundColor:u.value}:{},"aria-label":`Select color ${u.name}`,"data-test":`color-picker-${u.name.toLowerCase().replace(/\s+/g,"-")}`},u.value)),t.jsx("input",{type:"color",value:r.startsWith("hsl")?Uo(r):r,onChange:u=>l(u.target.value),className:"mt-2 w-full col-span-5 h-8 bg-secondary","data-test":"color-picker-custom-color-input"}),t.jsxs("div",{className:"mt-3 pt-3 border-t border-border col-span-5",children:[t.jsx("label",{htmlFor:"border-width-input",className:"block text-sm font-medium text-foreground mb-1",children:"Border Width"}),t.jsx("input",{type:"number",id:"border-width-input",value:i,onChange:d,min:"0",max:"50",className:"mt-1 w-full col-span-5 h-8 p-2 rounded-md border border-input bg-background text-foreground focus:ring-ring focus:border-ring","data-test":"color-picker-border-width-input"})]})]})},Qm=()=>{var k,S,C,R;const e=H(I=>I.updateNode),s=H(I=>{var M;return((M=I.projectCanvas.getActive())==null?void 0:M.coreState.selectedNodes)??[]}),[n,o]=p.useState(!1),[r,a]=p.useState("hsl(var(--primary))"),[i,c]=p.useState("1px"),[l,d]=p.useState("solid"),u=E.getState().getLastUsedBorder(),h=u.lastUsedColor,f=u.lastUsedWidth,g=u.lastUsedStyle;p.useEffect(()=>{if(s.length===1){const M=s[0].styles,W=(M==null?void 0:M.borderColor)||"hsl(var(--primary))",B=(M==null?void 0:M.borderWidth)||"1px",F=(M==null?void 0:M.borderStyle)||"solid";a(W),c(B),d(F)}else s.length===0&&(a("hsl(var(--primary))"),c("1px"),d("solid"))},[s]);const y=(I,M,W)=>{s.forEach(B=>{const F={...B.styles,borderWidth:I,borderStyle:M,borderColor:W};I===void 0&&M===void 0&&W===void 0&&(F.border=void 0);const D={styles:F};e(B.id,D)})},m=()=>{y(f,g,h)},x=I=>{y(i,l,I),a(I),E.getState().setLastUsedBorder(I,i,l),E.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},w=I=>{const M=`${I}px`;y(M,l,r),c(M),E.getState().setLastUsedBorder(r,M,l),E.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},v=()=>{c(void 0),d(void 0),a(void 0),y(void 0,void 0,void 0)},b=[{label:"Apply last used border color",icon:t.jsx("span",{style:{color:h==="transparent"?void 0:h,display:"inline-flex"},children:t.jsx(Sr,{className:"h-2.5 w-2.5"})}),onClick:()=>{m()},disabled:s.length===0},{label:"Set Border Color",icon:t.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:t.jsx(Oc,{className:"h-2.5 w-2.5"})}),onClick:()=>{o(!0)},disabled:s.length===0},{label:"Remove Border",icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:()=>{v()},disabled:s.length===0||!((S=(k=s[0])==null?void 0:k.styles)!=null&&S.borderWidth)&&!((R=(C=s[0])==null?void 0:C.styles)!=null&&R.border)}],N={...b[0],icon:t.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:t.jsx(Sr,{className:"h-2.5 w-2.5"})})},j=I=>{if(!I)return 1;const M=parseInt(I,10);return isNaN(M)?1:M};return t.jsxs(ot,{open:n,onOpenChange:o,children:[t.jsx(at,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"canvas-border-width-button",children:t.jsx(Ye,{mainAction:N,dropdownActions:b,variant:"outline",size:"compact",persistenceKey:"canvas-border-width"})})}),t.jsx(rt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:I=>I.preventDefault(),"data-test":"canvas-border-width-popover",children:t.jsx(Jm,{currentColor:r,onColorSelect:x,currentBorderWidth:j(i),onBorderWidthChange:w})})]})},ex=e=>{const{className:s}=e,n=or(),o={icon:t.jsx(va,{}),onClick:()=>n.execute("lines:remove-extra"),label:"Remove extra new lines"},r=[{label:"Remove extra new lines",icon:t.jsx(va,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("lines:remove-extra")}];return t.jsx("div",{id:"ToolbarLinesButtonContainer",className:we("flex items-center",s),"data-test":"toolbar-lines-button",children:t.jsx(Ye,{mainAction:o,dropdownActions:r,variant:"outline",size:"compact",persistenceKey:"toolbar-lines",facade:n})})},tx=e=>{const{className:s,...n}=e,o=()=>{var i;const r=E.getState();(((i=r.projectCanvas.getActive())==null?void 0:i.coreState.selectedNodes)??[]).length>0&&r.deleteSelectedNodes()};return t.jsx(qs,{id:"ToolbarDeleteNodesButton",className:s,type:"button",onClick:o,"data-test":"toolbar-delete-nodes-button",...n,children:t.jsx(pt,{className:"h-2.5 w-2.5"})})};class sx{constructor(s){Oe(this,"namespace","canvas.alignment");this.hooks=s}getActions(){return[{id:"node:left",label:"Align left",category:"Node",icon:t.jsx(jn,{className:"h-3 w-3"})},{id:"node:right",label:"Align right",category:"Node",icon:t.jsx(kn,{className:"h-3 w-3"})},{id:"node:top",label:"Align top",category:"Node",icon:t.jsx(Ya,{className:"h-3 w-3"})},{id:"node:bottom",label:"Align bottom",category:"Node",icon:t.jsx(Ka,{className:"h-3 w-3"})},{id:"text:left",label:"Text left",category:"Text",icon:t.jsx(jn,{className:"h-3 w-3"})},{id:"text:center",label:"Text center",category:"Text",icon:t.jsx(Lc,{className:"h-3 w-3"})},{id:"text:right",label:"Text right",category:"Text",icon:t.jsx(kn,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"node:left":this.hooks.alignNodesLeft();break;case"node:right":this.hooks.alignNodesRight();break;case"node:top":this.hooks.alignNodesTop();break;case"node:bottom":this.hooks.alignNodesBottom();break;case"text:left":this.hooks.alignTextLeft();break;case"text:center":this.hooks.alignTextCenter();break;case"text:right":this.hooks.alignTextRight();break;default:console.warn(`AlignmentFacade: Unknown action "${s}"`)}}}const nx=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.y??0)-(c.y??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.y??0,l=i.height??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},ox=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.x??0)-(c.x??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.x??0,l=i.width??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},ax=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="left"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.x??0)-(i.x??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.x??0)+(i.width??0);if((c.x??0)<l+n){const u=l+n;o.set(c.id,{x:u}),r[a]={...c,x:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.x??0)+(a.width??0);return(i.x??0)+(i.width??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.x??0;if((c.x??0)+(c.width??0)>l-n){const u=l-n-(c.width??0);o.set(c.id,{x:u}),r[a]={...c,x:u}}}}return o},rx=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="top"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.y??0)-(i.y??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.y??0)+(i.height??0);if((c.y??0)<l+n){const u=l+n;o.set(c.id,{y:u}),r[a]={...c,y:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.y??0)+(a.height??0);return(i.y??0)+(i.height??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.y??0;if((c.y??0)+(c.height??0)>l-n){const u=l-n-(c.height??0);o.set(c.id,{y:u}),r[a]={...c,y:u}}}}return o};function ix(){const e=p.useCallback(r=>{var f;const a=E.getState(),i=((f=a.projectCanvas.getActive())==null?void 0:f.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.filter(g=>typeof g.x=="number"&&typeof g.y=="number"&&typeof g.width=="number"&&typeof g.height=="number");if(c.length===0)return;const l=r==="left"||r==="right"?nx(c):ox(c);let d;switch(r){case"left":d=Math.min(...c.map(g=>g.x));break;case"right":d=Math.max(...c.map(g=>(g.x??0)+(g.width??0)));break;case"top":d=Math.min(...c.map(g=>g.y));break;case"bottom":d=Math.max(...c.map(g=>(g.y??0)+(g.height??0)));break;default:return}const u=new Map;for(const g of c)switch(r){case"left":u.set(g.id,{x:d});break;case"right":u.set(g.id,{x:d-(g.width??0)});break;case"top":u.set(g.id,{y:d});break;case"bottom":u.set(g.id,{y:d-(g.height??0)});break}const h=pe.NODE_ALIGNMENT_PADDING;for(const g of l){const y=g.map(x=>{const w=u.get(x.id);return w?{...x,...w}:x});(r==="left"||r==="right"?ax(y,r,h):rx(y,r,h)).forEach((x,w)=>{const v=u.get(w)||{};u.set(w,{...v,...x})})}u.forEach((g,y)=>{a.updateNode(y,g)})},[]),s=p.useCallback(r=>{var l;const a=E.getState(),i=((l=a.projectCanvas.getActive())==null?void 0:l.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.map(d=>({...d,id:d.id,styles:{...d.styles,textAlign:r}}));a.updateNodes(c)},[]),n=p.useMemo(()=>({alignNodesLeft:()=>e("left"),alignNodesRight:()=>e("right"),alignNodesTop:()=>e("top"),alignNodesBottom:()=>e("bottom"),alignTextLeft:()=>s("left"),alignTextCenter:()=>s("center"),alignTextRight:()=>s("right")}),[e,s]),o=p.useMemo(()=>new sx(n),[n]);return p.useEffect(()=>(st.register("alignment",{name:"Alignment",getActions:()=>o.getActions()}),tt.register("alignment",o),()=>{st.unregister("alignment"),tt.unregister("alignment")}),[o]),o}const ha={left:t.jsx(jn,{className:"h-3 w-3"}),right:t.jsx(kn,{className:"h-3 w-3"}),top:t.jsx(Ya,{className:"h-3 w-3"}),bottom:t.jsx(Ka,{className:"h-3 w-3"})},pi={left:t.jsx(jn,{className:"h-3 w-3"}),center:t.jsx(Lc,{className:"h-3 w-3"}),right:t.jsx(kn,{className:"h-3 w-3"})},cx=e=>{const{className:s,value:n,defaultValue:o="left",onAlignmentChange:r,textAlignValue:a,defaultTextAlignValue:i="left",onTextAlignmentChange:c}=e,l=ix(),[d,u]=p.useState(n??o),[h,f]=p.useState(a??i);p.useEffect(()=>{n!==void 0&&u(n)},[n]),p.useEffect(()=>{a!==void 0&&f(a)},[a]);const g=w=>{r==null||r(w),u(w),l.execute(`node:${w}`)},y=w=>{c==null||c(w),f(w),l.execute(`text:${w}`)},m={icon:t.jsx(t.Fragment,{children:ha[d]}),onClick:()=>g(d),label:`Align nodes ${d}`,text:""},x=[{header:"Node",width:"100px",actions:Object.keys(ha).map(w=>({label:`Node ${w}`,icon:ha[w],onClick:()=>g(w)}))},{header:"Text",width:"100px",actions:Object.keys(pi).map(w=>({label:`Text ${w}`,icon:pi[w],onClick:()=>y(w)}))}];return t.jsx("div",{id:"ToolbarNodesAlignmentButton",className:we("flex items-center",s),"data-test":"toolbar-nodes-alignment-button",children:t.jsx(Ye,{mainAction:m,dropdownColumns:x,variant:"outline",size:"compact",persistenceKey:"toolbar-alignment",facade:l,dropdownMenuClassName:"w-auto min-w-0"})})};function ar({nodeGap:e,gridColumns:s,gridRows:n,onNodeGapChange:o,onGridColumnsChange:r,onGridRowsChange:a,showFavorites:i=!1,isGapFavorite:c=!1,isColumnsFavorite:l=!1,isRowsFavorite:d=!1,onToggleGapFavorite:u,onToggleColumnsFavorite:h,onToggleRowsFavorite:f,compact:g=!1,showRows:y=!0,className:m}){const x=g?"h-5 w-12 text-[10px] px-1":"h-7 w-20 text-xs",w=g?"text-muted-foreground text-[10px]":"text-xs text-muted-foreground min-w-[60px]",v=g?"flex items-center gap-3":"space-y-3",b=g?"flex items-center gap-1":"flex items-center gap-2";return t.jsxs("div",{className:we(v,m),"data-test":"arrange-config-form",children:[t.jsxs("div",{className:b,"data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:w,children:"Gap:"}),t.jsx(Ae,{type:"number",min:"0",max:"200",value:e,onChange:N=>o(Math.max(0,Math.min(200,parseInt(N.target.value)||0))),className:x,"data-test":"arrange-config-gap-input"}),!g&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"px"}),g&&t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"px"}),i&&t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:u,title:c?"Remove from favorites":"Add to favorites","data-test":"arrange-config-gap-favorite-button",children:t.jsx(Es,{className:we("h-3.5 w-3.5",c&&"fill-yellow-400 text-yellow-400")})})]}),t.jsxs("div",{className:b,"data-test":"arrange-config-columns-row",children:[t.jsx("span",{className:w,children:"Cols:"}),t.jsx(Ae,{type:"number",min:"1",max:"10",value:s,onChange:N=>r(Math.max(1,Math.min(10,parseInt(N.target.value)||3))),className:x,"data-test":"arrange-config-columns-input"}),!g&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:h,title:l?"Remove from favorites":"Add to favorites","data-test":"arrange-config-columns-favorite-button",children:t.jsx(Es,{className:we("h-3.5 w-3.5",l&&"fill-yellow-400 text-yellow-400")})})]}),y&&n!==void 0&&a&&t.jsxs("div",{className:b,"data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:w,children:"Rows:"}),t.jsx(Ae,{type:"number",min:"1",max:"10",value:n,onChange:N=>a(Math.max(1,Math.min(10,parseInt(N.target.value)||3))),className:x,"data-test":"arrange-config-rows-input"}),!g&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:f,title:d?"Remove from favorites":"Add to favorites","data-test":"arrange-config-rows-favorite-button",children:t.jsx(Es,{className:we("h-3.5 w-3.5",d&&"fill-yellow-400 text-yellow-400")})})]})]})}function lx(e){if(e.length<2)return[...e];const n=e.reduce((o,r)=>o+(r.height??100),0)/e.length*.5;return[...e].sort((o,r)=>Math.abs(o.y-r.y)<n?o.x-r.x:o.y-r.y)}const pa=lx;function Sl(e){return e.map(s=>({...s,width:s.width??100,height:s.height??31}))}function dx(e,s){if(e.length===0)return[];if(e.length===1)return[[...e]];const n=Sl(e),r=n.reduce((d,u)=>d+u.height,0)/n.length*s,a=[...e].sort((d,u)=>d.y-u.y),i=[];let c=[a[0]],l=a[0].y;for(let d=1;d<a.length;d++){const u=a[d];Math.abs(u.y-l)<=r?c.push(u):(i.push(c),c=[u],l=u.y)}return c.length>0&&i.push(c),i}function ux(e,s){if(e.length===0)return[];if(e.length===1)return[...e];const{cleanUpGap:n,rowThreshold:o}=s,r=Sl(e),a=new Map;r.forEach(u=>{a.set(u.id,{width:u.width,height:u.height})});const i=dx(e,o),l=[...i[0]].sort((u,h)=>u.x-h.x)[0].x,d=[];for(const u of i){const h=[...u].sort((m,x)=>m.x-x.x),g=h[0].y;let y=l;for(const m of h){const x=a.get(m.id);d.push({...m,x:y,y:g}),y+=x.width+n}}return d}const vs=[];function hx(){const e=H(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??vs}),s=H(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.nodes)??vs}),{updateNode:n}=E.getState(),[o,r]=p.useState("content"),a=p.useRef(vs);e.length===0?a.current=vs:(e.length!==a.current.length||!e.every((A,T)=>{var O;return A.id===((O=a.current[T])==null?void 0:O.id)}))&&(a.current=e);const i=p.useRef(vs);s.length===0?i.current=vs:(s.length!==i.current.length||!s.every((A,T)=>{var O;return A.id===((O=i.current[T])==null?void 0:O.id)}))&&(i.current=s);const c=A=>{if(A)return A;const O=E.getState().projectCanvas.getActive(),$=(O==null?void 0:O.coreState.selectedNodes)??[],_=(O==null?void 0:O.coreState.nodes)??[];return $.length>=2?$:_},l=A=>{const T={timestamp:Date.now(),nodePositions:Object.fromEntries(A.map(O=>[O.id,{x:O.x,y:O.y,width:O.width,height:O.height}]))};E.getState().setArrangeSnapshot(T)},d=p.useCallback((A,T)=>{const O=c(A);if(O.length<2)return;l(O);const $=E.getState().getArrangeNodeGap(),_=[...O].sort((J,P)=>J.y-P.y);let G;T==="left"?G=Math.min(...O.map(J=>J.x)):T==="right"&&(G=Math.max(...O.map(P=>P.x+(P.width||200))));let X=_[0].y;_.forEach((J,P)=>{const z={};P===0?X=J.y+(J.height||100)+$:(z.y=X,X=X+(J.height||100)+$),T==="left"&&G!==void 0?z.x=G:T==="right"&&G!==void 0&&(z.x=G-(J.width||200)),Object.keys(z).length>0&&n(J.id,z)})},[n]),u=p.useCallback(A=>{d(A,"left")},[d]),h=p.useCallback(A=>{d(A,"right")},[d]),f=p.useCallback((A,T)=>{const O=c(A),$=E.getState().getArrangeNodeGap();if(O.length<2)return;l(O);const _=[...O].sort((J,P)=>J.x-P.x);let G;T==="top"?G=Math.min(...O.map(J=>J.y)):T==="bottom"&&(G=Math.max(...O.map(P=>P.y+(P.height||100))));let X=_[0].x;_.forEach((J,P)=>{const z={},U=J.width||200;P===0?X=J.x+U+$:(z.x=X,X=X+U+$),T==="top"&&G!==void 0?z.y=G:T==="bottom"&&G!==void 0&&(z.y=G-(J.height||100)),Object.keys(z).length>0&&n(J.id,z)})},[n]),g=p.useCallback(A=>{f(A,"top")},[f]),y=p.useCallback(A=>{f(A,"bottom")},[f]),m=(A,T)=>{const O=A.content||"";return ct(O,{containerWidth:T})+pe.NODE_Y_PADDING*2},x=A=>{const T=E.getState().group.createFromSelected(`[Arrange] ${A}`);T&&E.getState().addTagToNode(T,{id:Re(8),title:"action:arrange"})},w=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O=E.getState().getArrangeNodeGap(),$=E.getState().getArrangeGridColumns(),_=Math.max(...T.map(K=>K.width??pe.DEFAULT_NODE_WIDTH)),G=pa(T),X=G[0].x,J=G[0].y,P=G.map(K=>m(K,_)),z=Math.ceil(G.length/$),U=[];for(let K=0;K<z;K++){let re=0;for(let ne=0;ne<$;ne++){const V=K*$+ne;V<P.length&&(re=Math.max(re,P[V]))}U.push(re)}G.forEach((K,re)=>{const ne=re%$,V=Math.floor(re/$),oe=X+ne*(_+O),le=V===0?J:J+U.slice(0,V).reduce((q,Y)=>q+Y+O,0),Z=P[re];n(K.id,{x:oe,y:le,width:_,height:Z,options:{...K.options,lockSize:!0}})}),x("Grid")},[n]),v=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O=E.getState().getArrangeNodeGap(),$=E.getState().getArrangeGridColumns(),_=Math.max(...T.map(U=>U.width??pe.DEFAULT_NODE_WIDTH)),G=pa(T),X=G[0].x,J=G[0].y,P=Array($).fill(J),z=G.map(U=>m(U,_));G.forEach((U,K)=>{const re=P.indexOf(Math.min(...P)),ne=X+re*(_+O),V=P[re],oe=z[K];n(U.id,{x:ne,y:V,width:_,height:oe,options:{...U.options,lockSize:!0}}),P[re]=V+oe+O}),x("Masonry")},[n]),b=(A,T)=>{switch(T){case"content":return String(A.content??"").toLowerCase();case"title":return String(A.title??"").toLowerCase();case"x":return A.x;case"y":return A.y;case"width":return A.width??0;case"height":return A.height??0;case"createdAt":return A.createdAt??"";case"updatedAt":return A.updatedAt??"";case"id":return A.id;case"type":return A.type;default:return""}},N=p.useCallback((A,T="asc",O)=>{const $=c(O);if($.length<2)return;const _=pa($).map(X=>({x:X.x,y:X.y}));[...$].sort((X,J)=>{const P=b(X,A),z=b(J,A);let U;return typeof P=="number"&&typeof z=="number"?U=P-z:U=String(P).localeCompare(String(z)),T==="asc"?U:-U}).forEach((X,J)=>{const P=_[J];(X.x!==P.x||X.y!==P.y)&&n(X.id,{x:P.x,y:P.y})})},[n]),j=p.useCallback((A,T)=>{N(A??o,"asc",T)},[N,o]),k=p.useCallback((A,T)=>{N(A??o,"desc",T)},[N,o]),S=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O={cleanUpGap:se.arrange.cleanUpGap,rowThreshold:se.arrange.cleanUpRowThreshold};ux(T,O).forEach(_=>{const G=T.find(X=>X.id===_.id);G&&(G.x!==_.x||G.y!==_.y)&&n(_.id,{x:_.x,y:_.y})})},[n]),C=A=>{const O=E.getState().projectCanvas.getActive(),$=(O==null?void 0:O.coreState.arrows)??[],_=new Set(A.map(G=>G.id));return $.filter(G=>G.startNodeId&&G.endNodeId&&_.has(G.startNodeId)&&_.has(G.endNodeId))},R=A=>{const T=A.width??pe.DEFAULT_NODE_WIDTH,O=A.height??100;return{x:A.x+T/2,y:A.y+O/2}},I=(A,T,O)=>{const{arrow:$}=E.getState();for(const _ of A){if(!_.startNodeId||!_.endNodeId)continue;const G=T.get(_.startNodeId),X=T.get(_.endNodeId);if(!G||!X)continue;const P=E.getState().projectCanvas.getActive(),z=(P==null?void 0:P.coreState.nodes)??[],U=z.find(V=>V.id===_.startNodeId),K=z.find(V=>V.id===_.endNodeId);if(!U||!K)continue;const re=R(U),ne=R(K);$.update(_.id,{type:O,startPoint:re,endPoint:ne})}},M=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O=E.getState().getArrangeNodeGap(),$=C(T),_=new Map(T.map(ne=>[ne.id,ne])),G=T.filter(ne=>!$.some(oe=>oe.endNodeId===ne.id)),X=G.reduce((ne,V)=>V.x<ne.x||V.x===ne.x&&V.y<ne.y?V:ne,G[0]),J=[...G].sort((ne,V)=>ne.x!==V.x?ne.x-V.x:ne.y-V.y),P=new Set,z=(X==null?void 0:X.x)??T[0].x,U=(X==null?void 0:X.y)??T[0].y,K=(ne,V,oe)=>{if(P.has(ne.id))return{width:0,height:0};P.add(ne.id);const le=$.filter(ie=>ie.startNodeId===ne.id&&ie.endNodeId&&!P.has(ie.endNodeId)).map(ie=>_.get(ie.endNodeId)).filter(ie=>ie!==void 0);n(ne.id,{x:V,y:oe});const Z=ne.width??pe.DEFAULT_NODE_WIDTH,q=ne.height??100;if(le.length===0)return{width:Z,height:q};const Y=V+Z+O;let te=oe,ae=0;for(const ie of le){const fe=K(ie,Y,te),ge=ie.height??100;te+=Math.max(ge,fe.height)+O,ae=Math.max(ae,fe.width)}const ce=te-oe-O;return{width:Z+O+ae,height:Math.max(q,ce)}};let re=U;for(const ne of J){const V=K(ne,z,re),oe=ne.height??100;re+=Math.max(oe,V.height)+O}I($,_,"TreeZShape")},[n]),W=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O=E.getState().getArrangeNodeGap(),$=C(T),_=new Map(T.map(ne=>[ne.id,ne])),G=T.filter(ne=>!$.some(oe=>oe.endNodeId===ne.id)),X=G.reduce((ne,V)=>V.x<ne.x||V.x===ne.x&&V.y<ne.y?V:ne,G[0]),J=[...G].sort((ne,V)=>ne.x!==V.x?ne.x-V.x:ne.y-V.y),P=new Set,z=(X==null?void 0:X.x)??T[0].x,U=(X==null?void 0:X.y)??T[0].y,K=(ne,V,oe)=>{if(P.has(ne.id))return{width:0,height:0};P.add(ne.id);const le=$.filter(ie=>ie.startNodeId===ne.id&&ie.endNodeId&&!P.has(ie.endNodeId)).map(ie=>_.get(ie.endNodeId)).filter(ie=>ie!==void 0);n(ne.id,{x:V,y:oe});const Z=ne.width??pe.DEFAULT_NODE_WIDTH,q=ne.height??100;if(le.length===0)return{width:Z,height:q};const Y=oe+q+O;let te=V,ae=0;for(const ie of le){const fe=K(ie,te,Y),ge=ie.width??pe.DEFAULT_NODE_WIDTH;te+=Math.max(ge,fe.width)+O,ae=Math.max(ae,fe.height)}const ce=te-V-O;return{width:Math.max(Z,ce),height:q+O+ae}};let re=z;for(const ne of J){const V=K(ne,re,U),oe=ne.width??pe.DEFAULT_NODE_WIDTH;re+=Math.max(oe,V.width)+O}I($,_,"TreeLStep")},[n]),B=(A,T)=>{const O=[...A].sort((X,J)=>X.y-J.y),$=[];let _=[],G=null;for(const X of O)G===null||Math.abs(X.y-G)<=T?(_.push(X),G===null&&(G=X.y)):($.push(_),_=[X],G=X.y);return _.length>0&&$.push(_),$},F=(A,T)=>{const O=[...A].sort((X,J)=>X.x-J.x),$=[];let _=[],G=null;for(const X of O)G===null||Math.abs(X.x-G)<=T?(_.push(X),G===null&&(G=X.x)):($.push(_),_=[X],G=X.x);return _.length>0&&$.push(_),$},D=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O=E.getState().getCycleRowBuffer(),$=B(T,O);if($.length<2)return;const _=$.map(X=>Math.min(...X.map(J=>J.y)));[$[$.length-1],...$.slice(0,-1)].forEach((X,J)=>{const P=_[J],z=Math.min(...X.map(K=>K.y)),U=P-z;for(const K of X)n(K.id,{y:K.y+U})})},[n]),L=p.useCallback(A=>{const T=c(A);if(T.length<2)return;l(T);const O=E.getState().getCycleRowBuffer(),$=F(T,O);if($.length<2)return;const _=$.map(X=>Math.min(...X.map(J=>J.x)));[$[$.length-1],...$.slice(0,-1)].forEach((X,J)=>{const P=_[J],z=Math.min(...X.map(K=>K.x)),U=P-z;for(const K of X)n(K.id,{x:K.x+U})})},[n]);return{arrangeVertically:d,arrangeVerticallyAlignLeft:u,arrangeVerticallyAlignRight:h,arrangeHorizontally:f,arrangeHorizontallyAlignTop:g,arrangeHorizontallyAlignBottom:y,arrangeGrid:w,arrangeMasonry:v,cleanUp:S,arrangeByArrowsVertical:M,arrangeByArrowsHorizontal:W,cycleRowsHorizontal:D,cycleColumnsVertical:L,sortNodes:N,sortNodesAsc:j,sortNodesDesc:k,sortKey:o,setSortKey:r,sortableKeys:md,selectedNodes:a.current}}function px({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a,sortableKeys:i}){const c=s==="record",l=d=>{o(d==="asc"?"sort:asc":"sort:desc",{sortKey:r.sortKey})};return t.jsxs("div",{"data-test":"sort-action-section",children:[t.jsxs("div",{className:we("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",c&&n&&"bg-primary/10 border border-primary",!c&&"hover:bg-accent"),"data-test":"sort-action-row",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[t.jsxs(lt,{value:r.sortKey,onValueChange:d=>a({sortKey:d}),children:[t.jsx(dt,{className:"h-6 w-[90px] text-xs px-2","data-test":"sort-key-selector",children:t.jsx(ut,{})}),t.jsx(ht,{children:i.map(d=>t.jsx(Ue,{value:d,"data-test":`sort-key-${d}`,children:gc[d]},d))})]}),t.jsx(ee,{variant:"outline",size:"icon",className:we("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:asc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("asc")},title:"Sort ascending","data-test":"sort-asc-button",children:t.jsx(Sn,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"outline",size:"icon",className:we("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:desc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("desc")},title:"Sort descending","data-test":"sort-desc-button",children:t.jsx(Cn,{className:"h-3 w-3"})})]})]}),t.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 text-xs text-muted-foreground hover:bg-accent rounded-sm cursor-pointer","data-test":"sort-by-last-arrange-row",children:[t.jsx(De,{checked:r.sortByLastArrange,onCheckedChange:d=>a({sortByLastArrange:d===!0}),className:"h-3.5 w-3.5","data-test":"sort-by-last-arrange-checkbox"}),t.jsxs("span",{children:["By last arranged: ",r.lastArrangeOption||"none"]})]})]})}class gx{constructor(s,n){Oe(this,"namespace","canvas.arrange");this.hooks=s,this.storeActions=n}getActions(){const s=this.hooks.sortableKeys;return[{id:"vertical",label:"Arrange vertically",category:"Vertical",icon:t.jsx(eo,{className:"h-3.5 w-3.5"}),subActions:[{id:"vertical:left",icon:t.jsx(jn,{className:"h-3 w-3"}),title:"Align left"},{id:"vertical:right",icon:t.jsx(kn,{className:"h-3 w-3"}),title:"Align right"}]},{id:"horizontal",label:"Arrange horizontally",category:"Horizontal",icon:t.jsx(ps,{className:"h-3.5 w-3.5"}),subActions:[{id:"horizontal:top",icon:t.jsx(Ya,{className:"h-3 w-3"}),title:"Align top"},{id:"horizontal:bottom",icon:t.jsx(Ka,{className:"h-3 w-3"}),title:"Align bottom"}]},{id:"grid",label:"Grid",category:"Layout",icon:t.jsx(An,{className:"h-3.5 w-3.5"})},{id:"masonry",label:"Masonry",category:"Layout",icon:t.jsx(Wc,{className:"h-3.5 w-3.5"})},{id:"cleanup",label:"Clean up",category:"Layout",icon:t.jsx(bn,{className:"h-3.5 w-3.5"})},{id:"groupByArrows",label:"Group by Arrows",category:"Layout",icon:t.jsx(Xa,{className:"h-3.5 w-3.5"}),subActions:[{id:"groupByArrows:vertical",icon:t.jsx(eo,{className:"h-3 w-3"}),title:"Vertical"},{id:"groupByArrows:horizontal",icon:t.jsx(ps,{className:"h-3 w-3"}),title:"Horizontal"}]},{id:"cycle",label:"Cycle",category:"Layout",icon:t.jsx(qa,{className:"h-3.5 w-3.5"}),subActions:[{id:"cycle:horizontal",icon:t.jsx(eo,{className:"h-3 w-3"}),title:"Cycle Rows"},{id:"cycle:vertical",icon:t.jsx(ps,{className:"h-3 w-3"}),title:"Cycle Columns"}]},{id:"sort:asc",label:"Sort",category:"Sort",icon:t.jsx($u,{className:"h-3.5 w-3.5"}),params:[{name:"sortKey",type:"select",label:"Sort by",default:"createdAt",options:Object.entries(gc).map(([n,o])=>({value:n,label:o}))}],customRender:n=>t.jsx(px,{...n,sortableKeys:s})}]}getConfig(){return{nodeGap:this.storeActions.getArrangeNodeGap(),gridColumns:this.storeActions.getArrangeGridColumns(),gridRows:this.storeActions.getArrangeGridRows(),sortByLastArrange:this.storeActions.getSortByLastArrange(),sortKey:this.hooks.sortKey,lastArrangeOption:this.storeActions.getLastArrangeOption()}}setConfig(s){s.nodeGap!==void 0&&this.storeActions.setArrangeNodeGap(s.nodeGap),s.gridColumns!==void 0&&this.storeActions.setArrangeGridColumns(s.gridColumns),s.gridRows!==void 0&&this.storeActions.setArrangeGridRows(s.gridRows),s.sortByLastArrange!==void 0&&this.storeActions.setSortByLastArrange(s.sortByLastArrange),s.sortKey!==void 0&&this.hooks.setSortKey(s.sortKey)}execute(s,n){n!=null&&n.sortKey&&this.hooks.setSortKey(n.sortKey);const o={vertical:"Arrange vertically","vertical:left":"Arrange vertically (left)","vertical:right":"Arrange vertically (right)",horizontal:"Arrange horizontally","horizontal:top":"Arrange horizontally (top)","horizontal:bottom":"Arrange horizontally (bottom)",grid:"Grid",masonry:"Masonry",cleanup:"Clean up",groupByArrows:"Group by Arrows (vertical)","groupByArrows:vertical":"Group by Arrows (vertical)","groupByArrows:horizontal":"Group by Arrows (horizontal)",cycle:"Cycle (horizontal)","cycle:horizontal":"Cycle (horizontal)","cycle:vertical":"Cycle (vertical)"};o[s]&&this.storeActions.setLastArrangeOption(o[s]);const r=a=>{var i;if(this.storeActions.getSortByLastArrange()){const c=this.storeActions.getLastArrangeOption();if(c){const l={"Arrange vertically":this.hooks.arrangeVertically,"Arrange vertically (left)":this.hooks.arrangeVerticallyAlignLeft,"Arrange vertically (right)":this.hooks.arrangeVerticallyAlignRight,"Arrange horizontally":this.hooks.arrangeHorizontally,"Arrange horizontally (top)":this.hooks.arrangeHorizontallyAlignTop,"Arrange horizontally (bottom)":this.hooks.arrangeHorizontallyAlignBottom,Grid:this.hooks.arrangeGrid,Masonry:this.hooks.arrangeMasonry,"Clean up":this.hooks.cleanUp,"Group by Arrows (vertical)":this.hooks.arrangeByArrowsVertical,"Group by Arrows (horizontal)":this.hooks.arrangeByArrowsHorizontal,"Cycle (horizontal)":this.hooks.cycleRowsHorizontal,"Cycle (vertical)":this.hooks.cycleColumnsVertical};(i=l[c])==null||i.call(l)}}a==="asc"?this.hooks.sortNodesAsc():this.hooks.sortNodesDesc()};switch(s){case"vertical":this.hooks.arrangeVertically();break;case"vertical:left":this.hooks.arrangeVerticallyAlignLeft();break;case"vertical:right":this.hooks.arrangeVerticallyAlignRight();break;case"horizontal":this.hooks.arrangeHorizontally();break;case"horizontal:top":this.hooks.arrangeHorizontallyAlignTop();break;case"horizontal:bottom":this.hooks.arrangeHorizontallyAlignBottom();break;case"grid":this.hooks.arrangeGrid();break;case"masonry":this.hooks.arrangeMasonry();break;case"cleanup":this.hooks.cleanUp();break;case"groupByArrows":case"groupByArrows:vertical":this.hooks.arrangeByArrowsVertical();break;case"groupByArrows:horizontal":this.hooks.arrangeByArrowsHorizontal();break;case"cycle":case"cycle:horizontal":this.hooks.cycleRowsHorizontal();break;case"cycle:vertical":this.hooks.cycleColumnsVertical();break;case"sort:asc":r("asc");break;case"sort:desc":r("desc");break;default:console.warn(`Unknown action: ${s}`)}}executePreset(s){const o=this.storeActions.getArrangePresets().find(r=>r.id===s);o&&(this.storeActions.applyArrangePreset(s),this.execute(o.config.arrangeMode))}}function Cl(){const e=hx(),s=H(v=>v.getArrangeNodeGap),n=H(v=>v.setArrangeNodeGap),o=H(v=>v.getArrangeGridColumns),r=H(v=>v.setArrangeGridColumns),a=H(v=>v.getArrangeGridRows),i=H(v=>v.setArrangeGridRows),c=H(v=>v.getSortByLastArrange),l=H(v=>v.setSortByLastArrange),d=H(v=>v.getLastArrangeOption),u=H(v=>v.setLastArrangeOption),h=H(v=>v.getCycleRowBuffer),f=H(v=>v.setCycleRowBuffer),g=H(v=>v.getArrangePresets),y=H(v=>v.applyArrangePreset),m=p.useMemo(()=>({arrangeVertically:e.arrangeVertically,arrangeVerticallyAlignLeft:e.arrangeVerticallyAlignLeft,arrangeVerticallyAlignRight:e.arrangeVerticallyAlignRight,arrangeHorizontally:e.arrangeHorizontally,arrangeHorizontallyAlignTop:e.arrangeHorizontallyAlignTop,arrangeHorizontallyAlignBottom:e.arrangeHorizontallyAlignBottom,arrangeGrid:e.arrangeGrid,arrangeMasonry:e.arrangeMasonry,cleanUp:e.cleanUp,arrangeByArrowsVertical:e.arrangeByArrowsVertical,arrangeByArrowsHorizontal:e.arrangeByArrowsHorizontal,cycleRowsHorizontal:e.cycleRowsHorizontal,cycleColumnsVertical:e.cycleColumnsVertical,sortNodesAsc:e.sortNodesAsc,sortNodesDesc:e.sortNodesDesc,sortKey:e.sortKey,setSortKey:e.setSortKey,sortableKeys:e.sortableKeys}),[e.arrangeVertically,e.arrangeVerticallyAlignLeft,e.arrangeVerticallyAlignRight,e.arrangeHorizontally,e.arrangeHorizontallyAlignTop,e.arrangeHorizontallyAlignBottom,e.arrangeGrid,e.arrangeMasonry,e.cleanUp,e.arrangeByArrowsVertical,e.arrangeByArrowsHorizontal,e.cycleRowsHorizontal,e.cycleColumnsVertical,e.sortNodesAsc,e.sortNodesDesc,e.sortKey,e.setSortKey,e.sortableKeys]),x=p.useMemo(()=>({getArrangeNodeGap:s,setArrangeNodeGap:n,getArrangeGridColumns:o,setArrangeGridColumns:r,getArrangeGridRows:a,setArrangeGridRows:i,getSortByLastArrange:c,setSortByLastArrange:l,getLastArrangeOption:()=>d()??void 0,setLastArrangeOption:u,getCycleRowBuffer:h,setCycleRowBuffer:f,getArrangePresets:g,applyArrangePreset:y}),[s,n,o,r,a,i,c,l,d,u,h,f,g,y]),w=p.useMemo(()=>new gx(m,x),[m,x]);return p.useEffect(()=>(st.register("arrange",{name:"Arrange",getActions:()=>w.getActions()}),tt.register("arrange",w),()=>{st.unregister("arrange"),tt.unregister("arrange")}),[w]),w}const fx=[],mx=[];function xx({currentConfig:e,onConfigChange:s,facade:n,onExecuteArrange:o,canExecute:r}){const a=p.useCallback((c,l)=>{s({arrangeMode:c}),l!=null&&l.sortKey},[s]),i=p.useMemo(()=>({nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,sortByLastArrange:e.sortByLastArrange,sortKey:n.getConfig().sortKey,lastArrangeOption:n.getConfig().lastArrangeOption}),[e,n]);return t.jsxs("div",{className:"space-y-2","data-test":"arrange-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"arrange-action-selector",children:t.jsx(Mo,{facade:n,mode:"record",selectedActionId:e.arrangeMode,onActionSelect:a,configOverride:i,onConfigChange:c=>{c.nodeGap!==void 0&&s({nodeGap:c.nodeGap}),c.gridColumns!==void 0&&s({gridColumns:c.gridColumns}),c.sortByLastArrange!==void 0&&s({sortByLastArrange:c.sortByLastArrange})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1","data-test":"arrange-config-section",children:[t.jsx(ar,{nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,onNodeGapChange:c=>s({nodeGap:c}),onGridColumnsChange:c=>s({gridColumns:c}),onGridRowsChange:c=>s({gridRows:c}),compact:!0,showRows:!0}),t.jsxs(ee,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(e.arrangeMode),disabled:!r,"data-test":"arrange-execute-button",children:[t.jsx(Ze,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function wx({isVisible:e,onClose:s,triggerPosition:n,onArrangeAction:o,onPresetApplied:r}){const[a,i]=p.useState(!1),[c,l]=p.useState(0),d=p.useRef({currentConfig:null,isEditingPreset:!1}),u=Cl(),h=p.useCallback(P=>{var z,U;return((U=(z=P.preferences)==null?void 0:z.arrangePresets)==null?void 0:U.presets)??fx},[]),f=H(h),g=H(P=>{var z,U;return((U=(z=P.preferences)==null?void 0:z.arrangePresets)==null?void 0:U.favoriteIds)??mx}),y=H(P=>{var z,U;return((U=(z=P.preferences)==null?void 0:z.arrangePresets)==null?void 0:U.activePresetId)??null}),m=H(P=>{var z,U;return((U=(z=P.preferences)==null?void 0:z.arrangeButton)==null?void 0:U.nodeGap)??pe.ARRANGE_NODE_GAP}),x=H(P=>{var z,U;return((U=(z=P.preferences)==null?void 0:z.arrangeButton)==null?void 0:U.gridColumns)??pe.ARRANGE_GRID_COLUMNS}),w=H(P=>P.getArrangeGridRows()),v=H(P=>{var z,U;return((U=(z=P.preferences)==null?void 0:z.arrangeButton)==null?void 0:U.sortByLastArrange)??!1}),b=H(P=>P.setArrangeNodeGap),N=H(P=>P.setArrangeGridColumns);H(P=>P.setArrangeGridRows);const j=H(P=>P.setSortByLastArrange),k=H(P=>P.createArrangePreset),S=H(P=>P.updateArrangePreset),C=H(P=>P.duplicateArrangePreset),R=H(P=>P.deleteArrangePreset),I=H(P=>P.renameArrangePreset),M=H(P=>P.applyArrangePreset),W=H(P=>P.toggleArrangePresetFavorite),B=H(P=>P.setActiveArrangePresetId),F=p.useMemo(()=>({getAll:()=>f,getById:P=>f.find(z=>z.id===P),getFavorites:()=>f.filter(P=>g.includes(P.id)),getFavoriteIds:()=>g,getActiveId:()=>y,create:(P,z)=>k(P,z),update:(P,z)=>{S(P,z)},updateConfig:(P,z)=>{const U=f.find(K=>K.id===P);U&&S(P,{config:{...U.config,...z}})},duplicate:P=>C(P),delete:P=>{R(P)},rename:(P,z)=>{I(P,z)},reorder:P=>{},apply:P=>{M(P)},setActive:P=>{B(P)},toggleFavorite:P=>{W(P)},isFavorite:P=>g.includes(P)}),[f,g,y,k,S,C,R,I,M,B,W]),D=p.useCallback(()=>({arrangeMode:"vertical",nodeGap:m,gridColumns:x,gridRows:w,sortByLastArrange:v}),[m,x,w,v]),L=p.useCallback(P=>{o&&(o(P),ve.success(`Executed ${P} arrange`))},[o]),A=p.useCallback(P=>{o?(requestAnimationFrame(()=>{o(P.config.arrangeMode)}),ve.success(`Applied and executed "${P.name}" (${P.config.arrangeMode})`),r&&r(P.id,P.name,()=>{M(P.id),o(P.config.arrangeMode)})):ve.success(`Applied preset "${P.name}" settings`)},[o,r,M]),T=p.useCallback(P=>{d.current={currentConfig:P.currentConfig,isEditingPreset:P.isEditingPreset,editingPresetName:P.editingPresetName};const z=U=>{P.onConfigChange(U),d.current.currentConfig&&(d.current={...d.current,currentConfig:{...d.current.currentConfig,...U}}),a&&requestAnimationFrame(()=>{l(K=>K+1)}),U.nodeGap!==void 0&&b(U.nodeGap),U.gridColumns!==void 0&&N(U.gridColumns),U.sortByLastArrange!==void 0&&j(U.sortByLastArrange)};return t.jsx(xx,{...P,onConfigChange:z,facade:u,onExecuteArrange:L,canExecute:!!o})},[u,L,o,b,N,j,a]),O=p.useCallback(()=>{a||l(P=>P+1),i(!a)},[a]),$=p.useCallback(()=>{l(P=>P+1)},[]),_=p.useMemo(()=>t.jsx("button",{className:`p-1 rounded hover:bg-accent transition-colors ${a?"bg-accent text-accent-foreground":""}`,onClick:O,"aria-label":a?"Hide debug panel":"Show debug panel",title:a?"Hide debug panel":"Show debug panel","data-test":"preset-debug-toggle",children:t.jsx(_a,{size:14})}),[a,O]),G=["activePreset","allPresets"],X=p.useMemo(()=>{const P=d.current,z=y?f.find(K=>K.id===y):null,U={mode:P.isEditingPreset?"editing":"creating",editingPresetName:P.editingPresetName||null,currentConfig:P.currentConfig,activePreset:z?{id:z.id,name:z.name,config:z.config}:null,allPresets:f.map(K=>({id:K.id,name:K.name,isFavorite:g.includes(K.id),config:K.config}))};return Object.fromEntries(Object.entries(U).filter(([K])=>!G.includes(K)))},[c,y,f,g]),J=p.useMemo(()=>n?{x:n.x+400,y:n.y}:{x:500,y:100},[n]);return t.jsxs(t.Fragment,{children:[t.jsx(yl,{isVisible:e,onClose:s,triggerPosition:n,title:"Arrange Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:T,getCurrentConfig:D,presetActions:F,onApplyPreset:A,headerActions:_}),t.jsx(Be,{isVisible:e&&a,onClose:()=>i(!1),title:"Preset Debug",triggerPosition:J,initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:$,"aria-label":"Refresh debug data",title:"Refresh debug data","data-test":"preset-debug-refresh",children:t.jsx(qa,{size:14})}),children:t.jsx("div",{className:"p-3 overflow-auto h-full font-mono text-xs","data-test":"preset-debug-content",children:t.jsx("pre",{className:"whitespace-pre-wrap break-words",children:JSON.stringify(X,null,2)})})})]})}function yx({isVisible:e,onClose:s,triggerPosition:n}){const o=H(m=>{var x,w;return((w=(x=m.preferences)==null?void 0:x.arrangeButton)==null?void 0:w.nodeGap)??pe.ARRANGE_NODE_GAP}),r=H(m=>{var x,w;return((w=(x=m.preferences)==null?void 0:x.arrangeButton)==null?void 0:w.gridColumns)??pe.ARRANGE_GRID_COLUMNS}),a=H(m=>m.getArrangeGridRows()),i=H(m=>m.setArrangeNodeGap),c=H(m=>m.setArrangeGridColumns),l=H(m=>m.setArrangeGridRows),d=H(m=>m.toggleArrangeConfigFavorite),u=H(m=>m.isArrangeConfigFavorite),h=p.useCallback((m,x)=>{const w=u(m,x);d(m,x),ve.success(w?"Removed from favorites":"Added to favorites")},[d,u]),f=u("gap",o),g=u("columns",r),y=u("rows",a);return t.jsx(Be,{isVisible:e,onClose:s,title:"Arrange Config",triggerPosition:n,initialSize:{width:280,height:200},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3","data-test":"arrange-config-content",children:t.jsx(ar,{nodeGap:o,gridColumns:r,gridRows:a,onNodeGapChange:i,onGridColumnsChange:c,onGridRowsChange:l,showFavorites:!0,showRows:!0,isGapFavorite:f,isColumnsFavorite:g,isRowsFavorite:y,onToggleGapFavorite:()=>h("gap",o),onToggleColumnsFavorite:()=>h("columns",r),onToggleRowsFavorite:()=>h("rows",a)})})})}const vx=[],bx=[],Nx=[],gi="canvas-arrange-nodes",Sx=()=>{const e=Cl(),n=H(T=>Me.selectSelectedNodes(T).length)<2,o=H(T=>{var O,$;return(($=(O=T.preferences)==null?void 0:O.arrangePresets)==null?void 0:$.presets)??vx}),r=H(T=>{var O,$;return(($=(O=T.preferences)==null?void 0:O.arrangePresets)==null?void 0:$.favoriteIds)??Nx}),a=p.useMemo(()=>o.filter(T=>r.includes(T.id)),[o,r]),i=H(T=>{var O;return((O=T.preferences)==null?void 0:O.arrangeConfigFavorites)??bx}),c=H(T=>{var O,$;return(($=(O=T.preferences)==null?void 0:O.arrangeButton)==null?void 0:$.nodeGap)??pe.ARRANGE_NODE_GAP}),l=H(T=>{var O,$;return(($=(O=T.preferences)==null?void 0:O.arrangeButton)==null?void 0:$.gridColumns)??pe.ARRANGE_GRID_COLUMNS}),d=H(T=>T.getArrangeGridRows()),u=H(T=>T.setArrangeNodeGap),h=H(T=>T.setArrangeGridColumns),f=H(T=>T.setArrangeGridRows),[g,y]=p.useState(!1),[m,x]=p.useState(),w=p.useRef(null),v=p.useRef(null),[b,N]=p.useState(!1),[j,k]=p.useState(),S=p.useRef(null),C=p.useCallback(()=>{if(w.current){const T=w.current.getBoundingClientRect();x({x:T.left,y:T.bottom+4})}y(!0)},[]),R=p.useCallback(()=>{y(!1)},[]),I=p.useCallback(()=>{if(b)N(!1);else{if(S.current){const T=S.current.getBoundingClientRect();k({x:T.left,y:T.bottom+4})}N(!0)}},[b]),M=p.useCallback(()=>{N(!1)},[]),W=p.useCallback((T,O,$)=>{v.current=$,E.getState().setSegmentedButtonAction(gi,O,()=>v.current)},[]),B=p.useCallback(T=>{e.execute(T)},[e]),F=p.useCallback(T=>{var _;const O=o.find(G=>G.name===T);if(O)return()=>e.executePreset(O.id);const $=e.getActions();for(const G of $){if(G.label===T)return()=>e.execute(G.id);const X=(_=G.subActions)==null?void 0:_.find(J=>J.title===T);if(X)return()=>e.execute(X.id)}return null},[o,e]),D=p.useCallback((T,O,$)=>{e.executePreset(T),$(O,()=>e.executePreset(T))},[e]),L=[{width:"180px",actions:[{label:"Arrange Actions",customRender:({registerRepeatAction:T})=>t.jsx(Mo,{facade:e,mode:"execute",onActionExecuted:T,categories:["Vertical","Horizontal","Layout"]})}]},{width:"230px",actions:[{label:"Presets",customRender:({registerRepeatAction:T})=>t.jsxs("div",{"data-test":"arrange-presets-section",children:[t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Presets"}),t.jsxs("button",{ref:w,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:C,"data-test":"arrange-presets-button",children:[t.jsx(Va,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),a.length>0&&t.jsxs("div",{className:"px-3 py-1","data-test":"arrange-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"arrange-favorite-presets-grid",children:a.map(O=>t.jsxs(ee,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:$=>{$.stopPropagation(),D(O.id,O.name,T)},title:`Apply & Execute: ${O.name}`,"data-test":`arrange-favorite-preset-${O.id}`,children:[t.jsx(Ze,{className:"h-2 w-2 mr-1"}),O.name]},O.id))})]})]})},{label:"Sort Actions",customRender:({registerRepeatAction:T})=>t.jsxs("div",{"data-test":"arrange-sort-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Sort"}),t.jsx(Mo,{facade:e,mode:"execute",onActionExecuted:T,categories:["Sort"]})]})},{label:"Config",customRender:()=>{const T=i.filter(G=>G.type==="gap"),O=i.filter(G=>G.type==="columns"),$=i.filter(G=>G.type==="rows"),_=i.length>0;return t.jsxs("div",{"data-test":"arrange-config-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsxs("div",{className:"px-3 py-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Config"}),t.jsx("button",{ref:S,className:"p-0.5 rounded hover:bg-accent",onClick:I,title:"Toggle config popover","data-test":"arrange-config-button",children:t.jsx(Mn,{className:"h-3 w-3 text-muted-foreground"})})]}),_&&t.jsxs("div",{className:"px-3 py-1 space-y-1.5","data-test":"arrange-config-quick-access-section",children:[T.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Gap:"}),t.jsx(Ae,{type:"number",min:"0",max:"200",value:c,onChange:G=>u(Math.max(0,Math.min(200,parseInt(G.target.value)||0))),className:"h-5 w-12 text-[10px] px-1",onClick:G=>G.stopPropagation(),onPointerDown:G=>G.stopPropagation(),"data-test":"arrange-config-gap-input"})]}),O.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-cols-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Cols:"}),t.jsx(Ae,{type:"number",min:"1",max:"10",value:l,onChange:G=>h(Math.max(1,Math.min(10,parseInt(G.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:G=>G.stopPropagation(),onPointerDown:G=>G.stopPropagation(),"data-test":"arrange-config-cols-input"})]}),$.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Rows:"}),t.jsx(Ae,{type:"number",min:"1",max:"10",value:d,onChange:G=>f(Math.max(1,Math.min(10,parseInt(G.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:G=>G.stopPropagation(),onPointerDown:G=>G.stopPropagation(),"data-test":"arrange-config-rows-input"})]})]})]})}}]}],A={label:"Arrange",icon:t.jsx(Bu,{className:"h-2.5 w-2.5"}),onClick:()=>e.execute("vertical"),disabled:n,disabledTooltip:"Select at least 2 nodes to arrange"};return t.jsxs(t.Fragment,{children:[t.jsx(Ye,{mainAction:A,dropdownColumns:L,variant:"outline",size:"compact",persistenceKey:gi,facade:e,restoreRepeatAction:F,"data-test":"canvas-arrange-nodes-button"}),t.jsx(wx,{isVisible:g,onClose:R,triggerPosition:m,onArrangeAction:B,onPresetApplied:W}),t.jsx(yx,{isVisible:b,onClose:M,triggerPosition:j})]})};function rr(){const e=H(d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.entries)??ys}),s=H(d=>{var u,h;return(h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.lastAction}),n=H(d=>d.getGlobalActionHistory),o=H(d=>d.getGlobalLastAction),r=H(d=>d.clearGlobalActionHistory),a=H(d=>d.executeGlobalLastAction),i=H(d=>d.executeActionById),c=H(d=>d.hasExecutor),l=p.useCallback(d=>i(d.executorId),[i]);return{history:e,lastAction:s,getHistory:n,getLastAction:o,clearHistory:r,executeLastAction:a,executeAction:l,hasExecutor:c}}class Cx{fromHistoryEntry(s){if(!s.actionId)return console.warn("ActionReferenceResolver: Cannot create reference without actionId"),null;const n=this.extractFacadeKeyFromSource(s.source);return n?{facadeKey:n,actionId:s.actionId,params:s.params,label:s.label}:(console.warn(`ActionReferenceResolver: Cannot derive facadeKey from source "${s.source}"`),null)}extractFacadeKeyFromSource(s){const n={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(n[s])return n[s];const o=s.split("-");return o.length>=2?o[1]:null}execute(s){const n=tt.get(s.facadeKey);if(!n)return{success:!1,error:`Facade "${s.facadeKey}" not found in registry`};try{return n.execute(s.actionId,s.params),{success:!0}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async executeSequence(s,n){const o=[];for(let r=0;r<s.length;r++){const{action:a,delayMs:i}=s[r],c=Math.max(i,pe.PRESET_STEP_DELAY_MS);r>0&&await new Promise(d=>setTimeout(d,c));const l=this.execute(a);o.push(l),n==null||n(r,l),l.success||console.warn(`ActionReferenceResolver: Step ${r} failed for "${a.label}": ${l.error}`)}return o}}const jx=new Cx,kx=[],Ax=[];function ir(){const e=jt(E,u=>{var h,f;return((f=(h=u.actions)==null?void 0:h.sequencePresets)==null?void 0:f.presets)??kx}),s=jt(E,u=>{var h,f;return((f=(h=u.actions)==null?void 0:h.sequencePresets)==null?void 0:f.favoriteIds)??Ax}),n=p.useCallback(u=>E.getState().getSequencePresetById(u),[]),o=p.useCallback((u,h)=>E.getState().createSequencePreset(u,h),[]),r=p.useCallback((u,h)=>{E.getState().updateSequencePreset(u,h)},[]),a=p.useCallback(u=>E.getState().duplicateSequencePreset(u),[]),i=p.useCallback(u=>{E.getState().deleteSequencePreset(u)},[]),c=p.useCallback(u=>{E.getState().toggleSequencePresetFavorite(u)},[]),l=p.useCallback(u=>s.includes(u),[s]),d=p.useCallback(async u=>{const h=E.getState().getSequencePresetById(u);if(!h){console.warn(`useSequencePresets: Preset "${u}" not found`);return}const f=h.steps.map(g=>({action:g.action,delayMs:g.delayMs}));await jx.executeSequence(f)},[]);return{presets:e,favoriteIds:s,getPresetById:n,createPreset:o,updatePreset:r,duplicatePreset:a,deletePreset:i,toggleFavorite:c,isFavorite:l,executePreset:d}}const Ix=({presetsButtonRef:e,onOpenPresetsPopover:s,closeDropdown:n,favoritePresets:o,onExecutePreset:r,dataTestPrefix:a,maxFavorites:i=6})=>{const c=()=>{n==null||n(),s()};return t.jsxs("div",{"data-test":`${a}-presets-section`,children:[t.jsxs("button",{ref:e,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:c,"data-test":`${a}-presets-button`,children:[t.jsx(Va,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),o.length>0&&t.jsxs("div",{className:"px-3 py-1.5 border-t border-border/50 mt-1","data-test":`${a}-quick-access-section`,children:[t.jsx("div",{className:"text-[10px] text-muted-foreground mb-1.5",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-1","data-test":`${a}-favorite-presets-grid`,children:o.slice(0,i).map(l=>t.jsxs(ee,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:d=>{d.stopPropagation(),r(l.id,l.name)},title:`Execute: ${l.name}`,"data-test":`${a}-favorite-preset-${l.id}`,children:[t.jsx(Ze,{className:"h-2.5 w-2.5 mr-1"}),l.name]},l.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},Tx=[];function Ex(){const e=jt(E,a=>{var i,c;return((c=(i=a.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)??Tx}),s=p.useCallback(a=>E.getState().getVisualWorkflowPresetById(a),[]),n=p.useCallback((a,i,c)=>E.getState().createVisualWorkflowPreset(a,i,c),[]),o=p.useCallback((a,i)=>{E.getState().updateVisualWorkflowPreset(a,i)},[]),r=p.useCallback(a=>{E.getState().deleteVisualWorkflowPreset(a)},[]);return{visualWorkflows:e,getPresetById:s,createPreset:n,updatePreset:o,deletePreset:r}}const Rx={content:!0,title:!1,id:!1,type:!1,tags:!1},Mx={horizontal:"Horizontal",vertical:"Vertical",grid:"Grid",masonry:"Masonry"},Px={GAP:se.arrange.gap,LANE_GAP:se.slice.laneGap,LANE_HEADER_OFFSET:se.slice.laneHeaderOffset,GRID_COLUMNS:se.arrange.gridColumns},{GAP:St,LANE_GAP:Dx,LANE_HEADER_OFFSET:mn,GRID_COLUMNS:Dt}=Px,Ox=e=>{const s=new Map;for(const n of e)if(n.tags)for(const o of n.tags)s.has(o.title)||s.set(o.title,o);return Array.from(s.values()).sort((n,o)=>n.title.localeCompare(o.title))},cr=(e,s)=>{var n;return((n=e.tags)==null?void 0:n.some(o=>o.title===s))??!1},jl=(e,s)=>e.filter(n=>cr(n,s)),kl=100,Al=200,ss=e=>e.height??kl,Ds=e=>e.width??Al,Lx=(e,s)=>{if(e.length===0)return kl;switch(s){case"horizontal":return Math.max(...e.map(ss));case"vertical":return e.reduce((o,r)=>o+ss(r),0)+(e.length-1)*St;case"grid":{const n=Math.ceil(e.length/Dt);let o=0;for(let r=0;r<n;r++){const a=r*Dt,i=Math.min(a+Dt,e.length),c=e.slice(a,i),l=Math.max(...c.map(ss));o+=l}return o+(n-1)*St}case"masonry":{const n=Array(Dt).fill(0);return e.forEach(o=>{const r=n.indexOf(Math.min(...n));n[r]+=ss(o)+St}),Math.max(...n)-St}}},Wx=(e,s,n,o)=>{const r=[];switch(o){case"horizontal":{let a=s;e.forEach(i=>{r.push({id:i.id,x:a,y:n+mn}),a+=Ds(i)+St});break}case"vertical":{let a=n+mn;e.forEach(i=>{r.push({id:i.id,x:s,y:a}),a+=ss(i)+St});break}case"grid":{const a=Math.ceil(e.length/Dt),i=[n+mn];for(let l=0;l<a-1;l++){const d=l*Dt,u=Math.min(d+Dt,e.length),h=e.slice(d,u),f=Math.max(...h.map(ss));i.push(i[l]+f+St)}const c=Math.max(...e.map(Ds));e.forEach((l,d)=>{const u=Math.floor(d/Dt);r.push({id:l.id,x:s+d%Dt*(c+St),y:i[u]})});break}case"masonry":{const a=Math.max(...e.map(Ds)),i=Array(Dt).fill(0);e.forEach(c=>{const l=i.indexOf(Math.min(...i));r.push({id:c.id,x:s+l*(a+St),y:n+mn+i[l]}),i[l]+=ss(c)+St});break}}return r},$x=(e,s)=>{if(e.length===0)return Al;switch(s){case"horizontal":return e.reduce((o,r)=>o+Ds(r),0)+(e.length-1)*St;case"vertical":return Math.max(...e.map(Ds));case"grid":case"masonry":{const n=Math.max(...e.map(Ds)),o=Math.min(e.length,Dt);return o*n+(o-1)*St}}},Bx=(e,s,n="horizontal")=>{if(s.length===0)return{updates:[],laneCount:0,nodesPerLane:new Map,lanes:[]};const o=[...s].sort(),r=[],a=new Map,i=[],c=new Set,l=Math.min(...e.map(h=>h.x));let d=0;o.forEach(h=>{const f=jl(e,h).filter(x=>!c.has(x.id));if(f.length===0)return;const g=Wx(f,l,d,n);r.push(...g),f.forEach(x=>c.add(x.id)),a.set(h,f.length);const y=Lx(f,n),m=$x(f,n);i.push({tagTitle:h,nodeIds:f.map(x=>x.id),bounds:{x:l,y:d,width:m,height:y+mn}}),d+=y+Dx});const u=e.filter(h=>!c.has(h.id));if(u.length>0){const h=[...u].sort((g,y)=>g.y-y.y);let f=d;for(const g of h)r.push({id:g.id,x:l,y:f}),f+=ss(g)+St}return{updates:r,laneCount:o.length,nodesPerLane:a,lanes:i}},Hx=(e,s)=>{const n=new Map;for(const o of s){const r=e.filter(a=>cr(a,o.title)).length;n.set(o.title,r)}return n},Fx={split:{whitespace:{facadeKey:"split",actionId:"byWhitespace"},line:{facadeKey:"split",actionId:"byLine"},paragraph:{facadeKey:"split",actionId:"byParagraph"},comma:{facadeKey:"split",actionId:"byComma"},period:{facadeKey:"split",actionId:"byPeriod"}},arrange:{horizontal:{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:top":{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:center":{facadeKey:"arrange",actionId:"horizontal:center"},"horizontal:bottom":{facadeKey:"arrange",actionId:"horizontal:bottom"},vertical:{facadeKey:"arrange",actionId:"vertical:left"},"vertical:left":{facadeKey:"arrange",actionId:"vertical:left"},"vertical:center":{facadeKey:"arrange",actionId:"vertical:center"},"vertical:right":{facadeKey:"arrange",actionId:"vertical:right"},grid:{facadeKey:"arrange",actionId:"grid"},masonry:{facadeKey:"arrange",actionId:"masonry"}},align:{left:{facadeKey:"alignment",actionId:"left"},center:{facadeKey:"alignment",actionId:"center"},right:{facadeKey:"alignment",actionId:"right"},top:{facadeKey:"alignment",actionId:"top"},middle:{facadeKey:"alignment",actionId:"middle"},bottom:{facadeKey:"alignment",actionId:"bottom"}},group:{create:{facadeKey:"grouping",actionId:"group"},ungroup:{facadeKey:"grouping",actionId:"ungroup"}},collapse:{collapse:{facadeKey:"collapse",actionId:"collapse"},expand:{facadeKey:"collapse",actionId:"expand"}}};function _x(e,s){const n=Fx[e];if(!n)return null;const o=n[s];return o||null}function zx(e){return e.type==="GROUP"&&cr(e,"workflow")}function Ux(e){if(e.type===de.WORKFLOW_STEP){const o=e.data;if(!(o!=null&&o.stepType))return console.warn(`VisualWorkflowParser: WORKFLOW_STEP node ${e.id} has no stepType configured`),null;const a={toolbarAction:"toolbarAction",if:"if",tagUpdate:"nodeUpdate",loop:"loop",source:"source"}[o.stepType];if(!a)return console.warn(`VisualWorkflowParser: Unknown stepType "${o.stepType}" in node ${e.id}`),null;let i=o.config;return{nodeId:e.id,order:0,stepType:a,config:i||{},label:e.title||o.stepType}}const s=(e.title||"").trim().toLowerCase();if(!s)return null;const n=s.match(/^([^:]+):\s*(.+)$/);if(n){const[,o,r]=n,a=o.trim(),i=r.trim();if(a==="if")return{nodeId:e.id,order:0,stepType:"if",config:{condition:i},label:`If: ${i}`};if(a==="tag")return{nodeId:e.id,order:0,stepType:"nodeUpdate",config:{simpleFieldUpdates:[{field:"tags",template:i}]},label:`Tag: ${i}`};const c=_x(a,i);return c?{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:c.facadeKey,actionId:c.actionId,params:c.params||{}},label:`${a}: ${i}`}:{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:a,actionId:i,params:{}},label:`${a}: ${i}`}}return s==="loop"?{nodeId:e.id,order:0,stepType:"loop",config:{},label:"Loop"}:s==="source"?{nodeId:e.id,order:0,stepType:"source",config:{},label:"Source"}:(console.warn(`VisualWorkflowParser: Unknown step pattern "${s}"`),null)}function Vx(e,s){const n=new Map,o=new Map;e.forEach(c=>{n.set(c.id,[]),o.set(c.id,0)}),s.forEach(c=>{if(c.startNodeId&&c.endNodeId){const l=n.get(c.startNodeId)||[];l.push(c.endNodeId),n.set(c.startNodeId,l),o.set(c.endNodeId,(o.get(c.endNodeId)||0)+1)}});const r=[];o.forEach((c,l)=>{c===0&&r.push(l)});const a=[],i=new Map(e.map(c=>[c.id,c]));for(;r.length>0;){const c=r.shift(),l=i.get(c);l&&a.push(l),(n.get(c)||[]).forEach(u=>{const h=(o.get(u)||0)-1;o.set(u,h),h===0&&r.push(u)})}return a.length!==e.length?(console.warn("VisualWorkflowParser: Cycle detected in workflow graph"),e):a}function Ra(e,s,n){const o=e.data,r=(o==null?void 0:o.childNodeIds)||[];if(r.length===0)return[];const a=s.filter(d=>r.includes(d.id)),i=n.filter(d=>d.startNodeId&&d.endNodeId&&r.includes(d.startNodeId)&&r.includes(d.endNodeId)),c=Vx(a,i),l=[];return c.forEach((d,u)=>{const h=Ux(d);h&&(h.order=u+1,l.push(h))}),l}function Gx(e){return e.map(s=>({id:`visual_step_${s.nodeId}`,label:s.label,order:s.order,stepType:s.stepType,config:s.config}))}function Il(e,s){return{id:`${e}_orchestration`,type:de.WORKFLOW_ORCHESTRATION,x:0,y:0,width:200,height:100,title:"Visual Workflow",content:"",data:{nodeType:"workflowOrchestration",parameters:{rows:s}}}}async function Yx(e,s,n,o=[]){try{const r=Ra(e,s,n);if(r.length===0)return{success:!1,error:"No workflow steps found in group",nodeUpdates:[]};const a=Gx(r),i=Il(e.id,a),c=[i,...s],l=n,d=new zs;d.loadWorkflow(c,l);const u=await d.executeWorkflow(i.id,o),h=u.nodeUpdates||[];return{success:u.success,error:u.error,nodeUpdates:h,executionId:u.executionId,duration:u.duration}}catch(r){return console.error("VisualWorkflowAdapter: Execution error:",r),{success:!1,error:r instanceof Error?r.message:String(r),nodeUpdates:[]}}}function Kx(e){return e.map((s,n)=>({id:`preset_step_${s.id}`,label:s.label,order:n,stepType:s.stepType,config:s.config}))}async function Xx(e){try{const s=E.getState(),n=s.projectCanvas.getActive();if(!n)return{success:!1,error:"No active canvas",nodeUpdates:[]};const o=n.coreState.selectedNodes,r=n.coreState.nodes,a=n.coreState.arrows;if(e.steps.length===0)return{success:!1,error:"No workflow steps in preset",nodeUpdates:[]};const i=Kx(e.steps),c=Il(`preset_${e.id}`,i),l=[c,...r],d=a,u=new zs;u.loadWorkflow(l,d);const h=await u.executeWorkflow(c.id,o),f=h.nodeUpdates||[];return h.success&&f.length>0&&f.forEach(({nodeId:g,updates:y})=>{s.updateNode(g,y)}),{success:h.success,error:h.error,nodeUpdates:f,executionId:h.executionId,duration:h.duration}}catch(s){return console.error("VisualWorkflowAdapter: Preset execution error:",s),{success:!1,error:s instanceof Error?s.message:String(s),nodeUpdates:[]}}}const qx=({onStartRecording:e,onStartSelection:s,isRecording:n=!1,capturedStepsCount:o=0,onStopRecording:r,onCancelRecording:a,className:i})=>{const{presets:c,executePreset:l,deletePreset:d,duplicatePreset:u,updatePreset:h,toggleFavorite:f,isFavorite:g}=ir(),{visualWorkflows:y,deletePreset:m,updatePreset:x}=Ex(),[w,v]=p.useState(null),[b,N]=p.useState([]),[j,k]=p.useState(void 0),S=p.useRef({x:0,y:0});p.useEffect(()=>{const P=z=>{S.current={x:z.clientX,y:z.clientY}};return window.addEventListener("mousemove",P),()=>window.removeEventListener("mousemove",P)},[]);const C=p.useCallback(async P=>{const z=c.find(U=>U.id===P);z&&(await l(P),E.getState().setSegmentedButtonAction("sequence-presets-panel",z.name,()=>()=>{l(P)}))},[l,c]),R=p.useCallback(P=>{k({...S.current}),v(P),N(P.steps.map(z=>({...z})))},[]),I=p.useCallback(()=>{w&&h(w.id,{steps:b}),v(null),N([])},[w,b,h]),M=p.useCallback(()=>{v(null),N([])},[]),W=p.useCallback(P=>{u(P)},[u]),B=p.useCallback(P=>{const z=E.getState();z.projectCanvas.switch(P.canvasId),setTimeout(()=>{z.scrollToNode(P.groupNodeId,500)},100)},[]),[F,D]=p.useState(null),L=p.useCallback(async P=>{if(!F){D(P.id);try{const z=await Xx(P);z.success?ve.success(`Executed: ${P.name}`,{description:`${z.nodeUpdates.length} node${z.nodeUpdates.length!==1?"s":""} updated`,duration:3e3}):ve.error(`Failed: ${P.name}`,{description:z.error||"Unknown error",duration:4e3})}catch(z){ve.error("Execution failed",{description:z instanceof Error?z.message:"Unknown error",duration:4e3})}finally{D(null)}}},[F]),A=p.useMemo(()=>c.map(P=>({id:P.id,label:P.name,data:P})),[c]),T=p.useCallback(P=>{console.log("Preset reorder:",P.map(z=>z.id))},[]),O=p.useCallback(P=>[{id:"execute",icon:t.jsx(Ze,{className:"h-3 w-3"}),title:"Execute preset",onClick:()=>C(P.id)}],[C]),$=p.useCallback(P=>{const z=P.data,U=g(z.id);return[{id:"toggle-favorite",label:U?"Remove from favorites":"Add to favorites",icon:t.jsx(Es,{className:we("h-4 w-4 mr-2",U&&"fill-yellow-400 text-yellow-400")}),onClick:()=>f(z.id)},{id:"rename",label:"Rename",icon:t.jsx(Hs,{className:"h-4 w-4 mr-2"}),onClick:()=>{const K=window.prompt("Rename preset:",z.name);K&&K.trim()&&K!==z.name&&h(z.id,{name:K.trim()})}},{id:"edit-steps",label:"Edit steps",icon:t.jsx(kc,{className:"h-4 w-4 mr-2"}),onClick:()=>R(z)},{id:"duplicate",label:"Duplicate",icon:t.jsx(Mt,{className:"h-4 w-4 mr-2"}),onClick:()=>W(P.id)}]},[W,R,h,f,g]),_=p.useMemo(()=>b.map((P,z)=>({id:P.id,label:`${z+1}. ${P.action.label}`,data:P})),[b]),G=p.useCallback(P=>{const z=P.map(U=>U.data);N(z)},[]),X=p.useCallback(P=>{N(z=>z.filter(U=>U.id!==P))},[]),J=p.useCallback((P,z,U,K)=>{const re=P.data;return t.jsxs("div",{"data-test":`edit-step-${P.id}`,children:[K,t.jsxs("div",{className:"pl-8 -mt-1 mb-1 text-[10px] text-muted-foreground",children:[re.action.facadeKey," → ",re.action.actionId]})]})},[]);return t.jsxs("div",{className:we("flex flex-col h-full",i),"data-test":"sequence-presets-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"presets-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:n?t.jsxs(t.Fragment,{children:[t.jsx($o,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",o,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(Nn,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[c.length+y.length," preset",c.length+y.length!==1?"s":""]})]})}),n?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(ee,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:P=>r==null?void 0:r({x:P.clientX,y:P.clientY}),"data-test":"presets-stop-recording",children:"Stop"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:a,"data-test":"presets-cancel-recording",children:"Cancel"})]}):t.jsxs(uo,{children:[t.jsx(ho,{asChild:!0,children:t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs","data-test":"presets-create-button",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"}),"New"]})}),t.jsxs(po,{align:"end",style:{zIndex:ke.draggablePopoverDropdown},children:[t.jsx(It,{onClick:e,"data-test":"presets-create-from-recording",children:"Record actions"}),t.jsx(It,{onClick:s,"data-test":"presets-create-from-selection",children:"Select from history"})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"presets-list",children:c.length===0&&y.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(Nn,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No presets yet"}),t.jsx("span",{className:"text-xs text-center",children:"Create a preset to save action sequences"})]}):t.jsxs(t.Fragment,{children:[c.length>0&&t.jsx(_s,{data:A,onDelete:d,onReorder:T,enableEdit:!1,enableDelete:!0,enableDrag:!0,quickActions:O,moreOptionsItems:$,dropdownZIndex:ke.draggablePopoverDropdown,className:"py-1"}),y.length>0&&t.jsxs("div",{"data-test":"visual-workflow-presets",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-muted/50 border-y border-border/50",children:[t.jsx(fs,{className:"h-3 w-3 text-muted-foreground"}),t.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wider",children:["Visual Workflows (",y.length,")"]})]}),t.jsx("div",{className:"py-1",children:y.map(P=>t.jsxs("div",{className:we("group flex items-center gap-2 px-3 py-2 hover:bg-muted/50 transition-colors",P.sourceLocation&&"cursor-pointer"),onClick:()=>{P.sourceLocation&&B(P.sourceLocation)},"data-test":`visual-workflow-${P.id}`,children:[t.jsx(fs,{className:"h-3.5 w-3.5 text-primary/70 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm font-medium truncate",children:P.name}),t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:[P.steps.length," step",P.steps.length!==1?"s":""," • ",P.steps.map(z=>z.stepType).filter((z,U,K)=>K.indexOf(z)===U).join(", ")]})]}),t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx(ee,{variant:"ghost",size:"sm",className:we("h-6 w-6 p-0",F===P.id&&"text-primary animate-pulse"),onClick:z=>{z.stopPropagation(),L(P)},disabled:F!==null,title:F===P.id?"Executing...":"Execute workflow","data-test":`visual-workflow-execute-${P.id}`,children:t.jsx(Ze,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:z=>{z.stopPropagation();const U=window.prompt("Rename workflow:",P.name);U&&U.trim()&&U!==P.name&&x(P.id,{name:U.trim()})},title:"Rename","data-test":`visual-workflow-rename-${P.id}`,children:t.jsx(Hs,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:text-destructive",onClick:z=>{z.stopPropagation(),m(P.id)},title:"Delete","data-test":`visual-workflow-delete-${P.id}`,children:t.jsx(pt,{className:"h-3 w-3"})})]})]},P.id))})]})]})}),t.jsx(Be,{isVisible:!!w,onClose:M,title:`Edit Steps: ${(w==null?void 0:w.name)??""}`,initialSize:{width:360,height:380},triggerPosition:j,resizable:!0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"edit-steps-popover",children:[t.jsxs("div",{className:"flex-1 px-4 py-2 overflow-y-auto",children:[t.jsxs(je,{className:"text-xs text-muted-foreground mb-2 block",children:["Steps (",b.length,") - drag to reorder"]}),b.length===0?t.jsx("div",{className:"text-xs text-muted-foreground text-center py-4",children:"No steps in this preset"}):t.jsx(_s,{data:_,onDelete:X,onReorder:G,enableEdit:!1,enableDelete:!0,enableDrag:!0,renderNode:J,dropdownZIndex:ke.draggablePopoverDropdown+10,className:"text-xs"})]}),t.jsxs("div",{className:"px-4 py-3 border-t bg-muted/20 flex justify-end gap-2",children:[t.jsx(ee,{variant:"outline",size:"sm",onClick:M,"data-test":"edit-steps-cancel",children:"Cancel"}),t.jsx(ee,{size:"sm",onClick:I,disabled:b.length===0,"data-test":"edit-steps-save",children:"Save"})]})]})})]})},Zx=[];function Jx(){const e=jt(E,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.isRecording)??!1}),s=jt(E,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.capturedSteps)??Zx}),n=jt(E,c=>{var l,d;return(d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.startedAt}),o=p.useCallback(()=>{E.getState().startRecording()},[]),r=p.useCallback(()=>E.getState().stopRecording(),[]),a=p.useCallback(()=>{E.getState().cancelRecording()},[]),i=p.useMemo(()=>n?Date.now()-n:0,[n]);return{isRecording:e,capturedSteps:s,startedAt:n,startRecording:o,stopRecording:r,cancelRecording:a,recordingDuration:i}}const Qx=[],ew=[],tw=e=>{const s={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(s[e])return s[e];const n=e.split("-");return n.length>=2?n[1]:null};function sw(){const e=jt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.historySelection)==null?void 0:h.isSelecting)??!1}),s=jt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.historySelection)==null?void 0:h.selectedIds)??Qx}),n=jt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.entries)??ew}),o=p.useCallback(()=>{E.getState().toggleHistorySelectionMode()},[]),r=p.useCallback(d=>{E.getState().toggleHistoryItemSelection(d)},[n,s]),a=p.useCallback(d=>s.includes(d),[s]),i=p.useCallback(()=>{E.getState().clearHistorySelection()},[]),c=p.useCallback(()=>{const d=new Map;n.forEach(h=>{d.set(h.executorId,h)});const u=[];for(const h of s){const f=d.get(h);if(!f)continue;const g=tw(f.source);if(!g||!f.actionId)continue;const y={facadeKey:g,actionId:f.actionId,params:f.params,label:f.label};u.push({id:Re(8),action:y,delayMs:0})}return u},[s,n]),l=p.useMemo(()=>s.length,[s]);return{isSelecting:e,selectedIds:s,toggleSelectionMode:o,toggleItemSelection:r,isSelected:a,clearSelection:i,getSelectedAsSteps:c,selectionCount:l}}const Tl=({initialTab:e="history",onTabChange:s})=>{const{history:n,executeAction:o,hasExecutor:r,clearHistory:a}=rr(),[i,c]=p.useState(e),{isRecording:l,capturedSteps:d,startRecording:u,stopRecording:h,cancelRecording:f}=Jx(),{isSelecting:g,toggleSelectionMode:y,toggleItemSelection:m,isSelected:x,clearSelection:w,getSelectedAsSteps:v,selectionCount:b}=sw(),{createPreset:N}=ir(),[j,k]=p.useState(!1),[S,C]=p.useState(""),[R,I]=p.useState([]),[M,W]=p.useState(void 0),B=p.useCallback(P=>{const z=P;c(z),s==null||s(z)},[s]),F=P=>new Date(P).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),D=P=>P.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(z=>z.charAt(0).toUpperCase()+z.slice(1)).join(" "),L=p.useCallback(P=>{o(P)},[o]),A=p.useCallback(()=>{u()},[u]),T=p.useCallback(P=>{const z=h();z.length>0&&(I(z),C(`Preset ${new Date().toLocaleTimeString()}`),W(P),k(!0))},[h]),O=p.useCallback(()=>{y(),c("history")},[y]),$=p.useCallback(()=>{const P=v();P.length>0&&(I(P),C(`Preset ${new Date().toLocaleTimeString()}`),k(!0),w())},[v,w]),_=p.useCallback(()=>{S.trim()&&R.length>0&&(N(S.trim(),R),k(!1),C(""),I([]),c("presets"))},[S,R,N]),G=p.useCallback(()=>{k(!1),C(""),I([])},[]),X=(P,z)=>{const U=z===0,K=r(P.executorId),re=x(P.executorId);return t.jsxs("div",{className:we("group flex items-center gap-2 px-3 py-2 text-sm","border-b border-border/50 last:border-b-0",U&&"bg-primary/5",!K&&"opacity-50",re&&"bg-primary/10"),"data-test":`action-history-item-${z}`,children:[g?t.jsx(De,{checked:re,onCheckedChange:()=>m(P.executorId),className:"h-4 w-4","data-test":`action-history-select-${z}`}):t.jsx("div",{className:we("flex-shrink-0 w-5 h-5 rounded text-[10px] font-medium flex items-center justify-center",U?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:z+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:we("font-medium truncate",U&&"text-primary"),"data-test":"action-history-item-label",children:P.label}),U&&!g&&t.jsx("span",{className:"text-[9px] px-1 py-0.5 rounded bg-primary/10 text-primary font-medium",children:"Latest"})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[t.jsx("span",{"data-test":"action-history-item-source",children:D(P.source)}),t.jsx("span",{children:"•"}),t.jsx("span",{"data-test":"action-history-item-time",children:F(P.timestamp)})]})]}),!g&&(K?t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 hover:opacity-100 transition-opacity",onClick:()=>L(P),title:"Execute this action","data-test":`action-history-execute-${z}`,children:t.jsx(Ze,{className:"h-3 w-3"})}):t.jsx("div",{className:"h-6 w-6 flex items-center justify-center text-muted-foreground/50",children:t.jsx(ns,{className:"h-3 w-3"})}))]},`${P.executorId}-${z}`)},J=t.jsxs("div",{className:"flex flex-col h-full","data-test":"action-history-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"action-history-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:g?t.jsxs(t.Fragment,{children:[t.jsx(Za,{className:"h-3.5 w-3.5 text-primary"}),t.jsxs("span",{className:"text-xs font-medium text-primary",children:[b," selected"]})]}):l?t.jsxs(t.Fragment,{children:[t.jsx($o,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",d.length,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(ns,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[n.length," action",n.length!==1?"s":""]})]})}),t.jsx("div",{className:"flex items-center gap-1","data-test":"action-history-header-actions",children:g?t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:$,disabled:b===0,"data-test":"action-history-save-selection",children:"Save Preset"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:w,"data-test":"action-history-cancel-selection",children:"Cancel"})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:P=>T({x:P.clientX,y:P.clientY}),"data-test":"action-history-stop-recording",children:"Stop"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:f,"data-test":"action-history-cancel-recording",children:"Cancel"})]}):t.jsx(t.Fragment,{children:n.length>0&&t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-destructive",onClick:a,"data-test":"action-history-clear-button",children:[t.jsx(pt,{className:"h-3 w-3 mr-1"}),"Clear"]})})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"action-history-list",children:n.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(Bo,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No actions yet"}),t.jsx("span",{className:"text-xs text-center",children:"Actions you perform will appear here"})]}):t.jsx("div",{"data-test":"action-history-items",children:n.map((P,z)=>X(P,z))})}),n.length>0&&!g&&!l&&t.jsxs("div",{className:"px-3 py-2 border-t bg-muted/30 text-[10px] text-muted-foreground","data-test":"action-history-footer",children:["Click ",t.jsx(Ze,{className:"h-2.5 w-2.5 inline mx-0.5"})," to repeat an action"]})]});return t.jsxs(t.Fragment,{children:[t.jsxs(xd,{value:i,onValueChange:B,className:"flex flex-col h-full",children:[t.jsxs(wd,{className:"grid w-full grid-cols-2 h-8","data-test":"repeat-action-tabs",children:[t.jsxs(mr,{value:"history",className:"text-xs","data-test":"tab-history",children:[t.jsx(ns,{className:"h-3 w-3 mr-1"}),"History"]}),t.jsxs(mr,{value:"presets",className:"text-xs","data-test":"tab-presets",children:[t.jsx(Nn,{className:"h-3 w-3 mr-1"}),"Presets"]})]}),t.jsx(xr,{value:"history",className:"flex-1 mt-0 overflow-hidden",children:J}),t.jsx(xr,{value:"presets",className:"flex-1 mt-0 overflow-hidden",children:t.jsx(qx,{onStartRecording:A,onStartSelection:O,isRecording:l,capturedStepsCount:d.length,onStopRecording:T,onCancelRecording:f})})]}),t.jsx(Be,{isVisible:j,onClose:G,title:"Save as Preset",initialSize:{width:320,height:200},triggerPosition:M,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-4 flex flex-col gap-3","data-test":"save-preset-popover-content",children:[t.jsxs("div",{children:[t.jsx(je,{htmlFor:"new-preset-name",className:"text-sm",children:"Preset Name"}),t.jsx(Ae,{id:"new-preset-name",value:S,onChange:P=>C(P.target.value),placeholder:"Enter preset name",className:"mt-2",autoFocus:!0,onKeyDown:P=>{P.key==="Enter"&&_()},"data-test":"save-preset-name-input"}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[R.length," step",R.length!==1?"s":""," will be saved"]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(ee,{variant:"outline",size:"sm",onClick:G,"data-test":"save-preset-cancel",children:"Cancel"}),t.jsx(ee,{size:"sm",onClick:_,disabled:!S.trim(),"data-test":"save-preset-confirm",children:"Save Preset"})]})]})})]})},El=()=>{const[e,s]=p.useState(!1),n=st.getAllActions().map(({source:o,actions:r})=>({facade:o,actions:r}));return t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:o=>{o.stopPropagation(),s(!0)},onMouseDown:o=>o.stopPropagation(),title:"Debug: Show all available actions","data-test":"action-history-debug-button",children:t.jsx(_a,{className:"h-3.5 w-3.5"})}),t.jsx(Be,{isVisible:e,onClose:()=>s(!1),title:"Available Actions (Debug)",initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3 overflow-y-auto h-full","data-test":"debug-actions-panel",children:n.map(({facade:o,actions:r})=>t.jsxs("div",{className:"mb-4","data-test":`debug-facade-${o.toLowerCase()}`,children:[t.jsxs("h4",{className:"text-sm font-semibold mb-2 text-primary",children:[o," Actions"]}),t.jsx("ol",{className:"list-decimal list-inside space-y-1 text-xs",children:r.map(a=>t.jsxs("li",{className:"ml-2","data-test":`debug-action-${a.id}`,children:[t.jsx("span",{className:"font-medium",children:a.label}),t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",a.id,")"]}),a.subActions&&a.subActions.length>0&&t.jsx("ol",{className:"list-[lower-alpha] list-inside ml-4 mt-1 space-y-0.5",children:a.subActions.map(i=>t.jsxs("li",{className:"text-muted-foreground","data-test":`debug-subaction-${i.id}`,children:[t.jsx("span",{children:i.title}),t.jsxs("span",{className:"ml-1 opacity-60",children:["(",i.id,")"]})]},i.id))})]},a.id))})]},o))})})]})},nw=({className:e})=>{const{history:s,lastAction:n,executeLastAction:o,executeAction:r,hasExecutor:a}=rr(),{presets:i,executePreset:c,favoriteIds:l}=ir(),[d,u]=p.useState(!1),[h,f]=p.useState(),g=p.useRef(null),y=p.useCallback(()=>{if(g.current){const R=g.current.getBoundingClientRect();f({x:R.left,y:R.bottom+4})}u(!0)},[]),m=p.useMemo(()=>i.filter(R=>l.includes(R.id)),[i,l]),x=p.useCallback(R=>R.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(I=>I.charAt(0).toUpperCase()+I.slice(1)).join(" "),[]),w=p.useCallback(R=>new Date(R).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[]),v=p.useCallback(R=>{r(R)},[r]),b=p.useCallback((R,I,M)=>{c(R),M(I,()=>c(R))},[c]),N=p.useCallback(()=>{n&&a(n.executorId)&&o()},[n,a,o]),j=p.useCallback(R=>{const I=i.find(M=>M.name===R);return I?()=>{c(I.id)}:null},[i,c]),k=p.useCallback((R,I)=>{const M=I===0,W=a(R.executorId);return t.jsxs("div",{className:we("group flex items-center gap-2 px-2 py-1.5 text-xs rounded-sm","hover:bg-accent cursor-pointer transition-colors",M&&"bg-primary/5",!W&&"opacity-50 cursor-not-allowed"),onClick:()=>W&&v(R),"data-test":`history-item-${I}`,children:[t.jsx("div",{className:we("flex-shrink-0 w-4 h-4 rounded text-[9px] font-medium flex items-center justify-center",M?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:I+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:we("font-medium truncate text-[11px]",M&&"text-primary"),children:R.label}),t.jsxs("div",{className:"text-[9px] text-muted-foreground truncate",children:[x(R.source)," • ",w(R.timestamp)]})]}),W&&t.jsx(Ze,{className:"h-2.5 w-2.5 opacity-0 group-hover:opacity-100 transition-opacity text-primary"})]},`${R.executorId}-${I}`)},[a,v,x,w]),S=p.useMemo(()=>[{header:"Recent Actions",width:"200px",actions:[{label:"History",onClick:()=>{},customRender:({registerRepeatAction:R})=>t.jsx("div",{className:"flex flex-col","data-test":"history-column",children:t.jsx("div",{className:"max-h-[200px] overflow-y-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},"data-test":"history-list",children:s.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-muted-foreground",children:[t.jsx(ns,{className:"h-6 w-6 opacity-30 mb-2"}),t.jsx("span",{className:"text-[10px]",children:"No actions yet"})]}):s.map((I,M)=>t.jsx("div",{onClick:()=>{a(I.executorId)&&(v(I),R(I.label,()=>r(I)))},children:k(I,M)},`${I.executorId}-${M}`))})})}]},{header:"Presets",width:"180px",actions:[{label:"Presets",onClick:()=>{},customRender:({registerRepeatAction:R,closeDropdown:I})=>t.jsx(Ix,{presetsButtonRef:g,onOpenPresetsPopover:y,closeDropdown:I,favoritePresets:m,onExecutePreset:(M,W)=>b(M,W,R),dataTestPrefix:"sequence"})}]}],[s,m,a,v,b,y,r,k]),C=n?`Repeat: ${n.label}`:"Actions & Presets";return t.jsxs(t.Fragment,{children:[t.jsx(Ye,{mainAction:{icon:t.jsx(Hu,{className:"h-4 w-4"}),onClick:N,label:C},dropdownColumns:S,variant:"outline",size:"compact",persistenceKey:"canvas-actions-presets",restoreRepeatAction:j,className:e,"data-test":"canvas-actions-presets-button"}),t.jsx(Be,{isVisible:d,onClose:()=>u(!1),title:"Actions & Presets",initialSize:{width:300,height:380},triggerPosition:h,resizable:!0,headerActions:t.jsx(El,{}),children:t.jsx(Tl,{initialTab:"presets"})})]})},ow=[],fi=[],Rl=()=>{const e=H(l=>l.arrow.update),s=H(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedNodes)??ow}),n=H(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??fi}),o=H(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.arrows)??fi}),r=p.useMemo(()=>{if(n.length>0){const l=n[0].type??se.arrows.type;return n.every(u=>(u.type??se.arrows.type)===l)?l:null}if(s.length>0){const l=new Set(s.map(f=>f.id)),d=o.filter(f=>f.startNodeId&&l.has(f.startNodeId)||f.endNodeId&&l.has(f.endNodeId));if(d.length===0)return se.arrows.type;const u=d[0].type??se.arrows.type;return d.every(f=>(f.type??se.arrows.type)===u)?u:null}return se.arrows.type},[n,s,o]),a=p.useCallback(l=>{const u=E.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.arrows??[],f=u.coreState.selectedArrows??[],g=u.coreState.selectedNodes??[];let y=h;if(f.length>0)y=f;else if(g.length>0){const m=new Set(g.map(x=>x.id));y=h.filter(x=>x.startNodeId&&m.has(x.startNodeId)||x.endNodeId&&m.has(x.endNodeId))}y.forEach(m=>{e(m.id,{type:l})})},[e]),i=[{label:"Straight",icon:t.jsx(Wo,{className:"h-2.5 w-2.5"}),onClick:()=>a("Straight"),selected:r==="Straight"},{label:"Quadratic",icon:t.jsx(Fu,{className:"h-2.5 w-2.5"}),onClick:()=>a("Quadratic"),selected:r==="Quadratic"},{label:"Cubic",icon:t.jsx(_u,{className:"h-2.5 w-2.5"}),onClick:()=>a("Cubic"),selected:r==="Cubic"},{label:"Step",icon:t.jsx(zu,{className:"h-2.5 w-2.5"}),onClick:()=>a("Step"),selected:r==="Step"},{label:"Orthogonal",icon:t.jsx(fs,{className:"h-2.5 w-2.5"}),onClick:()=>a("Orthogonal"),selected:r==="Orthogonal"},{label:"Tree: Cubic",icon:t.jsx(Xa,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeCubic"),selected:r==="TreeCubic"},{label:"Tree: L-Step",icon:t.jsx(Uu,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeLStep"),selected:r==="TreeLStep"},{label:"Tree: Z-Shape",icon:t.jsx(Vu,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeZShape"),selected:r==="TreeZShape"}],c=i[2];return t.jsx(Ye,{mainAction:c,dropdownActions:i,variant:"outline",size:"compact",persistenceKey:"canvas-arrow-type","data-test":"canvas-arrow-type-button"})};class aw{constructor(s){Oe(this,"namespace","canvas.grouping");this.hooks=s}getActions(){return[{id:"group",label:"Group nodes",category:"Grouping",icon:t.jsx($c,{className:"h-3 w-3"})},{id:"ungroup",label:"Ungroup nodes",category:"Grouping",icon:t.jsx(Ja,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"group":this.hooks.group();break;case"ungroup":this.hooks.ungroup();break;default:console.warn(`GroupingFacade: Unknown action "${s}"`)}}}function rw(){const e=p.useCallback(()=>{E.getState().group.createFromSelected()},[]),s=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],c=new Set;i.forEach(l=>{l.type===de.GROUP?c.add(l.id):l.groupId&&c.add(l.groupId)}),c.forEach(l=>{r.group.ungroup(l)})},[]),n=p.useMemo(()=>({group:e,ungroup:s}),[e,s]),o=p.useMemo(()=>new aw(n),[n]);return p.useEffect(()=>(st.register("grouping",{name:"Grouping",getActions:()=>o.getActions()}),tt.register("grouping",o),()=>{st.unregister("grouping"),tt.unregister("grouping")}),[o]),o}const iw=e=>{const{className:s,...n}=e,o=rw();H(y=>{var m,x;return((x=(m=y.projectCanvas.getActive())==null?void 0:m.coreState.selectedNodes)==null?void 0:x.length)??0});const a=E.getState().projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],l=i.filter(y=>y.type===de.GROUP).length>0,d=i.filter(y=>y.type!==de.GROUP),u=d.some(y=>y.groupId),h=d.some(y=>!y.groupId),f=l||u&&!h&&d.length>0,g=d.length>=2&&h;return!f&&!g?null:t.jsx(qs,{id:"ToolbarGroupButton",className:s,type:"button",onClick:()=>o.execute(f?"ungroup":"group"),title:f?"Ungroup (remove from group)":"Group selected nodes (Ctrl+G)","data-test":f?"toolbar-ungroup-button":"toolbar-group-button",...n,children:f?t.jsx(Ja,{className:"h-2.5 w-2.5"}):t.jsx($c,{className:"h-2.5 w-2.5"})})},cw=e=>{const{className:s}=e,{handleAlignmentChange:n,currentAlignment:o}=cm();return t.jsxs("div",{className:Se("p-0.5 gap-0.5","bg-primary-foreground shadow","flex items-center flex-wrap","pointer-events-auto",s),"data-test":"canvas-node-configurations-toolbar",children:[t.jsx(wl,{}),t.jsx(tx,{}),t.jsx(cx,{textAlignValue:o,onTextAlignmentChange:n}),t.jsx(Qm,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(Wm,{}),t.jsx(ex,{}),t.jsx(zm,{}),t.jsx(Ym,{}),t.jsx(Sx,{}),t.jsx(nw,{}),t.jsx(Zm,{}),t.jsx(qm,{}),t.jsx(Rl,{}),t.jsx(iw,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(Um,{})]})},Ml=({children:e,className:s,dataTest:n,dataAttributes:o={}})=>{const r=se.nodeUI.idleOpacity;return t.jsx("div",{className:Se("relative","bg-primary-foreground shadow rounded flex items-center pointer-events-auto","hover:opacity-100 transition-opacity duration-200",s),style:{zIndex:ke.nodeQuickPanel,opacity:r},onMouseEnter:a=>{a.currentTarget.style.opacity="1"},onMouseLeave:a=>{a.currentTarget.style.opacity=String(r)},"data-test":n,...Object.fromEntries(Object.entries(o).map(([a,i])=>[`data-${a}`,i])),children:e})},lw=({node:e})=>t.jsx(Ml,{className:"space-x-2",dataTest:"node-quick-panel-container",dataAttributes:{"node-id":e.id,"node-type":e.type},children:t.jsx(cw,{})}),dw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??ys;return s.length===0?null:s.reduce((r,a)=>a.y<r.y||a.y===r.y&&a.x<r.x?a:r,s[0]).id},Pl=e=>e.length===0?null:e.reduce((s,n)=>n.y<s.y||n.y===s.y&&n.x<s.x?n:s,e[0]),uw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??ys,n=Pl(s);return(n==null?void 0:n.x)??null},hw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??ys,n=Pl(s);return(n==null?void 0:n.y)??null},pw=e=>{var s,n;return((n=(s=e.projectCanvas.getActive())==null?void 0:s.coreState.selectedNodes)==null?void 0:n.length)??0},gw=Ce.memo(({node:e,isOpen:s,children:n})=>{const[o,r]=p.useState({top:0,left:0}),a=p.useRef(null),i=H(pw),c=H(dw),l=H(uw),d=H(hw),h=H(g=>g.uiState.mode)===Q.DRAW_ARROW,f=i>0&&c&&l!==null&&d!==null?{...e,id:c}:e;return p.useEffect(()=>{if(!s)return;const g=()=>{var F,D;const m=f,x=document.getElementById(`NodeContainerV2-${m.id}`);if(!x)return;const w=x.getBoundingClientRect(),v=((F=a.current)==null?void 0:F.offsetHeight)||250,b=((D=a.current)==null?void 0:D.offsetWidth)||350,N=window.innerWidth,j=window.innerHeight,k=20;let S=w.left+w.width/2-b/2;const C=se.nodeUI.quickPanelGap,R=w.top-v-C,I=w.bottom+C,M=R>=k,W=I+v<=j-k;let B;!M&&W?B=I:M?B=R:W?B=I:B=k,S<k?S=k:S+b>N-k&&(S=N-b-k),r({top:B,left:S})};g();const y=setTimeout(g,100);return window.addEventListener("scroll",g,!0),window.addEventListener("resize",g),()=>{clearTimeout(y),window.removeEventListener("scroll",g,!0),window.removeEventListener("resize",g)}},[s,c,l,d]),t.jsxs(t.Fragment,{children:[n,s&&!h&&e.type!==de.DRAWING&&Ys.createPortal(t.jsx("div",{ref:a,className:"fixed pointer-events-auto",style:{top:`${o.top}px`,left:`${o.left}px`,zIndex:ke.popover,maxWidth:"90vw"},onPointerDown:g=>g.stopPropagation(),onTouchStart:g=>g.stopPropagation(),onWheel:g=>g.stopPropagation(),children:t.jsx(lw,{node:e})}),document.body)]})}),fw=[{position:"top",cursor:"cursor-crosshair",classes:"top-0 left-1/2 -translate-x-1/2"},{position:"bottom",cursor:"cursor-crosshair",classes:"bottom-0 left-1/2 -translate-x-1/2"},{position:"left",cursor:"cursor-crosshair",classes:"left-0 top-1/2 -translate-y-1/2"},{position:"right",cursor:"cursor-crosshair",classes:"right-0 top-1/2 -translate-y-1/2"}],Qt=8,Vn=se.nodeOptions.resizeBorderWidth,$e={corner:{width:Qt,height:Qt},edge:{horizontal:{height:Vn,width:`calc(100% - ${Qt*2}px)`},vertical:{width:Vn,height:`calc(100% - ${Qt*2}px)`}},position:{cornerTop:`-${Qt}px`,cornerLeft:`-${Qt}px`,cornerBottom:"100%",cornerRight:"100%",edgeTop:`-${Vn}px`,edgeLeft:`-${Vn}px`,topEdge:`${Qt}px`,leftEdge:`${Qt}px`},edgePosition:{bottom:"100%",left:"100%"}},mw=[{position:"top-left",cursor:"cursor-nwse-resize",classes:"z-10",style:{...$e.corner,top:$e.position.cornerTop,left:$e.position.cornerLeft}},{position:"top-right",cursor:"cursor-nesw-resize",classes:"z-10",style:{...$e.corner,top:$e.position.cornerTop,left:$e.position.cornerRight}},{position:"bottom-left",cursor:"cursor-nesw-resize",classes:"z-10",style:{...$e.corner,top:$e.position.cornerBottom,left:$e.position.cornerLeft}},{position:"bottom-right",cursor:"cursor-nwse-resize",classes:"z-10",style:{...$e.corner,top:$e.position.cornerBottom,left:$e.position.cornerRight}},{position:"top",cursor:"cursor-ns-resize",classes:"",style:{...$e.edge.horizontal,top:$e.position.edgeTop,left:$e.position.leftEdge}},{position:"bottom",cursor:"cursor-ns-resize",classes:"",style:{...$e.edge.horizontal,top:$e.edgePosition.bottom,left:$e.position.leftEdge}},{position:"left",cursor:"cursor-ew-resize",classes:"",style:{...$e.edge.vertical,top:$e.position.topEdge,left:$e.position.edgeLeft}},{position:"right",cursor:"cursor-ew-resize",classes:"",style:{...$e.edge.vertical,top:$e.position.topEdge,left:$e.edgePosition.left}}],xw=e=>{const s=Jt(e,"top-left"),n=Jt(e,"top-right"),o=Jt(e,"bottom-left"),r=Jt(e,"bottom-right"),a=Jt(e,"top"),i=Jt(e,"bottom"),c=Jt(e,"left"),l=Jt(e,"right");return{"top-left":s,"top-right":n,"bottom-left":o,"bottom-right":r,top:a,bottom:i,left:c,right:l}},{HANDLE_BG_COLOR:ww,HANDLE_BORDER_COLOR:yw}=pe,Ma=8,Pa=20,bs=(Pa-Ma)/2,vw=({node:e,isSelected:s,mode:n})=>{const o=s&&n===Q.SELECT,r=xw(e),a=se.nodeUI.resizeHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:mw.map(({position:i,cursor:c,classes:l,style:d})=>{const u=r[i];return["top","right","bottom","left"].includes(i)?t.jsx("div",{"data-test":`resize-handle-${i}`,id:`resize-handle-${e.id}-${i}`,className:Se("absolute","hover:bg-primary/5 transition-colors",l,c),style:{...d,touchAction:"none",zIndex:ke.canvasResizeHandles},onPointerDown:f=>{f.stopPropagation(),u(f)}},i):t.jsx("div",{"data-test":`resize-handle-${i}`,id:`resize-handle-${e.id}-${i}`,className:Se("absolute transition-opacity duration-200",l,c),style:{width:Pa,height:Pa,top:typeof(d==null?void 0:d.top)=="string"?`calc(${d.top} - ${bs}px)`:(d==null?void 0:d.top)-bs,left:typeof(d==null?void 0:d.left)=="string"?`calc(${d.left} - ${bs}px)`:(d==null?void 0:d.left)-bs,touchAction:"none",zIndex:ke.canvasResizeHandles,opacity:a},onMouseEnter:f=>{f.currentTarget.style.opacity="1"},onMouseLeave:f=>{f.currentTarget.style.opacity=String(a)},onPointerDown:f=>{f.stopPropagation(),u(f)},children:t.jsx("div",{className:Se("absolute border",ww,yw),style:{width:Ma,height:Ma,top:bs,left:bs,pointerEvents:"none"}})},i)})}):null},bw=e=>{const s=zn(e,"top"),n=zn(e,"bottom"),o=zn(e,"left"),r=zn(e,"right");return p.useMemo(()=>({top:s,bottom:n,left:o,right:r}),[s,n,o,r])},Gn=-10,Nw=({node:e,isSelected:s,mode:n})=>{const o=s&&n===Q.SELECT,r=bw(e),a=se.nodeUI.quickArrowHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:fw.map(({position:i,cursor:c,classes:l})=>{const d=r[i];return t.jsx("div",{"data-test":`quick-arrow-handle-${i}`,id:`arrow-handle-${e.id}-${i}`,className:Se("absolute border rounded-full z-10","bg-blue-500","border-blue-700",l.replace(/-translate-\w+-1\/2/g,"").trim(),c,"pointer-events-auto","transition-opacity duration-200"),style:{width:`${Zt}px`,height:`${Zt}px`,top:l.includes("top-0")?`${Gn-Zt}px`:l.includes("bottom-0")?`calc(100% + ${Zt-Gn}px)`:`calc(50% - ${Zt/2}px)`,left:l.includes("left-0")?`${Gn-Zt}px`:l.includes("right-0")?`calc(100% + ${Zt-Gn}px)`:`calc(50% - ${Zt/2}px)`,opacity:a},onMouseEnter:u=>{u.currentTarget.style.opacity="1"},onMouseLeave:u=>{u.currentTarget.style.opacity=String(a)},onMouseDown:u=>{u.stopPropagation(),d(u)}},`arrow-${i}`)})}):null},Sw=e=>{const{node:s,mode:n,isPopoverOpen:o,setIsPopoverOpen:r}=e,a=_g(s),c=E.getState().setSelectedNodes,l=p.useRef({x:NaN,y:NaN});return{handleMouseDown:p.useCallback(u=>{var I;const h={x:u.clientX,y:u.clientY};l.current=h;const f=u.target;if(n===Q.MOVE)return;const y=(I=E.getState().projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes,m=y==null?void 0:y.some(M=>M.id===s.id),x=m&&(y==null?void 0:y.length)===1,w=f.closest(`[id^="resize-handle-${s.id}-"]`),v=f.closest(`[id^="arrow-handle-${s.id}-"]`),b=f.closest("[data-drag-handle]"),k=(f.tagName==="TEXTAREA"||f.closest("textarea")||f.closest("[contenteditable]")||f.closest("[data-node-textarea]")||f.closest(".markdown-textarea")||f.closest("[data-text-node-click-overlay]")||f.isContentEditable||f.closest("[data-text-position-container]"))&&!s.isEditing&&x,S=f.closest(".audio-button-wrapper")||f.closest(".voice-input-button")||f.closest(".nav-button")||f.closest(".chunk-counter"),C=f.closest('[data-test="group-header"] button'),R=f.closest(".node-actions-sidebar button");if(k){const M=E.getState(),W=u.clientX,B=u.clientY;r(!1);const F=document.querySelector(`#NodeContainerV2-${s.id} .markdown-textarea`);if(F){F.contentEditable="true",F.focus({preventScroll:!0});const D=document.querySelector(`#NodeContainerV2-${s.id} [data-text-node-click-overlay]`);D&&(D.style.display="none")}M.updateNode(s.id,{isEditing:!0}),M.setNodeToFocusId(s.id),ml(B)&&fl({nodeId:s.id,nodeY:s.y,source:"existingNode"}),requestAnimationFrame(()=>{try{let D=null;if(document.caretRangeFromPoint)D=document.caretRangeFromPoint(W,B);else if(document.caretPositionFromPoint){const L=document.caretPositionFromPoint(W,B);L&&(D=document.createRange(),D.setStart(L.offsetNode,L.offset),D.collapse(!0))}if(D){const L=window.getSelection();L&&(L.removeAllRanges(),L.addRange(D))}}catch{}});return}if(w||v||b||S||C||R){r(!1);return}m||r(!1),!s.isEditing&&!k&&a(u)},[s,c,a,n,o,r]),initialClickPoint:l}};function Po({tags:e,onAddTag:s,onRemoveTag:n,quickTags:o=["left","right","todo","important"],canvasTags:r=[],className:a}){const[i,c]=p.useState(""),l=r.filter(u=>{const h=!i.trim()||u.toLowerCase().includes(i.toLowerCase()),f=!e.includes(u);return h&&f}),d=()=>{const u=i.trim();u&&(s(u),c(""))};return t.jsxs("div",{className:we("tag-management-ui space-y-3",a),"data-test":"tag-management-ui-container",children:[e.length>0&&t.jsxs("div",{className:"current-tags space-y-2","data-test":"tag-management-current-tags-section",children:[t.jsx("div",{className:"tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-current-tags-label",children:"Current Tags"}),t.jsx("div",{className:"tags-list flex flex-wrap gap-1","data-test":"tag-management-current-tags-list",children:e.map(u=>t.jsxs(qe,{variant:"secondary",className:"tag-badge text-xs flex items-center gap-1","data-test":`tag-management-tag-${u}`,children:[u,t.jsx("button",{onClick:()=>n(u),className:"tag-remove-button ml-1 hover:text-destructive",title:"Remove tag","data-test":`tag-management-remove-tag-${u}-button`,children:t.jsx(We,{className:"h-3 w-3"})})]},u))})]}),t.jsxs("div",{className:"add-tag-section space-y-2","data-test":"tag-management-add-tag-section",children:[t.jsx("div",{className:"add-tag-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-add-tag-label",children:"Add Tag"}),t.jsxs("div",{className:"add-tag-input-group flex gap-2","data-test":"tag-management-add-tag-input-group",children:[t.jsx(Ae,{placeholder:"Enter tag name...",value:i,onChange:u=>c(u.target.value),onKeyDown:u=>{u.key==="Enter"&&i.trim()&&(u.preventDefault(),d())},className:"tag-input h-8 text-sm",autoFocus:!0,"data-test":"tag-management-tag-input"}),t.jsx(ee,{variant:"default",size:"sm",className:"add-tag-button h-8",onClick:d,disabled:!i.trim(),"data-test":"tag-management-add-tag-button",children:t.jsx(wt,{className:"h-4 w-4"})})]})]}),l.length>0&&t.jsxs("div",{className:"canvas-tags-section space-y-2","data-test":"tag-management-canvas-tags-section",children:[t.jsx("div",{className:"canvas-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-canvas-tags-label",children:"Tags in Canvas"}),t.jsx("div",{className:"canvas-tags-list flex flex-wrap gap-1 max-h-14 overflow-y-auto","data-test":"tag-management-canvas-tags-list",children:l.map(u=>t.jsx(qe,{variant:"outline",className:"canvas-tag cursor-pointer hover:opacity-80 hover:bg-accent",onClick:()=>s(u),"data-test":`tag-management-canvas-tag-${u}`,children:u},u))})]}),o.length>0&&t.jsxs("div",{className:"quick-tags-section space-y-2","data-test":"tag-management-quick-tags-section",children:[t.jsx("div",{className:"quick-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-quick-tags-label",children:"Quick Add"}),t.jsx("div",{className:"quick-tags-list flex flex-wrap gap-1","data-test":"tag-management-quick-tags-list",children:o.map(u=>{const h=e.includes(u);return t.jsx(qe,{variant:h?"default":"outline",className:we("quick-tag cursor-pointer hover:opacity-80",h&&"opacity-50 cursor-not-allowed"),onClick:()=>{h||s(u)},"data-test":`tag-management-quick-tag-${u}`,children:u},u)})})]})]})}const Cw=[];function jw({nodeId:e,tags:s,className:n}){const[o,r]=p.useState(!1),a=H(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.nodes)??Cw}),i=Array.isArray(s)?s:[],c=p.useMemo(()=>i.map(h=>h.title),[i]),l=p.useMemo(()=>{const h=new Set;for(const f of a)if(Array.isArray(f.tags))for(const g of f.tags)h.add(g.title);return Array.from(h).sort()},[a]),d=p.useCallback(h=>{const f=E.getState(),g={id:Math.random().toString(36).slice(2,10),title:h};f.addTagToNode(e,g)},[e]),u=p.useCallback(h=>{const f=E.getState(),g=i.find(y=>y.title===h);g&&f.removeTagFromNode(e,g.id)},[e,i]);return t.jsxs(ot,{open:o,onOpenChange:r,"data-test":"tag-selector-popover",children:[t.jsx(at,{asChild:!0,children:t.jsx(qs,{className:n,onClick:h=>{h.stopPropagation()},title:"Manage tags",variant:"ghost","data-test":"tag-selector-trigger-button",children:t.jsx(In,{})})}),t.jsx(rt,{className:"tag-selector-popover w-64 p-3",align:"start","data-test":"tag-selector-popover-content",children:t.jsx(Po,{tags:c,onAddTag:d,onRemoveTag:u,canvasTags:l})})]})}function kw({node:e,className:s}){const n=o=>{var d;o.stopPropagation();const r=E.getState(),a=(d=r.projectCanvas.getActive())==null?void 0:d.viewState,i=r.updateNode;if(!a)return;const{scale:c,offset:l}=a;if(e.isPinned){const u=(e.x-l.x)/c,h=(e.y-l.y)/c;i(e.id,{isPinned:!1,x:u,y:h})}else{const u=e.x*c+l.x,h=e.y*c+l.y;i(e.id,{isPinned:!0,x:u,y:h})}};return t.jsx(qs,{className:s,onClick:n,title:e.isPinned?"Unpin from viewport":"Pin to viewport",variant:"ghost",children:e.isPinned?t.jsx(Bc,{className:"h-4 w-4 text-blue-500"}):t.jsx(Hc,{className:"h-4 w-4"})})}const as=p.forwardRef(({tooltip:e,children:s,...n},o)=>t.jsx(Xt,{children:t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx(ee,{ref:o,...n,children:s})}),t.jsx($t,{children:typeof e=="string"?t.jsx("p",{children:e}):e})]})}));as.displayName="ButtonWithTooltip";const Dl=p.createContext(null),Aw=({children:e})=>{const[s,n]=p.useState(null),o=p.useRef(null),r=p.useCallback(c=>{n(c)},[s]),a=p.useCallback(c=>{n(l=>l===c?null:l)},[s]),i=p.useCallback(c=>s===c,[s]);return p.useEffect(()=>{if(!s)return;const c=l=>{var u;const d=l.target;(u=o.current)!=null&&u.contains(d)||d.closest('[data-test^="draggable-popover"]')||n(null)};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[s]),t.jsx(Dl.Provider,{value:{activePopoverId:s,openPopover:r,closePopover:a,isPopoverOpen:i},children:t.jsx("div",{ref:o,children:e})})},lr=e=>{const s=p.useContext(Dl),[n,o]=p.useState(!1);if(!s)return{isOpen:n,open:()=>o(!0),close:()=>o(!1),toggle:()=>o(c=>!c)};const{isPopoverOpen:r,openPopover:a,closePopover:i}=s;return{isOpen:r(e),open:()=>a(e),close:()=>i(e),toggle:()=>{r(e)?i(e):a(e)}}},Zs=({popoverId:e,icon:s,tooltip:n,popoverContent:o,popoverTitle:r,leftOffset:a=180,initialSize:i={width:320,height:400},resizable:c=!0,headerActions:l,buttonVariant:d="secondary",buttonSize:u="sm",dataTest:h})=>{const f=p.useRef(null),[g,y]=p.useState(null),{isOpen:m,open:x,close:w}=lr(e),v=()=>{if(m){w();return}if(f.current){const b=f.current.getBoundingClientRect(),{width:N,height:j}=i,k=b.left+b.width/2,S=b.top+b.height/2;y({x:k-N/2+a,y:S-j/2})}x()};return t.jsxs(t.Fragment,{children:[t.jsx(as,{ref:f,variant:d,size:u,tooltip:n,onClick:v,"data-test":h,children:t.jsx(s,{className:"h-4 w-4"})}),t.jsx(Be,{isVisible:m,onClose:w,title:r,triggerPosition:g??void 0,initialSize:i,resizable:c,shouldCloseManually:!0,headerActions:l,children:o})]})};function Iw(e){const n=Date.now()-e,o=Math.floor(n/1e3),r=Math.floor(o/60),a=Math.floor(r/60);return o<60?"just now":r<60?`${r} min ago`:a<24?`${a} hour${a>1?"s":""} ago`:"over a day ago"}const Tw=[],Ew=({node:e})=>{var x,w,v,b,N,j,k,S;const s=H(C=>C.uiState.arrangeSnapshot),n=H(C=>C.revertArrangeSnapshot),o=H(C=>{var R;return((R=C.projectCanvas.getActive())==null?void 0:R.coreState.nodes)??Tw}),r=e.data,a=r==null?void 0:r.automation,i=p.useMemo(()=>{const C=new Set;for(const R of o)if(Array.isArray(R.tags))for(const I of R.tags)C.add(I.title);return Array.from(C).sort()},[o]),c=p.useMemo(()=>{if(!s)return null;const C=Object.keys(s.nodePositions).length,R=Iw(s.timestamp);return{nodeCount:C,relativeTime:R}},[s]),l=()=>{n()},d=p.useCallback(C=>{const R=e.data??{childNodeIds:[]},I={...R.automation,...C};E.getState().updateNode(e.id,{data:{...R,automation:I}})},[e.id,e.data]),u=p.useCallback(C=>{var R;d({onEnter:{enabled:C,tags:((R=a==null?void 0:a.onEnter)==null?void 0:R.tags)??[]}})},[d,(x=a==null?void 0:a.onEnter)==null?void 0:x.tags]),h=p.useCallback(C=>{var I,M;const R=((I=a==null?void 0:a.onEnter)==null?void 0:I.tags)??[];R.includes(C)||d({onEnter:{enabled:((M=a==null?void 0:a.onEnter)==null?void 0:M.enabled)??!0,tags:[...R,C]}})},[d,a==null?void 0:a.onEnter]),f=p.useCallback(C=>{var I,M;const R=((I=a==null?void 0:a.onEnter)==null?void 0:I.tags)??[];d({onEnter:{enabled:((M=a==null?void 0:a.onEnter)==null?void 0:M.enabled)??!1,tags:R.filter(W=>W!==C)}})},[d,a==null?void 0:a.onEnter]),g=p.useCallback(C=>{var R;d({onLeave:{enabled:C,tags:((R=a==null?void 0:a.onLeave)==null?void 0:R.tags)??[]}})},[d,(w=a==null?void 0:a.onLeave)==null?void 0:w.tags]),y=p.useCallback(C=>{var I,M;const R=((I=a==null?void 0:a.onLeave)==null?void 0:I.tags)??[];R.includes(C)||d({onLeave:{enabled:((M=a==null?void 0:a.onLeave)==null?void 0:M.enabled)??!0,tags:[...R,C]}})},[d,a==null?void 0:a.onLeave]),m=p.useCallback(C=>{var I,M;const R=((I=a==null?void 0:a.onLeave)==null?void 0:I.tags)??[];d({onLeave:{enabled:((M=a==null?void 0:a.onLeave)==null?void 0:M.enabled)??!1,tags:R.filter(W=>W!==C)}})},[d,a==null?void 0:a.onLeave]);return t.jsx(Zs,{popoverId:`action-settings-${e.id}`,icon:Mn,tooltip:"Group Settings",popoverTitle:"Group Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"group-settings-content",children:[t.jsxs("div",{"data-test":"group-settings-automation-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-3",children:"Automation"}),t.jsxs("div",{className:"space-y-2 mb-4","data-test":"group-settings-on-enter",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(je,{htmlFor:"on-enter-switch",className:"text-sm",children:"Add tags when node enters"}),t.jsx(go,{id:"on-enter-switch",checked:((v=a==null?void 0:a.onEnter)==null?void 0:v.enabled)??!1,onCheckedChange:u,"data-test":"group-settings-on-enter-switch"})]}),((b=a==null?void 0:a.onEnter)==null?void 0:b.enabled)&&t.jsx(Po,{tags:((N=a==null?void 0:a.onEnter)==null?void 0:N.tags)??[],onAddTag:h,onRemoveTag:f,canvasTags:i,quickTags:[],className:"mt-2"})]}),t.jsxs("div",{className:"space-y-2","data-test":"group-settings-on-leave",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(je,{htmlFor:"on-leave-switch",className:"text-sm",children:"Remove tags when node leaves"}),t.jsx(go,{id:"on-leave-switch",checked:((j=a==null?void 0:a.onLeave)==null?void 0:j.enabled)??!1,onCheckedChange:g,"data-test":"group-settings-on-leave-switch"})]}),((k=a==null?void 0:a.onLeave)==null?void 0:k.enabled)&&t.jsx(Po,{tags:((S=a==null?void 0:a.onLeave)==null?void 0:S.tags)??[],onAddTag:y,onRemoveTag:m,canvasTags:i,quickTags:[],className:"mt-2"})]})]}),t.jsx("div",{className:"border-t border-border"}),t.jsxs("div",{"data-test":"group-settings-arrangement-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Arrangement"}),c?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-xs text-muted-foreground",children:[c.nodeCount," node",c.nodeCount!==1?"s":""," • ",c.relativeTime]}),t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:l,"data-test":"group-settings-revert-button",children:[t.jsx(za,{className:"h-4 w-4 mr-2"}),"Revert to Initial Positions"]})]}):t.jsx("div",{className:"text-xs text-muted-foreground italic",children:"No arrangement to revert"})]})]}),initialSize:{width:320,height:400},buttonVariant:"ghost",buttonSize:"icon",dataTest:"group-settings-button"})},Rw=({node:e})=>{const s=e.data,n=(s==null?void 0:s.vocabType)??He.DICTIONARY,o=p.useCallback(i=>{const c=i,l=e.data??{vocabType:He.DICTIONARY,term:"",definition:""};E.getState().updateNode(e.id,{data:{...l,vocabType:c}})},[e.id,e.data]),r=p.useCallback(()=>{const i=e.data??{vocabType:He.VOCABULARY,term:"",definition:""};E.getState().updateNode(e.id,{data:{...i,sourceWord:i.translationWord||"",translationWord:i.sourceWord||""}})},[e.id,e.data]),a=n===He.VOCABULARY;return t.jsx(Zs,{popoverId:`vocab-settings-${e.id}`,icon:Mn,tooltip:"Vocabulary Settings",popoverTitle:"Vocabulary Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"vocab-settings-content",children:[t.jsxs("div",{"data-test":"vocab-settings-type-section",children:[t.jsx(je,{htmlFor:"vocab-type-select",className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Vocabulary Type"}),t.jsxs(lt,{value:n,onValueChange:o,children:[t.jsx(dt,{id:"vocab-type-select","data-test":"vocab-type-select",className:"w-full",children:t.jsx(ut,{})}),t.jsxs(ht,{children:[t.jsx(Ue,{value:He.DICTIONARY,children:"Dictionary"}),t.jsx(Ue,{value:He.FLASHCARD,children:"Flashcard"}),t.jsx(Ue,{value:He.WORD_LIST,children:"Word List"}),t.jsx(Ue,{value:He.ETYMOLOGY,children:"Etymology"}),t.jsx(Ue,{value:He.VOCABULARY,children:"Vocabulary"})]})]})]}),a&&t.jsx("div",{"data-test":"vocab-settings-swap-section",children:t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full",onClick:r,"data-test":"vocab-swap-words-button",children:[t.jsx(ps,{className:"h-4 w-4 mr-2"}),"Swap Words"]})})]}),initialSize:{width:280,height:a?180:120},buttonVariant:"ghost",buttonSize:"icon",dataTest:"vocab-settings-button"})};function Mw({value:e,onChange:s,showLabel:n=!0,label:o="Fork From",placeholder:r="No fork (new session)",className:a="",disabled:i=!1}){const{forks:c,loading:l}=yd({loadOnMount:!0}),d=u=>{s==null||s(u==="none"?null:u)};return t.jsxs("div",{className:"fork-session-selector space-y-2","data-test":"fork-session-selector",children:[n&&t.jsxs(je,{className:"flex items-center gap-1","data-test":"fork-session-selector-label",children:[t.jsx(Gu,{className:"h-3 w-3"}),o]}),t.jsxs(lt,{value:e??"none",onValueChange:d,disabled:i,children:[t.jsx(dt,{className:`fork-selector ${a}`,"data-test":"fork-session-selector-trigger",children:t.jsx(ut,{placeholder:r})}),t.jsxs(ht,{"data-test":"fork-session-selector-options",style:{zIndex:ke.draggablePopoverDropdown},children:[t.jsx(Ue,{value:"none","data-test":"fork-option-none",children:t.jsx("span",{className:"text-muted-foreground",children:r})}),l?t.jsx(Ue,{value:"loading",disabled:!0,children:"Loading forks..."}):c.map(u=>t.jsx(Ue,{value:u.sessionId,"data-test":`fork-option-${u.id}`,children:t.jsxs("div",{className:"flex flex-col items-start",children:[t.jsx("span",{className:"font-medium",children:u.sessionName??u.description??`Fork ${u.sessionId.slice(0,8)}`}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[u.messageCount??0," messages"]})]})},u.id))]})]})]})}const Pw=[{value:"low",label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"medium",label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"high",label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:"urgent",label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],Dw=[{value:"freezer",label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:"backlog",label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"selected",label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:"doing",label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"done",label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:"archive",label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],Ow=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.data)==null?void 0:o.projects)??[]},Lw=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.ui)==null?void 0:o.loadingProjects)??!1};function Ww({status:e="backlog",priority:s="medium",category:n="",dueDate:o="",claudeProject:r,forkSessionId:a,sessionIds:i=[],tags:c=[],onStatusChange:l,onPriorityChange:d,onCategoryChange:u,onDueDateChange:h,onClaudeProjectChange:f,onForkSessionIdChange:g,onSessionIdsChange:y,onTagsChange:m,showForkSelector:x=!1,showSessionSelector:w=!1,showTags:v=!0,compact:b=!1}){const N=co(Ow),j=co(Lw),k=p.useMemo(()=>N.map(M=>({value:M.path,label:M.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[N]),S=p.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...k],[k]),C=p.useCallback(M=>{const W=M.trim();W&&!c.includes(W)&&(m==null||m([...c,W]))},[c,m]),R=p.useCallback(M=>{m==null||m(c.filter(W=>W!==M))},[c,m]),I=p.useCallback(M=>{const W=Array.isArray(M)?M:[M];y==null||y(W)},[y]);return t.jsxs("div",{className:`todo-metadata-form space-y-4 ${b?"text-sm":""}`,"data-test":"todo-metadata-form",children:[t.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-metadata-status-selector",children:[t.jsx(je,{"data-test":"todo-metadata-status-label",children:"Status"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(vd,{value:e,options:Dw,onChange:M=>l==null?void 0:l(M),placeholder:"Search status...","data-test":"todo-metadata-status-select"})})]}),t.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-metadata-priority-selector",children:[t.jsx(je,{"data-test":"todo-metadata-priority-label",children:"Priority"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(wr,{value:s,options:Pw,onChange:M=>d==null?void 0:d(M),placeholder:"Search priorities...",contentStyle:{zIndex:ke.draggablePopoverDropdown},"data-test":"todo-metadata-priority-badge"})})]}),t.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-metadata-category-selector",children:[t.jsx(je,{"data-test":"todo-metadata-category-label",children:"Category"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(bd,{value:n||"personal",onChange:M=>u==null?void 0:u(M),placeholder:"Search categories...","data-test":"todo-metadata-category-select"})})]}),!j&&S.length>1&&t.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-metadata-project-selector",children:[t.jsx(je,{"data-test":"todo-metadata-project-label",children:"Claude Project"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(wr,{value:r??"__no_project__",options:S,onChange:M=>f==null?void 0:f(M),placeholder:"Search projects...",contentStyle:{zIndex:ke.draggablePopoverDropdown},"data-test":"todo-metadata-project-badge"})})]}),x&&t.jsx(Mw,{value:a,onChange:g,showLabel:!0,className:"w-full"}),w&&t.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-metadata-session-selector",children:[t.jsx(je,{"data-test":"todo-metadata-session-selector-label",children:"Claude Sessions"}),t.jsx(Nd,{value:i,onChange:I,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-metadata-session-select"})]}),v&&t.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-metadata-tags-selector",children:[t.jsx(je,{"data-test":"todo-metadata-tags-label",children:"Tags"}),t.jsx($w,{tags:c,onAddTag:C,onRemoveTag:R})]}),t.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-metadata-due-date-field",children:[t.jsx(je,{htmlFor:"dueDate","data-test":"todo-metadata-due-date-label",children:"Due Date"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Yu,{className:"w-4 h-4 text-gray-400"}),t.jsx(Ae,{id:"dueDate",type:"date",value:o,onChange:M=>h==null?void 0:h(M.target.value),"data-test":"todo-metadata-due-date-input"})]})]})]})}function $w({tags:e,onAddTag:s,onRemoveTag:n}){const o=p.useCallback(a=>{if(a.key==="Enter"){a.preventDefault();const i=a.currentTarget;s(i.value),i.value=""}},[s]),r=p.useCallback(()=>{const a=document.querySelector('[data-test="todo-metadata-tag-input"]');a&&(s(a.value),a.value="")},[s]);return t.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-metadata-tags-container",children:[t.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-metadata-tags-list",children:e.map(a=>t.jsxs(qe,{variant:"outline",className:"tag-badge gap-1","data-test":`todo-metadata-tag-${a}`,children:[a,t.jsx("button",{onClick:()=>n(a),className:"tag-remove ml-1 hover:text-red-500","data-test":`todo-metadata-tag-remove-${a}`,children:t.jsx(We,{className:"w-3 h-3"})})]},a))}),t.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-metadata-tag-input-container",children:[t.jsx(Ae,{onKeyDown:o,placeholder:"Add a tag...","data-test":"todo-metadata-tag-input"}),t.jsx(ee,{onClick:r,size:"sm",className:"tag-add-button","data-test":"todo-metadata-tag-add-button",children:t.jsx(wt,{className:"w-4 h-4"})})]})]})}const Bw=({node:e})=>{const[s,n]=p.useState(!1),o=p.useRef(null),r=e.data,a=r==null?void 0:r.todo,i=p.useCallback(()=>{if(!o.current)return{x:100,y:100};const x=o.current.getBoundingClientRect();return{x:x.right+8,y:x.top}},[]),c=p.useCallback(x=>{const w=e.data??{},v=w.todo??{};E.getState().updateNode(e.id,{data:{...w,todo:{...v,...x}}})},[e.id,e.data]),l=p.useCallback(x=>{c({status:x})},[c]),d=p.useCallback(x=>{c({priority:x})},[c]),u=p.useCallback(x=>{c({category:x})},[c]),h=p.useCallback(x=>{c({dueDate:x||void 0})},[c]),f=p.useCallback(x=>{c({claudeProjectPath:x==="__no_project__"?void 0:x})},[c]),g=p.useCallback(x=>{c({sessionIds:x})},[c]),y=p.useCallback(x=>{c({forkSessionId:x??void 0})},[c]),m=a&&(a.status||a.priority||a.category||a.dueDate||a.claudeProjectPath||a.forkSessionId||a.sessionIds&&a.sessionIds.length>0);return t.jsxs(t.Fragment,{children:[t.jsx(ee,{ref:o,variant:"ghost",size:"icon",className:`todo-metadata-button h-8 w-8 ${m?"text-blue-500":"text-muted-foreground"}`,onClick:()=>n(!0),title:"Todo Metadata","data-test":"node-todo-metadata-button",children:t.jsx(Ku,{className:"h-4 w-4"})}),t.jsx(Be,{isVisible:s,onClose:()=>n(!1),title:"Todo Metadata",triggerPosition:i(),initialSize:{width:300,height:450},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx(Sd,{variant:"ghost",size:"icon",buttonTitle:"Create Claude Session",projectPath:a==null?void 0:a.claudeProjectPath,initialForkSessionId:a==null?void 0:a.forkSessionId,initialMessage:typeof e.content=="string"?e.content:"",useModal:!0}),children:t.jsx("div",{className:"p-4",children:t.jsx(Ww,{status:a==null?void 0:a.status,priority:a==null?void 0:a.priority,category:a==null?void 0:a.category,dueDate:a==null?void 0:a.dueDate,claudeProject:a==null?void 0:a.claudeProjectPath,forkSessionId:a==null?void 0:a.forkSessionId,sessionIds:a==null?void 0:a.sessionIds,onStatusChange:l,onPriorityChange:d,onCategoryChange:u,onDueDateChange:h,onClaudeProjectChange:f,onForkSessionIdChange:y,onSessionIdsChange:g,showForkSelector:!0,showSessionSelector:!0,showTags:!1,compact:!0})})})]})},Hw=({node:e})=>{const s=e.type===de.GROUP,n=e.type===de.VOCABULARY,o=se.nodeUI.idleOpacity;return t.jsxs("div",{className:Se("node-actions-sidebar absolute","gap-1","items-center","hover:opacity-100 transition-opacity duration-200"),style:{left:-50,opacity:o},onMouseEnter:r=>{r.currentTarget.style.opacity="1"},onMouseLeave:r=>{r.currentTarget.style.opacity=String(o)},"data-test":"node-container-extra",children:[t.jsx("div",{className:"pin-button-wrapper",children:t.jsx(kw,{node:e})}),t.jsx("div",{className:"text-editor-button-wrapper",children:e.subContent?t.jsx(wl,{className:"my-2"}):null}),t.jsx("div",{className:"tag-selector-wrapper",children:t.jsx(jw,{nodeId:e.id,tags:e.tags})}),t.jsx("div",{className:"todo-metadata-wrapper",children:t.jsx(Bw,{node:e})}),s&&t.jsx("div",{className:"group-settings-button-wrapper","data-test":"group-settings-wrapper",children:t.jsx(Ew,{node:e})}),n&&t.jsx("div",{className:"vocab-settings-button-wrapper","data-test":"vocab-settings-wrapper",children:t.jsx(Rw,{node:e})})]})},Fw={columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},_w=({node:e})=>{const{updateNode:s}=E.getState(),n=H(j=>{var k,S;return((k=j.uiState.tableDropTarget)==null?void 0:k.tableId)===e.id?((S=j.uiState.tableDropTarget)==null?void 0:S.columnKey)??null:null}),o=H(j=>{var k,S;return((k=j.uiState.tableDropTarget)==null?void 0:k.tableId)===e.id?((S=j.uiState.tableDropTarget)==null?void 0:S.rowIndex)??null:null}),[r,a]=p.useState(!1),i=p.useRef(null);p.useEffect(()=>{e.isEditing!==void 0&&e.isEditing!==r&&a(e.isEditing)},[e.isEditing]),p.useEffect(()=>{if(!r)return;const j=k=>{const S=k.target,C=i.current;C&&S.closest('[data-test="table-node-container"]')===C&&(k.stopPropagation(),k.preventDefault(),C.scrollTop+=k.deltaY,C.scrollLeft+=k.deltaX)};return document.addEventListener("wheel",j,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",j,{capture:!0})}},[r,e.id]);const c=e.data,l=c!=null&&c.rows&&(c!=null&&c.columns)?c:Fw,d=p.useCallback((j,k)=>{const S=l.columns.map(C=>C.key===j?{...C,header:k}:C);s(e.id,{data:{...l,columns:S}})},[e.id,l,s]),u=p.useCallback(j=>{const k=l.rows.filter(S=>S.id!==j);s(e.id,{data:{...l,rows:k}})},[e.id,l,s]),h=p.useMemo(()=>{const j=l.columns.map(k=>Dh(k.key,k.header,{width:k.width}));return j.push({id:"actions",header:()=>t.jsx("div",{"data-test":"actions-header"}),size:40,cell:({row:k})=>r?t.jsx(ee,{"data-test":"delete-row-button",variant:"ghost",size:"sm",onClick:()=>u(k.original.id),className:"h-6 w-6 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",children:t.jsx(pt,{className:"h-3 w-3"})}):null}),j},[l.columns,r,u]),f=p.useCallback((j,k,S)=>{const C=l.rows.map((R,I)=>I===j?{...R,[k]:S}:R);s(e.id,{data:{...l,rows:C}})},[e.id,l,s]),g=p.useCallback(()=>{const j={id:`row-${Date.now()}`};l.columns.forEach(k=>{j[k.key]=""}),s(e.id,{data:{...l,rows:[...l.rows,j]}})},[e.id,l,s]),y=p.useCallback(j=>{const k={id:`row-${Date.now()}`};l.columns.forEach(C=>{k[C.key]=""});const S=[...l.rows.slice(0,j),k,...l.rows.slice(j)];s(e.id,{data:{...l,rows:S}})},[e.id,l,s]),m=p.useCallback((j,k)=>{const S=[...l.rows],[C]=S.splice(j,1);S.splice(k,0,C),s(e.id,{data:{...l,rows:S}})},[e.id,l,s]),x=p.useCallback(j=>{s(e.id,{data:{...l,columnOrder:j}})},[e.id,l,s]),w=p.useCallback(()=>{const j=!r;a(j),s(e.id,{isEditing:j})},[r,e.id,s]),v=p.useCallback(()=>{r||(a(!0),s(e.id,{isEditing:!0}))},[r,e.id,s]),b=p.useCallback(j=>{r&&(j.stopPropagation(),j.nativeEvent.stopPropagation(),j.nativeEvent.stopImmediatePropagation())},[r,e.id]),N=p.useCallback(()=>{const j=i.current;if(!j)return;const k=document.querySelector("[data-canvas-container]"),S=k==null?void 0:k.getBoundingClientRect();ic(async()=>{const{canvasStoreV2:C}=await import("./index-hTFRJyrx.js").then(R=>R.d0);return{canvasStoreV2:C}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({canvasStoreV2:C})=>{const R=C.getState().projectCanvas.getActive(),I=(R==null?void 0:R.viewState.scale)??1,M=(R==null?void 0:R.viewState.offset)??{x:0,y:0},W=D=>{if(!S)return null;const L=D.x-S.left,A=D.y-S.top;return{x:Math.round((L-M.x)/I),y:Math.round((A-M.y)/I),w:Math.round(D.width/I),h:Math.round(D.height/I)}};j.getBoundingClientRect();const B=j.querySelector("thead tr");B==null||B.getBoundingClientRect();const F=j.querySelectorAll("tbody tr");Array.from(F).map((D,L)=>({index:L,canvas:W(D.getBoundingClientRect())}))})},[e.id,e.x,e.y]);return t.jsx("div",{ref:i,"data-test":"table-node-container",style:{width:"100%",height:"100%",overflow:r?"auto":"hidden"},onDoubleClick:v,onWheel:b,onClick:N,children:t.jsx(Oh,{data:l.rows,columns:h,isEditing:r,onDataUpdate:f,onHeaderUpdate:d,onAddNewRow:r?g:void 0,onInsertRow:r?y:void 0,enableColumnReorder:r,onColumnOrderChange:x,enableRowReorder:r,onRowOrderChange:m,highlightColumnKey:n,highlightRowIndex:o,topRight:t.jsxs("div",{className:"flex items-center gap-1","data-test":"table-header-actions",children:[t.jsx(ee,{"data-test":"table-edit-toggle",onClick:w,size:"sm",variant:"outline",className:"h-6 text-xs",children:r?"Done":"Edit"}),t.jsx(Oo,{storageKey:"table-node-drop-config",initialConfig:{dropBehavior:se.canvasTable.dropBehavior},children:(j,k,S)=>t.jsx(S,{size:"smIconCompact",variant:"ghost",title:"Table Drop Settings",contentClassName:"w-48",children:t.jsxs("div",{className:"space-y-3","data-test":"table-drop-config",children:[t.jsx("div",{className:"text-sm font-medium","data-test":"config-title",children:"On node drop"}),t.jsxs(Lh,{value:j.dropBehavior,onValueChange:C=>k({dropBehavior:C}),"data-test":"drop-behavior-radio",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Ir,{value:"copy",id:"copy","data-test":"radio-copy"}),t.jsx(je,{htmlFor:"copy",className:"text-sm cursor-pointer","data-test":"label-copy",children:"Copy nodes"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Ir,{value:"delete",id:"delete","data-test":"radio-delete"}),t.jsx(je,{htmlFor:"delete",className:"text-sm cursor-pointer","data-test":"label-delete",children:"Delete nodes"})]})]})]})})})]})})})},zw=({node:e,preventEdit:s})=>{var M;const n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(e.title||""),[l,d]=p.useState(e.content||""),{onEditStart:u,onEditEnd:h}=Gs(e.id,"title"),{onEditStart:f,onEditEnd:g}=Gs(e.id,"content"),y=E.getState(),m=y.updateNode,x=y.setMode,w=y.uiState.nodeToFocusId,v=(M=y.projectCanvas.getActive())==null?void 0:M.coreState,b=(v==null?void 0:v.selectedNodes)??[],N=b.some(W=>W.id===e.id),j=N&&w===e.id,k=W=>{c(W.target.value)},S=W=>{d(W.target.value)},C=p.useCallback(()=>{var W;m(e.id,{title:i,content:l,isEditing:!1}),h(i),g(l),a(!1),(W=window.getSelection())==null||W.removeAllRanges()},[e.id,m,i,l,h,g]),R=p.useCallback(()=>{N&&b.length<=1&&!s&&(r||(u(e.title||""),f(e.content||"")),a(!0),m(e.id,{isEditing:!0}))},[N,b.length,s,m,e.id,r,e.title,e.content,u,f]),I=p.useCallback(W=>{var B,F;if(W.key==="Escape"){C(),E.getState().uiState.mode!==Q.VIM&&x(Q.SELECT),(B=n.current)==null||B.blur(),(F=o.current)==null||F.blur();return}},[C,x]);return p.useEffect(()=>{j&&r&&n.current&&n.current.focus()},[j,r]),p.useEffect(()=>{c(e.title||""),d(e.content||"")},[e.title,e.content]),t.jsxs("div",{className:"w-full h-full flex flex-col",children:[t.jsx("div",{className:"title-section border-b",children:t.jsx("input",{ref:n,type:"text",value:i,onChange:k,onBlur:C,onMouseDown:R,onKeyDown:I,placeholder:"Title...",className:Se("w-full px-2 py-1","text-sm font-semibold","border-none focus:outline-none","bg-transparent",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})}),t.jsx("div",{className:"content-section flex-1",children:t.jsx("textarea",{ref:o,value:l,onChange:S,onBlur:C,onMouseDown:R,onKeyDown:I,placeholder:"Content...",className:Se("w-full h-full","px-2 py-1","text-sm","border-none focus:outline-none","bg-transparent","resize-none","overflow-hidden",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})})]})},Uw=({node:e,isSingleNodeSelected:s,isCollapsed:n=!1})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(e.title||""),c=p.useRef(null),l=p.useRef(e.title||""),{onEditStart:d,onEditEnd:u}=Gs(e.id,"title");p.useEffect(()=>{i(e.title||""),l.current=e.title||""},[e.title]),p.useEffect(()=>{l.current=a},[a]),p.useEffect(()=>{o&&c.current&&(c.current.focus(),c.current.select())},[o]),p.useEffect(()=>{if(s)return()=>{const N=l.current.trim();N!==e.title&&E.getState().updateNodeTitle(e.id,N)}},[s,e.id,e.title]);const h=p.useCallback(()=>{const N=a.trim();N!==e.title&&E.getState().updateNodeTitle(e.id,N),u(N),r(!1)},[e.id,a,e.title,u]),f=p.useCallback(N=>{N.key==="Enter"?(N.preventDefault(),h()):N.key==="Escape"&&(N.preventDefault(),i(e.title||""),r(!1))},[h,e.title]),g=()=>{if(e.title)return e.title;if(typeof e.content=="string"){const N=e.content.split(`
`)[0];return N.length>50?N.substring(0,50)+"...":N}return"(empty)"},y=p.useMemo(()=>e.title?Tr(e.title):"",[e.title]),m=p.useMemo(()=>{const N=g();return Tr(N)},[e.title,e.content]),x=H(N=>{var S;const k=(((S=N.projectCanvas.getActive())==null?void 0:S.coreState.nodes)??[]).find(C=>C.id===e.id);return(k==null?void 0:k.isCollapsed)??!1}),w=p.useCallback(N=>{N.stopPropagation(),N.preventDefault(),E.getState().updateNode(e.id,{isCollapsed:!x})},[e.id,x]),v=se.nodeUI.idleOpacity,b=t.jsx(ee,{title:x?"Expand node":"Collapse node",variant:"ghost",size:"icon",onClick:w,className:"absolute h-6 w-6 flex-shrink-0 transition-opacity duration-200",style:{left:-43,opacity:v},onMouseEnter:N=>{N.currentTarget.style.opacity="1"},onMouseLeave:N=>{N.currentTarget.style.opacity=String(v)},"data-test":"node-title-collapse-button",children:x?t.jsx(Ks,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(Et,{className:"h-3.5 w-3.5"})});return n?t.jsxs("div",{className:"markdown-textarea absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-collapsed",children:[b,t.jsx("div",{className:"px-2 py-0.5 bg-background/90 truncate border border-dashed border-muted-foreground rounded [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:m}})]}):!e.title&&!s?null:t.jsxs("div",{className:"absolute flex gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-container",children:[s&&b,s?t.jsx("input",{ref:c,type:"text",value:a,onChange:N=>i(N.target.value),onBlur:h,onKeyDown:f,placeholder:"Add title...",className:"relative left-0 text-xs px-2 py-0.5 bg-background/90 w-full",onClick:N=>{N.stopPropagation(),o||d(e.title||""),r(!0)}}):e.title?t.jsx("div",{className:"text-xs px-2 py-0.5 bg-background/90 truncate [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:y}}):null]})};function Vw(e,s){return e.node.title===s.node.title&&e.node.width===s.node.width&&e.node.content===s.node.content&&e.isSingleNodeSelected===s.isSingleNodeSelected&&e.isCollapsed===s.isCollapsed}const Gw=Ce.memo(Uw,Vw),Yw=(e,s)=>p.useMemo(()=>{if(s.length!==1)return-1;const n=s[0].id;return e.findIndex(o=>o.id===n)},[e,s]),Kw={[de.RECT]:t.jsx(Ht,{className:"w-4 h-4"}),[de.TEXT]:t.jsx(Xu,{className:"w-4 h-4"})},Vo=e=>Kw[e]??null,Xw=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{const[r,a]=p.useState(!1),[i,c]=p.useState(null),[l,d]=p.useState(!1),u=p.useRef(null),h=p.useCallback(m=>{const w=(l?e:s).map(v=>{const b=Array.isArray(v.tags)?v.tags:[];if(b.some(k=>k.title===m))return v;const j={id:Math.random().toString(36).slice(2,10),title:m};return{...v,tags:[...b,j]}});n(w),o()},[l,e,s,n,o]),f=p.useCallback(m=>{const w=(l?e:s).map(v=>{const b=Array.isArray(v.tags)?v.tags:[];return b.some(j=>j.title===m)?{...v,tags:b.filter(j=>j.title!==m)}:v});n(w),o()},[l,e,s,n,o]),g=Ce.useMemo(()=>{const m=l?e:s,x=new Set;return m.forEach(w=>{(Array.isArray(w.tags)?w.tags:[]).forEach(b=>x.add(b.title))}),Array.from(x).sort()},[l,e,s]),y=Ce.useMemo(()=>{const m=new Set;return e.forEach(x=>{(Array.isArray(x.tags)?x.tags:[]).forEach(v=>m.add(v.title))}),Array.from(m).sort()},[e]);return t.jsxs(t.Fragment,{children:[t.jsx(as,{ref:u,onMouseDown:m=>m.stopPropagation(),onClick:m=>{if(m.stopPropagation(),u.current){const x=u.current.getBoundingClientRect();c({x:x.left,y:x.bottom+4})}a(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Tag nodes","data-test":"nodes-info-tag-button",children:t.jsx(In,{})}),t.jsx(Be,{isVisible:r,onClose:()=>a(!1),title:"Tag Nodes",triggerPosition:i??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"apply-to-section space-y-2 pb-2 border-b",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:m=>d(m.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"tag-apply-to-all-checkbox"}),t.jsx("span",{children:"Apply to all nodes"})]}),t.jsx("div",{className:"text-xs text-muted-foreground ml-6",children:l?`Will apply to all ${e.length} nodes`:`Will apply to ${s.length} selected node${s.length!==1?"s":""}`})]}),t.jsx(Po,{tags:g,onAddTag:h,onRemoveTag:f,canvasTags:y})]})})]})},qw={content:!0,title:!1,id:!1,type:!1,tags:!1},an=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const u=n?l:l.toLowerCase();let h=0,f=u.indexOf(a,h);for(;f!==-1;){const g=Math.max(0,f-40),y=Math.min(l.length,f+a.length+40);let m=l.substring(g,y);g>0&&(m="..."+m),y<l.length&&(m=m+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:m,startIndex:f,field:o}),h=f+1,f=u.indexOf(a,h)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let f=e.substring(u,h);u>0&&(f="..."+f),h<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},Zw=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...an(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...an(e.title,s,n,"title")),o.id&&e.id&&r.push(...an(e.id,s,n,"id")),o.type&&e.type&&r.push(...an(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...an(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},Jw=e=>{const{node:s,matches:n}=e,o=Vo(s.type),r=s.id.substring(0,6),a=typeof s.content=="string"?s.content:"",i=s.title?`${s.title.substring(0,30)}${s.title.length>30?"...":""}`:a?`${a.substring(0,30)}${a.length>30?"...":""}`:"(No Content)",c=s.title&&a?`${a.substring(0,50)}${a.length>50?"...":""}`:null;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[o&&t.jsx("span",{className:"flex-shrink-0",children:o}),t.jsx("span",{className:"truncate",children:i}),s.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(qe,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[n.length," ",n.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:r})]}),c&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:c})]})},Qw=(e,s,n,o)=>{const r=n?s:s.toLowerCase(),i=(n?e.context:e.context.toLowerCase()).indexOf(r);if(i===-1)return t.jsxs("div",{className:"text-xs font-mono flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:e.context})]});const c=e.context.substring(0,i),l=e.context.substring(i,i+s.length),d=e.context.substring(i+s.length);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsxs("span",{className:"flex-1",children:[c,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:l}),d]})]})},ey=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(!1),[r,a]=p.useState(null),[i,c]=p.useState(""),[l,d]=p.useState(!1),[u,h]=p.useState(qw),f=p.useRef(null),[g,y]=p.useState(new Set),[m,x]=p.useState(!1),w=l||u.title||u.id||u.type||u.tags||!u.content,v=p.useMemo(()=>{if(!i.trim())return[];if(!Object.values(u).some(I=>I))return[];const R=[];return e.forEach(I=>{if(g.has(I.id))return;const M=Zw(I,i,l,u);M&&R.push(M)}),R},[e,i,l,u,g]),b=p.useMemo(()=>v.reduce((C,R)=>C+R.matches.length,0),[v]),N=p.useCallback(()=>{if(v.length>0){const C=v.map(R=>R.node);s(C)}},[v,s]),j=p.useCallback(C=>{y(R=>new Set(R).add(C))},[]),k=p.useCallback(C=>{const R=C.node;s([R]),E.getState().scrollToNode(R.id)},[s]),S=p.useCallback((C,R)=>{const I=C.node;s([I]);const M=pe.LINE_HEIGHT_FIND,W=R?(R-1)*M:0;Ln(I,{highlightYOffset:W})},[s]);return t.jsxs(t.Fragment,{children:[t.jsx(as,{ref:f,onMouseDown:C=>C.stopPropagation(),onClick:C=>{if(C.stopPropagation(),f.current){const R=f.current.getBoundingClientRect();a({x:R.left,y:R.bottom+4})}o(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Find nodes","data-test":"nodes-info-find-button",children:t.jsx(ms,{})}),t.jsx(Be,{isVisible:n,onClose:()=>{o(!1)},title:"Find Nodes",triggerPosition:r??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-3 space-y-3","data-test":"find-nodes-popover-content",children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"find-nodes-search-section",children:[t.jsx(ms,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"find-nodes-search-icon"}),t.jsx(Ae,{type:"text",placeholder:"Search nodes...",value:i,onChange:C=>c(C.target.value),onKeyDown:C=>{C.key==="Enter"&&i.trim()&&(C.preventDefault(),N())},className:we("h-8 text-sm pl-8",i?"pr-16":"pr-10"),autoFocus:!0,"data-test":"find-nodes-search-input"}),i&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>c(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"find-nodes-clear-button",children:t.jsx(We,{className:"h-3 w-3"})}),w&&t.jsx("div",{className:we("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",i?"right-16":"right-11"),"data-test":"find-nodes-filter-indicator"}),t.jsxs(ot,{open:m,onOpenChange:x,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"find-nodes-settings-button",children:t.jsx(Ho,{className:"h-3.5 w-3.5"})})}),t.jsx(rt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:ke.draggablePopoverDropdown},"data-test":"find-nodes-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"find-case-sensitive",checked:l,onCheckedChange:C=>d(!!C),"data-test":"find-nodes-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"find-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"find-node-content",checked:u.content,onCheckedChange:C=>h(R=>({...R,content:!!C})),"data-test":"find-nodes-content-checkbox"}),t.jsx("label",{htmlFor:"find-node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"find-node-title",checked:u.title,onCheckedChange:C=>h(R=>({...R,title:!!C})),"data-test":"find-nodes-title-checkbox"}),t.jsx("label",{htmlFor:"find-node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"find-node-id",checked:u.id,onCheckedChange:C=>h(R=>({...R,id:!!C})),"data-test":"find-nodes-id-checkbox"}),t.jsx("label",{htmlFor:"find-node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"find-node-type",checked:u.type,onCheckedChange:C=>h(R=>({...R,type:!!C})),"data-test":"find-nodes-type-checkbox"}),t.jsx("label",{htmlFor:"find-node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"find-node-tags",checked:u.tags,onCheckedChange:C=>h(R=>({...R,tags:!!C})),"data-test":"find-nodes-tags-checkbox"}),t.jsx("label",{htmlFor:"find-node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]})]})})]})]}),i.trim()&&t.jsx("div",{className:"results-section space-y-2","data-test":"find-nodes-results-section",children:t.jsx("div",{className:"results-info flex items-center justify-between","data-test":"find-nodes-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground","data-test":v.length===0?"find-nodes-no-matches":"find-nodes-match-count",children:v.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found ",t.jsx(qe,{variant:"secondary",className:"mx-1","data-test":"find-nodes-total-matches-badge",children:b}),b===1?"match":"matches"," in"," ",t.jsx(qe,{variant:"secondary",className:"mx-1","data-test":"find-nodes-nodes-count-badge",children:v.length}),v.length===1?"node":"nodes"]})})})}),v.length>0&&t.jsx("div",{className:"nodes-list-section space-y-2 max-h-[400px] overflow-y-auto","data-test":"find-nodes-list-section",children:v.map(C=>t.jsx("div",{className:"node-matches-container border border-border rounded-md overflow-hidden","data-test":`find-nodes-result-${C.nodeId}`,children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>j(C.nodeId),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":`find-nodes-remove-result-button-${C.nodeId}`,children:t.jsx(We,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none","data-test":`find-nodes-result-content-${C.nodeId}`,children:[t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:()=>k(C),"data-test":`find-nodes-result-header-${C.nodeId}`,children:Jw(C)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":`find-nodes-result-matches-${C.nodeId}`,children:C.matches.map((R,I)=>t.jsx("div",{onClick:M=>{M.stopPropagation(),S(C,R.lineNumber)},"data-test":`find-nodes-match-${C.nodeId}-${I}`,children:Qw(R,i,l)},I))})]})]})},C.nodeId))})]})})]})},ty=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{var b;const r=E.getState(),a=r.setNodeUpdateSettings,i=((b=r.uiState)==null?void 0:b.nodeUpdateSettings)??{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},[c,l]=p.useState(!1),[d,u]=p.useState(i.searchHistory[0]??""),[h,f]=p.useState(null),g=Ce.useRef(null),[y,m]=p.useState(i.deleteInAllNodes),[x,w]=p.useState(i.deleteWholeLine),v=p.useCallback(()=>{if(!d)return;const j=(y?e:s).map(S=>{if(typeof S.content!="string")return S;let C=S.content;x?C=C.split(`
`).filter(B=>!B.includes(d)).join(`
`):C=C.split(d).join("");const R=S.width??pe.DEFAULT_NODE_WIDTH,I=ct(C,{containerWidth:R})+pe.NODE_Y_PADDING*2;return{...S,content:C,height:I}});n(j);const k=[d,...i.searchHistory.filter(S=>S!==d)].slice(0,10);a({deleteInAllNodes:y,deleteWholeLine:x,searchHistory:k}),o(),console.log(`Deleted "${d}" from ${j.length} nodes (wholeLine: ${x})`)},[d,y,x,e,s,n,i.searchHistory,a,o]);return t.jsxs(t.Fragment,{children:[t.jsx(as,{ref:g,onMouseDown:N=>N.stopPropagation(),onClick:N=>{if(N.stopPropagation(),g.current){const j=g.current.getBoundingClientRect();f({x:j.left,y:j.bottom+4})}l(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Update nodes","data-test":"nodes-info-update-button",children:t.jsx(Hs,{})}),t.jsx(Be,{isVisible:c,onClose:()=>l(!1),title:"Update Nodes",triggerPosition:h??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:d,onChange:N=>u(N.target.value),placeholder:"Text to delete...",className:"flex-1 px-2 py-1 text-sm border rounded bg-background","data-test":"update-nodes-search-input"}),t.jsxs("button",{onClick:v,disabled:!d,className:"flex items-center gap-1 px-2 py-1 text-sm rounded bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors","data-test":"update-nodes-delete-button",children:[t.jsx(pt,{className:"w-3 h-3"}),"Delete"]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:y,onChange:N=>{const j=N.target.checked;m(j),a({deleteInAllNodes:j}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-all-nodes-checkbox"}),t.jsx("span",{children:"Delete in all nodes"})]}),t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:x,onChange:N=>{const j=N.target.checked;w(j),a({deleteWholeLine:j}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-whole-line-checkbox"}),t.jsx("span",{children:"Delete whole line"})]})]}),t.jsx("div",{className:"text-xs text-muted-foreground",children:y?`Will update all ${e.length} nodes`:`Will update ${s.length} selected node${s.length!==1?"s":""}`})]})})]})},sy=e=>{const s=Vo(e.type),n=String(e.content??""),o=n?`${n.substring(0,15)}${n.length>15?"...":""}`:"(No Content)",r=e.id.substring(0,6),a=`[x:${Math.round(e.x)},y:${Math.round(e.y)}]`,i=`[w:${Math.round(e.width??0)},h:${Math.round(e.height??0)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"node-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"node-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"node-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"node-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"node-display-text",children:o}),e.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0","data-test":"node-display-editing-indicator",children:"[E]"})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"node-display-id",children:r})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1","data-test":"node-display-coords",children:[a," ",i]})]})},Ol=e=>{const{className:s,style:n,nodes:o,headerText:r,initiallyExpanded:a}=e,i=E.getState(),c=i.projectCanvas.getActive(),l=o??(c==null?void 0:c.coreState.nodes)??[],d=(c==null?void 0:c.coreState.selectedNodes)??[],u=i.setSelectedNodes,h=i.scrollToNode,f=i.updateNodes,g=i.saveStateToLocalStorage,y=p.useCallback((w,v)=>{const b=w.length>0?w[0]:-1;if(b>=0&&b<l.length){const N=l[b];u([N]),h(N.id)}else u([])},[l,u,h]),m=Yw(l,d),x=m!==-1?[m]:[];return t.jsx("div",{"data-ui-panel":"canvas-node-infos","data-test":"canvas-node-infos-container",className:Se("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:w=>w.stopPropagation(),children:t.jsx(Fa,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-node-infos-header",children:r??"Nodes"}),itemList:l.map(sy),onSelectionChange:y,selectedIndices:x,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!a,moreOptions:t.jsxs(t.Fragment,{children:[t.jsx(ey,{nodes:l,setSelectedNodes:u}),t.jsx(Xw,{nodes:l,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:g}),t.jsx(ty,{nodes:l,selectedNodes:d,updateNodes:f,saveStateToLocalStorage:g})]})})})},ny=({tag:e})=>{const[s,n]=p.useState(!1),o=p.useMemo(()=>{if(!s)return[];const i=E.getState().projectCanvas.getActive();return((i==null?void 0:i.coreState.nodes)??[]).filter(l=>Array.isArray(l.tags)&&l.tags.some(d=>d.title===e.title))},[s,e.title]),r=p.useCallback(a=>{a.stopPropagation()},[]);return t.jsxs(ot,{open:s,onOpenChange:n,children:[t.jsx(at,{asChild:!0,children:t.jsxs(qe,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-5 bg-background/90 text-muted-foreground font-normal italic cursor-pointer hover:bg-accent","data-test":`node-tag-${e.id}`,onClick:r,children:["#",e.title]})}),t.jsx(rt,{className:"p-0 w-auto",align:"end",onPointerDownOutside:a=>a.stopPropagation(),onClick:a=>a.stopPropagation(),children:t.jsx(Ol,{nodes:o,headerText:`#${e.title}`,className:"border-0",initiallyExpanded:!0})})]})},oy=({node:e})=>!e.tags||!Array.isArray(e.tags)||e.tags.length===0?null:t.jsx("div",{className:"absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",right:"0px"},"data-test":"node-tags-container",children:e.tags.map(s=>t.jsx(ny,{tag:s},s.id))});function ay(e,s){const n=e.node.tags,o=s.node.tags;if(n===o)return!0;const r=Array.isArray(n),a=Array.isArray(o);return!r&&!a?!0:!r||!a||n.length!==o.length?!1:n.every((i,c)=>{var l,d;return i.id===((l=o[c])==null?void 0:l.id)&&i.title===((d=o[c])==null?void 0:d.title)})}const ry=Ce.memo(oy,ay);function iy({node:e,isSelected:s,scale:n}){const r=(typeof e.content=="string"?e.content:"").split(`

`).filter(u=>u.trim().length>0),a=e.width??pe.DEFAULT_NODE_WIDTH;e.height??pe.DEFAULT_NODE_HEIGHT;const c=document.createElement("canvas").getContext("2d"),l=[];if(c){c.font=getComputedStyle(document.body).font;for(const u of r){const h=u.split(`
`);let f=0;for(const m of h){if(m.trim()===""){f++;continue}const x=m.split(" ");let w="",v=1;for(let b=0;b<x.length;b++){const N=x[b],j=w+(w?" ":"")+N;c.measureText(j).width>a&&w!==""?(v++,w=N):w=j}f+=v}const g=u.length;let y;g<100?y=40+g/100*20:g<300?y=60+(g-100)/200*25:y=Math.min(95,85+(g-300)/500*10),l.push({lines:f,widthPercent:Math.round(y),charCount:g})}}return{jsx:t.jsx("div",{className:"w-full h-full flex flex-col gap-2 p-2",children:l.map((u,h)=>t.jsx("div",{className:"rounded flex flex-col gap-[2px]",style:{height:`${u.lines*pe.LINE_HEIGHT}px`,width:`${u.widthPercent}%`,backgroundColor:"transparent"},children:Array.from({length:u.lines}).map((f,g)=>t.jsx("div",{className:"rounded",style:{height:`${pe.LINE_HEIGHT-4}px`,width:"100%",backgroundColor:s?"#93c5fd":"hsl(var(--foreground))"}},g))},h))}),blockMetrics:l}}const Ll=p.createContext(null),Wl=()=>{const e=p.useContext(Ll);if(!e)throw new Error("useWorkflowExecution must be used within a WorkflowExecutionProvider. Make sure CanvasAppV2 wraps its content with the provider.");return e},cy=({children:e,value:s})=>t.jsx(Ll.Provider,{value:s,children:e}),$l=({nodeId:e,label:s="Execute Workflow",className:n})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(null),c=Wl(),{executeWorkflow:l}=c,d=h=>{h.stopPropagation()},u=async h=>{h.stopPropagation(),r(!0),i(null);try{await l(!1,e)}catch(f){const g=f instanceof Error?f.message:String(f);i(g)}finally{r(!1)}};return t.jsxs("div",{className:"w-full",children:[t.jsx(ee,{"data-test":"workflow-execute-button",onPointerDown:d,onClick:u,disabled:o,className:we("w-full bg-primary hover:bg-primary/70 text-primary-foreground","disabled:bg-muted disabled:text-muted-foreground disabled:cursor-not-allowed",n),size:"sm",children:o?t.jsxs(t.Fragment,{children:[t.jsx(On,{className:"w-4 h-4 animate-spin"}),"Executing..."]}):t.jsxs(t.Fragment,{children:[t.jsx(Ze,{className:"w-4 h-4"}),s]})}),a&&t.jsxs("div",{className:"text-xs text-destructive mt-1",children:["Error: ",a]})]})},ly=({executionState:e,duration:s,className:n})=>{if(!e||e==="idle")return null;const r={pending:{color:"bg-gray-500",textColor:"text-white",icon:null,label:"Pending"},running:{color:"bg-blue-500",textColor:"text-white",icon:t.jsx(On,{className:"w-3 h-3 animate-spin"}),label:"Running"},success:{color:"bg-green-500",textColor:"text-white",icon:t.jsx(Bs,{className:"w-3 h-3"}),label:"Success"},error:{color:"bg-red-500",textColor:"text-white",icon:t.jsx(We,{className:"w-3 h-3"}),label:"Error"}}[e];return t.jsxs("div",{"data-test":`workflow-execution-badge-${e}`,className:we("absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium","flex items-center gap-1",r.color,r.textColor,n),children:[r.icon&&t.jsx("span",{"data-test":`workflow-execution-badge-icon-${e}`,children:r.icon}),t.jsx("span",{"data-test":"workflow-execution-badge-label",children:r.label}),s&&t.jsxs("span",{"data-test":"workflow-execution-badge-duration",className:"ml-1",children:["(",s,"ms)"]})]})};class Yn{static convertOrchestrationNode(s,n){var c;const o=s.data,r=((c=o==null?void 0:o.parameters)==null?void 0:c.rows)||[],a=this.convertRowsToNodes(r),i=[...this.createConnectionsFromRowHierarchy(r),...this.createConnectionsFromArrows(s.id,n)];return{nodes:a,connections:i}}static convertRowsToNodes(s){const n=[];for(const o of s){const r={id:o.id,type:o.stepType||"unknown",parameters:{label:o.label,order:o.order,...o.config||{}},inputHandles:this.createHandlesForStepType(o.stepType,"input",o.id),outputHandles:this.createHandlesForStepType(o.stepType,"output",o.id)};if(n.push(r),o.children&&o.children.length>0){const a=this.convertRowsToNodes(o.children);n.push(...a)}}return n}static createHandlesForStepType(s,n,o){const r=["source","transform","nodeUpdate","condition","if"],a=["source","transform","nodeUpdate","condition","if","loop"];return n==="input"&&r.includes(s)?[{id:`input_${o}`,name:"Input",type:"input",dataType:"any"}]:n==="output"&&a.includes(s)?[{id:`output_${o}`,name:"Output",type:"output",dataType:"any"}]:[]}static createConnectionsFromRowHierarchy(s,n){const o=[];for(const r of s)if(n&&o.push({id:`conn_${n}_to_${r.id}`,sourceNodeId:n,sourceHandleId:`output_${n}`,targetNodeId:r.id,targetHandleId:`input_${r.id}`}),r.children&&r.children.length>0){const a=this.createConnectionsFromRowHierarchy(r.children,r.id);o.push(...a)}return o}static createConnectionsFromArrows(s,n){const o=[],r=n.filter(a=>a.endNodeId===s&&a.endRowId);for(const a of r){const i={id:a.id,sourceNodeId:a.startNodeId||"",sourceHandleId:a.startRowId||`output_${a.startNodeId}`,targetNodeId:a.endRowId||"",targetHandleId:a.endRowId||`input_${a.endRowId}`};o.push(i)}return o}static getWorkflowName(s){return s.title||"Untitled Workflow"}static getWorkflowDescription(s){var r,a;const n=s.data,o=((a=(r=n==null?void 0:n.parameters)==null?void 0:r.rows)==null?void 0:a.length)||0;return`Workflow with ${o} step${o!==1?"s":""}`}}class dy{constructor(s=[]){Oe(this,"crudService");this.crudService=new fc(s)}create(s){const n=new Date().toISOString(),o=this.crudService.create({name:s.name,description:s.description,tags:s.tags||[],nodes:s.nodes||[],connections:s.connections||[],version:1,createdAt:n,updatedAt:n});if(!o)throw new Error("Failed to create workflow definition");return o}getAll(){return this.crudService.readAll()}getById(s){return this.crudService.readById(s)}update(s,n){const o=this.crudService.readById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt,updatedAt:new Date().toISOString(),version:(o.version||1)+1};return this.crudService.update(r),r}delete(s){this.crudService.delete(s)}findByTag(s){return this.crudService.readAll().filter(n=>{var o;return(o=n.tags)==null?void 0:o.includes(s)})}findByName(s){const n=s.toLowerCase();return this.crudService.readAll().filter(o=>o.name.toLowerCase().includes(n))}count(){return this.crudService.count()}clear(){this.crudService.clear()}updateNodes(s,n){return this.update(s,{nodes:n})}updateConnections(s,n){return this.update(s,{connections:n})}addNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.nodes,n];return this.updateNodes(s,r)}removeNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.nodes.filter(i=>i.id!==n),a=o.connections.filter(i=>i.sourceNodeId!==n&&i.targetNodeId!==n);return this.update(s,{nodes:r,connections:a})}addConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.connections,n];return this.updateConnections(s,r)}removeConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.connections.filter(a=>a.id!==n);return this.updateConnections(s,r)}duplicate(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);return this.create({name:n,description:o.description,tags:o.tags?[...o.tags]:void 0,nodes:o.nodes.map(r=>({...r})),connections:o.connections.map(r=>({...r}))})}}class Da{constructor(s=[],n=[]){Oe(this,"definitionService");Oe(this,"instanceService");Oe(this,"executionFacade");this.definitionService=new dy(s),this.instanceService=new fc(n),this.executionFacade=new zs}createDefinition(s){return this.definitionService.create(s)}getAllDefinitions(){return this.definitionService.getAll()}getDefinitionById(s){return this.definitionService.getById(s)}updateDefinition(s,n){return this.definitionService.update(s,n)}deleteDefinition(s){this.instanceService.filterByKey("definitionId",s).forEach(o=>this.instanceService.delete(o.id)),this.definitionService.delete(s)}findDefinitionsByTag(s){return this.definitionService.findByTag(s)}findDefinitionsByName(s){return this.definitionService.findByName(s)}duplicateDefinition(s,n){return this.definitionService.duplicate(s,n)}createInstance(s,n){const o=this.definitionService.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=new Date().toISOString(),a=this.instanceService.create({definitionId:s,name:n||o.name,status:"idle",createdAt:r,executionHistory:[]});if(!a)throw new Error("Failed to create workflow instance");return a}getAllInstances(){return this.instanceService.readAll()}getInstanceById(s){return this.instanceService.readById(s)}getInstancesByDefinitionId(s){return this.instanceService.filterByKey("definitionId",s)}updateInstance(s,n){const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt};this.instanceService.update(r)}deleteInstance(s){this.instanceService.delete(s)}async executeInstance(s,n={}){var a;const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r=this.definitionService.getById(o.definitionId);if(!r)throw new Error(`Workflow definition not found: ${o.definitionId}`);this.updateInstance(s,{status:"running"});try{const i=this.convertWorkflowNodesToCanvas(r.nodes),c=this.convertWorkflowConnectionsToCanvas(r.connections);this.executionFacade.loadWorkflow(i,c);const l=await this.executionFacade.executeWorkflow(n.triggerNodeId||((a=i[0])==null?void 0:a.id)||""),d=l.executionId?await this.executionFacade.getExecution(l.executionId):null;if(d){const h=[...o.executionHistory,d];this.updateInstance(s,{status:l.success?"completed":"failed",lastExecutedAt:new Date().toISOString(),executionHistory:h})}return{success:l.success,executionId:l.executionId||"",instanceId:s,definitionId:o.definitionId,duration:l.duration||0,executedNodeCount:l.executedNodeCount||0,errors:l.errors||[],nodeUpdates:l.nodeUpdates}}catch(i){throw this.updateInstance(s,{status:"failed"}),i}}getExecutionHistory(s){const n=this.instanceService.readById(s);if(!n)throw new Error(`Workflow instance not found: ${s}`);return n.executionHistory}clearExecutionHistory(s){this.updateInstance(s,{executionHistory:[]})}convertWorkflowNodesToCanvas(s){return s.map(n=>({id:n.id,x:0,y:0,type:"workflow",data:{nodeType:n.type,parameters:n.parameters,inputHandles:n.inputHandles,outputHandles:n.outputHandles},width:200,height:100}))}convertWorkflowConnectionsToCanvas(s){return s.map(n=>({id:n.id,startNodeId:n.sourceNodeId,endNodeId:n.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0},startRowId:n.sourceHandleId,endRowId:n.targetHandleId}))}getStats(){const s=this.instanceService.readAll(),n=s.reduce((o,r)=>(o[r.status]=(o[r.status]||0)+1,o),{});return{totalDefinitions:this.definitionService.count(),totalInstances:s.length,instancesByStatus:n}}clearAll(){this.definitionService.clear(),this.instanceService.clear()}}class Oa{constructor(s,n){Oe(this,"workflowManager");this.getCanvasState=n,this.workflowManager=s||new Da}saveWorkflow(s){const{nodeId:n,name:o,description:r,tags:a}=s,{node:i,arrows:c}=this.getNodeAndArrows(n),{nodes:l,connections:d}=Yn.convertOrchestrationNode(i,c),u=o||Yn.getWorkflowName(i),h=r||Yn.getWorkflowDescription(i),g=this.workflowManager.getAllDefinitions().find(y=>y.name===u);return g?this.workflowManager.updateDefinition(g.id,{nodes:l,connections:d,description:h,tags:a||g.tags}):this.workflowManager.createDefinition({name:u,description:h,tags:a||[],nodes:l,connections:d})}loadWorkflow(s){const{definitionId:n,position:o={x:100,y:100},existingNodeId:r}=s,a=this.workflowManager.getDefinitionById(n);if(!a)throw new Error(`Workflow definition not found: ${n}`);const i=this.convertWorkflowNodesToRows(a.nodes,a.connections);return{id:r||`workflow-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:a.name,content:a.description||"",x:o.x,y:o.y,width:400,height:600,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:i},inputHandles:this.createInputHandlesFromRows(i),outputHandles:[]}}}validateWorkflow(s){var r;const n=[],o=[];try{const{node:a,arrows:i}=this.getNodeAndArrows(s),c=a.data,l=((r=c==null?void 0:c.parameters)==null?void 0:r.rows)||[];l.length===0&&n.push("Workflow must have at least one step");const d=l.filter(g=>!g.stepType||g.stepType==="empty");d.length>0&&o.push(`${d.length} step(s) have no type configured`);const u=new Set(i.filter(g=>g.endNodeId===s&&g.endRowId).map(g=>g.endRowId)),f=l.filter(g=>g.stepType==="source").filter(g=>!u.has(g.id));return f.length>0&&o.push(`${f.length} source step(s) have no input connections`),{valid:n.length===0,errors:n,warnings:o}}catch(a){return{valid:!1,errors:[`Validation failed: ${String(a)}`],warnings:o}}}canSave(s){const n=this.validateWorkflow(s);return{valid:n.valid,errors:n.errors}}previewDefinition(s){const{node:n,arrows:o}=this.getNodeAndArrows(s),{nodes:r,connections:a}=Yn.convertOrchestrationNode(n,o);return{nodes:r,connections:a,nodeCount:r.length,connectionCount:a.length}}addRow(s){var f;const{nodeId:n,stepType:o,label:r,parentRowId:a,config:i}=s,{node:c}=this.getNodeAndArrows(n),l=c.data,d=((f=l==null?void 0:l.parameters)==null?void 0:f.rows)||[],u=d.length+1,h={id:Re(),label:r||`Step ${u}`,order:u,stepType:o,config:i||{}};if(a){const g=this.addRowToParent(d,a,h);this.updateNodeRows(n,g)}else{const g=[...d,h];this.updateNodeRows(n,g)}return h}updateRow(s){var d;const{nodeId:n,rowId:o,updates:r}=s,{node:a}=this.getNodeAndArrows(n),i=a.data,c=((d=i==null?void 0:i.parameters)==null?void 0:d.rows)||[],l=this.updateRowRecursive(c,o,r);this.updateNodeRows(n,l)}deleteRow(s){var l;const{nodeId:n,rowId:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((l=a==null?void 0:a.parameters)==null?void 0:l.rows)||[],c=this.deleteRowRecursive(i,o);this.updateNodeRows(n,c)}reorderRows(s){var d;const{nodeId:n,rowOrders:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((d=a==null?void 0:a.parameters)==null?void 0:d.rows)||[],c=new Map(o.map(u=>[u.rowId,u.order])),l=this.updateRowOrders(i,c);this.updateNodeRows(n,l)}getTemplates(){return[{id:"simple-transform",name:"Simple Transform",description:"Data input → transformation → output"},{id:"conditional-flow",name:"Conditional Flow",description:"Data input → condition check → branching logic"},{id:"loop-process",name:"Loop Processing",description:"Data input → loop over items → process each"}]}createFromTemplate(s){const{templateId:n,name:o}=s,a={"simple-transform":{name:o||"Simple Transform Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"transform-1",type:"transform",parameters:{label:"Transform Data"},inputHandles:[{id:"input_transform-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_transform-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"transform-1",targetHandleId:"input_transform-1"}]},"conditional-flow":{name:o||"Conditional Flow Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"condition-1",type:"if",parameters:{label:"Check Condition"},inputHandles:[{id:"input_condition-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_condition-1_true",name:"True",type:"output",dataType:"any"},{id:"output_condition-1_false",name:"False",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"condition-1",targetHandleId:"input_condition-1"}]},"loop-process":{name:o||"Loop Processing Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"loop-1",type:"loop",parameters:{label:"Process Each Item"},inputHandles:[{id:"input_loop-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_loop-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"loop-1",targetHandleId:"input_loop-1"}]}}[n];if(!a)throw new Error(`Template not found: ${n}`);return this.workflowManager.createDefinition({name:a.name,description:`Created from ${n} template`,tags:["template",n],nodes:a.nodes,connections:a.connections})}exportWorkflow(s){const n=this.workflowManager.getDefinitionById(s);if(!n)throw new Error(`Workflow definition not found: ${s}`);return JSON.stringify(n,null,2)}exportWorkflows(s){const n=s.map(o=>this.workflowManager.getDefinitionById(o)).filter(o=>o!==void 0);return JSON.stringify(n,null,2)}exportAllWorkflows(){const s=this.workflowManager.getAllDefinitions();return JSON.stringify(s,null,2)}importWorkflow(s){try{const n=JSON.parse(s);if(!n.name||!Array.isArray(n.nodes)||!Array.isArray(n.connections))throw new Error("Invalid workflow format: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:n.name,description:n.description,tags:n.tags||[],nodes:n.nodes,connections:n.connections})}catch(n){throw new Error(`Failed to import workflow: ${n instanceof Error?n.message:String(n)}`)}}importWorkflows(s){try{const n=JSON.parse(s);if(!Array.isArray(n))throw new Error("Invalid format: expected array of workflows");return n.map(o=>{if(!o.name||!Array.isArray(o.nodes)||!Array.isArray(o.connections))throw new Error("Invalid workflow format in array: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:o.name,description:o.description,tags:o.tags||[],nodes:o.nodes,connections:o.connections})})}catch(n){throw new Error(`Failed to import workflows: ${n instanceof Error?n.message:String(n)}`)}}downloadWorkflow(s){const n=this.exportWorkflow(s),o=this.workflowManager.getDefinitionById(s);if(!o)return;const r=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`${o.name.replace(/[^a-z0-9]/gi,"_")}.workflow.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}downloadWorkflows(s){const n=this.exportWorkflows(s),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download=`workflows_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}bulkDeleteDefinitions(s){s.forEach(n=>{this.workflowManager.deleteDefinition(n)})}bulkDuplicateDefinitions(s){return s.map((n,o)=>{const r=this.workflowManager.getDefinitionById(n);if(!r)throw new Error(`Definition not found: ${n}`);return this.workflowManager.duplicateDefinition(n,`${r.name} (Copy ${o+1})`)})}bulkAddTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const a=r.tags||[],i=[...new Set([...a,...n])];this.workflowManager.updateDefinition(o,{tags:i})})}bulkRemoveTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const i=(r.tags||[]).filter(c=>!n.includes(c));this.workflowManager.updateDefinition(o,{tags:i})})}getBulkStats(s){const n=s.map(i=>this.workflowManager.getDefinitionById(i)).filter(i=>i!==void 0),o=new Set;let r=0,a=0;return n.forEach(i=>{r+=i.nodes.length,a+=i.connections.length,(i.tags||[]).forEach(c=>o.add(c))}),{count:n.length,totalNodes:r,totalConnections:a,tags:Array.from(o)}}getNodeAndArrows(s){if(!this.getCanvasState)throw new Error("Canvas state getter not provided");const{nodes:n,arrows:o}=this.getCanvasState(),r=n.find(a=>a.id===s);if(!r)throw new Error(`Node not found: ${s}`);return{node:r,arrows:o}}convertWorkflowNodesToRows(s,n){const o=new Map;for(const c of n)if(c.sourceHandleId.startsWith("output_")&&c.targetHandleId.startsWith("input_")){const l=c.sourceNodeId,d=c.targetNodeId;o.has(l)||o.set(l,[]),o.get(l).push(d)}const r=new Set,a=(c,l)=>{r.add(c.id);const u=(o.get(c.id)||[]).filter(h=>!r.has(h)).map((h,f)=>{const g=s.find(y=>y.id===h);return g?a(g,f+1):null}).filter(Boolean);return{id:c.id,label:c.parameters.label||`Step ${l}`,order:l,stepType:c.type,config:c.parameters,children:u.length>0?u:void 0}};return s.filter(c=>!n.some(l=>l.targetNodeId===c.id)).map((c,l)=>a(c,l+1))}createInputHandlesFromRows(s){const n=[],o=r=>{r.stepType==="source"&&n.push({id:`input_${r.id}`,name:r.label,type:"input",dataType:"any"}),r.children&&r.children.forEach(a=>o(a))};return s.forEach(o),n}updateNodeRows(s,n){if(!this.getCanvasState)throw new Error("Cannot update rows without canvas state");const o=this.createInputHandlesFromRows(n);return{rows:n,inputHandles:o}}addRowToParent(s,n,o){return s.map(r=>{if(r.id===n){const a=r.children||[];return{...r,children:[...a,o]}}return r.children?{...r,children:this.addRowToParent(r.children,n,o)}:r})}updateRowRecursive(s,n,o){return s.map(r=>r.id===n?{...r,...o}:r.children?{...r,children:this.updateRowRecursive(r.children,n,o)}:r)}deleteRowRecursive(s,n){return s.filter(o=>o.id!==n).map(o=>o.children?{...o,children:this.deleteRowRecursive(o.children,n)}:o)}updateRowOrders(s,n){return s.map(o=>{const r=n.get(o.id),a=r!==void 0?{...o,order:r}:o;return a.children?{...a,children:this.updateRowOrders(a.children,n)}:a}).sort((o,r)=>o.order-r.order)}}const Bl="workflow-manager-storage",Hl=()=>{try{const e=localStorage.getItem(Bl);if(e)return JSON.parse(e)}catch(e){console.error("[WorkflowManager] Failed to load from localStorage:",e)}return null},uy=e=>{try{const s=JSON.stringify(e);localStorage.setItem(Bl,s)}catch(s){console.error("[WorkflowManager] Failed to save to localStorage:",s)}},Os=Hl(),mi=(Os==null?void 0:Os.definitions)||[],xi=(Os==null?void 0:Os.instances)||[],cs=Cd((e,s)=>{const n=new Da(mi,xi);return{definitions:mi,instances:xi,facade:n,selectedDefinitionId:null,selectedInstanceId:null,isExecuting:!1,lastExecutionResult:null,createDefinition:o=>{const r=n.createDefinition(o),a=n.getAllDefinitions();return e({definitions:a}),s().saveToStorage(),r},updateDefinition:(o,r)=>{const a=n.updateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},deleteDefinition:o=>{n.deleteDefinition(o);const r=n.getAllDefinitions(),a=n.getAllInstances();e({definitions:r,instances:a,selectedDefinitionId:s().selectedDefinitionId===o?null:s().selectedDefinitionId}),s().saveToStorage()},duplicateDefinition:(o,r)=>{const a=n.duplicateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},findDefinitionsByTag:o=>n.findDefinitionsByTag(o),findDefinitionsByName:o=>n.findDefinitionsByName(o),createInstance:(o,r)=>{const a=n.createInstance(o,r),i=n.getAllInstances();return e({instances:i}),s().saveToStorage(),a},updateInstance:(o,r)=>{n.updateInstance(o,r);const a=n.getAllInstances();e({instances:a}),s().saveToStorage()},deleteInstance:o=>{n.deleteInstance(o);const r=n.getAllInstances();e({instances:r,selectedInstanceId:s().selectedInstanceId===o?null:s().selectedInstanceId}),s().saveToStorage()},getInstancesByDefinitionId:o=>n.getInstancesByDefinitionId(o),executeInstance:async(o,r)=>{e({isExecuting:!0});try{const a=await n.executeInstance(o,r),i=n.getAllInstances();return e({instances:i,isExecuting:!1,lastExecutionResult:a}),s().saveToStorage(),a}catch(a){throw e({isExecuting:!1}),a}},selectDefinition:o=>{e({selectedDefinitionId:o})},selectInstance:o=>{e({selectedInstanceId:o})},getStats:()=>n.getStats(),clearAll:()=>{n.clearAll(),e({definitions:[],instances:[],selectedDefinitionId:null,selectedInstanceId:null,lastExecutionResult:null}),s().saveToStorage()},loadFromStorage:()=>{const o=Hl();if(o){const r=new Da(o.definitions,o.instances);e({definitions:o.definitions,instances:o.instances,facade:r})}},saveToStorage:()=>{uy({definitions:s().definitions,instances:s().instances})}}}),hy=({node:e,nodes:s,arrows:n,updateNode:o})=>{var d;const r=e.data,a=((d=r==null?void 0:r.parameters)==null?void 0:d.rows)||[],i=cs.getState().definitions,c=()=>{try{const h=new Oa(cs.getState().facade,()=>({nodes:s,arrows:n})).previewDefinition(e.id),f=typeof e.title=="string"?e.title:`Workflow ${e.id}`,g=typeof e.content=="string"?e.content:"",m=cs.getState().definitions.find(w=>w.name===f);let x;m?x=cs.getState().updateDefinition(m.id,{nodes:h.nodes,connections:h.connections,description:g}):x=cs.getState().createDefinition({name:f,description:g,tags:[],nodes:h.nodes,connections:h.connections}),ve.success("Workflow saved",{description:`"${x.name}" saved successfully (v${x.version})`})}catch(u){ve.error("Failed to save workflow",{description:u instanceof Error?u.message:String(u)})}},l=u=>{if(!u){ve.error("No workflow selected",{description:"Please select a workflow to load"});return}try{const f=new Oa(cs.getState().facade,()=>({nodes:s,arrows:n})).loadWorkflow({definitionId:u,existingNodeId:e.id});o(e.id,{title:f.title,content:f.content,data:f.data}),ve.success("Workflow loaded",{description:`"${f.title}" loaded successfully`})}catch(h){ve.error("Failed to load workflow",{description:h instanceof Error?h.message:String(h)})}};return t.jsx(Oo,{storageKey:`workflow-more-options-${e.id}`,initialConfig:{autoSaveEnabled:!1,selectedDefinitionId:""},children:(u,h,f)=>(p.useEffect(()=>{if(!u.autoSaveEnabled||a.length===0)return;const g=setTimeout(()=>{c()},3e3);return()=>clearTimeout(g)},[a,u.autoSaveEnabled]),t.jsx(f,{icon:t.jsx(Fc,{className:"h-4 w-4"}),variant:"ghost",size:"icon",buttonClassName:"workflow-more-options-button",contentClassName:"w-80",title:"Workflow Options",children:t.jsxs("div",{className:"workflow-options-panel space-y-4",children:[t.jsxs("div",{className:"save-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Save Workflow"}),t.jsxs("button",{"data-test":"workflow-save-to-manager-button",onClick:g=>{g.stopPropagation(),c()},className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:[t.jsx(qt,{className:"h-4 w-4"}),"Save to Workflow Manager"]})]}),t.jsxs("div",{className:"load-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Load Workflow"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Select a workflow to load into this node"}),t.jsxs(lt,{"data-test":"workflow-load-select",value:u.selectedDefinitionId,onValueChange:g=>{h({...u,selectedDefinitionId:g})},children:[t.jsx(dt,{"data-test":"workflow-load-select-trigger",children:t.jsx(ut,{placeholder:"Select workflow..."})}),t.jsx(ht,{children:i.length===0?t.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No saved workflows found"}):i.map(g=>t.jsxs(Ue,{value:g.id,children:[g.name," (v",g.version,")"]},g.id))})]}),t.jsxs("button",{"data-test":"workflow-load-confirm-button",onClick:g=>{g.stopPropagation(),l(u.selectedDefinitionId),h({...u,selectedDefinitionId:""})},disabled:!u.selectedDefinitionId,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm border rounded hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[t.jsx(qu,{className:"h-4 w-4"}),"Load"]})]}),t.jsx("div",{className:"auto-save-section space-y-2 pt-2 border-t",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"space-y-0.5",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Auto-Save"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically save after changes (3s delay)"})]}),t.jsx("button",{"data-test":"workflow-auto-save-toggle",onClick:g=>{g.stopPropagation();const y=!u.autoSaveEnabled;h({...u,autoSaveEnabled:y}),ve.info(y?"Auto-save enabled":"Auto-save disabled",{description:y?"Workflow will save automatically after changes":"Manual save required"})},className:`w-10 h-10 flex items-center justify-center rounded transition-colors border ${u.autoSaveEnabled?"bg-primary text-primary-foreground border-primary":"hover:bg-accent border-border"}`,title:u.autoSaveEnabled?"Disable auto-save":"Enable auto-save",children:t.jsx(ns,{className:"h-4 w-4"})})]})})]})}))})},py=({node:e,nodes:s,arrows:n,showTextConfig:o,rows:r,updateNode:a,onToggleTextConfig:i,onSetJsonConfigText:c,onSetJsonError:l})=>{const d=e.data,{executeWorkflow:u,showDryRunResults:h}=Wl(),f=y=>{if(y.stopPropagation(),!o){const m={nodeId:e.id,nodeType:d==null?void 0:d.nodeType,rows:r,connections:n.filter(x=>x.endNodeId===e.id||x.startNodeId===e.id)};c(JSON.stringify(m,null,2)),l(null)}i()},g=async y=>{y.stopPropagation();const m=await u(!0,e.id);h(m)};return t.jsxs("div",{className:"workflow-header font-semibold mb-2 text-sm border-b pb-1 flex justify-between items-center",children:[t.jsx("span",{children:o?"JSON Config":"Orchestration Rows"}),(d==null?void 0:d.showExecuteButton)&&t.jsxs("div",{className:"execute-button-container flex items-center gap-1.5",children:[t.jsx(ee,{"data-test":"workflow-toggle-json-button",onClick:f,variant:o?"default":"outline",size:"icon",className:"h-8 w-8",title:o?"View visual steps":"View workflow as JSON",children:o?t.jsx(os,{className:"h-4 w-4"}):t.jsx(Fo,{className:"h-4 w-4"})}),t.jsx(ee,{"data-test":"workflow-dry-run-button",onClick:g,variant:"outline",size:"icon",className:"h-8 w-8",title:"Dry Run (preview changes without applying)",children:t.jsx(ms,{className:"h-4 w-4"})}),t.jsx($l,{nodeId:e.id,label:"",className:"h-8 w-8"}),t.jsx(hy,{node:e,nodes:s,arrows:n,updateNode:a})]})]})},gy=({node:e,jsonConfigText:s,jsonError:n,onJsonConfigTextChange:o,onJsonErrorChange:r,onClose:a,updateNode:i})=>{const c=e.data,l=f=>{f.stopPropagation();try{const g=JSON.parse(s);if(!g.rows||!Array.isArray(g.rows)){r('Invalid JSON: "rows" must be an array');return}i(e.id,{data:{...c,parameters:{...c.parameters,rows:g.rows}}}),r(null),a()}catch(g){r(`Invalid JSON: ${g.message}`)}},d=f=>{f.stopPropagation(),navigator.clipboard.writeText(s)},u=f=>{o(f.target.value),r(null)},h=f=>{f.preventDefault(),f.stopPropagation();const g=f.currentTarget,y=g.scrollTop<g.scrollHeight-g.clientHeight,m=g.scrollTop>0,x=f.deltaY>0;(x&&y||!x&&m)&&(g.scrollTop+=f.deltaY)};return t.jsxs("div",{className:"workflow-json-wrapper h-full w-full flex flex-col gap-1",onWheel:f=>{f.stopPropagation()},children:[t.jsx("div",{className:"workflow-textarea-parent flex-1 w-full min-h-0",onWheel:f=>{f.stopPropagation()},children:t.jsx("textarea",{value:s,onChange:u,onClick:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onWheel:h,className:"workflow-textarea w-full h-full text-[10px] font-mono bg-background border-0 p-1 resize-none focus:outline-none overflow-auto",spellCheck:!1})}),n&&t.jsx("div",{className:"text-[10px] text-destructive bg-destructive/10 border-t border-destructive/20 px-1 py-1",children:n}),t.jsxs("div",{className:"flex gap-1 border-t pt-1",children:[t.jsx("button",{"data-test":"workflow-json-save-button",onClick:l,className:"flex-1 px-2 py-1 text-[10px] bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:"Save"}),t.jsx("button",{"data-test":"workflow-json-copy-button",onClick:d,className:"px-2 py-1 text-[10px] border border-border rounded hover:bg-accent transition-colors",children:"Copy"})]})]})},fy=({node:e,rows:s,rowElementsRef:n,connectorOffsetLeft:o,stepTypesWithConnectors:r})=>t.jsx("div",{"data-test":"workflow-connector-layer-container",className:"workflow-connector-layer absolute top-0 bottom-0 pointer-events-none",style:{left:`${o}px`},children:s.map(a=>{if(!r.includes(a.stepType))return null;const i=a.id.replace("row_",""),c=a.label||`Step ${i}`,l=n.current.get(a.id);if(!l)return null;const d=l.getBoundingClientRect(),u=l.closest(".bg-background.border.p-3");if(!u)return null;const h=u.getBoundingClientRect(),f=d.top+d.height/2-h.top;return t.jsx("div",{"data-test":`workflow-connector-${a.id}`,"data-row-connector":a.id,"data-node-id":e.id,className:"absolute w-3 h-3 rounded-full border-2 border bg-background cursor-crosshair hover:bg-accent transition-colors pointer-events-auto",style:{left:"0",top:`${f}px`,transform:"translateY(-50%)"},title:`Connect to ${c}`,onClick:g=>{g.stopPropagation()}},`connector-${a.id}`)})}),my=({node:e,rows:s,updateNode:n})=>{const o=e.data,[r,a]=p.useState(null),[i,c]=p.useState(!1),[l,d]=p.useState(!1),[u,h]=p.useState(!1),[f,g]=p.useState(null),[y,m]=p.useState(null),x=(R,I)=>{for(const M of R){if(M.id===I)return M;if(M.children){const W=x(M.children,I);if(W)return W}}return null},w=(R,I,M)=>R.map(W=>W.id===I?{...W,...M}:W.children?{...W,children:w(W.children,I,M)}:W),v=(R,I)=>R.filter(M=>M.id!==I).map(M=>M.children?{...M,children:v(M.children,I)}:M);return{selectedRowId:r,setSelectedRowId:a,configPopoverOpen:i,setConfigPopoverOpen:c,showNodeUpdateConfig:l,setShowNodeUpdateConfig:d,showIfStepConfig:u,setShowIfStepConfig:h,popoverPosition:f,popoverSize:y,handleAddRow:()=>{const R=s.length+1,I={id:Re(),label:`Step ${R}`,order:R,stepType:"empty"},M=[...s,I];M.sort((F,D)=>F.order-D.order);const B=M.filter(F=>yn.includes(F.stepType)).map(F=>({id:`input_${F.id}`,name:F.label,type:"input",dataType:"any"}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:M},inputHandles:B}})},handleRowClick:(R,I,M)=>{const W=x(s,R);a(R);const B=window.innerWidth,F=window.innerHeight,D=I.clientX,L=I.clientY,T=D<B/2?D+100:D-100;g({x:T,y:L});const O=Math.min(450,Math.floor(F*.6));if(m({width:500,height:O}),M==="badge")c(!0);else if(M==="gear"){const _=W==null?void 0:W.stepType;_==="nodeUpdate"?d(!0):_==="if"&&h(!0)}},handleConfigureRow:(R,I)=>{const M=w(s,R,{stepType:I});n(e.id,{data:{...o,parameters:{...o.parameters,rows:M}}}),a(null)},handleDeleteRow:R=>{const I=v(s,R),W=I.filter(B=>yn.includes(B.stepType)).map((B,F)=>({id:B.id,position:"left",offsetY:96+F*32}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:I},inputHandles:W}})},handleSaveNodeUpdateConfig:R=>{if(!r)return;const I=w(s,r,{stepType:"nodeUpdate",config:R});n(e.id,{data:{...o,parameters:{...o.parameters,rows:I}}}),d(!1),a(null)},handleSaveIfStepConfig:R=>{if(!r)return;const I=w(s,r,{stepType:"if",config:R});n(e.id,{data:{...o,parameters:{...o.parameters,rows:I}}}),h(!1),a(null)},findRowRecursive:x}},wi=({node:e})=>{var S,C,R;const s=e.data,n=((S=s==null?void 0:s.parameters)==null?void 0:S.rows)||[],[o,r]=p.useState(!1),[a,i]=p.useState(""),[c,l]=p.useState(null);p.useEffect(()=>{if(!o)return;const I=M=>{var B;const W=M.target;if(W.closest(".workflow-json-wrapper")){const F=(B=W.closest(".workflow-json-wrapper"))==null?void 0:B.querySelector("textarea");if(F){M.stopPropagation(),M.preventDefault();const D=F.scrollTop<F.scrollHeight-F.clientHeight,L=F.scrollTop>0,A=M.deltaY>0;(A&&D||!A&&L)&&(F.scrollTop+=M.deltaY)}}};return document.addEventListener("wheel",I,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",I,{capture:!0})}},[o]);const[d,u]=p.useState(()=>new Set(n.filter(I=>I.children&&I.children.length>0).map(I=>I.id))),h=p.useRef(null),f=p.useRef(new Map),[g,y]=p.useState(null),m=H(I=>{var M;return((M=I.projectCanvas.getActive())==null?void 0:M.coreState.arrows)??[]}),x=H(I=>{var M;return((M=I.projectCanvas.getActive())==null?void 0:M.coreState.nodes)??[]}),v=H(I=>{var M;return((M=I.projectCanvas.getActive())==null?void 0:M.coreState.selectedNodes)??[]}).some(I=>I.id===e.id),{updateNode:b}=E.getState(),N=my({node:e,rows:n,updateNode:b}),j=m.filter(I=>I.endNodeId===e.id&&I.endRowId);p.useEffect(()=>{let I=[...n],M=!1;const W=new Set;j.forEach(F=>{F.endRowId&&W.add(F.endRowId)});const B=I.length;if(I=I.filter(F=>{const D=F.stepType&&F.stepType!=="empty";return W.has(F.id)||D}),I.length!==B&&(M=!0),M){I.sort((L,A)=>L.order-A.order);const D=I.filter(L=>yn.includes(L.stepType)).map(L=>({id:`input_${L.id}`,name:L.label,type:"input",dataType:"any"}));b(e.id,{data:{...s,parameters:{...s.parameters,rows:I},inputHandles:D}})}},[j.length,e.id,b]),p.useEffect(()=>(h.current=new $h({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:()=>!0,onDragMove:({sortIndex:I})=>{I!==null&&y(I)},onDrop:({item:I,sortIndex:M})=>{if(M==null)return;const W=I.data.rowId,B=[...n],F=B.findIndex(T=>T.id===W);if(F===-1)return;const[D]=B.splice(F,1);B.splice(M,0,D),B.forEach((T,O)=>{T.order=O+1});const A=B.filter(T=>yn.includes(T.stepType)).map((T,O)=>({id:T.id,position:"left",offsetY:96+O*32}));b(e.id,{data:{...s,parameters:{...s.parameters,rows:B},inputHandles:A}})},onDragEnd:()=>{y(null)}}),()=>{var I;(I=h.current)==null||I.destroy(),f.current.clear()}),[e.id]),p.useEffect(()=>{if(!h.current)return;const I=document.querySelector(`[data-workflow-rows="${e.id}"]`);I&&!I.dataset.dropZoneRegistered&&(h.current.registerDropZone(`workflow-rows-${e.id}`,I,void 0,{nodeId:e.id}),I.dataset.dropZoneRegistered="true"),n.forEach(W=>{const B=document.querySelector(`[data-drag-handle="${W.id}"]`);B&&!B.dataset.dndRegistered&&(h.current.registerDraggable(W.id,B,{rowId:W.id}),B.dataset.dndRegistered="true")});const M=new Set(n.map(W=>W.id));f.current.forEach((W,B)=>{M.has(B)||(h.current.unregisterDraggable(B),f.current.delete(B))})},[n,e.id]);const k=I=>{const W=I.target.closest("[data-drag-handle]"),B=document.querySelector(`[data-node-id="${e.id}"]`);B==null||B.getBoundingClientRect(),n.map(F=>{const D=document.querySelector(`[data-workflow-row="${e.id}:${F.id}"]`);if(D){const L=D.getBoundingClientRect();return{rowId:F.id,screenY:L.top+L.height/2,top:L.top,bottom:L.bottom,height:L.height}}return{rowId:F.id,error:"element not found"}}),v&&!W&&I.stopPropagation()};return t.jsxs("div",{"data-test":`workflow-orchestration-node-${e.id}`,className:"workflow-node-container bg-background border p-3 w-full h-full flex flex-col relative overflow-visible",onPointerDown:k,children:[t.jsx(fy,{node:e,rows:n,rowElementsRef:f,connectorOffsetLeft:Eh,stepTypesWithConnectors:yn}),t.jsx(py,{node:e,nodes:x,arrows:m,showTextConfig:o,rows:n,updateNode:b,onToggleTextConfig:()=>r(!o),onSetJsonConfigText:i,onSetJsonError:l}),t.jsx("div",{"data-test":`workflow-content-area-${e.id}`,className:"workflow-content-area flex-1 w-full text-xs overflow-y-auto relative","data-workflow-rows":e.id,onWheel:I=>{o&&I.stopPropagation()},children:o?t.jsx(gy,{node:e,jsonConfigText:a,jsonError:c,onJsonConfigTextChange:i,onJsonErrorChange:l,onClose:()=>r(!1),updateNode:b}):t.jsx(Bh,{data:n,defaultExpandedIds:d,onReorder:I=>{const M=(D,L=1)=>D.map((A,T)=>{const O=L+T;return{...A,order:O,children:A.children?M(A.children,O*10):A.children}}),W=M(I),B=new Set(W.filter(D=>D.children&&D.children.length>0).map(D=>D.id)),F=new Set(d);B.forEach(D=>{d.has(D)||F.add(D)}),u(F),b(e.id,{data:{...s,parameters:{...s.parameters,rows:W}}})},renderCustomContent:I=>t.jsx(Rh,{row:I,node:e,nodes:x,incomingArrows:j,selectedRowId:N.selectedRowId,configPopoverOpen:N.configPopoverOpen,rowElementsRef:f,onRowClick:N.handleRowClick,onConfigureRow:N.handleConfigureRow,onDeleteRow:N.handleDeleteRow,onSelectedRowIdChange:N.setSelectedRowId})})}),t.jsx("button",{"data-test":"workflow-add-row-button",onClick:N.handleAddRow,className:"mt-2 w-full py-1 text-xs border bg-background hover:bg-accent rounded",children:"+ Add Row"}),N.showNodeUpdateConfig&&N.selectedRowId&&t.jsx(Mh,{isVisible:N.showNodeUpdateConfig,onClose:()=>{N.setShowNodeUpdateConfig(!1),N.setSelectedRowId(null)},allNodes:x,currentConfig:(C=N.findRowRecursive(n,N.selectedRowId))==null?void 0:C.config,onSave:N.handleSaveNodeUpdateConfig,initialPosition:N.popoverPosition||void 0,initialSize:N.popoverSize||void 0}),N.showIfStepConfig&&N.selectedRowId&&t.jsx(Ph,{isVisible:N.showIfStepConfig,onClose:()=>{N.setShowIfStepConfig(!1),N.setSelectedRowId(null)},currentConfig:(R=N.findRowRecursive(n,N.selectedRowId))==null?void 0:R.config,onSave:N.handleSaveIfStepConfig,initialPosition:N.popoverPosition||void 0,initialSize:N.popoverSize||void 0})]})},xy="type here...",wy=({node:e,preventEdit:s})=>{var R;const n=p.useRef(null),[o,r]=p.useState(s),[a,i]=p.useState(e.content||""),c=e.data,l=(c==null?void 0:c.displayFormat)||"raw",{updateNodeContent:d,updateNode:u,setMode:h}=E.getState(),f=H(I=>I.uiState.nodeToFocusId);H(I=>{var M;return((M=I.uiState.dragInfo)==null?void 0:M.draggedNodeId)===e.id});const g=H(I=>{var M,W;return((W=(M=I.projectCanvas.getActive())==null?void 0:M.coreState.selectedNodes)==null?void 0:W.some(B=>B.id===e.id))??!1}),y=g&&f===e.id,m=H(I=>{var M,W;return((W=(M=I.projectCanvas.getActive())==null?void 0:M.coreState.selectedNodes)==null?void 0:W.length)??0}),{fitNodeDimensions:x}=Xs(),w=p.useMemo(()=>{if(l==="json")try{const I=JSON.parse(a);return JSON.stringify(I,null,2)}catch{return a}return a},[a,l]),v=I=>{i(I.target.value)},b=p.useCallback(I=>{I.preventDefault();const M=I.clipboardData.getData("text"),W=n.current;if(!W)return;const B=W.selectionStart,F=W.selectionEnd,D=W.value,L=D.substring(0,B)+M+D.substring(F);W.value=L;const A=B+M.length;W.setSelectionRange(A,A),i(L),d(e.id,L)},[e.id,d]),N=p.useCallback(I=>{r(I),u(e.id,{isEditing:I})},[u,e.id]),j=p.useCallback(()=>{var I;d(e.id,a),N(!1),u(e.id,{isEditing:!1}),(I=window.getSelection())==null||I.removeAllRanges()},[e.id,d,a,u]),k=p.useCallback(I=>{if(I.shiftKey){!o&&g&&m<=1&&(N(!0),setTimeout(()=>{var W;return(W=n.current)==null?void 0:W.focus()},0));return}const M=g&&m<=1;M&&N(M)},[o,g,m]),S=p.useCallback(I=>{var O,$,_,G;if(I.key==="Escape"){j(),N(!1),E.getState().uiState.mode!==Q.VIM&&h(Q.SELECT),(O=n.current)==null||O.blur();return}if(I.key==="Enter"&&I.ctrlKey){const X=(($=n.current)==null?void 0:$.value)||"";d(e.id,X);return}const M=((_=n.current)==null?void 0:_.value)??"",W=A(M),B=L(),F=T(M,I.key==="Enter",B),D=(G=e.options)!=null&&G.lockSize?e.width:W;u(e.id,{width:D,height:F,isEditing:!0});function L(){const X=n.current;if(X){const P=window.getComputedStyle(X).lineHeight;if(P&&P!=="normal"){const z=parseFloat(P);if(!isNaN(z))return z}}return pe.LINE_HEIGHT}function A(X,J=pe.DEFAULT_NODE_WIDTH,P=Ba.textNodeXPadding){const K=X.split(/\n/).map(V=>lo(V)).reduce((V,oe)=>Math.max(V,oe),0)+P,re=Math.max(K,J);return Math.max(re,e.width??0)}function T(X,J=!1,P=pe.LINE_HEIGHT){let U=X.split(/\n/).length,K=pe.DEFAULT_NODE_HEIGHT;return U===1&&!J?(K=Math.max(K,e.height??0),K):(J&&(U+=1),K+=(U-1)*P,K=Math.max(K,e.height??0),K)}},[j,d,u,e.id,e.width]);p.useEffect(()=>{f||N(!1)},[f]),p.useEffect(()=>{y&&(N(!0),i(e.content||""),window.setTimeout(()=>{const I=n.current;I&&(I.focus(),I.selectionStart=I.selectionEnd=I.value.length)},0))},[y,e.content]),p.useEffect(()=>{i(e.content||"")},[e.content]);const C=p.useCallback(()=>{const I=l==="raw"?"json":"raw";u(e.id,{data:{...c,displayFormat:I}})},[l,e.id,c,u]);return t.jsxs("div",{className:"relative w-full h-full",children:[g&&t.jsx("button",{onClick:C,className:"absolute -top-7 right-0 z-50 px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",title:`Switch to ${l==="raw"?"JSON":"raw"} format`,children:l==="raw"?"Raw":"JSON"}),t.jsx("textarea",{spellCheck:!1,ref:n,id:`WorkflowSourceNode-${e.id}`,value:o?a:w,onChange:v,onPaste:b,onBlur:j,onKeyDown:S,onMouseDown:k,placeholder:xy,"data-is-editing":s?!1:o,className:Se("relative z-10","m-0 p-1 w-full h-full","resize-none","overflow-hidden","border","font-mono",e.className,{"pointer-events-none":s,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!a&&!o}),style:{textAlign:(R=e.styles)==null?void 0:R.textAlign,fontSize:l==="json"?`${pe.FONT_SIZE_XXS}px`:se.text.fontSize,lineHeight:l==="json"?"1.4":"1.5"},readOnly:!o})]})},yi=Ce.memo(wy),it=e=>jt(cs,e),yy=({node:e,preventEdit:s})=>{const{updateNode:n}=E.getState(),o=H(w=>{var v,b;return((b=(v=w.projectCanvas.getActive())==null?void 0:v.coreState.selectedNodes)==null?void 0:b.some(N=>N.id===e.id))??!1}),r=it(w=>w.definitions),a=it(w=>w.createInstance),i=it(w=>w.executeInstance),c=it(w=>w.isExecuting),l=e.data||{},{definitionId:d,instanceId:u,lastExecutionStatus:h="idle"}=l,f=p.useMemo(()=>r.find(w=>w.id===d),[r,d]),g=p.useCallback(w=>{const v=a(w,`${(f==null?void 0:f.name)||"Workflow"} Instance`);n(e.id,{data:{...l,definitionId:w,instanceId:v.id,lastExecutionStatus:"idle"},title:(f==null?void 0:f.name)||"Workflow"})},[e.id,l,n,a,f]),y=p.useCallback(async()=>{if(!u){console.warn("No instance selected");return}try{n(e.id,{data:{...l,lastExecutionStatus:"running"}});const w=await i(u);n(e.id,{data:{...l,lastExecutionStatus:w.success?"completed":"failed"}})}catch{n(e.id,{data:{...l,lastExecutionStatus:"failed"}})}},[u,l,e.id,n,i]),m=p.useMemo(()=>{switch(h){case"running":return t.jsx(On,{className:"h-4 w-4 animate-spin text-blue-500"});case"completed":return t.jsx(Ju,{className:"h-4 w-4 text-green-500"});case"failed":return t.jsx(Zu,{className:"h-4 w-4 text-red-500"});default:return t.jsx(fs,{className:"h-4 w-4 text-gray-400"})}},[h]),x=p.useMemo(()=>{switch(h){case"running":return"border-blue-500";case"completed":return"border-green-500";case"failed":return"border-red-500";default:return"border-border"}},[h]);return t.jsxs("div",{className:Se("workflow-definition-node w-full h-full p-3 bg-background border-2 rounded flex flex-col gap-2",x,{"ring-2 ring-primary":o}),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(fs,{className:"h-5 w-5 text-primary"}),t.jsx("span",{className:"text-sm font-semibold",children:"Workflow"})]}),m]}),t.jsxs(lt,{value:d||"",onValueChange:g,disabled:s,children:[t.jsx(dt,{className:"w-full h-8 text-xs",children:t.jsx(ut,{placeholder:"Select workflow..."})}),t.jsx(ht,{children:r.length===0?t.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"No workflows available"}):r.map(w=>t.jsx(Ue,{value:w.id,className:"text-xs",children:w.name},w.id))})]}),d&&t.jsx("div",{className:"flex gap-1",children:t.jsxs(ee,{size:"sm",variant:"default",className:"flex-1 h-7 text-xs",onClick:y,disabled:!d||c||s,children:[t.jsx(Ze,{className:"h-3 w-3 mr-1"}),"Execute"]})}),f&&o&&t.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[t.jsxs("div",{children:["Nodes: ",f.nodes.length]}),t.jsxs("div",{children:["Connections: ",f.connections.length]}),f.tags&&f.tags.length>0&&t.jsx("div",{className:"flex gap-1 flex-wrap",children:f.tags.map(w=>t.jsx("span",{className:"px-1 py-0.5 bg-primary/10 text-primary rounded text-[10px]",children:w},w))})]})]})},vy=Ce.memo(yy),by=({node:e})=>{const{updateNode:s}=E.getState(),n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),i=p.useRef(null),c=H(I=>{var W;const M=I.projectCanvas.getActive();return((W=M==null?void 0:M.coreState.selectedNodes)==null?void 0:W.some(B=>B.id===e.id))??!1}),l=H(I=>{var W;const M=I.projectCanvas.getActive();return((W=M==null?void 0:M.coreState.nodes)==null?void 0:W.length)??0}),d=e.data||{},[u,h]=p.useState(d.image||null),{result:f,isProcessing:g,error:y,processBlob:m,cancel:x,reset:w}=Hh();p.useEffect(()=>{o.current&&c&&o.current.focus()},[c]),p.useEffect(()=>{if(!c)return;const I=async M=>{var B;M.preventDefault(),M.stopPropagation();const W=(B=M.clipboardData)==null?void 0:B.items;if(W){for(const F of W)if(F.type.startsWith("image/")){const D=F.getAsFile();if(D){const L=new FileReader;L.onload=()=>{const A=L.result;h(A),w(),s(e.id,{data:{...d,image:A}})},L.readAsDataURL(D)}break}}};return document.addEventListener("paste",I),()=>{document.removeEventListener("paste",I)}},[c,e.id,d,s,w]),p.useEffect(()=>{if(!f)return;const I=f.timestamp.toISOString();if(i.current===I)return;const M=f.extractedText||"[No text detected in image]",W={image:u||void 0,extractedText:f.extractedText,detectedLanguage:f.detectedLanguage,confidence:f.confidence,processingTime:f.processingTime,timestamp:f.timestamp.toISOString()};s(e.id,{data:W,content:f.extractedText});const B=Le.buildTextNodeV2({content:M});_o(B,e,"right",{shouldFocus:!1}),i.current=I},[f,u,e.id,e,s,l]);const v=p.useCallback(async I=>{var W;const M=(W=I.target.files)==null?void 0:W[0];if(M&&M.type.startsWith("image/")){const B=new FileReader;B.onload=()=>{const F=B.result;h(F),w(),s(e.id,{data:{...d,image:F}})},B.readAsDataURL(M)}},[w,e.id,d,s]),b=p.useCallback(async()=>{if(!u)return;const M=await(await fetch(u)).blob();await m(M)},[u,m]),N=p.useCallback(async()=>{if(!u)return;const M=await(await fetch(u)).blob();await m(M,{downscale:!0,downscaleFactor:.5})},[u,m]),j=p.useCallback(()=>{x()},[x]),k=p.useCallback(()=>{h(null),w(),n.current&&(n.current.value=""),s(e.id,{data:{},content:""})},[w,e.id,s]),S=p.useCallback(async()=>{const I=(f==null?void 0:f.extractedText)||d.extractedText;if(I)try{await navigator.clipboard.writeText(I),a(!0),setTimeout(()=>a(!1),2e3)}catch(M){console.error("Failed to copy:",M)}},[f,d]),C=p.useCallback(I=>{var W;I.preventDefault(),I.stopPropagation();const M=(W=I.clipboardData)==null?void 0:W.items;if(M){for(const B of M)if(B.type.startsWith("image/")){const F=B.getAsFile();if(F){const D=new FileReader;D.onload=()=>{const L=D.result;h(L),w(),s(e.id,{data:{...d,image:L}})},D.readAsDataURL(F)}break}}},[e.id,d,w,s]),R=f||(d.extractedText?{extractedText:d.extractedText,detectedLanguage:d.detectedLanguage,confidence:d.confidence,processingTime:d.processingTime}:null);return t.jsxs("div",{className:"canvas-ocr-node w-full h-full p-4 flex flex-col gap-3 overflow-auto",children:[t.jsxs("div",{className:"ocr-header flex items-center justify-between pb-2 border-b border-border",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Qn,{className:"h-4 w-4 text-primary"}),t.jsx("h3",{className:"text-sm font-semibold",children:"OCR Node"})]}),u&&t.jsx(ee,{"data-test":"ocr-clear-button",variant:"ghost",size:"sm",onClick:k,className:"h-6 px-2",children:t.jsx(We,{className:"h-3 w-3"})})]}),t.jsx("div",{ref:o,className:"image-input-area border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onPaste:C,tabIndex:0,role:"button","aria-label":"Paste image area",children:u?t.jsxs("div",{className:"image-preview-container space-y-2",children:[t.jsx("img",{src:u,alt:"OCR preview",className:"image-preview max-w-full max-h-32 mx-auto rounded-lg shadow-sm"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for OCR"})]}):t.jsxs("div",{className:"empty-state space-y-2",children:[t.jsx(Tn,{className:"w-6 h-6 mx-auto text-muted-foreground"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Paste image (Ctrl+V) or upload"})]})}),t.jsxs("div",{className:"upload-controls",children:[t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:v,className:"hidden"}),t.jsxs(ee,{"data-test":"ocr-upload-button",variant:"outline",size:"sm",onClick:()=>{var I;return(I=n.current)==null?void 0:I.click()},className:"w-full",children:[t.jsx(Tn,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]}),y&&!g&&t.jsxs(Fh,{variant:"destructive",children:[t.jsx(mo,{className:"h-4 w-4"}),t.jsx(_h,{className:"text-xs",children:y})]}),t.jsx("div",{className:"ocr-controls flex flex-col gap-2",children:g?t.jsxs(ee,{"data-test":"ocr-cancel-button",variant:"destructive",onClick:j,className:"w-full",size:"sm",children:[t.jsx(On,{className:"w-3 h-3 mr-2 animate-spin"}),"Cancel"]}):t.jsxs(t.Fragment,{children:[t.jsxs(ee,{"data-test":"ocr-extract-button",onClick:b,disabled:!u,className:"w-full",size:"sm",children:[t.jsx(Qn,{className:"w-3 h-3 mr-2"}),"Extract Text"]}),t.jsxs(ee,{"data-test":"ocr-extract-downscale-button",onClick:N,disabled:!u,variant:"outline",className:"w-full",size:"sm",children:[t.jsx(Qn,{className:"w-3 h-3 mr-2"}),"Downscale and Extract"]})]})}),R&&t.jsxs("div",{className:"ocr-results space-y-2 flex-1 flex flex-col",children:[t.jsxs("div",{className:"results-header flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[t.jsx(ba,{className:"w-3 h-3 text-green-600"}),t.jsx("span",{children:"Extracted"})]}),t.jsx(ee,{"data-test":"ocr-copy-result-button",variant:"ghost",size:"sm",onClick:S,className:"h-6 px-2",children:r?t.jsxs(t.Fragment,{children:[t.jsx(ba,{className:"w-3 h-3 mr-1 text-green-600"}),t.jsx("span",{className:"text-xs",children:"Copied!"})]}):t.jsxs(t.Fragment,{children:[t.jsx(Mt,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"text-xs",children:"Copy"})]})})]}),(R.detectedLanguage||R.confidence||R.processingTime)&&t.jsxs("div",{className:"results-metadata text-xs text-muted-foreground space-y-1",children:[R.detectedLanguage&&t.jsxs("div",{children:["Language: ",R.detectedLanguage]}),R.confidence&&t.jsxs("div",{children:["Confidence: ",R.confidence]}),R.processingTime&&t.jsxs("div",{children:["Time: ",R.processingTime,"ms"]})]}),t.jsx("div",{className:"results-text flex-1 p-3 bg-muted rounded-lg font-mono text-xs whitespace-pre-wrap break-words overflow-y-auto",children:R.extractedText})]})]})},Ny=Ce.memo(by),ga=1/3;function fa(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}const Sy=({node:e})=>{const{updateNode:s}=E.getState(),n=p.useRef(null),o=p.useRef(null),r=H(u=>{var f;const h=u.projectCanvas.getActive();return((f=h==null?void 0:h.coreState.selectedNodes)==null?void 0:f.some(g=>g.id===e.id))??!1}),a=e.data||{},[i,c]=p.useState(a.image||null);p.useEffect(()=>{o.current&&r&&o.current.focus()},[r]),p.useEffect(()=>{if(!r)return;const u=async h=>{var g;h.preventDefault(),h.stopPropagation();const f=(g=h.clipboardData)==null?void 0:g.items;if(f){for(const y of f)if(y.type.startsWith("image/")){const m=y.getAsFile();if(m){Math.round(m.size/1024);const x=new FileReader;x.onload=async()=>{let w=x.result,v;{const N=await fa(w,ga);w=N.dataUrl,v=N.size}c(w);const b=Math.round(w.length*3/4/1024);s(e.id,{data:{...a,imageSize:v,fileSizeKB:b,image:w}})},x.readAsDataURL(m)}break}}};return document.addEventListener("paste",u),()=>{document.removeEventListener("paste",u)}},[r,e.id,a,s]);const l=p.useCallback(async u=>{var f;const h=(f=u.target.files)==null?void 0:f[0];if(h&&h.type.startsWith("image/")){Math.round(h.size/1024);const g=new FileReader;g.onload=async()=>{let y=g.result,m;{const w=await fa(y,ga);y=w.dataUrl,m=w.size}c(y);const x=Math.round(y.length*3/4/1024);s(e.id,{data:{...a,imageSize:m,fileSizeKB:x,image:y}})},g.readAsDataURL(h)}},[e.id,a,s]),d=p.useCallback(u=>{var f;u.preventDefault(),u.stopPropagation();const h=(f=u.clipboardData)==null?void 0:f.items;if(h){for(const g of h)if(g.type.startsWith("image/")){const y=g.getAsFile();if(y){Math.round(y.size/1024);const m=new FileReader;m.onload=async()=>{let x=m.result,w;{const b=await fa(x,ga);x=b.dataUrl,w=b.size}c(x);const v=Math.round(x.length*3/4/1024);s(e.id,{data:{...a,imageSize:w,fileSizeKB:v,image:x}})},m.readAsDataURL(y)}break}}},[e.id,a,s]);return t.jsx("div",{ref:o,className:"canvas-image-node w-full h-full overflow-hidden",onPaste:d,tabIndex:0,role:"button","aria-label":"Paste image area","data-test":"canvas-image-node",children:i?t.jsx("img",{src:i,alt:"Image",className:"w-full h-full object-contain pointer-events-none select-none",draggable:!1,"data-test":"image-preview"}):t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center gap-3 border-2 border-dashed rounded-lg hover:border-primary transition-colors","data-test":"image-empty-state",children:[t.jsx(Tn,{className:"w-8 h-8 text-muted-foreground"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Paste image (Ctrl+V) or upload"}),t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:l,className:"hidden","data-test":"image-file-input"}),t.jsxs(ee,{"data-test":"image-upload-button",variant:"outline",size:"sm",onClick:()=>{var u;return(u=n.current)==null?void 0:u.click()},children:[t.jsx(Tn,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]})})},Cy=Ce.memo(Sy),Fl=({node:e})=>{var F;const s=E.getState().updateNode,n=E.getState().deleteNodeById,o=E.getState().setSelectedNodes,a=H(D=>D.uiState.activeGroupId)===e.id,c=H(D=>D.uiState.hoveredDropTargetGroupId)===e.id,l=e.data,d=(l==null?void 0:l.childNodeIds)??[],u=e.isCollapsed??!1,h=zx(e),[f,g]=p.useState(!1),[y,m]=p.useState(!1),[x,w]=p.useState(!1),[v,b]=p.useState(null),N=p.useCallback(D=>{D.stopPropagation(),s(e.id,{isCollapsed:!u})},[e.id,u,s]),j=p.useCallback(D=>{D.stopPropagation();const L=E.getState(),A=L.projectCanvas.getActive();if(!A)return;const O=A.coreState.nodes.filter($=>d.includes($.id));O.forEach($=>{L.updateNode($.id,{groupId:void 0})}),o(O),n(e.id)},[e.id,d,n,o]),k=p.useCallback(D=>{D.stopPropagation(),D.preventDefault();const L=E.getState(),A=L.projectCanvas.getActive();if(!A)return;const O=A.coreState.nodes.filter($=>d.includes($.id));O.length!==0&&(L.setSelectedNodes(O),L.arrow.setSelected([]))},[d]),S=p.useCallback(async D=>{if(D.stopPropagation(),!f){g(!0);try{const L=E.getState(),A=L.projectCanvas.getActive();if(!A)return;const T=A.coreState.nodes,O=A.coreState.arrows,$=A.coreState.selectedNodes,_=await Yx(e,T,O,$);_.success?_.nodeUpdates.forEach(({nodeId:G,updates:X})=>{L.updateNode(G,X)}):console.error("Workflow execution failed:",_.error)}catch(L){console.error("Error executing workflow:",L)}finally{g(!1)}}},[e,f]),C=p.useCallback(D=>{if(D.stopPropagation(),!y){m(!0);try{const L=E.getState(),A=L.projectCanvas.getActive();if(!A)return;const O=L.getVisualWorkflowPresets().find(K=>{var re;return((re=K.sourceLocation)==null?void 0:re.groupNodeId)===e.id});if(O){ve.info(`Workflow "${O.name}" already saved`,{description:"This workflow group is already in presets",duration:3e3});return}const $=A.coreState.nodes,_=A.coreState.arrows,G=Ra(e,$,_);if(G.length===0){ve.warning("No workflow steps found",{description:"Add workflow step nodes to save this workflow",duration:3e3});return}const X=G.map(K=>({id:K.nodeId,stepType:K.stepType,config:K.config,label:K.label})),J=e.title||"Untitled Workflow",{path:P}=js(L);if(!P.projectId||!P.workspaceId||!P.canvasId)throw new Error("Could not determine canvas location for workflow preset");const z={projectId:P.projectId,workspaceId:P.workspaceId,canvasId:P.canvasId,groupNodeId:e.id},U=L.createVisualWorkflowPreset(J,X,z);ve.success(`Workflow saved: ${J}`,{description:`${X.length} step${X.length!==1?"s":""} saved to presets`,duration:3e3}),console.log(`Workflow saved as preset: ${J} (${U})`)}catch(L){console.error("Error saving workflow:",L),ve.error("Failed to save workflow",{description:L instanceof Error?L.message:"Unknown error",duration:4e3})}finally{m(!1)}}},[e,y]),R=p.useCallback(D=>{D.stopPropagation();const A=E.getState().projectCanvas.getActive();if(!A)return;const T=A.coreState.nodes,O=A.coreState.arrows,_=Ra(e,T,O).map(X=>({id:X.nodeId,stepType:X.stepType,config:X.config,label:X.label})),G={name:e.title||"Untitled Workflow",groupNodeId:e.id,stepCount:_.length,stepTypes:[...new Set(_.map(X=>X.stepType))],steps:_};b(G),w(!0)},[e]),I=(F=l==null?void 0:l.styles)==null?void 0:F.backgroundColor,M=!I,W={};I&&(W.backgroundColor=`color-mix(in srgb, ${I} 20%, transparent)`),!a&&!c&&(W.border="1px solid hsl(var(--muted-foreground) / 0.3)"),c&&(W.border="2px dashed hsl(var(--primary))",W.boxShadow="0 0 0 4px hsl(var(--primary) / 0.2)");const B=I?`color-mix(in srgb, ${I} 60%, transparent)`:void 0;return t.jsxs("div",{className:Se("w-full h-full rounded-lg","flex flex-col","pointer-events-none",M&&"bg-background",a&&"ring-2 ring-dashed ring-primary/50"),style:W,"data-test":"group-node-content",children:[t.jsxs("div",{className:Se("flex items-center gap-1 px-2 py-1","border-b border-border/50","select-none",!a&&"pointer-events-auto",!B&&"bg-muted/70"),style:B?{backgroundColor:B}:void 0,"data-test":"group-header",children:[t.jsx("button",{className:"p-0.5 rounded hover:bg-muted transition-colors",onPointerDown:D=>{D.stopPropagation()},onClick:N,title:u?"Expand group":"Collapse group","data-test":"group-collapse-toggle",children:u?t.jsx(Ks,{className:"h-4 w-4 text-muted-foreground"}):t.jsx(Et,{className:"h-4 w-4 text-muted-foreground"})}),t.jsx("span",{className:"flex-1 text-sm font-medium text-foreground truncate",title:e.title||"Group","data-test":"group-name",children:e.title||"Group"}),h&&t.jsxs("div",{className:"flex items-center gap-0.5 border-r border-border/50 pr-1 mr-1","data-test":"group-workflow-actions",children:[t.jsx("button",{className:Se("p-0.5 rounded transition-colors",f?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:D=>D.stopPropagation(),onClick:S,disabled:f,title:f?"Executing workflow...":"Execute workflow","data-test":"group-execute-workflow-button",children:t.jsx(Ze,{className:Se("h-4 w-4",f?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:Se("p-0.5 rounded transition-colors",y?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:D=>D.stopPropagation(),onClick:C,disabled:y,title:y?"Saving workflow...":"Save workflow to presets","data-test":"group-save-workflow-button",children:t.jsx(qt,{className:Se("h-4 w-4",y?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:D=>D.stopPropagation(),onClick:R,title:"View workflow JSON","data-test":"group-json-viewer-button",children:t.jsx(Fo,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})]}),t.jsxs("div",{className:"flex items-center gap-0.5","data-test":"group-node-actions",children:[t.jsx("span",{className:"text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded",title:`${d.length} nodes in group`,"data-test":"group-child-count",children:d.length}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:k,title:"Select all nodes in group","data-test":"group-select-all-button",children:t.jsx(Za,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:D=>{D.stopPropagation()},onClick:j,title:"Ungroup","data-test":"group-ungroup-button",children:t.jsx(Ja,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]})]}),!u&&t.jsx("div",{className:"flex-1 min-h-[20px] pointer-events-none","data-test":"group-body"}),a&&t.jsxs("div",{className:"flex items-center justify-center gap-1 px-2 py-1 border-t border-primary/30 bg-primary/5","data-test":"group-edit-mode-footer",children:[t.jsx(Hs,{className:"h-3 w-3 text-primary"}),t.jsx("span",{className:"text-xs text-primary font-medium",children:"Editing - click outside to exit"})]}),t.jsx(Be,{isVisible:x,onClose:()=>w(!1),title:`Workflow: ${e.title||"Untitled"}`,initialSize:{width:1200,height:1e3},triggerPosition:{x:(typeof window<"u"?window.innerWidth:1920)/2-600,y:(typeof window<"u"?window.innerHeight:1080)/2-500},resizable:!0,"data-test":"workflow-json-viewer-popover",children:v&&t.jsx("div",{className:"h-full overflow-auto","data-test":"workflow-json-content",children:t.jsx(Vc,{data:v,onDataChange:()=>{}})})})]})};Fl.displayName="GroupNodeV2";const vi=[{type:"if",label:"If Condition",icon:"🔀",description:"Conditional logic based on field values"},{type:"toolbarAction",label:"Toolbar Action",icon:"⚡",description:"Execute canvas toolbar actions"},{type:"tagUpdate",label:"Tag Update",icon:"🏷️",description:"Add, remove, or set node tags"},{type:"loop",label:"Loop",icon:"🔄",description:"Iterate over nodes or data"},{type:"source",label:"Source",icon:"📥",description:"Define data source for workflow"}],jy=[{value:"selection.count",label:"Selection Count",description:"Number of selected nodes"},{value:"node.title",label:"Node Title",description:"Title of the node"},{value:"node.content",label:"Node Content",description:"Content of the node"},{value:"node.tags",label:"Node Tags",description:"Tags array of the node"},{value:"loop.index",label:"Loop Index",description:"Current loop iteration (1-based)"},{value:"loop.current",label:"Loop Current",description:"Current loop value"},{value:"loop.total",label:"Loop Total",description:"Total loop iterations"}],ky=[{value:"==",label:"Equals",symbol:"=="},{value:"!=",label:"Not Equals",symbol:"!="},{value:">",label:"Greater Than",symbol:">"},{value:">=",label:"Greater or Equal",symbol:">="},{value:"<",label:"Less Than",symbol:"<"},{value:"<=",label:"Less or Equal",symbol:"<="},{value:"contains",label:"Contains",symbol:"contains"},{value:"matches",label:"Matches (regex)",symbol:"matches"}],bi=[{value:"addTags",label:"Add Tags"},{value:"removeTags",label:"Remove Tags"},{value:"setTags",label:"Set Tags"},{value:"updateTitle",label:"Update Title"},{value:"updateContent",label:"Update Content"},{value:"setStyle",label:"Set Background"},{value:"toolbarAction",label:"Run Toolbar Action"}],Ay=({config:e,onChange:s})=>{const n=h=>{s({...e,condition:{...e.condition,field:h}})},o=h=>{s({...e,condition:{...e.condition,operator:h}})},r=h=>{s({...e,condition:{...e.condition,value:h}})},a=h=>{s({...e,then:{type:h,value:h==="addTags"||h==="removeTags"||h==="setTags"?[]:""}})},i=h=>{const f=e.then.type,g=f==="addTags"||f==="removeTags"||f==="setTags"?h.split(",").map(y=>y.trim()).filter(Boolean):h;s({...e,then:{...e.then,value:g}})},c=h=>{s({...e,else:{type:h,value:h==="addTags"||h==="removeTags"||h==="setTags"?[]:""}})},l=h=>{if(!e.else)return;const f=e.else.type,g=f==="addTags"||f==="removeTags"||f==="setTags"?h.split(",").map(y=>y.trim()).filter(Boolean):h;s({...e,else:{...e.else,value:g}})},d=h=>Array.isArray(h.value)?h.value.join(", "):String(h.value||""),u=h=>h==="addTags"||h==="removeTags"||h==="setTags"?"tag1, tag2":"value";return t.jsxs("div",{"data-test":"if-condition-config",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"if-condition-section",className:"space-y-1 p-1.5 bg-muted/30 rounded border border-border",children:[t.jsx("span",{"data-test":"if-condition-section-label",className:"text-[10px] font-semibold text-muted-foreground uppercase",children:"If"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(lt,{value:e.condition.field,onValueChange:h=>n(h),children:[t.jsx(dt,{"data-test":"if-condition-field-trigger",className:"h-6 text-[11px] flex-1",onClick:h=>h.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"if-condition-field-content",children:jy.map(h=>t.jsx(Ue,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsxs(lt,{value:e.condition.operator,onValueChange:h=>o(h),children:[t.jsx(dt,{"data-test":"if-condition-operator-trigger",className:"h-6 text-[11px] w-16",onClick:h=>h.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"if-condition-operator-content",children:ky.map(h=>t.jsx(Ue,{value:h.value,className:"text-xs",children:h.symbol},h.value))})]}),t.jsx(Ae,{"data-test":"if-condition-value-input",value:e.condition.value,onChange:h=>r(h.target.value),onClick:h=>h.stopPropagation(),placeholder:"value",className:"h-6 text-[11px] w-16"})]})]}),t.jsxs("div",{"data-test":"if-then-section",className:"space-y-1 p-1.5 bg-green-500/10 rounded border border-green-500/30",children:[t.jsx("span",{"data-test":"if-then-section-label",className:"text-[10px] font-semibold text-green-700 dark:text-green-400 uppercase",children:"Then"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(lt,{value:e.then.type,onValueChange:h=>a(h),children:[t.jsx(dt,{"data-test":"if-then-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:h=>h.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"if-then-action-type-content",children:bi.map(h=>t.jsx(Ue,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsx(Ae,{"data-test":"if-then-action-value-input",value:d(e.then),onChange:h=>i(h.target.value),onClick:h=>h.stopPropagation(),placeholder:u(e.then.type),className:"h-6 text-[11px] flex-1"})]})]}),t.jsxs("div",{"data-test":"if-else-section",className:"space-y-1 p-1.5 bg-orange-500/10 rounded border border-orange-500/30",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{"data-test":"if-else-section-label",className:"text-[10px] font-semibold text-orange-700 dark:text-orange-400 uppercase",children:"Else"}),e.else&&t.jsx("button",{"data-test":"if-else-remove-button",onClick:h=>{h.stopPropagation(),s({...e,else:void 0})},className:"text-[10px] text-muted-foreground hover:text-destructive",children:"✕"})]}),e.else?t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(lt,{value:e.else.type,onValueChange:h=>c(h),children:[t.jsx(dt,{"data-test":"if-else-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:h=>h.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"if-else-action-type-content",children:bi.map(h=>t.jsx(Ue,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsx(Ae,{"data-test":"if-else-action-value-input",value:d(e.else),onChange:h=>l(h.target.value),onClick:h=>h.stopPropagation(),placeholder:u(e.else.type),className:"h-6 text-[11px] flex-1"})]}):t.jsx("button",{"data-test":"if-else-add-button",onClick:h=>{h.stopPropagation(),s({...e,else:{type:"addTags",value:[]}})},className:"text-[10px] text-primary hover:underline",children:"+ Add else"})]})]})},Iy=[{value:"split",label:"Split"},{value:"arrange",label:"Arrange"},{value:"align",label:"Align"},{value:"group",label:"Group"},{value:"collapse",label:"Collapse"}],Ni={split:[{value:"byWhitespace",label:"By Whitespace"},{value:"byLine",label:"By Line"},{value:"byParagraph",label:"By Paragraph"},{value:"byComma",label:"By Comma"},{value:"byPeriod",label:"By Period"},{value:"byRegex",label:"By Regex"}],arrange:[{value:"horizontal:top",label:"Horizontal (Top)"},{value:"horizontal:bottom",label:"Horizontal (Bottom)"},{value:"vertical:left",label:"Vertical (Left)"},{value:"vertical:right",label:"Vertical (Right)"},{value:"grid",label:"Grid"},{value:"masonry",label:"Masonry"}],align:[{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"},{value:"top",label:"Top"},{value:"middle",label:"Middle"},{value:"bottom",label:"Bottom"}],group:[{value:"create",label:"Create Group"},{value:"ungroup",label:"Ungroup"}],collapse:[{value:"collapse",label:"Collapse"},{value:"expand",label:"Expand"}]},Ty=({config:e,onChange:s})=>{var l,d,u,h;const n=f=>{var y;const g=((y=Ni[f][0])==null?void 0:y.value)||"";s({facadeKey:f,actionId:g,params:{}})},o=f=>{s({...e,actionId:f})},r=(f,g)=>{s({...e,params:{...e.params,[f]:g}})},a=e.facadeKey==="split",i=e.facadeKey==="arrange",c=e.facadeKey==="arrange"&&e.actionId==="grid";return t.jsxs("div",{"data-test":"toolbar-action-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"toolbar-action-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:"Execute canvas toolbar actions on selected nodes"}),t.jsxs("div",{"data-test":"toolbar-action-category",children:[t.jsx("label",{"data-test":"toolbar-action-category-label",className:"text-xs font-medium",children:"Category"}),t.jsxs(lt,{value:e.facadeKey,onValueChange:f=>n(f),children:[t.jsx(dt,{"data-test":"toolbar-action-category-trigger",className:"h-7 text-xs mt-1",onClick:f=>f.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"toolbar-action-category-content",children:Iy.map(f=>t.jsx(Ue,{value:f.value,"data-test":`toolbar-action-category-option-${f.value}`,className:"text-xs",children:f.label},f.value))})]})]}),t.jsxs("div",{"data-test":"toolbar-action-action",children:[t.jsx("label",{"data-test":"toolbar-action-action-label",className:"text-xs font-medium",children:"Action"}),t.jsxs(lt,{value:e.actionId,onValueChange:o,children:[t.jsx(dt,{"data-test":"toolbar-action-action-trigger",className:"h-7 text-xs mt-1",onClick:f=>f.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"toolbar-action-action-content",children:Ni[e.facadeKey].map(f=>t.jsx(Ue,{value:f.value,"data-test":`toolbar-action-action-option-${f.value}`,className:"text-xs",children:f.label},f.value))})]})]}),(a||i)&&t.jsxs("div",{"data-test":"toolbar-action-options",className:"space-y-2 p-2 bg-muted/30 rounded border border-border",children:[t.jsx("label",{"data-test":"toolbar-action-options-label",className:"text-xs font-semibold",children:"Options"}),a&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{"data-test":"toolbar-action-keep-arrows",className:"flex items-center gap-2",children:[t.jsx(De,{"data-test":"toolbar-action-keep-arrows-checkbox",checked:((l=e.params)==null?void 0:l.keepArrows)||!1,onCheckedChange:f=>r("keepArrows",f),onClick:f=>f.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-arrows-label",className:"text-xs",children:"Keep Arrows"})]}),t.jsxs("div",{"data-test":"toolbar-action-keep-match",className:"flex items-center gap-2",children:[t.jsx(De,{"data-test":"toolbar-action-keep-match-checkbox",checked:((d=e.params)==null?void 0:d.keepMatch)||!1,onCheckedChange:f=>r("keepMatch",f),onClick:f=>f.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-match-label",className:"text-xs",children:"Keep Match"})]})]}),t.jsxs("div",{"data-test":"toolbar-action-gap",children:[t.jsx("label",{"data-test":"toolbar-action-gap-label",className:"text-xs text-muted-foreground",children:"Gap"}),t.jsx(Ae,{"data-test":"toolbar-action-gap-input",type:"number",value:((u=e.params)==null?void 0:u.gap)||20,onChange:f=>r("gap",parseInt(f.target.value,10)),onClick:f=>f.stopPropagation(),className:"h-7 text-xs mt-1",min:0})]}),c&&t.jsxs("div",{"data-test":"toolbar-action-columns",children:[t.jsx("label",{"data-test":"toolbar-action-columns-label",className:"text-xs text-muted-foreground",children:"Columns"}),t.jsx(Ae,{"data-test":"toolbar-action-columns-input",type:"number",value:((h=e.params)==null?void 0:h.columns)||3,onChange:f=>r("columns",parseInt(f.target.value,10)),onClick:f=>f.stopPropagation(),className:"h-7 text-xs mt-1",min:1})]})]})]})},Si=[{value:"add",label:"Add Tags",description:"Add tags to existing tags"},{value:"remove",label:"Remove Tags",description:"Remove specific tags"},{value:"set",label:"Set Tags",description:"Replace all tags with new ones"},{value:"clear",label:"Clear All Tags",description:"Remove all tags from nodes"}],Ey=({config:e,onChange:s})=>{var u;const[n,o]=p.useState(""),r=h=>{s({...e,mode:h})},a=()=>{const h=n.trim();h&&(e.tags.includes(h)||s({...e,tags:[...e.tags,h]}),o(""))},i=h=>{s({...e,tags:e.tags.filter(f=>f!==h)})},c=h=>{h.key==="Enter"&&(h.preventDefault(),h.stopPropagation(),a())},l=h=>{s({...e,useTemplate:h})},d=((u=Si.find(h=>h.value===e.mode))==null?void 0:u.description)||"";return t.jsxs("div",{"data-test":"tag-update-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"tag-update-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:d}),t.jsxs("div",{"data-test":"tag-update-mode",children:[t.jsx("label",{"data-test":"tag-update-mode-label",className:"text-xs font-medium",children:"Mode"}),t.jsxs(lt,{value:e.mode,onValueChange:h=>r(h),children:[t.jsx(dt,{"data-test":"tag-update-mode-trigger",className:"h-7 text-xs mt-1",onClick:h=>h.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"tag-update-mode-content",children:Si.map(h=>t.jsx(Ue,{value:h.value,"data-test":`tag-update-mode-option-${h.value}`,className:"text-xs",children:h.label},h.value))})]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-tags",className:"space-y-2",children:[t.jsx("label",{"data-test":"tag-update-tags-label",className:"text-xs font-medium",children:"Tags"}),e.tags.length>0&&t.jsx("div",{"data-test":"tag-update-tags-chips",className:"flex flex-wrap gap-1 p-2 bg-muted/30 rounded border border-border",children:e.tags.map((h,f)=>t.jsxs("div",{"data-test":`tag-update-tag-chip-${f}`,className:"flex items-center gap-1 px-2 py-0.5 bg-primary/10 text-primary rounded-full text-xs",children:[t.jsx("span",{"data-test":`tag-update-tag-text-${f}`,children:h}),t.jsx("button",{"data-test":`tag-update-tag-remove-${f}`,onClick:g=>{g.stopPropagation(),i(h)},className:"hover:text-destructive",children:t.jsx(We,{size:12})})]},`${h}-${f}`))}),t.jsx(Ae,{"data-test":"tag-update-tags-input",value:n,onChange:h=>o(h.target.value),onKeyDown:c,onClick:h=>h.stopPropagation(),placeholder:"Type tag and press Enter...",className:"h-7 text-xs"}),t.jsxs("p",{"data-test":"tag-update-tags-hint",className:"text-xs text-muted-foreground",children:["Press Enter to add tag. Supports templates like ","{","{","loop.current","}","."]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-template",className:"flex items-center gap-2 p-2 bg-muted/30 rounded",children:[t.jsx(De,{"data-test":"tag-update-template-checkbox",checked:e.useTemplate||!1,onCheckedChange:l,onClick:h=>h.stopPropagation()}),t.jsxs("label",{"data-test":"tag-update-template-label",className:"text-xs",children:["Use template variables (e.g., ","{","{","loop.current","}",")"]})]}),e.useTemplate&&t.jsxs("div",{"data-test":"tag-update-template-help",className:"text-xs text-muted-foreground bg-blue-500/10 p-2 rounded border border-blue-500/30",children:[t.jsx("strong",{children:"Available variables:"}),t.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-0.5",children:[t.jsxs("li",{children:["{","{","loop.current","}"," - Current item in loop"]}),t.jsxs("li",{children:["{","{","loop.index","}"," - Loop index (1-based)"]}),t.jsxs("li",{children:["{","{","loop.total","}"," - Total iterations"]})]})]})]})},Ci=[{value:"connectedNode",label:"Connected Node",description:"Iterate over data from incoming arrow connection"},{value:"selectedNodes",label:"Selected Nodes",description:"Iterate over currently selected nodes on canvas"},{value:"allNodes",label:"All Canvas Nodes",description:"Iterate over all nodes on the canvas"}],Ry=({config:e,onChange:s})=>{var r;const n=a=>{s({...e,source:a})},o=((r=Ci.find(a=>a.value===e.source))==null?void 0:r.description)||"";return t.jsxs("div",{"data-test":"loop-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"loop-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:o}),t.jsxs("div",{"data-test":"loop-config-source",children:[t.jsx("label",{"data-test":"loop-config-source-label",className:"text-xs font-medium",children:"Data Source"}),t.jsxs(lt,{value:e.source,onValueChange:a=>n(a),children:[t.jsx(dt,{"data-test":"loop-config-source-trigger",className:"h-7 text-xs mt-1",onClick:a=>a.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"loop-config-source-content",children:Ci.map(a=>t.jsx(Ue,{value:a.value,"data-test":`loop-config-source-option-${a.value}`,className:"text-xs",children:a.label},a.value))})]})]}),t.jsxs("div",{"data-test":"loop-config-variables",className:"p-2 bg-blue-500/10 rounded border border-blue-500/30 space-y-2",children:[t.jsx("label",{"data-test":"loop-config-variables-label",className:"text-xs font-semibold text-blue-700 dark:text-blue-300",children:"Available Variables"}),t.jsxs("div",{"data-test":"loop-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"loop-config-variable-current",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.current","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current item being processed"})]}),t.jsxs("div",{"data-test":"loop-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.index","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current iteration (1-based)"})]}),t.jsxs("div",{"data-test":"loop-config-variable-total",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.total","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Total number of iterations"})]})]}),t.jsxs("div",{"data-test":"loop-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-blue-500/30",children:[t.jsx("strong",{children:"Example:"})," Use"," ",t.jsxs("code",{className:"px-1 bg-blue-500/20 rounded",children:["{","{","loop.current","}"]})," ","in subsequent steps to reference the current item."]})]}),t.jsxs("div",{"data-test":"loop-config-tips",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Tip:"})," Steps connected after this loop will execute once per item. Use loop variables in those steps to access iteration data."]})]})},ji=[{value:"connectedNode",label:"Connected Node",description:"Read data from incoming arrow connection"},{value:"inline",label:"Inline Data",description:"Define data directly in this node"}],My=({config:e,onChange:s})=>{var c;const n=l=>{s({...e,dataFrom:l,inlineData:l==="inline"?e.inlineData||"{}":void 0})},o=l=>{s({...e,inlineData:l})};let r=null,a=null;if(e.dataFrom==="inline"&&e.inlineData)try{r=JSON.parse(e.inlineData)}catch(l){a=l.message}const i=((c=ji.find(l=>l.value===e.dataFrom))==null?void 0:c.description)||"";return t.jsxs("div",{"data-test":"source-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"source-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:i}),t.jsxs("div",{"data-test":"source-config-data-from",children:[t.jsx("label",{"data-test":"source-config-data-from-label",className:"text-xs font-medium",children:"Data From"}),t.jsxs(lt,{value:e.dataFrom,onValueChange:l=>n(l),children:[t.jsx(dt,{"data-test":"source-config-data-from-trigger",className:"h-7 text-xs mt-1",onClick:l=>l.stopPropagation(),children:t.jsx(ut,{})}),t.jsx(ht,{"data-test":"source-config-data-from-content",children:ji.map(l=>t.jsx(Ue,{value:l.value,"data-test":`source-config-data-from-option-${l.value}`,className:"text-xs",children:l.label},l.value))})]})]}),e.dataFrom==="inline"&&t.jsxs("div",{"data-test":"source-config-inline-data",className:"space-y-2",children:[t.jsx("label",{"data-test":"source-config-inline-data-label",className:"text-xs font-medium",children:"Inline Data (JSON)"}),t.jsx("textarea",{"data-test":"source-config-inline-data-textarea",value:e.inlineData||"",onChange:l=>o(l.target.value),onClick:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),placeholder:'{"key": "value"}',className:"w-full h-24 text-xs font-mono border border-border rounded px-2 py-1 bg-background resize-none"}),a&&t.jsxs("div",{"data-test":"source-config-parse-error",className:"text-xs text-destructive bg-destructive/10 p-2 rounded border border-destructive/30",children:[t.jsx("strong",{children:"Invalid JSON:"})," ",a]}),!a&&r&&t.jsxs("div",{"data-test":"source-config-preview",className:"space-y-1",children:[t.jsx("label",{"data-test":"source-config-preview-label",className:"text-xs font-medium text-muted-foreground",children:"Preview"}),t.jsx("div",{"data-test":"source-config-preview-content",className:"text-xs font-mono bg-muted/30 p-2 rounded border border-border max-h-32 overflow-auto",children:t.jsx("pre",{children:JSON.stringify(r,null,2)})})]})]}),t.jsxs("div",{"data-test":"source-config-variables",className:"p-2 bg-green-500/10 rounded border border-green-500/30 space-y-2",children:[t.jsx("label",{"data-test":"source-config-variables-label",className:"text-xs font-semibold text-green-700 dark:text-green-300",children:"Access Data"}),t.jsxs("div",{"data-test":"source-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"source-config-variable-key",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.key","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access object property by key"})]}),t.jsxs("div",{"data-test":"source-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source[0]","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access array element by index"})]}),t.jsxs("div",{"data-test":"source-config-variable-nested",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.user.name","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access nested properties"})]})]}),t.jsxs("div",{"data-test":"source-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-green-500/30",children:[t.jsx("strong",{children:"Example:"})," If source data is"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{",'"',"users",'"',": [",'"',"name",'"',": ",'"',"Alice",'"',"}","}"," "]}),", use"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{","{","source.users[0].name","}"]})," ","to get ",'"',"Alice",'"',"."]})]}),e.dataFrom==="connectedNode"&&t.jsxs("div",{"data-test":"source-config-connected-info",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Note:"})," Connect an arrow from another node to provide data. The connected node's content or output will be available via ",t.jsx("code",{children:"{{source}}"})," variables."]})]})},Py=({nodeId:e,data:s,onDataChange:n})=>{var l;const[o,r]=p.useState(s.stepType),a=d=>{r(d);let u;switch(d){case"if":u={condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}};break;case"toolbarAction":u={facadeKey:"split",actionId:"byWhitespace",params:{}};break;case"tagUpdate":u={mode:"add",tags:[]};break;case"loop":u={source:"connectedNode"};break;case"source":u={dataFrom:"connectedNode"};break;default:u={}}n({stepType:d,config:u})},i=d=>{o&&n({stepType:o,config:d})},c=o?((l=vi.find(d=>d.type===o))==null?void 0:l.icon)||"⚡":"❓";return t.jsxs("div",{"data-test":`workflow-step-node-${e}`,className:"flex flex-col gap-1 p-1.5 bg-background border border-border rounded-md min-w-[240px]",onMouseDown:d=>d.stopPropagation(),onClick:d=>d.stopPropagation(),children:[t.jsxs("div",{"data-test":"workflow-step-header",className:"flex items-center gap-1.5",children:[t.jsx("span",{"data-test":"workflow-step-icon",className:"text-sm",children:c}),t.jsxs(lt,{value:o??"",onValueChange:d=>a(d),children:[t.jsx(dt,{"data-test":"workflow-step-type-trigger",className:"h-6 text-[11px] flex-1",onClick:d=>d.stopPropagation(),children:t.jsx(ut,{placeholder:"Select step type..."})}),t.jsx(ht,{"data-test":"workflow-step-type-content",children:vi.map(d=>t.jsx(Ue,{value:d.type,"data-test":`workflow-step-type-option-${d.type}`,className:"text-xs",children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{children:d.icon}),t.jsx("span",{children:d.label})]})},d.type))})]})]}),o?t.jsxs("div",{"data-test":"workflow-step-config-panel",children:[o==="if"&&t.jsx(Ay,{config:s.config,onChange:d=>i(d)}),o==="toolbarAction"&&t.jsx(Ty,{config:s.config,onChange:d=>i(d)}),o==="tagUpdate"&&t.jsx(Ey,{config:s.config,onChange:d=>i(d)}),o==="loop"&&t.jsx(Ry,{config:s.config,onChange:d=>i(d)}),o==="source"&&t.jsx(My,{config:s.config,onChange:d=>i(d)})]}):t.jsx("div",{"data-test":"workflow-step-placeholder",className:"text-[10px] text-muted-foreground text-center py-2",children:"Select a step type to configure"})]})},Dy=({node:e})=>{const o=e.data||{stepType:"if",config:{condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}}},r=p.useCallback(a=>{E.getState().updateNode(e.id,{data:a})},[e.id]);return t.jsx("div",{"data-test":`canvas-workflow-step-node-${e.id}`,className:"w-full h-full",children:t.jsx(Py,{nodeId:e.id,data:o,onDataChange:r})})};function _l({nodeId:e,preventEdit:s=!1,onEditStart:n,onEditEnd:o,inputRefs:r,clearSelectionOnBlur:a=!1}){const[i,c]=p.useState(!1),l=H(v=>v.uiState.nodeToFocusId),d=H(v=>{var b,N;return((N=(b=v.projectCanvas.getActive())==null?void 0:b.coreState.selectedNodes)==null?void 0:N.some(j=>j.id===e))??!1}),u=H(v=>{var b,N;return((N=(b=v.projectCanvas.getActive())==null?void 0:b.coreState.selectedNodes)==null?void 0:N.length)??0}),h=d&&l===e,{updateNode:f,setMode:g}=E.getState(),y=p.useCallback(v=>{c(v),f(e,{isEditing:v})},[e,f]),m=p.useCallback(v=>{var b;if(!document.querySelector("[data-radix-popper-content-wrapper]")){if(r&&r.length>0&&(v!=null&&v.relatedTarget)){const N=v.relatedTarget;if(r.some(k=>k.current===N))return}o==null||o(),y(!1),a&&(E.getState().setNodeToFocusId(null),E.getState().setSelectedNodes([])),(b=window.getSelection())==null||b.removeAllRanges()}},[o,y,r,a]),x=p.useCallback(()=>{d&&u<=1&&!s&&(i||n==null||n(),y(!0))},[d,u,s,i,n,y]),w=p.useCallback(v=>{v.key==="Escape"&&(m(),E.getState().uiState.mode!==Q.VIM&&g(Q.SELECT))},[m,g]);return p.useEffect(()=>{l||y(!1)},[l,y]),p.useEffect(()=>{!d&&i&&y(!1)},[d,i,y]),p.useEffect(()=>{if(!h||s)return;!i&&(n==null||n()),y(!0)},[h,s,i,n,y]),p.useEffect(()=>{if(!r||r.length===0)return;const v=[];return r.forEach(b=>{if(b.current){const N=j=>m(j);b.current.addEventListener("blur",N),v.push({el:b.current,handler:N})}}),()=>{v.forEach(({el:b,handler:N})=>{b.removeEventListener("blur",N)})}},[m,r]),{isEditing:i,shouldFocus:h,isSelected:d,selectedNodesCount:u,handleMouseDown:x,handleBlur:m,handleKeyDown:w,setIsEditing:y}}const Oy=({nodeId:e,nodeData:s,preventEdit:n})=>{const o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),[i,c]=p.useState(s.sourceWord||""),[l,d]=p.useState(s.translationWord||""),[u,h]=p.useState(null),{isEditing:f,isSelected:g,selectedNodesCount:y,handleKeyDown:m}=_l({nodeId:e,preventEdit:n,inputRefs:[r,a],clearSelectionOnBlur:!0,onEditEnd:()=>{x({sourceWord:i,translationWord:l})}});p.useEffect(()=>{c(s.sourceWord||""),d(s.translationWord||"")},[s.sourceWord,s.translationWord]),p.useEffect(()=>{requestAnimationFrame(()=>{var W,B;const R=((W=E.getState().projectCanvas.getActive())==null?void 0:W.viewState.scale)??1,M=(((B=o.current)==null?void 0:B.getBoundingClientRect().height)??0)/R;M>0&&E.getState().updateNode(e,{height:M})})},[e,i,l]);const x=p.useCallback(C=>{const R=s;E.getState().updateNode(e,{data:{...R,...C}})},[e,s]),w=C=>{c(C.target.value)},v=C=>{d(C.target.value)},b=C=>{const I=E.getState().getNodeById(C);return I&&typeof I.content=="string"?I.content.trim():""},N=p.useCallback(C=>{C.preventDefault(),h(null);const R=C.dataTransfer.getData("application/json");if(R)try{const I=JSON.parse(R);if(I.nodeIds&&Array.isArray(I.nodeIds)&&I.nodeIds.length>=1){const M=I.nodeIds.map(W=>{const B=E.getState().getNodeById(W);return B?{id:W,x:B.x,y:B.y,content:b(W)}:null}).filter(Boolean);if(M.length>=2){M.sort((F,D)=>F.x+F.y-(D.x+D.y));const W=M[0].content,B=M[M.length-1].content;c(W),d(B),x({sourceWord:W,translationWord:B})}else if(M.length===1){const W=M[0].content;i?(d(W),x({translationWord:W})):(c(W),x({sourceWord:W}))}}else if(I.nodeId){const M=b(I.nodeId);c(M),x({sourceWord:M})}}catch(I){console.error("Failed to parse drop data:",I)}},[i,x]),j=p.useCallback(C=>{C.preventDefault(),h(null);const R=C.dataTransfer.getData("application/json");if(R)try{const I=JSON.parse(R);if(I.nodeIds&&Array.isArray(I.nodeIds)&&I.nodeIds.length>=1){const M=I.nodeIds.map(W=>{const B=E.getState().getNodeById(W);return B?{id:W,x:B.x,y:B.y,content:b(W)}:null}).filter(Boolean);if(M.length>=2){M.sort((F,D)=>F.x+F.y-(D.x+D.y));const W=M[0].content,B=M[M.length-1].content;c(W),d(B),x({sourceWord:W,translationWord:B})}else if(M.length===1){const W=M[0].content;l?(c(W),x({sourceWord:W})):(d(W),x({translationWord:W}))}}else if(I.nodeId){const M=b(I.nodeId);d(M),x({translationWord:M})}}catch(I){console.error("Failed to parse drop data:",I)}},[l,x]),k=(C,R)=>{C.preventDefault(),h(R)},S=()=>{h(null)};return t.jsxs("div",{ref:o,className:"w-full flex flex-col","data-text-position-container":"true","data-test":"vocab-vocabulary-view",children:[t.jsx("div",{className:Se("flex items-center justify-center transition-colors rounded-t-md",u==="source"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:N,onDragOver:C=>k(C,"source"),onDragLeave:S,"data-test":"vocab-source-drop-zone",children:t.jsx(Ae,{ref:r,type:"text",value:i,onChange:w,onKeyDown:m,placeholder:"Source word...","data-test":"vocab-source-input",className:Se("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!f&&!g||y>1||n,"cursor-text":f,"cursor-default":!f}),readOnly:!f})}),t.jsx("div",{className:"py-1","data-test":"vocab-divider",children:t.jsx("div",{className:"border-t border-border"})}),t.jsx("div",{className:Se("flex items-center justify-center transition-colors rounded-b-md",u==="translation"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:j,onDragOver:C=>k(C,"translation"),onDragLeave:S,"data-test":"vocab-translation-drop-zone",children:t.jsx(Ae,{ref:a,type:"text",value:l,onChange:v,onKeyDown:m,placeholder:"Translation...","data-test":"vocab-translation-input",className:Se("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!f&&!g||y>1||n,"cursor-text":f,"cursor-default":!f}),readOnly:!f})})]})},Ly={noun:"bg-blue-100 text-blue-800",verb:"bg-green-100 text-green-800",adjective:"bg-purple-100 text-purple-800",adverb:"bg-orange-100 text-orange-800",pronoun:"bg-pink-100 text-pink-800",preposition:"bg-indigo-100 text-indigo-800",conjunction:"bg-yellow-100 text-yellow-800",interjection:"bg-red-100 text-red-800"},Wy=({node:e,preventEdit:s})=>{var V,oe;const n=p.useRef(null),o=p.useRef(null),r=e.data||{vocabType:He.DICTIONARY,term:"",definition:""},i=H(le=>le.uiState.hoveredDropTargetVocabNodeId)===e.id,[c,l]=p.useState(r.vocabType||He.DICTIONARY),[d,u]=p.useState(r.term||""),[h,f]=p.useState(r.pronunciation||""),[g,y]=p.useState(r.partOfSpeech||""),[m,x]=p.useState(r.definition||""),[w,v]=p.useState(r.flashcardBack||""),[b,N]=p.useState((r.wordListItems||[]).join(`
`)),[j,k]=p.useState(r.isFlipped||!1),[S,C]=p.useState(r.expandedSections||["definition"]),{onEditStart:R,onEditEnd:I}=Gs(e.id,"title"),{onEditStart:M,onEditEnd:W}=Gs(e.id,"content"),B=E.getState().updateNode,{isEditing:F,shouldFocus:D,handleMouseDown:L,handleBlur:A,handleKeyDown:T}=_l({nodeId:e.id,preventEdit:s,onEditStart:()=>{R(d),M(m)},onEditEnd:()=>{const le=b.split(`
`).map(Z=>Z.trim()).filter(Z=>Z.length>0);B(e.id,{data:{...r,vocabType:c,term:d,pronunciation:h,partOfSpeech:g,definition:m,flashcardBack:w,wordListItems:le,isFlipped:j,expandedSections:S},title:d,content:m}),I(d),W(m)}});p.useEffect(()=>{u(r.term||""),f(r.pronunciation||""),y(r.partOfSpeech||""),x(r.definition||""),v(r.flashcardBack||""),N((r.wordListItems||[]).join(`
`)),k(r.isFlipped||!1),l(r.vocabType||He.DICTIONARY),C(r.expandedSections||["definition"])},[r]),p.useEffect(()=>{D&&F&&n.current&&n.current.focus()},[D,F]);const O=p.useCallback(()=>{A()},[A]),$=p.useCallback(le=>{var Z,q;T(le),le.key==="Escape"&&((Z=n.current)==null||Z.blur(),(q=o.current)==null||q.blur())},[T]),_=le=>{C(Z=>Z.includes(le)?Z.filter(q=>q!==le):[...Z,le])},G=r.examples&&r.examples.length>0,X=(V=r.relatedWords)==null?void 0:V.some(le=>le.type==="synonym"),J=(oe=r.relatedWords)==null?void 0:oe.some(le=>le.type==="antonym"),P=r.etymology&&(r.etymology.origin||r.etymology.language),z=()=>{var le,Z,q,Y,te,ae,ce,ie,fe;return t.jsxs("div",{className:"w-full h-full flex flex-col overflow-auto",children:[t.jsx("div",{className:"border-b pb-3 mb-3",children:t.jsx(Ae,{ref:n,type:"text",value:d,onChange:ge=>u(ge.target.value),onBlur:O,onMouseDown:L,onKeyDown:$,placeholder:"Term...","data-test":"vocab-term-input",className:Se("text-lg font-semibold",{"pointer-events-none":s,"cursor-text":F,"cursor-default":!F}),readOnly:!F})}),(h||g)&&t.jsxs("div",{className:"flex gap-2 mb-3 flex-wrap",children:[h&&t.jsxs(qe,{"data-test":"vocab-pronunciation-badge",variant:"secondary",className:"text-xs",children:["/",h,"/"]}),g&&t.jsx(qe,{"data-test":"vocab-pos-badge",className:Se("text-xs",Ly[g]||"bg-gray-100 text-gray-800"),children:g})]}),t.jsxs(ls,{open:S.includes("definition"),onOpenChange:()=>_("definition"),className:"mb-2 border rounded",children:[t.jsxs(ds,{"data-test":"vocab-definition-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Et,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Definition"})]}),t.jsx(us,{className:"border-t",children:t.jsx(Qa,{ref:o,value:m,onChange:ge=>x(ge.target.value),onBlur:O,onMouseDown:L,onKeyDown:$,placeholder:"Enter definition...","data-test":"vocab-definition-textarea",className:Se("min-h-20 resize-none border-none focus:outline-none bg-transparent text-sm p-3",{"pointer-events-none":s,"cursor-text":F,"cursor-default":!F}),readOnly:!F})})]}),G&&t.jsxs(ls,{open:S.includes("examples"),onOpenChange:()=>_("examples"),className:"mb-2 border rounded",children:[t.jsxs(ds,{"data-test":"vocab-examples-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Et,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Examples (",((le=r.examples)==null?void 0:le.length)||0,")"]})]}),t.jsx(us,{className:"border-t p-3 space-y-2",children:(Z=r.examples)==null?void 0:Z.map(ge=>t.jsxs("div",{"data-test":"vocab-example-item",className:"text-sm p-2 bg-muted rounded",children:[t.jsx("p",{className:"italic",children:ge.text}),ge.translation&&t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:ge.translation})]},ge.id))})]}),(X||J)&&t.jsxs(ls,{open:S.includes("related"),onOpenChange:()=>_("related"),className:"mb-2 border rounded",children:[t.jsxs(ds,{"data-test":"vocab-related-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Et,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Related Words",X&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Synonyms (",((q=r.relatedWords)==null?void 0:q.filter(ge=>ge.type==="synonym").length)||0,")"]}),J&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Antonyms (",((Y=r.relatedWords)==null?void 0:Y.filter(ge=>ge.type==="antonym").length)||0,")"]})]})]}),t.jsx(us,{className:"border-t p-3 space-y-2",children:(te=r.relatedWords)==null?void 0:te.map(ge=>t.jsxs("div",{"data-test":"vocab-related-word",className:"flex items-center gap-2",children:[t.jsx(qe,{variant:"outline",className:"text-xs",children:ge.type}),t.jsx("span",{className:"text-sm",children:ge.word})]},ge.id))})]}),P&&t.jsxs(ls,{open:S.includes("etymology"),onOpenChange:()=>_("etymology"),className:"mb-2 border rounded",children:[t.jsxs(ds,{"data-test":"vocab-etymology-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Et,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Etymology"})]}),t.jsx(us,{className:"border-t p-3 space-y-2",children:t.jsxs("div",{"data-test":"vocab-etymology-content",className:"text-sm space-y-2",children:[((ae=r.etymology)==null?void 0:ae.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((ce=r.etymology)==null?void 0:ce.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((ie=r.etymology)==null?void 0:ie.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((fe=r.etymology)==null?void 0:fe.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})})]})]})},U=()=>t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-4",children:[t.jsx("div",{"data-test":"vocab-flashcard-container",className:"relative w-full flex-1 flex items-center justify-center cursor-pointer",onClick:()=>k(!j),style:{perspective:"1000px"},children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center rounded-lg border-2 border-primary bg-card shadow-lg transition-transform",style:{transformStyle:"preserve-3d",transform:j?"rotateY(180deg)":"rotateY(0deg)",transitionDuration:"0.6s"},children:[t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden"},children:t.jsxs("div",{"data-test":"vocab-flashcard-front",className:"text-center",children:[h&&t.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["/",h,"/"]}),t.jsx("p",{className:"text-3xl font-bold",children:d}),g&&t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:g})]})}),t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden",transform:"rotateY(180deg)"},children:t.jsx("div",{"data-test":"vocab-flashcard-back",className:"text-center",children:t.jsx("p",{className:"text-lg",children:w||m})})})]})}),t.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"Click to flip"})]}),K=()=>t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-wordlist-container",className:"grid grid-cols-2 gap-2 flex-1",children:(r.wordListItems||[]).map((le,Z)=>t.jsx("div",{"data-test":"vocab-wordlist-item",className:"p-3 bg-muted rounded-lg border border-border hover:border-primary transition-colors",children:t.jsx("p",{className:"text-sm font-medium",children:le})},Z))})}),re=()=>{var le,Z,q,Y;return t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-etymology-view",className:"space-y-4",children:t.jsxs("div",{className:"p-4 bg-muted rounded-lg border border-border",children:[t.jsxs("h3",{className:"font-semibold text-sm flex items-center gap-2 mb-3",children:[t.jsx(Qu,{className:"h-4 w-4"}),'Etymology of "',d,'"']}),t.jsxs("div",{className:"space-y-2 text-sm",children:[((le=r.etymology)==null?void 0:le.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((Z=r.etymology)==null?void 0:Z.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((q=r.etymology)==null?void 0:q.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((Y=r.etymology)==null?void 0:Y.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})]})})})},ne=i?{border:"2px dashed hsl(var(--primary))",boxShadow:"0 0 0 4px hsl(var(--primary) / 0.2)"}:{};return t.jsxs("div",{className:Se("w-full h-full rounded-lg transition-all",i&&"ring-2 ring-primary/50"),style:ne,"data-test":"vocabulary-node-content",children:[c===He.DICTIONARY&&z(),c===He.FLASHCARD&&U(),c===He.WORD_LIST&&K(),c===He.ETYMOLOGY&&re(),c===He.VOCABULARY&&t.jsx(Oy,{nodeId:e.id,nodeData:r,preventEdit:s})]})},zl=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},$y=({element:e,index:s})=>{const{type:n,stroke:o,shape:r,style:a}=e,i=zl(a),c=a.opacity??1;if(n==="freehand"&&o){const l=c<1;return t.jsx("path",{"data-test":"draw-freehand-path",d:o.smoothedPath,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:"none",strokeLinecap:l?"butt":"round",strokeLinejoin:l?"bevel":"round"},s)}if(n==="shape"&&r){const l=ze.generateShapeSVGPath(r);return t.jsx("path",{"data-test":`draw-shape-${r.shapeType}`,d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:a.fillColor||"none",fillOpacity:a.fillColor?c:void 0,strokeLinecap:"round",strokeLinejoin:"round"},s)}return null},By=p.memo($y),Hy=({drawData:e})=>{if(e.elements&&e.elements.length>0)return t.jsx(t.Fragment,{children:e.elements.map((c,l)=>t.jsx(By,{element:c,index:l},l))});const{drawType:s,stroke:n,shape:o,style:r}=e;if(!r)return null;const a=zl(r),i=r.opacity??1;if(s==="freehand"&&n)return t.jsx("path",{"data-test":"draw-freehand-path",d:n.smoothedPath,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:"none",strokeLinecap:"round",strokeLinejoin:"round"});if(s==="shape"&&o){const c=ze.generateShapeSVGPath(o);return t.jsx("path",{"data-test":`draw-shape-${o.shapeType}`,d:c,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:r.fillColor||"none",fillOpacity:r.fillColor?i:void 0,strokeLinecap:"round",strokeLinejoin:"round"})}return null},Fy=p.memo(Hy),ki=new Set(["circle","square"]),_y=e=>{var n;const s=e.elements??[];return s.length===0?(n=e.shape)!=null&&n.shapeType?ki.has(e.shape.shapeType):!1:s.every(o=>{var r;return o.type==="shape"&&((r=o.shape)==null?void 0:r.shapeType)&&ki.has(o.shape.shapeType)})},zy=({node:e})=>{const s=e.data;if(!s)return null;const n=s.intrinsicWidth??e.width??100,o=s.intrinsicHeight??e.height??100,r=_y(s);return t.jsx("svg",{"data-test":"draw-node-svg",viewBox:`0 0 ${n} ${o}`,preserveAspectRatio:r?"xMidYMid meet":"none",style:{width:e.width?`${e.width}px`:"100%",height:e.height?`${e.height}px`:"100%",overflow:"visible"},children:t.jsx(Fy,{drawData:s})})},Uy=p.memo(zy),Ul="turn-to-vocabulary";function Ai(e,s){const n=lo(e),o=lo(s),a=Math.max(n,o)+40;return Math.max(a,pe.VOCAB_NODE_MIN_WIDTH)}function Vl(){var o;const e=E.getState(),n=(((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??[]).filter(r=>r.type===de.TEXT).sort((r,a)=>r.x+r.y-(a.x+a.y));if(n.length!==0)if(n.length===1){const a=(typeof n[0].content=="string"?n[0].content:"").trim(),i={vocabType:He.VOCABULARY,term:"",definition:"",sourceWord:a,translationWord:""};e.updateNode(n[0].id,{type:de.VOCABULARY,data:i,content:"",width:Ai(a,"")})}else{const r=n[0],a=n[n.length-1],i=typeof r.content=="string"?r.content:"",c=typeof a.content=="string"?a.content:"",l=i.trim(),d=c.trim(),u={vocabType:He.VOCABULARY,term:"",definition:"",sourceWord:l,translationWord:d};e.updateNode(r.id,{type:de.VOCABULARY,data:u,content:"",width:Ai(l,d)});for(let f=1;f<n.length;f++)e.deleteNodeById(n[f].id);const h=e.getNodeById(r.id);h&&e.setSelectedNodes([h])}}jd(Ul,()=>{Vl()});function Vy({node:e,isLockSize:s,onLockSizeToggle:n}){const o=()=>{E.getState().deleteSelectedNodes(),E.getState().setSegmentedButtonAction("node-context-menu","Delete",()=>()=>E.getState().deleteSelectedNodes())},r=()=>{el()},a=()=>{var u;const d=(((u=E.getState().projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??[]).map(h=>typeof h.content=="string"?h.content:"").filter(h=>h.length>0);navigator.clipboard.writeText(d.join(`
`))},i=()=>{Vl(),E.getState().setSegmentedButtonAction("node-context-menu","Turn to Vocabulary",void 0,{actionId:Ul})},c=e.type===de.TEXT;return t.jsxs(zh,{className:"w-48","data-test":"node-context-menu",children:[t.jsx(en,{onClick:()=>n(!s),"data-test":"lock-size-item",children:s?t.jsxs(t.Fragment,{children:[t.jsx(_c,{className:"mr-2 h-4 w-4"}),"Unlock Size"]}):t.jsxs(t.Fragment,{children:[t.jsx(Na,{className:"mr-2 h-4 w-4"}),"Lock Size"]})}),t.jsx(Qo,{}),t.jsxs(en,{onClick:r,"data-test":"copy-item",children:[t.jsx(Mt,{className:"mr-2 h-4 w-4"}),"Copy"]}),t.jsxs(en,{onClick:a,"data-test":"copy-content-item",children:[t.jsx(eh,{className:"mr-2 h-4 w-4"}),"Copy content"]}),c&&t.jsxs(t.Fragment,{children:[t.jsx(Qo,{}),t.jsxs(Uh,{children:[t.jsxs(Vh,{"data-test":"turn-to-trigger",children:[t.jsx(qa,{className:"mr-2 h-4 w-4"}),"Turn to"]}),t.jsx(Gh,{"data-test":"turn-to-submenu",children:t.jsxs(en,{onClick:i,"data-test":"turn-to-vocabulary-item",children:[t.jsx(Lo,{className:"mr-2 h-4 w-4"}),"Vocabulary"]})})]})]}),t.jsx(Qo,{}),t.jsxs(en,{onClick:o,className:"text-destructive focus:text-destructive","data-test":"delete-item",children:[t.jsx(pt,{className:"mr-2 h-4 w-4"}),"Delete"]})]})}function Gy(){const[e,s]=p.useState(0),n=p.useRef(!1),o=p.useRef(0),r=p.useCallback(a=>{const i=Date.now(),c=i-o.current;if(a){const l=c<50;if(l&&(n.current=!0),n.current&&!l){n.current=!1,s(d=>d+1);return}}else o.current=i,s(l=>l+1)},[e]);return{menuKey:e,handleOpenChange:r}}const{DEFAULT_NODE_WIDTH:Yy,DEFAULT_NODE_HEIGHT:Ky}=pe,Xy=({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o=!1})=>{var B,F;const[r,a]=p.useState(!1),i=H(D=>D.uiState.mode),c=H(D=>!!D.uiState.dragInfo),l=H(D=>!!D.uiState.resizingNode),d=H(D=>D.uiState.activeGroupId),h=e.type===de.GROUP&&d===e.id,f=()=>{var O,$;const D=(O=E.getState().projectCanvas.getActive())==null?void 0:O.coreState.selectedNodes,L=(D==null?void 0:D.some(_=>_.id===e.id))??!1,A=D&&D.length>0?(($=D[D.length-1])==null?void 0:$.id)===e.id:!1,T=(D==null?void 0:D.length)??0;return{isNodeAlreadySelected:L,isLastSelectedNode:A,selectedNodeIdsLength:T}},{isNodeAlreadySelected:g,isLastSelectedNode:y,selectedNodeIdsLength:m}=f(),x=((B=E.getState().projectCanvas.getActive())==null?void 0:B.viewState.scale)??1,v=s&&(n??m)===1,{handleMouseDown:b,initialClickPoint:N}=Sw({node:e,mode:i,isPopoverOpen:r,setIsPopoverOpen:a}),{menuKey:j,handleOpenChange:k}=Gy(),S=p.useCallback(D=>{var L;D&&(((L=E.getState().projectCanvas.getActive())==null?void 0:L.coreState.selectedNodes)??[]).length===0&&E.getState().setSelectedNodes([e]),k(D)},[e,k]),C=p.useCallback(D=>{E.getState().updateNode(e.id,{options:{...e.options,lockSize:D}})},[e.id,e.options]),R=p.useCallback(D=>{const L={x:D.clientX,y:D.clientY};if(!kd(N.current,L))return;const T=!e.isEditing&&y;return a(T),T},[e,v,g,y,m,r]);p.useEffect(()=>{if(!g){a(!1);return}if(e.isEditing){a(!1);return}c||l||(y?a(!0):g&&!y&&a(!1))},[m,e.isEditing,g,v,y,e.id,c,l]),p.useEffect(()=>{(c||l)&&a(!1)},[c,l]);const I=()=>{if(o){const{jsx:T}=iy({node:e,isSelected:s,scale:x});return T}const D=e.data,L=(D==null?void 0:D.nodeType)==="workflowOrchestration",A=(D==null?void 0:D.nodeType)==="workflowSource";if(L)return t.jsx(wi,{node:e});if(A)return t.jsx(yi,{node:e,preventEdit:!g});switch(e.type){case de.RECT:return t.jsx(Vf,{node:e});case de.TEXT:return t.jsx(im,{node:e});case de.TABLE:return t.jsx(_w,{node:e});case de.TEXTCARD:return t.jsx(zw,{node:e});case de.WORKFLOW_ORCHESTRATION:return t.jsx(wi,{node:e});case de.WORKFLOW_SOURCE:return t.jsx(yi,{node:e,preventEdit:!g});case de.WORKFLOW_DEFINITION:return t.jsx(vy,{node:e,preventEdit:!g});case de.OCR:return t.jsx(Ny,{node:e});case de.IMAGE:return t.jsx(Cy,{node:e});case de.GROUP:return t.jsx(Fl,{node:e});case de.VOCABULARY:return t.jsx(Wy,{node:e});case de.WORKFLOW_STEP:return t.jsx(Dy,{node:e});case de.DRAWING:return t.jsx(Uy,{node:e});default:return t.jsx("div",{children:"Unknown Node Type"})}},M=se.getSelectionRingClass(s),W=e.styles;return t.jsx(gw,{node:e,isOpen:r,children:t.jsxs(Yh,{onOpenChange:S,children:[t.jsx(Kh,{asChild:!0,children:t.jsxs("div",{id:`NodeContainerV2-${e.id}`,"data-test":"node-container-v2",className:Se("node-container-main","absolute group",i===Q.DRAW?"cursor-crosshair":"cursor-grab","select-none","rounded","overflow-visible",s&&M),style:{transform:(()=>{const D=ts.get(e.id),L=D?e.x+D.dx:e.x,A=D?e.y+D.dy:e.y;return`translate(${L}px, ${A}px)`})(),transition:c||l||i===Q.DRAW?"none":`transform ${se.animation.durationMs}ms ${se.animation.easing}`,width:e.isCollapsed?"auto":`${e.width??Yy}px`,height:e.isCollapsed?"0px":`${e.height??Ky}px`,minWidth:e.isCollapsed?"100px":void 0,transformOrigin:"0 0",border:e.isCollapsed?"none":W==null?void 0:W.border,borderWidth:e.isCollapsed||W==null?void 0:W.borderWidth,borderColor:e.isCollapsed||W==null?void 0:W.borderColor,borderStyle:e.isCollapsed?void 0:W!=null&&W.borderWidth?(W==null?void 0:W.borderStyle)||"solid":W==null?void 0:W.borderStyle,willChange:"transform",backfaceVisibility:"hidden",pointerEvents:h?"none":"auto"},onPointerDown:h?void 0:b,onPointerUp:h?void 0:R,"data-node-id":e.id,children:[t.jsx(Gw,{node:e,isSingleNodeSelected:v,isCollapsed:e.isCollapsed}),!e.isCollapsed&&t.jsx(ry,{node:e}),e.isPinned&&t.jsx("div",{className:"pin-indicator-border absolute pointer-events-none rounded border-[3px] border-primary",style:{top:"-6px",left:"-6px",right:"-6px",bottom:"-6px",zIndex:1e3}}),(()=>{var O;const D=e.data,L=D==null?void 0:D.nodeType,A=D==null?void 0:D.executionState,T=(O=D==null?void 0:D.executionData)==null?void 0:O.duration;return L&&A?t.jsx(ly,{executionState:A,duration:T}):null})(),v&&t.jsx(Hw,{node:e}),!e.isCollapsed&&t.jsxs("section",{className:"node-content-section h-[100%] overflow-visible",children:[t.jsx("div",{id:`node-content-${e.id}`,className:Se("node-content-inner relative w-full h-full overflow-visible","flex",{}),children:I()}),(()=>{var T;const D=e.data,L=(D==null?void 0:D.nodeType)==="manualTrigger",A=(T=D==null?void 0:D.parameters)==null?void 0:T.label;return L?t.jsx("div",{className:"manual-trigger-button-container absolute bottom-2 left-2 right-2 px-2",children:t.jsx($l,{nodeId:e.id,label:A})}):null})(),t.jsxs(t.Fragment,{children:[t.jsx(vw,{node:e,isSelected:v,mode:i}),t.jsx(Nw,{node:e,isSelected:v,mode:i})]})]})]})}),t.jsx(Vy,{node:e,isLockSize:((F=e.options)==null?void 0:F.lockSize)??!1,onLockSizeToggle:C})]},j)})};function qy(e,s){if(e.node===s.node&&e.isSelected===s.isSelected&&e.selectedNodesCount===s.selectedNodesCount&&e.useSimplifiedRendering===s.useSimplifiedRendering)return!0;if(s.node.type===de.GROUP){const I=[];e.node!==s.node&&I.push("node ref"),e.node.x!==s.node.x&&I.push(`x: ${e.node.x} -> ${s.node.x}`),e.node.y!==s.node.y&&I.push(`y: ${e.node.y} -> ${s.node.y}`),e.isSelected!==s.isSelected&&I.push("isSelected"),e.selectedNodesCount!==s.selectedNodesCount&&I.push(`selectedNodesCount: ${e.selectedNodesCount} -> ${s.selectedNodesCount}`)}const n=e.node.x===s.node.x,o=e.node.y===s.node.y,r=n&&o,a=e.node.width===s.node.width,i=e.node.height===s.node.height,c=a&&i,l=e.isSelected===s.isSelected,d=e.node.content===s.node.content,u=e.node.title===s.node.title,h=e.node.type===s.node.type,f=e.node.isEditing===s.node.isEditing,g=e.node.styles===s.node.styles,y=e.node.tags,m=s.node.tags,x=Array.isArray(y),w=Array.isArray(m),v=y===m||!x&&!w||x&&w&&y.length===m.length&&y.every((I,M)=>I===m[M]),b=e.node.isPinned===s.node.isPinned,N=e.node.isCollapsed===s.node.isCollapsed,j=e.node.data===s.node.data,k=e.node.options===s.node.options,S=e.selectedNodesCount===s.selectedNodesCount,C=e.useSimplifiedRendering===s.useSimplifiedRendering;return!!(r&&c&&l&&d&&u&&h&&f&&g&&v&&b&&N&&j&&k&&S&&C)}const Do=Ce.memo(({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o})=>t.jsx(Xy,{node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o}),qy),Zy=e=>{const{className:s,style:n}=e,o=H(g=>g.uiState.mode),r=H(g=>g.uiState.zoomSubMode),a=H(g=>g.uiState.writeSubMode),i=H(g=>g.uiState.drawSubMode),c=H(g=>g.uiState.activeGlobalOverlay),[l,d]=p.useState(null);p.useEffect(()=>{if(o!==Q.VIM){d(null);return}const g=()=>{const m=window.__vimContainer;if(!m)return null;try{const x=m.get(vc),w=x==null?void 0:x.getVimCore(Ot.canvasVim),v=w==null?void 0:w.getVimState();return(v==null?void 0:v.mode)??null}catch{return null}};d(g());const y=setInterval(()=>{d(g())},100);return()=>clearInterval(y)},[o]);let u=o;o===Q.ZOOM&&r==="zoom:lock"?u="zoom:lock":o===Q.WRITE&&a===Ws.AUDIO?u="write:audio":o===Q.DRAW?u=`draw: ${ze.getSubModeLabel(i??be.FREEHAND)}`:o===Q.VIM&&l&&(u=`vim: ${l.charAt(0)+l.slice(1).toLowerCase()}`);const f=(g=>!g||g===hs.NONE?null:g.charAt(0).toUpperCase()+g.slice(1))(c);return t.jsxs("div",{className:`text-xs p-1 bg-background/50 rounded pointer-events-auto ${s}`,style:{...n},"data-test":"canvas-mode-info",children:[t.jsxs("div",{"data-test":"canvas-mode-info-mode",children:["Mode: ",u||"N/A"]}),f&&t.jsxs("div",{"data-test":"canvas-mode-info-overlay",className:"text-primary",children:["Overlay: ",f]})]})},Jy=e=>{const{className:s,style:n}=e,[o,r]=p.useState(1),[a,i]=p.useState([]);p.useEffect(()=>{const x=E.subscribe(b=>{const N=b.projectCanvas.getActive();N&&r(N.viewState.scale),i(b.uiState.zoomMarks||[])}),w=E.getState(),v=w.projectCanvas.getActive();return v&&r(v.viewState.scale),i(w.uiState.zoomMarks||[]),x},[]);const c=x=>{const w=x[0],v=E.getState(),b=v.projectCanvas.getActive();if(!b)return;const{scale:N,offset:j}=b.viewState,k=document.getElementById("CanvasAppV2");if(!k)return;const S=k.getBoundingClientRect(),C={x:S.width/2,y:S.height/2},R=xt(C,N,j),I=C.x-R.x*w,M=C.y-R.y*w,W=isNaN(I)?0:I,B=isNaN(M)?0:M,F=isNaN(w)?1:w;v.setActiveCanvasViewState(D=>({...D,scale:F,offset:{x:W,y:B}}))},{min:l,max:d,marks:u}=se.zoom,h=Math.round(o*100),f=Array.from(new Set([...u,...a])).sort((x,w)=>x-w),g=()=>{const x=Math.round(o*100)/100;E.getState().addZoomMark(x)},y=x=>{E.getState().removeZoomMark(x)},m=x=>a.includes(x);return t.jsxs("div",{"data-ui-panel":"zoom-slider","data-test":"canvas-zoom-slider",className:`flex flex-col gap-2 p-2 bg-background/50 rounded pointer-events-auto min-w-[200px] ${s}`,style:{...n},children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{children:"Zoom"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"font-mono",children:[h,"%"]}),t.jsx(ee,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:g,title:"Save current zoom level","data-test":"canvas-zoom-save-button",children:t.jsx(wt,{className:"h-3 w-3"})})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(Vt,{value:[o],onValueChange:c,min:l,max:d,step:.01,className:"cursor-pointer","data-test":"canvas-zoom-slider"}),t.jsx("div",{className:"relative h-4 mt-1 px-3",children:f.map(x=>{const w=(x-l)/(d-l)*100,v=m(x);return t.jsxs("div",{className:"absolute flex flex-col items-center group",style:{left:`${w}%`,transform:"translateX(-50%)"},children:[t.jsxs("div",{className:"cursor-pointer hover:opacity-70 transition-opacity flex flex-col items-center",onClick:()=>c([x]),title:`Zoom to ${Math.round(x*100)}%`,children:[t.jsx("div",{className:`w-px h-2 ${v?"bg-primary/60":"bg-muted-foreground/40"}`}),t.jsx("span",{className:`text-[10px] mt-0.5 ${v?"text-primary":"text-muted-foreground"}`,children:x===1?"1×":`${x}×`})]}),v&&t.jsx("button",{className:"opacity-0 group-hover:opacity-100 absolute -top-2 right-0 h-3 w-3 rounded-full bg-destructive/80 hover:bg-destructive flex items-center justify-center transition-opacity",onClick:b=>{b.stopPropagation(),y(x)},title:"Remove mark","data-test":"canvas-zoom-remove-mark-button",children:t.jsx(We,{className:"h-2 w-2 text-destructive-foreground"})})]},x)})})]})]})},ma=({position:e,onMouseDown:s,onDoubleClick:n,variant:o="end",size:r=4,className:a})=>t.jsx("circle",{"data-test":`arrow-handle-${o}`,cx:e.x,cy:e.y,r,fill:"hsl(var(--primary))",stroke:"hsl(var(--primary-foreground))",strokeWidth:1,onPointerDown:s,onDoubleClick:n,className:Se("cursor-move",a),style:{pointerEvents:"all",touchAction:"none"}}),Ii=se.arrows.REVERSE_CURVE,Qy=(e,s)=>{const n=(e.x+s.x)/2,o=(e.y+s.y)/2,r=s.x-e.x,a=s.y-e.y,i=Math.sqrt(r*r+a*a);if(i===0)return{path:`M ${e.x} ${e.y}`,controlPoint:e};const c=-a/i,l=r/i;let d=i*.2;(!Ii&&e.x<s.x||Ii&&e.x>s.x)&&(d=-d);const u=n+c*d,h=o+l*d,f={x:u,y:h};return{path:`M ${e.x} ${e.y} Q ${u} ${h}, ${s.x} ${s.y}`,controlPoint:f}},ev=(e,s,n)=>{let o=s.x-e.x;const r=s.y-e.y,a=Math.sqrt(o*o+r*r),i=Math.max(20,a*.15);if(a===0)return{x:0,y:i};let c=-r,l=o;n||(o=-o),o<0&&(c=-c,l=-l);const d=c/a,u=l/a;return{x:d*i,y:u*i}},Kn=()=>{var e;return((e=E.getState().projectCanvas.getActive())==null?void 0:e.coreState.nodes)??[]},tv=(e,s,n,o)=>{jt(E,m=>{var x,w;return(w=(x=m.preferences)==null?void 0:x.canvasConfig)==null?void 0:w.arrows});const r=e.type??se.arrows.type,a=se.arrows.REVERSE_CURVE,i=se.arrows.CUBIC_HORIZONTAL_BIAS,c=-10,l=r==="TreeCubic"||r==="TreeLStep"||r==="TreeZShape",d=p.useMemo(()=>{const m=Kn(),x=m.find(N=>N.id===e.startNodeId),w=m.find(N=>N.id===e.endNodeId);if(l&&x&&w){const N=Ge(x);return vo(e.endNodeId,e.endPoint,N,m,c)}if((r==="Cubic"||r==="Orthogonal")&&x&&w){const N=Ge(x);return Ms(e.endNodeId,e.endPoint,N,m,c,i)}if(r==="Step"&&x&&w){const N=Ge(x),j=Ge(w),k=j.x-N.x,S=j.y-N.y,R=Math.abs(k)*i>=Math.abs(S)?.001:1e3;return Ms(e.endNodeId,e.endPoint,N,m,c,R)}const v=x?et(e.startNodeId,e.startPoint,e.endPoint,m,e.startRowId):e.startPoint;return w?et(e.endNodeId,e.endPoint,v,m,e.endRowId):e.endPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,r,i,n,o]),u=p.useMemo(()=>{const m=Kn(),x=m.find(b=>b.id===e.startNodeId),w=m.find(b=>b.id===e.endNodeId);if(r==="TreeLStep"&&x)return tl(e.startNodeId,e.startPoint,m);if((r==="TreeCubic"||r==="TreeZShape")&&x&&w){const b=Ge(w);return vo(e.startNodeId,e.startPoint,b,m,0)}if((r==="Cubic"||r==="Step"||r==="Orthogonal")&&x&&w){const b=Ge(w);return Ms(e.startNodeId,e.startPoint,b,m,0,i)}const v=w?et(e.endNodeId,e.endPoint,e.startPoint,m,e.endRowId):e.endPoint;return x?et(e.startNodeId,e.startPoint,v,m,e.startRowId):e.startPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,r,i,n,o]),h=p.useMemo(()=>{const m=(u.x+d.x)/2,x=(u.y+d.y)/2;if(e.controlPointOffset)return{x:m+e.controlPointOffset.x,y:x+e.controlPointOffset.y};{const w=ev(u,d,a),v=d.x-u.x,b=d.y-u.y,N=v>0?m-w.x:m+w.x,j=b<0?x-w.y:x+w.y;return{x:N,y:j}}},[e.controlPointOffset,u,d,s,a]),f=p.useMemo(()=>{if(r!=="Cubic"&&r!=="TreeCubic")return null;const m=Kn(),x=m.find(N=>N.id===e.startNodeId),w=m.find(N=>N.id===e.endNodeId);let v="horizontal",b;if(x&&w){const N=Ge(x),j=Ge(w),k=j.x-N.x,S=j.y-N.y;r==="TreeCubic"?v="horizontal":v=Math.abs(k)*i>=Math.abs(S)?"horizontal":"vertical",b={dx:k,dy:S}}return xg(u,d,v,b)},[u,d,r,e.startNodeId,e.endNodeId,i,n,o]),{path:g}=p.useMemo(()=>Qy(u,d),[u,d,s]),y=p.useMemo(()=>{if(!(r==="Step"||r==="Orthogonal"||r==="TreeLStep"||r==="TreeZShape"))return null;if(r==="TreeLStep")return[u,{x:u.x,y:d.y},d];if(r==="TreeZShape"){const N=(u.x+d.x)/2;return[u,{x:N,y:u.y},{x:N,y:d.y},d]}const x=Kn(),w=x.find(N=>N.id===e.startNodeId),v=x.find(N=>N.id===e.endNodeId);let b=!0;if(w&&v){const N=Ge(w),j=Ge(v),k=j.x-N.x,S=j.y-N.y;b=Math.abs(k)*i>=Math.abs(S)}if(r==="Step")return b?[u,{x:d.x,y:u.y},d]:[u,{x:u.x,y:d.y},d];{const N=(u.x+d.x)/2,j=(u.y+d.y)/2;return b?[u,{x:N,y:u.y},{x:N,y:d.y},d]:[u,{x:u.x,y:j},{x:d.x,y:j},d]}},[u,d,r,e.startNodeId,e.endNodeId,i,n,o]);return{actualStartPoint:u,actualEndPoint:d,bezierPath:g,controlPoint:h,cubicControlPoints:f,stepPoints:y,arrowType:r}},sv=(e,s,n,o,r)=>{const a=E.getState();a.scrollToArrow;const i=a.uiState.mode,c=a.projectCanvas.getActive(),l=(c==null?void 0:c.viewState.scale)??1,d=(c==null?void 0:c.coreState.nodes)??[],u=a.arrow.setAll,h=a.arrow.setSelected,f=a.setSelectedNodes,[g,y]=p.useState(null),[m,x]=p.useState(null),[w,v]=p.useState(null),b=p.useRef(null),N=p.useCallback((j,k)=>{i!==Q.SELECT||j.button!==0&&j.button!==-1||(j.stopPropagation(),y(k),x({x:j.clientX,y:j.clientY}),v({...e,startPoint:s,endPoint:n,controlPointOffset:o}),b.current=k==="start"?s:k==="end"?n:o,r||(f([]),h([e])))},[i,e,s,n,o,r,h,f]);return p.useEffect(()=>{const j=S=>{var A;if(!g||!m||!w)return;const C=S.clientX-m.x,R=S.clientY-m.y,I=C/l,M=R/l,W=g==="start"?w.startPoint:g==="end"?w.endPoint:w.controlPointOffset;let B={x:W.x+I,y:W.y+M};const F=bo(S.clientX,S.clientY);let D=null,L=null;if(F){D=F.nodeId,L=F.rowId;const T=g==="start"?w.endPoint:g==="end"?w.startPoint:w.controlPointOffset;B=et(D,B,T,d,L)}else{const T=io(B,d);if(T&&!(((A=T.data)==null?void 0:A.nodeType)==="workflowOrchestration")){D=T.id;const $=g==="start"?w.endPoint:g==="end"?w.startPoint:w.controlPointOffset;B=et(D,B,$,d)}}b.current=B,u(T=>T.map(O=>{if(O.id===w.id){const $={...O};if(g==="start")$.startPoint=B,$.startNodeId=D,$.startRowId=L;else if(g==="end")$.endPoint=B,$.endNodeId=D,$.endRowId=L;else if(g==="control"){const _=O.startNodeId?et(O.startNodeId,O.startPoint,O.endPoint,d,O.startRowId):O.startPoint,G=O.endNodeId?et(O.endNodeId,O.endPoint,O.startPoint,d,O.endRowId):O.endPoint,X=(_.x+G.x)/2,J=(_.y+G.y)/2,P={x:B.x-X,y:B.y-J};$.controlPointOffset=P}return $}return O}))},k=S=>{var R;if(!g||!w)return;const C=b.current;if(C){const I=bo(S.clientX,S.clientY);let M=null,W=null;const B=g==="start"?w.endPoint:g==="end"?w.startPoint:w.controlPointOffset;let F;if(I)M=I.nodeId,W=I.rowId,F=et(M,C,B,d,W);else{const D=io(C,d);D?((R=D.data)==null?void 0:R.nodeType)==="workflowOrchestration"?F=C:(M=D.id,F=et(M,C,B,d)):F=C}u(D=>D.map(L=>{if(L.id===w.id){const A={...L};return g==="start"?(A.startPoint=F,A.startNodeId=M,A.startRowId=W):g==="end"&&(A.endPoint=F,A.endNodeId=M,A.endRowId=W),A}return L}))}y(null),x(null),v(null),b.current=null};return g&&(window.addEventListener("pointermove",j),window.addEventListener("pointerup",k)),()=>{window.removeEventListener("pointermove",j),window.removeEventListener("pointerup",k)}},[g,m,w,l,u,d]),{handleMouseDownOnHandle:N}},nv=(e,s,n)=>`M ${e.x} ${e.y} Q ${s.x} ${s.y} ${n.x} ${n.y}`,ov=(e,s,n,o)=>`M ${e.x} ${e.y} C ${s.x} ${s.y} ${n.x} ${n.y} ${o.x} ${o.y}`,av=e=>{if(e.length<2)return"";const[s,...n]=e;return`M ${s.x} ${s.y} `+n.map(o=>`L ${o.x} ${o.y}`).join(" ")},La=({startPoint:e,endPoint:s,controlPoint:n,cubicControlPoints:o,stepPoints:r,useCurvedArrows:a,stroke:i,strokeWidth:c,markerEndId:l,strokeDasharray:d,isHitbox:u=!1,onPointerDown:h})=>{const f={stroke:i,strokeWidth:c,fill:"none",strokeDasharray:d,markerEnd:!u&&l?`url(#${l})`:void 0,onPointerDown:h,style:{pointerEvents:"auto"}};if(r&&r.length>=2){const g=av(r);return t.jsx("path",{d:g,...f})}if(a&&o&&o.length===2){const[g,y]=o,m=ov(e,g,y,s);return t.jsx("path",{d:m,...f})}if(a&&n){const g=nv(e,n,s);return t.jsx("path",{d:g,...f})}return t.jsx("line",{x1:e.x,y1:e.y,x2:s.x,y2:s.y,...f})},rv=({isSelected:e,label:s,labelPosition:n,labelInput:o,setLabelInput:r,onLabelChange:a,onLabelBlur:i,onLabelKeyDown:c})=>{const l=pe.FONT_SIZE_XXS,d=6,u=4,h=l*.6,g=s.length*h+2*d,y=l+2*u;return e?t.jsx("foreignObject",{x:n.x-50,y:n.y-15,width:"100",height:"30",style:{pointerEvents:"auto"},children:t.jsx(Ae,{"data-test":"arrow-label-input",type:"text",value:o,onChange:a,onBlur:i,onKeyDown:c,onMouseDown:m=>m.stopPropagation(),placeholder:"Label",className:"w-full h-full text-[12px]! text-center p-0.5 bg-background border border-border rounded-sm focus:ring-1 focus:ring-ring focus:outline-none"})}):s?t.jsxs(t.Fragment,{children:[t.jsx("rect",{x:n.x-g/2,y:n.y-y/2,width:g,height:y,fill:"hsl(var(--background))",rx:"3",ry:"3",style:{pointerEvents:"none"}}),t.jsx("text",{x:n.x,y:n.y,fill:"hsl(var(--foreground))",fontSize:l,textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:s})]}):null},iv=({markerId:e,strokeColor:s,markerOrientation:n})=>t.jsx("defs",{children:t.jsx("marker",{id:e,markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:n,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:s})})}),cv=({arrow:e})=>{const s=H($=>{var _,G;return((G=(_=$.projectCanvas.getActive())==null?void 0:_.coreState.selectedArrows)==null?void 0:G.some(X=>X.id===e.id))??!1}),n=H($=>$.uiState.mode),{setSelectedNodes:o}=E.getState(),{setSelected:r,update:a}=E.getState().arrow;H($=>{var _,G;return(G=(_=$.preferences)==null?void 0:_.canvasConfig)==null?void 0:G.arrows});const i=H($=>{var G,X;const _=(X=(G=$.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:X.find(J=>J.id===e.startNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),c=H($=>{var G,X;const _=(X=(G=$.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:X.find(J=>J.id===e.endNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),{actualStartPoint:l,actualEndPoint:d,controlPoint:u,cubicControlPoints:h,stepPoints:f,arrowType:g}=tv(e,!0,i,c),y=g!=="Straight",{handleMouseDownOnHandle:m}=sv(e,l,d,u,s),x=$=>{var X;if(n!==Q.SELECT||$.button!==0&&$.button!==-1)return;$.stopPropagation();const _=((X=E.getState().projectCanvas.getActive())==null?void 0:X.coreState.selectedArrows)??[];if($.ctrlKey||$.metaKey){r(s?_.filter(J=>J.id!==e.id):[..._,e]);return}if($.shiftKey){s||r([..._,e]);return}o([]),r([e])},w=$=>{$.stopPropagation(),a(e.id,{controlPointOffset:null})},[v,b]=p.useState(e.label||""),N=p.useRef(null);p.useEffect(()=>{s&&N.current===null?N.current=e.label||"":s||(N.current=null)},[s,e.label]),p.useEffect(()=>{b(e.label||"")},[e.label]);const j=$=>{b($.target.value),a(e.id,{label:$.target.value})},k=()=>{e.label!==v&&a(e.id,{label:v});const $=N.current;$!==null&&$!==v&&E.getState().undo.commit({type:"arrow:update",arrowId:e.id,from:{label:$},to:{label:v}})},S=$=>{$.key==="Enter"&&$.currentTarget.blur(),$.stopPropagation()},C=0,R=p.useMemo(()=>{if(y&&u){const $=(l.x+d.x)/2,_=(l.y+d.y)/2;return{x:$-(u.x-$),y:_-(u.y-_)+C}}return{x:(l.x+d.x)/2,y:(l.y+d.y)/2+C}},[l,d,u,y]),I=e.strokeColor??se.arrows.styles.line,M=s&&!e.strokeColor?se.arrows.styles.lineSelected:I,W=e.strokeWidth??1,B=s?W+.5:W,D=($=>{switch($){case"dashed":return"8,4";case"dotted":return"2,4";default:return}})(e.strokeStyle),L=s&&n===Q.SELECT,A=y?"auto-start-reverse":"auto",T=`arrowhead-${e.id}`,O=e.strokeColor??M;return t.jsxs("g",{"data-arrow-id":e.id,style:{cursor:n===Q.SELECT?"pointer":"default"},children:[t.jsx(iv,{markerId:T,strokeColor:O,markerOrientation:A}),t.jsx(La,{startPoint:l,endPoint:d,controlPoint:u,cubicControlPoints:h,stepPoints:f,useCurvedArrows:y,stroke:M,strokeWidth:B,strokeDasharray:D,markerEndId:T}),t.jsx(La,{startPoint:l,endPoint:d,controlPoint:u,cubicControlPoints:h,stepPoints:f,useCurvedArrows:y,stroke:"transparent",strokeWidth:15,isHitbox:!0,onPointerDown:x}),L&&t.jsxs(t.Fragment,{children:[t.jsx(ma,{position:l,onMouseDown:$=>m($,"start")}),t.jsx(ma,{position:d,onMouseDown:$=>m($,"end")}),y&&u&&t.jsx(ma,{position:u,onMouseDown:$=>m($,"control"),onDoubleClick:w,variant:"control"})]}),t.jsx(rv,{isSelected:s,label:e.label||"",labelPosition:R,labelInput:v,setLabelInput:b,onLabelChange:j,onLabelBlur:k,onLabelKeyDown:S})]})};function lv(e,s){const n=e.arrow,o=s.arrow,r=n.startPoint.x===o.startPoint.x&&n.startPoint.y===o.startPoint.y,a=n.endPoint.x===o.endPoint.x&&n.endPoint.y===o.endPoint.y,i=n.label===o.label,c=n.type===o.type,l=n.controlPointOffset==null&&o.controlPointOffset==null||n.controlPointOffset!=null&&o.controlPointOffset!=null&&n.controlPointOffset.x===o.controlPointOffset.x&&n.controlPointOffset.y===o.controlPointOffset.y,d=n.strokeColor===o.strokeColor,u=n.strokeWidth===o.strokeWidth,h=n.strokeStyle===o.strokeStyle;return r&&a&&i&&c&&l&&d&&u&&h}const Gl=Ce.memo(cv,lv),dv=[{value:"solid",label:"Solid",dashArray:"none"},{value:"dashed",label:"Dashed",dashArray:"8,4"},{value:"dotted",label:"Dotted",dashArray:"2,4"}],uv=({currentColor:e,currentWidth:s,currentStyle:n,onColorSelect:o,onWidthChange:r,onStyleChange:a})=>{const[i,c]=p.useState(e),[l,d]=p.useState(s),[u,h]=p.useState(n);p.useEffect(()=>{c(e)},[e]),p.useEffect(()=>{d(s)},[s]),p.useEffect(()=>{h(n)},[n]);const f=m=>{c(m),o(m)},g=m=>{const x=parseFloat(m.target.value);!isNaN(x)&&x>=.5&&x<=10&&(d(x),r(x))},y=m=>{h(m),a(m)};return t.jsxs("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"arrow-style-picker-content",children:[t.jsxs("div",{"data-test":"arrow-style-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:zo.filter(m=>m.value!=="transparent").map(m=>t.jsx("button",{type:"button",title:m.name,onClick:()=>f(m.value),className:we("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",m.twClass,m.value===i?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",m.value==="#ffffff"&&"border-neutral-300"),style:m.value.startsWith("hsl(")?{backgroundColor:m.value}:{},"aria-label":`Select color ${m.name}`,"data-test":`arrow-color-${m.name.toLowerCase().replace(/\s+/g,"-")}`},m.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?Uo(i):i.startsWith("#")?i:"#000000",onChange:m=>f(m.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"arrow-color-custom-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-width-section",children:[t.jsxs("label",{htmlFor:"arrow-stroke-width-input",className:"block text-xs text-muted-foreground font-medium mb-1",children:["Stroke Width: ",l,"px"]}),t.jsx("input",{type:"range",id:"arrow-stroke-width-input",value:l,onChange:g,min:"0.5",max:"10",step:"0.5",className:"w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer","data-test":"arrow-stroke-width-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-style-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Style"}),t.jsx("div",{className:"flex gap-2",children:dv.map(m=>t.jsx("button",{type:"button",onClick:()=>y(m.value),className:we("flex-1 px-2 py-1.5 rounded border text-xs",u===m.value?"border-primary bg-primary/10":"border-muted hover:border-muted-foreground"),title:m.label,"data-test":`arrow-style-${m.value}`,children:t.jsx("svg",{width:"100%",height:"12",viewBox:"0 0 40 12",className:"stroke-current",children:t.jsx("line",{x1:"2",y1:"6",x2:"38",y2:"6",strokeWidth:"2",strokeDasharray:m.dashArray,fill:"none"})})},m.value))})]})]})},hv=[],pv=({className:e})=>{const[s,n]=p.useState(!1),o=H(j=>{var k;return((k=j.projectCanvas.getActive())==null?void 0:k.coreState.selectedArrows)??hv}),r=H(j=>j.arrow.update),a=o.length>0?o[0]:null,[i,c]=p.useState((a==null?void 0:a.strokeColor)??"hsl(var(--muted-light))"),[l,d]=p.useState((a==null?void 0:a.strokeWidth)??1),[u,h]=p.useState((a==null?void 0:a.strokeStyle)??"solid"),f=E.getState().getLastUsedArrowStyle();p.useEffect(()=>{a?(c(a.strokeColor??"hsl(var(--muted-light))"),d(a.strokeWidth??1),h(a.strokeStyle??"solid")):(c("hsl(var(--muted-light))"),d(1),h("solid"))},[a]);const g=(j,k,S)=>{o.forEach(C=>{r(C.id,{strokeColor:j,strokeWidth:k,strokeStyle:S})})},y=()=>{g(f.lastUsedColor,f.lastUsedWidth,f.lastUsedStyle)},m=j=>{g(j,l,u),c(j),E.getState().setLastUsedArrowStyle(j,l,u),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},x=j=>{g(i,j,u),d(j),E.getState().setLastUsedArrowStyle(i,j,u),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},w=j=>{g(i,l,j),h(j),E.getState().setLastUsedArrowStyle(i,l,j),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},v=()=>{c("hsl(var(--muted-light))"),d(1),h("solid"),g(void 0,void 0,void 0)},b=[{label:"Apply last used style",icon:t.jsx("span",{style:{color:f.lastUsedColor,display:"inline-flex"},children:t.jsx(Cr,{className:"h-2.5 w-2.5"})}),onClick:y,disabled:o.length===0},{label:"Set Arrow Style",icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(Oc,{className:"h-2.5 w-2.5"})}),onClick:()=>{n(!0)},disabled:o.length===0},{label:"Reset Style",icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:v,disabled:o.length===0}],N={...b[0],icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(Cr,{className:"h-2.5 w-2.5"})})};return t.jsxs(ot,{open:s,onOpenChange:n,children:[t.jsx(at,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"arrow-style-picker-button",children:t.jsx(Ye,{mainAction:N,dropdownActions:b,variant:"outline",size:"compact",persistenceKey:"arrow-style-picker",className:e})})}),t.jsx(rt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:j=>j.preventDefault(),"data-test":"arrow-style-picker-popover",children:t.jsx(uv,{currentColor:i,currentWidth:l,currentStyle:u,onColorSelect:m,onWidthChange:x,onStyleChange:w})})]})},Ti=[],gv=[],fv=()=>{const e=H(d=>d.setSelectedNodes),s=H(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??Ti}),n=H(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedArrows)??gv});H(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.nodes)??Ti});const o=s.length>0,r=p.useMemo(()=>{const d=new Set;return n.forEach(u=>{u.startNodeId&&d.add(u.startNodeId),u.endNodeId&&d.add(u.endNodeId)}),d},[n]),a=p.useCallback(()=>{const u=E.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.selectedArrows??[],f=u.coreState.nodes??[],g=new Set;h.forEach(m=>{m.startNodeId&&g.add(m.startNodeId),m.endNodeId&&g.add(m.endNodeId)});const y=f.filter(m=>g.has(m.id));e(y)},[e]),i=p.useCallback(()=>{e([])},[e]),c=[{label:"Select connected nodes",icon:t.jsx(jr,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0},{label:"Deselect all nodes",icon:t.jsx(We,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!o}],l=o?{label:"Deselect all nodes",icon:t.jsx(We,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!1}:{label:"Select connected nodes",icon:t.jsx(jr,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0};return t.jsx(Ye,{mainAction:l,dropdownActions:c,variant:"outline",size:"compact",persistenceKey:"arrow-connected-nodes","data-test":"arrow-connected-nodes-button"})},mv=({arrows:e})=>{const s=p.useCallback(()=>{E.getState().deleteSelectedArrows()},[]);return t.jsxs("div",{className:Se("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:ke.nodeQuickPanel},"data-test":"arrow-quick-panel-container","data-arrow-ids":e.map(n=>n.id).join(","),children:[t.jsx(pv,{}),t.jsx(Rl,{}),t.jsx(fv,{}),t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:s,title:"Delete selected arrows","data-test":"arrow-delete-button",children:t.jsx(pt,{className:"h-3.5 w-3.5"})})]})},Xn=30,xv=[],wv=()=>{var d;const[e,s]=p.useState({top:0,left:0}),n=p.useRef(null),o=H(u=>{var h,f;return(((f=(h=u.projectCanvas.getActive())==null?void 0:h.coreState.selectedArrows)==null?void 0:f.length)??0)>0}),r=H(u=>u.uiState.mode),a=H(u=>{var h;return(h=u.projectCanvas.getActive())==null?void 0:h.viewState}),i=o,c=r===Q.DRAW_ARROW;if(p.useEffect(()=>{if(!i||!a)return;const u=()=>{var B,F,D,L;const f=((B=E.getState().projectCanvas.getActive())==null?void 0:B.coreState.selectedArrows)??[],g=((F=E.getState().projectCanvas.getActive())==null?void 0:F.coreState.nodes)??[];if(f.length===0)return;let y=0,m=0,x=0,w=0,v=0;if(f.forEach(A=>{const T=document.querySelector(`[data-arrow-id="${A.id}"]`);if(!T)return;const O=T.getBoundingClientRect(),$=O.left+O.width/2,_=O.top+O.height/2,{actualStartPoint:G,actualEndPoint:X}=sl(A,g),J=X.x-G.x,P=X.y-G.y;y+=$,m+=_,x+=J,w+=P,v++}),v===0)return;const b=y/v,N=m/v,j=Math.abs(w)>Math.abs(x),k=((D=n.current)==null?void 0:D.offsetHeight)||40,S=((L=n.current)==null?void 0:L.offsetWidth)||100,C=window.innerWidth,R=window.innerHeight,I=20;let M,W;if(j){const A=b-S-Xn,T=b+Xn,O=A>=I,$=T+S<=C-I;W=O?A:$?T:I,M=N-k/2}else{const A=N-k-Xn,T=N+Xn,O=A>=I,$=T+k<=R-I;M=O?A:$?T:I,W=b-S/2}M=Math.max(I,Math.min(M,R-k-I)),W=Math.max(I,Math.min(W,C-S-I)),s({top:M,left:W})};u();const h=setTimeout(u,100);return window.addEventListener("scroll",u,!0),window.addEventListener("resize",u),()=>{clearTimeout(h),window.removeEventListener("scroll",u,!0),window.removeEventListener("resize",u)}},[i,a]),!i||c)return null;const l=((d=E.getState().projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??xv;return Ys.createPortal(t.jsx("div",{ref:n,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:ke.quickPanelPortal},onPointerDown:u=>u.stopPropagation(),onTouchStart:u=>u.stopPropagation(),onWheel:u=>u.stopPropagation(),"data-test":"arrow-quick-panel-portal",children:t.jsx(mv,{arrows:l})}),document.body)},yv=({currentColor:e,onColorSelect:s})=>{const[n,o]=p.useState(e);p.useEffect(()=>{o(e)},[e]);const r=a=>{o(a),s(a)};return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"group-background-picker-content",children:t.jsxs("div",{"data-test":"group-background-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Background Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:zo.map(a=>t.jsx("button",{type:"button",title:a.name,onClick:()=>r(a.value),className:we("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",a.twClass,a.value===n?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",a.value==="#ffffff"&&"border-neutral-300",a.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:a.value.startsWith("hsl(")?{backgroundColor:a.value}:{},"aria-label":`Select color ${a.name}`,"data-test":`group-background-color-${a.name.toLowerCase().replace(/\s+/g,"-")}`},a.value))}),t.jsx("input",{type:"color",value:n.startsWith("hsl")?Uo(n):n.startsWith("#")?n:"#000000",onChange:a=>r(a.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"group-background-color-custom-input"})]})})},rn="hsl(var(--background))",Ei=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),vv=({groups:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e,i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.styles)==null?void 0:v.backgroundColor)??rn),[u,h]=p.useState(rn);p.useEffect(()=>{var b;d(c?((b=c.styles)==null?void 0:b.backgroundColor)??rn:rn)},[c]);const f=b=>{a.forEach(N=>{const j=N.data,k={...j,childNodeIds:(j==null?void 0:j.childNodeIds)??[],styles:{...j==null?void 0:j.styles,backgroundColor:b}};r(N.id,{data:k})})},g=()=>{f(u)},y=b=>{f(b),d(b),h(b),E.getState().setSegmentedButtonAction("group-background-picker","Apply last used style")},m=()=>{d(rn),f(void 0)},x=[{label:"Apply last used style",icon:t.jsx(Ei,{color:u}),onClick:g,disabled:a.length===0},{label:"Set Background Color",icon:t.jsx(Ei,{color:l}),onClick:()=>{o(!0)},disabled:a.length===0},{label:"Reset Style",icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:m,disabled:a.length===0}],w={...x[0]};return t.jsxs(ot,{open:n,onOpenChange:o,children:[t.jsx(at,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"group-background-picker-button",children:t.jsx(Ye,{mainAction:w,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"group-background-picker",className:s})})}),t.jsx(rt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:b=>b.preventDefault(),"data-test":"group-background-picker-popover",children:t.jsx(yv,{currentColor:l,onColorSelect:y})})]})},bv=({groups:e})=>t.jsx("div",{className:Se("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:ke.nodeQuickPanel},"data-test":"group-quick-panel-container","data-group-ids":e.map(s=>s.id).join(","),children:t.jsx(vv,{groups:e})}),Ri=10,Nv=100,Sv=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(Q.SELECT),l=p.useRef(null),d=p.useRef(""),u=p.useRef(!1),h=p.useRef(Q.SELECT);p.useEffect(()=>{const m=()=>{var S;const w=E.getState(),v=(S=w.projectCanvas.getActive())==null?void 0:S.coreState.selectedNodes,b=!!w.uiState.dragInfo,N=w.uiState.mode;if(b!==u.current&&(u.current=b,a(b)),N!==h.current&&(h.current=N??Q.SELECT,c(N??Q.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let j="";const k=[];for(const C of v)C.type===de.GROUP&&(j+=(j?",":"")+C.id,k.push(C));j!==d.current&&(d.current=j,o(k))};m();const x=setInterval(m,Nv);return()=>clearInterval(x)},[]);const f=n.length>=1&&!r,g=i===Q.DRAW_ARROW,y=Ce.useMemo(()=>n.map(m=>m.id),[n]);return p.useEffect(()=>{if(!f||y.length===0)return;const m=()=>{var B,F;let w=0,v=0,b=0;if(y.forEach(D=>{const L=document.querySelector(`[data-node-id="${D}"]`);if(!L)return;const A=L.getBoundingClientRect(),T=A.left+A.width/2,O=A.top;w+=T,v+=O,b++}),b===0)return;const N=w/b,j=v/b,k=((B=l.current)==null?void 0:B.offsetHeight)||40,S=((F=l.current)==null?void 0:F.offsetWidth)||100,C=window.innerWidth,R=window.innerHeight,I=20;let M=j-k-Ri,W=N-S/2;if(M<I){let D=0;y.forEach(L=>{const A=document.querySelector(`[data-node-id="${L}"]`);if(A){const T=A.getBoundingClientRect();D=Math.max(D,T.bottom)}}),M=D+Ri}M=Math.max(I,Math.min(M,R-k-I)),W=Math.max(I,Math.min(W,C-S-I)),s({top:M,left:W})};m();const x=setTimeout(m,100);return()=>{clearTimeout(x)}},[f,y]),!f||y.length===0||g?null:Ys.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:ke.popover},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),"data-test":"group-quick-panel-portal",children:t.jsx(bv,{groups:n})}),document.body)},Cv=Ce.memo(Sv),dr=({label:e,currentColor:s,onColorSelect:n})=>{const[o,r]=p.useState(s);p.useEffect(()=>{r(s)},[s]);const a=c=>{r(c),n(c)},i=s==="currentColor"?"hsl(var(--foreground))":s;return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"draw-color-picker-content",children:t.jsxs("div",{"data-test":"draw-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:e}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:zo.map(c=>t.jsx("button",{type:"button",title:c.name,onClick:()=>a(c.value),className:we("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",c.twClass,c.value===o?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",c.value==="#ffffff"&&"border-neutral-300",c.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:c.value.startsWith("hsl(")?{backgroundColor:c.value}:{},"aria-label":`Select color ${c.name}`,"data-test":`draw-color-${c.name.toLowerCase().replace(/\s+/g,"-")}`},c.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?Uo(i):i.startsWith("#")?i:"#000000",onChange:c=>a(c.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"draw-color-custom-input"})]})})},ks="currentColor";let Mi=ks;const Pi=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-color-swatch-icon",children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e==="currentColor"?"hsl(var(--foreground))":e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),jv=({drawings:e,className:s})=>{var w;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((w=i==null?void 0:i.style)==null?void 0:w.strokeColor)??ks),[d,u]=p.useState(Mi);p.useEffect(()=>{var v;l(i?((v=i.style)==null?void 0:v.strokeColor)??ks:ks)},[i]);const h=v=>{e.forEach(b=>{const N=b.data;if(!N)return;if(N.elements&&N.elements.length>0){const k=N.elements.map(S=>({...S,style:{...S.style,strokeColor:v}}));r(b.id,{data:{...N,elements:k}});return}const j={...N,drawType:(N==null?void 0:N.drawType)??"freehand",style:{...Ct,...N==null?void 0:N.style,strokeColor:v}};r(b.id,{data:j})})},f=()=>{h(d)},g=v=>{h(v),l(v),u(v),Mi=v,E.getState().setSegmentedButtonAction("draw-stroke-color","Apply last used color")},y=()=>{l(ks),h(ks)},m=[{label:"Apply last used color",icon:t.jsx(Pi,{color:d}),onClick:f,disabled:e.length===0},{label:"Set Stroke Color",icon:t.jsx(Pi,{color:c}),onClick:()=>o(!0),disabled:e.length===0},{label:"Reset Color",icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:y,disabled:e.length===0}],x={...m[0]};return t.jsxs(ot,{open:n,onOpenChange:o,children:[t.jsx(at,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-color-button",children:t.jsx(Ye,{mainAction:x,dropdownActions:m,variant:"outline",size:"compact",persistenceKey:"draw-stroke-color",className:s})})}),t.jsx(rt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:v=>v.preventDefault(),"data-test":"draw-stroke-color-popover",children:t.jsx(dr,{label:"Stroke Color",currentColor:c,onColorSelect:g})})]})},kv=[1,2,3,4,5,6,8,10];let Di=Ct.strokeWidth;const Av=({width:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-width-icon",children:t.jsx("span",{style:{width:"12px",height:`${Math.min(e,6)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})}),Iv=({drawings:e,className:s})=>{var x;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((x=i==null?void 0:i.style)==null?void 0:x.strokeWidth)??Ct.strokeWidth),[d,u]=p.useState(Di);p.useEffect(()=>{var w;l(i?((w=i.style)==null?void 0:w.strokeWidth)??Ct.strokeWidth:Ct.strokeWidth)},[i]);const h=w=>{e.forEach(v=>{const b=v.data;if(!b)return;if(b.elements&&b.elements.length>0){const j=b.elements.map(k=>({...k,style:{...k.style,strokeWidth:w}}));r(v.id,{data:{...b,elements:j}});return}const N={...b,drawType:(b==null?void 0:b.drawType)??"freehand",style:{...Ct,...b==null?void 0:b.style,strokeWidth:w}};r(v.id,{data:N})})},f=()=>{h(d)},g=w=>{h(w),l(w),u(w),Di=w,o(!1),E.getState().setSegmentedButtonAction("draw-stroke-width","Apply last used width")},y=[{label:"Apply last used width",icon:t.jsx(Av,{width:d}),onClick:f,disabled:e.length===0},{label:"Set Stroke Width",icon:t.jsx(Wo,{className:"h-2.5 w-2.5"}),onClick:()=>o(!0),disabled:e.length===0}],m={...y[0]};return t.jsxs(ot,{open:n,onOpenChange:o,children:[t.jsx(at,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-width-button",children:t.jsx(Ye,{mainAction:m,dropdownActions:y,variant:"outline",size:"compact",persistenceKey:"draw-stroke-width",className:s})})}),t.jsx(rt,{className:"w-auto p-3",sideOffset:5,onCloseAutoFocus:w=>w.preventDefault(),"data-test":"draw-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1",children:kv.map(w=>t.jsx("button",{type:"button",title:`${w}px`,onClick:()=>g(w),className:`w-8 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${c===w?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":`draw-stroke-width-${w}`,children:t.jsx("span",{style:{width:"16px",height:`${Math.min(w,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})},w))}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Current: ",c,"px"]})]})})]})},Tv=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}];let Oi=Ct.strokeStyle;const Li=({style:e,className:s})=>{const n=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-style-icon",children:t.jsx("svg",{width:"14",height:"6",viewBox:"0 0 14 6",children:t.jsx("line",{x1:"0",y1:"3",x2:"14",y2:"3",stroke:"currentColor",strokeWidth:"2",strokeDasharray:n,strokeLinecap:"round"})})})},Ev=({drawings:e,className:s})=>{var g;const n=E.getState().updateNode,o=e.length>0?e[0]:null,r=o==null?void 0:o.data,[a,i]=p.useState(((g=r==null?void 0:r.style)==null?void 0:g.strokeStyle)??Ct.strokeStyle),[c,l]=p.useState(Oi);p.useEffect(()=>{var y;i(r?((y=r.style)==null?void 0:y.strokeStyle)??Ct.strokeStyle:Ct.strokeStyle)},[r]);const d=y=>{e.forEach(m=>{const x=m.data;if(!x)return;if(x.elements&&x.elements.length>0){const v=x.elements.map(b=>({...b,style:{...b.style,strokeStyle:y}}));n(m.id,{data:{...x,elements:v}});return}const w={...x,drawType:(x==null?void 0:x.drawType)??"freehand",style:{...Ct,...x==null?void 0:x.style,strokeStyle:y}};n(m.id,{data:w})}),i(y),l(y),Oi=y},u=()=>{d(c)},h=[{label:"Apply last used style",icon:t.jsx(Li,{style:c}),onClick:u,disabled:e.length===0},...Tv.map(y=>({label:y.label,icon:t.jsx(Li,{style:y.value}),onClick:()=>{d(y.value),E.getState().setSegmentedButtonAction("draw-stroke-style",y.label)},disabled:e.length===0,selected:a===y.value}))],f={...h[0]};return t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-style-button",children:t.jsx(Ye,{mainAction:f,dropdownActions:h,variant:"outline",size:"compact",persistenceKey:"draw-stroke-style",className:s})})},As="transparent";let Wi=As;const $i=({color:e,className:s})=>{const n=e&&e!=="transparent"?e:void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"fill-color-swatch-icon",children:n?t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:n,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}}):t.jsx($o,{className:"h-2.5 w-2.5"})})},Rv=({drawings:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.filter(b=>{const N=b.data;return N?N.elements&&N.elements.length>0?N.elements.some(j=>j.type==="shape"):N.drawType==="shape":!1}),i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.style)==null?void 0:v.fillColor)??As),[u,h]=p.useState(Wi);p.useEffect(()=>{var b;d(c?((b=c.style)==null?void 0:b.fillColor)??As:As)},[c]);const f=b=>{const N=b===As?void 0:b;a.forEach(j=>{const k=j.data;if(!k)return;if(k.elements&&k.elements.length>0){const C=k.elements.map(R=>R.type==="shape"?{...R,style:{...R.style,fillColor:N}}:R);r(j.id,{data:{...k,elements:C}});return}const S={...k,drawType:(k==null?void 0:k.drawType)??"shape",style:{...Ct,...k==null?void 0:k.style,fillColor:N}};r(j.id,{data:S})})},g=()=>{f(u)},y=b=>{f(b),d(b),h(b),Wi=b,E.getState().setSegmentedButtonAction("draw-fill-color","Apply last used fill")},m=()=>{d(As),f(void 0)},x=[{label:"Apply last used fill",icon:t.jsx($i,{color:u}),onClick:g,disabled:a.length===0},{label:"Set Fill Color",icon:t.jsx($i,{color:l}),onClick:()=>o(!0),disabled:a.length===0},{label:"Remove Fill",icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:m,disabled:a.length===0}],w={...x[0]};return a.length===0?null:t.jsxs(ot,{open:n,onOpenChange:o,children:[t.jsx(at,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-fill-color-button",children:t.jsx(Ye,{mainAction:w,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"draw-fill-color",className:s})})}),t.jsx(rt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:b=>b.preventDefault(),"data-test":"draw-fill-color-popover",children:t.jsx(dr,{label:"Fill Color",currentColor:l,onColorSelect:y})})]})},Mv=({drawings:e,className:s})=>{const n=()=>{const r=E.getState().setSelectedNodes,a=E.getState().duplicateNodes;r(e),a()},o=e.length===0;return t.jsx(Xt,{delayDuration:300,children:t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-duplicate-tooltip-wrapper",children:t.jsx(ee,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-duplicate-button",children:t.jsx(Mt,{className:"h-3.5 w-3.5"})})})}),t.jsx($t,{children:t.jsxs("p",{children:["Duplicate ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},Pv=({drawings:e,className:s})=>{const n=()=>{const r=E.getState().deleteNodeById;e.forEach(a=>{r(a.id)})},o=e.length===0;return t.jsx(Xt,{delayDuration:300,children:t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-delete-tooltip-wrapper",children:t.jsx(ee,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-delete-button",children:t.jsx(pt,{className:"h-3.5 w-3.5"})})})}),t.jsx($t,{children:t.jsxs("p",{children:["Delete ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},Bt=[100,90,80,70,60,50,40,30,20,10],Yl=e=>(e==null?void 0:e._compressionLevel)??100,Dv=e=>{const s=Bt.indexOf(e);if(s===-1||s>=Bt.length-1){for(let n=0;n<Bt.length;n++)if(Bt[n]<e)return Bt[n];return Bt[Bt.length-1]}return Bt[s+1]},Ov=({drawings:e})=>{var r;const s=Yl((r=e[0])==null?void 0:r.data),n=s>Bt[Bt.length-1],o=()=>{for(const a of e){const i=a.data;if(!i)continue;const c=i._original??{...i,_original:void 0,_compressionLevel:void 0},l=Dv(s),d=Kc(c,l);E.getState().updateNode(a.id,{data:{...d,_original:c,_compressionLevel:l}})}};return t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-compress-button",children:t.jsx(xo,{className:"h-4 w-4"})})}),t.jsx($t,{children:t.jsx("p",{children:"Compress drawing (reduce quality)"})})]})},Lv=({drawings:e})=>{var r;const s=(r=e[0])==null?void 0:r.data,n=!!(s!=null&&s._original),o=()=>{for(const a of e){const i=a.data;if(!(i!=null&&i._original))continue;const{_original:c,_compressionLevel:l,...d}=i._original;E.getState().updateNode(a.id,{data:d})}};return t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-restore-button",children:t.jsx(vn,{className:"h-4 w-4"})})}),t.jsx($t,{children:t.jsx("p",{children:"Restore original quality"})})]})},Wv=({drawings:e})=>{var n;const s=Yl((n=e[0])==null?void 0:n.data);return t.jsxs("span",{className:Se("text-xs px-1 tabular-nums",s===100?"text-muted-foreground":"text-orange-500 font-medium"),"data-test":"draw-compression-level",title:"Current compression level (% of original quality)",children:[s,"%"]})},$v=e=>{if(!e)return 0;if(e._original)return JSON.stringify(e._original).length;const{_original:s,_compressionLevel:n,...o}=e;return JSON.stringify(o).length},Bv=e=>{if(!e)return 0;const{_original:s,...n}=e;return JSON.stringify(n).length},Bi=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`;let Hi=[],cn=[];const Hv=({drawings:e})=>{e.map(i=>i.id).join(",");const s=p.useSyncExternalStore(E.subscribe,()=>{var h;const i=(h=E.getState().projectCanvas.getActive())==null?void 0:h.coreState.nodes;if(!i)return cn;const c=e.map(f=>f.id),l=i.filter(f=>c.includes(f.id)),d=c.join(","),u=l.some((f,g)=>{const y=cn[g];return!y||y.id!==f.id||y.data!==f.data})||l.length!==cn.length;return(d!==Hi.join(",")||u)&&(Hi=c,cn=l),cn}),n=s.length>0?s:e,{currentSize:o,originalSize:r}=p.useMemo(()=>{let i=0,c=0;for(const l of n)l.data&&(i+=Bv(l.data),c+=$v(l.data));return{currentSize:i,originalSize:c}},[n]),a=o<r;return t.jsxs(Ml,{className:"gap-0.5 p-0.5",dataTest:"draw-quick-panel-container",dataAttributes:{"drawing-ids":e.map(i=>i.id).join(",")},children:[t.jsx(jv,{drawings:e}),t.jsx(Iv,{drawings:e}),t.jsx(Ev,{drawings:e}),t.jsx(Rv,{drawings:e}),t.jsx(yr,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(Mv,{drawings:e}),t.jsx(Pv,{drawings:e}),t.jsx(yr,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(Ov,{drawings:n}),t.jsx(Lv,{drawings:n}),t.jsx(Wv,{drawings:n}),t.jsxs("span",{className:Se("text-xs px-1.5 ml-1 tabular-nums",o>500*1024?"text-red-500 font-medium":"text-muted-foreground"),"data-test":"draw-size-indicator",title:`Current: ${o.toLocaleString()} bytes${a?` | Original: ${r.toLocaleString()} bytes`:""}`,children:[Bi(o),a&&t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",Bi(r),")"]})]})]})},Fv=100,_v=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(Q.SELECT),l=p.useRef(null),d=p.useRef(""),u=p.useRef(!1),h=p.useRef(Q.SELECT);p.useEffect(()=>{const m=()=>{var S;const w=E.getState(),v=(S=w.projectCanvas.getActive())==null?void 0:S.coreState.selectedNodes,b=!!w.uiState.dragInfo,N=w.uiState.mode;if(b!==u.current&&(u.current=b,a(b)),N!==h.current&&(h.current=N??Q.SELECT,c(N??Q.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let j="";const k=[];for(const C of v)C.type===de.DRAWING&&(j+=(j?",":"")+C.id,k.push(C));j!==d.current&&(d.current=j,o(k))};m();const x=setInterval(m,Fv);return()=>clearInterval(x)},[]);const f=n.length>=1&&!r,g=i===Q.DRAW_ARROW,y=Ce.useMemo(()=>n.map(m=>m.id),[n]);return p.useEffect(()=>{if(!f||y.length===0)return;const m=()=>{var F,D;let w=0,v=0,b=0;if(y.forEach(L=>{const A=document.querySelector(`[data-node-id="${L}"]`);if(!A)return;const T=A.getBoundingClientRect(),O=T.left+T.width/2,$=T.top;w+=O,v+=$,b++}),b===0)return;const N=w/b,j=v/b,k=((F=l.current)==null?void 0:F.offsetHeight)||40,S=((D=l.current)==null?void 0:D.offsetWidth)||100,C=window.innerWidth,R=window.innerHeight,I=20,M=se.nodeUI.quickPanelGap;let W=j-k-M,B=N-S/2;if(W<I){let L=0;y.forEach(A=>{const T=document.querySelector(`[data-node-id="${A}"]`);if(T){const O=T.getBoundingClientRect();L=Math.max(L,O.bottom)}}),W=L+M}W=Math.max(I,Math.min(W,R-k-I)),B=Math.max(I,Math.min(B,C-S-I)),s({top:W,left:B})};m();const x=setTimeout(m,100);return()=>{clearTimeout(x)}},[f,y]),!f||y.length===0||g?null:Ys.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:ke.popover},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),"data-test":"draw-quick-panel-portal",children:t.jsx(Hv,{drawings:n})}),document.body)},zv=Ce.memo(_v),Uv=e=>{const s=t.jsx(Kt,{className:"h-3 w-3"}),n=e.startNodeId?`Node ${e.startNodeId.substring(0,4)}`:`(${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)})`,o=e.endNodeId?`Node ${e.endNodeId.substring(0,4)}`:`(${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)})`,r=`${n} -> ${o}`,a=e.id.substring(0,6),i=`S: [${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)}]`,c=`E: [${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"arrow-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"arrow-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"arrow-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"arrow-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"arrow-display-text",children:r})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"arrow-display-id",children:a})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full flex justify-between pr-1","data-test":"arrow-display-coords",children:[t.jsx("span",{"data-test":"arrow-display-start-coords",children:i}),t.jsx("span",{"data-test":"arrow-display-end-coords",children:c})]})]})},Vv=(e,s)=>s.length!==1?-1:e.findIndex(n=>n.id===s[0].id),Gv=e=>{const{className:s,style:n}=e,o=E.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.arrows)??[],i=(r==null?void 0:r.coreState.selectedArrows)??[],c=o.arrow.setSelected,l=o.scrollToArrow,d=p.useCallback((f,g)=>{const y=f.length>0?f[0]:-1;if(y>=0&&y<a.length){const m=a[y];c([m]),l(m),console.log("Selected arrow from list:",m.id)}else c([])},[a,c]),u=Vv(a,i),h=u!==-1?[u]:[];return t.jsx("div",{"data-test":"canvas-arrow-infos-container",className:Se("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:f=>f.stopPropagation(),children:t.jsx(Fa,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-arrow-infos-header",children:"Arrows"}),itemList:a.map(Uv),onSelectionChange:d,selectedIndices:h,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0})})},Yv=()=>{const e=H(i=>i.uiState.temporaryArrow),s=H(i=>{var c;return((c=i.uiState)==null?void 0:c.useCurvedArrows)??!1}),{startPoint:n,endPoint:o}=e??{};if(!n||!o)return null;const r=s?"auto-start-reverse":"auto",a="temporary-arrowhead";return t.jsxs("g",{children:[t.jsx("defs",{children:t.jsx("marker",{id:a,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:r,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"grey"})})}),t.jsx(La,{startPoint:n,endPoint:o,useCurvedArrows:s,stroke:"grey",strokeWidth:1,strokeDasharray:"4 2",markerEndId:a})]})},Fi=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},Kv=()=>{const e=H(i=>i.uiState.temporaryDrawing??null);if(!e)return null;const{subMode:s,points:n,startPoint:o,endPoint:r,style:a}=e;if(s===be.FREEHAND&&n.length>0){const i=ze.smoothToSVGPath(n),c=Fi(a),l=a.opacity??1,d=l<1;return t.jsx("g",{"data-test":"temporary-drawing-freehand",children:t.jsx("path",{d:i,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:c,strokeOpacity:l,fill:"none",strokeLinecap:d?"butt":"round",strokeLinejoin:d?"bevel":"round"})})}if(o&&r){const c={[be.RECTANGLE]:"rectangle",[be.SQUARE]:"square",[be.CIRCLE]:"circle",[be.ELLIPSE]:"ellipse",[be.LINE]:"line",[be.ARROW]:"arrow",[be.FREEHAND]:"line"}[s],l=ze.generateShapeSVGPath({shapeType:c,startPoint:o,endPoint:r}),d=Fi(a),u=a.opacity??1;return t.jsx("g",{"data-test":`temporary-drawing-${c}`,children:t.jsx("path",{d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:d,strokeOpacity:u,fill:a.fillColor?`${a.fillColor}40`:"none",strokeLinecap:"round",strokeLinejoin:"round"})})}return null},Xv=30,qv=()=>{const[e,s]=p.useState(0),n=p.useRef(0),o=p.useRef(performance.now());return p.useEffect(()=>{let r=!0;function a(){n.current+=1;const i=performance.now();if(i-o.current>=1e3){const c=n.current;s(c),n.current=0,o.current=i}r&&requestAnimationFrame(a)}return requestAnimationFrame(a),()=>{r=!1}},[]),t.jsxs("div",{className:"text-xs pl-1",style:{color:e<Xv?"red":"inherit"},children:["FPS: ",e]})},ln=1e3,dn=500,Zv=({scale:e,offset:s})=>{const n=H(M=>M.uiState.mode),[o,r]=p.useState(null),[a,i]=p.useState(null),c=H(M=>{var W;return((W=M.projectCanvas.getActive())==null?void 0:W.coreState.nodes)??ys}),l=H(M=>M.setSelectedNodes),d=window.innerWidth,u=window.innerHeight,h=-s.x/e,f=-s.y/e,g=h+d/e,y=f+u/e,m=Math.floor(h/ln)*ln,x=Math.ceil(g/ln)*ln,w=Math.floor(f/dn)*dn,v=Math.ceil(y/dn)*dn,b=[];for(let M=m;M<=x;M+=ln)b.push(M);const N=[];for(let M=w;M<=v;M+=dn)N.push(M);const j=p.useCallback(M=>{const B=M.currentTarget.getBoundingClientRect(),F=M.clientX-B.left,D=M.clientY-B.top,L=(F-s.x)/e,A=(D-s.y)/e,T=F,O=B.width-F,$=D,_=B.height-D,G=50,X=T<G||O<G,J=$<G||_<G;r({canvasX:L,canvasY:A,showVertical:J,showHorizontal:X})},[e,s]),k=p.useCallback(()=>{r(null),i(null)},[]),S=p.useCallback(M=>{if(o&&(o.showVertical||o.showHorizontal)){M.stopPropagation(),M.preventDefault();const W=o.showVertical?"vertical":"horizontal";i({isDragging:!0,startX:o.canvasX,startY:o.canvasY,currentX:o.canvasX,currentY:o.canvasY,dragType:W})}},[o]),C=p.useCallback(M=>{if(!a||!a.isDragging)return;M.stopPropagation(),M.preventDefault();const W=Math.min(a.startX,a.currentX),B=Math.max(a.startX,a.currentX),F=Math.min(a.startY,a.currentY),D=Math.max(a.startY,a.currentY),L=c.filter(A=>{const T=A.width??200,O=A.height??100,$=A.x+T,_=A.y+O;return a.dragType==="vertical"?A.x<=B&&$>=W:A.y<=D&&_>=F});L.length>0&&l(L),i(null)},[a,c,l]),R=j,I=p.useCallback(M=>{if(R(M),a!=null&&a.isDragging){M.stopPropagation(),M.preventDefault();const B=M.currentTarget.getBoundingClientRect(),F=M.clientX-B.left,D=M.clientY-B.top,L=(F-s.x)/e,A=(D-s.y)/e;i({...a,currentX:L,currentY:A})}},[R,a,s,e]);return n!==Q.GRID?null:t.jsx("svg",{"data-grid-svg":"true","data-grid-active":o!=null&&o.showVertical||o!=null&&o.showHorizontal?"true":"false",className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{zIndex:o!=null&&o.showVertical||o!=null&&o.showHorizontal?999:0,pointerEvents:"auto",touchAction:"none",cursor:o?a!=null&&a.isDragging?"grabbing":"grab":"default"},onPointerMove:I,onPointerLeave:k,onPointerDown:S,onPointerUp:C,children:t.jsxs("g",{transform:`translate(${s.x}, ${s.y}) scale(${e})`,children:[b.map(M=>t.jsx("line",{x1:M,y1:f,x2:M,y2:y,stroke:M===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:M===0?2/e:1/e,style:{pointerEvents:"none"}},`v-${M}`)),N.map(M=>t.jsx("line",{x1:h,y1:M,x2:g,y2:M,stroke:M===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:M===0?2/e:1/e,style:{pointerEvents:"none"}},`h-${M}`)),o&&o.showVertical&&t.jsx("line",{x1:o.canvasX,y1:f,x2:o.canvasX,y2:y,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-vertical"),o&&o.showHorizontal&&t.jsx("line",{x1:h,y1:o.canvasY,x2:g,y2:o.canvasY,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-horizontal"),a&&a.isDragging&&(()=>{const M=Math.min(a.startX,a.currentX),W=Math.max(a.startX,a.currentX),B=Math.min(a.startY,a.currentY),F=Math.max(a.startY,a.currentY);return a.dragType==="vertical"?t.jsx("rect",{x:M,y:f,width:W-M,height:y-f,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range"):t.jsx("rect",{x:h,y:B,width:g-h,height:F-B,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range")})(),b.map(M=>t.jsx("text",{x:M,y:f+20/e,fill:"rgba(100, 116, 139, 0.6)",fontSize:pe.FONT_SIZE_XXS/e,textAnchor:"middle",style:{pointerEvents:"none"},children:M},`label-v-${M}`)),N.map(M=>t.jsx("text",{x:h+20/e,y:M,fill:"rgba(100, 116, 139, 0.6)",fontSize:pe.FONT_SIZE_XXS/e,textAnchor:"start",dominantBaseline:"middle",style:{pointerEvents:"none"},children:M},`label-h-${M}`)),o&&(o.showVertical||o.showHorizontal)&&(()=>{let M=c,W="",B=o.canvasX,F=o.canvasY-30/e;if(a!=null&&a.isDragging){const D=Math.min(a.startX,a.currentX),L=Math.max(a.startX,a.currentX),A=Math.min(a.startY,a.currentY),T=Math.max(a.startY,a.currentY);M=c.filter(O=>{const $=O.width??200,_=O.height??100,G=O.x+$,X=O.y+_;return a.dragType==="vertical"?O.x<=L&&G>=D:O.y<=T&&X>=A}),W=`Release to select ${M.length} node${M.length!==1?"s":""}`,B=(D+L)/2,F=a.dragType==="vertical"?f+30/e:(A+T)/2}else o.showVertical&&(M=M.filter(D=>{const L=D.width??200,A=D.x+L;return D.x<=o.canvasX&&A>=o.canvasX})),o.showHorizontal&&(M=M.filter(D=>{const L=D.height??100,A=D.y+L;return D.y<=o.canvasY&&A>=o.canvasY})),W=`Click/drag to select ${M.length} node${M.length!==1?"s":""}`;return t.jsxs("g",{children:[t.jsx("rect",{x:B-70/e,y:F-12/e,width:140/e,height:24/e,fill:"rgba(0, 0, 0, 0.9)",rx:4/e,style:{pointerEvents:"none"}}),t.jsx("text",{x:B,y:F,fill:"white",fontSize:pe.FONT_SIZE_XXS/e,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:W})]},"tooltip")})()]})})},Kl={projectScope:{projects:!0,workspaces:!0,canvases:!0},nodeFields:{content:!1,title:!1,id:!1,type:!1,tags:!1}},Xl=e=>Object.values(e.nodeFields).some(s=>s),Jv=e=>{const s=!e.projectScope.projects||!e.projectScope.workspaces||!e.projectScope.canvases,n=Xl(e);return s||n},Qv=({searchQuery:e,onSearchQueryChange:s,searchFilters:n,onSearchFiltersChange:o})=>{const[r,a]=p.useState(!1);return t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"projects-search-section",children:[t.jsx(ms,{className:"search-icon absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"projects-search-icon"}),t.jsx(Ae,{type:"text",placeholder:"Search...",value:e,onChange:i=>s(i.target.value),className:we("search-input h-7 text-sm pl-8",e?"pr-14":"pr-8"),"data-test":"projects-search-input"}),e&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>s(""),className:"clear-button absolute right-8 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"projects-search-clear-button",children:t.jsx(We,{className:"h-3 w-3"})}),Jv(n)&&t.jsx("div",{className:we("filter-indicator absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",e?"right-14":"right-9"),"data-test":"projects-search-filter-indicator"}),t.jsxs(ot,{open:r,onOpenChange:a,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0","aria-label":r?"Collapse advanced search":"Expand advanced search","data-test":"projects-search-expand-button",children:t.jsx(Ho,{className:"h-3 w-3"})})}),t.jsxs(rt,{align:"start",side:"bottom",className:"advanced-search-panel w-72",style:{zIndex:ke.draggablePopoverDropdown},"data-test":"projects-advanced-search-panel",children:[t.jsxs("div",{className:"panel-header flex items-center justify-between pb-2 border-b","data-test":"projects-panel-header",children:[t.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:()=>o(Kl),className:"h-6 text-xs px-2","data-test":"projects-clear-filters-button",children:"Clear All"})]}),t.jsxs("div",{className:"project-scope-section space-y-2 mt-3","data-test":"projects-scope-section",children:[t.jsx(je,{className:"text-sm font-medium",children:"Project"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in names of:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"scope-projects",checked:n.projectScope.projects,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,projects:!!i}}),"data-test":"projects-scope-projects-checkbox"}),t.jsx("label",{htmlFor:"scope-projects",className:"text-sm cursor-pointer",children:"Projects"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"scope-workspaces",checked:n.projectScope.workspaces,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,workspaces:!!i}}),"data-test":"projects-scope-workspaces-checkbox"}),t.jsx("label",{htmlFor:"scope-workspaces",className:"text-sm cursor-pointer",children:"Workspaces"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"scope-canvases",checked:n.projectScope.canvases,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,canvases:!!i}}),"data-test":"projects-scope-canvases-checkbox"}),t.jsx("label",{htmlFor:"scope-canvases",className:"text-sm cursor-pointer",children:"Canvases"})]})]})]}),t.jsxs("div",{className:"node-fields-section space-y-2 mt-4","data-test":"projects-node-fields-section",children:[t.jsx(je,{className:"text-sm font-medium",children:"Node Content"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"node-content",checked:n.nodeFields.content,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,content:!!i}}),"data-test":"projects-node-content-checkbox"}),t.jsx("label",{htmlFor:"node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"node-title",checked:n.nodeFields.title,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,title:!!i}}),"data-test":"projects-node-title-checkbox"}),t.jsx("label",{htmlFor:"node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"node-id",checked:n.nodeFields.id,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,id:!!i}}),"data-test":"projects-node-id-checkbox"}),t.jsx("label",{htmlFor:"node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"node-type",checked:n.nodeFields.type,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,type:!!i}}),"data-test":"projects-node-type-checkbox"}),t.jsx("label",{htmlFor:"node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(De,{id:"node-tags",checked:n.nodeFields.tags,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,tags:!!i}}),"data-test":"projects-node-tags-checkbox"}),t.jsx("label",{htmlFor:"node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]}),t.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 mt-4 border-t","data-test":"projects-panel-footer",children:[t.jsx(ee,{onClick:()=>a(!1),className:"flex-1",size:"sm","data-test":"projects-apply-search-button",children:"Apply"}),t.jsx(ee,{onClick:()=>a(!1),variant:"outline",size:"sm","data-test":"projects-cancel-button",children:"Cancel"})]})]})]})]})},eb=()=>{const e=H(a=>{var i,c;return(c=(i=a.preferences)==null?void 0:i.projectsManagerSearch)==null?void 0:c.filters}),[s,n]=p.useState(""),[o,r]=p.useState(e??Kl);return p.useEffect(()=>{E.setState(a=>({...a,preferences:{...a.preferences,projectsManagerSearch:{filters:o}}}))},[o]),{searchQuery:s,setSearchQuery:n,searchFilters:o,setSearchFilters:r}},tb=180,sb=[],ql=e=>{const{onCanvasSelected:s,excludeCanvasId:n,selectionModeTitle:o,isOpen:r,onClose:a,popoverPosition:i}=e,c=!!s,l=H(Z=>{var q;return((q=Z.state)==null?void 0:q.projects)??{}}),d=H(Z=>{var q;return((q=Z.state)==null?void 0:q.activeProjectId)??""}),u=H(Z=>Z.project),h=H(Z=>Z.workspace),f=H(Z=>Z.projectCanvas),g=H(Z=>Z.exportSingleCanvas),y=H(Z=>Z.exportSingleWorkspace),m=H(Z=>Z.exportSingleProject),{searchQuery:x,setSearchQuery:w,searchFilters:v,setSearchFilters:b}=eb(),N=H(Z=>{var q;return((q=Z.preferences)==null?void 0:q.recentCanvases)??sb}),[j,k]=p.useState("projects"),S=p.useMemo(()=>d?l[d]??null:null,[l,d]),C=p.useMemo(()=>S!=null&&S.activeWorkspaceId?S.workspaces[S.activeWorkspaceId]??null:null,[S]),[R,I]=p.useState(""),[M,W]=p.useState(null),[B,F]=p.useState(null),D=p.useRef(null),L=lr("projects-manager"),A=r!==void 0,T=A?r:L.isOpen,O=A?Z=>{!Z&&a&&a()}:Z=>{Z?L.open():L.close()},$=A?i:B,_=p.useMemo(()=>{const Z=x.toLowerCase().trim(),q=Z.length>0,Y=Xl(v),te=ce=>ce?ce.toLowerCase().includes(Z):!1,ae=ce=>{if(!q||!Y)return!1;const{nodeFields:ie}=v,fe=typeof ce.content=="string"?ce.content:"";return!!(ie.content&&te(fe)||ie.title&&te(ce.title)||ie.id&&te(ce.id)||ie.type&&te(ce.type)||ie.tags&&Array.isArray(ce.tags)&&ce.tags.some(he=>{const ue=typeof he=="string"?he:(he==null?void 0:he.value)||(he==null?void 0:he.label)||"";return te(ue)}))};return Object.values(l).sort((ce,ie)=>(ce.sortOrder??0)-(ie.sortOrder??0)).map(ce=>{if(q&&ce.hideFromSearch)return null;const ie=q&&v.projectScope.projects&&te(ce.name),fe=Object.values(ce.workspaces).sort((he,ue)=>(he.sortOrder??0)-(ue.sortOrder??0)).map(he=>{if(q&&he.hideFromSearch)return null;const ue=q&&v.projectScope.workspaces&&te(he.name),xe=Object.values(he.canvases).sort((ye,Ie)=>(ye.sortOrder??0)-(Ie.sortOrder??0)).map(ye=>{var Pe;if(n&&ye.id===n||q&&ye.hideFromSearch)return null;const Ie=q&&v.projectScope.canvases&&te(ye.name);let Ne=[];q&&Y&&((Pe=ye.coreState)!=null&&Pe.nodes)&&(Ne=ye.coreState.nodes.filter(ae).map(Ee=>{const Fe=typeof Ee.content=="string"?Ee.content:"",yt=Ee.title||Fe.substring(0,40)||Ee.id,Je=yt.length>40?yt.substring(0,40)+"...":yt;return{id:`node-${Ee.id}`,label:Je,data:{type:"node",id:Ee.id,name:Je,isActive:!1,projectId:ce.id,workspaceId:he.id,canvasId:ye.id,nodeType:Ee.type}}}));const Te=Ne.length>0;return!q||Ie||Te?{id:ye.id,label:ye.name,data:{type:"canvas",id:ye.id,name:ye.name,isActive:ye.id===he.activeCanvasId,projectId:ce.id,workspaceId:he.id},children:Ne.length>0?Ne:void 0}:null}).filter(Boolean),me=xe.length>0;return!q||ue||me?{id:he.id,label:he.name,data:{type:"workspace",id:he.id,name:he.name,isActive:he.id===ce.activeWorkspaceId,projectId:ce.id},children:xe}:null}).filter(Boolean),ge=fe.length>0;return!q||ie||ge?{id:ce.id,label:ce.name,data:{type:"project",id:ce.id,name:ce.name,isActive:ce.id===d},children:fe}:null}).filter(Boolean)},[l,d,x,v,n]),G=p.useMemo(()=>{const Z=new Set;if(d&&Z.add(d),S!=null&&S.activeWorkspaceId&&Z.add(S.activeWorkspaceId),x.trim()){const q=Y=>{for(const te of Y)Z.add(te.id),te.children&&q(te.children)};q(_)}return Z},[d,S,x,_]),X=Z=>{const q=R.trim()||`New ${Z}`;Z==="project"?u.create(q):Z==="workspace"?h.create(q):Z==="canvas"&&f.create(q),I(""),W(null)},J=Z=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5","data-test":`projects-add-${Z}-input-container`,children:[t.jsx(Ae,{"data-test":`projects-new-${Z}-input`,type:"text",placeholder:`New ${Z} name...`,value:R,onChange:q=>I(q.target.value),onKeyDown:q=>q.key==="Enter"&&X(Z),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(ee,{"data-test":`projects-save-${Z}-button`,variant:"ghost",size:"sm",onClick:()=>X(Z),children:t.jsx(qt,{className:"h-3 w-3"})}),t.jsx(ee,{"data-test":`projects-cancel-${Z}-button`,variant:"ghost",size:"sm",onClick:()=>{W(null),I("")},children:t.jsx(We,{className:"h-3 w-3"})})]}),P=Z=>{var Y;const q=(Y=Z.data)==null?void 0:Y.type;if(q==="canvas"){if(c&&s){const{id:te,workspaceId:ae,projectId:ce,name:ie}=Z.data||{};te&&ae&&ce&&s({canvasId:te,workspaceId:ae,projectId:ce,canvasName:ie||""});return}f.switch(Z.id)}else if(q==="node"){const{canvasId:te,id:ae}=Z.data||{};te&&ae&&(f.switch(te),setTimeout(()=>{const ce=E.getState().getNodeById(ae);ce&&(E.getState().setSelectedNodes([ce]),E.getState().scrollToNode(ae,300))},100))}},z=Z=>{if(c&&s){if(n&&Z.canvasId===n)return;s({canvasId:Z.canvasId,workspaceId:Z.workspaceId,projectId:Z.projectId,canvasName:Z.canvasName});return}f.switch(Z.canvasId),k("projects")},U=(Z,q)=>{Z.stopPropagation(),f.removeRecentCanvas(q)},K=(Z,q)=>{const Y=ae=>{var ce;for(const ie of ae){if(ie.id===Z)return(ce=ie.data)==null?void 0:ce.type;if(ie.children){const fe=Y(ie.children);if(fe)return fe}}return null},te=Y(_);te==="project"?u.updateMetadata(Z,{name:q}):te==="workspace"?h.updateMetadata(Z,{name:q}):te==="canvas"&&f.updateMetadata(Z,{name:q})},re=Z=>{const q=te=>{var ae;for(const ce of te){if(ce.id===Z)return(ae=ce.data)==null?void 0:ae.type;if(ce.children){const ie=q(ce.children);if(ie)return ie}}return null},Y=q(_);Y==="project"?u.delete(Z):Y==="workspace"?h.delete(Z):Y==="canvas"&&f.delete(Z)},ne=Z=>{var Y;return`Are you sure you want to delete this ${((Y=Z.data)==null?void 0:Y.type)??"item"}: "${Z.label}"?`},V=Z=>{const q=E.getState().setState;q(Ad(Y=>{if(!Y)return;const te=Date.now();Z.forEach((ae,ce)=>{var he;const ie=Y.projects[ae.id];if(!ie)return;ie.sortOrder=ce,ie.lastModified=te;const fe=new Set,ge=new Map;(he=ae.children)==null||he.forEach((ue,xe)=>{var ye;let me=ie.workspaces[ue.id];if(me)me.sortOrder=xe,me.lastModified=te,fe.add(ue.id);else{let Ie=null,Ne=null;for(const[Te,Pe]of Object.entries(Y.projects))if(Te!==ae.id&&Pe.workspaces[ue.id]){Ie=Pe.workspaces[ue.id],Ne=Te;break}if(Ie&&Ne){if(delete Y.projects[Ne].workspaces[ue.id],Y.projects[Ne].lastModified=te,Y.projects[Ne].activeWorkspaceId===ue.id){const Te=Object.keys(Y.projects[Ne].workspaces);Y.projects[Ne].activeWorkspaceId=Te[0]||""}ie.workspaces[ue.id]=Ie,Ie.sortOrder=xe,Ie.lastModified=te,fe.add(ue.id),me=Ie}}if(me){const Ie=new Set;ge.set(ue.id,Ie),(ye=ue.children)==null||ye.forEach((Ne,Te)=>{const Pe=me.canvases[Ne.id];if(Pe)Pe.sortOrder=Te,Pe.lastModified=te,Ie.add(Ne.id);else{let Ee=null,Fe=null;for(const[yt,Je]of Object.entries(ie.workspaces))if(Je.canvases[Ne.id]){Ee=Je.canvases[Ne.id],Fe=yt;break}if(Ee)Fe&&Fe!==ue.id&&(delete ie.workspaces[Fe].canvases[Ne.id],ie.workspaces[Fe].lastModified=te);else for(const[yt,Je]of Object.entries(Y.projects))if(yt!==ae.id){for(const[vt,nt]of Object.entries(Je.workspaces))if(nt.canvases[Ne.id]){Ee=nt.canvases[Ne.id],Fe=vt,delete nt.canvases[Ne.id],nt.lastModified=te,Je.lastModified=te;break}if(Ee)break}Ee&&(me.canvases[Ne.id]=Ee,Ee.sortOrder=Te,Ee.lastModified=te,Ie.add(Ne.id))}})}})})}))},oe=Z=>{var Y,te,ae,ce,ie,fe,ge;const q=(Y=Z.data)==null?void 0:Y.type;if(q==="project"){const he=(te=Z.data)==null?void 0:te.id,ue=he?l[he]:null,xe=(ue==null?void 0:ue.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:xe?"Include in search":"Hide from search",icon:xe?t.jsx(os,{className:"h-4 w-4 mr-2"}):t.jsx(Rs,{className:"h-4 w-4 mr-2"}),onClick:me=>{const{id:ye}=me.data||{};ye&&u.updateMetadata(ye,{hideFromSearch:!xe})}},{id:"export",label:"Export",icon:t.jsx(to,{className:"h-4 w-4 mr-2"}),onClick:me=>{const{id:ye}=me.data||{};ye&&m({projectId:ye})}}]}if(q==="workspace"){const he=(ae=Z.data)==null?void 0:ae.id,ue=(ce=Z.data)==null?void 0:ce.projectId,xe=ue?l[ue]:null,me=xe&&he?xe.workspaces[he]:null,ye=(me==null?void 0:me.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:ye?"Include in search":"Hide from search",icon:ye?t.jsx(os,{className:"h-4 w-4 mr-2"}):t.jsx(Rs,{className:"h-4 w-4 mr-2"}),onClick:Ie=>{const{id:Ne}=Ie.data||{};Ne&&h.updateMetadata(Ne,{hideFromSearch:!ye})}},{id:"export",label:"Export",icon:t.jsx(to,{className:"h-4 w-4 mr-2"}),onClick:Ie=>{const{projectId:Ne,id:Te}=Ie.data||{};Ne&&Te&&y({projectId:Ne,workspaceId:Te})}}]}if(q==="canvas"){const he=(ie=Z.data)==null?void 0:ie.id,ue=(fe=Z.data)==null?void 0:fe.projectId,xe=(ge=Z.data)==null?void 0:ge.workspaceId,me=ue?l[ue]:null,ye=me&&xe?me.workspaces[xe]:null,Ie=ye&&he?ye.canvases[he]:null,Ne=(Ie==null?void 0:Ie.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:Ne?"Include in search":"Hide from search",icon:Ne?t.jsx(os,{className:"h-4 w-4 mr-2"}):t.jsx(Rs,{className:"h-4 w-4 mr-2"}),onClick:Te=>{const{id:Pe}=Te.data||{};Pe&&f.updateMetadata(Pe,{hideFromSearch:!Ne})}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Mt,{className:"h-4 w-4 mr-2"}),onClick:Te=>{const{projectId:Pe,workspaceId:Ee,id:Fe}=Te.data||{};Pe&&Ee&&Fe&&f.duplicate(Fe,Pe,Ee)}},{id:"export",label:"Export",icon:t.jsx(to,{className:"h-4 w-4 mr-2"}),onClick:Te=>{const{projectId:Pe,workspaceId:Ee,id:Fe}=Te.data||{};Pe&&Ee&&Fe&&g({projectId:Pe,workspaceId:Ee,canvasId:Fe})}}]}return null},le=()=>{if(T){O(!1),W(null),I("");return}if(D.current){const Z=D.current.getBoundingClientRect(),q=320,Y=400,te=Z.left+Z.width/2,ae=Z.top+Z.height/2;F({x:te-q/2+tb,y:ae-Y/2})}O(!0)};return t.jsxs(t.Fragment,{children:[!A&&t.jsx(as,{ref:D,variant:"secondary",size:"sm",tooltip:"Manage projects",onClick:le,className:"canvas-projects-manager-button","data-test":"canvas-projects-manager-button",children:t.jsx(th,{className:"h-4 w-4"})}),t.jsx(Be,{isVisible:T,onClose:()=>{O(!1),W(null),I(""),k("projects")},title:c?o??"Select Canvas":j==="recent"?"Recent Canvases":"Projects",resizable:!0,initialSize:{width:320,height:400},triggerPosition:$??void 0,shouldCloseManually:!0,headerActions:j==="recent"?t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>k("projects"),title:"Back to Projects","data-test":"projects-back-button",children:t.jsx(Fs,{className:"h-3.5 w-3.5"})}):t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>k("recent"),title:"Recent Canvases","data-test":"projects-recent-button",children:t.jsx(ns,{className:"h-3.5 w-3.5"})}),children:t.jsx("div",{className:"manager-content flex flex-col space-y-2 p-2 h-full overflow-hidden","data-test":"projects-manager-content",children:j==="projects"?t.jsxs(t.Fragment,{children:[t.jsx(Qv,{searchQuery:x,onSearchQueryChange:w,searchFilters:v,onSearchFiltersChange:b}),t.jsx($s,{className:"tree-scroll-area flex-1 min-h-0","data-test":"projects-tree-scroll-area",children:t.jsx("div",{className:"tree-container space-y-1 pr-2","data-test":"projects-tree-container",children:t.jsx(_s,{data:_,onItemClick:P,onUpdate:c?void 0:K,onDelete:c?void 0:re,onReorder:c?void 0:V,defaultExpandedIds:G,selectedId:(C==null?void 0:C.activeCanvasId)??null,deleteConfirmMessage:c?void 0:ne,enableEdit:!c,enableDelete:!c,enableDrag:!c,moreOptionsItems:c?void 0:oe,dropdownZIndex:ke.draggablePopoverDropdown})})}),!c&&(M?J(M):t.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t","data-test":"projects-add-buttons-row",children:[t.jsxs(ee,{"data-test":"projects-add-project-button",variant:"outline",size:"sm",className:"add-project-button flex-1",onClick:()=>W("project"),title:"Add Project",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Pr"]}),S&&t.jsxs(ee,{"data-test":"projects-add-workspace-button",variant:"outline",size:"sm",className:"add-workspace-button flex-1",onClick:()=>W("workspace"),title:"Add Workspace",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Wo"]}),C&&t.jsxs(ee,{"data-test":"projects-add-canvas-button",variant:"outline",size:"sm",className:"add-canvas-button flex-1",onClick:()=>W("canvas"),title:"Add Canvas",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Ca"]})]}))]}):t.jsx($s,{className:"recent-canvases-scroll flex-1 min-h-0","data-test":"projects-recent-scroll-area",children:t.jsx("div",{className:"recent-canvases-list space-y-1 pr-2","data-test":"recent-canvases-list",children:(()=>{const Z=n?N.filter(q=>q.canvasId!==n):N;return Z.length===0?t.jsx("div",{className:"empty-state text-center text-muted-foreground text-sm py-8","data-test":"recent-canvases-empty",children:"No recently visited canvases"}):Z.map(q=>t.jsxs("div",{className:"recent-canvas-item group flex items-center w-full text-left px-2 py-1.5 rounded hover:bg-accent transition-colors cursor-pointer",onClick:()=>z(q),"data-test":`recent-canvas-item-${q.canvasId}`,children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"canvas-name text-sm font-medium truncate","data-test":"recent-canvas-name",children:q.canvasName}),t.jsxs("div",{className:"canvas-path text-xs text-muted-foreground truncate","data-test":"recent-canvas-path",children:[q.projectName," / ",q.workspaceName]})]}),!c&&t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",onClick:Y=>U(Y,q.canvasId),title:"Remove from recent","data-test":`recent-canvas-delete-${q.canvasId}`,children:t.jsx(We,{className:"h-3.5 w-3.5"})})]},`${q.projectId}-${q.workspaceId}-${q.canvasId}`))})()})})})})]})};function Zl({node:e,onItemClick:s,onUpdate:n,onDelete:o,level:r=0,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f}){var D;const[g,y]=p.useState((a==null?void 0:a.has(e.id))??!1),[m,x]=p.useState(!1),[w,v]=p.useState(e.label),b=e.children&&e.children.length>0,N=i===e.id,j=p.useRef(null),k=p.useRef(e.label);p.useEffect(()=>{e.label!==k.current&&(k.current=e.label,m||v(e.label))},[e.label,m]),p.useEffect(()=>{N&&j.current&&j.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[N]);const S=L=>{L.stopPropagation(),m||(b&&y(!g),s==null||s(e))},C=()=>{w.trim()&&w!==e.label&&(n==null||n(e.id,w.trim())),x(!1)},R=()=>{v(e.label),x(!1)},I=L=>{L.stopPropagation();const A=(d==null?void 0:d(e))??`Are you sure you want to delete "${e.label}"?`;window.confirm(A)&&(o==null||o(e.id))},M={paddingLeft:`${r*1.5}rem`},W=b?t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:g?t.jsx(Et,{className:"h-4 w-4"}):t.jsx(Ks,{className:"h-4 w-4"})}):t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),B=t.jsxs("div",{ref:j,className:we("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",N&&"bg-primary/10 border border-primary"),style:M,onClick:S,children:[W,e.icon&&t.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:e.icon}),m?t.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[t.jsx(Ae,{type:"text",value:w,onChange:L=>v(L.target.value),onKeyDown:L=>{L.key==="Enter"&&C(),L.key==="Escape"&&R()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:L=>L.stopPropagation()}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:L=>{L.stopPropagation(),C()},className:"h-6 w-6 p-0",children:t.jsx(qt,{className:"h-3 w-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:L=>{L.stopPropagation(),R()},className:"h-6 w-6 p-0",children:t.jsx(We,{className:"h-3 w-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"tree-item-label flex-grow truncate",title:e.label,children:e.label}),t.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[c&&n&&t.jsx(ee,{variant:"ghost",size:"sm",onClick:L=>{L.stopPropagation(),x(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:t.jsx(zc,{className:"h-3 w-3"})}),(()=>{const L=h==null?void 0:h(e);return L&&L.length>0?t.jsxs(uo,{children:[t.jsx(ho,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"sm",onClick:A=>A.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:t.jsx(Fc,{className:"h-3 w-3"})})}),t.jsxs(po,{align:"end",style:f?{zIndex:f}:void 0,"data-test":"tree-item-more-options-content",children:[L.map(A=>A.subItems?t.jsxs(Id,{children:[t.jsxs(Td,{className:A.className,"data-test":`tree-item-menu-${A.id}`,children:[A.icon,A.label]}),t.jsx(Ed,{children:A.subItems.map(T=>t.jsxs(It,{onClick:O=>{O.stopPropagation(),T.onClick(e)},className:T.className,"data-test":`tree-item-menu-${A.id}-${T.id}`,children:[T.icon,T.label]},T.id))})]},A.id):t.jsxs(It,{onClick:T=>{var O;T.stopPropagation(),(O=A.onClick)==null||O.call(A,e)},className:A.className,"data-test":`tree-item-menu-${A.id}`,children:[A.icon,A.label]},A.id)),l&&o&&t.jsxs(It,{onClick:A=>{A.stopPropagation(),I(A)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[t.jsx(pt,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):l&&o?t.jsx(ee,{variant:"ghost",size:"sm",onClick:I,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:t.jsx(pt,{className:"h-3 w-3"})}):null})()]})]})]}),F=u?u(e,N,!!b,B):B;return b?t.jsxs(ls,{open:g,onOpenChange:y,children:[t.jsx(ds,{asChild:!0,children:t.jsx("div",{children:F})}),t.jsx(us,{children:t.jsx("div",{className:"tree-item-children",children:(D=e.children)==null?void 0:D.map(L=>t.jsx(Zl,{node:L,onItemClick:s,onUpdate:n,onDelete:o,level:r+1,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f},L.id))})})]}):t.jsx(t.Fragment,{children:F})}function nb({data:e,onItemClick:s,onUpdate:n,onDelete:o,className:r,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f}){return t.jsx("div",{className:we("crud-tree-root",r),children:e.map(g=>t.jsx(Zl,{node:g,onItemClick:s,onUpdate:n,onDelete:o,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:f},g.id))})}const ob=180,ab=()=>{const e=it(V=>V.definitions),s=it(V=>V.instances),n=it(V=>V.selectedDefinitionId),o=it(V=>V.createDefinition),r=it(V=>V.updateDefinition),a=it(V=>V.deleteDefinition);it(V=>V.duplicateDefinition);const i=it(V=>V.createInstance),c=it(V=>V.deleteInstance),l=it(V=>V.selectDefinition),d=H(V=>{var oe;return((oe=V.projectCanvas.getActive())==null?void 0:oe.coreState.nodes)??ys}),u=H(V=>{var oe;return((oe=V.state)==null?void 0:oe.projects)??{}}),[h,f]=p.useState(""),[g,y]=p.useState(null),[m,x]=p.useState(null),[w,v]=p.useState(new Set),b=p.useRef(null),N=p.useRef(null),{isOpen:j,open:k,close:S}=lr("workflow-manager"),C=it(V=>V.facade),R=p.useMemo(()=>new Oa(C),[C]),I=p.useMemo(()=>{const V=u["workflow-templates-project"],oe=[];V&&Object.values(V.workspaces).forEach(ae=>{Object.values(ae.canvases).forEach(ce=>{ce.coreState.nodes.filter(fe=>{var ge;return((ge=fe.data)==null?void 0:ge.nodeType)==="workflowOrchestration"}).forEach(fe=>{var me,ye;const ge=fe.data,he=((ye=(me=ge==null?void 0:ge.parameters)==null?void 0:me.rows)==null?void 0:ye.length)||0,ue=typeof fe.title=="string"?fe.title:"",xe=typeof fe.content=="string"?fe.content:"";oe.push({id:`preset-${fe.id}`,label:ue||xe||`Preset (${he} steps)`,data:{type:"preset-workflow",id:fe.id,nodeId:fe.id,rowCount:he,canvasId:ce.id,canvasName:ce.name}})})})});const le=new Set(oe.map(ae=>{var ce;return(ce=ae.data)==null?void 0:ce.nodeId})),q=d.filter(ae=>{var ce;return((ce=ae.data)==null?void 0:ce.nodeType)==="workflowOrchestration"&&!le.has(ae.id)}).map(ae=>{var he,ue;const ce=ae.data,ie=((ue=(he=ce==null?void 0:ce.parameters)==null?void 0:he.rows)==null?void 0:ue.length)||0,fe=typeof ae.title=="string"?ae.title:"",ge=typeof ae.content=="string"?ae.content:"";return{id:ae.id,label:fe||ge||`Workflow (${ie} steps)`,data:{type:"canvas-workflow",id:ae.id,nodeId:ae.id,rowCount:ie}}}),Y=e.map(ae=>{const ce=s.filter(ie=>ie.definitionId===ae.id);return{id:ae.id,label:ae.name,data:{type:"definition",id:ae.id,name:ae.name,isActive:ae.id===n,description:ae.description,tags:ae.tags},children:ce.map(ie=>({id:ie.id,label:ie.name,data:{type:"instance",id:ie.id,name:ie.name,status:ie.status,definitionId:ie.definitionId}}))}}),te=[];return oe.length>0&&te.push({id:"section-presets",label:`📚 Workflow Presets (${oe.length})`,data:{type:"section",section:"presets"},children:oe}),q.length>0&&te.push({id:"section-canvas",label:`🎨 Current Canvas (${q.length})`,data:{type:"section",section:"canvas"},children:q}),Y.length>0&&te.push({id:"section-saved",label:`💾 Saved Workflows (${Y.length})`,data:{type:"section",section:"saved"},children:Y}),te},[d,e,s,n,u]),M=p.useMemo(()=>{const V=new Set;return V.add("section-presets"),V.add("section-canvas"),V.add("section-saved"),n&&V.add(n),V},[n]),W=V=>{const oe=h.trim()||`New ${V}`;V==="definition"?o({name:oe}):V==="instance"&&n&&i(n,oe),f(""),y(null)},B=V=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[t.jsx(Ae,{"data-test":`workflow-new-${V}-input`,type:"text",placeholder:`New ${V} name...`,value:h,onChange:oe=>f(oe.target.value),onKeyDown:oe=>oe.key==="Enter"&&W(V),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(ee,{"data-test":`workflow-save-${V}-button`,variant:"ghost",size:"sm",onClick:()=>W(V),children:t.jsx(qt,{className:"h-3 w-3"})}),t.jsx(ee,{"data-test":`workflow-cancel-${V}-button`,variant:"ghost",size:"sm",onClick:()=>{y(null),f("")},children:t.jsx(We,{className:"h-3 w-3"})})]}),F=V=>{var le;((le=V.data)==null?void 0:le.type)==="definition"&&l(V.id)},D=(V,oe)=>{const le=q=>{var Y;for(const te of q){if(te.id===V)return(Y=te.data)==null?void 0:Y.type;if(te.children){const ae=le(te.children);if(ae)return ae}}return null},Z=le(I);Z==="section"||Z==="preset-workflow"||(Z==="canvas-workflow"?E.getState().updateNode(V,{title:oe}):Z==="definition"?r(V,{name:oe}):Z==="instance"&&console.warn("Instance rename not yet implemented"))},L=V=>{const oe=Z=>{var q;for(const Y of Z){if(Y.id===V)return(q=Y.data)==null?void 0:q.type;if(Y.children){const te=oe(Y.children);if(te)return te}}return null},le=oe(I);le==="section"||le==="preset-workflow"||le==="canvas-workflow"||(le==="definition"?a(V):le==="instance"&&c(V))},A=V=>{var le;return`Are you sure you want to delete this ${((le=V.data)==null?void 0:le.type)??"item"}: "${V.label}"?`},T=()=>{if(j){S(),y(null),f("");return}if(b.current){const V=b.current.getBoundingClientRect(),oe=320,le=400,Z=V.left+V.width/2,q=V.top+V.height/2;x({x:Z-oe/2+ob,y:q-le/2})}k()},O=()=>{if(w.size===0){ve.error("No workflows selected");return}try{const V=Array.from(w);R.downloadWorkflows(V),ve.success(`Exported ${w.size} workflow(s)`,{description:"Workflows downloaded as JSON file"})}catch(V){ve.error("Export failed",{description:V instanceof Error?V.message:"Unknown error"})}},$=()=>{try{const V=R.exportAllWorkflows(),oe=new Blob([V],{type:"application/json"}),le=URL.createObjectURL(oe),Z=document.createElement("a");Z.href=le,Z.download=`all-workflows-${Date.now()}.json`,Z.click(),URL.revokeObjectURL(le),ve.success("Exported all workflows",{description:`${e.length} workflow(s) downloaded`})}catch(V){ve.error("Export failed",{description:V instanceof Error?V.message:"Unknown error"})}},_=()=>{var V;(V=N.current)==null||V.click()},G=V=>{var Z;const oe=(Z=V.target.files)==null?void 0:Z[0];if(!oe)return;const le=new FileReader;le.onload=q=>{var Y;try{const te=(Y=q.target)==null?void 0:Y.result,ae=R.importWorkflows(te);ve.success(`Imported ${ae.length} workflow(s)`,{description:"Workflows added to manager"})}catch(te){ve.error("Import failed",{description:te instanceof Error?te.message:"Invalid JSON"})}},le.readAsText(oe),V.target.value=""},X=V=>{const oe=new Set(w);oe.has(V)?oe.delete(V):oe.add(V),v(oe)},J=()=>{w.size===e.length?v(new Set):v(new Set(e.map(V=>V.id)))},P=()=>{if(w.size!==0&&window.confirm(`Are you sure you want to delete ${w.size} workflow(s)?`))try{R.bulkDeleteDefinitions(Array.from(w)),v(new Set),ve.success(`Deleted ${w.size} workflow(s)`)}catch(V){ve.error("Bulk delete failed",{description:V instanceof Error?V.message:"Unknown error"})}},z=()=>{if(w.size!==0)try{const V=R.bulkDuplicateDefinitions(Array.from(w));v(new Set),ve.success(`Duplicated ${V.length} workflow(s)`,{description:'New workflows created with " (copy)" suffix'})}catch(V){ve.error("Bulk duplicate failed",{description:V instanceof Error?V.message:"Unknown error"})}},U=()=>{if(w.size===0)return;const V=window.prompt("Enter tags (comma-separated):");if(!V)return;const oe=V.split(",").map(le=>le.trim()).filter(Boolean);if(oe.length===0){ve.error("No valid tags provided");return}try{R.bulkAddTags(Array.from(w),oe),ve.success(`Added tags to ${w.size} workflow(s)`,{description:`Tags: ${oe.join(", ")}`})}catch(le){ve.error("Bulk add tags failed",{description:le instanceof Error?le.message:"Unknown error"})}},K=()=>{if(w.size===0)return;const V=window.prompt("Enter tags to remove (comma-separated):");if(!V)return;const oe=V.split(",").map(le=>le.trim()).filter(Boolean);if(oe.length===0){ve.error("No valid tags provided");return}try{R.bulkRemoveTags(Array.from(w),oe),ve.success(`Removed tags from ${w.size} workflow(s)`,{description:`Tags: ${oe.join(", ")}`})}catch(le){ve.error("Bulk remove tags failed",{description:le instanceof Error?le.message:"Unknown error"})}},re=()=>{if(w.size!==0)try{const V=R.getBulkStats(Array.from(w));ve.info("Bulk Statistics",{description:`Workflows: ${V.count} | Nodes: ${V.totalNodes} | Connections: ${V.totalConnections} | Tags: ${V.tags.length}`})}catch(V){ve.error("Failed to get statistics",{description:V instanceof Error?V.message:"Unknown error"})}},ne=w.size===e.length&&e.length>0;return w.size>0&&w.size<e.length,t.jsxs(t.Fragment,{children:[t.jsx(as,{ref:b,variant:"secondary",size:"sm",tooltip:"Manage workflows",onClick:T,className:"workflow-manager-button","data-test":"workflow-manager-button",children:t.jsx(fs,{className:"h-4 w-4"})}),t.jsx(Be,{isVisible:j,onClose:()=>{S(),y(null),f("")},title:"Workflow Manager",resizable:!0,initialSize:{width:420,height:450},triggerPosition:m??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col space-y-2 p-2 flex-1 h-full overflow-scroll","data-test":"manager-content ",children:[t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b","data-test":"toolbar-row",children:[t.jsxs(uo,{children:[t.jsx(ho,{asChild:!0,children:t.jsxs(ee,{"data-test":"workflow-export-dropdown",variant:"outline",size:"sm",className:"flex-1",children:[t.jsx(to,{className:"h-3 w-3 mr-1"}),"Export",t.jsx(Et,{className:"h-3 w-3 ml-1"})]})}),t.jsxs(po,{style:{zIndex:ke.skipLink},children:[t.jsxs(It,{"data-test":"workflow-export-selected",onClick:O,children:["Export Selected (",w.size,")"]}),t.jsxs(It,{"data-test":"workflow-export-all",onClick:$,children:["Export All (",e.length,")"]})]})]}),t.jsxs(ee,{"data-test":"workflow-import-button",variant:"outline",size:"sm",className:"flex-1",onClick:_,title:"Import workflows from JSON",children:[t.jsx(Tn,{className:"h-3 w-3 mr-1"}),"Import"]}),t.jsx("input",{"data-test":"workflow-import-file-input",ref:N,type:"file",accept:".json",onChange:G,className:"hidden"})]}),w.size>0&&t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b bg-primary/5 p-1.5 rounded","data-test":"bulk-toolbar",children:[t.jsxs("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:[w.size," selected"]}),t.jsxs(uo,{children:[t.jsx(ho,{asChild:!0,children:t.jsxs(ee,{"data-test":"workflow-bulk-actions-dropdown",variant:"ghost",size:"sm",className:"flex-1",children:[t.jsx(Et,{className:"h-3 w-3 mr-1"}),"Bulk Actions"]})}),t.jsxs(po,{style:{zIndex:ke.skipLink},children:[t.jsx(Rd,{children:"Bulk Operations"}),t.jsx(Ko,{}),t.jsxs(It,{"data-test":"workflow-bulk-duplicate",onClick:z,children:[t.jsx(Mt,{className:"h-3 w-3 mr-2"}),"Duplicate"]}),t.jsxs(It,{"data-test":"workflow-bulk-delete",onClick:P,children:[t.jsx(pt,{className:"h-3 w-3 mr-2"}),"Delete"]}),t.jsx(Ko,{}),t.jsxs(It,{"data-test":"workflow-bulk-add-tags",onClick:U,children:[t.jsx(In,{className:"h-3 w-3 mr-2"}),"Add Tags"]}),t.jsxs(It,{"data-test":"workflow-bulk-remove-tags",onClick:K,children:[t.jsx(In,{className:"h-3 w-3 mr-2"}),"Remove Tags"]}),t.jsx(Ko,{}),t.jsxs(It,{"data-test":"workflow-bulk-stats",onClick:re,children:[t.jsx(sh,{className:"h-3 w-3 mr-2"}),"Show Statistics"]})]})]})]}),e.length>0&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1","data-test":"select-all-row",children:[t.jsx(De,{"data-test":"workflow-select-all-checkbox",checked:ne,onCheckedChange:J,className:"h-4 w-4","aria-label":"Select all workflows"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:ne?"Deselect All":"Select All"})]}),t.jsx($s,{className:"tree-scroll-area flex-1",children:t.jsx("div",{className:"space-y-1 pr-2","data-test":"tree-container",children:t.jsx(nb,{data:I,onItemClick:F,onUpdate:D,onDelete:L,defaultExpandedIds:M,selectedId:n,deleteConfirmMessage:A,dropdownZIndex:ke.skipLink,moreOptionsItems:V=>{var oe,le,Z;if(((oe=V.data)==null?void 0:oe.type)==="canvas-workflow")return[{id:"save",label:"Save Workflow",icon:t.jsx(qt,{className:"h-4 w-4 mr-2"}),onClick:q=>{try{const Y=R.saveWorkflow({nodeId:q.data.nodeId});ve.success("Workflow saved",{description:`"${Y.name}" saved as version ${Y.version}`})}catch(Y){ve.error("Failed to save workflow",{description:Y instanceof Error?Y.message:"Unknown error"})}}}];if(((le=V.data)==null?void 0:le.type)==="preset-workflow"){const q=async(Y,te)=>{var ae,ce,ie,fe,ge,he;try{const ue=u["workflow-templates-project"];if(!ue)throw new Error("Workflow Templates project not found");let xe=null,me=[];if(Object.values(ue.workspaces).forEach(vt=>{Object.values(vt.canvases).forEach(nt=>{const _t=nt.coreState.nodes.find(kt=>kt.id===Y.data.nodeId);_t&&(xe=JSON.parse(JSON.stringify(_t)),me=nt.coreState.arrows||[])})}),!xe)throw new Error("Preset workflow not found");(ce=(ae=xe.data)==null?void 0:ae.parameters)!=null&&ce.rows&&xe.data.parameters.rows.forEach(vt=>{vt.children&&vt.children.forEach(nt=>{var _t;nt.stepType==="nodeUpdate"&&((_t=nt.config)!=null&&_t.simpleFieldUpdates)&&nt.config.simpleFieldUpdates.forEach(kt=>{const Wn=kt.field;kt.field=te,kt.template&&(kt.template=kt.template.replace(new RegExp(`loop\\.current\\.${Wn}`,"g"),`loop.current.${te}`))})})});const ye=E.getState(),Ie=((ie=ye.projectCanvas.getActive())==null?void 0:ie.coreState.nodes)||[],Ne=((fe=ye.projectCanvas.getActive())==null?void 0:fe.coreState.selectedNodes)||[],Te=((ge=ye.projectCanvas.getActive())==null?void 0:ge.coreState.arrows)||[],Pe=Ne.length>0?Ne:Ie,Ee=new zs,Fe=[...Pe,xe],yt=[...Te,...me];Ee.loadWorkflow(Fe,yt);const Je=await Ee.executeWorkflow(xe.id);if(Je.success){if(Je.nodeUpdates&&Je.nodeUpdates.length>0){const nt=Je.nodeUpdates.map(({nodeId:_t,updates:kt})=>({id:_t,...kt}));ye.updateNodes(nt)}const vt=Ne.length>0?"selected":"all";ve.success("Workflow applied",{description:`Applied "${xe.title||"workflow"}" to ${te} of ${((he=Je.nodeUpdates)==null?void 0:he.length)||0} ${vt} nodes`})}else ve.error("Workflow execution failed",{description:Je.errors.map(vt=>vt.message).join(", ")||"Unknown error"})}catch(ue){ve.error("Failed to apply workflow",{description:ue instanceof Error?ue.message:"Unknown error"})}};return[{id:"apply",label:"Apply Workflow",icon:t.jsx(Ze,{className:"h-4 w-4 mr-2"}),subItems:Md.map(Y=>({id:Y,label:Pd[Y],onClick:async te=>q(te,Y)}))},{id:"copy",label:"Copy to Canvas",icon:t.jsx(Mt,{className:"h-4 w-4 mr-2"}),onClick:Y=>{try{const te=u["workflow-templates-project"];if(!te)throw new Error("Workflow Templates project not found");let ae=null;if(Object.values(te.workspaces).forEach(fe=>{Object.values(fe.canvases).forEach(ge=>{const he=ge.coreState.nodes.find(ue=>ue.id===Y.data.nodeId);he&&(ae=he)})}),!ae)throw new Error("Preset workflow not found");const ce=E.getState(),ie={...ae,id:`copied-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,x:150,y:150};ce.addNode(ie),ve.success("Preset copied",{description:"Workflow preset copied to current canvas"})}catch(te){ve.error("Failed to copy preset",{description:te instanceof Error?te.message:"Unknown error"})}}}]}return((Z=V.data)==null?void 0:Z.type)==="definition"?[{id:"apply",label:"Apply Workflow",icon:t.jsx(Ze,{className:"h-4 w-4 mr-2"}),onClick:async q=>{var Y,te,ae,ce,ie;try{const fe=e.find(Te=>Te.id===q.id);if(!fe)throw new Error("Workflow definition not found");const ge=E.getState(),he=((Y=ge.projectCanvas.getActive())==null?void 0:Y.coreState.nodes)||[],ue=((te=ge.projectCanvas.getActive())==null?void 0:te.coreState.selectedNodes)||[],xe=ue.length>0?ue:he;if(xe.length===0){ve.error("No nodes to apply workflow to");return}const me=new zs,ye=((ae=fe.nodes)==null?void 0:ae.map((Te,Pe)=>{var Ee,Fe;return{id:Te.id,label:((Ee=Te.parameters)==null?void 0:Ee.label)||`Step ${Pe+1}`,order:((Fe=Te.parameters)==null?void 0:Fe.order)||Pe+1,stepType:Te.type,config:Te.parameters||{}}}))||[],Ie={id:`temp-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:fe.name,content:"",x:0,y:0,width:400,height:300,data:{nodeType:"workflowOrchestration",parameters:{rows:ye}}};me.loadWorkflow([...xe,Ie],[]);const Ne=await me.executeWorkflow(Ie.id);if(Ne.success){if(Ne.nodeUpdates&&Ne.nodeUpdates.length>0)for(const{nodeId:Te,updates:Pe}of Ne.nodeUpdates)ge.updateNode(Te,Pe);ve.success("Workflow applied",{description:`Applied "${fe.name}" to ${((ce=Ne.nodeUpdates)==null?void 0:ce.length)||0} nodes`})}else ve.error("Workflow execution failed",{description:((ie=Ne.errors)==null?void 0:ie.map(Te=>Te.message).join(", "))||"Unknown error"})}catch(fe){ve.error("Failed to apply workflow",{description:fe instanceof Error?fe.message:"Unknown error"})}}},{id:"load",label:"Load to Canvas",icon:t.jsx(nh,{className:"h-4 w-4 mr-2"}),onClick:q=>{try{R.loadWorkflow({definitionId:q.id,position:{x:100,y:100}}),ve.success("Workflow loaded",{description:"Loaded workflow to canvas at position (100, 100)"})}catch(Y){ve.error("Failed to load workflow",{description:Y instanceof Error?Y.message:"Unknown error"})}}}]:null},renderNode:(V,oe,le,Z)=>{var q,Y;return((q=V.data)==null?void 0:q.type)==="section"?t.jsx("div",{className:"flex items-center gap-2 w-full",children:t.jsx("div",{className:"flex-1 font-semibold",children:Z})}):((Y=V.data)==null?void 0:Y.type)==="definition"?t.jsxs("div",{className:"flex items-center gap-2 w-full",children:[t.jsx(De,{"data-test":"workflow-definition-checkbox",checked:w.has(V.id),onCheckedChange:()=>X(V.id),className:"h-4 w-4 flex-shrink-0",onClick:te=>te.stopPropagation()}),t.jsx("div",{className:"flex-1",children:Z})]}):Z}})})}),g?B(g):t.jsxs("div",{className:"flex items-center gap-1 pt-2 border-t","data-test":"add-buttons-row",children:[t.jsxs(ee,{"data-test":"workflow-add-definition-button",variant:"outline",size:"sm",className:"add-definition-button flex-1",onClick:()=>y("definition"),title:"Add Workflow Definition",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Workflow"]}),n&&t.jsxs(ee,{"data-test":"workflow-add-instance-button",variant:"outline",size:"sm",className:"add-instance-button flex-1",onClick:()=>y("instance"),title:"Add Workflow Instance",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Instance"]})]})]})})]})},Go=e=>{const{className:s,style:n,children:o,position:r="left"}=e;return t.jsx("div",{className:Se("p-2 bg-background border shadow flex flex-col items-center space-y-2 pointer-events-auto rounded",s),style:{...n},onMouseDown:a=>a.stopPropagation(),onPointerDown:a=>a.stopPropagation(),"data-test":`canvas-vertical-toolbar-${r}`,"data-prevent-canvas-click":!0,children:o})},rb=({extension:e})=>{const s=H(i=>{var c,l;return((l=(c=i.extensions)==null?void 0:c.settings)==null?void 0:l[e.id])??e.defaultSettings}),n=i=>{var l,d;(d=(l=E.getState().ext)==null?void 0:l.setSettings)==null||d.call(l,e.id,i)},o=i=>typeof i=="boolean"?i:typeof i=="function"?i(s):!1,r=async i=>{try{await i(s)}catch(c){console.error(`Error executing extension action for ${e.id}:`,c)}},a=t.jsxs("div",{className:"flex flex-col h-full","data-test":`extension-popover-content-${e.id}`,children:[t.jsx("div",{className:"flex-1 overflow-y-auto border-b border-border p-3","data-test":`extension-settings-container-${e.id}`,children:Ce.createElement(e.settingsComponent,{settings:s,onSettingsChange:n})}),Object.entries(e.actions).length>0&&t.jsx("div",{className:"flex flex-col gap-2 p-3","data-test":`extension-actions-container-${e.id}`,children:Object.entries(e.actions).map(([i,c])=>{const l=o(c.disabled),d=c.icon;return t.jsxs("button",{onClick:()=>r(c.execute),disabled:l,className:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow-xs hover:bg-primary/90 h-8 px-3 py-1.5",title:c.label,"data-test":`extension-action-button-${e.id}-${i}`,children:[d&&t.jsx(d,{className:"h-4 w-4"}),t.jsx("span",{children:c.label})]},i)})})]});return t.jsx(Zs,{popoverId:`extension-${e.id}`,icon:e.icon,tooltip:e.description||e.name,popoverTitle:e.name,popoverContent:a,leftOffset:120,dataTest:`extension-button-${e.id}`})},ib=({settings:e,onSettingsChange:s})=>{p.useEffect(()=>{Wa("1_settings_load",e)},[e]);const n=p.useCallback((o,r)=>{s({...e,[o]:r})},[e,s]);return t.jsxs("div",{className:"flex flex-col gap-4 p-2","data-test":"journal-settings",children:[t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-project-field",children:[t.jsx(je,{htmlFor:"journal-project",className:"text-xs text-muted-foreground",children:"Project Name"}),t.jsx(Ae,{id:"journal-project",value:e.projectName,onChange:o=>n("projectName",o.target.value),placeholder:"Journal",className:"h-8 text-sm","data-test":"journal-settings-project-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-workspace-field",children:[t.jsx(je,{htmlFor:"journal-workspace",className:"text-xs text-muted-foreground",children:"Workspace Name"}),t.jsx(Ae,{id:"journal-workspace",value:e.workspaceName,onChange:o=>n("workspaceName",o.target.value),placeholder:ur(),className:"h-8 text-sm","data-test":"journal-settings-workspace-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-canvas-field",children:[t.jsx(je,{htmlFor:"journal-canvas",className:"text-xs text-muted-foreground",children:"Canvas Name"}),t.jsx(Ae,{id:"journal-canvas",value:e.canvasName,onChange:o=>n("canvasName",o.target.value),placeholder:hr(),className:"h-8 text-sm","data-test":"journal-settings-canvas-input"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 py-1","data-test":"journal-settings-autocreate-field",children:[t.jsx(je,{htmlFor:"journal-autocreate",className:"text-xs text-muted-foreground",children:"Create if missing"}),t.jsx(go,{id:"journal-autocreate",checked:e.autoCreateIfMissing,onCheckedChange:o=>n("autoCreateIfMissing",o),"data-test":"journal-settings-autocreate-switch"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-template-field",children:[t.jsx(je,{htmlFor:"journal-template",className:"text-xs text-muted-foreground",children:"Note Template (optional)"}),t.jsx(Qa,{id:"journal-template",value:e.noteTemplate??"",onChange:o=>n("noteTemplate",o.target.value),placeholder:"Enter default note content...",className:"min-h-[60px] resize-none text-sm","data-test":"journal-settings-template-input"}),t.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Text to include after the timestamp header"})]})]})};function ur(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0");return`${s}-${n}`}function hr(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${o}`}const cb={projectName:"Journal",workspaceName:ur(),canvasName:hr(),autoCreateIfMissing:!0,noteTemplate:""};function Wa(e,s){var a;const o=((a=E.getState().state)==null?void 0:a.projects)??{};Object.keys(o).find(i=>o[i].name===s.projectName)}function lb(){const e=new Date,s={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0};return e.toLocaleString(void 0,s)}function db(e){var h,f,g,y;const s=E.getState(),n=((h=s.state)==null?void 0:h.projects)??{},o=e.workspaceName||ur(),r=e.canvasName||hr();let a=Object.keys(n).find(m=>n[m].name===e.projectName),i=!1;if(!a&&e.autoCreateIfMissing){if(a=s.project.create(e.projectName),!a)return null;i=!0}if(!a)return null;const c=(f=E.getState().state)==null?void 0:f.projects[a];if(!c)return null;let l=Object.keys(c.workspaces).find(m=>c.workspaces[m].name===o);if(!l&&i&&e.autoCreateIfMissing){const m=Object.keys(c.workspaces).find(x=>c.workspaces[x].name==="Default Workspace");m&&(s.workspace.updateMetadata(m,{name:o}),l=m)}if(!l&&e.autoCreateIfMissing&&(s.project.switch(a),l=s.workspace.create(o)??void 0,!l)||!l)return null;const d=(y=(g=E.getState().state)==null?void 0:g.projects[a])==null?void 0:y.workspaces[l];if(!d)return null;let u=Object.keys(d.canvases).find(m=>d.canvases[m].name===r);if(!u&&i&&e.autoCreateIfMissing){const m=Object.keys(d.canvases).find(x=>d.canvases[x].name==="Default Canvas");m&&(s.projectCanvas.updateMetadata(m,{name:r}),u=m)}return!u&&e.autoCreateIfMissing&&(s.project.switch(a),s.workspace.switch(l),u=s.projectCanvas.create(r)??void 0,!u)?null:u??null}function ub(e){Wa("2_create_note_before",e);const s=E.getState(),n=db(e);if(!n){console.error("[JournalExtension] Could not find or create target canvas");return}s.projectCanvas.switch(n);const r=`## ${lb()}`,a=e.noteTemplate?`${r}

${e.noteTemplate}`:r,i=`journal-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,c={id:i,type:de.TEXT,x:100,y:100,width:300,height:150,content:"",isSelected:!0,isEditing:!0};s.addNode(c,a,{dontOverlap:!0}),s.setNodeToFocusId(i),Wa("2_create_note_after",e)}const hb={id:"journal",name:"Journal",icon:Lo,description:"Create timestamped notes in a dedicated canvas",settingsComponent:ib,defaultSettings:cb,version:"1.0.0",actions:{createNote:{label:"Create Note",execute:ub}}},un=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const u=n?l:l.toLowerCase();let h=0,f=u.indexOf(a,h);for(;f!==-1;){const g=Math.max(0,f-40),y=Math.min(l.length,f+a.length+40);let m=l.substring(g,y);g>0&&(m="..."+m),y<l.length&&(m=m+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:m,startIndex:f,field:o}),h=f+1,f=u.indexOf(a,h)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let f=e.substring(u,h);u>0&&(f="..."+f),h<e.length&&(f=f+"..."),i.push({context:f,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},pb=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...un(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...un(e.title,s,n,"title")),o.id&&e.id&&r.push(...un(e.id,s,n,"id")),o.type&&e.type&&r.push(...un(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...un(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},gb=(e,s,n=new Set)=>{if(!s.query.trim())return[];if(!Object.values(s.nodeFields).some(a=>a))return[];const r=[];for(const a of e){if(n.has(a.id))continue;const i=pb(a,s.query,s.caseSensitive,s.nodeFields);i&&r.push(i)}return r},fb=e=>e.reduce((s,n)=>s+n.matches.length,0),mb=(e,s,n)=>{const o=n?s:s.toLowerCase(),a=(n?e:e.toLowerCase()).indexOf(o);return a===-1?null:{before:e.substring(0,a),matched:e.substring(a,a+s.length),after:e.substring(a+s.length)}},xb=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(""),[r,a]=p.useState(!1),[i,c]=p.useState(Rx),[l,d]=p.useState(new Set),[u,h]=p.useState(!1),f=p.useMemo(()=>({query:n,caseSensitive:r,nodeFields:i}),[n,r,i]),g=p.useMemo(()=>gb(e,f,l),[e,f,l]),y=p.useMemo(()=>fb(g),[g]),m=p.useCallback(N=>{d(j=>new Set(j).add(N))},[]),x=p.useCallback(()=>{d(new Set)},[]),w=p.useCallback(()=>{if(g.length>0){const N=g.map(j=>j.node);s(N)}},[g,s]),v=p.useCallback(N=>{const j=N.node;s([j]),E.getState().scrollToNode(j.id)},[s]),b=p.useCallback((N,j)=>{const k=N.node;s([k]);const S=pe.LINE_HEIGHT_FIND,C=j?(j-1)*S:0;Ln(k,{highlightYOffset:C})},[s]);return{searchConfig:f,nodesWithMatches:g,totalMatchCount:y,excludedNodeIds:l,showSettings:u,setQuery:o,setCaseSensitive:a,setNodeFields:c,setShowSettings:h,removeNodeFromResults:m,clearExcludedNodes:x,handleSelectAllMatches:w,handleNodeClick:v,handleMatchClick:b}},qn=20,_i=40,zi=200,Ui=100;function Vi(e){if(e.length===0)return{x:0,y:0,width:zi,height:Ui};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e){const i=a.width??zi,c=a.height??Ui;s=Math.min(s,a.x),n=Math.min(n,a.y),o=Math.max(o,a.x+i),r=Math.max(r,a.y+c)}return{x:s-qn,y:n-qn-_i,width:o-s+qn*2,height:r-n+qn*2+_i}}const wb=({nodes:e})=>{const[s,n]=p.useState(null),[o,r]=p.useState([]),[a,i]=p.useState("horizontal"),[c,l]=p.useState(null),d=p.useMemo(()=>Ox(e),[e]),u=p.useMemo(()=>Hx(e,d),[e,d]),h=p.useMemo(()=>({mode:s,selectedTagIds:o,sliceArrangement:a}),[s,o,a]),f=p.useCallback(x=>{r(w=>w.includes(x)?w.filter(v=>v!==x):[...w,x])},[]),g=p.useCallback(x=>{const w=E.getState(),v=jl(e,x);if(v.length<2)return;c&&w.viewLayer.delete(c);const b=`(Unsaved) Group: ${x}`,N=w.viewLayer.create(b,{tagTitles:[x],arrangementStyle:"group"});if(!N)return;l(N);const j=Vi(v),k={id:Re(10),name:x,x:j.x,y:j.y,width:j.width,height:j.height,childNodeIds:v.map(S=>S.id)};w.viewLayer.addGroupNode(N,k),n("group"),r([x])},[e,c]),y=p.useCallback(()=>{if(o.length===0)return;const x=E.getState(),w=Bx(e,o,a);if(w.updates.length===0)return;e.map(S=>({id:S.id.slice(0,6),content:typeof S.content=="string"?S.content.slice(0,20):S.type,x:S.x,y:S.y,w:S.width,h:S.height,type:S.type,groupId:S.groupId})),c&&x.viewLayer.delete(c);const v=`(Unsaved) Slice: ${o.join(", ")}`,b=x.viewLayer.create(v,{tagTitles:o,arrangementStyle:"slice",sliceArrangement:a});if(!b)return;l(b),x.viewLayer.updateNodePositions(w.updates.map(S=>({id:S.id,x:S.x,y:S.y})));const N=[];w.lanes.forEach(S=>{if(S.nodeIds.length<2)return;const R=e.filter(W=>S.nodeIds.includes(W.id)).map(W=>{const B=w.updates.find(F=>F.id===W.id);return B?{...W,x:B.x,y:B.y}:W}),I=Vi(R),M={id:Re(10),name:S.tagTitle,x:I.x,y:I.y,width:I.width,height:I.height,childNodeIds:S.nodeIds};x.viewLayer.addGroupNode(b,M),N.push({tagTitle:S.tagTitle,nodeIds:S.nodeIds})});const k=E.getState().viewLayer.getNodesWithEffectivePositions();k.map(S=>({id:S.id.slice(0,6),content:typeof S.content=="string"?S.content.slice(0,20):S.type,x:S.x,y:S.y,w:S.width,h:S.height,type:S.type,groupId:S.groupId})),k.filter(S=>S.type===de.GROUP).map(S=>{var C;return{id:S.id.slice(0,6),content:S.content,x:S.x,y:S.y,w:S.width,h:S.height,childNodeIds:(C=S.data)==null?void 0:C.childNodeIds}}),n("slice")},[e,o,a,c]),m=p.useCallback(()=>{const x=E.getState();c&&(x.viewLayer.delete(c),l(null)),x.viewLayer.setActive(null),n(null),r([])},[c]);return{availableTags:d,nodesCountPerTag:u,config:h,canReset:s!==null,setMode:n,setSelectedTagIds:r,toggleTagSelection:f,setSliceArrangement:i,handleGroup:g,handleSlice:y,handleReset:m}},yb=({nodesWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemoveNode:a})=>t.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto","data-test":"search-results-list",children:e.map(i=>t.jsx(vb,{nodeWithMatches:i,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a},i.nodeId))}),vb=({nodeWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a})=>{const{node:i,matches:c,nodeId:l}=e;return t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":`search-result-${l}`,children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>a(l),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":`search-result-remove-${l}`,children:t.jsx(We,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none",children:[t.jsx(bb,{nodeWithMatches:e,onClick:()=>o(e)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":`search-result-matches-${l}`,children:c.map((d,u)=>t.jsx(Nb,{match:d,query:s,caseSensitive:n,onClick:()=>r(e,d.lineNumber),dataTest:`search-match-${l}-${u}`},u))})]})]})})},bb=({nodeWithMatches:e,onClick:s})=>{const{node:n,matches:o}=e,r=Vo(n.type),a=n.id.substring(0,6),i=typeof n.content=="string"?n.content:"",c=n.title?`${n.title.substring(0,30)}${n.title.length>30?"...":""}`:i?`${i.substring(0,30)}${i.length>30?"...":""}`:"(No Content)",l=n.title&&i?`${i.substring(0,50)}${i.length>50?"...":""}`:null;return t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:s,"data-test":`search-result-header-${n.id}`,children:t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[r&&t.jsx("span",{className:"flex-shrink-0",children:r}),t.jsx("span",{className:"truncate",children:c}),n.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(qe,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[o.length," ",o.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:a})]}),l&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:l})]})})},Nb=({match:e,query:s,caseSensitive:n,onClick:o,dataTest:r})=>{const a=mb(e.context,s,n);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",onClick:o,"data-test":r,children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:a?t.jsxs(t.Fragment,{children:[a.before,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:a.matched}),a.after]}):e.context})]})},Sb=({searchConfig:e,nodesWithMatches:s,totalMatchCount:n,showSettings:o,onQueryChange:r,onCaseSensitiveChange:a,onNodeFieldsChange:i,onShowSettingsChange:c,onNodeClick:l,onMatchClick:d,onRemoveNode:u,onSelectAllMatches:h})=>{const{query:f,caseSensitive:g,nodeFields:y}=e,m=g||y.title||y.id||y.type||y.tags||!y.content,x=(w,v)=>{i({...y,[w]:v})};return t.jsxs("div",{className:"space-y-3","data-test":"filter-search-section",children:[t.jsxs("div",{className:"relative flex items-center gap-1","data-test":"filter-search-input-container",children:[t.jsx(ms,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"filter-search-icon"}),t.jsx(Ae,{type:"text",placeholder:"Search nodes...",value:f,onChange:w=>r(w.target.value),onKeyDown:w=>{w.key==="Enter"&&f.trim()&&(w.preventDefault(),h())},className:we("h-8 text-sm pl-8",f?"pr-16":"pr-10"),autoFocus:!0,"data-test":"filter-search-input"}),f&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>r(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"filter-search-clear-button",children:t.jsx(We,{className:"h-3 w-3"})}),m&&t.jsx("div",{className:we("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",f?"right-16":"right-11"),"data-test":"filter-search-filter-indicator"}),t.jsx(Cb,{showSettings:o,onShowSettingsChange:c,caseSensitive:g,onCaseSensitiveChange:a,nodeFields:y,onFieldChange:x})]}),f.trim()&&t.jsx(jb,{nodesWithMatches:s,totalMatchCount:n}),s.length>0&&t.jsx(yb,{nodesWithMatches:s,query:f,caseSensitive:g,onNodeClick:l,onMatchClick:d,onRemoveNode:u})]})},Cb=({showSettings:e,onShowSettingsChange:s,caseSensitive:n,onCaseSensitiveChange:o,nodeFields:r,onFieldChange:a})=>t.jsxs(ot,{open:e,onOpenChange:s,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"filter-search-settings-button",children:t.jsx(Ho,{className:"h-3.5 w-3.5"})})}),t.jsx(rt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:ke.draggablePopoverDropdown},"data-test":"filter-search-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(Ns,{id:"filter-case-sensitive",label:"Case sensitive",checked:n,onChange:o,dataTest:"filter-case-sensitive-checkbox"}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx(Ns,{id:"filter-content",label:"Content",checked:r.content,onChange:i=>a("content",i),dataTest:"filter-content-checkbox"}),t.jsx(Ns,{id:"filter-title",label:"Title",checked:r.title,onChange:i=>a("title",i),dataTest:"filter-title-checkbox"}),t.jsx(Ns,{id:"filter-id",label:"ID",checked:r.id,onChange:i=>a("id",i),dataTest:"filter-id-checkbox"}),t.jsx(Ns,{id:"filter-type",label:"Type",checked:r.type,onChange:i=>a("type",i),dataTest:"filter-type-checkbox"}),t.jsx(Ns,{id:"filter-tags",label:"Tags",checked:r.tags,onChange:i=>a("tags",i),dataTest:"filter-tags-checkbox"})]})]})]})})]}),Ns=({id:e,label:s,checked:n,onChange:o,dataTest:r})=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:e,checked:n,onCheckedChange:a=>o(!!a),"data-test":r}),t.jsx("label",{htmlFor:e,className:"text-sm cursor-pointer",children:s})]}),jb=({nodesWithMatches:e,totalMatchCount:s})=>t.jsx("div",{className:"flex items-center justify-between","data-test":"filter-search-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground",children:e.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found"," ",t.jsx(qe,{variant:"secondary",className:"mx-1",children:s}),s===1?"match":"matches"," in"," ",t.jsx(qe,{variant:"secondary",className:"mx-1",children:e.length}),e.length===1?"node":"nodes"]})})}),kb=({availableTags:e,nodesCountPerTag:s,selectedTagIds:n,showToggle:o,onToggleTag:r,onSetSelectedTags:a})=>{const i=n.length===e.length&&e.length>0;return t.jsxs("div",{className:"space-y-2","data-test":"tags-list-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Available Tags:"}),o&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>{a(i?[]:e.map(c=>c.title))},className:"h-5 w-5",title:i?"Unselect all":"Select all","data-test":"tag-toggle-all-button",children:i?t.jsx(Za,{className:"h-3 w-3"}):t.jsx(Uc,{className:"h-3 w-3"})})]}),t.jsx("div",{className:"flex flex-wrap gap-1.5","data-test":"tags-list",children:e.map(c=>{const l=s.get(c.title)??0,d=n.includes(c.title);return t.jsxs(qe,{variant:d?"default":"secondary",className:we("text-xs transition-colors cursor-pointer hover:bg-primary/80"),onClick:()=>r(c.title),"data-test":`tag-badge-${c.id}`,children:[c.title,t.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",l,")"]})]},c.id)})})]})},Ab=({availableTags:e,nodesCountPerTag:s,config:n,canReset:o,onModeChange:r,onToggleTag:a,onSetSelectedTags:i,onArrangementChange:c,onGroup:l,onSlice:d,onReset:u})=>{const{mode:h,selectedTagIds:f,sliceArrangement:g}=n;return e.length===0?t.jsx("div",{className:"text-xs text-muted-foreground py-2","data-test":"tag-organize-no-tags",children:"No tags found. Add tags to nodes to organize them."}):t.jsxs("div",{className:"space-y-3","data-test":"tag-organize-section",children:[t.jsxs("div",{className:"flex items-center gap-2","data-test":"tag-organize-actions",children:[t.jsx(Gi,{mode:"group",currentMode:h,icon:t.jsx(An,{className:"h-3.5 w-3.5"}),label:"Group",onClick:()=>r(h==="group"?null:"group")}),t.jsx(Gi,{mode:"slice",currentMode:h,icon:t.jsx(Pn,{className:"h-3.5 w-3.5"}),label:"Slice",onClick:()=>r(h==="slice"?null:"slice")}),o&&t.jsxs(ee,{variant:"ghost",size:"sm",onClick:u,className:"h-7 text-xs","data-test":"tag-organize-reset-button",children:[t.jsx(Bo,{className:"h-3.5 w-3.5 mr-1"}),"Reset"]})]}),h&&t.jsx("div",{className:"text-xs text-muted-foreground","data-test":"tag-organize-mode-description",children:h==="group"?"Select tags, then click Apply to create groups.":"Select tags, then click Apply to create swimlanes."}),h==="slice"&&t.jsxs("div",{className:"space-y-1.5","data-test":"slice-arrangement-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lane Layout:"}),t.jsxs("div",{className:"flex gap-1","data-test":"slice-arrangement-buttons",children:[t.jsx(Zn,{arrangement:"horizontal",currentArrangement:g,icon:t.jsx(ps,{className:"h-3.5 w-3.5"}),onClick:()=>c("horizontal")}),t.jsx(Zn,{arrangement:"vertical",currentArrangement:g,icon:t.jsx(eo,{className:"h-3.5 w-3.5"}),onClick:()=>c("vertical")}),t.jsx(Zn,{arrangement:"grid",currentArrangement:g,icon:t.jsx(An,{className:"h-3.5 w-3.5"}),onClick:()=>c("grid")}),t.jsx(Zn,{arrangement:"masonry",currentArrangement:g,icon:t.jsx(Wc,{className:"h-3.5 w-3.5"}),onClick:()=>c("masonry")})]})]}),t.jsx(kb,{availableTags:e,nodesCountPerTag:s,selectedTagIds:f,showToggle:h!==null,onToggleTag:a,onSetSelectedTags:i}),h==="group"&&f.length>0&&t.jsxs(ee,{variant:"default",size:"sm",onClick:()=>{f.forEach(y=>l(y))},className:"w-full h-8","data-test":"tag-organize-apply-group-button",children:["Apply Groups (",f.length," tags)"]}),h==="slice"&&f.length>0&&t.jsxs(ee,{variant:"default",size:"sm",onClick:d,className:"w-full h-8","data-test":"tag-organize-apply-slice-button",children:["Apply Swimlanes (",f.length," tags)"]})]})},Gi=({mode:e,currentMode:s,icon:n,label:o,onClick:r})=>{const a=s===e;return t.jsxs(ee,{variant:a?"default":"outline",size:"sm",onClick:r,className:"h-7 text-xs","data-test":`tag-organize-mode-${e}-button`,children:[n,t.jsx("span",{className:"ml-1",children:o})]})},Zn=({arrangement:e,currentArrangement:s,icon:n,onClick:o})=>{const r=s===e;return t.jsx(ee,{variant:r?"default":"outline",size:"icon",onClick:o,className:"h-7 w-7",title:Mx[e],"data-test":`slice-arrangement-${e}-button`,children:n})},Ib=[],Tb=()=>{const e=H(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.coreState.nodes)??Ib}),s=H(o=>{var a;const r=o.projectCanvas.getActive();return r!=null&&r.activeViewLayerId?((a=r.viewLayers)==null?void 0:a.find(i=>i.id===r.activeViewLayerId))??null:null});return p.useMemo(()=>{if(!s)return e;const o=new Map(s.nodePositions.map(i=>[i.nodeId,i])),r=e.map(i=>{const c=o.get(i.id);return c?{...i,x:c.x,y:c.y}:i}),a=s.groupNodes.map(i=>({id:i.id,type:de.GROUP,x:i.x,y:i.y,width:i.width,height:i.height,content:i.name,data:{childNodeIds:i.childNodeIds}}));return[...r,...a]},[e,s])},Eb=()=>H(s=>{var n;return((n=s.projectCanvas.getActive())==null?void 0:n.activeViewLayerId)??null})!==null,Rb=[],Mb=()=>{const e=H(g=>{var y;return((y=g.projectCanvas.getActive())==null?void 0:y.viewLayers)??Rb}),s=H(g=>{var y;return((y=g.projectCanvas.getActive())==null?void 0:y.activeViewLayerId)??null}),n=H(g=>g.viewLayer),o=p.useMemo(()=>[...e].sort((g,y)=>new Date(y.createdAt).getTime()-new Date(g.createdAt).getTime()),[e]),r=p.useMemo(()=>o.map(g=>({id:g.id,label:g.name,icon:t.jsx(An,{className:"h-3 w-3 text-muted-foreground"}),data:{type:"view-layer",...g}})),[o]),a=p.useCallback(g=>{n.setActive(g.id)},[n]),i=p.useCallback(()=>{n.setActive(null)},[n]),c=p.useCallback((g,y)=>{n.rename(g,y)},[n]),l=p.useCallback(g=>{n.delete(g)},[n]),d=p.useCallback(g=>`Delete view "${g.label}"? This cannot be undone.`,[]),u=p.useCallback(g=>[{id:"duplicate",label:"Duplicate",icon:t.jsx(Mt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(g.id)}}],[n]),h=p.useCallback(()=>{const g=s?e.find(x=>x.id===s):null,y=g==null?void 0:g.name.startsWith("(Unsaved) ");let m;y&&g?m=g.name.replace("(Unsaved) ",""):m=`View ${e.filter(w=>!w.name.startsWith("(Unsaved)")).length+1}`,y&&s?n.rename(s,m):n.create(m)},[e,n,s]),f=s===null;return t.jsxs("div",{className:"view-layer-manager flex flex-col h-full w-full overflow-hidden","data-test":"view-layer-manager",children:[t.jsxs("div",{className:"view-list flex-1 min-h-0 w-full overflow-y-auto overflow-x-hidden p-2","data-test":"view-list-scroll-area",children:[t.jsxs("div",{className:we("flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",f&&"bg-primary/10 border border-primary"),onClick:i,"data-test":"base-view-item",children:[t.jsx("div",{className:"w-4 h-4 mr-2 flex-shrink-0"}),t.jsx(oh,{className:"h-3 w-3 text-muted-foreground mr-2 flex-shrink-0"}),t.jsx("span",{className:"text-sm truncate flex-grow",children:"Base View"})]}),r.length>0&&t.jsx("div",{className:"mt-1","data-test":"saved-views-list",children:t.jsx(_s,{data:r,onItemClick:a,onUpdate:c,onDelete:l,selectedId:s,deleteConfirmMessage:d,enableEdit:!0,enableDelete:!0,enableDrag:!1,moreOptionsItems:u,dropdownZIndex:ke.draggablePopoverDropdown})})]}),t.jsx("div",{className:"border-t p-2","data-test":"view-actions",children:t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full",onClick:h,"data-test":"view-save-button",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"}),"Save Current View"]})})]})},Pb=()=>{const e=H(g=>{var y;return((y=g.projectCanvas.getActive())==null?void 0:y.coreState.nodes)??[]}),s=H(g=>g.setSelectedNodes),n=Eb(),[o,r]=p.useState(!1),[a,i]=p.useState(null),c=p.useRef(null),l=xb({nodes:e,setSelectedNodes:s}),d=wb({nodes:e}),u=g=>{if(g.stopPropagation(),o){r(!1);return}if(c.current){const y=c.current.getBoundingClientRect();i({x:y.left-280-16,y:y.top})}r(!0)},h=t.jsx("button",{ref:c,onClick:u,onMouseDown:g=>g.stopPropagation(),className:we("p-1 rounded hover:bg-accent transition-colors",n&&"text-blue-500 bg-blue-500/10"),title:"Manage Views","data-test":"canvas-filter-views-button",children:t.jsx(An,{className:"h-3.5 w-3.5"})}),f=t.jsxs("div",{className:"flex flex-col h-full","data-test":"canvas-filter-popover-content",children:[t.jsx("div",{className:"border-b border-border p-3","data-test":"canvas-filter-search-container",children:t.jsx(Sb,{searchConfig:l.searchConfig,nodesWithMatches:l.nodesWithMatches,totalMatchCount:l.totalMatchCount,showSettings:l.showSettings,onQueryChange:l.setQuery,onCaseSensitiveChange:l.setCaseSensitive,onNodeFieldsChange:l.setNodeFields,onShowSettingsChange:l.setShowSettings,onNodeClick:l.handleNodeClick,onMatchClick:l.handleMatchClick,onRemoveNode:l.removeNodeFromResults,onSelectAllMatches:l.handleSelectAllMatches})}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3","data-test":"canvas-filter-organize-container",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Organize by Tags"}),n&&t.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded","data-test":"view-layer-active-badge",children:[t.jsx(Pn,{className:"h-3 w-3"}),"View Active"]})]}),t.jsx(Ab,{availableTags:d.availableTags,nodesCountPerTag:d.nodesCountPerTag,config:d.config,canReset:d.canReset,onModeChange:d.setMode,onToggleTag:d.toggleTagSelection,onSetSelectedTags:d.setSelectedTagIds,onArrangementChange:d.setSliceArrangement,onGroup:d.handleGroup,onSlice:d.handleSlice,onReset:d.handleReset})]})]});return t.jsxs(t.Fragment,{children:[t.jsx(Zs,{popoverId:"canvas-filter",icon:ah,tooltip:"Filter & Organize",popoverTitle:"Filter & Organize",popoverContent:f,leftOffset:120,initialSize:{width:360,height:500},dataTest:"canvas-filter-button",headerActions:h}),t.jsx(Be,{isVisible:o,onClose:()=>r(!1),title:"Views",resizable:!0,initialSize:{width:280,height:350},triggerPosition:a??void 0,children:t.jsx(Mb,{})})]})},Db=e=>{const{className:s,style:n}=e;return t.jsx(Aw,{children:t.jsxs(Go,{className:s,style:n,position:"left",children:[t.jsx(ql,{}),t.jsx(ab,{}),t.jsx(Pb,{}),t.jsx(rb,{extension:hb})]})})},Ob=()=>{const e=H(i=>i.uiState.mode),s=H(i=>i.uiState.selectFromDrawMode),{setMode:n,setUiState:o}=E.getState(),r=e===Q.SELECT&&s,a=()=>{r?(o(i=>({...i,selectFromDrawMode:!1})),E.getState().setSelectedNodes([]),E.getState().arrow.setSelected([]),n(Q.DRAW)):(o(i=>({...i,selectFromDrawMode:!0})),n(Q.SELECT))};return t.jsx(ee,{variant:r?"default":"outline",size:"icon",onPointerUp:a,title:r?"Back to Draw Mode":"Select Mode (select/drag nodes)","data-test":"draw-mode-select-button",children:t.jsx(Sc,{className:"h-4 w-4"})})},Yo=()=>"right",Lb=()=>{const[e,s]=p.useState(!1),n=H(h=>h.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=E.getState(),a=(n==null?void 0:n.strokeColor)??"currentColor",i=a==="currentColor"?"hsl(var(--foreground))":a,c=(n==null?void 0:n.opacity)??1,l=c<1,d=h=>{o({strokeColor:h}),r(l?f=>({...f,markerStrokeColor:h}):f=>({...f,penStrokeColor:h}))},u=h=>{o({opacity:h[0]})};return t.jsxs(ot,{open:e,onOpenChange:s,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"outline",size:"icon",title:`Stroke Color (${Math.round(c*100)}% opacity)`,"data-test":"draw-mode-stroke-color-button",children:t.jsx("span",{style:{width:"16px",height:"16px",borderRadius:"3px",backgroundColor:i,opacity:c,border:"1px solid hsl(var(--border))"}})})}),t.jsx(rt,{className:"w-auto p-0",side:Yo(),sideOffset:8,onCloseAutoFocus:h=>h.preventDefault(),"data-test":"draw-mode-stroke-color-popover",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(dr,{label:"Stroke Color",currentColor:a,onColorSelect:d}),t.jsxs("div",{className:"px-3 pb-3 space-y-2","data-test":"draw-mode-opacity-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(c*100),"%"]})]}),t.jsx(Vt,{value:[c],min:.1,max:1,step:.05,onValueChange:u,className:"w-full","data-test":"draw-mode-opacity-slider"})]})]})})]})},Wb=[1,2,3,4,5,6,8,10,12,16,20,28,40,60],$b=()=>{const[e,s]=p.useState(!1),n=H(l=>l.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=E.getState(),a=(n==null?void 0:n.strokeWidth)??wa,i=((n==null?void 0:n.opacity)??1)<1,c=l=>{o({strokeWidth:l}),r(i?d=>({...d,markerStrokeWidth:l}):d=>({...d,penStrokeWidth:l})),s(!1)};return t.jsxs(ot,{open:e,onOpenChange:s,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"outline",size:"icon",title:`Stroke Width: ${a}px`,"data-test":"draw-mode-stroke-width-button",children:t.jsxs("div",{className:"flex flex-col gap-[2px] items-center",children:[t.jsx("span",{style:{width:"14px",height:"1px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"2px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"4px",backgroundColor:"currentColor",borderRadius:"1px"}})]})})}),t.jsx(rt,{className:"w-auto p-3",side:Yo(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1 flex-wrap max-w-[200px]",children:Wb.map(l=>t.jsxs("button",{type:"button",title:`${l}px`,onClick:()=>c(l),className:`w-10 h-8 flex items-center justify-center gap-1 rounded border cursor-pointer hover:bg-accent ${a===l?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":`draw-mode-stroke-width-${l}px`,children:[t.jsx("span",{style:{width:"12px",height:`${Math.min(l,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}}),t.jsx("span",{className:"text-[10px] text-muted-foreground",children:l})]},l))})]})})]})},Bb=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}],Yi=({style:e})=>{const s=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("svg",{width:"16",height:"8",viewBox:"0 0 16 8",children:t.jsx("line",{x1:"0",y1:"4",x2:"16",y2:"4",stroke:"currentColor",strokeWidth:"2",strokeDasharray:s,strokeLinecap:"round"})})},Hb=()=>{const[e,s]=p.useState(!1),n=H(c=>c.uiState.drawStyle),{setDrawStyle:o}=E.getState(),r=(n==null?void 0:n.strokeStyle)??"solid",a=c=>{o({strokeStyle:c}),s(!1)},i=c=>{s(c)};return t.jsxs(ot,{open:e,onOpenChange:i,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"outline",size:"icon",title:`Stroke Style: ${r}`,"data-test":"draw-mode-stroke-style-button",onPointerDown:c=>{c.stopPropagation()},onPointerUp:c=>{c.stopPropagation()},children:t.jsx(Yi,{style:r})})}),t.jsx(rt,{className:"w-auto p-3",side:Yo(),sideOffset:8,onCloseAutoFocus:c=>c.preventDefault(),"data-test":"draw-mode-stroke-style-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-style-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Style"}),t.jsx("div",{className:"flex gap-1",children:Bb.map(c=>t.jsx("button",{type:"button",title:c.label,onClick:()=>a(c.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${r===c.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":`draw-mode-stroke-style-${c.value}`,children:t.jsx(Yi,{style:c.value})},c.value))})]})})]})},Fb=()=>t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:t.jsx("ellipse",{cx:"8",cy:"8",rx:"7",ry:"4"})}),Ki=[{value:be.SQUARE,label:"Square",icon:t.jsx(Uc,{className:"h-4 w-4"})},{value:be.RECTANGLE,label:"Rectangle",icon:t.jsx(Ht,{className:"h-4 w-4"})},{value:be.CIRCLE,label:"Circle",icon:t.jsx($o,{className:"h-4 w-4"})},{value:be.ELLIPSE,label:"Ellipse",icon:t.jsx(Fb,{})},{value:be.ARROW,label:"Arrow",icon:t.jsx(lh,{className:"h-4 w-4"})}],_b=()=>{const[e,s]=p.useState(!1),n=H(l=>l.uiState.drawSubMode),{setDrawSubMode:o,setDrawStyle:r}=E.getState(),a=n&&[be.SQUARE,be.RECTANGLE,be.CIRCLE,be.ELLIPSE,be.ARROW].includes(n),i=Ki.find(l=>l.value===n),c=l=>{o(l),r({opacity:1}),s(!1)};return t.jsxs(ot,{open:e,onOpenChange:s,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:a?"default":"outline",size:"icon",title:i?`Shape: ${i.label}`:"Shapes","data-test":"draw-mode-shape-button",children:a&&i?i.icon:t.jsx(ch,{className:"h-4 w-4"})})}),t.jsx(rt,{className:"w-auto p-3",side:Yo(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-shape-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-shape-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Shapes"}),t.jsx("div",{className:"flex gap-1",children:Ki.map(l=>t.jsx("button",{type:"button",title:l.label,onClick:()=>c(l.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${n===l.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":`draw-mode-shape-${l.label.toLowerCase()}`,children:l.icon},l.value))}),t.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Click to switch to shape mode. Drag to draw."})]})})]})},zb=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=H(k=>k.uiState.drawStyle),i=H(k=>k.uiState.penStrokeWidth)??wa,c=H(k=>k.uiState.markerStrokeWidth)??Dd,l=H(k=>k.uiState.penStrokeColor)??"currentColor",d=H(k=>k.uiState.markerStrokeColor)??se.drawing.markerColor,u=H(k=>k.uiState.drawAxisLock)??"none",{setDrawStyle:h,setDrawAxisLock:f,setUiState:g,setDrawSubMode:y}=E.getState(),m=((a==null?void 0:a.opacity)??1)<1,x=(a==null?void 0:a.strokeWidth)??wa,w=(a==null?void 0:a.strokeColor)??"currentColor",v=()=>{m?(g(k=>({...k,markerStrokeWidth:x,markerStrokeColor:w})),h({opacity:1,strokeWidth:i,strokeColor:l})):(g(k=>({...k,penStrokeWidth:x,penStrokeColor:w})),h({opacity:se.drawing.markerOpacity,strokeWidth:c,strokeColor:d}),y(be.FREEHAND))},b=k=>{if(k.stopPropagation(),e){s(!1);return}if(r.current){const S=r.current.getBoundingClientRect();o({x:S.right+8,y:S.top})}s(!0)},N=k=>{f(k?"horizontal":"none")},j=k=>{f(k?"vertical":"none")};return t.jsxs("div",{ref:r,className:"relative inline-flex group","data-test":"draw-mode-marker-container",children:[t.jsx(ee,{variant:m?"default":"outline",size:"icon",onPointerUp:v,title:m?"Marker Mode (On)":"Marker Mode (Off)","data-test":"draw-mode-marker-toggle",children:t.jsx(jc,{className:"h-4 w-4"})}),t.jsxs("div",{className:we("absolute right-0 top-0 bottom-0 translate-x-full","flex items-stretch","opacity-0 group-hover:opacity-100 transition-opacity duration-150","pointer-events-none group-hover:pointer-events-auto"),"data-test":"draw-mode-marker-caret-trigger",children:[t.jsx("div",{className:"w-[3px] bg-foreground/10"}),t.jsx("button",{type:"button",onClick:b,className:we("flex items-center justify-center","px-1 rounded-r-md","bg-foreground/5 hover:bg-foreground/10","transition-colors duration-150","cursor-pointer"),"aria-label":"Drawing options",title:"Drawing options","data-test":"draw-mode-marker-caret-button",children:t.jsx(Ks,{className:"h-3 w-3 text-foreground/60"})})]}),t.jsx(Be,{isVisible:e,onClose:()=>s(!1),title:"Drawing Options",initialPosition:n??{x:100,y:100},showPinButton:!1,showInspectorButton:!1,children:t.jsx("div",{className:"p-3 space-y-4","data-test":"draw-mode-options-popover-content",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Axis Lock"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lock drawing to a straight line"}),t.jsxs("div",{className:"space-y-2 mt-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"lock-horizontal",checked:u==="horizontal",onCheckedChange:N,"data-test":"draw-mode-lock-horizontal-checkbox"}),t.jsx(je,{htmlFor:"lock-horizontal",className:"text-sm font-normal cursor-pointer",children:"Lock Horizontal (constant Y)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"lock-vertical",checked:u==="vertical",onCheckedChange:j,"data-test":"draw-mode-lock-vertical-checkbox"}),t.jsx(je,{htmlFor:"lock-vertical",className:"text-sm font-normal cursor-pointer",children:"Lock Vertical (constant X)"})]})]})]})})})]})},Ub=e=>{const{className:s}=e,{setMode:n,undo:o}=E.getState(),r=H(u=>u.undo.canUndo()),a=H(u=>u.undo.canRedo()),i=()=>{E.getState().setUiState(u=>({...u,selectFromDrawMode:!1})),n(Q.SELECT)},c=()=>{o.undo()},l=()=>{o.redo()};return t.jsxs(Go,{position:"left",className:s,children:[t.jsx(ee,{variant:"outline",size:"icon",onPointerUp:i,title:"Exit Draw Mode (Esc)","data-test":"draw-mode-exit-button",children:t.jsx(We,{className:"h-5 w-5"})}),t.jsx(Ob,{}),t.jsx(Lb,{}),t.jsx($b,{}),t.jsx(Hb,{}),t.jsx(_b,{}),t.jsx(zb,{}),t.jsx(En,{expandContent:t.jsx(Io,{onSelect:u=>o.jumpTo(u)}),expandTitle:"History",onClick:c,onHoldRepeat:c,holdRepeatInterval:se.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!r,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"draw-mode-undo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Eo,{}),t.jsx(Ro,{}),t.jsx(To,{})]}),children:t.jsx(rh,{className:"h-5 w-5"})}),t.jsx(En,{expandContent:t.jsx(Io,{onSelect:u=>o.jumpTo(u)}),expandTitle:"History",onClick:l,onHoldRepeat:l,holdRepeatInterval:se.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!a,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"draw-mode-redo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Eo,{}),t.jsx(Ro,{}),t.jsx(To,{})]}),children:t.jsx(ih,{className:"h-5 w-5"})})]})},Vb=Ce.memo(Ub),Xi="paper-texture-live-config",Gb="paper-texture-saved-presets";function Yb({onTextureChange:e}){return t.jsx(Zs,{popoverId:"paper-texture-config",icon:dh,tooltip:"Paper Texture Live Preview",popoverTitle:"Paper Texture",initialSize:{width:320,height:420},leftOffset:120,buttonVariant:"ghost",buttonSize:"icon",dataTest:"paper-texture-config-button",popoverContent:t.jsx(Kb,{onTextureChange:e})})}function Kb({onTextureChange:e}){const[s,n]=p.useState(()=>{try{const a=localStorage.getItem(Xi);if(a)return JSON.parse(a)}catch{}return{params:mc.medium,activePreset:"medium"}}),[o,r]=p.useState(()=>{var i,c,l;const a=(l=(c=(i=E.getState().preferences)==null?void 0:i.canvasConfig)==null?void 0:c.background)==null?void 0:l.savedPresets;if(a&&a.length>0)return a;try{const d=localStorage.getItem(Gb);if(d){const u=JSON.parse(d);return u.length>0&&E.setState(h=>{var f,g,y;return{...h,preferences:{...h.preferences,canvasConfig:{...(f=h.preferences)==null?void 0:f.canvasConfig,background:{...(y=(g=h.preferences)==null?void 0:g.canvasConfig)==null?void 0:y.background,savedPresets:u}}}}}),u}}catch{}return se.background.savedPresets});return p.useEffect(()=>{localStorage.setItem(Xi,JSON.stringify(s))},[s]),p.useEffect(()=>{E.setState(a=>{var i,c,l;return{...a,preferences:{...a.preferences,canvasConfig:{...(i=a.preferences)==null?void 0:i.canvasConfig,background:{...(l=(c=a.preferences)==null?void 0:c.canvasConfig)==null?void 0:l.background,savedPresets:o}}}}}),se.background.savedPresets=o},[o]),t.jsx(Xb,{config:s,setConfig:n,savedPresets:o,setSavedPresets:r,onTextureChange:e})}function Xb({config:e,setConfig:s,savedPresets:n,setSavedPresets:o,onTextureChange:r}){const{params:a,activePreset:i}=e,[c,l]=p.useState(null),[d,u]=p.useState(""),{theme:h}=xc(),f=p.useMemo(()=>h==="dark"?!0:h==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[h]),g=100-a.bgLightness;p.useEffect(()=>{E.setState(S=>{var C;return{...S,preferences:{...S.preferences,canvasConfig:{...(C=S.preferences)==null?void 0:C.canvasConfig,background:{paperTexture:typeof i=="string"&&!Jn.includes(i)?"custom":i,customParams:a}}}}}),se.background.paperTexture=typeof i=="string"&&!Jn.includes(i)?"custom":i,se.background.customParams=a},[a,i]);const y=(S,C)=>{s(R=>({...R,params:{...R.params,[S]:C},activePreset:"custom"}))},m=S=>{S!=="custom"&&(s({params:mc[S],activePreset:S}),r==null||r(S))},x=S=>{s({params:S.params,activePreset:S.id})},w=()=>{m("none")},v=()=>{const S={id:`preset-${Date.now()}`,name:`Preset ${n.length+1}`,params:{...a}};o(C=>[...C,S]),s(C=>({...C,activePreset:S.id}))},b=S=>{o(C=>C.filter(R=>R.id!==S)),i===S&&m("none")},N=S=>{l(S.id),u(S.name)},j=()=>{c&&d.trim()&&o(S=>S.map(C=>C.id===c?{...C,name:d.trim()}:C)),l(null),u("")},k=()=>{l(null),u("")};return t.jsxs("div",{className:"texture-config space-y-4 p-4","data-test":"texture-config",children:[t.jsxs("div",{className:"presets","data-test":"texture-presets",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx(je,{className:"text-xs text-muted-foreground uppercase",children:"Presets"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:v,"data-test":"save-preset",children:[t.jsx(qt,{className:"w-3 h-3 mr-1"}),"Save"]}),t.jsxs(ee,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:w,"data-test":"reset-texture",children:[t.jsx(Bo,{className:"w-3 h-3 mr-1"}),"Reset"]})]})]}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:Jn.filter(S=>S!=="custom").map(S=>t.jsx(ee,{variant:i===S?"default":"outline",size:"sm",className:"h-7 text-xs",onClick:()=>m(S),"data-test":`preset-${S}`,children:wc[S]},S))})]}),n.length>0&&t.jsxs("div",{className:"saved-presets","data-test":"saved-presets",children:[t.jsx(je,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Saved"}),t.jsx("div",{className:"space-y-1",children:n.map(S=>t.jsx("div",{className:"flex items-center gap-1","data-test":`saved-preset-${S.id}`,children:c===S.id?t.jsxs(t.Fragment,{children:[t.jsx(Ae,{value:d,onChange:C=>u(C.target.value),className:"h-7 text-xs flex-1",onKeyDown:C=>{C.key==="Enter"&&j(),C.key==="Escape"&&k()},autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:j,"data-test":"save-preset-name",children:t.jsx(Bs,{className:"w-3 h-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:k,"data-test":"cancel-edit",children:t.jsx(We,{className:"w-3 h-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:i===S.id?"default":"outline",size:"sm",className:"h-7 text-xs flex-1 justify-start",onClick:()=>x(S),"data-test":"load-saved-preset",children:S.name}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>N(S),"data-test":"edit-preset",children:t.jsx(zc,{className:"w-3 h-3"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:()=>b(S.id),"data-test":"delete-preset",children:t.jsx(pt,{className:"w-3 h-3"})})]})},S.id))})]}),t.jsxs("div",{className:"controls space-y-3","data-test":"texture-controls",children:[t.jsx(je,{className:"text-xs text-muted-foreground uppercase",children:"Texture"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-frequency",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(je,{className:"text-xs",children:"Frequency"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.baseFrequency.toFixed(2)})]}),t.jsx(Vt,{value:[a.baseFrequency],onValueChange:([S])=>y("baseFrequency",S),min:.1,max:2,step:.05})]}),t.jsxs("div",{className:"control-group","data-test":"control-octaves",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(je,{className:"text-xs",children:"Octaves"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.numOctaves})]}),t.jsx(Vt,{value:[a.numOctaves],onValueChange:([S])=>y("numOctaves",S),min:1,max:6,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-opacity",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(je,{className:"text-xs",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[(a.opacity*100).toFixed(0),"%"]})]}),t.jsx(Vt,{value:[a.opacity],onValueChange:([S])=>y("opacity",S),min:0,max:.8,step:.05})]})]})]}),t.jsxs("div",{className:"bg-controls space-y-3","data-test":"bg-controls",children:[t.jsx(je,{className:"text-xs text-muted-foreground uppercase",children:"Background"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-hue",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(je,{className:"text-xs",children:"Hue"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgHue,"°"]})]}),t.jsx(Vt,{value:[a.bgHue],onValueChange:([S])=>y("bgHue",S),min:0,max:360,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-saturation",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(je,{className:"text-xs",children:"Saturation"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgSaturation,"%"]})]}),t.jsx(Vt,{value:[a.bgSaturation],onValueChange:([S])=>y("bgSaturation",S),min:0,max:100,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-lightness",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(je,{className:"text-xs",children:"Lightness"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgLightness,"%"]})]}),t.jsx(Vt,{value:[a.bgLightness],onValueChange:([S])=>y("bgLightness",S),min:0,max:100,step:1})]})]})]}),t.jsxs("div",{className:"preview","data-test":"texture-preview",children:[t.jsx(je,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Preview"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{className:"relative","data-test":"preview-light",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(uh,{className:`w-3 h-3 ${f?"text-muted-foreground":"text-primary"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${f?"":"ring-2 ring-primary"}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${a.bgLightness}%)`},"data-test":"preview-swatch-light",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-light"})})]}),t.jsxs("div",{className:"relative","data-test":"preview-dark",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(hh,{className:`w-3 h-3 ${f?"text-primary":"text-muted-foreground"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${f?"ring-2 ring-primary":""}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${g}%)`},"data-test":"preview-swatch-dark",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-dark"})})]})]})]})]})}function qi({title:e,action:s,isOpen:n}){return t.jsxs("div",{"data-test":`section-${e.toLowerCase().replace(/\s+/g,"-")}`,className:"border-b pb-1 mb-3 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Et,{className:we("h-3 w-3 text-muted-foreground transition-transform",!n&&"-rotate-90")}),t.jsx("h3",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:e})]}),s]})}function qb(){var S;const[e,s]=p.useState(""),[n,o]=p.useState(new Set),r=C=>{o(R=>{const I=new Set(R);return I.has(C)?I.delete(C):I.add(C),I})},a=H(C=>{var R,I;return((I=(R=C.preferences)==null?void 0:R.arrangeButton)==null?void 0:I.nodeGap)??pe.ARRANGE_NODE_GAP}),i=H(C=>{var R,I;return((I=(R=C.preferences)==null?void 0:R.arrangeButton)==null?void 0:I.gridColumns)??pe.ARRANGE_GRID_COLUMNS}),c=H(C=>C.getArrangeGridRows()),l=H(C=>C.setArrangeNodeGap),d=H(C=>C.setArrangeGridColumns),u=H(C=>C.setArrangeGridRows),h=async C=>{se.persistState=!!C.persistState,se.autosave=!!C.autosave,se.hideOverlay=!!C.hideOverlay,se.hideToolbar=!!C.hideToolbar,se.background.paperTexture=C.backgroundPaperTexture,se.arrows.type=C.arrowType,se.arrows.REVERSE_CURVE=!!C.arrowReverseCurve,se.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=Number(C.arrowSShapeFactor),se.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=!!C.arrowSShapeReversed,se.arrows.CUBIC_HORIZONTAL_BIAS=Number(C.arrowHorizontalBias),se.arrows.reverseArrowOnMultipleConnect=!!C.arrowReverseOnMultipleConnect,se.highlightAndCreate.createConnectingArrow=!!C.highlightCreateArrow,se.highlightAndCreate.createHighlight=!!C.highlightCreateHighlight,se.nodeOptions.maxNodeWidth=Number(C.nodeMaxWidth),se.nodeOptions.resizeBorderWidth=Number(C.nodeResizeBorderWidth),se.zoom.min=Number(C.zoomMin),se.zoom.max=Number(C.zoomMax),se.zoom.intensity=Number(C.zoomIntensity),se.history.historyLimit=Number(C.historyLimit),se.history.tabletHistoryLimit=Number(C.tabletHistoryLimit),se.history.archiveLimit=Number(C.archiveLimit),se.history.tabletArchiveLimit=Number(C.tabletArchiveLimit),E.setState(R=>{var I,M,W;return{...R,preferences:{...R.preferences,splitNodeGap:Number(C.splitNodeGap),canvasConfig:{...(I=R.preferences)==null?void 0:I.canvasConfig,persistState:!!C.persistState,autosave:!!C.autosave,hideOverlay:!!C.hideOverlay,hideToolbar:!!C.hideToolbar,background:{...(W=(M=R.preferences)==null?void 0:M.canvasConfig)==null?void 0:W.background,paperTexture:C.backgroundPaperTexture},arrows:{type:C.arrowType,REVERSE_CURVE:!!C.arrowReverseCurve,CUBIC_ARROW_S_SHAPE_FACTOR:Number(C.arrowSShapeFactor),CUBIC_ARROW_S_SHAPE_REVERSED:!!C.arrowSShapeReversed,CUBIC_HORIZONTAL_BIAS:Number(C.arrowHorizontalBias),reverseArrowOnMultipleConnect:!!C.arrowReverseOnMultipleConnect},nodeOptions:{maxNodeWidth:Number(C.nodeMaxWidth),resizeBorderWidth:Number(C.nodeResizeBorderWidth)},zoom:{min:Number(C.zoomMin),max:Number(C.zoomMax),intensity:Number(C.zoomIntensity)}}},uiState:{...R.uiState,isOverlayVisible:!C.hideOverlay,toolbar:{...R.uiState.toolbar,isVisible:!C.hideToolbar}}}}),ve.success("Settings saved!",{description:"Canvas configuration has been updated.",duration:3e3})},f=[{title:"Persistence",fields:[{name:"persistState",label:"Persist State",type:"checkbox"},{name:"autosave",label:"Autosave",type:"checkbox"}]},{title:"UI",fields:[{name:"hideOverlay",label:"Hide Overlay",type:"checkbox"},{name:"hideToolbar",label:"Hide Toolbar",type:"checkbox"}]},{title:"Background",fields:[{name:"backgroundPaperTexture",label:"Paper Texture",type:"select",options:Jn.map(C=>({value:C,label:wc[C]}))}]},{title:"Highlight & Create ($)",fields:[{name:"highlightCreateArrow",label:"Create Connecting Arrow",type:"checkbox"},{name:"highlightCreateHighlight",label:"Create Highlight",type:"checkbox"}]},{title:"Arrows",fields:[{name:"arrowType",label:"Type",type:"select",options:Od.map(C=>({value:C,label:Ld[C]}))},{name:"arrowSShapeFactor",label:"S-Shape Factor",type:"number",placeholder:"0-2",step:.1},{name:"arrowHorizontalBias",label:"Horizontal Bias",type:"number",placeholder:"0=auto, 1=none",step:.1},{name:"arrowReverseCurve",label:"Reverse Curve",type:"checkbox"},{name:"arrowSShapeReversed",label:"S-Shape Reversed",type:"checkbox"},{name:"arrowReverseOnMultipleConnect",label:"Reverse on Multiple Connect",type:"checkbox"}]},{title:"Nodes",fields:[{name:"nodeMaxWidth",label:"Max Width (px)",type:"number",placeholder:"100-2000"},{name:"nodeResizeBorderWidth",label:"Resize Border Width (px)",type:"number",placeholder:"1-50"},{name:"splitNodeGap",label:"Split Node Gap (px)",type:"number",placeholder:"0-100"}]},{title:"Zoom",fields:[{name:"zoomMin",label:"Min",type:"number",placeholder:"0.01-1"},{name:"zoomMax",label:"Max",type:"number",placeholder:"1-10"},{name:"zoomIntensity",label:"Intensity",type:"number",placeholder:"0.01-1"}]}],[g,y]=p.useState(!1);p.useEffect(()=>{const C=()=>y(window.innerWidth<1280);return C(),window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]);const m={title:"History",fields:g?[{name:"tabletHistoryLimit",label:"In-Memory Limit",type:"number",placeholder:"10-200"},{name:"tabletArchiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-1000"}]:[{name:"historyLimit",label:"In-Memory Limit",type:"number",placeholder:"10-500"},{name:"archiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-2000"}]},x=[...f,m],w=p.useMemo(()=>{const C=x.map(R=>R.title);return C.push("Arrange"),C},[x]),v=()=>o(new Set(w)),b=()=>o(new Set),N=p.useMemo(()=>{if(!e.trim())return x;const C=e.toLowerCase();return x.filter(R=>R.title.toLowerCase().includes(C))},[x,e]),j=p.useMemo(()=>e.trim()?"arrange".includes(e.toLowerCase()):!0,[e]),k={persistState:se.persistState,autosave:se.autosave,hideOverlay:se.hideOverlay,hideToolbar:se.hideToolbar,backgroundPaperTexture:se.background.paperTexture,highlightCreateArrow:se.highlightAndCreate.createConnectingArrow,highlightCreateHighlight:se.highlightAndCreate.createHighlight,arrowType:se.arrows.type,arrowReverseCurve:se.arrows.REVERSE_CURVE,arrowSShapeFactor:se.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,arrowSShapeReversed:se.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,arrowHorizontalBias:se.arrows.CUBIC_HORIZONTAL_BIAS,arrowReverseOnMultipleConnect:se.arrows.reverseArrowOnMultipleConnect,nodeMaxWidth:se.nodeOptions.maxNodeWidth,nodeResizeBorderWidth:se.nodeOptions.resizeBorderWidth,splitNodeGap:((S=E.getState().preferences)==null?void 0:S.splitNodeGap)??pe.NEW_NODE_SEGMENT_SPACING,zoomMin:se.zoom.min,zoomMax:se.zoom.max,zoomIntensity:se.zoom.intensity,historyLimit:se.history.historyLimit,tabletHistoryLimit:se.history.tabletHistoryLimit,archiveLimit:se.history.archiveLimit,tabletArchiveLimit:se.history.tabletArchiveLimit};return t.jsxs($s,{className:"h-full",children:[t.jsx("div",{className:"sticky top-0 z-10 bg-background p-3 pb-2 border-b","data-test":"settings-search-header",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(ms,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),t.jsx(Ae,{type:"text",placeholder:"Search settings...",value:e,onChange:C=>s(C.target.value),className:"h-7 pl-7 text-xs","data-test":"settings-search-input"})]}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:b,title:"Expand all sections","data-test":"settings-expand-all-button",children:t.jsx(ph,{className:"h-4 w-4"})}),t.jsx(ee,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:v,title:"Collapse all sections","data-test":"settings-collapse-all-button",children:t.jsx(gh,{className:"h-4 w-4"})})]})}),t.jsxs(Xh,{onSubmit:h,defaultValues:k,className:"p-3 space-y-4",formId:"canvas-settings-form",children:[N.map(C=>{const R=!n.has(C.title);return t.jsxs(ls,{open:R,onOpenChange:()=>r(C.title),"data-test":`settings-section-${C.title.toLowerCase()}`,children:[t.jsx(ds,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:I=>{I.altKey&&(I.preventDefault(),v())},children:t.jsx(qi,{title:C.title,action:C.title==="Background"?t.jsx(Yb,{}):void 0,isOpen:R})})}),t.jsx(us,{children:t.jsx(qh,{fields:C.fields,layout:"two-column",className:"space-y-2",labelClassName:"text-xs"})})]},C.title)}),j&&t.jsxs(ls,{open:!n.has("Arrange"),onOpenChange:()=>r("Arrange"),"data-test":"settings-section-arrange",children:[t.jsx(ds,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:C=>{C.altKey&&(C.preventDefault(),v())},children:t.jsx(qi,{title:"Arrange",isOpen:!n.has("Arrange")})})}),t.jsx(us,{children:t.jsx(ar,{nodeGap:a,gridColumns:i,gridRows:c,onNodeGapChange:l,onGridColumnsChange:d,onGridRowsChange:u,showRows:!0})})]})]})]})}const Zb=()=>{const e=E.getState(),s=e.exportCanvasData,n=e.importCanvasData,o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(!1),[l,d]=p.useState(null),u=()=>{var f;(f=o.current)==null||f.click()},h=f=>{var m;const g=(m=f.target.files)==null?void 0:m[0];if(!g)return;a(!0),d(null);const y=new FileReader;y.onload=x=>{var v;const w=(v=x.target)==null?void 0:v.result;if(typeof w=="string"){const b=n(w,{replace:i});d(b),b.projectsImported>0&&ve.success(`Successfully imported ${b.projectsImported} project${b.projectsImported>1?"s":""}`),b.projectsSkipped>0&&ve.warning(`Skipped ${b.projectsSkipped} project${b.projectsSkipped>1?"s":""} (already exist)`),b.projectsImported===0&&b.projectsSkipped===0&&ve.error("No projects found in the import file")}else console.error("Failed to read file content."),ve.error("Failed to read file content");a(!1),o.current&&(o.current.value="")},y.onerror=x=>{console.error("Error reading file:",x),ve.error("Error reading file"),a(!1),o.current&&(o.current.value="")},y.readAsText(g)};return t.jsxs("div",{className:"space-y-4","data-test":"data-io-panel",children:[t.jsxs("div",{"data-test":"data-export-section",children:[t.jsx(je,{className:"text-sm font-medium",children:"Export"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download all canvas projects as JSON"}),t.jsxs(ee,{variant:"outline",size:"sm",onClick:s,className:"w-full","data-test":"canvas-export-button",children:[t.jsx(fh,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),t.jsxs("div",{"data-test":"data-import-section",children:[t.jsx(je,{className:"text-sm font-medium",children:"Import"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import canvas projects from a JSON file"}),t.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"canvas-replace-mode-control",children:[t.jsxs("div",{children:[t.jsx(je,{htmlFor:"canvas-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),t.jsx(go,{id:"canvas-replace-mode",checked:i,onCheckedChange:c,disabled:r,"data-test":"canvas-replace-mode-switch"})]}),t.jsxs(ee,{variant:"outline",size:"sm",onClick:u,disabled:r,className:"w-full","data-test":"canvas-import-select-file-button",children:[t.jsx(mh,{className:"h-4 w-4 mr-2"}),r?"Importing...":"Select File"]}),t.jsx("input",{type:"file",ref:o,accept:".json",style:{display:"none"},onChange:h,"data-test":"canvas-import-file-input"})]}),l&&t.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"canvas-import-result",children:[l.projectsImported>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"canvas-imported-count",children:[t.jsx(ba,{className:"h-3 w-3"}),t.jsxs("span",{children:["Imported: ",l.projectsImported]})]}),l.projectsSkipped>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-yellow-600","data-test":"canvas-skipped-count",children:[t.jsx(mo,{className:"h-3 w-3"}),t.jsxs("span",{children:["Skipped: ",l.projectsSkipped]})]}),l.projectsImported===0&&l.projectsSkipped===0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"canvas-no-projects",children:[t.jsx(mo,{className:"h-3 w-3"}),t.jsx("span",{children:"No projects found"})]})]})]})},Jb=()=>t.jsx(Oo,{storageKey:"canvas-data-io",title:"Data Import/Export",icon:t.jsx(bc,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end",children:t.jsx(Zb,{})}),xa=Object.values(Hd).map(e=>({value:e,label:Fd[e]})),Qb=()=>{const[e,s]=p.useState(()=>{var i;return((i=Qs.getState().ui)==null?void 0:i.keyboardLanguage)??Ha}),[n,o]=p.useState(()=>{var c;const i=(c=Qs.getState().ui)==null?void 0:c.enabledKeyboardLanguages;return Array.isArray(i)&&i.length>0?i:Wd}),r=()=>{var u;if(n.length<=1)return;const i=n.indexOf(e),c=i===-1?0:(i+1)%n.length,l=n[c];s(l),Qs.update("ui",{keyboardLanguage:l});const d=((u=xa.find(h=>h.value===l))==null?void 0:u.label)??l;ve(`${Bd[l]} Keyboard: ${d}`,{duration:1500})},a=(i,c)=>{let l;if(c)l=xa.map(d=>d.value).filter(d=>n.includes(d)||d===i);else{if(n.length<=1)return;l=n.filter(d=>d!==i)}if(o(l),Qs.update("ui",{enabledKeyboardLanguages:l}),!l.includes(e)){const d=l[0];s(d),Qs.update("ui",{keyboardLanguage:d})}};return t.jsx($d,{label:t.jsx(xh,{className:"h-5 w-5"}),onAction:r,variant:"outline",size:"icon",tooltipText:`${Xo[e]} - Click to cycle, hold for settings`,popoverContent:t.jsxs("div",{className:"space-y-3 p-1","data-test":"keyboard-language-panel",children:[t.jsx(je,{className:"text-sm font-medium",children:"Languages to cycle"}),t.jsx("div",{className:"space-y-2",children:xa.map(i=>{const c=n.includes(i.value),l=n.length===1&&c;return t.jsxs("div",{className:"flex items-center space-x-2","data-test":`keyboard-lang-${i.value}`,children:[t.jsx(De,{id:`lang-${i.value}`,checked:c,onCheckedChange:d=>a(i.value,!!d),disabled:l}),t.jsx(je,{htmlFor:`lang-${i.value}`,className:`cursor-pointer ${l?"opacity-50":""}`,children:i.label})]},i.value)})}),t.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t","data-test":"current-language-indicator",children:["Current: ",t.jsx("span",{className:"font-medium",children:Xo[e]}),n.length>1&&t.jsxs("span",{className:"ml-1",children:["(cycling ",n.map(i=>Xo[i]).join(" → "),")"]})]})]})})},eN=[],tN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState("move"),[r,a]=p.useState(null),i=p.useRef(null),c=H(x=>{var w;return((w=x.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??eN}),l=H(x=>{var w;return(w=x.projectCanvas.getActive())==null?void 0:w.id}),d=H(x=>x.copyNodesToCanvas),u=H(x=>x.moveNodesToCanvas),h=c.length===0,f=()=>{if(!h){if(i.current){const x=i.current.getBoundingClientRect();a({x:x.left-320-16,y:Math.max(16,x.top+x.height/2-400/2)})}s(!0)}},g=x=>{const w=c.map(b=>b.id),v={nodeIds:w,targetCanvasId:x.canvasId,targetWorkspaceId:x.workspaceId,targetProjectId:x.projectId};n==="copy"?(d(v),ve.success(`Copied ${w.length} node${w.length>1?"s":""} to "${x.canvasName}"`)):(u(v),ve.success(`Moved ${w.length} node${w.length>1?"s":""} to "${x.canvasName}"`)),s(!1)},y=()=>{s(!1)},m=t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-move-nodes-title",children:[t.jsx(ee,{variant:n==="move"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("move"),"data-test":"canvas-move-nodes-move-option",children:"Move"}),t.jsx(ee,{variant:n==="copy"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("copy"),"data-test":"canvas-move-nodes-copy-option",children:"Copy"}),t.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:[c.length," node",c.length!==1?"s":""]})]});return t.jsxs(t.Fragment,{children:[t.jsx(Xt,{delayDuration:300,children:t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx(ee,{ref:i,variant:"outline",size:"icon",disabled:h,onClick:f,"data-test":"canvas-move-nodes-button",title:"Move/copy nodes",children:t.jsx(wh,{className:"h-5 w-5"})})}),t.jsx($t,{children:t.jsx("p",{children:h?"Select nodes to move/copy":"Move/copy nodes to canvas"})})]})}),t.jsx(ql,{onCanvasSelected:g,excludeCanvasId:l,selectionModeTitle:m,isOpen:e,onClose:y,popoverPosition:r})]})};class sN{constructor(s){Oe(this,"namespace","canvas.collapse");this.hooks=s}getActions(){return[{id:"collapse:all",label:"Collapse all nodes",category:"Collapse",icon:t.jsx(xo,{className:"h-3 w-3"})},{id:"expand:all",label:"Expand all nodes",category:"Collapse",icon:t.jsx(vn,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"collapse:all":this.hooks.collapseAll();break;case"expand:all":this.hooks.expandAll();break;default:console.warn(`CollapseFacade: Unknown action "${s}"`)}}}function nN(){const e=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed||r.updateNode(c.id,{isCollapsed:!0})})},[]),s=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed&&r.updateNode(c.id,{isCollapsed:!1})})},[]),n=p.useMemo(()=>({collapseAll:e,expandAll:s}),[e,s]),o=p.useMemo(()=>new sN(n),[n]);return p.useEffect(()=>(st.register("collapse",{name:"Collapse",getActions:()=>o.getActions()}),tt.register("collapse",o),()=>{st.unregister("collapse"),tt.unregister("collapse")}),[o]),o}const oN=[],aN=10,rN={content:!0,title:!0,id:!1,type:!1,tags:!1},iN=e=>{if(e.title)return e.title;if(typeof e.content=="string"){const s=e.content.split(`
`)[0];return s.length>50?s.substring(0,50)+"...":s||"(empty)"}return"(empty)"},cN=(e,s,n,o)=>{if(!s.trim())return!0;const r=n?s:s.toLowerCase(),a=i=>i?(n?i:i.toLowerCase()).includes(r):!1;if(o.content&&typeof e.content=="string"&&a(e.content)||o.title&&a(e.title)||o.id&&a(e.id)||o.type&&a(e.type))return!0;if(o.tags&&e.tags&&e.tags.length>0){const i=e.tags.map(c=>typeof c=="string"?c:c.title).join(", ");if(a(i))return!0}return!1},lN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),[r,a]=p.useState(""),[i,c]=p.useState(!1),[l,d]=p.useState(rN),[u,h]=p.useState(!1),[f,g]=p.useState([]),[y,m]=p.useState("nodes"),x=p.useRef(null),w=nN(),v=H(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.nodes)??oN}),b=i||l.id||l.type||l.tags||!l.content||!l.title,N=p.useMemo(()=>r.trim()?Object.values(l).some(T=>T)?v.filter(T=>cN(T,r,i,l)):[]:v,[v,r,i,l]),j=p.useMemo(()=>v.filter(A=>A.isCollapsed).length,[v]),k=p.useMemo(()=>v.filter(A=>!A.isCollapsed).length,[v]),S=p.useMemo(()=>f.map(A=>v.find(T=>T.id===A)).filter(A=>A!==void 0).slice(0,5),[f,v]),C=()=>{if(x.current){const A=x.current.getBoundingClientRect();o({x:A.left-360-16,y:Math.max(16,A.top+A.height/2-450/2)})}s(!0)},R=()=>{s(!1),m("nodes")},I=p.useCallback(A=>{g(T=>{const O=T.filter($=>$!==A);return[A,...O].slice(0,aN)})},[]),M=p.useCallback(A=>{const T=E.getState(),O=v.find($=>$.id===A);O&&(T.updateNode(A,{isCollapsed:!O.isCollapsed}),I(A))},[v,I]),W=p.useCallback(()=>{if(r.trim()){const A=E.getState();N.forEach(T=>{T.isCollapsed||(A.updateNode(T.id,{isCollapsed:!0}),I(T.id))})}else w.execute("collapse:all")},[N,r,I,w]),B=p.useCallback(()=>{if(r.trim()){const A=E.getState();N.forEach(T=>{T.isCollapsed&&(A.updateNode(T.id,{isCollapsed:!1}),I(T.id))})}else w.execute("expand:all")},[N,r,I,w]),F=p.useCallback(A=>{Ln(A)},[]),D=y==="recent"?"Recent":t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-collapse-title",children:[t.jsxs(ee,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:W,"data-test":"canvas-collapse-all-button",children:[t.jsx(xo,{className:"h-3 w-3 mr-1"}),"Collapse ",r.trim()?`(${N.length})`:"All"]}),t.jsxs(ee,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:B,"data-test":"canvas-expand-all-button",children:[t.jsx(vn,{className:"h-3 w-3 mr-1"}),"Expand ",r.trim()?`(${N.length})`:"All"]})]}),L=y==="recent"?t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>m("nodes"),title:"Back to Nodes","data-test":"canvas-collapse-back-button",children:t.jsx(Fs,{className:"h-3.5 w-3.5"})}):t.jsx(ee,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>m("recent"),title:"Recent Collapse/Expand History","data-test":"canvas-collapse-recent-button",children:t.jsx(ns,{className:"h-3.5 w-3.5"})});return t.jsxs(t.Fragment,{children:[t.jsx(Xt,{delayDuration:300,children:t.jsxs(Lt,{children:[t.jsx(Wt,{asChild:!0,children:t.jsx(ee,{ref:x,variant:"outline",size:"icon",onClick:C,"data-test":"canvas-collapse-button",title:"Collapse/expand nodes",children:t.jsx(xo,{className:"h-5 w-5"})})}),t.jsx($t,{children:t.jsxs("p",{children:["Collapse/expand nodes (",j," collapsed, ",k," expanded)"]})})]})}),t.jsx(Be,{isVisible:e,onClose:R,title:D,triggerPosition:n??void 0,shouldCloseManually:!0,resizable:!0,initialSize:{width:360,height:450},headerActions:L,children:t.jsx("div",{className:"p-3 space-y-3","data-test":"canvas-collapse-popover-content",children:y==="nodes"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"canvas-collapse-search-section",children:[t.jsx(ms,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"canvas-collapse-search-icon"}),t.jsx(Ae,{type:"text",placeholder:"Search nodes...",value:r,onChange:A=>a(A.target.value),className:we("h-8 text-sm pl-8",r?"pr-16":"pr-10"),autoFocus:!0,"data-test":"canvas-collapse-search-input"}),r&&t.jsx(ee,{variant:"ghost",size:"icon",onClick:()=>a(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"canvas-collapse-clear-button",children:t.jsx(We,{className:"h-3 w-3"})}),b&&t.jsx("div",{className:we("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",r?"right-16":"right-11"),"data-test":"canvas-collapse-filter-indicator"}),t.jsxs(ot,{open:u,onOpenChange:h,children:[t.jsx(at,{asChild:!0,children:t.jsx(ee,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"canvas-collapse-settings-button",children:t.jsx(Ho,{className:"h-3.5 w-3.5"})})}),t.jsx(rt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:ke.draggablePopoverDropdown},"data-test":"canvas-collapse-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:"collapse-case-sensitive",checked:i,onCheckedChange:A=>c(!!A),"data-test":"canvas-collapse-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"collapse-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsx("div",{className:"space-y-1.5",children:Object.entries({content:"Content",title:"Title",id:"ID",type:"Type",tags:"Tags"}).map(([A,T])=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(De,{id:`collapse-node-${A}`,checked:l[A],onCheckedChange:O=>d($=>({...$,[A]:!!O})),"data-test":`canvas-collapse-${A}-checkbox`}),t.jsx("label",{htmlFor:`collapse-node-${A}`,className:"text-sm cursor-pointer",children:T})]},A))})]})]})})]})]}),t.jsxs("div",{className:"stats-section flex items-center gap-2 text-xs text-muted-foreground","data-test":"canvas-collapse-stats",children:[t.jsxs(qe,{variant:"secondary","data-test":"canvas-collapse-collapsed-count",children:[j," collapsed"]}),t.jsxs(qe,{variant:"outline","data-test":"canvas-collapse-expanded-count",children:[k," expanded"]}),r.trim()&&t.jsxs("span",{"data-test":"canvas-collapse-filtered-count",children:["(",N.length," matching)"]})]}),t.jsxs("div",{className:"nodes-list-section space-y-1","data-test":"canvas-collapse-nodes-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:r.trim()?`Results (${N.length})`:`All Nodes (${v.length})`}),t.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1","data-test":"canvas-collapse-nodes-list",children:[N.map(A=>t.jsx(Zi,{node:A,onToggle:()=>M(A.id),onClick:()=>F(A)},A.id)),N.length===0&&r.trim()&&t.jsx("p",{className:"text-xs text-muted-foreground py-2 text-center","data-test":"canvas-collapse-no-results",children:"No nodes found"})]})]})]}):t.jsx("div",{className:"recent-view-section space-y-1","data-test":"canvas-collapse-recent-view",children:S.length>0?t.jsx("div",{className:"max-h-[350px] overflow-y-auto space-y-1","data-test":"canvas-collapse-recent-list",children:S.map(A=>t.jsx(Zi,{node:A,onToggle:()=>M(A.id),onClick:()=>F(A)},A.id))}):t.jsx("p",{className:"text-xs text-muted-foreground py-8 text-center","data-test":"canvas-collapse-recent-empty",children:"No recent collapse/expand history"})})})})]})},Zi=({node:e,onToggle:s,onClick:n})=>{const o=Vo(e.type),r=iN(e),a=e.id.substring(0,6);return t.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded hover:bg-accent/50 group","data-test":`canvas-collapse-node-item-${e.id}`,children:[t.jsx(ee,{variant:"ghost",size:"icon",className:"h-4 w-4 flex-shrink-0",onClick:i=>{i.stopPropagation(),s()},title:e.isCollapsed?"Expand":"Collapse","data-test":`canvas-collapse-toggle-${e.id}`,children:e.isCollapsed?t.jsx(Ks,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(Et,{className:"h-3.5 w-3.5"})}),t.jsxs("div",{className:"flex-1 flex items-center gap-1.5 cursor-pointer min-w-0",onClick:n,"data-test":`canvas-collapse-node-info-${e.id}`,children:[o&&t.jsx("span",{className:"flex-shrink-0 text-muted-foreground",children:o}),t.jsx("span",{className:"text-xs truncate flex-1",children:r}),t.jsx("span",{className:"text-[10px] text-muted-foreground flex-shrink-0",children:a})]}),e.isCollapsed&&t.jsx(qe,{variant:"secondary",className:"text-[9px] px-1 py-0 h-4","data-test":`canvas-collapse-badge-${e.id}`,children:"collapsed"})]})},Ji=[],dN=[],uN=({isVisible:e,onClose:s})=>{const n=H(g=>{var y;return((y=g.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??Ji}),o=H(g=>{var y;return((y=g.projectCanvas.getActive())==null?void 0:y.coreState.nodes)??Ji}),r=H(g=>{var y;return((y=g.projectCanvas.getActive())==null?void 0:y.coreState.arrows)??dN});H(g=>{var y;return(y=g.preferences)==null?void 0:y.canvasConfig});const a=H(g=>g.updateNode),i=n.length>0,c=p.useMemo(()=>i?Zc(r,n):r,[i,n,r]),l=p.useCallback(g=>Jc({includeConfig:g}),[]),d=p.useMemo(()=>{const g=Math.round(window.innerWidth*.85),y=Math.round(window.innerHeight*.85),m=Math.round((window.innerWidth-g)/2),x=Math.round((window.innerHeight-y)/2);return{initialSize:{width:g,height:y},triggerPosition:{x:m,y:x}}},[]),u=p.useCallback(g=>{const y=Array.isArray(g)?g:g.nodes;Array.isArray(y)&&y.forEach(m=>{m&&m.id&&a(m.id,m)})},[a]),h=c.length,f=i?`Selected Nodes (${n.length})${h>0?` + Arrows (${h})`:""}`:`All Canvas (${o.length} nodes, ${r.length} arrows)`;return t.jsx(Oo,{storageKey:"json-viewer-config",initialConfig:{includeCanvasConfig:!1},children:(g,y,m)=>{const x=l(g.includeCanvasConfig),w={nodes:[]},v=()=>{x&&Qc(x)};return t.jsx(Be,{isVisible:e,onClose:s,title:f,resizable:!0,initialSize:d.initialSize,shouldCloseManually:!0,triggerPosition:d.triggerPosition,headerActions:t.jsxs("div",{className:"flex items-center gap-1","data-test":"json-viewer-header-actions",children:[t.jsx(m,{title:"JSON Viewer Settings",contentClassName:"w-64",contentStyle:{zIndex:ke.draggablePopoverDropdown},children:t.jsxs("div",{className:"flex items-center space-x-2","data-test":"include-canvas-config-option",children:[t.jsx(De,{id:"includeCanvasConfig",checked:g.includeCanvasConfig,onCheckedChange:b=>y(N=>({...N,includeCanvasConfig:!!b})),"data-test":"include-canvas-config-checkbox"}),t.jsx(je,{htmlFor:"includeCanvasConfig",className:"text-xs cursor-pointer",children:"Include Canvas configuration"})]})}),t.jsx("button",{type:"button",className:"p-1 rounded hover:bg-accent transition-colors",onClick:b=>{b.stopPropagation(),v()},onMouseDown:b=>b.stopPropagation(),"aria-label":"Copy JSON",title:"Copy","data-test":"json-viewer-copy-button",children:t.jsx(Mt,{size:14})})]}),children:t.jsx(Vc,{data:x??w,onDataChange:u})})}})},hN=()=>{const[e,s]=p.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsx(ee,{variant:"outline",size:"icon",onClick:()=>s(!0),"data-test":"canvas-json-viewer-button",title:"View JSON Data",children:t.jsx(Fo,{className:"h-5 w-5"})}),t.jsx(uN,{isVisible:e,onClose:()=>s(!1)})]})},pN=[],gN=()=>{const e=H(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.coreState.layers)??pN}),s=H(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.coreState.activeLayerId)??null}),n=H(m=>m.layer),o=p.useMemo(()=>e.length===0?[yc()]:[...e].sort((m,x)=>x.order-m.order),[e]),r=p.useCallback((m,x,w)=>{m.stopPropagation(),n.setVisibility(x,!w)},[n]),a=p.useMemo(()=>o.map(m=>({id:m.id,label:m.name,icon:m.isLocked?t.jsx(Na,{className:"h-3 w-3 text-muted-foreground"}):t.jsx("button",{onClick:x=>r(x,m.id,m.isVisible),className:"hover:text-foreground transition-colors","data-test":`layer-visibility-toggle-${m.id}`,title:m.isVisible?"Hide layer":"Show layer",children:m.isVisible?t.jsx(os,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"}):t.jsx(Rs,{className:"h-3 w-3 text-muted-foreground/50 hover:text-foreground"})}),data:{type:"layer",...m}})),[o,r]),i=m=>{n.setActive(m.id)},c=(m,x)=>{n.rename(m,x)},l=m=>{n.delete(m)},d=m=>{const x=m.length;m.forEach((w,v)=>{const b=x-1-v;n.reorder(w.id,b)})},u=m=>`Delete layer "${m.label}"? Nodes will be moved to the layer below.`,h=m=>{const x=m.data;return x?[{id:"toggle-visibility",label:x.isVisible?"Hide Layer":"Show Layer",icon:x.isVisible?t.jsx(Rs,{className:"h-4 w-4 mr-2"}):t.jsx(os,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setVisibility(x.id,!x.isVisible)}},{id:"toggle-lock",label:x.isLocked?"Unlock Layer":"Lock Layer",icon:x.isLocked?t.jsx(_c,{className:"h-4 w-4 mr-2"}):t.jsx(Na,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setLocked(x.id,!x.isLocked)}},{id:"duplicate",label:"Duplicate Layer",icon:t.jsx(Mt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(x.id)}},{id:"merge-down",label:"Merge Down",icon:t.jsx(vh,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.mergeDown(x.id)}}]:null},f=()=>{n.create()},g=p.useCallback((m,x)=>{n.setOpacity(m,x)},[n]),y=p.useCallback((m,x,w,v)=>{const b=m.data;return b?t.jsxs("div",{"data-test":`layer-item-with-opacity-${m.id}`,children:[v,t.jsxs("div",{className:"flex items-center gap-1 px-2 py-0 mt-1 ml-8 opacity-50 hover:opacity-100 transition-opacity","data-test":`layer-opacity-row-${m.id}`,children:[t.jsx(yh,{className:"h-2 w-2 text-muted-foreground/60 flex-shrink-0"}),t.jsx(Vt,{value:[b.opacity],onValueChange:([N])=>g(m.id,N),min:0,max:100,step:1,className:"flex-1 [&>span:first-child]:h-0.5 [&>span:first-child>span]:bg-muted-foreground/40 [&_[role=slider]]:h-2 [&_[role=slider]]:w-2","data-test":`layer-opacity-slider-${m.id}`}),t.jsxs("span",{className:"text-[9px] text-muted-foreground/60 w-6 text-right","data-test":`layer-opacity-value-${m.id}`,children:[b.opacity,"%"]})]})]}):v},[g]);return t.jsxs("div",{className:"layer-manager flex flex-col h-full","data-test":"canvas-layer-manager",children:[t.jsx($s,{className:"layer-list flex-1 min-h-0","data-test":"layer-list-scroll-area",children:t.jsx("div",{className:"layer-tree-container p-2","data-test":"layer-tree-container",children:t.jsx(_s,{data:a,onItemClick:i,onUpdate:c,onDelete:e.length>1?l:void 0,onReorder:d,selectedId:s,deleteConfirmMessage:u,enableEdit:!0,enableDelete:e.length>1,enableDrag:!0,moreOptionsItems:h,dropdownZIndex:ke.draggablePopoverDropdown,renderNode:y})})}),t.jsx("div",{className:"layer-actions border-t p-2","data-test":"layer-actions",children:t.jsxs(ee,{variant:"outline",size:"sm",className:"w-full",onClick:f,"data-test":"layer-add-button",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"}),"Add Layer"]})})]})},fN=180,mN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=()=>{if(e){s(!1);return}if(r.current){const i=r.current.getBoundingClientRect(),c=280,l=350,d=i.left+i.width/2,u=i.top+i.height/2;o({x:d-c/2-fN,y:u-l/2})}s(!0)};return t.jsxs(t.Fragment,{children:[t.jsx(as,{ref:r,variant:"secondary",size:"sm",tooltip:"Manage layers",onClick:a,className:"canvas-layer-button","data-test":"canvas-layer-button",children:t.jsx(Pn,{className:"h-4 w-4"})}),t.jsx(Be,{isVisible:e,onClose:()=>s(!1),title:"Layers",resizable:!0,initialSize:{width:280,height:350},triggerPosition:n??void 0,children:t.jsx(gN,{})})]})},xN=({onSessionSelect:e})=>{const{sessions:s,loadingSessions:n,sessionsError:o,pagination:r,currentPage:a,searchSessions:i,refreshSessions:c,handlePageChange:l,handleLoadMore:d}=_d({loadOnMount:!1,subscribeToSSE:!1}),[u,h]=p.useState(null),[f,g]=p.useState(!1),{messages:y,sessionDetails:m,metadata:x,loading:w,pagination:v,loadOlderMessages:b,searchMessages:N,refreshSession:j,addOptimisticMessage:k,removeOptimisticMessage:S}=zd(u,{loadOnMount:!0,subscribeToSSE:!0}),C=400,R=-240,I=p.useMemo(()=>{const L=Math.round(window.innerWidth*.6),A=Math.round(window.innerHeight*.8),$=window.innerWidth-30+R-L,_=Math.round((window.innerHeight-A)/2);return{size:{width:L,height:A},position:{x:$,y:_}}},[R]),M=L=>{h(L),g(!0),e==null||e(L)},W=()=>{g(!1)},B=async(L,A)=>{try{const T=await ya.searchMessages(L,A);console.log("Message search results:",T)}catch(T){console.error("Message search failed:",T)}},F=async(L,A)=>{await N(L,A)},D=t.jsx(Wh,{sessions:s,loading:n,error:o,onSessionSelect:M,selectedSessionId:u,onRefresh:c,pagination:r,currentPage:a,onPageChange:l,onLoadMore:d,onSearch:i,onMessageSearch:B});return t.jsxs(t.Fragment,{children:[t.jsx(Zs,{popoverId:"claude-sessions",icon:bh,tooltip:"Claude Sessions",popoverTitle:"Claude Sessions",popoverContent:D,initialSize:{width:C,height:600},leftOffset:R,resizable:!0,dataTest:"canvas-claude-session-button"}),t.jsx(Be,{isVisible:f,onClose:W,title:(m==null?void 0:m.customName)??(m==null?void 0:m.name)??"Chat",shouldCloseManually:!0,resizable:!0,initialSize:I.size,initialPosition:I.position,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"claude-chat-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-auto","data-test":"claude-chat-messages-area",children:t.jsx(Ud,{messages:y,sessionDetails:m,metadata:x,loading:w,pagination:v,onLoadOlder:b,onSearch:F,onNameUpdated:j})}),u&&t.jsx("div",{className:"border-t p-2","data-test":"claude-chat-input-area",children:t.jsx(Vd,{sessionId:u,onSendSuccess:()=>{j()},onAddOptimisticMessage:k,onRemoveOptimisticMessage:S})})]})})]})},wN=e=>{const{className:s}=e,{history:n,lastAction:o,executeLastAction:r,hasExecutor:a}=rr(),i=o&&a(o.executorId),c=p.useCallback(()=>{i&&r()},[i,r]),l=n.length>0;return t.jsx(En,{expandTitle:"Actions & Presets",expandContent:t.jsx(Tl,{}),onClick:c,disabled:!l,variant:"outline",size:"icon",className:s,popoverSize:{width:300,height:380},title:o?`Repeat: ${o.label}`:"No action to repeat",dataTest:"canvas-repeat-action-button",headerActions:t.jsx(El,{}),children:t.jsx(Bo,{className:"h-5 w-5"})})},Qi=380,ec=360,tc=e=>{const{className:s}=e,[n,o]=p.useState(!1),[r,a]=p.useState(void 0),i=H(d=>d.setActiveGlobalOverlay),c=()=>{i(hs.STUDY)},l=d=>{const u=d.currentTarget.getBoundingClientRect();a({x:u.left-ec-16,y:(window.innerHeight-Qi)/2}),o(!0)};return t.jsxs(t.Fragment,{children:[t.jsxs(Go,{position:"right",className:s,children:[t.jsx(Qb,{}),t.jsx(hN,{}),t.jsx(tN,{}),t.jsx(lN,{}),t.jsx(mN,{}),t.jsx(xN,{}),t.jsx(Jb,{}),t.jsx(wN,{}),t.jsx(ee,{variant:"outline",size:"icon",onClick:c,title:"Enter Study Mode","data-test":"mobile-right-toolbar-study-mode",children:t.jsx(Nh,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:l,"data-test":"mobile-right-toolbar-settings",title:"Settings",children:t.jsx(Mn,{className:"h-5 w-5"})})]}),t.jsx(Be,{isVisible:n,onClose:()=>o(!1),title:"Canvas Settings",resizable:!0,initialSize:{width:ec,height:Qi},shouldCloseManually:!0,triggerPosition:r,headerActions:t.jsx("button",{type:"submit",form:"canvas-settings-form",className:"p-1 rounded hover:bg-accent transition-colors",onClick:d=>d.stopPropagation(),onMouseDown:d=>d.stopPropagation(),"aria-label":"Save settings",title:"Save","data-test":"canvas-settings-save-button",children:t.jsx(qt,{size:14})}),children:t.jsx(qb,{})})]})},yN=e=>{const{className:s}=e,n=H(c=>c.setActiveGlobalOverlay),o=()=>{n(hs.NONE)},r=()=>{console.log("Previous card")},a=()=>{console.log("Next card")},i=()=>{console.log("Flip card")};return t.jsxs(Go,{position:"right",className:s,children:[t.jsx(ee,{variant:"outline",size:"icon",onClick:o,title:"Exit Study Mode","data-test":"study-mode-exit-button",children:t.jsx(We,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:r,title:"Previous Card","data-test":"study-mode-prev-button",children:t.jsx(Sh,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:a,title:"Next Card","data-test":"study-mode-next-button",children:t.jsx(Ks,{className:"h-5 w-5"})}),t.jsx(ee,{variant:"outline",size:"icon",onClick:i,title:"Flip Card","data-test":"study-mode-flip-button",children:t.jsx(Ch,{className:"h-5 w-5"})})]})},vN=()=>{switch(H(s=>s.uiState.activeGlobalOverlay)){case hs.STUDY:return{right:t.jsx(yN,{})};case hs.PAIRING:return{right:t.jsx(tc,{})};case hs.NONE:default:return{right:t.jsx(tc,{})}}},bN=5,sc=[];function NN({items:e,onSelect:s,placeholder:n="Search...",getGroup:o,storageKey:r,maxRecentItems:a=bN,enablePinning:i=!1,openShortcut:c,repeatLastShortcut:l,renderItem:d,renderEmpty:u,open:h,onOpenChange:f,"data-test":g="general-command-palette"}){const[y,m]=p.useState(!1),x=h!==void 0,w=x?h:y,v=p.useCallback(P=>{x||m(P),f==null||f(P)},[x,f]),[b,N]=p.useState(""),[j,k]=p.useState(""),S=`${r}-recently-used`,C=`${r}-search-options`,[R,I]=p.useState(()=>{try{const P=localStorage.getItem(S);return P?JSON.parse(P):[]}catch{return[]}}),[M,W]=p.useState(()=>{try{const P=localStorage.getItem(C);return P?JSON.parse(P):{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}catch{return{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}}),B=p.useCallback(P=>{W(P);try{localStorage.setItem(C,JSON.stringify(P))}catch{}},[C]),F=H(p.useCallback(P=>{var z,U;return i?((U=(z=P.preferences)==null?void 0:z.pinnedPaletteItems)==null?void 0:U[r])??sc:sc},[i,r])),D=p.useMemo(()=>i?F.map(P=>e.find(z=>z.id===P)).filter(P=>P!==void 0):[],[i,F,e]),L=p.useCallback(P=>i?F.includes(P):!1,[i,F]),A=p.useCallback((P,z)=>{z&&(z.stopPropagation(),z.preventDefault()),i&&E.getState().togglePinPaletteItem(r,P)},[i,r]),T=p.useMemo(()=>Gd(M),[M]),{navigateResults:O}=Yd(b,N),$=p.useMemo(()=>{const P={};return e.forEach(z=>{const U=o?o(z):z.group??"General";P[U]||(P[U]=[]),P[U].push(z)}),P},[e,o]),_=p.useMemo(()=>R.filter(P=>!F.includes(P)).map(P=>e.find(z=>z.id===P)).filter(P=>P!==void 0),[R,e,F]),G=p.useCallback(P=>{v(!1),k(""),s(P),I(z=>{const U=z.filter(re=>re!==P.id),K=[P.id,...U].slice(0,a);try{localStorage.setItem(S,JSON.stringify(K))}catch{}return K})},[v,s,a,S]);p.useEffect(()=>{const P=[];if(c){const z=vr.register({key:c.key,ctrlKey:c.ctrl,altKey:c.alt,metaKey:c.meta,preventDefault:!0,callback:()=>v(!w)});P.push(z)}if(l&&R.length>0){const z=vr.register({key:l.key,ctrlKey:l.ctrl,altKey:l.alt,metaKey:l.meta,preventDefault:!0,callback:()=>{const U=R[0],K=e.find(re=>re.id===U);K&&s(K)}});P.push(z)}return()=>{P.forEach(z=>z())}},[c,l,w,v,R,e,s]),p.useEffect(()=>{if(!w)return;const P=z=>{if(i&&z.key==="Enter"&&z.ctrlKey){z.preventDefault(),z.stopPropagation();const ne=b.split("-");let V;ne[0]==="recent"||ne[0]==="pinned"?V=ne[1]:V=ne[0],V&&A(V);return}if(z.key!=="ArrowUp"&&z.key!=="ArrowDown")return;const U=Array.from(document.querySelectorAll("[cmdk-item]")).filter(ne=>ne.getAttribute("data-disabled")!=="true");if(U.length===0)return;const K=U.map(ne=>ne.getAttribute("data-value")||""),re=K.indexOf(b);z.key==="ArrowUp"&&re<=0?(z.preventDefault(),z.stopPropagation(),N(K[U.length-1])):z.key==="ArrowDown"&&re>=U.length-1&&(z.preventDefault(),z.stopPropagation(),N(K[0]))};return document.addEventListener("keydown",P,{capture:!0}),()=>document.removeEventListener("keydown",P,{capture:!0})},[w,b,i,A]);const X=P=>t.jsxs("div",{className:"flex justify-between items-center w-full","data-test":`${g}-item-content-${P.id}`,children:[t.jsxs("div",{className:"flex flex-col","data-test":`${g}-item-text-${P.id}`,children:[t.jsx("span",{"data-test":`${g}-item-label-${P.id}`,children:P.label}),P.description&&t.jsx("span",{className:"text-xs text-muted-foreground","data-test":`${g}-item-description-${P.id}`,children:P.description})]}),P.shortcut&&t.jsx("kbd",{className:"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground","data-test":`${g}-item-shortcut-${P.id}`,children:P.shortcut})]}),J=P=>{const z=L(P.id),U=d?d(P):X(P);return i?t.jsxs("div",{className:"flex items-center w-full group","data-test":`${g}-item-wrapper-${P.id}`,children:[t.jsx("div",{className:"flex-1 min-w-0",children:U}),t.jsx(ee,{type:"button",variant:"ghost",size:"smIcon",onClick:K=>A(P.id,K),className:`shrink-0 ${z?"opacity-100":"opacity-0 group-hover:opacity-100"}`,title:z?"Unpin (Ctrl+Enter)":"Pin (Ctrl+Enter)","data-test":`${g}-pin-button-${P.id}`,children:z?t.jsx(Hc,{className:"text-muted-foreground","data-test":`${g}-pin-icon-off-${P.id}`}):t.jsx(Bc,{className:"text-muted-foreground","data-test":`${g}-pin-icon-${P.id}`})})]}):U};return t.jsxs(Kd,{open:w,onOpenChange:v,value:b,onValueChange:N,filter:T,"data-test":`${g}-dialog`,children:[t.jsx(Xd,{placeholder:n,initialOptions:M,onSearchOptionsChange:B,onSearchChange:k,onNavigate:O}),t.jsxs(qd,{"data-test":`${g}-list`,children:[t.jsx(Zd,{"data-test":`${g}-empty`,children:u?u():"No results found."}),i&&D.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(qo,{heading:"Pinned","data-test":`${g}-group-pinned`,children:D.map(P=>t.jsx(Zo,{value:`pinned-${P.id}-${P.label}`,onSelect:()=>G(P),"data-test":`${g}-item-pinned-${P.id}`,children:J(P)},`pinned-${P.id}`))}),t.jsx(Jo,{"data-test":`${g}-separator-pinned`})]}),_.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(qo,{heading:"Recently Used","data-test":`${g}-group-recent`,children:_.map(P=>t.jsx(Zo,{value:`recent-${P.id}-${P.label}`,onSelect:()=>G(P),"data-test":`${g}-item-recent-${P.id}`,children:J(P)},`recent-${P.id}`))}),t.jsx(Jo,{"data-test":`${g}-separator-recent`})]}),Object.entries($).map(([P,z],U)=>t.jsxs("div",{"data-test":`${g}-group-container-${P.toLowerCase().replace(/\s+/g,"-")}`,children:[U>0&&t.jsx(Jo,{"data-test":`${g}-separator-${P.toLowerCase().replace(/\s+/g,"-")}`}),t.jsx(qo,{heading:P,"data-test":`${g}-group-${P.toLowerCase().replace(/\s+/g,"-")}`,children:z.map(K=>t.jsx(Zo,{value:`${K.id}-${K.label}-${K.description||""}`,onSelect:()=>G(K),"data-test":`${g}-item-${K.id}`,children:J(K)},K.id))})]},P))]})]})}const SN=({open:e,onOpenChange:s})=>{const n=H(l=>{var d;return((d=l.state)==null?void 0:d.projects)??{}}),o=H(l=>{var d;return(d=l.state)==null?void 0:d.activeProjectId}),r=p.useMemo(()=>{const l=[];for(const[d,u]of Object.entries(n))for(const[h,f]of Object.entries(u.workspaces))for(const[g,y]of Object.entries(f.canvases))y.hideFromSearch||l.push({id:g,label:y.name,description:`${u.name} / ${f.name}`,projectId:d,workspaceId:h,canvasId:g,projectName:u.name,workspaceName:f.name});return l.sort((d,u)=>{if(d.projectId===o&&u.projectId!==o)return-1;if(u.projectId===o&&d.projectId!==o)return 1;const h=d.projectName.localeCompare(u.projectName);if(h!==0)return h;const f=d.workspaceName.localeCompare(u.workspaceName);return f!==0?f:d.label.localeCompare(u.label)}),l},[n,o]),a=p.useCallback(l=>{E.getState().projectCanvas.switch(l.canvasId)},[]),i=p.useCallback(l=>t.jsxs("div",{className:"flex items-center gap-1.5 w-full min-w-0","data-test":`canvas-picker-item-${l.id}`,children:[t.jsx(Pn,{className:"!h-3 !w-3 text-muted-foreground shrink-0"}),t.jsx("span",{className:"shrink-0 font-medium","data-test":`canvas-picker-item-label-${l.id}`,children:l.label}),t.jsxs("span",{className:"text-xs text-muted-foreground truncate",title:`${l.projectName} / ${l.workspaceName} / ${l.label}`,"data-test":`canvas-picker-item-path-${l.id}`,children:[l.projectName," / ",l.workspaceName," / ",l.label]})]}),[]),c=p.useCallback(()=>t.jsxs("div",{className:"text-center py-4","data-test":"canvas-picker-empty",children:[t.jsx("p",{className:"text-muted-foreground",children:"No canvases found."}),t.jsx("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Create a canvas to get started."})]}),[]);return t.jsx(NN,{items:r,onSelect:a,placeholder:"Search canvases...",storageKey:"canvas-picker-palette",maxRecentItems:10,enablePinning:!0,openShortcut:{key:"p",ctrl:!0},renderItem:i,renderEmpty:c,open:e,onOpenChange:s,"data-test":"canvas-picker-palette"})};function nc(e,s){const{selected:n}=s;if(e==="selected")return n.map(o=>o.content??"").filter(o=>String(o).trim()).join(`
`);if(e.startsWith("selected[")){const o=Ar(e,{selected:n});return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}if(e.startsWith("selected.")){const o=e.slice(9);return n.map(r=>{const a={node:r},i=Ar(`node.${o}`,a);return i==null?"":typeof i=="object"?JSON.stringify(i):String(i)}).filter(r=>String(r).trim()).join(`
`)}return""}function CN({formulas:e,inputRef:s,onFormulaExecute:n,getSelectedNodes:o,fieldCompletions:r=[]}){const[a,i]=p.useState(!1),[c,l]=p.useState(""),[d,u]=p.useState(0),[h,f]=p.useState(null),[g,y]=p.useState({top:0,left:0}),[m,x]=p.useState("formula"),[w,v]=p.useState(null),b=p.useMemo(()=>{if(m==="field"){const I=c.toLowerCase();return r.filter(M=>!I||M.field.toLowerCase().startsWith(I)||M.name.toLowerCase().includes(I)).map(M=>({id:M.id,name:M.name,trigger:M.field,description:M.description}))}if(!c)return e;const R=c.toLowerCase();return e.filter(I=>I.trigger.toLowerCase().startsWith(R)||I.name.toLowerCase().includes(R))},[e,r,c,m]);p.useMemo(()=>{u(0)},[b.length]);const N=p.useCallback(()=>{i(!1),l(""),f(null),u(0),x("formula"),v(null)},[]),j=p.useCallback(R=>{const I=Qh(R);if(I){const M=R.getBoundingClientRect(),W=window.getComputedStyle(R),B=parseInt(W.lineHeight||W.fontSize)||20;y({top:M.top+I.top-B-se.slashCommand.menuGapAboveInput,left:M.left+I.left})}},[]),k=p.useCallback(R=>{var _,G,X,J,P,z;const I=s.current;if(!I||h===null)return;const M=I.selectionStart??0,W=I.value,B={query:c,fullText:W,cursorPosition:M,equalPosition:h};if(m==="field"&&w){const U=`${w}.${R.trigger}`;let K;if(o){const q=o();K=nc(U,{selected:q})}else K="";const re=K??"",ne=W.substring(0,h),V=W.substring(M),oe=ne+re+V,le=((_=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:_.set)||((G=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:G.set);le&&(le.call(I,oe),I.dispatchEvent(new Event("input",{bubbles:!0})));const Z=h+re.length;I.setSelectionRange(Z,Z),n==null||n({...R,trigger:U},K),N();return}if(R.insertTrigger){const U=`=${R.trigger}`,K=W.substring(0,h),re=W.substring(M),ne=K+U+re,V=((X=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:X.set)||((J=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:J.set);V&&(V.call(I,ne),I.dispatchEvent(new Event("input",{bubbles:!0})));const oe=h+U.length;I.setSelectionRange(oe,oe),N();return}let F;if(R.onSelect)F=R.onSelect(B);else if(o){const U=o();F=nc(R.trigger,{selected:U})}else F="";const D=F??"",L=W.substring(0,h),A=W.substring(M),T=L+D+A,O=((P=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:P.set)||((z=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:z.set);O&&(O.call(I,T),I.dispatchEvent(new Event("input",{bubbles:!0})));const $=h+D.length;I.setSelectionRange($,$),n==null||n(R,F),N()},[s,h,c,m,w,n,o,N]),S=p.useCallback(R=>{const I=R.currentTarget,M=I.selectionStart??0,W=I.value;if(R.key==="="&&!a){const B=M>0?W[M-1]:"";(M===0||/\s/.test(B))&&(j(I),f(M),i(!0),l(""),u(0),x("formula"),v(null));return}if(R.key==="."&&!a&&r.length>0){let B=-1;for(let F=M-1;F>=0;F--){if(W[F]==="="){const D=F>0?W[F-1]:"";if(F===0||/\s/.test(D)){B=F;break}}if(/\s/.test(W[F]))break}if(B>=0){const F=W.substring(B+1,M);e.find(L=>L.insertTrigger&&L.trigger===F)&&(j(I),f(B),i(!0),l(""),u(0),x("field"),v(F))}return}a&&(R.key==="ArrowDown"?(R.preventDefault(),u(B=>B<b.length-1?B+1:0)):R.key==="ArrowUp"?(R.preventDefault(),u(B=>B>0?B-1:b.length-1)):R.key==="Enter"||R.key==="Tab"?b.length>0&&(R.preventDefault(),k(b[d])):R.key==="Escape"&&(R.preventDefault(),N()))},[a,b,d,k,N,j,e,r.length]),C=p.useCallback(R=>{if(!a||h===null)return;if(h>=R.length||R[h]!=="="){N();return}const I=s.current,M=(I==null?void 0:I.selectionStart)??R.length;if(m==="field"){const W=h+1+((w==null?void 0:w.length)??0);if(M<=W||R[W]!=="."){N();return}const B=R.substring(W+1,M);if(B.includes(" ")){N();return}l(B)}else{const W=R.substring(h+1,M);if(W.includes(" ")){N();return}l(W)}},[a,h,m,w,s,N]);return{isOpen:a,query:c,filteredFormulas:b,selectedIndex:d,handleKeyDown:S,handleChange:C,selectFormula:k,close:N,menuPosition:g,isFieldMode:m==="field"}}const Jl=({formulas:e,selectedIndex:s,position:n,onSelect:o,onClose:r,triggerPrefix:a="="})=>{const i=p.useRef(null),c=p.useRef(null);p.useEffect(()=>{var d;(d=c.current)==null||d.scrollIntoView({block:"nearest"})},[s]),p.useEffect(()=>{const d=u=>{i.current&&!i.current.contains(u.target)&&r()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[r]);const l=t.jsx("div",{ref:i,"data-test":"formula-menu",className:we("fixed min-w-[200px] max-w-[300px]","rounded-md border bg-popover p-1 shadow-md",e.length>0&&"max-h-[200px] overflow-y-auto"),style:{top:n.top,left:n.left,zIndex:ke.slashCommandMenu,transform:"translateY(-100%)"},children:e.length===0?t.jsx("div",{"data-test":"formula-menu-empty",className:"py-2 px-2 text-sm text-muted-foreground text-center",children:"No formulas found"}):e.map((d,u)=>t.jsxs("div",{ref:u===s?c:void 0,"data-test":`formula-item-${d.id}`,className:we("flex items-center gap-2 rounded-sm px-2 py-1.5 text-sm cursor-pointer","select-none outline-none",u===s?"bg-accent text-accent-foreground":"hover:bg-accent/50"),onClick:()=>o(d),children:[d.icon&&t.jsx("span",{"data-test":`formula-icon-${d.id}`,className:"flex-shrink-0 w-4 h-4",children:d.icon}),t.jsxs("div",{"data-test":`formula-content-${d.id}`,className:"flex flex-col flex-1 min-w-0",children:[t.jsxs("span",{"data-test":`formula-name-${d.id}`,className:"font-medium truncate",children:[a,d.trigger]}),d.description&&t.jsx("span",{"data-test":`formula-description-${d.id}`,className:"text-xs text-muted-foreground truncate",children:d.description})]})]},d.id))});return Ys.createPortal(l,document.body)};Jl.displayName="FormulaMenu";const jN=[{id:"selected",name:"Selected Nodes",trigger:"selected",description:"Access selected nodes",insertTrigger:!0}],kN=[{id:"content",name:"content",field:"content",description:"Node content text"},{id:"title",name:"title",field:"title",description:"Node title"},{id:"id",name:"id",field:"id",description:"Node ID"}];var Pt=(e=>(e.DEFAULT="default",e.CLAUDE="claude",e))(Pt||{});const AN={default:"",claude:"Claude"};function IN({content:e,srcLang:s,toLang:n}){return`Translate the following text from ${s} to ${n}: \`${e}\``}const oc={ENGLISH:"English",VIETNAMESE:"Vietnamese"},TN=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??Ha},EN=({onSend:e,placeholder:s="Type a message...",disabled:n=!1})=>{const[o,r]=p.useState(""),[a,i]=p.useState(Pt.DEFAULT),[c,l]=p.useState(null),[d,u]=p.useState(!1),[h,f]=p.useState(!0),[g,y]=p.useState(!1),[m,x]=p.useState(null),w=p.useRef(null),v=p.useRef(null),b=p.useRef(null),N=p.useRef(0),j=p.useRef(null),k=p.useRef(null),S=H(q=>{var Y;return((Y=q.uiState)==null?void 0:Y.isOverlayVisible)??!0}),C=H(Me.selectSelectedNodes),R=H(q=>{var Y;return((Y=q.uiState)==null?void 0:Y.dragInfo)!==null}),I=co(TN);p.useEffect(()=>{if(C.length===1){const Y=C[0].data;if(Y!=null&&Y.sessionId){i(Pt.CLAUDE),l(Y.sessionId);const te=Y.role!=="assistant";f(te);return}}else k.current=null},[C,R]),p.useEffect(()=>{var q;v.current=((q=w.current)==null?void 0:q.getTextArea())??null}),p.useEffect(()=>{const q=()=>{var Y,te;(te=(Y=w.current)==null?void 0:Y.getTextArea())==null||te.focus()};return window.addEventListener("focus",q),()=>window.removeEventListener("focus",q)},[]);const M=p.useCallback(()=>{var q;return((q=E.getState().projectCanvas.getActive())==null?void 0:q.coreState.selectedNodes)??[]},[]),W=p.useMemo(()=>[{id:"claude",name:"Claude",trigger:"claude",description:"Send to Claude AI",onSelect:()=>(i(Pt.CLAUDE),"")},{id:"claude-project-select",name:"Claude Project Select",trigger:"claude project select",description:"Select Claude project for next message",onSelect:()=>(y(!0),i(Pt.CLAUDE),"")},{id:"translate-selected",name:"Translate Selected",trigger:"translate selected",description:"Translate selected node content",onSelect:()=>{var ae;const Y=((ae=M()[0])==null?void 0:ae.content)??"";return Y?IN({content:Y,srcLang:oc.ENGLISH,toLang:oc.VIETNAMESE}):(ve.warning("No content selected",{description:"Select a node with content first"}),"")}}],[c,g,m,M]),{isOpen:B,filteredCommands:F,selectedIndex:D,handleKeyDown:L,handleChange:A,selectCommand:T,close:O,menuPosition:$}=Zh({commands:W,inputRef:v}),{isOpen:_,filteredFormulas:G,selectedIndex:X,handleKeyDown:J,handleChange:P,selectFormula:z,close:U,menuPosition:K,isFieldMode:re}=CN({formulas:jN,inputRef:v,getSelectedNodes:M,fieldCompletions:kN}),ne=p.useCallback(q=>{const Y=q.target.value;r(Y),A(Y),P(Y);const te=q.target;te.style.height="auto",te.style.height=`${Math.min(te.scrollHeight,200)}px`},[A,P]),V=p.useCallback((q,Y)=>{var kt,Wn,pr;N.current+=1;const te=b.current;if(!te)return;const ae=te.getBoundingClientRect(),ce=ae.right,ie=(kt=w.current)==null?void 0:kt.getTextArea(),fe=(ie==null?void 0:ie.getBoundingClientRect().width)??ae.width,ge=S?pe.chatInput.BOTTOM_VISIBLE:pe.chatInput.BOTTOM_HIDDEN,he=window.innerHeight-ge,ue=(Wn=E.getState().projectCanvas.getActive())==null?void 0:Wn.viewState;if(!ue)return;const{scale:xe}=ue,me=Ls(q)+pe.NODE_X_PADDING*2,ye=Math.min(me,fe),Ne=ct(q,{containerWidth:ye})+pe.NODE_Y_PADDING*2,Te=Ne*xe+pe.chatInput.NODE_SCROLL_GAP;E.getState().setActiveCanvasViewState(rs=>({...rs,offset:{...rs.offset,y:rs.offset.y-Te}}));const Pe=(pr=E.getState().projectCanvas.getActive())==null?void 0:pr.viewState;if(!Pe)return;const{offset:Ee}=Pe,Fe=(Y==null?void 0:Y.role)==="assistant"?!1:h;let yt;if(Fe){const rs=pe.chatInput.NODE_GAP_RIGHT/xe;yt=(ce-Ee.x)/xe-ye-rs}else{const rs=pe.chatInput.NODE_GAP_LEFT/xe;yt=(ae.left-Ee.x)/xe+rs}const Je=pe.chatInput.NODE_GAP_TOP/xe,vt=(he-Ee.y)/xe-Ne-Je,nt={id:Re(),type:de.TEXT,x:yt,y:vt,width:ye,height:Ne,content:q,lockSize:!0,...Y&&{data:Y}},_t=vt+Ne;return j.current=_t,E.getState().addNode(nt,void 0,{dontSelect:!0}),nt},[S,h]),oe=p.useCallback(async()=>{var te;const q=o.trim();if(!q)return;const Y=(te=w.current)==null?void 0:te.getTextArea();if(a===Pt.CLAUDE){u(!0);try{let ae=c;if(!ae){const ie=await ya.createSession();if(!ie.success||!ie.sessionId)throw new Error(ie.error??"Failed to create Claude session");ae=ie.sessionId,l(ae)}V(q,{sessionId:ae,role:"user"});const ce=await ya.sendMessage({sessionId:ae,message:q});if(!ce.success)throw new Error(ce.error??"Failed to send message to Claude");V(ce.response,{sessionId:ae,role:"assistant"}),e==null||e(q),r(""),Y&&(Y.style.height="auto",Y.focus())}catch(ae){const ce=ae instanceof Error?ae.message:"Unknown error";ve.error("Claude API error",{description:ce}),c&&V(`Error: ${ce}`,{sessionId:c,role:"error"})}finally{u(!1)}return}V(q),e==null||e(q),r(""),i(Pt.DEFAULT),Y&&(Y.style.height="auto",Y.focus())},[o,e,a,c,V]),le=p.useCallback(()=>{if(a===Pt.CLAUDE){const q=(m==null?void 0:m.split("/").pop())??"",Y=c?Er(c,3,3):"new";return q?`[${q}] ${Y}`:c?Er(c,3,3):"Claude"}return AN[a]},[a,c,m]),Z=p.useCallback(q=>{L(q),J(q),!(B&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(q.key))&&(_&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(q.key)||q.key==="Enter"&&!q.shiftKey&&!B&&!_&&(q.preventDefault(),oe()))},[oe,L,J,B,_]);return t.jsxs("div",{ref:b,className:"fixed left-1/2 -translate-x-1/2 w-[80vw] md:w-[50vw] pointer-events-auto transition-[bottom] duration-200",style:{zIndex:ke.canvasChatInput,bottom:S?`${pe.chatInput.BOTTOM_VISIBLE}px`:`${pe.chatInput.BOTTOM_HIDDEN}px`},"data-test":"canvas-chat-input-container","data-ui-panel":"true",children:[B&&t.jsx(Jh,{commands:F,selectedIndex:D,position:$,onSelect:T,onClose:O}),_&&t.jsx(Jl,{formulas:G,selectedIndex:X,position:K,onSelect:z,onClose:U,triggerPrefix:re?".":"="}),g&&t.jsxs("div",{"data-test":"chat-input-project-selector",className:"absolute bottom-full mb-2 left-0 right-0 bg-background border rounded-lg shadow-lg p-3",style:{zIndex:ke.canvasChatInput+1},children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-sm font-medium",children:"Select Claude Project"}),t.jsx("button",{"data-test":"chat-input-project-selector-close",onClick:()=>y(!1),className:"p-1 hover:bg-muted rounded",children:t.jsx(We,{className:"h-4 w-4"})})]}),t.jsx(Jd,{variant:"select",onChange:q=>{x(typeof q=="string"?q:null),setTimeout(()=>{var te,ae;l(null),i(Pt.CLAUDE),y(!1),(ae=(te=w.current)==null?void 0:te.getTextArea())==null||ae.focus()},0)}})]}),a!==Pt.DEFAULT&&t.jsxs("div",{"data-test":"chat-input-mode-indicator",className:"absolute -top-7 left-2 flex items-center gap-1 px-2 py-1 bg-primary text-primary-foreground text-xs font-medium rounded-t-md",children:[t.jsx("span",{"data-test":"chat-input-mode-label",children:le()}),t.jsx("button",{"data-test":"chat-input-mode-clear",onClick:()=>{i(Pt.DEFAULT),l(null)},className:"p-0.5 hover:bg-primary-foreground/20 rounded",title:"Clear mode",children:t.jsx(We,{className:"h-3 w-3"})})]}),t.jsxs("div",{className:"flex items-end gap-2 bg-background border rounded-lg shadow-lg","data-test":"canvas-chat-input-wrapper",children:[t.jsx("div",{className:"flex-1 min-w-0","data-test":"canvas-chat-input-textarea-container",children:t.jsx(lc,{ref:w,value:o,onChange:ne,onKeyDown:Z,placeholder:s,className:"min-h-[40px] max-h-[200px] resize-none border-0 focus-visible:ring-0 focus-visible:ring-offset-0",rows:1,showFilePicker:!0,showCopyButton:!1,showAudioButton:!0,showConfigButton:!1,audioButtonVariant:"muted",useMarkdown:!1,readOnly:n||d,keyboard:I})}),t.jsx(ee,{type:"button",size:"icon",onClick:oe,disabled:n||!o.trim()||d,className:"mr-1 mb-0.5","data-test":"canvas-chat-input-send-button",children:d?t.jsx(On,{className:"h-4 w-4 animate-spin","data-test":"canvas-chat-input-loading"}):t.jsx(jh,{className:"h-4 w-4"})})]})]})},RN=[],MN=()=>{const e=H(h=>h.uiState.switchLayerDialog),s=H(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.layers)??RN}),n=H(h=>{var f;return((f=h.projectCanvas.getActive())==null?void 0:f.coreState.activeLayerId)??mt}),o=(e==null?void 0:e.isOpen)??!1,r=(e==null?void 0:e.targetLayerId)??mt,a=s.find(h=>h.id===r),i=(a==null?void 0:a.name)??(r===mt?"Default Layer":"Unknown Layer"),c=s.find(h=>h.id===n),l=(c==null?void 0:c.name)??(n===mt?"Default Layer":"Unknown Layer"),d=()=>{E.getState().setUiState(h=>({...h,switchLayerDialog:null}))},u=()=>{E.getState().layer.setActive(r),d()};return t.jsx(dc,{open:o,onOpenChange:h=>!h&&d(),children:t.jsxs(uc,{"data-test":"switch-layer-dialog",children:[t.jsxs(hc,{children:[t.jsx(pc,{"data-test":"switch-layer-dialog-title",children:"Node on Different Layer"}),t.jsxs(Qd,{"data-test":"switch-layer-dialog-description",children:['You are currently on the "',l,'" layer. The node you clicked is on the "',i,'" layer. Would you like to switch to that layer?']})]}),t.jsxs(eu,{"data-test":"switch-layer-dialog-footer",children:[t.jsx(ee,{variant:"outline",onClick:d,"data-test":"switch-layer-dialog-cancel",children:"Cancel"}),t.jsx(ee,{onClick:u,"data-test":"switch-layer-dialog-confirm",children:"Switch Layer"})]})]})})},PN=2e3,DN=[],ac=[],Js={offset:{x:0,y:0},scale:1,targetView:null},ON=Ce.memo(({node:e,isSelected:s})=>{const a=(typeof e.content=="string"?e.content:"").split(`
`).filter(y=>y.trim().length>0),i=e.width??200,c=e.height??100,l=Math.max(a.length,1),d=Math.min(20,c/l),u=8,h="hsl(var(--muted))",f=s?"2px solid #2563eb":"1px solid hsl(var(--border))",g="hsl(var(--foreground))";return t.jsx("div",{style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${i}px`,height:`${c}px`,backgroundColor:h,border:f,borderRadius:"4px",padding:`${u}px`,display:"flex",flexDirection:"column",gap:`${Math.min(4,d*.2)}px`,overflow:"hidden",willChange:"transform",backfaceVisibility:"hidden"},children:a.slice(0,Math.floor(c/d)).map((y,m)=>{const x=y.length,w=Math.max(...a.map(b=>b.length),1),v=Math.max(20,x/w*90);return t.jsx("div",{style:{height:`${Math.max(2,d-4)}px`,width:`${v}%`,backgroundColor:s?"#93c5fd":g,borderRadius:"2px"}},m)})})});ON.displayName="SimplifiedNode";const Ql=Ce.memo(({nodes:e,selectedNodeIds:s,selectedNodesCount:n,scale:o,offset:r})=>{const a=o<$n,i=p.useMemo(()=>{if(o>=$n)return e;const c=window.innerWidth,l=window.innerHeight,d=-r.x/o,u=-r.y/o,h=d+c/o,f=u+l/o,g=500/o;return e.filter(m=>{const x=m.x+(m.width??200),w=m.y+(m.height??100);return m.x<h+g&&x>d-g&&m.y<f+g&&w>u-g})},[e,o,r]);return a?t.jsx(t.Fragment,{children:i.map(c=>t.jsx(Do,{node:c,isSelected:s.has(c.id),selectedNodesCount:n,useSimplifiedRendering:!0},c.id))}):t.jsx(t.Fragment,{children:e.map(c=>t.jsx(Do,{node:c,isSelected:s.has(c.id),selectedNodesCount:n},c.id))})},(e,s)=>{const n=e.scale<$n,o=s.scale<$n;return!(n!==o||o&&(e.scale!==s.scale||e.offset.x!==s.offset.x||e.offset.y!==s.offset.y)||e.nodes!==s.nodes||e.selectedNodeIds!==s.selectedNodeIds||e.selectedNodesCount!==s.selectedNodesCount)});Ql.displayName="CanvasNodesRenderer";const LN=[],ed=Ce.memo(({groupNodes:e,selectedNodeIds:s})=>{const n=H(a=>{var i;return((i=a.projectCanvas.getActive())==null?void 0:i.viewState)??Js}),{scale:o,offset:r}=n;return e.length===0?null:t.jsx("div",{className:"absolute top-0 left-0 origin-top-left","data-test":"canvas-groups-layer",style:{transform:`translate3d(${r.x}px, ${r.y}px, 0) scale(${o})`,zIndex:ke.canvasGroups,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:t.jsx("div",{style:{pointerEvents:"auto"},children:e.map(a=>t.jsx(Do,{node:a,isSelected:s.has(a.id),selectedNodesCount:s.size},a.id))})})});ed.displayName="CanvasGroupsLayer";const td=Ce.memo(({nodes:e,selectedNodeIds:s,layers:n})=>{const o=H(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.viewState)??Js}),{scale:r,offset:a}=o,i=p.useRef(0),c=p.useRef(r),[l,d]=p.useState(!1),u=p.useRef(null),h=p.useMemo(()=>e.filter(m=>!m.isPinned),[e]),f=p.useMemo(()=>e.filter(m=>m.isPinned),[e]),g=p.useMemo(()=>n.length===0?[yc()]:[...n].sort((m,x)=>m.order-x.order),[n]),y=p.useMemo(()=>{const m=new Map;return g.forEach(x=>{m.set(x.id,[])}),m.has(mt)||m.set(mt,[]),h.forEach(x=>{const w=x.layerId??mt,v=m.get(w);if(v)v.push(x);else{const b=m.get(mt);b&&b.push(x)}}),m},[h,g]);return p.useEffect(()=>{i.current+=1,c.current!==r&&(d(!0),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{d(!1)},200)),c.current=r},[r,l,e.length]),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"absolute top-0 left-0 origin-top-left",style:{transform:`translate3d(${a.x}px, ${a.y}px, 0) scale(${r})`,zIndex:ke.canvasNodes,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:[t.jsx(FN,{scale:r,offset:a}),g.map((m,x)=>{const w=y.get(m.id)??[];return m.isVisible?t.jsx("div",{"data-layer-id":m.id,"data-layer-name":m.name,"data-test":`canvas-layer-container-${m.id}`,style:{zIndex:x,opacity:m.opacity/100,pointerEvents:m.isLocked?"none":"auto",...l&&{willChange:"transform, contents"}},children:t.jsx(Ql,{nodes:w,selectedNodeIds:s,selectedNodesCount:s.size,scale:r,offset:a})},m.id):null})]}),f.length>0&&t.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:ke.canvasNodes+1},children:t.jsx("div",{style:{pointerEvents:"auto"},children:f.map(m=>t.jsx(Do,{node:m,isSelected:s.has(m.id),selectedNodesCount:s.size},m.id))})})]})});td.displayName="CanvasTransformLayer";const WN=({arrows:e,selectedArrows:s})=>{const n=H(c=>{var l;return((l=c.projectCanvas.getActive())==null?void 0:l.viewState)??Js}),{scale:o,offset:r}=n,a=c=>!s.some(d=>d.id===c.id)||s.length>1,i=e.filter(a);return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:ke.canvasArrows,willChange:"transform"},children:t.jsxs("g",{transform:`translate(${r.x}, ${r.y}) scale(${o})`,style:{touchAction:"none"},children:[i.map(c=>t.jsx(Gl,{arrow:c},c.id)),t.jsx(Yv,{})]})})},$N=Ce.memo(WN,(e,s)=>e.arrows.length!==s.arrows.length||e.selectedArrows.length!==s.selectedArrows.length?!1:e.arrows===s.arrows&&e.selectedArrows===s.selectedArrows),BN=({selectedArrows:e})=>{const s=H(r=>{var a;return((a=r.projectCanvas.getActive())==null?void 0:a.viewState)??Js}),{scale:n,offset:o}=s;return e.length!==1?null:t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:ke.canvasNodes+1,willChange:"transform"},children:t.jsx("g",{transform:`translate(${o.x}, ${o.y}) scale(${n})`,style:{touchAction:"none"},children:t.jsx(Gl,{arrow:e[0]},e[0].id)})})},HN=Ce.memo(BN,(e,s)=>e.selectedArrows.length!==s.selectedArrows.length?!1:e.selectedArrows===s.selectedArrows),sd=Ce.memo(()=>{const e=H(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??Js}),{scale:s,offset:n}=e;return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:ke.canvasNodes+2,willChange:"transform"},"data-test":"temporary-drawing-layer",children:t.jsx("g",{transform:`translate(${n.x}, ${n.y}) scale(${s})`,style:{touchAction:"none"},children:t.jsx(Kv,{})})})});sd.displayName="CanvasTemporaryDrawingLayer";const nd=Ce.memo(()=>{const e=H(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??Js}),{scale:s,offset:n}=e;return t.jsx(Zv,{scale:s,offset:n})});nd.displayName="CanvasGridLayer";const FN=({scale:e,offset:s,x:n=0,y:o=0})=>t.jsx("div",{style:{position:"absolute",left:n*e,top:o*e,width:12,height:12,background:"darkred",borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 2px #0008",cursor:"pointer",zIndex:10,transform:"translate(-50%, -50%)",userSelect:"none"},title:`Canvas origin (${n.toFixed(1)}, ${o.toFixed(1)})`}),_N=()=>{const e=H(T=>T.uiState.isOverlayVisible??!0);H(T=>T.uiState.addNodeType);const s=H(T=>T.uiState.mode),n=H(T=>T.uiState.isPanning),o=H(T=>T.uiState.selectFromDrawMode),r=H(T=>{var O,$,_;return((_=($=(O=T.preferences)==null?void 0:O.canvasConfig)==null?void 0:$.background)==null?void 0:_.paperTexture)??se.background.paperTexture}),a=H(T=>{var O,$,_;return((_=($=(O=T.preferences)==null?void 0:O.canvasConfig)==null?void 0:$.background)==null?void 0:_.customParams)??se.background.customParams}),{theme:i}=xc(),c=Ce.useMemo(()=>i==="dark"?!0:i==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[i]),l=r!=="custom"&&tu[r]||"",d=Ce.useMemo(()=>{if(!a||a.opacity===0)return{};const T=c?100-a.bgLightness:a.bgLightness;return{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${T}%)`,position:"relative"}},[a,c]),u=Ce.useMemo(()=>!a||a.opacity===0?null:{position:"absolute",inset:0,opacity:a.opacity,pointerEvents:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`,zIndex:0},[a]),h=p.useRef(0),f=p.useRef(performance.now());p.useEffect(()=>{h.current+=1;const T=performance.now();T-f.current>=2e3&&(h.current=0,f.current=T)});const g=H(T=>T.toggleOverlayVisibility),y=Tb(),m=H(T=>{var O;return((O=T.projectCanvas.getActive())==null?void 0:O.coreState.selectedNodes)??DN}),x=H(T=>{var O;return((O=T.projectCanvas.getActive())==null?void 0:O.coreState.arrows)??ac}),w=H(T=>{var O;return((O=T.projectCanvas.getActive())==null?void 0:O.coreState.selectedArrows)??ac}),v=H(T=>{var O;return((O=T.projectCanvas.getActive())==null?void 0:O.coreState.layers)??LN}),b=H(T=>T.saveStateToLocalStorage),N=vN(),j=H(T=>T.uiState.activeGlobalOverlay),k=j&&j!==hs.NONE;p.useEffect(()=>{se.autosave&&setInterval(()=>{typeof b=="function"&&b()},PN)},[]);const S=p.useMemo(()=>new Set(m.map(T=>T.id)),[m]),C=p.useMemo(()=>{const T=new Set;return y.forEach(O=>{if(O.type===de.GROUP&&O.isCollapsed){const $=O.data;$!=null&&$.childNodeIds&&$.childNodeIds.forEach(_=>T.add(_))}}),T},[y]),R=p.useMemo(()=>{const T=Pg(y,x);return C.forEach(O=>T.add(O)),T},[y,x,C]),{visibleGroupNodes:I,visibleNonGroupNodes:M}=p.useMemo(()=>{const T=y.filter(_=>!R.has(_.id)),O=[],$=[];return T.forEach(_=>{_.type===de.GROUP?O.push(_):$.push(_)}),{visibleGroupNodes:O,visibleNonGroupNodes:$}},[y,R]),W=p.useMemo(()=>x.filter(T=>{const O=T.startNodeId!==null&&R.has(T.startNodeId),$=T.endNodeId!==null&&R.has(T.endNodeId);return!O&&!$}),[x,R]),B=p.useMemo(()=>w.filter(T=>{const O=T.startNodeId!==null&&R.has(T.startNodeId),$=T.endNodeId!==null&&R.has(T.endNodeId);return!O&&!$}),[w,R]),F=t.jsx(ee,{variant:"outline",size:"icon",onClick:g,className:"h-7 w-7","data-prevent-canvas-click":!0,title:e?"Hide Overlay":"Show Overlay","data-test":"canvas-toggle-overlay-button",children:e?t.jsx(Rs,{className:"h-4 w-4"}):t.jsx(os,{className:"h-4 w-4"})}),D=t.jsx("div",{className:"flex items-center space-x-2",children:F}),L=s===Q.DRAW||s===Q.SELECT&&o,A=p.useMemo(()=>s===Q.MOVE?n?"grabbing":"grab":s===Q.DRAW?"crosshair":"default",[s,n]);return t.jsxs("div",{className:Se("relative w-full h-full select-none",k&&"ring-2 ring-primary ring-inset",l),"data-canvas-content":!0,"data-global-overlay":j,style:{cursor:A,...d},children:[u&&t.jsx("div",{style:u,"data-test":"custom-texture-overlay"}),t.jsx(nd,{}),t.jsx(ed,{groupNodes:I,selectedNodeIds:S}),t.jsx($N,{arrows:W,selectedArrows:B}),t.jsx(td,{nodes:M,selectedNodeIds:S,layers:v}),t.jsx(HN,{selectedArrows:B}),t.jsx(sd,{}),t.jsx(ul,{}),t.jsx(wv,{}),t.jsx(Cv,{}),t.jsx(zv,{}),t.jsx(Uf,{}),t.jsx(jf,{isContentVisible:e,topMargin:"70px",topLeft:t.jsx(t.Fragment,{children:t.jsxs(t.Fragment,{children:[t.jsx(qv,{}),t.jsx(Jy,{}),t.jsx(Af,{})]})}),topRight:t.jsxs(t.Fragment,{children:[t.jsx(Ol,{}),t.jsx(Gv,{})]}),bottomRight:t.jsx("div",{className:"flex flex-col gap-2",children:D}),bottom:t.jsx(Ff,{}),bottomLeft:e&&t.jsx("div",{className:"flex flex-col gap-2",children:t.jsx(Zy,{})}),left:L?void 0:t.jsx(Db,{}),right:L?void 0:N.right}),L&&t.jsx("div",{className:"absolute top-1/2 transform -translate-y-1/2 pointer-events-auto z-50 left-2","data-prevent-canvas-click":!0,"data-test":"draw-mode-toolbar-container",children:t.jsx(Vb,{})}),t.jsx(SN,{}),t.jsx(EN,{}),t.jsx(MN,{})]})},zN=({sourceNode:e,allNodes:s,onNodeSelect:n,onClose:o,isVisible:r})=>{const[a,i]=p.useState(""),c=p.useMemo(()=>{const h=(e.highlights||[]).map(f=>f.linkedNodeId).filter(f=>f!==void 0);return s.filter(f=>h.includes(f.id))},[e.highlights,s]),l=p.useMemo(()=>{if(!a)return c;const u=a.toLowerCase();return c.filter(h=>(typeof h.content=="string"?h.content:"").toLowerCase().includes(u))},[c,a]),d=p.useMemo(()=>l.map(u=>{const h=typeof u.content=="string"?u.content:"[Complex content]",f=h.length>50?h.substring(0,50)+"...":h;return t.jsx("div",{className:"text-sm",children:f},u.id)}),[l]);return t.jsxs(Be,{isVisible:r,onClose:o,title:`Linked Nodes (${c.length})`,initialPosition:"bottom-right","data-test":"linked-nodes-popover",children:[t.jsx("div",{className:"search-field px-3 py-2 border-b border-border",children:t.jsx("input",{type:"text",className:"w-full px-2 py-1 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:"Search linked nodes...",value:a,onChange:u=>i(u.target.value)})}),t.jsx("div",{className:"linked-nodes-list overflow-hidden",children:d.length>0?t.jsx(Fa,{itemList:d,maxHeight:"200px",itemStyles:"border border-border",onSelectionChange:u=>{if(u.length>0){const h=l[u[0]];h&&(n(h),o())}}}):t.jsx("div",{className:"empty-state px-3 py-4 text-sm text-muted-foreground text-center",children:a?"No matching nodes found":"No linked nodes yet"})})]})},rc=({node:e,isChanged:s})=>{const n=e.title||e.id,o=typeof e.content=="string"?e.content:"";return t.jsxs("div",{className:`absolute border-2 ${s?"border-green-500 ring-2 ring-green-500/30":"border-black"} bg-white rounded p-1`,style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:`${pe.FONT_SIZE_MINI}px`},children:[t.jsx("div",{className:"font-semibold text-[10px] truncate",children:n}),t.jsx("div",{className:"text-[8px] text-muted-foreground truncate",children:o.substring(0,50)})]})},UN=({isVisible:e,changes:s,previewNodes:n,currentNodes:o,arrows:r,executionResult:a,onApply:i,onCancel:c})=>{const l=s.length>0,[d,u]=p.useState("canvas"),h=new Set(s.map(g=>g.nodeId)),f=p.useMemo(()=>{if(!a)return null;const g={workflow:{success:a.success,duration:`${a.duration}ms`,executedNodes:a.executedNodeCount,errors:a.errors.length},steps:[],changes:{totalNodes:s.length,updates:s.map(y=>({nodeId:y.nodeId,before:y.before,after:y.after}))}};return a.nodeStates&&a.nodeStates.forEach((y,m)=>{var x;(x=y.executionData)!=null&&x.steps&&y.executionData.steps.forEach(w=>{var b,N,j,k;const v={type:w.stepType,label:w.label,order:w.order};w.stepType==="source"?v.sourceData=y.executionData.sourceData:w.stepType==="loop"?v.items=((b=y.executionData.sourceData)==null?void 0:b.length)||0:w.stepType==="if"?(v.config=w.config,v.conditionResult=w.conditionResult,v.checkedNodes=((N=w.checkedNodes)==null?void 0:N.length)||0,v.matchedNodes=((j=w.checkedNodes)==null?void 0:j.filter(S=>S.matches).map(S=>S.nodeId))||[]):w.stepType==="nodeUpdate"&&(v.targets=((k=y.executionData.nodeUpdates)==null?void 0:k.length)||0),g.steps.push(v)})}),g},[a,s]);return t.jsx(Be,{isVisible:e,onClose:c,title:"Workflow Dry Run Results",shouldCloseManually:!0,resizable:!0,initialSize:{width:1200,height:700},children:t.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[t.jsxs("div",{className:"p-4 bg-muted border-b border-border flex items-center justify-between",children:[t.jsx("div",{className:"text-sm",children:l?t.jsxs(t.Fragment,{children:[t.jsx("strong",{children:s.length})," node",s.length!==1?"s":""," will be updated"]}):t.jsx("span",{className:"text-muted-foreground",children:"No changes to apply"})}),l&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{"data-test":"dry-run-view-canvas-button",onClick:()=>u("canvas"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="canvas"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(os,{size:14}),"Canvas Preview"]}),t.jsxs("button",{"data-test":"dry-run-view-list-button",onClick:()=>u("list"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="list"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(Ga,{size:14}),"Details"]}),t.jsxs("button",{"data-test":"dry-run-view-json-button",onClick:()=>u("json"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="json"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(Fo,{size:14}),"JSON"]})]})]}),t.jsx("div",{className:"flex-1 overflow-hidden",children:l?d==="json"?t.jsx("div",{className:"h-full overflow-auto p-4 bg-gray-50","data-test":"dry-run-json-view",children:t.jsx("pre",{className:"text-xs font-mono bg-background border border-border rounded p-4 whitespace-pre-wrap break-words",children:JSON.stringify(f,null,2)})}):d==="canvas"?t.jsxs("div",{className:"h-full flex gap-2 p-2",children:[t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-muted px-2 py-1 text-xs font-semibold border-b border-border",children:"Current State"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:o.map(g=>t.jsx(rc,{node:g,isChanged:h.has(g.id)},g.id))})]}),t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-green-500/10 px-2 py-1 text-xs font-semibold border-b border-green-500/30 text-green-700 dark:text-green-400",children:"Preview (After Apply)"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:n.map(g=>t.jsx(rc,{node:g,isChanged:h.has(g.id)},g.id))})]})]}):t.jsx("div",{className:"h-full overflow-y-auto p-4 space-y-4",children:s.map((g,y)=>t.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-2 bg-background",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:g.nodeId}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",y+1]})]}),g.before.title!==g.after.title&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Title"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:g.before.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(Kt,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:g.after.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),g.before.content!==g.after.content&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Content"}),t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20 font-mono max-h-24 overflow-y-auto",children:g.before.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:g.before.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(Kt,{size:16,className:"text-muted-foreground flex-shrink-0 mt-1"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20 font-mono max-h-24 overflow-y-auto",children:g.after.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:g.after.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),(()=>{const m=Array.isArray(g.before.tags)?g.before.tags:[],x=Array.isArray(g.after.tags)?g.after.tags:[],w=m.map(N=>N.title).sort().join(", "),v=x.map(N=>N.title).sort().join(", ");return w!==v?t.jsxs("div",{className:"space-y-1","data-test":"dry-run-tags-change",children:[t.jsxs("div",{className:"text-xs font-semibold text-muted-foreground flex items-center gap-1",children:[t.jsx(In,{size:12}),"Tags"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:m.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:m.map(N=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-destructive/20 rounded text-xs",children:["#",N.title]},N.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})}),t.jsx(Kt,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:x.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(N=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-xs",children:["#",N.title]},N.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})})]})]}):null})()]},g.nodeId))}):t.jsx("div",{className:"text-center text-muted-foreground py-8",children:"The workflow executed successfully but made no changes to the canvas nodes."})}),t.jsxs("div",{className:"p-4 border-t border-border flex items-center justify-end gap-2",children:[t.jsxs("button",{"data-test":"dry-run-cancel-button",onClick:c,className:"px-4 py-2 text-sm border border-border rounded hover:bg-accent transition-colors flex items-center gap-2",children:[t.jsx(We,{size:16}),"Cancel"]}),l&&t.jsxs("button",{"data-test":"dry-run-apply-button",onClick:i,className:"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors flex items-center gap-2",children:[t.jsx(Bs,{size:16}),"Apply Changes"]})]})]})})},od=Ce.memo(({canvasId:e,canvasName:s,projectName:n,workspaceName:o,isActive:r,isDragging:a,onClose:i,onClick:c,onAuxClick:l,dragRef:d})=>{const u=`${n} / ${o} / ${s}`;return t.jsxs("div",{ref:d,"data-test":`canvas-tab-${e}`,className:we("group flex items-center gap-1 px-3 py-1.5 text-sm","border-r border-border","cursor-pointer select-none","min-w-[100px]","transition-colors duration-150",r?"bg-background text-foreground border-b-2 border-b-primary":"bg-muted/50 text-muted-foreground hover:bg-accent hover:text-accent-foreground"),style:{maxWidth:se.tabBar.maxTabWidth,opacity:a?se.tabBar.dragSourceOpacity:void 0},onClick:c,onAuxClick:l,title:u,children:[t.jsx("span",{"data-test":`canvas-tab-title-${e}`,className:"truncate flex-1",children:s}),t.jsx("button",{"data-test":`canvas-tab-close-${e}`,className:we("ml-1 p-0.5 rounded-sm","opacity-0 group-hover:opacity-100","hover:bg-destructive/20 hover:text-destructive","transition-opacity duration-150",r&&"opacity-60"),onClick:h=>{h.stopPropagation(),i(h)},title:"Close tab",children:t.jsx(We,{className:"h-3 w-3"})})]})});od.displayName="CanvasTab";const VN=ys,$a="canvas-tab-bar-zone",ad=Ce.memo(({tab:e,isActive:s,isDragging:n,manager:o,onClose:r,onClick:a,onAuxClick:i})=>{const c=sp(o,e.canvasId,{canvasId:e.canvasId,dropZoneId:$a});return t.jsx(od,{canvasId:e.canvasId,canvasName:e.canvasName,projectName:e.projectName,workspaceName:e.workspaceName,isActive:s,isDragging:n,onClose:l=>{l.stopPropagation(),r(e.canvasId)},onClick:()=>a(e.canvasId),onAuxClick:l=>{l.button===1&&(l.preventDefault(),i(e.canvasId))},dragRef:c})});ad.displayName="DraggableTab";const rd=Ce.memo(()=>{const e=p.useRef(null),s=H(N=>{var j;return((j=N.preferences)==null?void 0:j.openTabs)??VN}),n=H(N=>{var j;return((j=N.projectCanvas.getActive())==null?void 0:j.id)??null}),o=H(N=>{var j;return((j=N.state)==null?void 0:j.activeProjectId)??null}),r=H(N=>{var k,S,C;const j=(k=N.state)==null?void 0:k.activeProjectId;return j?((C=(S=N.state)==null?void 0:S.projects[j])==null?void 0:C.activeWorkspaceId)??null:null}),a=p.useMemo(()=>{var j;const N=((j=E.getState().state)==null?void 0:j.projects)??{};return s.map(k=>{const S=N[k.projectId],C=S==null?void 0:S.workspaces[k.workspaceId],R=C==null?void 0:C.canvases[k.canvasId];return{canvasId:k.canvasId,canvasName:(R==null?void 0:R.name)??"Unknown",projectId:k.projectId,projectName:(S==null?void 0:S.name)??"Unknown",workspaceId:k.workspaceId,workspaceName:(C==null?void 0:C.name)??"Unknown",exists:!!R}}).filter(k=>k.exists)},[s]),i=p.useRef({switchCanvas:E.getState().projectCanvas.switch,closeTab:E.getState().closeTab,reorderTabs:E.getState().reorderTabs,createCanvas:E.getState().projectCanvas.create,openTab:E.getState().openTab});p.useEffect(()=>{if(!n||!o||!r)return;s.some(j=>j.canvasId===n)||i.current.openTab(n,o,r)},[n,o,r,s]);const[c,l]=p.useState(null),[d,u]=p.useState(null),h=p.useRef(a);h.current=a;const f=p.useMemo(()=>({onDragStart:N=>{var k;const j=((k=N.item.data)==null?void 0:k.canvasId)??null;u(j)},onDragMove:N=>{l(N.sortIndex)},onDrop:N=>{var M;const j=(M=N.item.data)==null?void 0:M.canvasId,k=N.sortIndex??0;if(!j)return;const S=h.current.map(W=>W.canvasId),C=S.indexOf(j);if(C===-1)return;const R=[...S];R.splice(C,1);const I=C<k?k-1:k;R.splice(I,0,j),i.current.reorderTabs(R)},onDragEnd:()=>{l(null),u(null)}}),[]),{manager:g}=ep({snap:{enabled:!1,threshold:10},sort:{enabled:!0,orientation:"horizontal",threshold:.5},dragThreshold:5},f),y=tp(g,$a),m=p.useCallback(N=>{e&&(e.current=N),y(N)},[y,e]),x=p.useCallback(N=>{i.current.switchCanvas(N)},[]),w=p.useCallback(N=>{i.current.closeTab(N)},[]),v=p.useCallback(N=>{i.current.closeTab(N)},[]),b=p.useCallback(()=>{const N=i.current.createCanvas("New Canvas");N&&i.current.switchCanvas(N)},[]);return p.useEffect(()=>{if(!n||!e.current)return;const N=e.current.querySelector(`[data-test="canvas-tab-${n}"]`);N&&N.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},[n]),a.length===0?t.jsx("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border px-1",children:t.jsx("button",{"data-test":"canvas-tab-add-button",className:we("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:b,title:"New canvas",children:t.jsx(wt,{className:"h-4 w-4"})})}):t.jsxs("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border",children:[t.jsx("div",{ref:m,"data-drop-zone":$a,className:"flex-1 flex items-center overflow-x-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},children:a.map((N,j)=>{const k=c===j&&d!==N.canvasId,S=c===j+1&&j===a.length-1&&d!==N.canvasId;return t.jsxs(Ce.Fragment,{children:[k&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:se.tabBar.dropIndicator.width,opacity:se.tabBar.dropIndicator.opacity}}),t.jsx(ad,{tab:N,isActive:N.canvasId===n,isDragging:N.canvasId===d,manager:g,onClose:w,onClick:x,onAuxClick:v}),S&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:se.tabBar.dropIndicator.width,opacity:se.tabBar.dropIndicator.opacity}})]},N.canvasId)})}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:we("flex items-center justify-center","h-7 w-7 mx-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:b,title:"New canvas",children:t.jsx(wt,{className:"h-4 w-4"})})]})});rd.displayName="CanvasTabBar";function GN({open:e,onOpenChange:s}){const n=H(p.useCallback(m=>{var x,w;return((w=(x=m.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:w.current)??null},[])),o=H(p.useCallback(m=>{var x,w;return((w=(x=m.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:w.root)??null},[])),r=H(p.useCallback(m=>{var w,v;const x=(v=(w=m.projectCanvas.getActive())==null?void 0:w.undoTree)==null?void 0:v.nodes;return x?Object.keys(x).length:0},[])),{allNodes:a,currentNode:i,canUndo:c,canRedo:l,treeData:d}=p.useMemo(()=>{const m=E.getState();return{allNodes:m.undo.getAllNodes(),currentNode:m.undo.getCurrent(),canUndo:m.undo.canUndo(),canRedo:m.undo.canRedo(),treeData:m.undo.getTreeData()}},[n,o,r]),u=p.useCallback(()=>{E.getState().undo.undo()},[]),h=p.useCallback(()=>{E.getState().undo.redo()},[]),f=p.useCallback(m=>{E.getState().undo.jumpTo(m)},[]),g=p.useCallback(()=>{E.getState().undo.clear()},[]),y=p.useMemo(()=>{if(!d||a.length===0)return null;const m=d.root;return m?YN(a,m,(i==null?void 0:i.id)??null):null},[a,d,i]);return t.jsx(su,{open:e,onOpenChange:s,children:t.jsxs(nu,{side:"right",className:"w-80 sm:w-96","data-test":"undo-tree-explorer",children:[t.jsx(ou,{children:t.jsxs(au,{className:"flex items-center gap-2",children:[t.jsx(Xa,{className:"h-5 w-5"}),"Undo History"]})}),t.jsxs("div",{className:"mt-4 space-y-4","data-test":"undo-tree-controls",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(ee,{variant:"outline",size:"sm",onClick:u,disabled:!c,"data-test":"undo-button",children:[t.jsx(za,{className:"h-4 w-4 mr-1"}),"Undo"]}),t.jsxs(ee,{variant:"outline",size:"sm",onClick:h,disabled:!l,"data-test":"redo-button",children:[t.jsx(Cc,{className:"h-4 w-4 mr-1"}),"Redo"]}),t.jsx(ee,{variant:"ghost",size:"sm",onClick:g,disabled:a.length===0,className:"ml-auto text-muted-foreground hover:text-destructive","data-test":"clear-history-button",children:t.jsx(pt,{className:"h-4 w-4"})})]}),t.jsxs("div",{className:"text-sm text-muted-foreground","data-test":"history-stats",children:[a.length," operations in history"]}),t.jsx($s,{className:"h-[calc(100vh-200px)]","data-test":"undo-tree-scroll",children:y?t.jsx("div",{className:"pr-4","data-test":"undo-tree-content",children:y.map((m,x)=>t.jsx(KN,{item:m,isCurrent:m.node.id===(i==null?void 0:i.id),onJump:f,isLast:x===y.length-1},m.node.id))}):t.jsxs("div",{className:"text-center text-muted-foreground py-8","data-test":"empty-history",children:["No undo history yet.",t.jsx("br",{}),t.jsx("span",{className:"text-xs",children:"Drag nodes or resize them to start recording."})]})})]})]})})}function YN(e,s,n){const o=new Map(e.map(i=>[i.id,i])),r=[];function a(i,c,l,d,u){const h=o.get(i);h&&(r.push({node:h,depth:c,hasSiblings:u,isLastChild:d,branchIndex:l}),h.children.forEach((f,g)=>{a(f,c+1,g,g===h.children.length-1,h.children.length>1)}))}return a(s,0,0,!0,!1),r}function KN({item:e,isCurrent:s,onJump:n,isLast:o}){const{node:r,depth:a,hasSiblings:i,branchIndex:c}=e,l=p.useMemo(()=>new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[r.timestamp]);return t.jsxs("div",{className:"relative",style:{marginLeft:a*16},"data-test":`tree-node-${r.id}`,children:[a>0&&t.jsx("div",{className:we("absolute left-[-12px] top-0 h-full w-px bg-border",o&&"h-3")}),a>0&&t.jsx("div",{className:"absolute left-[-12px] top-3 w-3 h-px bg-border"}),i&&c>0&&t.jsx("div",{className:"absolute left-[-14px] top-2 w-2 h-2 rounded-full bg-muted-foreground/50",title:`Branch ${c+1}`}),t.jsx("button",{onClick:()=>n(r.id),className:we("w-full text-left px-2 py-1.5 rounded-md text-sm transition-colors","hover:bg-accent hover:text-accent-foreground",s&&"bg-primary/10 border border-primary/30 font-medium"),"data-test":`jump-to-${r.id}`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:we("w-2 h-2 rounded-full flex-shrink-0",s?"bg-primary":"bg-muted-foreground/30")}),t.jsx("span",{className:"truncate flex-1",children:r.label??r.operation.type}),t.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[t.jsx(ns,{className:"h-3 w-3"}),l]})]})})]})}const jS=({width:e,height:s,className:n,style:o})=>{var v;const r=p.useRef(null),a="cursor-default",i=p.useRef(E.getState().setCanvasDimensions),c=p.useRef(async(b=!1,N)=>{var B,F;const j=E.getState(),k=((B=j.projectCanvas.getActive())==null?void 0:B.coreState.nodes)??[],S=((F=j.projectCanvas.getActive())==null?void 0:F.coreState.arrows)??[];let C=N;if(!C){const D=k.find(L=>{var A;return((A=L.data)==null?void 0:A.nodeType)==="workflowOrchestration"});C=(D==null?void 0:D.id)||"wf-orchestration-001"}const R=new zs;R.loadWorkflow(k,S);const I=await R.executeWorkflow(C),M=[],W=b?k.map(D=>({...D})):[];return I.nodeStates&&(I.nodeUpdates&&I.nodeUpdates.length>0&&I.nodeUpdates.forEach(D=>{const L=k.find(A=>A.id===D.nodeId);if(L){const A=Array.isArray(L.tags)?L.tags:[],T=D.updates.tags!==void 0?Array.isArray(D.updates.tags)?D.updates.tags:[]:A;if(M.push({nodeId:D.nodeId,before:{title:L.title,content:typeof L.content=="string"?L.content:void 0,tags:A},after:{title:D.updates.title!==void 0?D.updates.title:L.title,content:D.updates.content!==void 0?D.updates.content:typeof L.content=="string"?L.content:void 0,tags:T}}),b){const O=W.find($=>$.id===D.nodeId);O&&(D.updates.title!==void 0&&(O.title=D.updates.title),D.updates.content!==void 0&&(O.content=D.updates.content),D.updates.tags!==void 0&&(O.tags=D.updates.tags))}}b||j.updateNode(D.nodeId,D.updates)}),I.nodeStates.forEach((D,L)=>{var J,P,z;const A=k.find(U=>U.id===L);if(!A)return;const T=(J=A.data)==null?void 0:J.nodeType,O=A.type,G=T==="workflowSource"||O==="WORKFLOW_SOURCE"||(T==="workflowOrchestration"||O==="WORKFLOW_ORCHESTRATION");let X=((P=D.executionData)==null?void 0:P.formattedOutput)||((z=D.executionData)==null?void 0:z.output)||A.content;if(X!=null&&typeof X=="object"&&(X=JSON.stringify(X,null,2)),!b){const U={content:G?A.content:X,data:{...A.data||{},executionState:D.executionState}};j.updateNode(L,U)}})),{...I,success:I.success,errors:I.errors||[],changes:M,previewNodes:W,currentNodes:k,arrows:S}}),[l,d]=p.useState({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null}),[u,h]=p.useState({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]});p.useEffect(()=>{const b=r.current;if(!b)return;i.current(b.offsetWidth,b.offsetHeight);const N=new ResizeObserver(j=>{for(const k of j){const{width:S,height:C}=k.contentRect;i.current(S,C)}});return N.observe(b),()=>{N.disconnect()}},[]),p.useEffect(()=>{var b;(b=r.current)==null||b.focus()},[]);const f=p.useMemo(()=>({executeWorkflow:(b,N)=>c.current(b,N),showDryRunResults:b=>{h({isVisible:!0,changes:b.changes||[],previewNodes:b.previewNodes||[],currentNodes:b.currentNodes||[],arrows:b.arrows||[],executionResult:b})},showLinkedNodesPopover:(b,N)=>{d({isVisible:!0,sourceNode:b,newlyCreatedNodeId:N||null})}}),[]),g=b=>{const{newlyCreatedNodeId:N}=l;if(N){const j=E.getState(),k=j.getNodeById(N);if(k&&typeof k.content=="string"){const C=(typeof b.content=="string"?b.content:"")+`

`+k.content;j.updateNode(b.id,{content:C}),j.deleteNodeById(N)}}},y=()=>{d({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null})},m=((v=E.getState().projectCanvas.getActive())==null?void 0:v.coreState.nodes)??[],x=H(b=>b.uiState.undoTreeExplorerOpen??!1),w=p.useCallback(b=>{E.getState().setUiState(N=>({...N,undoTreeExplorerOpen:b}))},[]);return t.jsx(cy,{value:f,children:t.jsx(ip,{value:r,children:t.jsxs("div",{className:"flex flex-col",style:{width:e,height:s},children:[t.jsx(rd,{}),t.jsxs("div",{ref:r,id:"CanvasAppV2","data-canvas-container":!0,className:Se("relative","overflow-hidden","focus:outline-none","flex-1",a,n),style:{touchAction:"none",...o},tabIndex:0,children:[t.jsx(Sf,{}),t.jsx(_N,{}),l.sourceNode&&t.jsx(zN,{sourceNode:l.sourceNode,allNodes:m,onNodeSelect:g,onClose:y,isVisible:l.isVisible}),t.jsx(UN,{isVisible:u.isVisible,changes:u.changes,previewNodes:u.previewNodes,currentNodes:u.currentNodes,arrows:u.arrows,executionResult:u.executionResult,onApply:async()=>{h({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]}),await c.current(!1)},onCancel:()=>{h({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]})}}),t.jsx(GN,{open:x,onOpenChange:w})]})]})})})};export{jS as C,ys as E,Kc as c,op as s,H as u};
