var k=Object.defineProperty;var R=(g,t,e)=>t in g?k(g,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[t]=e;var v=(g,t,e)=>R(g,typeof t!="symbol"?t+"":t,e);import{bc as V}from"./index-BEUYSeX_.js";class C{constructor(t){v(this,"items",[]);v(this,"linkedCrudService",null);v(this,"linkedItemsFn",null);v(this,"cache",{});t!=null&&t.source&&(Array.isArray(t.source)?this.items=structuredClone(t.source):t.source instanceof V&&(this.linkedCrudService=t.source,this.items=t.source.readAll())),t!=null&&t.linkedItems&&(this.linkedItemsFn=t.linkedItems)}refreshFromLinkedSource(){this.linkedCrudService?this.items=this.linkedCrudService.readAll():this.linkedItemsFn&&(this.items=this.linkedItemsFn())}getItems(){return(this.linkedCrudService||this.linkedItemsFn)&&this.refreshFromLinkedSource(),structuredClone(this.items)}setItems(t){if(this.linkedCrudService||this.linkedItemsFn)throw new Error("Cannot set items when linked to a source");this.items=structuredClone(t),this.clearCache()}forceSetItems(t){this.items=structuredClone(t),this.clearCache()}getCachedResult(t,e=5e3){const r=this.cache[t];return r&&Date.now()-r.timestamp<e?r.result:null}cacheResult(t,e){this.cache[t]={timestamp:Date.now(),result:structuredClone(e)}}clearCache(){this.cache={}}getNestedValue(t,e){return e.includes(".")?e.split(".").reduce((i,c)=>i==null?void 0:i[c],t):t[e]}}class W extends C{constructor(e){super(e);v(this,"indices",{})}clearCache(){super.clearCache(),this.indices={}}updateItems(e){this.forceSetItems(e),this.indices={}}createIndex(e){const r=this.getItems(),i=new Map;r.forEach(c=>{const s=c[e];i.has(s)||i.set(s,[]),i.get(s).push(c)}),this.indices[e]=i}hasIndex(e){return e in this.indices}searchByIndex(e,r){this.hasIndex(e)||this.createIndex(e);const i=this.indices[e];return i.has(r)?structuredClone(i.get(r)):[]}search(e,r={}){const{caseSensitive:i=!1,exactMatch:c=!1,searchableFields:s}=r,a=this.getItems();if(!e)return a;const l=i?e:e.toLowerCase();return a.filter(h=>(s??Object.keys(h)).some(u=>{if(h[u]===void 0||h[u]===null)return!1;const o=String(h[u]),d=i?o:o.toLowerCase();return c?d===l:d.includes(l)}))}advancedSearch(e,r={logic:"AND"}){const i=`advancedSearch:${JSON.stringify(e)}:${JSON.stringify(r)}`,c=this.getCachedResult(i);if(c)return c;const s=this.getItems(),{logic:a,nestedSearch:l=!1}=r,h=s.filter(n=>{const u=e.map(o=>{const{field:d,value:f,match:p,caseSensitive:x=!1,threshold:m=.7}=o;return Array.isArray(d)?d.map(S=>this.matchItem(n,S,f,p,x,m,l)).some(S=>S):this.matchItem(n,d,f,p,x,m,l)});return a==="AND"?u.every(o=>o):a==="OR"?u.some(o=>o):a==="NOT"?!u.some(o=>o):!1});return this.cacheResult(i,h),h}matchItem(e,r,i,c,s,a,l){let h;if(l&&typeof r=="string"&&r.includes(".")?h=this.getNestedValue(e,r):h=e[r],h==null)return!1;const n=String(h),u=String(i),o=s?n:n.toLowerCase(),d=s?u:u.toLowerCase();switch(c){case"exact":return o===d;case"contains":return o.includes(d);case"startsWith":return o.startsWith(d);case"endsWith":return o.endsWith(d);case"regex":try{return new RegExp(d,s?"":"i").test(o)}catch{return!1}case"fuzzy":return this.fuzzyMatch(o,d,a);default:return!1}}fuzzyMatch(e,r,i){if(r.length===0)return!0;if(e.length===0)return!1;if(e.toLowerCase().includes(r.toLowerCase()))return!0;let c=0,s=0;const a=e.toLowerCase(),l=r.toLowerCase();for(let n=0;n<a.length&&s<l.length;n++)a[n]===l[s]&&(c++,s++);return c/r.length>=i}}class A extends C{constructor(t){super(t)}updateItems(t){this.forceSetItems(t)}filter(t){const e=this.getItems();return typeof t=="function"?e.filter(t):this.multiFilter([t])}multiFilter(t,e={combineWith:"AND"}){const r=this.getItems(),{combineWith:i}=e;return t.length===0?r:r.filter(c=>{const s=t.map(a=>{if(typeof a=="function")return a(c);const{field:l,operator:h,value:n}=a,u=c[l];switch(h){case"eq":return u===n;case"neq":return u!==n;case"gt":return u>n;case"gte":return u>=n;case"lt":return u<n;case"lte":return u<=n;case"contains":return String(u).includes(String(n));case"startsWith":return String(u).startsWith(String(n));case"endsWith":return String(u).endsWith(String(n));default:return!1}});return i==="AND"?s.every(a=>a):s.some(a=>a)})}advancedFilter(t){const e=`advancedFilter:${JSON.stringify(t)}`,r=this.getCachedResult(e);if(r)return r;const c=this.getItems().filter(s=>this.evaluateFilter(s,t));return this.cacheResult(e,c),c}evaluateFilter(t,e){if("conditions"in e){const{conditions:u,logic:o}=e,d=u.map(f=>this.evaluateFilter(t,f));return o==="AND"?d.every(f=>f):o==="OR"?d.some(f=>f):o==="NOT"?!d.some(f=>f):!1}const r=e,{field:i,operator:c,value:s,valueRange:a,valueList:l,caseSensitive:h=!1}=r,n=this.getNestedValue(t,i);if(n==null&&c!=="exists")return!1;if(typeof n=="string"&&["contains","startsWith","endsWith","regex"].includes(c)){const u=String(s),o=h?n:n.toLowerCase(),d=h?u:u.toLowerCase();switch(c){case"contains":return o.includes(d);case"startsWith":return o.startsWith(d);case"endsWith":return o.endsWith(d);case"regex":try{return new RegExp(d,h?"":"i").test(o)}catch{return!1}}}switch(c){case"eq":return n===s;case"neq":return n!==s;case"gt":return n>s;case"gte":return n>=s;case"lt":return n<s;case"lte":return n<=s;case"in":return Array.isArray(l)&&l.includes(n);case"nin":return Array.isArray(l)&&!l.includes(n);case"between":return Array.isArray(a)&&n>=a[0]&&n<=a[1];case"exists":return n!=null;default:return!1}}}class N extends C{constructor(t){super(t)}updateItems(t){this.forceSetItems(t)}sort(t){return this.multiSort([t])}multiSort(t){return t.length===0?this.getItems():[...this.getItems()].sort((r,i)=>{for(const c of t){const{field:s,direction:a}=c,l=r[s],h=i[s];if(l===h)continue;const n=l<h?-1:1;return a==="asc"?n:-n}return 0})}}class b extends C{constructor(t){super(t)}updateItems(t){this.forceSetItems(t)}paginate(t,e){const{page:r,pageSize:i}=e,c=t.length,s=Math.ceil(c/i),a=Math.max(1,Math.min(r,s)),l=(a-1)*i,h=Math.min(l+i,c);return r>10?{items:[],totalItems:c,totalPages:s,currentPage:a}:{items:t.slice(l,h),totalItems:c,totalPages:s,currentPage:a}}paginateWithCursor(t,e){const{cursor:r,limit:i,direction:c="next",sortField:s="id",sortDirection:a="asc"}=e,l=`cursorPagination:${r??"start"}:${i}:${c}:${s}:${a}:${t.length}`,h=this.getCachedResult(l);if(h)return h;const n=[...t].sort((m,I)=>{const S=m[s],y=I[s];if(S===y)return 0;const F=S<y?-1:1;return a==="asc"?F:-F});let u=0;if(r)try{const m=JSON.parse(atob(r)),I=m.value,S=m.id;u=n.findIndex(y=>y[s]!==I?!1:y.id===S),c==="next"&&u!==-1?u+=1:c==="prev"&&(u=Math.max(0,u-i))}catch{u=0}else c==="prev"&&(u=Math.max(0,n.length-i));const o=Math.min(u+i,n.length),d=n.slice(u,o);let f=null;if(o<n.length){const m=n[o-1],I=m[s];f=btoa(JSON.stringify({value:I,id:m.id}))}let p=null;if(u>0){const m=Math.max(0,u-1),I=n[m],S=I[s];p=btoa(JSON.stringify({value:S,id:I.id}))}const x={items:d,nextCursor:f,prevCursor:p,hasMore:o<n.length};return this.cacheResult(l,x),x}}class w extends C{constructor(e){super({source:e??null});v(this,"searchService");v(this,"filterService");v(this,"sortService");v(this,"paginationService");const i={linkedItems:()=>super.getItems()};this.searchService=new W(i),this.filterService=new A(i),this.sortService=new N(i),this.paginationService=new b(i)}setItems(e){this.items=structuredClone(e),this.clearCache(),this.searchService.updateItems(e),this.filterService.updateItems(e),this.sortService.updateItems(e),this.paginationService.updateItems(e)}createIndex(e){this.searchService.createIndex(e)}hasIndex(e){return this.searchService.hasIndex(e)}searchByIndex(e,r){return this.searchService.searchByIndex(e,r)}search(e,r={}){return this.searchService.search(e,r)}advancedSearch(e,r={logic:"AND"}){return this.searchService.advancedSearch(e,r)}filter(e){return this.filterService.filter(e)}multiFilter(e,r={combineWith:"AND"}){return this.filterService.multiFilter(e,r)}advancedFilter(e){return this.filterService.advancedFilter(e)}sort(e){return this.sortService.sort(e)}multiSort(e){return this.sortService.multiSort(e)}paginate(e,r){return this.paginationService.paginate(e,r)}paginateWithCursor(e,r){return this.paginationService.paginateWithCursor(e,r)}chain(){const e=this,r=[];let i=null;const c=()=>{const s=`chain:${JSON.stringify(r)}`,a=this.getCachedResult(s);if(a)return a;let l=e.getItems();for(const h of r){const n=new w(l);switch(h.type){case"search":l=n.search(...h.args);break;case"advancedSearch":l=n.advancedSearch(...h.args);break;case"advancedFilter":l=n.advancedFilter(h.args[0]);break;case"filter":l=n.filter(h.args[0]);break;case"multiFilter":l=n.multiFilter(...h.args);break;case"sort":l=n.sort(h.args[0]);break;case"multiSort":l=n.multiSort(h.args[0]);break}}return this.cacheResult(s,l),l};return{search(s,a){return r.push({type:"search",args:[s,a]}),i=null,this},advancedSearch(s,a){return r.push({type:"advancedSearch",args:[s,a]}),i=null,this},filter(s){return r.push({type:"filter",args:[s]}),i=null,this},multiFilter(s,a){return r.push({type:"multiFilter",args:[s,a]}),i=null,this},advancedFilter(s){return r.push({type:"advancedFilter",args:[s]}),i=null,this},sort(s){return r.push({type:"sort",args:[s]}),i=null,this},multiSort(s){return r.push({type:"multiSort",args:[s]}),i=null,this},paginate(s){return i??(i=c()),e.paginate(i,s)},paginateWithCursor(s){return i??(i=c()),e.paginateWithCursor(i,s)},getItems(){return i??(i=c()),structuredClone(i)}}}}export{w as S};
