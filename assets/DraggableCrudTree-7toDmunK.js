import{r as c,j as e}from"./react-vendor-CrhW4DYn.js";import{W as Q,w as ne,B as H,a4 as ae,a5 as se,a6 as oe,a7 as W}from"./index-CgyRe94A.js";import{D as le}from"./DragDropManager-BCQ9eUTy.js";import{r as ce,f as $,D as de,i as ie}from"./DropIndicator-BK5HbmlC.js";import{a9 as ue,E as ge,X as xe,aa as he,ab as pe,O as J,a6 as me,a7 as fe}from"./icons-6Gjq1X59.js";function _({node:t,level:S,parentId:T,index:F,onItemClick:A,onUpdate:w,onDelete:I,defaultExpandedIds:D,selectedId:q,enableEdit:B=!0,enableDelete:N=!0,enableDrag:V=!0,deleteConfirmMessage:k,renderNode:M,moreOptionsItems:C,dropdownZIndex:j,dragSortIndex:f,dragTargetParent:z,draggedNodeId:y,onTreeStructureChange:R,allNodes:Y}){const[v,x]=c.useState((D==null?void 0:D.has(t.id))??!1),[P,X]=c.useState(!1),[L,Z]=c.useState(t.label),o=!!(t.children&&t.children.length>0),g=q===t.id,h=c.useRef(null);c.useEffect(()=>{R()},[v,R]),c.useEffect(()=>{g&&h.current&&h.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[g]);const i=a=>{a.stopPropagation(),P||(o&&x(!v),A==null||A(t))},s=()=>{L.trim()&&L!==t.label&&(w==null||w(t.id,L.trim())),X(!1)},l=()=>{Z(t.label),X(!1)},p=a=>{a.stopPropagation();const d=(k==null?void 0:k(t))??`Are you sure you want to delete "${t.label}"?`;window.confirm(d)&&(I==null||I(t.id))},n={paddingLeft:`${S*1.5}rem`},r=o?e.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:v?e.jsx(me,{className:"h-4 w-4"}):e.jsx(fe,{className:"h-4 w-4"})}):e.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),u=y&&y!==t.id&&z===T&&f===F,b=e.jsxs(e.Fragment,{children:[u&&e.jsx("div",{className:"drop-indicator h-0.5 bg-primary -mt-1 mb-1",style:n}),e.jsxs("div",{ref:h,className:Q("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",g&&"bg-primary/10 border border-primary"),style:n,onClick:i,children:[V&&e.jsx("div",{"data-drag-handle":t.id,"data-parent-id":T,className:"drag-handle cursor-grab active:cursor-grabbing mr-1 opacity-0 group-hover:opacity-100",children:e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"})}),r,t.icon&&e.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:t.icon}),P?e.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[e.jsx(ne,{type:"text",value:L,onChange:a=>Z(a.target.value),onKeyDown:a=>{a.key==="Enter"&&s(),a.key==="Escape"&&l()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:a=>a.stopPropagation()}),e.jsx(H,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),s()},className:"h-6 w-6 p-0",children:e.jsx(ge,{className:"h-3 w-3"})}),e.jsx(H,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),l()},className:"h-6 w-6 p-0",children:e.jsx(xe,{className:"h-3 w-3"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"tree-item-label flex-grow truncate",title:t.label,children:t.label}),e.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[B&&w&&e.jsx(H,{variant:"ghost",size:"sm",onClick:a=>{a.stopPropagation(),X(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:e.jsx(he,{className:"h-3 w-3"})}),(()=>{const a=C==null?void 0:C(t);return a&&a.length>0?e.jsxs(ae,{children:[e.jsx(se,{asChild:!0,children:e.jsx(H,{variant:"ghost",size:"sm",onClick:d=>d.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:e.jsx(pe,{className:"h-3 w-3"})})}),e.jsxs(oe,{align:"end",style:j?{zIndex:j}:void 0,"data-test":"tree-item-more-options-content",children:[a.map(d=>e.jsxs(W,{onClick:m=>{m.stopPropagation(),d.onClick(t)},className:d.className,"data-test":`tree-item-menu-${d.id}`,children:[d.icon,d.label]},d.id)),N&&I&&e.jsxs(W,{onClick:d=>{d.stopPropagation(),p(d)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):N&&I?e.jsx(H,{variant:"ghost",size:"sm",onClick:p,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:e.jsx(J,{className:"h-3 w-3"})}):null})()]})]})]})]});return e.jsxs("div",{className:"draggable-crud-tree-item",children:[M?M(t,g,o,b):b,o&&v&&e.jsx("div",{"data-drop-zone":t.id,"data-node-name":t.label,children:t.children.map((a,d)=>e.jsx(_,{node:a,level:S+1,parentId:t.id,index:d,onItemClick:A,onUpdate:w,onDelete:I,defaultExpandedIds:D,selectedId:q,enableEdit:B,enableDelete:N,enableDrag:V,deleteConfirmMessage:k,renderNode:M,moreOptionsItems:C,dropdownZIndex:j,dragSortIndex:f,dragTargetParent:z,dragOverNode:null,dragX:null,dragY:null,dragExpectedX:null,dragExpectedY:null,draggedNodeId:y,dragNextNodeLabel:null,onTreeStructureChange:R,allNodes:Y},a.id))})]})}function ye({data:t,onReorder:S,onItemClick:T,onUpdate:F,onDelete:A,className:w,defaultExpandedIds:I,selectedId:D,enableEdit:q=!0,enableDelete:B=!0,enableDrag:N=!0,deleteConfirmMessage:V,renderNode:k,moreOptionsItems:M,dropdownZIndex:C}){const j=c.useRef(null),f=c.useRef(t),z=c.useRef(S),y=c.useRef(null),R=c.useRef([]),Y=c.useRef(null),v=c.useRef({targetParent:null,sortIndex:null});c.useEffect(()=>{f.current=t,z.current=S},[t,S]);const[x,P]=c.useState({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),[X,L]=c.useState(0),Z=c.useCallback(()=>{L(o=>o+1)},[]);return c.useEffect(()=>{if(N)return j.current=new le({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:({item:o})=>{const g=o.data.nodeId;Y.current=null,v.current={targetParent:null,sortIndex:null};const h=document.querySelector(`[data-drag-handle="${g}"]`);if(h){const n=h.parentElement;if(n){const r=n.getBoundingClientRect();y.current={top:Math.round(r.top),bottom:Math.round(r.bottom)}}}const i=[];document.querySelectorAll("[data-drag-handle]").forEach(n=>{const r=n.getAttribute("data-drag-handle");if(r){const u=n.parentElement;if(u){const b=u.getBoundingClientRect(),a=$(f.current,r);i.push({id:r,label:(a==null?void 0:a.node.label)||r,rect:{top:Math.round(b.top),bottom:Math.round(b.bottom)}})}}});const l=new Map;i.forEach(n=>{const r=n.rect.bottom-n.rect.top,u=l.get(n.id);if(!u)l.set(n.id,n);else{const b=u.rect.bottom-u.rect.top;r<b&&l.set(n.id,n)}});const p=Array.from(l.values());return p.sort((n,r)=>n.rect.top-r.rect.top),R.current=p,P({isDragging:!0,nodeId:o.id,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null}),!0},onDragMove:({item:o,position:g})=>{var a,d;o.data.nodeId;const h=Math.round(g.x),i=Math.round(g.y),s=y.current;if(s&&i>=s.top&&i<=s.bottom){P(m=>({...m,x:h,y:i,sortIndex:null,targetParent:null,overNode:null,expectedX:null,expectedY:null,nextNodeLabel:null}));return}const n=R.current.find(m=>i>=m.rect.top&&i<=m.rect.bottom);let r=null;if(n){const m=$(f.current,n.id);if(m){const U=n.rect.bottom-n.rect.top,K=(i-n.rect.top)/U,ee=K>=.33&&K<.66,te=K>=.66;if(ee)r={targetParentId:n.id,sortIndex:0};else if(te){const E=m.parent,O=(E===null?f.current:((a=$(f.current,E))==null?void 0:a.node.children)||[]).findIndex(G=>G.id===n.id);r={targetParentId:E,sortIndex:O+1}}else{const E=m.parent,O=(E===null?f.current:((d=$(f.current,E))==null?void 0:d.node.children)||[]).findIndex(G=>G.id===n.id);r={targetParentId:E,sortIndex:O}}}r&&(Y.current=r)}else Y.current&&(r=Y.current);const u=(r==null?void 0:r.targetParentId)??null,b=(r==null?void 0:r.sortIndex)??0;v.current={targetParent:u??null,sortIndex:b??null},P(m=>({...m,sortIndex:b??null,targetParent:u??null,overNode:u??null,x:h,y:i,expectedX:null,expectedY:null,nextNodeLabel:null}))},onDrop:({item:o})=>{const g=o.data.nodeId,h=v.current.targetParent,i=v.current.sortIndex;if(i==null)return;const{newNodes:s,removed:l}=ce(f.current,g);if(!l)return;const p=ie(s,l,h,i);z.current&&z.current(p)},onDragEnd:()=>{y.current=null,R.current=[],v.current={targetParent:null,sortIndex:null},P({isDragging:!1,nodeId:null,sortIndex:null,targetParent:null,overNode:null,x:null,y:null,expectedX:null,expectedY:null,nextNodeLabel:null})}}),()=>{var o;(o=j.current)==null||o.destroy()}},[N]),c.useEffect(()=>{if(!j.current||!N)return;document.querySelectorAll('[data-dnd-registered="true"]').forEach(s=>s.removeAttribute("data-dnd-registered")),document.querySelectorAll('[data-dnd-zone-registered="true"]').forEach(s=>s.removeAttribute("data-dnd-zone-registered")),document.querySelectorAll("[data-drop-zone]").forEach(s=>{const l=s.getAttribute("data-drop-zone"),p=s.getAttribute("data-node-name");l&&(j.current.registerDropZone(l,s,void 0,{nodeName:p||l}),s.setAttribute("data-dnd-zone-registered","true"))}),document.querySelectorAll("[data-drag-handle]").forEach(s=>{const l=s.getAttribute("data-drag-handle"),p=s.getAttribute("data-parent-id");let n="root",r=s.parentElement;for(;r;){const u=r.getAttribute("data-drop-zone");if(u){n=u;break}r=r.parentElement}l&&(j.current.registerDraggable(l,s,{nodeId:l,parentId:p||null,dropZoneId:n}),s.setAttribute("data-dnd-registered","true"))})},[t,X,N]),e.jsx("div",{className:Q("draggable-crud-tree",w),children:e.jsxs("div",{"data-drop-zone":"root","data-node-name":"root","data-tree-root":!0,style:{position:"relative"},children:[t.map((o,g)=>e.jsx(_,{node:o,level:0,parentId:null,index:g,onItemClick:T,onUpdate:F,onDelete:A,defaultExpandedIds:I,selectedId:D,enableEdit:q,enableDelete:B,enableDrag:N,deleteConfirmMessage:V,renderNode:k,moreOptionsItems:M,dropdownZIndex:C,dragSortIndex:x.sortIndex,dragTargetParent:x.targetParent,dragOverNode:x.overNode,dragX:x.x,dragY:x.y,dragExpectedX:x.expectedX,dragExpectedY:x.expectedY,draggedNodeId:x.nodeId,dragNextNodeLabel:x.nextNodeLabel,onTreeStructureChange:Z,allNodes:t},o.id)),x.sortIndex===t.length&&x.targetParent===null&&e.jsx(de,{message:"Drop at end"})]})})}export{ye as D};
