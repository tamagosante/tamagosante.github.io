import{r as o,j as e,u as te,d as oe}from"./react-vendor-Byz07MLO.js";import{t as _}from"./utils-G1l1U0hd.js";import{S as ae}from"./SessionSidebar-CSfwOUNw.js";import{a2 as ne,L as C,I as re,a7 as ie,aj as le,H as ce,a as q,ak as de,u as ue,s as H,r as W,al as fe,am as he}from"./index-hTFRJyrx.js";import{T as me}from"./textarea-ZFIB_HyS.js";import{M as pe,G as ge}from"./icons-yhbeTEay.js";import"./radix-ui-9f16WUVy.js";import"./tree-CNsSXVP0.js";import"./ui-utils-BxIQ3qGg.js";function xe({isVisible:r,onClose:m,sessionId:F,sessionName:a,messages:p,onFork:w,isSubmitting:i=!1,triggerPosition:I,onMessageSelect:g}){const[S,d]=o.useState(""),[j,b]=o.useState(""),[E,N]=o.useState(null),[x,y]=o.useState(!0),c=o.useMemo(()=>p.filter(s=>s.role==="user"),[p]),A=o.useMemo(()=>c.length===0?null:c[c.length-1].id,[c]),u=E??A,f=s=>{if(s.preventDefault(),!u)return;let t=u;if(x){const v=p.findIndex(R=>R.id===u);v>0&&(t=p[v-1].id)}const k={forkPointEntryUuid:t,customName:S.trim()||void 0,description:j.trim()||void 0};w(k)},L=()=>{d(""),b(""),N(null),y(!0)},P=()=>{L(),m()},O=s=>{if(typeof s.content=="string")return s.content.slice(0,100);if(Array.isArray(s.content))for(const t of s.content){if(typeof t=="string")return t.slice(0,100);if(typeof t=="object"&&t!==null){if(t.type==="text"&&"text"in t)return t.text.slice(0,100);if(t.type==="tool_result"&&"content"in t){const k=t.content;if(typeof k=="string")return k.slice(0,100)}}}if(typeof s.content=="object"&&s.content!==null){if("text"in s.content)return s.content.text.slice(0,100);if("content"in s.content&&typeof s.content.content=="string")return s.content.content.slice(0,100)}return"Message content"},T=e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ge,{size:14}),"Fork Session"]});return e.jsx(ne,{isVisible:r,onClose:P,title:T,shouldCloseManually:!0,showPinButton:!1,showInspectorButton:!1,initialPosition:I??"bottom-right",initialSize:{width:400,height:500},resizable:!0,children:e.jsxs("form",{"data-test":"fork-session-form",onSubmit:f,className:"fork-session-form flex flex-col h-full",children:[e.jsxs("div",{"data-test":"fork-session-content",className:"fork-session-content p-4 flex-1 min-h-0 flex flex-col gap-4 overflow-auto",children:[e.jsxs("div",{"data-test":"fork-session-name-field",className:"fork-session-name-field space-y-1",children:[e.jsx(C,{htmlFor:"fork-name",children:"Fork Name (optional)"}),e.jsx(re,{id:"fork-name","data-test":"fork-session-name-input",placeholder:"e.g., Refactor approach, Bug fix v2...",value:S,onChange:s=>d(s.target.value),disabled:i})]}),e.jsxs("div",{"data-test":"fork-session-description-field",className:"fork-session-description-field space-y-1",children:[e.jsx(C,{htmlFor:"fork-description",children:"Description (optional)"}),e.jsx(me,{id:"fork-description","data-test":"fork-session-description-input",placeholder:"Why are you creating this fork?",value:j,onChange:s=>b(s.target.value),disabled:i,rows:2,className:"resize-none"})]}),e.jsxs("div",{"data-test":"fork-session-point-field",className:"fork-session-point-field flex-1 flex flex-col gap-2 min-h-0",children:[e.jsx(C,{children:"Fork Point (select a message)"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:x?"The fork will include all messages up to (but not including) the selected message.":"The fork will include all messages up to and including the selected message."}),e.jsxs("div",{"data-test":"fork-session-exclude-checkbox",className:"flex items-center gap-2",children:[e.jsx(ie,{id:"exclude-selected",checked:x,onCheckedChange:s=>y(s===!0),disabled:i}),e.jsx(C,{htmlFor:"exclude-selected",className:"text-sm font-normal cursor-pointer",children:"Exclude selected message (fork before it)"})]}),e.jsx(le,{"data-test":"fork-session-messages",className:"fork-session-messages flex-1 border rounded-md",children:e.jsx("div",{className:"p-2 space-y-1",children:c.length===0?e.jsx("div",{"data-test":"fork-session-no-messages",className:"text-sm text-muted-foreground text-center py-4",children:"No user messages available to fork from."}):c.map((s,t)=>e.jsx("button",{type:"button","data-test":`fork-session-message-${t}`,className:ce("fork-session-message w-full text-left p-2 rounded-md transition-colors","hover:bg-accent",u===s.id&&"bg-primary/10 border border-primary"),onClick:()=>{N(s.id),g==null||g(s.id)},disabled:i,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(pe,{size:14,className:"mt-0.5 flex-shrink-0 text-muted-foreground"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Message ",t+1]}),e.jsx("div",{className:"text-sm truncate",children:O(s)})]})]})},s.id))})})]})]}),e.jsxs("div",{"data-test":"fork-session-actions",className:"fork-session-actions p-4 border-t flex justify-end gap-2",children:[e.jsx(q,{type:"button",variant:"outline","data-test":"fork-session-cancel",onClick:P,disabled:i,children:"Cancel"}),e.jsx(q,{type:"submit","data-test":"fork-session-submit",disabled:i||!u,children:i?"Creating Fork...":"Create Fork"})]})]})})}function Fe(){const{sessionId:r}=te(),m=oe(),{messages:F,sessionDetails:a,metadata:p,loading:w,pagination:i,currentPage:I,loadOlderMessages:g,searchMessages:S,refreshSession:d,addOptimisticMessage:j,removeOptimisticMessage:b}=de(r,{onSessionDeleted:()=>{m("/claude")}}),{sessions:E,loadingSessions:N,sessionsError:x,pagination:y,currentPage:c,excludeAgents:A,searchSessions:u,refreshSessions:f,handlePageChange:L,handleLoadMore:P,toggleExcludeAgents:O}=ue({loadOnMount:!1,subscribeToSSE:!1});o.useLayoutEffect(()=>{var n,l,h,D,V,G;if(a!=null&&a.cwd){const M=H.getState();((h=(l=(n=M.app)==null?void 0:n.claude)==null?void 0:l.ui)==null?void 0:h.selectedProjectPath)!==a.cwd&&H.updateState({app:{...M.app,claude:{...(D=M.app)==null?void 0:D.claude,ui:{...(G=(V=M.app)==null?void 0:V.claude)==null?void 0:G.ui,selectedProjectPath:a.cwd}}}})}},[a==null?void 0:a.cwd]);const T=n=>{m(`/claude/${n}`)},[s,t]=o.useState(null),[k,v]=o.useState(!1),[R,B]=o.useState(!1),[J,U]=o.useState(!1),[K,$]=o.useState(null),[Q,X]=o.useState(null),Y=o.useCallback(n=>{X(n),B(!0)},[]),z=o.useCallback(()=>{B(!1),$(null)},[]),Z=o.useCallback(n=>{$(n)},[]),ee=o.useCallback(async n=>{if(r){U(!0);try{const l=await W.forkSession(r,n);_.success("Fork created successfully",{description:`Fork "${n.customName||"Unnamed fork"}" has been created.`}),z(),f(),m(`/claude/${l.sessionId}`)}catch(l){console.error("Failed to create fork:",l),_.error("Failed to create fork",{description:l instanceof Error?l.message:"An unknown error occurred"})}finally{U(!1)}}},[r,z,f,m]),se=async(n,l)=>{try{v(!0);const h=await W.searchMessages(n,l);t(h.results),console.log("Message search results:",h)}catch(h){console.error("Message search failed:",h),t([])}finally{v(!1)}};return e.jsxs("div",{className:"session-details-page h-full p-4 overflow-hidden",children:[e.jsxs("div",{className:"session-layout grid grid-cols-[350px_1fr] gap-4 h-full overflow-hidden",children:[e.jsx("div",{className:"sessions-sidebar overflow-hidden",children:e.jsx(ae,{sessions:E,loading:N,error:x,onSessionSelect:T,selectedSessionId:r??null,onRefresh:()=>{f(),d()},pagination:y,currentPage:c,onPageChange:L,onLoadMore:P,onSearch:u,onMessageSearch:se,onNameUpdated:()=>{d(),f()},excludeAgents:A,onToggleExcludeAgents:O})}),e.jsxs("div",{className:"chat-area flex flex-col gap-4 min-h-0 overflow-hidden",children:[e.jsx("div",{className:"chat-messages flex-1 min-h-0 overflow-hidden",children:e.jsx(fe,{messages:F,sessionDetails:a,metadata:p,loading:w,pagination:i,onLoadOlder:i&&I<i.totalPages?g:void 0,onSearch:S,onNameUpdated:()=>{d(),f()},onFork:r?Y:void 0,scrollToMessageId:K})}),e.jsx("div",{className:"chat-input flex-shrink-0",children:r&&e.jsx(he,{sessionId:r,onSendSuccess:()=>{d()},onAddOptimisticMessage:j,onRemoveOptimisticMessage:b})})]})]}),r&&a&&e.jsx(xe,{isVisible:R,onClose:z,sessionId:r,sessionName:a.customName||a.name,messages:F,onFork:ee,isSubmitting:J,onMessageSelect:Z,triggerPosition:Q??void 0})]})}export{Fe as SessionDetailsPage};
