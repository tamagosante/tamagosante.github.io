const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BEUYSeX_.js","assets/react-vendor-Byz07MLO.js","assets/utils-DjFvUtuq.js","assets/radix-ui-B6r6BEmy.js","assets/ui-utils-BxIQ3qGg.js","assets/icons-Detj0uxE.js","assets/index-D__wy4cR.css"])))=>i.map(i=>d[i]);
var Vd=Object.defineProperty;var Ud=(e,s,n)=>s in e?Vd(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n;var He=(e,s,n)=>Ud(e,typeof s!="symbol"?s+"":s,n);import{R as Ie,j as t,r as p,b as sn}from"./react-vendor-Byz07MLO.js";import{c8 as Bc,c9 as In,O as E,ca as Gd,cb as js,cc as J,cd as jt,ce as Yd,cf as Kd,N as De,ai as Z,aS as be,K as le,cg as Xd,ch as ks,ci as vs,cj as Tt,ck as Ce,cl as bs,cm as Ns,cn as mt,aR as qd,aU as Ss,co as Us,cp as Mn,cq as Tn,cr as qe,cs as nr,ct as xt,aJ as Fc,ah as Vn,cu as $c,cv as Zd,cw as wo,ay as Te,a as Q,V as ve,bb as Zt,aY as Wt,aZ as Ht,a_ as Bt,cx as Jd,aT as Lr,cy as Wr,z as yo,F as or,c6 as vo,E as zc,T as ar,bP as _c,bQ as Qd,bR as Vc,bS as Uc,bT as Gc,ac as Ve,I as Re,aV as eu,aP as tu,az as ht,aA as pt,aB as gt,cz as su,cA as Yc,S as ct,h as lt,i as dt,j as ut,k as _e,aj as We,ad as bo,ae as No,af as So,ag as Rt,L as Ee,m as nu,n as ou,o as Hr,p as Br,cB as es,B as Ze,l as Co,aX as au,cC as Fr,cD as $r,cE as ru,bJ as zr,bK as iu,cF as cu,b0 as lu,g as Go,b1 as du,b2 as _r,aw as rr,bc as Kc,cG as bn,P as gs,$ as fs,Q as ms,cH as uu,cI as hu,cJ as xs,R as Yt,al as Vr,av as Gs,cK as pu,cL as gu,cM as fu,cN as mu,cO as xu,cP as ca,cQ as wu,cR as yu,cS as La,cT as vu,cU as Xc,cV as qc,cW as lo,cX as Zc,cY as bu,cZ as Nu,y as dn,c_ as Su,aq as Cu,c$ as la,d0 as ju,d1 as ku,d2 as Au,d3 as Jc,u as Iu,r as Tu,s as Eu,M as Ru,w as Wa,d4 as Mu,d5 as Pu,b9 as Ur,d6 as Du,d7 as Ou,bD as Lu,bE as Wu,bF as da,bG as ua,d8 as ha,d9 as Hu,aD as Bu,bU as Fu,bV as $u,da as zu,b7 as _u,b8 as Vu,db as Uu,dc as Gu}from"./index-BEUYSeX_.js";import{g as Yu,c as st,V as Nn,I as Qc,K as Ku,S as Xu,C as qu,R as Zu,a as Ju,d as Qu}from"./VimInputHandlerV2-v7x6rosp.js";import{t as Se}from"./utils-DjFvUtuq.js";import{a as je}from"./ui-utils-BxIQ3qGg.js";import{b5 as Gr,y as Un,b4 as Yo,as as jo,c2 as Pn,g as Ct,C as Ys,az as eh,b as th,I as sh,aS as uo,bT as Ko,aJ as Cs,bb as el,a as ot,ac as nh,N as oh,c6 as ah,af as Ms,T as yt,c7 as rh,c8 as ih,a7 as tl,Z as ch,aR as lh,c9 as dh,aX as _t,c as Ks,M as ir,bs as cr,ca as sl,S as Jt,e as Pt,h as Dn,cb as nl,br as uh,cc as hh,aY as Fs,bt as ol,a2 as wt,cd as ph,ce as lr,cf as gh,cg as fh,ch as mh,ci as xh,cj as wh,ck as yh,Q as vh,aG as nn,ab as ko,cl as dr,cm as bh,B as al,o as rl,cn as il,co as cl,cp as ll,cq as dl,ag as ur,cr as On,cs as ul,ct as hl,cu as Nh,L as Yr,cv as $t,cw as ws,bf as Ln,bg as Wn,b0 as Xs,cx as Xo,cy as Ha,aL as Sh,cz as Kr,ae as pl,bv as Gn,A as Hn,J as Bn,cA as hr,cB as pr,H as gl,cC as ho,bi as Fn,cD as fl,aM as gr,l as fr,bD as Ch,cE as jh,W as qo,bu as mr,ao as as,R as Zo,cF as kh,cG as Ah,cH as Ih,bL as Th,cI as Eh,cJ as Rh,cK as ml,cL as xr,X as Be,ar as $n,bX as xl,cM as wl,G as Mh,a3 as rs,cN as Ph,ah as Dh,F as yl,aZ as Oh,bQ as Lh,O as on,c5 as Wh,b1 as Jo,d as Yn,q as Hh,$ as vl,E as qt,cO as Qo,aW as Bh,a4 as Fh,U as zn,ai as Ba,bE as $h,c3 as zh,cP as _h,cQ as bl,cR as Ao,cS as Xr,cT as qr,cU as Io,aO as Vh,z as ys,D as po,_ as Nl,b8 as Uh,cV as Gh,aa as Sl,aH as Yh,b2 as Kh,cW as Xh,cX as qh,cY as Zh,cZ as Jh,c_ as Qh,bj as ep,bk as tp,b_ as sp,c$ as np,bV as op,bW as ap,a1 as rp,am as ip,d0 as cp,d1 as lp,a$ as dp,d2 as up,V as hp,d3 as pp,bl as gp}from"./icons-Detj0uxE.js";import{V as Lt,E as fp,D as mp}from"./logging-ChHefsQB.js";import{U as _n}from"./UiButtonWithExpandOption-BD9fK_BY.js";import{T as xp}from"./TextareaPopoverAtCursor-BhwkV6wH.js";import{d as wp,t as Zr}from"./definitionHelper-dps33DtK.js";import{D as qs}from"./DraggableCrudTree-YgeUuqwC.js";import{globalFacadeRegistry as rt}from"./globalFacadeRegistry-BlelMPVg.js";import{W as Zs,S as En,C as yp,a as vp,N as bp,I as Np,e as Jr}from"./WorkflowRowItem-D3RzlFOz.js";import{a as Sp,U as Cp}from"./UiDataTable-DAUK7MTZ.js";import{a as Qr}from"./markdownToHtml-C-4HvgxL.js";import{D as jp}from"./DragDropManager-CacIWg_Z.js";import{D as kp}from"./DraggableTree-swEHR_kM.js";import{u as Ap}from"./useOcr-DYE1Y-ty.js";import{A as Ip,a as Tp}from"./alert-jnVhG4mD.js";import{J as Cl}from"./JsonViewerApp-BHZpouoC.js";import{b as Ep,c as Is,e as pa,h as ga,i as fa,j as ma,C as Rp,a as Mp}from"./context-menu-Cqki0KHo.js";import{a as Pp,b as Dp}from"./easy-form-BS-7nk34.js";import{S as Op}from"./SessionSidebar-CXGqFCn_.js";import{u as Lp,S as Wp}from"./SlashCommandMenu-bS5gDC3O.js";import{g as Hp}from"./cursorPosition-otMhJ5rZ.js";import{a as ei}from"./string-4WCj7OpV.js";import{u as Bp,b as Fp,a as $p}from"./react-hooks-CNdHs55p.js";const zp=e=>e;function kt(e,s=zp){const n=Ie.useSyncExternalStore(e.subscribe,Ie.useCallback(()=>s(e.getState()),[e,s]),Ie.useCallback(()=>s(e.getInitialState()),[e,s]));return Ie.useDebugValue(n),n}const ti=e=>{const s=Bc(e),n=o=>kt(s,o);return Object.assign(n,s),n},wC=(e=>e?ti(e):ti),As=[],z=e=>kt(E,e),Js=e=>kt(In,e),_p=(e,s)=>e.replace(/(\d+\.\d+)/g,n=>parseFloat(n).toFixed(s)),Vp=(e,s,n)=>{var a,i;if(s===0&&n===0)return e;let o="",r=0;for(;r<e.length;){const c=e[r];if(/[A-Za-z]/.test(c)){o+=c,r++;continue}if(/[\s,]/.test(c)){o+=c,r++;continue}let l="";for(;r<e.length&&/[\d.\-+eE]/.test(e[r]);)l+=e[r],r++;if(l){const d=((i=(a=o.match(/[A-Za-z](?=[^A-Za-z]*$)/))==null?void 0:a[0])==null?void 0:i.toUpperCase())||"M",h=(o.slice(o.lastIndexOf(d)+1).match(/-?\d+\.?\d*/g)||[]).length,g=parseFloat(l);let f=g;if(d==="H")f=g+s;else if(d==="V")f=g+n;else if(d==="A"){const w=h%7;w===5?f=g+s:w===6&&(f=g+n)}else h%2===0?f=g+s:f=g+n;o+=f}}return o},Up=(e,s)=>{if(s>=1||e.length<=2)return e;const n=Math.max(1,Math.floor(1/s)),o=[];o.push(e[0]);for(let r=n;r<e.length-1;r+=n)o.push(e[r]);return e.length>1&&o.push(e[e.length-1]),o},jl=(e,s)=>{const n=s/100,o=Math.max(0,Math.floor(s/100*4));return{points:Up(e.points,n),smoothedPath:_p(e.smoothedPath,o)}},kl=(e,s)=>e.type==="freehand"&&e.stroke?{...e,stroke:jl(e.stroke,s)}:e,Al=(e,s)=>{if(s>=100)return e;const n={...e};return e.stroke&&(n.stroke=jl(e.stroke,s)),e.elements&&(n.elements=e.elements.map(o=>kl(o,s))),n},Il=p.createContext(null),Gp=({children:e,value:s})=>t.jsx(Il.Provider,{value:s,children:e}),Tl=()=>{const e=p.useContext(Il);if(e===null)throw new Error("useCanvasRef must be used within a CanvasRefProvider");return e},Yp=e=>{const s=Tl(),n=p.useRef(e);p.useEffect(()=>{n.current=e},[e]),p.useEffect(()=>{const o=s.current;if(!o)return;const r=N=>{var S,C;const b=["[data-prevent-canvas-click]"],j=N.target;b.some(M=>j.closest(M))||(C=(S=n.current.pointer)==null?void 0:S.onPointerDown)==null||C.call(S,N)},a=N=>{var b,j;return(j=(b=n.current.pointer)==null?void 0:b.onPointerMove)==null?void 0:j.call(b,N)},i=N=>{var b,j;return(j=(b=n.current.pointer)==null?void 0:b.onPointerUp)==null?void 0:j.call(b,N)},c=N=>{var b,j;return(j=(b=n.current.pointer)==null?void 0:b.onPointerLeave)==null?void 0:j.call(b,N)},l=N=>{var S,C;const b=["#itemList"],j=N.target;b.some(M=>j.closest(M))||(C=(S=n.current).wheel)==null||C.call(S,N)},d=N=>{var b,j;return(j=(b=n.current.keyboard)==null?void 0:b.onKeyDown)==null?void 0:j.call(b,N)},u=N=>{var b,j;return(j=(b=n.current.keyboard)==null?void 0:b.onKeyUp)==null?void 0:j.call(b,N)},h=N=>{var b,j;return(j=(b=n.current.keyboard)==null?void 0:b.onCopy)==null?void 0:j.call(b,N)},g=N=>{var b,j;return(j=(b=n.current.touch)==null?void 0:b.onTouchStart)==null?void 0:j.call(b,N)},f=N=>{var b,j;return(j=(b=n.current.touch)==null?void 0:b.onTouchMove)==null?void 0:j.call(b,N)},w=N=>{var b,j;return(j=(b=n.current.touch)==null?void 0:b.onTouchEnd)==null?void 0:j.call(b,N)},{pointer:m,wheel:x,touch:y,keyboard:v}=e;return m!=null&&m.onPointerDown&&o.addEventListener("pointerdown",r),m!=null&&m.onPointerMove&&o.addEventListener("pointermove",a),m!=null&&m.onPointerUp&&window.addEventListener("pointerup",i),m!=null&&m.onPointerLeave&&o.addEventListener("pointerleave",c),x&&o.addEventListener("wheel",l,{passive:!1}),y!=null&&y.onTouchStart&&o.addEventListener("touchstart",g,{passive:!1}),y!=null&&y.onTouchMove&&o.addEventListener("touchmove",f,{passive:!1}),y!=null&&y.onTouchEnd&&o.addEventListener("touchend",w,{passive:!1}),v!=null&&v.onKeyDown&&window.addEventListener("keydown",d),v!=null&&v.onKeyUp&&window.addEventListener("keyup",u),v!=null&&v.onCopy&&window.addEventListener("copy",h),()=>{m!=null&&m.onPointerDown&&o.removeEventListener("pointerdown",r),m!=null&&m.onPointerMove&&o.removeEventListener("pointermove",a),m!=null&&m.onPointerUp&&window.removeEventListener("pointerup",i),m!=null&&m.onPointerLeave&&o.removeEventListener("pointerleave",c),x&&o.removeEventListener("wheel",l),y!=null&&y.onTouchStart&&o.removeEventListener("touchstart",g),y!=null&&y.onTouchMove&&o.removeEventListener("touchmove",f),y!=null&&y.onTouchEnd&&o.removeEventListener("touchend",w),v!=null&&v.onKeyDown&&window.removeEventListener("keydown",d),v!=null&&v.onKeyUp&&window.removeEventListener("keyup",u)}},[s])},wr=()=>{const e=Tl();return p.useCallback(s=>{const n=e.current;if(!n)return console.error("Canvas container ref not available in useGetRelativeMousePos"),{x:0,y:0};const o=n.getBoundingClientRect();return{x:s.clientX-o.left,y:s.clientY-o.top}},[e])};function Kp(e){var a,i;const s=e;if(!s){(a=window.getSelection())==null||a.removeAllRanges();return}const n=s.tagName==="TEXTAREA",o=s.tagName==="INPUT",r=s.isContentEditable||!!s.closest('[contenteditable="true"]');n||o||r||(i=window.getSelection())==null||i.removeAllRanges()}function Xp(e){const{selector:s,delay:n=Gd,onFocused:o}=e,r=document.createElement("input");r.style.cssText="position:absolute;opacity:0;height:0;width:0;pointer-events:none;",document.body.appendChild(r),r.focus(),setTimeout(()=>{const a=document.querySelector(s);a&&(a.getAttribute("contenteditable")!=="true"&&(a.contentEditable="true"),a.focus({preventScroll:!0}),o==null||o(a)),r.remove()},n)}const Qs=new js("useCanvasMouseEventsV2",ks.useCanvasMouseEventsV2),qp=e=>{const s=e.target,n=s.closest("[data-canvas-container]");return!n||s.closest("[data-ui-panel]")?null:n},Zp=()=>{p.useEffect(()=>{const e=()=>{if(document.pointerLockElement===null){const s=E.getState().uiState.mode,n=E.getState().uiState.zoomSubMode;if(s===J.ZOOM&&n==="zoom:lock"){const o=E.getState().setZoomSubMode;o("zoom"),Qs.log("Pointer lock released, reset to zoom mode")}}};return document.addEventListener("pointerlockchange",e),()=>{document.removeEventListener("pointerlockchange",e)}},[])},Jp=e=>{const s=wr(),n=Js(i=>i.setMousePosition),o=E.getState(),r=o.uiState.mode,a=o.setIsPanning;return p.useCallback(i=>{const c=s(i);n(c),Qs.log("Generic Pointer Down:",c.x,c.y),Kp(i.target);const l=E.getState().uiState.mode,d=E.getState().uiState.zoomSubMode;if(l===J.ZOOM&&i.button===0){const x=qp(i);if(x){const y=E.getState().setZoomSubMode;d==="zoom:lock"?document.exitPointerLock():(x.requestPointerLock(),y("zoom:lock")),i.preventDefault();return}}if(!(i.button===1||i.button===0&&r===J.MOVE||i.button===-1))return;const h=i.target,g=h.closest("[data-node-id]"),f=h.id.includes("resize-handle-"),w=h.closest("[data-ui-panel]");if(f||w)return;let m=!1;r===J.MOVE?m=!0:g||(m=!0),m&&(Qs.log("Starting Panning"),a(!0),e(c),i.preventDefault())},[s,n,a,e,r])},Qp=()=>{var i;const e=wr(),s=E.getState(),n=(i=s.uiState)==null?void 0:i.isPanning,o=Js(c=>c.setMousePosition),r=s.setActiveCanvasViewState,a=Js(c=>c.mousePosition);return p.useCallback(c=>{const l=E.getState().uiState.mode,d=E.getState().uiState.zoomSubMode,u=document.pointerLockElement!==null;if(l===J.ZOOM&&d==="zoom:lock"&&u){const f=c.movementX,w=c.movementY;r(m=>({...m,offset:{x:m.offset.x+f,y:m.offset.y+w}}));return}const g=e(c);if(n&&a){const f=g.x-a.x,w=g.y-a.y;if(c.pointerType==="touch"){o(g);return}r(m=>({...m,offset:{x:m.offset.x+f,y:m.offset.y+w}}))}o(g)},[e,o,n,a,r])},eg=e=>{var a;const s=wr(),n=E.getState(),o=(a=n.uiState)==null?void 0:a.isPanning,r=n.setIsPanning;return p.useCallback(i=>{const c=s(i);Qs.log("Generic Pointer Up:",c.x,c.y),o&&(r(!1),e(null),Qs.log("Stopped Panning"))},[s,o,r,e])},tg=e=>{var a;const s=E.getState(),n=(a=s.uiState)==null?void 0:a.isPanning,o=s.setIsPanning,r=Js(i=>i.setMousePosition);return p.useCallback(()=>{n&&(o(!1),e(null),Qs.log("Stopped Panning (Mouse Leave)")),r(null)},[n,o,e,r])},un={current:null},xa={current:null},wa={current:0},sg=()=>{const e=E.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=Js(r=>r.mousePosition);return p.useCallback(r=>{r.preventDefault();const a=s();if(!a)return;const{scale:i,offset:c}=a.viewState,d=E.getState().uiState.mode===J.ZOOM;if(r.ctrlKey||r.metaKey||d){if(!o)return;const{min:u,max:h,intensity:g}=Z.zoom,f=r.deltaY<0?1:-1;let w;if(i<=.1){const S=i+f*.01;w=Math.max(u,Math.min(h,S)),w=Math.round(w*100)/100}else{const S=i+f*g*i,C=Math.max(u,Math.min(h,S));w=(f>0?Math.ceil:Math.floor)(C*10)/10}if(w===i)return;const m=jt(o,i,c),x=o.x-m.x*w,y=o.y-m.y*w,v=isNaN(x)?0:x,N=isNaN(y)?0:y,b=isNaN(w)?1:w,j=performance.now(),R=j-wa.current;un.current={newScale:b,newOffsetX:v,newOffsetY:N},R>=16?(n(S=>({...S,scale:b,offset:{x:v,y:N}})),wa.current=j,un.current=null):(xa.current&&clearTimeout(xa.current),xa.current=setTimeout(()=>{if(un.current){const{newScale:S,newOffsetX:C,newOffsetY:M}=un.current;n(I=>({...I,scale:S,offset:{x:C,y:M}})),wa.current=performance.now(),un.current=null}},16-R))}else n(u=>{var y,v;let h=r.deltaX,g=r.deltaY;r.shiftKey&&(h=g,g=0);const f=(((y=u.offset)==null?void 0:y.x)??0)-h,w=(((v=u.offset)==null?void 0:v.y)??0)-g,m=isNaN(f)?0:f,x=isNaN(w)?0:w;return{...u,offset:{x:m,y:x}}})},[s,n,o])};let us=null;const ng=()=>p.useCallback(e=>{var g;const s=Date.now(),n={time:s,x:e.clientX,y:e.clientY};if(us){const f=s-us.time,w=Math.sqrt(Math.pow(n.x-us.x,2)+Math.pow(n.y-us.y,2));if(f>Yd||w>Kd){us=n;return}}else{us=n;return}us=null;const o=E.getState();if(o.uiState.mode!==J.SELECT||e.target.closest("[data-node-id], [data-arrow-id], [data-test='canvas-chat-input-container'], [data-prevent-canvas-click]"))return;const i=o.getCanvasMouseCoords();if(!i)return;const c=window.innerWidth<vs,l=De(10),d=Z.chatInput.mobile.fontConfig,u=c?d.cssFontSize:void 0,h=c?d.baseNodeHeight:be.DEFAULT_NODE_HEIGHT;if(o.addNode({id:l,x:i.x,y:i.y,content:"",type:le.TEXT,height:h,...c&&{styles:{fontSize:u}}}),o.setNodeToFocusId(l),c&&((g=o.projectCanvas.getActive())==null?void 0:g.viewState)){const w=document.querySelector("[data-canvas-container]"),m=(w==null?void 0:w.getBoundingClientRect().top)??0,x=(w==null?void 0:w.getBoundingClientRect().left)??0,y=window.innerWidth,v=window.innerHeight,N=be.DEFAULT_NODE_WIDTH,b=be.DEFAULT_NODE_HEIGHT,j=y/2,R=(v-m)/2+m,S=i.x+N/2,C=i.y+b/2,M=j-x-S,I=R-m-C;o.setActiveCanvasViewState(A=>({...A,targetView:{targetOffset:{x:M,y:I},targetScale:1,animationStartTime:0,animationDuration:Xd}}))}c&&Xp({selector:`#NodeContainerV2-${l} .markdown-textarea`}),e.preventDefault(),e.stopPropagation()},[]),Ke={createTemporaryDrawing:(e,s,n=Tt)=>{const o=e===Ce.FREEHAND;return{subMode:e,points:o?[s]:[],startPoint:o?void 0:s,endPoint:o?void 0:s,style:n}},updateFreehandPoints:(e,s)=>({...e,points:[...e.points,s]}),updateShapeEndPoint:(e,s)=>({...e,endPoint:s}),canFinalizeDraw:e=>e.subMode===Ce.FREEHAND?e.points.length>=2:!e.startPoint||!e.endPoint?!1:Math.hypot(e.endPoint.x-e.startPoint.x,e.endPoint.y-e.startPoint.y)>=5,simplifyPoints:(e,s=2)=>{if(e.length<=2)return e;const n=s*s,o=(i,c,l)=>{let d=0,u=c;const h=i[c],g=i[l],f=g.x-h.x,w=g.y-h.y,m=f*f+w*w;for(let x=c+1;x<l;x++){const y=i[x];let v;if(m===0)v=(y.x-h.x)**2+(y.y-h.y)**2;else{const N=Math.max(0,Math.min(1,((y.x-h.x)*f+(y.y-h.y)*w)/m)),b=h.x+N*f,j=h.y+N*w;v=(y.x-b)**2+(y.y-j)**2}v>d&&(d=v,u=x)}return{index:u,distance:d}},r=(i,c,l,d)=>{const{index:u,distance:h}=o(i,c,l);h>n&&(d[u]=!0,r(i,c,u,d),r(i,u,l,d))},a=new Array(e.length).fill(!1);return a[0]=!0,a[e.length-1]=!0,r(e,0,e.length-1,a),e.filter((i,c)=>a[c])},smoothToSVGPath:(e,s=.5)=>{if(e.length===0)return"";if(e.length===1)return`M ${e[0].x} ${e[0].y}`;if(e.length===2)return`M ${e[0].x} ${e[0].y} L ${e[1].x} ${e[1].y}`;const n=(r,a,i,c)=>{const l=s,d=a.x+(i.x-r.x)*l/6,u=a.y+(i.y-r.y)*l/6,h=i.x-(c.x-a.x)*l/6,g=i.y-(c.y-a.y)*l/6;return`C ${d} ${u}, ${h} ${g}, ${i.x} ${i.y}`};let o=`M ${e[0].x} ${e[0].y}`;o+=" "+n(e[0],e[0],e[1],e[2]||e[1]);for(let r=1;r<e.length-2;r++)o+=" "+n(e[r-1],e[r],e[r+1],e[r+2]);if(e.length>2){const r=e.length-1;o+=" "+n(e[r-2],e[r-1],e[r],e[r])}return o},pointsToPolylinePath:e=>e.length===0?"":e.length===1?`M ${e[0].x} ${e[0].y}`:`M ${e[0].x} ${e[0].y} `+e.slice(1).map(s=>`L ${s.x} ${s.y}`).join(" "),generateShapeSVGPath:e=>{const{shapeType:s,startPoint:n,endPoint:o}=e;switch(s){case"line":return`M ${n.x} ${n.y} L ${o.x} ${o.y}`;case"rectangle":{const r=Math.min(n.x,o.x),a=Math.min(n.y,o.y),i=Math.abs(o.x-n.x),c=Math.abs(o.y-n.y);return`M ${r} ${a} h ${i} v ${c} h ${-i} Z`}case"square":{const r=Math.min(Math.abs(o.x-n.x),Math.abs(o.y-n.y)),a=o.x>=n.x?n.x:n.x-r,i=o.y>=n.y?n.y:n.y-r;return`M ${a} ${i} h ${r} v ${r} h ${-r} Z`}case"circle":{const r=(n.x+o.x)/2,a=(n.y+o.y)/2,i=Math.hypot(o.x-n.x,o.y-n.y)/2;return`M ${r-i} ${a} A ${i} ${i} 0 1 0 ${r+i} ${a} A ${i} ${i} 0 1 0 ${r-i} ${a}`}case"ellipse":{const r=Math.abs(o.x-n.x),a=Math.abs(o.y-n.y),i=o.x>=n.x?1:-1,c=o.y>=n.y?1:-1,l=n.x+i*r/2,d=n.y+c*a/2,u=r/2,h=a/2;return`M ${l-u} ${d} A ${u} ${h} 0 1 0 ${l+u} ${d} A ${u} ${h} 0 1 0 ${l-u} ${d}`}case"arrow":{const r=o.x-n.x,a=o.y-n.y,i=Math.hypot(r,a);if(i<1)return"";const c=r/i,l=a/i,d=Math.min(20,Math.max(8,i*.2)),u=d*.6,h=o.x-c*d,g=o.y-l*d,f=-l,w=c,m=h+f*u,x=g+w*u,y=h-f*u,v=g-w*u;return`M ${n.x} ${n.y} L ${h} ${g} M ${o.x} ${o.y} L ${m} ${x} L ${y} ${v} Z`}default:return""}},calculateFreehandBounds:e=>{if(e.length===0)return{x:0,y:0,width:0,height:0};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e)a.x<s&&(s=a.x),a.y<n&&(n=a.y),a.x>o&&(o=a.x),a.y>r&&(r=a.y);return{x:s,y:n,width:o-s,height:r-n}},calculateShapeBounds:(e,s,n)=>{if(n==="circle"){const c=(e.x+s.x)/2,l=(e.y+s.y)/2,d=Math.hypot(s.x-e.x,s.y-e.y)/2;return{x:c-d,y:l-d,width:d*2,height:d*2}}if(n==="square"){const c=Math.min(Math.abs(s.x-e.x),Math.abs(s.y-e.y)),l=s.x>=e.x?e.x:e.x-c,d=s.y>=e.y?e.y:e.y-c;return{x:l,y:d,width:c,height:c}}const o=Math.min(e.x,s.x),r=Math.min(e.y,s.y),a=Math.abs(s.x-e.x),i=Math.abs(s.y-e.y);return{x:o,y:r,width:a,height:i}},calculateBounds:e=>e.drawType==="freehand"&&e.stroke?Ke.calculateFreehandBounds(e.stroke.points):e.drawType==="shape"&&e.shape?Ke.calculateShapeBounds(e.shape.startPoint,e.shape.endPoint,e.shape.shapeType):{x:0,y:0,width:0,height:0},normalizePoints:(e,s)=>e.map(n=>({x:n.x-s.x,y:n.y-s.y})),finalizeDrawing:e=>{if(!Ke.canFinalizeDraw(e))return null;const s=(e.style.strokeWidth??2)/2;if(e.subMode===Ce.FREEHAND){const c=Ke.calculateFreehandBounds(e.points),l={x:c.x-s,y:c.y-s},u=e.points.length>20?Ke.simplifyPoints(e.points,2):e.points,h=Ke.normalizePoints(u,l),g=Ke.smoothToSVGPath(h);return{drawType:"freehand",stroke:{points:Ke.normalizePoints(e.points,l),smoothedPath:g},style:e.style}}if(!e.startPoint||!e.endPoint)return null;const o={[Ce.RECTANGLE]:"rectangle",[Ce.SQUARE]:"square",[Ce.CIRCLE]:"circle",[Ce.ELLIPSE]:"ellipse",[Ce.LINE]:"line",[Ce.ARROW]:"arrow",[Ce.FREEHAND]:"rectangle"}[e.subMode],r=Ke.calculateShapeBounds(e.startPoint,e.endPoint,o),a={x:r.x-s,y:r.y-s};return{drawType:"shape",shape:{shapeType:o,startPoint:{x:e.startPoint.x-a.x,y:e.startPoint.y-a.y},endPoint:{x:e.endPoint.x-a.x,y:e.endPoint.y-a.y}},style:e.style}},getSubModeFromKey:e=>{switch(e){case"1":return Ce.FREEHAND;case"2":return Ce.RECTANGLE;case"3":return Ce.SQUARE;case"4":return Ce.CIRCLE;case"5":return Ce.ELLIPSE;case"6":return Ce.LINE;case"7":return Ce.ARROW;default:return null}},getSubModeLabel:e=>{switch(e){case Ce.FREEHAND:return"Freehand";case Ce.RECTANGLE:return"Rectangle";case Ce.SQUARE:return"Square";case Ce.CIRCLE:return"Circle";case Ce.ELLIPSE:return"Ellipse";case Ce.LINE:return"Line";case Ce.ARROW:return"Arrow";default:return"Draw"}}};class Le{static buildTextNode(s,n,o){return{id:De(10),type:le.TEXT,content:n,x:s.x,y:s.y,width:s.width,height:s.height,styles:o}}static buildTextNodeV2(s){return{id:De(10),type:le.TEXT,content:s.content||"",x:s.x||0,y:s.y||0,width:s.width||100,height:s.height||100,styles:s.styles||{},options:s.options||{lockSize:!0},...s}}static buildTableNode(s){return{id:De(10),type:le.TABLE,content:null,data:{columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},x:s.x,y:s.y,width:s.width||400,height:s.height||250,styles:{textAlign:"left"}}}static buildTextCardNode(s){return{id:De(10),type:le.TEXTCARD,title:"",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||150,styles:{textAlign:"left"}}}static buildWorkflowOrchestrationNode(s){return{id:`wf-orchestration-${De(6)}`,type:le.WORKFLOW_ORCHESTRATION,title:"Workflow",content:"",x:s.x,y:s.y,width:s.width||400,height:s.height||500,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:[{id:"row_1",label:"Step 1",order:1,stepType:"source",children:[]}]}}}}static buildWorkflowSourceNode(s){return{id:`wf-source-${De(6)}`,type:le.WORKFLOW_SOURCE,title:"Source",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||200,data:{displayFormat:"raw"}}}static buildWorkflowDefinitionNode(s){return{id:`wf-def-${De(6)}`,type:le.WORKFLOW_DEFINITION,title:"Workflow Runner",content:"",x:s.x,y:s.y,width:s.width||280,height:s.height||180,data:{definitionId:void 0,instanceId:void 0,lastExecutionStatus:"idle"}}}static buildOCRNode(s){return{id:`ocr-${De(6)}`,type:le.OCR,title:"OCR",content:"",x:s.x,y:s.y,width:s.width||350,height:s.height||500,data:{image:void 0,extractedText:void 0,detectedLanguage:void 0,confidence:void 0}}}static buildImageNode(s){return{id:`img-${De(6)}`,type:le.IMAGE,title:"Image",content:"",x:s.x,y:s.y,width:s.width||300,height:s.height||250,data:{image:void 0}}}static buildWorkflowStepNode(s){return{id:`wf-step-${De(6)}`,type:le.WORKFLOW_STEP,title:"Workflow Step",content:"",x:s.x,y:s.y,width:s.width||260,height:s.height||180,data:{stepType:void 0,config:{}}}}static buildVocabularyNode(s){return{id:`vocab-${De(6)}`,type:le.VOCABULARY,title:"Vocabulary",content:"",x:s.x,y:s.y,width:s.width||320,height:s.height||280,data:{vocabType:"vocabulary",term:"",definition:"",sourceWord:"",translationWord:""}}}static buildDrawingNode(s,n){return{id:`draw-${De(6)}`,type:le.DRAWING,content:"",x:s.x,y:s.y,width:s.width||100,height:s.height||100,data:n}}}const og=Object.freeze(Object.defineProperty({__proto__:null,CanvasNodeBuilderV2:Le},Symbol.toStringTag,{value:"Module"}));function ea(e,s,n="right",o={}){var u;const{shouldFocus:r=!0,createArrow:a=!0}=o,i=E.getState();let c=e.width,l=e.height;if(!c||!l){const h=Z.nodeOptions.maxNodeWidth;c=Math.min(bs(e.content),h)+Ns.textNodeXPadding,l=mt(e.content,c,e)}switch((u=i.projectCanvas.getActive())==null||u.viewState.offset,n){case"left":e.x=s.x-c-be.nodeSpacing*3,e.y=s.y;break;case"right":e.x=s.x+(s.width??0)+be.nodeSpacing*3,e.y=s.y;break;case"above":e.y=s.y-be.nodeSpacing*3;break;case"below":e.y=s.y+(s.height??0)+be.nodeSpacing;break}const d={...e,width:c,height:l};if(i.addNode(d,void 0,{dontOverlap:!0,dontSelect:!0}),r&&i.setNodeToFocusId(s.id),a){const h=()=>Math.random().toString(36).slice(2,10),g=f=>({x:(f.x??0)+(f.width??0)/2,y:(f.y??0)+(f.height??0)/2});window.setTimeout(()=>{i.arrow.add({id:h(),startNodeId:s.id,endNodeId:d.id,startPoint:g(s),endPoint:g(d)})},0)}}function El(e,s,n){let o=e;for(;o&&!o.hasAttribute("data-text-position-container");)o=o.parentElement;if(!o)return null;const r=window.getComputedStyle(e),a=document.createElement("div");a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.visibility="hidden",a.style.font=r.font,a.style.fontSize=r.fontSize,a.style.fontFamily=r.fontFamily,a.style.fontWeight=r.fontWeight,a.style.lineHeight=r.lineHeight,a.style.letterSpacing=r.letterSpacing,a.style.wordSpacing=r.wordSpacing,a.style.padding=r.padding,a.style.width=`${e.clientWidth}px`,a.style.border="none",a.style.whiteSpace=r.whiteSpace,a.style.wordWrap=r.wordWrap,a.style.overflowWrap=r.overflowWrap,a.textContent=e.value,o?o.appendChild(a):document.body.appendChild(a);try{const i=document.createRange(),c=a.firstChild;if(!c||c.nodeType!==Node.TEXT_NODE)return null;i.setStart(c,s),i.setEnd(c,n);const l=i.getClientRects();if(l.length===0)return null;const d=l[0],u=o==null?void 0:o.getBoundingClientRect();if(!u)return null;const h={top:d.top-u.top,left:d.left-u.left},g=parseFloat(r.paddingTop)||0,f=parseFloat(r.paddingLeft)||0,w=h.top-g,m=h.left-f;return{top:w,left:m,width:d.width,height:d.height}}finally{o&&a.parentNode===o?o.removeChild(a):a.parentNode===document.body&&document.body.removeChild(a)}}const Mt=e=>/[\w\u00C0-\u024F]/.test(e);function si(e,s){if(!e||s<0||s>e.length)return!1;const n=e[s]||"",o=e[s-1]||"",r=Mt(o),a=Mt(n);return r&&!a||!r&&a}function ag(e,s){if(!e||s<0||s>e.length)return null;const n=e[s]||"",o=e[s-1]||"";if(!Mt(n)&&!Mt(o))return null;let r=s;for(;r>0&&Mt(e[r-1]);)r--;let a=s;for(;a<e.length&&Mt(e[a]);)a++;return r<a?{start:r,end:a,word:e.substring(r,a)}:null}function ni(e,s){const n=ag(e,s);return n?{start:n.start,end:n.end}:null}function oi(e,s){if(!e||s<0||s>e.length)return null;let n=s;for(;n>0&&!Mt(e[n-1]);)n--;if(n===0)return null;let o=n;for(;o>0&&Mt(e[o-1]);)o--;let r=s;for(;r<e.length&&!Mt(e[r]);)r++;if(r>=e.length)return null;let a=r;for(;a<e.length&&Mt(e[a]);)a++;return{start:o,end:a}}function ai(e,s){for(;s>0&&Mt(e[s-1]);)s--;return s}function ri(e,s){for(;s<e.length&&Mt(e[s]);)s++;return s}function rg(e,s,n){var h;const o=document.createRange(),r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let a=0,i=null,c=0,l=null,d=0,u;for(;u=r.nextNode();){const g=((h=u.textContent)==null?void 0:h.length)||0;if(!i&&a+g>=s&&(i=u,c=s-a),!l&&a+g>=n){l=u,d=n-a;break}a+=g}if(i&&l)try{return o.setStart(i,c),o.setEnd(l,d),o}catch(g){return console.warn("Failed to create text range:",g),null}return null}var Fa=(e=>(e.CONTENT_CAPTURE="content-capture",e.REGULAR="regular",e))(Fa||{});const Rl=(e,s)=>{const n=new Set(s.map(o=>o.id));return e.filter(o=>o.startNodeId&&o.endNodeId&&n.has(o.startNodeId)&&n.has(o.endNodeId))},ig=e=>e.type===le.GROUP||e.type==="GROUP",cg=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=[...e];for(const r of e)if(ig(r)){const a=r.data,i=(a==null?void 0:a.childNodeIds)??[];for(const c of i)if(!n.has(c)){const l=s.find(d=>d.id===c);l&&(o.push(l),n.add(c))}}return o},lg=(e,s,n)=>{const o=Rl(s,e),r={nodes:e};return o.length>0&&(r.arrows=o),n!=null&&n.canvasConfig&&(r.canvasConfig=n.canvasConfig),r},Ml=e=>{var l;const s=E.getState(),n=s.projectCanvas.getActive();if(!n)return null;const{nodes:o,arrows:r,selectedNodes:a}=n.coreState,i=a.length>0?cg(a,o):o;if(i.length===0)return null;const c=e!=null&&e.includeConfig?(l=s.preferences)==null?void 0:l.canvasConfig:void 0;return lg(i,r,{canvasConfig:c})},Pl=async(e,s)=>{var n;try{if(await navigator.clipboard.writeText(JSON.stringify(e,null,2)),(s==null?void 0:s.showToast)!==!1){const o=(n=e.arrows)!=null&&n.length?` and ${e.arrows.length} arrow(s)`:"";Se.success(`Copied ${e.nodes.length} node(s)${o}`)}return!0}catch(o){return console.error("Failed to copy to clipboard:",o),(s==null?void 0:s.showToast)!==!1&&Se.error("Failed to copy to clipboard"),!1}},Dl=async e=>{const s=Ml({includeConfig:e==null?void 0:e.includeConfig});return s?Pl(s,{showToast:e==null?void 0:e.showToast}):(Se.info("No nodes to copy"),!1)},dg=e=>{try{const s=JSON.parse(e);if(!s)return null;const n=Array.isArray(s.nodes)&&s.nodes.length>0,o=Array.isArray(s.arrows)&&s.arrows.length>0;return n||o?s:null}catch{return null}};function ug(e){const s=e.split(qd);if(s.length===2)try{return{type:"content-capture",data:JSON.parse(s[1])}}catch{}const n=dg(e);return n?{type:"content-capture",data:n}:{type:"regular",content:s[0]}}const hg={id:"noDuplicateHeaders",name:"No Duplicate Headers",description:"Warn when same header text appears multiple times",defaultSeverity:"warning",check:(e,s)=>{const n=[],o=new Map;for(let r=0;r<s.length;r++){const a=s[r].match(/^#{1,6}\s+(.+)$/);if(a){const i=a[1].trim().toLowerCase(),c=o.get(i);c!==void 0?n.push({ruleId:"no-duplicate-headers",severity:"warning",message:`Duplicate header "${a[1].trim()}" (first seen on line ${c})`,line:r+1}):o.set(i,r+1)}}return n}},pg={id:"headerIncrement",name:"Header Increment",description:"Headers should only increment by one level",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=0;r<s.length;r++){const a=s[r].match(/^(#{1,6})\s+/);if(a){const i=a[1].length;o>0&&i>o+1&&n.push({ruleId:"header-increment",severity:"warning",message:`Header level jumped from H${o} to H${i} (should be H${o+1})`,line:r+1}),o=i}}return n}},gg={id:"noEmptyHeaders",name:"No Empty Headers",description:"Headers must have content after the # markers",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^#{1,6}\s*$/.test(r)&&n.push({ruleId:"no-empty-headers",severity:"error",message:"Header has no content",line:o+1})}return n}},fg={id:"firstHeaderH1",name:"First Header H1",description:"Document should start with H1",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].match(/^(#{1,6})\s+/);if(r){const a=r[1].length;a!==1&&n.push({ruleId:"first-header-h1",severity:"info",message:`First header should be H1, found H${a}`,line:o+1});break}}return n}},mg={id:"noTrailingSpaces",name:"No Trailing Spaces",description:"Lines shouldn't end with trailing spaces",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];r.endsWith(" ")&&!r.endsWith("  ")&&n.push({ruleId:"no-trailing-spaces",severity:"warning",message:"Line has trailing spaces",line:o+1,column:r.trimEnd().length+1})}return n}},xg={id:"noMultipleBlanks",name:"No Multiple Blanks",description:"No more than 1 consecutive blank line",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0,r=0;for(let a=0;a<s.length;a++)s[a].trim()===""?(o===0&&(r=a+1),o++):(o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:a}),o=0);return o>1&&n.push({ruleId:"no-multiple-blanks",severity:"warning",message:`${o} consecutive blank lines (max 1)`,line:r,endLine:s.length}),n}},wg={id:"noLeadingWhitespace",name:"No Leading Whitespace",description:"Content shouldn't start with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let a=0;a<s.length&&s[a].trim()==="";a++)o++;o>0&&n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`Content starts with ${o} blank line(s)`,line:1,endLine:o});const r=s.find(a=>a.trim()!=="");if(r&&/^\s+/.test(r)){const a=r.match(/^(\s+)/),i=a?a[1].length:0;n.push({ruleId:"no-leading-whitespace",severity:"warning",message:`First content line starts with ${i} whitespace character(s)`,line:o+1,column:1})}return n}},yg={id:"noTrailingWhitespace",name:"No Trailing Whitespace",description:"Content shouldn't end with blank lines or whitespace",defaultSeverity:"warning",check:(e,s)=>{const n=[];let o=0;for(let r=s.length-1;r>=0&&s[r].trim()==="";r--)o++;return o>0&&n.push({ruleId:"no-trailing-whitespace",severity:"warning",message:`Content ends with ${o} blank line(s)`,line:s.length-o+1,endLine:s.length}),n}},vg={id:"consistentEmphasis",name:"Consistent Emphasis",description:"Use same style for emphasis (* vs _)",defaultSeverity:"info",check:e=>{const s=[],n=e.match(new RegExp("(?<!\\*)\\*(?!\\*)([^*]+)(?<!\\*)\\*(?!\\*)","g")),o=e.match(new RegExp("(?<!_)_(?!_)([^_]+)(?<!_)_(?!_)","g"));n&&o&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both *italic* and _italic_",line:1});const r=e.match(/\*\*([^*]+)\*\*/g),a=e.match(/__([^_]+)__/g);return r&&a&&s.push({ruleId:"consistent-emphasis",severity:"info",message:"Mixed emphasis styles: using both **bold** and __bold__",line:1}),s}},bg={id:"noSpaceInEmphasis",name:"No Space in Emphasis",description:"No spaces inside emphasis markers",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\*\*\s+[^*]+\*\*|\*\*[^*]+\s+\*\*/);a&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside bold markers: ** text ** should be **text**",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(new RegExp("(?<!\\*)\\*\\s+[^*]+\\*(?!\\*)|\\*[^*]+\\s+\\*(?!\\*)"));i&&n.push({ruleId:"no-space-in-emphasis",severity:"warning",message:"Spaces inside italic markers: * text * should be *text*",line:o+1,column:r.indexOf(i[0])+1})}return n}},Ng={id:"noEmptyLinks",name:"No Empty Links",description:"Links must have both text and URL",defaultSeverity:"error",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=r.match(/\[\]\([^)]+\)/);a&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no text: [](url)",line:o+1,column:r.indexOf(a[0])+1});const i=r.match(/\[[^\]]+\]\(\s*\)/);i&&n.push({ruleId:"no-empty-links",severity:"error",message:"Link has no URL: [text]()",line:o+1,column:r.indexOf(i[0])+1})}return n}},Sg={id:"noBareUrls",name:"No Bare URLs",description:"URLs should be wrapped in link syntax [text](url)",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o],a=new RegExp("(?<!\\]\\()https?:\\/\\/[^\\s\\)]+","g");let i;for(;(i=a.exec(r))!==null;)r.substring(0,i.index).endsWith("](")||n.push({ruleId:"no-bare-urls",severity:"info",message:`Bare URL found: ${i[0].substring(0,30)}...`,line:o+1,column:i.index+1})}return n}},Cg={id:"consistentListMarker",name:"Consistent List Marker",description:"Use same marker for unordered lists (- vs * vs +)",defaultSeverity:"info",check:(e,s)=>{const n=[],o=new Set;let r=0,a="";for(let i=0;i<s.length;i++){const c=s[i].match(/^(\s*)([*+-])\s+/);if(c){const l=c[2];o.size===0&&(r=i+1,a=l),o.add(l)}}return o.size>1&&n.push({ruleId:"consistent-list-marker",severity:"info",message:`Mixed list markers: using ${Array.from(o).join(", ")} (first "${a}" on line ${r})`,line:1}),n}},jg={id:"noEmptyListItems",name:"No Empty List Items",description:"List items must have content",defaultSeverity:"warning",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o];/^\s*[*+-]\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty list item",line:o+1}),/^\s*\d+\.\s*$/.test(r)&&n.push({ruleId:"no-empty-list-items",severity:"warning",message:"Empty ordered list item",line:o+1})}return n}},kg={id:"orderedListPrefix",name:"Ordered List Prefix",description:"Ordered lists should use 1. or sequential numbering",defaultSeverity:"info",check:(e,s)=>{const n=[];let o=1,r=!1;for(let a=0;a<s.length;a++){const i=s[a].match(/^(\s*)(\d+)\.\s+/);if(i){const c=parseInt(i[2],10);r||(r=!0,o=1),c!==1&&c!==o&&n.push({ruleId:"ordered-list-prefix",severity:"info",message:`Ordered list item ${c}. should be ${o}. (or use 1. for all)`,line:a+1}),o++}else s[a].trim()===""&&(r=!1,o=1)}return n}},Ag={id:"tableColumnCount",name:"Table Column Count",description:"All table rows should have the same column count",defaultSeverity:"error",check:(e,s)=>{const n=[];let o=-1,r=0;for(let a=0;a<s.length;a++){const i=s[a].trim();if(i.startsWith("|")||i.includes("|")&&/\|.+\|/.test(i)){const c=i.split("|").filter(l=>l.trim()!=="").length;o===-1?(o=a+1,r=c):c!==r&&(/^[\s|:-]+$/.test(i)||n.push({ruleId:"table-column-count",severity:"error",message:`Table row has ${c} columns, expected ${r}`,line:a+1}))}else o!==-1&&i===""&&(o=-1,r=0)}return n}},Ig={id:"noEmptyTableCells",name:"No Empty Table Cells",description:"Warn on empty table cells",defaultSeverity:"info",check:(e,s)=>{const n=[];for(let o=0;o<s.length;o++){const r=s[o].trim();if(!/^[\s|:-]+$/.test(r)&&(r.startsWith("|")||r.includes("|")&&/\|.+\|/.test(r))){const a=r.split("|");for(let i=1;i<a.length-1;i++)a[i].trim()===""&&n.push({ruleId:"no-empty-table-cells",severity:"info",message:`Empty table cell in column ${i}`,line:o+1})}}return n}},Tg=[hg,pg,gg,fg,mg,xg,wg,yg,vg,bg,Ng,Sg,Cg,jg,kg,Ag,Ig],Eg=Object.fromEntries(Tg.map(e=>[e.id,e]));function Rg(e,s){const n=[],o=e.split(`
`);for(const[r,a]of Object.entries(s)){if(!(a!=null&&a.enabled))continue;const i=Eg[r];if(!i){console.warn(`Unknown lint rule: ${r}`);continue}const c=i.check(e,o),l=a.severity??i.defaultSeverity;for(const d of c)n.push({...d,severity:l})}return n.sort((r,a)=>r.line!==a.line?r.line-a.line:(r.column??0)-(a.column??0)),n}function Mg(e){return{total:e.length,errors:e.filter(s=>s.severity==="error").length,warnings:e.filter(s=>s.severity==="warning").length,infos:e.filter(s=>s.severity==="info").length}}function Pg(e){if(e.length===0)return"No issues found.";const s=e.map(o=>{const r=o.column?`${o.line}:${o.column}`:`${o.line}`,a=o.severity.toUpperCase().padEnd(7);return`  ${r.padEnd(8)} ${a} ${o.message} (${o.ruleId})`}),n=Mg(e);return s.push(""),s.push(`Found ${n.total} issue(s): ${n.errors} error(s), ${n.warnings} warning(s), ${n.infos} info(s)`),s.join(`
`)}function Dg(e){let s=e.split(`
`);for(;s.length>0&&s[0].trim()==="";)s.shift();for(s.length>0&&(s[0]=s[0].trimStart());s.length>0&&s[s.length-1].trim()==="";)s.pop();const n=[];let o=!1;for(const r of s)if(r.trim()==="")o||n.push(r),o=!0;else{const i=o?r.trimStart():r;n.push(i),o=!1}return n.join(`
`)}const ii={noEmptyHeaders:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},noEmptyLinks:{enabled:!0},noEmptyListItems:{enabled:!0},tableColumnCount:{enabled:!0}},Og={noDuplicateHeaders:{enabled:!0},headerIncrement:{enabled:!0},noEmptyHeaders:{enabled:!0},firstHeaderH1:{enabled:!0},noTrailingSpaces:{enabled:!0},noMultipleBlanks:{enabled:!0},noLeadingWhitespace:{enabled:!0},noTrailingWhitespace:{enabled:!0},consistentEmphasis:{enabled:!0},noSpaceInEmphasis:{enabled:!0},noEmptyLinks:{enabled:!0},noBareUrls:{enabled:!0},consistentListMarker:{enabled:!0},noEmptyListItems:{enabled:!0},orderedListPrefix:{enabled:!0},tableColumnCount:{enabled:!0},noEmptyTableCells:{enabled:!0}};function Lg(e){switch(e){case"disabled":return null;case"simple":return{...ii};case"comprehensive":return{...Og};default:return{...ii}}}function ci(e,s,n){let o=0,r=!1;const a=[];function i(c){var l,d,u,h,g,f,w;if(r)return!0;if(c===s)return c.nodeType===Node.TEXT_NODE?(a.push(`FOUND target text node "${(l=c.textContent)==null?void 0:l.substring(0,20)}", adding targetOffset ${n}`),o+=n):a.push(`FOUND target element node, type=${c.tagName}`),r=!0,!0;if(c.nodeType===Node.TEXT_NODE){const m=((d=c.textContent)==null?void 0:d.length)||0;a.push(`text "${(u=c.textContent)==null?void 0:u.substring(0,20)}" +${m} → ${o+m}`),o+=m}else if(c.nodeType===Node.ELEMENT_NODE){const m=c,x=m.tagName;if(x==="BR")return a.push(`BR +1 → ${o+1}`),o+=1,!1;let y=0,v=!1,N=!1;if(x==="H1")y=2;else if(x==="H2")y=3;else if(x==="H3")y=4;else if(x==="BLOCKQUOTE")y=2;else if(m.classList.contains("list-item-ul"))y=2,v=!0,((h=m.previousElementSibling)!=null&&h.classList.contains("list-item-ul")||(g=m.previousElementSibling)!=null&&g.classList.contains("list-item-ol"))&&(N=!0);else if(m.classList.contains("list-item-ol")){const j=m.querySelector("span:first-child");y=((j==null?void 0:j.textContent)||"1.").length+1,v=!0,((f=m.previousElementSibling)!=null&&f.classList.contains("list-item-ul")||(w=m.previousElementSibling)!=null&&w.classList.contains("list-item-ol"))&&(N=!0)}else if(m.classList.contains("empty-line"))return a.push(`empty-line +1 → ${o+1}`),o+=1,!1;N&&(a.push(`newline before block +1 → ${o+1}`),o+=1),y>0&&a.push(`${x} prefix +${y} → ${o+y}`),o+=y;const b=Array.from(c.childNodes);for(let j=0;j<b.length;j++)if(!(v&&j===0&&b[j].nodeName==="SPAN")&&i(b[j]))return!0}return!1}return i(e),o}let tt=null,ya=!1;typeof window<"u"&&(window.addEventListener("keydown",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(ya=!0)},!0),window.addEventListener("keyup",e=>{(e.key==="Control"||e.key==="Alt"||e.key==="Meta")&&(ya=!1)},!0),document.addEventListener("selectionchange",()=>{const e=window.getSelection();ya||!e||e.isCollapsed||(tt={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,text:e.toString(),timestamp:Date.now()})}));const Ye=class Ye{static lintPastedContent(s){const n=Z.lint.onPastePreset,o=Lg(n);if(!o)return;const r=Rg(s,o);r.length>0&&(console.warn(`[Markdown Linter] Found ${r.length} issue(s) in pasted content:`),console.warn(Pg(r)))}onMouseDown(s){const n=E.getState(),o=n.uiState,{mode:r,addNodeType:a}=o,i=n.getCanvasMouseCoords();if(r!==J.ADD||a!==le.TEXT||!i)return!1;const c=Le.buildTextNode(i,"");return n.addNode(c),n.setNodeToFocusId(c.id),!0}async onPaste(s){var w,m;const n=E.getState(),o=await Yu();if(!o)return!1;const r=ug(o);if(r.type===Fa.CONTENT_CAPTURE){const x=n.getCanvasMouseCoords();if(x)return this.createNodesFromContentCapture(r.data,x),n.setNodeToFocusId(null),s.preventDefault(),!0}const a=r.type===Fa.REGULAR?r.content:o,i=Dg(a),{mode:c,addNodeType:l,nodeToFocusId:d}=n.uiState,u=((w=n.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??[];if(d){const x=n.getNodeById(d);if(x&&typeof x.content=="string"&&u.length>0){const v=(x.content||"")+i;if(!((m=x.options)!=null&&m.lockSize)){let b;const j=document.querySelector("textarea[data-node-textarea]");if(j){const I=window.getComputedStyle(j).lineHeight;if(I&&I!=="normal"){const A=parseFloat(I);isNaN(A)||(b=A)}}const R=Ss(v,b,x),S=Math.min(R.width,Z.paste.maxWidth);let C=R.height;S<R.width&&(C=mt(v,S,x)),n.updateNode(x.id,{...x,content:v,width:S,height:C})}else n.updateNode(x.id,{...x,content:v});return s.preventDefault(),Ye.lintPastedContent(i),!0}}const h=n.getCanvasMouseCoords(),g=c===J.ADD&&l===le.TEXT&&h,f=!d&&h;if(g){const x=Le.buildTextNode(h,i);return n.addNode(x),n.setNodeToFocusId(null),n.setMode(J.SELECT),n.setAddNodeType(null),s.preventDefault(),Ye.lintPastedContent(i),!0}else if(f){const x=n.getSegmentedButtonAction("canvas-fit-width");let y=null;if(x){const R=/Set width to (\d+)px/.exec(x);R&&(y=parseInt(R[1],10))}let v,N,b;if(y)N=mt(i,y),v=y,b=!0;else{const R=document.querySelector("textarea[data-node-textarea]");R&&window.getComputedStyle(R).lineHeight;const S=Ss(i);v=Math.min(S.width,Z.paste.maxWidth),v<S.width?N=mt(i,v):N=S.height,b=!1}const j=Le.buildTextNodeV2({x:h.x,y:h.y,width:v,height:N,content:i,styles:{textAlign:"left"},options:{lockSize:b}});return n.addNode(j),n.setNodeToFocusId(null),s.preventDefault(),Ye.lintPastedContent(i),!0}return!1}isGroupNodeType(s){return s.type===le.GROUP||s.type==="GROUP"}createNodesFromContentCapture(s,n){const o=E.getState(),{pasteWidth:r,nodeGap:a}=Z.contentCapture,i=Math.min(...s.nodes.map(y=>y.x)),c=Math.min(...s.nodes.map(y=>y.y)),l=n.x-i,d=n.y-c,u=new Map,h=s.nodes.every(y=>y.width&&y.height);let g=n.y;const f=[];for(const y of s.nodes){const v=y.content||"",N=this.isGroupNodeType(y);let b,j,R;y.width&&y.height?(b=y.width,j=y.height,R=h?y.y+d:g):(b=r,j=mt(v,r),R=g);let S;if(N){const C=new Date().toISOString();S={...y,id:De(10),type:le.GROUP,x:y.x+l,y:R,width:b,height:j,createdAt:C,updatedAt:C}}else S={...y,id:De(10),x:y.x+l,y:R,width:b,height:j,content:v,styles:y.styles??{textAlign:"left"},options:y.options??{lockSize:!h},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};u.set(y.id,S.id),f.push({oldNode:y,newNode:S}),h||(g+=j+a)}for(const{oldNode:y,newNode:v}of f){if(y.groupId){const N=u.get(y.groupId);N?v.groupId=N:delete v.groupId}else delete v.groupId;if(this.isGroupNodeType(y)){const N=y.data,j=((N==null?void 0:N.childNodeIds)??[]).map(R=>u.get(R)).filter(R=>R!==void 0);v.data={...N??{},childNodeIds:j}}o.addNode(v,void 0,{skipUndo:!0})}const w=f.map(({newNode:y})=>({type:"node:create",node:y})),m=[];for(const y of s.arrows??[]){const v=y.startNodeId?u.get(y.startNodeId):null,N=y.endNodeId?u.get(y.endNodeId):null;if(v&&N){const b={id:De(10),startNodeId:v,endNodeId:N,startPoint:{x:0,y:0},endPoint:{x:0,y:0}};o.arrow.add(b),m.push(b),w.push({type:"arrow:create",arrow:b})}}w.length>0&&o.undo.commit({type:"batch",label:`Paste ${f.length} node${f.length!==1?"s":""}${m.length>0?` and ${m.length} arrow${m.length!==1?"s":""}`:""}`,operations:w});const x=f.map(y=>y.newNode);o.setSelectedNodes(x),m.length>0&&o.arrow.setSelected(m)}onCopy(s){var h,g;const{focus:n,sourceNode:o,side:r="right"}=s||{focus:!0},a=E.getState(),{mode:i,nodeToFocusId:c}=a.uiState;if(!i)return null;const l=((h=a.projectCanvas.getActive())==null?void 0:h.coreState.selectedNodes)??[],d=Date.now();let u=!1;if(Ye.lastCopyTimestamp&&d-Ye.lastCopyTimestamp<Ye.DOUBLE_COPY_INTERVAL_MS&&(u=!0),Ye.lastCopyTimestamp=d,u)return null;{let f=o;return f||(f=l[0],f||(f=(((g=a.projectCanvas.getActive())==null?void 0:g.coreState.nodes)??[]).find(y=>y.id===c))),Wg(f,n?c:null,n,r)}}highlightAndCreateNode(s,n="right"){var d;const o=E.getState(),r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c=!1,l=null;if(a){const u=r,h=u.value;let g=u.selectionStart,f=u.selectionEnd;if(g===f)if(si(h,g)){const w=oi(h,g);w&&(g=w.start,f=w.end)}else{const w=ni(h,g);w&&(g=w.start,f=w.end)}else g=ai(h,g),f=ri(h,f);(g!==u.selectionStart||f!==u.selectionEnd)&&u.setSelectionRange(g,f),c=g!==f}else if(i){const u=window.getSelection(),h=r.textContent||"";let g=!!(u&&!u.isCollapsed&&u.toString().trim());if(u&&u.rangeCount>0){const f=u.getRangeAt(0),w=document.createRange();w.setStart(r,0),w.setEnd(f.startContainer,f.startOffset);let m=w.toString().length;const x=document.createRange();x.setStart(r,0),x.setEnd(f.endContainer,f.endOffset);let y=x.toString().length;if(m===y)if(si(h,m)){const v=oi(h,m);v&&(m=v.start,y=v.end)}else{const v=ni(h,m);v&&(m=v.start,y=v.end)}else m=ai(h,m),y=ri(h,y);if(m!==y){const v=rg(r,m,y);v&&(u.removeAllRanges(),u.addRange(v),l=v.cloneRange(),g=!0)}}c=g,c&&u&&u.rangeCount>0&&!l&&(l=u.getRangeAt(0).cloneRange())}if(c){s.preventDefault();const{nodeToFocusId:u}=o.uiState,h=o.projectCanvas.getActive();let f=((h==null?void 0:h.coreState.selectedNodes)??[])[0];!f&&u&&(f=((h==null?void 0:h.coreState.nodes)??[]).find(v=>v.id===u));const w=a?r.selectionStart:0,m=a?r.selectionEnd:0;Ye.dismissPopoverCallback&&Ye.dismissPopoverCallback();const x=this.onCopy({focus:!1,sourceNode:f,side:n});if(setTimeout(()=>{if(r.focus(),a)r.setSelectionRange(w,m);else if(i&&l){const y=window.getSelection();y&&(y.removeAllRanges(),y.addRange(l))}},0),f!=null&&f.highlights&&f.highlights.length>1&&x){const v=(((d=o.projectCanvas.getActive())==null?void 0:d.coreState.nodes)??[]).find(b=>b.id===f.id),N=window.__showLinkedNodesPopover;N&&v&&N(v,x)}}else{const{nodeToFocusId:u}=o.uiState,h=o.projectCanvas.getActive();let f=((h==null?void 0:h.coreState.selectedNodes)??[])[0];if(!f&&u&&(f=((h==null?void 0:h.coreState.nodes)??[]).find(m=>m.id===u)),f!=null&&f.highlights&&f.highlights.length>0){s.preventDefault();const w=window.__showLinkedNodesPopover;w&&w(f,null)}}}static registerSelectionCallback(s){Ye.selectionChangeCallback=s}static unregisterSelectionCallback(){Ye.selectionChangeCallback=null}static registerDismissPopoverCallback(s){Ye.dismissPopoverCallback=s}static unregisterDismissPopoverCallback(){Ye.dismissPopoverCallback=null}onTextSelect(s,n,o){const r=n!==o;Ye.selectionChangeCallback&&Ye.selectionChangeCallback(r)}};He(Ye,"lastCopyTimestamp",null),He(Ye,"DOUBLE_COPY_INTERVAL_MS",400),He(Ye,"selectionChangeCallback",null),He(Ye,"dismissPopoverCallback",null);let Kt=Ye;function Wg(e,s,n=!0,o="right"){var A,O,F,B;if(!e)return console.warn("No target node found for copy action."),null;const r=document.activeElement,a=(r==null?void 0:r.tagName)==="TEXTAREA",i=(r==null?void 0:r.classList.contains("markdown-textarea"))&&r.isContentEditable;let c="",l=null,d=0,u=0;if(a){const W=r;d=W.selectionStart,u=W.selectionEnd,c=W.value.substring(d,u);const P=El(W,d,u);if(P)l=new DOMRect(0,P.top,P.width,P.height);else{const k=be.LINE_HEIGHT,T=4,$=W.value.substring(0,d).split(`
`).length-1,_=T+$*k;l=new DOMRect(0,_,0,k)}}else if(i){const W=window.getSelection(),P=5e3,k=tt&&((A=tt.anchorNode)==null?void 0:A.nodeType)===Node.TEXT_NODE&&tt.text.length>0,T=tt&&k&&Date.now()-tt.timestamp<P;let L,H,$;if(T&&tt)L=tt.anchorNode,H=tt.focusNode,$=tt.focusOffset,c=tt.text;else if(W)L=W.anchorNode,H=W.focusNode,$=W.focusOffset,c=W.toString();else return null;const _=W;if(_&&_.rangeCount>0){const G=_.getRangeAt(0),V=r.getBoundingClientRect(),D=G.getClientRects();if(D.length>0){const de=D[0],pe=de.top-V.top;l=new DOMRect(0,pe,de.width,de.height)}const Y=e.content||"",te=de=>{let pe=de;for(;pe&&pe!==r;){if(pe.nodeType===Node.ELEMENT_NODE){const re=pe.parentElement;if(re&&(re.classList.contains("list-item-ul")||re.classList.contains("list-item-ol"))){const me=re.querySelector("span:first-child");if(me&&(pe===me||me.contains(de)))return!0}}pe=pe.parentNode}return!1},ie=de=>{let pe=de;for(;pe&&pe!==r;){const ae=pe.parentElement;if(ae&&(ae.classList.contains("list-item-ul")||ae.classList.contains("list-item-ol"))){const re=ae.querySelector("span:nth-child(2)");if(re!=null&&re.firstChild)return re.firstChild}pe=pe.parentNode}return null};let we,ge,X,ce;if(T&&(tt!=null&&tt.anchorNode)?(we=tt.anchorNode,ge=tt.anchorOffset,X=tt.anchorNode,ce=tt.anchorOffset+tt.text.length):(we=G.startContainer,ge=G.startOffset,X=G.endContainer,ce=G.endOffset),te(we)){const de=ie(we);de&&(we=de,ge=0)}const ue=de=>{let pe=de;for(;pe&&pe!==r;){if(pe.nodeType===Node.ELEMENT_NODE){const ae=pe,re=ae.tagName;if(re==="H1"||re==="H2"||re==="H3"||re==="DIV"||re==="P"||re==="BLOCKQUOTE"||ae.classList.contains("list-item-ul")||ae.classList.contains("list-item-ol"))return ae}pe=pe.parentNode}return null},ee=ue(we),K=ue(X),U=H?ue(H):null,q=L?ue(L):null,se=c.includes(`
`);if(ee&&ee!==K&&se&&!(L===H)){const de=q!==U;if(de&&q&&!U){const pe=(H==null?void 0:H.textContent)||"",ae=$;let re=ae,me=ae;for(;re>0&&/\S/.test(pe[re-1]);)re--;for(;me<pe.length&&/\S/.test(pe[me]);)me++;if(re===me&&ae>0)for(me=ae,re=ae-1;re>0&&/\S/.test(pe[re-1]);)re--;re<me&&H&&(we=H,ge=re,X=H,ce=me)}else if(de&&!q&&U){const ae=document.createTreeWalker(U,NodeFilter.SHOW_TEXT).nextNode();ae&&(we=ae,ge=0)}else if(de&&U&&q){const pe=document.createTreeWalker(ee,NodeFilter.SHOW_TEXT);let ae=null,re;for(;re=pe.nextNode();)ae=re;ae&&(X=ae,ce=((O=ae.textContent)==null?void 0:O.length)||0)}else{const pe=document.createTreeWalker(ee,NodeFilter.SHOW_TEXT);let ae=null,re;for(;re=pe.nextNode();)ae=re;ae&&(X=ae,ce=((F=ae.textContent)==null?void 0:F.length)||0)}}const oe=ci(r,we,ge),fe=ci(r,X,ce);d=Math.min(oe,fe),u=Math.max(oe,fe),c=Y.substring(d,u)}}else{const W=window.getSelection();if(c=(W==null?void 0:W.toString())||"",W&&W.rangeCount>0){const P=W.getRangeAt(0).cloneRange(),k=document.createElement("span");k.style.position="absolute",k.textContent="​",P.insertNode(k),l=k.getBoundingClientRect(),(B=k.parentNode)==null||B.removeChild(k)}}const h=E.getState();let g;const f="rgb(198, 183, 0)";if(Z.highlightAndCreate.createHighlight&&(a||i)&&d!==u){const W=e.highlights||[],P=W.find(k=>k.start===d&&k.end===u);if(P)g=P.id;else{g=Math.random().toString(36).slice(2,10);const k={id:g,start:d,end:u,color:f,createdAt:Date.now()},T=[...W,k];h.updateNode(e.id,{highlights:T})}}const m=h.getSegmentedButtonAction("canvas-fit-width");let x=null;if(m){const W=/Set width to (\d+)px/.exec(m);W&&(x=parseInt(W[1],10))}let y,v,N;const b=document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(b&&window.getComputedStyle(b).lineHeight,x)v=mt(c,x),y=x,N=!0;else{const W=Ss(c);y=W.width,v=W.height,N=!1}const j=Le.buildTextNodeV2({content:c,width:y,height:v,linkedHighlightId:g,linkedSourceNodeId:e.id,options:{lockSize:N}});let R=e.y;if(l){const W=l.top;R=e.y+W,l.height&&(R+=l.height/2)}const S=j.height??v,C=R-S/2,M=s||e.id,I=Z.highlightAndCreate.createConnectingArrow;if(ea(j,{...e,y:C,id:M},o,{shouldFocus:n,createArrow:I}),g){const W=h.getNodeById(e.id),k=((W==null?void 0:W.highlights)||[]).map(T=>T.id===g?{...T,linkedNodeId:j.id}:T);h.updateNode(e.id,{highlights:k})}return j.id}const Hg=1e3,Bg=500,Fg=500,$g=250,zg=2e3,_g=1e3,Vg=500;class Ug{handleArrowKey(s,n=!1,o=!1){const r=E.getState(),a=r.projectCanvas.getActive();if(!a)return!1;const i=a.coreState.selectedNodes??[];if(i.length===0)return!1;const c=a.coreState.nodes??[],l=new Set(i.map(f=>f.id)),d=c.filter(f=>l.has(f.id));let u=Hg,h=Bg;o?(u=zg,h=_g):n&&(u=Fg,h=$g);const g=d.map(f=>{const w={id:f.id};switch(s.key){case"ArrowLeft":{const m=f.x,y=Math.round(m/u)-1;w.x=y*u;break}case"ArrowRight":{const m=f.x,y=Math.round(m/u)+1;w.x=y*u;break}case"ArrowUp":{const m=f.y,y=Math.round(m/h)-1;w.y=y*h;break}case"ArrowDown":{const m=f.y,y=Math.round(m/h)+1;w.y=y*h;break}}return w});return r.updateNodes(g),this.animateViewportToCenter(g,a),s.preventDefault(),!0}animateViewportToCenter(s,n){if(s.length===0||!n)return;const r=E.getState().setActiveCanvasViewState,a=n.viewState,i=a.scale,c=a.offset,l=n.coreState.nodes??[],d=new Map(l.map(R=>[R.id,R]));let u=0,h=0;s.forEach(R=>{const S=d.get(R.id);if(S){const C=R.x??S.x,M=R.y??S.y;u+=C,h+=M}});const g=u/s.length,f=h/s.length,w=window.innerWidth,m=window.innerHeight,x=w/2-g*i,y=m/2-f*i,v=performance.now(),N=c.x,b=c.y,j=R=>{const S=R-v,C=Math.min(S/Vg,1),M=1-Math.pow(1-C,3),I=N+(x-N)*M,A=b+(y-b)*M;r(O=>({...O,offset:{x:I,y:A}})),C<1&&requestAnimationFrame(j)};requestAnimationFrame(j)}}const li=!0,Gg=1/3;function Yg(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}class Kg{async onPaste(s){try{const n=await navigator.clipboard.read();for(const o of n){const r=o.types.find(h=>h.startsWith("image/"));if(!r)continue;const a=await o.getType(r);if(!a)continue;const i=Math.round(a.size/1024),c=await this.blobToDataUrl(a);let l,d;if(li){const h=await Yg(c,Gg);l=h.dataUrl,d=h.size}const u=li?Math.round(l.length*3/4/1024):i;return this.createImageNode(l,d,u),s.preventDefault(),!0}}catch(n){console.debug("ImageModeHandler: Clipboard read failed",n)}return!1}blobToDataUrl(s){return new Promise((n,o)=>{const r=new FileReader;r.onload=()=>n(r.result),r.onerror=o,r.readAsDataURL(s)})}createImageNode(s,n,o){const r=E.getState(),a=r.getCanvasMouseCoords();if(!a){console.warn("ImageModeHandler: No mouse position available");return}const i=300,c=n.height/n.width,l=Math.round(i*c),d=Le.buildImageNode({x:a.x,y:a.y,width:i,height:Math.max(l,100)});d.data={image:s,imageSize:n,fileSizeKB:o},r.addNode(d),r.setNodeToFocusId(d.id)}}function Xg(){const e=document.activeElement;if(!e)return null;const s=["INPUT","TEXTAREA"].includes(e.nodeName??""),n=e.contentEditable==="true";return s||n}class qg{constructor(){He(this,"activeCallback",null)}registerCallback(s){this.activeCallback=s}unregisterCallback(s){this.activeCallback===s&&(this.activeCallback=null)}applyHighlight(s){return this.activeCallback?(this.activeCallback(s),!0):!1}hasActiveCallback(){return this.activeCallback!==null}}const Sn=new qg,Zg=new js("useCanvasKeyboardEventsV2",ks.useCanvasKeyboardEventsV2),Jg=["q","Q","$","%","5"],Qg=()=>{const e=E.getState(),s=e.uiState.mode,n=e.setMode,o=e.setZoomSubMode,r=e.setWriteSubMode,a=e.toggleWriteSubMode,i=e.setArrowSubMode,c=e.toggleArrowSubMode,l=e.setDrawSubMode,d=e.toggleDrawSubMode,u=e.setAddNodeType,h=e.setNodeToFocusId,g=e.duplicateNodes,f=e.setSelectedNodes,w=e.arrow.setSelected,m=e.deleteSelectedNodes,x=e.deleteSelectedArrows,y=e.setActiveCanvasViewState,v=e.toggleOverlayVisibility,N=p.useRef(new Kt),b=p.useRef(new Ug),j=p.useRef(new Kg),R=p.useRef(0);return p.useCallback(S=>{var B;const C=E.getState().uiState.mode;if(C===J.VIM)return;if(S.key==="Escape"){const W=Date.now(),k=W-R.current<400;if(R.current=W,k){const L=document.querySelector('[data-test="canvas-chat-input-container"] textarea');L==null||L.focus();return}if(E.getState().uiState.activeGroupId){E.getState().group.setActiveGroupId(null);return}C===J.SELECT&&f([]),n(J.SELECT),h(null),u(null);return}if((S.key==="h"||S.key==="H")&&(S.ctrlKey||S.metaKey)){S.preventDefault(),Sn.applyHighlight();return}const M=S.key==="Enter"&&S.ctrlKey,I=S.key==="a"&&C===J.WRITE;if(C===J.WRITE&&!M&&!I)return;const A=Xg(),O=Jg.includes(S.key);if(A&&!O)return;if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(S.key)){const W=e.projectCanvas.getActive(),P=(W==null?void 0:W.coreState.selectedNodes)??[];if(C===J.GRID&&P.length>0){const k=S.ctrlKey,T=S.shiftKey;if(b.current.handleArrowKey(S,k,T))return}if(S.ctrlKey&&P.length>0&&C!==J.GRID){const k=e.uiState.lastUpdatedNodeId;if(!k)return;const T=(B=W==null?void 0:W.coreState.nodes)==null?void 0:B.find(H=>H.id===k);if(!T)return;const L=P.map(H=>{const $={id:H.id};switch(S.key){case"ArrowLeft":case"ArrowRight":$.x=T.x;break;case"ArrowUp":case"ArrowDown":$.y=T.y;break}return $});e.updateNodes(L),S.preventDefault();return}if(P.length===0){const k=S.shiftKey?100:30;y(T=>{let L=0,H=0;switch(S.key){case"ArrowUp":H=k;break;case"ArrowDown":H=-k;break;case"ArrowLeft":L=k;break;case"ArrowRight":L=-k;break}return{...T,offset:{x:T.offset.x+L,y:T.offset.y+H}}}),S.preventDefault();return}}switch(S.key){case".":{S.preventDefault();break}case"a":{if(S.preventDefault(),S.ctrlKey||S.metaKey){const k=e.projectCanvas.getActive(),T=(k==null?void 0:k.coreState.nodes)??[];f(T);break}const W=e.uiState.addNodeType;C===J.ADD&&W===le.TEXT?(n(J.WRITE),r(Us.AUDIO)):C===J.WRITE?a():C===J.DRAW_ARROW?c():(n(J.DRAW_ARROW),i(Mn.DEFAULT));break}case"c":if(S.ctrlKey||S.metaKey){const W=window.getSelection();if(W&&W.toString().trim().length>0)break;S.preventDefault(),Dl();break}S.preventDefault(),console.clear();break;case"d":if(S.preventDefault(),S.ctrlKey){g();break}f([]),w([]),n(J.DRAW);break;case"v":if(S.ctrlKey){const W=e.projectCanvas.getActive();if(((W==null?void 0:W.coreState.selectedNodes)??[]).some(T=>T.type===le.OCR||T.type===le.IMAGE))break;(async()=>await j.current.onPaste(S)||N.current.onPaste(S))();break}n(J.SELECT);break;case"g":if(S.ctrlKey){E.getState().group.createFromSelected()&&S.preventDefault();break}n(J.GRID);break;case"h":case"H":C===J.MOVE?(n(J.ZOOM),o("zoom")):C===J.ZOOM?n(J.MOVE):n(J.MOVE);break;case"i":n(J.VIM);break;case"m":n(J.ADD),u(le.CHAT);break;case"n":{E.getState().setCustomNodeDropdownOpen(!0);break}case"q":if(S.ctrlKey){N.current.onCopy();break}break;case"r":S.altKey&&(S.preventDefault(),E.getState().executeGlobalLastAction());break;case"s":(S.ctrlKey||S.metaKey)&&(S.preventDefault(),E.getState().saveCanvasData());break;case"Q":if(S.ctrlKey&&S.shiftKey){N.current.onCopy();break}break;case"$":{N.current.highlightAndCreateNode(S,"right");break}case"%":case"5":{N.current.highlightAndCreateNode(S,"left");break}case"t":n(J.ADD),u(le.TEXT);break;case"w":{const W=e.uiState.addNodeType;C===J.ADD&&W===le.TEXT&&(n(J.WRITE),r(Us.WRITE));break}case"u":case"U":(S.ctrlKey||S.metaKey)&&S.shiftKey&&(S.preventDefault(),E.getState().setUiState(W=>({...W,undoTreeExplorerOpen:!W.undoTreeExplorerOpen})));break;case"y":(S.ctrlKey||S.metaKey)&&(S.preventDefault(),E.getState().undo.redo());break;case"z":if(S.ctrlKey||S.metaKey){S.preventDefault(),S.shiftKey?E.getState().undo.redo():E.getState().undo.undo();break}v();break;case"1":case"2":case"3":case"4":if(C===J.DRAW){S.preventDefault();const W=Ke.getSubModeFromKey(S.key);W&&l(W)}break;case"Tab":C===J.DRAW&&(S.preventDefault(),d());break;case"Delete":case"Backspace":m(),x(),S.preventDefault();break}},[s,n,o,r,a,i,c,l,d,u,m,x,y,v,e])},ef=()=>p.useCallback(e=>{Zg.log("Key Up:",e.key)},[]),To=(e,s)=>e.x<s.x+s.width&&e.x+e.width>s.x&&e.y<s.y+s.height&&e.y+e.height>s.y,Eo=e=>({x:e.x,y:e.y,width:e.width??100,height:e.height??50}),tf=(e,s,n)=>{const{x1:o,y1:r,x2:a,y2:i}=n,{x:c,y:l}=e,{x:d,y:u}=s,h=d-c,g=u-l;let f=-1/0,w=1/0;const m=(y,v,N,b)=>{if(Math.abs(v)<1e-6)return y>=N&&y<=b;let j=(N-y)/v,R=(b-y)/v;return j>R&&([j,R]=[R,j]),f=Math.max(f,j),w=Math.min(w,R),f<=w};if(!m(c,h,o,a)||!m(l,g,r,i)||f>1||w<0)return null;const x=Math.max(0,f);return x<=1?{x:c+x*h,y:l+x*g}:null},nt=(e,s,n,o,r)=>{var d;if(!e)return s;const a=o.find(u=>u.id===e);if((a==null?void 0:a.width)===void 0||a.height===void 0)return s;if(r){const u=`[data-row-connector="${r}"][data-node-id="${e}"]`,h=document.querySelector(u);if(h){const g=h.getBoundingClientRect(),f=document.querySelector("[data-canvas-content]");if(f){const w=f.getBoundingClientRect(),m=g.left+g.width/2-w.left,x=g.top+g.height/2-w.top,v=(d=E.getState().projectCanvas.getActive())==null?void 0:d.viewState;return v?jt({x:m,y:x},v.scale,v.offset):{x:m,y:x}}}else return s}const i=Tn(a),c=qe(a);return tf(n,c,i)??c},sf=(e,s,n,o,r)=>{if(r===0){const a=n/o;return Math.abs(e)*a>=Math.abs(s)}return Math.abs(e)*r>=Math.abs(s)},$s=(e,s,n,o,r=0,a=Z.arrows.CUBIC_HORIZONTAL_BIAS)=>{if(!e)return s;const i=o.find(h=>h.id===e);if(!(i!=null&&i.width)||!i.height)return s;const c=qe(i),l=n.x-c.x,d=n.y-c.y;return sf(l,d,i.width,i.height,a)?l>0?{x:i.x+i.width-r,y:c.y}:{x:i.x+r,y:c.y}:d>0?{x:c.x,y:i.y+i.height-r}:{x:c.x,y:i.y+r}};function di(e,s,n){switch(s){case"fixed-minimum":return Math.max(e*.5,50)*n;case"no-minimum":return e*.5*n;case"scaled-minimum":const o=Math.min(e*.3,50);return Math.max(e*.5,o)*n;case"proportional":return Math.max(e*.4,10)*n;default:return Math.max(e*.5,50)*n}}function nf(e,s,n,o){const r=s.x-e.x,a=s.y-e.y,i=Math.abs(r),c=Math.abs(a),l=(o==null?void 0:o.dx)??r,d=(o==null?void 0:o.dy)??a,u=Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,h=Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,g=Z.arrows.CUBIC_CONTROL_DISTANCE_MODE;let f,w;if(n==="horizontal"){const m=di(i,g,u),x=l>0?1:-1,y=h?-1:1;f={x:e.x+x*m*y,y:e.y},w={x:s.x-x*m*y,y:s.y}}else{const m=di(c,g,u),x=d>0?1:-1,y=h?-1:1;f={x:e.x,y:e.y+x*m*y},w={x:s.x,y:s.y-x*m*y}}return[f,w]}const Ro=(e,s,n,o,r=0)=>{if(!e)return s;const a=o.find(l=>l.id===e);if(!(a!=null&&a.width)||!a.height)return s;const i=qe(a);return n.x-i.x>0?{x:a.x+a.width-r,y:i.y}:{x:a.x+r,y:i.y}},Ol=(e,s,n)=>{if(!e)return s;const o=n.find(a=>a.id===e);return!(o!=null&&o.width)||!o.height?s:{x:qe(o).x,y:o.y+o.height}};function Ll(e,s,n){const o=e.type??Z.arrows.type,r=Z.arrows.CUBIC_HORIZONTAL_BIAS,a=-10,i=s.find(h=>h.id===e.startNodeId),c=s.find(h=>h.id===e.endNodeId),l=o==="TreeCubic"||o==="TreeLStep"||o==="TreeZShape";let d;if(l&&i&&c){const h=qe(i);d=Ro(e.endNodeId,e.endPoint,h,s,a)}else if((o==="Cubic"||o==="Orthogonal")&&i&&c){const h=qe(i);d=$s(e.endNodeId,e.endPoint,h,s,a,r)}else if(o==="Step"&&i&&c){const h=qe(i),g=qe(c),f=g.x-h.x,w=g.y-h.y,x=Math.abs(f)*r>=Math.abs(w)?.001:1e3;d=$s(e.endNodeId,e.endPoint,h,s,a,x)}else{const h=i?nt(e.startNodeId,e.startPoint,e.endPoint,s,e.startRowId):e.startPoint;d=c?nt(e.endNodeId,e.endPoint,h,s,e.endRowId):e.endPoint}let u;if(o==="TreeLStep"&&i)u=Ol(e.startNodeId,e.startPoint,s);else if((o==="TreeCubic"||o==="TreeZShape")&&i&&c){const h=qe(c);u=Ro(e.startNodeId,e.startPoint,h,s,0)}else if((o==="Cubic"||o==="Step"||o==="Orthogonal")&&i&&c){const h=qe(c);u=$s(e.startNodeId,e.startPoint,h,s,0,r)}else{const h=c?nt(e.endNodeId,e.endPoint,e.startPoint,s,e.endRowId):e.endPoint;u=i?nt(e.startNodeId,e.startPoint,h,s,e.startRowId):e.startPoint}return{actualStartPoint:u,actualEndPoint:d}}function of(e,s,n){const{actualStartPoint:o,actualEndPoint:r}=Ll(e,s),a=Math.min(o.x,r.x),i=Math.min(o.y,r.y),c=Math.max(o.x,r.x),l=Math.max(o.y,r.y);return{x:a,y:i,width:c-a,height:l-i}}const ui={SELECTION_BOX_END:"selectionBoxEnd"};class af{constructor(){He(this,"listeners",{})}subscribe(s,n){return this.listeners[s]||(this.listeners[s]=[]),this.listeners[s].push(n),()=>{this.unsubscribe(s,n)}}unsubscribe(s,n){this.listeners[s]&&(this.listeners[s]=this.listeners[s].filter(o=>o!==n))}dispatch(s,n){this.listeners[s]&&this.listeners[s].forEach(o=>{try{o(n)}catch(r){console.error(`Error in event listener for ${s} event:`,r)}})}}const rf=new af,hs=new js("useSelectionHandler",ks.useSelectionHandler),cf=e=>e?Z.autoScroll.edgeThresholdMobile:Z.autoScroll.edgeThreshold,Xn=Z.autoScroll.scrollSpeed,yr=e=>{const n=e.target.closest("[data-canvas-container]");if(!n)return console.warn("Canvas container not found, falling back to offsetX/Y"),{x:e.offsetX,y:e.offsetY};const o=n.getBoundingClientRect();return{x:e.clientX-o.left,y:e.clientY-o.top}},lf=()=>{const e=E.getState(),s=e.setSelectionBox,n=e.setPendingSelectionStart,o=e.setSelectedNodes,r=e.setNodeToFocusId,a=e.arrow.setSelected,i=nr();return p.useCallback(c=>{var j,R,S,C,M;const l=yr(c),d=E.getState(),u=d.uiState.mode,h=(j=d.uiState)==null?void 0:j.isPanning;if(u===J.MOVE||((R=E.getState().uiState)==null?void 0:R.dragInfo))return;const f=c.target,w=f.closest("[data-node-id]"),m=f.closest("[data-arrow-id]"),x=f.closest("[data-group-id]"),y=f.closest("[data-ui-panel]"),v=f.closest("[data-grid-svg]"),N=v&&v.getAttribute("data-grid-active")==="true",b=!!f.closest("foreignObject");if((u===J.SELECT||u===J.GRID||u===J.WRITE||u===J.VIM)&&(c.button===0||c.button===-1)&&!h){if(w||m||x||y||N||b)return;const I=c.shiftKey&&!c.ctrlKey&&!c.metaKey,A=e.projectCanvas.getActive();if((S=A==null?void 0:A.coreState.nodes)==null?void 0:S.some($=>$.isEditing))return;const F=(A==null?void 0:A.coreState.selectedNodes)??[],B=(A==null?void 0:A.coreState.nodes)??[],W=(A==null?void 0:A.viewState.scale)??1,P=(A==null?void 0:A.viewState.offset)??{x:0,y:0};if(I&&F.length>0){const $=jt(l,W,P),_=F[F.length-1],G=[{x:_.x,y:_.y},{x:_.x+(_.width??0),y:_.y},{x:_.x,y:_.y+(_.height??0)},{x:_.x+(_.width??0),y:_.y+(_.height??0)}];let V=G[0],D=0;G.forEach(ce=>{const ue=Math.sqrt(Math.pow(ce.x-$.x,2)+Math.pow(ce.y-$.y,2));ue>D&&(D=ue,V=ce)});const Y={x:Math.min(V.x,$.x),y:Math.min(V.y,$.y),width:Math.abs(V.x-$.x),height:Math.abs(V.y-$.y)},te=(A==null?void 0:A.coreState.activeLayerId)??xt,ie=B.filter(ce=>{if((ce.layerId??xt)!==te)return!1;const ee=Eo(ce);return To(ee,Y)}),we=new Set(F.map(ce=>ce.id)),ge=ie.filter(ce=>!we.has(ce.id)),X=[...F,...ge];o(X);return}if(hs.log("Selection Mouse Down on Background:",l.x,l.y),u===J.WRITE){const $=e.projectCanvas.getActive(),_=($==null?void 0:$.viewState.scale)??1,G=($==null?void 0:$.viewState.offset)??{x:0,y:0},V=jt(l,_,G);Fc(async()=>{const{CanvasNodeBuilderV2:D}=await Promise.resolve().then(()=>og);return{CanvasNodeBuilderV2:D}},void 0).then(({CanvasNodeBuilderV2:D})=>{const Y=D.buildTextNode(V,"");Y.isEditing=!0,e.addNode(Y,""),e.setNodeToFocusId(Y.id)});return}const k=(C=E.getState().uiState)==null?void 0:C.pendingSelectionStart,T=(M=E.getState().uiState)==null?void 0:M.selectionBox;if(k&&T){n(null);return}const L=jt(l,W,P);n(L),o([]),a([]),r(null);const H=c.pointerType==="touch";if(i&&H)return;s({start:l,end:l})}},[s,n,o,r,a,e,i])},df=()=>{const e=E.getState(),s=e.setSelectionBox,n=e.setActiveCanvasViewState,o=z(d=>d.uiState.selectionBox),r=Vn(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useCallback(()=>{var w,m;const d=E.getState().projectCanvas.getActive(),u=(w=E.getState().uiState)==null?void 0:w.selectionBox;if(!d||!u){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const h=d.viewState.offset;let g=0,f=0;if(g=i.current.x,f=i.current.y,g!==0||f!==0){n(y=>({...y,offset:{x:h.x+g,y:h.y+f}}));const x=(m=E.getState().uiState)==null?void 0:m.selectionBox;if(x){const y={x:x.start.x+g,y:x.start.y+f};s({start:y,end:x.end})}}a.current=requestAnimationFrame(l)},[n,s]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useEffect(()=>{o||(c.current=null)},[o]),p.useCallback(d=>{var W,P,k,T,L;if((W=E.getState().uiState)==null?void 0:W.dragInfo)return;const h=yr(d),g=(P=E.getState().uiState)==null?void 0:P.pendingSelectionStart,f=E.getState().projectCanvas.getActive(),w=(f==null?void 0:f.viewState.scale)??1,m=(f==null?void 0:f.viewState.offset)??{x:0,y:0};if((k=f==null?void 0:f.coreState.nodes)==null?void 0:k.some(H=>H.isEditing))return;const y=(d.buttons&1)!==0;if(g&&d.shiftKey&&!y){const H=g.x*w+m.x,$=g.y*w+m.y;s({start:{x:H,y:$},end:h});return}if(g&&!d.shiftKey&&!y){((T=E.getState().uiState)==null?void 0:T.selectionBox)&&s(null);return}if(!o)return;const v=(L=E.getState().uiState)==null?void 0:L.selectionBox;if(!v)return;const N=window.innerWidth,b=window.innerHeight;let j=0,R=0;c.current&&(j=h.x-c.current.x,R=h.y-c.current.y),c.current={x:h.x,y:h.y},s({start:v.start,end:h});const S=d.clientX,C=d.clientY,M=cf(r),I=C<M&&R<0,A=C>b-M&&R>0,O=S<M&&j<0,F=S>N-M&&j>0,B=I||A||O||F;if(B){let H=0,$=0;I&&($=Xn),A&&($=-Xn),O&&(H=Xn),F&&(H=-Xn),i.current={x:H,y:$},a.current===null&&(a.current=requestAnimationFrame(l))}else!B&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null,i.current={x:0,y:0})},[s,o,l,r])},uf=()=>{var c;const e=E.getState(),s=e.setSelectionBox,n=e.setPendingSelectionStart,o=(c=e.uiState)==null?void 0:c.selectionBox,r=e.projectCanvas.getActive,a=e.setSelectedNodes,i=e.arrow.setSelected;return p.useCallback(l=>{var v,N,b;if((v=E.getState().uiState)==null?void 0:v.dragInfo)return;const u=yr(l),h=r(),g=(h==null?void 0:h.coreState.nodes)??[],f=(h==null?void 0:h.coreState.arrows)??[],w=(h==null?void 0:h.viewState.scale)??1,m=(h==null?void 0:h.viewState.offset)??{x:0,y:0},x=(N=E.getState().uiState)==null?void 0:N.selectionBox,y=(b=E.getState().uiState)==null?void 0:b.pendingSelectionStart;if(x){hs.log("Selection Mouse Up:",u.x,u.y),hs.log("Stopped Marquee Selection");const j={x:Math.min(x.start.x,u.x),y:Math.min(x.start.y,u.y),width:Math.abs(x.start.x-u.x),height:Math.abs(x.start.y-u.y)},R=jt({x:j.x,y:j.y},w,m),S=jt({x:j.x+j.width,y:j.y+j.height},w,m),C={x:R.x,y:R.y,width:S.x-R.x,height:S.y-R.y},M=5;if(j.width<M&&j.height<M){const B=E.getState().uiState.activeGroupId;if(B){const W=g.find(P=>P.id===B);if(W){const P=Eo(W),k=jt(u,w,m);k.x>=P.x&&k.x<=P.x+P.width&&k.y>=P.y&&k.y<=P.y+P.height||E.getState().group.setActiveGroupId(null)}else E.getState().group.setActiveGroupId(null)}y||(s(null),a([]),i([]));return}const I=E.getState().uiState.activeGroupId,A=(h==null?void 0:h.coreState.activeLayerId)??xt,O=g.filter(B=>{if(I&&B.id===I||(B.layerId??xt)!==A)return!1;const P=Eo(B);return To(P,C)});hs.log("Selected Nodes by Marquee:",O.map(B=>B.content)),a(O);const F=f.filter(B=>{const W=of(B,g),P=To(W,C);return hs.log(">>>> _ >>>> ~ useSelectionHandler.ts:164 ~ arrowBBox:",W),P});hs.log("Selected Arrows by Marquee:",F.map(B=>B.id)),i(F),O.length>0&&(rf.dispatch(ui.SELECTION_BOX_END,{selectedNodes:O}),hs.log(`Dispatched ${ui.SELECTION_BOX_END} event with nodes:`,O.map(B=>B.id))),s(null),n(null)}},[o,r,s,n,a,i])},hf=()=>{const e=In.getState().mousePosition??null,n=E.getState().projectCanvas.getActive,o=n(),r=(o==null?void 0:o.viewState.scale)??1,a=(o==null?void 0:o.viewState.offset)??{x:0,y:0},i=p.useMemo(()=>e?jt(e,r,a):null,[e,r,a]);return{screenCoords:e,canvasCoords:i}},bt={"I am dragging a node near the <edge> edge":"I am dragging a node near the <edge> edge","I am dragging a node near the top edge":"I am dragging a node near the top edge","I am dragging a node toward the <edge> edge":"I am dragging a node toward the <edge> edge","I am in GRID mode":"I am in GRID mode","I am in MOVE mode":"I am in MOVE mode","I am in SELECT mode":"I am in SELECT mode","I am in WRITE mode":"I am in WRITE mode","I have a canvas with nodes":"I have a canvas with nodes","I have selected a node":"I have selected a node","auto-scroll is active":"auto-scroll is active"},Ut={"I click on a node":"I click on a node","I hold Ctrl and click on another node":"I hold Ctrl and click on another node","I hold Ctrl and click on one of the selected nodes":"I hold Ctrl and click on one of the selected nodes","I hold Shift and click on a node":"I hold Shift and click on a node"},pf=e=>e?Z.autoScroll.edgeThresholdMobile:Z.autoScroll.edgeThreshold,go=Z.autoScroll.edgeThreshold;let Wl=!1;const gf=e=>{Wl=e};let $a=0,Hl=0;const fo={[bt["I have a canvas with nodes"]]:()=>{const e=E.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.nodes.length)??0)>0},[bt["I have selected a node"]]:()=>{const e=E.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.selectedNodes.length)??0)>0},[bt["I am dragging a node near the top edge"]]:(e,s=go)=>E.getState().uiState.dragInfo?(e??$a)<s:!1,[bt["I am dragging a node near the <edge> edge"]]:(e,s,n,o=go)=>{if(!E.getState().uiState.dragInfo)return!1;const i=s??Hl,c=n??$a;switch(e){case"top":return c<o;case"bottom":return c>window.innerHeight-o;case"left":return i<o;case"right":return i>window.innerWidth-o;default:return!1}},[bt["auto-scroll is active"]]:()=>Wl,[bt["I am dragging a node toward the <edge> edge"]]:(e,s,n,o=go)=>{if(!E.getState().uiState.dragInfo)return!1;const i=fo[bt["I am dragging a node near the <edge> edge"]](e,void 0,void 0,o);if(!i)return!1;if(s===void 0&&n===void 0)return i;switch(e){case"top":return(n??0)<0;case"bottom":return(n??0)>0;case"left":return(s??0)<0;case"right":return(s??0)>0;default:return!1}}},ff=(e,s)=>{Hl=e,$a=s},ns=Z.autoScroll.scrollSpeed,Bl=(e,s,n=go)=>{if(e===null||s===null)return{x:0,y:0};let o=0,r=0;const a=window.innerWidth,i=window.innerHeight;return e<n?o=ns:e>a-n&&(o=-ns),s<n?r=ns:s>i-n&&(r=-ns),{x:o,y:r}},mf=(e,s)=>({x:-e.x/s,y:-e.y/s}),qn={getScrollDeltaForMousePosition:(e,s)=>Bl(e,s),shouldScroll:e=>e.x!==0||e.y!==0,applyDeltaToPosition:(e,s,n)=>({x:Number((e+n.x).toFixed(2)),y:Number((s+n.y).toFixed(2))})},Ps={calculateScrollDelta:(e,s)=>{if(e){const n=Bl(e.x,e.y),o=qn.shouldScroll(n);return{delta:n,shouldUpdateLastDelta:o}}return{delta:s,shouldUpdateLastDelta:!1}},calculateNewOffset:(e,s)=>({x:e.x+s.x,y:e.y+s.y}),updateNodesForScroll:(e,s,n)=>e.map(o=>{if(s.has(o.id)){const r=qn.applyDeltaToPosition(o.x,o.y,n);return{...o,...r}}return o}),updateSelectedNodesForScroll:(e,s)=>e.map(n=>{const o=qn.applyDeltaToPosition(n.x,n.y,s);return{...n,...o}}),updateArrowsForScroll:(e,s,n)=>e.map(o=>{let r=o.startPoint,a=o.endPoint;return o.startNodeId&&s.has(o.startNodeId)&&(r={x:Number((o.startPoint.x+n.x).toFixed(2)),y:Number((o.startPoint.y+n.y).toFixed(2))}),o.endNodeId&&s.has(o.endNodeId)&&(a={x:Number((o.endPoint.x+n.x).toFixed(2)),y:Number((o.endPoint.y+n.y).toFixed(2))}),r!==o.startPoint||a!==o.endPoint?{...o,startPoint:r,endPoint:a}:o}),processAutoScrollFrame:e=>{const{mousePosition:s,lastScrollDelta:n,currentOffset:o,scale:r,nodes:a,selectedNodes:i,arrows:c=[]}=e,{delta:l}=Ps.calculateScrollDelta(s,n);if(!qn.shouldScroll(l))return{shouldScroll:!1,scrollDelta:l,newOffset:o,updatedNodes:a,updatedSelectedNodes:i,updatedArrows:c};const u=Ps.calculateNewOffset(o,l),h=mf(l,r),g=new Set(i.map(x=>x.id)),f=Ps.updateNodesForScroll(a,g,h),w=Ps.updateSelectedNodesForScroll(i,h),m=Ps.updateArrowsForScroll(c,g,h);return{shouldScroll:!0,scrollDelta:l,newOffset:u,updatedNodes:f,updatedSelectedNodes:w,updatedArrows:m}}},za={isShiftPressed:e=>e.shiftKey&&!e.ctrlKey&&!e.metaKey,isCtrlPressed:e=>e.ctrlKey||e.metaKey,noModifiersPressed:e=>!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey},xf=e=>{const s=E.getState().projectCanvas.getActive();return(s==null?void 0:s.coreState.selectedNodes.some(n=>n.id===e))??!1},Zn=()=>{const e=E.getState().projectCanvas.getActive();return(e==null?void 0:e.coreState.selectedNodes)??[]},_a={isClickOnEditingElement:e=>!!e.closest("[data-is-editing='true']"),hasActiveTextSelection:()=>{const e=window.getSelection();return e!==null&&!e.isCollapsed&&e.toString().length>0},getSelectedText:()=>{const e=window.getSelection();return(e==null?void 0:e.toString())??""},isInsideTextInput:e=>{const s=e.tagName.toLowerCase();return s==="textarea"||s==="input"?!0:!!e.closest('textarea, input, [contenteditable="true"]')}},wf=(e,s)=>{const n=[];for(const o of s)o.startNodeId===e&&o.endNodeId&&n.push(o.endNodeId);return n},yf=(e,s)=>s.filter(n=>n.endNodeId===e).length,Fl=(e,s,n,o=!1)=>{const r=new Set(e),a=new Set,i=[...e],c=new Set(e);for(;i.length>0;){const d=i.shift(),u=wf(d,n);for(const h of u)c.has(h)||s.some(g=>g.id===h)&&(c.add(h),!(o&&yf(h,n)>1)&&(a.add(h),i.push(h)))}return s.filter(d=>a.has(d.id)&&!r.has(d.id))},vf=(e,s)=>{const n=new Set,o=e.filter(r=>r.isCollapsed);for(const r of o)Fl([r.id],e,s,!0).forEach(i=>n.add(i.id));return n};let bf=!0;const hi={isDragInProgress:()=>{var s;const e=(s=E.getState().uiState)==null?void 0:s.dragInfo;return e!=null},isDragWithSelectedNodes:()=>{var o;const e=E.getState();if(!((o=e.uiState)==null?void 0:o.dragInfo))return!1;const n=e.projectCanvas.getActive();return((n==null?void 0:n.coreState.selectedNodes.length)??0)>0},isFirstMoveEvent:()=>bf,[bt["I am in SELECT mode"]]:()=>E.getState().uiState.mode===J.SELECT,[bt["I am in GRID mode"]]:()=>E.getState().uiState.mode===J.GRID,[bt["I am in MOVE mode"]]:()=>E.getState().uiState.mode===J.MOVE,[bt["I am in WRITE mode"]]:()=>E.getState().uiState.mode===J.WRITE,canDragInCurrentMode:()=>{const e=E.getState().uiState.mode;return e===J.SELECT||e===J.GRID||e===J.WRITE||e===J.VIM},isPrimaryButton:e=>e.button===0||e.button===-1},hn={calculateScreenDelta:e=>{const{screenCoords:s,prevScreenPos:n}=e;if(!s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:null,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!0};if(s&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:s,newDragDirection:null,isFirstMoveEvent:!0,shouldSkipFrame:!0};if(s&&n){const o={x:s.x-n.x,y:s.y-n.y},r=o.x!==0||o.y!==0?o:null;return{screenDelta:o,newPrevScreenPos:s,newDragDirection:r,isFirstMoveEvent:!1,shouldSkipFrame:!1}}return{screenDelta:{x:0,y:0},newPrevScreenPos:n,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!1}},screenDeltaToCanvasDelta:(e,s)=>({x:e.x/s,y:e.y/s}),checkAutoScrollEdges:e=>{const{screenCoords:s,dragDirection:n,draggedNode:o,scale:r,offset:a,edgeThreshold:i}=e;let c=!1;o&&(c=o.y*r+a.y<=0&&n.y<0);const l=c,d=fo[bt["I am dragging a node toward the <edge> edge"]]("bottom",n.x,n.y,i),u=fo[bt["I am dragging a node toward the <edge> edge"]]("left",n.x,n.y,i),h=fo[bt["I am dragging a node toward the <edge> edge"]]("right",n.x,n.y,i);return{shouldAutoScroll:l||d||u||h}},calculateMouseLeftWindowDelta:e=>{const{lastCoords:s,viewportWidth:n,viewportHeight:o}=e;if(!s)return{shouldStartAutoScroll:!1,scrollDelta:{x:0,y:0}};let r=0,a=0;return s.x<n/2?r=ns:r=-ns,s.y<o/2?a=ns:a=-ns,{shouldStartAutoScroll:!0,scrollDelta:{x:r,y:a}}},calculateNodeMoves:e=>{const{canvasDelta:s,draggedNodeId:n,selectedNodes:o,nodes:r,arrows:a,isCtrlPressed:i,isShiftPressed:c}=e;if(Math.abs(s.x)<.1&&Math.abs(s.y)<.1)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const l=new Set(o.map(m=>m.id));let d=new Set(l);if(i){const m=c??!1;Fl(Array.from(l),r,a,m).forEach(y=>d.add(y.id))}for(const m of o)if(m.type===le.GROUP){const x=m.data,y=x==null?void 0:x.childNodeIds;if(y)for(const v of y)d.add(v)}if(d.size===0)return{shouldUpdate:!1,updatedNodes:r,updatedSelectedNodes:o,updatedArrows:a};const u=s.x,h=s.y;let g=null;for(let m=0;m<r.length;m++){const x=r[m];d.has(x.id)&&(g||(g=r.slice()),g[m]={...x,x:x.x+u,y:x.y+h})}let f=null;for(let m=0;m<o.length;m++){const x=o[m];d.has(x.id)&&(f||(f=o.slice()),f[m]={...x,x:x.x+u,y:x.y+h})}let w=null;for(let m=0;m<a.length;m++){const x=a[m],y=x.startNodeId&&d.has(x.startNodeId),v=x.endNodeId&&d.has(x.endNodeId);(y||v)&&(w||(w=a.slice()),w[m]={...x,startPoint:y?{x:x.startPoint.x+u,y:x.startPoint.y+h}:x.startPoint,endPoint:v?{x:x.endPoint.x+u,y:x.endPoint.y+h}:x.endPoint})}return{shouldUpdate:!0,updatedNodes:g??r,updatedSelectedNodes:f??o,updatedArrows:w??a}}},Nf=(e,s)=>{const n=[{x:e.x,y:e.y},{x:e.x+(e.width??0),y:e.y},{x:e.x,y:e.y+(e.height??0)},{x:e.x+(e.width??0),y:e.y+(e.height??0)}];let o=n[0],r=0;return n.forEach(a=>{const i=Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2));i>r&&(r=i,o=a)}),o},Sf=(e,s)=>({x:Math.min(e.x,s.x),y:Math.min(e.y,s.y),width:Math.abs(e.x-s.x),height:Math.abs(e.y-s.y)}),Cf=(e,s)=>e.filter(n=>{const o=Eo(n);return To(o,s)}),jf=(e,s)=>{const n=new Set(e.map(r=>r.id)),o=s.filter(r=>!n.has(r.id));return[...e,...o]},Ds={[Ut["I hold Shift and click on a node"]]:(e,s)=>{const o=E.getState().projectCanvas.getActive(),r=(o==null?void 0:o.coreState.selectedNodes)??[],a=(o==null?void 0:o.coreState.nodes)??[];if(r.length===0)return[e];const i=r[r.length-1],c=Nf(i,s),l=Sf(c,s),d=Cf(a,l);return jf(r,d)},[Ut["I hold Ctrl and click on one of the selected nodes"]]:e=>Zn().filter(n=>n.id!==e.id),[Ut["I hold Ctrl and click on another node"]]:e=>[...Zn(),e],[Ut["I click on a node"]]:(e,s)=>s?Zn():[e],handleNodeMouseDown:e=>{const{node:s,event:n,canvasCoords:o}=e,r=E.getState(),a=r.projectCanvas.getActive(),i=Zn(),c=xf(s.id),l=(a==null?void 0:a.coreState.activeLayerId)??xt,d=s.layerId??xt;if(d!==l)return{action:"wrong_layer",shouldStartDrag:!1,newSelection:i,targetLayerId:d,clickedNode:s};const u=s.groupId,h=r.uiState.activeGroupId,g=(a==null?void 0:a.coreState.nodes)??[];if(s.type===le.GROUP&&c&&i.length===1&&h!==s.id)return r.group.setActiveGroupId(s.id),{action:"keep_selection",shouldStartDrag:!0,newSelection:i,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};if(u&&u!==h){const m=g.find(x=>x.id===u&&x.type===le.GROUP);if(m)return i.length===1&&i[0].id===m.id?(r.group.setActiveGroupId(u),{action:"replace_selection",shouldStartDrag:!0,newSelection:Ds[Ut["I click on a node"]](s,c),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}):{action:"select_group",shouldStartDrag:!1,newSelection:[m],selectedGroup:m}}if(za.isShiftPressed(n)&&i.length>0)return{action:"shift_select",shouldStartDrag:!1,newSelection:Ds[Ut["I hold Shift and click on a node"]](s,o)};if(za.isCtrlPressed(n))return c?{action:"ctrl_toggle_remove",shouldStartDrag:!1,newSelection:Ds[Ut["I hold Ctrl and click on one of the selected nodes"]](s)}:{action:"ctrl_toggle_add",shouldStartDrag:!0,newSelection:Ds[Ut["I hold Ctrl and click on another node"]](s),dragStartOffset:{x:o.x-s.x,y:o.y-s.y}};h&&u!==h&&r.group.setActiveGroupId(null);const w=Ds[Ut["I click on a node"]](s,c);return{action:c?"keep_selection":"replace_selection",shouldStartDrag:!0,newSelection:w,dragStartOffset:{x:o.x-s.x,y:o.y-s.y}}}},At={isNodeInsideGroup:(e,s)=>$c(e,s),isNodeInGroup:e=>e.groupId!==void 0&&e.groupId!==null,isGroupNode:e=>e.type===le.GROUP,canBeAddedToGroup:e=>!At.isGroupNode(e)&&!At.isNodeInGroup(e),isValidDropCandidate:e=>!At.isGroupNode(e)},va={filterValidDropCandidates:e=>e.filter(At.canBeAddedToGroup),filterNodesInGroups:e=>e.filter(At.isNodeInGroup),filterGroupNodes:e=>e.filter(At.isGroupNode),getCurrentGroupForNode:(e,s)=>{if(e.groupId)return s.find(n=>n.id===e.groupId)},findGroupDropTargets:(e,s)=>e.filter(n=>n.type===le.GROUP&&!s.has(n.id))},$l={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Set(s.map(i=>i.id)),a=va.findGroupDropTargets(n,r);for(const i of s){if(At.isGroupNode(i)||At.isNodeInGroup(i))continue;const c=a.find(l=>l.id===o?!1:At.isNodeInsideGroup(i,l));if(c)return{hoveredGroupId:c.id,hasValidDropTarget:!0}}return{hoveredGroupId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,allNodes:n,activeGroupId:o}=e,r=new Map,a=[],i=new Set(s.map(d=>d.id)),c=va.findGroupDropTargets(n,i);for(const d of s){if(At.isGroupNode(d))continue;if(At.isNodeInGroup(d)){const h=va.getCurrentGroupForNode(d,c);h&&!At.isNodeInsideGroup(d,h)&&a.push(d.id);continue}const u=c.find(h=>h.id===o?!1:At.isNodeInsideGroup(d,h));if(u){const h=r.get(u.id)||[];h.push(d.id),r.set(u.id,h)}}const l=r.size>0||a.length>0;return{nodesToAddToGroups:r,nodesToRemoveFromGroups:a,hasChanges:l}}},kf=69,Af=41,If=45,Va={isTableNode:e=>e.type===le.TABLE,isPointInsideNode:(e,s)=>{const n=Tn(s);return e.x>=n.x1&&e.x<=n.x2&&e.y>=n.y1&&e.y<=n.y2},hasValidTableData:e=>{const s=e.data;return!!(s!=null&&s.columns)&&Array.isArray(s.columns)&&s.columns.length>0}},Cn={getNodeCenter:e=>{const s=Tn(e);return{x:(s.x1+s.x2)/2,y:(s.y1+s.y2)/2}},findTableDropTargets:(e,s)=>e.filter(n=>Va.isTableNode(n)&&!s.has(n.id)),calculateTargetColumn:(e,s)=>{const n=s.data;if(!(n!=null&&n.columns)||n.columns.length===0)return null;const o=Tn(s),r=o.x2-o.x1,a=e-o.x1,i=n.columnOrder&&n.columnOrder.length>0?n.columnOrder.map(g=>n.columns.find(f=>f.key===g)).filter(g=>g!==void 0):n.columns;let c=0;for(const g of i)c+=g.width?parseInt(g.width,10):150;const l=r/c;let d=0;const u=[];for(let g=0;g<i.length;g++){const f=i[g],m=(f.width?parseInt(f.width,10):150)*l,x=d;d+=m,u.push({key:f.key,relStart:Math.round(x),relEnd:Math.round(d),absStart:Math.round(o.x1+x),absEnd:Math.round(o.x1+d)})}for(let g=0;g<u.length;g++){const f=u[g];if(a<f.relEnd)return{columnIndex:g,columnKey:f.key}}const h=i[i.length-1];return{columnIndex:i.length-1,columnKey:h.key}},calculateTargetRow:(e,s)=>{const n=s.data;if(!(n!=null&&n.rows)||n.rows.length===0)return null;const o=Tn(s),r=e-o.y1,a=kf+Af;if(r<a)return null;const i=Math.floor((r-a)/If);if(i<0)return null;if(i>=n.rows.length){const c=n.rows[n.rows.length-1];return{rowIndex:n.rows.length-1,rowId:c.id}}return{rowIndex:i,rowId:n.rows[i].id}},extractNodeContent:e=>e.content===null||e.content===void 0?"":String(e.content)},zl={calculateTableDropTarget:e=>{const{droppedNode:s,allNodes:n,mousePosition:o}=e,r=o??Cn.getNodeCenter(s),a=new Set([s.id]),i=Cn.findTableDropTargets(n,a);for(const c of i){if(!Va.isPointInsideNode(r,c)||!Va.hasValidTableData(c))continue;const l=Cn.calculateTargetColumn(r.x,c);if(!l)continue;const d=Cn.calculateTargetRow(r.y,c);return{targetTableId:c.id,columnIndex:l.columnIndex,columnKey:l.columnKey,rowIndex:(d==null?void 0:d.rowIndex)??null,rowId:(d==null?void 0:d.rowId)??null}}return{targetTableId:null,columnIndex:null,columnKey:null,rowIndex:null,rowId:null}}};var Ge=(e=>(e.DICTIONARY="dictionary",e.FLASHCARD="flashcard",e.WORD_LIST="word_list",e.ETYMOLOGY="etymology",e.VOCABULARY="vocabulary",e))(Ge||{});const zs={isVocabularyNode:e=>e.type===le.VOCABULARY,isVocabularyMode:e=>{if(!zs.isVocabularyNode(e))return!1;const s=e.data;return(s==null?void 0:s.vocabType)===Ge.VOCABULARY},isTextNode:e=>e.type===le.TEXT,canBeDroppedOnVocab:e=>zs.isTextNode(e),isNodeInsideVocabNode:(e,s)=>$c(e,s)},pn={findVocabularyDropTargets:(e,s)=>e.filter(n=>zs.isVocabularyMode(n)&&!s.has(n.id)),extractNodeContent:e=>typeof e.content=="string"?e.content.trim():"",sortNodesByPosition:e=>[...e].sort((s,n)=>s.x+s.y-(n.x+n.y))},_l={calculateHoveredDropTarget:e=>{const{draggedNodes:s,allNodes:n}=e,o=new Set(s.map(a=>a.id)),r=pn.findVocabularyDropTargets(n,o);for(const a of s){if(!zs.canBeDroppedOnVocab(a))continue;const i=r.find(c=>zs.isNodeInsideVocabNode(a,c));if(i)return{hoveredVocabNodeId:i.id,hasValidDropTarget:!0}}return{hoveredVocabNodeId:null,hasValidDropTarget:!1}},calculateDropResult:e=>{const{droppedNodes:s,targetVocabNode:n}=e,o=s.filter(zs.canBeDroppedOnVocab);if(o.length===0)return{sourceWord:"",translationWord:"",nodeIdsToDelete:[],hasChanges:!1};const r=n.data,a=(r==null?void 0:r.sourceWord)||"",i=(r==null?void 0:r.translationWord)||"";let c=a,l=i;const d=[];if(o.length>=2){const h=pn.sortNodesByPosition(o);c=pn.extractNodeContent(h[0]),l=pn.extractNodeContent(h[h.length-1]),d.push(...o.map(g=>g.id))}else{const h=pn.extractNodeContent(o[0]);a?l=h:c=h,d.push(o[0].id)}return{sourceWord:c,translationWord:l,nodeIdsToDelete:d,hasChanges:c!==a||l!==i}}},at=new js("useNodeDragHandler",ks.useCanvasMouseEventsV2),Tf=e=>{const s=e.target,n=s.closest('[data-test="chat-messages-container"]'),o=s.closest('[data-test="chat-header"]');return n!==null&&o===null};let Rn=null,jn=null;const ba=()=>{Rn&&(clearTimeout(Rn),Rn=null),jn=null},zt=new Map,pi=(e,s,n,o,r)=>{const a=E.getState(),i=Ds.handleNodeMouseDown({node:e,event:s,canvasCoords:n});if(i.action==="wrong_layer"&&i.targetLayerId&&i.clickedNode){a.setUiState(c=>({...c,switchLayerDialog:{isOpen:!0,targetLayerId:i.targetLayerId,clickedNodeId:i.clickedNode.id}})),at.log(`Node Mouse Down: Node ${e.id} is on layer ${i.targetLayerId}, not current layer`);return}if(i.action==="select_group"&&i.selectedGroup){r([i.selectedGroup]),at.log("Node Mouse Down: Selected parent group node",i.selectedGroup.id,"instead of node",e.id);return}if(r(i.newSelection),at.log(`Node Mouse Down: ${i.action}`,e.id,"Selection count:",i.newSelection.length),i.shouldStartDrag&&i.dragStartOffset){const c={};for(const l of i.newSelection)c[l.id]={x:l.x,y:l.y};c[e.id]||(c[e.id]={x:e.x,y:e.y}),o({draggedNodeId:e.id,dragStartOffset:i.dragStartOffset,initialNodePosition:{x:e.x,y:e.y},initialPositions:c}),at.log("Node Drag Start on:",e.id,"tracking",Object.keys(c).length,"nodes")}},Ef=e=>{const s=E.getState(),n=s.setDragInfo,o=s.setSelectedNodes;return p.useCallback(r=>{const a=E.getState().getCanvasMouseCoords();if(!hi.canDragInCurrentMode()||!hi.isPrimaryButton(r))return;r.stopPropagation();const i=r.target;if(_a.isClickOnEditingElement(i)){at.log("Node Mouse Down: Clicked on editing node, skipping drag initialization");return}if(!a){at.warn("Node Mouse Down: Canvas coordinates not available.");return}if(Tf(r)){at.log("Node Mouse Down: Inside ChatNode scroll area, starting hold-to-drag timer"),ba(),jn={x:r.clientX,y:r.clientY},E.getState().setChatNodeHoldToDrag({nodeId:e.id,isHolding:!0,isReady:!1});let c=!1;const l=u=>{if(!c&&jn){const h=u.clientX-jn.x,g=u.clientY-jn.y;Math.sqrt(h*h+g*g)>Z.holdToDrag.movementThresholdPx&&(at.log("Node Mouse Down: Movement exceeded threshold, cancelling hold"),ba(),E.getState().setChatNodeHoldToDrag(null),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d))}},d=()=>{c||(at.log("Node Mouse Down: Pointer up before hold complete, cancelling hold"),ba(),E.getState().setChatNodeHoldToDrag(null),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d))};document.addEventListener("pointermove",l),document.addEventListener("pointerup",d),Rn=setTimeout(()=>{at.log("Node Mouse Down: Hold timer complete, starting drag"),Rn=null,c=!0,document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",d),E.getState().setChatNodeHoldToDrag({nodeId:e.id,isHolding:!1,isReady:!0}),a&&pi(e,r,a,n,o)},Z.holdToDrag.holdDelayMs);return}pi(e,r,a,n,o)},[e,n,o])},Rf=()=>{const e=E.getState(),s=z(u=>u.uiState.dragInfo),n=e.setActiveCanvasCoreState,o=e.setActiveCanvasViewState;hf();const r=Vn(),a=p.useRef(null),i=p.useRef({x:0,y:0}),c=p.useRef(null),l=p.useRef({x:0,y:0});p.useEffect(()=>{s&&(c.current=null)},[s]);const d=p.useCallback(()=>{var f;const u=E.getState().projectCanvas.getActive(),h=(f=E.getState().uiState)==null?void 0:f.dragInfo;if(!u||!h){a.current!==null&&(cancelAnimationFrame(a.current),a.current=null);return}const g=Ps.processAutoScrollFrame({mousePosition:In.getState().mousePosition??null,lastScrollDelta:i.current,currentOffset:u.viewState.offset,scale:u.viewState.scale,nodes:u.coreState.nodes,selectedNodes:u.coreState.selectedNodes,arrows:u.coreState.arrows||[]});g.shouldScroll&&(i.current=g.scrollDelta,o(w=>({...w,offset:g.newOffset})),n(w=>({...w,nodes:g.updatedNodes,selectedNodes:g.updatedSelectedNodes,arrows:g.updatedArrows}))),a.current=requestAnimationFrame(d)},[o,n]);return p.useEffect(()=>()=>{a.current!==null&&cancelAnimationFrame(a.current)},[]),p.useCallback(u=>{var M,I,A;const h=(M=E.getState().uiState)==null?void 0:M.dragInfo;if(!h)return;const g=E.getState().viewLayer.getActiveId();let f;if(g){const O=((I=E.getState().projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes)??[],F=E.getState().viewLayer.getNodesWithEffectivePositions();if(O.length>0)f=O.map(B=>F.find(P=>P.id===B.id)??B);else if(h.draggedNodeId){const B=F.find(W=>W.id===h.draggedNodeId);f=B?[B]:[]}else f=[]}else f=((A=E.getState().projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes)??[];if(f.length===0)return;const w=In.getState().mousePosition??null,m=hn.calculateScreenDelta({screenCoords:w,prevScreenPos:c.current});if(m.newPrevScreenPos!==null&&(c.current=m.newPrevScreenPos),m.newDragDirection&&(l.current=m.newDragDirection),m.shouldSkipFrame)return;const x=E.getState().projectCanvas.getActive();if(!x)return;const y=x.viewState.scale,v=hn.screenDeltaToCanvasDelta(m.screenDelta,y);if(w){ff(w.x,w.y);const O=x.coreState.nodes.find(W=>W.id===h.draggedNodeId),F=pf(r),B=hn.checkAutoScrollEdges({screenCoords:w,dragDirection:l.current,draggedNode:O,scale:y,offset:x.viewState.offset,edgeThreshold:F});gf(B.shouldAutoScroll),B.shouldAutoScroll&&a.current===null?a.current=requestAnimationFrame(d):!B.shouldAutoScroll&&a.current!==null&&(cancelAnimationFrame(a.current),a.current=null)}else if(a.current===null){const O=hn.calculateMouseLeftWindowDelta({lastCoords:In.getState().mousePosition??null,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight});O.shouldStartAutoScroll&&(i.current=O.scrollDelta,a.current=requestAnimationFrame(d))}const N=u.target;if(_a.isClickOnEditingElement(N)||_a.hasActiveTextSelection())return;const b=E.getState().viewLayer.getActiveId(),j=b?E.getState().viewLayer.getNodesWithEffectivePositions():x.coreState.nodes,R=b?j:j.map(O=>{const F=zt.get(O.id);return F?{...O,x:O.x+F.dx,y:O.y+F.dy}:O}),S=b?f:f.map(O=>{const F=zt.get(O.id);return F?{...O,x:O.x+F.dx,y:O.y+F.dy}:O}),C=hn.calculateNodeMoves({canvasDelta:v,draggedNodeId:h.draggedNodeId,selectedNodes:S,nodes:R,arrows:x.coreState.arrows||[],isCtrlPressed:za.isCtrlPressed(u),isShiftPressed:u.shiftKey});if(C.shouldUpdate){if(b){const k=[],T=[];for(const H of C.updatedSelectedNodes)H.type===le.GROUP?T.push({id:H.id,x:H.x,y:H.y}):k.push({id:H.id,x:H.x,y:H.y});const L=new Set(C.updatedSelectedNodes.map(H=>H.id));for(const H of C.updatedNodes){if(L.has(H.id)||H.type===le.GROUP)continue;const $=j.find(_=>_.id===H.id);$&&($.x!==H.x||$.y!==H.y)&&k.push({id:H.id,x:H.x,y:H.y})}k.length>0&&E.getState().viewLayer.updateNodePositions(k);for(const H of T)E.getState().viewLayer.updateGroupNode(b,H.id,{x:H.x,y:H.y});n(H=>({...H,selectedNodes:C.updatedSelectedNodes,arrows:C.updatedArrows}))}else{for(const k of C.updatedSelectedNodes){const T=j.find(L=>L.id===k.id);if(T){const L=k.x-T.x,H=k.y-T.y;zt.set(k.id,{dx:L,dy:H});const $=document.getElementById(`NodeContainerV2-${k.id}`);$&&($.style.transform=`translate(${k.x}px, ${k.y}px)`)}}E.getState().incrementDragVersion()}const O=$l.calculateHoveredDropTarget({draggedNodes:C.updatedSelectedNodes,allNodes:C.updatedNodes,activeGroupId:E.getState().uiState.activeGroupId??null}),F=E.getState().uiState.hoveredDropTargetGroupId;O.hoveredGroupId!==F&&E.getState().setHoveredDropTargetGroupId(O.hoveredGroupId);const B=_l.calculateHoveredDropTarget({draggedNodes:C.updatedSelectedNodes,allNodes:C.updatedNodes}),W=E.getState().uiState.hoveredDropTargetVocabNodeId;B.hoveredVocabNodeId!==W&&E.getState().setHoveredDropTargetVocabNodeId(B.hoveredVocabNodeId);const P=C.updatedSelectedNodes.length===1?C.updatedSelectedNodes[0]:null;if(P){const k=document.querySelector("[data-canvas-container]"),T=k==null?void 0:k.getBoundingClientRect(),L=T?{x:u.clientX-T.left,y:u.clientY-T.top}:null,H=(x==null?void 0:x.viewState.scale)??1,$=(x==null?void 0:x.viewState.offset)??{x:0,y:0},_=L?{x:(L.x-$.x)/H,y:(L.y-$.y)/H}:null,G=zl.calculateTableDropTarget({droppedNode:P,allNodes:C.updatedNodes,mousePosition:_??void 0}),V=E.getState().uiState.tableDropTarget,D=G.targetTableId&&G.columnKey?{tableId:G.targetTableId,columnKey:G.columnKey,rowId:G.rowId,rowIndex:G.rowIndex}:null;((V==null?void 0:V.tableId)!==(D==null?void 0:D.tableId)||(V==null?void 0:V.columnKey)!==(D==null?void 0:D.columnKey)||(V==null?void 0:V.rowId)!==(D==null?void 0:D.rowId))&&E.getState().setTableDropTarget(D)}else E.getState().uiState.tableDropTarget&&E.getState().setTableDropTarget(null)}},[n,d,r])},Mf=()=>{const e=E.getState(),s=z(o=>o.uiState.dragInfo),n=e.setDragInfo;return p.useCallback(o=>{var r,a,i;if(s){at.log("Node Drag End (Pointer Up on):",s.draggedNodeId);const c=E.getState().projectCanvas.getActive(),l=(c==null?void 0:c.coreState.nodes)??[],d=l.find(h=>h.id===s.draggedNodeId);if(d){const g=E.getState().viewLayer.getActiveId()?E.getState().viewLayer.getNodesWithEffectivePositions():l,f=g.find(j=>j.id===d.id)??d,w=document.querySelector("[data-canvas-container]"),m=w==null?void 0:w.getBoundingClientRect(),x=(c==null?void 0:c.viewState.scale)??1,y=(c==null?void 0:c.viewState.offset)??{x:0,y:0},v=m?{x:o.clientX-m.left,y:o.clientY-m.top}:null,N=v?{x:(v.x-y.x)/x,y:(v.y-y.y)/x}:null,b=zl.calculateTableDropTarget({droppedNode:f,allNodes:g,mousePosition:N??void 0});if(b.targetTableId&&b.columnKey){const j=Cn.extractNodeContent(d);let R=!1;if(b.rowId!==null?(R=E.getState().table.updateCellFromDrop(b.targetTableId,b.rowId,b.columnKey,j),R&&at.log(`Updated cell in table ${b.targetTableId}, row: ${b.rowId}, column: ${b.columnKey}`)):(R=E.getState().table.addRowFromDrop(b.targetTableId,b.columnKey,j),R&&at.log(`Dropped node ${d.id} onto table ${b.targetTableId}, column: ${b.columnKey}`)),R){let S=Z.canvasTable.dropBehavior;try{const C=localStorage.getItem("watcher-table-node-drop-config");C&&(S=JSON.parse(C).dropBehavior)}catch{}S==="delete"?(E.getState().deleteNodeById(d.id),E.getState().setSelectedNodes([])):S==="copy"&&s.initialNodePosition&&E.getState().updateNode(d.id,{x:s.initialNodePosition.x,y:s.initialNodePosition.y}),E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),n(null);return}}}const u=E.getState().uiState.hoveredDropTargetVocabNodeId;if(u&&d){const h=(c==null?void 0:c.coreState.selectedNodes)??[],g=h.length>0?h:[d],f=l.find(w=>w.id===u);if(f){const w=_l.calculateDropResult({droppedNodes:g,targetVocabNode:f});if(w.hasChanges){const m=f.data??{};E.getState().updateNode(u,{data:{...m,sourceWord:w.sourceWord,translationWord:w.translationWord}});for(const x of w.nodeIdsToDelete)E.getState().deleteNodeById(x);E.getState().setSelectedNodes([]),at.log(`Dropped nodes onto vocab node ${u}: source="${w.sourceWord}", translation="${w.translationWord}"`),E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),E.getState().setTableDropTarget(null),n(null);return}}}if(d){const h=(c==null?void 0:c.coreState.selectedNodes)??[],g=h.length>0?h:[d],f=$l.calculateDropResult({droppedNodes:g,allNodes:l,activeGroupId:E.getState().uiState.activeGroupId??null});if(f.hasChanges){for(const[w,m]of f.nodesToAddToGroups)at.log(`Adding nodes ${m.join(", ")} to group ${w}`),E.getState().group.addNodesToGroup(w,m);f.nodesToRemoveFromGroups.length>0&&(at.log(`Removing nodes ${f.nodesToRemoveFromGroups.join(", ")} from their groups`),E.getState().group.removeNodesFromGroup(f.nodesToRemoveFromGroups))}}if(E.getState().setHoveredDropTargetGroupId(null),E.getState().setHoveredDropTargetVocabNodeId(null),E.getState().setTableDropTarget(null),zt.size>0){const h=((r=E.getState().projectCanvas.getActive())==null?void 0:r.coreState.nodes)??[],g=((a=E.getState().projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],f=h.map(m=>{const x=zt.get(m.id);return x?{...m,x:m.x+x.dx,y:m.y+x.dy}:m}),w=g.map(m=>{const x=zt.get(m.id);return x?{...m,x:m.x+x.dx,y:m.y+x.dy}:m});E.getState().setActiveCanvasCoreState(m=>({...m,nodes:f,selectedNodes:w})),zt.clear()}if(s.initialPositions){const h=((i=E.getState().projectCanvas.getActive())==null?void 0:i.coreState.nodes)??[],g=[];for(const[f,w]of Object.entries(s.initialPositions)){const m=h.find(x=>x.id===f);m&&(m.x!==w.x||m.y!==w.y)&&g.push({nodeId:f,from:w,to:{x:m.x,y:m.y}})}if(g.length>0){const f=Zd(g);E.getState().undo.commit(f),at.log("Committed move operation for",g.length,"nodes")}}E.getState().setChatNodeHoldToDrag(null),n(null)}},[s,n])},Ua=new Map,Jn=20,Pf=300,ts=(e,s)=>{const n=nr(),o=p.useRef(null),r=p.useCallback(()=>{o.current&&(clearTimeout(o.current),o.current=null),E.getState().setNodeHoldToResize(null)},[]);return p.useCallback(a=>{const i=E.getState(),c=i.uiState.mode,l=i.setResizingNode;if(c!==J.SELECT||a.button!==0&&a.button!==-1)return;a.stopPropagation();const d=i.projectCanvas.getActive(),u=(d==null?void 0:d.viewState.scale)??1,h=(d==null?void 0:d.viewState.offset)??{x:0,y:0},g={x:a.clientX,y:a.clientY},f=jt(g,u,h),w=d==null?void 0:d.coreState.nodes.find(x=>x.id===e.id),m={x:(w==null?void 0:w.x)??e.x,y:(w==null?void 0:w.y)??e.y,width:(w==null?void 0:w.width)??e.width??100,height:(w==null?void 0:w.height)??e.height??50};if(n){r(),i.setNodeHoldToResize({nodeId:e.id,edge:s,isHolding:!0,isReady:!1,touchX:a.clientX,touchY:a.clientY}),o.current=setTimeout(()=>{var y;(y=navigator.vibrate)==null||y.call(navigator,50),i.setNodeHoldToResize({nodeId:e.id,edge:s,isHolding:!1,isReady:!0,touchX:a.clientX,touchY:a.clientY}),l({id:e.id,handle:s,startNodeRect:m,startPointerPos:f})},Pf);const x=()=>{r(),document.removeEventListener("pointerup",x),document.removeEventListener("pointercancel",x)};document.addEventListener("pointerup",x),document.addEventListener("pointercancel",x);return}l({id:e.id,handle:s,startNodeRect:m,startPointerPos:f})},[e,s,n,r])},Df=()=>{var n;const e=E.getState(),s=(n=e.uiState)==null?void 0:n.resizingNode;return p.useCallback(o=>{if(!s)return;const{id:r,handle:a,startNodeRect:i,startPointerPos:c}=s,l=e.projectCanvas.getActive(),d=(l==null?void 0:l.viewState.scale)??1,u=(l==null?void 0:l.viewState.offset)??{x:0,y:0},h={x:o.clientX,y:o.clientY},g=jt(h,d,u),f=g.x-c.x,w=g.y-c.y;let m=i.x,x=i.y,y=i.width,v=i.height;a.includes("left")&&(y=Math.round(Math.max(Jn,i.width-f)),m=i.x+i.width-y),a.includes("right")&&(y=Math.round(Math.max(Jn,i.width+f))),a.includes("top")&&(v=Math.round(Math.max(Jn,i.height-w)),x=i.y+i.height-v),a.includes("bottom")&&(v=Math.round(Math.max(Jn,i.height+w))),Ua.set(r,{x:m,y:x,width:y,height:v});const N=document.getElementById(`NodeContainerV2-${r}`);if(N){N.style.transform=`translate(${m}px, ${x}px)`,N.style.width=`${y}px`,N.style.height=`${v}px`;const b=N.querySelector('[data-test="draw-node-svg"]');b&&(b.style.width=`${y}px`,b.style.height=`${v}px`)}},[s,e])};function Of(e,s){const n=e.x+(e.width??100),o=e.y+(e.height??50),r=s.x+s.width,a=s.y+s.height;return e.x>=s.x&&e.y>=s.y&&n<=r&&o<=a}const Lf=()=>{var r;const e=E.getState(),s=(r=e.uiState)==null?void 0:r.resizingNode,n=e.setResizingNode,o=e.updateNode;return p.useCallback(a=>{var i;if(s){const{id:c,handle:l,startNodeRect:d}=s,u=Ua.get(c),h=l.includes("top")||l.includes("bottom"),g=l.includes("left")||l.includes("right"),f=e.projectCanvas.getActive(),w=f==null?void 0:f.coreState.nodes.find(m=>m.id===c);if(u)if(h)o(c,{x:u.x,y:u.y,width:u.width,height:u.height,options:{lockSize:!0}});else if(g){const m=((i=w==null?void 0:w.data)==null?void 0:i.nodeType)==="workflowOrchestration";if(w&&w.content&&!m){const x=mt(w.content,u.width,w);o(c,{x:u.x,y:u.y,width:u.width,height:x,options:{lockSize:!0}})}else o(c,{x:u.x,y:u.y,width:u.width,height:u.height})}else o(c,{x:u.x,y:u.y,width:u.width,height:u.height});if(w&&w.type===le.GROUP&&Z.groups.autoAddNodesOnExpand){const m=w.data,x=new Set((m==null?void 0:m.childNodeIds)??[]),y=(f==null?void 0:f.coreState.nodes)??[],v=u??{x:w.x,y:w.y,width:w.width??100,height:w.height??50},N=y.filter(b=>b.id===c||b.type===le.GROUP||x.has(b.id)||b.groupId&&b.groupId!==c?!1:Of(b,v));if(N.length>0){const b=N.map(j=>j.id);e.group.addNodesToGroup(c,b)}}if(u&&(u.x!==d.x||u.y!==d.y||u.width!==d.width||u.height!==d.height)){const x={type:"node:resize",nodeId:c,from:d,to:u};E.getState().undo.commit(x)}Ua.delete(c),n(null),e.setNodeHoldToResize(null)}},[s,n,o,e])},Wf=30,Mo=(e,s)=>{const n=document.elementsFromPoint(e,s);for(const a of n){const i=a.getAttribute("data-row-connector"),c=a.getAttribute("data-node-id");if(i&&c)return{nodeId:c,rowId:i}}const o=document.querySelectorAll("[data-row-connector]");let r=null;return o.forEach(a=>{const i=a.getBoundingClientRect(),c=i.left+i.width/2,l=i.top+i.height/2,d=Math.sqrt(Math.pow(e-c,2)+Math.pow(s-l,2));if(d<=Wf){const u=a.getAttribute("data-row-connector")??"",h=a.getAttribute("data-node-id")??"";u&&h&&(!r||d<r.distance)&&(r={nodeId:h,rowId:u,distance:d})}}),r},Hf=Z.arrows.reverseArrowOnMultipleConnect,St=new js("useArrowDrawingV2",ks.useArrowDrawingV2),Bf=()=>p.useCallback(e=>{const s=E.getState(),n=s.uiState.mode,o=s.uiState.arrowSubMode,r=s.uiState.temporaryArrow,a=s.projectCanvas.getActive(),i=s.arrow.setTemporary,c=s.arrow.add,l=s.getCanvasMouseCoords,d=(a==null?void 0:a.coreState.nodes)??[],u=o===Mn.STAY;if(n!==J.DRAW_ARROW)return;St.log("Fired in DRAW_ARROW mode.");const h=l();if(!h){St.log("No click point found.");return}const g=E.getState().uiState.activeGroupId,w=wo(h,d,g?[g]:void 0),m=(w==null?void 0:w.id)??null;if(r!=null&&r.startNodeId&&m&&m!==r.startNodeId){St.log(`Click-click: Creating arrow from ${r.startNodeId} to ${m}`);const x=nt(m,h,r.startPoint,d,null),y={id:De(10),startPoint:r.startPoint,endPoint:x,startNodeId:r.startNodeId,endNodeId:m,label:""};c(y),u?i({startPoint:h,endPoint:h,startNodeId:m}):(i(null),s.setMode(J.SELECT)),e.stopPropagation();return}if(!m){r?(St.log("Clicked on background - cancelling temporary arrow."),i(null)):St.log("Clicked on background - ignoring (arrows must start from a node)."),e.stopPropagation();return}St.log(`Starting arrow draw from node: ${m}`),i({startPoint:h,endPoint:h,startNodeId:m}),e.stopPropagation()},[]),Ff=Bf,$f=()=>p.useCallback(e=>{const s=E.getState(),n=s.uiState.mode,o=s.uiState.temporaryArrow,r=s.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.nodes)??[],i=s.arrow.setTemporary,c=s.getCanvasMouseCoords;if(n!==J.DRAW_ARROW||!o)return;let l=c();if(!l)return;const d=Mo(e.clientX,e.clientY);d&&(l=nt(d.nodeId,l,o.startPoint,a,d.rowId)),i({...o,endPoint:l}),e.stopPropagation()},[]),zf=$f,Qn=(e,s)=>{const n=E.getState(),o=n.setMode,r=n.arrow.setTemporary,a=n.uiState.mode;return p.useCallback(i=>{if(a!==J.SELECT)return;St.log(`useQuickArrowHandleMouseDownHandler: Fired on node ${e.id}, handle ${s}.`),i.stopPropagation();const c=e.width??100,l=e.height??50;let d;switch(s){case"top":d={x:e.x+c/2,y:e.y};break;case"bottom":d={x:e.x+c/2,y:e.y+l};break;case"left":d={x:e.x,y:e.y+l/2};break;case"right":d={x:e.x+c,y:e.y+l/2};break}St.log("Switching to DRAW_ARROW mode."),o(J.DRAW_ARROW),St.log("Setting temporary arrow from node",e.id),r({startPoint:d,endPoint:d,startNodeId:e.id})},[e,s,r,o,a])},_f=()=>p.useCallback(e=>{var S;const s=E.getState(),n=s.uiState.mode,o=s.uiState.arrowSubMode,r=s.uiState.temporaryArrow,a=s.projectCanvas.getActive(),i=s.arrow.setTemporary,c=s.arrow.add,l=s.setMode,d=(a==null?void 0:a.coreState.nodes)??[],u=(a==null?void 0:a.coreState.selectedNodes)??[],h=s.getCanvasMouseCoords,g=o===Mn.STAY;if(n!==J.DRAW_ARROW||!r)return;St.log("useArrowPointerUpHandler: Fired.");const f=h();if(!f){St.log("No final mouse coords found.");return}const{startPoint:w,startNodeId:m}=r,y=Math.sqrt(Math.pow(f.x-w.x,2)+Math.pow(f.y-w.y,2))>10,v=E.getState().uiState.activeGroupId,N=v?[v]:void 0;let b=null,j=null;const R=Mo(e.clientX,e.clientY);if(R)b=R.nodeId,j=R.rowId;else{const C=wo(f,d,N);C&&(((S=C.data)==null?void 0:S.nodeType)==="workflowOrchestration"||(b=C.id))}if(y&&b&&b!==m&&u.length===0){St.log(`Drag mode: Creating arrow from ${m} to ${b}`);const C=nt(b,f,w,d,j),M={id:De(10),startPoint:w,endPoint:C,startNodeId:m??null,endNodeId:b,endRowId:j,label:""};c(M),g?i(null):(i(null),l(J.SELECT)),e.stopPropagation();return}if(y&&u.length>0&&b){u.forEach(C=>{if(b&&b!==C.id){const M=nt(b,f,w,d,j),I=Hf&&u.length>1,A={id:De(10),startPoint:I?M:w,endPoint:I?w:M,startNodeId:I?b:C.id??null,endNodeId:I?C.id??null:b,startRowId:I?j:void 0,endRowId:I?void 0:j,label:""};c(A)}}),i(null),g||l(J.SELECT),e.stopPropagation();return}if(!y&&b===m){St.log("Click on start node - waiting for second click on target node"),e.stopPropagation();return}if(!b){St.log("Released on empty space - canceling arrow"),i(null),e.stopPropagation();return}e.stopPropagation()},[]),Vf=_f;let mo=null;const vr=()=>mo,Vl=()=>{const e=p.useRef(null),s=p.useRef([]),n=p.useRef(null),o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),i=p.useRef(!1),c=z(u=>u.uiState.canvasWidth??0),l=z(u=>u.uiState.canvasHeight??0),d=z(u=>u.uiState.mode);return p.useEffect(()=>{const u=e.current;if(!u)return;const h=u.getBoundingClientRect();if(h.width===0||h.height===0)return;const g=window.devicePixelRatio||1;u.width=h.width*g,u.height=h.height*g;const f=u.getContext("2d");f&&f.scale(g,g)},[c,l,d]),p.useEffect(()=>{const u=e.current;if(!u){mo=null;return}const h=()=>{const m=E.getState().projectCanvas.getActive();return(m==null?void 0:m.viewState)??{offset:{x:0,y:0},scale:1}},g=(m,x)=>{const y=u.getBoundingClientRect();return{x:m-y.left,y:x-y.top}},f=m=>{if(!a.current||s.current.length<2)return;const{scale:x}=h(),y=window.devicePixelRatio||1;m.clearRect(0,0,u.width/y,u.height/y);const v=(a.current.opacity??1)<1;m.beginPath(),m.strokeStyle=a.current.strokeColor,m.lineWidth=a.current.strokeWidth*x,m.globalAlpha=a.current.opacity??1,m.lineCap=v?"butt":"round",m.lineJoin=v?"bevel":"round";const N=s.current;m.moveTo(N[0].x,N[0].y);for(let b=1;b<N.length;b++)m.lineTo(N[b].x,N[b].y);m.stroke(),m.globalAlpha=1},w=m=>{if(!a.current||s.current.length<2)return;const{scale:x}=h(),y=s.current,v=y[y.length-2],N=y[y.length-1];m.beginPath(),m.strokeStyle=a.current.strokeColor,m.lineWidth=a.current.strokeWidth*x,m.globalAlpha=a.current.opacity??1,m.lineCap="round",m.lineJoin="round",m.moveTo(v.x,v.y),m.lineTo(N.x,N.y),m.stroke(),m.globalAlpha=1};return mo={startStroke:(m,x,y)=>{const v=u==null?void 0:u.getContext("2d");if(!v||!u)return;const N=window.devicePixelRatio||1;v.clearRect(0,0,u.width/N,u.height/N),a.current=y;const b=g(m,x);s.current=[b],n.current=b,o.current=b,r.current=b,i.current=!0},addPoint:(m,x)=>{var M;if(!i.current||!o.current||!r.current)return;const y=u==null?void 0:u.getContext("2d");if(!y)return;let v=g(m,x);const N=(((M=a.current)==null?void 0:M.opacity)??1)<1;if(N){const I=E.getState().getDrawAxisLock();I==="horizontal"?v={x:v.x,y:r.current.y}:I==="vertical"&&(v={x:r.current.x,y:v.y})}const b=Z.drawing.minPointDistance,j=v,R=j.x-o.current.x,S=j.y-o.current.y;Math.sqrt(R*R+S*S)>=b&&(s.current.push({...j}),o.current=j,N?f(y):w(y))},endStroke:()=>{if(!i.current)return null;const m=u==null?void 0:u.getContext("2d");if(m&&u){const N=window.devicePixelRatio||1;m.clearRect(0,0,u.width/N,u.height/N)}const{offset:x,scale:y}=h(),v=s.current.map(N=>({x:(N.x-x.x)/y,y:(N.y-x.y)/y}));return s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1,v.length>1?v:null},clear:()=>{const m=u==null?void 0:u.getContext("2d");if(m&&u){const x=window.devicePixelRatio||1;m.clearRect(0,0,u.width/x,u.height/x)}s.current=[],n.current=null,o.current=null,r.current=null,a.current=null,i.current=!1}},()=>{mo=null}},[d]),d!==J.DRAW?null:t.jsx("canvas",{ref:e,"data-test":"temporary-drawing-canvas","data-temporary-drawing-canvas":!0,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",touchAction:"none",zIndex:9999}})};Vl.displayName="TemporaryDrawingCanvas";const Nt=new js("useDrawingV2",ks.useDrawingV2);let kn=null,Hs=null,Po=null,Bs=null,Do=[],Oo=!1,Lo=0;const Uf=3;let Na=null,gi=null,Sa=null,fi=null;const en=new Map,Ul=()=>{Oo||(Bs=document.querySelector("[data-temporary-drawing-canvas]"),Do=Array.from(document.querySelectorAll(".markdown-textarea")),Do.forEach(e=>{const s=e;en.has(e)||en.set(e,s.getAttribute("contenteditable")||""),s.style.setProperty("pointer-events","auto","important"),s.style.setProperty("user-select","text","important"),s.setAttribute("contenteditable","true"),s.setAttribute("inputmode","none")}),Oo=!0,Lo=0)},Gf=()=>{Do.forEach(e=>{const s=e;s.style.removeProperty("pointer-events"),s.style.removeProperty("user-select")}),Bs=null,Do=[],Oo=!1,Lo=0},Yf=(e,s)=>{var o;if(Lo++,Lo%Uf!==1)return;Oo||Ul(),Bs&&(Bs.style.visibility="hidden");let n=null;if(typeof document.caretRangeFromPoint=="function")n=document.caretRangeFromPoint(e,s);else{const r=(o=document.caretPositionFromPoint)==null?void 0:o.call(document,e,s);r!=null&&r.offsetNode&&(n=document.createRange(),n.setStart(r.offsetNode,r.offset),n.setEnd(r.offsetNode,r.offset))}if(n&&n.startContainer.nodeType===Node.TEXT_NODE){const r=n.startContainer.parentElement;if((r==null?void 0:r.closest("[data-node-id]"))!==null){const i=window.getSelection();if(i)if(kn){const c=kn.screenX,l=kn.screenY,d=Ga(c,l);if(!d)return;const u=document.createRange(),h=d.node,g=d.offset,f=n.startContainer,w=n.startOffset,m=h.compareDocumentPosition(f);(h===f?g<=w:!(m&Node.DOCUMENT_POSITION_PRECEDING))?(u.setStart(h,g),u.setEnd(f,w)):(u.setStart(f,w),u.setEnd(h,g)),i.removeAllRanges(),i.addRange(u)}else{kn={node:n.startContainer,offset:n.startOffset,screenX:e,screenY:s},i.removeAllRanges();const c=document.createRange();c.setStart(n.startContainer,n.startOffset),c.setEnd(n.startContainer,n.startOffset),i.addRange(c)}}}Bs&&(Bs.style.visibility="")},Gl=()=>{kn=null,Hs=null,Po=null,Gf(),en.forEach((e,s)=>{const n=s;e?n.setAttribute("contenteditable",e):n.removeAttribute("contenteditable"),n.removeAttribute("inputmode")}),en.clear()},Ga=(e,s)=>{const n=typeof document.caretRangeFromPoint=="function",o=typeof document.caretPositionFromPoint=="function";if(n){const r=document.caretRangeFromPoint(e,s);if(r&&r.startContainer.nodeType===Node.TEXT_NODE)return{node:r.startContainer,offset:r.startOffset}}else if(o){const r=document.caretPositionFromPoint(e,s);if(r!=null&&r.offsetNode&&r.offsetNode.nodeType===Node.TEXT_NODE)return{node:r.offsetNode,offset:r.offset}}return null},Kf=(e,s,n,o)=>{const r=document.querySelector("[data-temporary-drawing-canvas]"),a=r==null?void 0:r.style.visibility;r&&(r.style.visibility="hidden"),document.querySelectorAll(".markdown-textarea").forEach(d=>{const u=d;en.has(d)||en.set(d,u.getAttribute("contenteditable")||""),u.setAttribute("contenteditable","true"),u.setAttribute("inputmode","none")});const c=Ga(e,s),l=Ga(n,o);if(r&&(r.style.visibility=a||""),c&&l){const d=window.getSelection();if(d){d.removeAllRanges();const u=document.createRange(),h=c.node.compareDocumentPosition(l.node);(c.node===l.node?c.offset<=l.offset:!(h&Node.DOCUMENT_POSITION_PRECEDING))?(u.setStart(c.node,c.offset),u.setEnd(l.node,l.offset)):(u.setStart(l.node,l.offset),u.setEnd(c.node,c.offset)),d.addRange(u)}}},Xf=(e,s)=>{var C,M,I;const n=window.getSelection();if(!n||n.isCollapsed)return;const o=n.toString().trim();if(!o)return;const r=((C=n.anchorNode)==null?void 0:C.nodeType)===Node.TEXT_NODE?n.anchorNode.parentElement:n.anchorNode,a=((M=n.focusNode)==null?void 0:M.nodeType)===Node.TEXT_NODE?n.focusNode.parentElement:n.focusNode,i=(r==null?void 0:r.closest("[data-node-id]"))??(a==null?void 0:a.closest("[data-node-id]"));if(!i)return;const c=i.getAttribute("data-node-id");if(!c)return;const l=E.getState(),d=l.getNodeById(c);if(!d)return;const u=Ss(o,void 0,d),h=Le.buildTextNodeV2({content:o,width:u.width,height:u.height,linkedSourceNodeId:d.id,options:{lockSize:!1}});let g=d;if(e==="left"&&gi===d.id&&Na){const A=l.getNodeById(Na);A&&(g=A)}else if(e==="right"&&fi===d.id&&Sa){const A=l.getNodeById(Sa);A&&(g=A)}const f=(I=l.projectCanvas.getActive())==null?void 0:I.viewState,w=(f==null?void 0:f.offset)??{y:0},m=(f==null?void 0:f.scale)??1,x=document.querySelector("[data-canvas-container]"),y=x==null?void 0:x.getBoundingClientRect(),v=(y==null?void 0:y.top)??0,b=(s-v-w.y)/m,j=Z.highlightAndCreate.createConnectingArrow,R=h.height??u.height,S=b-R/2;ea(h,{...g,y:S},e,{shouldFocus:!1,createArrow:j}),e==="left"?(Na=h.id,gi=d.id):(Sa=h.id,fi=d.id)};let Ca=null,ja=0;const qf=e=>{const{level:s}=Z.drawing.compression;return Al(e,s)},Zf=e=>{const{level:s}=Z.drawing.compression;return kl(e,s)};let Xt=null,Wo=!1;const Jf=()=>{const e=E.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getDrawSubMode,r=e.getDrawStyle;return p.useCallback(a=>{if(a.pointerType==="pen"&&a.button===1&&(Wo=!0),E.getState().uiState.mode!==J.DRAW||a.button!==0&&a.button!==-1||a.buttons&4||a.pointerType==="pen"&&Wo)return;a.preventDefault(),Nt.log("Fired in DRAW mode.");const c=vr();if(a.pointerType==="touch"&&Xt!==null&&a.pointerId!==Xt){Nt.log("Second touch detected, canceling drawing."),c==null||c.clear(),n(null),Xt=null;return}const l=s();if(!l){Nt.log("No start point found.");return}const d=o(),u=r();Nt.log(`Starting draw with sub-mode: ${d}, pointerId: ${a.pointerId}`),Xt=a.pointerId;const h=Ke.createTemporaryDrawing(d,l,u);n(h),d===Ce.FREEHAND&&(Nt.log(`canvasAPI available: ${!!c}`),c?(c.startStroke(a.clientX,a.clientY,u),Gl(),Hs=a.clientX,Po=a.clientY,(u.opacity??1)<1&&Ul()):Nt.log("WARNING: canvasAPI is null in mouseDown!")),a.stopPropagation()},[s,n,o,r])},Qf=()=>{const e=E.getState(),s=e.getCanvasMouseCoords,n=e.setTemporaryDrawing,o=e.getTemporaryDrawing;return p.useCallback(r=>{var c;if(E.getState().uiState.mode!==J.DRAW)return;const i=o();if(i&&!(Xt!==null&&r.pointerId!==Xt)){if(i.subMode===Ce.FREEHAND){const l=vr();if(l){const d=((c=r.getCoalescedEvents)==null?void 0:c.call(r))??[r];for(const h of d)l.addPoint(h.clientX,h.clientY);(i.style.opacity??1)<1&&Yf(r.clientX,r.clientY)}else Nt.log("WARNING: canvasAPI is null in mouseMove!")}else{const l=s();if(!l)return;const d=Ke.updateShapeEndPoint(i,l);n(d)}r.stopPropagation()}},[s,n,o])},em=e=>e.elements&&e.elements.length>0?e.elements:e.drawType&&e.style?[{type:e.drawType,stroke:e.stroke,shape:e.shape,style:e.style}]:[],tm=(e,s)=>{const n=Math.min(e.x,s.x),o=Math.min(e.y,s.y),r=Math.max(e.x+(e.width??0),s.x+s.width),a=Math.max(e.y+(e.height??0),s.y+s.height);return{x:n,y:o,width:r-n,height:a-o}},sm=(e,s,n)=>e.map(o=>({x:o.x+s,y:o.y+n})),nm=()=>{const e=E.getState(),s=e.addNode,n=e.updateNode,o=e.getNodeById,r=e.setTemporaryDrawing,a=e.getTemporaryDrawing,i=e.undo.commit;return p.useCallback(c=>{var I;if(c.pointerType==="pen"&&Wo&&(c.buttons&4||(Wo=!1)),E.getState().uiState.mode!==J.DRAW)return;const d=a();if(!d||Xt!==null&&c.pointerId!==Xt)return;const u=Hs!==null&&c.clientX<Hs?"left":"right",h=window.getSelection(),g=(h==null?void 0:h.toString().trim())||"";Hs!==null&&Po!==null&&g.length===0&&Kf(Hs,Po,c.clientX,c.clientY),Xf(u,c.clientY),(I=window.getSelection())==null||I.removeAllRanges(),Gl(),Nt.log("useDrawMouseUpHandler: Fired.");const f=vr(),w=(f==null?void 0:f.endStroke())??null;if(d.subMode===Ce.FREEHAND&&(!w||w.length<2)){Nt.log("Freehand drawing too short, discarding."),M();return}const x={[Ce.RECTANGLE]:"rectangle",[Ce.SQUARE]:"square",[Ce.CIRCLE]:"circle",[Ce.ELLIPSE]:"ellipse",[Ce.LINE]:"line",[Ce.ARROW]:"arrow",[Ce.FREEHAND]:"line"}[d.subMode],y=d.subMode===Ce.FREEHAND?Ke.calculateFreehandBounds(w):Ke.calculateShapeBounds(d.startPoint,d.endPoint,x),v=d.style.strokeWidth??2,N={x:y.x-v,y:y.y-v,width:y.width+v*2,height:y.height+v*2};if(d.subMode!==Ce.FREEHAND&&!Ke.canFinalizeDraw(d)){Nt.log("Shape too small or invalid, discarding."),M();return}const b=Date.now(),j=Z.drawing.strokeGroupingTimeoutMs,R=Ca?o(Ca):void 0;if(b-ja<j&&R&&R.type===le.DRAWING&&R){Nt.log("Grouping with existing node:",R.id);const A=R.data,O=em(A),F=tm(R,N),B=R.x-F.x,W=R.y-F.y,P=O.map(_=>{if(_.type==="freehand"&&_.stroke){const G=sm(_.stroke.points,B,W),V=Vp(_.stroke.smoothedPath,B,W);return{..._,stroke:{points:G,smoothedPath:V}}}return _.type==="shape"&&_.shape?{..._,shape:{..._.shape,startPoint:{x:_.shape.startPoint.x+B,y:_.shape.startPoint.y+W},endPoint:{x:_.shape.endPoint.x+B,y:_.shape.endPoint.y+W}}}:_}),k=mi(d,N,F,w),T=Zf(k),L={elements:[...P,T],intrinsicWidth:F.width,intrinsicHeight:F.height},H={x:R.x,y:R.y,width:R.width,height:R.height,data:A},$={x:F.x,y:F.y,width:F.width,height:F.height,data:L};n(R.id,$),i({type:"node:update",nodeId:R.id,from:H,to:$}),ja=b,Nt.log("Merged into node:",R.id)}else{const A=mi(d,N,N,w),O=qf({elements:[A],intrinsicWidth:N.width,intrinsicHeight:N.height}),F={id:De(10),x:N.x,y:N.y,width:N.width,height:N.height,type:le.DRAWING,data:O,content:""};s(F,void 0,{dontSelect:!0}),Ca=F.id,ja=b,Nt.log("Created DRAWING node:",F.id)}M();function M(){Nt.log("Resetting temporary drawing state."),r(null),Xt=null,c.stopPropagation()}},[s,n,o,r,a,i])};function mi(e,s,n,o=null){if(s.x-n.x,s.y-n.y,e.subMode===Ce.FREEHAND){const d=(o??e.points).map(h=>({x:h.x-n.x,y:h.y-n.y})),u=Ke.smoothToSVGPath(d);return{type:"freehand",stroke:{points:d,smoothedPath:u},style:e.style}}const r=e.startPoint,a=e.endPoint;return{type:"shape",shape:{shapeType:{[Ce.RECTANGLE]:"rectangle",[Ce.SQUARE]:"square",[Ce.CIRCLE]:"circle",[Ce.ELLIPSE]:"ellipse",[Ce.LINE]:"line",[Ce.ARROW]:"arrow",[Ce.FREEHAND]:"line"}[e.subMode],startPoint:{x:r.x-n.x,y:r.y-n.y},endPoint:{x:a.x-n.x,y:a.y-n.y}},style:e.style}}const xi=(e,s)=>{const n=e.clientX-s.clientX,o=e.clientY-s.clientY;return Math.sqrt(n*n+o*o)},wi=(e,s)=>({x:(e.clientX+s.clientX)/2,y:(e.clientY+s.clientY)/2}),yi=()=>Z.holdToSelect,om=()=>{const e=E.getState(),s=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=e.setIsPanning,r=e.setSelectionBox,a=e.setPendingSelectionStart,i=e.setIsHoldSelectActive,c=e.setHoldSelectProgress,l=nr(),d=z(B=>B.uiState.isHoldSelectActive??!1),u=p.useRef(null),h=20,g=10,f=B=>Number.isFinite(B)&&Math.abs(B)<1e10,w=(B,W)=>!f(B)||!f(W.x)||!f(W.y)?(R.current=null,S.current=null,C.current=null,u.current=null,null):{scale:B,offset:W},m=p.useRef(null),x=p.useRef(null),y=p.useRef(null),v=p.useRef(null),N=p.useRef(null),b=p.useRef(null),j=p.useRef(null),R=p.useRef(null),S=p.useRef(null),C=p.useRef(null),M=p.useCallback(()=>{x.current&&(clearTimeout(x.current),x.current=null),y.current&&(clearTimeout(y.current),y.current=null),N.current=null,c(null)},[c]),I=p.useCallback((B,W)=>{if(!W)return{x:B.clientX,y:B.clientY};const P=W.getBoundingClientRect();return{x:B.clientX-P.left,y:B.clientY-P.top}},[]),A=p.useCallback(B=>{var T;const W=E.getState().projectCanvas.getActive();if(!W)return;const P=E.getState().uiState.mode,k=B.target;if(b.current=k.closest("[data-canvas-container]"),B.touches.length===1){const L=B.touches[0],H=k.closest("[data-node-id]"),$=k.id.includes("resize-handle-"),_=k.closest("[data-ui-panel]");if(H||$||_){m.current=null,M();return}if(l){const G=yi();M(),v.current={x:L.clientX,y:L.clientY},N.current=Date.now(),y.current=setTimeout(()=>{const V=N.current?Date.now()-N.current:0,Y=G.holdDurationMs-V-100;Y>0&&c({touchX:L.clientX,touchY:L.clientY,durationMs:Y})},G.indicatorDelayMs),x.current=setTimeout(()=>{var D;c(null),i(!0),(D=navigator.vibrate)==null||D.call(navigator,50);const V=I(L,b.current);r({start:V,end:V}),o(!1),m.current=null},G.holdDurationMs),m.current={startX:L.clientX,startY:L.clientY,initialOffsetX:W.viewState.offset.x,initialOffsetY:W.viewState.offset.y},o(!0),u.current=null;return}if(P===J.DRAW||P===J.SELECT){m.current=null;return}m.current={startX:L.clientX,startY:L.clientY,initialOffsetX:W.viewState.offset.x,initialOffsetY:W.viewState.offset.y},o(!0),u.current=null}else if(B.touches.length===2){j.current&&(clearTimeout(j.current),j.current=null),r(null),a(null),l&&(M(),i(!1),v.current=null);const L=B.touches[0],H=B.touches[1],$=xi(L,H),_=wi(L,H);if(u.current){const G=((T=S.current)==null?void 0:T.scale)??W.viewState.scale;if(!f(G)){u.current=null,R.current=null,S.current=null;return}u.current={...u.current,initialDistance:$,initialScale:G}}else{const G=W.viewState.scale,V=W.viewState.offset;if(!f(G)||!f(V.x)||!f(V.y))return;const D=jt(_,G,V);u.current={initialDistance:$,initialScale:G,initialOffsetX:V.x,initialOffsetY:V.y,center:_,anchorInCanvas:D,gestureType:"undetermined"},R.current=G}m.current=null,o(!1)}else u.current=null,m.current=null,o(!1),l&&(M(),i(!1),v.current=null)},[s,o,r,a,l,M,I]),O=p.useCallback(B=>{var P,k,T,L;if(s()){if(B.touches.length===1){const H=B.touches[0];if(l&&d){B.preventDefault();const $=I(H,b.current),_=(P=E.getState().uiState)==null?void 0:P.selectionBox;_&&r({start:_.start,end:$});return}if(l&&v.current&&x.current){const $=yi(),_=H.clientX-v.current.x,G=H.clientY-v.current.y;Math.hypot(_,G)>$.movementThresholdPx&&(M(),v.current=null)}if(m.current){B.preventDefault();const $=H.clientX-m.current.startX,_=H.clientY-m.current.startY;n(G=>({...G,offset:{x:m.current.initialOffsetX+$,y:m.current.initialOffsetY+_}}))}}else if(B.touches.length===2&&u.current){B.preventDefault();const H=B.touches[0],$=B.touches[1],_=xi(H,$),G=wi(H,$),V=Math.abs(_-u.current.initialDistance);if(u.current.gestureType==="undetermined")if(V>h){u.current.gestureType="zoom",C.current=null;const D=(k=E.getState().projectCanvas.getActive())==null?void 0:k.viewState,Y=(D==null?void 0:D.scale)??u.current.initialScale,te=(D==null?void 0:D.offset)??{x:u.current.initialOffsetX,y:u.current.initialOffsetY},ie=jt(u.current.center,Y,te);R.current=Y,S.current={scale:Y,offset:te},u.current.initialDistance=_,u.current.initialScale=Y,u.current.initialOffsetX=te.x,u.current.initialOffsetY=te.y,u.current.anchorInCanvas=ie}else{const D=Math.abs(G.x-u.current.center.x),Y=Math.abs(G.y-u.current.center.y);(D>h||Y>h)&&(u.current.gestureType="pan",o(!0))}if(u.current.gestureType==="zoom"){if(C.current===null){const ee=((T=s())==null?void 0:T.coreState.nodes)??[],K=(L=E.getState().projectCanvas.getActive())==null?void 0:L.viewState;if(ee.length>0&&K){const U=ee[0],q=Math.round(U.x*K.scale+K.offset.x),se=Math.round(U.y*K.scale+K.offset.y);C.current={x:q,y:se,scale:K.scale,anchor:{x:Math.round(u.current.anchorInCanvas.x),y:Math.round(u.current.anchorInCanvas.y)},center:{x:Math.round(u.current.center.x),y:Math.round(u.current.center.y)}}}return}if(_<g||u.current.initialDistance<g)return;const D=_/u.current.initialDistance;let Y=u.current.initialScale*D;if(!f(D)||!f(Y))return;const{min:te,max:ie}=Z.zoom;Y=Math.max(te,Math.min(ie,Y)),R.current!==null&&(Y=R.current+(Y-R.current)*.4),R.current=Y;const we=u.current.anchorInCanvas,ge=u.current.center,X=ge.x-we.x*Y,ce=ge.y-we.y*Y,ue=w(Y,{x:X,y:ce});if(!ue)return;S.current={scale:ue.scale,offset:ue.offset},n(ee=>({...ee,scale:ue.scale,offset:ue.offset})),C.current={x:0,y:0,scale:Y,anchor:{x:Math.round(we.x),y:Math.round(we.y)},center:{x:Math.round(ge.x),y:Math.round(ge.y)}}}else if(u.current.gestureType==="pan"){const D=G.x-u.current.center.x,Y=G.y-u.current.center.y,te=u.current.initialOffsetX+D,ie=u.current.initialOffsetY+Y;n(we=>({...we,offset:{x:te,y:ie}}))}}}},[s,n,o,l,d,M,I,r]),F=p.useCallback(B=>{const W=E.getState().uiState.mode;if(B.touches.length===0)j.current&&(clearTimeout(j.current),j.current=null),u.current=null,m.current=null,R.current=null,S.current=null,C.current=null,o(!1),l&&(M(),v.current=null,d&&i(!1));else if(B.touches.length===1){if(j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{u.current=null,j.current=null},150),l&&(M(),i(!1),v.current=null),!l&&(W===J.DRAW||W===J.SELECT)){m.current=null,o(!1);return}if(!m.current){const P=E.getState().projectCanvas.getActive();if(P){const k=B.touches[0];m.current={startX:k.clientX,startY:k.clientY,initialOffsetX:P.viewState.offset.x,initialOffsetY:P.viewState.offset.y},o(!0)}}}else B.touches.length>=2&&(m.current=null,o(!1),l&&(M(),i(!1),v.current=null))},[o,l,d,M]);return{handleTouchStart:A,handleTouchMove:O,handleTouchEnd:F}},am=e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,rm={offset:{x:0,y:0},scale:1,targetView:null},im=()=>{const e=z(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.viewState)??rm}),s=E.getState(),n=s.projectCanvas.getActive,o=s.setActiveCanvasViewState,r=p.useRef(null),a=p.useRef({x:0,y:0}),i=p.useRef(1),c=p.useRef(!1);p.useEffect(()=>{const l=e.offset,d=e.scale,u=e.targetView;if(u){if(u.animationStartTime===0){const g=performance.now();o(f=>({...f,targetView:f.targetView?{...f.targetView,animationStartTime:g}:null}));return}c.current||(a.current=l,i.current=d,c.current=!0);const h=g=>{var j;const f=(j=n())==null?void 0:j.viewState,w=f==null?void 0:f.targetView;if(!w){r.current&&(cancelAnimationFrame(r.current),r.current=null);return}const m=g-w.animationStartTime,x=Math.min(m/w.animationDuration,1),y=am(x),v=a.current.x+(w.targetOffset.x-a.current.x)*y,N=a.current.y+(w.targetOffset.y-a.current.y)*y,b=i.current+(w.targetScale-i.current)*y;o(R=>({...R,offset:{x:v,y:N},scale:b})),x<1?r.current=requestAnimationFrame(h):(o(R=>({...R,offset:w.targetOffset,scale:w.targetScale,targetView:null})),c.current=!1,r.current=null)};r.current=requestAnimationFrame(h)}return()=>{r.current&&(cancelAnimationFrame(r.current),r.current=null)}},[e,n,o])};class Ya{static isInGivenAreaInCanvas(s,n,o){if(n.x===void 0||n.y===void 0)return!1;let r=!0,a=!0;if(o.xRatio!==void 0){const i=s.x+o.xRatio*s.width;r=n.x>=i}if(o.yRatio!==void 0){const i=s.y+o.yRatio*s.height;a=n.y>=i}return r&&a}static createGridForCanvas(s,n=3){const{width:o,height:r}=s,a=[],i=o/n,c=r/n;for(let l=0;l<=n;l++){const d=[];for(let u=0;u<=n;u++)d.push({x:u*i,y:l*c});a.push(d)}return a}static focusElementAndMoveCursorToEnd(s){if(!s)return;s.hasAttribute("tabindex")||s.setAttribute("tabindex","-1"),s.focus();const n=document.createRange(),o=window.getSelection();if(o)try{n.selectNodeContents(s),n.collapse(!1),o.removeAllRanges(),o.addRange(n)}catch(r){console.error("Failed to set cursor position:",r)}}}He(Ya,"getCanvasCenter",(s,n,o)=>{if(!s)return console.warn("Container not available for center calculation."),{x:0,y:0};if(!n)return console.warn("Offset not available for center calculation."),{x:0,y:0};const{clientWidth:r,clientHeight:a}=s,i=r/2,c=a/2,l=(i-n.x)/o,d=(c-n.y)/o;return{x:l,y:d}});const eo=new js("WriteModeHandlerV2",ks.WriteModeHandlerV2);class cm{constructor(){He(this,"s")}onKeyDown(s){const n=E.getState();this.s=n;const o=this.s.uiState,a=s.target.closest("#CanvasAppV2"),i=this.s.projectCanvas.getActive(),c=i==null?void 0:i.viewState,l=(c==null?void 0:c.offset)??{x:0,y:0},d=(c==null?void 0:c.scale)??1;if(!a||!c)return eo.warn("Canvas or active canvas viewState not available."),!0;if(s.key==="Enter"&&s.ctrlKey){const m=this.s.getEditingNode();if(!m)return!0;this.s.unselectNodeById(m.id);const x={x:m.x,y:m.y+(m.height??30)+30},y=Le.buildTextNode(x,""),v={x:(0-l.x)/d,y:(0-l.y)/d,width:a.clientWidth/d,height:a.clientHeight/d},N=Ya.isInGivenAreaInCanvas(v,y,{yRatio:Z.writeMode.scrollYRatio});return this.addNode(y),N&&setTimeout(()=>{n.scrollToNode(y,Z.writeMode.scrollDuration,{verticalOnly:!0})},50),!0}if(o.nodeToFocusId)return!0;const{mode:g}=o;if(g!==J.WRITE)return!1;const f=s.key,w=s.ctrlKey||s.metaKey;if(f.length===1&&!w&&f!=="Enter"){const m=E.getState(),x=m.uiState.writeModeStartPosition,y=x??Ya.getCanvasCenter(a,l,d),v=Le.buildTextNode(y,"");return this.addNode(v),x&&m.setWriteModeStartPosition(null),eo.log(`WRITE Mode: Key "${f}" pressed. Created node ${v.id} at position (${y.x}, ${y.y}) and requested focus.`),!0}return f==="Escape"?(eo.log("WRITE Mode: Escape pressed. Global handler will switch mode."),!1):(eo.log(`WRITE Mode: Key "${f}" ignored by WriteModeHandler.`),!0)}onKeyUp(s){return!0}addNode(s){s.isEditing=!0,this.s.addNode(s,""),this.s.setNodeToFocusId(s.id)}}class lm{onMouseDown(s){const n=E.getState(),o=n.uiState,{mode:r,addNodeType:a}=o;if(r!==J.ADD)return!1;const i=n.getCanvasMouseCoords();if(!i)return!1;let c=!1;if(a===le.TABLE){const l=Le.buildTableNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.TEXTCARD){const l=Le.buildTextCardNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.WORKFLOW_ORCHESTRATION){const l=Le.buildWorkflowOrchestrationNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.WORKFLOW_SOURCE){const l=Le.buildWorkflowSourceNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.WORKFLOW_DEFINITION){const l=Le.buildWorkflowDefinitionNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.OCR){const l=Le.buildOCRNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.IMAGE){const l=Le.buildImageNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.WORKFLOW_STEP){const l=Le.buildWorkflowStepNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}else if(a===le.VOCABULARY){const l=Le.buildVocabularyNode(i);n.addNode(l),n.setNodeToFocusId(l.id),c=!0}return c?(n.setMode(J.SELECT),n.setAddNodeType(null),s.stopPropagation(),!0):!1}}const dm=()=>{const[e,s]=p.useState(null),n=p.useRef(new cm),o=p.useRef(new Kt),r=p.useRef(new lm),a=Jp(s),i=Qp(),c=eg(s),l=tg(s),d=sg(),u=ng(),h=Qg(),g=ef(),f=lf(),w=df(),m=uf(),x=Rf(),y=Mf(),v=Df(),N=Lf(),b=Ff(),j=zf(),R=Vf(),S=Jf(),C=Qf(),M=nm(),{handleTouchStart:I,handleTouchMove:A,handleTouchEnd:O}=om(),F=E.getState(),B=F.setMode,W=F.setAddNodeType,P=F.uiState,k=Ie.useMemo(()=>({pointer:{onPointerDown:T=>{const L=E.getState().uiState.mode;L===J.DRAW&&T.preventDefault(),!(L===J.ADD&&r.current.onMouseDown(T))&&(a(T),f(T),b(T),S(T),o.current.onMouseDown(T))},onPointerMove:T=>{i(T),w(T),x(T),v(T),j(T),C(T)},onPointerUp:T=>{c(T),m(T),y(T),N(T),R(T),M(T),u(T)},onPointerLeave:l},wheel:d,touch:{onTouchStart:I,onTouchMove:A,onTouchEnd:O},keyboard:{onKeyDown:T=>{n.current.onKeyDown(T),h(T)},onKeyUp:g}}),[a,f,b,S,i,w,x,v,j,C,c,m,y,N,R,M,l,d,I,A,O,h,g,u,B,W,P.mode,P.addNodeType,r]);return Yp(k),im(),Zp(),null},vi=1280,um=({top:e,bottom:s,left:n,right:o,topLeft:r,topRight:a,bottomLeft:i,bottomRight:c,alwaysVisibleBottomLeft:l,footer:d,isContentVisible:u=!0,topMargin:h})=>{const[g,f]=p.useState(()=>typeof window<"u"?window.innerWidth<vs:!1),[w,m]=p.useState(()=>typeof window<"u"?window.innerWidth<vi:!1);p.useEffect(()=>{const C=()=>{f(window.innerWidth<vs),m(window.innerWidth<vi)};return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]);const x=p.useRef(null),[y,v]=p.useState(50);p.useEffect(()=>{if(!x.current)return;const C=new ResizeObserver(M=>{var A;const I=((A=M[0])==null?void 0:A.contentRect.height)??50;v(I)});return C.observe(x.current),()=>C.disconnect()},[]);const N=g?y+8:8,[b,j]=p.useState({top:!1,bottom:!1,left:!1,right:!1,topLeft:!1,topRight:!1,bottomLeft:!1,alwaysVisibleBottomLeft:!1}),R=C=>{j(M=>({...M,[C]:!M[C]}))},S=(C,M,I)=>t.jsx(Q,{variant:"ghost",size:"icon",onClick:()=>R(C),className:`h-11 w-11 bg-background/30 backdrop-blur-sm hover:bg-background/50 transition-colors ${I}`,"data-prevent-canvas-click":!0,"data-ui-panel":!0,title:`Toggle ${C}`,"data-test":"mobile-toggle",children:t.jsx(M,{className:"h-5 w-5 opacity-70"})});return t.jsxs("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:Te.canvasOverlay},"data-ui-panel":"canvas-overlay","data-test":"canvas-overlay-container",children:[e&&t.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{top:h||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top",children:e}),u&&s&&t.jsxs("div",{className:"absolute left-1/2 transform -translate-x-1/2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom",children:[t.jsx("div",{className:"hidden md:block","data-test":"canvas-overlay-bottom-desktop",children:s}),t.jsxs("div",{className:"flex flex-col items-center gap-2 md:hidden","data-test":"canvas-overlay-bottom-mobile",children:[b.bottom&&t.jsx("div",{children:s}),S("bottom",Gr,"")]})]}),u&&n&&t.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-left",children:g?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[S("left",Gr,""),b.left&&t.jsx("div",{children:n})]}):n}),u&&o&&t.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-right",children:g?t.jsxs("div",{className:"flex flex-row items-center gap-2",children:[b.right&&t.jsx("div",{children:o}),S("right",Un,"")]}):o}),u&&r&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{top:h||"1rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-left",children:g?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[S("topLeft",Yo,""),b.topLeft&&t.jsx("div",{children:r})]}):r}),u&&a&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{top:h||"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-right",children:g?t.jsxs("div",{className:"flex flex-col items-end gap-1",children:[S("topRight",jo,""),b.topRight&&t.jsx("div",{children:a})]}):a}),u&&i&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-left",children:g?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[b.bottomLeft&&t.jsx("div",{children:i}),S("bottomLeft",Pn,"")]}):i}),l&&t.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:u&&i?`${N+60}px`:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-always-visible-bottom-left",children:g?t.jsxs("div",{className:"flex flex-col items-start gap-1",children:[b.alwaysVisibleBottomLeft&&t.jsx("div",{children:l}),S("alwaysVisibleBottomLeft",Pn,"")]}):l}),c&&t.jsx("div",{className:"absolute right-2 pointer-events-auto",style:{bottom:`${N}px`},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-right",children:c}),d&&t.jsx("div",{ref:x,className:"absolute left-0 right-0 flex justify-center pointer-events-auto",style:{bottom:g?0:u?be.chatInput.BOTTOM_VISIBLE:be.chatInput.BOTTOM_HIDDEN},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-footer",children:d})]})},hm={offset:{x:0,y:0},scale:1,targetView:null},pm=()=>{var d,u;const e=z(h=>{var g;return((g=h.projectCanvas.getActive())==null?void 0:g.viewState)??hm}),s=z(h=>h.uiState.selectionBox),n=Js(h=>h.mousePosition)??null,o=e.scale??1,r=e.offset??{x:0,y:0},a=h=>{const g=Math.max(.01,Math.min(4,h));E.getState().setActiveCanvasViewState(f=>({...f,scale:g}))},i=h=>{let g;h==="up"?o<.1?g=Math.round((o+.01)*100)/100:g=Math.round((o+.1)*10)/10:o<=.1?g=Math.round((o-.01)*100)/100:g=Math.round((o-.1)*10)/10,a(g)},c=h=>{h.key==="ArrowUp"?(h.preventDefault(),i("up")):h.key==="ArrowDown"&&(h.preventDefault(),i("down"))},l=()=>{E.getState().setActiveCanvasViewState(h=>({...h,offset:{x:0,y:0},scale:1,targetView:null}))};return t.jsxs("div",{className:"text-xs p-1 bg-background/30 backdrop-blur-sm rounded pointer-events-auto",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("label",{className:"opacity-70",children:"Zoom:"}),t.jsx("input",{type:"number",value:o.toFixed(2),onChange:h=>a(parseFloat(h.target.value)||1),onKeyDown:c,min:"0.01",max:"4.0",step:"any",className:"w-16 px-1 py-0.5 text-xs border-0 rounded bg-background/50","data-test":"canvas-debug-zoom-input"}),t.jsx("button",{onClick:l,className:"px-1.5 py-0.5 text-xs border-0 rounded bg-background/50 hover:bg-background/70 transition-colors",title:"Reset view to 0,0","data-test":"canvas-debug-reset-button",children:"Reset"})]}),t.jsxs("div",{children:["Offset: X: ",((d=r==null?void 0:r.x)==null?void 0:d.toFixed(0))??0,", Y: ",((u=r==null?void 0:r.y)==null?void 0:u.toFixed(0))??0]}),t.jsxs("div",{children:["Mouse:"," ",n?`X: ${n.x.toFixed(0)}, Y: ${n.y.toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["M+O:"," ",n&&r?`X: ${(n.x-r.x).toFixed(0)}, Y: ${(n.y-r.y).toFixed(0)}`:"N/A"]}),t.jsxs("div",{children:["SelBox:",s?t.jsxs(t.Fragment,{children:[t.jsx("div",{children:`S:(${s.start.x.toFixed(0)},${s.start.y.toFixed(0)})`}),t.jsx("div",{children:` E:(${s.end.x.toFixed(0)},${s.end.y.toFixed(0)})`})]}):"N/A"]})]})},Je=e=>{const{className:s,mainAction:n,dropdownActions:o=[],dropdownColumns:r,variant:a,size:i,dropdownMenuClassName:c,dropdownTriggerButtonId:l="options-menu-button",dropdownPosition:d="bottom",dropdownHorizontalAlign:u="container-right",persistenceKey:h,isOpen:g,onOpenChange:f,dropdownVerticalOffset:w=0,restoreRepeatAction:m,facade:x,...y}=e,v=r&&r.length>0,N=v?r.flatMap(U=>U.actions):o,[b,j]=p.useState(!1),R=g!==void 0,S=R?g:b,C=U=>{const q=typeof U=="function"?U(S):U;R||j(q),f==null||f(q)},M=p.useRef(null),I=p.useRef(null),[A,O]=p.useState(u),[F,B]=p.useState(d),[W,P]=p.useState(!1),[k,T]=p.useState({top:0,left:0}),L=()=>h?E.getState().getSegmentedButtonAction(h):null,[H,$]=p.useState(L),[_,G]=p.useState(null),V=p.useRef(null),D=p.useRef(!1);p.useEffect(()=>{var ne,oe,fe;if(D.current||!h)return;const U=E.getState().getSegmentedButtonAction(h),se=(((oe=(ne=E.getState().actions)==null?void 0:ne.history)==null?void 0:oe.entries)??[]).filter(he=>he.source===h);for(const he of se){const de=N.find(pe=>pe.label===he.label&&pe.onClick);if(de){E.getState().setSegmentedButtonAction(h,he.label,()=>de.onClick,{skipHistoryUpdate:!0});continue}if(x){const pe=x.getActions();let ae=!1;const re=pe.find(me=>me.label===he.label);if(re&&(E.getState().setSegmentedButtonAction(h,he.label,()=>()=>x.execute(re.id),{skipHistoryUpdate:!0,actionId:re.id}),ae=!0),!ae)for(const me of pe){const Ne=(fe=me.subActions)==null?void 0:fe.find(xe=>xe.title===he.label);if(Ne){E.getState().setSegmentedButtonAction(h,he.label,()=>()=>x.execute(Ne.id),{skipHistoryUpdate:!0,actionId:Ne.id}),ae=!0;break}}if(ae)continue}if(m){const pe=m(he.label);pe&&E.getState().setSegmentedButtonAction(h,he.label,()=>pe,{skipHistoryUpdate:!0})}}if(U){const he=N.find(de=>de.label===U&&de.onClick);if(he)V.current=he.onClick,$(U);else if(m){const de=m(U);de&&(G({label:U,execute:de}),$(null),V.current=de,E.getState().setSegmentedButtonAction(h,U,()=>V.current,{skipHistoryUpdate:!0}))}}D.current=!0},[h,m,N]);const Y=U=>{U.stopPropagation(),C(q=>(q||P(!1),!q))},te=U=>{var ne;if(!x)return;const q=x.getActions(),se=q.find(oe=>oe.label===U);if(se)return se.id;for(const oe of q){const fe=(ne=oe.subActions)==null?void 0:ne.find(he=>he.title===U);if(fe)return fe.id}},ie=()=>{if(_){if(_.execute(),h){const U=te(_.label);E.getState().setSegmentedButtonAction(h,_.label,()=>V.current,{actionId:U})}return}if(H){const U=N.find(q=>q.label===H);if(U&&!U.disabled&&U.onClick){if(U.onClick(),V.current=U.onClick,h){const q=te(H);E.getState().setSegmentedButtonAction(h,H,()=>V.current,{actionId:q})}}else n.onClick()}else n.onClick()},we=(U,q)=>{if(U(),$(q),G(null),V.current=U,h){const se=te(q);E.getState().setSegmentedButtonAction(h,q,()=>V.current,{actionId:se})}C(!1)},X={registerRepeatAction:(U,q)=>{if(G({label:U,execute:q}),$(null),V.current=q,h){const se=te(U);E.getState().setSegmentedButtonAction(h,U,()=>V.current,{actionId:se})}C(!1)},closeDropdown:()=>C(!1)};p.useEffect(()=>{if(S&&M.current){const U=M.current.getBoundingClientRect(),q=window.innerWidth,se=window.innerHeight,ne=16,oe=224,fe=200;let he=0,de=0;d==="top"?he=U.top-fe-8+w:he=U.bottom+4+w,u==="container-right"?de=U.right-oe:(u==="container-edge-right"||u==="middle-right")&&(de=U.right,u==="middle-right"&&(de-=oe/2)),de+oe>q-ne?(de=q-ne-oe,O("container-right")):de<ne?(de=ne,O("container-edge-right")):O(u),he+fe>se-ne?(he=U.top-fe-8,B("top")):he<ne?(he=U.bottom+4,B("bottom")):B(d),T({top:he,left:de}),P(!0)}},[S,u,d,w]);const ce=p.useRef(!1);p.useEffect(()=>{const U=se=>{var oe,fe;const ne=se.target;ce.current||(oe=M.current)!=null&&oe.contains(ne)||(fe=I.current)!=null&&fe.contains(ne)||ne.closest("[data-radix-popper-content-wrapper]")||ne.closest("[data-radix-select-viewport]")||ne.closest('[role="listbox"]')||ne.closest('[data-test="draggable-popover-wrapper"]')||ne.closest("[data-radix-select-trigger]")||ne.closest('[role="combobox"]')||C(!1)},q=new MutationObserver(se=>{for(const ne of se)if(ne.type==="childList"){const oe=Array.from(ne.addedNodes),fe=Array.from(ne.removedNodes);oe.some(he=>he instanceof HTMLElement&&he.hasAttribute("data-radix-popper-content-wrapper"))&&(ce.current=!0),fe.some(he=>he instanceof HTMLElement&&he.hasAttribute("data-radix-popper-content-wrapper"))&&setTimeout(()=>{ce.current=!1},100)}});return S&&(document.addEventListener("pointerdown",U,!0),q.observe(document.body,{childList:!0})),()=>{document.removeEventListener("pointerdown",U,!0),q.disconnect()}},[S]);const ue=N&&N.length>0;let ee=n.text||n.label;if(n.disabled&&n.disabledTooltip)ee=n.disabledTooltip;else if(_)ee=_.label;else if(H){const U=N.find(q=>q.label===H);U&&(ee=U.label)}const K=U=>{const q=U.target;q.closest("[data-radix-select-trigger]")||q.closest('[role="combobox"]')||U.stopPropagation()};return t.jsxs("div",{id:"UiSegmentedButton",ref:M,"data-prevent-canvas-click":!0,className:ve("ui-segmented-button","relative inline-flex items-stretch",s),...y,children:[t.jsx(Zt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"main-action-tooltip-wrapper",children:t.jsxs(Q,{variant:a,size:i,onClick:U=>{U.stopPropagation(),ie()},"aria-label":n.label,disabled:n.disabled,className:ve("ui-segmented-button__main-action",{"rounded-r-none":ue,"border-r-0":ue&&a==="outline","focus:z-10":ue,"!opacity-40":n.disabled}),children:[n.icon,n.text&&t.jsx("span",{children:n.text})]})})}),t.jsx(Bt,{children:t.jsx("p",{children:ee})})]})}),ue&&t.jsxs(t.Fragment,{children:[t.jsx(Q,{id:l,variant:a,size:i,onClick:Y,"aria-haspopup":"true","aria-expanded":S,"aria-label":"Toggle dropdown options",disabled:n.disabled||!N.some(U=>!U.disabled),className:ve("ui-segmented-button__dropdown-trigger","rounded-l-none",i!=="icon"&&"px-1",{"focus:z-10":ue}),children:t.jsx(Ct,{className:"ui-segmented-button__caret-icon w-1.5 h-2.5"})}),S&&sn.createPortal(t.jsx("div",{ref:I,onPointerDown:K,onPointerUp:K,onClick:K,className:ve("ui-segmented-button__dropdown-menu","fixed rounded-md shadow-lg",v?"w-auto":"w-56","bg-popover text-popover-foreground border","transition-opacity duration-75",{"opacity-0 pointer-events-none":!W,"opacity-100":W},c),style:{zIndex:Te.toolbarDropdown,top:k.top,left:k.left},role:"menu","aria-orientation":"vertical","aria-labelledby":l,"data-test":"segmented-button-dropdown-portal",children:v?t.jsx("div",{className:"grid gap-2 p-2",style:{gridTemplateColumns:r.some(U=>U.width)?r.map(U=>U.width||"1fr").join(" "):`repeat(${r.length}, 1fr)`},role:"none","data-test":"segmented-button-multi-column",children:r.map((U,q)=>t.jsxs("div",{className:"flex flex-col gap-1","data-test":"segmented-button-column",children:[U.header&&t.jsx("span",{className:"text-xs font-medium text-muted-foreground px-1",children:U.header}),U.actions.map((se,ne)=>se.customRender?t.jsx("div",{children:se.customRender(X)},ne):t.jsxs(Q,{variant:"ghost",size:"sm",onClick:()=>we(se.onClick,se.label),disabled:se.disabled,className:"h-7 px-2 justify-start",role:"menuitem",title:se.label,"data-test":"segmented-button-action",children:[se.icon&&t.jsx("span",{className:"mr-1",children:se.icon}),t.jsx("span",{className:"text-xs",children:se.label}),se.selected&&t.jsx(Ys,{className:"ml-auto h-3 w-3"})]},ne))]},q))}):t.jsx("div",{className:"py-1",role:"none",children:o.map((U,q)=>U.customRender?t.jsx("div",{children:U.customRender(X)},q):t.jsxs(Q,{variant:"ghost",size:"sm",onClick:()=>we(U.onClick,U.label),disabled:U.disabled,className:ve("ui-segmented-button__dropdown-item","w-full justify-start text-left font-normal"),role:"menuitem",children:[U.icon&&t.jsx("span",{className:"mr-2",children:U.icon})," ",U.label,U.selected&&t.jsx(Ys,{className:"ml-auto h-4 w-4"})]},q))})}),document.body)]})]})},gm={1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8},fm=e=>{const{className:s,variant:n}=e,o=E.getState(),r=o.setMode,a=o.setAddNodeType,i=o.setSelectionBox,c=z(S=>S.uiState.customNodeDropdownOpen??!1),l=S=>{E.getState().setCustomNodeDropdownOpen(S)},d=()=>{r(J.ADD),a(le.TABLE),i(null)},u=()=>{r(J.ADD),a(le.TEXTCARD),i(null)},h=()=>{r(J.ADD),a(le.WORKFLOW_ORCHESTRATION),i(null)},g=()=>{r(J.ADD),a(le.WORKFLOW_SOURCE),i(null)},f=()=>{r(J.ADD),a(le.WORKFLOW_DEFINITION),i(null)},w=()=>{r(J.ADD),a(le.OCR),i(null)},m=()=>{r(J.ADD),a(le.IMAGE),i(null)},x=()=>{r(J.ADD),a(le.WORKFLOW_STEP),i(null)},y=()=>{r(J.ADD),a(le.VOCABULARY),i(null)},v=[{label:"1: Table",icon:t.jsx(eh,{className:"h-2.5 w-2.5"}),onClick:d},{label:"2: Text Card",icon:t.jsx(th,{className:"h-2.5 w-2.5"}),onClick:u},{label:"3: Image",icon:t.jsx(sh,{className:"h-2.5 w-2.5"}),onClick:m},{label:"4: OCR",icon:t.jsx(uo,{className:"h-2.5 w-2.5"}),onClick:w},{label:"5: Vocabulary",icon:t.jsx(Ko,{className:"h-2.5 w-2.5"}),onClick:y},{label:"6: Workflow",icon:t.jsx(Cs,{className:"h-2.5 w-2.5"}),onClick:h},{label:"7: Source",icon:t.jsx(el,{className:"h-2.5 w-2.5"}),onClick:g},{label:"8: WF Runner",icon:t.jsx(ot,{className:"h-2.5 w-2.5"}),onClick:f},{label:"9: WF Step",icon:t.jsx(nh,{className:"h-2.5 w-2.5"}),onClick:x}],[N,b]=p.useState(v[0]),j=S=>{b(S),S.onClick(),l(!1)},R=()=>{N.onClick()};return p.useEffect(()=>{if(!c)return;const S=C=>{const M=gm[C.key];M!==void 0&&M<v.length?(C.preventDefault(),j(v[M])):C.key==="Escape"&&l(!1)};return window.addEventListener("keydown",S),()=>window.removeEventListener("keydown",S)},[c,v]),t.jsx("div",{id:"ToolbarAddCustomNode",className:je("",s),"data-test":"toolbar-add-custom-node-button",children:t.jsx(Je,{size:"sm",variant:n??"default",mainAction:{icon:N.icon,onClick:R,text:"(n)",label:`Add ${N.label}`},dropdownActions:v.map(S=>({...S,onClick:()=>j(S)})),dropdownPosition:"top",dropdownHorizontalAlign:"middle-right",dropdownVerticalOffset:-30,isOpen:c,onOpenChange:l})})},mm=()=>{const e=z(h=>h.uiState.mode),s=z(h=>h.uiState.addNodeType),n=z(h=>h.uiState.writeSubMode),o=e===J.ADD&&s===le.TEXT,r=e===J.WRITE,a=r&&n===Us.AUDIO,i=()=>{const h=E.getState();r?h.toggleWriteSubMode():o?(h.setMode(J.WRITE),h.setWriteSubMode(Us.WRITE)):(h.setMode(J.ADD),h.setAddNodeType(le.TEXT))},c=o||r,l=()=>a?t.jsx(oh,{className:"h-4 w-4"}):r?t.jsx(ah,{className:"h-4 w-4"}):t.jsx(Ms,{className:"h-4 w-4"}),d=()=>a?"Audio Mode (click to toggle)":r?"Write Mode (click for audio)":o?"Text Mode (click for write, or w/a)":"Text (t)",u=()=>a?"(a)":r?"(w)":"(T)";return t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-text-mode-wrapper",children:[t.jsxs(Q,{variant:c?"default":"secondary",size:"sm",className:je(a&&"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 text-white"),onClick:i,title:d(),"data-test":"canvas-toolbar-text-mode-button",children:[l(),t.jsx("span",{className:"hidden md:inline ml-1",children:u()})]}),t.jsx(Zt,{children:t.jsxs(Wt,{delayDuration:200,children:[t.jsx(Ht,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-text-mode-info-icon",children:t.jsx(jo,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Bt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-text-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-text-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Text Mode (t):"})," Click to add text nodes"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Write Mode (t→w):"})," Create nodes with Ctrl+Enter"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Audio Mode (t→a):"})," Auto-starts voice recording"]}),t.jsx("p",{className:"text-muted-foreground",children:"Click button to cycle through modes"})]})})]})})]})};class xm{constructor(){He(this,"currentNodeId",null);He(this,"nodes",[]);He(this,"yBandThreshold",100)}setNodes(s){this.nodes=s}setCurrentNode(s){this.currentNodeId=s}getCurrentNodeId(){return this.currentNodeId}getCurrentNode(){return this.currentNodeId?this.nodes.find(s=>s.id===this.currentNodeId)??null:null}getSortedNodes(){return[...this.nodes].sort((s,n)=>s.x!==n.x?s.x-n.x:s.y-n.y)}getCurrentIndex(){return this.getSortedNodes().findIndex(n=>n.id===this.currentNodeId)}getNodesInSameRow(s){return this.nodes.filter(n=>Math.abs(n.y-s.y)<=this.yBandThreshold)}moveLeft(){const s=this.getCurrentIndex();return s<=0?null:this.getSortedNodes()[s-1]??null}moveRight(){const s=this.getCurrentIndex(),n=this.getSortedNodes();return s<0||s>=n.length-1?null:n[s+1]??null}moveUp(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y<s.y-this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?r.y-o.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveDown(){const s=this.getCurrentNode();if(!s)return null;const n=this.nodes.filter(o=>o.y>s.y+this.yBandThreshold);return n.length===0?null:(n.sort((o,r)=>o.y!==r.y?o.y-r.y:Math.abs(o.x-s.x)-Math.abs(r.x-s.x)),n[0]??null)}moveToLineStart(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>o.x-r.x),n[0]??null)}moveToLineEnd(){const s=this.getCurrentNode();if(!s)return null;const n=this.getNodesInSameRow(s);return n.length===0?null:(n.sort((o,r)=>r.x-o.x),n[0]??null)}moveToDocumentStart(){return this.getSortedNodes()[0]??null}moveToDocumentEnd(){const s=this.getSortedNodes();return s[s.length-1]??null}moveNext(){return this.moveRight()}movePrev(){return this.moveLeft()}}const Xe=new xm;function wm(e){const s=E.getState();s.setSelectedNodes([e]),Xe.setCurrentNode(e.id),s.scrollToNode(e.id,300)}function Et(e,s){const n=e();return n?(wm(n),!0):!1}let xo=null;function bi(e){xo=e}function Ni(){return E.getState().setMode(J.SELECT),xo==null||xo.popIdIf(Lt.canvasVim),!0}function ym(e){const s=E.getState(),n=s.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.selectedNodes)??[];return o.length>0&&s.setNodeToFocusId(o[0].id),e==null||e.executeCommand(st.enterInsertMode,""),!0}function vm(e){return E.getState().setNodeToFocusId(null),e==null||e.executeCommand(st.enterNormalMode,""),!0}const bm=[{key:"i",command:st.enterInsertMode,desc:"Enter insert mode - edit selected node",execute:(e,s,n)=>ym(n),preventUndoRedo:!0},{key:"h",command:st.cursorLeft,desc:"Move to previous node (left in spatial order)",execute:()=>Et(()=>Xe.moveLeft()),preventUndoRedo:!0},{key:"l",command:st.cursorRight,desc:"Move to next node (right in spatial order)",execute:()=>Et(()=>Xe.moveRight()),preventUndoRedo:!0},{key:"k",command:st.cursorUp,desc:"Move to node above",execute:()=>Et(()=>Xe.moveUp()),preventUndoRedo:!0},{key:"j",command:st.cursorDown,desc:"Move to node below",execute:()=>Et(()=>Xe.moveDown()),preventUndoRedo:!0},{key:"0",command:st.cursorLineStart,desc:"Move to first node in row",execute:()=>Et(()=>Xe.moveToLineStart()),preventUndoRedo:!0},{key:"$",command:st.cursorLineEnd,desc:"Move to last node in row",execute:()=>Et(()=>Xe.moveToLineEnd()),preventUndoRedo:!0},{key:"<Shift>$",command:st.cursorLineEnd,desc:"Move to last node in row",execute:()=>Et(()=>Xe.moveToLineEnd()),preventUndoRedo:!0},{key:"gg",command:st.goToFirstLine,desc:"Move to first node",execute:()=>Et(()=>Xe.moveToDocumentStart()),preventUndoRedo:!0},{key:"<Shift>G",command:st.goToLastLine,desc:"Move to last node",execute:()=>Et(()=>Xe.moveToDocumentEnd()),preventUndoRedo:!0},{key:"G",command:st.goToLastLine,desc:"Move to last node",execute:()=>Et(()=>Xe.moveToDocumentEnd()),preventUndoRedo:!0},{key:"w",command:st.cursorWordForwardStart,desc:"Move to next node",execute:()=>Et(()=>Xe.moveNext()),preventUndoRedo:!0},{key:"b",command:st.cursorBackwordsStartWord,desc:"Move to previous node",execute:()=>Et(()=>Xe.movePrev()),preventUndoRedo:!0},{key:"q",command:st.enterNormalMode,desc:"Exit vim mode",execute:()=>Ni(),preventUndoRedo:!0},{key:"<Escape>",command:st.enterNormalMode,desc:"Exit vim mode",execute:()=>Ni(),preventUndoRedo:!0}],Nm=[{key:"<Escape>",command:st.enterNormalMode,desc:"Exit insert mode - return to normal mode",execute:(e,s,n)=>vm(n),preventUndoRedo:!0}];function Sm(){return{[Nn.NORMAL]:bm,[Nn.INSERT]:Nm,[Nn.VISUAL]:[],[Nn.ALL]:[]}}function Os(e){var c,l;const s=((c=e.state)==null?void 0:c.activeProjectId)??null,n=s?((l=e.state)==null?void 0:l.projects[s])??null:null,o=(n==null?void 0:n.activeWorkspaceId)??null,r=o?(n==null?void 0:n.workspaces[o])??null:null,a=(r==null?void 0:r.activeCanvasId)??null,i=a?(r==null?void 0:r.canvases[a])??null:null;return{project:n,workspace:r,canvas:i,path:{projectId:s,workspaceId:o,canvasId:a}}}const Si=[],Ci=[],Oe={selectMode:e=>e.uiState.mode,selectIsSelectMode:e=>e.uiState.mode===J.SELECT,selectIsMoveMode:e=>e.uiState.mode===J.MOVE,selectIsDrawArrowMode:e=>e.uiState.mode===J.DRAW_ARROW,selectIsAddTextMode:e=>e.uiState.mode===J.ADD,selectIsAddTableMode:e=>e.uiState.mode===J.ADD,selectIsWriteMode:e=>e.uiState.mode===J.WRITE,selectActiveCanvas:e=>{const{canvas:s}=Os(e);return s},selectActiveCanvasId:e=>{const{path:s}=Os(e);return s.canvasId},selectActiveProjectId:e=>{var s;return((s=e.state)==null?void 0:s.activeProjectId)??null},selectActiveWorkspaceId:e=>{const{path:s}=Os(e);return s.workspaceId},selectAllNodes:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.coreState.nodes)??Si},selectNode:e=>s=>Oe.selectAllNodes(s).find(o=>o.id===e)??null,selectSelectedNodes:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedNodes)??Si},selectIsNodeSelected:e=>s=>Oe.selectSelectedNodes(s).some(o=>o.id===e),selectAllArrows:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.coreState.arrows)??Ci},selectArrow:e=>s=>Oe.selectAllArrows(s).find(o=>o.id===e)??null,selectSelectedArrows:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.coreState.selectedArrows)??Ci},selectIsArrowSelected:e=>s=>Oe.selectSelectedArrows(s).some(o=>o.id===e),selectArrowsConnectedToNode:e=>s=>Oe.selectAllArrows(s).filter(o=>o.startNodeId===e||o.endNodeId===e),selectCanvasOffset:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.viewState.offset)??{x:0,y:0}},selectCanvasScale:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.viewState.scale)??1},selectCanvasDimensions:e=>({width:e.uiState.canvasWidth??0,height:e.uiState.canvasHeight??0}),selectViewState:e=>{const s=Oe.selectActiveCanvas(e);return(s==null?void 0:s.viewState)??null},selectTemporaryArrow:e=>e.uiState.temporaryArrow,selectSelectionBox:e=>e.uiState.selectionBox,selectDragInfo:e=>e.uiState.dragInfo,selectResizingNode:e=>e.uiState.resizingNode,selectAddNodeType:e=>e.uiState.addNodeType,selectIsDragging:e=>e.uiState.dragInfo!==null,selectIsResizing:e=>e.uiState.resizingNode!==null,selectIsSelectionBoxActive:e=>e.uiState.selectionBox!==null,selectIsDrawingArrow:e=>e.uiState.temporaryArrow!==null,selectHasSelectedNodes:e=>Oe.selectSelectedNodes(e).length>0,selectHasSelectedArrows:e=>Oe.selectSelectedArrows(e).length>0,selectNodeCount:e=>Oe.selectAllNodes(e).length,selectArrowCount:e=>Oe.selectAllArrows(e).length,selectSelectedNodeCount:e=>Oe.selectSelectedNodes(e).length,selectSelectedArrowCount:e=>Oe.selectSelectedArrows(e).length,selectHasContent:e=>{const s=Oe.selectNodeCount(e),n=Oe.selectArrowCount(e);return s>0||n>0},selectIsCanvasEmpty:e=>!Oe.selectHasContent(e),selectCanvasStats:e=>({nodeCount:Oe.selectNodeCount(e),arrowCount:Oe.selectArrowCount(e),selectedNodeCount:Oe.selectSelectedNodeCount(e),selectedArrowCount:Oe.selectSelectedArrowCount(e),hasContent:Oe.selectHasContent(e)}),selectAllProjects:e=>{var s;return((s=e.state)==null?void 0:s.projects)??{}},selectActiveProject:e=>{const{project:s}=Os(e);return s},selectActiveWorkspace:e=>{const{workspace:s}=Os(e);return s}};let ji=!1;function Cm(){const e=window.__vimContainer;if(e)return e;const s=mp.createContainer();return fp.register(s),Ku.register(s),Xu.register(s),qu.register(s),Zu.register(s),Ju.register(s),window.__vimContainer=s,s}function jm(e){if(ji)return;const s=e.get(Qu),n=Sm();s.registerCommands(Lt.canvasVim,n),ji=!0}function ki(e){if(e.getInstanceMap(Lt.canvasVim))return;const n={id:Lt.canvasVim,mode:Nn.NORMAL,cursor:{line:0,col:0},lines:[]};e.registerAndInit({vimId:Lt.canvasVim,vimState:n})}function km(){const[e,s]=p.useState(!1),n=p.useRef(null),o=p.useRef(null),r=z(Oe.selectAllNodes),a=z(Oe.selectSelectedNodes),i=z(d=>d.uiState.mode);p.useEffect(()=>{const d=Cm();return n.current=d.get(Qc),jm(d),bi(n.current),()=>{bi(null)}},[]),p.useEffect(()=>{Xe.setNodes(r)},[r]),p.useEffect(()=>{var u;const d=((u=a[0])==null?void 0:u.id)??null;Xe.setCurrentNode(d)},[a]),p.useEffect(()=>{const d=n.current;if(!d)return;const u=i===J.VIM;if(u&&!e){ki(d),d.setActiveId(Lt.canvasVim);const h=E.getState();h.setNodeToFocusId(null);const g=h.getEditingNode();g&&h.updateNode(g.id,{isEditing:!1});const f=d.getVimCore(Lt.canvasVim);if(f&&f.executeCommand(st.enterNormalMode,""),a.length===0&&r.length>0){const w=o.current,m=w?r.find(x=>x.id===w):null;if(m)E.getState().setSelectedNodes([m]),Xe.setCurrentNode(m.id),E.getState().scrollToNode(m.id,Z.writeMode.scrollDuration);else{const x=Xe.moveToDocumentStart();x&&(E.getState().setSelectedNodes([x]),Xe.setCurrentNode(x.id))}}s(!0)}else!u&&e&&(a.length>0&&(o.current=a[0].id),d.popIdIf(Lt.canvasVim),s(!1))},[i,e,r,a]);const c=p.useCallback(d=>{const u=n.current;if(u){if(d){if(ki(u),u.setActiveId(Lt.canvasVim),a.length===0&&r.length>0){const h=Xe.moveToDocumentStart();h&&(E.getState().setSelectedNodes([h]),Xe.setCurrentNode(h.id))}}else u.popIdIf(Lt.canvasVim);s(d)}},[r,a]),l=p.useCallback(()=>{c(!e)},[e,c]);return{vimEnabled:e,setVimEnabled:c,toggleVimMode:l}}const Ho=({onSelect:e})=>{const s=z(c=>{var l;return(l=c.undo.getCurrent())==null?void 0:l.id}),{undoPath:n,redoPath:o}=p.useMemo(()=>{const c=E.getState();return{undoPath:c.undo.getPath(),redoPath:c.undo.getRedoPath()}},[s]),r=p.useMemo(()=>{const c=[...o].reverse(),l=[...n].reverse();return[...c,...l]},[n,o]);if(r.length===0)return t.jsx("div",{className:"p-3 text-sm text-muted-foreground","data-test":"unified-history-empty",children:"No history available"});const a=c=>new Date(c).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),i=o.length;return t.jsx("div",{className:"flex flex-col h-full overflow-y-auto","data-test":"unified-history-list",children:r.map((c,l)=>{const d=l<i,u=c.id===s;return t.jsxs("button",{type:"button",onClick:()=>e(c.id),className:je("flex items-center gap-2 px-3 py-2 text-left transition-colors border-b border-border last:border-b-0",u&&"bg-accent/50",d&&"opacity-50",!d&&"hover:bg-accent",d&&"hover:bg-accent/30"),"data-test":"unified-history-item","data-redo":d,"data-current":u,children:[t.jsx("span",{className:"text-xs text-muted-foreground w-16 shrink-0",children:a(c.timestamp)}),t.jsx("span",{className:"text-sm truncate flex-1",children:c.label??Jd(c.operation)}),u&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"●"})]},c.id)})})},Bo=({size:e="icon"})=>{const s=()=>{window.confirm("Clear all undo/redo history? This cannot be undone.")&&E.getState().undo.clear()};return t.jsx(Q,{variant:"ghost",size:e,onClick:s,title:"Clear history",className:"h-6 w-6 p-0","data-test":"clear-history-button",children:t.jsx(yt,{className:"h-3.5 w-3.5 text-muted-foreground hover:text-destructive"})})},Fo=({size:e="icon"})=>{const s=()=>{const n=E.getState().undo.getPath();n.length>0&&E.getState().undo.jumpTo(n[0].id)};return t.jsx(Q,{variant:"ghost",size:e,onClick:s,title:"Jump to start",className:"h-6 w-6 p-0","data-test":"jump-to-start-button",children:t.jsx(rh,{className:"h-3.5 w-3.5 text-muted-foreground"})})},$o=({size:e="icon"})=>{const s=()=>{const n=E.getState().undo.getRedoPath();n.length>0&&E.getState().undo.jumpTo(n[n.length-1].id)};return t.jsx(Q,{variant:"ghost",size:e,onClick:s,title:"Jump to end",className:"h-6 w-6 p-0","data-test":"jump-to-end-button",children:t.jsx(ih,{className:"h-3.5 w-3.5 text-muted-foreground"})})},Am=e=>{const{className:s,style:n}=e;Vn();const o=z(y=>y.uiState.mode),r=z(y=>y.uiState.addNodeType),a=z(y=>y.uiState.zoomSubMode),i=z(y=>y.uiState.arrowSubMode),c=z(y=>y.undo.canUndo()),l=z(y=>y.undo.canRedo()),{setVimEnabled:d}=km(),u=E.getState(),h=u.setMode,g=u.setZoomSubMode,f=u.saveCanvasData,w=()=>{E.getState().undo.undo()},m=()=>{E.getState().undo.redo()},x=y=>{o===J.VIM&&y!==J.VIM&&d(!1),y===J.VIM&&d(!0),h(y)};return t.jsxs("div",{className:je("p-2 bg-background border shadow pointer-events-auto rounded flex items-center","max-md:flex-wrap max-md:gap-2 max-md:w-full max-md:max-w-lg md:space-x-2",s),style:{...n},onMouseDown:y=>y.stopPropagation(),"data-ui-panel":"canvas-toolbar",children:[t.jsxs(Q,{variant:o===J.SELECT?"default":"secondary",size:"sm",onClick:()=>x(J.SELECT),title:"Select (v)","data-test":"canvas-toolbar-select-mode-button",children:[t.jsx(tl,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(v)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-move-mode-wrapper",children:[t.jsxs(Q,{variant:o===J.MOVE||o===J.ZOOM?"default":"secondary",size:"sm",className:je(o===J.ZOOM&&a==="zoom:lock"&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{o===J.MOVE?(x(J.ZOOM),g("zoom")):o===J.ZOOM?(document.pointerLockElement&&document.exitPointerLock(),x(J.MOVE)):x(J.MOVE)},title:o===J.ZOOM&&a==="zoom:lock"?"Zoom:Lock Mode (click or Esc to exit)":o===J.ZOOM?"Zoom Mode (h to toggle Pan)":"Pan Mode (h to toggle Zoom)","data-test":"canvas-toolbar-move-mode-button",children:[o===J.ZOOM?t.jsx(ch,{className:"h-4 w-4"}):t.jsx(lh,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(h)"})]}),t.jsx(Zt,{children:t.jsxs(Wt,{delayDuration:200,children:[t.jsx(Ht,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-move-mode-info-icon",children:t.jsx(jo,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Bt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-move-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-move-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Pan Mode (h):"})," Drag to pan the canvas"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom Mode (h again):"})," Scroll or drag to zoom"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Zoom:Lock:"})," Double-click canvas to lock zoom, move mouse to zoom"]}),t.jsx("p",{className:"text-muted-foreground",children:"Press 'h' to toggle between Pan and Zoom"})]})})]})})]}),t.jsxs(Q,{variant:o===J.GRID?"default":"secondary",size:"sm",onClick:()=>x(J.GRID),title:"Grid Mode (g)","data-test":"canvas-toolbar-grid-mode-button",children:[t.jsx(dh,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(g)"})]}),t.jsxs("div",{className:"relative","data-test":"canvas-toolbar-vim-mode-wrapper",children:[t.jsxs(Q,{variant:o===J.VIM?"default":"secondary",size:"sm",onClick:()=>x(J.VIM),title:"Vim Navigation Mode (i)","data-test":"canvas-toolbar-vim-mode-button",children:[t.jsx("span",{className:"text-sm font-bold","data-test":"vim-mode-icon",children:"V"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(i)"})]}),t.jsx(Zt,{children:t.jsxs(Wt,{delayDuration:200,children:[t.jsx(Ht,{asChild:!0,children:t.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-vim-mode-info-icon",children:t.jsx(jo,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),t.jsx(Bt,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-vim-mode-info-tooltip",children:t.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-vim-mode-info-content",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Vim Mode:"})," Navigate nodes with vim keybindings"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"h/l:"})," Previous/next node (X-first order)"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"j/k:"})," Node below/above"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"0/$:"})," First/last node in row"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"gg/G:"})," First/last node"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"w/b:"})," Next/previous node"]})]})})]})})]}),t.jsxs(Q,{variant:o===J.DRAW_ARROW?"default":"secondary",size:"sm",className:je(o===J.DRAW_ARROW&&i===Mn.STAY&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>x(J.DRAW_ARROW),title:o===J.DRAW_ARROW&&i===Mn.STAY?"Draw Arrow: Stay Mode (a to toggle, Esc to exit)":"Draw Arrow (a)","data-test":"canvas-toolbar-draw-arrow-button",children:[t.jsx(_t,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(a)"})]}),t.jsxs(Q,{variant:o===J.DRAW?"default":"secondary",size:"sm",onClick:()=>x(J.DRAW),title:"Draw Mode (d) - Freehand, Rectangle, Circle, Line","data-test":"canvas-toolbar-draw-mode-button",children:[t.jsx(Ks,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(d)"})]}),t.jsxs(Q,{variant:o===J.ADD&&r===le.CHAT?"default":"secondary",size:"sm",onClick:()=>{x(J.ADD),u.setAddNodeType(le.CHAT)},title:"Message Mode (m) - Add chat node","data-test":"canvas-toolbar-message-mode-button",children:[t.jsx(ir,{className:"h-4 w-4"}),t.jsx("span",{className:"hidden md:inline ml-1",children:"(m)"})]}),t.jsx(mm,{}),t.jsx(fm,{variant:o===J.ADD&&(r===le.TABLE||r===le.TEXTCARD||r===le.OCR||r===le.VOCABULARY||r===le.WORKFLOW_ORCHESTRATION||r===le.WORKFLOW_SOURCE||r===le.WORKFLOW_DEFINITION)?"default":"secondary"}),t.jsx(_n,{expandContent:t.jsx(Ho,{onSelect:y=>E.getState().undo.jumpTo(y)}),expandTitle:"History",onClick:w,onHoldRepeat:w,holdRepeatInterval:Z.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!c,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"canvas-toolbar-undo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(cr,{className:"h-4 w-4"})}),t.jsx(_n,{expandContent:t.jsx(Ho,{onSelect:y=>E.getState().undo.jumpTo(y)}),expandTitle:"History",onClick:m,onHoldRepeat:m,holdRepeatInterval:Z.history.holdRepeatIntervalMs,variant:"secondary",size:"sm",disabled:!l,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"canvas-toolbar-redo-button",popoverSize:{width:280,height:250},expandDirection:"up",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(sl,{className:"h-4 w-4"})}),t.jsx(Q,{variant:"secondary",size:"sm",onClick:f,title:"Save to Local Storage and API","data-test":"canvas-toolbar-save-button",children:t.jsx(Jt,{className:"h-4 w-4"})})]})},Im=({startX:e,startY:s,endX:n,endY:o})=>{const r=Math.min(e,n),a=Math.min(s,o),i=Math.abs(e-n),c=Math.abs(s-o);return i===0||c===0?null:t.jsx("div",{className:"absolute border border-ring bg-ring/20 pointer-events-none",style:{left:`${r}px`,top:`${a}px`,width:`${i}px`,height:`${c}px`,zIndex:20}})},Tm=Ie.memo(Im),Em=()=>{const e=z(s=>s.uiState.selectionBox);return e?t.jsx(Tm,{startX:e.start.x,startY:e.start.y,endX:e.end.x,endY:e.end.y}):null},Rm=({node:e})=>t.jsxs("div",{className:je("bg-background border border-foreground p-2",e.className),style:{width:e.width?`${e.width}px`:"100px",height:e.height?`${e.height}px`:"50px",whiteSpace:"pre-line"},children:[e.content||"Rect"," "]});class Mm{createHighlight(s,n,o){return{id:n??De(),start:s.start,end:s.end,color:s.color,createdAt:o??Date.now()}}validateHighlight(s,n){return s.start<0?{valid:!1,error:"Highlight start cannot be negative"}:s.end>n?{valid:!1,error:`Highlight end (${s.end}) exceeds text length (${n})`}:s.start>=s.end?{valid:!1,error:"Highlight start must be less than end"}:{valid:!0}}findOverlapping(s,n,o,r){const a=(r==null?void 0:r.includeTouching)??!1;return s.filter(i=>a?!(i.end<n||i.start>o):!(i.end<=n||i.start>=o))}deleteHighlight(s,n){return s.filter(o=>o.id!==n)}sortHighlights(s){return[...s].sort((n,o)=>n.start!==o.start?n.start-o.start:n.end-o.end)}}function Ai(e,s,n){let o=0,r=!1;function a(i){var c;if(r)return!0;if(i===s)return i.nodeType===Node.TEXT_NODE&&(o+=n),r=!0,!0;if(i.nodeType===Node.TEXT_NODE)o+=((c=i.textContent)==null?void 0:c.length)||0;else if(i.nodeType===Node.ELEMENT_NODE){const l=i,d=l.tagName;if(d==="BR")return o+=1,!1;let u=0,h=!1;if(d==="H1")u=2;else if(d==="H2")u=3;else if(d==="H3")u=4;else if(d==="BLOCKQUOTE")u=2;else if(l.classList.contains("list-item-ul"))u=2,h=!0;else if(l.classList.contains("list-item-ol")){const f=l.querySelector("span:first-child");u=((f==null?void 0:f.textContent)||"1.").length+1,h=!0}else if(l.classList.contains("empty-line"))return o+=1,!1;o+=u;const g=Array.from(i.childNodes);for(let f=0;f<g.length;f++)if(!(h&&f===0&&g[f].nodeName==="SPAN")&&a(g[f]))return!0}return!1}return a(e),o}function Pm(e){if(e instanceof HTMLTextAreaElement){const s=e.selectionStart,n=e.selectionEnd;return s===n?null:{start:s,end:n}}if(e.isContentEditable){const s=window.getSelection();if(!s||s.isCollapsed||s.rangeCount===0)return null;const n=s.getRangeAt(0),o=Ai(e,n.startContainer,n.startOffset),r=Ai(e,n.endContainer,n.endOffset);return o===r?null:{start:o,end:r}}return null}const Dm="rgb(198, 183, 0)";function Om({textareaRef:e,node:s,updateNode:n,enabled:o=!0,defaultColor:r=Dm}){const a=p.useRef(new Mm),i=p.useCallback(d=>{if(!e.current||!o)return;const u=Pm(e.current);if(!u)return;const h=s.highlights||[],g=a.current.findOverlapping(h,u.start,u.end);if(g.length>0){let v=h;for(const N of g)v=a.current.deleteHighlight(v,N.id);if(n(s.id,{highlights:v.length>0?v:void 0}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const N=window.getSelection();N&&N.collapseToEnd()}console.log("🗑️ Highlights removed:",g.length);return}const f=a.current.createHighlight({start:u.start,end:u.end,color:d||r}),w=s.content||"",m=a.current.validateHighlight(f,w.length);if(!m.valid){console.error("useTextHighlighting: Invalid highlight",m.error);return}const x=[...h,f],y=a.current.sortHighlights(x);if(n(s.id,{highlights:y}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const v=window.getSelection();v&&v.collapseToEnd()}console.log("✨ Highlight applied:",{start:u.start,end:u.end,color:f.color})},[e,o,s,n,r]),c=d=>{const u=s.highlights||[],h=a.current.deleteHighlight(u,d);n(s.id,{highlights:h.length>0?h:void 0}),console.log("🗑️ Highlight removed:",d)},l=()=>{n(s.id,{highlights:void 0}),console.log("🧹 All highlights cleared")};return p.useEffect(()=>{if(!o||!e.current)return;const d=()=>{Sn.registerCallback(i)},u=()=>{Sn.unregisterCallback(i)},h=e.current;return h.addEventListener("focus",d),h.addEventListener("blur",u),document.activeElement===h&&Sn.registerCallback(i),()=>{h.removeEventListener("focus",d),h.removeEventListener("blur",u),Sn.unregisterCallback(i)}},[o,e,i]),{applyHighlight:i,removeHighlight:c,clearAllHighlights:l}}function tn(e,s="content"){const n=p.useRef(null),o=p.useCallback(a=>{n.current=a},[]),r=p.useCallback(a=>{const i=n.current;i!==null&&i!==a&&E.getState().undo.commit({type:"node:update",nodeId:e,from:{[s]:i},to:{[s]:a}}),n.current=null},[e,s]);return{onEditStart:o,onEditEnd:r}}function Kn(e,s={}){var x;const{duration:n=500,targetScale:o,highlightYOffset:r}=s,a=E.getState(),i=(x=a.projectCanvas.getActive())==null?void 0:x.viewState;if(!i)return;const c=document.getElementById("CanvasAppV2");if(!c)return;const l=c.getBoundingClientRect(),d=l.width/2,u=l.height/2,h=o??i.scale,g=e.x*h,f=e.y*h,w=r!==void 0?f+r*h:f+(e.height||0)*h/2,m={x:d-g-(e.width||0)*h/2,y:u-w};a.setActiveCanvasViewState(y=>({...y,targetView:{targetOffset:m,targetScale:h,animationStartTime:performance.now(),animationDuration:n}})),a.setSelectedNodes([e]),a.setNodeToFocusId(e.id)}function Ii(e,s){let n=0;function o(r){var a,i,c,l,d;if(r.nodeType===Node.TEXT_NODE){const u=((a=r.textContent)==null?void 0:a.length)||0;if(n+u>=s){const h=s-n,g=Math.min(h,u);return{node:r,offset:g}}return n+=u,null}if(r.nodeType===Node.ELEMENT_NODE){const u=r,h=u.tagName;if(h==="BR")return n+1>s?{node:r.parentNode,offset:Array.from(r.parentNode.childNodes).indexOf(r)}:(n+=1,null);let g=0,f=!1,w=!1;if(h==="H1")g=2;else if(h==="H2")g=3;else if(h==="H3")g=4;else if(h==="BLOCKQUOTE")g=2;else if(u.classList.contains("list-item-ul"))g=2,f=!0,((i=u.previousElementSibling)!=null&&i.classList.contains("list-item-ul")||(c=u.previousElementSibling)!=null&&c.classList.contains("list-item-ol"))&&(w=!0);else if(u.classList.contains("list-item-ol")){const x=u.querySelector("span:first-child");g=((x==null?void 0:x.textContent)||"1.").length+1,f=!0,((l=u.previousElementSibling)!=null&&l.classList.contains("list-item-ul")||(d=u.previousElementSibling)!=null&&d.classList.contains("list-item-ol"))&&(w=!0)}else if(u.classList.contains("empty-line"))return n+1>s?{node:u,offset:0}:(n+=1,null);w&&(n+=1),n+=g;const m=Array.from(r.childNodes);for(let x=0;x<m.length;x++){if(f&&x===0&&m[x].nodeName==="SPAN")continue;const y=o(m[x]);if(y)return y}}return null}return o(e)}const Lm=({text:e,highlights:s,className:n})=>!s||s.length===0?null:t.jsx(Wm,{text:e,highlights:s,className:n}),Wm=({text:e,highlights:s,className:n})=>{const o=p.useRef(null),r=p.useRef(null),[a,i]=p.useState([]),[c,l]=p.useState(0),[d,u]=p.useState(1);p.useEffect(()=>{var m;const g=E.subscribe(x=>{var N;const y=(N=x.projectCanvas.getActive())==null?void 0:N.viewState,v=(y==null?void 0:y.scale)??1;u(v)}),w=(m=E.getState().projectCanvas.getActive())==null?void 0:m.viewState;return u((w==null?void 0:w.scale)??1),g},[]);const h=g=>{var x;if(!g)return;const m=(((x=E.getState().projectCanvas.getActive())==null?void 0:x.coreState.nodes)??[]).find(y=>y.id===g);if(!m){console.warn(`Linked node ${g} not found`);return}Kn(m,{duration:400})};return p.useEffect(()=>{var m,x;const g=o.current;if(!g)return;const f=((m=g.parentElement)==null?void 0:m.querySelector("textarea"))||((x=g.parentElement)==null?void 0:x.querySelector(".markdown-textarea"));if(!f)return;l(f.clientWidth);const w=new ResizeObserver(y=>{for(const v of y)v.target===f&&l(f.clientWidth)});return w.observe(f),()=>{w.disconnect()}},[]),p.useEffect(()=>{if(!o.current||!r.current||!s||s.length===0){i([]);return}const g=requestAnimationFrame(()=>{var S,C,M,I;if(!o.current||!r.current)return;const f=o.current,w=((S=f.parentElement)==null?void 0:S.querySelector("textarea"))||((C=f.parentElement)==null?void 0:C.querySelector(".markdown-textarea"));if(!w){i([]);return}const m=r.current,x=window.getComputedStyle(w);m.style.font=x.font,m.style.fontSize=x.fontSize,m.style.fontFamily=x.fontFamily,m.style.fontWeight=x.fontWeight,m.style.lineHeight=x.lineHeight,m.style.letterSpacing=x.letterSpacing,m.style.wordSpacing=x.wordSpacing,m.style.padding=x.padding,m.style.paddingLeft=x.paddingLeft,m.style.paddingRight=x.paddingRight,m.style.paddingTop=x.paddingTop,m.style.paddingBottom=x.paddingBottom,m.style.width=`${w.clientWidth}px`,m.style.border="none";const y=parseFloat(x.borderTopWidth)||0,v=parseFloat(x.borderLeftWidth)||0;m.style.top=`${y}px`,m.style.left=`${v}px`,m.style.wordWrap=x.wordWrap,m.style.whiteSpace=x.whiteSpace,m.style.overflowWrap=x.overflowWrap,m.style.boxSizing=x.boxSizing,m.style.textAlign=x.textAlign,m.style.direction=x.direction,m.style.wordBreak=x.wordBreak,m.textContent=e;const N=w.getBoundingClientRect(),b=f.getBoundingClientRect(),j=w.classList.contains("markdown-textarea"),R=[];for(const A of s){const O=Math.min(A.start,e.length),F=Math.min(A.end,e.length);if(O>=F)continue;const B=e.substring(O,F);try{let W;if(j){const P=Ii(w,O),k=Ii(w,F),T=((M=P==null?void 0:P.node.textContent)==null?void 0:M.length)??0,L=((I=k==null?void 0:k.node.textContent)==null?void 0:I.length)??0,H=P&&P.offset>=0&&P.offset<=T,$=k&&k.offset>=0&&k.offset<=L;if(!P||!k||!H||!$)continue;const _=document.createRange();_.setStart(P.node,P.offset),_.setEnd(k.node,k.offset),W=_.getClientRects()}else{const P=document.createRange(),k=m.firstChild;if(!k||k.nodeType!==Node.TEXT_NODE)continue;P.setStart(k,O),P.setEnd(k,F),W=P.getClientRects()}for(let P=0;P<W.length;P++){const k=W[P],T={top:k.top-b.top,left:k.left-b.left},L={top:k.top-N.top,left:k.left-N.left},H=parseFloat(x.borderTopWidth)||0,$=T.top-H,_=parseFloat(x.paddingLeft)||0,G=j?L.left:L.left-_,V=k.width,D=k.height;if(V<1)continue;const Y=$/d,te=G/d,ie=V/d+8,we=D/d;R.push({id:`${A.id}-${P}`,top:Y,left:te,width:ie,height:we,color:A.color,linkedNodeId:A.linkedNodeId,highlightedText:B})}}catch(W){console.error("Error calculating highlight rect:",W)}}i(R)});return()=>{cancelAnimationFrame(g)}},[e,s,c,d]),t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:r,className:je("mirror-div absolute inset-0 pointer-events-none whitespace-pre-wrap"),"aria-hidden":"true"}),t.jsx("div",{ref:o,className:je("highlight-renderer","absolute inset-0","z-20","pointer-events-none",n),"aria-hidden":"true",children:a.map(g=>t.jsx("mark",{"data-test":"highlight-mark",className:je("absolute",g.linkedNodeId?"cursor-pointer pointer-events-auto":"pointer-events-none"),onClick:g.linkedNodeId?()=>h(g.linkedNodeId):void 0,style:{top:`${g.top}px`,left:`${g.left}px`,width:`${g.width}px`,height:`${g.height}px`,backgroundColor:g.color,opacity:.4,borderRadius:"2px"}},g.id))})]})};function Hm(e,s){const n=e.split(`
`);let o=0;for(let r=0;r<n.length;r++){const a=n[r].length,i=o+a;if(s<=i)return r;o=i+1}return n.length-1}function Bm(e,s,n=be.DEFAULT_PADDING,o=be.LINE_HEIGHT){const r=Hm(e,s.start);return n+r*o+o/2}function Fm({textareaRef:e,onCopy:s,onHighlight:n,onDelete:o,onLink:r,onHighlightAndCreateNode:a,onDefine:i}){const[c,l]=p.useState(!1),[d,u]=p.useState({start:0,end:0}),h=p.useRef({start:0,end:0}),g=p.useRef(null),f=p.useRef(!1);p.useEffect(()=>{const x=()=>{f.current=!0,l(!1)};return Kt.registerDismissPopoverCallback(x),()=>{Kt.unregisterDismissPopoverCallback()}},[]),p.useEffect(()=>(Kt.registerSelectionCallback(x=>{l(x)}),g.current=setInterval(()=>{const x=e.current;if(!x)return;const y=x.selectionStart,v=x.selectionEnd,N=y!==v;N&&((y!==h.current.start||v!==h.current.end)&&(f.current=!1),h.current={start:y,end:v},u({start:y,end:v})),f.current||l(N)},100),()=>{Kt.unregisterSelectionCallback(),g.current&&clearInterval(g.current)}),[e]);const w=()=>{const x=e.current;return x?(x.value??"").substring(d.start,d.end):""},m=(x,y)=>{x.preventDefault(),x.stopPropagation(),f.current=!0;const v=e.current;v&&(v.focus(),v.setSelectionRange(d.start,d.end)),y&&y(),setTimeout(()=>{l(!1)},20)};return t.jsx(xp,{inputRef:e,show:c,updateOn:d,offset:{top:4,left:0},children:t.jsxs("div",{className:"text-selection-popover bg-popover text-popover-foreground border border-border rounded-md shadow-lg p-1","data-test":"text-selection-popover",onPointerDown:x=>{x.preventDefault()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center gap-1",children:[s&&t.jsx("button",{"data-test":"text-selection-copy-button",onPointerDown:x=>m(x,s),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Create linked node",children:t.jsx(Pt,{className:"w-4 h-4"})}),a&&t.jsx("button",{"data-test":"text-selection-highlight-create-button",onPointerDown:x=>m(x,a),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight & create linked node",children:t.jsx(Dn,{className:"w-4 h-4"})}),i&&t.jsx("button",{"data-test":"text-selection-define-button",onPointerDown:x=>m(x,i),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Define word",children:t.jsx(Ko,{className:"w-4 h-4"})}),n&&t.jsx("button",{"data-test":"text-selection-highlight-button",onPointerDown:x=>m(x,n),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight text",children:t.jsx(nl,{className:"w-4 h-4"})}),r&&t.jsx("button",{"data-test":"text-selection-link-button",onPointerDown:x=>m(x,r),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Link to node",children:t.jsx(uh,{className:"w-4 h-4"})}),o&&t.jsx("button",{"data-test":"text-selection-delete-button",onPointerDown:x=>m(x,o),className:"action-button p-2 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors",title:"Delete selection",children:t.jsx(yt,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"selection-preview text-xs text-muted-foreground mt-1 px-2 py-1 max-w-[200px] truncate",children:['"',w(),'"']})]})})}function $m({input:e,lastKeyWasEnter:s=!1,pendingNewlines:n=0,computedLineHeight:o=be.LINE_HEIGHT,currentNodeHeight:r=0}){const a=e.split(/\n|&nbsp;/);let i=a.length,c=be.DEFAULT_NODE_HEIGHT;if(i===1&&!s&&n===0)return c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:0,headerExtraLines:0};i+=n;let l=0,d=!1,u=!0;const h=n>0;let g=0;for(let f=0;f<a.length;f++){const m=a[f].trimStart(),x=m.startsWith("- ")||/^\d+\.\s/.test(m),y=f===a.length-1;x&&!d&&!u&&(!y||h)&&(l+=1),(!y||h)&&(m.startsWith("# ")?g+=.5:m.startsWith("## ")?g+=.3:m.startsWith("### ")&&(g+=.1)),d=x,u=!1}return i+=l+g,c+=(i-1)*o,c=Math.max(c,r),{finalHeight:c,numOfLines:i,listMarginLines:l,headerExtraLines:g}}const Ti=(e,s)=>{const o=E.getState().projectCanvas.getActive();if(!o)return null;const a=(o.coreState.nodes||[]).filter(c=>c.linkedSourceNodeId===e&&Array.isArray(c.tags)&&c.tags.some(l=>l.title===s));return a.length===0?null:Math.max(...a.map(c=>(c.y??0)+(c.height??0)))},Ei=e=>({id:Math.random().toString(36).slice(2,10),title:e}),Ri=e=>({x:(e.x??0)+(e.width??0)/2,y:(e.y??0)+(e.height??0)/2}),Mi=(e,s)=>{const n=E.getState(),o=()=>Math.random().toString(36).slice(2,10);window.setTimeout(()=>{n.arrow.add({id:o(),startNodeId:e.id,endNodeId:s.id,startPoint:Ri(e),endPoint:Ri(s),type:"TreeLStep"})},0)},zm=Ie.memo(({node:e,isEditing:s,preventEdit:n})=>{const o=p.useCallback(()=>{const i=E.getState(),c=i.getNodeById(e.id);if(!c)return;const l=be.DEFAULT_NODE_WIDTH,d=be.DEFAULT_NODE_HEIGHT,u=40,h=c.x-l/2,g=Ti(c.id,"left"),f=g!==null?g+u:c.y+(c.height??0)+u,w=Le.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});w.x=h,w.y=f,w.width=l,w.height=d,w.tags=[Ei("left")],i.addNode(w,void 0,{dontOverlap:!0}),i.setNodeToFocusId(w.id),Mi(c,w)},[e.id]),r=p.useCallback(()=>{const i=E.getState(),c=i.getNodeById(e.id);if(!c)return;const l=be.DEFAULT_NODE_WIDTH,d=be.DEFAULT_NODE_HEIGHT,u=40,h=c.x+(c.width??0)-l/2,g=Ti(c.id,"right"),f=g!==null?g+u:c.y+(c.height??0)+u,w=Le.buildTextNodeV2({content:"",linkedSourceNodeId:c.id});w.x=h,w.y=f,w.width=l,w.height=d,w.tags=[Ei("right")],i.addNode(w,void 0,{dontOverlap:!0}),i.setNodeToFocusId(w.id),Mi(c,w)},[e.id]);return!s||n||!(e.content&&e.content.trim().length>0)?null:t.jsxs(t.Fragment,{children:[t.jsx(Q,{"data-test":"create-left-child-node-button",size:"icon",variant:"ghost",className:"create-left-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),o()},title:"Create linked node on the left",children:"+"}),t.jsx(Q,{"data-test":"create-right-child-node-button",size:"icon",variant:"ghost",className:"create-right-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${2*(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:i=>{i.stopPropagation(),i.preventDefault(),r()},title:"Create linked node on the right",children:"+"})]})}),Yl=new Map;function _m(e){const s=e.data;if((s==null?void 0:s.vocabType)!==Ge.VOCABULARY)return null;const n=s.sourceWord||"",o=s.translationWord||"",r=bs(n),a=bs(o),i=Math.max(r,a);return{width:Math.max(i+Ns.textNodeXPadding,be.VOCAB_NODE_MIN_WIDTH),height:null}}Yl.set(le.VOCABULARY,_m);function Pi(e){const s=Yl.get(e.type);return s?s(e):null}const ka=()=>{var e;return((e=E.getState().projectCanvas.getActive())==null?void 0:e.coreState.selectedNodes)??[]},Aa=()=>E.getState().updateNode;function an(){const e=p.useCallback(r=>{const a=r||ka(),i=Aa();if(a.length===0)return;const c=Lr(),l=a.map(d=>{if(!(d!=null&&d.id))return null;const u=Pi(d);if(u){const f={...d,width:u.width};return u.height!==null&&(f.height=u.height),{id:d.id,payload:f}}if(!d.content||typeof d.content!="string")return null;const{width:h,height:g}=Ss(d.content,c,d);return h>0?{id:d.id,payload:{...d,width:h,height:g}}:null}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const u={width:d.payload.width,options:{...d.payload.options,lockSize:!0}};d.payload.height!==void 0&&(u.height=d.payload.height),i(d.id,u)})},[]),s=p.useCallback((r,a)=>{const i=a||ka(),c=Aa(),l=i.map(d=>{if(!(d!=null&&d.id))return null;const u=Pi(d);if(u){const f={...d,width:r,options:{...d.options,lockSize:!0}};return u.height!==null&&(f.height=u.height),{id:d.id,payload:f}}const h=d.content||"",g=mt(h,r,d);return{id:d.id,payload:{...d,width:r,height:g,options:{...d.options,lockSize:!0}}}}).filter(d=>d!==null);l.length>0&&l.forEach(d=>{const u={width:d.payload.width,options:d.payload.options};d.payload.height!==void 0&&(u.height=d.payload.height),c(d.id,u)})},[]),n=p.useCallback((r,a,i)=>{if(r.length===0)return;const c=Aa(),l=i??Z.arrange.gap,d=Lr();r.map(h=>{if(!(h!=null&&h.id)||!h.content||typeof h.content!="string")return null;const{width:g,height:f}=Ss(h.content,d,h);return g>0?{id:h.id,width:g,height:f}:null}).filter(h=>h!==null).forEach(h=>{c(h.id,{width:h.width,height:h.height,options:{lockSize:!1}})}),setTimeout(()=>{const h=E.getState();let g=a;r.forEach(f=>{const w=h.getNodeById(f.id);w&&(h.updateNode(f.id,{y:g}),g+=(w.height??0)+l)})},10)},[]);return p.useMemo(()=>({fitNodeDimensions:e,setFixedWidth:s,fitAndRepositionNodes:n,get selectedNodes(){return ka()}}),[e,s,n])}const Kl=p.createContext({inChat:!1});function Vm(){return p.useContext(Kl)}function Um(e){const s=p.useCallback(()=>Wr.has(e),[e]);return p.useSyncExternalStore(n=>Wr.subscribe(n),s,s)}const zo=new Map;let Xl={targetScreenYRatio:.8,animationDuration:300,stabilizationDelay:10,minKeyboardHeight:100,listenerTimeout:2e3};function Gm(e){var d;const{nodeId:s,nodeY:n}=e,o=Xl,r=document.querySelector(`[data-node-id="${s}"]`);r==null||r.getBoundingClientRect().top;let a=0,i=null;const c=()=>{var f;const u=window.innerHeight,h=((f=window.visualViewport)==null?void 0:f.height)||window.innerHeight,g=u-h;if(g>o.minKeyboardHeight&&g!==a){a=g,i&&clearTimeout(i),i=setTimeout(()=>{var w;(w=window.visualViewport)==null||w.removeEventListener("resize",c),l()},o.stabilizationDelay);return}},l=()=>{var b;const u=((b=window.visualViewport)==null?void 0:b.height)||window.innerHeight,h=E.getState(),g=h.projectCanvas.getActive(),f=(g==null?void 0:g.viewState.offset)||{x:0,y:0},w=(g==null?void 0:g.viewState.scale)||1,m=document.querySelector(`[data-node-id="${s}"]`),x=m==null?void 0:m.getBoundingClientRect(),y=(x==null?void 0:x.top)??n*w+f.y,N=u*o.targetScreenYRatio-y;h.setActiveCanvasViewState(j=>({...j,targetView:{targetOffset:{x:f.x,y:f.y+N},targetScale:w,animationStartTime:0,animationDuration:o.animationDuration}})),zo.set(s,N)};(d=window.visualViewport)==null||d.addEventListener("resize",c),setTimeout(()=>{var u;(u=window.visualViewport)==null||u.removeEventListener("resize",c),i&&clearTimeout(i)},o.listenerTimeout)}function Ym(e){var i,c;const s=Xl,n=zo.get(e);if(!n)return;zo.delete(e);let o=window.innerHeight-(((i=window.visualViewport)==null?void 0:i.height)||window.innerHeight),r=null;const a=()=>{var h;const l=window.innerHeight,d=((h=window.visualViewport)==null?void 0:h.height)||window.innerHeight,u=l-d;u!==o&&(o=u,r&&clearTimeout(r),r=setTimeout(()=>{var g;if(u<s.minKeyboardHeight){(g=window.visualViewport)==null||g.removeEventListener("resize",a);const f=E.getState(),w=f.projectCanvas.getActive(),{scale:m,offset:x}=(w==null?void 0:w.viewState)||{scale:1,offset:{x:0,y:0}};f.setActiveCanvasViewState(y=>({...y,targetView:{targetOffset:{x:x.x,y:x.y-n},targetScale:m,animationStartTime:0,animationDuration:s.animationDuration}}))}},s.stabilizationDelay))};(c=window.visualViewport)==null||c.addEventListener("resize",a),setTimeout(()=>{var l;(l=window.visualViewport)==null||l.removeEventListener("resize",a),r&&clearTimeout(r)},s.listenerTimeout)}function Km(e){var n;const s=((n=window.visualViewport)==null?void 0:n.height)||window.innerHeight;return e>s/2}const Xm="type here...",qm=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??or},ql=Ie.memo(({node:e})=>{var we,ge,X,ce,ue,ee;const s=p.useRef(null),n=p.useRef(null),[o,r]=p.useState(e.isEditing??!1),a=p.useRef(Date.now()),[i,c]=p.useState(e.content||""),l=p.useRef(0),d=Vn(),u=yo(qm),h=Um(e.id),{inChat:g,containerWidth:f,onSendMessage:w}=Vm(),{onEditStart:m,onEditEnd:x}=tn(e.id,"content");p.useEffect(()=>{if(s.current){const K=s.current.getTextArea();K&&(n.current=K)}},[s.current]);const{updateNodeContent:y,updateNode:v,setMode:N,deleteNodeById:b}=E.getState(),j=z(K=>K.uiState.nodeToFocusId),R=z(K=>K.uiState.mode),S=z(K=>K.uiState.writeSubMode);z(K=>{var U;return((U=K.uiState.dragInfo)==null?void 0:U.draggedNodeId)===e.id});const C=z(K=>{var U,q;return((q=(U=K.projectCanvas.getActive())==null?void 0:U.coreState.selectedNodes)==null?void 0:q.some(se=>se.id===e.id))??!1}),M=z(K=>{var U,q;return((q=(U=K.projectCanvas.getActive())==null?void 0:U.coreState.selectedNodes)==null?void 0:q.length)??0}),I=C&&j===e.id,{fitNodeDimensions:A,setFixedWidth:O}=an(),F=K=>{const U=K.target.value,q=(i.match(/\n/g)||[]).length,ne=(U.match(/\n/g)||[]).length-q;ne>0&&(l.current=Math.max(0,l.current-ne)),c(U),y(e.id,U)},B=p.useCallback(K=>{var de;K.preventDefault();const U=K.clipboardData.getData("text"),q=(de=s.current)==null?void 0:de.getTextArea();if(!q)return;const se=q.selectionStart,ne=q.selectionEnd,oe=q.value;if(!oe)return;const fe=oe.substring(0,se)+U+oe.substring(ne);q.value=fe;const he=se+U.length;q.setSelectionRange(he,he),c(fe),y(e.id,fe),setTimeout(()=>{const ae=E.getState().getNodeById(e.id);ae!=null&&ae.width&&O(ae.width,[ae])},10)},[e.id,y,O]),W=p.useCallback(()=>{setTimeout(()=>{const U=E.getState().getNodeById(e.id);U!=null&&U.width&&O(U.width,[U])},10)},[e.id,O]),P=p.useCallback(()=>{setTimeout(()=>{const U=E.getState().getNodeById(e.id);U&&A([U])},10)},[e.id,A]),k=p.useCallback(()=>{setTimeout(()=>{const U=E.getState().getNodeById(e.id);U!=null&&U.width&&O(U.width,[U])},10)},[e.id,O]);Om({textareaRef:n,node:e,updateNode:v,enabled:o,defaultColor:void 0});const T=p.useCallback(K=>{r(K),v(e.id,{isEditing:K})},[v,e.id]),L=p.useCallback(()=>{var U,q;if(document.querySelector("[data-radix-popper-content-wrapper]"))return;const K=Date.now()-a.current;if(!i.trim()){if(K<200){requestAnimationFrame(()=>{var ne;const se=(ne=s.current)==null?void 0:ne.getTextArea();se&&se.focus({preventScroll:!0})});return}b(e.id);return}l.current=0,y(e.id,i),x(i),T(!1),v(e.id,{isEditing:!1}),(U=window.getSelection())==null||U.removeAllRanges(),(q=e.options)!=null&&q.lockSize||setTimeout(()=>{const ne=E.getState().getNodeById(e.id);ne!=null&&ne.width&&O(ne.width,[ne])},10),zo.has(e.id)&&Ym(e.id)},[e.id,e.width,e.height,(we=e.options)==null?void 0:we.lockSize,y,i,v,O,x,b]),H=p.useCallback(K=>{var ne,oe,fe;const U=window.getSelection();U==null||U.rangeCount,(ne=U==null?void 0:U.anchorNode)==null||ne.nodeName,U==null||U.anchorOffset,(oe=U==null?void 0:U.focusNode)==null||oe.nodeName,U==null||U.focusOffset,U==null||U.isCollapsed,(fe=U==null?void 0:U.toString())==null||fe.substring(0,30);const se=K.currentTarget.getBoundingClientRect();K.clientX,K.clientY,Math.round(se.left),Math.round(se.top),Math.round(se.right),Math.round(se.bottom),K.clientX>=se.left&&K.clientX<=se.right&&K.clientY>=se.top&&K.clientY<=se.bottom,e.isEditing&&K.shiftKey},[e.isEditing,e.id]),$=p.useCallback(()=>{var U;if(!e.isEditing)return;const K=(U=s.current)==null?void 0:U.getTextArea();K&&K.focus()},[e.isEditing]),_=p.useCallback(K=>{if(!K)return"";if("value"in K&&typeof K.value=="string")return K.value;const U=ne=>{let oe="";for(const fe of ne.childNodes)if(fe.nodeType===Node.TEXT_NODE)oe+=fe.textContent||"";else if(fe.nodeType===Node.ELEMENT_NODE){const he=fe;if(he.tagName==="BR")oe+=`
`;else if(he.tagName==="DIV"||he.tagName==="P"){const de=U(he);oe+=de+`
`}else oe+=U(he)}return oe};return U(K).replace(/\n+$/,"")},[]),G=p.useCallback(K=>{var pe,ae,re,me,Ne;if(K.key==="Escape"){L(),T(!1),E.getState().uiState.mode!==J.VIM&&N(J.SELECT),(ae=(pe=s.current)==null?void 0:pe.getTextArea())==null||ae.blur();return}if(K.key==="Enter"&&K.ctrlKey){const xe=(re=s.current)==null?void 0:re.getTextArea(),ye=_(xe);y(e.id,ye);return}if(g&&K.key==="Enter"&&!K.shiftKey&&!d){K.preventDefault(),y(e.id,i),w==null||w();return}let U=i;if(K.key==="Backspace"||K.key==="Delete"){const xe=(me=s.current)==null?void 0:me.getTextArea();if(xe){const ye=xe.selectionStart,Ae=xe.selectionEnd;ye!==Ae?U=i.substring(0,ye)+i.substring(Ae):K.key==="Backspace"&&ye>0?U=i.substring(0,ye-1)+i.substring(ye):K.key==="Delete"&&ye<i.length&&(U=i.substring(0,ye)+i.substring(ye+1))}}if(K.key==="Enter"){const xe=U.split(`
`),ye=xe[xe.length-1].replace(/\u200B/g,"");/^(\s*)-\s*$/.test(ye)||/^(\s*)(\d+)\.\s*$/.test(ye)?l.current=0:l.current+=1}else l.current=0;const q=fe();let se=he(U,K.key==="Enter",l.current,q);const ne=de(U);let oe=(Ne=e.options)!=null&&Ne.lockSize?e.width:ne;if(g&&f&&oe!==void 0&&oe>f&&(oe=f),K.key==="Enter"&&l.current>0){const xe=(e.height??0)+q;se=Math.max(se,xe)}v(e.id,{width:oe,height:se,isEditing:!0});function fe(){var ye;const xe=(ye=s.current)==null?void 0:ye.getTextArea();if(xe){const ke=window.getComputedStyle(xe).lineHeight;if(ke&&ke!=="normal"){const Pe=parseFloat(ke);if(!isNaN(Pe))return Pe}}return be.LINE_HEIGHT}function he(xe,ye=!1,Ae=0,ke=be.LINE_HEIGHT){return $m({input:xe,lastKeyWasEnter:ye,pendingNewlines:Ae,computedLineHeight:ke,currentNodeHeight:e.height??0}).finalHeight}function de(xe,ye=be.DEFAULT_NODE_WIDTH,Ae=Ns.textNodeXPadding){const Fe=xe.split(/\n/).map(Qe=>vo(Qe)).reduce((Qe,et)=>Math.max(Qe,et),0)+Ae,Me=Math.max(Fe,ye);return K.key==="Backspace"||K.key==="Delete"?Math.min(Me,e.width??Me):Math.max(Me,e.width??0)}},[L,y,v,e.id,e.width,e.height,(ge=e.options)==null?void 0:ge.lockSize,i,N,g,f,w,d]);p.useEffect(()=>{j||T(!1)},[j]),p.useEffect(()=>{!C&&o&&T(!1)},[C,o,T]),p.useEffect(()=>{var se,ne;if(!I)return;const K=!o,U=e.content||"";if(T(!0),c(U),K&&m(U),!K)return;const q=(se=s.current)==null?void 0:se.getTextArea();if(q){q.readOnly=!1,q.focus({preventScroll:!0}),q.click();const oe=((ne=q.value)==null?void 0:ne.length)??0;q.selectionStart=q.selectionEnd=oe}window.setTimeout(()=>{var he,de;const oe=(he=s.current)==null?void 0:he.getTextArea();if(oe&&document.activeElement!==oe){oe.readOnly=!1,oe.focus({preventScroll:!0}),oe.click();const pe=((de=oe.value)==null?void 0:de.length)??0;oe.selectionStart=oe.selectionEnd=pe}},50)},[I,e.content,o,m]),p.useEffect(()=>{var U;const K=(U=s.current)==null?void 0:U.getTextArea();if(K)return K.addEventListener("blur",L),()=>{K.removeEventListener("blur",L)}},[L,e.id,e.width,e.height,(X=e.options)==null?void 0:X.lockSize]),p.useEffect(()=>{c(e.content||"")},[e.content]);const V=p.useCallback(()=>{const U=E.getState().TextModeHandler;if(U){const q=new U;q&&typeof q.onCopy=="function"&&q.onCopy()}},[]),D=p.useCallback(()=>{var U,q;const K=new KeyboardEvent("keydown",{key:"h",ctrlKey:!0,bubbles:!0});(q=(U=s.current)==null?void 0:U.getTextArea())==null||q.dispatchEvent(K)},[]),Y=p.useCallback(()=>{var ne;const K=(ne=s.current)==null?void 0:ne.getTextArea();if(!K)return;const U=K.selectionStart,q=K.selectionEnd,se=i.substring(0,U)+i.substring(q);c(se),y(e.id,se),setTimeout(()=>{var oe,fe;(fe=(oe=s.current)==null?void 0:oe.getTextArea())==null||fe.setSelectionRange(U,U)},0)},[i,e.id,y]),te=p.useCallback(()=>{var se;if(!((se=s.current)==null?void 0:se.getTextArea()))return;const U=new Kt,q=new KeyboardEvent("keydown",{key:"!"});U.highlightAndCreateNode(q)},[]),ie=p.useCallback(async()=>{var ye,Ae;const K=(ye=s.current)==null?void 0:ye.getTextArea();if(!K)return;const U=K.selectionStart,q=K.selectionEnd,ne=K.value.substring(U,q);if(!ne.trim())return;const oe=E.getState(),fe="rgb(198, 183, 0)",he=await wp(ne.trim(),"English");let de;if(U!==q){const ke=e.highlights||[],Pe=ke.find(Fe=>Fe.start===U&&Fe.end===q);if(Pe)de=Pe.id;else{de=Math.random().toString(36).slice(2,10);const Fe={id:de,start:U,end:q,color:fe,createdAt:Date.now()},Me=[...ke,Fe];oe.updateNode(e.id,{highlights:Me})}}const pe=`${ne}

${he.definition}`,ae=Le.buildTextNodeV2({content:pe,linkedHighlightId:de,linkedSourceNodeId:e.id}),re=El(K,U,q),me=(Ae=oe.projectCanvas.getActive())==null?void 0:Ae.viewState,Ne=(me==null?void 0:me.scale)??1;let xe=e.y;if(re){const ke=re.top/Ne;xe=e.y+ke}if(ea(ae,{...e,y:xe,id:e.id}),de){const ke=oe.getNodeById(e.id),Fe=((ke==null?void 0:ke.highlights)||[]).map(Me=>Me.id===de?{...Me,linkedNodeId:ae.id}:Me);oe.updateNode(e.id,{highlights:Fe})}},[e]);return t.jsxs(t.Fragment,{children:[e.linkedHighlightId&&e.linkedSourceNodeId&&C&&M===1&&t.jsx("div",{className:"absolute z-50 cursor-pointer","data-test":"text-node-linked-highlight-indicator",style:{left:`${(e.width||0)+8}px`,top:"4px"},onClick:K=>{var fe;K.stopPropagation();const se=(((fe=E.getState().projectCanvas.getActive())==null?void 0:fe.coreState.nodes)??[]).find(he=>he.id===e.linkedSourceNodeId);if(!se)return;const ne=(se.highlights||[]).find(he=>he.id===e.linkedHighlightId);let oe;ne&&typeof se.content=="string"&&(oe=Bm(se.content,ne,4,be.LINE_HEIGHT)),Kn(se,{duration:400,highlightYOffset:oe})},title:"Navigate to source highlight",children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18","data-test":"text-node-linked-highlight-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-600 hover:text-yellow-700",children:[t.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),t.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}),t.jsx(zm,{node:e,isEditing:!!o,preventEdit:!1}),h&&!o&&t.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-blue-500 z-50",title:"Transcription in progress...","data-test":"text-node-transcription-indicator"}),t.jsxs("div",{className:"relative w-full h-full","data-text-position-container":"true","data-test":"text-node-position-container",children:[!o&&C&&M<=1&&d&&t.jsx("div",{className:"absolute inset-0 z-20 cursor-pointer",onClick:$,onTouchEnd:K=>{K.preventDefault(),$()},"data-text-node-click-overlay":"true","data-test":"text-node-mobile-click-overlay"}),o&&t.jsx(Fm,{textareaRef:n,onCopy:V,onHighlight:D,onDelete:Y,onHighlightAndCreateNode:te,onDefine:ie,"data-test":"text-node-selection-popover"}),t.jsx(Lm,{text:i,highlights:e.highlights,"data-test":"text-node-highlight-renderer"}),t.jsx(zc,{ref:s,value:i,onChange:F,onPaste:B,onPasteComplete:W,onBlur:L,onKeyDown:G,onMouseDown:H,onClick:$,placeholder:Xm,readOnly:!o,showFilePicker:!1,showAudioButton:o||h,showConfigButton:o||h,audioButtonVariant:"muted",autoStartAudioRecording:I&&R===J.WRITE&&S===Us.AUDIO,onAudioTranscriptionComplete:P,audioNodeId:e.id,useMarkdown:!0,showBuiltInPopover:!1,keyboard:u,onModeChange:k,"data-test":"text-node-textarea",className:je("relative","m-0 p-1 w-full h-full","min-h-0","resize-none","border","rounded-[3px]",e.className,{"overflow-hidden":!d||!o,"overflow-y-auto":d&&o,"pointer-events-none":!o&&!C||M>1,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!i&&!o},"bg-primary/1"),style:{zIndex:Te.nodeTextarea,textAlign:(ce=e.styles)==null?void 0:ce.textAlign,fontSize:(ue=e.styles)==null?void 0:ue.fontSize,lineHeight:(ee=e.styles)!=null&&ee.fontSize?`${Math.round(parseFloat(e.styles.fontSize)*1.5)}px`:void 0,border:g?"none":void 0}})]})]})}),Zm=()=>{var a;const e=E.getState(),s=((a=e.projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[],n=e.updateNodes,o=p.useMemo(()=>{var i;if(s.length===1)return(i=s[0].styles)==null?void 0:i.textAlign},[s]);return{handleAlignmentChange:p.useCallback(i=>{if(s.length===0)return;const c=s.map(l=>({...l,id:l.id,styles:{...l.styles,textAlign:i}}));n(c)},[s,n]),currentAlignment:o}},rn=p.forwardRef((e,s)=>{const{className:n,children:o}=e;return t.jsx(Q,{ref:s,id:"ConfigurationButton",variant:"secondary",size:"icon","aria-label":"Configuration button",className:`h-6 w-6 p-0.5 rounded hover:bg-secondary/80 flex-shrink-0 flex items-center justify-center ${n||null}`,...e,children:o})});rn.displayName="ConfigurationButton";function Jm(e,s,n=!1){let o=null;const r=function(...a){const i=this,c=()=>{o=null,n||e.apply(i,a)},l=n&&!o;o!==null&&clearTimeout(o),o=setTimeout(c,s),l&&e.apply(i,a)};return r.cancel=()=>{o!==null&&(clearTimeout(o),o=null)},r}const Qm=Z.text.debounceInput,ex=e=>{const{className:s,content:n,onValueChange:o}=e,[r,a]=p.useState(n),i=p.useCallback(Jm(l=>{o==null||o(l)},Qm),[o]),c=l=>{const d=l.target.value;a(d),i(d)};return t.jsx(ar,{id:"CanvasTextEditor",className:je("h-[90%]","bg-background",s),style:{fontSize:Z.text.fontSize},value:r,onChange:c,"data-test":"canvas-text-editor-textarea"})},Zl=e=>{var u;const{className:s}=e,n=E.getState(),o=n.projectCanvas.getActive(),r=o==null?void 0:o.coreState,a=n.updateNodeSubContent,c=((r==null?void 0:r.selectedNodes)??[])[0],l=(u=c==null?void 0:c.content)==null?void 0:u.toString().slice(0,30),d=p.useCallback(h=>{c&&a(c.id,h)},[c,a]);return t.jsxs(_c,{children:[t.jsx(Qd,{asChild:!0,children:t.jsx(rn,{id:"CanvasTextEditorButton",className:s,tooltip:"Open Text Editor",variant:"ghost","data-test":"canvas-text-editor-button",children:t.jsx(hh,{})})}),t.jsxs(Vc,{id:"canvas-text-editor-dialog",className:"sm:max-w-[70vw] h-[80vh] bg-secondary",style:{display:"unset"},"aria-describedby":"Text editor dialog",children:[t.jsx(Uc,{children:t.jsx(Gc,{children:l})}),t.jsx(ex,{content:c==null?void 0:c.subContent,onValueChange:d})]})]})},tx={width:380,height:500},sx="Presets",nx="No presets yet. Create one from current settings.";function Jl({isVisible:e,onClose:s,triggerPosition:n,renderConfigSection:o,getCurrentConfig:r,presetActions:a,onApplyPreset:i,title:c=sx,initialSize:l=tx,emptyMessage:d=nx,headerActions:u}){const[h,g]=p.useState(null),[f,w]=p.useState(""),[m,x]=p.useState(null),[y,v]=p.useState(!1),N=a.getAll(),b=a.getFavoriteIds(),j=a.getActiveId(),R=h?a.getById(h):null,S=m??r(),C=p.useMemo(()=>{const V=N.filter(Y=>b.includes(Y.id)),D=N.filter(Y=>!b.includes(Y.id));return[...V,...D]},[N,b]),M=p.useMemo(()=>C.map(V=>({id:V.id,label:V.name,icon:b.includes(V.id)?t.jsx(Fs,{className:"h-3 w-3 fill-yellow-400 text-yellow-400"}):void 0,data:V})),[C,b]),I=p.useCallback(V=>{x(D=>({...D??r(),...V}))},[r]),A=p.useCallback(()=>{v(!0),g(null),w("New Preset"),x(r())},[r]),O=p.useCallback(()=>{if(!f.trim()||!m)return;const V=a.create(f.trim(),m);v(!1),w(""),x(null),a.apply(V);const D=a.getById(V);D&&i&&i(D)},[f,m,a,i]),F=p.useCallback(()=>{v(!1),w(""),x(null)},[]),B=p.useCallback(V=>{g(V.id),v(!1),x(V.config)},[]),W=p.useCallback(()=>{!h||!m||(a.updateConfig(h,m),g(null),x(null))},[h,m,a]),P=p.useCallback(()=>{g(null),x(null)},[]),k=p.useCallback(V=>{const D=V.data;a.apply(D.id),i&&i(D)},[a,i]),T=p.useCallback((V,D)=>{a.rename(V,D)},[a]),L=p.useCallback(V=>{a.delete(V),h===V&&(g(null),x(null))},[a,h]),H=p.useCallback(V=>{const D=V.map(Y=>Y.id);a.reorder(D)},[a]),$=p.useCallback(V=>{const D=V.data;return[{id:"apply-execute",icon:t.jsx(ot,{className:"h-3 w-3"}),title:"Apply & Execute",onClick:()=>{a.apply(D.id),i&&i(D)}}]},[a,i]),_=p.useCallback(V=>{const D=V.data,Y=b.includes(D.id);return[{id:"toggle-favorite",label:Y?"Remove from favorites":"Add to favorites",icon:t.jsx(Fs,{className:`h-4 w-4 mr-2 ${Y?"fill-yellow-400 text-yellow-400":""}`}),onClick:()=>a.toggleFavorite(D.id)},{id:"rename",label:"Rename",icon:t.jsx(Ks,{className:"h-4 w-4 mr-2"}),onClick:()=>{const te=window.prompt("Rename preset:",D.name);te&&te.trim()&&te!==D.name&&a.rename(D.id,te.trim())}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>a.duplicate(D.id)},{id:"edit-settings",label:"Edit settings",icon:t.jsx(ol,{className:"h-4 w-4 mr-2"}),onClick:()=>B(D)}]},[b,a,B]),G=y||h!==null;return t.jsx(Ve,{isVisible:e,onClose:s,title:c,triggerPosition:n,initialSize:l,resizable:!0,shouldCloseManually:!0,headerActions:u,children:t.jsxs("div",{className:"flex flex-col h-full overflow-hidden","data-test":"preset-manager-popover",children:[t.jsx("div",{className:"px-3 py-2 border-b border-border","data-test":"preset-create-section",children:y?t.jsx("div",{className:"space-y-2","data-test":"preset-create-form",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx(Re,{value:f,onChange:V=>w(V.target.value),placeholder:"Preset name",className:"flex-1 h-8 text-sm",autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(Q,{size:"sm",onClick:O,disabled:!f.trim(),"data-test":"preset-save-button",children:"Save"}),t.jsx(Q,{size:"sm",variant:"ghost",onClick:F,"data-test":"preset-cancel-button",children:"Cancel"})]})}):R?t.jsx("div",{className:"space-y-2","data-test":"preset-edit-form",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("span",{className:"text-sm font-medium truncate",children:["Editing: ",R.name]}),t.jsxs("div",{className:"flex gap-1",children:[t.jsx(Q,{size:"sm",onClick:W,"data-test":"preset-update-button",children:"Update"}),t.jsx(Q,{size:"sm",variant:"ghost",onClick:P,"data-test":"preset-cancel-edit-button",children:"Cancel"})]})]})}):t.jsxs(Q,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:A,"data-test":"preset-create-button",children:[t.jsx(wt,{className:"h-4 w-4 mr-2"}),"New from current settings"]})}),G&&t.jsx("div",{className:"px-3 py-2 border-b border-border overflow-auto max-h-[75%] shrink-0","data-test":"preset-config-section",children:o({currentConfig:S,onConfigChange:I,isEditingPreset:h!==null,editingPresetName:R==null?void 0:R.name})}),t.jsx("div",{className:"flex-1 overflow-auto px-1 py-2","data-test":"preset-list-section",children:M.length===0?t.jsx("div",{className:"text-center text-muted-foreground text-sm py-8 px-4","data-test":"preset-empty-message",children:d}):t.jsx(qs,{data:M,selectedId:j,onItemClick:k,onUpdate:T,onDelete:L,onReorder:H,quickActions:$,moreOptionsItems:_,dropdownZIndex:Te.draggablePopoverDropdown,enableEdit:!1,enableDelete:!0,enableDrag:!0,deleteConfirmMessage:V=>`Delete preset "${V.label}"? This cannot be undone.`})})]})})}const{animation:Di}=Z,ox=(e=!1,s=!0,n=!1,o=20)=>{const{fitAndRepositionNodes:r}=an(),a=p.useCallback(f=>{const w=E.getState(),m=w.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],y=w.addNode,v=w.deleteSelectedNodes,N=w.setSelectedNodes,b=w.updateNodes,j=w.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const R=x[0];if(!R.content||typeof R.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}const S=f==="paragraph"?/(\n\n)/:f==="line"?/(\n)/:f==="comma"?/(,)/:f==="period"?/(\.)/:f==="whitespace"?/(\s+)/:new RegExp(`([${be.CUSTOM_CHARACTERS.join("")}])`),C=R.content.split(S),M=[];for(let T=0;T<C.length;T+=2){const L=C[T],H=C[T+1];(L||H)&&M.push(s?(L||"")+(H||""):L||"")}if(M.length===0){console.warn("useNodeSplitter: No segments found after split.");return}if(M.length===1&&M[0]===R.content){console.warn(`useNodeSplitter: No ${f==="paragraph"?"double newline":f==="line"?"single newline":f==="comma"?"comma":f==="period"?"period":f==="whitespace"?"whitespace":"custom character"} found to split content. Original node not modified.`);return}const I=R.x,A=R.y;R.width;const O=R.id;e||v();let F=n?I:A,B=0;const W=[],P=new Map;let k=n?I:A;M.forEach((T,L)=>{const H=f==="comma"||f==="paragraph"||f==="period"||f==="custom"||f==="whitespace"?T.trim():T;if((f==="paragraph"||f==="comma"||f==="period"||f==="custom"||f==="whitespace")&&H===""&&M.length>1)return;const $=Math.min(bs(H),Z.nodeOptions.maxNodeWidth)+Ns.textNodeXPadding,_=mt(H,$,R);let G,V;if(n?(V=A,L===0?G=I:G=F+B+o):(G=I,L===0?V=A:V=F+B+o),e&&L===0){b([{id:O,content:H,width:$,height:_}]),F=n?G:V,B=n?$:_,k=(n?G+$:V+_)+o;return}const D=O+"-split-"+L,Y=Le.buildTextNodeV2({...R,id:D,title:"",x:I,y:A,width:$,height:_,content:H});P.set(D,{x:G,y:V}),y(Y),W.push(Y),e&&j({id:De(10),startNodeId:O,endNodeId:Y.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),F=n?G:V,B=n?$:_}),W.length>0&&(N(W),setTimeout(()=>{const L=E.getState().updateNodes,H=[];P.forEach(($,_)=>{H.push({id:_,x:$.x,y:$.y})}),H.length>0&&L(H),n||r(W,k,o)},Di.splitDelayMs))},[r,e,s,n,o]),i=p.useCallback(()=>{a("paragraph")},[a]),c=p.useCallback(()=>{a("line")},[a]),l=p.useCallback(()=>{a("comma")},[a]),d=p.useCallback(()=>{a("period")},[a]),u=p.useCallback(()=>{a("custom")},[a]),h=p.useCallback(()=>{a("whitespace")},[a]),g=p.useCallback(f=>{const w=E.getState(),m=w.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],y=w.addNode,v=w.deleteSelectedNodes,N=w.setSelectedNodes,b=w.updateNodes,j=w.arrow.add;if(x.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const R=x[0];if(!R.content||typeof R.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}let S;try{S=new RegExp(`(${f})`,"g")}catch(T){console.error("useNodeSplitter: Invalid regex pattern",T);return}const C=R.content.split(S),M=[];for(let T=0;T<C.length;T+=2){const L=C[T]||"",H=C[T+1]||"",$=s?(L+H).trim():L.trim();$&&M.push($)}if(M.length===0){console.warn("useNodeSplitter: No segments found with regex pattern.");return}if(M.length===1&&M[0]===R.content.trim()){console.warn("useNodeSplitter: Regex pattern did not match content.");return}const I=R.x,A=R.y,O=R.id;e||v();let F=n?I:A,B=0;const W=[],P=new Map;let k=n?I:A;M.forEach((T,L)=>{if(T==="")return;const H=Math.min(bs(T),Z.nodeOptions.maxNodeWidth)+Ns.textNodeXPadding,$=mt(T,H,R);let _,G;if(n?(G=A,L===0?_=I:_=F+B+o):(_=I,L===0?G=A:G=F+B+o),e&&L===0){b([{id:O,content:T,width:H,height:$}]),F=n?_:G,B=n?H:$,k=(n?_+H:G+$)+o;return}const V=O+"-split-"+L,D=Le.buildTextNodeV2({...R,id:V,title:"",x:I,y:A,width:H,height:$,content:T});P.set(V,{x:_,y:G}),y(D),W.push(D),e&&j({id:De(10),startNodeId:O,endNodeId:D.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),F=n?_:G,B=n?H:$}),W.length>0&&(N(W),setTimeout(()=>{const L=E.getState().updateNodes,H=[];P.forEach(($,_)=>{H.push({id:_,x:$.x,y:$.y})}),H.length>0&&L(H),n||r(W,k,o)},Di.splitDelayMs))},[e,s,n,o,r]);return{splitNodeContentByParagraph:i,splitNodeContentByLine:c,splitNodeContentByComma:l,splitNodeContentByPeriod:d,splitNodeContentByCustomCharacter:u,splitNodeContentByWhitespace:h,splitNodeContentByRegex:g}};function ax(e){return!e||e.trim()===""?0:e.trim().split(/\s+/).filter(s=>s.length>0).length}const rx=[".","!","?",":",";"],ix=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","Ph.D","M.D","B.A","M.A","B.S","M.S","Inc","Ltd","Co","Corp","etc","vs","e.g","i.e","a.m","p.m","St","Ave","Blvd","Rd","vol","no"];function cx(e,s){if(s<=0||s>=e.length-1)return!1;let n=s-1;for(;n>=0&&/[a-zA-Z.]/.test(e[n]);)n--;n++;const o=e.substring(n,s);return!!(ix.includes(o)||o.length===1&&/[A-Z]/.test(o)||s>1&&e[s-2]===".")}function lx(e,s){const n=[".","!","?",","];let o=e.length;for(const r of n){const a=e.indexOf(r,s);a!==-1&&a<o&&(o=a)}return o}function dx(e,s){const n=[];for(let r=0;r<e.length;r++)e[r]===","&&n.push(r);const o=[];for(let r=0;r<n.length;r++){const a=n[r],i=lx(e,a+1),c=e.substring(a+1,i).trim();ax(c)>=s&&o.push(a)}return o}function Oi(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(rx.includes(o)){if(o==="."&&cx(e,n)){s+=o,n++;continue}for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}function Li(e,s=3){if(!e)return e;const n=dx(e,s);if(n.length===0)return e;let o=e;for(let r=n.length-1;r>=0;r--){const a=n[r];let i=a+1;for(;i<o.length&&o[i]===" ";)i++;o=o.substring(0,a+1)+`
`+o.substring(i)}return o}const ux=["&",";","-",":"];function Wi(e){if(!e)return e;let s="",n=0;for(;n<e.length;){const o=e[n];if(ux.includes(o)){for(s+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(s+=`
`)}else s+=o,n++}return s}const hx=()=>{const e=p.useCallback((a,i=3)=>{const c=E.getState(),l=c.projectCanvas.getActive(),d=(l==null?void 0:l.coreState.selectedNodes)??[],u=c.updateNodeContent;if(d.length===0){console.warn("useNodeInsideSplitter: No nodes selected.");return}d.forEach(h=>{if(!h.content||typeof h.content!="string"){console.warn(`useNodeInsideSplitter: Node ${h.id} has no content to split.`);return}let g;if(a==="sentence")g=Oi(h.content);else if(a==="smartComma")g=Li(h.content,i);else if(a==="smartCharacter")g=Wi(h.content);else if(a==="all")g=Oi(h.content),g=Li(g,i),g=Wi(g);else{console.warn(`useNodeInsideSplitter: Unknown mode "${a}"`);return}if(g===h.content){console.warn(`useNodeInsideSplitter: No ${a==="sentence"?"sentence endings":"qualifying commas"} found in node ${h.id}. Content not modified.`);return}u(h.id,g);const f=c.getSegmentedButtonAction("canvas-fit-width");let w=null;if(f){const v=f.match(/Set width to (\d+)px/);v&&(w=parseInt(v[1],10))}let m,x,y;if(w)x=mt(g,w,h),m=w,y=!0;else{let v;const N=document.querySelector("textarea[data-node-textarea]");if(N){const R=window.getComputedStyle(N).lineHeight;if(R&&R!=="normal"){const S=parseFloat(R);isNaN(S)||(v=S)}}const b=Ss(g,v,h);m=b.width,x=b.height,y=!1}c.updateNode(h.id,{content:g,width:m,height:x,options:{...h.options,lockSize:y}})})},[]),s=p.useCallback(()=>{e("sentence")},[e]),n=p.useCallback((a=3)=>{e("smartComma",a)},[e]),o=p.useCallback(()=>{e("smartCharacter")},[e]),r=p.useCallback((a=3)=>{e("all",a)},[e]);return{splitInsideBySentence:s,splitInsideBySmartComma:n,splitInsideBySmartCharacter:o,splitInsideByAll:r}};function px({action:e,mode:s,isSelected:n,onSelect:o,onSplitRegex:r,selectedNodeContent:a}){const[i,c]=p.useState(""),[l,d]=p.useState([]),u=s==="record",h=f=>{if(c(f),f&&a)try{const w=new RegExp(f,"g"),m=a.match(w)||[];d(m.slice(0,3))}catch{d([])}else d([])},g=()=>{i&&(u?o(e.id,{pattern:i}):r(i))};return t.jsxs("div",{"data-test":"regex-action-section",children:[t.jsx("div",{className:ve("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",u&&n&&"bg-primary/10 border border-primary",!u&&"hover:bg-accent"),"data-test":"regex-action-row",children:t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]})}),t.jsxs("div",{className:"px-3 py-1.5 space-y-1","data-test":"regex-input-section",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Re,{type:"text",value:i,onChange:f=>h(f.target.value),placeholder:"Enter regex pattern...",className:"h-6 text-xs flex-1",onClick:f=>f.stopPropagation(),"data-test":"regex-pattern-input"}),t.jsx(Q,{size:"sm",variant:"secondary",className:"h-6 text-xs px-2",onClick:f=>{f.stopPropagation(),g()},disabled:!i,"data-test":"regex-split-button",children:"Split"})]}),l.length>0&&t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:["Matches: ",l.map(f=>`"${f}"`).join(", "),l.length===3&&"..."]})]})]})}function gx({action:e,mode:s,isSelected:n,onSelect:o,onSplitSmartComma:r}){const[a,i]=p.useState(3),c=s==="record",l=()=>{c?o(e.id,{minWords:a}):r(a)};return t.jsxs("div",{"data-test":"smart-comma-action-section",className:"px-3 py-1.5",children:[t.jsxs("div",{className:ve("flex items-center gap-2 text-sm",c&&n&&"text-primary"),"data-test":"smart-comma-action-row",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 mt-1",onPointerDown:d=>d.stopPropagation(),children:[t.jsx("span",{className:"text-[10px] text-muted-foreground",children:"Min words:"}),t.jsx(Re,{type:"number",min:"1",max:"20",value:a,onChange:d=>i(Math.max(1,parseInt(d.target.value)||3)),className:"h-5 w-10 text-xs px-1",onClick:d=>d.stopPropagation(),"data-test":"smart-comma-min-words-input"}),t.jsx(Q,{size:"sm",variant:"secondary",className:"h-5 text-[10px] px-2",onClick:d=>{d.stopPropagation(),l()},"data-test":"smart-comma-split-button",children:"Split"})]})]})}class fx{constructor(s,n,o=""){He(this,"namespace","canvas.split");this.hooks=s,this.storeActions=n,this.selectedNodeContent=o}getActions(){return[{id:"byParagraph",label:"Paragraph",category:"Node Split",icon:t.jsx(ph,{className:"h-3.5 w-3.5"})},{id:"byLine",label:"Line",category:"Node Split",icon:t.jsx(lr,{className:"h-3.5 w-3.5"})},{id:"byComma",label:"Comma",category:"Node Split",icon:t.jsx(gh,{className:"h-3.5 w-3.5"})},{id:"byPeriod",label:"Period",category:"Node Split",icon:t.jsx(fh,{className:"h-3.5 w-3.5"})},{id:"bySpecial",label:"Special",category:"Node Split",icon:t.jsx(Dn,{className:"h-3.5 w-3.5"})},{id:"byWhitespace",label:"Whitespace",category:"Node Split",icon:t.jsx(mh,{className:"h-3.5 w-3.5"})},{id:"byRegex",label:"Regex",category:"Node Split",icon:t.jsx(xh,{className:"h-3.5 w-3.5"}),params:[{name:"pattern",type:"string",label:"Regex Pattern",default:""}],customRender:s=>t.jsx(px,{...s,onSplitRegex:this.hooks.splitByRegex,selectedNodeContent:this.selectedNodeContent})},{id:"textBySentence",label:"Sentence",category:"Text Split",icon:t.jsx(wh,{className:"h-3.5 w-3.5"})},{id:"textBySmartComma",label:"Smart Comma",category:"Text Split",icon:t.jsx(yh,{className:"h-3.5 w-3.5"}),params:[{name:"minWords",type:"number",label:"Minimum Words",default:3}],customRender:s=>t.jsx(gx,{...s,onSplitSmartComma:this.hooks.textSplitBySmartComma})},{id:"textBySmartChar",label:"Smart Char",category:"Text Split",icon:t.jsx(vh,{className:"h-3.5 w-3.5"})},{id:"textByAll",label:"All",category:"Text Split",icon:t.jsx(nn,{className:"h-3.5 w-3.5"})}]}getConfig(){return{keepArrows:this.storeActions.getKeepArrows(),keepMatch:this.storeActions.getKeepMatch(),horizontal:this.storeActions.getHorizontal(),gap:this.storeActions.getGap()}}setConfig(s){s.keepArrows!==void 0&&this.storeActions.setKeepArrows(s.keepArrows),s.keepMatch!==void 0&&this.storeActions.setKeepMatch(s.keepMatch),s.horizontal!==void 0&&this.storeActions.setHorizontal(s.horizontal),s.gap!==void 0&&this.storeActions.setGap(s.gap)}execute(s,n){switch(s){case"byParagraph":this.hooks.splitByParagraph();break;case"byLine":this.hooks.splitByLine();break;case"byComma":this.hooks.splitByComma();break;case"byPeriod":this.hooks.splitByPeriod();break;case"byWhitespace":this.hooks.splitByWhitespace();break;case"bySpecial":this.hooks.splitBySpecial();break;case"byRegex":n!=null&&n.pattern&&this.hooks.splitByRegex(n.pattern);break;case"textBySentence":this.hooks.textSplitBySentence();break;case"textBySmartComma":this.hooks.textSplitBySmartComma((n==null?void 0:n.minWords)??3);break;case"textBySmartChar":this.hooks.textSplitBySmartChar();break;case"textByAll":this.hooks.textSplitByAll(3);break;default:console.warn(`Unknown split action: ${s}`)}}}class mx{constructor(){He(this,"sources",new Map)}register(s,n){this.sources.set(s,n)}unregister(s){this.sources.delete(s)}has(s){return this.sources.has(s)}getAllActions(){return Array.from(this.sources.values()).map(s=>({source:s.name,actions:s.getActions()}))}get size(){return this.sources.size}getKeys(){return Array.from(this.sources.keys())}}const it=new mx;function Ql(){const e=z(y=>{var v;return((v=y.preferences)==null?void 0:v.keepArrowsOnSplit)??!1}),s=z(y=>{var v;return((v=y.preferences)==null?void 0:v.keepSplitMatch)??!1}),n=z(y=>{var v;return((v=y.preferences)==null?void 0:v.splitHorizontally)??!1}),o=z(y=>{var v;return((v=y.preferences)==null?void 0:v.splitNodeGap)??15}),r=z(y=>y.setKeepArrowsOnSplit),a=z(y=>y.setKeepSplitMatch),i=z(y=>y.setSplitHorizontally),c=z(y=>y.setSplitNodeGap),l=ox(e,s,n,o),d=hx(),h=E.getState().projectCanvas.getActive(),g=(h==null?void 0:h.coreState.selectedNodes)??[],f=g.length===1&&typeof g[0].content=="string"?g[0].content:"",w=p.useMemo(()=>({splitByParagraph:l.splitNodeContentByParagraph,splitByLine:l.splitNodeContentByLine,splitByComma:l.splitNodeContentByComma,splitByPeriod:l.splitNodeContentByPeriod,splitByWhitespace:l.splitNodeContentByWhitespace,splitBySpecial:l.splitNodeContentByCustomCharacter,splitByRegex:l.splitNodeContentByRegex,textSplitBySentence:d.splitInsideBySentence,textSplitBySmartComma:d.splitInsideBySmartComma,textSplitBySmartChar:d.splitInsideBySmartCharacter,textSplitByAll:d.splitInsideByAll}),[l.splitNodeContentByParagraph,l.splitNodeContentByLine,l.splitNodeContentByComma,l.splitNodeContentByPeriod,l.splitNodeContentByWhitespace,l.splitNodeContentByCustomCharacter,l.splitNodeContentByRegex,d.splitInsideBySentence,d.splitInsideBySmartComma,d.splitInsideBySmartCharacter,d.splitInsideByAll]),m=p.useMemo(()=>({getKeepArrows:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.keepArrowsOnSplit)??!1},setKeepArrows:r,getKeepMatch:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.keepSplitMatch)??!1},setKeepMatch:a,getHorizontal:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.splitHorizontally)??!1},setHorizontal:i,getGap:()=>{var y;return((y=E.getState().preferences)==null?void 0:y.splitNodeGap)??15},setGap:c}),[r,a,i,c]),x=p.useMemo(()=>new fx(w,m,f),[w,m,f]);return p.useEffect(()=>(it.register("split",{name:"Split",getActions:()=>x.getActions()}),rt.register("split",x),()=>{it.unregister("split"),rt.unregister("split")}),[x]),x}function xx({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a}){const i=s==="record",c=e.subActions&&e.subActions.length>0;return t.jsxs("div",{className:ve("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",i&&n&&"bg-primary/10 border border-primary",!i&&"hover:bg-accent"),"data-test":"toolbar-action-row",children:[t.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>o(e.id),"data-test":"toolbar-action-button",children:[e.icon,t.jsx("span",{children:e.label})]}),c&&t.jsx("div",{className:"flex items-center gap-0.5 ml-2",children:e.subActions.map(l=>t.jsx(Q,{variant:"outline",size:"icon",className:ve("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",i&&n&&l.id===e.id&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),o(l.id)},title:l.title,"data-test":"toolbar-sub-action",children:l.icon},l.id))})]})}function _o({facade:e,mode:s,selectedActionId:n,selectedActionParams:o,onActionSelect:r,onActionExecuted:a,showConfig:i=!1,configOverride:c,onConfigChange:l,categories:d,className:u}){const h=e.getActions(),g=d?h.filter(N=>d.includes(N.category||"Other")):h,f=e.getConfig(),w=c??f,m=(N,b)=>{var j,R;if(s==="execute"){if(e.execute(N,b),a){const S=g.find(M=>{var I;return M.id===N||((I=M.subActions)==null?void 0:I.some(A=>A.id===N))}),C=((R=(j=S==null?void 0:S.subActions)==null?void 0:j.find(M=>M.id===N))==null?void 0:R.title)??(S==null?void 0:S.label)??N;a(C,()=>e.execute(N,b))}}else r==null||r(N,b)},x=N=>{l?l(N):e.setConfig(N)},y=g.reduce((N,b)=>{const j=b.category||"Other";return N[j]||(N[j]=[]),N[j].push(b),N},{}),v=Object.keys(y);return t.jsx("div",{className:ve("flex flex-col",u),"data-test":"toolbar-actions-panel",children:v.map((N,b)=>t.jsxs("div",{"data-test":"action-category",children:[b>0&&t.jsx("div",{className:"h-px bg-border my-1"}),v.length>1&&t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:N}),y[N].map(j=>{var S;const R=n===j.id||(((S=j.subActions)==null?void 0:S.some(C=>C.id===n))??!1);return j.customRender?t.jsx(Ie.Fragment,{children:j.customRender({action:j,mode:s,isSelected:R,onSelect:m,config:w,onConfigChange:x})},j.id):t.jsx(xx,{action:j,mode:s,isSelected:R,onSelect:m,config:w,onConfigChange:x},j.id)})]},N))})}const wx=[],yx=[];function vx({currentConfig:e,onConfigChange:s,facade:n,onExecuteSplit:o,canExecute:r}){const a=p.useCallback((l,d)=>{const h={byParagraph:"paragraph",byLine:"line",byComma:"comma",byPeriod:"period",bySpecial:"custom",byWhitespace:"whitespace",byRegex:"regex"}[l];h&&(s({splitMode:h}),d!=null&&d.pattern&&s({regexPattern:d.pattern}))},[s]),i=p.useMemo(()=>({keepArrows:e.keepArrowsOnSplit,keepMatch:e.keepSplitMatch,horizontal:e.splitHorizontally,gap:e.splitNodeGap}),[e]),c={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex"};return t.jsxs("div",{className:"space-y-2","data-test":"split-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"split-action-selector",children:t.jsx(_o,{facade:n,mode:"record",selectedActionId:c[e.splitMode],onActionSelect:a,configOverride:i,onConfigChange:l=>{l.keepArrows!==void 0&&s({keepArrowsOnSplit:l.keepArrows}),l.keepMatch!==void 0&&s({keepSplitMatch:l.keepMatch}),l.horizontal!==void 0&&s({splitHorizontally:l.horizontal}),l.gap!==void 0&&s({splitNodeGap:l.gap})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepArrowsOnSplit,onChange:l=>s({keepArrowsOnSplit:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Arrows"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.keepSplitMatch,onChange:l=>s({keepSplitMatch:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Match"})]}),t.jsxs("label",{className:"flex items-center gap-1 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:e.splitHorizontally,onChange:l=>s({splitHorizontally:l.target.checked}),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Horiz"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"100",value:e.splitNodeGap,onChange:l=>s({splitNodeGap:Math.max(0,parseInt(l.target.value)||15)}),className:"h-5 w-12 text-[10px] px-1","data-test":"split-config-gap"})]})]}),t.jsxs(Q,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(c[e.splitMode]),disabled:!r,"data-test":"split-execute-button",children:[t.jsx(ot,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function bx({isVisible:e,onClose:s,triggerPosition:n,currentSplitMode:o,currentRegexPattern:r,onSplitAction:a}){const i=Ql(),c=p.useCallback(P=>{var k,T;return((T=(k=P.preferences)==null?void 0:k.splitPresets)==null?void 0:T.presets)??wx},[]),l=z(c),d=z(P=>{var k,T;return((T=(k=P.preferences)==null?void 0:k.splitPresets)==null?void 0:T.favoriteIds)??yx}),u=z(P=>{var k,T;return((T=(k=P.preferences)==null?void 0:k.splitPresets)==null?void 0:T.activePresetId)??null}),h=z(P=>{var k;return((k=P.preferences)==null?void 0:k.keepArrowsOnSplit)??!1}),g=z(P=>{var k;return((k=P.preferences)==null?void 0:k.keepSplitMatch)??!1}),f=z(P=>{var k;return((k=P.preferences)==null?void 0:k.splitHorizontally)??!1}),w=z(P=>{var k;return((k=P.preferences)==null?void 0:k.splitNodeGap)??15}),m=z(P=>P.setKeepArrowsOnSplit),x=z(P=>P.setKeepSplitMatch),y=z(P=>P.setSplitHorizontally),v=z(P=>P.setSplitNodeGap),N=z(P=>P.createSplitPreset),b=z(P=>P.updateSplitPreset),j=z(P=>P.duplicateSplitPreset),R=z(P=>P.deleteSplitPreset),S=z(P=>P.renameSplitPreset),C=z(P=>P.applySplitPreset),M=z(P=>P.toggleSplitPresetFavorite),I=z(P=>P.setActiveSplitPresetId),A=p.useMemo(()=>({getAll:()=>l,getById:P=>l.find(k=>k.id===P),getFavorites:()=>l.filter(P=>d.includes(P.id)),getFavoriteIds:()=>d,getActiveId:()=>u,create:(P,k)=>N(P,k),update:(P,k)=>{b(P,k)},updateConfig:(P,k)=>{const T=l.find(L=>L.id===P);T&&b(P,{config:{...T.config,...k}})},duplicate:P=>j(P),delete:P=>{R(P)},rename:(P,k)=>{S(P,k)},reorder:P=>{},apply:P=>{C(P)},setActive:P=>{I(P)},toggleFavorite:P=>{M(P)},isFavorite:P=>d.includes(P)}),[l,d,u,N,b,j,R,S,C,I,M]),O=p.useCallback(()=>({splitMode:o,regexPattern:o==="regex"?r:void 0,keepArrowsOnSplit:h,keepSplitMatch:g,splitHorizontally:f,splitNodeGap:w}),[o,r,h,g,f,w]),F=p.useCallback(P=>{a&&(a(P),Se.success("Executed split action"))},[a]),B=p.useCallback(P=>{a?(requestAnimationFrame(()=>{a(P.config.splitMode)}),Se.success(`Applied and executed "${P.name}" (${P.config.splitMode})`)):Se.success(`Applied preset "${P.name}" settings`)},[a]),W=p.useCallback(P=>{const k=T=>{P.onConfigChange(T),T.keepArrowsOnSplit!==void 0&&m(T.keepArrowsOnSplit),T.keepSplitMatch!==void 0&&x(T.keepSplitMatch),T.splitHorizontally!==void 0&&y(T.splitHorizontally),T.splitNodeGap!==void 0&&v(T.splitNodeGap)};return t.jsx(vx,{...P,onConfigChange:k,facade:i,onExecuteSplit:F,canExecute:!!a})},[i,F,a,m,x,y,v]);return t.jsx(Jl,{isVisible:e,onClose:s,triggerPosition:n,title:"Split Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:W,getCurrentConfig:O,presetActions:A,onApplyPreset:B})}const Hi="canvas-split-regex-history",Bi="canvas-split-before-enabled",Nx=10,Sx=({onSplit:e,selectedNodeContent:s=""})=>{const n=p.useCallback(()=>{try{const m=localStorage.getItem(Hi);return m?JSON.parse(m):[]}catch{return[]}},[]),[o,r]=p.useState(()=>n()[0]||""),[a,i]=p.useState(()=>{try{return localStorage.getItem(Bi)==="true"}catch{return!1}}),[c,l]=p.useState(null),[d,u]=p.useState(0);p.useEffect(()=>{try{localStorage.setItem(Bi,String(a))}catch(m){console.warn("Failed to save split before preference",m)}},[a]);const h=p.useCallback((m,x)=>m?x?`\\n(?=${m})`:m:"",[]),g=p.useCallback(m=>{if(!m)return;const y=n().filter(N=>N!==m),v=[m,...y].slice(0,Nx);try{localStorage.setItem(Hi,JSON.stringify(v))}catch(N){console.warn("Failed to save regex history",N)}},[n]);p.useEffect(()=>{if(!o){l(null),u(0);return}try{const m=h(o,a),x=new RegExp(`(${m})`,"g");if(l(!0),s){const y=s.match(x);u(y?y.length:0)}else u(0)}catch{l(!1),u(0)}},[o,s,a,h]);const f=p.useCallback(()=>{if(!o||!c)return;g(o);const m=h(o,a);e(m)},[o,c,e,g,a,h]),w=p.useCallback(m=>{m.key==="Enter"&&(m.preventDefault(),m.stopPropagation(),f())},[f]);return t.jsxs("div",{className:"regex-split-item px-1 py-1 space-y-0.5",onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"none"},children:[t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsx("span",{className:"text-xs text-foreground",children:"Regex"}),t.jsx("button",{onPointerDown:m=>{m.stopPropagation(),f()},disabled:!c,className:ve("p-0.5 rounded transition-colors",c?"hover:bg-accent text-accent-foreground cursor-pointer":"opacity-50 cursor-not-allowed"),title:"Execute split",style:{touchAction:"none"},"data-test":"regex-split-execute-button",children:t.jsx(ot,{className:"h-2.5 w-2.5"})})]}),t.jsxs("div",{className:"relative px-1",children:[t.jsx("input",{type:"text",value:o,onChange:m=>r(m.target.value),onKeyDown:w,placeholder:"Art \\d+",className:ve("w-full px-1.5 py-0.5 text-[10px] border rounded h-5","bg-background text-foreground","focus:outline-none focus:ring-1 focus:ring-primary",c===!1&&"border-destructive focus:ring-destructive",c===!0&&"border-green-500 focus:ring-green-500"),onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"auto"},"data-test":"regex-split-pattern-input"}),t.jsxs("div",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none",children:[c===!0&&t.jsx(Ys,{className:"h-2 w-2 text-green-500"}),c===!1&&t.jsx(ko,{className:"h-2 w-2 text-destructive"})]})]}),t.jsxs("div",{className:"flex items-center justify-between px-2",children:[t.jsxs("label",{className:"flex items-center gap-1 text-[9px] cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:m=>i(m.target.checked),className:"w-2 h-2 cursor-pointer",onPointerDown:m=>{m.stopPropagation()},"data-test":"regex-split-before-checkbox"}),t.jsx("span",{className:"text-muted-foreground",children:"Before"})]}),c&&d>0&&t.jsx("span",{className:"text-[9px] text-muted-foreground",children:d}),c===!1&&o&&t.jsx("span",{className:"text-[9px] text-destructive",children:"!"})]})]})},Cx=[],jx=[],kx=e=>{const{className:s}=e,n=Ql(),o=z(k=>{var T;return((T=k.preferences)==null?void 0:T.keepArrowsOnSplit)??!1}),r=z(k=>k.setKeepArrowsOnSplit),a=z(k=>{var T;return((T=k.preferences)==null?void 0:T.keepSplitMatch)??!1}),i=z(k=>k.setKeepSplitMatch),c=z(k=>{var T;return((T=k.preferences)==null?void 0:T.splitHorizontally)??!1}),l=z(k=>k.setSplitHorizontally),d=z(k=>{var T;return((T=k.preferences)==null?void 0:T.splitNodeGap)??15}),u=z(k=>k.setSplitNodeGap),h=z(k=>{var T,L;return((L=(T=k.preferences)==null?void 0:T.splitPresets)==null?void 0:L.presets)??Cx}),g=z(k=>{var T,L;return((L=(T=k.preferences)==null?void 0:T.splitPresets)==null?void 0:L.favoriteIds)??jx}),f=z(k=>k.applySplitPreset),w=p.useMemo(()=>h.filter(k=>g.includes(k.id)),[h,g]),[m,x]=p.useState(!1),[y,v]=p.useState(),N=p.useRef(null),b=p.useCallback(()=>{if(N.current){const k=N.current.getBoundingClientRect();v({x:k.left,y:k.bottom+4})}x(!0)},[]),j=p.useCallback(()=>{x(!1)},[]),R=p.useCallback(k=>{const L={paragraph:"byParagraph",line:"byLine",comma:"byComma",period:"byPeriod",custom:"bySpecial",whitespace:"byWhitespace",regex:"byRegex","text:sentence":"textBySentence","text:smartComma":"textBySmartComma","text:smartChar":"textBySmartChar","text:all":"textByAll"}[k]||k;n.execute(L)},[n]),S=p.useCallback(k=>{const T=h.find(L=>L.name===k);return T?()=>{f(T.id),R(T.config.splitMode)}:null},[h,f,R]),M=E.getState().projectCanvas.getActive(),I=(M==null?void 0:M.coreState.selectedNodes)??[],A=I.length===1&&typeof I[0].content=="string"?I[0].content:"",O=n.getActions(),F=O.filter(k=>k.category==="Node Split"&&k.id!=="byRegex"),B=O.filter(k=>k.category==="Text Split"),W=[{header:"Node",width:"150px",actions:[...F.map(k=>({label:k.label,icon:k.icon,onClick:()=>n.execute(k.id)})),{label:"Regex",customRender:()=>t.jsx(Sx,{onSplit:k=>n.execute("byRegex",{pattern:k}),selectedNodeContent:A})}]},{header:"Text",width:"150px",actions:B.map(k=>k.customRender?{label:k.label,customRender:()=>k.customRender({action:k,mode:"execute",isSelected:!1,onSelect:(T,L)=>n.execute(T,L),config:{},onConfigChange:()=>{}})}:{label:k.label,icon:k.icon,onClick:()=>n.execute(k.id)})},{header:"Config",width:"150px",actions:[{label:"Presets",customRender:({registerRepeatAction:k})=>t.jsxs("div",{"data-test":"split-presets-section",className:"mt-1 pt-1",children:[t.jsxs("button",{ref:N,className:"flex items-center gap-2 w-full px-1 py-1 text-sm rounded-sm hover:bg-accent text-left",onClick:b,"data-test":"split-presets-button",children:[t.jsx(dr,{className:"h-3 w-3"}),t.jsx("span",{className:"text-xs",children:"Presets"})]}),w.length>0&&t.jsxs("div",{className:"px-1 py-1","data-test":"split-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"split-favorite-presets-grid",children:w.map(T=>t.jsxs(Q,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:L=>{L.stopPropagation(),f(T.id),R(T.config.splitMode),k(T.name,()=>{f(T.id),R(T.config.splitMode)})},title:`Apply & Execute: ${T.name}`,"data-test":"split-favorite-preset-button",children:[t.jsx(ot,{className:"h-2 w-2 mr-1"}),T.name]},T.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},{label:"Keep arrows",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:k=>r(k.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-arrows"}),t.jsx("span",{className:"text-[10px]",children:"Keep arrows"})]})},{label:"Keep match",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:a,onChange:k=>i(k.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-keep-match"}),t.jsx("span",{className:"text-[10px]",children:"Keep match"})]})},{label:"Horizontal",customRender:()=>t.jsxs("label",{className:"flex items-center gap-1.5 px-1 py-0.5 text-xs cursor-pointer hover:bg-accent rounded",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:k=>l(k.target.checked),className:"w-3 h-3 cursor-pointer","data-test":"split-config-horizontal"}),t.jsx("span",{className:"text-[10px]",children:"Horizontal"})]})},{label:"Gap",customRender:()=>t.jsxs("div",{className:"flex items-center gap-1 px-1 py-0.5",children:[t.jsx("span",{className:"text-[10px]",children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"100",value:d,onChange:k=>u(Math.max(0,parseInt(k.target.value)||15)),className:"h-5 w-12 text-[10px] px-1",onClick:k=>k.stopPropagation(),"data-test":"split-config-gap"}),t.jsx("span",{className:"text-[10px]",children:"px"})]})}]}],P={label:"Split",icon:t.jsx(bh,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("byParagraph")};return t.jsxs(t.Fragment,{children:[t.jsx("div",{id:"CanvasTextSplitButtonContainer",className:ve("flex items-center",s),"data-test":"toolbar-split-button",children:t.jsx(Je,{mainAction:P,dropdownColumns:W,variant:"outline",size:"compact",persistenceKey:"toolbar-split-button",facade:n,restoreRepeatAction:S,"data-test":"canvas-split-nodes-button"})}),t.jsx(bx,{isVisible:m,onClose:j,triggerPosition:y,currentSplitMode:"paragraph",onSplitAction:R})]})};class Ax{constructor(s,n){He(this,"namespace","canvas.textFormatting");this.hooks=s,this.storeActions=n}getActions(){return[{id:"style:bold",label:"Bold",category:"Style",icon:t.jsx(al,{className:"h-3 w-3"})},{id:"style:italic",label:"Italic",category:"Style",icon:t.jsx(rl,{className:"h-3 w-3"})},{id:"style:strikethrough",label:"Strikethrough",category:"Style",icon:t.jsx(il,{className:"h-3 w-3"})},{id:"heading:h1",label:"Heading 1",category:"Headings",icon:t.jsx(cl,{className:"h-3 w-3"})},{id:"heading:h2",label:"Heading 2",category:"Headings",icon:t.jsx(ll,{className:"h-3 w-3"})},{id:"heading:h3",label:"Heading 3",category:"Headings",icon:t.jsx(dl,{className:"h-3 w-3"})},{id:"list:bullet",label:"Bullet list",category:"Lists",icon:t.jsx(ur,{className:"h-3 w-3"})},{id:"list:numbered",label:"Numbered list",category:"Lists",icon:t.jsx(On,{className:"h-3 w-3"})},{id:"list:indent",label:"Indent",category:"Lists",icon:t.jsx(ul,{className:"h-3 w-3"})},{id:"list:outdent",label:"Outdent",category:"Lists",icon:t.jsx(hl,{className:"h-3 w-3"})}]}getConfig(){return{firstLineOnly:this.storeActions.getFirstLineOnly()}}setConfig(s){s.firstLineOnly!==void 0&&this.storeActions.setFirstLineOnly(s.firstLineOnly)}execute(s,n){switch(s){case"style:bold":this.hooks.applyBold();break;case"style:italic":this.hooks.applyItalic();break;case"style:strikethrough":this.hooks.applyStrikethrough();break;case"heading:h1":this.hooks.applyH1();break;case"heading:h2":this.hooks.applyH2();break;case"heading:h3":this.hooks.applyH3();break;case"list:bullet":this.hooks.applyUnorderedList();break;case"list:numbered":this.hooks.applyOrderedList();break;case"list:indent":this.hooks.applyIndent();break;case"list:outdent":this.hooks.applyOutdent();break;case"style:fontSize:small":this.hooks.applyFontSize("small");break;case"style:fontSize:normal":this.hooks.applyFontSize("normal");break;case"style:fontSize:large":this.hooks.applyFontSize("large");break;case"style:fontSize:xlarge":this.hooks.applyFontSize("xlarge");break;default:console.warn(`TextFormattingFacade: Unknown action "${s}"`)}}}function Ia(e,s,n,o,r){const a=e.substring(0,s),i=e.substring(s,n),c=e.substring(n),l=o.length,d=r.length;return s>=l&&a.endsWith(o)&&c.startsWith(r)?{newText:a.substring(0,a.length-l)+i+c.substring(d),newStart:s-l,newEnd:n-l}:{newText:a+o+i+r+c,newStart:s+l,newEnd:n+l}}function Ix(e,s,n){const o=s==="1. "&&n!==void 0?`${n}. `:s;if(s==="1. "){const i=e.match(/^\d+\.\s/);if(i)return e.substring(i[0].length)}else if(e.startsWith(s))return e.substring(s.length);const r=e.match(/^(#{1,3}\s)/);if(r&&s.startsWith("#"))return o+e.substring(r[1].length);const a=e.match(/^(\s*[-*]\s|\s*\d+\.\s)/);return a&&(s==="- "||s.match(/^\d+\.\s/))?o+e.substring(a[1].length):o+e}function gn(e,s,n,o=!1){const r=e.split(`
`);if(o){const h=n==="1. ",g=r.every(w=>h?/^\d+\.\s/.test(w):w.startsWith(n));return{newText:r.map((w,m)=>{if(g){if(h){const x=w.match(/^\d+\.\s/);return x?w.substring(x[0].length):w}return w.startsWith(n)?w.substring(n.length):w}return Ix(w,n,h?m+1:void 0)}).join(`
`),newCursorPos:0}}let a=0,i=0;for(let h=0;h<r.length;h++){if(a+r[h].length>=s){i=h;break}a+=r[h].length+1}const c=r[i],l=a;if(c.startsWith(n)){r[i]=c.substring(n.length);const h=Math.max(l,s-n.length);return{newText:r.join(`
`),newCursorPos:h}}const d=c.match(/^(#{1,3}\s)/);if(d&&n.startsWith("#")){r[i]=n+c.substring(d[1].length);const h=n.length-d[1].length;return{newText:r.join(`
`),newCursorPos:s+h}}const u=c.match(/^(\s*[-*]\s|\s*\d+\.\s)/);if(u&&(n==="- "||n.match(/^\d+\.\s/))){r[i]=n+c.substring(u[1].length);const h=n.length-u[1].length;return{newText:r.join(`
`),newCursorPos:s+h}}return r[i]=n+c,{newText:r.join(`
`),newCursorPos:s+n.length}}function Tx(e,s){if(s)return"  "+e;{let n=0;for(let o=0;o<Math.min(2,e.length)&&e[o]===" ";o++)n++;return n>0?e.substring(n):e}}function Fi(e,s,n,o=!1){const r=e.split(`
`);if(o)return{newText:r.map(d=>Tx(d,n)).join(`
`),newCursorPos:0};let a=0,i=0;for(let l=0;l<r.length;l++){if(a+r[l].length>=s){i=l;break}a+=r[l].length+1}const c=r[i];if(n)return r[i]="  "+c,{newText:r.join(`
`),newCursorPos:s+2};{let l=0;for(let d=0;d<Math.min(2,c.length)&&c[d]===" ";d++)l++;return l>0?(r[i]=c.substring(l),{newText:r.join(`
`),newCursorPos:Math.max(a,s-l)}):{newText:e,newCursorPos:s}}}const Ex=(e=!0)=>{const{fitNodeDimensions:s}=an(),n=p.useCallback(r=>{const a=E.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length!==1){console.warn("useTextFormatting: Expected exactly one selected node");return}const l=c[0],d=typeof l.content=="string"?l.content:"",u=0,h=d.length,g=!e;let f;switch(r){case"bold":f=Ia(d,u,h,"**","**");break;case"italic":f=Ia(d,u,h,"_","_");break;case"strikethrough":f=Ia(d,u,h,"~~","~~");break;case"h1":{const w=gn(d,u,"# ",g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}case"h2":{const w=gn(d,u,"## ",g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}case"h3":{const w=gn(d,u,"### ",g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}case"unorderedList":{const w=gn(d,u,"- ",g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}case"orderedList":{const w=gn(d,u,"1. ",g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}case"indent":{const w=Fi(d,u,!0,g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}case"outdent":{const w=Fi(d,u,!1,g);f={newText:w.newText,newCursorPos:w.newCursorPos};break}default:return}a.updateNodeContent(l.id,f.newText),setTimeout(()=>{const w=E.getState().getNodeById(l.id);w&&s([w])},10)},[s,e]),o=p.useCallback(r=>{const a=E.getState(),i=a.projectCanvas.getActive(),c=(i==null?void 0:i.coreState.selectedNodes)??[];if(c.length===0){console.warn("useTextFormatting: No nodes selected for font size change");return}const l=be.FONT_SIZE_PRESETS[r],d=`${l}px`,u=Math.round(l*1.5),h=[];for(const g of c){const f=g.styles??{},w=g.height,m={...f,fontSize:d},x=(typeof g.content=="string"?g.content:"").replace(/\n+$/,""),y=window.getComputedStyle(document.body),v=y.fontFamily,b=`${y.fontWeight} ${l}px ${v}`,j=bs(x,b)+Ns.textNodeXPadding,R=Math.max(g.width??be.DEFAULT_NODE_WIDTH,j),C=eu(x,R,b,u)+be.NODE_Y_PADDING;h.push({type:"node:update",nodeId:g.id,from:{styles:f,height:w,width:g.width},to:{styles:m,height:C,width:R}}),a.updateNode(g.id,{styles:m,height:C,width:R})}h.length===1?a.undo.commit(h[0]):h.length>1&&a.undo.commit({type:"batch",label:`Apply ${r} font size to ${h.length} nodes`,operations:h})},[]);return{applyBold:p.useCallback(()=>n("bold"),[n]),applyItalic:p.useCallback(()=>n("italic"),[n]),applyStrikethrough:p.useCallback(()=>n("strikethrough"),[n]),applyH1:p.useCallback(()=>n("h1"),[n]),applyH2:p.useCallback(()=>n("h2"),[n]),applyH3:p.useCallback(()=>n("h3"),[n]),applyUnorderedList:p.useCallback(()=>n("unorderedList"),[n]),applyOrderedList:p.useCallback(()=>n("orderedList"),[n]),applyIndent:p.useCallback(()=>n("indent"),[n]),applyOutdent:p.useCallback(()=>n("outdent"),[n]),applyFontSize:o}};function Rx(){const[e,s]=p.useState(!1),{applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:u,applyOutdent:h,applyFontSize:g}=Ex(e),f=p.useMemo(()=>({applyBold:n,applyItalic:o,applyStrikethrough:r,applyH1:a,applyH2:i,applyH3:c,applyUnorderedList:l,applyOrderedList:d,applyIndent:u,applyOutdent:h,applyFontSize:g}),[n,o,r,a,i,c,l,d,u,h,g]),w=p.useCallback(()=>e,[e]),m=p.useMemo(()=>({getFirstLineOnly:w,setFirstLineOnly:s}),[w]),x=p.useMemo(()=>new Ax(f,m),[f,m]);return p.useEffect(()=>(it.register("textFormatting",{name:"Text Formatting",getActions:()=>x.getActions()}),rt.register("textFormatting",x),()=>{it.unregister("textFormatting"),rt.unregister("textFormatting")}),[x]),{facade:x,firstLineOnly:e,setFirstLineOnly:s}}const Mx=e=>{const{className:s}=e,{facade:n,firstLineOnly:o,setFirstLineOnly:r}=Rx(),a={icon:t.jsx(Ms,{className:"h-4 w-4"}),onClick:()=>n.execute("style:bold"),label:"Text formatting"},i=[{header:"Style",width:"120px",actions:[{label:"Bold",icon:t.jsx(al,{className:"h-3 w-3"}),onClick:()=>n.execute("style:bold")},{label:"Italic",icon:t.jsx(rl,{className:"h-3 w-3"}),onClick:()=>n.execute("style:italic")},{label:"Strikethrough",icon:t.jsx(il,{className:"h-3 w-3"}),onClick:()=>n.execute("style:strikethrough")}]},{header:"Headings",width:"120px",actions:[{label:"Heading 1",icon:t.jsx(cl,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h1")},{label:"Heading 2",icon:t.jsx(ll,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h2")},{label:"Heading 3",icon:t.jsx(dl,{className:"h-3 w-3"}),onClick:()=>n.execute("heading:h3")}]},{header:"Lists",width:"130px",actions:[{label:"Bullet list",icon:t.jsx(ur,{className:"h-3 w-3"}),onClick:()=>n.execute("list:bullet")},{label:"Numbered list",icon:t.jsx(On,{className:"h-3 w-3"}),onClick:()=>n.execute("list:numbered")},{label:"Indent",icon:t.jsx(ul,{className:"h-3 w-3"}),onClick:()=>n.execute("list:indent")},{label:"Outdent",icon:t.jsx(hl,{className:"h-3 w-3"}),onClick:()=>n.execute("list:outdent")},{label:"First line only",icon:null,customRender:()=>t.jsx("div",{className:"px-2 py-1",onPointerDown:c=>c.stopPropagation(),children:t.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:c=>r(c.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:c=>c.stopPropagation(),"data-test":"toolbar-formatting-first-line-only-checkbox"}),t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"First line only"})]})})}]},{header:"Size",width:"100px",actions:[{label:"Small",icon:t.jsx(Ms,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("style:fontSize:small")},{label:"Normal",icon:t.jsx(Ms,{className:"h-3 w-3"}),onClick:()=>n.execute("style:fontSize:normal")},{label:"Large",icon:t.jsx(Ms,{className:"h-3.5 w-3.5"}),onClick:()=>n.execute("style:fontSize:large")},{label:"X-Large",icon:t.jsx(Ms,{className:"h-4 w-4"}),onClick:()=>n.execute("style:fontSize:xlarge")}]}];return t.jsx("div",{className:ve("flex items-center",s),"data-test":"toolbar-text-formatting-button",children:t.jsx(Je,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-text-formatting",facade:n,dropdownMenuClassName:"w-auto min-w-0"})})},Ta=e=>{let s="";if(typeof e.content=="string"&&(s+=e.content+`
`),e.subContent){if(typeof e.subContent=="string")s+=e.subContent+`
`;else if(typeof e.subContent=="object"&&"lines"in e.subContent){const{lines:n}=e.subContent;typeof n=="string"?s+=n+`
`:Array.isArray(n)&&n.forEach(o=>{typeof o=="string"?s+=o+`
`:o&&Array.isArray(o.words)&&(s+=o.words.join(" ")+`
`)})}}return s.trim()},Px=e=>{const{className:s,variant:n}=e,o=E.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.selectedNodes)??[],i=o.addNode,c=o.setNodeToFocusId,l=async(m,x)=>{if(a.length===0){console.log(`AI ${m}: No nodes selected.`);return}let y=a.map(Ta).join(`

---

`);if(x&&(y=`${x}:

${y}`),!y.trim()){console.log(`AI ${m}: Selected nodes have no text content.`);return}console.log(`AI ${m} - Prompt:`,y);try{const v=await tu.generateCompletion(y,void 0,{stream:!1});console.log(`AI ${m} - Response:`,v);const N=v==null?void 0:v.response;if(typeof N=="string"&&N.trim()){let b={x:100,y:100};if(a.length>0){const R=a[0];b={x:R.x,y:R.y+(R.height??be.DEFAULT_NODE_HEIGHT)+be.nodeSpacing}}const j=Le.buildTextNode(b,N);i(j),c(j.id),console.log(`AI ${m}: Created new node ${j.id} with AI response.`)}else(typeof N!="string"||!N.trim())&&console.log(`AI ${m}: Received empty or invalid response from AI.`)}catch(v){console.error(`AI ${m} - Error:`,v)}},d=()=>{l("Generate Text","Continue writing based on the following text")},u=()=>{l("Summarize Selection","Summarize the following text")},h=()=>{l("Ask Question","Based on the following, answer any implied questions or provide information")},g=async()=>{if(a.length===0){console.log("Translate to VN: No nodes selected.");return}const m=a.map(Ta).join(`

`);if(!m.trim()){console.log("Translate to VN: Selected nodes have no text content.");return}console.log("Translate to VN - Input:",m);try{const x=await Zr(m,"English","Vietnamese");console.log("Translate to VN - Response:",x);const y=x.output;if(y!=null&&y.trim()){let v={x:100,y:100};if(a.length>0){const b=a[0];v={x:b.x,y:b.y+(b.height??be.DEFAULT_NODE_HEIGHT)+be.nodeSpacing}}const N=Le.buildTextNode(v,y);i(N),c(N.id),console.log(`Translate to VN: Created new node ${N.id} with Vietnamese translation.`)}else console.log("Translate to VN: Received empty translation.")}catch(x){console.error("Translate to VN - Error:",x)}},f=async()=>{if(a.length===0){console.log("Translate to EN: No nodes selected.");return}const m=a.map(Ta).join(`

`);if(!m.trim()){console.log("Translate to EN: Selected nodes have no text content.");return}console.log("Translate to EN - Input:",m);try{const x=await Zr(m,"Vietnamese","English");console.log("Translate to EN - Response:",x);const y=x.output;if(y!=null&&y.trim()){let v={x:100,y:100};if(a.length>0){const b=a[0];v={x:b.x,y:b.y+(b.height??be.DEFAULT_NODE_HEIGHT)+be.nodeSpacing}}const N=Le.buildTextNode(v,y);i(N),c(N.id),console.log(`Translate to EN: Created new node ${N.id} with English translation.`)}else console.log("Translate to EN: Received empty translation.")}catch(x){console.error("Translate to EN - Error:",x)}},w=[{label:"Generate Text",icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Summarize",icon:t.jsx(Nh,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Ask Question",icon:t.jsx(ir,{className:"h-2.5 w-2.5"}),onClick:h},{label:"Translate to VN",icon:t.jsx(Yr,{className:"h-2.5 w-2.5"}),onClick:g},{label:"Translate to EN",icon:t.jsx(Yr,{className:"h-2.5 w-2.5"}),onClick:f}];return t.jsx("div",{id:"ToolbarAi",className:je("ToolbarAi",s),"data-test":"toolbar-ai-button",children:t.jsx(Je,{size:"compact",variant:n??"secondary",mainAction:{icon:t.jsx(Dn,{className:"h-2.5 w-2.5"}),onClick:()=>{console.log("Main AI Action clicked")},text:"AI",label:"Trigger AI actions"},dropdownActions:w,dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})};class Dx{constructor(s){He(this,"namespace","canvas.fitWidth");this.hooks=s}getActions(){return[{id:"width:350",label:"Set width to 350px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"width:550",label:"Set width to 550px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"width:700",label:"Set width to 700px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"width:850",label:"Set width to 850px",category:"Width",icon:t.jsx($t,{className:"h-3 w-3"})},{id:"fit:dimensions",label:"Fit node dimensions",category:"Fit",icon:t.jsx(ws,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"width:350":this.hooks.setWidth350();break;case"width:550":this.hooks.setWidth550();break;case"width:700":this.hooks.setWidth700();break;case"width:850":this.hooks.setWidth850();break;case"fit:dimensions":this.hooks.fitDimensions();break;default:console.warn(`FitWidthFacade: Unknown action "${s}"`)}}}function Ox(){const{setFixedWidth:e,fitNodeDimensions:s}=an(),n=p.useCallback(()=>e(350),[e]),o=p.useCallback(()=>e(550),[e]),r=p.useCallback(()=>e(700),[e]),a=p.useCallback(()=>e(850),[e]),i=p.useCallback(()=>s(),[s]),c=p.useMemo(()=>({setWidth350:n,setWidth550:o,setWidth700:r,setWidth850:a,fitDimensions:i}),[n,o,r,a,i]),l=p.useMemo(()=>new Dx(c),[c]);return p.useEffect(()=>(it.register("fitWidth",{name:"Fit Width",getActions:()=>l.getActions()}),rt.register("fitWidth",l),()=>{it.unregister("fitWidth"),rt.unregister("fitWidth")}),[l]),l}const Lx=()=>{const{selectedNodes:e}=an(),s=Ox(),n=e.length===0,o=[{label:"Set width to 350px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:350"),disabled:n},{label:"Set width to 550px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:550"),disabled:n},{label:"Set width to 700px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:700"),disabled:n},{label:"Set width to 850px",icon:t.jsx($t,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("width:850"),disabled:n},{label:"Fit node dimensions",icon:t.jsx(ws,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("fit:dimensions"),disabled:n}],r=o[0];return t.jsx(Je,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"canvas-fit-width",facade:s,"data-test":"canvas-fit-width-button"})},Gt=50,ed=()=>{const s=E.getState().projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=p.useCallback((g,f)=>{const w=E.getState(),m=w.projectCanvas.getActive(),x=(m==null?void 0:m.coreState.selectedNodes)??[],y=(m==null?void 0:m.coreState.nodes)??{},v=w.updateNode;if(x.length!==1){console.warn("useNodePusher: Exactly one node must be selected to push/pull other nodes.");return}const N=x[0],b=[],j=Object.values(y),R=f==="pull"?g==="up"?"down":g==="down"?"up":g==="left"?"right":"left":g;j.forEach(S=>{if(S.id===N.id)return;let C=!1;const M={id:S.id};switch(R){case"down":S.y>=N.y+(N.height??0)&&(M.y=S.y+(f==="push"?Gt:-Gt),C=!0);break;case"up":S.y+(S.height??0)<=(N.y??0)&&(M.y=S.y+(f==="push"?-Gt:Gt),C=!0);break;case"right":S.x>=N.x+(N.width??0)&&(M.x=S.x+(f==="push"?Gt:-Gt),C=!0);break;case"left":S.x+(S.width??0)<=N.x&&(M.x=S.x+(f==="push"?-Gt:Gt),C=!0);break}C&&b.push(M)}),b.length>0?(b.forEach(S=>v(S.id,S)),console.log(`${f==="push"?"Pushed":"Pulled"} ${b.length} nodes ${g} by ${Gt}px.`)):console.warn(`No nodes found to ${f} ${g}.`)},[]),r=p.useCallback(()=>o("down","push"),[o]),a=p.useCallback(()=>o("up","push"),[o]),i=p.useCallback(()=>o("left","push"),[o]),c=p.useCallback(()=>o("right","push"),[o]),l=p.useCallback(()=>o("down","pull"),[o]),d=p.useCallback(()=>o("up","pull"),[o]),u=p.useCallback(()=>o("left","pull"),[o]),h=p.useCallback(()=>o("right","pull"),[o]);return{pushNodesDown:r,pushNodesUp:a,pushNodesLeft:i,pushNodesRight:c,pullNodesDown:l,pullNodesUp:d,pullNodesLeft:u,pullNodesRight:h,selectedNodes:n}};class Wx{constructor(s){He(this,"namespace","canvas.nodeOperations");this.hooks=s}getActions(){return[{id:"push:up",label:"Push up",category:"Push",icon:t.jsx(Ln,{className:"h-3 w-3"})},{id:"push:down",label:"Push down",category:"Push",icon:t.jsx(Wn,{className:"h-3 w-3"})},{id:"push:left",label:"Push left",category:"Push",icon:t.jsx(Xs,{className:"h-3 w-3"})},{id:"push:right",label:"Push right",category:"Push",icon:t.jsx(_t,{className:"h-3 w-3"})},{id:"pull:up",label:"Pull up",category:"Pull",icon:t.jsx(Ln,{className:"h-3 w-3"})},{id:"pull:down",label:"Pull down",category:"Pull",icon:t.jsx(Wn,{className:"h-3 w-3"})},{id:"pull:left",label:"Pull left",category:"Pull",icon:t.jsx(Xs,{className:"h-3 w-3"})},{id:"pull:right",label:"Pull right",category:"Pull",icon:t.jsx(_t,{className:"h-3 w-3"})},{id:"join:newline",label:"Join with newline",category:"Join",icon:t.jsx(lr,{className:"h-3 w-3"})},{id:"join:space",label:"Join with space",category:"Join",icon:t.jsx(Xo,{className:"h-3 w-3"})},{id:"lines:remove-extra",label:"Remove extra lines",category:"Lines",icon:t.jsx(Ha,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"push:up":this.hooks.pushUp();break;case"push:down":this.hooks.pushDown();break;case"push:left":this.hooks.pushLeft();break;case"push:right":this.hooks.pushRight();break;case"pull:up":this.hooks.pullUp();break;case"pull:down":this.hooks.pullDown();break;case"pull:left":this.hooks.pullLeft();break;case"pull:right":this.hooks.pullRight();break;case"join:newline":this.hooks.joinWithNewline();break;case"join:space":this.hooks.joinWithSpace();break;case"lines:remove-extra":this.hooks.removeExtraLines();break;default:console.warn(`NodeOperationsFacade: Unknown action "${s}"`)}}}const td=()=>{const e=E.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=(s==null?void 0:s.coreState.arrows)??[];e.addNode,e.deleteSelectedNodes;const r=e.deleteNodeById,a=e.setSelectedNodes,i=e.updateNodes,c=e.arrow.setAll,l=p.useCallback(h=>{if(n.length<2){console.warn("useNodeJoiner: At least two nodes must be selected to join.");return}const g=[...n].sort((N,b)=>N.y<b.y?-1:N.y>b.y?1:N.x<b.x?-1:N.x>b.x?1:0),f=g[0],w=g.slice(1),m=g.reduce((N,b)=>(b.width??0)>(N.width??0)?b:N,g[0]),x=g.map(N=>typeof N.content=="string"?N.content.trim():"").filter(N=>N.length>0).join(h);if(x.length===0&&g.every(N=>!(typeof N.content=="string"&&N.content.trim()))){console.warn("useNodeJoiner: All selected nodes have empty content. No node created.");return}const y=m.width??be.DEFAULT_NODE_WIDTH,v=mt(x,y,f);i([{id:f.id,content:x,width:m.width,height:v}]);{const N=new Set(w.map(R=>R.id)),j=o.map(R=>{const S=R.startNodeId&&N.has(R.startNodeId),C=R.endNodeId&&N.has(R.endNodeId);return S&&C||S&&R.endNodeId===f.id||C&&R.startNodeId===f.id?null:S||C?{...R,startNodeId:S?f.id:R.startNodeId,endNodeId:C?f.id:R.endNodeId}:R}).filter(R=>R!==null).filter((R,S,C)=>R?S===C.findIndex(M=>M&&M.startNodeId===R.startNodeId&&M.endNodeId===R.endNodeId):!1);c(j)}w.forEach(N=>{r(N.id)}),a([f]),console.log("Nodes joined into first node:",f.id)},[n,o,i,r,a,c]),d=p.useCallback(()=>{l(" ")},[l]),u=p.useCallback(()=>{l(`
`)},[l]);return{joinNodes:d,joinNodesWithNewline:u,selectedNodes:n}},Hx=()=>{const e=E.getState(),s=e.projectCanvas.getActive(),n=(s==null?void 0:s.coreState.selectedNodes)??[],o=e.updateNode;return{removeExtraNewLines:p.useCallback(()=>{if(n.length!==1){console.warn("useNodeLineManipulation: Exactly one node must be selected.");return}const a=n[0];if(!a.content||typeof a.content!="string"){console.warn("useNodeLineManipulation: Selected node has no content to modify.");return}const i=a.content.replace(/\n\n+/g,`
`);if(i===a.content){console.warn("useNodeLineManipulation: No extra new lines found. Node content not changed.");return}const c=mt(i,a.width??0,a),l={id:a.id,content:i,height:c};o(l.id,l),console.log("Action: Removed extra new lines from node content.")},[n,o])}};function br(){const{pushNodesUp:e,pushNodesDown:s,pushNodesLeft:n,pushNodesRight:o,pullNodesUp:r,pullNodesDown:a,pullNodesLeft:i,pullNodesRight:c}=ed(),{joinNodes:l,joinNodesWithNewline:d}=td(),{removeExtraNewLines:u}=Hx(),h=p.useMemo(()=>({pushUp:e,pushDown:s,pushLeft:n,pushRight:o,pullUp:r,pullDown:a,pullLeft:i,pullRight:c,joinWithNewline:d,joinWithSpace:l,removeExtraLines:u}),[e,s,n,o,r,a,i,c,d,l,u]),g=p.useMemo(()=>new Wx(h),[h]);return p.useEffect(()=>(it.register("nodeOperations",{name:"Node Operations",getActions:()=>g.getActions()}),rt.register("nodeOperations",g),()=>{it.unregister("nodeOperations"),rt.unregister("nodeOperations")}),[g]),g}const Bx=e=>{const{className:s}=e,{selectedNodes:n}=ed(),o=br(),r=n.length!==1,a={icon:t.jsx(Sh,{className:"h-4 w-4"}),onClick:()=>o.execute("push:down"),label:"Push/Pull nodes",disabled:r},i=[{header:"Push",actions:[{label:"Push Up",icon:t.jsx(Ln,{className:"h-3 w-3"}),onClick:()=>o.execute("push:up"),disabled:r},{label:"Push Down",icon:t.jsx(Wn,{className:"h-3 w-3"}),onClick:()=>o.execute("push:down"),disabled:r},{label:"Push Left",icon:t.jsx(Xs,{className:"h-3 w-3"}),onClick:()=>o.execute("push:left"),disabled:r},{label:"Push Right",icon:t.jsx(_t,{className:"h-3 w-3"}),onClick:()=>o.execute("push:right"),disabled:r}]},{header:"Pull",actions:[{label:"Pull Up",icon:t.jsx(Ln,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:up"),disabled:r},{label:"Pull Down",icon:t.jsx(Wn,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:down"),disabled:r},{label:"Pull Left",icon:t.jsx(Xs,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:left"),disabled:r},{label:"Pull Right",icon:t.jsx(_t,{className:"h-3 w-3"}),onClick:()=>o.execute("pull:right"),disabled:r}]}];return t.jsx("div",{id:"PushNodesButtonContainer",className:ve("flex items-center",s),"data-test":"toolbar-push-pull-nodes-button",children:t.jsx(Je,{mainAction:a,dropdownColumns:i,variant:"outline",size:"compact",persistenceKey:"toolbar-push-nodes",facade:o,dropdownMenuClassName:"w-auto min-w-0"})})},Fx=()=>{const{selectedNodes:e}=td(),s=br(),n=e.length<2,o=[{label:"Join with newline",icon:t.jsx(lr,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:newline"),disabled:n},{label:"Join with space",icon:t.jsx(Xo,{className:"h-2.5 w-2.5"}),onClick:()=>s.execute("join:space"),disabled:n}],r={...o[0]};return t.jsx(Je,{mainAction:r,dropdownActions:o,variant:"outline",size:"compact",persistenceKey:"toolbar-join-nodes",facade:s,"data-test":"canvas-join-nodes-button"})},ta=[{name:"Red",value:"#ef4444",twClass:"bg-red-500"},{name:"Orange",value:"#f97316",twClass:"bg-orange-500"},{name:"Yellow",value:"#eab308",twClass:"bg-yellow-500"},{name:"Green",value:"#22c55e",twClass:"bg-green-500"},{name:"Teal",value:"#14b8a6",twClass:"bg-teal-500"},{name:"Cyan",value:"#06b6d4",twClass:"bg-cyan-500"},{name:"Blue",value:"#3b82f6",twClass:"bg-blue-500"},{name:"Violet",value:"#8b5cf6",twClass:"bg-violet-500"},{name:"Purple",value:"#a855f7",twClass:"bg-purple-500"},{name:"Pink",value:"#ec4899",twClass:"bg-pink-500"},{name:"White",value:"#ffffff",twClass:"bg-white"},{name:"Border",value:"hsl(240 5.9% 90%)",twClass:"bg-border"},{name:"Muted",value:"hsl(var(--muted-light))",twClass:"bg-muted"},{name:"Black",value:"#000000",twClass:"bg-black"},{name:"Transparent",value:"transparent",twClass:"bg-transparent border-dashed border-neutral-400"}],sa=e=>{if(e.startsWith("hsl(")){const s=/hsl\(\s*(\d+)\s*,\s*(\d+%)\s*,\s*(\d+%)\s*\)/.exec(e);if(s){const n=parseInt(s[1]),o=parseInt(s[2])/100,r=parseInt(s[3])/100;if(o===0){const d=Math.round(r*255).toString(16).padStart(2,"0");return`#${d}${d}${d}`}const a=d=>(d+n/30)%12,i=o*Math.min(r,1-r),c=d=>r-i*Math.max(-1,Math.min(a(d)-3,Math.min(9-a(d),1))),l=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${l(c(0))}${l(c(8))}${l(c(4))}`}}return console.warn(`convertHslToHex: Could not convert HSL string "${e}" to HEX. Returning as is or black.`),e.startsWith("#")?e:"#000000"},$x=({currentColor:e,onColorSelect:s,currentBorderWidth:n,onBorderWidthChange:o})=>{const[r,a]=p.useState(e),[i,c]=p.useState(n);p.useEffect(()=>{a(e)},[e]),p.useEffect(()=>{c(n)},[n]);const l=u=>{a(u),s(u)},d=u=>{const h=parseInt(u.target.value,10);isNaN(h)||(c(h),o(h))};return t.jsxs("div",{className:"p-2 grid grid-cols-5 gap-2 bg-popover rounded-md shadow-md",children:[ta.map(u=>t.jsx("button",{type:"button",title:u.name,onClick:()=>l(u.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",u.twClass,u.value===r?"ring-2 ring-ring ring-offset-2":"border-muted ring-0",u.value==="white"&&"border-neutral-300"),style:u.value.startsWith("hsl(")?{backgroundColor:u.value}:{},"aria-label":`Select color ${u.name}`,"data-test":"color-picker-option"},u.value)),t.jsx("input",{type:"color",value:r.startsWith("hsl")?sa(r):r,onChange:u=>l(u.target.value),className:"mt-2 w-full col-span-5 h-8 bg-secondary","data-test":"color-picker-custom-color-input"}),t.jsxs("div",{className:"mt-3 pt-3 border-t border-border col-span-5",children:[t.jsx("label",{htmlFor:"border-width-input",className:"block text-sm font-medium text-foreground mb-1",children:"Border Width"}),t.jsx("input",{type:"number",id:"border-width-input",value:i,onChange:d,min:"0",max:"50",className:"mt-1 w-full col-span-5 h-8 p-2 rounded-md border border-input bg-background text-foreground focus:ring-ring focus:border-ring","data-test":"color-picker-border-width-input"})]})]})},zx=()=>{var R,S,C,M;const e=z(I=>I.updateNode),s=z(I=>{var A;return((A=I.projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes)??[]}),[n,o]=p.useState(!1),[r,a]=p.useState("hsl(var(--primary))"),[i,c]=p.useState("1px"),[l,d]=p.useState("solid"),u=E.getState().getLastUsedBorder(),h=u.lastUsedColor,g=u.lastUsedWidth,f=u.lastUsedStyle;p.useEffect(()=>{if(s.length===1){const A=s[0].styles,O=(A==null?void 0:A.borderColor)||"hsl(var(--primary))",F=(A==null?void 0:A.borderWidth)||"1px",B=(A==null?void 0:A.borderStyle)||"solid";a(O),c(F),d(B)}else s.length===0&&(a("hsl(var(--primary))"),c("1px"),d("solid"))},[s]);const w=(I,A,O)=>{s.forEach(F=>{const B={...F.styles,borderWidth:I,borderStyle:A,borderColor:O};I===void 0&&A===void 0&&O===void 0&&(B.border=void 0);const W={styles:B};e(F.id,W)})},m=()=>{w(g,f,h)},x=I=>{w(i,l,I),a(I),E.getState().setLastUsedBorder(I,i,l),E.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},y=I=>{const A=`${I}px`;w(A,l,r),c(A),E.getState().setLastUsedBorder(r,A,l),E.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},v=()=>{c(void 0),d(void 0),a(void 0),w(void 0,void 0,void 0)},N=[{label:"Apply last used border color",icon:t.jsx("span",{style:{color:h==="transparent"?void 0:h,display:"inline-flex"},children:t.jsx(Kr,{className:"h-2.5 w-2.5"})}),onClick:()=>{m()},disabled:s.length===0},{label:"Set Border Color",icon:t.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:t.jsx(pl,{className:"h-2.5 w-2.5"})}),onClick:()=>{o(!0)},disabled:s.length===0},{label:"Remove Border",icon:t.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:()=>{v()},disabled:s.length===0||!((S=(R=s[0])==null?void 0:R.styles)!=null&&S.borderWidth)&&!((M=(C=s[0])==null?void 0:C.styles)!=null&&M.border)}],b={...N[0],icon:t.jsx("span",{style:{color:r==="transparent"?void 0:r,display:"inline-flex"},children:t.jsx(Kr,{className:"h-2.5 w-2.5"})})},j=I=>{if(!I)return 1;const A=parseInt(I,10);return isNaN(A)?1:A};return t.jsxs(ht,{open:n,onOpenChange:o,children:[t.jsx(pt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"canvas-border-width-button",children:t.jsx(Je,{mainAction:b,dropdownActions:N,variant:"outline",size:"compact",persistenceKey:"canvas-border-width"})})}),t.jsx(gt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:I=>I.preventDefault(),"data-test":"canvas-border-width-popover",children:t.jsx($x,{currentColor:r,onColorSelect:x,currentBorderWidth:j(i),onBorderWidthChange:y})})]})},_x=e=>{const{className:s}=e,n=br(),o={icon:t.jsx(Ha,{}),onClick:()=>n.execute("lines:remove-extra"),label:"Remove extra new lines"},r=[{label:"Remove extra new lines",icon:t.jsx(Ha,{className:"h-2.5 w-2.5"}),onClick:()=>n.execute("lines:remove-extra")}];return t.jsx("div",{id:"ToolbarLinesButtonContainer",className:ve("flex items-center",s),"data-test":"toolbar-lines-button",children:t.jsx(Je,{mainAction:o,dropdownActions:r,variant:"outline",size:"compact",persistenceKey:"toolbar-lines",facade:n})})},Vx=e=>{const{className:s,...n}=e,o=()=>{var i;const r=E.getState();(((i=r.projectCanvas.getActive())==null?void 0:i.coreState.selectedNodes)??[]).length>0&&r.deleteSelectedNodes()};return t.jsx(rn,{id:"ToolbarDeleteNodesButton",className:s,type:"button",onClick:o,"data-test":"toolbar-delete-nodes-button",...n,children:t.jsx(yt,{className:"h-2.5 w-2.5"})})};class Ux{constructor(s){He(this,"namespace","canvas.alignment");this.hooks=s}getActions(){return[{id:"node:left",label:"Align left",category:"Node",icon:t.jsx(Hn,{className:"h-3 w-3"})},{id:"node:right",label:"Align right",category:"Node",icon:t.jsx(Bn,{className:"h-3 w-3"})},{id:"node:top",label:"Align top",category:"Node",icon:t.jsx(hr,{className:"h-3 w-3"})},{id:"node:bottom",label:"Align bottom",category:"Node",icon:t.jsx(pr,{className:"h-3 w-3"})},{id:"text:left",label:"Text left",category:"Text",icon:t.jsx(Hn,{className:"h-3 w-3"})},{id:"text:center",label:"Text center",category:"Text",icon:t.jsx(gl,{className:"h-3 w-3"})},{id:"text:right",label:"Text right",category:"Text",icon:t.jsx(Bn,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"node:left":this.hooks.alignNodesLeft();break;case"node:right":this.hooks.alignNodesRight();break;case"node:top":this.hooks.alignNodesTop();break;case"node:bottom":this.hooks.alignNodesBottom();break;case"text:left":this.hooks.alignTextLeft();break;case"text:center":this.hooks.alignTextCenter();break;case"text:right":this.hooks.alignTextRight();break;default:console.warn(`AlignmentFacade: Unknown action "${s}"`)}}}const Gx=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.y??0)-(c.y??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.y??0,l=i.height??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},Yx=e=>{if(!e||e.length===0)return[];const s=[...e].sort((i,c)=>(i.x??0)-(c.x??0)),n=[];let o=[],r=0,a=0;for(const i of s){const c=i.x??0,l=i.width??0;if(o.length===0){o.push(i),r=c,a=c+l;continue}c>=r&&c<=a?(o.push(i),a=Math.max(a,c+l)):(n.push(o),o=[i],r=c,a=c+l)}return o.length>0&&n.push(o),n},Kx=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="left"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.x??0)-(i.x??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.x??0)+(i.width??0);if((c.x??0)<l+n){const u=l+n;o.set(c.id,{x:u}),r[a]={...c,x:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.x??0)+(a.width??0);return(i.x??0)+(i.width??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.x??0;if((c.x??0)+(c.width??0)>l-n){const u=l-n-(c.width??0);o.set(c.id,{x:u}),r[a]={...c,x:u}}}}return o},Xx=(e,s,n)=>{const o=new Map;if(!e||e.length===0)return o;if(s==="top"){const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const c=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(c!==0)return c}return(a.y??0)-(i.y??0)});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=(i.y??0)+(i.height??0);if((c.y??0)<l+n){const u=l+n;o.set(c.id,{y:u}),r[a]={...c,y:u}}}}else{const r=[...e].sort((a,i)=>{if(a.createdAt&&i.createdAt){const d=new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime();if(d!==0)return d}const c=(a.y??0)+(a.height??0);return(i.y??0)+(i.height??0)-c});for(let a=1;a<r.length;a++){const i=r[a-1],c=r[a],l=i.y??0;if((c.y??0)+(c.height??0)>l-n){const u=l-n-(c.height??0);o.set(c.id,{y:u}),r[a]={...c,y:u}}}}return o};function qx(){const e=p.useCallback(r=>{var g;const a=E.getState(),i=((g=a.projectCanvas.getActive())==null?void 0:g.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.filter(f=>typeof f.x=="number"&&typeof f.y=="number"&&typeof f.width=="number"&&typeof f.height=="number");if(c.length===0)return;const l=r==="left"||r==="right"?Gx(c):Yx(c);let d;switch(r){case"left":d=Math.min(...c.map(f=>f.x));break;case"right":d=Math.max(...c.map(f=>(f.x??0)+(f.width??0)));break;case"top":d=Math.min(...c.map(f=>f.y));break;case"bottom":d=Math.max(...c.map(f=>(f.y??0)+(f.height??0)));break;default:return}const u=new Map;for(const f of c)switch(r){case"left":u.set(f.id,{x:d});break;case"right":u.set(f.id,{x:d-(f.width??0)});break;case"top":u.set(f.id,{y:d});break;case"bottom":u.set(f.id,{y:d-(f.height??0)});break}const h=be.NODE_ALIGNMENT_PADDING;for(const f of l){const w=f.map(x=>{const y=u.get(x.id);return y?{...x,...y}:x});(r==="left"||r==="right"?Kx(w,r,h):Xx(w,r,h)).forEach((x,y)=>{const v=u.get(y)||{};u.set(y,{...v,...x})})}u.forEach((f,w)=>{a.updateNode(w,f)})},[]),s=p.useCallback(r=>{var l;const a=E.getState(),i=((l=a.projectCanvas.getActive())==null?void 0:l.coreState.selectedNodes)??[];if(i.length===0)return;const c=i.map(d=>({...d,id:d.id,styles:{...d.styles,textAlign:r}}));a.updateNodes(c)},[]),n=p.useMemo(()=>({alignNodesLeft:()=>e("left"),alignNodesRight:()=>e("right"),alignNodesTop:()=>e("top"),alignNodesBottom:()=>e("bottom"),alignTextLeft:()=>s("left"),alignTextCenter:()=>s("center"),alignTextRight:()=>s("right")}),[e,s]),o=p.useMemo(()=>new Ux(n),[n]);return p.useEffect(()=>(it.register("alignment",{name:"Alignment",getActions:()=>o.getActions()}),rt.register("alignment",o),()=>{it.unregister("alignment"),rt.unregister("alignment")}),[o]),o}const Ea={left:t.jsx(Hn,{className:"h-3 w-3"}),right:t.jsx(Bn,{className:"h-3 w-3"}),top:t.jsx(hr,{className:"h-3 w-3"}),bottom:t.jsx(pr,{className:"h-3 w-3"})},$i={left:t.jsx(Hn,{className:"h-3 w-3"}),center:t.jsx(gl,{className:"h-3 w-3"}),right:t.jsx(Bn,{className:"h-3 w-3"})},Zx=e=>{const{className:s,value:n,defaultValue:o="left",onAlignmentChange:r,textAlignValue:a,defaultTextAlignValue:i="left",onTextAlignmentChange:c}=e,l=qx(),[d,u]=p.useState(n??o),[h,g]=p.useState(a??i);p.useEffect(()=>{n!==void 0&&u(n)},[n]),p.useEffect(()=>{a!==void 0&&g(a)},[a]);const f=y=>{r==null||r(y),u(y),l.execute(`node:${y}`)},w=y=>{c==null||c(y),g(y),l.execute(`text:${y}`)},m={icon:t.jsx(t.Fragment,{children:Ea[d]}),onClick:()=>f(d),label:`Align nodes ${d}`,text:""},x=[{header:"Node",width:"100px",actions:Object.keys(Ea).map(y=>({label:`Node ${y}`,icon:Ea[y],onClick:()=>f(y)}))},{header:"Text",width:"100px",actions:Object.keys($i).map(y=>({label:`Text ${y}`,icon:$i[y],onClick:()=>w(y)}))}];return t.jsx("div",{id:"ToolbarNodesAlignmentButton",className:ve("flex items-center",s),"data-test":"toolbar-nodes-alignment-button",children:t.jsx(Je,{mainAction:m,dropdownColumns:x,variant:"outline",size:"compact",persistenceKey:"toolbar-alignment",facade:l,dropdownMenuClassName:"w-auto min-w-0"})})};function Nr({nodeGap:e,gridColumns:s,gridRows:n,onNodeGapChange:o,onGridColumnsChange:r,onGridRowsChange:a,showFavorites:i=!1,isGapFavorite:c=!1,isColumnsFavorite:l=!1,isRowsFavorite:d=!1,onToggleGapFavorite:u,onToggleColumnsFavorite:h,onToggleRowsFavorite:g,compact:f=!1,showRows:w=!0,className:m}){const x=f?"h-5 w-12 text-[10px] px-1":"h-7 w-20 text-xs",y=f?"text-muted-foreground text-[10px]":"text-xs text-muted-foreground min-w-[60px]",v=f?"flex items-center gap-3":"space-y-3",N=f?"flex items-center gap-1":"flex items-center gap-2";return t.jsxs("div",{className:ve(v,m),"data-test":"arrange-config-form",children:[t.jsxs("div",{className:N,"data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:y,children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"200",value:e,onChange:b=>o(Math.max(0,Math.min(200,parseInt(b.target.value)||0))),className:x,"data-test":"arrange-config-gap-input"}),!f&&t.jsx("span",{className:"text-xs text-muted-foreground",children:"px"}),f&&t.jsx("span",{className:"text-muted-foreground text-[10px]",children:"px"}),i&&t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:u,title:c?"Remove from favorites":"Add to favorites","data-test":"arrange-config-gap-favorite-button",children:t.jsx(Fs,{className:ve("h-3.5 w-3.5",c&&"fill-yellow-400 text-yellow-400")})})]}),t.jsxs("div",{className:N,"data-test":"arrange-config-columns-row",children:[t.jsx("span",{className:y,children:"Cols:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:s,onChange:b=>r(Math.max(1,Math.min(10,parseInt(b.target.value)||3))),className:x,"data-test":"arrange-config-columns-input"}),!f&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:h,title:l?"Remove from favorites":"Add to favorites","data-test":"arrange-config-columns-favorite-button",children:t.jsx(Fs,{className:ve("h-3.5 w-3.5",l&&"fill-yellow-400 text-yellow-400")})})]}),w&&n!==void 0&&a&&t.jsxs("div",{className:N,"data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:y,children:"Rows:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:n,onChange:b=>a(Math.max(1,Math.min(10,parseInt(b.target.value)||3))),className:x,"data-test":"arrange-config-rows-input"}),!f&&t.jsx("span",{className:"text-xs text-muted-foreground invisible",children:"px"}),i&&t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-auto",onClick:g,title:d?"Remove from favorites":"Add to favorites","data-test":"arrange-config-rows-favorite-button",children:t.jsx(Fs,{className:ve("h-3.5 w-3.5",d&&"fill-yellow-400 text-yellow-400")})})]})]})}function Jx(e){if(e.length<2)return[...e];const n=e.reduce((o,r)=>o+(r.height??100),0)/e.length*.5;return[...e].sort((o,r)=>Math.abs(o.y-r.y)<n?o.x-r.x:o.y-r.y)}const Ra=Jx;function sd(e){return e.map(s=>({...s,width:s.width??100,height:s.height??31}))}function Qx(e,s){if(e.length===0)return[];if(e.length===1)return[[...e]];const n=sd(e),r=n.reduce((d,u)=>d+u.height,0)/n.length*s,a=[...e].sort((d,u)=>d.y-u.y),i=[];let c=[a[0]],l=a[0].y;for(let d=1;d<a.length;d++){const u=a[d];Math.abs(u.y-l)<=r?c.push(u):(i.push(c),c=[u],l=u.y)}return c.length>0&&i.push(c),i}function ew(e,s){if(e.length===0)return[];if(e.length===1)return[...e];const{cleanUpGap:n,rowThreshold:o}=s,r=sd(e),a=new Map;r.forEach(u=>{a.set(u.id,{width:u.width,height:u.height})});const i=Qx(e,o),l=[...i[0]].sort((u,h)=>u.x-h.x)[0].x,d=[];for(const u of i){const h=[...u].sort((m,x)=>m.x-x.x),f=h[0].y;let w=l;for(const m of h){const x=a.get(m.id);d.push({...m,x:w,y:f}),w+=x.width+n}}return d}const Ts=[];function tw(){const e=z(k=>{var T;return((T=k.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??Ts}),s=z(k=>{var T;return((T=k.projectCanvas.getActive())==null?void 0:T.coreState.nodes)??Ts}),{updateNode:n}=E.getState(),[o,r]=p.useState("content"),a=p.useRef(Ts);e.length===0?a.current=Ts:(e.length!==a.current.length||!e.every((k,T)=>{var L;return k.id===((L=a.current[T])==null?void 0:L.id)}))&&(a.current=e);const i=p.useRef(Ts);s.length===0?i.current=Ts:(s.length!==i.current.length||!s.every((k,T)=>{var L;return k.id===((L=i.current[T])==null?void 0:L.id)}))&&(i.current=s);const c=k=>{if(k)return k;const L=E.getState().projectCanvas.getActive(),H=(L==null?void 0:L.coreState.selectedNodes)??[],$=(L==null?void 0:L.coreState.nodes)??[];return H.length>=2?H:$},l=k=>{const T={timestamp:Date.now(),nodePositions:Object.fromEntries(k.map(L=>[L.id,{x:L.x,y:L.y,width:L.width,height:L.height}]))};E.getState().setArrangeSnapshot(T)},d=p.useCallback((k,T)=>{const L=c(k);if(L.length<2)return;l(L);const H=E.getState().getArrangeNodeGap(),$=[...L].sort((V,D)=>V.y-D.y);let _;T==="left"?_=Math.min(...L.map(V=>V.x)):T==="right"&&(_=Math.max(...L.map(D=>D.x+(D.width||200))));let G=$[0].y;$.forEach((V,D)=>{const Y={};D===0?G=V.y+(V.height||100)+H:(Y.y=G,G=G+(V.height||100)+H),T==="left"&&_!==void 0?Y.x=_:T==="right"&&_!==void 0&&(Y.x=_-(V.width||200)),Object.keys(Y).length>0&&n(V.id,Y)})},[n]),u=p.useCallback(k=>{d(k,"left")},[d]),h=p.useCallback(k=>{d(k,"right")},[d]),g=p.useCallback((k,T)=>{const L=c(k),H=E.getState().getArrangeNodeGap();if(L.length<2)return;l(L);const $=[...L].sort((V,D)=>V.x-D.x);let _;T==="top"?_=Math.min(...L.map(V=>V.y)):T==="bottom"&&(_=Math.max(...L.map(D=>D.y+(D.height||100))));let G=$[0].x;$.forEach((V,D)=>{const Y={},te=V.width||200;D===0?G=V.x+te+H:(Y.x=G,G=G+te+H),T==="top"&&_!==void 0?Y.y=_:T==="bottom"&&_!==void 0&&(Y.y=_-(V.height||100)),Object.keys(Y).length>0&&n(V.id,Y)})},[n]),f=p.useCallback(k=>{g(k,"top")},[g]),w=p.useCallback(k=>{g(k,"bottom")},[g]),m=(k,T)=>{const L=k.content||"";return mt(L,T,k)},x=k=>{const T=E.getState().group.createFromSelected(`[Arrange] ${k}`);T&&E.getState().addTagToNode(T,{id:De(8),title:"action:arrange"})},y=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L=E.getState().getArrangeNodeGap(),H=E.getState().getArrangeGridColumns(),$=Math.max(...T.map(ie=>ie.width??be.DEFAULT_NODE_WIDTH)),_=Ra(T),G=_[0].x,V=_[0].y,D=_.map(ie=>m(ie,$)),Y=Math.ceil(_.length/H),te=[];for(let ie=0;ie<Y;ie++){let we=0;for(let ge=0;ge<H;ge++){const X=ie*H+ge;X<D.length&&(we=Math.max(we,D[X]))}te.push(we)}_.forEach((ie,we)=>{const ge=we%H,X=Math.floor(we/H),ce=G+ge*($+L),ue=X===0?V:V+te.slice(0,X).reduce((K,U)=>K+U+L,0),ee=D[we];n(ie.id,{x:ce,y:ue,width:$,height:ee,options:{...ie.options,lockSize:!0}})}),x("Grid")},[n]),v=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L=E.getState().getArrangeNodeGap(),H=E.getState().getArrangeGridColumns(),$=Math.max(...T.map(te=>te.width??be.DEFAULT_NODE_WIDTH)),_=Ra(T),G=_[0].x,V=_[0].y,D=Array(H).fill(V),Y=_.map(te=>m(te,$));_.forEach((te,ie)=>{const we=D.indexOf(Math.min(...D)),ge=G+we*($+L),X=D[we],ce=Y[ie];n(te.id,{x:ge,y:X,width:$,height:ce,options:{...te.options,lockSize:!0}}),D[we]=X+ce+L}),x("Masonry")},[n]),N=(k,T)=>{switch(T){case"content":return String(k.content??"").toLowerCase();case"title":return String(k.title??"").toLowerCase();case"x":return k.x;case"y":return k.y;case"width":return k.width??0;case"height":return k.height??0;case"createdAt":return k.createdAt??"";case"updatedAt":return k.updatedAt??"";case"id":return k.id;case"type":return k.type;default:return""}},b=p.useCallback((k,T="asc",L)=>{const H=c(L);if(H.length<2)return;const $=Ra(H).map(G=>({x:G.x,y:G.y}));[...H].sort((G,V)=>{const D=N(G,k),Y=N(V,k);let te;return typeof D=="number"&&typeof Y=="number"?te=D-Y:te=String(D).localeCompare(String(Y)),T==="asc"?te:-te}).forEach((G,V)=>{const D=$[V];(G.x!==D.x||G.y!==D.y)&&n(G.id,{x:D.x,y:D.y})})},[n]),j=p.useCallback((k,T)=>{b(k??o,"asc",T)},[b,o]),R=p.useCallback((k,T)=>{b(k??o,"desc",T)},[b,o]),S=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L={cleanUpGap:Z.arrange.cleanUpGap,rowThreshold:Z.arrange.cleanUpRowThreshold};ew(T,L).forEach($=>{const _=T.find(G=>G.id===$.id);_&&(_.x!==$.x||_.y!==$.y)&&n($.id,{x:$.x,y:$.y})})},[n]),C=k=>{const L=E.getState().projectCanvas.getActive(),H=(L==null?void 0:L.coreState.arrows)??[],$=new Set(k.map(_=>_.id));return H.filter(_=>_.startNodeId&&_.endNodeId&&$.has(_.startNodeId)&&$.has(_.endNodeId))},M=k=>{const T=k.width??be.DEFAULT_NODE_WIDTH,L=k.height??100;return{x:k.x+T/2,y:k.y+L/2}},I=(k,T,L)=>{const{arrow:H}=E.getState();for(const $ of k){if(!$.startNodeId||!$.endNodeId)continue;const _=T.get($.startNodeId),G=T.get($.endNodeId);if(!_||!G)continue;const D=E.getState().projectCanvas.getActive(),Y=(D==null?void 0:D.coreState.nodes)??[],te=Y.find(X=>X.id===$.startNodeId),ie=Y.find(X=>X.id===$.endNodeId);if(!te||!ie)continue;const we=M(te),ge=M(ie);H.update($.id,{type:L,startPoint:we,endPoint:ge})}},A=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L=E.getState().getArrangeNodeGap(),H=C(T),$=new Map(T.map(ge=>[ge.id,ge])),_=T.filter(ge=>!H.some(ce=>ce.endNodeId===ge.id)),G=_.reduce((ge,X)=>X.x<ge.x||X.x===ge.x&&X.y<ge.y?X:ge,_[0]),V=[..._].sort((ge,X)=>ge.x!==X.x?ge.x-X.x:ge.y-X.y),D=new Set,Y=(G==null?void 0:G.x)??T[0].x,te=(G==null?void 0:G.y)??T[0].y,ie=(ge,X,ce)=>{if(D.has(ge.id))return{width:0,height:0};D.add(ge.id);const ue=H.filter(oe=>oe.startNodeId===ge.id&&oe.endNodeId&&!D.has(oe.endNodeId)).map(oe=>$.get(oe.endNodeId)).filter(oe=>oe!==void 0);n(ge.id,{x:X,y:ce});const ee=ge.width??be.DEFAULT_NODE_WIDTH,K=ge.height??100;if(ue.length===0)return{width:ee,height:K};const U=X+ee+L;let q=ce,se=0;for(const oe of ue){const fe=ie(oe,U,q),he=oe.height??100;q+=Math.max(he,fe.height)+L,se=Math.max(se,fe.width)}const ne=q-ce-L;return{width:ee+L+se,height:Math.max(K,ne)}};let we=te;for(const ge of V){const X=ie(ge,Y,we),ce=ge.height??100;we+=Math.max(ce,X.height)+L}I(H,$,"TreeZShape")},[n]),O=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L=E.getState().getArrangeNodeGap(),H=C(T),$=new Map(T.map(ge=>[ge.id,ge])),_=T.filter(ge=>!H.some(ce=>ce.endNodeId===ge.id)),G=_.reduce((ge,X)=>X.x<ge.x||X.x===ge.x&&X.y<ge.y?X:ge,_[0]),V=[..._].sort((ge,X)=>ge.x!==X.x?ge.x-X.x:ge.y-X.y),D=new Set,Y=(G==null?void 0:G.x)??T[0].x,te=(G==null?void 0:G.y)??T[0].y,ie=(ge,X,ce)=>{if(D.has(ge.id))return{width:0,height:0};D.add(ge.id);const ue=H.filter(oe=>oe.startNodeId===ge.id&&oe.endNodeId&&!D.has(oe.endNodeId)).map(oe=>$.get(oe.endNodeId)).filter(oe=>oe!==void 0);n(ge.id,{x:X,y:ce});const ee=ge.width??be.DEFAULT_NODE_WIDTH,K=ge.height??100;if(ue.length===0)return{width:ee,height:K};const U=ce+K+L;let q=X,se=0;for(const oe of ue){const fe=ie(oe,q,U),he=oe.width??be.DEFAULT_NODE_WIDTH;q+=Math.max(he,fe.width)+L,se=Math.max(se,fe.height)}const ne=q-X-L;return{width:Math.max(ee,ne),height:K+L+se}};let we=Y;for(const ge of V){const X=ie(ge,we,te),ce=ge.width??be.DEFAULT_NODE_WIDTH;we+=Math.max(ce,X.width)+L}I(H,$,"TreeLStep")},[n]),F=(k,T)=>{const L=[...k].sort((G,V)=>G.y-V.y),H=[];let $=[],_=null;for(const G of L)_===null||Math.abs(G.y-_)<=T?($.push(G),_===null&&(_=G.y)):(H.push($),$=[G],_=G.y);return $.length>0&&H.push($),H},B=(k,T)=>{const L=[...k].sort((G,V)=>G.x-V.x),H=[];let $=[],_=null;for(const G of L)_===null||Math.abs(G.x-_)<=T?($.push(G),_===null&&(_=G.x)):(H.push($),$=[G],_=G.x);return $.length>0&&H.push($),H},W=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L=E.getState().getCycleRowBuffer(),H=F(T,L);if(H.length<2)return;const $=H.map(G=>Math.min(...G.map(V=>V.y)));[H[H.length-1],...H.slice(0,-1)].forEach((G,V)=>{const D=$[V],Y=Math.min(...G.map(ie=>ie.y)),te=D-Y;for(const ie of G)n(ie.id,{y:ie.y+te})})},[n]),P=p.useCallback(k=>{const T=c(k);if(T.length<2)return;l(T);const L=E.getState().getCycleRowBuffer(),H=B(T,L);if(H.length<2)return;const $=H.map(G=>Math.min(...G.map(V=>V.x)));[H[H.length-1],...H.slice(0,-1)].forEach((G,V)=>{const D=$[V],Y=Math.min(...G.map(ie=>ie.x)),te=D-Y;for(const ie of G)n(ie.id,{x:ie.x+te})})},[n]);return{arrangeVertically:d,arrangeVerticallyAlignLeft:u,arrangeVerticallyAlignRight:h,arrangeHorizontally:g,arrangeHorizontallyAlignTop:f,arrangeHorizontallyAlignBottom:w,arrangeGrid:y,arrangeMasonry:v,cleanUp:S,arrangeByArrowsVertical:A,arrangeByArrowsHorizontal:O,cycleRowsHorizontal:W,cycleColumnsVertical:P,sortNodes:b,sortNodesAsc:j,sortNodesDesc:R,sortKey:o,setSortKey:r,sortableKeys:su,selectedNodes:a.current}}function sw({action:e,mode:s,isSelected:n,onSelect:o,config:r,onConfigChange:a,sortableKeys:i}){const c=s==="record",l=d=>{o(d==="asc"?"sort:asc":"sort:desc",{sortKey:r.sortKey})};return t.jsxs("div",{"data-test":"sort-action-section",children:[t.jsxs("div",{className:ve("flex items-center justify-between w-full px-3 py-1.5 text-sm rounded-sm",c&&n&&"bg-primary/10 border border-primary",!c&&"hover:bg-accent"),"data-test":"sort-action-row",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.icon,t.jsx("span",{children:e.label})]}),t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[t.jsxs(ct,{value:r.sortKey,onValueChange:d=>a({sortKey:d}),children:[t.jsx(lt,{className:"h-6 w-[90px] text-xs px-2","data-test":"sort-key-selector",children:t.jsx(dt,{})}),t.jsx(ut,{children:i.map(d=>t.jsx(_e,{value:d,"data-test":"sort-key-option",children:Yc[d]},d))})]}),t.jsx(Q,{variant:"outline",size:"icon",className:ve("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:asc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("asc")},title:"Sort ascending","data-test":"sort-asc-button",children:t.jsx(Ln,{className:"h-3 w-3"})}),t.jsx(Q,{variant:"outline",size:"icon",className:ve("h-6 w-6 border-transparent hover:border-foreground/50 hover:bg-background",c&&n&&e.id==="sort:desc"&&"border-primary bg-primary/10"),onClick:d=>{d.stopPropagation(),l("desc")},title:"Sort descending","data-test":"sort-desc-button",children:t.jsx(Wn,{className:"h-3 w-3"})})]})]}),t.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 text-xs text-muted-foreground hover:bg-accent rounded-sm cursor-pointer","data-test":"sort-by-last-arrange-row",children:[t.jsx(We,{checked:r.sortByLastArrange,onCheckedChange:d=>a({sortByLastArrange:d===!0}),className:"h-3.5 w-3.5","data-test":"sort-by-last-arrange-checkbox"}),t.jsxs("span",{children:["By last arranged: ",r.lastArrangeOption||"none"]})]})]})}class nw{constructor(s,n){He(this,"namespace","canvas.arrange");this.hooks=s,this.storeActions=n}getActions(){const s=this.hooks.sortableKeys;return[{id:"vertical",label:"Arrange vertically",category:"Vertical",icon:t.jsx(ho,{className:"h-3.5 w-3.5"}),subActions:[{id:"vertical:left",icon:t.jsx(Hn,{className:"h-3 w-3"}),title:"Align left"},{id:"vertical:right",icon:t.jsx(Bn,{className:"h-3 w-3"}),title:"Align right"}]},{id:"horizontal",label:"Arrange horizontally",category:"Horizontal",icon:t.jsx(ws,{className:"h-3.5 w-3.5"}),subActions:[{id:"horizontal:top",icon:t.jsx(hr,{className:"h-3 w-3"}),title:"Align top"},{id:"horizontal:bottom",icon:t.jsx(pr,{className:"h-3 w-3"}),title:"Align bottom"}]},{id:"grid",label:"Grid",category:"Layout",icon:t.jsx(Fn,{className:"h-3.5 w-3.5"})},{id:"masonry",label:"Masonry",category:"Layout",icon:t.jsx(fl,{className:"h-3.5 w-3.5"})},{id:"cleanup",label:"Clean up",category:"Layout",icon:t.jsx(Dn,{className:"h-3.5 w-3.5"})},{id:"groupByArrows",label:"Group by Arrows",category:"Layout",icon:t.jsx(gr,{className:"h-3.5 w-3.5"}),subActions:[{id:"groupByArrows:vertical",icon:t.jsx(ho,{className:"h-3 w-3"}),title:"Vertical"},{id:"groupByArrows:horizontal",icon:t.jsx(ws,{className:"h-3 w-3"}),title:"Horizontal"}]},{id:"cycle",label:"Cycle",category:"Layout",icon:t.jsx(fr,{className:"h-3.5 w-3.5"}),subActions:[{id:"cycle:horizontal",icon:t.jsx(ho,{className:"h-3 w-3"}),title:"Cycle Rows"},{id:"cycle:vertical",icon:t.jsx(ws,{className:"h-3 w-3"}),title:"Cycle Columns"}]},{id:"sort:asc",label:"Sort",category:"Sort",icon:t.jsx(Ch,{className:"h-3.5 w-3.5"}),params:[{name:"sortKey",type:"select",label:"Sort by",default:"createdAt",options:Object.entries(Yc).map(([n,o])=>({value:n,label:o}))}],customRender:n=>t.jsx(sw,{...n,sortableKeys:s})}]}getConfig(){return{nodeGap:this.storeActions.getArrangeNodeGap(),gridColumns:this.storeActions.getArrangeGridColumns(),gridRows:this.storeActions.getArrangeGridRows(),sortByLastArrange:this.storeActions.getSortByLastArrange(),sortKey:this.hooks.sortKey,lastArrangeOption:this.storeActions.getLastArrangeOption()}}setConfig(s){s.nodeGap!==void 0&&this.storeActions.setArrangeNodeGap(s.nodeGap),s.gridColumns!==void 0&&this.storeActions.setArrangeGridColumns(s.gridColumns),s.gridRows!==void 0&&this.storeActions.setArrangeGridRows(s.gridRows),s.sortByLastArrange!==void 0&&this.storeActions.setSortByLastArrange(s.sortByLastArrange),s.sortKey!==void 0&&this.hooks.setSortKey(s.sortKey)}execute(s,n){n!=null&&n.sortKey&&this.hooks.setSortKey(n.sortKey);const o={vertical:"Arrange vertically","vertical:left":"Arrange vertically (left)","vertical:right":"Arrange vertically (right)",horizontal:"Arrange horizontally","horizontal:top":"Arrange horizontally (top)","horizontal:bottom":"Arrange horizontally (bottom)",grid:"Grid",masonry:"Masonry",cleanup:"Clean up",groupByArrows:"Group by Arrows (vertical)","groupByArrows:vertical":"Group by Arrows (vertical)","groupByArrows:horizontal":"Group by Arrows (horizontal)",cycle:"Cycle (horizontal)","cycle:horizontal":"Cycle (horizontal)","cycle:vertical":"Cycle (vertical)"};o[s]&&this.storeActions.setLastArrangeOption(o[s]);const r=a=>{var i;if(this.storeActions.getSortByLastArrange()){const c=this.storeActions.getLastArrangeOption();if(c){const l={"Arrange vertically":this.hooks.arrangeVertically,"Arrange vertically (left)":this.hooks.arrangeVerticallyAlignLeft,"Arrange vertically (right)":this.hooks.arrangeVerticallyAlignRight,"Arrange horizontally":this.hooks.arrangeHorizontally,"Arrange horizontally (top)":this.hooks.arrangeHorizontallyAlignTop,"Arrange horizontally (bottom)":this.hooks.arrangeHorizontallyAlignBottom,Grid:this.hooks.arrangeGrid,Masonry:this.hooks.arrangeMasonry,"Clean up":this.hooks.cleanUp,"Group by Arrows (vertical)":this.hooks.arrangeByArrowsVertical,"Group by Arrows (horizontal)":this.hooks.arrangeByArrowsHorizontal,"Cycle (horizontal)":this.hooks.cycleRowsHorizontal,"Cycle (vertical)":this.hooks.cycleColumnsVertical};(i=l[c])==null||i.call(l)}}a==="asc"?this.hooks.sortNodesAsc():this.hooks.sortNodesDesc()};switch(s){case"vertical":this.hooks.arrangeVertically();break;case"vertical:left":this.hooks.arrangeVerticallyAlignLeft();break;case"vertical:right":this.hooks.arrangeVerticallyAlignRight();break;case"horizontal":this.hooks.arrangeHorizontally();break;case"horizontal:top":this.hooks.arrangeHorizontallyAlignTop();break;case"horizontal:bottom":this.hooks.arrangeHorizontallyAlignBottom();break;case"grid":this.hooks.arrangeGrid();break;case"masonry":this.hooks.arrangeMasonry();break;case"cleanup":this.hooks.cleanUp();break;case"groupByArrows":case"groupByArrows:vertical":this.hooks.arrangeByArrowsVertical();break;case"groupByArrows:horizontal":this.hooks.arrangeByArrowsHorizontal();break;case"cycle":case"cycle:horizontal":this.hooks.cycleRowsHorizontal();break;case"cycle:vertical":this.hooks.cycleColumnsVertical();break;case"sort:asc":r("asc");break;case"sort:desc":r("desc");break;default:console.warn(`Unknown action: ${s}`)}}executePreset(s){const o=this.storeActions.getArrangePresets().find(r=>r.id===s);o&&(this.storeActions.applyArrangePreset(s),this.execute(o.config.arrangeMode))}}function nd(){const e=tw(),s=z(v=>v.getArrangeNodeGap),n=z(v=>v.setArrangeNodeGap),o=z(v=>v.getArrangeGridColumns),r=z(v=>v.setArrangeGridColumns),a=z(v=>v.getArrangeGridRows),i=z(v=>v.setArrangeGridRows),c=z(v=>v.getSortByLastArrange),l=z(v=>v.setSortByLastArrange),d=z(v=>v.getLastArrangeOption),u=z(v=>v.setLastArrangeOption),h=z(v=>v.getCycleRowBuffer),g=z(v=>v.setCycleRowBuffer),f=z(v=>v.getArrangePresets),w=z(v=>v.applyArrangePreset),m=p.useMemo(()=>({arrangeVertically:e.arrangeVertically,arrangeVerticallyAlignLeft:e.arrangeVerticallyAlignLeft,arrangeVerticallyAlignRight:e.arrangeVerticallyAlignRight,arrangeHorizontally:e.arrangeHorizontally,arrangeHorizontallyAlignTop:e.arrangeHorizontallyAlignTop,arrangeHorizontallyAlignBottom:e.arrangeHorizontallyAlignBottom,arrangeGrid:e.arrangeGrid,arrangeMasonry:e.arrangeMasonry,cleanUp:e.cleanUp,arrangeByArrowsVertical:e.arrangeByArrowsVertical,arrangeByArrowsHorizontal:e.arrangeByArrowsHorizontal,cycleRowsHorizontal:e.cycleRowsHorizontal,cycleColumnsVertical:e.cycleColumnsVertical,sortNodesAsc:e.sortNodesAsc,sortNodesDesc:e.sortNodesDesc,sortKey:e.sortKey,setSortKey:e.setSortKey,sortableKeys:e.sortableKeys}),[e.arrangeVertically,e.arrangeVerticallyAlignLeft,e.arrangeVerticallyAlignRight,e.arrangeHorizontally,e.arrangeHorizontallyAlignTop,e.arrangeHorizontallyAlignBottom,e.arrangeGrid,e.arrangeMasonry,e.cleanUp,e.arrangeByArrowsVertical,e.arrangeByArrowsHorizontal,e.cycleRowsHorizontal,e.cycleColumnsVertical,e.sortNodesAsc,e.sortNodesDesc,e.sortKey,e.setSortKey,e.sortableKeys]),x=p.useMemo(()=>({getArrangeNodeGap:s,setArrangeNodeGap:n,getArrangeGridColumns:o,setArrangeGridColumns:r,getArrangeGridRows:a,setArrangeGridRows:i,getSortByLastArrange:c,setSortByLastArrange:l,getLastArrangeOption:()=>d()??void 0,setLastArrangeOption:u,getCycleRowBuffer:h,setCycleRowBuffer:g,getArrangePresets:f,applyArrangePreset:w}),[s,n,o,r,a,i,c,l,d,u,h,g,f,w]),y=p.useMemo(()=>new nw(m,x),[m,x]);return p.useEffect(()=>(it.register("arrange",{name:"Arrange",getActions:()=>y.getActions()}),rt.register("arrange",y),()=>{it.unregister("arrange"),rt.unregister("arrange")}),[y]),y}const ow=[],aw=[];function rw({currentConfig:e,onConfigChange:s,facade:n,onExecuteArrange:o,canExecute:r}){const a=p.useCallback((c,l)=>{s({arrangeMode:c}),l!=null&&l.sortKey},[s]),i=p.useMemo(()=>({nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,sortByLastArrange:e.sortByLastArrange,sortKey:n.getConfig().sortKey,lastArrangeOption:n.getConfig().lastArrangeOption}),[e,n]);return t.jsxs("div",{className:"space-y-2","data-test":"arrange-config-renderer",children:[t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"arrange-action-selector",children:t.jsx(_o,{facade:n,mode:"record",selectedActionId:e.arrangeMode,onActionSelect:a,configOverride:i,onConfigChange:c=>{c.nodeGap!==void 0&&s({nodeGap:c.nodeGap}),c.gridColumns!==void 0&&s({gridColumns:c.gridColumns}),c.sortByLastArrange!==void 0&&s({sortByLastArrange:c.sortByLastArrange})}})}),t.jsxs("div",{className:"flex items-center justify-between gap-2 px-1","data-test":"arrange-config-section",children:[t.jsx(Nr,{nodeGap:e.nodeGap,gridColumns:e.gridColumns,gridRows:e.gridRows,onNodeGapChange:c=>s({nodeGap:c}),onGridColumnsChange:c=>s({gridColumns:c}),onGridRowsChange:c=>s({gridRows:c}),compact:!0,showRows:!0}),t.jsxs(Q,{size:"sm",variant:"default",className:"h-6 px-2 text-xs",onClick:()=>o(e.arrangeMode),disabled:!r,"data-test":"arrange-execute-button",children:[t.jsx(ot,{className:"h-3 w-3 mr-1"}),"Run"]})]})]})}function iw({isVisible:e,onClose:s,triggerPosition:n,onArrangeAction:o,onPresetApplied:r}){const[a,i]=p.useState(!1),[c,l]=p.useState(0),d=p.useRef({currentConfig:null,isEditingPreset:!1}),u=nd(),h=p.useCallback(D=>{var Y,te;return((te=(Y=D.preferences)==null?void 0:Y.arrangePresets)==null?void 0:te.presets)??ow},[]),g=z(h),f=z(D=>{var Y,te;return((te=(Y=D.preferences)==null?void 0:Y.arrangePresets)==null?void 0:te.favoriteIds)??aw}),w=z(D=>{var Y,te;return((te=(Y=D.preferences)==null?void 0:Y.arrangePresets)==null?void 0:te.activePresetId)??null}),m=z(D=>{var Y,te;return((te=(Y=D.preferences)==null?void 0:Y.arrangeButton)==null?void 0:te.nodeGap)??be.ARRANGE_NODE_GAP}),x=z(D=>{var Y,te;return((te=(Y=D.preferences)==null?void 0:Y.arrangeButton)==null?void 0:te.gridColumns)??be.ARRANGE_GRID_COLUMNS}),y=z(D=>D.getArrangeGridRows()),v=z(D=>{var Y,te;return((te=(Y=D.preferences)==null?void 0:Y.arrangeButton)==null?void 0:te.sortByLastArrange)??!1}),N=z(D=>D.setArrangeNodeGap),b=z(D=>D.setArrangeGridColumns);z(D=>D.setArrangeGridRows);const j=z(D=>D.setSortByLastArrange),R=z(D=>D.createArrangePreset),S=z(D=>D.updateArrangePreset),C=z(D=>D.duplicateArrangePreset),M=z(D=>D.deleteArrangePreset),I=z(D=>D.renameArrangePreset),A=z(D=>D.applyArrangePreset),O=z(D=>D.toggleArrangePresetFavorite),F=z(D=>D.setActiveArrangePresetId),B=p.useMemo(()=>({getAll:()=>g,getById:D=>g.find(Y=>Y.id===D),getFavorites:()=>g.filter(D=>f.includes(D.id)),getFavoriteIds:()=>f,getActiveId:()=>w,create:(D,Y)=>R(D,Y),update:(D,Y)=>{S(D,Y)},updateConfig:(D,Y)=>{const te=g.find(ie=>ie.id===D);te&&S(D,{config:{...te.config,...Y}})},duplicate:D=>C(D),delete:D=>{M(D)},rename:(D,Y)=>{I(D,Y)},reorder:D=>{},apply:D=>{A(D)},setActive:D=>{F(D)},toggleFavorite:D=>{O(D)},isFavorite:D=>f.includes(D)}),[g,f,w,R,S,C,M,I,A,F,O]),W=p.useCallback(()=>({arrangeMode:"vertical",nodeGap:m,gridColumns:x,gridRows:y,sortByLastArrange:v}),[m,x,y,v]),P=p.useCallback(D=>{o&&(o(D),Se.success(`Executed ${D} arrange`))},[o]),k=p.useCallback(D=>{o?(requestAnimationFrame(()=>{o(D.config.arrangeMode)}),Se.success(`Applied and executed "${D.name}" (${D.config.arrangeMode})`),r&&r(D.id,D.name,()=>{A(D.id),o(D.config.arrangeMode)})):Se.success(`Applied preset "${D.name}" settings`)},[o,r,A]),T=p.useCallback(D=>{d.current={currentConfig:D.currentConfig,isEditingPreset:D.isEditingPreset,editingPresetName:D.editingPresetName};const Y=te=>{D.onConfigChange(te),d.current.currentConfig&&(d.current={...d.current,currentConfig:{...d.current.currentConfig,...te}}),a&&requestAnimationFrame(()=>{l(ie=>ie+1)}),te.nodeGap!==void 0&&N(te.nodeGap),te.gridColumns!==void 0&&b(te.gridColumns),te.sortByLastArrange!==void 0&&j(te.sortByLastArrange)};return t.jsx(rw,{...D,onConfigChange:Y,facade:u,onExecuteArrange:P,canExecute:!!o})},[u,P,o,N,b,j,a]),L=p.useCallback(()=>{a||l(D=>D+1),i(!a)},[a]),H=p.useCallback(()=>{l(D=>D+1)},[]),$=p.useMemo(()=>t.jsx("button",{className:`p-1 rounded hover:bg-accent transition-colors ${a?"bg-accent text-accent-foreground":""}`,onClick:L,"aria-label":a?"Hide debug panel":"Show debug panel",title:a?"Hide debug panel":"Show debug panel","data-test":"preset-debug-toggle",children:t.jsx(Yo,{size:14})}),[a,L]),_=["activePreset","allPresets"],G=p.useMemo(()=>{const D=d.current,Y=w?g.find(ie=>ie.id===w):null,te={mode:D.isEditingPreset?"editing":"creating",editingPresetName:D.editingPresetName||null,currentConfig:D.currentConfig,activePreset:Y?{id:Y.id,name:Y.name,config:Y.config}:null,allPresets:g.map(ie=>({id:ie.id,name:ie.name,isFavorite:f.includes(ie.id),config:ie.config}))};return Object.fromEntries(Object.entries(te).filter(([ie])=>!_.includes(ie)))},[c,w,g,f]),V=p.useMemo(()=>n?{x:n.x+400,y:n.y}:{x:500,y:100},[n]);return t.jsxs(t.Fragment,{children:[t.jsx(Jl,{isVisible:e,onClose:s,triggerPosition:n,title:"Arrange Presets",initialSize:{width:380,height:480},emptyMessage:"No presets yet. Create one to get started.",renderConfigSection:T,getCurrentConfig:W,presetActions:B,onApplyPreset:k,headerActions:$}),t.jsx(Ve,{isVisible:e&&a,onClose:()=>i(!1),title:"Preset Debug",triggerPosition:V,initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:H,"aria-label":"Refresh debug data",title:"Refresh debug data","data-test":"preset-debug-refresh",children:t.jsx(fr,{size:14})}),children:t.jsx("div",{className:"p-3 overflow-auto h-full font-mono text-xs","data-test":"preset-debug-content",children:t.jsx("pre",{className:"whitespace-pre-wrap break-words",children:JSON.stringify(G,null,2)})})})]})}function cw({isVisible:e,onClose:s,triggerPosition:n}){const o=z(m=>{var x,y;return((y=(x=m.preferences)==null?void 0:x.arrangeButton)==null?void 0:y.nodeGap)??be.ARRANGE_NODE_GAP}),r=z(m=>{var x,y;return((y=(x=m.preferences)==null?void 0:x.arrangeButton)==null?void 0:y.gridColumns)??be.ARRANGE_GRID_COLUMNS}),a=z(m=>m.getArrangeGridRows()),i=z(m=>m.setArrangeNodeGap),c=z(m=>m.setArrangeGridColumns),l=z(m=>m.setArrangeGridRows),d=z(m=>m.toggleArrangeConfigFavorite),u=z(m=>m.isArrangeConfigFavorite),h=p.useCallback((m,x)=>{const y=u(m,x);d(m,x),Se.success(y?"Removed from favorites":"Added to favorites")},[d,u]),g=u("gap",o),f=u("columns",r),w=u("rows",a);return t.jsx(Ve,{isVisible:e,onClose:s,title:"Arrange Config",triggerPosition:n,initialSize:{width:280,height:200},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3","data-test":"arrange-config-content",children:t.jsx(Nr,{nodeGap:o,gridColumns:r,gridRows:a,onNodeGapChange:i,onGridColumnsChange:c,onGridRowsChange:l,showFavorites:!0,showRows:!0,isGapFavorite:g,isColumnsFavorite:f,isRowsFavorite:w,onToggleGapFavorite:()=>h("gap",o),onToggleColumnsFavorite:()=>h("columns",r),onToggleRowsFavorite:()=>h("rows",a)})})})}const lw=[],dw=[],uw=[],zi="canvas-arrange-nodes",hw=()=>{const e=nd(),n=z(T=>Oe.selectSelectedNodes(T).length)<2,o=z(T=>{var L,H;return((H=(L=T.preferences)==null?void 0:L.arrangePresets)==null?void 0:H.presets)??lw}),r=z(T=>{var L,H;return((H=(L=T.preferences)==null?void 0:L.arrangePresets)==null?void 0:H.favoriteIds)??uw}),a=p.useMemo(()=>o.filter(T=>r.includes(T.id)),[o,r]),i=z(T=>{var L;return((L=T.preferences)==null?void 0:L.arrangeConfigFavorites)??dw}),c=z(T=>{var L,H;return((H=(L=T.preferences)==null?void 0:L.arrangeButton)==null?void 0:H.nodeGap)??be.ARRANGE_NODE_GAP}),l=z(T=>{var L,H;return((H=(L=T.preferences)==null?void 0:L.arrangeButton)==null?void 0:H.gridColumns)??be.ARRANGE_GRID_COLUMNS}),d=z(T=>T.getArrangeGridRows()),u=z(T=>T.setArrangeNodeGap),h=z(T=>T.setArrangeGridColumns),g=z(T=>T.setArrangeGridRows),[f,w]=p.useState(!1),[m,x]=p.useState(),y=p.useRef(null),v=p.useRef(null),[N,b]=p.useState(!1),[j,R]=p.useState(),S=p.useRef(null),C=p.useCallback(()=>{if(y.current){const T=y.current.getBoundingClientRect();x({x:T.left,y:T.bottom+4})}w(!0)},[]),M=p.useCallback(()=>{w(!1)},[]),I=p.useCallback(()=>{if(N)b(!1);else{if(S.current){const T=S.current.getBoundingClientRect();R({x:T.left,y:T.bottom+4})}b(!0)}},[N]),A=p.useCallback(()=>{b(!1)},[]),O=p.useCallback((T,L,H)=>{v.current=H,E.getState().setSegmentedButtonAction(zi,L,()=>v.current)},[]),F=p.useCallback(T=>{e.execute(T)},[e]),B=p.useCallback(T=>{var $;const L=o.find(_=>_.name===T);if(L)return()=>e.executePreset(L.id);const H=e.getActions();for(const _ of H){if(_.label===T)return()=>e.execute(_.id);const G=($=_.subActions)==null?void 0:$.find(V=>V.title===T);if(G)return()=>e.execute(G.id)}return null},[o,e]),W=p.useCallback((T,L,H)=>{e.executePreset(T),H(L,()=>e.executePreset(T))},[e]),P=[{width:"180px",actions:[{label:"Arrange Actions",customRender:({registerRepeatAction:T})=>t.jsx(_o,{facade:e,mode:"execute",onActionExecuted:T,categories:["Vertical","Horizontal","Layout"]})}]},{width:"230px",actions:[{label:"Presets",customRender:({registerRepeatAction:T})=>t.jsxs("div",{"data-test":"arrange-presets-section",children:[t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Presets"}),t.jsxs("button",{ref:y,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:C,"data-test":"arrange-presets-button",children:[t.jsx(dr,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),a.length>0&&t.jsxs("div",{className:"px-3 py-1","data-test":"arrange-quick-access-section",children:[t.jsx("div",{className:"text-[9px] text-muted-foreground mb-1",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-0.5","data-test":"arrange-favorite-presets-grid",children:a.map(L=>t.jsxs(Q,{variant:"outline",size:"sm",className:"h-5 px-1.5 text-[10px]",onClick:H=>{H.stopPropagation(),W(L.id,L.name,T)},title:`Apply & Execute: ${L.name}`,"data-test":"arrange-favorite-preset-button",children:[t.jsx(ot,{className:"h-2 w-2 mr-1"}),L.name]},L.id))})]})]})},{label:"Sort Actions",customRender:({registerRepeatAction:T})=>t.jsxs("div",{"data-test":"arrange-sort-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsx("div",{className:"px-3 py-1 text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Sort"}),t.jsx(_o,{facade:e,mode:"execute",onActionExecuted:T,categories:["Sort"]})]})},{label:"Config",customRender:()=>{const T=i.filter(_=>_.type==="gap"),L=i.filter(_=>_.type==="columns"),H=i.filter(_=>_.type==="rows"),$=i.length>0;return t.jsxs("div",{"data-test":"arrange-config-section",children:[t.jsx("div",{className:"h-px bg-border my-1"}),t.jsxs("div",{className:"px-3 py-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wide",children:"Config"}),t.jsx("button",{ref:S,className:"p-0.5 rounded hover:bg-accent",onClick:I,title:"Toggle config popover","data-test":"arrange-config-button",children:t.jsx(Un,{className:"h-3 w-3 text-muted-foreground"})})]}),$&&t.jsxs("div",{className:"px-3 py-1 space-y-1.5","data-test":"arrange-config-quick-access-section",children:[T.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-gap-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Gap:"}),t.jsx(Re,{type:"number",min:"0",max:"200",value:c,onChange:_=>u(Math.max(0,Math.min(200,parseInt(_.target.value)||0))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-gap-input"})]}),L.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-cols-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Cols:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:l,onChange:_=>h(Math.max(1,Math.min(10,parseInt(_.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-cols-input"})]}),H.length>0&&t.jsxs("div",{className:"flex items-center gap-1","data-test":"arrange-config-rows-row",children:[t.jsx("span",{className:"text-[9px] text-muted-foreground w-7",children:"Rows:"}),t.jsx(Re,{type:"number",min:"1",max:"10",value:d,onChange:_=>g(Math.max(1,Math.min(10,parseInt(_.target.value)||3))),className:"h-5 w-12 text-[10px] px-1",onClick:_=>_.stopPropagation(),onPointerDown:_=>_.stopPropagation(),"data-test":"arrange-config-rows-input"})]})]})]})}}]}],k={label:"Arrange",icon:t.jsx(jh,{className:"h-2.5 w-2.5"}),onClick:()=>e.execute("vertical"),disabled:n,disabledTooltip:"Select at least 2 nodes to arrange"};return t.jsxs(t.Fragment,{children:[t.jsx(Je,{mainAction:k,dropdownColumns:P,variant:"outline",size:"compact",persistenceKey:zi,facade:e,restoreRepeatAction:B,"data-test":"canvas-arrange-nodes-button"}),t.jsx(iw,{isVisible:f,onClose:M,triggerPosition:m,onArrangeAction:F,onPresetApplied:O}),t.jsx(cw,{isVisible:N,onClose:A,triggerPosition:j})]})};function Sr(){const e=z(d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.entries)??As}),s=z(d=>{var u,h;return(h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.lastAction}),n=z(d=>d.getGlobalActionHistory),o=z(d=>d.getGlobalLastAction),r=z(d=>d.clearGlobalActionHistory),a=z(d=>d.executeGlobalLastAction),i=z(d=>d.executeActionById),c=z(d=>d.hasExecutor),l=p.useCallback(d=>i(d.executorId),[i]);return{history:e,lastAction:s,getHistory:n,getLastAction:o,clearHistory:r,executeLastAction:a,executeAction:l,hasExecutor:c}}class pw{fromHistoryEntry(s){if(!s.actionId)return console.warn("ActionReferenceResolver: Cannot create reference without actionId"),null;const n=this.extractFacadeKeyFromSource(s.source);return n?{facadeKey:n,actionId:s.actionId,params:s.params,label:s.label}:(console.warn(`ActionReferenceResolver: Cannot derive facadeKey from source "${s.source}"`),null)}extractFacadeKeyFromSource(s){const n={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(n[s])return n[s];const o=s.split("-");return o.length>=2?o[1]:null}execute(s){const n=rt.get(s.facadeKey);if(!n)return{success:!1,error:`Facade "${s.facadeKey}" not found in registry`};try{return n.execute(s.actionId,s.params),{success:!0}}catch(o){return{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async executeSequence(s,n){const o=[];for(let r=0;r<s.length;r++){const{action:a,delayMs:i}=s[r],c=Math.max(i,be.PRESET_STEP_DELAY_MS);r>0&&await new Promise(d=>setTimeout(d,c));const l=this.execute(a);o.push(l),n==null||n(r,l),l.success||console.warn(`ActionReferenceResolver: Step ${r} failed for "${a.label}": ${l.error}`)}return o}}const gw=new pw,fw=[],mw=[];function Cr(){const e=kt(E,u=>{var h,g;return((g=(h=u.actions)==null?void 0:h.sequencePresets)==null?void 0:g.presets)??fw}),s=kt(E,u=>{var h,g;return((g=(h=u.actions)==null?void 0:h.sequencePresets)==null?void 0:g.favoriteIds)??mw}),n=p.useCallback(u=>E.getState().getSequencePresetById(u),[]),o=p.useCallback((u,h)=>E.getState().createSequencePreset(u,h),[]),r=p.useCallback((u,h)=>{E.getState().updateSequencePreset(u,h)},[]),a=p.useCallback(u=>E.getState().duplicateSequencePreset(u),[]),i=p.useCallback(u=>{E.getState().deleteSequencePreset(u)},[]),c=p.useCallback(u=>{E.getState().toggleSequencePresetFavorite(u)},[]),l=p.useCallback(u=>s.includes(u),[s]),d=p.useCallback(async u=>{const h=E.getState().getSequencePresetById(u);if(!h){console.warn(`useSequencePresets: Preset "${u}" not found`);return}const g=h.steps.map(f=>({action:f.action,delayMs:f.delayMs}));await gw.executeSequence(g)},[]);return{presets:e,favoriteIds:s,getPresetById:n,createPreset:o,updatePreset:r,duplicatePreset:a,deletePreset:i,toggleFavorite:c,isFavorite:l,executePreset:d}}const xw=({presetsButtonRef:e,onOpenPresetsPopover:s,closeDropdown:n,favoritePresets:o,onExecutePreset:r,dataTestPrefix:a,maxFavorites:i=6})=>{const c=()=>{n==null||n(),s()};return t.jsxs("div",{"data-test":"preset-and-quick-access-section",children:[t.jsxs("button",{ref:e,className:"flex items-center gap-2 w-full px-3 py-1.5 text-sm rounded-sm hover:bg-accent text-left",onClick:c,"data-test":"preset-and-quick-access-presets-button",children:[t.jsx(dr,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Presets"})]}),o.length>0&&t.jsxs("div",{className:"px-3 py-1.5 border-t border-border/50 mt-1","data-test":"preset-quick-access-section",children:[t.jsx("div",{className:"text-[10px] text-muted-foreground mb-1.5",children:"Quick access"}),t.jsx("div",{className:"flex flex-wrap gap-1","data-test":"preset-favorite-presets-grid",children:o.slice(0,i).map(l=>t.jsxs(Q,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:d=>{d.stopPropagation(),r(l.id,l.name)},title:`Execute: ${l.name}`,"data-test":"preset-favorite-preset-button",children:[t.jsx(ot,{className:"h-2.5 w-2.5 mr-1"}),l.name]},l.id))})]}),t.jsx("div",{className:"h-px bg-border border-2 my-1"})]})},ww=[];function yw(){const e=kt(E,a=>{var i,c;return((c=(i=a.actions)==null?void 0:i.sequencePresets)==null?void 0:c.visualWorkflows)??ww}),s=p.useCallback(a=>E.getState().getVisualWorkflowPresetById(a),[]),n=p.useCallback((a,i,c)=>E.getState().createVisualWorkflowPreset(a,i,c),[]),o=p.useCallback((a,i)=>{E.getState().updateVisualWorkflowPreset(a,i)},[]),r=p.useCallback(a=>{E.getState().deleteVisualWorkflowPreset(a)},[]);return{visualWorkflows:e,getPresetById:s,createPreset:n,updatePreset:o,deletePreset:r}}const vw={content:!0,title:!1,id:!1,type:!1,tags:!1},bw={horizontal:"Horizontal",vertical:"Vertical",grid:"Grid",masonry:"Masonry"},Nw={GAP:Z.arrange.gap,LANE_GAP:Z.slice.laneGap,LANE_HEADER_OFFSET:Z.slice.laneHeaderOffset,GRID_COLUMNS:Z.arrange.gridColumns},{GAP:It,LANE_GAP:Sw,LANE_HEADER_OFFSET:An,GRID_COLUMNS:Ot}=Nw,Cw=e=>{const s=new Map;for(const n of e)if(n.tags)for(const o of n.tags)s.has(o.title)||s.set(o.title,o);return Array.from(s.values()).sort((n,o)=>n.title.localeCompare(o.title))},jr=(e,s)=>{var n;return((n=e.tags)==null?void 0:n.some(o=>o.title===s))??!1},od=(e,s)=>e.filter(n=>jr(n,s)),ad=100,rd=200,os=e=>e.height??ad,_s=e=>e.width??rd,jw=(e,s)=>{if(e.length===0)return ad;switch(s){case"horizontal":return Math.max(...e.map(os));case"vertical":return e.reduce((o,r)=>o+os(r),0)+(e.length-1)*It;case"grid":{const n=Math.ceil(e.length/Ot);let o=0;for(let r=0;r<n;r++){const a=r*Ot,i=Math.min(a+Ot,e.length),c=e.slice(a,i),l=Math.max(...c.map(os));o+=l}return o+(n-1)*It}case"masonry":{const n=Array(Ot).fill(0);return e.forEach(o=>{const r=n.indexOf(Math.min(...n));n[r]+=os(o)+It}),Math.max(...n)-It}}},kw=(e,s,n,o)=>{const r=[];switch(o){case"horizontal":{let a=s;e.forEach(i=>{r.push({id:i.id,x:a,y:n+An}),a+=_s(i)+It});break}case"vertical":{let a=n+An;e.forEach(i=>{r.push({id:i.id,x:s,y:a}),a+=os(i)+It});break}case"grid":{const a=Math.ceil(e.length/Ot),i=[n+An];for(let l=0;l<a-1;l++){const d=l*Ot,u=Math.min(d+Ot,e.length),h=e.slice(d,u),g=Math.max(...h.map(os));i.push(i[l]+g+It)}const c=Math.max(...e.map(_s));e.forEach((l,d)=>{const u=Math.floor(d/Ot);r.push({id:l.id,x:s+d%Ot*(c+It),y:i[u]})});break}case"masonry":{const a=Math.max(...e.map(_s)),i=Array(Ot).fill(0);e.forEach(c=>{const l=i.indexOf(Math.min(...i));r.push({id:c.id,x:s+l*(a+It),y:n+An+i[l]}),i[l]+=os(c)+It});break}}return r},Aw=(e,s)=>{if(e.length===0)return rd;switch(s){case"horizontal":return e.reduce((o,r)=>o+_s(r),0)+(e.length-1)*It;case"vertical":return Math.max(...e.map(_s));case"grid":case"masonry":{const n=Math.max(...e.map(_s)),o=Math.min(e.length,Ot);return o*n+(o-1)*It}}},Iw=(e,s,n="horizontal")=>{if(s.length===0)return{updates:[],laneCount:0,nodesPerLane:new Map,lanes:[]};const o=[...s].sort(),r=[],a=new Map,i=[],c=new Set,l=Math.min(...e.map(h=>h.x));let d=0;o.forEach(h=>{const g=od(e,h).filter(x=>!c.has(x.id));if(g.length===0)return;const f=kw(g,l,d,n);r.push(...f),g.forEach(x=>c.add(x.id)),a.set(h,g.length);const w=jw(g,n),m=Aw(g,n);i.push({tagTitle:h,nodeIds:g.map(x=>x.id),bounds:{x:l,y:d,width:m,height:w+An}}),d+=w+Sw});const u=e.filter(h=>!c.has(h.id));if(u.length>0){const h=[...u].sort((f,w)=>f.y-w.y);let g=d;for(const f of h)r.push({id:f.id,x:l,y:g}),g+=os(f)+It}return{updates:r,laneCount:o.length,nodesPerLane:a,lanes:i}},Tw=(e,s)=>{const n=new Map;for(const o of s){const r=e.filter(a=>jr(a,o.title)).length;n.set(o.title,r)}return n},Ew={split:{whitespace:{facadeKey:"split",actionId:"byWhitespace"},line:{facadeKey:"split",actionId:"byLine"},paragraph:{facadeKey:"split",actionId:"byParagraph"},comma:{facadeKey:"split",actionId:"byComma"},period:{facadeKey:"split",actionId:"byPeriod"}},arrange:{horizontal:{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:top":{facadeKey:"arrange",actionId:"horizontal:top"},"horizontal:center":{facadeKey:"arrange",actionId:"horizontal:center"},"horizontal:bottom":{facadeKey:"arrange",actionId:"horizontal:bottom"},vertical:{facadeKey:"arrange",actionId:"vertical:left"},"vertical:left":{facadeKey:"arrange",actionId:"vertical:left"},"vertical:center":{facadeKey:"arrange",actionId:"vertical:center"},"vertical:right":{facadeKey:"arrange",actionId:"vertical:right"},grid:{facadeKey:"arrange",actionId:"grid"},masonry:{facadeKey:"arrange",actionId:"masonry"}},align:{left:{facadeKey:"alignment",actionId:"left"},center:{facadeKey:"alignment",actionId:"center"},right:{facadeKey:"alignment",actionId:"right"},top:{facadeKey:"alignment",actionId:"top"},middle:{facadeKey:"alignment",actionId:"middle"},bottom:{facadeKey:"alignment",actionId:"bottom"}},group:{create:{facadeKey:"grouping",actionId:"group"},ungroup:{facadeKey:"grouping",actionId:"ungroup"}},collapse:{collapse:{facadeKey:"collapse",actionId:"collapse"},expand:{facadeKey:"collapse",actionId:"expand"}}};function Rw(e,s){const n=Ew[e];if(!n)return null;const o=n[s];return o||null}function Mw(e){return e.type==="GROUP"&&jr(e,"workflow")}function Pw(e){if(e.type===le.WORKFLOW_STEP){const o=e.data;if(!(o!=null&&o.stepType))return console.warn(`VisualWorkflowParser: WORKFLOW_STEP node ${e.id} has no stepType configured`),null;const a={toolbarAction:"toolbarAction",if:"if",tagUpdate:"nodeUpdate",loop:"loop",source:"source"}[o.stepType];if(!a)return console.warn(`VisualWorkflowParser: Unknown stepType "${o.stepType}" in node ${e.id}`),null;let i=o.config;return{nodeId:e.id,order:0,stepType:a,config:i||{},label:e.title||o.stepType}}const s=(e.title||"").trim().toLowerCase();if(!s)return null;const n=s.match(/^([^:]+):\s*(.+)$/);if(n){const[,o,r]=n,a=o.trim(),i=r.trim();if(a==="if")return{nodeId:e.id,order:0,stepType:"if",config:{condition:i},label:`If: ${i}`};if(a==="tag")return{nodeId:e.id,order:0,stepType:"nodeUpdate",config:{simpleFieldUpdates:[{field:"tags",template:i}]},label:`Tag: ${i}`};const c=Rw(a,i);return c?{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:c.facadeKey,actionId:c.actionId,params:c.params||{}},label:`${a}: ${i}`}:{nodeId:e.id,order:0,stepType:"toolbarAction",config:{facadeKey:a,actionId:i,params:{}},label:`${a}: ${i}`}}return s==="loop"?{nodeId:e.id,order:0,stepType:"loop",config:{},label:"Loop"}:s==="source"?{nodeId:e.id,order:0,stepType:"source",config:{},label:"Source"}:(console.warn(`VisualWorkflowParser: Unknown step pattern "${s}"`),null)}function Dw(e,s){const n=new Map,o=new Map;e.forEach(c=>{n.set(c.id,[]),o.set(c.id,0)}),s.forEach(c=>{if(c.startNodeId&&c.endNodeId){const l=n.get(c.startNodeId)||[];l.push(c.endNodeId),n.set(c.startNodeId,l),o.set(c.endNodeId,(o.get(c.endNodeId)||0)+1)}});const r=[];o.forEach((c,l)=>{c===0&&r.push(l)});const a=[],i=new Map(e.map(c=>[c.id,c]));for(;r.length>0;){const c=r.shift(),l=i.get(c);l&&a.push(l),(n.get(c)||[]).forEach(u=>{const h=(o.get(u)||0)-1;o.set(u,h),h===0&&r.push(u)})}return a.length!==e.length?(console.warn("VisualWorkflowParser: Cycle detected in workflow graph"),e):a}function Ka(e,s,n){const o=e.data,r=(o==null?void 0:o.childNodeIds)||[];if(r.length===0)return[];const a=s.filter(d=>r.includes(d.id)),i=n.filter(d=>d.startNodeId&&d.endNodeId&&r.includes(d.startNodeId)&&r.includes(d.endNodeId)),c=Dw(a,i),l=[];return c.forEach((d,u)=>{const h=Pw(d);h&&(h.order=u+1,l.push(h))}),l}function Ow(e){return e.map(s=>({id:`visual_step_${s.nodeId}`,label:s.label,order:s.order,stepType:s.stepType,config:s.config}))}function id(e,s){return{id:`${e}_orchestration`,type:le.WORKFLOW_ORCHESTRATION,x:0,y:0,width:200,height:100,title:"Visual Workflow",content:"",data:{nodeType:"workflowOrchestration",parameters:{rows:s}}}}async function Lw(e,s,n,o=[]){try{const r=Ka(e,s,n);if(r.length===0)return{success:!1,error:"No workflow steps found in group",nodeUpdates:[]};const a=Ow(r),i=id(e.id,a),c=[i,...s],l=n,d=new Zs;d.loadWorkflow(c,l);const u=await d.executeWorkflow(i.id,o),h=u.nodeUpdates||[];return{success:u.success,error:u.error,nodeUpdates:h,executionId:u.executionId,duration:u.duration}}catch(r){return console.error("VisualWorkflowAdapter: Execution error:",r),{success:!1,error:r instanceof Error?r.message:String(r),nodeUpdates:[]}}}function Ww(e){return e.map((s,n)=>({id:`preset_step_${s.id}`,label:s.label,order:n,stepType:s.stepType,config:s.config}))}async function Hw(e){try{const s=E.getState(),n=s.projectCanvas.getActive();if(!n)return{success:!1,error:"No active canvas",nodeUpdates:[]};const o=n.coreState.selectedNodes,r=n.coreState.nodes,a=n.coreState.arrows;if(e.steps.length===0)return{success:!1,error:"No workflow steps in preset",nodeUpdates:[]};const i=Ww(e.steps),c=id(`preset_${e.id}`,i),l=[c,...r],d=a,u=new Zs;u.loadWorkflow(l,d);const h=await u.executeWorkflow(c.id,o),g=h.nodeUpdates||[];return h.success&&g.length>0&&g.forEach(({nodeId:f,updates:w})=>{s.updateNode(f,w)}),{success:h.success,error:h.error,nodeUpdates:g,executionId:h.executionId,duration:h.duration}}catch(s){return console.error("VisualWorkflowAdapter: Preset execution error:",s),{success:!1,error:s instanceof Error?s.message:String(s),nodeUpdates:[]}}}const Bw=({onStartRecording:e,onStartSelection:s,isRecording:n=!1,capturedStepsCount:o=0,onStopRecording:r,onCancelRecording:a,className:i})=>{const{presets:c,executePreset:l,deletePreset:d,duplicatePreset:u,updatePreset:h,toggleFavorite:g,isFavorite:f}=Cr(),{visualWorkflows:w,deletePreset:m,updatePreset:x}=yw(),[y,v]=p.useState(null),[N,b]=p.useState([]),[j,R]=p.useState(void 0),S=p.useRef({x:0,y:0});p.useEffect(()=>{const D=Y=>{S.current={x:Y.clientX,y:Y.clientY}};return window.addEventListener("mousemove",D),()=>window.removeEventListener("mousemove",D)},[]);const C=p.useCallback(async D=>{const Y=c.find(te=>te.id===D);Y&&(await l(D),E.getState().setSegmentedButtonAction("sequence-presets-panel",Y.name,()=>()=>{l(D)}))},[l,c]),M=p.useCallback(D=>{R({...S.current}),v(D),b(D.steps.map(Y=>({...Y})))},[]),I=p.useCallback(()=>{y&&h(y.id,{steps:N}),v(null),b([])},[y,N,h]),A=p.useCallback(()=>{v(null),b([])},[]),O=p.useCallback(D=>{u(D)},[u]),F=p.useCallback(D=>{const Y=E.getState();Y.projectCanvas.switch(D.canvasId),setTimeout(()=>{Y.scrollToNode(D.groupNodeId,500)},100)},[]),[B,W]=p.useState(null),P=p.useCallback(async D=>{if(!B){W(D.id);try{const Y=await Hw(D);Y.success?Se.success(`Executed: ${D.name}`,{description:`${Y.nodeUpdates.length} node${Y.nodeUpdates.length!==1?"s":""} updated`,duration:3e3}):Se.error(`Failed: ${D.name}`,{description:Y.error||"Unknown error",duration:4e3})}catch(Y){Se.error("Execution failed",{description:Y instanceof Error?Y.message:"Unknown error",duration:4e3})}finally{W(null)}}},[B]),k=p.useMemo(()=>c.map(D=>({id:D.id,label:D.name,data:D})),[c]),T=p.useCallback(D=>{console.log("Preset reorder:",D.map(Y=>Y.id))},[]),L=p.useCallback(D=>[{id:"execute",icon:t.jsx(ot,{className:"h-3 w-3"}),title:"Execute preset",onClick:()=>C(D.id)}],[C]),H=p.useCallback(D=>{const Y=D.data,te=f(Y.id);return[{id:"toggle-favorite",label:te?"Remove from favorites":"Add to favorites",icon:t.jsx(Fs,{className:ve("h-4 w-4 mr-2",te&&"fill-yellow-400 text-yellow-400")}),onClick:()=>g(Y.id)},{id:"rename",label:"Rename",icon:t.jsx(Ks,{className:"h-4 w-4 mr-2"}),onClick:()=>{const ie=window.prompt("Rename preset:",Y.name);ie&&ie.trim()&&ie!==Y.name&&h(Y.id,{name:ie.trim()})}},{id:"edit-steps",label:"Edit steps",icon:t.jsx(ol,{className:"h-4 w-4 mr-2"}),onClick:()=>M(Y)},{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>O(D.id)}]},[O,M,h,g,f]),$=p.useMemo(()=>N.map((D,Y)=>({id:D.id,label:`${Y+1}. ${D.action.label}`,data:D})),[N]),_=p.useCallback(D=>{const Y=D.map(te=>te.data);b(Y)},[]),G=p.useCallback(D=>{b(Y=>Y.filter(te=>te.id!==D))},[]),V=p.useCallback((D,Y,te,ie)=>{const we=D.data;return t.jsxs("div",{"data-test":"edit-step-item",children:[ie,t.jsxs("div",{className:"pl-8 -mt-1 mb-1 text-[10px] text-muted-foreground",children:[we.action.facadeKey," → ",we.action.actionId]})]})},[]);return t.jsxs("div",{className:ve("flex flex-col h-full",i),"data-test":"sequence-presets-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"presets-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:n?t.jsxs(t.Fragment,{children:[t.jsx(qo,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",o,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(On,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[c.length+w.length," preset",c.length+w.length!==1?"s":""]})]})}),n?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Q,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:D=>r==null?void 0:r({x:D.clientX,y:D.clientY}),"data-test":"presets-stop-recording",children:"Stop"}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:a,"data-test":"presets-cancel-recording",children:"Cancel"})]}):t.jsxs(bo,{children:[t.jsx(No,{asChild:!0,children:t.jsxs(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs","data-test":"presets-create-button",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"}),"New"]})}),t.jsxs(So,{align:"end",style:{zIndex:Te.draggablePopoverDropdown},children:[t.jsx(Rt,{onClick:e,"data-test":"presets-create-from-recording",children:"Record actions"}),t.jsx(Rt,{onClick:s,"data-test":"presets-create-from-selection",children:"Select from history"})]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"presets-list",children:c.length===0&&w.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(On,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No presets yet"}),t.jsx("span",{className:"text-xs text-center",children:"Create a preset to save action sequences"})]}):t.jsxs(t.Fragment,{children:[c.length>0&&t.jsx(qs,{data:k,onDelete:d,onReorder:T,enableEdit:!1,enableDelete:!0,enableDrag:!0,quickActions:L,moreOptionsItems:H,dropdownZIndex:Te.draggablePopoverDropdown,className:"py-1"}),w.length>0&&t.jsxs("div",{"data-test":"visual-workflow-presets",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-muted/50 border-y border-border/50",children:[t.jsx(Cs,{className:"h-3 w-3 text-muted-foreground"}),t.jsxs("span",{className:"text-[10px] font-medium text-muted-foreground uppercase tracking-wider",children:["Visual Workflows (",w.length,")"]})]}),t.jsx("div",{className:"py-1",children:w.map(D=>t.jsxs("div",{className:ve("group flex items-center gap-2 px-3 py-2 hover:bg-muted/50 transition-colors",D.sourceLocation&&"cursor-pointer"),onClick:()=>{D.sourceLocation&&F(D.sourceLocation)},"data-test":"visual-workflow-item",children:[t.jsx(Cs,{className:"h-3.5 w-3.5 text-primary/70 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm font-medium truncate",children:D.name}),t.jsxs("div",{className:"text-[10px] text-muted-foreground",children:[D.steps.length," step",D.steps.length!==1?"s":""," • ",D.steps.map(Y=>Y.stepType).filter((Y,te,ie)=>ie.indexOf(Y)===te).join(", ")]})]}),t.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[t.jsx(Q,{variant:"ghost",size:"sm",className:ve("h-6 w-6 p-0",B===D.id&&"text-primary animate-pulse"),onClick:Y=>{Y.stopPropagation(),P(D)},disabled:B!==null,title:B===D.id?"Executing...":"Execute workflow","data-test":"visual-workflow-execute-button",children:t.jsx(ot,{className:"h-3 w-3"})}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:Y=>{Y.stopPropagation();const te=window.prompt("Rename workflow:",D.name);te&&te.trim()&&te!==D.name&&x(D.id,{name:te.trim()})},title:"Rename","data-test":"visual-workflow-rename-button",children:t.jsx(Ks,{className:"h-3 w-3"})}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:text-destructive",onClick:Y=>{Y.stopPropagation(),m(D.id)},title:"Delete","data-test":"visual-workflow-delete-button",children:t.jsx(yt,{className:"h-3 w-3"})})]})]},D.id))})]})]})}),t.jsx(Ve,{isVisible:!!y,onClose:A,title:`Edit Steps: ${(y==null?void 0:y.name)??""}`,initialSize:{width:360,height:380},triggerPosition:j,resizable:!0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"edit-steps-popover",children:[t.jsxs("div",{className:"flex-1 px-4 py-2 overflow-y-auto",children:[t.jsxs(Ee,{className:"text-xs text-muted-foreground mb-2 block",children:["Steps (",N.length,") - drag to reorder"]}),N.length===0?t.jsx("div",{className:"text-xs text-muted-foreground text-center py-4",children:"No steps in this preset"}):t.jsx(qs,{data:$,onDelete:G,onReorder:_,enableEdit:!1,enableDelete:!0,enableDrag:!0,renderNode:V,dropdownZIndex:Te.draggablePopoverDropdown+10,className:"text-xs"})]}),t.jsxs("div",{className:"px-4 py-3 border-t bg-muted/20 flex justify-end gap-2",children:[t.jsx(Q,{variant:"outline",size:"sm",onClick:A,"data-test":"edit-steps-cancel",children:"Cancel"}),t.jsx(Q,{size:"sm",onClick:I,disabled:N.length===0,"data-test":"edit-steps-save",children:"Save"})]})]})})]})},Fw=[];function $w(){const e=kt(E,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.isRecording)??!1}),s=kt(E,c=>{var l,d;return((d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.capturedSteps)??Fw}),n=kt(E,c=>{var l,d;return(d=(l=c.actions)==null?void 0:l.recording)==null?void 0:d.startedAt}),o=p.useCallback(()=>{E.getState().startRecording()},[]),r=p.useCallback(()=>E.getState().stopRecording(),[]),a=p.useCallback(()=>{E.getState().cancelRecording()},[]),i=p.useMemo(()=>n?Date.now()-n:0,[n]);return{isRecording:e,capturedSteps:s,startedAt:n,startRecording:o,stopRecording:r,cancelRecording:a,recordingDuration:i}}const zw=[],_w=[],Vw=e=>{const s={"canvas-arrange-nodes":"arrange","toolbar-split-button":"split","canvas-alignment-button":"alignment","canvas-node-operations":"nodeOperations","canvas-grouping-button":"grouping","toolbar-text-formatting":"textFormatting","canvas-fit-width":"fitWidth","canvas-collapse":"collapse"};if(s[e])return s[e];const n=e.split("-");return n.length>=2?n[1]:null};function Uw(){const e=kt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.historySelection)==null?void 0:h.isSelecting)??!1}),s=kt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.historySelection)==null?void 0:h.selectedIds)??zw}),n=kt(E,d=>{var u,h;return((h=(u=d.actions)==null?void 0:u.history)==null?void 0:h.entries)??_w}),o=p.useCallback(()=>{E.getState().toggleHistorySelectionMode()},[]),r=p.useCallback(d=>{E.getState().toggleHistoryItemSelection(d)},[n,s]),a=p.useCallback(d=>s.includes(d),[s]),i=p.useCallback(()=>{E.getState().clearHistorySelection()},[]),c=p.useCallback(()=>{const d=new Map;n.forEach(h=>{d.set(h.executorId,h)});const u=[];for(const h of s){const g=d.get(h);if(!g)continue;const f=Vw(g.source);if(!f||!g.actionId)continue;const w={facadeKey:f,actionId:g.actionId,params:g.params,label:g.label};u.push({id:De(8),action:w,delayMs:0})}return u},[s,n]),l=p.useMemo(()=>s.length,[s]);return{isSelecting:e,selectedIds:s,toggleSelectionMode:o,toggleItemSelection:r,isSelected:a,clearSelection:i,getSelectedAsSteps:c,selectionCount:l}}const cd=({initialTab:e="history",onTabChange:s})=>{const{history:n,executeAction:o,hasExecutor:r,clearHistory:a}=Sr(),[i,c]=p.useState(e),{isRecording:l,capturedSteps:d,startRecording:u,stopRecording:h,cancelRecording:g}=$w(),{isSelecting:f,toggleSelectionMode:w,toggleItemSelection:m,isSelected:x,clearSelection:y,getSelectedAsSteps:v,selectionCount:N}=Uw(),{createPreset:b}=Cr(),[j,R]=p.useState(!1),[S,C]=p.useState(""),[M,I]=p.useState([]),[A,O]=p.useState(void 0),F=p.useCallback(D=>{const Y=D;c(Y),s==null||s(Y)},[s]),B=D=>new Date(D).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),W=D=>D.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(Y=>Y.charAt(0).toUpperCase()+Y.slice(1)).join(" "),P=p.useCallback(D=>{o(D)},[o]),k=p.useCallback(()=>{u()},[u]),T=p.useCallback(D=>{const Y=h();Y.length>0&&(I(Y),C(`Preset ${new Date().toLocaleTimeString()}`),O(D),R(!0))},[h]),L=p.useCallback(()=>{w(),c("history")},[w]),H=p.useCallback(()=>{const D=v();D.length>0&&(I(D),C(`Preset ${new Date().toLocaleTimeString()}`),R(!0),y())},[v,y]),$=p.useCallback(()=>{S.trim()&&M.length>0&&(b(S.trim(),M),R(!1),C(""),I([]),c("presets"))},[S,M,b]),_=p.useCallback(()=>{R(!1),C(""),I([])},[]),G=(D,Y)=>{const te=Y===0,ie=r(D.executorId),we=x(D.executorId);return t.jsxs("div",{className:ve("group flex items-center gap-2 px-3 py-2 text-sm","border-b border-border/50 last:border-b-0",te&&"bg-primary/5",!ie&&"opacity-50",we&&"bg-primary/10"),"data-test":"action-history-item",children:[f?t.jsx(We,{checked:we,onCheckedChange:()=>m(D.executorId),className:"h-4 w-4","data-test":"action-history-select"}):t.jsx("div",{className:ve("flex-shrink-0 w-5 h-5 rounded text-[10px] font-medium flex items-center justify-center",te?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:Y+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:ve("font-medium truncate",te&&"text-primary"),"data-test":"action-history-item-label",children:D.label}),te&&!f&&t.jsx("span",{className:"text-[9px] px-1 py-0.5 rounded bg-primary/10 text-primary font-medium",children:"Latest"})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[t.jsx("span",{"data-test":"action-history-item-source",children:W(D.source)}),t.jsx("span",{children:"•"}),t.jsx("span",{"data-test":"action-history-item-time",children:B(D.timestamp)})]})]}),!f&&(ie?t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 hover:opacity-100 transition-opacity",onClick:()=>P(D),title:"Execute this action","data-test":"action-history-execute",children:t.jsx(ot,{className:"h-3 w-3"})}):t.jsx("div",{className:"h-6 w-6 flex items-center justify-center text-muted-foreground/50",children:t.jsx(as,{className:"h-3 w-3"})}))]},`${D.executorId}-${Y}`)},V=t.jsxs("div",{className:"flex flex-col h-full","data-test":"action-history-panel",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b bg-muted/30","data-test":"action-history-header",children:[t.jsx("div",{className:"flex items-center gap-2",children:f?t.jsxs(t.Fragment,{children:[t.jsx(mr,{className:"h-3.5 w-3.5 text-primary"}),t.jsxs("span",{className:"text-xs font-medium text-primary",children:[N," selected"]})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(qo,{className:"h-3.5 w-3.5 fill-destructive text-destructive animate-pulse"}),t.jsxs("span",{className:"text-xs font-medium text-destructive",children:["Recording (",d.length,")"]})]}):t.jsxs(t.Fragment,{children:[t.jsx(as,{className:"h-3.5 w-3.5 text-muted-foreground"}),t.jsxs("span",{className:"text-xs font-medium",children:[n.length," action",n.length!==1?"s":""]})]})}),t.jsx("div",{className:"flex items-center gap-1","data-test":"action-history-header-actions",children:f?t.jsxs(t.Fragment,{children:[t.jsx(Q,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:H,disabled:N===0,"data-test":"action-history-save-selection",children:"Save Preset"}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:y,"data-test":"action-history-cancel-selection",children:"Cancel"})]}):l?t.jsxs(t.Fragment,{children:[t.jsx(Q,{variant:"default",size:"sm",className:"h-6 px-2 text-xs",onClick:D=>T({x:D.clientX,y:D.clientY}),"data-test":"action-history-stop-recording",children:"Stop"}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:g,"data-test":"action-history-cancel-recording",children:"Cancel"})]}):t.jsx(t.Fragment,{children:n.length>0&&t.jsxs(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-destructive",onClick:a,"data-test":"action-history-clear-button",children:[t.jsx(yt,{className:"h-3 w-3 mr-1"}),"Clear"]})})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto","data-test":"action-history-list",children:n.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground p-6 gap-2",children:[t.jsx(Zo,{className:"h-8 w-8 opacity-30"}),t.jsx("span",{className:"text-sm",children:"No actions yet"}),t.jsx("span",{className:"text-xs text-center",children:"Actions you perform will appear here"})]}):t.jsx("div",{"data-test":"action-history-items",children:n.map((D,Y)=>G(D,Y))})}),n.length>0&&!f&&!l&&t.jsxs("div",{className:"px-3 py-2 border-t bg-muted/30 text-[10px] text-muted-foreground","data-test":"action-history-footer",children:["Click ",t.jsx(ot,{className:"h-2.5 w-2.5 inline mx-0.5"})," to repeat an action"]})]});return t.jsxs(t.Fragment,{children:[t.jsxs(nu,{value:i,onValueChange:F,className:"flex flex-col h-full",children:[t.jsxs(ou,{className:"grid w-full grid-cols-2 h-8","data-test":"repeat-action-tabs",children:[t.jsxs(Hr,{value:"history",className:"text-xs","data-test":"tab-history",children:[t.jsx(as,{className:"h-3 w-3 mr-1"}),"History"]}),t.jsxs(Hr,{value:"presets",className:"text-xs","data-test":"tab-presets",children:[t.jsx(On,{className:"h-3 w-3 mr-1"}),"Presets"]})]}),t.jsx(Br,{value:"history",className:"flex-1 mt-0 overflow-hidden",children:V}),t.jsx(Br,{value:"presets",className:"flex-1 mt-0 overflow-hidden",children:t.jsx(Bw,{onStartRecording:k,onStartSelection:L,isRecording:l,capturedStepsCount:d.length,onStopRecording:T,onCancelRecording:g})})]}),t.jsx(Ve,{isVisible:j,onClose:_,title:"Save as Preset",initialSize:{width:320,height:200},triggerPosition:A,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-4 flex flex-col gap-3","data-test":"save-preset-popover-content",children:[t.jsxs("div",{children:[t.jsx(Ee,{htmlFor:"new-preset-name",className:"text-sm",children:"Preset Name"}),t.jsx(Re,{id:"new-preset-name",value:S,onChange:D=>C(D.target.value),placeholder:"Enter preset name",className:"mt-2",autoFocus:!0,onKeyDown:D=>{D.key==="Enter"&&$()},"data-test":"save-preset-name-input"}),t.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[M.length," step",M.length!==1?"s":""," will be saved"]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(Q,{variant:"outline",size:"sm",onClick:_,"data-test":"save-preset-cancel",children:"Cancel"}),t.jsx(Q,{size:"sm",onClick:$,disabled:!S.trim(),"data-test":"save-preset-confirm",children:"Save Preset"})]})]})})]})},ld=()=>{const[e,s]=p.useState(!1),n=it.getAllActions().map(({source:o,actions:r})=>({facade:o,actions:r}));return t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"p-1 rounded hover:bg-accent transition-colors",onClick:o=>{o.stopPropagation(),s(!0)},onMouseDown:o=>o.stopPropagation(),title:"Debug: Show all available actions","data-test":"action-history-debug-button",children:t.jsx(Yo,{className:"h-3.5 w-3.5"})}),t.jsx(Ve,{isVisible:e,onClose:()=>s(!1),title:"Available Actions (Debug)",initialSize:{width:400,height:500},resizable:!0,shouldCloseManually:!0,children:t.jsx("div",{className:"p-3 overflow-y-auto h-full","data-test":"debug-actions-panel",children:n.map(({facade:o,actions:r})=>t.jsxs("div",{className:"mb-4","data-test":"debug-facade-section",children:[t.jsxs("h4",{className:"text-sm font-semibold mb-2 text-primary",children:[o," Actions"]}),t.jsx("ol",{className:"list-decimal list-inside space-y-1 text-xs",children:r.map(a=>t.jsxs("li",{className:"ml-2","data-test":"debug-action-item",children:[t.jsx("span",{className:"font-medium",children:a.label}),t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",a.id,")"]}),a.subActions&&a.subActions.length>0&&t.jsx("ol",{className:"list-[lower-alpha] list-inside ml-4 mt-1 space-y-0.5",children:a.subActions.map(i=>t.jsxs("li",{className:"text-muted-foreground","data-test":"debug-subaction-item",children:[t.jsx("span",{children:i.title}),t.jsxs("span",{className:"ml-1 opacity-60",children:["(",i.id,")"]})]},i.id))})]},a.id))})]},o))})})]})},Gw=({className:e})=>{const{history:s,lastAction:n,executeLastAction:o,executeAction:r,hasExecutor:a}=Sr(),{presets:i,executePreset:c,favoriteIds:l}=Cr(),[d,u]=p.useState(!1),[h,g]=p.useState(),f=p.useRef(null),w=p.useCallback(()=>{if(f.current){const M=f.current.getBoundingClientRect();g({x:M.left,y:M.bottom+4})}u(!0)},[]),m=p.useMemo(()=>i.filter(M=>l.includes(M.id)),[i,l]),x=p.useCallback(M=>M.replace("toolbar-","").replace("canvas-","").replace("-button","").replace("-nodes","").split("-").map(I=>I.charAt(0).toUpperCase()+I.slice(1)).join(" "),[]),y=p.useCallback(M=>new Date(M).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[]),v=p.useCallback(M=>{r(M)},[r]),N=p.useCallback((M,I,A)=>{c(M),A(I,()=>c(M))},[c]),b=p.useCallback(()=>{n&&a(n.executorId)&&o()},[n,a,o]),j=p.useCallback(M=>{const I=i.find(A=>A.name===M);return I?()=>{c(I.id)}:null},[i,c]),R=p.useCallback((M,I)=>{const A=I===0,O=a(M.executorId);return t.jsxs("div",{className:ve("group flex items-center gap-2 px-2 py-1.5 text-xs rounded-sm","hover:bg-accent cursor-pointer transition-colors",A&&"bg-primary/5",!O&&"opacity-50 cursor-not-allowed"),onClick:()=>O&&v(M),"data-test":"history-item",children:[t.jsx("div",{className:ve("flex-shrink-0 w-4 h-4 rounded text-[9px] font-medium flex items-center justify-center",A?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"),children:I+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:ve("font-medium truncate text-[11px]",A&&"text-primary"),children:M.label}),t.jsxs("div",{className:"text-[9px] text-muted-foreground truncate",children:[x(M.source)," • ",y(M.timestamp)]})]}),O&&t.jsx(ot,{className:"h-2.5 w-2.5 opacity-0 group-hover:opacity-100 transition-opacity text-primary"})]},`${M.executorId}-${I}`)},[a,v,x,y]),S=p.useMemo(()=>[{header:"Recent Actions",width:"200px",actions:[{label:"History",onClick:()=>{},customRender:({registerRepeatAction:M})=>t.jsx("div",{className:"flex flex-col","data-test":"history-column",children:t.jsx("div",{className:"max-h-[200px] overflow-y-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},"data-test":"history-list",children:s.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center py-6 text-muted-foreground",children:[t.jsx(as,{className:"h-6 w-6 opacity-30 mb-2"}),t.jsx("span",{className:"text-[10px]",children:"No actions yet"})]}):s.map((I,A)=>t.jsx("div",{onClick:()=>{a(I.executorId)&&(v(I),M(I.label,()=>r(I)))},children:R(I,A)},`${I.executorId}-${A}`))})})}]},{header:"Presets",width:"180px",actions:[{label:"Presets",onClick:()=>{},customRender:({registerRepeatAction:M,closeDropdown:I})=>t.jsx(xw,{presetsButtonRef:f,onOpenPresetsPopover:w,closeDropdown:I,favoritePresets:m,onExecutePreset:(A,O)=>N(A,O,M),dataTestPrefix:"sequence"})}]}],[s,m,a,v,N,w,r,R]),C=n?`Repeat: ${n.label}`:"Actions & Presets";return t.jsxs(t.Fragment,{children:[t.jsx(Je,{mainAction:{icon:t.jsx(kh,{className:"h-4 w-4"}),onClick:b,label:C},dropdownColumns:S,variant:"outline",size:"compact",persistenceKey:"canvas-actions-presets",restoreRepeatAction:j,className:e,"data-test":"canvas-actions-presets-button"}),t.jsx(Ve,{isVisible:d,onClose:()=>u(!1),title:"Actions & Presets",initialSize:{width:300,height:380},triggerPosition:h,resizable:!0,headerActions:t.jsx(ld,{}),children:t.jsx(cd,{initialTab:"presets"})})]})},Yw=[],_i=[],dd=()=>{const e=z(l=>l.arrow.update),s=z(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedNodes)??Yw}),n=z(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??_i}),o=z(l=>{var d;return((d=l.projectCanvas.getActive())==null?void 0:d.coreState.arrows)??_i}),r=p.useMemo(()=>{if(n.length>0){const l=n[0].type??Z.arrows.type;return n.every(u=>(u.type??Z.arrows.type)===l)?l:null}if(s.length>0){const l=new Set(s.map(g=>g.id)),d=o.filter(g=>g.startNodeId&&l.has(g.startNodeId)||g.endNodeId&&l.has(g.endNodeId));if(d.length===0)return Z.arrows.type;const u=d[0].type??Z.arrows.type;return d.every(g=>(g.type??Z.arrows.type)===u)?u:null}return Z.arrows.type},[n,s,o]),a=p.useCallback(l=>{const u=E.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.arrows??[],g=u.coreState.selectedArrows??[],f=u.coreState.selectedNodes??[];let w=h;if(g.length>0)w=g;else if(f.length>0){const m=new Set(f.map(x=>x.id));w=h.filter(x=>x.startNodeId&&m.has(x.startNodeId)||x.endNodeId&&m.has(x.endNodeId))}w.forEach(m=>{e(m.id,{type:l})})},[e]),i=[{label:"Straight",icon:t.jsx(Xo,{className:"h-2.5 w-2.5"}),onClick:()=>a("Straight"),selected:r==="Straight"},{label:"Quadratic",icon:t.jsx(Ah,{className:"h-2.5 w-2.5"}),onClick:()=>a("Quadratic"),selected:r==="Quadratic"},{label:"Cubic",icon:t.jsx(Ih,{className:"h-2.5 w-2.5"}),onClick:()=>a("Cubic"),selected:r==="Cubic"},{label:"Step",icon:t.jsx(Th,{className:"h-2.5 w-2.5"}),onClick:()=>a("Step"),selected:r==="Step"},{label:"Orthogonal",icon:t.jsx(Cs,{className:"h-2.5 w-2.5"}),onClick:()=>a("Orthogonal"),selected:r==="Orthogonal"},{label:"Tree: Cubic",icon:t.jsx(gr,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeCubic"),selected:r==="TreeCubic"},{label:"Tree: L-Step",icon:t.jsx(Eh,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeLStep"),selected:r==="TreeLStep"},{label:"Tree: Z-Shape",icon:t.jsx(Rh,{className:"h-2.5 w-2.5"}),onClick:()=>a("TreeZShape"),selected:r==="TreeZShape"}],c=i[2];return t.jsx(Je,{mainAction:c,dropdownActions:i,variant:"outline",size:"compact",persistenceKey:"canvas-arrow-type","data-test":"canvas-arrow-type-button"})};class Kw{constructor(s){He(this,"namespace","canvas.grouping");this.hooks=s}getActions(){return[{id:"group",label:"Group nodes",category:"Grouping",icon:t.jsx(ml,{className:"h-3 w-3"})},{id:"ungroup",label:"Ungroup nodes",category:"Grouping",icon:t.jsx(xr,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"group":this.hooks.group();break;case"ungroup":this.hooks.ungroup();break;default:console.warn(`GroupingFacade: Unknown action "${s}"`)}}}function Xw(){const e=p.useCallback(()=>{E.getState().group.createFromSelected()},[]),s=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],c=new Set;i.forEach(l=>{l.type===le.GROUP?c.add(l.id):l.groupId&&c.add(l.groupId)}),c.forEach(l=>{r.group.ungroup(l)})},[]),n=p.useMemo(()=>({group:e,ungroup:s}),[e,s]),o=p.useMemo(()=>new Kw(n),[n]);return p.useEffect(()=>(it.register("grouping",{name:"Grouping",getActions:()=>o.getActions()}),rt.register("grouping",o),()=>{it.unregister("grouping"),rt.unregister("grouping")}),[o]),o}const qw=e=>{const{className:s,...n}=e,o=Xw();z(w=>{var m,x;return((x=(m=w.projectCanvas.getActive())==null?void 0:m.coreState.selectedNodes)==null?void 0:x.length)??0});const a=E.getState().projectCanvas.getActive(),i=(a==null?void 0:a.coreState.selectedNodes)??[],l=i.filter(w=>w.type===le.GROUP).length>0,d=i.filter(w=>w.type!==le.GROUP),u=d.some(w=>w.groupId),h=d.some(w=>!w.groupId),g=l||u&&!h&&d.length>0,f=d.length>=2&&h;return!g&&!f?null:t.jsx(rn,{id:"ToolbarGroupButton",className:s,type:"button",onClick:()=>o.execute(g?"ungroup":"group"),title:g?"Ungroup (remove from group)":"Group selected nodes (Ctrl+G)","data-test":g?"toolbar-ungroup-button":"toolbar-group-button",...n,children:g?t.jsx(xr,{className:"h-2.5 w-2.5"}):t.jsx(ml,{className:"h-2.5 w-2.5"})})},Zw=e=>{const{className:s}=e,{handleAlignmentChange:n,currentAlignment:o}=Zm();return t.jsxs("div",{className:je("p-0.5 gap-0.5","bg-primary-foreground shadow","flex items-center flex-wrap","pointer-events-auto",s),"data-test":"canvas-node-configurations-toolbar",children:[t.jsx(Zl,{}),t.jsx(Vx,{}),t.jsx(Zx,{textAlignValue:o,onTextAlignmentChange:n}),t.jsx(zx,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(kx,{}),t.jsx(_x,{}),t.jsx(Mx,{}),t.jsx(Lx,{}),t.jsx(hw,{}),t.jsx(Gw,{}),t.jsx(Fx,{}),t.jsx(Bx,{}),t.jsx(dd,{}),t.jsx(qw,{}),t.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),t.jsx(Px,{})]})},ud=({children:e,className:s,dataTest:n,dataAttributes:o={}})=>{const r=Z.nodeUI.idleOpacity;return t.jsx("div",{className:je("relative","bg-primary-foreground shadow rounded flex items-center pointer-events-auto","hover:opacity-100 transition-opacity duration-200",s),style:{zIndex:Te.nodeQuickPanel,opacity:r},onMouseEnter:a=>{a.currentTarget.style.opacity="1"},onMouseLeave:a=>{a.currentTarget.style.opacity=String(r)},"data-test":n,...Object.fromEntries(Object.entries(o).map(([a,i])=>[`data-${a}`,i])),children:e})},Jw=({node:e})=>t.jsx(ud,{className:"space-x-2",dataTest:"node-quick-panel-container",dataAttributes:{"node-id":e.id,"node-type":e.type},children:t.jsx(Zw,{})}),Qw=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??As;return s.length===0?null:s.reduce((r,a)=>a.y<r.y||a.y===r.y&&a.x<r.x?a:r,s[0]).id},hd=e=>e.length===0?null:e.reduce((s,n)=>n.y<s.y||n.y===s.y&&n.x<s.x?n:s,e[0]),ey=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??As,n=hd(s);return(n==null?void 0:n.x)??null},ty=e=>{var o;const s=((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??As,n=hd(s);return(n==null?void 0:n.y)??null},sy=e=>{var s,n;return((n=(s=e.projectCanvas.getActive())==null?void 0:s.coreState.selectedNodes)==null?void 0:n.length)??0},ny=Ie.memo(({node:e,isOpen:s,children:n})=>{const[o,r]=p.useState({top:0,left:0}),a=p.useRef(null),i=z(sy),c=z(Qw),l=z(ey),d=z(ty),h=z(f=>f.uiState.mode)===J.DRAW_ARROW,g=i>0&&c&&l!==null&&d!==null?{...e,id:c}:e;return p.useEffect(()=>{if(!s)return;const f=()=>{var B,W;const m=g,x=document.getElementById(`NodeContainerV2-${m.id}`);if(!x)return;const y=x.getBoundingClientRect(),v=((B=a.current)==null?void 0:B.offsetHeight)||250,N=((W=a.current)==null?void 0:W.offsetWidth)||350,b=window.innerWidth,j=window.innerHeight,R=20;let S=y.left+y.width/2-N/2;const C=Z.nodeUI.quickPanelGap,M=y.top-v-C,I=y.bottom+C,A=M>=R,O=I+v<=j-R;let F;!A&&O?F=I:A?F=M:O?F=I:F=R,S<R?S=R:S+N>b-R&&(S=b-N-R),r({top:F,left:S})};f();const w=setTimeout(f,100);return window.addEventListener("scroll",f,!0),window.addEventListener("resize",f),()=>{clearTimeout(w),window.removeEventListener("scroll",f,!0),window.removeEventListener("resize",f)}},[s,c,l,d]),t.jsxs(t.Fragment,{children:[n,s&&!h&&e.type!==le.DRAWING&&sn.createPortal(t.jsx("div",{ref:a,className:"fixed pointer-events-auto",style:{top:`${o.top}px`,left:`${o.left}px`,zIndex:Te.popover,maxWidth:"90vw"},onPointerDown:f=>f.stopPropagation(),onTouchStart:f=>f.stopPropagation(),onWheel:f=>f.stopPropagation(),children:t.jsx(Jw,{node:e})}),document.body)]})}),oy=[{position:"top",cursor:"cursor-crosshair",classes:"top-0 left-1/2 -translate-x-1/2"},{position:"bottom",cursor:"cursor-crosshair",classes:"bottom-0 left-1/2 -translate-x-1/2"},{position:"left",cursor:"cursor-crosshair",classes:"left-0 top-1/2 -translate-y-1/2"},{position:"right",cursor:"cursor-crosshair",classes:"right-0 top-1/2 -translate-y-1/2"}],ss=8,to=Z.nodeOptions.resizeBorderWidth,ze={corner:{width:ss,height:ss},edge:{horizontal:{height:to,width:`calc(100% - ${ss*2}px)`},vertical:{width:to,height:`calc(100% - ${ss*2}px)`}},position:{cornerTop:`-${ss}px`,cornerLeft:`-${ss}px`,cornerBottom:"100%",cornerRight:"100%",edgeTop:`-${to}px`,edgeLeft:`-${to}px`,topEdge:`${ss}px`,leftEdge:`${ss}px`},edgePosition:{bottom:"100%",left:"100%"}},ay=[{position:"top-left",cursor:"cursor-nwse-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerTop,left:ze.position.cornerLeft}},{position:"top-right",cursor:"cursor-nesw-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerTop,left:ze.position.cornerRight}},{position:"bottom-left",cursor:"cursor-nesw-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerBottom,left:ze.position.cornerLeft}},{position:"bottom-right",cursor:"cursor-nwse-resize",classes:"z-10",style:{...ze.corner,top:ze.position.cornerBottom,left:ze.position.cornerRight}},{position:"top",cursor:"cursor-ns-resize",classes:"",style:{...ze.edge.horizontal,top:ze.position.edgeTop,left:ze.position.leftEdge}},{position:"bottom",cursor:"cursor-ns-resize",classes:"",style:{...ze.edge.horizontal,top:ze.edgePosition.bottom,left:ze.position.leftEdge}},{position:"left",cursor:"cursor-ew-resize",classes:"",style:{...ze.edge.vertical,top:ze.position.topEdge,left:ze.position.edgeLeft}},{position:"right",cursor:"cursor-ew-resize",classes:"",style:{...ze.edge.vertical,top:ze.position.topEdge,left:ze.edgePosition.left}}],ry=e=>{const s=ts(e,"top-left"),n=ts(e,"top-right"),o=ts(e,"bottom-left"),r=ts(e,"bottom-right"),a=ts(e,"top"),i=ts(e,"bottom"),c=ts(e,"left"),l=ts(e,"right");return{"top-left":s,"top-right":n,"bottom-left":o,"bottom-right":r,top:a,bottom:i,left:c,right:l}},{HANDLE_BG_COLOR:iy,HANDLE_BORDER_COLOR:cy}=be,Xa=8,qa=20,Es=(qa-Xa)/2,ly=({node:e,isSelected:s,mode:n})=>{const o=s&&n===J.SELECT,r=ry(e),a=z(h=>h.uiState.nodeHoldToResize),i=(a==null?void 0:a.nodeId)===e.id,c=i?a.edge:null,l=i&&a.isReady,d=i&&a.isHolding,u=Z.nodeUI.resizeHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:ay.map(({position:h,cursor:g,classes:f,style:w})=>{const m=r[h],x=!["top","right","bottom","left"].includes(h),y=c===h,v=y&&l,N=y&&d;return x?t.jsx("div",{"data-test":"resize-handle",id:`resize-handle-${e.id}-${h}`,className:je("absolute transition-opacity duration-200",f,g),style:{width:qa,height:qa,top:typeof(w==null?void 0:w.top)=="string"?`calc(${w.top} - ${Es}px)`:(w==null?void 0:w.top)-Es,left:typeof(w==null?void 0:w.left)=="string"?`calc(${w.left} - ${Es}px)`:(w==null?void 0:w.left)-Es,touchAction:"none",zIndex:Te.canvasResizeHandles,opacity:y?1:u},onMouseEnter:b=>{b.currentTarget.style.opacity="1"},onMouseLeave:b=>{y||(b.currentTarget.style.opacity=String(u))},onPointerDown:b=>{b.stopPropagation(),m(b)},children:t.jsx("div",{className:je("absolute border transition-all duration-150",v?"bg-emerald-500 border-emerald-500 scale-125":N?"bg-amber-500 border-amber-500":je(iy,cy)),style:{width:Xa,height:Xa,top:Es,left:Es,pointerEvents:"none"}})},h):t.jsx("div",{"data-test":"resize-handle",id:`resize-handle-${e.id}-${h}`,className:je("absolute transition-all duration-150",v?"bg-emerald-500/30":N?"bg-amber-500/20":"hover:bg-primary/5",f,g),style:{...w,touchAction:"none",zIndex:Te.canvasResizeHandles},onPointerDown:b=>{b.stopPropagation(),m(b)}},h)})}):null},dy=e=>{const s=Qn(e,"top"),n=Qn(e,"bottom"),o=Qn(e,"left"),r=Qn(e,"right");return p.useMemo(()=>({top:s,bottom:n,left:o,right:r}),[s,n,o,r])},so=-10,uy=({node:e,isSelected:s,mode:n})=>{const o=s&&n===J.SELECT,r=dy(e),a=Z.nodeUI.quickArrowHandleIdleOpacity;return o?t.jsx(t.Fragment,{children:oy.map(({position:i,cursor:c,classes:l})=>{const d=r[i];return t.jsx("div",{"data-test":"quick-arrow-handle",id:`arrow-handle-${e.id}-${i}`,className:je("absolute border rounded-full z-10","bg-blue-500","border-blue-700",l.replace(/-translate-\w+-1\/2/g,"").trim(),c,"pointer-events-auto","transition-opacity duration-200"),style:{width:`${es}px`,height:`${es}px`,top:l.includes("top-0")?`${so-es}px`:l.includes("bottom-0")?`calc(100% + ${es-so}px)`:`calc(50% - ${es/2}px)`,left:l.includes("left-0")?`${so-es}px`:l.includes("right-0")?`calc(100% + ${es-so}px)`:`calc(50% - ${es/2}px)`,opacity:a},onMouseEnter:u=>{u.currentTarget.style.opacity="1"},onMouseLeave:u=>{u.currentTarget.style.opacity=String(a)},onMouseDown:u=>{u.stopPropagation(),d(u)}},`arrow-${i}`)})}):null},hy=e=>{const{node:s,mode:n,isPopoverOpen:o,setIsPopoverOpen:r}=e,a=Ef(s),c=E.getState().setSelectedNodes,l=p.useRef({x:NaN,y:NaN});return{handleMouseDown:p.useCallback(u=>{var I;const h={x:u.clientX,y:u.clientY};l.current=h;const g=u.target;if(n===J.MOVE)return;const w=(I=E.getState().projectCanvas.getActive())==null?void 0:I.coreState.selectedNodes,m=w==null?void 0:w.some(A=>A.id===s.id),x=m&&(w==null?void 0:w.length)===1,y=g.closest(`[id^="resize-handle-${s.id}-"]`),v=g.closest(`[id^="arrow-handle-${s.id}-"]`),N=g.closest("[data-drag-handle]"),R=(g.tagName==="TEXTAREA"||g.closest("textarea")||g.closest("[contenteditable]")||g.closest("[data-node-textarea]")||g.closest(".markdown-textarea")||g.closest("[data-text-node-click-overlay]")||g.isContentEditable||g.closest("[data-text-position-container]"))&&!s.isEditing&&x,S=g.closest(".audio-button-wrapper")||g.closest(".voice-input-button")||g.closest(".nav-button")||g.closest(".chunk-counter"),C=g.closest('[data-test="group-header"] button'),M=g.closest(".node-actions-sidebar button");if(R){const A=E.getState(),O=u.clientX,F=u.clientY;r(!1);const B=document.querySelector(`#NodeContainerV2-${s.id} .markdown-textarea`);if(B){B.contentEditable="true",B.focus({preventScroll:!0});const W=document.querySelector(`#NodeContainerV2-${s.id} [data-text-node-click-overlay]`);W&&(W.style.display="none")}A.updateNode(s.id,{isEditing:!0}),A.setNodeToFocusId(s.id),Km(F)&&Gm({nodeId:s.id,nodeY:s.y}),requestAnimationFrame(()=>{try{let W=null;if(document.caretRangeFromPoint)W=document.caretRangeFromPoint(O,F);else if(document.caretPositionFromPoint){const P=document.caretPositionFromPoint(O,F);P&&(W=document.createRange(),W.setStart(P.offsetNode,P.offset),W.collapse(!0))}if(W){const P=window.getSelection();P&&(P.removeAllRanges(),P.addRange(W))}}catch{}});return}if(y||v||N||S||C||M){r(!1);return}m||r(!1),!s.isEditing&&!R&&a(u)},[s,c,a,n,o,r]),initialClickPoint:l}};function Vo({tags:e,onAddTag:s,onRemoveTag:n,quickTags:o=["left","right","todo","important"],canvasTags:r=[],className:a}){const[i,c]=p.useState(""),l=r.filter(u=>{const h=!i.trim()||u.toLowerCase().includes(i.toLowerCase()),g=!e.includes(u);return h&&g}),d=()=>{const u=i.trim();u&&(s(u),c(""))};return t.jsxs("div",{className:ve("tag-management-ui space-y-3",a),"data-test":"tag-management-ui-container",children:[e.length>0&&t.jsxs("div",{className:"current-tags space-y-2","data-test":"tag-management-current-tags-section",children:[t.jsx("div",{className:"tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-current-tags-label",children:"Current Tags"}),t.jsx("div",{className:"tags-list flex flex-wrap gap-1","data-test":"tag-management-current-tags-list",children:e.map(u=>t.jsxs(Ze,{variant:"secondary",className:"tag-badge text-xs flex items-center gap-1","data-test":"tag-management-tag",children:[u,t.jsx("button",{onClick:()=>n(u),className:"tag-remove-button ml-1 hover:text-destructive",title:"Remove tag","data-test":"tag-management-remove-tag-button",children:t.jsx(Be,{className:"h-3 w-3"})})]},u))})]}),t.jsxs("div",{className:"add-tag-section space-y-2","data-test":"tag-management-add-tag-section",children:[t.jsx("div",{className:"add-tag-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-add-tag-label",children:"Add Tag"}),t.jsxs("div",{className:"add-tag-input-group flex gap-2","data-test":"tag-management-add-tag-input-group",children:[t.jsx(Re,{placeholder:"Enter tag name...",value:i,onChange:u=>c(u.target.value),onKeyDown:u=>{u.key==="Enter"&&i.trim()&&(u.preventDefault(),d())},className:"tag-input h-8 text-sm",autoFocus:!0,"data-test":"tag-management-tag-input"}),t.jsx(Q,{variant:"default",size:"sm",className:"add-tag-button h-8",onClick:d,disabled:!i.trim(),"data-test":"tag-management-add-tag-button",children:t.jsx(wt,{className:"h-4 w-4"})})]})]}),l.length>0&&t.jsxs("div",{className:"canvas-tags-section space-y-2","data-test":"tag-management-canvas-tags-section",children:[t.jsx("div",{className:"canvas-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-canvas-tags-label",children:"Tags in Canvas"}),t.jsx("div",{className:"canvas-tags-list flex flex-wrap gap-1 max-h-14 overflow-y-auto","data-test":"tag-management-canvas-tags-list",children:l.map(u=>t.jsx(Ze,{variant:"outline",className:"canvas-tag cursor-pointer hover:opacity-80 hover:bg-accent",onClick:()=>s(u),"data-test":"tag-management-canvas-tag",children:u},u))})]}),o.length>0&&t.jsxs("div",{className:"quick-tags-section space-y-2","data-test":"tag-management-quick-tags-section",children:[t.jsx("div",{className:"quick-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-quick-tags-label",children:"Quick Add"}),t.jsx("div",{className:"quick-tags-list flex flex-wrap gap-1","data-test":"tag-management-quick-tags-list",children:o.map(u=>{const h=e.includes(u);return t.jsx(Ze,{variant:h?"default":"outline",className:ve("quick-tag cursor-pointer hover:opacity-80",h&&"opacity-50 cursor-not-allowed"),onClick:()=>{h||s(u)},"data-test":"tag-management-quick-tag",children:u},u)})})]})]})}const py=[];function gy({nodeId:e,tags:s,className:n}){const[o,r]=p.useState(!1),a=z(h=>{var g;return((g=h.projectCanvas.getActive())==null?void 0:g.coreState.nodes)??py}),i=Array.isArray(s)?s:[],c=p.useMemo(()=>i.map(h=>h.title),[i]),l=p.useMemo(()=>{const h=new Set;for(const g of a)if(Array.isArray(g.tags))for(const f of g.tags)h.add(f.title);return Array.from(h).sort()},[a]),d=p.useCallback(h=>{const g=E.getState(),f={id:Math.random().toString(36).slice(2,10),title:h};g.addTagToNode(e,f)},[e]),u=p.useCallback(h=>{const g=E.getState(),f=i.find(w=>w.title===h);f&&g.removeTagFromNode(e,f.id)},[e,i]);return t.jsxs(ht,{open:o,onOpenChange:r,"data-test":"tag-selector-popover",children:[t.jsx(pt,{asChild:!0,children:t.jsx(rn,{className:n,onClick:h=>{h.stopPropagation()},title:"Manage tags",variant:"ghost","data-test":"tag-selector-trigger-button",children:t.jsx($n,{})})}),t.jsx(gt,{className:"tag-selector-popover w-64 p-3",align:"start","data-test":"tag-selector-popover-content",children:t.jsx(Vo,{tags:c,onAddTag:d,onRemoveTag:u,canvasTags:l})})]})}function fy({node:e,className:s}){const n=o=>{var d;o.stopPropagation();const r=E.getState(),a=(d=r.projectCanvas.getActive())==null?void 0:d.viewState,i=r.updateNode;if(!a)return;const{scale:c,offset:l}=a;if(e.isPinned){const u=(e.x-l.x)/c,h=(e.y-l.y)/c;i(e.id,{isPinned:!1,x:u,y:h})}else{const u=e.x*c+l.x,h=e.y*c+l.y;i(e.id,{isPinned:!0,x:u,y:h})}};return t.jsx(rn,{className:s,onClick:n,title:e.isPinned?"Unpin from viewport":"Pin to viewport",variant:"ghost",children:e.isPinned?t.jsx(xl,{className:"h-4 w-4 text-blue-500"}):t.jsx(wl,{className:"h-4 w-4"})})}const is=p.forwardRef(({tooltip:e,children:s,...n},o)=>t.jsx(Zt,{children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(Q,{ref:o,...n,children:s})}),t.jsx(Bt,{children:typeof e=="string"?t.jsx("p",{children:e}):e})]})}));is.displayName="ButtonWithTooltip";const pd=p.createContext(null),my=({children:e})=>{const[s,n]=p.useState(null),o=p.useRef(null),r=p.useCallback(c=>{n(c)},[s]),a=p.useCallback(c=>{n(l=>l===c?null:l)},[s]),i=p.useCallback(c=>s===c,[s]);return p.useEffect(()=>{if(!s)return;const c=l=>{var u;const d=l.target;(u=o.current)!=null&&u.contains(d)||d.closest('[data-test^="draggable-popover"]')||n(null)};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[s]),t.jsx(pd.Provider,{value:{activePopoverId:s,openPopover:r,closePopover:a,isPopoverOpen:i},children:t.jsx("div",{ref:o,children:e})})},kr=e=>{const s=p.useContext(pd),[n,o]=p.useState(!1);if(!s)return{isOpen:n,open:()=>o(!0),close:()=>o(!1),toggle:()=>o(c=>!c)};const{isPopoverOpen:r,openPopover:a,closePopover:i}=s;return{isOpen:r(e),open:()=>a(e),close:()=>i(e),toggle:()=>{r(e)?i(e):a(e)}}},cn=({popoverId:e,icon:s,tooltip:n,popoverContent:o,popoverTitle:r,leftOffset:a=180,initialSize:i={width:320,height:400},resizable:c=!0,headerActions:l,buttonVariant:d="secondary",buttonSize:u="sm",dataTest:h})=>{const g=p.useRef(null),[f,w]=p.useState(null),{isOpen:m,open:x,close:y}=kr(e),v=()=>{if(m){y();return}if(g.current){const N=g.current.getBoundingClientRect(),{width:b,height:j}=i,R=N.left+N.width/2,S=N.top+N.height/2;w({x:R-b/2+a,y:S-j/2})}x()};return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:g,variant:d,size:u,tooltip:n,onClick:v,"data-test":h,children:t.jsx(s,{className:"h-4 w-4"})}),t.jsx(Ve,{isVisible:m,onClose:y,title:r,triggerPosition:f??void 0,initialSize:i,resizable:c,shouldCloseManually:!0,headerActions:l,children:o})]})};function xy(e){const n=Date.now()-e,o=Math.floor(n/1e3),r=Math.floor(o/60),a=Math.floor(r/60);return o<60?"just now":r<60?`${r} min ago`:a<24?`${a} hour${a>1?"s":""} ago`:"over a day ago"}const wy=[],yy=({node:e})=>{var x,y,v,N,b,j,R,S;const s=z(C=>C.uiState.arrangeSnapshot),n=z(C=>C.revertArrangeSnapshot),o=z(C=>{var M;return((M=C.projectCanvas.getActive())==null?void 0:M.coreState.nodes)??wy}),r=e.data,a=r==null?void 0:r.automation,i=p.useMemo(()=>{const C=new Set;for(const M of o)if(Array.isArray(M.tags))for(const I of M.tags)C.add(I.title);return Array.from(C).sort()},[o]),c=p.useMemo(()=>{if(!s)return null;const C=Object.keys(s.nodePositions).length,M=xy(s.timestamp);return{nodeCount:C,relativeTime:M}},[s]),l=()=>{n()},d=p.useCallback(C=>{const M=e.data??{childNodeIds:[]},I={...M.automation,...C};E.getState().updateNode(e.id,{data:{...M,automation:I}})},[e.id,e.data]),u=p.useCallback(C=>{var M;d({onEnter:{enabled:C,tags:((M=a==null?void 0:a.onEnter)==null?void 0:M.tags)??[]}})},[d,(x=a==null?void 0:a.onEnter)==null?void 0:x.tags]),h=p.useCallback(C=>{var I,A;const M=((I=a==null?void 0:a.onEnter)==null?void 0:I.tags)??[];M.includes(C)||d({onEnter:{enabled:((A=a==null?void 0:a.onEnter)==null?void 0:A.enabled)??!0,tags:[...M,C]}})},[d,a==null?void 0:a.onEnter]),g=p.useCallback(C=>{var I,A;const M=((I=a==null?void 0:a.onEnter)==null?void 0:I.tags)??[];d({onEnter:{enabled:((A=a==null?void 0:a.onEnter)==null?void 0:A.enabled)??!1,tags:M.filter(O=>O!==C)}})},[d,a==null?void 0:a.onEnter]),f=p.useCallback(C=>{var M;d({onLeave:{enabled:C,tags:((M=a==null?void 0:a.onLeave)==null?void 0:M.tags)??[]}})},[d,(y=a==null?void 0:a.onLeave)==null?void 0:y.tags]),w=p.useCallback(C=>{var I,A;const M=((I=a==null?void 0:a.onLeave)==null?void 0:I.tags)??[];M.includes(C)||d({onLeave:{enabled:((A=a==null?void 0:a.onLeave)==null?void 0:A.enabled)??!0,tags:[...M,C]}})},[d,a==null?void 0:a.onLeave]),m=p.useCallback(C=>{var I,A;const M=((I=a==null?void 0:a.onLeave)==null?void 0:I.tags)??[];d({onLeave:{enabled:((A=a==null?void 0:a.onLeave)==null?void 0:A.enabled)??!1,tags:M.filter(O=>O!==C)}})},[d,a==null?void 0:a.onLeave]);return t.jsx(cn,{popoverId:`action-settings-${e.id}`,icon:Un,tooltip:"Group Settings",popoverTitle:"Group Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"group-settings-content",children:[t.jsxs("div",{"data-test":"group-settings-automation-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-3",children:"Automation"}),t.jsxs("div",{className:"space-y-2 mb-4","data-test":"group-settings-on-enter",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(Ee,{htmlFor:"on-enter-switch",className:"text-sm",children:"Add tags when node enters"}),t.jsx(Co,{id:"on-enter-switch",checked:((v=a==null?void 0:a.onEnter)==null?void 0:v.enabled)??!1,onCheckedChange:u,"data-test":"group-settings-on-enter-switch"})]}),((N=a==null?void 0:a.onEnter)==null?void 0:N.enabled)&&t.jsx(Vo,{tags:((b=a==null?void 0:a.onEnter)==null?void 0:b.tags)??[],onAddTag:h,onRemoveTag:g,canvasTags:i,quickTags:[],className:"mt-2"})]}),t.jsxs("div",{className:"space-y-2","data-test":"group-settings-on-leave",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(Ee,{htmlFor:"on-leave-switch",className:"text-sm",children:"Remove tags when node leaves"}),t.jsx(Co,{id:"on-leave-switch",checked:((j=a==null?void 0:a.onLeave)==null?void 0:j.enabled)??!1,onCheckedChange:f,"data-test":"group-settings-on-leave-switch"})]}),((R=a==null?void 0:a.onLeave)==null?void 0:R.enabled)&&t.jsx(Vo,{tags:((S=a==null?void 0:a.onLeave)==null?void 0:S.tags)??[],onAddTag:w,onRemoveTag:m,canvasTags:i,quickTags:[],className:"mt-2"})]})]}),t.jsx("div",{className:"border-t border-border"}),t.jsxs("div",{"data-test":"group-settings-arrangement-section",children:[t.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:"Arrangement"}),c?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-xs text-muted-foreground",children:[c.nodeCount," node",c.nodeCount!==1?"s":""," • ",c.relativeTime]}),t.jsxs(Q,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:l,"data-test":"group-settings-revert-button",children:[t.jsx(cr,{className:"h-4 w-4 mr-2"}),"Revert to Initial Positions"]})]}):t.jsx("div",{className:"text-xs text-muted-foreground italic",children:"No arrangement to revert"})]})]}),initialSize:{width:320,height:400},buttonVariant:"ghost",buttonSize:"icon",dataTest:"group-settings-button"})},vy=({node:e})=>{const s=e.data,n=(s==null?void 0:s.vocabType)??Ge.DICTIONARY,o=p.useCallback(i=>{const c=i,l=e.data??{vocabType:Ge.DICTIONARY,term:"",definition:""};E.getState().updateNode(e.id,{data:{...l,vocabType:c}})},[e.id,e.data]),r=p.useCallback(()=>{const i=e.data??{vocabType:Ge.VOCABULARY,term:"",definition:""};E.getState().updateNode(e.id,{data:{...i,sourceWord:i.translationWord||"",translationWord:i.sourceWord||""}})},[e.id,e.data]),a=n===Ge.VOCABULARY;return t.jsx(cn,{popoverId:`vocab-settings-${e.id}`,icon:Un,tooltip:"Vocabulary Settings",popoverTitle:"Vocabulary Settings",popoverContent:t.jsxs("div",{className:"p-3 space-y-4","data-test":"vocab-settings-content",children:[t.jsxs("div",{"data-test":"vocab-settings-type-section",children:[t.jsx(Ee,{htmlFor:"vocab-type-select",className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Vocabulary Type"}),t.jsxs(ct,{value:n,onValueChange:o,children:[t.jsx(lt,{id:"vocab-type-select","data-test":"vocab-type-select",className:"w-full",children:t.jsx(dt,{})}),t.jsxs(ut,{children:[t.jsx(_e,{value:Ge.DICTIONARY,children:"Dictionary"}),t.jsx(_e,{value:Ge.FLASHCARD,children:"Flashcard"}),t.jsx(_e,{value:Ge.WORD_LIST,children:"Word List"}),t.jsx(_e,{value:Ge.ETYMOLOGY,children:"Etymology"}),t.jsx(_e,{value:Ge.VOCABULARY,children:"Vocabulary"})]})]})]}),a&&t.jsx("div",{"data-test":"vocab-settings-swap-section",children:t.jsxs(Q,{variant:"outline",size:"sm",className:"w-full",onClick:r,"data-test":"vocab-swap-words-button",children:[t.jsx(ws,{className:"h-4 w-4 mr-2"}),"Swap Words"]})})]}),initialSize:{width:280,height:a?180:120},buttonVariant:"ghost",buttonSize:"icon",dataTest:"vocab-settings-button"})},by={template:"TEMPLATES",bug:"BUG INVESTIGATIONS",experiment:"EXPERIMENTS",archive:"ARCHIVED"},Vi={all:"All Categories",template:"Templates",bug:"Bug Investigations",experiment:"Experiments",archive:"Archived"},Ny={template:"bg-purple-500/20 text-purple-700 dark:text-purple-300 border-purple-500/30",bug:"bg-red-500/20 text-red-700 dark:text-red-300 border-red-500/30",experiment:"bg-blue-500/20 text-blue-700 dark:text-blue-300 border-blue-500/30",archive:"bg-gray-500/20 text-gray-700 dark:text-gray-300 border-gray-500/30"},Sy={template:yl,bug:Yo,experiment:Dh,archive:Ph},Ui=2,Gi=["template","bug","experiment","archive"];function Cy(e){const s={template:[],bug:[],experiment:[],archive:[]},n=[];for(const o of e)o.category&&o.category in s?s[o.category].push(o):n.push(o);return{categorized:s,uncategorized:n}}function Yi({fork:e}){var r,a;const s=((r=e.tags)==null?void 0:r.slice(0,Ui))??[],n=(((a=e.tags)==null?void 0:a.length)??0)-Ui,o=e.category?Sy[e.category]:null;return t.jsxs("div",{className:"flex flex-col items-start gap-0.5","data-test":"fork-option-content",children:[t.jsxs("div",{className:"flex items-center gap-1.5 w-full",children:[o&&t.jsx(o,{size:12,className:"flex-shrink-0 text-muted-foreground","data-test":"fork-option-category-icon"}),t.jsx("span",{className:"font-medium truncate","data-test":"fork-option-name",children:e.sessionName??e.description??`Fork ${e.sessionId.slice(0,8)}`}),e.category&&t.jsx(Ze,{variant:"outline",className:ve("text-[9px] px-1 py-0 h-3.5 ml-auto flex-shrink-0",Ny[e.category]),"data-test":"fork-option-category-badge",children:e.category})]}),t.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[t.jsxs("span",{"data-test":"fork-option-message-count",children:[e.messageCount??0," messages"]}),s.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"mx-0.5",children:"|"}),s.map(i=>t.jsx(Ze,{variant:"secondary",className:"text-[9px] px-1 py-0 h-3.5 bg-secondary/50","data-test":"fork-option-tag",children:i},i)),n>0&&t.jsxs("span",{className:"text-[9px]","data-test":"fork-option-tags-overflow",children:["+",n]})]})]})]})}function jy({value:e,onChange:s,showLabel:n=!0,label:o="Fork From",placeholder:r="No fork (new session)",className:a="",disabled:i=!1,filterByCategory:c,filterByTag:l,showFilters:d=!1}){const[u,h]=p.useState("all"),[g,f]=p.useState(""),w=c??(u!=="all"?u:void 0),m=l??(g.trim()||void 0),{forks:x,loading:y,loadForks:v}=au({loadOnMount:!0,filterByCategory:w,filterByTag:m});p.useEffect(()=>{v(1)},[w,m]);const N=p.useMemo(()=>Cy(x),[x]),b=p.useMemo(()=>Gi.some(S=>N.categorized[S].length>0)||N.uncategorized.length>0,[N]),j=S=>{s==null||s(S==="none"?null:S)},R=S=>{h(S)};return t.jsxs("div",{className:"fork-session-selector space-y-2","data-test":"fork-session-selector",children:[n&&t.jsxs(Ee,{className:"flex items-center gap-1","data-test":"fork-session-selector-label",children:[t.jsx(Mh,{className:"h-3 w-3"}),o]}),d&&t.jsxs("div",{className:"flex items-center gap-2","data-test":"fork-session-selector-filters",children:[t.jsxs(ct,{value:u,onValueChange:R,disabled:i,children:[t.jsx(lt,{className:"h-8 text-xs w-[140px]","data-test":"fork-filter-category-trigger",children:t.jsx(dt,{placeholder:"Category"})}),t.jsx(ut,{"data-test":"fork-filter-category-options",style:{zIndex:Te.draggablePopoverDropdown},children:Object.keys(Vi).map(S=>t.jsx(_e,{value:S,"data-test":`fork-filter-category-${S}`,children:Vi[S]},S))})]}),t.jsxs("div",{className:"relative flex-1",children:[t.jsx(rs,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3 w-3 text-muted-foreground","data-test":"fork-filter-tag-icon"}),t.jsx(Re,{type:"text",placeholder:"Filter by tag...",value:g,onChange:S=>f(S.target.value),className:"h-8 text-xs pl-7",disabled:i,"data-test":"fork-filter-tag-input"})]})]}),t.jsxs(ct,{value:e??"none",onValueChange:j,disabled:i,children:[t.jsx(lt,{className:`fork-selector ${a}`,"data-test":"fork-session-selector-trigger",children:t.jsx(dt,{placeholder:r})}),t.jsxs(ut,{"data-test":"fork-session-selector-options",style:{zIndex:Te.draggablePopoverDropdown},className:"max-h-[300px]",children:[t.jsx(_e,{value:"none","data-test":"fork-option-none",children:t.jsx("span",{className:"text-muted-foreground",children:r})}),y?t.jsx(_e,{value:"loading",disabled:!0,"data-test":"fork-option-loading",children:"Loading forks..."}):b?t.jsxs(t.Fragment,{children:[Gi.map(S=>{const C=N.categorized[S];return C.length===0?null:t.jsxs(Fr,{"data-test":`fork-group-${S}`,children:[t.jsx($r,{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider","data-test":`fork-group-label-${S}`,children:by[S]}),C.map(M=>t.jsx(_e,{value:M.sessionId,"data-test":"fork-option-item",children:t.jsx(Yi,{fork:M})},M.id))]},S)}),N.uncategorized.length>0&&t.jsxs(Fr,{"data-test":"fork-group-uncategorized",children:[t.jsx($r,{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider","data-test":"fork-group-label-uncategorized",children:"OTHER"}),N.uncategorized.map(S=>t.jsx(_e,{value:S.sessionId,"data-test":"fork-option-item",children:t.jsx(Yi,{fork:S})},S.id))]})]}):t.jsx(_e,{value:"empty",disabled:!0,"data-test":"fork-option-empty",children:"No forks available"})]})]})]})}const ky=[{value:"low",label:"Low",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"medium",label:"Medium",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"high",label:"High",variant:"secondary",className:"bg-orange-100 text-orange-800 border-orange-200"},{value:"urgent",label:"Urgent",variant:"destructive",className:"bg-red-100 text-red-800 border-red-200"}],Ay=[{value:"freezer",label:"Freezer",variant:"secondary",className:"bg-cyan-100 text-cyan-800 border-cyan-200"},{value:"backlog",label:"Backlog",variant:"secondary",className:"bg-gray-100 text-gray-800 border-gray-200"},{value:"selected",label:"Selected",variant:"secondary",className:"bg-yellow-100 text-yellow-800 border-yellow-200"},{value:"doing",label:"Doing",variant:"secondary",className:"bg-blue-100 text-blue-800 border-blue-200"},{value:"done",label:"Done",variant:"secondary",className:"bg-green-100 text-green-800 border-green-200"},{value:"archive",label:"Archive",variant:"secondary",className:"bg-slate-100 text-slate-800 border-slate-200"}],Iy=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.data)==null?void 0:o.projects)??[]},Ty=e=>{var s,n,o;return((o=(n=(s=e.app)==null?void 0:s.claude)==null?void 0:n.ui)==null?void 0:o.loadingProjects)??!1};function Ey({status:e="backlog",priority:s="medium",category:n="",dueDate:o="",claudeProject:r,forkSessionId:a,sessionIds:i=[],tags:c=[],onStatusChange:l,onPriorityChange:d,onCategoryChange:u,onDueDateChange:h,onClaudeProjectChange:g,onForkSessionIdChange:f,onSessionIdsChange:w,onTagsChange:m,showForkSelector:x=!1,showSessionSelector:y=!1,showTags:v=!0,compact:N=!1}){const b=yo(Iy),j=yo(Ty),R=p.useMemo(()=>b.map(A=>({value:A.path,label:A.name,variant:"outline",className:"bg-purple-50 text-purple-800 border-purple-200"})),[b]),S=p.useMemo(()=>[{value:"__no_project__",label:"No Project",variant:"outline",className:"bg-gray-50 text-gray-600 border-gray-200"},...R],[R]),C=p.useCallback(A=>{const O=A.trim();O&&!c.includes(O)&&(m==null||m([...c,O]))},[c,m]),M=p.useCallback(A=>{m==null||m(c.filter(O=>O!==A))},[c,m]),I=p.useCallback(A=>{const O=Array.isArray(A)?A:[A];w==null||w(O)},[w]);return t.jsxs("div",{className:`todo-metadata-form space-y-4 ${N?"text-sm":""}`,"data-test":"todo-metadata-form",children:[t.jsxs("div",{className:"selector-status space-y-2","data-test":"todo-metadata-status-selector",children:[t.jsx(Ee,{"data-test":"todo-metadata-status-label",children:"Status"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(ru,{value:e,options:Ay,onChange:A=>l==null?void 0:l(A),placeholder:"Search status...","data-test":"todo-metadata-status-select"})})]}),t.jsxs("div",{className:"selector-priority space-y-2","data-test":"todo-metadata-priority-selector",children:[t.jsx(Ee,{"data-test":"todo-metadata-priority-label",children:"Priority"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(zr,{value:s,options:ky,onChange:A=>d==null?void 0:d(A),placeholder:"Search priorities...",contentStyle:{zIndex:Te.draggablePopoverDropdown},"data-test":"todo-metadata-priority-badge"})})]}),t.jsxs("div",{className:"selector-category space-y-2","data-test":"todo-metadata-category-selector",children:[t.jsx(Ee,{"data-test":"todo-metadata-category-label",children:"Category"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(iu,{value:n||"personal",onChange:A=>u==null?void 0:u(A),placeholder:"Search categories...","data-test":"todo-metadata-category-select"})})]}),!j&&S.length>1&&t.jsxs("div",{className:"selector-project space-y-2","data-test":"todo-metadata-project-selector",children:[t.jsx(Ee,{"data-test":"todo-metadata-project-label",children:"Claude Project"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:t.jsx(zr,{value:r??"__no_project__",options:S,onChange:A=>g==null?void 0:g(A),placeholder:"Search projects...",contentStyle:{zIndex:Te.draggablePopoverDropdown},"data-test":"todo-metadata-project-badge"})})]}),x&&t.jsx(jy,{value:a,onChange:f,showLabel:!0,className:"w-full"}),y&&t.jsxs("div",{className:"selector-sessions space-y-2","data-test":"todo-metadata-session-selector",children:[t.jsx(Ee,{"data-test":"todo-metadata-session-selector-label",children:"Claude Sessions"}),t.jsx(cu,{value:i,onChange:I,showLabel:!1,placeholder:"Link to sessions",multiSelect:!0,"data-test":"todo-metadata-session-select"})]}),v&&t.jsxs("div",{className:"selector-tags space-y-2","data-test":"todo-metadata-tags-selector",children:[t.jsx(Ee,{"data-test":"todo-metadata-tags-label",children:"Tags"}),t.jsx(Ry,{tags:c,onAddTag:C,onRemoveTag:M})]}),t.jsxs("div",{className:"form-field-due-date space-y-2","data-test":"todo-metadata-due-date-field",children:[t.jsx(Ee,{htmlFor:"dueDate","data-test":"todo-metadata-due-date-label",children:"Due Date"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Oh,{className:"w-4 h-4 text-gray-400"}),t.jsx(Re,{id:"dueDate",type:"date",value:o,onChange:A=>h==null?void 0:h(A.target.value),"data-test":"todo-metadata-due-date-input"})]})]})]})}function Ry({tags:e,onAddTag:s,onRemoveTag:n}){const o=p.useCallback(a=>{if(a.key==="Enter"){a.preventDefault();const i=a.currentTarget;s(i.value),i.value=""}},[s]),r=p.useCallback(()=>{const a=document.querySelector('[data-test="todo-metadata-tag-input"]');a&&(s(a.value),a.value="")},[s]);return t.jsxs("div",{className:"tags-container space-y-2","data-test":"todo-metadata-tags-container",children:[t.jsx("div",{className:"tags-list flex flex-wrap gap-2","data-test":"todo-metadata-tags-list",children:e.map(a=>t.jsxs(Ze,{variant:"outline",className:"tag-badge gap-1","data-test":"todo-metadata-tag",children:[a,t.jsx("button",{onClick:()=>n(a),className:"tag-remove ml-1 hover:text-red-500","data-test":"todo-metadata-tag-remove",children:t.jsx(Be,{className:"w-3 h-3"})})]},a))}),t.jsxs("div",{className:"tag-input flex gap-2","data-test":"todo-metadata-tag-input-container",children:[t.jsx(Re,{onKeyDown:o,placeholder:"Add a tag...","data-test":"todo-metadata-tag-input"}),t.jsx(Q,{onClick:r,size:"sm",className:"tag-add-button","data-test":"todo-metadata-tag-add-button",children:t.jsx(wt,{className:"w-4 h-4"})})]})]})}const My=({node:e})=>{const[s,n]=p.useState(!1),o=p.useRef(null),r=e.data,a=r==null?void 0:r.todo,i=p.useCallback(()=>{if(!o.current)return{x:100,y:100};const x=o.current.getBoundingClientRect();return{x:x.right+8,y:x.top}},[]),c=p.useCallback(x=>{const y=e.data??{},v=y.todo??{};E.getState().updateNode(e.id,{data:{...y,todo:{...v,...x}}})},[e.id,e.data]),l=p.useCallback(x=>{c({status:x})},[c]),d=p.useCallback(x=>{c({priority:x})},[c]),u=p.useCallback(x=>{c({category:x})},[c]),h=p.useCallback(x=>{c({dueDate:x||void 0})},[c]),g=p.useCallback(x=>{c({claudeProjectPath:x==="__no_project__"?void 0:x})},[c]),f=p.useCallback(x=>{c({sessionIds:x})},[c]),w=p.useCallback(x=>{c({forkSessionId:x??void 0})},[c]),m=a&&(a.status||a.priority||a.category||a.dueDate||a.claudeProjectPath||a.forkSessionId||a.sessionIds&&a.sessionIds.length>0);return t.jsxs(t.Fragment,{children:[t.jsx(Q,{ref:o,variant:"ghost",size:"icon",className:`todo-metadata-button h-8 w-8 ${m?"text-blue-500":"text-muted-foreground"}`,onClick:()=>n(!0),title:"Todo Metadata","data-test":"node-todo-metadata-button",children:t.jsx(Lh,{className:"h-4 w-4"})}),t.jsx(Ve,{isVisible:s,onClose:()=>n(!1),title:"Todo Metadata",triggerPosition:i(),initialSize:{width:300,height:450},resizable:!0,shouldCloseManually:!0,headerActions:t.jsx(lu,{variant:"ghost",size:"icon",buttonTitle:"Create Claude Session",projectPath:a==null?void 0:a.claudeProjectPath,initialForkSessionId:a==null?void 0:a.forkSessionId,initialMessage:typeof e.content=="string"?e.content:"",useModal:!0}),children:t.jsx("div",{className:"p-4",children:t.jsx(Ey,{status:a==null?void 0:a.status,priority:a==null?void 0:a.priority,category:a==null?void 0:a.category,dueDate:a==null?void 0:a.dueDate,claudeProject:a==null?void 0:a.claudeProjectPath,forkSessionId:a==null?void 0:a.forkSessionId,sessionIds:a==null?void 0:a.sessionIds,onStatusChange:l,onPriorityChange:d,onCategoryChange:u,onDueDateChange:h,onClaudeProjectChange:g,onForkSessionIdChange:w,onSessionIdsChange:f,showForkSelector:!0,showSessionSelector:!0,showTags:!1,compact:!0})})})]})},Py=({node:e})=>{const s=e.type===le.GROUP,n=e.type===le.VOCABULARY,o=Z.nodeUI.idleOpacity;return t.jsxs("div",{className:je("node-actions-sidebar absolute","gap-1","items-center","hover:opacity-100 transition-opacity duration-200"),style:{left:-50,opacity:o},onMouseEnter:r=>{r.currentTarget.style.opacity="1"},onMouseLeave:r=>{r.currentTarget.style.opacity=String(o)},"data-test":"node-container-extra",children:[t.jsx("div",{className:"pin-button-wrapper",children:t.jsx(fy,{node:e})}),t.jsx("div",{className:"text-editor-button-wrapper",children:e.subContent?t.jsx(Zl,{className:"my-2"}):null}),t.jsx("div",{className:"tag-selector-wrapper",children:t.jsx(gy,{nodeId:e.id,tags:e.tags})}),t.jsx("div",{className:"todo-metadata-wrapper",children:t.jsx(My,{node:e})}),s&&t.jsx("div",{className:"group-settings-button-wrapper","data-test":"group-settings-wrapper",children:t.jsx(yy,{node:e})}),n&&t.jsx("div",{className:"vocab-settings-button-wrapper","data-test":"vocab-settings-wrapper",children:t.jsx(vy,{node:e})})]})},Dy={columns:[{key:"word",header:"Word",width:"150px"},{key:"translation",header:"Translation",width:"150px"},{key:"notes",header:"Notes",width:"100px"}],rows:[{id:"1",word:"hello",translation:"hallo",notes:""},{id:"2",word:"goodbye",translation:"auf Wiedersehen",notes:""},{id:"3",word:"thank you",translation:"danke",notes:""}]},Oy=({node:e})=>{const{updateNode:s}=E.getState(),n=z(j=>{var R,S;return((R=j.uiState.tableDropTarget)==null?void 0:R.tableId)===e.id?((S=j.uiState.tableDropTarget)==null?void 0:S.columnKey)??null:null}),o=z(j=>{var R,S;return((R=j.uiState.tableDropTarget)==null?void 0:R.tableId)===e.id?((S=j.uiState.tableDropTarget)==null?void 0:S.rowIndex)??null:null}),[r,a]=p.useState(!1),i=p.useRef(null);p.useEffect(()=>{e.isEditing!==void 0&&e.isEditing!==r&&a(e.isEditing)},[e.isEditing]),p.useEffect(()=>{if(!r)return;const j=R=>{const S=R.target,C=i.current;C&&S.closest('[data-test="table-node-container"]')===C&&(R.stopPropagation(),R.preventDefault(),C.scrollTop+=R.deltaY,C.scrollLeft+=R.deltaX)};return document.addEventListener("wheel",j,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",j,{capture:!0})}},[r,e.id]);const c=e.data,l=c!=null&&c.rows&&(c!=null&&c.columns)?c:Dy,d=p.useCallback((j,R)=>{const S=l.columns.map(C=>C.key===j?{...C,header:R}:C);s(e.id,{data:{...l,columns:S}})},[e.id,l,s]),u=p.useCallback(j=>{const R=l.rows.filter(S=>S.id!==j);s(e.id,{data:{...l,rows:R}})},[e.id,l,s]),h=p.useMemo(()=>{const j=l.columns.map(R=>Sp(R.key,R.header,{width:R.width}));return j.push({id:"actions",header:()=>t.jsx("div",{"data-test":"actions-header"}),size:40,cell:({row:R})=>r?t.jsx(Q,{"data-test":"delete-row-button",variant:"ghost",size:"sm",onClick:()=>u(R.original.id),className:"h-6 w-6 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",children:t.jsx(yt,{className:"h-3 w-3"})}):null}),j},[l.columns,r,u]),g=p.useCallback((j,R,S)=>{const C=l.rows.map((M,I)=>I===j?{...M,[R]:S}:M);s(e.id,{data:{...l,rows:C}})},[e.id,l,s]),f=p.useCallback(()=>{const j={id:`row-${Date.now()}`};l.columns.forEach(R=>{j[R.key]=""}),s(e.id,{data:{...l,rows:[...l.rows,j]}})},[e.id,l,s]),w=p.useCallback(j=>{const R={id:`row-${Date.now()}`};l.columns.forEach(C=>{R[C.key]=""});const S=[...l.rows.slice(0,j),R,...l.rows.slice(j)];s(e.id,{data:{...l,rows:S}})},[e.id,l,s]),m=p.useCallback((j,R)=>{const S=[...l.rows],[C]=S.splice(j,1);S.splice(R,0,C),s(e.id,{data:{...l,rows:S}})},[e.id,l,s]),x=p.useCallback(j=>{s(e.id,{data:{...l,columnOrder:j}})},[e.id,l,s]),y=p.useCallback(()=>{const j=!r;a(j),s(e.id,{isEditing:j})},[r,e.id,s]),v=p.useCallback(()=>{r||(a(!0),s(e.id,{isEditing:!0}))},[r,e.id,s]),N=p.useCallback(j=>{r&&(j.stopPropagation(),j.nativeEvent.stopPropagation(),j.nativeEvent.stopImmediatePropagation())},[r,e.id]),b=p.useCallback(()=>{const j=i.current;if(!j)return;const R=document.querySelector("[data-canvas-container]"),S=R==null?void 0:R.getBoundingClientRect();Fc(async()=>{const{canvasStoreV2:C}=await import("./index-BEUYSeX_.js").then(M=>M.df);return{canvasStoreV2:C}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({canvasStoreV2:C})=>{const M=C.getState().projectCanvas.getActive(),I=(M==null?void 0:M.viewState.scale)??1,A=(M==null?void 0:M.viewState.offset)??{x:0,y:0},O=W=>{if(!S)return null;const P=W.x-S.left,k=W.y-S.top;return{x:Math.round((P-A.x)/I),y:Math.round((k-A.y)/I),w:Math.round(W.width/I),h:Math.round(W.height/I)}};j.getBoundingClientRect();const F=j.querySelector("thead tr");F==null||F.getBoundingClientRect();const B=j.querySelectorAll("tbody tr");Array.from(B).map((W,P)=>({index:P,canvas:O(W.getBoundingClientRect())}))})},[e.id,e.x,e.y]);return t.jsx("div",{ref:i,"data-test":"table-node-container",style:{width:"100%",height:"100%",overflow:r?"auto":"hidden"},onDoubleClick:v,onWheel:N,onClick:b,children:t.jsx(Cp,{data:l.rows,columns:h,isEditing:r,onDataUpdate:g,onHeaderUpdate:d,onAddNewRow:r?f:void 0,onInsertRow:r?w:void 0,enableColumnReorder:r,onColumnOrderChange:x,enableRowReorder:r,onRowOrderChange:m,highlightColumnKey:n,highlightRowIndex:o,topRight:t.jsxs("div",{className:"flex items-center gap-1","data-test":"table-header-actions",children:[t.jsx(Q,{"data-test":"table-edit-toggle",onClick:y,size:"sm",variant:"outline",className:"h-6 text-xs",children:r?"Done":"Edit"}),t.jsx(Go,{storageKey:"table-node-drop-config",initialConfig:{dropBehavior:Z.canvasTable.dropBehavior},children:(j,R,S)=>t.jsx(S,{size:"smIconCompact",variant:"ghost",title:"Table Drop Settings",contentClassName:"w-48",children:t.jsxs("div",{className:"space-y-3","data-test":"table-drop-config",children:[t.jsx("div",{className:"text-sm font-medium","data-test":"config-title",children:"On node drop"}),t.jsxs(du,{value:j.dropBehavior,onValueChange:C=>R({dropBehavior:C}),"data-test":"drop-behavior-radio",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(_r,{value:"copy",id:"copy","data-test":"radio-copy"}),t.jsx(Ee,{htmlFor:"copy",className:"text-sm cursor-pointer","data-test":"label-copy",children:"Copy nodes"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(_r,{value:"delete",id:"delete","data-test":"radio-delete"}),t.jsx(Ee,{htmlFor:"delete",className:"text-sm cursor-pointer","data-test":"label-delete",children:"Delete nodes"})]})]})]})})})]})})})},Ly=({node:e,preventEdit:s})=>{var A;const n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(e.title||""),[l,d]=p.useState(e.content||""),{onEditStart:u,onEditEnd:h}=tn(e.id,"title"),{onEditStart:g,onEditEnd:f}=tn(e.id,"content"),w=E.getState(),m=w.updateNode,x=w.setMode,y=w.uiState.nodeToFocusId,v=(A=w.projectCanvas.getActive())==null?void 0:A.coreState,N=(v==null?void 0:v.selectedNodes)??[],b=N.some(O=>O.id===e.id),j=b&&y===e.id,R=O=>{c(O.target.value)},S=O=>{d(O.target.value)},C=p.useCallback(()=>{var O;m(e.id,{title:i,content:l,isEditing:!1}),h(i),f(l),a(!1),(O=window.getSelection())==null||O.removeAllRanges()},[e.id,m,i,l,h,f]),M=p.useCallback(()=>{b&&N.length<=1&&!s&&(r||(u(e.title||""),g(e.content||"")),a(!0),m(e.id,{isEditing:!0}))},[b,N.length,s,m,e.id,r,e.title,e.content,u,g]),I=p.useCallback(O=>{var F,B;if(O.key==="Escape"){C(),E.getState().uiState.mode!==J.VIM&&x(J.SELECT),(F=n.current)==null||F.blur(),(B=o.current)==null||B.blur();return}},[C,x]);return p.useEffect(()=>{j&&r&&n.current&&n.current.focus()},[j,r]),p.useEffect(()=>{c(e.title||""),d(e.content||"")},[e.title,e.content]),t.jsxs("div",{className:"w-full h-full flex flex-col",children:[t.jsx("div",{className:"title-section border-b",children:t.jsx("input",{ref:n,type:"text",value:i,onChange:R,onBlur:C,onMouseDown:M,onKeyDown:I,placeholder:"Title...",className:je("w-full px-2 py-1","text-sm font-semibold","border-none focus:outline-none","bg-transparent",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})}),t.jsx("div",{className:"content-section flex-1",children:t.jsx("textarea",{ref:o,value:l,onChange:S,onBlur:C,onMouseDown:M,onKeyDown:I,placeholder:"Content...",className:je("w-full h-full","px-2 py-1","text-sm","border-none focus:outline-none","bg-transparent","resize-none","overflow-hidden",{"pointer-events-none":s,"cursor-text":r,"cursor-default":!r}),readOnly:!r})})]})},Wy=({node:e,isSingleNodeSelected:s,isCollapsed:n=!1})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(e.title||""),c=p.useRef(null),l=p.useRef(e.title||""),{onEditStart:d,onEditEnd:u}=tn(e.id,"title");p.useEffect(()=>{i(e.title||""),l.current=e.title||""},[e.title]),p.useEffect(()=>{l.current=a},[a]),p.useEffect(()=>{o&&c.current&&(c.current.focus(),c.current.select())},[o]),p.useEffect(()=>{if(s)return()=>{const b=l.current.trim();b!==e.title&&E.getState().updateNodeTitle(e.id,b)}},[s,e.id,e.title]);const h=p.useCallback(()=>{const b=a.trim();b!==e.title&&E.getState().updateNodeTitle(e.id,b),u(b),r(!1)},[e.id,a,e.title,u]),g=p.useCallback(b=>{b.key==="Enter"?(b.preventDefault(),h()):b.key==="Escape"&&(b.preventDefault(),i(e.title||""),r(!1))},[h,e.title]),f=()=>{if(e.title)return e.title;if(typeof e.content=="string"){const b=e.content.split(`
`)[0];return b.length>50?b.substring(0,50)+"...":b}return"(empty)"},w=p.useMemo(()=>e.title?Qr(e.title):"",[e.title]),m=p.useMemo(()=>{const b=f();return Qr(b)},[e.title,e.content]),x=z(b=>{var S;const R=(((S=b.projectCanvas.getActive())==null?void 0:S.coreState.nodes)??[]).find(C=>C.id===e.id);return(R==null?void 0:R.isCollapsed)??!1}),y=p.useCallback(b=>{b.stopPropagation(),b.preventDefault(),E.getState().updateNode(e.id,{isCollapsed:!x})},[e.id,x]),v=Z.nodeUI.idleOpacity,N=t.jsx(Q,{title:x?"Expand node":"Collapse node",variant:"ghost",size:"icon",onClick:y,className:"absolute h-6 w-6 flex-shrink-0 transition-opacity duration-200",style:{left:-43,opacity:v},onMouseEnter:b=>{b.currentTarget.style.opacity="1"},onMouseLeave:b=>{b.currentTarget.style.opacity=String(v)},"data-test":"node-title-collapse-button",children:x?t.jsx(on,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(Ct,{className:"h-3.5 w-3.5"})});return n?t.jsxs("div",{className:"markdown-textarea absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-collapsed",children:[N,t.jsx("div",{className:"px-2 py-0.5 bg-background/90 truncate border border-dashed border-muted-foreground rounded [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:m}})]}):!e.title&&!s?null:t.jsxs("div",{className:"absolute flex gap-1 pointer-events-auto",style:{top:"-28px",left:"0px"},"data-test":"node-title-container",children:[s&&N,s?t.jsx("input",{ref:c,type:"text",value:a,onChange:b=>i(b.target.value),onBlur:h,onKeyDown:g,placeholder:"Add title...",className:"relative left-0 text-xs px-2 py-0.5 bg-background/90 w-full",onClick:b=>{b.stopPropagation(),o||d(e.title||""),r(!0)}}):e.title?t.jsx("div",{className:"text-xs px-2 py-0.5 bg-background/90 truncate [&_strong]:font-bold [&_em]:italic [&_del]:line-through [&_code]:bg-muted [&_code]:px-0.5 [&_code]:rounded [&_code]:font-mono",dangerouslySetInnerHTML:{__html:w}}):null]})};function Hy(e,s){return e.node.title===s.node.title&&e.node.width===s.node.width&&e.node.content===s.node.content&&e.isSingleNodeSelected===s.isSingleNodeSelected&&e.isCollapsed===s.isCollapsed}const By=Ie.memo(Wy,Hy),Fy=(e,s)=>p.useMemo(()=>{if(s.length!==1)return-1;const n=s[0].id;return e.findIndex(o=>o.id===n)},[e,s]),$y={[le.RECT]:t.jsx($t,{className:"w-4 h-4"}),[le.TEXT]:t.jsx(Wh,{className:"w-4 h-4"})},na=e=>$y[e]??null,zy=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{const[r,a]=p.useState(!1),[i,c]=p.useState(null),[l,d]=p.useState(!1),u=p.useRef(null),h=p.useCallback(m=>{const y=(l?e:s).map(v=>{const N=Array.isArray(v.tags)?v.tags:[];if(N.some(R=>R.title===m))return v;const j={id:Math.random().toString(36).slice(2,10),title:m};return{...v,tags:[...N,j]}});n(y),o()},[l,e,s,n,o]),g=p.useCallback(m=>{const y=(l?e:s).map(v=>{const N=Array.isArray(v.tags)?v.tags:[];return N.some(j=>j.title===m)?{...v,tags:N.filter(j=>j.title!==m)}:v});n(y),o()},[l,e,s,n,o]),f=Ie.useMemo(()=>{const m=l?e:s,x=new Set;return m.forEach(y=>{(Array.isArray(y.tags)?y.tags:[]).forEach(N=>x.add(N.title))}),Array.from(x).sort()},[l,e,s]),w=Ie.useMemo(()=>{const m=new Set;return e.forEach(x=>{(Array.isArray(x.tags)?x.tags:[]).forEach(v=>m.add(v.title))}),Array.from(m).sort()},[e]);return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:u,onMouseDown:m=>m.stopPropagation(),onClick:m=>{if(m.stopPropagation(),u.current){const x=u.current.getBoundingClientRect();c({x:x.left,y:x.bottom+4})}a(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Tag nodes","data-test":"nodes-info-tag-button",children:t.jsx($n,{})}),t.jsx(Ve,{isVisible:r,onClose:()=>a(!1),title:"Tag Nodes",triggerPosition:i??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"apply-to-section space-y-2 pb-2 border-b",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:l,onChange:m=>d(m.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"tag-apply-to-all-checkbox"}),t.jsx("span",{children:"Apply to all nodes"})]}),t.jsx("div",{className:"text-xs text-muted-foreground ml-6",children:l?`Will apply to all ${e.length} nodes`:`Will apply to ${s.length} selected node${s.length!==1?"s":""}`})]}),t.jsx(Vo,{tags:f,onAddTag:h,onRemoveTag:g,canvasTags:w})]})})]})},_y={content:!0,title:!1,id:!1,type:!1,tags:!1},fn=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const u=n?l:l.toLowerCase();let h=0,g=u.indexOf(a,h);for(;g!==-1;){const f=Math.max(0,g-40),w=Math.min(l.length,g+a.length+40);let m=l.substring(f,w);f>0&&(m="..."+m),w<l.length&&(m=m+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:m,startIndex:g,field:o}),h=g+1,g=u.indexOf(a,h)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let g=e.substring(u,h);u>0&&(g="..."+g),h<e.length&&(g=g+"..."),i.push({context:g,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},Vy=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...fn(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...fn(e.title,s,n,"title")),o.id&&e.id&&r.push(...fn(e.id,s,n,"id")),o.type&&e.type&&r.push(...fn(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...fn(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},Uy=e=>{const{node:s,matches:n}=e,o=na(s.type),r=s.id.substring(0,6),a=typeof s.content=="string"?s.content:"",i=s.title?`${s.title.substring(0,30)}${s.title.length>30?"...":""}`:a?`${a.substring(0,30)}${a.length>30?"...":""}`:"(No Content)",c=s.title&&a?`${a.substring(0,50)}${a.length>50?"...":""}`:null;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[o&&t.jsx("span",{className:"flex-shrink-0",children:o}),t.jsx("span",{className:"truncate",children:i}),s.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(Ze,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[n.length," ",n.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:r})]}),c&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:c})]})},Gy=(e,s,n,o)=>{const r=n?s:s.toLowerCase(),i=(n?e.context:e.context.toLowerCase()).indexOf(r);if(i===-1)return t.jsxs("div",{className:"text-xs font-mono flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:e.context})]});const c=e.context.substring(0,i),l=e.context.substring(i,i+s.length),d=e.context.substring(i+s.length);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsxs("span",{className:"flex-1",children:[c,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:l}),d]})]})},Yy=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(!1),[r,a]=p.useState(null),[i,c]=p.useState(""),[l,d]=p.useState(!1),[u,h]=p.useState(_y),g=p.useRef(null),[f,w]=p.useState(new Set),[m,x]=p.useState(!1),y=l||u.title||u.id||u.type||u.tags||!u.content,v=p.useMemo(()=>{if(!i.trim())return[];if(!Object.values(u).some(I=>I))return[];const M=[];return e.forEach(I=>{if(f.has(I.id))return;const A=Vy(I,i,l,u);A&&M.push(A)}),M},[e,i,l,u,f]),N=p.useMemo(()=>v.reduce((C,M)=>C+M.matches.length,0),[v]),b=p.useCallback(()=>{if(v.length>0){const C=v.map(M=>M.node);s(C)}},[v,s]),j=p.useCallback(C=>{w(M=>new Set(M).add(C))},[]),R=p.useCallback(C=>{const M=C.node;s([M]),E.getState().scrollToNode(M.id)},[s]),S=p.useCallback((C,M)=>{const I=C.node;s([I]);const A=be.LINE_HEIGHT_FIND,O=M?(M-1)*A:0;Kn(I,{highlightYOffset:O})},[s]);return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:g,onMouseDown:C=>C.stopPropagation(),onClick:C=>{if(C.stopPropagation(),g.current){const M=g.current.getBoundingClientRect();a({x:M.left,y:M.bottom+4})}o(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Find nodes","data-test":"nodes-info-find-button",children:t.jsx(rs,{})}),t.jsx(Ve,{isVisible:n,onClose:()=>{o(!1)},title:"Find Nodes",triggerPosition:r??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"p-3 space-y-3","data-test":"find-nodes-popover-content",children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"find-nodes-search-section",children:[t.jsx(rs,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"find-nodes-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search nodes...",value:i,onChange:C=>c(C.target.value),onKeyDown:C=>{C.key==="Enter"&&i.trim()&&(C.preventDefault(),b())},className:ve("h-8 text-sm pl-8",i?"pr-16":"pr-10"),autoFocus:!0,"data-test":"find-nodes-search-input"}),i&&t.jsx(Q,{variant:"ghost",size:"icon",onClick:()=>c(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"find-nodes-clear-button",children:t.jsx(Be,{className:"h-3 w-3"})}),y&&t.jsx("div",{className:ve("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",i?"right-16":"right-11"),"data-test":"find-nodes-filter-indicator"}),t.jsxs(ht,{open:m,onOpenChange:x,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"find-nodes-settings-button",children:t.jsx(Jo,{className:"h-3.5 w-3.5"})})}),t.jsx(gt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:Te.draggablePopoverDropdown},"data-test":"find-nodes-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-case-sensitive",checked:l,onCheckedChange:C=>d(!!C),"data-test":"find-nodes-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"find-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-content",checked:u.content,onCheckedChange:C=>h(M=>({...M,content:!!C})),"data-test":"find-nodes-content-checkbox"}),t.jsx("label",{htmlFor:"find-node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-title",checked:u.title,onCheckedChange:C=>h(M=>({...M,title:!!C})),"data-test":"find-nodes-title-checkbox"}),t.jsx("label",{htmlFor:"find-node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-id",checked:u.id,onCheckedChange:C=>h(M=>({...M,id:!!C})),"data-test":"find-nodes-id-checkbox"}),t.jsx("label",{htmlFor:"find-node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-type",checked:u.type,onCheckedChange:C=>h(M=>({...M,type:!!C})),"data-test":"find-nodes-type-checkbox"}),t.jsx("label",{htmlFor:"find-node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"find-node-tags",checked:u.tags,onCheckedChange:C=>h(M=>({...M,tags:!!C})),"data-test":"find-nodes-tags-checkbox"}),t.jsx("label",{htmlFor:"find-node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]})]})})]})]}),i.trim()&&t.jsx("div",{className:"results-section space-y-2","data-test":"find-nodes-results-section",children:t.jsx("div",{className:"results-info flex items-center justify-between","data-test":"find-nodes-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground","data-test":v.length===0?"find-nodes-no-matches":"find-nodes-match-count",children:v.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found ",t.jsx(Ze,{variant:"secondary",className:"mx-1","data-test":"find-nodes-total-matches-badge",children:N}),N===1?"match":"matches"," in"," ",t.jsx(Ze,{variant:"secondary",className:"mx-1","data-test":"find-nodes-nodes-count-badge",children:v.length}),v.length===1?"node":"nodes"]})})})}),v.length>0&&t.jsx("div",{className:"nodes-list-section space-y-2 max-h-[400px] overflow-y-auto","data-test":"find-nodes-list-section",children:v.map(C=>t.jsx("div",{className:"node-matches-container border border-border rounded-md overflow-hidden","data-test":"find-nodes-result",children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>j(C.nodeId),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"find-nodes-remove-result-button",children:t.jsx(Be,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none","data-test":"find-nodes-result-content",children:[t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:()=>R(C),"data-test":"find-nodes-result-header",children:Uy(C)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":"find-nodes-result-matches",children:C.matches.map((M,I)=>t.jsx("div",{onClick:A=>{A.stopPropagation(),S(C,M.lineNumber)},"data-test":"find-nodes-match",children:Gy(M,i,l)},I))})]})]})},C.nodeId))})]})})]})},Ky=({nodes:e,selectedNodes:s,updateNodes:n,saveStateToLocalStorage:o})=>{var N;const r=E.getState(),a=r.setNodeUpdateSettings,i=((N=r.uiState)==null?void 0:N.nodeUpdateSettings)??{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},[c,l]=p.useState(!1),[d,u]=p.useState(i.searchHistory[0]??""),[h,g]=p.useState(null),f=Ie.useRef(null),[w,m]=p.useState(i.deleteInAllNodes),[x,y]=p.useState(i.deleteWholeLine),v=p.useCallback(()=>{if(!d)return;const j=(w?e:s).map(S=>{if(typeof S.content!="string")return S;let C=S.content;x?C=C.split(`
`).filter(F=>!F.includes(d)).join(`
`):C=C.split(d).join("");const M=S.width??be.DEFAULT_NODE_WIDTH,I=mt(C,M,S);return{...S,content:C,height:I}});n(j);const R=[d,...i.searchHistory.filter(S=>S!==d)].slice(0,10);a({deleteInAllNodes:w,deleteWholeLine:x,searchHistory:R}),o(),console.log(`Deleted "${d}" from ${j.length} nodes (wholeLine: ${x})`)},[d,w,x,e,s,n,i.searchHistory,a,o]);return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:f,onMouseDown:b=>b.stopPropagation(),onClick:b=>{if(b.stopPropagation(),f.current){const j=f.current.getBoundingClientRect();g({x:j.left,y:j.bottom+4})}l(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Update nodes","data-test":"nodes-info-update-button",children:t.jsx(Ks,{})}),t.jsx(Ve,{isVisible:c,onClose:()=>l(!1),title:"Update Nodes",triggerPosition:h??void 0,children:t.jsxs("div",{className:"p-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",value:d,onChange:b=>u(b.target.value),placeholder:"Text to delete...",className:"flex-1 px-2 py-1 text-sm border rounded bg-background","data-test":"update-nodes-search-input"}),t.jsxs("button",{onClick:v,disabled:!d,className:"flex items-center gap-1 px-2 py-1 text-sm rounded bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors","data-test":"update-nodes-delete-button",children:[t.jsx(yt,{className:"w-3 h-3"}),"Delete"]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:w,onChange:b=>{const j=b.target.checked;m(j),a({deleteInAllNodes:j}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-all-nodes-checkbox"}),t.jsx("span",{children:"Delete in all nodes"})]}),t.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:x,onChange:b=>{const j=b.target.checked;y(j),a({deleteWholeLine:j}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-whole-line-checkbox"}),t.jsx("span",{children:"Delete whole line"})]})]}),t.jsx("div",{className:"text-xs text-muted-foreground",children:w?`Will update all ${e.length} nodes`:`Will update ${s.length} selected node${s.length!==1?"s":""}`})]})})]})},Xy=e=>{const s=na(e.type),n=String(e.content??""),o=n?`${n.substring(0,15)}${n.length>15?"...":""}`:"(No Content)",r=e.id.substring(0,6),a=`[x:${Math.round(e.x)},y:${Math.round(e.y)}]`,i=`[w:${Math.round(e.width??0)},h:${Math.round(e.height??0)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"node-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"node-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"node-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"node-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"node-display-text",children:o}),e.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0","data-test":"node-display-editing-indicator",children:"[E]"})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"node-display-id",children:r})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1","data-test":"node-display-coords",children:[a," ",i]})]})},gd=e=>{const{className:s,style:n,nodes:o,headerText:r,initiallyExpanded:a}=e,i=E.getState(),c=i.projectCanvas.getActive(),l=o??(c==null?void 0:c.coreState.nodes)??[],d=(c==null?void 0:c.coreState.selectedNodes)??[],u=i.setSelectedNodes,h=i.scrollToNode,g=i.updateNodes,f=i.saveStateToLocalStorage,w=p.useCallback((y,v)=>{const N=y.length>0?y[0]:-1;if(N>=0&&N<l.length){const b=l[N];u([b]),h(b.id)}else u([])},[l,u,h]),m=Fy(l,d),x=m!==-1?[m]:[];return t.jsx("div",{"data-ui-panel":"canvas-node-infos","data-test":"canvas-node-infos-container",className:je("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:y=>y.stopPropagation(),children:t.jsx(rr,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-node-infos-header",children:r??"Nodes"}),itemList:l.map(Xy),onSelectionChange:w,selectedIndices:x,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!a,moreOptions:t.jsxs(t.Fragment,{children:[t.jsx(Yy,{nodes:l,setSelectedNodes:u}),t.jsx(zy,{nodes:l,selectedNodes:d,updateNodes:g,saveStateToLocalStorage:f}),t.jsx(Ky,{nodes:l,selectedNodes:d,updateNodes:g,saveStateToLocalStorage:f})]})})})},qy=({tag:e})=>{const[s,n]=p.useState(!1),o=p.useMemo(()=>{if(!s)return[];const i=E.getState().projectCanvas.getActive();return((i==null?void 0:i.coreState.nodes)??[]).filter(l=>Array.isArray(l.tags)&&l.tags.some(d=>d.title===e.title))},[s,e.title]),r=p.useCallback(a=>{a.stopPropagation()},[]);return t.jsxs(ht,{open:s,onOpenChange:n,children:[t.jsx(pt,{asChild:!0,children:t.jsxs(Ze,{variant:"secondary",className:"text-[10px] px-1.5 py-0 h-5 bg-background/90 text-muted-foreground font-normal italic cursor-pointer hover:bg-accent","data-test":"node-tag",onClick:r,children:["#",e.title]})}),t.jsx(gt,{className:"p-0 w-auto",align:"end",onPointerDownOutside:a=>a.stopPropagation(),onClick:a=>a.stopPropagation(),children:t.jsx(gd,{nodes:o,headerText:`#${e.title}`,className:"border-0",initiallyExpanded:!0})})]})},Zy=({node:e})=>!e.tags||!Array.isArray(e.tags)||e.tags.length===0?null:t.jsx("div",{className:"absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",right:"0px"},"data-test":"node-tags-container",children:e.tags.map(s=>t.jsx(qy,{tag:s},s.id))});function Jy(e,s){const n=e.node.tags,o=s.node.tags;if(n===o)return!0;const r=Array.isArray(n),a=Array.isArray(o);return!r&&!a?!0:!r||!a||n.length!==o.length?!1:n.every((i,c)=>{var l,d;return i.id===((l=o[c])==null?void 0:l.id)&&i.title===((d=o[c])==null?void 0:d.title)})}const Qy=Ie.memo(Zy,Jy),fd=p.createContext(null),md=()=>{const e=p.useContext(fd);if(!e)throw new Error("useWorkflowExecution must be used within a WorkflowExecutionProvider. Make sure CanvasAppV2 wraps its content with the provider.");return e},ev=({children:e,value:s})=>t.jsx(fd.Provider,{value:s,children:e}),xd=({nodeId:e,label:s="Execute Workflow",className:n})=>{const[o,r]=p.useState(!1),[a,i]=p.useState(null),c=md(),{executeWorkflow:l}=c,d=h=>{h.stopPropagation()},u=async h=>{h.stopPropagation(),r(!0),i(null);try{await l(!1,e)}catch(g){const f=g instanceof Error?g.message:String(g);i(f)}finally{r(!1)}};return t.jsxs("div",{className:"w-full",children:[t.jsx(Q,{"data-test":"workflow-execute-button",onPointerDown:d,onClick:u,disabled:o,className:ve("w-full bg-primary hover:bg-primary/70 text-primary-foreground","disabled:bg-muted disabled:text-muted-foreground disabled:cursor-not-allowed",n),size:"sm",children:o?t.jsxs(t.Fragment,{children:[t.jsx(Yn,{className:"w-4 h-4 animate-spin"}),"Executing..."]}):t.jsxs(t.Fragment,{children:[t.jsx(ot,{className:"w-4 h-4"}),s]})}),a&&t.jsxs("div",{className:"text-xs text-destructive mt-1",children:["Error: ",a]})]})},tv=({executionState:e,duration:s,className:n})=>{if(!e||e==="idle")return null;const r={pending:{color:"bg-gray-500",textColor:"text-white",icon:null,label:"Pending"},running:{color:"bg-blue-500",textColor:"text-white",icon:t.jsx(Yn,{className:"w-3 h-3 animate-spin"}),label:"Running"},success:{color:"bg-green-500",textColor:"text-white",icon:t.jsx(Ys,{className:"w-3 h-3"}),label:"Success"},error:{color:"bg-red-500",textColor:"text-white",icon:t.jsx(Be,{className:"w-3 h-3"}),label:"Error"}}[e];return t.jsxs("div",{"data-test":"workflow-execution-badge",className:ve("absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium","flex items-center gap-1",r.color,r.textColor,n),children:[r.icon&&t.jsx("span",{"data-test":"workflow-execution-badge-icon",children:r.icon}),t.jsx("span",{"data-test":"workflow-execution-badge-label",children:r.label}),s&&t.jsxs("span",{"data-test":"workflow-execution-badge-duration",className:"ml-1",children:["(",s,"ms)"]})]})};class no{static convertOrchestrationNode(s,n){var c;const o=s.data,r=((c=o==null?void 0:o.parameters)==null?void 0:c.rows)||[],a=this.convertRowsToNodes(r),i=[...this.createConnectionsFromRowHierarchy(r),...this.createConnectionsFromArrows(s.id,n)];return{nodes:a,connections:i}}static convertRowsToNodes(s){const n=[];for(const o of s){const r={id:o.id,type:o.stepType||"unknown",parameters:{label:o.label,order:o.order,...o.config||{}},inputHandles:this.createHandlesForStepType(o.stepType,"input",o.id),outputHandles:this.createHandlesForStepType(o.stepType,"output",o.id)};if(n.push(r),o.children&&o.children.length>0){const a=this.convertRowsToNodes(o.children);n.push(...a)}}return n}static createHandlesForStepType(s,n,o){const r=["source","transform","nodeUpdate","condition","if"],a=["source","transform","nodeUpdate","condition","if","loop"];return n==="input"&&r.includes(s)?[{id:`input_${o}`,name:"Input",type:"input",dataType:"any"}]:n==="output"&&a.includes(s)?[{id:`output_${o}`,name:"Output",type:"output",dataType:"any"}]:[]}static createConnectionsFromRowHierarchy(s,n){const o=[];for(const r of s)if(n&&o.push({id:`conn_${n}_to_${r.id}`,sourceNodeId:n,sourceHandleId:`output_${n}`,targetNodeId:r.id,targetHandleId:`input_${r.id}`}),r.children&&r.children.length>0){const a=this.createConnectionsFromRowHierarchy(r.children,r.id);o.push(...a)}return o}static createConnectionsFromArrows(s,n){const o=[],r=n.filter(a=>a.endNodeId===s&&a.endRowId);for(const a of r){const i={id:a.id,sourceNodeId:a.startNodeId||"",sourceHandleId:a.startRowId||`output_${a.startNodeId}`,targetNodeId:a.endRowId||"",targetHandleId:a.endRowId||`input_${a.endRowId}`};o.push(i)}return o}static getWorkflowName(s){return s.title||"Untitled Workflow"}static getWorkflowDescription(s){var r,a;const n=s.data,o=((a=(r=n==null?void 0:n.parameters)==null?void 0:r.rows)==null?void 0:a.length)||0;return`Workflow with ${o} step${o!==1?"s":""}`}}class sv{constructor(s=[]){He(this,"crudService");this.crudService=new Kc(s)}create(s){const n=new Date().toISOString(),o=this.crudService.create({name:s.name,description:s.description,tags:s.tags||[],nodes:s.nodes||[],connections:s.connections||[],version:1,createdAt:n,updatedAt:n});if(!o)throw new Error("Failed to create workflow definition");return o}getAll(){return this.crudService.readAll()}getById(s){return this.crudService.readById(s)}update(s,n){const o=this.crudService.readById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt,updatedAt:new Date().toISOString(),version:(o.version||1)+1};return this.crudService.update(r),r}delete(s){this.crudService.delete(s)}findByTag(s){return this.crudService.readAll().filter(n=>{var o;return(o=n.tags)==null?void 0:o.includes(s)})}findByName(s){const n=s.toLowerCase();return this.crudService.readAll().filter(o=>o.name.toLowerCase().includes(n))}count(){return this.crudService.count()}clear(){this.crudService.clear()}updateNodes(s,n){return this.update(s,{nodes:n})}updateConnections(s,n){return this.update(s,{connections:n})}addNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.nodes,n];return this.updateNodes(s,r)}removeNode(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.nodes.filter(i=>i.id!==n),a=o.connections.filter(i=>i.sourceNodeId!==n&&i.targetNodeId!==n);return this.update(s,{nodes:r,connections:a})}addConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=[...o.connections,n];return this.updateConnections(s,r)}removeConnection(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=o.connections.filter(a=>a.id!==n);return this.updateConnections(s,r)}duplicate(s,n){const o=this.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);return this.create({name:n,description:o.description,tags:o.tags?[...o.tags]:void 0,nodes:o.nodes.map(r=>({...r})),connections:o.connections.map(r=>({...r}))})}}class Za{constructor(s=[],n=[]){He(this,"definitionService");He(this,"instanceService");He(this,"executionFacade");this.definitionService=new sv(s),this.instanceService=new Kc(n),this.executionFacade=new Zs}createDefinition(s){return this.definitionService.create(s)}getAllDefinitions(){return this.definitionService.getAll()}getDefinitionById(s){return this.definitionService.getById(s)}updateDefinition(s,n){return this.definitionService.update(s,n)}deleteDefinition(s){this.instanceService.filterByKey("definitionId",s).forEach(o=>this.instanceService.delete(o.id)),this.definitionService.delete(s)}findDefinitionsByTag(s){return this.definitionService.findByTag(s)}findDefinitionsByName(s){return this.definitionService.findByName(s)}duplicateDefinition(s,n){return this.definitionService.duplicate(s,n)}createInstance(s,n){const o=this.definitionService.getById(s);if(!o)throw new Error(`Workflow definition not found: ${s}`);const r=new Date().toISOString(),a=this.instanceService.create({definitionId:s,name:n||o.name,status:"idle",createdAt:r,executionHistory:[]});if(!a)throw new Error("Failed to create workflow instance");return a}getAllInstances(){return this.instanceService.readAll()}getInstanceById(s){return this.instanceService.readById(s)}getInstancesByDefinitionId(s){return this.instanceService.filterByKey("definitionId",s)}updateInstance(s,n){const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r={...o,...n,id:o.id,createdAt:o.createdAt};this.instanceService.update(r)}deleteInstance(s){this.instanceService.delete(s)}async executeInstance(s,n={}){var a;const o=this.instanceService.readById(s);if(!o)throw new Error(`Workflow instance not found: ${s}`);const r=this.definitionService.getById(o.definitionId);if(!r)throw new Error(`Workflow definition not found: ${o.definitionId}`);this.updateInstance(s,{status:"running"});try{const i=this.convertWorkflowNodesToCanvas(r.nodes),c=this.convertWorkflowConnectionsToCanvas(r.connections);this.executionFacade.loadWorkflow(i,c);const l=await this.executionFacade.executeWorkflow(n.triggerNodeId||((a=i[0])==null?void 0:a.id)||""),d=l.executionId?await this.executionFacade.getExecution(l.executionId):null;if(d){const h=[...o.executionHistory,d];this.updateInstance(s,{status:l.success?"completed":"failed",lastExecutedAt:new Date().toISOString(),executionHistory:h})}return{success:l.success,executionId:l.executionId||"",instanceId:s,definitionId:o.definitionId,duration:l.duration||0,executedNodeCount:l.executedNodeCount||0,errors:l.errors||[],nodeUpdates:l.nodeUpdates}}catch(i){throw this.updateInstance(s,{status:"failed"}),i}}getExecutionHistory(s){const n=this.instanceService.readById(s);if(!n)throw new Error(`Workflow instance not found: ${s}`);return n.executionHistory}clearExecutionHistory(s){this.updateInstance(s,{executionHistory:[]})}convertWorkflowNodesToCanvas(s){return s.map(n=>({id:n.id,x:0,y:0,type:"workflow",data:{nodeType:n.type,parameters:n.parameters,inputHandles:n.inputHandles,outputHandles:n.outputHandles},width:200,height:100}))}convertWorkflowConnectionsToCanvas(s){return s.map(n=>({id:n.id,startNodeId:n.sourceNodeId,endNodeId:n.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0},startRowId:n.sourceHandleId,endRowId:n.targetHandleId}))}getStats(){const s=this.instanceService.readAll(),n=s.reduce((o,r)=>(o[r.status]=(o[r.status]||0)+1,o),{});return{totalDefinitions:this.definitionService.count(),totalInstances:s.length,instancesByStatus:n}}clearAll(){this.definitionService.clear(),this.instanceService.clear()}}class Ja{constructor(s,n){He(this,"workflowManager");this.getCanvasState=n,this.workflowManager=s||new Za}saveWorkflow(s){const{nodeId:n,name:o,description:r,tags:a}=s,{node:i,arrows:c}=this.getNodeAndArrows(n),{nodes:l,connections:d}=no.convertOrchestrationNode(i,c),u=o||no.getWorkflowName(i),h=r||no.getWorkflowDescription(i),f=this.workflowManager.getAllDefinitions().find(w=>w.name===u);return f?this.workflowManager.updateDefinition(f.id,{nodes:l,connections:d,description:h,tags:a||f.tags}):this.workflowManager.createDefinition({name:u,description:h,tags:a||[],nodes:l,connections:d})}loadWorkflow(s){const{definitionId:n,position:o={x:100,y:100},existingNodeId:r}=s,a=this.workflowManager.getDefinitionById(n);if(!a)throw new Error(`Workflow definition not found: ${n}`);const i=this.convertWorkflowNodesToRows(a.nodes,a.connections);return{id:r||`workflow-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:a.name,content:a.description||"",x:o.x,y:o.y,width:400,height:600,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:i},inputHandles:this.createInputHandlesFromRows(i),outputHandles:[]}}}validateWorkflow(s){var r;const n=[],o=[];try{const{node:a,arrows:i}=this.getNodeAndArrows(s),c=a.data,l=((r=c==null?void 0:c.parameters)==null?void 0:r.rows)||[];l.length===0&&n.push("Workflow must have at least one step");const d=l.filter(f=>!f.stepType||f.stepType==="empty");d.length>0&&o.push(`${d.length} step(s) have no type configured`);const u=new Set(i.filter(f=>f.endNodeId===s&&f.endRowId).map(f=>f.endRowId)),g=l.filter(f=>f.stepType==="source").filter(f=>!u.has(f.id));return g.length>0&&o.push(`${g.length} source step(s) have no input connections`),{valid:n.length===0,errors:n,warnings:o}}catch(a){return{valid:!1,errors:[`Validation failed: ${String(a)}`],warnings:o}}}canSave(s){const n=this.validateWorkflow(s);return{valid:n.valid,errors:n.errors}}previewDefinition(s){const{node:n,arrows:o}=this.getNodeAndArrows(s),{nodes:r,connections:a}=no.convertOrchestrationNode(n,o);return{nodes:r,connections:a,nodeCount:r.length,connectionCount:a.length}}addRow(s){var g;const{nodeId:n,stepType:o,label:r,parentRowId:a,config:i}=s,{node:c}=this.getNodeAndArrows(n),l=c.data,d=((g=l==null?void 0:l.parameters)==null?void 0:g.rows)||[],u=d.length+1,h={id:De(),label:r||`Step ${u}`,order:u,stepType:o,config:i||{}};if(a){const f=this.addRowToParent(d,a,h);this.updateNodeRows(n,f)}else{const f=[...d,h];this.updateNodeRows(n,f)}return h}updateRow(s){var d;const{nodeId:n,rowId:o,updates:r}=s,{node:a}=this.getNodeAndArrows(n),i=a.data,c=((d=i==null?void 0:i.parameters)==null?void 0:d.rows)||[],l=this.updateRowRecursive(c,o,r);this.updateNodeRows(n,l)}deleteRow(s){var l;const{nodeId:n,rowId:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((l=a==null?void 0:a.parameters)==null?void 0:l.rows)||[],c=this.deleteRowRecursive(i,o);this.updateNodeRows(n,c)}reorderRows(s){var d;const{nodeId:n,rowOrders:o}=s,{node:r}=this.getNodeAndArrows(n),a=r.data,i=((d=a==null?void 0:a.parameters)==null?void 0:d.rows)||[],c=new Map(o.map(u=>[u.rowId,u.order])),l=this.updateRowOrders(i,c);this.updateNodeRows(n,l)}getTemplates(){return[{id:"simple-transform",name:"Simple Transform",description:"Data input → transformation → output"},{id:"conditional-flow",name:"Conditional Flow",description:"Data input → condition check → branching logic"},{id:"loop-process",name:"Loop Processing",description:"Data input → loop over items → process each"}]}createFromTemplate(s){const{templateId:n,name:o}=s,a={"simple-transform":{name:o||"Simple Transform Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"transform-1",type:"transform",parameters:{label:"Transform Data"},inputHandles:[{id:"input_transform-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_transform-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"transform-1",targetHandleId:"input_transform-1"}]},"conditional-flow":{name:o||"Conditional Flow Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"condition-1",type:"if",parameters:{label:"Check Condition"},inputHandles:[{id:"input_condition-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_condition-1_true",name:"True",type:"output",dataType:"any"},{id:"output_condition-1_false",name:"False",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"condition-1",targetHandleId:"input_condition-1"}]},"loop-process":{name:o||"Loop Processing Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"loop-1",type:"loop",parameters:{label:"Process Each Item"},inputHandles:[{id:"input_loop-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_loop-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"loop-1",targetHandleId:"input_loop-1"}]}}[n];if(!a)throw new Error(`Template not found: ${n}`);return this.workflowManager.createDefinition({name:a.name,description:`Created from ${n} template`,tags:["template",n],nodes:a.nodes,connections:a.connections})}exportWorkflow(s){const n=this.workflowManager.getDefinitionById(s);if(!n)throw new Error(`Workflow definition not found: ${s}`);return JSON.stringify(n,null,2)}exportWorkflows(s){const n=s.map(o=>this.workflowManager.getDefinitionById(o)).filter(o=>o!==void 0);return JSON.stringify(n,null,2)}exportAllWorkflows(){const s=this.workflowManager.getAllDefinitions();return JSON.stringify(s,null,2)}importWorkflow(s){try{const n=JSON.parse(s);if(!n.name||!Array.isArray(n.nodes)||!Array.isArray(n.connections))throw new Error("Invalid workflow format: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:n.name,description:n.description,tags:n.tags||[],nodes:n.nodes,connections:n.connections})}catch(n){throw new Error(`Failed to import workflow: ${n instanceof Error?n.message:String(n)}`)}}importWorkflows(s){try{const n=JSON.parse(s);if(!Array.isArray(n))throw new Error("Invalid format: expected array of workflows");return n.map(o=>{if(!o.name||!Array.isArray(o.nodes)||!Array.isArray(o.connections))throw new Error("Invalid workflow format in array: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:o.name,description:o.description,tags:o.tags||[],nodes:o.nodes,connections:o.connections})})}catch(n){throw new Error(`Failed to import workflows: ${n instanceof Error?n.message:String(n)}`)}}downloadWorkflow(s){const n=this.exportWorkflow(s),o=this.workflowManager.getDefinitionById(s);if(!o)return;const r=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download=`${o.name.replace(/[^a-z0-9]/gi,"_")}.workflow.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}downloadWorkflows(s){const n=this.exportWorkflows(s),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download=`workflows_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}bulkDeleteDefinitions(s){s.forEach(n=>{this.workflowManager.deleteDefinition(n)})}bulkDuplicateDefinitions(s){return s.map((n,o)=>{const r=this.workflowManager.getDefinitionById(n);if(!r)throw new Error(`Definition not found: ${n}`);return this.workflowManager.duplicateDefinition(n,`${r.name} (Copy ${o+1})`)})}bulkAddTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const a=r.tags||[],i=[...new Set([...a,...n])];this.workflowManager.updateDefinition(o,{tags:i})})}bulkRemoveTags(s,n){s.forEach(o=>{const r=this.workflowManager.getDefinitionById(o);if(!r)return;const i=(r.tags||[]).filter(c=>!n.includes(c));this.workflowManager.updateDefinition(o,{tags:i})})}getBulkStats(s){const n=s.map(i=>this.workflowManager.getDefinitionById(i)).filter(i=>i!==void 0),o=new Set;let r=0,a=0;return n.forEach(i=>{r+=i.nodes.length,a+=i.connections.length,(i.tags||[]).forEach(c=>o.add(c))}),{count:n.length,totalNodes:r,totalConnections:a,tags:Array.from(o)}}getNodeAndArrows(s){if(!this.getCanvasState)throw new Error("Canvas state getter not provided");const{nodes:n,arrows:o}=this.getCanvasState(),r=n.find(a=>a.id===s);if(!r)throw new Error(`Node not found: ${s}`);return{node:r,arrows:o}}convertWorkflowNodesToRows(s,n){const o=new Map;for(const c of n)if(c.sourceHandleId.startsWith("output_")&&c.targetHandleId.startsWith("input_")){const l=c.sourceNodeId,d=c.targetNodeId;o.has(l)||o.set(l,[]),o.get(l).push(d)}const r=new Set,a=(c,l)=>{r.add(c.id);const u=(o.get(c.id)||[]).filter(h=>!r.has(h)).map((h,g)=>{const f=s.find(w=>w.id===h);return f?a(f,g+1):null}).filter(Boolean);return{id:c.id,label:c.parameters.label||`Step ${l}`,order:l,stepType:c.type,config:c.parameters,children:u.length>0?u:void 0}};return s.filter(c=>!n.some(l=>l.targetNodeId===c.id)).map((c,l)=>a(c,l+1))}createInputHandlesFromRows(s){const n=[],o=r=>{r.stepType==="source"&&n.push({id:`input_${r.id}`,name:r.label,type:"input",dataType:"any"}),r.children&&r.children.forEach(a=>o(a))};return s.forEach(o),n}updateNodeRows(s,n){if(!this.getCanvasState)throw new Error("Cannot update rows without canvas state");const o=this.createInputHandlesFromRows(n);return{rows:n,inputHandles:o}}addRowToParent(s,n,o){return s.map(r=>{if(r.id===n){const a=r.children||[];return{...r,children:[...a,o]}}return r.children?{...r,children:this.addRowToParent(r.children,n,o)}:r})}updateRowRecursive(s,n,o){return s.map(r=>r.id===n?{...r,...o}:r.children?{...r,children:this.updateRowRecursive(r.children,n,o)}:r)}deleteRowRecursive(s,n){return s.filter(o=>o.id!==n).map(o=>o.children?{...o,children:this.deleteRowRecursive(o.children,n)}:o)}updateRowOrders(s,n){return s.map(o=>{const r=n.get(o.id),a=r!==void 0?{...o,order:r}:o;return a.children?{...a,children:this.updateRowOrders(a.children,n)}:a}).sort((o,r)=>o.order-r.order)}}const wd="workflow-manager-storage",yd=()=>{try{const e=localStorage.getItem(wd);if(e)return JSON.parse(e)}catch(e){console.error("[WorkflowManager] Failed to load from localStorage:",e)}return null},nv=e=>{try{const s=JSON.stringify(e);localStorage.setItem(wd,s)}catch(s){console.error("[WorkflowManager] Failed to save to localStorage:",s)}},Vs=yd(),Ki=(Vs==null?void 0:Vs.definitions)||[],Xi=(Vs==null?void 0:Vs.instances)||[],ps=Bc((e,s)=>{const n=new Za(Ki,Xi);return{definitions:Ki,instances:Xi,facade:n,selectedDefinitionId:null,selectedInstanceId:null,isExecuting:!1,lastExecutionResult:null,createDefinition:o=>{const r=n.createDefinition(o),a=n.getAllDefinitions();return e({definitions:a}),s().saveToStorage(),r},updateDefinition:(o,r)=>{const a=n.updateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},deleteDefinition:o=>{n.deleteDefinition(o);const r=n.getAllDefinitions(),a=n.getAllInstances();e({definitions:r,instances:a,selectedDefinitionId:s().selectedDefinitionId===o?null:s().selectedDefinitionId}),s().saveToStorage()},duplicateDefinition:(o,r)=>{const a=n.duplicateDefinition(o,r),i=n.getAllDefinitions();return e({definitions:i}),s().saveToStorage(),a},findDefinitionsByTag:o=>n.findDefinitionsByTag(o),findDefinitionsByName:o=>n.findDefinitionsByName(o),createInstance:(o,r)=>{const a=n.createInstance(o,r),i=n.getAllInstances();return e({instances:i}),s().saveToStorage(),a},updateInstance:(o,r)=>{n.updateInstance(o,r);const a=n.getAllInstances();e({instances:a}),s().saveToStorage()},deleteInstance:o=>{n.deleteInstance(o);const r=n.getAllInstances();e({instances:r,selectedInstanceId:s().selectedInstanceId===o?null:s().selectedInstanceId}),s().saveToStorage()},getInstancesByDefinitionId:o=>n.getInstancesByDefinitionId(o),executeInstance:async(o,r)=>{e({isExecuting:!0});try{const a=await n.executeInstance(o,r),i=n.getAllInstances();return e({instances:i,isExecuting:!1,lastExecutionResult:a}),s().saveToStorage(),a}catch(a){throw e({isExecuting:!1}),a}},selectDefinition:o=>{e({selectedDefinitionId:o})},selectInstance:o=>{e({selectedInstanceId:o})},getStats:()=>n.getStats(),clearAll:()=>{n.clearAll(),e({definitions:[],instances:[],selectedDefinitionId:null,selectedInstanceId:null,lastExecutionResult:null}),s().saveToStorage()},loadFromStorage:()=>{const o=yd();if(o){const r=new Za(o.definitions,o.instances);e({definitions:o.definitions,instances:o.instances,facade:r})}},saveToStorage:()=>{nv({definitions:s().definitions,instances:s().instances})}}}),ov=({node:e,nodes:s,arrows:n,updateNode:o})=>{var d;const r=e.data,a=((d=r==null?void 0:r.parameters)==null?void 0:d.rows)||[],i=ps.getState().definitions,c=()=>{try{const h=new Ja(ps.getState().facade,()=>({nodes:s,arrows:n})).previewDefinition(e.id),g=typeof e.title=="string"?e.title:`Workflow ${e.id}`,f=typeof e.content=="string"?e.content:"",m=ps.getState().definitions.find(y=>y.name===g);let x;m?x=ps.getState().updateDefinition(m.id,{nodes:h.nodes,connections:h.connections,description:f}):x=ps.getState().createDefinition({name:g,description:f,tags:[],nodes:h.nodes,connections:h.connections}),Se.success("Workflow saved",{description:`"${x.name}" saved successfully (v${x.version})`})}catch(u){Se.error("Failed to save workflow",{description:u instanceof Error?u.message:String(u)})}},l=u=>{if(!u){Se.error("No workflow selected",{description:"Please select a workflow to load"});return}try{const g=new Ja(ps.getState().facade,()=>({nodes:s,arrows:n})).loadWorkflow({definitionId:u,existingNodeId:e.id});o(e.id,{title:g.title,content:g.content,data:g.data}),Se.success("Workflow loaded",{description:`"${g.title}" loaded successfully`})}catch(h){Se.error("Failed to load workflow",{description:h instanceof Error?h.message:String(h)})}};return t.jsx(Go,{storageKey:`workflow-more-options-${e.id}`,initialConfig:{autoSaveEnabled:!1,selectedDefinitionId:""},children:(u,h,g)=>(p.useEffect(()=>{if(!u.autoSaveEnabled||a.length===0)return;const f=setTimeout(()=>{c()},3e3);return()=>clearTimeout(f)},[a,u.autoSaveEnabled]),t.jsx(g,{icon:t.jsx(vl,{className:"h-4 w-4"}),variant:"ghost",size:"icon",buttonClassName:"workflow-more-options-button",contentClassName:"w-80",title:"Workflow Options",children:t.jsxs("div",{className:"workflow-options-panel space-y-4",children:[t.jsxs("div",{className:"save-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Save Workflow"}),t.jsxs("button",{"data-test":"workflow-save-to-manager-button",onClick:f=>{f.stopPropagation(),c()},className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:[t.jsx(Jt,{className:"h-4 w-4"}),"Save to Workflow Manager"]})]}),t.jsxs("div",{className:"load-section space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Load Workflow"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Select a workflow to load into this node"}),t.jsxs(ct,{"data-test":"workflow-load-select",value:u.selectedDefinitionId,onValueChange:f=>{h({...u,selectedDefinitionId:f})},children:[t.jsx(lt,{"data-test":"workflow-load-select-trigger",children:t.jsx(dt,{placeholder:"Select workflow..."})}),t.jsx(ut,{children:i.length===0?t.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No saved workflows found"}):i.map(f=>t.jsxs(_e,{value:f.id,children:[f.name," (v",f.version,")"]},f.id))})]}),t.jsxs("button",{"data-test":"workflow-load-confirm-button",onClick:f=>{f.stopPropagation(),l(u.selectedDefinitionId),h({...u,selectedDefinitionId:""})},disabled:!u.selectedDefinitionId,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm border rounded hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[t.jsx(Hh,{className:"h-4 w-4"}),"Load"]})]}),t.jsx("div",{className:"auto-save-section space-y-2 pt-2 border-t",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"space-y-0.5",children:[t.jsx("h4",{className:"text-sm font-semibold",children:"Auto-Save"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically save after changes (3s delay)"})]}),t.jsx("button",{"data-test":"workflow-auto-save-toggle",onClick:f=>{f.stopPropagation();const w=!u.autoSaveEnabled;h({...u,autoSaveEnabled:w}),Se.info(w?"Auto-save enabled":"Auto-save disabled",{description:w?"Workflow will save automatically after changes":"Manual save required"})},className:`w-10 h-10 flex items-center justify-center rounded transition-colors border ${u.autoSaveEnabled?"bg-primary text-primary-foreground border-primary":"hover:bg-accent border-border"}`,title:u.autoSaveEnabled?"Disable auto-save":"Enable auto-save",children:t.jsx(as,{className:"h-4 w-4"})})]})})]})}))})},av=({node:e,nodes:s,arrows:n,showTextConfig:o,rows:r,updateNode:a,onToggleTextConfig:i,onSetJsonConfigText:c,onSetJsonError:l})=>{const d=e.data,{executeWorkflow:u,showDryRunResults:h}=md(),g=w=>{if(w.stopPropagation(),!o){const m={nodeId:e.id,nodeType:d==null?void 0:d.nodeType,rows:r,connections:n.filter(x=>x.endNodeId===e.id||x.startNodeId===e.id)};c(JSON.stringify(m,null,2)),l(null)}i()},f=async w=>{w.stopPropagation();const m=await u(!0,e.id);h(m)};return t.jsxs("div",{className:"workflow-header font-semibold mb-2 text-sm border-b pb-1 flex justify-between items-center",children:[t.jsx("span",{children:o?"JSON Config":"Orchestration Rows"}),(d==null?void 0:d.showExecuteButton)&&t.jsxs("div",{className:"execute-button-container flex items-center gap-1.5",children:[t.jsx(Q,{"data-test":"workflow-toggle-json-button",onClick:g,variant:o?"default":"outline",size:"icon",className:"h-8 w-8",title:o?"View visual steps":"View workflow as JSON",children:o?t.jsx(qt,{className:"h-4 w-4"}):t.jsx(Qo,{className:"h-4 w-4"})}),t.jsx(Q,{"data-test":"workflow-dry-run-button",onClick:f,variant:"outline",size:"icon",className:"h-8 w-8",title:"Dry Run (preview changes without applying)",children:t.jsx(rs,{className:"h-4 w-4"})}),t.jsx(xd,{nodeId:e.id,label:"",className:"h-8 w-8"}),t.jsx(ov,{node:e,nodes:s,arrows:n,updateNode:a})]})]})},rv=({node:e,jsonConfigText:s,jsonError:n,onJsonConfigTextChange:o,onJsonErrorChange:r,onClose:a,updateNode:i})=>{const c=e.data,l=g=>{g.stopPropagation();try{const f=JSON.parse(s);if(!f.rows||!Array.isArray(f.rows)){r('Invalid JSON: "rows" must be an array');return}i(e.id,{data:{...c,parameters:{...c.parameters,rows:f.rows}}}),r(null),a()}catch(f){r(`Invalid JSON: ${f.message}`)}},d=g=>{g.stopPropagation(),navigator.clipboard.writeText(s)},u=g=>{o(g.target.value),r(null)},h=g=>{g.preventDefault(),g.stopPropagation();const f=g.currentTarget,w=f.scrollTop<f.scrollHeight-f.clientHeight,m=f.scrollTop>0,x=g.deltaY>0;(x&&w||!x&&m)&&(f.scrollTop+=g.deltaY)};return t.jsxs("div",{className:"workflow-json-wrapper h-full w-full flex flex-col gap-1",onWheel:g=>{g.stopPropagation()},children:[t.jsx("div",{className:"workflow-textarea-parent flex-1 w-full min-h-0",onWheel:g=>{g.stopPropagation()},children:t.jsx("textarea",{value:s,onChange:u,onClick:g=>g.stopPropagation(),onPointerDown:g=>g.stopPropagation(),onWheel:h,className:"workflow-textarea w-full h-full text-[10px] font-mono bg-background border-0 p-1 resize-none focus:outline-none overflow-auto",spellCheck:!1})}),n&&t.jsx("div",{className:"text-[10px] text-destructive bg-destructive/10 border-t border-destructive/20 px-1 py-1",children:n}),t.jsxs("div",{className:"flex gap-1 border-t pt-1",children:[t.jsx("button",{"data-test":"workflow-json-save-button",onClick:l,className:"flex-1 px-2 py-1 text-[10px] bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:"Save"}),t.jsx("button",{"data-test":"workflow-json-copy-button",onClick:d,className:"px-2 py-1 text-[10px] border border-border rounded hover:bg-accent transition-colors",children:"Copy"})]})]})},iv=({node:e,rows:s,rowElementsRef:n,connectorOffsetLeft:o,stepTypesWithConnectors:r})=>t.jsx("div",{"data-test":"workflow-connector-layer-container",className:"workflow-connector-layer absolute top-0 bottom-0 pointer-events-none",style:{left:`${o}px`},children:s.map(a=>{if(!r.includes(a.stepType))return null;const i=a.id.replace("row_",""),c=a.label||`Step ${i}`,l=n.current.get(a.id);if(!l)return null;const d=l.getBoundingClientRect(),u=l.closest(".bg-background.border.p-3");if(!u)return null;const h=u.getBoundingClientRect(),g=d.top+d.height/2-h.top;return t.jsx("div",{"data-test":"workflow-connector","data-row-connector":a.id,"data-node-id":e.id,className:"absolute w-3 h-3 rounded-full border-2 border bg-background cursor-crosshair hover:bg-accent transition-colors pointer-events-auto",style:{left:"0",top:`${g}px`,transform:"translateY(-50%)"},title:`Connect to ${c}`,onClick:f=>{f.stopPropagation()}},`connector-${a.id}`)})}),cv=({node:e,rows:s,updateNode:n})=>{const o=e.data,[r,a]=p.useState(null),[i,c]=p.useState(!1),[l,d]=p.useState(!1),[u,h]=p.useState(!1),[g,f]=p.useState(null),[w,m]=p.useState(null),x=(M,I)=>{for(const A of M){if(A.id===I)return A;if(A.children){const O=x(A.children,I);if(O)return O}}return null},y=(M,I,A)=>M.map(O=>O.id===I?{...O,...A}:O.children?{...O,children:y(O.children,I,A)}:O),v=(M,I)=>M.filter(A=>A.id!==I).map(A=>A.children?{...A,children:v(A.children,I)}:A);return{selectedRowId:r,setSelectedRowId:a,configPopoverOpen:i,setConfigPopoverOpen:c,showNodeUpdateConfig:l,setShowNodeUpdateConfig:d,showIfStepConfig:u,setShowIfStepConfig:h,popoverPosition:g,popoverSize:w,handleAddRow:()=>{const M=s.length+1,I={id:De(),label:`Step ${M}`,order:M,stepType:"empty"},A=[...s,I];A.sort((B,W)=>B.order-W.order);const F=A.filter(B=>En.includes(B.stepType)).map(B=>({id:`input_${B.id}`,name:B.label,type:"input",dataType:"any"}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:A},inputHandles:F}})},handleRowClick:(M,I,A)=>{const O=x(s,M);a(M);const F=window.innerWidth,B=window.innerHeight,W=I.clientX,P=I.clientY,T=W<F/2?W+100:W-100;f({x:T,y:P});const L=Math.min(450,Math.floor(B*.6));if(m({width:500,height:L}),A==="badge")c(!0);else if(A==="gear"){const $=O==null?void 0:O.stepType;$==="nodeUpdate"?d(!0):$==="if"&&h(!0)}},handleConfigureRow:(M,I)=>{const A=y(s,M,{stepType:I});n(e.id,{data:{...o,parameters:{...o.parameters,rows:A}}}),a(null)},handleDeleteRow:M=>{const I=v(s,M),O=I.filter(F=>En.includes(F.stepType)).map((F,B)=>({id:F.id,position:"left",offsetY:96+B*32}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:I},inputHandles:O}})},handleSaveNodeUpdateConfig:M=>{if(!r)return;const I=y(s,r,{stepType:"nodeUpdate",config:M});n(e.id,{data:{...o,parameters:{...o.parameters,rows:I}}}),d(!1),a(null)},handleSaveIfStepConfig:M=>{if(!r)return;const I=y(s,r,{stepType:"if",config:M});n(e.id,{data:{...o,parameters:{...o.parameters,rows:I}}}),h(!1),a(null)},findRowRecursive:x}},qi=({node:e})=>{var S,C,M;const s=e.data,n=((S=s==null?void 0:s.parameters)==null?void 0:S.rows)||[],[o,r]=p.useState(!1),[a,i]=p.useState(""),[c,l]=p.useState(null);p.useEffect(()=>{if(!o)return;const I=A=>{var F;const O=A.target;if(O.closest(".workflow-json-wrapper")){const B=(F=O.closest(".workflow-json-wrapper"))==null?void 0:F.querySelector("textarea");if(B){A.stopPropagation(),A.preventDefault();const W=B.scrollTop<B.scrollHeight-B.clientHeight,P=B.scrollTop>0,k=A.deltaY>0;(k&&W||!k&&P)&&(B.scrollTop+=A.deltaY)}}};return document.addEventListener("wheel",I,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",I,{capture:!0})}},[o]);const[d,u]=p.useState(()=>new Set(n.filter(I=>I.children&&I.children.length>0).map(I=>I.id))),h=p.useRef(null),g=p.useRef(new Map),[f,w]=p.useState(null),m=z(I=>{var A;return((A=I.projectCanvas.getActive())==null?void 0:A.coreState.arrows)??[]}),x=z(I=>{var A;return((A=I.projectCanvas.getActive())==null?void 0:A.coreState.nodes)??[]}),v=z(I=>{var A;return((A=I.projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes)??[]}).some(I=>I.id===e.id),{updateNode:N}=E.getState(),b=cv({node:e,rows:n,updateNode:N}),j=m.filter(I=>I.endNodeId===e.id&&I.endRowId);p.useEffect(()=>{let I=[...n],A=!1;const O=new Set;j.forEach(B=>{B.endRowId&&O.add(B.endRowId)});const F=I.length;if(I=I.filter(B=>{const W=B.stepType&&B.stepType!=="empty";return O.has(B.id)||W}),I.length!==F&&(A=!0),A){I.sort((P,k)=>P.order-k.order);const W=I.filter(P=>En.includes(P.stepType)).map(P=>({id:`input_${P.id}`,name:P.label,type:"input",dataType:"any"}));N(e.id,{data:{...s,parameters:{...s.parameters,rows:I},inputHandles:W}})}},[j.length,e.id,N]),p.useEffect(()=>(h.current=new jp({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:()=>!0,onDragMove:({sortIndex:I})=>{I!==null&&w(I)},onDrop:({item:I,sortIndex:A})=>{if(A==null)return;const O=I.data.rowId,F=[...n],B=F.findIndex(T=>T.id===O);if(B===-1)return;const[W]=F.splice(B,1);F.splice(A,0,W),F.forEach((T,L)=>{T.order=L+1});const k=F.filter(T=>En.includes(T.stepType)).map((T,L)=>({id:T.id,position:"left",offsetY:96+L*32}));N(e.id,{data:{...s,parameters:{...s.parameters,rows:F},inputHandles:k}})},onDragEnd:()=>{w(null)}}),()=>{var I;(I=h.current)==null||I.destroy(),g.current.clear()}),[e.id]),p.useEffect(()=>{if(!h.current)return;const I=document.querySelector(`[data-workflow-rows="${e.id}"]`);I&&!I.dataset.dropZoneRegistered&&(h.current.registerDropZone(`workflow-rows-${e.id}`,I,void 0,{nodeId:e.id}),I.dataset.dropZoneRegistered="true"),n.forEach(O=>{const F=document.querySelector(`[data-drag-handle="${O.id}"]`);F&&!F.dataset.dndRegistered&&(h.current.registerDraggable(O.id,F,{rowId:O.id}),F.dataset.dndRegistered="true")});const A=new Set(n.map(O=>O.id));g.current.forEach((O,F)=>{A.has(F)||(h.current.unregisterDraggable(F),g.current.delete(F))})},[n,e.id]);const R=I=>{const O=I.target.closest("[data-drag-handle]"),F=document.querySelector(`[data-node-id="${e.id}"]`);F==null||F.getBoundingClientRect(),n.map(B=>{const W=document.querySelector(`[data-workflow-row="${e.id}:${B.id}"]`);if(W){const P=W.getBoundingClientRect();return{rowId:B.id,screenY:P.top+P.height/2,top:P.top,bottom:P.bottom,height:P.height}}return{rowId:B.id,error:"element not found"}}),v&&!O&&I.stopPropagation()};return t.jsxs("div",{"data-test":"workflow-orchestration-node",className:"workflow-node-container bg-background border p-3 w-full h-full flex flex-col relative overflow-visible",onPointerDown:R,children:[t.jsx(iv,{node:e,rows:n,rowElementsRef:g,connectorOffsetLeft:yp,stepTypesWithConnectors:En}),t.jsx(av,{node:e,nodes:x,arrows:m,showTextConfig:o,rows:n,updateNode:N,onToggleTextConfig:()=>r(!o),onSetJsonConfigText:i,onSetJsonError:l}),t.jsx("div",{"data-test":"workflow-content-area",className:"workflow-content-area flex-1 w-full text-xs overflow-y-auto relative","data-workflow-rows":e.id,onWheel:I=>{o&&I.stopPropagation()},children:o?t.jsx(rv,{node:e,jsonConfigText:a,jsonError:c,onJsonConfigTextChange:i,onJsonErrorChange:l,onClose:()=>r(!1),updateNode:N}):t.jsx(kp,{data:n,defaultExpandedIds:d,onReorder:I=>{const A=(W,P=1)=>W.map((k,T)=>{const L=P+T;return{...k,order:L,children:k.children?A(k.children,L*10):k.children}}),O=A(I),F=new Set(O.filter(W=>W.children&&W.children.length>0).map(W=>W.id)),B=new Set(d);F.forEach(W=>{d.has(W)||B.add(W)}),u(B),N(e.id,{data:{...s,parameters:{...s.parameters,rows:O}}})},renderCustomContent:I=>t.jsx(vp,{row:I,node:e,nodes:x,incomingArrows:j,selectedRowId:b.selectedRowId,configPopoverOpen:b.configPopoverOpen,rowElementsRef:g,onRowClick:b.handleRowClick,onConfigureRow:b.handleConfigureRow,onDeleteRow:b.handleDeleteRow,onSelectedRowIdChange:b.setSelectedRowId})})}),t.jsx("button",{"data-test":"workflow-add-row-button",onClick:b.handleAddRow,className:"mt-2 w-full py-1 text-xs border bg-background hover:bg-accent rounded",children:"+ Add Row"}),b.showNodeUpdateConfig&&b.selectedRowId&&t.jsx(bp,{isVisible:b.showNodeUpdateConfig,onClose:()=>{b.setShowNodeUpdateConfig(!1),b.setSelectedRowId(null)},allNodes:x,currentConfig:(C=b.findRowRecursive(n,b.selectedRowId))==null?void 0:C.config,onSave:b.handleSaveNodeUpdateConfig,initialPosition:b.popoverPosition||void 0,initialSize:b.popoverSize||void 0}),b.showIfStepConfig&&b.selectedRowId&&t.jsx(Np,{isVisible:b.showIfStepConfig,onClose:()=>{b.setShowIfStepConfig(!1),b.setSelectedRowId(null)},currentConfig:(M=b.findRowRecursive(n,b.selectedRowId))==null?void 0:M.config,onSave:b.handleSaveIfStepConfig,initialPosition:b.popoverPosition||void 0,initialSize:b.popoverSize||void 0})]})},lv="type here...",dv=({node:e,preventEdit:s})=>{var M;const n=p.useRef(null),[o,r]=p.useState(s),[a,i]=p.useState(e.content||""),c=e.data,l=(c==null?void 0:c.displayFormat)||"raw",{updateNodeContent:d,updateNode:u,setMode:h}=E.getState(),g=z(I=>I.uiState.nodeToFocusId);z(I=>{var A;return((A=I.uiState.dragInfo)==null?void 0:A.draggedNodeId)===e.id});const f=z(I=>{var A,O;return((O=(A=I.projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes)==null?void 0:O.some(F=>F.id===e.id))??!1}),w=f&&g===e.id,m=z(I=>{var A,O;return((O=(A=I.projectCanvas.getActive())==null?void 0:A.coreState.selectedNodes)==null?void 0:O.length)??0}),{fitNodeDimensions:x}=an(),y=p.useMemo(()=>{if(l==="json")try{const I=JSON.parse(a);return JSON.stringify(I,null,2)}catch{return a}return a},[a,l]),v=I=>{i(I.target.value)},N=p.useCallback(I=>{I.preventDefault();const A=I.clipboardData.getData("text"),O=n.current;if(!O)return;const F=O.selectionStart,B=O.selectionEnd,W=O.value,P=W.substring(0,F)+A+W.substring(B);O.value=P;const k=F+A.length;O.setSelectionRange(k,k),i(P),d(e.id,P)},[e.id,d]),b=p.useCallback(I=>{r(I),u(e.id,{isEditing:I})},[u,e.id]),j=p.useCallback(()=>{var I;d(e.id,a),b(!1),u(e.id,{isEditing:!1}),(I=window.getSelection())==null||I.removeAllRanges()},[e.id,d,a,u]),R=p.useCallback(I=>{if(I.shiftKey){!o&&f&&m<=1&&(b(!0),setTimeout(()=>{var O;return(O=n.current)==null?void 0:O.focus()},0));return}const A=f&&m<=1;A&&b(A)},[o,f,m]),S=p.useCallback(I=>{var L,H,$,_;if(I.key==="Escape"){j(),b(!1),E.getState().uiState.mode!==J.VIM&&h(J.SELECT),(L=n.current)==null||L.blur();return}if(I.key==="Enter"&&I.ctrlKey){const G=((H=n.current)==null?void 0:H.value)||"";d(e.id,G);return}const A=(($=n.current)==null?void 0:$.value)??"",O=k(A),F=P(),B=T(A,I.key==="Enter",F),W=(_=e.options)!=null&&_.lockSize?e.width:O;u(e.id,{width:W,height:B,isEditing:!0});function P(){const G=n.current;if(G){const D=window.getComputedStyle(G).lineHeight;if(D&&D!=="normal"){const Y=parseFloat(D);if(!isNaN(Y))return Y}}return be.LINE_HEIGHT}function k(G,V=be.DEFAULT_NODE_WIDTH,D=Ns.textNodeXPadding){const ie=G.split(/\n/).map(X=>vo(X)).reduce((X,ce)=>Math.max(X,ce),0)+D,we=Math.max(ie,V);return Math.max(we,e.width??0)}function T(G,V=!1,D=be.LINE_HEIGHT){let te=G.split(/\n/).length,ie=be.DEFAULT_NODE_HEIGHT;return te===1&&!V?(ie=Math.max(ie,e.height??0),ie):(V&&(te+=1),ie+=(te-1)*D,ie=Math.max(ie,e.height??0),ie)}},[j,d,u,e.id,e.width]);p.useEffect(()=>{g||b(!1)},[g]),p.useEffect(()=>{w&&(b(!0),i(e.content||""),window.setTimeout(()=>{const I=n.current;I&&(I.focus(),I.selectionStart=I.selectionEnd=I.value.length)},0))},[w,e.content]),p.useEffect(()=>{i(e.content||"")},[e.content]);const C=p.useCallback(()=>{const I=l==="raw"?"json":"raw";u(e.id,{data:{...c,displayFormat:I}})},[l,e.id,c,u]);return t.jsxs("div",{className:"relative w-full h-full",children:[f&&t.jsx("button",{onClick:C,className:"absolute -top-7 right-0 z-50 px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",title:`Switch to ${l==="raw"?"JSON":"raw"} format`,children:l==="raw"?"Raw":"JSON"}),t.jsx("textarea",{spellCheck:!1,ref:n,id:`WorkflowSourceNode-${e.id}`,value:o?a:y,onChange:v,onPaste:N,onBlur:j,onKeyDown:S,onMouseDown:R,placeholder:lv,"data-is-editing":s?!1:o,className:je("relative z-10","m-0 p-1 w-full h-full","resize-none","overflow-hidden","border","font-mono",e.className,{"pointer-events-none":s,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!a&&!o}),style:{textAlign:(M=e.styles)==null?void 0:M.textAlign,fontSize:l==="json"?`${be.FONT_SIZE_XXS}px`:Z.text.fontSize,lineHeight:l==="json"?"1.4":"1.5"},readOnly:!o})]})},Zi=Ie.memo(dv),ft=e=>kt(ps,e),uv=({node:e,preventEdit:s})=>{const{updateNode:n}=E.getState(),o=z(y=>{var v,N;return((N=(v=y.projectCanvas.getActive())==null?void 0:v.coreState.selectedNodes)==null?void 0:N.some(b=>b.id===e.id))??!1}),r=ft(y=>y.definitions),a=ft(y=>y.createInstance),i=ft(y=>y.executeInstance),c=ft(y=>y.isExecuting),l=e.data||{},{definitionId:d,instanceId:u,lastExecutionStatus:h="idle"}=l,g=p.useMemo(()=>r.find(y=>y.id===d),[r,d]),f=p.useCallback(y=>{const v=a(y,`${(g==null?void 0:g.name)||"Workflow"} Instance`);n(e.id,{data:{...l,definitionId:y,instanceId:v.id,lastExecutionStatus:"idle"},title:(g==null?void 0:g.name)||"Workflow"})},[e.id,l,n,a,g]),w=p.useCallback(async()=>{if(!u){console.warn("No instance selected");return}try{n(e.id,{data:{...l,lastExecutionStatus:"running"}});const y=await i(u);n(e.id,{data:{...l,lastExecutionStatus:y.success?"completed":"failed"}})}catch{n(e.id,{data:{...l,lastExecutionStatus:"failed"}})}},[u,l,e.id,n,i]),m=p.useMemo(()=>{switch(h){case"running":return t.jsx(Yn,{className:"h-4 w-4 animate-spin text-blue-500"});case"completed":return t.jsx(Fh,{className:"h-4 w-4 text-green-500"});case"failed":return t.jsx(Bh,{className:"h-4 w-4 text-red-500"});default:return t.jsx(Cs,{className:"h-4 w-4 text-gray-400"})}},[h]),x=p.useMemo(()=>{switch(h){case"running":return"border-blue-500";case"completed":return"border-green-500";case"failed":return"border-red-500";default:return"border-border"}},[h]);return t.jsxs("div",{className:je("workflow-definition-node w-full h-full p-3 bg-background border-2 rounded flex flex-col gap-2",x,{"ring-2 ring-primary":o}),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Cs,{className:"h-5 w-5 text-primary"}),t.jsx("span",{className:"text-sm font-semibold",children:"Workflow"})]}),m]}),t.jsxs(ct,{value:d||"",onValueChange:f,disabled:s,children:[t.jsx(lt,{className:"w-full h-8 text-xs",children:t.jsx(dt,{placeholder:"Select workflow..."})}),t.jsx(ut,{children:r.length===0?t.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"No workflows available"}):r.map(y=>t.jsx(_e,{value:y.id,className:"text-xs",children:y.name},y.id))})]}),d&&t.jsx("div",{className:"flex gap-1",children:t.jsxs(Q,{size:"sm",variant:"default",className:"flex-1 h-7 text-xs",onClick:w,disabled:!d||c||s,children:[t.jsx(ot,{className:"h-3 w-3 mr-1"}),"Execute"]})}),g&&o&&t.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[t.jsxs("div",{children:["Nodes: ",g.nodes.length]}),t.jsxs("div",{children:["Connections: ",g.connections.length]}),g.tags&&g.tags.length>0&&t.jsx("div",{className:"flex gap-1 flex-wrap",children:g.tags.map(y=>t.jsx("span",{className:"px-1 py-0.5 bg-primary/10 text-primary rounded text-[10px]",children:y},y))})]})]})},hv=Ie.memo(uv),pv=({node:e})=>{const{updateNode:s}=E.getState(),n=p.useRef(null),o=p.useRef(null),[r,a]=p.useState(!1),i=p.useRef(null),c=z(I=>{var O;const A=I.projectCanvas.getActive();return((O=A==null?void 0:A.coreState.selectedNodes)==null?void 0:O.some(F=>F.id===e.id))??!1}),l=z(I=>{var O;const A=I.projectCanvas.getActive();return((O=A==null?void 0:A.coreState.nodes)==null?void 0:O.length)??0}),d=e.data||{},[u,h]=p.useState(d.image||null),{result:g,isProcessing:f,error:w,processBlob:m,cancel:x,reset:y}=Ap();p.useEffect(()=>{o.current&&c&&o.current.focus()},[c]),p.useEffect(()=>{if(!c)return;const I=async A=>{var F;A.preventDefault(),A.stopPropagation();const O=(F=A.clipboardData)==null?void 0:F.items;if(O){for(const B of O)if(B.type.startsWith("image/")){const W=B.getAsFile();if(W){const P=new FileReader;P.onload=()=>{const k=P.result;h(k),y(),s(e.id,{data:{...d,image:k}})},P.readAsDataURL(W)}break}}};return document.addEventListener("paste",I),()=>{document.removeEventListener("paste",I)}},[c,e.id,d,s,y]),p.useEffect(()=>{if(!g)return;const I=g.timestamp.toISOString();if(i.current===I)return;const A=g.extractedText||"[No text detected in image]",O={image:u||void 0,extractedText:g.extractedText,detectedLanguage:g.detectedLanguage,confidence:g.confidence,processingTime:g.processingTime,timestamp:g.timestamp.toISOString()};s(e.id,{data:O,content:g.extractedText});const F=Le.buildTextNodeV2({content:A});ea(F,e,"right",{shouldFocus:!1}),i.current=I},[g,u,e.id,e,s,l]);const v=p.useCallback(async I=>{var O;const A=(O=I.target.files)==null?void 0:O[0];if(A&&A.type.startsWith("image/")){const F=new FileReader;F.onload=()=>{const B=F.result;h(B),y(),s(e.id,{data:{...d,image:B}})},F.readAsDataURL(A)}},[y,e.id,d,s]),N=p.useCallback(async()=>{if(!u)return;const A=await(await fetch(u)).blob();await m(A)},[u,m]),b=p.useCallback(async()=>{if(!u)return;const A=await(await fetch(u)).blob();await m(A,{downscale:!0,downscaleFactor:.5})},[u,m]),j=p.useCallback(()=>{x()},[x]),R=p.useCallback(()=>{h(null),y(),n.current&&(n.current.value=""),s(e.id,{data:{},content:""})},[y,e.id,s]),S=p.useCallback(async()=>{const I=(g==null?void 0:g.extractedText)||d.extractedText;if(I)try{await navigator.clipboard.writeText(I),a(!0),setTimeout(()=>a(!1),2e3)}catch(A){console.error("Failed to copy:",A)}},[g,d]),C=p.useCallback(I=>{var O;I.preventDefault(),I.stopPropagation();const A=(O=I.clipboardData)==null?void 0:O.items;if(A){for(const F of A)if(F.type.startsWith("image/")){const B=F.getAsFile();if(B){const W=new FileReader;W.onload=()=>{const P=W.result;h(P),y(),s(e.id,{data:{...d,image:P}})},W.readAsDataURL(B)}break}}},[e.id,d,y,s]),M=g||(d.extractedText?{extractedText:d.extractedText,detectedLanguage:d.detectedLanguage,confidence:d.confidence,processingTime:d.processingTime}:null);return t.jsxs("div",{className:"canvas-ocr-node w-full h-full p-4 flex flex-col gap-3 overflow-auto",children:[t.jsxs("div",{className:"ocr-header flex items-center justify-between pb-2 border-b border-border",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(uo,{className:"h-4 w-4 text-primary"}),t.jsx("h3",{className:"text-sm font-semibold",children:"OCR Node"})]}),u&&t.jsx(Q,{"data-test":"ocr-clear-button",variant:"ghost",size:"sm",onClick:R,className:"h-6 px-2",children:t.jsx(Be,{className:"h-3 w-3"})})]}),t.jsx("div",{ref:o,className:"image-input-area border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onPaste:C,tabIndex:0,role:"button","aria-label":"Paste image area",children:u?t.jsxs("div",{className:"image-preview-container space-y-2",children:[t.jsx("img",{src:u,alt:"OCR preview",className:"image-preview max-w-full max-h-32 mx-auto rounded-lg shadow-sm"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for OCR"})]}):t.jsxs("div",{className:"empty-state space-y-2",children:[t.jsx(zn,{className:"w-6 h-6 mx-auto text-muted-foreground"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Paste image (Ctrl+V) or upload"})]})}),t.jsxs("div",{className:"upload-controls",children:[t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:v,className:"hidden"}),t.jsxs(Q,{"data-test":"ocr-upload-button",variant:"outline",size:"sm",onClick:()=>{var I;return(I=n.current)==null?void 0:I.click()},className:"w-full",children:[t.jsx(zn,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]}),w&&!f&&t.jsxs(Ip,{variant:"destructive",children:[t.jsx(ko,{className:"h-4 w-4"}),t.jsx(Tp,{className:"text-xs",children:w})]}),t.jsx("div",{className:"ocr-controls flex flex-col gap-2",children:f?t.jsxs(Q,{"data-test":"ocr-cancel-button",variant:"destructive",onClick:j,className:"w-full",size:"sm",children:[t.jsx(Yn,{className:"w-3 h-3 mr-2 animate-spin"}),"Cancel"]}):t.jsxs(t.Fragment,{children:[t.jsxs(Q,{"data-test":"ocr-extract-button",onClick:N,disabled:!u,className:"w-full",size:"sm",children:[t.jsx(uo,{className:"w-3 h-3 mr-2"}),"Extract Text"]}),t.jsxs(Q,{"data-test":"ocr-extract-downscale-button",onClick:b,disabled:!u,variant:"outline",className:"w-full",size:"sm",children:[t.jsx(uo,{className:"w-3 h-3 mr-2"}),"Downscale and Extract"]})]})}),M&&t.jsxs("div",{className:"ocr-results space-y-2 flex-1 flex flex-col",children:[t.jsxs("div",{className:"results-header flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[t.jsx(Ba,{className:"w-3 h-3 text-green-600"}),t.jsx("span",{children:"Extracted"})]}),t.jsx(Q,{"data-test":"ocr-copy-result-button",variant:"ghost",size:"sm",onClick:S,className:"h-6 px-2",children:r?t.jsxs(t.Fragment,{children:[t.jsx(Ba,{className:"w-3 h-3 mr-1 text-green-600"}),t.jsx("span",{className:"text-xs",children:"Copied!"})]}):t.jsxs(t.Fragment,{children:[t.jsx(Pt,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"text-xs",children:"Copy"})]})})]}),(M.detectedLanguage||M.confidence||M.processingTime)&&t.jsxs("div",{className:"results-metadata text-xs text-muted-foreground space-y-1",children:[M.detectedLanguage&&t.jsxs("div",{children:["Language: ",M.detectedLanguage]}),M.confidence&&t.jsxs("div",{children:["Confidence: ",M.confidence]}),M.processingTime&&t.jsxs("div",{children:["Time: ",M.processingTime,"ms"]})]}),t.jsx("div",{className:"results-text flex-1 p-3 bg-muted rounded-lg font-mono text-xs whitespace-pre-wrap break-words overflow-y-auto",children:M.extractedText})]})]})},gv=Ie.memo(pv),Ma=1/3;function Pa(e,s){return new Promise(n=>{const o=new Image;o.onload=()=>{const r=Math.round(o.naturalWidth*s),a=Math.round(o.naturalHeight*s),i=document.createElement("canvas");i.width=r,i.height=a;const c=i.getContext("2d");if(!c){n({dataUrl:e,size:{width:o.naturalWidth,height:o.naturalHeight}});return}c.drawImage(o,0,0,r,a);const l=i.toDataURL("image/jpeg",.85);n({dataUrl:l,size:{width:r,height:a}})},o.onerror=()=>{n({dataUrl:e,size:{width:0,height:0}})},o.src=e})}const fv=({node:e})=>{const{updateNode:s}=E.getState(),n=p.useRef(null),o=p.useRef(null),r=z(u=>{var g;const h=u.projectCanvas.getActive();return((g=h==null?void 0:h.coreState.selectedNodes)==null?void 0:g.some(f=>f.id===e.id))??!1}),a=e.data||{},[i,c]=p.useState(a.image||null);p.useEffect(()=>{o.current&&r&&o.current.focus()},[r]),p.useEffect(()=>{if(!r)return;const u=async h=>{var f;h.preventDefault(),h.stopPropagation();const g=(f=h.clipboardData)==null?void 0:f.items;if(g){for(const w of g)if(w.type.startsWith("image/")){const m=w.getAsFile();if(m){Math.round(m.size/1024);const x=new FileReader;x.onload=async()=>{let y=x.result,v;{const b=await Pa(y,Ma);y=b.dataUrl,v=b.size}c(y);const N=Math.round(y.length*3/4/1024);s(e.id,{data:{...a,imageSize:v,fileSizeKB:N,image:y}})},x.readAsDataURL(m)}break}}};return document.addEventListener("paste",u),()=>{document.removeEventListener("paste",u)}},[r,e.id,a,s]);const l=p.useCallback(async u=>{var g;const h=(g=u.target.files)==null?void 0:g[0];if(h&&h.type.startsWith("image/")){Math.round(h.size/1024);const f=new FileReader;f.onload=async()=>{let w=f.result,m;{const y=await Pa(w,Ma);w=y.dataUrl,m=y.size}c(w);const x=Math.round(w.length*3/4/1024);s(e.id,{data:{...a,imageSize:m,fileSizeKB:x,image:w}})},f.readAsDataURL(h)}},[e.id,a,s]),d=p.useCallback(u=>{var g;u.preventDefault(),u.stopPropagation();const h=(g=u.clipboardData)==null?void 0:g.items;if(h){for(const f of h)if(f.type.startsWith("image/")){const w=f.getAsFile();if(w){Math.round(w.size/1024);const m=new FileReader;m.onload=async()=>{let x=m.result,y;{const N=await Pa(x,Ma);x=N.dataUrl,y=N.size}c(x);const v=Math.round(x.length*3/4/1024);s(e.id,{data:{...a,imageSize:y,fileSizeKB:v,image:x}})},m.readAsDataURL(w)}break}}},[e.id,a,s]);return t.jsx("div",{ref:o,className:"canvas-image-node w-full h-full overflow-hidden",onPaste:d,tabIndex:0,role:"button","aria-label":"Paste image area","data-test":"canvas-image-node",children:i?t.jsx("img",{src:i,alt:"Image",className:"w-full h-full object-contain pointer-events-none select-none",draggable:!1,"data-test":"image-preview"}):t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center gap-3 border-2 border-dashed rounded-lg hover:border-primary transition-colors","data-test":"image-empty-state",children:[t.jsx(zn,{className:"w-8 h-8 text-muted-foreground"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Paste image (Ctrl+V) or upload"}),t.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:l,className:"hidden","data-test":"image-file-input"}),t.jsxs(Q,{"data-test":"image-upload-button",variant:"outline",size:"sm",onClick:()=>{var u;return(u=n.current)==null?void 0:u.click()},children:[t.jsx(zn,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]})})},mv=Ie.memo(fv),vd=({node:e})=>{var B;const s=E.getState().updateNode,n=E.getState().deleteNodeById,o=E.getState().setSelectedNodes,a=z(W=>W.uiState.activeGroupId)===e.id,c=z(W=>W.uiState.hoveredDropTargetGroupId)===e.id,l=e.data,d=(l==null?void 0:l.childNodeIds)??[],u=e.isCollapsed??!1,h=Mw(e),[g,f]=p.useState(!1),[w,m]=p.useState(!1),[x,y]=p.useState(!1),[v,N]=p.useState(null),b=p.useCallback(W=>{W.stopPropagation(),s(e.id,{isCollapsed:!u})},[e.id,u,s]),j=p.useCallback(W=>{W.stopPropagation();const P=E.getState(),k=P.projectCanvas.getActive();if(!k)return;const L=k.coreState.nodes.filter(H=>d.includes(H.id));L.forEach(H=>{P.updateNode(H.id,{groupId:void 0})}),o(L),n(e.id)},[e.id,d,n,o]),R=p.useCallback(W=>{W.stopPropagation(),W.preventDefault();const P=E.getState(),k=P.projectCanvas.getActive();if(!k)return;const L=k.coreState.nodes.filter(H=>d.includes(H.id));L.length!==0&&(P.setSelectedNodes(L),P.arrow.setSelected([]))},[d]),S=p.useCallback(async W=>{if(W.stopPropagation(),!g){f(!0);try{const P=E.getState(),k=P.projectCanvas.getActive();if(!k)return;const T=k.coreState.nodes,L=k.coreState.arrows,H=k.coreState.selectedNodes,$=await Lw(e,T,L,H);$.success?$.nodeUpdates.forEach(({nodeId:_,updates:G})=>{P.updateNode(_,G)}):console.error("Workflow execution failed:",$.error)}catch(P){console.error("Error executing workflow:",P)}finally{f(!1)}}},[e,g]),C=p.useCallback(W=>{if(W.stopPropagation(),!w){m(!0);try{const P=E.getState(),k=P.projectCanvas.getActive();if(!k)return;const L=P.getVisualWorkflowPresets().find(ie=>{var we;return((we=ie.sourceLocation)==null?void 0:we.groupNodeId)===e.id});if(L){Se.info(`Workflow "${L.name}" already saved`,{description:"This workflow group is already in presets",duration:3e3});return}const H=k.coreState.nodes,$=k.coreState.arrows,_=Ka(e,H,$);if(_.length===0){Se.warning("No workflow steps found",{description:"Add workflow step nodes to save this workflow",duration:3e3});return}const G=_.map(ie=>({id:ie.nodeId,stepType:ie.stepType,config:ie.config,label:ie.label})),V=e.title||"Untitled Workflow",{path:D}=Os(P);if(!D.projectId||!D.workspaceId||!D.canvasId)throw new Error("Could not determine canvas location for workflow preset");const Y={projectId:D.projectId,workspaceId:D.workspaceId,canvasId:D.canvasId,groupNodeId:e.id},te=P.createVisualWorkflowPreset(V,G,Y);Se.success(`Workflow saved: ${V}`,{description:`${G.length} step${G.length!==1?"s":""} saved to presets`,duration:3e3}),console.log(`Workflow saved as preset: ${V} (${te})`)}catch(P){console.error("Error saving workflow:",P),Se.error("Failed to save workflow",{description:P instanceof Error?P.message:"Unknown error",duration:4e3})}finally{m(!1)}}},[e,w]),M=p.useCallback(W=>{W.stopPropagation();const k=E.getState().projectCanvas.getActive();if(!k)return;const T=k.coreState.nodes,L=k.coreState.arrows,$=Ka(e,T,L).map(G=>({id:G.nodeId,stepType:G.stepType,config:G.config,label:G.label})),_={name:e.title||"Untitled Workflow",groupNodeId:e.id,stepCount:$.length,stepTypes:[...new Set($.map(G=>G.stepType))],steps:$};N(_),y(!0)},[e]),I=(B=l==null?void 0:l.styles)==null?void 0:B.backgroundColor,A=!I,O={};I&&(O.backgroundColor=`color-mix(in srgb, ${I} 20%, transparent)`),!a&&!c&&(O.border="1px solid hsl(var(--muted-foreground) / 0.3)"),c&&(O.border="2px dashed hsl(var(--primary))",O.boxShadow="0 0 0 4px hsl(var(--primary) / 0.2)");const F=I?`color-mix(in srgb, ${I} 60%, transparent)`:void 0;return t.jsxs("div",{className:je("w-full h-full rounded-lg","flex flex-col","pointer-events-none",A&&"bg-background",a&&"ring-2 ring-dashed ring-primary/50"),style:O,"data-test":"group-node-content",children:[t.jsxs("div",{className:je("flex items-center gap-1 px-2 py-1","border-b border-border/50","select-none",!a&&"pointer-events-auto",!F&&"bg-muted/70"),style:F?{backgroundColor:F}:void 0,"data-test":"group-header",children:[t.jsx("button",{className:"p-0.5 rounded hover:bg-muted transition-colors",onPointerDown:W=>{W.stopPropagation()},onClick:b,title:u?"Expand group":"Collapse group","data-test":"group-collapse-toggle",children:u?t.jsx(on,{className:"h-4 w-4 text-muted-foreground"}):t.jsx(Ct,{className:"h-4 w-4 text-muted-foreground"})}),t.jsx("span",{className:"flex-1 text-sm font-medium text-foreground truncate",title:e.title||"Group","data-test":"group-name",children:e.title||"Group"}),h&&t.jsxs("div",{className:"flex items-center gap-0.5 border-r border-border/50 pr-1 mr-1","data-test":"group-workflow-actions",children:[t.jsx("button",{className:je("p-0.5 rounded transition-colors",g?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:W=>W.stopPropagation(),onClick:S,disabled:g,title:g?"Executing workflow...":"Execute workflow","data-test":"group-execute-workflow-button",children:t.jsx(ot,{className:je("h-4 w-4",g?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:je("p-0.5 rounded transition-colors",w?"bg-primary/20 cursor-wait":"hover:bg-primary/20"),onPointerDown:W=>W.stopPropagation(),onClick:C,disabled:w,title:w?"Saving workflow...":"Save workflow to presets","data-test":"group-save-workflow-button",children:t.jsx(Jt,{className:je("h-4 w-4",w?"text-primary animate-pulse":"text-muted-foreground hover:text-primary")})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:W=>W.stopPropagation(),onClick:M,title:"View workflow JSON","data-test":"group-json-viewer-button",children:t.jsx(Qo,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})})]}),t.jsxs("div",{className:"flex items-center gap-0.5","data-test":"group-node-actions",children:[t.jsx("span",{className:"text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded",title:`${d.length} nodes in group`,"data-test":"group-child-count",children:d.length}),t.jsx("button",{className:"p-0.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:R,title:"Select all nodes in group","data-test":"group-select-all-button",children:t.jsx(mr,{className:"h-4 w-4 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-0.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:W=>{W.stopPropagation()},onClick:j,title:"Ungroup","data-test":"group-ungroup-button",children:t.jsx(xr,{className:"h-4 w-4 text-muted-foreground hover:text-destructive"})})]})]}),!u&&t.jsx("div",{className:"flex-1 min-h-[20px] pointer-events-none","data-test":"group-body"}),a&&t.jsxs("div",{className:"flex items-center justify-center gap-1 px-2 py-1 border-t border-primary/30 bg-primary/5","data-test":"group-edit-mode-footer",children:[t.jsx(Ks,{className:"h-3 w-3 text-primary"}),t.jsx("span",{className:"text-xs text-primary font-medium",children:"Editing - click outside to exit"})]}),t.jsx(Ve,{isVisible:x,onClose:()=>y(!1),title:`Workflow: ${e.title||"Untitled"}`,initialSize:{width:1200,height:1e3},triggerPosition:{x:(typeof window<"u"?window.innerWidth:1920)/2-600,y:(typeof window<"u"?window.innerHeight:1080)/2-500},resizable:!0,"data-test":"workflow-json-viewer-popover",children:v&&t.jsx("div",{className:"h-full overflow-auto","data-test":"workflow-json-content",children:t.jsx(Cl,{data:v,onDataChange:()=>{}})})})]})};vd.displayName="GroupNodeV2";const Qa=({node:e})=>{const s=p.useRef(null),n=p.useRef(null),o=p.useRef(0),r=Vn(),a=z(T=>{var L;return((L=T.projectCanvas.getActive())==null?void 0:L.viewState.scale)??1}),i=z(T=>{var L;return((L=T.projectCanvas.getActive())==null?void 0:L.coreState.nodes)??[]}),l=z(T=>T.uiState.activeChatNodeId)===e.id,d=z(T=>T.uiState.chatNodeHoldToDrag);(d==null?void 0:d.nodeId)===e.id&&(d==null||d.isHolding),(d==null?void 0:d.nodeId)===e.id&&(d==null||d.isReady);const u=e.data,h=(u==null?void 0:u.childNodeIds)??[],g=(u==null?void 0:u.viewMode)??"chat",f=p.useRef(null),w=p.useRef(null),m=p.useRef(g),x=p.useRef(Date.now()+Z.claudeChat.alignScrollDuration+100),[y,v]=p.useState(null);p.useEffect(()=>{g==="chat"&&m.current!=="chat"&&(x.current=Date.now()+Z.claudeChat.alignScrollDuration+100),m.current=g},[g]),p.useEffect(()=>{g==="chat"&&(f.current===null&&(f.current=a),w.current===null&&(w.current={x:e.x,y:e.y}))},[g,a,e.x,e.y]),p.useEffect(()=>{if(g!=="chat")return;if(Date.now()<x.current){f.current=a,w.current={x:e.x,y:e.y};return}const T=f.current!==null&&Math.abs(a-f.current)>.01,L=w.current!==null&&(Math.abs(e.x-w.current.x)>1||Math.abs(e.y-w.current.y)>1);(T||L)&&(E.getState().updateNode(e.id,{data:{...u,viewMode:"canvas"}}),f.current=null,w.current=null)},[g,a,e.x,e.y,e.id,u]);const N=p.useMemo(()=>h.map(T=>i.find(L=>L.id===T)).filter(T=>T!==void 0),[h,i]);p.useEffect(()=>{const T=N.length;if(T>o.current&&s.current){const L=s.current;requestAnimationFrame(()=>{L.scrollTop=L.scrollHeight})}o.current=T},[N.length]),p.useEffect(()=>{const T=s.current;if(!T)return;const L=H=>{H.stopPropagation()};return T.addEventListener("wheel",L,{capture:!0}),()=>T.removeEventListener("wheel",L,{capture:!0})},[]),p.useEffect(()=>{if(!r||g!=="chat"){v(null);return}const T=()=>{const L=document.querySelector('[data-test="canvas-chat-input-container"]'),H=document.querySelector("[data-canvas-container]"),$=n.current;if(!L||!H||!$)return;const _=L.getBoundingClientRect().top,G=H.getBoundingClientRect().top,V=$.getBoundingClientRect(),D=44,Y=Math.max(V.top,G),ie=Math.min(V.bottom,_)-Y-D;ie>0&&v(ie)};return T(),window.addEventListener("resize",T),()=>window.removeEventListener("resize",T)},[r,g,e.width,e.height]);const b=p.useCallback(()=>{const T=E.getState(),L=Le.buildTextNodeV2({content:"",x:e.x,y:e.y});T.addNode(L);const H=e.data||{childNodeIds:[]};T.updateNode(e.id,{data:{...H,childNodeIds:[...H.childNodeIds,L.id]}}),T.setSelectedNodes([L]),T.setNodeToFocusId(L.id)},[e.id,e.x,e.y,e.data]),j=p.useCallback(()=>{E.getState().deleteNodeById(e.id)},[e.id]),R=p.useCallback(T=>{T.stopPropagation(),E.getState().setActiveChatNodeId(e.id,!0);const L=document.querySelector('[data-test="canvas-chat-input-textarea-container"] textarea');L==null||L.focus()},[e.id]),S=p.useRef(0),C=300,M=p.useCallback(()=>{l||E.getState().setActiveChatNodeId(e.id,!0)},[l,e.id]),I=p.useCallback(T=>{T.stopPropagation(),M()},[M]),A=p.useCallback(T=>{const L=Date.now();L-S.current<C?(T.stopPropagation(),M(),S.current=0):S.current=L},[M]),{zoomFontSize:O}=Z.chatNode,F=a>=O.minScale&&a<=O.maxScale,B=Z.chatInput.mobile.nodeFontSize,W=F?O.fontSize:r?parseInt(B):16,P=p.useMemo(()=>({inChat:!0,containerWidth:(e.width??400)-32,chatNodeId:e.id,onSendMessage:b}),[e.id,b,e.width]),k=r&&g==="chat";return t.jsxs("div",{ref:n,className:je("w-full h-full","flex flex-col","bg-background","transition-all duration-200","overflow-hidden",k?"":"rounded-lg shadow-lg",!k&&(l?"border-4 border-primary":"border-2 border-primary/30")),style:{},onDoubleClick:I,onTouchEnd:A,"data-test":"chat-node-content",children:[t.jsxs("div",{className:je("flex items-center gap-2 px-3 py-2","border-b border-border/50","bg-muted/50","select-none","flex-shrink-0"),"data-test":"chat-header",children:[t.jsx(ir,{className:"h-5 w-5 text-muted-foreground"}),t.jsx("span",{className:"flex-1 text-base font-medium text-foreground truncate",title:e.title||"Chat","data-test":"chat-name",children:e.title||"Chat"}),t.jsx("span",{className:"text-sm text-muted-foreground bg-muted px-2 py-0.5 rounded",title:`${N.length} messages`,"data-test":"chat-message-count",children:N.length}),t.jsx("button",{className:je("p-1.5 rounded transition-colors",l?"bg-primary/20 text-primary":"hover:bg-primary/10 text-muted-foreground hover:text-primary"),onPointerDown:T=>T.stopPropagation(),onClick:T=>{T.stopPropagation(),l?E.getState().setActiveChatNodeId(null,!0):E.getState().setActiveChatNodeId(e.id,!0)},title:l?"Active chat target":"Set as active chat target","data-test":"chat-pin-active-button",children:t.jsx($h,{className:"h-5 w-5"})}),t.jsx("button",{className:"p-1.5 rounded hover:bg-primary/20 transition-colors",onPointerDown:T=>T.stopPropagation(),onClick:R,title:"Focus chat input","data-test":"chat-focus-input-button",children:t.jsx(zh,{className:"h-5 w-5 text-muted-foreground hover:text-primary"})}),t.jsx("button",{className:"p-1.5 rounded hover:bg-destructive/20 transition-colors",onPointerDown:T=>T.stopPropagation(),onClick:j,title:"Close chat","data-test":"chat-close-button",children:t.jsx(Be,{className:"h-5 w-5 text-muted-foreground hover:text-destructive"})})]}),t.jsx("div",{ref:s,className:je("flex-1 overflow-y-auto overflow-x-hidden","flex flex-col-reverse items-end","py-3"),style:{gap:`${Z.chatNode.messageGap*(r?2:1)}px`,touchAction:"pan-y",paddingLeft:r&&Z.chatNode.viewMode==="fullwidth"?`${Z.chatNode.fullwidth.contentPadding}px`:"12px",paddingRight:r&&Z.chatNode.viewMode==="fullwidth"?`${Z.chatNode.fullwidth.contentPadding}px`:"12px"},"data-test":"chat-messages-container",children:t.jsx(Kl.Provider,{value:P,children:N.length===0?t.jsx("div",{className:"flex items-center justify-center h-20 text-muted-foreground text-base w-full","data-test":"chat-empty-state",children:"No messages yet. Click + to add one."}):a<bn?[...N].reverse().map(T=>t.jsx("div",{className:"bg-primary rounded",style:{width:T.width??100,height:T.height??30},"data-test":"chat-message-simplified"},T.id)):[...N].reverse().map(T=>{const L={...T,styles:{...T.styles,fontSize:`${W}px`}},H=Z.chatInput.mobile.fontConfig;return t.jsx("div",{className:"relative bg-muted/30 rounded-lg",style:{width:"auto",minWidth:50,maxWidth:"85%",padding:`${Z.chatNode.messagePadding}px`,fontSize:H.cssFontSize,lineHeight:H.cssLineHeight},"data-test":"chat-message",children:t.jsx(ql,{node:L})},T.id)})})})]})};Qa.displayName="ChatNodeV2";const Ji=[{type:"if",label:"If Condition",icon:"🔀",description:"Conditional logic based on field values"},{type:"toolbarAction",label:"Toolbar Action",icon:"⚡",description:"Execute canvas toolbar actions"},{type:"tagUpdate",label:"Tag Update",icon:"🏷️",description:"Add, remove, or set node tags"},{type:"loop",label:"Loop",icon:"🔄",description:"Iterate over nodes or data"},{type:"source",label:"Source",icon:"📥",description:"Define data source for workflow"}],xv=[{value:"selection.count",label:"Selection Count",description:"Number of selected nodes"},{value:"node.title",label:"Node Title",description:"Title of the node"},{value:"node.content",label:"Node Content",description:"Content of the node"},{value:"node.tags",label:"Node Tags",description:"Tags array of the node"},{value:"loop.index",label:"Loop Index",description:"Current loop iteration (1-based)"},{value:"loop.current",label:"Loop Current",description:"Current loop value"},{value:"loop.total",label:"Loop Total",description:"Total loop iterations"}],wv=[{value:"==",label:"Equals",symbol:"=="},{value:"!=",label:"Not Equals",symbol:"!="},{value:">",label:"Greater Than",symbol:">"},{value:">=",label:"Greater or Equal",symbol:">="},{value:"<",label:"Less Than",symbol:"<"},{value:"<=",label:"Less or Equal",symbol:"<="},{value:"contains",label:"Contains",symbol:"contains"},{value:"matches",label:"Matches (regex)",symbol:"matches"}],Qi=[{value:"addTags",label:"Add Tags"},{value:"removeTags",label:"Remove Tags"},{value:"setTags",label:"Set Tags"},{value:"updateTitle",label:"Update Title"},{value:"updateContent",label:"Update Content"},{value:"setStyle",label:"Set Background"},{value:"toolbarAction",label:"Run Toolbar Action"}],yv=({config:e,onChange:s})=>{const n=h=>{s({...e,condition:{...e.condition,field:h}})},o=h=>{s({...e,condition:{...e.condition,operator:h}})},r=h=>{s({...e,condition:{...e.condition,value:h}})},a=h=>{s({...e,then:{type:h,value:h==="addTags"||h==="removeTags"||h==="setTags"?[]:""}})},i=h=>{const g=e.then.type,f=g==="addTags"||g==="removeTags"||g==="setTags"?h.split(",").map(w=>w.trim()).filter(Boolean):h;s({...e,then:{...e.then,value:f}})},c=h=>{s({...e,else:{type:h,value:h==="addTags"||h==="removeTags"||h==="setTags"?[]:""}})},l=h=>{if(!e.else)return;const g=e.else.type,f=g==="addTags"||g==="removeTags"||g==="setTags"?h.split(",").map(w=>w.trim()).filter(Boolean):h;s({...e,else:{...e.else,value:f}})},d=h=>Array.isArray(h.value)?h.value.join(", "):String(h.value||""),u=h=>h==="addTags"||h==="removeTags"||h==="setTags"?"tag1, tag2":"value";return t.jsxs("div",{"data-test":"if-condition-config",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"if-condition-section",className:"space-y-1 p-1.5 bg-muted/30 rounded border border-border",children:[t.jsx("span",{"data-test":"if-condition-section-label",className:"text-[10px] font-semibold text-muted-foreground uppercase",children:"If"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(ct,{value:e.condition.field,onValueChange:h=>n(h),children:[t.jsx(lt,{"data-test":"if-condition-field-trigger",className:"h-6 text-[11px] flex-1",onClick:h=>h.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"if-condition-field-content",children:xv.map(h=>t.jsx(_e,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsxs(ct,{value:e.condition.operator,onValueChange:h=>o(h),children:[t.jsx(lt,{"data-test":"if-condition-operator-trigger",className:"h-6 text-[11px] w-16",onClick:h=>h.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"if-condition-operator-content",children:wv.map(h=>t.jsx(_e,{value:h.value,className:"text-xs",children:h.symbol},h.value))})]}),t.jsx(Re,{"data-test":"if-condition-value-input",value:e.condition.value,onChange:h=>r(h.target.value),onClick:h=>h.stopPropagation(),placeholder:"value",className:"h-6 text-[11px] w-16"})]})]}),t.jsxs("div",{"data-test":"if-then-section",className:"space-y-1 p-1.5 bg-green-500/10 rounded border border-green-500/30",children:[t.jsx("span",{"data-test":"if-then-section-label",className:"text-[10px] font-semibold text-green-700 dark:text-green-400 uppercase",children:"Then"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(ct,{value:e.then.type,onValueChange:h=>a(h),children:[t.jsx(lt,{"data-test":"if-then-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:h=>h.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"if-then-action-type-content",children:Qi.map(h=>t.jsx(_e,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsx(Re,{"data-test":"if-then-action-value-input",value:d(e.then),onChange:h=>i(h.target.value),onClick:h=>h.stopPropagation(),placeholder:u(e.then.type),className:"h-6 text-[11px] flex-1"})]})]}),t.jsxs("div",{"data-test":"if-else-section",className:"space-y-1 p-1.5 bg-orange-500/10 rounded border border-orange-500/30",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{"data-test":"if-else-section-label",className:"text-[10px] font-semibold text-orange-700 dark:text-orange-400 uppercase",children:"Else"}),e.else&&t.jsx("button",{"data-test":"if-else-remove-button",onClick:h=>{h.stopPropagation(),s({...e,else:void 0})},className:"text-[10px] text-muted-foreground hover:text-destructive",children:"✕"})]}),e.else?t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(ct,{value:e.else.type,onValueChange:h=>c(h),children:[t.jsx(lt,{"data-test":"if-else-action-type-trigger",className:"h-6 text-[11px] w-24",onClick:h=>h.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"if-else-action-type-content",children:Qi.map(h=>t.jsx(_e,{value:h.value,className:"text-xs",children:h.label},h.value))})]}),t.jsx(Re,{"data-test":"if-else-action-value-input",value:d(e.else),onChange:h=>l(h.target.value),onClick:h=>h.stopPropagation(),placeholder:u(e.else.type),className:"h-6 text-[11px] flex-1"})]}):t.jsx("button",{"data-test":"if-else-add-button",onClick:h=>{h.stopPropagation(),s({...e,else:{type:"addTags",value:[]}})},className:"text-[10px] text-primary hover:underline",children:"+ Add else"})]})]})},vv=[{value:"split",label:"Split"},{value:"arrange",label:"Arrange"},{value:"align",label:"Align"},{value:"group",label:"Group"},{value:"collapse",label:"Collapse"}],ec={split:[{value:"byWhitespace",label:"By Whitespace"},{value:"byLine",label:"By Line"},{value:"byParagraph",label:"By Paragraph"},{value:"byComma",label:"By Comma"},{value:"byPeriod",label:"By Period"},{value:"byRegex",label:"By Regex"}],arrange:[{value:"horizontal:top",label:"Horizontal (Top)"},{value:"horizontal:bottom",label:"Horizontal (Bottom)"},{value:"vertical:left",label:"Vertical (Left)"},{value:"vertical:right",label:"Vertical (Right)"},{value:"grid",label:"Grid"},{value:"masonry",label:"Masonry"}],align:[{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"},{value:"top",label:"Top"},{value:"middle",label:"Middle"},{value:"bottom",label:"Bottom"}],group:[{value:"create",label:"Create Group"},{value:"ungroup",label:"Ungroup"}],collapse:[{value:"collapse",label:"Collapse"},{value:"expand",label:"Expand"}]},bv=({config:e,onChange:s})=>{var l,d,u,h;const n=g=>{var w;const f=((w=ec[g][0])==null?void 0:w.value)||"";s({facadeKey:g,actionId:f,params:{}})},o=g=>{s({...e,actionId:g})},r=(g,f)=>{s({...e,params:{...e.params,[g]:f}})},a=e.facadeKey==="split",i=e.facadeKey==="arrange",c=e.facadeKey==="arrange"&&e.actionId==="grid";return t.jsxs("div",{"data-test":"toolbar-action-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"toolbar-action-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:"Execute canvas toolbar actions on selected nodes"}),t.jsxs("div",{"data-test":"toolbar-action-category",children:[t.jsx("label",{"data-test":"toolbar-action-category-label",className:"text-xs font-medium",children:"Category"}),t.jsxs(ct,{value:e.facadeKey,onValueChange:g=>n(g),children:[t.jsx(lt,{"data-test":"toolbar-action-category-trigger",className:"h-7 text-xs mt-1",onClick:g=>g.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"toolbar-action-category-content",children:vv.map(g=>t.jsx(_e,{value:g.value,"data-test":"toolbar-action-category-option",className:"text-xs",children:g.label},g.value))})]})]}),t.jsxs("div",{"data-test":"toolbar-action-action",children:[t.jsx("label",{"data-test":"toolbar-action-action-label",className:"text-xs font-medium",children:"Action"}),t.jsxs(ct,{value:e.actionId,onValueChange:o,children:[t.jsx(lt,{"data-test":"toolbar-action-action-trigger",className:"h-7 text-xs mt-1",onClick:g=>g.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"toolbar-action-action-content",children:ec[e.facadeKey].map(g=>t.jsx(_e,{value:g.value,"data-test":"toolbar-action-action-option",className:"text-xs",children:g.label},g.value))})]})]}),(a||i)&&t.jsxs("div",{"data-test":"toolbar-action-options",className:"space-y-2 p-2 bg-muted/30 rounded border border-border",children:[t.jsx("label",{"data-test":"toolbar-action-options-label",className:"text-xs font-semibold",children:"Options"}),a&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{"data-test":"toolbar-action-keep-arrows",className:"flex items-center gap-2",children:[t.jsx(We,{"data-test":"toolbar-action-keep-arrows-checkbox",checked:((l=e.params)==null?void 0:l.keepArrows)||!1,onCheckedChange:g=>r("keepArrows",g),onClick:g=>g.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-arrows-label",className:"text-xs",children:"Keep Arrows"})]}),t.jsxs("div",{"data-test":"toolbar-action-keep-match",className:"flex items-center gap-2",children:[t.jsx(We,{"data-test":"toolbar-action-keep-match-checkbox",checked:((d=e.params)==null?void 0:d.keepMatch)||!1,onCheckedChange:g=>r("keepMatch",g),onClick:g=>g.stopPropagation()}),t.jsx("label",{"data-test":"toolbar-action-keep-match-label",className:"text-xs",children:"Keep Match"})]})]}),t.jsxs("div",{"data-test":"toolbar-action-gap",children:[t.jsx("label",{"data-test":"toolbar-action-gap-label",className:"text-xs text-muted-foreground",children:"Gap"}),t.jsx(Re,{"data-test":"toolbar-action-gap-input",type:"number",value:((u=e.params)==null?void 0:u.gap)||20,onChange:g=>r("gap",parseInt(g.target.value,10)),onClick:g=>g.stopPropagation(),className:"h-7 text-xs mt-1",min:0})]}),c&&t.jsxs("div",{"data-test":"toolbar-action-columns",children:[t.jsx("label",{"data-test":"toolbar-action-columns-label",className:"text-xs text-muted-foreground",children:"Columns"}),t.jsx(Re,{"data-test":"toolbar-action-columns-input",type:"number",value:((h=e.params)==null?void 0:h.columns)||3,onChange:g=>r("columns",parseInt(g.target.value,10)),onClick:g=>g.stopPropagation(),className:"h-7 text-xs mt-1",min:1})]})]})]})},tc=[{value:"add",label:"Add Tags",description:"Add tags to existing tags"},{value:"remove",label:"Remove Tags",description:"Remove specific tags"},{value:"set",label:"Set Tags",description:"Replace all tags with new ones"},{value:"clear",label:"Clear All Tags",description:"Remove all tags from nodes"}],Nv=({config:e,onChange:s})=>{var u;const[n,o]=p.useState(""),r=h=>{s({...e,mode:h})},a=()=>{const h=n.trim();h&&(e.tags.includes(h)||s({...e,tags:[...e.tags,h]}),o(""))},i=h=>{s({...e,tags:e.tags.filter(g=>g!==h)})},c=h=>{h.key==="Enter"&&(h.preventDefault(),h.stopPropagation(),a())},l=h=>{s({...e,useTemplate:h})},d=((u=tc.find(h=>h.value===e.mode))==null?void 0:u.description)||"";return t.jsxs("div",{"data-test":"tag-update-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"tag-update-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:d}),t.jsxs("div",{"data-test":"tag-update-mode",children:[t.jsx("label",{"data-test":"tag-update-mode-label",className:"text-xs font-medium",children:"Mode"}),t.jsxs(ct,{value:e.mode,onValueChange:h=>r(h),children:[t.jsx(lt,{"data-test":"tag-update-mode-trigger",className:"h-7 text-xs mt-1",onClick:h=>h.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"tag-update-mode-content",children:tc.map(h=>t.jsx(_e,{value:h.value,"data-test":"tag-update-mode-option",className:"text-xs",children:h.label},h.value))})]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-tags",className:"space-y-2",children:[t.jsx("label",{"data-test":"tag-update-tags-label",className:"text-xs font-medium",children:"Tags"}),e.tags.length>0&&t.jsx("div",{"data-test":"tag-update-tags-chips",className:"flex flex-wrap gap-1 p-2 bg-muted/30 rounded border border-border",children:e.tags.map((h,g)=>t.jsxs("div",{"data-test":"tag-update-tag-chip",className:"flex items-center gap-1 px-2 py-0.5 bg-primary/10 text-primary rounded-full text-xs",children:[t.jsx("span",{"data-test":"tag-update-tag-text",children:h}),t.jsx("button",{"data-test":"tag-update-tag-remove",onClick:f=>{f.stopPropagation(),i(h)},className:"hover:text-destructive",children:t.jsx(Be,{size:12})})]},`${h}-${g}`))}),t.jsx(Re,{"data-test":"tag-update-tags-input",value:n,onChange:h=>o(h.target.value),onKeyDown:c,onClick:h=>h.stopPropagation(),placeholder:"Type tag and press Enter...",className:"h-7 text-xs"}),t.jsxs("p",{"data-test":"tag-update-tags-hint",className:"text-xs text-muted-foreground",children:["Press Enter to add tag. Supports templates like ","{","{","loop.current","}","."]})]}),e.mode!=="clear"&&t.jsxs("div",{"data-test":"tag-update-template",className:"flex items-center gap-2 p-2 bg-muted/30 rounded",children:[t.jsx(We,{"data-test":"tag-update-template-checkbox",checked:e.useTemplate||!1,onCheckedChange:l,onClick:h=>h.stopPropagation()}),t.jsxs("label",{"data-test":"tag-update-template-label",className:"text-xs",children:["Use template variables (e.g., ","{","{","loop.current","}",")"]})]}),e.useTemplate&&t.jsxs("div",{"data-test":"tag-update-template-help",className:"text-xs text-muted-foreground bg-blue-500/10 p-2 rounded border border-blue-500/30",children:[t.jsx("strong",{children:"Available variables:"}),t.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-0.5",children:[t.jsxs("li",{children:["{","{","loop.current","}"," - Current item in loop"]}),t.jsxs("li",{children:["{","{","loop.index","}"," - Loop index (1-based)"]}),t.jsxs("li",{children:["{","{","loop.total","}"," - Total iterations"]})]})]})]})},sc=[{value:"connectedNode",label:"Connected Node",description:"Iterate over data from incoming arrow connection"},{value:"selectedNodes",label:"Selected Nodes",description:"Iterate over currently selected nodes on canvas"},{value:"allNodes",label:"All Canvas Nodes",description:"Iterate over all nodes on the canvas"}],Sv=({config:e,onChange:s})=>{var r;const n=a=>{s({...e,source:a})},o=((r=sc.find(a=>a.value===e.source))==null?void 0:r.description)||"";return t.jsxs("div",{"data-test":"loop-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"loop-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:o}),t.jsxs("div",{"data-test":"loop-config-source",children:[t.jsx("label",{"data-test":"loop-config-source-label",className:"text-xs font-medium",children:"Data Source"}),t.jsxs(ct,{value:e.source,onValueChange:a=>n(a),children:[t.jsx(lt,{"data-test":"loop-config-source-trigger",className:"h-7 text-xs mt-1",onClick:a=>a.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"loop-config-source-content",children:sc.map(a=>t.jsx(_e,{value:a.value,"data-test":"loop-config-source-option",className:"text-xs",children:a.label},a.value))})]})]}),t.jsxs("div",{"data-test":"loop-config-variables",className:"p-2 bg-blue-500/10 rounded border border-blue-500/30 space-y-2",children:[t.jsx("label",{"data-test":"loop-config-variables-label",className:"text-xs font-semibold text-blue-700 dark:text-blue-300",children:"Available Variables"}),t.jsxs("div",{"data-test":"loop-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"loop-config-variable-current",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.current","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current item being processed"})]}),t.jsxs("div",{"data-test":"loop-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.index","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Current iteration (1-based)"})]}),t.jsxs("div",{"data-test":"loop-config-variable-total",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-blue-500/20 rounded text-blue-700 dark:text-blue-300",children:["{","{","loop.total","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Total number of iterations"})]})]}),t.jsxs("div",{"data-test":"loop-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-blue-500/30",children:[t.jsx("strong",{children:"Example:"})," Use"," ",t.jsxs("code",{className:"px-1 bg-blue-500/20 rounded",children:["{","{","loop.current","}"]})," ","in subsequent steps to reference the current item."]})]}),t.jsxs("div",{"data-test":"loop-config-tips",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Tip:"})," Steps connected after this loop will execute once per item. Use loop variables in those steps to access iteration data."]})]})},nc=[{value:"connectedNode",label:"Connected Node",description:"Read data from incoming arrow connection"},{value:"inline",label:"Inline Data",description:"Define data directly in this node"}],Cv=({config:e,onChange:s})=>{var c;const n=l=>{s({...e,dataFrom:l,inlineData:l==="inline"?e.inlineData||"{}":void 0})},o=l=>{s({...e,inlineData:l})};let r=null,a=null;if(e.dataFrom==="inline"&&e.inlineData)try{r=JSON.parse(e.inlineData)}catch(l){a=l.message}const i=((c=nc.find(l=>l.value===e.dataFrom))==null?void 0:c.description)||"";return t.jsxs("div",{"data-test":"source-config",className:"space-y-3",children:[t.jsx("div",{"data-test":"source-config-info",className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:i}),t.jsxs("div",{"data-test":"source-config-data-from",children:[t.jsx("label",{"data-test":"source-config-data-from-label",className:"text-xs font-medium",children:"Data From"}),t.jsxs(ct,{value:e.dataFrom,onValueChange:l=>n(l),children:[t.jsx(lt,{"data-test":"source-config-data-from-trigger",className:"h-7 text-xs mt-1",onClick:l=>l.stopPropagation(),children:t.jsx(dt,{})}),t.jsx(ut,{"data-test":"source-config-data-from-content",children:nc.map(l=>t.jsx(_e,{value:l.value,"data-test":"source-config-data-from-option",className:"text-xs",children:l.label},l.value))})]})]}),e.dataFrom==="inline"&&t.jsxs("div",{"data-test":"source-config-inline-data",className:"space-y-2",children:[t.jsx("label",{"data-test":"source-config-inline-data-label",className:"text-xs font-medium",children:"Inline Data (JSON)"}),t.jsx("textarea",{"data-test":"source-config-inline-data-textarea",value:e.inlineData||"",onChange:l=>o(l.target.value),onClick:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),placeholder:'{"key": "value"}',className:"w-full h-24 text-xs font-mono border border-border rounded px-2 py-1 bg-background resize-none"}),a&&t.jsxs("div",{"data-test":"source-config-parse-error",className:"text-xs text-destructive bg-destructive/10 p-2 rounded border border-destructive/30",children:[t.jsx("strong",{children:"Invalid JSON:"})," ",a]}),!a&&r&&t.jsxs("div",{"data-test":"source-config-preview",className:"space-y-1",children:[t.jsx("label",{"data-test":"source-config-preview-label",className:"text-xs font-medium text-muted-foreground",children:"Preview"}),t.jsx("div",{"data-test":"source-config-preview-content",className:"text-xs font-mono bg-muted/30 p-2 rounded border border-border max-h-32 overflow-auto",children:t.jsx("pre",{children:JSON.stringify(r,null,2)})})]})]}),t.jsxs("div",{"data-test":"source-config-variables",className:"p-2 bg-green-500/10 rounded border border-green-500/30 space-y-2",children:[t.jsx("label",{"data-test":"source-config-variables-label",className:"text-xs font-semibold text-green-700 dark:text-green-300",children:"Access Data"}),t.jsxs("div",{"data-test":"source-config-variables-list",className:"space-y-1.5",children:[t.jsxs("div",{"data-test":"source-config-variable-key",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.key","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access object property by key"})]}),t.jsxs("div",{"data-test":"source-config-variable-index",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source[0]","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access array element by index"})]}),t.jsxs("div",{"data-test":"source-config-variable-nested",className:"text-xs",children:[t.jsxs("code",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-green-700 dark:text-green-300",children:["{","{","source.user.name","}"]}),t.jsx("span",{className:"ml-2 text-muted-foreground",children:"Access nested properties"})]})]}),t.jsxs("div",{"data-test":"source-config-variables-example",className:"text-xs text-muted-foreground mt-2 pt-2 border-t border-green-500/30",children:[t.jsx("strong",{children:"Example:"})," If source data is"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{",'"',"users",'"',": [",'"',"name",'"',": ",'"',"Alice",'"',"}","}"," "]}),", use"," ",t.jsxs("code",{className:"px-1 bg-green-500/20 rounded",children:["{","{","source.users[0].name","}"]})," ","to get ",'"',"Alice",'"',"."]})]}),e.dataFrom==="connectedNode"&&t.jsxs("div",{"data-test":"source-config-connected-info",className:"text-xs text-muted-foreground bg-muted/50 p-2 rounded",children:[t.jsx("strong",{children:"Note:"})," Connect an arrow from another node to provide data. The connected node's content or output will be available via ",t.jsx("code",{children:"{{source}}"})," variables."]})]})},jv=({nodeId:e,data:s,onDataChange:n})=>{var l;const[o,r]=p.useState(s.stepType),a=d=>{r(d);let u;switch(d){case"if":u={condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}};break;case"toolbarAction":u={facadeKey:"split",actionId:"byWhitespace",params:{}};break;case"tagUpdate":u={mode:"add",tags:[]};break;case"loop":u={source:"connectedNode"};break;case"source":u={dataFrom:"connectedNode"};break;default:u={}}n({stepType:d,config:u})},i=d=>{o&&n({stepType:o,config:d})},c=o?((l=Ji.find(d=>d.type===o))==null?void 0:l.icon)||"⚡":"❓";return t.jsxs("div",{"data-test":"workflow-step-node",className:"flex flex-col gap-1 p-1.5 bg-background border border-border rounded-md min-w-[240px]",onMouseDown:d=>d.stopPropagation(),onClick:d=>d.stopPropagation(),children:[t.jsxs("div",{"data-test":"workflow-step-header",className:"flex items-center gap-1.5",children:[t.jsx("span",{"data-test":"workflow-step-icon",className:"text-sm",children:c}),t.jsxs(ct,{value:o??"",onValueChange:d=>a(d),children:[t.jsx(lt,{"data-test":"workflow-step-type-trigger",className:"h-6 text-[11px] flex-1",onClick:d=>d.stopPropagation(),children:t.jsx(dt,{placeholder:"Select step type..."})}),t.jsx(ut,{"data-test":"workflow-step-type-content",children:Ji.map(d=>t.jsx(_e,{value:d.type,"data-test":"workflow-step-type-option",className:"text-xs",children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{children:d.icon}),t.jsx("span",{children:d.label})]})},d.type))})]})]}),o?t.jsxs("div",{"data-test":"workflow-step-config-panel",children:[o==="if"&&t.jsx(yv,{config:s.config,onChange:d=>i(d)}),o==="toolbarAction"&&t.jsx(bv,{config:s.config,onChange:d=>i(d)}),o==="tagUpdate"&&t.jsx(Nv,{config:s.config,onChange:d=>i(d)}),o==="loop"&&t.jsx(Sv,{config:s.config,onChange:d=>i(d)}),o==="source"&&t.jsx(Cv,{config:s.config,onChange:d=>i(d)})]}):t.jsx("div",{"data-test":"workflow-step-placeholder",className:"text-[10px] text-muted-foreground text-center py-2",children:"Select a step type to configure"})]})},kv=({node:e})=>{const o=e.data||{stepType:"if",config:{condition:{field:"selection.count",operator:">=",value:"1"},then:{type:"addTags",value:[]}}},r=p.useCallback(a=>{E.getState().updateNode(e.id,{data:a})},[e.id]);return t.jsx("div",{"data-test":"canvas-workflow-step-node",className:"w-full h-full",children:t.jsx(jv,{nodeId:e.id,data:o,onDataChange:r})})};function bd({nodeId:e,preventEdit:s=!1,onEditStart:n,onEditEnd:o,inputRefs:r,clearSelectionOnBlur:a=!1}){const[i,c]=p.useState(!1),l=z(v=>v.uiState.nodeToFocusId),d=z(v=>{var N,b;return((b=(N=v.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)==null?void 0:b.some(j=>j.id===e))??!1}),u=z(v=>{var N,b;return((b=(N=v.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)==null?void 0:b.length)??0}),h=d&&l===e,{updateNode:g,setMode:f}=E.getState(),w=p.useCallback(v=>{c(v),g(e,{isEditing:v})},[e,g]),m=p.useCallback(v=>{var N;if(!document.querySelector("[data-radix-popper-content-wrapper]")){if(r&&r.length>0&&(v!=null&&v.relatedTarget)){const b=v.relatedTarget;if(r.some(R=>R.current===b))return}o==null||o(),w(!1),a&&(E.getState().setNodeToFocusId(null),E.getState().setSelectedNodes([])),(N=window.getSelection())==null||N.removeAllRanges()}},[o,w,r,a]),x=p.useCallback(()=>{d&&u<=1&&!s&&(i||n==null||n(),w(!0))},[d,u,s,i,n,w]),y=p.useCallback(v=>{v.key==="Escape"&&(m(),E.getState().uiState.mode!==J.VIM&&f(J.SELECT))},[m,f]);return p.useEffect(()=>{l||w(!1)},[l,w]),p.useEffect(()=>{!d&&i&&w(!1)},[d,i,w]),p.useEffect(()=>{if(!h||s)return;!i&&(n==null||n()),w(!0)},[h,s,i,n,w]),p.useEffect(()=>{if(!r||r.length===0)return;const v=[];return r.forEach(N=>{if(N.current){const b=j=>m(j);N.current.addEventListener("blur",b),v.push({el:N.current,handler:b})}}),()=>{v.forEach(({el:N,handler:b})=>{N.removeEventListener("blur",b)})}},[m,r]),{isEditing:i,shouldFocus:h,isSelected:d,selectedNodesCount:u,handleMouseDown:x,handleBlur:m,handleKeyDown:y,setIsEditing:w}}const Av=({nodeId:e,nodeData:s,preventEdit:n})=>{const o=p.useRef(null),r=p.useRef(null),a=p.useRef(null),[i,c]=p.useState(s.sourceWord||""),[l,d]=p.useState(s.translationWord||""),[u,h]=p.useState(null),{isEditing:g,isSelected:f,selectedNodesCount:w,handleKeyDown:m}=bd({nodeId:e,preventEdit:n,inputRefs:[r,a],clearSelectionOnBlur:!0,onEditEnd:()=>{x({sourceWord:i,translationWord:l})}});p.useEffect(()=>{c(s.sourceWord||""),d(s.translationWord||"")},[s.sourceWord,s.translationWord]),p.useEffect(()=>{requestAnimationFrame(()=>{var O,F;const M=((O=E.getState().projectCanvas.getActive())==null?void 0:O.viewState.scale)??1,A=(((F=o.current)==null?void 0:F.getBoundingClientRect().height)??0)/M;A>0&&E.getState().updateNode(e,{height:A})})},[e,i,l]);const x=p.useCallback(C=>{const M=s;E.getState().updateNode(e,{data:{...M,...C}})},[e,s]),y=C=>{c(C.target.value)},v=C=>{d(C.target.value)},N=C=>{const I=E.getState().getNodeById(C);return I&&typeof I.content=="string"?I.content.trim():""},b=p.useCallback(C=>{C.preventDefault(),h(null);const M=C.dataTransfer.getData("application/json");if(M)try{const I=JSON.parse(M);if(I.nodeIds&&Array.isArray(I.nodeIds)&&I.nodeIds.length>=1){const A=I.nodeIds.map(O=>{const F=E.getState().getNodeById(O);return F?{id:O,x:F.x,y:F.y,content:N(O)}:null}).filter(Boolean);if(A.length>=2){A.sort((B,W)=>B.x+B.y-(W.x+W.y));const O=A[0].content,F=A[A.length-1].content;c(O),d(F),x({sourceWord:O,translationWord:F})}else if(A.length===1){const O=A[0].content;i?(d(O),x({translationWord:O})):(c(O),x({sourceWord:O}))}}else if(I.nodeId){const A=N(I.nodeId);c(A),x({sourceWord:A})}}catch(I){console.error("Failed to parse drop data:",I)}},[i,x]),j=p.useCallback(C=>{C.preventDefault(),h(null);const M=C.dataTransfer.getData("application/json");if(M)try{const I=JSON.parse(M);if(I.nodeIds&&Array.isArray(I.nodeIds)&&I.nodeIds.length>=1){const A=I.nodeIds.map(O=>{const F=E.getState().getNodeById(O);return F?{id:O,x:F.x,y:F.y,content:N(O)}:null}).filter(Boolean);if(A.length>=2){A.sort((B,W)=>B.x+B.y-(W.x+W.y));const O=A[0].content,F=A[A.length-1].content;c(O),d(F),x({sourceWord:O,translationWord:F})}else if(A.length===1){const O=A[0].content;l?(c(O),x({sourceWord:O})):(d(O),x({translationWord:O}))}}else if(I.nodeId){const A=N(I.nodeId);d(A),x({translationWord:A})}}catch(I){console.error("Failed to parse drop data:",I)}},[l,x]),R=(C,M)=>{C.preventDefault(),h(M)},S=()=>{h(null)};return t.jsxs("div",{ref:o,className:"w-full flex flex-col","data-text-position-container":"true","data-test":"vocab-vocabulary-view",children:[t.jsx("div",{className:je("flex items-center justify-center transition-colors rounded-t-md",u==="source"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:b,onDragOver:C=>R(C,"source"),onDragLeave:S,"data-test":"vocab-source-drop-zone",children:t.jsx(Re,{ref:r,type:"text",value:i,onChange:y,onKeyDown:m,placeholder:"Source word...","data-test":"vocab-source-input",className:je("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!g&&!f||w>1||n,"cursor-text":g,"cursor-default":!g}),readOnly:!g})}),t.jsx("div",{className:"py-1","data-test":"vocab-divider",children:t.jsx("div",{className:"border-t border-border"})}),t.jsx("div",{className:je("flex items-center justify-center transition-colors rounded-b-md",u==="translation"&&"bg-primary/10 border-2 border-dashed border-primary"),onDrop:j,onDragOver:C=>R(C,"translation"),onDragLeave:S,"data-test":"vocab-translation-drop-zone",children:t.jsx(Re,{ref:a,type:"text",value:l,onChange:v,onKeyDown:m,placeholder:"Translation...","data-test":"vocab-translation-input",className:je("text-center text-base border-none bg-foreground/5 h-auto py-2 rounded",{"pointer-events-none":!g&&!f||w>1||n,"cursor-text":g,"cursor-default":!g}),readOnly:!g})})]})},Iv={noun:"bg-blue-100 text-blue-800",verb:"bg-green-100 text-green-800",adjective:"bg-purple-100 text-purple-800",adverb:"bg-orange-100 text-orange-800",pronoun:"bg-pink-100 text-pink-800",preposition:"bg-indigo-100 text-indigo-800",conjunction:"bg-yellow-100 text-yellow-800",interjection:"bg-red-100 text-red-800"},Tv=({node:e,preventEdit:s})=>{var X,ce;const n=p.useRef(null),o=p.useRef(null),r=e.data||{vocabType:Ge.DICTIONARY,term:"",definition:""},i=z(ue=>ue.uiState.hoveredDropTargetVocabNodeId)===e.id,[c,l]=p.useState(r.vocabType||Ge.DICTIONARY),[d,u]=p.useState(r.term||""),[h,g]=p.useState(r.pronunciation||""),[f,w]=p.useState(r.partOfSpeech||""),[m,x]=p.useState(r.definition||""),[y,v]=p.useState(r.flashcardBack||""),[N,b]=p.useState((r.wordListItems||[]).join(`
`)),[j,R]=p.useState(r.isFlipped||!1),[S,C]=p.useState(r.expandedSections||["definition"]),{onEditStart:M,onEditEnd:I}=tn(e.id,"title"),{onEditStart:A,onEditEnd:O}=tn(e.id,"content"),F=E.getState().updateNode,{isEditing:B,shouldFocus:W,handleMouseDown:P,handleBlur:k,handleKeyDown:T}=bd({nodeId:e.id,preventEdit:s,onEditStart:()=>{M(d),A(m)},onEditEnd:()=>{const ue=N.split(`
`).map(ee=>ee.trim()).filter(ee=>ee.length>0);F(e.id,{data:{...r,vocabType:c,term:d,pronunciation:h,partOfSpeech:f,definition:m,flashcardBack:y,wordListItems:ue,isFlipped:j,expandedSections:S},title:d,content:m}),I(d),O(m)}});p.useEffect(()=>{u(r.term||""),g(r.pronunciation||""),w(r.partOfSpeech||""),x(r.definition||""),v(r.flashcardBack||""),b((r.wordListItems||[]).join(`
`)),R(r.isFlipped||!1),l(r.vocabType||Ge.DICTIONARY),C(r.expandedSections||["definition"])},[r]),p.useEffect(()=>{W&&B&&n.current&&n.current.focus()},[W,B]);const L=p.useCallback(()=>{k()},[k]),H=p.useCallback(ue=>{var ee,K;T(ue),ue.key==="Escape"&&((ee=n.current)==null||ee.blur(),(K=o.current)==null||K.blur())},[T]),$=ue=>{C(ee=>ee.includes(ue)?ee.filter(K=>K!==ue):[...ee,ue])},_=r.examples&&r.examples.length>0,G=(X=r.relatedWords)==null?void 0:X.some(ue=>ue.type==="synonym"),V=(ce=r.relatedWords)==null?void 0:ce.some(ue=>ue.type==="antonym"),D=r.etymology&&(r.etymology.origin||r.etymology.language),Y=()=>{var ue,ee,K,U,q,se,ne,oe,fe;return t.jsxs("div",{className:"w-full h-full flex flex-col overflow-auto",children:[t.jsx("div",{className:"border-b pb-3 mb-3",children:t.jsx(Re,{ref:n,type:"text",value:d,onChange:he=>u(he.target.value),onBlur:L,onMouseDown:P,onKeyDown:H,placeholder:"Term...","data-test":"vocab-term-input",className:je("text-lg font-semibold",{"pointer-events-none":s,"cursor-text":B,"cursor-default":!B}),readOnly:!B})}),(h||f)&&t.jsxs("div",{className:"flex gap-2 mb-3 flex-wrap",children:[h&&t.jsxs(Ze,{"data-test":"vocab-pronunciation-badge",variant:"secondary",className:"text-xs",children:["/",h,"/"]}),f&&t.jsx(Ze,{"data-test":"vocab-pos-badge",className:je("text-xs",Iv[f]||"bg-gray-100 text-gray-800"),children:f})]}),t.jsxs(gs,{open:S.includes("definition"),onOpenChange:()=>$("definition"),className:"mb-2 border rounded",children:[t.jsxs(fs,{"data-test":"vocab-definition-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Ct,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Definition"})]}),t.jsx(ms,{className:"border-t",children:t.jsx(ar,{ref:o,value:m,onChange:he=>x(he.target.value),onBlur:L,onMouseDown:P,onKeyDown:H,placeholder:"Enter definition...","data-test":"vocab-definition-textarea",className:je("min-h-20 resize-none border-none focus:outline-none bg-transparent text-sm p-3",{"pointer-events-none":s,"cursor-text":B,"cursor-default":!B}),readOnly:!B})})]}),_&&t.jsxs(gs,{open:S.includes("examples"),onOpenChange:()=>$("examples"),className:"mb-2 border rounded",children:[t.jsxs(fs,{"data-test":"vocab-examples-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Ct,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Examples (",((ue=r.examples)==null?void 0:ue.length)||0,")"]})]}),t.jsx(ms,{className:"border-t p-3 space-y-2",children:(ee=r.examples)==null?void 0:ee.map(he=>t.jsxs("div",{"data-test":"vocab-example-item",className:"text-sm p-2 bg-muted rounded",children:[t.jsx("p",{className:"italic",children:he.text}),he.translation&&t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:he.translation})]},he.id))})]}),(G||V)&&t.jsxs(gs,{open:S.includes("related"),onOpenChange:()=>$("related"),className:"mb-2 border rounded",children:[t.jsxs(fs,{"data-test":"vocab-related-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Ct,{className:"h-4 w-4"}),t.jsxs("span",{className:"text-sm font-medium",children:["Related Words",G&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Synonyms (",((K=r.relatedWords)==null?void 0:K.filter(he=>he.type==="synonym").length)||0,")"]}),V&&t.jsxs("span",{className:"ml-2 text-xs text-muted-foreground",children:["• Antonyms (",((U=r.relatedWords)==null?void 0:U.filter(he=>he.type==="antonym").length)||0,")"]})]})]}),t.jsx(ms,{className:"border-t p-3 space-y-2",children:(q=r.relatedWords)==null?void 0:q.map(he=>t.jsxs("div",{"data-test":"vocab-related-word",className:"flex items-center gap-2",children:[t.jsx(Ze,{variant:"outline",className:"text-xs",children:he.type}),t.jsx("span",{className:"text-sm",children:he.word})]},he.id))})]}),D&&t.jsxs(gs,{open:S.includes("etymology"),onOpenChange:()=>$("etymology"),className:"mb-2 border rounded",children:[t.jsxs(fs,{"data-test":"vocab-etymology-trigger",className:"flex items-center gap-2 w-full px-3 py-2 hover:bg-muted",children:[t.jsx(Ct,{className:"h-4 w-4"}),t.jsx("span",{className:"text-sm font-medium",children:"Etymology"})]}),t.jsx(ms,{className:"border-t p-3 space-y-2",children:t.jsxs("div",{"data-test":"vocab-etymology-content",className:"text-sm space-y-2",children:[((se=r.etymology)==null?void 0:se.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((ne=r.etymology)==null?void 0:ne.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((oe=r.etymology)==null?void 0:oe.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((fe=r.etymology)==null?void 0:fe.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})})]})]})},te=()=>t.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center p-4",children:[t.jsx("div",{"data-test":"vocab-flashcard-container",className:"relative w-full flex-1 flex items-center justify-center cursor-pointer",onClick:()=>R(!j),style:{perspective:"1000px"},children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center rounded-lg border-2 border-primary bg-card shadow-lg transition-transform",style:{transformStyle:"preserve-3d",transform:j?"rotateY(180deg)":"rotateY(0deg)",transitionDuration:"0.6s"},children:[t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden"},children:t.jsxs("div",{"data-test":"vocab-flashcard-front",className:"text-center",children:[h&&t.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["/",h,"/"]}),t.jsx("p",{className:"text-3xl font-bold",children:d}),f&&t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:f})]})}),t.jsx("div",{className:"absolute w-full h-full flex flex-col items-center justify-center p-4",style:{backfaceVisibility:"hidden",transform:"rotateY(180deg)"},children:t.jsx("div",{"data-test":"vocab-flashcard-back",className:"text-center",children:t.jsx("p",{className:"text-lg",children:y||m})})})]})}),t.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"Click to flip"})]}),ie=()=>t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-wordlist-container",className:"grid grid-cols-2 gap-2 flex-1",children:(r.wordListItems||[]).map((ue,ee)=>t.jsx("div",{"data-test":"vocab-wordlist-item",className:"p-3 bg-muted rounded-lg border border-border hover:border-primary transition-colors",children:t.jsx("p",{className:"text-sm font-medium",children:ue})},ee))})}),we=()=>{var ue,ee,K,U;return t.jsx("div",{className:"w-full h-full flex flex-col overflow-auto p-4",children:t.jsx("div",{"data-test":"vocab-etymology-view",className:"space-y-4",children:t.jsxs("div",{className:"p-4 bg-muted rounded-lg border border-border",children:[t.jsxs("h3",{className:"font-semibold text-sm flex items-center gap-2 mb-3",children:[t.jsx(_h,{className:"h-4 w-4"}),'Etymology of "',d,'"']}),t.jsxs("div",{className:"space-y-2 text-sm",children:[((ue=r.etymology)==null?void 0:ue.origin)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Origin:"})," ",r.etymology.origin]}),((ee=r.etymology)==null?void 0:ee.language)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Language:"})," ",r.etymology.language]}),((K=r.etymology)==null?void 0:K.year)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Year:"})," ",r.etymology.year]}),((U=r.etymology)==null?void 0:U.evolution)&&t.jsxs("p",{children:[t.jsx("span",{className:"font-semibold",children:"Evolution:"})," ",r.etymology.evolution]})]})]})})})},ge=i?{border:"2px dashed hsl(var(--primary))",boxShadow:"0 0 0 4px hsl(var(--primary) / 0.2)"}:{};return t.jsxs("div",{className:je("w-full h-full rounded-lg transition-all",i&&"ring-2 ring-primary/50"),style:ge,"data-test":"vocabulary-node-content",children:[c===Ge.DICTIONARY&&Y(),c===Ge.FLASHCARD&&te(),c===Ge.WORD_LIST&&ie(),c===Ge.ETYMOLOGY&&we(),c===Ge.VOCABULARY&&t.jsx(Av,{nodeId:e.id,nodeData:r,preventEdit:s})]})},Nd=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},Ev=({element:e,index:s})=>{const{type:n,stroke:o,shape:r,style:a}=e,i=Nd(a),c=a.opacity??1;if(n==="freehand"&&o){const l=c<1;return t.jsx("path",{"data-test":"draw-freehand-path",d:o.smoothedPath,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:"none",strokeLinecap:l?"butt":"round",strokeLinejoin:l?"bevel":"round"},s)}if(n==="shape"&&r){const l=Ke.generateShapeSVGPath(r);return t.jsx("path",{"data-test":"draw-shape-path",d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:i,strokeOpacity:c,fill:a.fillColor||"none",fillOpacity:a.fillColor?c:void 0,strokeLinecap:"round",strokeLinejoin:"round"},s)}return null},Rv=p.memo(Ev),Mv=({drawData:e})=>{if(e.elements&&e.elements.length>0)return t.jsx(t.Fragment,{children:e.elements.map((c,l)=>t.jsx(Rv,{element:c,index:l},l))});const{drawType:s,stroke:n,shape:o,style:r}=e;if(!r)return null;const a=Nd(r),i=r.opacity??1;if(s==="freehand"&&n)return t.jsx("path",{"data-test":"draw-freehand-path",d:n.smoothedPath,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:"none",strokeLinecap:"round",strokeLinejoin:"round"});if(s==="shape"&&o){const c=Ke.generateShapeSVGPath(o);return t.jsx("path",{"data-test":"draw-shape-path",d:c,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeDasharray:a,strokeOpacity:i,fill:r.fillColor||"none",fillOpacity:r.fillColor?i:void 0,strokeLinecap:"round",strokeLinejoin:"round"})}return null},Pv=p.memo(Mv),oc=new Set(["circle","square"]),Dv=e=>{var n;const s=e.elements??[];return s.length===0?(n=e.shape)!=null&&n.shapeType?oc.has(e.shape.shapeType):!1:s.every(o=>{var r;return o.type==="shape"&&((r=o.shape)==null?void 0:r.shapeType)&&oc.has(o.shape.shapeType)})},Ov=({node:e})=>{const s=e.data;if(!s)return null;const n=s.intrinsicWidth??e.width??100,o=s.intrinsicHeight??e.height??100,r=Dv(s);return t.jsx("svg",{"data-test":"draw-node-svg",viewBox:`0 0 ${n} ${o}`,preserveAspectRatio:r?"xMidYMid meet":"none",style:{width:e.width?`${e.width}px`:"100%",height:e.height?`${e.height}px`:"100%",overflow:"visible"},children:t.jsx(Pv,{drawData:s})})},Lv=p.memo(Ov),Wv=[],Sd="turn-to-vocabulary";function ac(e,s){const n=vo(e),o=vo(s),a=Math.max(n,o)+40;return Math.max(a,be.VOCAB_NODE_MIN_WIDTH)}function Cd(){var o;const e=E.getState(),n=(((o=e.projectCanvas.getActive())==null?void 0:o.coreState.selectedNodes)??[]).filter(r=>r.type===le.TEXT).sort((r,a)=>r.x+r.y-(a.x+a.y));if(n.length!==0)if(n.length===1){const a=(typeof n[0].content=="string"?n[0].content:"").trim(),i={vocabType:Ge.VOCABULARY,term:"",definition:"",sourceWord:a,translationWord:""};e.updateNode(n[0].id,{type:le.VOCABULARY,data:i,content:"",width:ac(a,"")})}else{const r=n[0],a=n[n.length-1],i=typeof r.content=="string"?r.content:"",c=typeof a.content=="string"?a.content:"",l=i.trim(),d=c.trim(),u={vocabType:Ge.VOCABULARY,term:"",definition:"",sourceWord:l,translationWord:d};e.updateNode(r.id,{type:le.VOCABULARY,data:u,content:"",width:ac(l,d)});for(let g=1;g<n.length;g++)e.deleteNodeById(n[g].id);const h=e.getNodeById(r.id);h&&e.setSelectedNodes([h])}}uu(Sd,()=>{Cd()});function Hv({node:e,isLockSize:s,onLockSizeToggle:n}){const o=z(p.useCallback(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.coreState.layers)??Wv},[])),r=e.layerId??xt,a=o.filter(f=>f.id!==r),i=a.length>0,c=f=>{var x;const m=(((x=E.getState().projectCanvas.getActive())==null?void 0:x.coreState.selectedNodes)??[]).map(y=>y.id);E.getState().layer.moveNodesToLayer(m,f)},l=()=>{E.getState().deleteSelectedNodes(),E.getState().setSegmentedButtonAction("node-context-menu","Delete",()=>()=>E.getState().deleteSelectedNodes())},d=()=>{Dl()},u=()=>{var m;const w=(((m=E.getState().projectCanvas.getActive())==null?void 0:m.coreState.selectedNodes)??[]).map(x=>typeof x.content=="string"?x.content:"").filter(x=>x.length>0);navigator.clipboard.writeText(w.join(`
`))},h=()=>{Cd(),E.getState().setSegmentedButtonAction("node-context-menu","Turn to Vocabulary",void 0,{actionId:Sd})},g=e.type===le.TEXT;return t.jsxs(Ep,{className:"w-48","data-test":"node-context-menu",children:[t.jsx(Is,{onClick:()=>n(!s),"data-test":"lock-size-item",children:s?t.jsxs(t.Fragment,{children:[t.jsx(bl,{className:"mr-2 h-4 w-4"}),"Unlock Size"]}):t.jsxs(t.Fragment,{children:[t.jsx(Ao,{className:"mr-2 h-4 w-4"}),"Lock Size"]})}),t.jsx(pa,{}),t.jsxs(Is,{onClick:d,"data-test":"copy-item",children:[t.jsx(Pt,{className:"mr-2 h-4 w-4"}),"Copy"]}),t.jsxs(Is,{onClick:u,"data-test":"copy-content-item",children:[t.jsx(yl,{className:"mr-2 h-4 w-4"}),"Copy content"]}),i&&t.jsxs(ga,{children:[t.jsxs(fa,{"data-test":"move-to-trigger",children:[t.jsx(_t,{className:"mr-2 h-4 w-4"}),"Move to"]}),t.jsx(ma,{"data-test":"move-to-submenu",children:t.jsxs(ga,{children:[t.jsxs(fa,{"data-test":"move-to-layer-trigger",children:[t.jsx(nn,{className:"mr-2 h-4 w-4"}),"Layer"]}),t.jsx(ma,{"data-test":"move-to-layer-submenu",children:a.map(f=>t.jsxs(Is,{onClick:()=>c(f.id),disabled:f.isLocked,"data-test":"move-to-layer-option",children:[f.isLocked&&t.jsx(Ao,{className:"mr-2 h-4 w-4"}),f.name]},f.id))})]})})]}),g&&t.jsxs(t.Fragment,{children:[t.jsx(pa,{}),t.jsxs(ga,{children:[t.jsxs(fa,{"data-test":"turn-to-trigger",children:[t.jsx(fr,{className:"mr-2 h-4 w-4"}),"Turn to"]}),t.jsx(ma,{"data-test":"turn-to-submenu",children:t.jsxs(Is,{onClick:h,"data-test":"turn-to-vocabulary-item",children:[t.jsx(Ko,{className:"mr-2 h-4 w-4"}),"Vocabulary"]})})]})]}),t.jsx(pa,{}),t.jsxs(Is,{onClick:l,className:"text-destructive focus:text-destructive","data-test":"delete-item",children:[t.jsx(yt,{className:"mr-2 h-4 w-4"}),"Delete"]})]})}function Bv(){const[e,s]=p.useState(0),n=p.useRef(!1),o=p.useRef(0),r=p.useCallback(a=>{const i=Date.now(),c=i-o.current;if(a){const l=c<50;if(l&&(n.current=!0),n.current&&!l){n.current=!1,s(d=>d+1);return}}else o.current=i,s(l=>l+1)},[e]);return{menuKey:e,handleOpenChange:r}}const{DEFAULT_NODE_WIDTH:Fv,DEFAULT_NODE_HEIGHT:$v}=be,zv=({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o=!1})=>{var O,F;const[r,a]=p.useState(!1),i=z(B=>B.uiState.mode),c=z(B=>!!B.uiState.dragInfo),l=z(B=>!!B.uiState.resizingNode),d=z(B=>B.uiState.activeGroupId),h=e.type===le.GROUP&&d===e.id,g=()=>{var T,L;const B=(T=E.getState().projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes,W=(B==null?void 0:B.some(H=>H.id===e.id))??!1,P=B&&B.length>0?((L=B[B.length-1])==null?void 0:L.id)===e.id:!1,k=(B==null?void 0:B.length)??0;return{isNodeAlreadySelected:W,isLastSelectedNode:P,selectedNodeIdsLength:k}},{isNodeAlreadySelected:f,isLastSelectedNode:w,selectedNodeIdsLength:m}=g();(O=E.getState().projectCanvas.getActive())==null||O.viewState.scale;const y=s&&(n??m)===1,{handleMouseDown:v,initialClickPoint:N}=hy({node:e,mode:i,isPopoverOpen:r,setIsPopoverOpen:a}),{menuKey:b,handleOpenChange:j}=Bv(),R=p.useCallback(B=>{var W;B&&(((W=E.getState().projectCanvas.getActive())==null?void 0:W.coreState.selectedNodes)??[]).length===0&&E.getState().setSelectedNodes([e]),j(B)},[e,j]),S=p.useCallback(B=>{E.getState().updateNode(e.id,{options:{...e.options,lockSize:B}})},[e.id,e.options]),C=p.useCallback(B=>{const W={x:B.clientX,y:B.clientY};if(!hu(N.current,W))return;const k=!e.isEditing&&w;return a(k),k},[e,y,f,w,m,r]);p.useEffect(()=>{if(!f){a(!1);return}if(e.isEditing){a(!1);return}c||l||(w?a(!0):f&&!w&&a(!1))},[m,e.isEditing,f,y,w,e.id,c,l]),p.useEffect(()=>{(c||l)&&a(!1)},[c,l]);const M=()=>{if(o)return e.type===le.CHAT?t.jsx(Qa,{node:e}):null;const B=e.data,W=(B==null?void 0:B.nodeType)==="workflowOrchestration",P=(B==null?void 0:B.nodeType)==="workflowSource";if(W)return t.jsx(qi,{node:e});if(P)return t.jsx(Zi,{node:e,preventEdit:!f});switch(e.type){case le.RECT:return t.jsx(Rm,{node:e});case le.TEXT:return t.jsx(ql,{node:e});case le.TABLE:return t.jsx(Oy,{node:e});case le.TEXTCARD:return t.jsx(Ly,{node:e});case le.WORKFLOW_ORCHESTRATION:return t.jsx(qi,{node:e});case le.WORKFLOW_SOURCE:return t.jsx(Zi,{node:e,preventEdit:!f});case le.WORKFLOW_DEFINITION:return t.jsx(hv,{node:e,preventEdit:!f});case le.OCR:return t.jsx(gv,{node:e});case le.IMAGE:return t.jsx(mv,{node:e});case le.GROUP:return t.jsx(vd,{node:e});case le.CHAT:return t.jsx(Qa,{node:e});case le.VOCABULARY:return t.jsx(Tv,{node:e});case le.WORKFLOW_STEP:return t.jsx(kv,{node:e});case le.DRAWING:return t.jsx(Lv,{node:e});default:return t.jsx("div",{children:"Unknown Node Type"})}},I=Z.getSelectionRingClass(s),A=e.styles;return t.jsx(ny,{node:e,isOpen:r,children:t.jsxs(Rp,{onOpenChange:R,children:[t.jsx(Mp,{asChild:!0,children:t.jsxs("div",{id:`NodeContainerV2-${e.id}`,"data-test":"node-container-v2",className:je("node-container-main","absolute group",i===J.DRAW?"cursor-crosshair":"cursor-grab","select-none","rounded","overflow-visible",s&&I),style:{transform:(()=>{const B=zt.get(e.id),W=B?e.x+B.dx:e.x,P=B?e.y+B.dy:e.y;return`translate(${W}px, ${P}px)`})(),transition:c||l||i===J.DRAW?"none":`transform ${Z.animation.durationMs}ms ${Z.animation.easing}`,width:e.isCollapsed?"auto":`${e.width??Fv}px`,height:e.isCollapsed?"0px":`${e.height??$v}px`,minWidth:e.isCollapsed?"100px":void 0,transformOrigin:"0 0",border:e.isCollapsed?"none":A==null?void 0:A.border,borderWidth:e.isCollapsed||A==null?void 0:A.borderWidth,borderColor:e.isCollapsed||A==null?void 0:A.borderColor,borderStyle:e.isCollapsed?void 0:A!=null&&A.borderWidth?(A==null?void 0:A.borderStyle)||"solid":A==null?void 0:A.borderStyle,willChange:"transform",backfaceVisibility:"hidden",pointerEvents:h?"none":"auto"},onPointerDown:h?void 0:v,onPointerUp:h?void 0:C,"data-node-id":e.id,children:[t.jsx(By,{node:e,isSingleNodeSelected:y,isCollapsed:e.isCollapsed}),!e.isCollapsed&&t.jsx(Qy,{node:e}),e.isPinned&&t.jsx("div",{className:"pin-indicator-border absolute pointer-events-none rounded border-[3px] border-primary",style:{top:"-6px",left:"-6px",right:"-6px",bottom:"-6px",zIndex:1e3}}),(()=>{var T;const B=e.data,W=B==null?void 0:B.nodeType,P=B==null?void 0:B.executionState,k=(T=B==null?void 0:B.executionData)==null?void 0:T.duration;return W&&P?t.jsx(tv,{executionState:P,duration:k}):null})(),y&&t.jsx(Py,{node:e}),!e.isCollapsed&&t.jsxs("section",{className:"node-content-section h-[100%] overflow-visible",children:[t.jsx("div",{id:`node-content-${e.id}`,className:je("node-content-inner relative w-full h-full overflow-visible","flex",{}),children:M()}),(()=>{var k;const B=e.data,W=(B==null?void 0:B.nodeType)==="manualTrigger",P=(k=B==null?void 0:B.parameters)==null?void 0:k.label;return W?t.jsx("div",{className:"manual-trigger-button-container absolute bottom-2 left-2 right-2 px-2",children:t.jsx(xd,{nodeId:e.id,label:P})}):null})()]}),!e.isCollapsed&&t.jsxs(t.Fragment,{children:[t.jsx(ly,{node:e,isSelected:y,mode:i}),t.jsx(uy,{node:e,isSelected:y,mode:i})]})]})}),t.jsx(Hv,{node:e,isLockSize:((F=e.options)==null?void 0:F.lockSize)??!1,onLockSizeToggle:S})]},b)})};function _v(e,s){if(e.node===s.node&&e.isSelected===s.isSelected&&e.selectedNodesCount===s.selectedNodesCount&&e.useSimplifiedRendering===s.useSimplifiedRendering)return!0;if(s.node.type===le.GROUP){const I=[];e.node!==s.node&&I.push("node ref"),e.node.x!==s.node.x&&I.push(`x: ${e.node.x} -> ${s.node.x}`),e.node.y!==s.node.y&&I.push(`y: ${e.node.y} -> ${s.node.y}`),e.isSelected!==s.isSelected&&I.push("isSelected"),e.selectedNodesCount!==s.selectedNodesCount&&I.push(`selectedNodesCount: ${e.selectedNodesCount} -> ${s.selectedNodesCount}`)}const n=e.node.x===s.node.x,o=e.node.y===s.node.y,r=n&&o,a=e.node.width===s.node.width,i=e.node.height===s.node.height,c=a&&i,l=e.isSelected===s.isSelected,d=e.node.content===s.node.content,u=e.node.title===s.node.title,h=e.node.type===s.node.type,g=e.node.isEditing===s.node.isEditing,f=e.node.styles===s.node.styles,w=e.node.tags,m=s.node.tags,x=Array.isArray(w),y=Array.isArray(m),v=w===m||!x&&!y||x&&y&&w.length===m.length&&w.every((I,A)=>I===m[A]),N=e.node.isPinned===s.node.isPinned,b=e.node.isCollapsed===s.node.isCollapsed,j=e.node.data===s.node.data,R=e.node.options===s.node.options,S=e.selectedNodesCount===s.selectedNodesCount,C=e.useSimplifiedRendering===s.useSimplifiedRendering;return!!(r&&c&&l&&d&&u&&h&&g&&f&&v&&N&&b&&j&&R&&S&&C)}const Uo=Ie.memo(({node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o})=>t.jsx(zv,{node:e,isSelected:s,selectedNodesCount:n,useSimplifiedRendering:o}),_v),Vv=e=>{const{className:s,style:n}=e,o=z(f=>f.uiState.mode),r=z(f=>f.uiState.zoomSubMode),a=z(f=>f.uiState.writeSubMode),i=z(f=>f.uiState.drawSubMode),c=z(f=>f.uiState.activeGlobalOverlay),[l,d]=p.useState(null);p.useEffect(()=>{if(o!==J.VIM){d(null);return}const f=()=>{const m=window.__vimContainer;if(!m)return null;try{const x=m.get(Qc),y=x==null?void 0:x.getVimCore(Lt.canvasVim),v=y==null?void 0:y.getVimState();return(v==null?void 0:v.mode)??null}catch{return null}};d(f());const w=setInterval(()=>{d(f())},100);return()=>clearInterval(w)},[o]);let u=o;o===J.ZOOM&&r==="zoom:lock"?u="zoom:lock":o===J.WRITE&&a===Us.AUDIO?u="write:audio":o===J.DRAW?u=`draw: ${Ke.getSubModeLabel(i??Ce.FREEHAND)}`:o===J.VIM&&l&&(u=`vim: ${l.charAt(0)+l.slice(1).toLowerCase()}`);const g=(f=>!f||f===xs.NONE?null:f.charAt(0).toUpperCase()+f.slice(1))(c);return t.jsxs("div",{className:`text-xs p-1 bg-background/50 rounded pointer-events-auto ${s}`,style:{...n},"data-test":"canvas-mode-info",children:[t.jsxs("div",{"data-test":"canvas-mode-info-mode",children:["Mode: ",u||"N/A"]}),g&&t.jsxs("div",{"data-test":"canvas-mode-info-overlay",className:"text-primary",children:["Overlay: ",g]})]})},Uv=e=>{const{className:s,style:n}=e,[o,r]=p.useState(1),[a,i]=p.useState([]);p.useEffect(()=>{const x=E.subscribe(N=>{const b=N.projectCanvas.getActive();b&&r(b.viewState.scale),i(N.uiState.zoomMarks||[])}),y=E.getState(),v=y.projectCanvas.getActive();return v&&r(v.viewState.scale),i(y.uiState.zoomMarks||[]),x},[]);const c=x=>{const y=x[0],v=E.getState(),N=v.projectCanvas.getActive();if(!N)return;const{scale:b,offset:j}=N.viewState,R=document.getElementById("CanvasAppV2");if(!R)return;const S=R.getBoundingClientRect(),C={x:S.width/2,y:S.height/2},M=jt(C,b,j),I=C.x-M.x*y,A=C.y-M.y*y,O=isNaN(I)?0:I,F=isNaN(A)?0:A,B=isNaN(y)?1:y;v.setActiveCanvasViewState(W=>({...W,scale:B,offset:{x:O,y:F}}))},{min:l,max:d,marks:u}=Z.zoom,h=Math.round(o*100),g=Array.from(new Set([...u,...a])).sort((x,y)=>x-y),f=()=>{const x=Math.round(o*100)/100;E.getState().addZoomMark(x)},w=x=>{E.getState().removeZoomMark(x)},m=x=>a.includes(x);return t.jsxs("div",{"data-ui-panel":"zoom-slider","data-test":"canvas-zoom-slider",className:`flex flex-col gap-2 p-2 bg-background/50 rounded pointer-events-auto min-w-[200px] ${s}`,style:{...n},children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{children:"Zoom"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"font-mono",children:[h,"%"]}),t.jsx(Q,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:f,title:"Save current zoom level","data-test":"canvas-zoom-save-button",children:t.jsx(wt,{className:"h-3 w-3"})})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(Yt,{value:[o],onValueChange:c,min:l,max:d,step:.01,className:"cursor-pointer","data-test":"canvas-zoom-slider"}),t.jsx("div",{className:"relative h-4 mt-1 px-3",children:g.map(x=>{const y=(x-l)/(d-l)*100,v=m(x);return t.jsxs("div",{className:"absolute flex flex-col items-center group",style:{left:`${y}%`,transform:"translateX(-50%)"},children:[t.jsxs("div",{className:"cursor-pointer hover:opacity-70 transition-opacity flex flex-col items-center",onClick:()=>c([x]),title:`Zoom to ${Math.round(x*100)}%`,children:[t.jsx("div",{className:`w-px h-2 ${v?"bg-primary/60":"bg-muted-foreground/40"}`}),t.jsx("span",{className:`text-[10px] mt-0.5 ${v?"text-primary":"text-muted-foreground"}`,children:x===1?"1×":`${x}×`})]}),v&&t.jsx("button",{className:"opacity-0 group-hover:opacity-100 absolute -top-2 right-0 h-3 w-3 rounded-full bg-destructive/80 hover:bg-destructive flex items-center justify-center transition-opacity",onClick:N=>{N.stopPropagation(),w(x)},title:"Remove mark","data-test":"canvas-zoom-remove-mark-button",children:t.jsx(Be,{className:"h-2 w-2 text-destructive-foreground"})})]},x)})})]})]})},Da=({position:e,onMouseDown:s,onDoubleClick:n,variant:o="end",size:r=4,className:a})=>t.jsx("circle",{"data-test":"arrow-handle",cx:e.x,cy:e.y,r,fill:"hsl(var(--primary))",stroke:"hsl(var(--primary-foreground))",strokeWidth:1,onPointerDown:s,onDoubleClick:n,className:je("cursor-move",a),style:{pointerEvents:"all",touchAction:"none"}}),rc=Z.arrows.REVERSE_CURVE,Gv=(e,s)=>{const n=(e.x+s.x)/2,o=(e.y+s.y)/2,r=s.x-e.x,a=s.y-e.y,i=Math.sqrt(r*r+a*a);if(i===0)return{path:`M ${e.x} ${e.y}`,controlPoint:e};const c=-a/i,l=r/i;let d=i*.2;(!rc&&e.x<s.x||rc&&e.x>s.x)&&(d=-d);const u=n+c*d,h=o+l*d,g={x:u,y:h};return{path:`M ${e.x} ${e.y} Q ${u} ${h}, ${s.x} ${s.y}`,controlPoint:g}},Yv=(e,s,n)=>{let o=s.x-e.x;const r=s.y-e.y,a=Math.sqrt(o*o+r*r),i=Math.max(20,a*.15);if(a===0)return{x:0,y:i};let c=-r,l=o;n||(o=-o),o<0&&(c=-c,l=-l);const d=c/a,u=l/a;return{x:d*i,y:u*i}},oo=()=>{var s;const e=((s=E.getState().projectCanvas.getActive())==null?void 0:s.coreState.nodes)??[];return zt.size>0?e.map(n=>{const o=zt.get(n.id);return o?{...n,x:n.x+o.dx,y:n.y+o.dy}:n}):e},Kv=(e,s,n,o,r)=>{kt(E,x=>{var y,v;return(v=(y=x.preferences)==null?void 0:y.canvasConfig)==null?void 0:v.arrows});const a=e.type??Z.arrows.type,i=Z.arrows.REVERSE_CURVE,c=Z.arrows.CUBIC_HORIZONTAL_BIAS,l=-10,d=a==="TreeCubic"||a==="TreeLStep"||a==="TreeZShape",u=p.useMemo(()=>{const x=oo(),y=x.find(j=>j.id===e.startNodeId),v=x.find(j=>j.id===e.endNodeId);if(d&&y&&v){const j=qe(y);return Ro(e.endNodeId,e.endPoint,j,x,l)}if((a==="Cubic"||a==="Orthogonal")&&y&&v){const j=qe(y);return $s(e.endNodeId,e.endPoint,j,x,l,c)}if(a==="Step"&&y&&v){const j=qe(y),R=qe(v),S=R.x-j.x,C=R.y-j.y,I=Math.abs(S)*c>=Math.abs(C)?.001:1e3;return $s(e.endNodeId,e.endPoint,j,x,l,I)}const N=y?nt(e.startNodeId,e.startPoint,e.endPoint,x,e.startRowId):e.startPoint;return v?nt(e.endNodeId,e.endPoint,N,x,e.endRowId):e.endPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,a,c,n,o,r]),h=p.useMemo(()=>{const x=oo(),y=x.find(b=>b.id===e.startNodeId),v=x.find(b=>b.id===e.endNodeId);if(a==="TreeLStep"&&y)return Ol(e.startNodeId,e.startPoint,x);if((a==="TreeCubic"||a==="TreeZShape")&&y&&v){const b=qe(v);return Ro(e.startNodeId,e.startPoint,b,x,0)}if((a==="Cubic"||a==="Step"||a==="Orthogonal")&&y&&v){const b=qe(v);return $s(e.startNodeId,e.startPoint,b,x,0,c)}const N=v?nt(e.endNodeId,e.endPoint,e.startPoint,x,e.endRowId):e.endPoint;return y?nt(e.startNodeId,e.startPoint,N,x,e.startRowId):e.startPoint},[e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId,a,c,n,o,r]),g=p.useMemo(()=>{const x=(h.x+u.x)/2,y=(h.y+u.y)/2;if(e.controlPointOffset)return{x:x+e.controlPointOffset.x,y:y+e.controlPointOffset.y};{const v=Yv(h,u,i),N=u.x-h.x,b=u.y-h.y,j=N>0?x-v.x:x+v.x,R=b<0?y-v.y:y+v.y;return{x:j,y:R}}},[e.controlPointOffset,h,u,s,i]),f=p.useMemo(()=>{if(a!=="Cubic"&&a!=="TreeCubic")return null;const x=oo(),y=x.find(j=>j.id===e.startNodeId),v=x.find(j=>j.id===e.endNodeId);let N="horizontal",b;if(y&&v){const j=qe(y),R=qe(v),S=R.x-j.x,C=R.y-j.y;a==="TreeCubic"?N="horizontal":N=Math.abs(S)*c>=Math.abs(C)?"horizontal":"vertical",b={dx:S,dy:C}}return nf(h,u,N,b)},[h,u,a,e.startNodeId,e.endNodeId,c,n,o,r]),{path:w}=p.useMemo(()=>Gv(h,u),[h,u,s]),m=p.useMemo(()=>{if(!(a==="Step"||a==="Orthogonal"||a==="TreeLStep"||a==="TreeZShape"))return null;if(a==="TreeLStep")return[h,{x:h.x,y:u.y},u];if(a==="TreeZShape"){const j=(h.x+u.x)/2;return[h,{x:j,y:h.y},{x:j,y:u.y},u]}const y=oo(),v=y.find(j=>j.id===e.startNodeId),N=y.find(j=>j.id===e.endNodeId);let b=!0;if(v&&N){const j=qe(v),R=qe(N),S=R.x-j.x,C=R.y-j.y;b=Math.abs(S)*c>=Math.abs(C)}if(a==="Step")return b?[h,{x:u.x,y:h.y},u]:[h,{x:h.x,y:u.y},u];{const j=(h.x+u.x)/2,R=(h.y+u.y)/2;return b?[h,{x:j,y:h.y},{x:j,y:u.y},u]:[h,{x:h.x,y:R},{x:u.x,y:R},u]}},[h,u,a,e.startNodeId,e.endNodeId,c,n,o,r]);return{actualStartPoint:h,actualEndPoint:u,bezierPath:w,controlPoint:g,cubicControlPoints:f,stepPoints:m,arrowType:a}},Xv=(e,s,n,o,r)=>{const a=E.getState();a.scrollToArrow;const i=a.uiState.mode,c=a.projectCanvas.getActive(),l=(c==null?void 0:c.viewState.scale)??1,d=(c==null?void 0:c.coreState.nodes)??[],u=a.arrow.setAll,h=a.arrow.setSelected,g=a.setSelectedNodes,[f,w]=p.useState(null),[m,x]=p.useState(null),[y,v]=p.useState(null),N=p.useRef(null),b=p.useCallback((j,R)=>{i!==J.SELECT||j.button!==0&&j.button!==-1||(j.stopPropagation(),w(R),x({x:j.clientX,y:j.clientY}),v({...e,startPoint:s,endPoint:n,controlPointOffset:o}),N.current=R==="start"?s:R==="end"?n:o,r||(g([]),h([e])))},[i,e,s,n,o,r,h,g]);return p.useEffect(()=>{const j=S=>{var k;if(!f||!m||!y)return;const C=S.clientX-m.x,M=S.clientY-m.y,I=C/l,A=M/l,O=f==="start"?y.startPoint:f==="end"?y.endPoint:y.controlPointOffset;let F={x:O.x+I,y:O.y+A};const B=Mo(S.clientX,S.clientY);let W=null,P=null;if(B){W=B.nodeId,P=B.rowId;const T=f==="start"?y.endPoint:f==="end"?y.startPoint:y.controlPointOffset;F=nt(W,F,T,d,P)}else{const T=wo(F,d);if(T&&!(((k=T.data)==null?void 0:k.nodeType)==="workflowOrchestration")){W=T.id;const H=f==="start"?y.endPoint:f==="end"?y.startPoint:y.controlPointOffset;F=nt(W,F,H,d)}}N.current=F,u(T=>T.map(L=>{if(L.id===y.id){const H={...L};if(f==="start")H.startPoint=F,H.startNodeId=W,H.startRowId=P;else if(f==="end")H.endPoint=F,H.endNodeId=W,H.endRowId=P;else if(f==="control"){const $=L.startNodeId?nt(L.startNodeId,L.startPoint,L.endPoint,d,L.startRowId):L.startPoint,_=L.endNodeId?nt(L.endNodeId,L.endPoint,L.startPoint,d,L.endRowId):L.endPoint,G=($.x+_.x)/2,V=($.y+_.y)/2,D={x:F.x-G,y:F.y-V};H.controlPointOffset=D}return H}return L}))},R=S=>{var M;if(!f||!y)return;const C=N.current;if(C){const I=Mo(S.clientX,S.clientY);let A=null,O=null;const F=f==="start"?y.endPoint:f==="end"?y.startPoint:y.controlPointOffset;let B;if(I)A=I.nodeId,O=I.rowId,B=nt(A,C,F,d,O);else{const W=wo(C,d);W?((M=W.data)==null?void 0:M.nodeType)==="workflowOrchestration"?B=C:(A=W.id,B=nt(A,C,F,d)):B=C}u(W=>W.map(P=>{if(P.id===y.id){const k={...P};return f==="start"?(k.startPoint=B,k.startNodeId=A,k.startRowId=O):f==="end"&&(k.endPoint=B,k.endNodeId=A,k.endRowId=O),k}return P}))}w(null),x(null),v(null),N.current=null};return f&&(window.addEventListener("pointermove",j),window.addEventListener("pointerup",R)),()=>{window.removeEventListener("pointermove",j),window.removeEventListener("pointerup",R)}},[f,m,y,l,u,d]),{handleMouseDownOnHandle:b}},qv=(e,s,n)=>`M ${e.x} ${e.y} Q ${s.x} ${s.y} ${n.x} ${n.y}`,Zv=(e,s,n,o)=>`M ${e.x} ${e.y} C ${s.x} ${s.y} ${n.x} ${n.y} ${o.x} ${o.y}`,Jv=e=>{if(e.length<2)return"";const[s,...n]=e;return`M ${s.x} ${s.y} `+n.map(o=>`L ${o.x} ${o.y}`).join(" ")},er=({startPoint:e,endPoint:s,controlPoint:n,cubicControlPoints:o,stepPoints:r,useCurvedArrows:a,stroke:i,strokeWidth:c,markerEndId:l,strokeDasharray:d,isHitbox:u=!1,onPointerDown:h})=>{const g={stroke:i,strokeWidth:c,fill:"none",strokeDasharray:d,markerEnd:!u&&l?`url(#${l})`:void 0,onPointerDown:h,style:{pointerEvents:"auto"}};if(r&&r.length>=2){const f=Jv(r);return t.jsx("path",{d:f,...g})}if(a&&o&&o.length===2){const[f,w]=o,m=Zv(e,f,w,s);return t.jsx("path",{d:m,...g})}if(a&&n){const f=qv(e,n,s);return t.jsx("path",{d:f,...g})}return t.jsx("line",{x1:e.x,y1:e.y,x2:s.x,y2:s.y,...g})},Qv=({isSelected:e,label:s,labelPosition:n,labelInput:o,setLabelInput:r,onLabelChange:a,onLabelBlur:i,onLabelKeyDown:c})=>{const l=be.FONT_SIZE_XXS,d=6,u=4,h=l*.6,f=s.length*h+2*d,w=l+2*u;return e?t.jsx("foreignObject",{x:n.x-50,y:n.y-15,width:"100",height:"30",style:{pointerEvents:"auto"},children:t.jsx(Re,{"data-test":"arrow-label-input",type:"text",value:o,onChange:a,onBlur:i,onKeyDown:c,onMouseDown:m=>m.stopPropagation(),placeholder:"Label",className:"w-full h-full text-[12px]! text-center p-0.5 bg-background border border-border rounded-sm focus:ring-1 focus:ring-ring focus:outline-none"})}):s?t.jsxs(t.Fragment,{children:[t.jsx("rect",{x:n.x-f/2,y:n.y-w/2,width:f,height:w,fill:"hsl(var(--background))",rx:"3",ry:"3",style:{pointerEvents:"none"}}),t.jsx("text",{x:n.x,y:n.y,fill:"hsl(var(--foreground))",fontSize:l,textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:s})]}):null},eb=({markerId:e,strokeColor:s,markerOrientation:n})=>t.jsx("defs",{children:t.jsx("marker",{id:e,markerWidth:"10",markerHeight:"7",refX:"0",refY:"3.5",orient:n,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:s})})}),tb=({arrow:e})=>{const s=z($=>{var _,G;return((G=(_=$.projectCanvas.getActive())==null?void 0:_.coreState.selectedArrows)==null?void 0:G.some(V=>V.id===e.id))??!1}),n=z($=>$.uiState.mode),{setSelectedNodes:o}=E.getState(),{setSelected:r,update:a}=E.getState().arrow;z($=>{var _,G;return(G=(_=$.preferences)==null?void 0:_.canvasConfig)==null?void 0:G.arrows});const i=z($=>{var G,V;const _=(V=(G=$.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:V.find(D=>D.id===e.startNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),c=z($=>{var G,V;const _=(V=(G=$.projectCanvas.getActive())==null?void 0:G.coreState.nodes)==null?void 0:V.find(D=>D.id===e.endNodeId);return _?`${_.x},${_.y},${_.width},${_.height}`:null}),l=z($=>$.uiState.dragVersion??0),{actualStartPoint:d,actualEndPoint:u,controlPoint:h,cubicControlPoints:g,stepPoints:f,arrowType:w}=Kv(e,!0,i,c,l),m=w!=="Straight",{handleMouseDownOnHandle:x}=Xv(e,d,u,h,s),y=$=>{var V;if(n!==J.SELECT||$.button!==0&&$.button!==-1)return;$.stopPropagation();const _=((V=E.getState().projectCanvas.getActive())==null?void 0:V.coreState.selectedArrows)??[];if($.ctrlKey||$.metaKey){r(s?_.filter(D=>D.id!==e.id):[..._,e]);return}if($.shiftKey){s||r([..._,e]);return}o([]),r([e])},v=$=>{$.stopPropagation(),a(e.id,{controlPointOffset:null})},[N,b]=p.useState(e.label||""),j=p.useRef(null);p.useEffect(()=>{s&&j.current===null?j.current=e.label||"":s||(j.current=null)},[s,e.label]),p.useEffect(()=>{b(e.label||"")},[e.label]);const R=$=>{b($.target.value),a(e.id,{label:$.target.value})},S=()=>{e.label!==N&&a(e.id,{label:N});const $=j.current;$!==null&&$!==N&&E.getState().undo.commit({type:"arrow:update",arrowId:e.id,from:{label:$},to:{label:N}})},C=$=>{$.key==="Enter"&&$.currentTarget.blur(),$.stopPropagation()},M=0,I=p.useMemo(()=>{if(m&&h){const $=(d.x+u.x)/2,_=(d.y+u.y)/2;return{x:$-(h.x-$),y:_-(h.y-_)+M}}return{x:(d.x+u.x)/2,y:(d.y+u.y)/2+M}},[d,u,h,m]),A=e.strokeColor??Z.arrows.styles.line,O=s&&!e.strokeColor?Z.arrows.styles.lineSelected:A,F=e.strokeWidth??1,B=s?F+.5:F,P=($=>{switch($){case"dashed":return"8,4";case"dotted":return"2,4";default:return}})(e.strokeStyle),k=s&&n===J.SELECT,T=m?"auto-start-reverse":"auto",L=`arrowhead-${e.id}`,H=e.strokeColor??O;return t.jsxs("g",{"data-arrow-id":e.id,style:{cursor:n===J.SELECT?"pointer":"default"},children:[t.jsx(eb,{markerId:L,strokeColor:H,markerOrientation:T}),t.jsx(er,{startPoint:d,endPoint:u,controlPoint:h,cubicControlPoints:g,stepPoints:f,useCurvedArrows:m,stroke:O,strokeWidth:B,strokeDasharray:P,markerEndId:L}),t.jsx(er,{startPoint:d,endPoint:u,controlPoint:h,cubicControlPoints:g,stepPoints:f,useCurvedArrows:m,stroke:"transparent",strokeWidth:15,isHitbox:!0,onPointerDown:y}),k&&t.jsxs(t.Fragment,{children:[t.jsx(Da,{position:d,onMouseDown:$=>x($,"start")}),t.jsx(Da,{position:u,onMouseDown:$=>x($,"end")}),m&&h&&t.jsx(Da,{position:h,onMouseDown:$=>x($,"control"),onDoubleClick:v,variant:"control"})]}),t.jsx(Qv,{isSelected:s,label:e.label||"",labelPosition:I,labelInput:N,setLabelInput:b,onLabelChange:R,onLabelBlur:S,onLabelKeyDown:C})]})};function sb(e,s){const n=e.arrow,o=s.arrow,r=n.startPoint.x===o.startPoint.x&&n.startPoint.y===o.startPoint.y,a=n.endPoint.x===o.endPoint.x&&n.endPoint.y===o.endPoint.y,i=n.label===o.label,c=n.type===o.type,l=n.controlPointOffset==null&&o.controlPointOffset==null||n.controlPointOffset!=null&&o.controlPointOffset!=null&&n.controlPointOffset.x===o.controlPointOffset.x&&n.controlPointOffset.y===o.controlPointOffset.y,d=n.strokeColor===o.strokeColor,u=n.strokeWidth===o.strokeWidth,h=n.strokeStyle===o.strokeStyle;return r&&a&&i&&c&&l&&d&&u&&h}const jd=Ie.memo(tb,sb),nb=[{value:"solid",label:"Solid",dashArray:"none"},{value:"dashed",label:"Dashed",dashArray:"8,4"},{value:"dotted",label:"Dotted",dashArray:"2,4"}],ob=({currentColor:e,currentWidth:s,currentStyle:n,onColorSelect:o,onWidthChange:r,onStyleChange:a})=>{const[i,c]=p.useState(e),[l,d]=p.useState(s),[u,h]=p.useState(n);p.useEffect(()=>{c(e)},[e]),p.useEffect(()=>{d(s)},[s]),p.useEffect(()=>{h(n)},[n]);const g=m=>{c(m),o(m)},f=m=>{const x=parseFloat(m.target.value);!isNaN(x)&&x>=.5&&x<=10&&(d(x),r(x))},w=m=>{h(m),a(m)};return t.jsxs("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"arrow-style-picker-content",children:[t.jsxs("div",{"data-test":"arrow-style-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:ta.filter(m=>m.value!=="transparent").map(m=>t.jsx("button",{type:"button",title:m.name,onClick:()=>g(m.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",m.twClass,m.value===i?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",m.value==="#ffffff"&&"border-neutral-300"),style:m.value.startsWith("hsl(")?{backgroundColor:m.value}:{},"aria-label":`Select color ${m.name}`,"data-test":"arrow-color-option"},m.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?sa(i):i.startsWith("#")?i:"#000000",onChange:m=>g(m.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"arrow-color-custom-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-width-section",children:[t.jsxs("label",{htmlFor:"arrow-stroke-width-input",className:"block text-xs text-muted-foreground font-medium mb-1",children:["Stroke Width: ",l,"px"]}),t.jsx("input",{type:"range",id:"arrow-stroke-width-input",value:l,onChange:f,min:"0.5",max:"10",step:"0.5",className:"w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer","data-test":"arrow-stroke-width-input"})]}),t.jsxs("div",{className:"pt-2 border-t border-border","data-test":"arrow-style-style-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Style"}),t.jsx("div",{className:"flex gap-2",children:nb.map(m=>t.jsx("button",{type:"button",onClick:()=>w(m.value),className:ve("flex-1 px-2 py-1.5 rounded border text-xs",u===m.value?"border-primary bg-primary/10":"border-muted hover:border-muted-foreground"),title:m.label,"data-test":"arrow-style-option",children:t.jsx("svg",{width:"100%",height:"12",viewBox:"0 0 40 12",className:"stroke-current",children:t.jsx("line",{x1:"2",y1:"6",x2:"38",y2:"6",strokeWidth:"2",strokeDasharray:m.dashArray,fill:"none"})})},m.value))})]})]})},ab=[],rb=({className:e})=>{const[s,n]=p.useState(!1),o=z(j=>{var R;return((R=j.projectCanvas.getActive())==null?void 0:R.coreState.selectedArrows)??ab}),r=z(j=>j.arrow.update),a=o.length>0?o[0]:null,[i,c]=p.useState((a==null?void 0:a.strokeColor)??"hsl(var(--muted-light))"),[l,d]=p.useState((a==null?void 0:a.strokeWidth)??1),[u,h]=p.useState((a==null?void 0:a.strokeStyle)??"solid"),g=E.getState().getLastUsedArrowStyle();p.useEffect(()=>{a?(c(a.strokeColor??"hsl(var(--muted-light))"),d(a.strokeWidth??1),h(a.strokeStyle??"solid")):(c("hsl(var(--muted-light))"),d(1),h("solid"))},[a]);const f=(j,R,S)=>{o.forEach(C=>{r(C.id,{strokeColor:j,strokeWidth:R,strokeStyle:S})})},w=()=>{f(g.lastUsedColor,g.lastUsedWidth,g.lastUsedStyle)},m=j=>{f(j,l,u),c(j),E.getState().setLastUsedArrowStyle(j,l,u),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},x=j=>{f(i,j,u),d(j),E.getState().setLastUsedArrowStyle(i,j,u),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},y=j=>{f(i,l,j),h(j),E.getState().setLastUsedArrowStyle(i,l,j),E.getState().setSegmentedButtonAction("arrow-style-picker","Apply last used style")},v=()=>{c("hsl(var(--muted-light))"),d(1),h("solid"),f(void 0,void 0,void 0)},N=[{label:"Apply last used style",icon:t.jsx("span",{style:{color:g.lastUsedColor,display:"inline-flex"},children:t.jsx(Xr,{className:"h-2.5 w-2.5"})}),onClick:w,disabled:o.length===0},{label:"Set Arrow Style",icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(pl,{className:"h-2.5 w-2.5"})}),onClick:()=>{n(!0)},disabled:o.length===0},{label:"Reset Style",icon:t.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:v,disabled:o.length===0}],b={...N[0],icon:t.jsx("span",{style:{color:i,display:"inline-flex"},children:t.jsx(Xr,{className:"h-2.5 w-2.5"})})};return t.jsxs(ht,{open:s,onOpenChange:n,children:[t.jsx(pt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"arrow-style-picker-button",children:t.jsx(Je,{mainAction:b,dropdownActions:N,variant:"outline",size:"compact",persistenceKey:"arrow-style-picker",className:e})})}),t.jsx(gt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:j=>j.preventDefault(),"data-test":"arrow-style-picker-popover",children:t.jsx(ob,{currentColor:i,currentWidth:l,currentStyle:u,onColorSelect:m,onWidthChange:x,onStyleChange:y})})]})},ic=[],ib=[],cb=()=>{const e=z(d=>d.setSelectedNodes),s=z(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedNodes)??ic}),n=z(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.selectedArrows)??ib});z(d=>{var u;return((u=d.projectCanvas.getActive())==null?void 0:u.coreState.nodes)??ic});const o=s.length>0,r=p.useMemo(()=>{const d=new Set;return n.forEach(u=>{u.startNodeId&&d.add(u.startNodeId),u.endNodeId&&d.add(u.endNodeId)}),d},[n]),a=p.useCallback(()=>{const u=E.getState().projectCanvas.getActive();if(!u)return;const h=u.coreState.selectedArrows??[],g=u.coreState.nodes??[],f=new Set;h.forEach(m=>{m.startNodeId&&f.add(m.startNodeId),m.endNodeId&&f.add(m.endNodeId)});const w=g.filter(m=>f.has(m.id));e(w)},[e]),i=p.useCallback(()=>{e([])},[e]),c=[{label:"Select connected nodes",icon:t.jsx(qr,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0},{label:"Deselect all nodes",icon:t.jsx(Be,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!o}],l=o?{label:"Deselect all nodes",icon:t.jsx(Be,{className:"h-2.5 w-2.5"}),onClick:i,disabled:!1}:{label:"Select connected nodes",icon:t.jsx(qr,{className:"h-2.5 w-2.5"}),onClick:a,disabled:r.size===0};return t.jsx(Je,{mainAction:l,dropdownActions:c,variant:"outline",size:"compact",persistenceKey:"arrow-connected-nodes","data-test":"arrow-connected-nodes-button"})},lb=({arrows:e})=>{const s=p.useCallback(()=>{E.getState().deleteSelectedArrows()},[]);return t.jsxs("div",{className:je("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:Te.nodeQuickPanel},"data-test":"arrow-quick-panel-container","data-arrow-ids":e.map(n=>n.id).join(","),children:[t.jsx(rb,{}),t.jsx(dd,{}),t.jsx(cb,{}),t.jsx(Q,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:s,title:"Delete selected arrows","data-test":"arrow-delete-button",children:t.jsx(yt,{className:"h-3.5 w-3.5"})})]})},ao=30,db=[],ub=()=>{var d;const[e,s]=p.useState({top:0,left:0}),n=p.useRef(null),o=z(u=>{var h,g;return(((g=(h=u.projectCanvas.getActive())==null?void 0:h.coreState.selectedArrows)==null?void 0:g.length)??0)>0}),r=z(u=>u.uiState.mode),a=z(u=>{var h;return(h=u.projectCanvas.getActive())==null?void 0:h.viewState}),i=o,c=r===J.DRAW_ARROW;if(p.useEffect(()=>{if(!i||!a)return;const u=()=>{var F,B,W,P;const g=((F=E.getState().projectCanvas.getActive())==null?void 0:F.coreState.selectedArrows)??[],f=((B=E.getState().projectCanvas.getActive())==null?void 0:B.coreState.nodes)??[];if(g.length===0)return;let w=0,m=0,x=0,y=0,v=0;if(g.forEach(k=>{const T=document.querySelector(`[data-arrow-id="${k.id}"]`);if(!T)return;const L=T.getBoundingClientRect(),H=L.left+L.width/2,$=L.top+L.height/2,{actualStartPoint:_,actualEndPoint:G}=Ll(k,f),V=G.x-_.x,D=G.y-_.y;w+=H,m+=$,x+=V,y+=D,v++}),v===0)return;const N=w/v,b=m/v,j=Math.abs(y)>Math.abs(x),R=((W=n.current)==null?void 0:W.offsetHeight)||40,S=((P=n.current)==null?void 0:P.offsetWidth)||100,C=window.innerWidth,M=window.innerHeight,I=20;let A,O;if(j){const k=N-S-ao,T=N+ao,L=k>=I,H=T+S<=C-I;O=L?k:H?T:I,A=b-R/2}else{const k=b-R-ao,T=b+ao,L=k>=I,H=T+R<=M-I;A=L?k:H?T:I,O=N-S/2}A=Math.max(I,Math.min(A,M-R-I)),O=Math.max(I,Math.min(O,C-S-I)),s({top:A,left:O})};u();const h=setTimeout(u,100);return window.addEventListener("scroll",u,!0),window.addEventListener("resize",u),()=>{clearTimeout(h),window.removeEventListener("scroll",u,!0),window.removeEventListener("resize",u)}},[i,a]),!i||c)return null;const l=((d=E.getState().projectCanvas.getActive())==null?void 0:d.coreState.selectedArrows)??db;return sn.createPortal(t.jsx("div",{ref:n,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:Te.quickPanelPortal},onPointerDown:u=>u.stopPropagation(),onTouchStart:u=>u.stopPropagation(),onWheel:u=>u.stopPropagation(),"data-test":"arrow-quick-panel-portal",children:t.jsx(lb,{arrows:l})}),document.body)},hb=({currentColor:e,onColorSelect:s})=>{const[n,o]=p.useState(e);p.useEffect(()=>{o(e)},[e]);const r=a=>{o(a),s(a)};return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"group-background-picker-content",children:t.jsxs("div",{"data-test":"group-background-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:"Background Color"}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:ta.map(a=>t.jsx("button",{type:"button",title:a.name,onClick:()=>r(a.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",a.twClass,a.value===n?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",a.value==="#ffffff"&&"border-neutral-300",a.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:a.value.startsWith("hsl(")?{backgroundColor:a.value}:{},"aria-label":`Select color ${a.name}`,"data-test":"group-background-color-option"},a.value))}),t.jsx("input",{type:"color",value:n.startsWith("hsl")?sa(n):n.startsWith("#")?n:"#000000",onChange:a=>r(a.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"group-background-color-custom-input"})]})})},mn="hsl(var(--background))",cc=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),pb=({groups:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e,i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.styles)==null?void 0:v.backgroundColor)??mn),[u,h]=p.useState(mn);p.useEffect(()=>{var N;d(c?((N=c.styles)==null?void 0:N.backgroundColor)??mn:mn)},[c]);const g=N=>{a.forEach(b=>{const j=b.data,R={...j,childNodeIds:(j==null?void 0:j.childNodeIds)??[],styles:{...j==null?void 0:j.styles,backgroundColor:N}};r(b.id,{data:R})})},f=()=>{g(u)},w=N=>{g(N),d(N),h(N),E.getState().setSegmentedButtonAction("group-background-picker","Apply last used style")},m=()=>{d(mn),g(void 0)},x=[{label:"Apply last used style",icon:t.jsx(cc,{color:u}),onClick:f,disabled:a.length===0},{label:"Set Background Color",icon:t.jsx(cc,{color:l}),onClick:()=>{o(!0)},disabled:a.length===0},{label:"Reset Style",icon:t.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:m,disabled:a.length===0}],y={...x[0]};return t.jsxs(ht,{open:n,onOpenChange:o,children:[t.jsx(pt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"group-background-picker-button",children:t.jsx(Je,{mainAction:y,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"group-background-picker",className:s})})}),t.jsx(gt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"group-background-picker-popover",children:t.jsx(hb,{currentColor:l,onColorSelect:w})})]})},gb=({groups:e})=>t.jsx("div",{className:je("relative","bg-primary-foreground shadow rounded flex items-center gap-0.5 p-0.5 pointer-events-auto"),style:{zIndex:Te.nodeQuickPanel},"data-test":"group-quick-panel-container","data-group-ids":e.map(s=>s.id).join(","),children:t.jsx(pb,{groups:e})}),lc=10,fb=100,mb=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(J.SELECT),l=p.useRef(null),d=p.useRef(""),u=p.useRef(!1),h=p.useRef(J.SELECT);p.useEffect(()=>{const m=()=>{var S;const y=E.getState(),v=(S=y.projectCanvas.getActive())==null?void 0:S.coreState.selectedNodes,N=!!y.uiState.dragInfo,b=y.uiState.mode;if(N!==u.current&&(u.current=N,a(N)),b!==h.current&&(h.current=b??J.SELECT,c(b??J.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let j="";const R=[];for(const C of v)C.type===le.GROUP&&(j+=(j?",":"")+C.id,R.push(C));j!==d.current&&(d.current=j,o(R))};m();const x=setInterval(m,fb);return()=>clearInterval(x)},[]);const g=n.length>=1&&!r,f=i===J.DRAW_ARROW,w=Ie.useMemo(()=>n.map(m=>m.id),[n]);return p.useEffect(()=>{if(!g||w.length===0)return;const m=()=>{var F,B;let y=0,v=0,N=0;if(w.forEach(W=>{const P=document.querySelector(`[data-node-id="${W}"]`);if(!P)return;const k=P.getBoundingClientRect(),T=k.left+k.width/2,L=k.top;y+=T,v+=L,N++}),N===0)return;const b=y/N,j=v/N,R=((F=l.current)==null?void 0:F.offsetHeight)||40,S=((B=l.current)==null?void 0:B.offsetWidth)||100,C=window.innerWidth,M=window.innerHeight,I=20;let A=j-R-lc,O=b-S/2;if(A<I){let W=0;w.forEach(P=>{const k=document.querySelector(`[data-node-id="${P}"]`);if(k){const T=k.getBoundingClientRect();W=Math.max(W,T.bottom)}}),A=W+lc}A=Math.max(I,Math.min(A,M-R-I)),O=Math.max(I,Math.min(O,C-S-I)),s({top:A,left:O})};m();const x=setTimeout(m,100);return()=>{clearTimeout(x)}},[g,w]),!g||w.length===0||f?null:sn.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:Te.popover},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),"data-test":"group-quick-panel-portal",children:t.jsx(gb,{groups:n})}),document.body)},xb=Ie.memo(mb),Ar=({label:e,currentColor:s,onColorSelect:n})=>{const[o,r]=p.useState(s);p.useEffect(()=>{r(s)},[s]);const a=c=>{r(c),n(c)},i=s==="currentColor"?"hsl(var(--foreground))":s;return t.jsx("div",{className:"p-3 space-y-3 bg-popover rounded-md","data-test":"draw-color-picker-content",children:t.jsxs("div",{"data-test":"draw-color-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium mb-2",children:e}),t.jsx("div",{className:"grid grid-cols-5 gap-2",children:ta.map(c=>t.jsx("button",{type:"button",title:c.name,onClick:()=>a(c.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1",c.twClass,c.value===o?"ring-2 ring-ring ring-offset-1":"border-muted ring-0",c.value==="#ffffff"&&"border-neutral-300",c.value==="transparent"&&"bg-[repeating-linear-gradient(45deg,#ccc,#ccc_2px,#fff_2px,#fff_4px)]"),style:c.value.startsWith("hsl(")?{backgroundColor:c.value}:{},"aria-label":`Select color ${c.name}`,"data-test":"draw-color-option"},c.value))}),t.jsx("input",{type:"color",value:i.startsWith("hsl")?sa(i):i.startsWith("#")?i:"#000000",onChange:c=>a(c.target.value),className:"mt-2 w-full h-7 bg-secondary rounded cursor-pointer","data-test":"draw-color-custom-input"})]})})},Ls="currentColor";let dc=Ls;const uc=({color:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-color-swatch-icon",children:t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"2px",backgroundColor:e==="currentColor"?"hsl(var(--foreground))":e,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}})}),wb=({drawings:e,className:s})=>{var y;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((y=i==null?void 0:i.style)==null?void 0:y.strokeColor)??Ls),[d,u]=p.useState(dc);p.useEffect(()=>{var v;l(i?((v=i.style)==null?void 0:v.strokeColor)??Ls:Ls)},[i]);const h=v=>{e.forEach(N=>{const b=N.data;if(!b)return;if(b.elements&&b.elements.length>0){const R=b.elements.map(S=>({...S,style:{...S.style,strokeColor:v}}));r(N.id,{data:{...b,elements:R}});return}const j={...b,drawType:(b==null?void 0:b.drawType)??"freehand",style:{...Tt,...b==null?void 0:b.style,strokeColor:v}};r(N.id,{data:j})})},g=()=>{h(d)},f=v=>{h(v),l(v),u(v),dc=v,E.getState().setSegmentedButtonAction("draw-stroke-color","Apply last used color")},w=()=>{l(Ls),h(Ls)},m=[{label:"Apply last used color",icon:t.jsx(uc,{color:d}),onClick:g,disabled:e.length===0},{label:"Set Stroke Color",icon:t.jsx(uc,{color:c}),onClick:()=>o(!0),disabled:e.length===0},{label:"Reset Color",icon:t.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:w,disabled:e.length===0}],x={...m[0]};return t.jsxs(ht,{open:n,onOpenChange:o,children:[t.jsx(pt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-color-button",children:t.jsx(Je,{mainAction:x,dropdownActions:m,variant:"outline",size:"compact",persistenceKey:"draw-stroke-color",className:s})})}),t.jsx(gt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:v=>v.preventDefault(),"data-test":"draw-stroke-color-popover",children:t.jsx(Ar,{label:"Stroke Color",currentColor:c,onColorSelect:f})})]})},yb=[1,2,3,4,5,6,8,10];let hc=Tt.strokeWidth;const vb=({width:e,className:s})=>t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-width-icon",children:t.jsx("span",{style:{width:"12px",height:`${Math.min(e,6)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})}),bb=({drawings:e,className:s})=>{var x;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.length>0?e[0]:null,i=a==null?void 0:a.data,[c,l]=p.useState(((x=i==null?void 0:i.style)==null?void 0:x.strokeWidth)??Tt.strokeWidth),[d,u]=p.useState(hc);p.useEffect(()=>{var y;l(i?((y=i.style)==null?void 0:y.strokeWidth)??Tt.strokeWidth:Tt.strokeWidth)},[i]);const h=y=>{e.forEach(v=>{const N=v.data;if(!N)return;if(N.elements&&N.elements.length>0){const j=N.elements.map(R=>({...R,style:{...R.style,strokeWidth:y}}));r(v.id,{data:{...N,elements:j}});return}const b={...N,drawType:(N==null?void 0:N.drawType)??"freehand",style:{...Tt,...N==null?void 0:N.style,strokeWidth:y}};r(v.id,{data:b})})},g=()=>{h(d)},f=y=>{h(y),l(y),u(y),hc=y,o(!1),E.getState().setSegmentedButtonAction("draw-stroke-width","Apply last used width")},w=[{label:"Apply last used width",icon:t.jsx(vb,{width:d}),onClick:g,disabled:e.length===0},{label:"Set Stroke Width",icon:t.jsx(Xo,{className:"h-2.5 w-2.5"}),onClick:()=>o(!0),disabled:e.length===0}],m={...w[0]};return t.jsxs(ht,{open:n,onOpenChange:o,children:[t.jsx(pt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-width-button",children:t.jsx(Je,{mainAction:m,dropdownActions:w,variant:"outline",size:"compact",persistenceKey:"draw-stroke-width",className:s})})}),t.jsx(gt,{className:"w-auto p-3",sideOffset:5,onCloseAutoFocus:y=>y.preventDefault(),"data-test":"draw-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1",children:yb.map(y=>t.jsx("button",{type:"button",title:`${y}px`,onClick:()=>f(y),className:`w-8 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${c===y?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-stroke-width-option",children:t.jsx("span",{style:{width:"16px",height:`${Math.min(y,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}})},y))}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Current: ",c,"px"]})]})})]})},Nb=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}];let pc=Tt.strokeStyle;const gc=({style:e,className:s})=>{const n=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"stroke-style-icon",children:t.jsx("svg",{width:"14",height:"6",viewBox:"0 0 14 6",children:t.jsx("line",{x1:"0",y1:"3",x2:"14",y2:"3",stroke:"currentColor",strokeWidth:"2",strokeDasharray:n,strokeLinecap:"round"})})})},Sb=({drawings:e,className:s})=>{var f;const n=E.getState().updateNode,o=e.length>0?e[0]:null,r=o==null?void 0:o.data,[a,i]=p.useState(((f=r==null?void 0:r.style)==null?void 0:f.strokeStyle)??Tt.strokeStyle),[c,l]=p.useState(pc);p.useEffect(()=>{var w;i(r?((w=r.style)==null?void 0:w.strokeStyle)??Tt.strokeStyle:Tt.strokeStyle)},[r]);const d=w=>{e.forEach(m=>{const x=m.data;if(!x)return;if(x.elements&&x.elements.length>0){const v=x.elements.map(N=>({...N,style:{...N.style,strokeStyle:w}}));n(m.id,{data:{...x,elements:v}});return}const y={...x,drawType:(x==null?void 0:x.drawType)??"freehand",style:{...Tt,...x==null?void 0:x.style,strokeStyle:w}};n(m.id,{data:y})}),i(w),l(w),pc=w},u=()=>{d(c)},h=[{label:"Apply last used style",icon:t.jsx(gc,{style:c}),onClick:u,disabled:e.length===0},...Nb.map(w=>({label:w.label,icon:t.jsx(gc,{style:w.value}),onClick:()=>{d(w.value),E.getState().setSegmentedButtonAction("draw-stroke-style",w.label)},disabled:e.length===0,selected:a===w.value}))],g={...h[0]};return t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-stroke-style-button",children:t.jsx(Je,{mainAction:g,dropdownActions:h,variant:"outline",size:"compact",persistenceKey:"draw-stroke-style",className:s})})},Ws="transparent";let fc=Ws;const mc=({color:e,className:s})=>{const n=e&&e!=="transparent"?e:void 0;return t.jsx("span",{className:s,style:{display:"inline-flex",alignItems:"center",justifyContent:"center"},"data-test":"fill-color-swatch-icon",children:n?t.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",backgroundColor:n,border:"1px solid hsl(var(--border))",boxShadow:"0 0 0 1px hsl(var(--background))"}}):t.jsx(qo,{className:"h-2.5 w-2.5"})})},Cb=({drawings:e,className:s})=>{var v;const[n,o]=p.useState(!1),r=E.getState().updateNode,a=e.filter(N=>{const b=N.data;return b?b.elements&&b.elements.length>0?b.elements.some(j=>j.type==="shape"):b.drawType==="shape":!1}),i=a.length>0?a[0]:null,c=i==null?void 0:i.data,[l,d]=p.useState(((v=c==null?void 0:c.style)==null?void 0:v.fillColor)??Ws),[u,h]=p.useState(fc);p.useEffect(()=>{var N;d(c?((N=c.style)==null?void 0:N.fillColor)??Ws:Ws)},[c]);const g=N=>{const b=N===Ws?void 0:N;a.forEach(j=>{const R=j.data;if(!R)return;if(R.elements&&R.elements.length>0){const C=R.elements.map(M=>M.type==="shape"?{...M,style:{...M.style,fillColor:b}}:M);r(j.id,{data:{...R,elements:C}});return}const S={...R,drawType:(R==null?void 0:R.drawType)??"shape",style:{...Tt,...R==null?void 0:R.style,fillColor:b}};r(j.id,{data:S})})},f=()=>{g(u)},w=N=>{g(N),d(N),h(N),fc=N,E.getState().setSegmentedButtonAction("draw-fill-color","Apply last used fill")},m=()=>{d(Ws),g(void 0)},x=[{label:"Apply last used fill",icon:t.jsx(mc,{color:u}),onClick:f,disabled:a.length===0},{label:"Set Fill Color",icon:t.jsx(mc,{color:l}),onClick:()=>o(!0),disabled:a.length===0},{label:"Remove Fill",icon:t.jsx(Gn,{className:"h-2.5 w-2.5"}),onClick:m,disabled:a.length===0}],y={...x[0]};return a.length===0?null:t.jsxs(ht,{open:n,onOpenChange:o,children:[t.jsx(pt,{asChild:!0,children:t.jsx("div",{style:{display:"inline-flex"},"data-test":"draw-fill-color-button",children:t.jsx(Je,{mainAction:y,dropdownActions:x,variant:"outline",size:"compact",persistenceKey:"draw-fill-color",className:s})})}),t.jsx(gt,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:N=>N.preventDefault(),"data-test":"draw-fill-color-popover",children:t.jsx(Ar,{label:"Fill Color",currentColor:l,onColorSelect:w})})]})},jb=({drawings:e,className:s})=>{const n=()=>{const r=E.getState().setSelectedNodes,a=E.getState().duplicateNodes;r(e),a()},o=e.length===0;return t.jsx(Zt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-duplicate-tooltip-wrapper",children:t.jsx(Q,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-duplicate-button",children:t.jsx(Pt,{className:"h-3.5 w-3.5"})})})}),t.jsx(Bt,{children:t.jsxs("p",{children:["Duplicate ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},kb=({drawings:e,className:s})=>{const n=()=>{const r=E.getState().deleteNodeById;e.forEach(a=>{r(a.id)})},o=e.length===0;return t.jsx(Zt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx("span",{className:"inline-flex","data-test":"draw-delete-tooltip-wrapper",children:t.jsx(Q,{variant:"outline",size:"compact",onClick:n,disabled:o,className:s,"data-test":"draw-delete-button",children:t.jsx(yt,{className:"h-3.5 w-3.5"})})})}),t.jsx(Bt,{children:t.jsxs("p",{children:["Delete ",e.length>1?`${e.length} drawings`:"drawing"]})})]})})},Ft=[100,90,80,70,60,50,40,30,20,10],kd=e=>(e==null?void 0:e._compressionLevel)??100,Ab=e=>{const s=Ft.indexOf(e);if(s===-1||s>=Ft.length-1){for(let n=0;n<Ft.length;n++)if(Ft[n]<e)return Ft[n];return Ft[Ft.length-1]}return Ft[s+1]},Ib=({drawings:e})=>{var r;const s=kd((r=e[0])==null?void 0:r.data),n=s>Ft[Ft.length-1],o=()=>{for(const a of e){const i=a.data;if(!i)continue;const c=i._original??{...i,_original:void 0,_compressionLevel:void 0},l=Ab(s),d=Al(c,l);E.getState().updateNode(a.id,{data:{...d,_original:c,_compressionLevel:l}})}};return t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-compress-button",children:t.jsx(Io,{className:"h-4 w-4"})})}),t.jsx(Bt,{children:t.jsx("p",{children:"Compress drawing (reduce quality)"})})]})},Tb=({drawings:e})=>{var r;const s=(r=e[0])==null?void 0:r.data,n=!!(s!=null&&s._original),o=()=>{for(const a of e){const i=a.data;if(!(i!=null&&i._original))continue;const{_original:c,_compressionLevel:l,...d}=i._original;E.getState().updateNode(a.id,{data:d})}};return t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,disabled:!n,"data-test":"draw-restore-button",children:t.jsx(Pn,{className:"h-4 w-4"})})}),t.jsx(Bt,{children:t.jsx("p",{children:"Restore original quality"})})]})},Eb=({drawings:e})=>{var n;const s=kd((n=e[0])==null?void 0:n.data);return t.jsxs("span",{className:je("text-xs px-1 tabular-nums",s===100?"text-muted-foreground":"text-orange-500 font-medium"),"data-test":"draw-compression-level",title:"Current compression level (% of original quality)",children:[s,"%"]})},Rb=e=>{if(!e)return 0;if(e._original)return JSON.stringify(e._original).length;const{_original:s,_compressionLevel:n,...o}=e;return JSON.stringify(o).length},Mb=e=>{if(!e)return 0;const{_original:s,...n}=e;return JSON.stringify(n).length},xc=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`;let wc=[],xn=[];const Pb=({drawings:e})=>{e.map(i=>i.id).join(",");const s=p.useSyncExternalStore(E.subscribe,()=>{var h;const i=(h=E.getState().projectCanvas.getActive())==null?void 0:h.coreState.nodes;if(!i)return xn;const c=e.map(g=>g.id),l=i.filter(g=>c.includes(g.id)),d=c.join(","),u=l.some((g,f)=>{const w=xn[f];return!w||w.id!==g.id||w.data!==g.data})||l.length!==xn.length;return(d!==wc.join(",")||u)&&(wc=c,xn=l),xn}),n=s.length>0?s:e,{currentSize:o,originalSize:r}=p.useMemo(()=>{let i=0,c=0;for(const l of n)l.data&&(i+=Mb(l.data),c+=Rb(l.data));return{currentSize:i,originalSize:c}},[n]),a=o<r;return t.jsxs(ud,{className:"gap-0.5 p-0.5",dataTest:"draw-quick-panel-container",dataAttributes:{"drawing-ids":e.map(i=>i.id).join(",")},children:[t.jsx(wb,{drawings:e}),t.jsx(bb,{drawings:e}),t.jsx(Sb,{drawings:e}),t.jsx(Cb,{drawings:e}),t.jsx(Vr,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(jb,{drawings:e}),t.jsx(kb,{drawings:e}),t.jsx(Vr,{orientation:"vertical",className:"h-5 mx-0.5"}),t.jsx(Ib,{drawings:n}),t.jsx(Tb,{drawings:n}),t.jsx(Eb,{drawings:n}),t.jsxs("span",{className:je("text-xs px-1.5 ml-1 tabular-nums",o>500*1024?"text-red-500 font-medium":"text-muted-foreground"),"data-test":"draw-size-indicator",title:`Current: ${o.toLocaleString()} bytes${a?` | Original: ${r.toLocaleString()} bytes`:""}`,children:[xc(o),a&&t.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",xc(r),")"]})]})]})},Db=100,Ob=()=>{const[e,s]=p.useState({top:0,left:0}),[n,o]=p.useState([]),[r,a]=p.useState(!1),[i,c]=p.useState(J.SELECT),l=p.useRef(null),d=p.useRef(""),u=p.useRef(!1),h=p.useRef(J.SELECT);p.useEffect(()=>{const m=()=>{var S;const y=E.getState(),v=(S=y.projectCanvas.getActive())==null?void 0:S.coreState.selectedNodes,N=!!y.uiState.dragInfo,b=y.uiState.mode;if(N!==u.current&&(u.current=N,a(N)),b!==h.current&&(h.current=b??J.SELECT,c(b??J.SELECT)),!v){d.current!==""&&(d.current="",o([]));return}let j="";const R=[];for(const C of v)C.type===le.DRAWING&&(j+=(j?",":"")+C.id,R.push(C));j!==d.current&&(d.current=j,o(R))};m();const x=setInterval(m,Db);return()=>clearInterval(x)},[]);const g=n.length>=1&&!r,f=i===J.DRAW_ARROW,w=Ie.useMemo(()=>n.map(m=>m.id),[n]);return p.useEffect(()=>{if(!g||w.length===0)return;const m=()=>{var B,W;let y=0,v=0,N=0;if(w.forEach(P=>{const k=document.querySelector(`[data-node-id="${P}"]`);if(!k)return;const T=k.getBoundingClientRect(),L=T.left+T.width/2,H=T.top;y+=L,v+=H,N++}),N===0)return;const b=y/N,j=v/N,R=((B=l.current)==null?void 0:B.offsetHeight)||40,S=((W=l.current)==null?void 0:W.offsetWidth)||100,C=window.innerWidth,M=window.innerHeight,I=20,A=Z.nodeUI.quickPanelGap;let O=j-R-A,F=b-S/2;if(O<I){let P=0;w.forEach(k=>{const T=document.querySelector(`[data-node-id="${k}"]`);if(T){const L=T.getBoundingClientRect();P=Math.max(P,L.bottom)}}),O=P+A}O=Math.max(I,Math.min(O,M-R-I)),F=Math.max(I,Math.min(F,C-S-I)),s({top:O,left:F})};m();const x=setTimeout(m,100);return()=>{clearTimeout(x)}},[g,w]),!g||w.length===0||f?null:sn.createPortal(t.jsx("div",{ref:l,className:"fixed pointer-events-auto",style:{top:`${e.top}px`,left:`${e.left}px`,zIndex:Te.popover},onPointerDown:m=>m.stopPropagation(),onTouchStart:m=>m.stopPropagation(),onWheel:m=>m.stopPropagation(),"data-test":"draw-quick-panel-portal",children:t.jsx(Pb,{drawings:n})}),document.body)},Lb=Ie.memo(Ob),Wb=e=>{const s=t.jsx(_t,{className:"h-3 w-3"}),n=e.startNodeId?`Node ${e.startNodeId.substring(0,4)}`:`(${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)})`,o=e.endNodeId?`Node ${e.endNodeId.substring(0,4)}`:`(${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)})`,r=`${n} -> ${o}`,a=e.id.substring(0,6),i=`S: [${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)}]`,c=`E: [${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)}]`;return t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"arrow-display-element",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"arrow-display-top-row",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"arrow-display-content",children:[s&&t.jsx("span",{className:"flex-shrink-0","data-test":"arrow-display-icon",children:s}),t.jsx("span",{className:"truncate","data-test":"arrow-display-text",children:r})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"arrow-display-id",children:a})]}),t.jsxs("div",{className:"text-muted-foreground text-[10px] w-full flex justify-between pr-1","data-test":"arrow-display-coords",children:[t.jsx("span",{"data-test":"arrow-display-start-coords",children:i}),t.jsx("span",{"data-test":"arrow-display-end-coords",children:c})]})]})},Hb=(e,s)=>s.length!==1?-1:e.findIndex(n=>n.id===s[0].id),Bb=e=>{const{className:s,style:n}=e,o=E.getState(),r=o.projectCanvas.getActive(),a=(r==null?void 0:r.coreState.arrows)??[],i=(r==null?void 0:r.coreState.selectedArrows)??[],c=o.arrow.setSelected,l=o.scrollToArrow,d=p.useCallback((g,f)=>{const w=g.length>0?g[0]:-1;if(w>=0&&w<a.length){const m=a[w];c([m]),l(m),console.log("Selected arrow from list:",m.id)}else c([])},[a,c]),u=Hb(a,i),h=u!==-1?[u]:[];return t.jsx("div",{"data-test":"canvas-arrow-infos-container",className:je("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded pointer-events-auto border",s),style:{...n},onMouseDown:g=>g.stopPropagation(),children:t.jsx(rr,{header:t.jsx("span",{className:"text-xs","data-test":"canvas-arrow-infos-header",children:"Arrows"}),itemList:a.map(Wb),onSelectionChange:d,selectedIndices:h,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0})})},Fb=()=>{const e=z(i=>i.uiState.temporaryArrow),s=z(i=>{var c;return((c=i.uiState)==null?void 0:c.useCurvedArrows)??!1}),{startPoint:n,endPoint:o}=e??{};if(!n||!o)return null;const r=s?"auto-start-reverse":"auto",a="temporary-arrowhead";return t.jsxs("g",{children:[t.jsx("defs",{children:t.jsx("marker",{id:a,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:r,markerUnits:"strokeWidth",children:t.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"grey"})})}),t.jsx(er,{startPoint:n,endPoint:o,useCurvedArrows:s,stroke:"grey",strokeWidth:1,strokeDasharray:"4 2",markerEndId:a})]})},yc=e=>{switch(e.strokeStyle){case"dashed":return"8 4";case"dotted":return"2 2";case"solid":default:return}},$b=()=>{const e=z(i=>i.uiState.temporaryDrawing??null);if(!e)return null;const{subMode:s,points:n,startPoint:o,endPoint:r,style:a}=e;if(s===Ce.FREEHAND&&n.length>0){const i=Ke.smoothToSVGPath(n),c=yc(a),l=a.opacity??1,d=l<1;return t.jsx("g",{"data-test":"temporary-drawing-freehand",children:t.jsx("path",{d:i,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:c,strokeOpacity:l,fill:"none",strokeLinecap:d?"butt":"round",strokeLinejoin:d?"bevel":"round"})})}if(o&&r){const c={[Ce.RECTANGLE]:"rectangle",[Ce.SQUARE]:"square",[Ce.CIRCLE]:"circle",[Ce.ELLIPSE]:"ellipse",[Ce.LINE]:"line",[Ce.ARROW]:"arrow",[Ce.FREEHAND]:"line"}[s],l=Ke.generateShapeSVGPath({shapeType:c,startPoint:o,endPoint:r}),d=yc(a),u=a.opacity??1;return t.jsx("g",{"data-test":"temporary-drawing-shape",children:t.jsx("path",{d:l,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeDasharray:d,strokeOpacity:u,fill:a.fillColor?`${a.fillColor}40`:"none",strokeLinecap:"round",strokeLinejoin:"round"})})}return null},zb=30,_b=()=>{const[e,s]=p.useState(0),n=p.useRef(0),o=p.useRef(performance.now());return p.useEffect(()=>{let r=!0;function a(){n.current+=1;const i=performance.now();if(i-o.current>=1e3){const c=n.current;s(c),n.current=0,o.current=i}r&&requestAnimationFrame(a)}return requestAnimationFrame(a),()=>{r=!1}},[]),t.jsxs("div",{className:"text-xs pl-1",style:{color:e<zb?"red":"inherit"},children:["FPS: ",e]})},wn=1e3,yn=500,Vb=({scale:e,offset:s})=>{const n=z(A=>A.uiState.mode),[o,r]=p.useState(null),[a,i]=p.useState(null),c=z(A=>{var O;return((O=A.projectCanvas.getActive())==null?void 0:O.coreState.nodes)??As}),l=z(A=>A.setSelectedNodes),d=window.innerWidth,u=window.innerHeight,h=-s.x/e,g=-s.y/e,f=h+d/e,w=g+u/e,m=Math.floor(h/wn)*wn,x=Math.ceil(f/wn)*wn,y=Math.floor(g/yn)*yn,v=Math.ceil(w/yn)*yn,N=[];for(let A=m;A<=x;A+=wn)N.push(A);const b=[];for(let A=y;A<=v;A+=yn)b.push(A);const j=p.useCallback(A=>{const F=A.currentTarget.getBoundingClientRect(),B=A.clientX-F.left,W=A.clientY-F.top,P=(B-s.x)/e,k=(W-s.y)/e,T=B,L=F.width-B,H=W,$=F.height-W,_=50,G=T<_||L<_,V=H<_||$<_;r({canvasX:P,canvasY:k,showVertical:V,showHorizontal:G})},[e,s]),R=p.useCallback(()=>{r(null),i(null)},[]),S=p.useCallback(A=>{if(o&&(o.showVertical||o.showHorizontal)){A.stopPropagation(),A.preventDefault();const O=o.showVertical?"vertical":"horizontal";i({isDragging:!0,startX:o.canvasX,startY:o.canvasY,currentX:o.canvasX,currentY:o.canvasY,dragType:O})}},[o]),C=p.useCallback(A=>{if(!a||!a.isDragging)return;A.stopPropagation(),A.preventDefault();const O=Math.min(a.startX,a.currentX),F=Math.max(a.startX,a.currentX),B=Math.min(a.startY,a.currentY),W=Math.max(a.startY,a.currentY),P=c.filter(k=>{const T=k.width??200,L=k.height??100,H=k.x+T,$=k.y+L;return a.dragType==="vertical"?k.x<=F&&H>=O:k.y<=W&&$>=B});P.length>0&&l(P),i(null)},[a,c,l]),M=j,I=p.useCallback(A=>{if(M(A),a!=null&&a.isDragging){A.stopPropagation(),A.preventDefault();const F=A.currentTarget.getBoundingClientRect(),B=A.clientX-F.left,W=A.clientY-F.top,P=(B-s.x)/e,k=(W-s.y)/e;i({...a,currentX:P,currentY:k})}},[M,a,s,e]);return n!==J.GRID?null:t.jsx("svg",{"data-grid-svg":"true","data-grid-active":o!=null&&o.showVertical||o!=null&&o.showHorizontal?"true":"false",className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{zIndex:o!=null&&o.showVertical||o!=null&&o.showHorizontal?999:0,pointerEvents:"auto",touchAction:"none",cursor:o?a!=null&&a.isDragging?"grabbing":"grab":"default"},onPointerMove:I,onPointerLeave:R,onPointerDown:S,onPointerUp:C,children:t.jsxs("g",{transform:`translate(${s.x}, ${s.y}) scale(${e})`,children:[N.map(A=>t.jsx("line",{x1:A,y1:g,x2:A,y2:w,stroke:A===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:A===0?2/e:1/e,style:{pointerEvents:"none"}},`v-${A}`)),b.map(A=>t.jsx("line",{x1:h,y1:A,x2:f,y2:A,stroke:A===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:A===0?2/e:1/e,style:{pointerEvents:"none"}},`h-${A}`)),o&&o.showVertical&&t.jsx("line",{x1:o.canvasX,y1:g,x2:o.canvasX,y2:w,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-vertical"),o&&o.showHorizontal&&t.jsx("line",{x1:h,y1:o.canvasY,x2:f,y2:o.canvasY,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-horizontal"),a&&a.isDragging&&(()=>{const A=Math.min(a.startX,a.currentX),O=Math.max(a.startX,a.currentX),F=Math.min(a.startY,a.currentY),B=Math.max(a.startY,a.currentY);return a.dragType==="vertical"?t.jsx("rect",{x:A,y:g,width:O-A,height:w-g,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range"):t.jsx("rect",{x:h,y:F,width:f-h,height:B-F,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range")})(),N.map(A=>t.jsx("text",{x:A,y:g+20/e,fill:"rgba(100, 116, 139, 0.6)",fontSize:be.FONT_SIZE_XXS/e,textAnchor:"middle",style:{pointerEvents:"none"},children:A},`label-v-${A}`)),b.map(A=>t.jsx("text",{x:h+20/e,y:A,fill:"rgba(100, 116, 139, 0.6)",fontSize:be.FONT_SIZE_XXS/e,textAnchor:"start",dominantBaseline:"middle",style:{pointerEvents:"none"},children:A},`label-h-${A}`)),o&&(o.showVertical||o.showHorizontal)&&(()=>{let A=c,O="",F=o.canvasX,B=o.canvasY-30/e;if(a!=null&&a.isDragging){const W=Math.min(a.startX,a.currentX),P=Math.max(a.startX,a.currentX),k=Math.min(a.startY,a.currentY),T=Math.max(a.startY,a.currentY);A=c.filter(L=>{const H=L.width??200,$=L.height??100,_=L.x+H,G=L.y+$;return a.dragType==="vertical"?L.x<=P&&_>=W:L.y<=T&&G>=k}),O=`Release to select ${A.length} node${A.length!==1?"s":""}`,F=(W+P)/2,B=a.dragType==="vertical"?g+30/e:(k+T)/2}else o.showVertical&&(A=A.filter(W=>{const P=W.width??200,k=W.x+P;return W.x<=o.canvasX&&k>=o.canvasX})),o.showHorizontal&&(A=A.filter(W=>{const P=W.height??100,k=W.y+P;return W.y<=o.canvasY&&k>=o.canvasY})),O=`Click/drag to select ${A.length} node${A.length!==1?"s":""}`;return t.jsxs("g",{children:[t.jsx("rect",{x:F-70/e,y:B-12/e,width:140/e,height:24/e,fill:"rgba(0, 0, 0, 0.9)",rx:4/e,style:{pointerEvents:"none"}}),t.jsx("text",{x:F,y:B,fill:"white",fontSize:be.FONT_SIZE_XXS/e,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:O})]},"tooltip")})()]})})},Ad={projectScope:{projects:!0,workspaces:!0,canvases:!0},nodeFields:{content:!1,title:!1,id:!1,type:!1,tags:!1}},Id=e=>Object.values(e.nodeFields).some(s=>s),Ub=e=>{const s=!e.projectScope.projects||!e.projectScope.workspaces||!e.projectScope.canvases,n=Id(e);return s||n},Gb=({searchQuery:e,onSearchQueryChange:s,searchFilters:n,onSearchFiltersChange:o})=>{const[r,a]=p.useState(!1);return t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"projects-search-section",children:[t.jsx(rs,{className:"search-icon absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"projects-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search...",value:e,onChange:i=>s(i.target.value),className:ve("search-input h-7 text-sm pl-8",e?"pr-14":"pr-8"),"data-test":"projects-search-input"}),e&&t.jsx(Q,{variant:"ghost",size:"icon",onClick:()=>s(""),className:"clear-button absolute right-8 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0 hover:bg-muted","aria-label":"Clear search","data-test":"projects-search-clear-button",children:t.jsx(Be,{className:"h-3 w-3"})}),Ub(n)&&t.jsx("div",{className:ve("filter-indicator absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",e?"right-14":"right-9"),"data-test":"projects-search-filter-indicator"}),t.jsxs(ht,{open:r,onOpenChange:a,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"icon",className:"expand-button absolute right-1 top-1/2 -translate-y-1/2 h-5 w-5 shrink-0","aria-label":r?"Collapse advanced search":"Expand advanced search","data-test":"projects-search-expand-button",children:t.jsx(Jo,{className:"h-3 w-3"})})}),t.jsxs(gt,{align:"start",side:"bottom",className:"advanced-search-panel w-72",style:{zIndex:Te.draggablePopoverDropdown},"data-test":"projects-advanced-search-panel",children:[t.jsxs("div",{className:"panel-header flex items-center justify-between pb-2 border-b","data-test":"projects-panel-header",children:[t.jsx("h3",{className:"font-semibold text-sm",children:"Advanced Search"}),t.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>o(Ad),className:"h-6 text-xs px-2","data-test":"projects-clear-filters-button",children:"Clear All"})]}),t.jsxs("div",{className:"project-scope-section space-y-2 mt-3","data-test":"projects-scope-section",children:[t.jsx(Ee,{className:"text-sm font-medium",children:"Project"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in names of:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"scope-projects",checked:n.projectScope.projects,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,projects:!!i}}),"data-test":"projects-scope-projects-checkbox"}),t.jsx("label",{htmlFor:"scope-projects",className:"text-sm cursor-pointer",children:"Projects"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"scope-workspaces",checked:n.projectScope.workspaces,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,workspaces:!!i}}),"data-test":"projects-scope-workspaces-checkbox"}),t.jsx("label",{htmlFor:"scope-workspaces",className:"text-sm cursor-pointer",children:"Workspaces"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"scope-canvases",checked:n.projectScope.canvases,onCheckedChange:i=>o({...n,projectScope:{...n.projectScope,canvases:!!i}}),"data-test":"projects-scope-canvases-checkbox"}),t.jsx("label",{htmlFor:"scope-canvases",className:"text-sm cursor-pointer",children:"Canvases"})]})]})]}),t.jsxs("div",{className:"node-fields-section space-y-2 mt-4","data-test":"projects-node-fields-section",children:[t.jsx(Ee,{className:"text-sm font-medium",children:"Node Content"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in node properties:"}),t.jsxs("div",{className:"checkboxes-grid space-y-1.5",children:[t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-content",checked:n.nodeFields.content,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,content:!!i}}),"data-test":"projects-node-content-checkbox"}),t.jsx("label",{htmlFor:"node-content",className:"text-sm cursor-pointer",children:"Content"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-title",checked:n.nodeFields.title,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,title:!!i}}),"data-test":"projects-node-title-checkbox"}),t.jsx("label",{htmlFor:"node-title",className:"text-sm cursor-pointer",children:"Title"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-id",checked:n.nodeFields.id,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,id:!!i}}),"data-test":"projects-node-id-checkbox"}),t.jsx("label",{htmlFor:"node-id",className:"text-sm cursor-pointer",children:"ID"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-type",checked:n.nodeFields.type,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,type:!!i}}),"data-test":"projects-node-type-checkbox"}),t.jsx("label",{htmlFor:"node-type",className:"text-sm cursor-pointer",children:"Type"})]}),t.jsxs("div",{className:"checkbox-item flex items-center space-x-2",children:[t.jsx(We,{id:"node-tags",checked:n.nodeFields.tags,onCheckedChange:i=>o({...n,nodeFields:{...n.nodeFields,tags:!!i}}),"data-test":"projects-node-tags-checkbox"}),t.jsx("label",{htmlFor:"node-tags",className:"text-sm cursor-pointer",children:"Tags"})]})]})]}),t.jsxs("div",{className:"panel-footer flex items-center gap-2 pt-3 mt-4 border-t","data-test":"projects-panel-footer",children:[t.jsx(Q,{onClick:()=>a(!1),className:"flex-1",size:"sm","data-test":"projects-apply-search-button",children:"Apply"}),t.jsx(Q,{onClick:()=>a(!1),variant:"outline",size:"sm","data-test":"projects-cancel-button",children:"Cancel"})]})]})]})]})},Yb=()=>{const e=z(a=>{var i,c;return(c=(i=a.preferences)==null?void 0:i.projectsManagerSearch)==null?void 0:c.filters}),[s,n]=p.useState(""),[o,r]=p.useState(e??Ad);return p.useEffect(()=>{E.setState(a=>({...a,preferences:{...a.preferences,projectsManagerSearch:{filters:o}}}))},[o]),{searchQuery:s,setSearchQuery:n,searchFilters:o,setSearchFilters:r}},Kb=180,Xb=[],Td=e=>{const{onCanvasSelected:s,excludeCanvasId:n,selectionModeTitle:o,isOpen:r,onClose:a,popoverPosition:i}=e,c=!!s,l=z(ee=>{var K;return((K=ee.state)==null?void 0:K.projects)??{}}),d=z(ee=>{var K;return((K=ee.state)==null?void 0:K.activeProjectId)??""}),u=z(ee=>ee.project),h=z(ee=>ee.workspace),g=z(ee=>ee.projectCanvas),f=z(ee=>ee.exportSingleCanvas),w=z(ee=>ee.exportSingleWorkspace),m=z(ee=>ee.exportSingleProject),{searchQuery:x,setSearchQuery:y,searchFilters:v,setSearchFilters:N}=Yb(),b=z(ee=>{var K;return((K=ee.preferences)==null?void 0:K.recentCanvases)??Xb}),[j,R]=p.useState("projects"),S=p.useMemo(()=>d?l[d]??null:null,[l,d]),C=p.useMemo(()=>S!=null&&S.activeWorkspaceId?S.workspaces[S.activeWorkspaceId]??null:null,[S]),[M,I]=p.useState(""),[A,O]=p.useState(null),[F,B]=p.useState(null),W=p.useRef(null),P=kr("projects-manager"),k=r!==void 0,T=k?r:P.isOpen,L=k?ee=>{!ee&&a&&a()}:ee=>{ee?P.open():P.close()},H=k?i:F,$=p.useMemo(()=>{const ee=x.toLowerCase().trim(),K=ee.length>0,U=Id(v),q=ne=>ne?ne.toLowerCase().includes(ee):!1,se=ne=>{if(!K||!U)return!1;const{nodeFields:oe}=v,fe=typeof ne.content=="string"?ne.content:"";return!!(oe.content&&q(fe)||oe.title&&q(ne.title)||oe.id&&q(ne.id)||oe.type&&q(ne.type)||oe.tags&&Array.isArray(ne.tags)&&ne.tags.some(de=>{const pe=typeof de=="string"?de:(de==null?void 0:de.value)||(de==null?void 0:de.label)||"";return q(pe)}))};return Object.values(l).sort((ne,oe)=>(ne.sortOrder??0)-(oe.sortOrder??0)).map(ne=>{if(K&&ne.hideFromSearch)return null;const oe=K&&v.projectScope.projects&&q(ne.name),fe=Object.values(ne.workspaces).sort((de,pe)=>(de.sortOrder??0)-(pe.sortOrder??0)).map(de=>{if(K&&de.hideFromSearch)return null;const pe=K&&v.projectScope.workspaces&&q(de.name),ae=Object.values(de.canvases).sort((me,Ne)=>(me.sortOrder??0)-(Ne.sortOrder??0)).map(me=>{var Ae;if(n&&me.id===n||K&&me.hideFromSearch)return null;const Ne=K&&v.projectScope.canvases&&q(me.name);let xe=[];K&&U&&((Ae=me.coreState)!=null&&Ae.nodes)&&(xe=me.coreState.nodes.filter(se).map(ke=>{const Pe=typeof ke.content=="string"?ke.content:"",Fe=ke.title||Pe.substring(0,40)||ke.id,Me=Fe.length>40?Fe.substring(0,40)+"...":Fe;return{id:`node-${ke.id}`,label:Me,data:{type:"node",id:ke.id,name:Me,isActive:!1,projectId:ne.id,workspaceId:de.id,canvasId:me.id,nodeType:ke.type}}}));const ye=xe.length>0;return!K||Ne||ye?{id:me.id,label:me.name,data:{type:"canvas",id:me.id,name:me.name,isActive:me.id===de.activeCanvasId,projectId:ne.id,workspaceId:de.id},children:xe.length>0?xe:void 0}:null}).filter(Boolean),re=ae.length>0;return!K||pe||re?{id:de.id,label:de.name,data:{type:"workspace",id:de.id,name:de.name,isActive:de.id===ne.activeWorkspaceId,projectId:ne.id},children:ae}:null}).filter(Boolean),he=fe.length>0;return!K||oe||he?{id:ne.id,label:ne.name,data:{type:"project",id:ne.id,name:ne.name,isActive:ne.id===d},children:fe}:null}).filter(Boolean)},[l,d,x,v,n]),_=p.useMemo(()=>{const ee=new Set;if(d&&ee.add(d),S!=null&&S.activeWorkspaceId&&ee.add(S.activeWorkspaceId),x.trim()){const K=U=>{for(const q of U)ee.add(q.id),q.children&&K(q.children)};K($)}return ee},[d,S,x,$]),G=ee=>{const K=M.trim()||`New ${ee}`;ee==="project"?u.create(K):ee==="workspace"?h.create(K):ee==="canvas"&&g.create(K),I(""),O(null)},V=ee=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5","data-test":"projects-add-input-container",children:[t.jsx(Re,{"data-test":"projects-new-input",type:"text",placeholder:`New ${ee} name...`,value:M,onChange:K=>I(K.target.value),onKeyDown:K=>K.key==="Enter"&&G(ee),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(Q,{"data-test":"projects-save-button",variant:"ghost",size:"sm",onClick:()=>G(ee),children:t.jsx(Jt,{className:"h-3 w-3"})}),t.jsx(Q,{"data-test":"projects-cancel-button",variant:"ghost",size:"sm",onClick:()=>{O(null),I("")},children:t.jsx(Be,{className:"h-3 w-3"})})]}),D=ee=>{var U;const K=(U=ee.data)==null?void 0:U.type;if(K==="canvas"){if(c&&s){const{id:q,workspaceId:se,projectId:ne,name:oe}=ee.data||{};q&&se&&ne&&s({canvasId:q,workspaceId:se,projectId:ne,canvasName:oe||""});return}g.switch(ee.id)}else if(K==="node"){const{canvasId:q,id:se}=ee.data||{};q&&se&&(g.switch(q),setTimeout(()=>{const ne=E.getState().getNodeById(se);ne&&(E.getState().setSelectedNodes([ne]),E.getState().scrollToNode(se,300))},100))}},Y=ee=>{if(c&&s){if(n&&ee.canvasId===n)return;s({canvasId:ee.canvasId,workspaceId:ee.workspaceId,projectId:ee.projectId,canvasName:ee.canvasName});return}g.switch(ee.canvasId),R("projects")},te=(ee,K)=>{ee.stopPropagation(),g.removeRecentCanvas(K)},ie=(ee,K)=>{const U=se=>{var ne;for(const oe of se){if(oe.id===ee)return(ne=oe.data)==null?void 0:ne.type;if(oe.children){const fe=U(oe.children);if(fe)return fe}}return null},q=U($);q==="project"?u.updateMetadata(ee,{name:K}):q==="workspace"?h.updateMetadata(ee,{name:K}):q==="canvas"&&g.updateMetadata(ee,{name:K})},we=ee=>{const K=q=>{var se;for(const ne of q){if(ne.id===ee)return(se=ne.data)==null?void 0:se.type;if(ne.children){const oe=K(ne.children);if(oe)return oe}}return null},U=K($);U==="project"?u.delete(ee):U==="workspace"?h.delete(ee):U==="canvas"&&g.delete(ee)},ge=ee=>{var U;return`Are you sure you want to delete this ${((U=ee.data)==null?void 0:U.type)??"item"}: "${ee.label}"?`},X=ee=>{const K=E.getState().setState;K(pu(U=>{if(!U)return;const q=Date.now();ee.forEach((se,ne)=>{var de;const oe=U.projects[se.id];if(!oe)return;oe.sortOrder=ne,oe.lastModified=q;const fe=new Set,he=new Map;(de=se.children)==null||de.forEach((pe,ae)=>{var me;let re=oe.workspaces[pe.id];if(re)re.sortOrder=ae,re.lastModified=q,fe.add(pe.id);else{let Ne=null,xe=null;for(const[ye,Ae]of Object.entries(U.projects))if(ye!==se.id&&Ae.workspaces[pe.id]){Ne=Ae.workspaces[pe.id],xe=ye;break}if(Ne&&xe){if(delete U.projects[xe].workspaces[pe.id],U.projects[xe].lastModified=q,U.projects[xe].activeWorkspaceId===pe.id){const ye=Object.keys(U.projects[xe].workspaces);U.projects[xe].activeWorkspaceId=ye[0]||""}oe.workspaces[pe.id]=Ne,Ne.sortOrder=ae,Ne.lastModified=q,fe.add(pe.id),re=Ne}}if(re){const Ne=new Set;he.set(pe.id,Ne),(me=pe.children)==null||me.forEach((xe,ye)=>{const Ae=re.canvases[xe.id];if(Ae)Ae.sortOrder=ye,Ae.lastModified=q,Ne.add(xe.id);else{let ke=null,Pe=null;for(const[Fe,Me]of Object.entries(oe.workspaces))if(Me.canvases[xe.id]){ke=Me.canvases[xe.id],Pe=Fe;break}if(ke)Pe&&Pe!==pe.id&&(delete oe.workspaces[Pe].canvases[xe.id],oe.workspaces[Pe].lastModified=q);else for(const[Fe,Me]of Object.entries(U.projects))if(Fe!==se.id){for(const[Ue,$e]of Object.entries(Me.workspaces))if($e.canvases[xe.id]){ke=$e.canvases[xe.id],Pe=Ue,delete $e.canvases[xe.id],$e.lastModified=q,Me.lastModified=q;break}if(ke)break}ke&&(re.canvases[xe.id]=ke,ke.sortOrder=ye,ke.lastModified=q,Ne.add(xe.id))}})}})})}))},ce=ee=>{var U,q,se,ne,oe,fe,he;const K=(U=ee.data)==null?void 0:U.type;if(K==="project"){const de=(q=ee.data)==null?void 0:q.id,pe=de?l[de]:null,ae=(pe==null?void 0:pe.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:ae?"Include in search":"Hide from search",icon:ae?t.jsx(qt,{className:"h-4 w-4 mr-2"}):t.jsx(ys,{className:"h-4 w-4 mr-2"}),onClick:re=>{const{id:me}=re.data||{};me&&u.updateMetadata(me,{hideFromSearch:!ae})}},{id:"export",label:"Export",icon:t.jsx(po,{className:"h-4 w-4 mr-2"}),onClick:re=>{const{id:me}=re.data||{};me&&m({projectId:me})}}]}if(K==="workspace"){const de=(se=ee.data)==null?void 0:se.id,pe=(ne=ee.data)==null?void 0:ne.projectId,ae=pe?l[pe]:null,re=ae&&de?ae.workspaces[de]:null,me=(re==null?void 0:re.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:me?"Include in search":"Hide from search",icon:me?t.jsx(qt,{className:"h-4 w-4 mr-2"}):t.jsx(ys,{className:"h-4 w-4 mr-2"}),onClick:Ne=>{const{id:xe}=Ne.data||{};xe&&h.updateMetadata(xe,{hideFromSearch:!me})}},{id:"export",label:"Export",icon:t.jsx(po,{className:"h-4 w-4 mr-2"}),onClick:Ne=>{const{projectId:xe,id:ye}=Ne.data||{};xe&&ye&&w({projectId:xe,workspaceId:ye})}}]}if(K==="canvas"){const de=(oe=ee.data)==null?void 0:oe.id,pe=(fe=ee.data)==null?void 0:fe.projectId,ae=(he=ee.data)==null?void 0:he.workspaceId,re=pe?l[pe]:null,me=re&&ae?re.workspaces[ae]:null,Ne=me&&de?me.canvases[de]:null,xe=(Ne==null?void 0:Ne.hideFromSearch)??!1;return[{id:"toggle-search-visibility",label:xe?"Include in search":"Hide from search",icon:xe?t.jsx(qt,{className:"h-4 w-4 mr-2"}):t.jsx(ys,{className:"h-4 w-4 mr-2"}),onClick:ye=>{const{id:Ae}=ye.data||{};Ae&&g.updateMetadata(Ae,{hideFromSearch:!xe})}},{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:ye=>{const{projectId:Ae,workspaceId:ke,id:Pe}=ye.data||{};Ae&&ke&&Pe&&g.duplicate(Pe,Ae,ke)}},{id:"export",label:"Export",icon:t.jsx(po,{className:"h-4 w-4 mr-2"}),onClick:ye=>{const{projectId:Ae,workspaceId:ke,id:Pe}=ye.data||{};Ae&&ke&&Pe&&f({projectId:Ae,workspaceId:ke,canvasId:Pe})}}]}return null},ue=()=>{if(T){L(!1),O(null),I("");return}if(W.current){const ee=W.current.getBoundingClientRect(),K=320,U=400,q=ee.left+ee.width/2,se=ee.top+ee.height/2;B({x:q-K/2+Kb,y:se-U/2})}L(!0)};return t.jsxs(t.Fragment,{children:[!k&&t.jsx(is,{ref:W,variant:"secondary",size:"sm",tooltip:"Manage projects",onClick:ue,className:"canvas-projects-manager-button","data-test":"canvas-projects-manager-button",children:t.jsx(Vh,{className:"h-4 w-4"})}),t.jsx(Ve,{isVisible:T,onClose:()=>{L(!1),O(null),I(""),R("projects")},title:c?o??"Select Canvas":j==="recent"?"Recent Canvases":"Projects",resizable:!0,initialSize:{width:320,height:400},triggerPosition:H??void 0,shouldCloseManually:!0,headerActions:j==="recent"?t.jsx(Q,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>R("projects"),title:"Back to Projects","data-test":"projects-back-button",children:t.jsx(Xs,{className:"h-3.5 w-3.5"})}):t.jsx(Q,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>R("recent"),title:"Recent Canvases","data-test":"projects-recent-button",children:t.jsx(as,{className:"h-3.5 w-3.5"})}),children:t.jsx("div",{className:"manager-content flex flex-col space-y-2 p-2 h-full overflow-hidden","data-test":"projects-manager-content",children:j==="projects"?t.jsxs(t.Fragment,{children:[t.jsx(Gb,{searchQuery:x,onSearchQueryChange:y,searchFilters:v,onSearchFiltersChange:N}),t.jsx(Gs,{className:"tree-scroll-area flex-1 min-h-0","data-test":"projects-tree-scroll-area",children:t.jsx("div",{className:"tree-container space-y-1 pr-2","data-test":"projects-tree-container",children:t.jsx(qs,{data:$,onItemClick:D,onUpdate:c?void 0:ie,onDelete:c?void 0:we,onReorder:c?void 0:X,defaultExpandedIds:_,selectedId:(C==null?void 0:C.activeCanvasId)??null,deleteConfirmMessage:c?void 0:ge,enableEdit:!c,enableDelete:!c,enableDrag:!c,moreOptionsItems:c?void 0:ce,dropdownZIndex:Te.draggablePopoverDropdown})})}),!c&&(A?V(A):t.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t","data-test":"projects-add-buttons-row",children:[t.jsxs(Q,{"data-test":"projects-add-project-button",variant:"outline",size:"sm",className:"add-project-button flex-1",onClick:()=>O("project"),title:"Add Project",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Pr"]}),S&&t.jsxs(Q,{"data-test":"projects-add-workspace-button",variant:"outline",size:"sm",className:"add-workspace-button flex-1",onClick:()=>O("workspace"),title:"Add Workspace",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Wo"]}),C&&t.jsxs(Q,{"data-test":"projects-add-canvas-button",variant:"outline",size:"sm",className:"add-canvas-button flex-1",onClick:()=>O("canvas"),title:"Add Canvas",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Ca"]})]}))]}):t.jsx(Gs,{className:"recent-canvases-scroll flex-1 min-h-0","data-test":"projects-recent-scroll-area",children:t.jsx("div",{className:"recent-canvases-list space-y-1 pr-2","data-test":"recent-canvases-list",children:(()=>{const ee=n?b.filter(K=>K.canvasId!==n):b;return ee.length===0?t.jsx("div",{className:"empty-state text-center text-muted-foreground text-sm py-8","data-test":"recent-canvases-empty",children:"No recently visited canvases"}):ee.map(K=>t.jsxs("div",{className:"recent-canvas-item group flex items-center w-full text-left px-2 py-1.5 rounded hover:bg-accent transition-colors cursor-pointer",onClick:()=>Y(K),"data-test":"recent-canvas-item",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"canvas-name text-sm font-medium truncate","data-test":"recent-canvas-name",children:K.canvasName}),t.jsxs("div",{className:"canvas-path text-xs text-muted-foreground truncate","data-test":"recent-canvas-path",children:[K.projectName," / ",K.workspaceName]})]}),!c&&t.jsx(Q,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity shrink-0",onClick:U=>te(U,K.canvasId),title:"Remove from recent","data-test":"recent-canvas-delete",children:t.jsx(Be,{className:"h-3.5 w-3.5"})})]},`${K.projectId}-${K.workspaceId}-${K.canvasId}`))})()})})})})]})};function Ed({node:e,onItemClick:s,onUpdate:n,onDelete:o,level:r=0,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:g}){var W;const[f,w]=p.useState((a==null?void 0:a.has(e.id))??!1),[m,x]=p.useState(!1),[y,v]=p.useState(e.label),N=e.children&&e.children.length>0,b=i===e.id,j=p.useRef(null),R=p.useRef(e.label);p.useEffect(()=>{e.label!==R.current&&(R.current=e.label,m||v(e.label))},[e.label,m]),p.useEffect(()=>{b&&j.current&&j.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[b]);const S=P=>{P.stopPropagation(),m||(N&&w(!f),s==null||s(e))},C=()=>{y.trim()&&y!==e.label&&(n==null||n(e.id,y.trim())),x(!1)},M=()=>{v(e.label),x(!1)},I=P=>{P.stopPropagation();const k=(d==null?void 0:d(e))??`Are you sure you want to delete "${e.label}"?`;window.confirm(k)&&(o==null||o(e.id))},A={paddingLeft:`${r*1.5}rem`},O=N?t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:f?t.jsx(Ct,{className:"h-4 w-4"}):t.jsx(on,{className:"h-4 w-4"})}):t.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),F=t.jsxs("div",{ref:j,className:ve("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",b&&"bg-primary/10 border border-primary"),style:A,onClick:S,children:[O,e.icon&&t.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:e.icon}),m?t.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[t.jsx(Re,{type:"text",value:y,onChange:P=>v(P.target.value),onKeyDown:P=>{P.key==="Enter"&&C(),P.key==="Escape"&&M()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:P=>P.stopPropagation()}),t.jsx(Q,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),C()},className:"h-6 w-6 p-0",children:t.jsx(Jt,{className:"h-3 w-3"})}),t.jsx(Q,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),M()},className:"h-6 w-6 p-0",children:t.jsx(Be,{className:"h-3 w-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"tree-item-label flex-grow truncate",title:e.label,children:e.label}),t.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[c&&n&&t.jsx(Q,{variant:"ghost",size:"sm",onClick:P=>{P.stopPropagation(),x(!0)},className:"h-6 w-6 p-0","data-test":"tree-item-edit-button",children:t.jsx(Nl,{className:"h-3 w-3"})}),(()=>{const P=h==null?void 0:h(e);return P&&P.length>0?t.jsxs(bo,{children:[t.jsx(No,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"sm",onClick:k=>k.stopPropagation(),className:"h-6 w-6 p-0","data-test":"tree-item-more-options-button",children:t.jsx(vl,{className:"h-3 w-3"})})}),t.jsxs(So,{align:"end",style:g?{zIndex:g}:void 0,"data-test":"tree-item-more-options-content",children:[P.map(k=>k.subItems?t.jsxs(gu,{children:[t.jsxs(fu,{className:k.className,"data-test":"tree-item-menu-trigger",children:[k.icon,k.label]}),t.jsx(mu,{children:k.subItems.map(T=>t.jsxs(Rt,{onClick:L=>{L.stopPropagation(),T.onClick(e)},className:T.className,"data-test":"tree-item-menu-subitem",children:[T.icon,T.label]},T.id))})]},k.id):t.jsxs(Rt,{onClick:T=>{var L;T.stopPropagation(),(L=k.onClick)==null||L.call(k,e)},className:k.className,"data-test":"tree-item-menu-item",children:[k.icon,k.label]},k.id)),l&&o&&t.jsxs(Rt,{onClick:k=>{k.stopPropagation(),I(k)},className:"text-destructive focus:text-destructive","data-test":"tree-item-menu-delete",children:[t.jsx(yt,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}):l&&o?t.jsx(Q,{variant:"ghost",size:"sm",onClick:I,className:"h-6 w-6 p-0 text-destructive hover:text-destructive","data-test":"tree-item-delete-button",children:t.jsx(yt,{className:"h-3 w-3"})}):null})()]})]})]}),B=u?u(e,b,!!N,F):F;return N?t.jsxs(gs,{open:f,onOpenChange:w,children:[t.jsx(fs,{asChild:!0,children:t.jsx("div",{children:B})}),t.jsx(ms,{children:t.jsx("div",{className:"tree-item-children",children:(W=e.children)==null?void 0:W.map(P=>t.jsx(Ed,{node:P,onItemClick:s,onUpdate:n,onDelete:o,level:r+1,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:g},P.id))})})]}):t.jsx(t.Fragment,{children:B})}function qb({data:e,onItemClick:s,onUpdate:n,onDelete:o,className:r,defaultExpandedIds:a,selectedId:i,enableEdit:c=!0,enableDelete:l=!0,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:g}){return t.jsx("div",{className:ve("crud-tree-root",r),children:e.map(f=>t.jsx(Ed,{node:f,onItemClick:s,onUpdate:n,onDelete:o,defaultExpandedIds:a,selectedId:i,enableEdit:c,enableDelete:l,deleteConfirmMessage:d,renderNode:u,moreOptionsItems:h,dropdownZIndex:g},f.id))})}const Zb=180,Jb=()=>{const e=ft(X=>X.definitions),s=ft(X=>X.instances),n=ft(X=>X.selectedDefinitionId),o=ft(X=>X.createDefinition),r=ft(X=>X.updateDefinition),a=ft(X=>X.deleteDefinition);ft(X=>X.duplicateDefinition);const i=ft(X=>X.createInstance),c=ft(X=>X.deleteInstance),l=ft(X=>X.selectDefinition),d=z(X=>{var ce;return((ce=X.projectCanvas.getActive())==null?void 0:ce.coreState.nodes)??As}),u=z(X=>{var ce;return((ce=X.state)==null?void 0:ce.projects)??{}}),[h,g]=p.useState(""),[f,w]=p.useState(null),[m,x]=p.useState(null),[y,v]=p.useState(new Set),N=p.useRef(null),b=p.useRef(null),{isOpen:j,open:R,close:S}=kr("workflow-manager"),C=ft(X=>X.facade),M=p.useMemo(()=>new Ja(C),[C]),I=p.useMemo(()=>{const X=u["workflow-templates-project"],ce=[];X&&Object.values(X.workspaces).forEach(se=>{Object.values(se.canvases).forEach(ne=>{ne.coreState.nodes.filter(fe=>{var he;return((he=fe.data)==null?void 0:he.nodeType)==="workflowOrchestration"}).forEach(fe=>{var re,me;const he=fe.data,de=((me=(re=he==null?void 0:he.parameters)==null?void 0:re.rows)==null?void 0:me.length)||0,pe=typeof fe.title=="string"?fe.title:"",ae=typeof fe.content=="string"?fe.content:"";ce.push({id:`preset-${fe.id}`,label:pe||ae||`Preset (${de} steps)`,data:{type:"preset-workflow",id:fe.id,nodeId:fe.id,rowCount:de,canvasId:ne.id,canvasName:ne.name}})})})});const ue=new Set(ce.map(se=>{var ne;return(ne=se.data)==null?void 0:ne.nodeId})),K=d.filter(se=>{var ne;return((ne=se.data)==null?void 0:ne.nodeType)==="workflowOrchestration"&&!ue.has(se.id)}).map(se=>{var de,pe;const ne=se.data,oe=((pe=(de=ne==null?void 0:ne.parameters)==null?void 0:de.rows)==null?void 0:pe.length)||0,fe=typeof se.title=="string"?se.title:"",he=typeof se.content=="string"?se.content:"";return{id:se.id,label:fe||he||`Workflow (${oe} steps)`,data:{type:"canvas-workflow",id:se.id,nodeId:se.id,rowCount:oe}}}),U=e.map(se=>{const ne=s.filter(oe=>oe.definitionId===se.id);return{id:se.id,label:se.name,data:{type:"definition",id:se.id,name:se.name,isActive:se.id===n,description:se.description,tags:se.tags},children:ne.map(oe=>({id:oe.id,label:oe.name,data:{type:"instance",id:oe.id,name:oe.name,status:oe.status,definitionId:oe.definitionId}}))}}),q=[];return ce.length>0&&q.push({id:"section-presets",label:`📚 Workflow Presets (${ce.length})`,data:{type:"section",section:"presets"},children:ce}),K.length>0&&q.push({id:"section-canvas",label:`🎨 Current Canvas (${K.length})`,data:{type:"section",section:"canvas"},children:K}),U.length>0&&q.push({id:"section-saved",label:`💾 Saved Workflows (${U.length})`,data:{type:"section",section:"saved"},children:U}),q},[d,e,s,n,u]),A=p.useMemo(()=>{const X=new Set;return X.add("section-presets"),X.add("section-canvas"),X.add("section-saved"),n&&X.add(n),X},[n]),O=X=>{const ce=h.trim()||`New ${X}`;X==="definition"?o({name:ce}):X==="instance"&&n&&i(n,ce),g(""),w(null)},F=X=>t.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[t.jsx(Re,{"data-test":"workflow-new-input",type:"text",placeholder:`New ${X} name...`,value:h,onChange:ce=>g(ce.target.value),onKeyDown:ce=>ce.key==="Enter"&&O(X),autoFocus:!0,className:"h-6 text-sm flex-grow"}),t.jsx(Q,{"data-test":"workflow-save-button",variant:"ghost",size:"sm",onClick:()=>O(X),children:t.jsx(Jt,{className:"h-3 w-3"})}),t.jsx(Q,{"data-test":"workflow-cancel-button",variant:"ghost",size:"sm",onClick:()=>{w(null),g("")},children:t.jsx(Be,{className:"h-3 w-3"})})]}),B=X=>{var ue;((ue=X.data)==null?void 0:ue.type)==="definition"&&l(X.id)},W=(X,ce)=>{const ue=K=>{var U;for(const q of K){if(q.id===X)return(U=q.data)==null?void 0:U.type;if(q.children){const se=ue(q.children);if(se)return se}}return null},ee=ue(I);ee==="section"||ee==="preset-workflow"||(ee==="canvas-workflow"?E.getState().updateNode(X,{title:ce}):ee==="definition"?r(X,{name:ce}):ee==="instance"&&console.warn("Instance rename not yet implemented"))},P=X=>{const ce=ee=>{var K;for(const U of ee){if(U.id===X)return(K=U.data)==null?void 0:K.type;if(U.children){const q=ce(U.children);if(q)return q}}return null},ue=ce(I);ue==="section"||ue==="preset-workflow"||ue==="canvas-workflow"||(ue==="definition"?a(X):ue==="instance"&&c(X))},k=X=>{var ue;return`Are you sure you want to delete this ${((ue=X.data)==null?void 0:ue.type)??"item"}: "${X.label}"?`},T=()=>{if(j){S(),w(null),g("");return}if(N.current){const X=N.current.getBoundingClientRect(),ce=320,ue=400,ee=X.left+X.width/2,K=X.top+X.height/2;x({x:ee-ce/2+Zb,y:K-ue/2})}R()},L=()=>{if(y.size===0){Se.error("No workflows selected");return}try{const X=Array.from(y);M.downloadWorkflows(X),Se.success(`Exported ${y.size} workflow(s)`,{description:"Workflows downloaded as JSON file"})}catch(X){Se.error("Export failed",{description:X instanceof Error?X.message:"Unknown error"})}},H=()=>{try{const X=M.exportAllWorkflows(),ce=new Blob([X],{type:"application/json"}),ue=URL.createObjectURL(ce),ee=document.createElement("a");ee.href=ue,ee.download=`all-workflows-${Date.now()}.json`,ee.click(),URL.revokeObjectURL(ue),Se.success("Exported all workflows",{description:`${e.length} workflow(s) downloaded`})}catch(X){Se.error("Export failed",{description:X instanceof Error?X.message:"Unknown error"})}},$=()=>{var X;(X=b.current)==null||X.click()},_=X=>{var ee;const ce=(ee=X.target.files)==null?void 0:ee[0];if(!ce)return;const ue=new FileReader;ue.onload=K=>{var U;try{const q=(U=K.target)==null?void 0:U.result,se=M.importWorkflows(q);Se.success(`Imported ${se.length} workflow(s)`,{description:"Workflows added to manager"})}catch(q){Se.error("Import failed",{description:q instanceof Error?q.message:"Invalid JSON"})}},ue.readAsText(ce),X.target.value=""},G=X=>{const ce=new Set(y);ce.has(X)?ce.delete(X):ce.add(X),v(ce)},V=()=>{y.size===e.length?v(new Set):v(new Set(e.map(X=>X.id)))},D=()=>{if(y.size!==0&&window.confirm(`Are you sure you want to delete ${y.size} workflow(s)?`))try{M.bulkDeleteDefinitions(Array.from(y)),v(new Set),Se.success(`Deleted ${y.size} workflow(s)`)}catch(X){Se.error("Bulk delete failed",{description:X instanceof Error?X.message:"Unknown error"})}},Y=()=>{if(y.size!==0)try{const X=M.bulkDuplicateDefinitions(Array.from(y));v(new Set),Se.success(`Duplicated ${X.length} workflow(s)`,{description:'New workflows created with " (copy)" suffix'})}catch(X){Se.error("Bulk duplicate failed",{description:X instanceof Error?X.message:"Unknown error"})}},te=()=>{if(y.size===0)return;const X=window.prompt("Enter tags (comma-separated):");if(!X)return;const ce=X.split(",").map(ue=>ue.trim()).filter(Boolean);if(ce.length===0){Se.error("No valid tags provided");return}try{M.bulkAddTags(Array.from(y),ce),Se.success(`Added tags to ${y.size} workflow(s)`,{description:`Tags: ${ce.join(", ")}`})}catch(ue){Se.error("Bulk add tags failed",{description:ue instanceof Error?ue.message:"Unknown error"})}},ie=()=>{if(y.size===0)return;const X=window.prompt("Enter tags to remove (comma-separated):");if(!X)return;const ce=X.split(",").map(ue=>ue.trim()).filter(Boolean);if(ce.length===0){Se.error("No valid tags provided");return}try{M.bulkRemoveTags(Array.from(y),ce),Se.success(`Removed tags from ${y.size} workflow(s)`,{description:`Tags: ${ce.join(", ")}`})}catch(ue){Se.error("Bulk remove tags failed",{description:ue instanceof Error?ue.message:"Unknown error"})}},we=()=>{if(y.size!==0)try{const X=M.getBulkStats(Array.from(y));Se.info("Bulk Statistics",{description:`Workflows: ${X.count} | Nodes: ${X.totalNodes} | Connections: ${X.totalConnections} | Tags: ${X.tags.length}`})}catch(X){Se.error("Failed to get statistics",{description:X instanceof Error?X.message:"Unknown error"})}},ge=y.size===e.length&&e.length>0;return y.size>0&&y.size<e.length,t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:N,variant:"secondary",size:"sm",tooltip:"Manage workflows",onClick:T,className:"workflow-manager-button","data-test":"workflow-manager-button",children:t.jsx(Cs,{className:"h-4 w-4"})}),t.jsx(Ve,{isVisible:j,onClose:()=>{S(),w(null),g("")},title:"Workflow Manager",resizable:!0,initialSize:{width:420,height:450},triggerPosition:m??void 0,shouldCloseManually:!0,children:t.jsxs("div",{className:"flex flex-col space-y-2 p-2 flex-1 h-full overflow-scroll","data-test":"manager-content ",children:[t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b","data-test":"toolbar-row",children:[t.jsxs(bo,{children:[t.jsx(No,{asChild:!0,children:t.jsxs(Q,{"data-test":"workflow-export-dropdown",variant:"outline",size:"sm",className:"flex-1",children:[t.jsx(po,{className:"h-3 w-3 mr-1"}),"Export",t.jsx(Ct,{className:"h-3 w-3 ml-1"})]})}),t.jsxs(So,{style:{zIndex:Te.skipLink},children:[t.jsxs(Rt,{"data-test":"workflow-export-selected",onClick:L,children:["Export Selected (",y.size,")"]}),t.jsxs(Rt,{"data-test":"workflow-export-all",onClick:H,children:["Export All (",e.length,")"]})]})]}),t.jsxs(Q,{"data-test":"workflow-import-button",variant:"outline",size:"sm",className:"flex-1",onClick:$,title:"Import workflows from JSON",children:[t.jsx(zn,{className:"h-3 w-3 mr-1"}),"Import"]}),t.jsx("input",{"data-test":"workflow-import-file-input",ref:b,type:"file",accept:".json",onChange:_,className:"hidden"})]}),y.size>0&&t.jsxs("div",{className:"flex items-center gap-1 pb-1 border-b bg-primary/5 p-1.5 rounded","data-test":"bulk-toolbar",children:[t.jsxs("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:[y.size," selected"]}),t.jsxs(bo,{children:[t.jsx(No,{asChild:!0,children:t.jsxs(Q,{"data-test":"workflow-bulk-actions-dropdown",variant:"ghost",size:"sm",className:"flex-1",children:[t.jsx(Ct,{className:"h-3 w-3 mr-1"}),"Bulk Actions"]})}),t.jsxs(So,{style:{zIndex:Te.skipLink},children:[t.jsx(xu,{children:"Bulk Operations"}),t.jsx(ca,{}),t.jsxs(Rt,{"data-test":"workflow-bulk-duplicate",onClick:Y,children:[t.jsx(Pt,{className:"h-3 w-3 mr-2"}),"Duplicate"]}),t.jsxs(Rt,{"data-test":"workflow-bulk-delete",onClick:D,children:[t.jsx(yt,{className:"h-3 w-3 mr-2"}),"Delete"]}),t.jsx(ca,{}),t.jsxs(Rt,{"data-test":"workflow-bulk-add-tags",onClick:te,children:[t.jsx($n,{className:"h-3 w-3 mr-2"}),"Add Tags"]}),t.jsxs(Rt,{"data-test":"workflow-bulk-remove-tags",onClick:ie,children:[t.jsx($n,{className:"h-3 w-3 mr-2"}),"Remove Tags"]}),t.jsx(ca,{}),t.jsxs(Rt,{"data-test":"workflow-bulk-stats",onClick:we,children:[t.jsx(Uh,{className:"h-3 w-3 mr-2"}),"Show Statistics"]})]})]})]}),e.length>0&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1","data-test":"select-all-row",children:[t.jsx(We,{"data-test":"workflow-select-all-checkbox",checked:ge,onCheckedChange:V,className:"h-4 w-4","aria-label":"Select all workflows"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:ge?"Deselect All":"Select All"})]}),t.jsx(Gs,{className:"tree-scroll-area flex-1",children:t.jsx("div",{className:"space-y-1 pr-2","data-test":"tree-container",children:t.jsx(qb,{data:I,onItemClick:B,onUpdate:W,onDelete:P,defaultExpandedIds:A,selectedId:n,deleteConfirmMessage:k,dropdownZIndex:Te.skipLink,moreOptionsItems:X=>{var ce,ue,ee;if(((ce=X.data)==null?void 0:ce.type)==="canvas-workflow")return[{id:"save",label:"Save Workflow",icon:t.jsx(Jt,{className:"h-4 w-4 mr-2"}),onClick:K=>{try{const U=M.saveWorkflow({nodeId:K.data.nodeId});Se.success("Workflow saved",{description:`"${U.name}" saved as version ${U.version}`})}catch(U){Se.error("Failed to save workflow",{description:U instanceof Error?U.message:"Unknown error"})}}}];if(((ue=X.data)==null?void 0:ue.type)==="preset-workflow"){const K=async(U,q)=>{var se,ne,oe,fe,he,de;try{const pe=u["workflow-templates-project"];if(!pe)throw new Error("Workflow Templates project not found");let ae=null,re=[];if(Object.values(pe.workspaces).forEach(Ue=>{Object.values(Ue.canvases).forEach($e=>{const Qe=$e.coreState.nodes.find(et=>et.id===U.data.nodeId);Qe&&(ae=JSON.parse(JSON.stringify(Qe)),re=$e.coreState.arrows||[])})}),!ae)throw new Error("Preset workflow not found");(ne=(se=ae.data)==null?void 0:se.parameters)!=null&&ne.rows&&ae.data.parameters.rows.forEach(Ue=>{Ue.children&&Ue.children.forEach($e=>{var Qe;$e.stepType==="nodeUpdate"&&((Qe=$e.config)!=null&&Qe.simpleFieldUpdates)&&$e.config.simpleFieldUpdates.forEach(et=>{const vt=et.field;et.field=q,et.template&&(et.template=et.template.replace(new RegExp(`loop\\.current\\.${vt}`,"g"),`loop.current.${q}`))})})});const me=E.getState(),Ne=((oe=me.projectCanvas.getActive())==null?void 0:oe.coreState.nodes)||[],xe=((fe=me.projectCanvas.getActive())==null?void 0:fe.coreState.selectedNodes)||[],ye=((he=me.projectCanvas.getActive())==null?void 0:he.coreState.arrows)||[],Ae=xe.length>0?xe:Ne,ke=new Zs,Pe=[...Ae,ae],Fe=[...ye,...re];ke.loadWorkflow(Pe,Fe);const Me=await ke.executeWorkflow(ae.id);if(Me.success){if(Me.nodeUpdates&&Me.nodeUpdates.length>0){const $e=Me.nodeUpdates.map(({nodeId:Qe,updates:et})=>({id:Qe,...et}));me.updateNodes($e)}const Ue=xe.length>0?"selected":"all";Se.success("Workflow applied",{description:`Applied "${ae.title||"workflow"}" to ${q} of ${((de=Me.nodeUpdates)==null?void 0:de.length)||0} ${Ue} nodes`})}else Se.error("Workflow execution failed",{description:Me.errors.map(Ue=>Ue.message).join(", ")||"Unknown error"})}catch(pe){Se.error("Failed to apply workflow",{description:pe instanceof Error?pe.message:"Unknown error"})}};return[{id:"apply",label:"Apply Workflow",icon:t.jsx(ot,{className:"h-4 w-4 mr-2"}),subItems:wu.map(U=>({id:U,label:yu[U],onClick:async q=>K(q,U)}))},{id:"copy",label:"Copy to Canvas",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:U=>{try{const q=u["workflow-templates-project"];if(!q)throw new Error("Workflow Templates project not found");let se=null;if(Object.values(q.workspaces).forEach(fe=>{Object.values(fe.canvases).forEach(he=>{const de=he.coreState.nodes.find(pe=>pe.id===U.data.nodeId);de&&(se=de)})}),!se)throw new Error("Preset workflow not found");const ne=E.getState(),oe={...se,id:`copied-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,x:150,y:150};ne.addNode(oe),Se.success("Preset copied",{description:"Workflow preset copied to current canvas"})}catch(q){Se.error("Failed to copy preset",{description:q instanceof Error?q.message:"Unknown error"})}}}]}return((ee=X.data)==null?void 0:ee.type)==="definition"?[{id:"apply",label:"Apply Workflow",icon:t.jsx(ot,{className:"h-4 w-4 mr-2"}),onClick:async K=>{var U,q,se,ne,oe;try{const fe=e.find(ye=>ye.id===K.id);if(!fe)throw new Error("Workflow definition not found");const he=E.getState(),de=((U=he.projectCanvas.getActive())==null?void 0:U.coreState.nodes)||[],pe=((q=he.projectCanvas.getActive())==null?void 0:q.coreState.selectedNodes)||[],ae=pe.length>0?pe:de;if(ae.length===0){Se.error("No nodes to apply workflow to");return}const re=new Zs,me=((se=fe.nodes)==null?void 0:se.map((ye,Ae)=>{var ke,Pe;return{id:ye.id,label:((ke=ye.parameters)==null?void 0:ke.label)||`Step ${Ae+1}`,order:((Pe=ye.parameters)==null?void 0:Pe.order)||Ae+1,stepType:ye.type,config:ye.parameters||{}}}))||[],Ne={id:`temp-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:fe.name,content:"",x:0,y:0,width:400,height:300,data:{nodeType:"workflowOrchestration",parameters:{rows:me}}};re.loadWorkflow([...ae,Ne],[]);const xe=await re.executeWorkflow(Ne.id);if(xe.success){if(xe.nodeUpdates&&xe.nodeUpdates.length>0)for(const{nodeId:ye,updates:Ae}of xe.nodeUpdates)he.updateNode(ye,Ae);Se.success("Workflow applied",{description:`Applied "${fe.name}" to ${((ne=xe.nodeUpdates)==null?void 0:ne.length)||0} nodes`})}else Se.error("Workflow execution failed",{description:((oe=xe.errors)==null?void 0:oe.map(ye=>ye.message).join(", "))||"Unknown error"})}catch(fe){Se.error("Failed to apply workflow",{description:fe instanceof Error?fe.message:"Unknown error"})}}},{id:"load",label:"Load to Canvas",icon:t.jsx(Gh,{className:"h-4 w-4 mr-2"}),onClick:K=>{try{M.loadWorkflow({definitionId:K.id,position:{x:100,y:100}}),Se.success("Workflow loaded",{description:"Loaded workflow to canvas at position (100, 100)"})}catch(U){Se.error("Failed to load workflow",{description:U instanceof Error?U.message:"Unknown error"})}}}]:null},renderNode:(X,ce,ue,ee)=>{var K,U;return((K=X.data)==null?void 0:K.type)==="section"?t.jsx("div",{className:"flex items-center gap-2 w-full",children:t.jsx("div",{className:"flex-1 font-semibold",children:ee})}):((U=X.data)==null?void 0:U.type)==="definition"?t.jsxs("div",{className:"flex items-center gap-2 w-full",children:[t.jsx(We,{"data-test":"workflow-definition-checkbox",checked:y.has(X.id),onCheckedChange:()=>G(X.id),className:"h-4 w-4 flex-shrink-0",onClick:q=>q.stopPropagation()}),t.jsx("div",{className:"flex-1",children:ee})]}):ee}})})}),f?F(f):t.jsxs("div",{className:"flex items-center gap-1 pt-2 border-t","data-test":"add-buttons-row",children:[t.jsxs(Q,{"data-test":"workflow-add-definition-button",variant:"outline",size:"sm",className:"add-definition-button flex-1",onClick:()=>w("definition"),title:"Add Workflow Definition",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Workflow"]}),n&&t.jsxs(Q,{"data-test":"workflow-add-instance-button",variant:"outline",size:"sm",className:"add-instance-button flex-1",onClick:()=>w("instance"),title:"Add Workflow Instance",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"})," Instance"]})]})]})})]})},oa=e=>{const{className:s,style:n,children:o,position:r="left"}=e;return t.jsx("div",{className:je("p-2 bg-background border shadow flex flex-col items-center space-y-2 pointer-events-auto rounded",s),style:{...n},onMouseDown:a=>a.stopPropagation(),onPointerDown:a=>a.stopPropagation(),"data-test":"canvas-vertical-toolbar","data-prevent-canvas-click":!0,children:o})},Qb=({extension:e})=>{const s=z(i=>{var c,l;return((l=(c=i.extensions)==null?void 0:c.settings)==null?void 0:l[e.id])??e.defaultSettings}),n=i=>{var l,d;(d=(l=E.getState().ext)==null?void 0:l.setSettings)==null||d.call(l,e.id,i)},o=i=>typeof i=="boolean"?i:typeof i=="function"?i(s):!1,r=async i=>{try{await i(s)}catch(c){console.error(`Error executing extension action for ${e.id}:`,c)}},a=t.jsxs("div",{className:"flex flex-col h-full","data-test":"extension-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-y-auto border-b border-border p-3","data-test":"extension-settings-container",children:Ie.createElement(e.settingsComponent,{settings:s,onSettingsChange:n})}),Object.entries(e.actions).length>0&&t.jsx("div",{className:"flex flex-col gap-2 p-3","data-test":"extension-actions-container",children:Object.entries(e.actions).map(([i,c])=>{const l=o(c.disabled),d=c.icon;return t.jsxs("button",{onClick:()=>r(c.execute),disabled:l,className:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow-xs hover:bg-primary/90 h-8 px-3 py-1.5",title:c.label,"data-test":"extension-action-button",children:[d&&t.jsx(d,{className:"h-4 w-4"}),t.jsx("span",{children:c.label})]},i)})})]});return t.jsx(cn,{popoverId:`extension-${e.id}`,icon:e.icon,tooltip:e.description||e.name,popoverTitle:e.name,popoverContent:a,leftOffset:120,dataTest:"extension-button"})},eN=({settings:e,onSettingsChange:s})=>{p.useEffect(()=>{tr("1_settings_load",e)},[e]);const n=p.useCallback((o,r)=>{s({...e,[o]:r})},[e,s]);return t.jsxs("div",{className:"flex flex-col gap-4 p-2","data-test":"journal-settings",children:[t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-project-field",children:[t.jsx(Ee,{htmlFor:"journal-project",className:"text-xs text-muted-foreground",children:"Project Name"}),t.jsx(Re,{id:"journal-project",value:e.projectName,onChange:o=>n("projectName",o.target.value),placeholder:"Journal",className:"h-8 text-sm","data-test":"journal-settings-project-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-workspace-field",children:[t.jsx(Ee,{htmlFor:"journal-workspace",className:"text-xs text-muted-foreground",children:"Workspace Name"}),t.jsx(Re,{id:"journal-workspace",value:e.workspaceName,onChange:o=>n("workspaceName",o.target.value),placeholder:Ir(),className:"h-8 text-sm","data-test":"journal-settings-workspace-input"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-canvas-field",children:[t.jsx(Ee,{htmlFor:"journal-canvas",className:"text-xs text-muted-foreground",children:"Canvas Name"}),t.jsx(Re,{id:"journal-canvas",value:e.canvasName,onChange:o=>n("canvasName",o.target.value),placeholder:Tr(),className:"h-8 text-sm","data-test":"journal-settings-canvas-input"})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 py-1","data-test":"journal-settings-autocreate-field",children:[t.jsx(Ee,{htmlFor:"journal-autocreate",className:"text-xs text-muted-foreground",children:"Create if missing"}),t.jsx(Co,{id:"journal-autocreate",checked:e.autoCreateIfMissing,onCheckedChange:o=>n("autoCreateIfMissing",o),"data-test":"journal-settings-autocreate-switch"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5","data-test":"journal-settings-template-field",children:[t.jsx(Ee,{htmlFor:"journal-template",className:"text-xs text-muted-foreground",children:"Note Template (optional)"}),t.jsx(ar,{id:"journal-template",value:e.noteTemplate??"",onChange:o=>n("noteTemplate",o.target.value),placeholder:"Enter default note content...",className:"min-h-[60px] resize-none text-sm","data-test":"journal-settings-template-input"}),t.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Text to include after the timestamp header"})]})]})};function Ir(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0");return`${s}-${n}`}function Tr(){const e=new Date,s=String(e.getFullYear()).slice(-2),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${n}-${o}`}const tN={projectName:"Journal",workspaceName:Ir(),canvasName:Tr(),autoCreateIfMissing:!0,noteTemplate:""};function tr(e,s){var a;const o=((a=E.getState().state)==null?void 0:a.projects)??{};Object.keys(o).find(i=>o[i].name===s.projectName)}function sN(){const e=new Date,s={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0};return e.toLocaleString(void 0,s)}function nN(e){var h,g,f,w;const s=E.getState(),n=((h=s.state)==null?void 0:h.projects)??{},o=e.workspaceName||Ir(),r=e.canvasName||Tr();let a=Object.keys(n).find(m=>n[m].name===e.projectName),i=!1;if(!a&&e.autoCreateIfMissing){if(a=s.project.create(e.projectName),!a)return null;i=!0}if(!a)return null;const c=(g=E.getState().state)==null?void 0:g.projects[a];if(!c)return null;let l=Object.keys(c.workspaces).find(m=>c.workspaces[m].name===o);if(!l&&i&&e.autoCreateIfMissing){const m=Object.keys(c.workspaces).find(x=>c.workspaces[x].name==="Default Workspace");m&&(s.workspace.updateMetadata(m,{name:o}),l=m)}if(!l&&e.autoCreateIfMissing&&(s.project.switch(a),l=s.workspace.create(o)??void 0,!l)||!l)return null;const d=(w=(f=E.getState().state)==null?void 0:f.projects[a])==null?void 0:w.workspaces[l];if(!d)return null;let u=Object.keys(d.canvases).find(m=>d.canvases[m].name===r);if(!u&&i&&e.autoCreateIfMissing){const m=Object.keys(d.canvases).find(x=>d.canvases[x].name==="Default Canvas");m&&(s.projectCanvas.updateMetadata(m,{name:r}),u=m)}return!u&&e.autoCreateIfMissing&&(s.project.switch(a),s.workspace.switch(l),u=s.projectCanvas.create(r)??void 0,!u)?null:u??null}function oN(e){tr("2_create_note_before",e);const s=E.getState(),n=nN(e);if(!n){console.error("[JournalExtension] Could not find or create target canvas");return}s.projectCanvas.switch(n);const r=`## ${sN()}`,a=e.noteTemplate?`${r}

${e.noteTemplate}`:r,i=`journal-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,c={id:i,type:le.TEXT,x:100,y:100,width:300,height:150,content:"",isSelected:!0,isEditing:!0};s.addNode(c,a,{dontOverlap:!0}),s.setNodeToFocusId(i),tr("2_create_note_after",e)}const aN={id:"journal",name:"Journal",icon:Ko,description:"Create timestamped notes in a dedicated canvas",settingsComponent:eN,defaultSettings:tN,version:"1.0.0",actions:{createNote:{label:"Create Note",execute:oN}}},vn=(e,s,n,o,r=!1)=>{const a=n?s:s.toLowerCase(),i=[];if(r){const c=e.split(`
`);c.forEach((l,d)=>{const u=n?l:l.toLowerCase();let h=0,g=u.indexOf(a,h);for(;g!==-1;){const f=Math.max(0,g-40),w=Math.min(l.length,g+a.length+40);let m=l.substring(f,w);f>0&&(m="..."+m),w<l.length&&(m=m+"..."),i.push({lineNumber:c.length>1?d+1:void 0,context:m,startIndex:g,field:o}),h=g+1,g=u.indexOf(a,h)}})}else{const c=n?e:e.toLowerCase();let l=0,d=c.indexOf(a,l);for(;d!==-1;){const u=Math.max(0,d-40),h=Math.min(e.length,d+a.length+40);let g=e.substring(u,h);u>0&&(g="..."+g),h<e.length&&(g=g+"..."),i.push({context:g,startIndex:d,field:o}),l=d+1,d=c.indexOf(a,l)}}return i},rN=(e,s,n,o)=>{const r=[];if(o.content&&typeof e.content=="string"&&r.push(...vn(e.content,s,n,"content",!0)),o.title&&e.title&&r.push(...vn(e.title,s,n,"title")),o.id&&e.id&&r.push(...vn(e.id,s,n,"id")),o.type&&e.type&&r.push(...vn(e.type,s,n,"type")),o.tags&&e.tags&&e.tags.length>0){const a=e.tags.map(i=>typeof i=="string"?i:i.title).join(", ");r.push(...vn(a,s,n,"tags"))}return r.length===0?null:{nodeId:e.id,node:e,matches:r}},iN=(e,s,n=new Set)=>{if(!s.query.trim())return[];if(!Object.values(s.nodeFields).some(a=>a))return[];const r=[];for(const a of e){if(n.has(a.id))continue;const i=rN(a,s.query,s.caseSensitive,s.nodeFields);i&&r.push(i)}return r},cN=e=>e.reduce((s,n)=>s+n.matches.length,0),lN=(e,s,n)=>{const o=n?s:s.toLowerCase(),a=(n?e:e.toLowerCase()).indexOf(o);return a===-1?null:{before:e.substring(0,a),matched:e.substring(a,a+s.length),after:e.substring(a+s.length)}},dN=({nodes:e,setSelectedNodes:s})=>{const[n,o]=p.useState(""),[r,a]=p.useState(!1),[i,c]=p.useState(vw),[l,d]=p.useState(new Set),[u,h]=p.useState(!1),g=p.useMemo(()=>({query:n,caseSensitive:r,nodeFields:i}),[n,r,i]),f=p.useMemo(()=>iN(e,g,l),[e,g,l]),w=p.useMemo(()=>cN(f),[f]),m=p.useCallback(b=>{d(j=>new Set(j).add(b))},[]),x=p.useCallback(()=>{d(new Set)},[]),y=p.useCallback(()=>{if(f.length>0){const b=f.map(j=>j.node);s(b)}},[f,s]),v=p.useCallback(b=>{const j=b.node;s([j]),E.getState().scrollToNode(j.id)},[s]),N=p.useCallback((b,j)=>{const R=b.node;s([R]);const S=be.LINE_HEIGHT_FIND,C=j?(j-1)*S:0;Kn(R,{highlightYOffset:C})},[s]);return{searchConfig:g,nodesWithMatches:f,totalMatchCount:w,excludedNodeIds:l,showSettings:u,setQuery:o,setCaseSensitive:a,setNodeFields:c,setShowSettings:h,removeNodeFromResults:m,clearExcludedNodes:x,handleSelectAllMatches:y,handleNodeClick:v,handleMatchClick:N}},ro=20,vc=40,bc=200,Nc=100;function Sc(e){if(e.length===0)return{x:0,y:0,width:bc,height:Nc};let s=1/0,n=1/0,o=-1/0,r=-1/0;for(const a of e){const i=a.width??bc,c=a.height??Nc;s=Math.min(s,a.x),n=Math.min(n,a.y),o=Math.max(o,a.x+i),r=Math.max(r,a.y+c)}return{x:s-ro,y:n-ro-vc,width:o-s+ro*2,height:r-n+ro*2+vc}}const uN=({nodes:e})=>{const[s,n]=p.useState(null),[o,r]=p.useState([]),[a,i]=p.useState("horizontal"),[c,l]=p.useState(null),d=p.useMemo(()=>Cw(e),[e]),u=p.useMemo(()=>Tw(e,d),[e,d]),h=p.useMemo(()=>({mode:s,selectedTagIds:o,sliceArrangement:a}),[s,o,a]),g=p.useCallback(x=>{r(y=>y.includes(x)?y.filter(v=>v!==x):[...y,x])},[]),f=p.useCallback(x=>{const y=E.getState(),v=od(e,x);if(v.length<2)return;c&&y.viewLayer.delete(c);const N=`(Unsaved) Group: ${x}`,b=y.viewLayer.create(N,{tagTitles:[x],arrangementStyle:"group"});if(!b)return;l(b);const j=Sc(v),R={id:De(10),name:x,x:j.x,y:j.y,width:j.width,height:j.height,childNodeIds:v.map(S=>S.id)};y.viewLayer.addGroupNode(b,R),n("group"),r([x])},[e,c]),w=p.useCallback(()=>{if(o.length===0)return;const x=E.getState(),y=Iw(e,o,a);if(y.updates.length===0)return;e.map(S=>({id:S.id.slice(0,6),content:typeof S.content=="string"?S.content.slice(0,20):S.type,x:S.x,y:S.y,w:S.width,h:S.height,type:S.type,groupId:S.groupId})),c&&x.viewLayer.delete(c);const v=`(Unsaved) Slice: ${o.join(", ")}`,N=x.viewLayer.create(v,{tagTitles:o,arrangementStyle:"slice",sliceArrangement:a});if(!N)return;l(N),x.viewLayer.updateNodePositions(y.updates.map(S=>({id:S.id,x:S.x,y:S.y})));const b=[];y.lanes.forEach(S=>{if(S.nodeIds.length<2)return;const M=e.filter(O=>S.nodeIds.includes(O.id)).map(O=>{const F=y.updates.find(B=>B.id===O.id);return F?{...O,x:F.x,y:F.y}:O}),I=Sc(M),A={id:De(10),name:S.tagTitle,x:I.x,y:I.y,width:I.width,height:I.height,childNodeIds:S.nodeIds};x.viewLayer.addGroupNode(N,A),b.push({tagTitle:S.tagTitle,nodeIds:S.nodeIds})});const R=E.getState().viewLayer.getNodesWithEffectivePositions();R.map(S=>({id:S.id.slice(0,6),content:typeof S.content=="string"?S.content.slice(0,20):S.type,x:S.x,y:S.y,w:S.width,h:S.height,type:S.type,groupId:S.groupId})),R.filter(S=>S.type===le.GROUP).map(S=>{var C;return{id:S.id.slice(0,6),content:S.content,x:S.x,y:S.y,w:S.width,h:S.height,childNodeIds:(C=S.data)==null?void 0:C.childNodeIds}}),n("slice")},[e,o,a,c]),m=p.useCallback(()=>{const x=E.getState();c&&(x.viewLayer.delete(c),l(null)),x.viewLayer.setActive(null),n(null),r([])},[c]);return{availableTags:d,nodesCountPerTag:u,config:h,canReset:s!==null,setMode:n,setSelectedTagIds:r,toggleTagSelection:g,setSliceArrangement:i,handleGroup:f,handleSlice:w,handleReset:m}},hN=({nodesWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemoveNode:a})=>t.jsx("div",{className:"space-y-2 max-h-[400px] overflow-y-auto","data-test":"search-results-list",children:e.map(i=>t.jsx(pN,{nodeWithMatches:i,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a},i.nodeId))}),pN=({nodeWithMatches:e,query:s,caseSensitive:n,onNodeClick:o,onMatchClick:r,onRemove:a})=>{const{node:i,matches:c,nodeId:l}=e;return t.jsx("div",{className:"border border-border rounded-md overflow-hidden","data-test":"search-result",children:t.jsxs("div",{className:"relative",children:[t.jsx("button",{onClick:()=>a(l),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"search-result-remove",children:t.jsx(Be,{className:"w-4 h-4 text-destructive"})}),t.jsxs("div",{className:"bg-background text-foreground select-none",children:[t.jsx(gN,{nodeWithMatches:e,onClick:()=>o(e)}),t.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},"data-test":"search-result-matches",children:c.map((d,u)=>t.jsx(fN,{match:d,query:s,caseSensitive:n,onClick:()=>r(e,d.lineNumber),dataTest:"search-match"},u))})]})]})})},gN=({nodeWithMatches:e,onClick:s})=>{const{node:n,matches:o}=e,r=na(n.type),a=n.id.substring(0,6),i=typeof n.content=="string"?n.content:"",c=n.title?`${n.title.substring(0,30)}${n.title.length>30?"...":""}`:i?`${i.substring(0,30)}${i.length>30?"...":""}`:"(No Content)",l=n.title&&i?`${i.substring(0,50)}${i.length>50?"...":""}`:null;return t.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:s,"data-test":"search-result-header",children:t.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[t.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[t.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[r&&t.jsx("span",{className:"flex-shrink-0",children:r}),t.jsx("span",{className:"truncate",children:c}),n.isEditing&&t.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),t.jsxs(Ze,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[o.length," ",o.length===1?"match":"matches"]})]}),t.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:a})]}),l&&t.jsx("div",{className:"text-muted-foreground text-[10px] w-full pr-1 truncate",children:l})]})})},fN=({match:e,query:s,caseSensitive:n,onClick:o,dataTest:r})=>{const a=lN(e.context,s,n);return t.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",onClick:o,"data-test":r,children:[e.lineNumber&&t.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),t.jsx("span",{className:"flex-1",children:a?t.jsxs(t.Fragment,{children:[a.before,t.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:a.matched}),a.after]}):e.context})]})},mN=({searchConfig:e,nodesWithMatches:s,totalMatchCount:n,showSettings:o,onQueryChange:r,onCaseSensitiveChange:a,onNodeFieldsChange:i,onShowSettingsChange:c,onNodeClick:l,onMatchClick:d,onRemoveNode:u,onSelectAllMatches:h})=>{const{query:g,caseSensitive:f,nodeFields:w}=e,m=f||w.title||w.id||w.type||w.tags||!w.content,x=(y,v)=>{i({...w,[y]:v})};return t.jsxs("div",{className:"space-y-3","data-test":"filter-search-section",children:[t.jsxs("div",{className:"relative flex items-center gap-1","data-test":"filter-search-input-container",children:[t.jsx(rs,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"filter-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search nodes...",value:g,onChange:y=>r(y.target.value),onKeyDown:y=>{y.key==="Enter"&&g.trim()&&(y.preventDefault(),h())},className:ve("h-8 text-sm pl-8",g?"pr-16":"pr-10"),autoFocus:!0,"data-test":"filter-search-input"}),g&&t.jsx(Q,{variant:"ghost",size:"icon",onClick:()=>r(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"filter-search-clear-button",children:t.jsx(Be,{className:"h-3 w-3"})}),m&&t.jsx("div",{className:ve("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",g?"right-16":"right-11"),"data-test":"filter-search-filter-indicator"}),t.jsx(xN,{showSettings:o,onShowSettingsChange:c,caseSensitive:f,onCaseSensitiveChange:a,nodeFields:w,onFieldChange:x})]}),g.trim()&&t.jsx(wN,{nodesWithMatches:s,totalMatchCount:n}),s.length>0&&t.jsx(hN,{nodesWithMatches:s,query:g,caseSensitive:f,onNodeClick:l,onMatchClick:d,onRemoveNode:u})]})},xN=({showSettings:e,onShowSettingsChange:s,caseSensitive:n,onCaseSensitiveChange:o,nodeFields:r,onFieldChange:a})=>t.jsxs(ht,{open:e,onOpenChange:s,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"filter-search-settings-button",children:t.jsx(Jo,{className:"h-3.5 w-3.5"})})}),t.jsx(gt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:Te.draggablePopoverDropdown},"data-test":"filter-search-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(Rs,{id:"filter-case-sensitive",label:"Case sensitive",checked:n,onChange:o,dataTest:"filter-case-sensitive-checkbox"}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx(Rs,{id:"filter-content",label:"Content",checked:r.content,onChange:i=>a("content",i),dataTest:"filter-content-checkbox"}),t.jsx(Rs,{id:"filter-title",label:"Title",checked:r.title,onChange:i=>a("title",i),dataTest:"filter-title-checkbox"}),t.jsx(Rs,{id:"filter-id",label:"ID",checked:r.id,onChange:i=>a("id",i),dataTest:"filter-id-checkbox"}),t.jsx(Rs,{id:"filter-type",label:"Type",checked:r.type,onChange:i=>a("type",i),dataTest:"filter-type-checkbox"}),t.jsx(Rs,{id:"filter-tags",label:"Tags",checked:r.tags,onChange:i=>a("tags",i),dataTest:"filter-tags-checkbox"})]})]})]})})]}),Rs=({id:e,label:s,checked:n,onChange:o,dataTest:r})=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:e,checked:n,onCheckedChange:a=>o(!!a),"data-test":r}),t.jsx("label",{htmlFor:e,className:"text-sm cursor-pointer",children:s})]}),wN=({nodesWithMatches:e,totalMatchCount:s})=>t.jsx("div",{className:"flex items-center justify-between","data-test":"filter-search-results-info",children:t.jsx("span",{className:"text-xs text-muted-foreground",children:e.length===0?"No matches found":t.jsxs(t.Fragment,{children:["Found"," ",t.jsx(Ze,{variant:"secondary",className:"mx-1",children:s}),s===1?"match":"matches"," in"," ",t.jsx(Ze,{variant:"secondary",className:"mx-1",children:e.length}),e.length===1?"node":"nodes"]})})}),yN=({availableTags:e,nodesCountPerTag:s,selectedTagIds:n,showToggle:o,onToggleTag:r,onSetSelectedTags:a})=>{const i=n.length===e.length&&e.length>0;return t.jsxs("div",{className:"space-y-2","data-test":"tags-list-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Available Tags:"}),o&&t.jsx(Q,{variant:"ghost",size:"icon",onClick:()=>{a(i?[]:e.map(c=>c.title))},className:"h-5 w-5",title:i?"Unselect all":"Select all","data-test":"tag-toggle-all-button",children:i?t.jsx(mr,{className:"h-3 w-3"}):t.jsx(Sl,{className:"h-3 w-3"})})]}),t.jsx("div",{className:"flex flex-wrap gap-1.5","data-test":"tags-list",children:e.map(c=>{const l=s.get(c.title)??0,d=n.includes(c.title);return t.jsxs(Ze,{variant:d?"default":"secondary",className:ve("text-xs transition-colors cursor-pointer hover:bg-primary/80"),onClick:()=>r(c.title),"data-test":"tag-badge",children:[c.title,t.jsxs("span",{className:"ml-1 text-[10px] opacity-70",children:["(",l,")"]})]},c.id)})})]})},vN=({availableTags:e,nodesCountPerTag:s,config:n,canReset:o,onModeChange:r,onToggleTag:a,onSetSelectedTags:i,onArrangementChange:c,onGroup:l,onSlice:d,onReset:u})=>{const{mode:h,selectedTagIds:g,sliceArrangement:f}=n;return e.length===0?t.jsx("div",{className:"text-xs text-muted-foreground py-2","data-test":"tag-organize-no-tags",children:"No tags found. Add tags to nodes to organize them."}):t.jsxs("div",{className:"space-y-3","data-test":"tag-organize-section",children:[t.jsxs("div",{className:"flex items-center gap-2","data-test":"tag-organize-actions",children:[t.jsx(Cc,{mode:"group",currentMode:h,icon:t.jsx(Fn,{className:"h-3.5 w-3.5"}),label:"Group",onClick:()=>r(h==="group"?null:"group")}),t.jsx(Cc,{mode:"slice",currentMode:h,icon:t.jsx(nn,{className:"h-3.5 w-3.5"}),label:"Slice",onClick:()=>r(h==="slice"?null:"slice")}),o&&t.jsxs(Q,{variant:"ghost",size:"sm",onClick:u,className:"h-7 text-xs","data-test":"tag-organize-reset-button",children:[t.jsx(Zo,{className:"h-3.5 w-3.5 mr-1"}),"Reset"]})]}),h&&t.jsx("div",{className:"text-xs text-muted-foreground","data-test":"tag-organize-mode-description",children:h==="group"?"Select tags, then click Apply to create groups.":"Select tags, then click Apply to create swimlanes."}),h==="slice"&&t.jsxs("div",{className:"space-y-1.5","data-test":"slice-arrangement-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lane Layout:"}),t.jsxs("div",{className:"flex gap-1","data-test":"slice-arrangement-buttons",children:[t.jsx(io,{arrangement:"horizontal",currentArrangement:f,icon:t.jsx(ws,{className:"h-3.5 w-3.5"}),onClick:()=>c("horizontal")}),t.jsx(io,{arrangement:"vertical",currentArrangement:f,icon:t.jsx(ho,{className:"h-3.5 w-3.5"}),onClick:()=>c("vertical")}),t.jsx(io,{arrangement:"grid",currentArrangement:f,icon:t.jsx(Fn,{className:"h-3.5 w-3.5"}),onClick:()=>c("grid")}),t.jsx(io,{arrangement:"masonry",currentArrangement:f,icon:t.jsx(fl,{className:"h-3.5 w-3.5"}),onClick:()=>c("masonry")})]})]}),t.jsx(yN,{availableTags:e,nodesCountPerTag:s,selectedTagIds:g,showToggle:h!==null,onToggleTag:a,onSetSelectedTags:i}),h==="group"&&g.length>0&&t.jsxs(Q,{variant:"default",size:"sm",onClick:()=>{g.forEach(w=>l(w))},className:"w-full h-8","data-test":"tag-organize-apply-group-button",children:["Apply Groups (",g.length," tags)"]}),h==="slice"&&g.length>0&&t.jsxs(Q,{variant:"default",size:"sm",onClick:d,className:"w-full h-8","data-test":"tag-organize-apply-slice-button",children:["Apply Swimlanes (",g.length," tags)"]})]})},Cc=({mode:e,currentMode:s,icon:n,label:o,onClick:r})=>{const a=s===e;return t.jsxs(Q,{variant:a?"default":"outline",size:"sm",onClick:r,className:"h-7 text-xs","data-test":"tag-organize-mode-button",children:[n,t.jsx("span",{className:"ml-1",children:o})]})},io=({arrangement:e,currentArrangement:s,icon:n,onClick:o})=>{const r=s===e;return t.jsx(Q,{variant:r?"default":"outline",size:"icon",onClick:o,className:"h-7 w-7",title:bw[e],"data-test":"slice-arrangement-button",children:n})},bN=[],NN=()=>{const e=z(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.coreState.nodes)??bN}),s=z(o=>{var a;const r=o.projectCanvas.getActive();return r!=null&&r.activeViewLayerId?((a=r.viewLayers)==null?void 0:a.find(i=>i.id===r.activeViewLayerId))??null:null});return p.useMemo(()=>{if(!s)return e;const o=new Map(s.nodePositions.map(i=>[i.nodeId,i])),r=e.map(i=>{const c=o.get(i.id);return c?{...i,x:c.x,y:c.y}:i}),a=s.groupNodes.map(i=>({id:i.id,type:le.GROUP,x:i.x,y:i.y,width:i.width,height:i.height,content:i.name,data:{childNodeIds:i.childNodeIds}}));return[...r,...a]},[e,s])},SN=()=>z(s=>{var n;return((n=s.projectCanvas.getActive())==null?void 0:n.activeViewLayerId)??null})!==null,CN=[],jN=()=>{const e=z(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.viewLayers)??CN}),s=z(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.activeViewLayerId)??null}),n=z(f=>f.viewLayer),o=p.useMemo(()=>[...e].sort((f,w)=>new Date(w.createdAt).getTime()-new Date(f.createdAt).getTime()),[e]),r=p.useMemo(()=>o.map(f=>({id:f.id,label:f.name,icon:t.jsx(Fn,{className:"h-3 w-3 text-muted-foreground"}),data:{type:"view-layer",...f}})),[o]),a=p.useCallback(f=>{n.setActive(f.id)},[n]),i=p.useCallback(()=>{n.setActive(null)},[n]),c=p.useCallback((f,w)=>{n.rename(f,w)},[n]),l=p.useCallback(f=>{n.delete(f)},[n]),d=p.useCallback(f=>`Delete view "${f.label}"? This cannot be undone.`,[]),u=p.useCallback(f=>[{id:"duplicate",label:"Duplicate",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(f.id)}}],[n]),h=p.useCallback(()=>{const f=s?e.find(x=>x.id===s):null,w=f==null?void 0:f.name.startsWith("(Unsaved) ");let m;w&&f?m=f.name.replace("(Unsaved) ",""):m=`View ${e.filter(y=>!y.name.startsWith("(Unsaved)")).length+1}`,w&&s?n.rename(s,m):n.create(m)},[e,n,s]),g=s===null;return t.jsxs("div",{className:"view-layer-manager flex flex-col h-full w-full overflow-hidden","data-test":"view-layer-manager",children:[t.jsxs("div",{className:"view-list flex-1 min-h-0 w-full overflow-y-auto overflow-x-hidden p-2","data-test":"view-list-scroll-area",children:[t.jsxs("div",{className:ve("flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",g&&"bg-primary/10 border border-primary"),onClick:i,"data-test":"base-view-item",children:[t.jsx("div",{className:"w-4 h-4 mr-2 flex-shrink-0"}),t.jsx(Yh,{className:"h-3 w-3 text-muted-foreground mr-2 flex-shrink-0"}),t.jsx("span",{className:"text-sm truncate flex-grow",children:"Base View"})]}),r.length>0&&t.jsx("div",{className:"mt-1","data-test":"saved-views-list",children:t.jsx(qs,{data:r,onItemClick:a,onUpdate:c,onDelete:l,selectedId:s,deleteConfirmMessage:d,enableEdit:!0,enableDelete:!0,enableDrag:!1,moreOptionsItems:u,dropdownZIndex:Te.draggablePopoverDropdown})})]}),t.jsx("div",{className:"border-t p-2","data-test":"view-actions",children:t.jsxs(Q,{variant:"outline",size:"sm",className:"w-full",onClick:h,"data-test":"view-save-button",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"}),"Save Current View"]})})]})},kN=()=>{const e=z(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.coreState.nodes)??[]}),s=z(f=>f.setSelectedNodes),n=SN(),[o,r]=p.useState(!1),[a,i]=p.useState(null),c=p.useRef(null),l=dN({nodes:e,setSelectedNodes:s}),d=uN({nodes:e}),u=f=>{if(f.stopPropagation(),o){r(!1);return}if(c.current){const w=c.current.getBoundingClientRect();i({x:w.left-280-16,y:w.top})}r(!0)},h=t.jsx("button",{ref:c,onClick:u,onMouseDown:f=>f.stopPropagation(),className:ve("p-1 rounded hover:bg-accent transition-colors",n&&"text-blue-500 bg-blue-500/10"),title:"Manage Views","data-test":"canvas-filter-views-button",children:t.jsx(Fn,{className:"h-3.5 w-3.5"})}),g=t.jsxs("div",{className:"flex flex-col h-full","data-test":"canvas-filter-popover-content",children:[t.jsx("div",{className:"border-b border-border p-3","data-test":"canvas-filter-search-container",children:t.jsx(mN,{searchConfig:l.searchConfig,nodesWithMatches:l.nodesWithMatches,totalMatchCount:l.totalMatchCount,showSettings:l.showSettings,onQueryChange:l.setQuery,onCaseSensitiveChange:l.setCaseSensitive,onNodeFieldsChange:l.setNodeFields,onShowSettingsChange:l.setShowSettings,onNodeClick:l.handleNodeClick,onMatchClick:l.handleMatchClick,onRemoveNode:l.removeNodeFromResults,onSelectAllMatches:l.handleSelectAllMatches})}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-3","data-test":"canvas-filter-organize-container",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Organize by Tags"}),n&&t.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded","data-test":"view-layer-active-badge",children:[t.jsx(nn,{className:"h-3 w-3"}),"View Active"]})]}),t.jsx(vN,{availableTags:d.availableTags,nodesCountPerTag:d.nodesCountPerTag,config:d.config,canReset:d.canReset,onModeChange:d.setMode,onToggleTag:d.toggleTagSelection,onSetSelectedTags:d.setSelectedTagIds,onArrangementChange:d.setSliceArrangement,onGroup:d.handleGroup,onSlice:d.handleSlice,onReset:d.handleReset})]})]});return t.jsxs(t.Fragment,{children:[t.jsx(cn,{popoverId:"canvas-filter",icon:Kh,tooltip:"Filter & Organize",popoverTitle:"Filter & Organize",popoverContent:g,leftOffset:120,initialSize:{width:360,height:500},dataTest:"canvas-filter-button",headerActions:h}),t.jsx(Ve,{isVisible:o,onClose:()=>r(!1),title:"Views",resizable:!0,initialSize:{width:280,height:350},triggerPosition:a??void 0,children:t.jsx(jN,{})})]})},AN=e=>{const{className:s,style:n}=e;return t.jsx(my,{children:t.jsxs(oa,{className:s,style:n,position:"left",children:[t.jsx(Td,{}),t.jsx(Jb,{}),t.jsx(kN,{}),t.jsx(Qb,{extension:aN})]})})},IN=()=>{const e=z(i=>i.uiState.mode),s=z(i=>i.uiState.selectFromDrawMode),{setMode:n,setUiState:o}=E.getState(),r=e===J.SELECT&&s,a=()=>{r?(o(i=>({...i,selectFromDrawMode:!1})),E.getState().setSelectedNodes([]),E.getState().arrow.setSelected([]),n(J.DRAW)):(o(i=>({...i,selectFromDrawMode:!0})),n(J.SELECT))};return t.jsx(Q,{variant:r?"default":"outline",size:"icon",onPointerUp:a,title:r?"Back to Draw Mode":"Select Mode (select/drag nodes)","data-test":"draw-mode-select-button",children:t.jsx(tl,{className:"h-4 w-4"})})},aa=()=>"right",TN=()=>{const[e,s]=p.useState(!1),n=z(h=>h.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=E.getState(),a=(n==null?void 0:n.strokeColor)??"currentColor",i=a==="currentColor"?"hsl(var(--foreground))":a,c=(n==null?void 0:n.opacity)??1,l=c<1,d=h=>{o({strokeColor:h}),r(l?g=>({...g,markerStrokeColor:h}):g=>({...g,penStrokeColor:h}))},u=h=>{o({opacity:h[0]})};return t.jsxs(ht,{open:e,onOpenChange:s,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"outline",size:"icon",title:`Stroke Color (${Math.round(c*100)}% opacity)`,"data-test":"draw-mode-stroke-color-button",children:t.jsx("span",{style:{width:"16px",height:"16px",borderRadius:"3px",backgroundColor:i,opacity:c,border:"1px solid hsl(var(--border))"}})})}),t.jsx(gt,{className:"w-auto p-0",side:aa(),sideOffset:8,onCloseAutoFocus:h=>h.preventDefault(),"data-test":"draw-mode-stroke-color-popover",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx(Ar,{label:"Stroke Color",currentColor:a,onColorSelect:d}),t.jsxs("div",{className:"px-3 pb-3 space-y-2","data-test":"draw-mode-opacity-section",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(c*100),"%"]})]}),t.jsx(Yt,{value:[c],min:.1,max:1,step:.05,onValueChange:u,className:"w-full","data-test":"draw-mode-opacity-slider"})]})]})})]})},EN=[1,2,3,4,5,6,8,10,12,16,20,28,40,60],RN=()=>{const[e,s]=p.useState(!1),n=z(l=>l.uiState.drawStyle),{setDrawStyle:o,setUiState:r}=E.getState(),a=(n==null?void 0:n.strokeWidth)??La,i=((n==null?void 0:n.opacity)??1)<1,c=l=>{o({strokeWidth:l}),r(i?d=>({...d,markerStrokeWidth:l}):d=>({...d,penStrokeWidth:l})),s(!1)};return t.jsxs(ht,{open:e,onOpenChange:s,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"outline",size:"icon",title:`Stroke Width: ${a}px`,"data-test":"draw-mode-stroke-width-button",children:t.jsxs("div",{className:"flex flex-col gap-[2px] items-center",children:[t.jsx("span",{style:{width:"14px",height:"1px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"2px",backgroundColor:"currentColor"}}),t.jsx("span",{style:{width:"14px",height:"4px",backgroundColor:"currentColor",borderRadius:"1px"}})]})})}),t.jsx(gt,{className:"w-auto p-3",side:aa(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-stroke-width-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-width-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Width"}),t.jsx("div",{className:"flex gap-1 flex-wrap max-w-[200px]",children:EN.map(l=>t.jsxs("button",{type:"button",title:`${l}px`,onClick:()=>c(l),className:`w-10 h-8 flex items-center justify-center gap-1 rounded border cursor-pointer hover:bg-accent ${a===l?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-stroke-width-button",children:[t.jsx("span",{style:{width:"12px",height:`${Math.min(l,8)}px`,backgroundColor:"currentColor",borderRadius:"1px"}}),t.jsx("span",{className:"text-[10px] text-muted-foreground",children:l})]},l))})]})})]})},MN=[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"dotted",label:"Dotted"}],jc=({style:e})=>{const s=e==="dashed"?"4,3":e==="dotted"?"1,3":void 0;return t.jsx("svg",{width:"16",height:"8",viewBox:"0 0 16 8",children:t.jsx("line",{x1:"0",y1:"4",x2:"16",y2:"4",stroke:"currentColor",strokeWidth:"2",strokeDasharray:s,strokeLinecap:"round"})})},PN=()=>{const[e,s]=p.useState(!1),n=z(c=>c.uiState.drawStyle),{setDrawStyle:o}=E.getState(),r=(n==null?void 0:n.strokeStyle)??"solid",a=c=>{o({strokeStyle:c}),s(!1)},i=c=>{s(c)};return t.jsxs(ht,{open:e,onOpenChange:i,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"outline",size:"icon",title:`Stroke Style: ${r}`,"data-test":"draw-mode-stroke-style-button",onPointerDown:c=>{c.stopPropagation()},onPointerUp:c=>{c.stopPropagation()},children:t.jsx(jc,{style:r})})}),t.jsx(gt,{className:"w-auto p-3",side:aa(),sideOffset:8,onCloseAutoFocus:c=>c.preventDefault(),"data-test":"draw-mode-stroke-style-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-stroke-style-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Stroke Style"}),t.jsx("div",{className:"flex gap-1",children:MN.map(c=>t.jsx("button",{type:"button",title:c.label,onClick:()=>a(c.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${r===c.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-stroke-style-option",children:t.jsx(jc,{style:c.value})},c.value))})]})})]})},DN=()=>t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:t.jsx("ellipse",{cx:"8",cy:"8",rx:"7",ry:"4"})}),kc=[{value:Ce.SQUARE,label:"Square",icon:t.jsx(Sl,{className:"h-4 w-4"})},{value:Ce.RECTANGLE,label:"Rectangle",icon:t.jsx($t,{className:"h-4 w-4"})},{value:Ce.CIRCLE,label:"Circle",icon:t.jsx(qo,{className:"h-4 w-4"})},{value:Ce.ELLIPSE,label:"Ellipse",icon:t.jsx(DN,{})},{value:Ce.ARROW,label:"Arrow",icon:t.jsx(Jh,{className:"h-4 w-4"})}],ON=()=>{const[e,s]=p.useState(!1),n=z(l=>l.uiState.drawSubMode),{setDrawSubMode:o,setDrawStyle:r}=E.getState(),a=n&&[Ce.SQUARE,Ce.RECTANGLE,Ce.CIRCLE,Ce.ELLIPSE,Ce.ARROW].includes(n),i=kc.find(l=>l.value===n),c=l=>{o(l),r({opacity:1}),s(!1)};return t.jsxs(ht,{open:e,onOpenChange:s,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:a?"default":"outline",size:"icon",title:i?`Shape: ${i.label}`:"Shapes","data-test":"draw-mode-shape-button",children:a&&i?i.icon:t.jsx(Zh,{className:"h-4 w-4"})})}),t.jsx(gt,{className:"w-auto p-3",side:aa(),sideOffset:8,onCloseAutoFocus:l=>l.preventDefault(),"data-test":"draw-mode-shape-popover",children:t.jsxs("div",{className:"space-y-2","data-test":"draw-mode-shape-content",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Shapes"}),t.jsx("div",{className:"flex gap-1",children:kc.map(l=>t.jsx("button",{type:"button",title:l.label,onClick:()=>c(l.value),className:`w-10 h-8 flex items-center justify-center rounded border cursor-pointer hover:bg-accent ${n===l.value?"ring-2 ring-ring ring-offset-1 border-primary":"border-muted"}`,"data-test":"draw-mode-shape-button",children:l.icon},l.value))}),t.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Click to switch to shape mode. Drag to draw."})]})})]})},LN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=z(R=>R.uiState.drawStyle),i=z(R=>R.uiState.penStrokeWidth)??La,c=z(R=>R.uiState.markerStrokeWidth)??vu,l=z(R=>R.uiState.penStrokeColor)??"currentColor",d=z(R=>R.uiState.markerStrokeColor)??Z.drawing.markerColor,u=z(R=>R.uiState.drawAxisLock)??"none",{setDrawStyle:h,setDrawAxisLock:g,setUiState:f,setDrawSubMode:w}=E.getState(),m=((a==null?void 0:a.opacity)??1)<1,x=(a==null?void 0:a.strokeWidth)??La,y=(a==null?void 0:a.strokeColor)??"currentColor",v=()=>{m?(f(R=>({...R,markerStrokeWidth:x,markerStrokeColor:y})),h({opacity:1,strokeWidth:i,strokeColor:l})):(f(R=>({...R,penStrokeWidth:x,penStrokeColor:y})),h({opacity:Z.drawing.markerOpacity,strokeWidth:c,strokeColor:d}),w(Ce.FREEHAND))},N=R=>{if(R.stopPropagation(),e){s(!1);return}if(r.current){const S=r.current.getBoundingClientRect();o({x:S.right+8,y:S.top})}s(!0)},b=R=>{g(R?"horizontal":"none")},j=R=>{g(R?"vertical":"none")};return t.jsxs("div",{ref:r,className:"relative inline-flex group","data-test":"draw-mode-marker-container",children:[t.jsx(Q,{variant:m?"default":"outline",size:"icon",onPointerUp:v,title:m?"Marker Mode (On)":"Marker Mode (Off)","data-test":"draw-mode-marker-toggle",children:t.jsx(nl,{className:"h-4 w-4"})}),t.jsxs("div",{className:ve("absolute right-0 top-0 bottom-0 translate-x-full","flex items-stretch","opacity-0 group-hover:opacity-100 transition-opacity duration-150","pointer-events-none group-hover:pointer-events-auto"),"data-test":"draw-mode-marker-caret-trigger",children:[t.jsx("div",{className:"w-[3px] bg-foreground/10"}),t.jsx("button",{type:"button",onClick:N,className:ve("flex items-center justify-center","px-1 rounded-r-md","bg-foreground/5 hover:bg-foreground/10","transition-colors duration-150","cursor-pointer"),"aria-label":"Drawing options",title:"Drawing options","data-test":"draw-mode-marker-caret-button",children:t.jsx(on,{className:"h-3 w-3 text-foreground/60"})})]}),t.jsx(Ve,{isVisible:e,onClose:()=>s(!1),title:"Drawing Options",initialPosition:n??{x:100,y:100},showPinButton:!1,showInspectorButton:!1,children:t.jsx("div",{className:"p-3 space-y-4","data-test":"draw-mode-options-popover-content",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:"Axis Lock"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Lock drawing to a straight line"}),t.jsxs("div",{className:"space-y-2 mt-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"lock-horizontal",checked:u==="horizontal",onCheckedChange:b,"data-test":"draw-mode-lock-horizontal-checkbox"}),t.jsx(Ee,{htmlFor:"lock-horizontal",className:"text-sm font-normal cursor-pointer",children:"Lock Horizontal (constant Y)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"lock-vertical",checked:u==="vertical",onCheckedChange:j,"data-test":"draw-mode-lock-vertical-checkbox"}),t.jsx(Ee,{htmlFor:"lock-vertical",className:"text-sm font-normal cursor-pointer",children:"Lock Vertical (constant X)"})]})]})]})})})]})},WN=e=>{const{className:s}=e,{setMode:n,undo:o}=E.getState(),r=z(u=>u.undo.canUndo()),a=z(u=>u.undo.canRedo()),i=()=>{E.getState().setUiState(u=>({...u,selectFromDrawMode:!1})),n(J.SELECT)},c=()=>{o.undo()},l=()=>{o.redo()};return t.jsxs(oa,{position:"left",className:s,children:[t.jsx(Q,{variant:"outline",size:"icon",onPointerUp:i,title:"Exit Draw Mode (Esc)","data-test":"draw-mode-exit-button",children:t.jsx(Be,{className:"h-5 w-5"})}),t.jsx(IN,{}),t.jsx(TN,{}),t.jsx(RN,{}),t.jsx(PN,{}),t.jsx(ON,{}),t.jsx(LN,{}),t.jsx(_n,{expandContent:t.jsx(Ho,{onSelect:u=>o.jumpTo(u)}),expandTitle:"History",onClick:c,onHoldRepeat:c,holdRepeatInterval:Z.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!r,title:"Undo (Ctrl+Z) - Hold to repeat",dataTest:"draw-mode-undo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(Xh,{className:"h-5 w-5"})}),t.jsx(_n,{expandContent:t.jsx(Ho,{onSelect:u=>o.jumpTo(u)}),expandTitle:"History",onClick:l,onHoldRepeat:l,holdRepeatInterval:Z.history.holdRepeatIntervalMs,variant:"outline",size:"icon",disabled:!a,title:"Redo (Ctrl+Y) - Hold to repeat",dataTest:"draw-mode-redo-button",popoverSize:{width:280,height:250},expandDirection:"right",headerActions:t.jsxs(t.Fragment,{children:[t.jsx(Fo,{}),t.jsx($o,{}),t.jsx(Bo,{})]}),children:t.jsx(qh,{className:"h-5 w-5"})})]})},HN=Ie.memo(WN),Ac="paper-texture-live-config",BN="paper-texture-saved-presets";function FN({onTextureChange:e}){return t.jsx(cn,{popoverId:"paper-texture-config",icon:Qh,tooltip:"Paper Texture Live Preview",popoverTitle:"Paper Texture",initialSize:{width:320,height:420},leftOffset:120,buttonVariant:"ghost",buttonSize:"icon",dataTest:"paper-texture-config-button",popoverContent:t.jsx($N,{onTextureChange:e})})}function $N({onTextureChange:e}){const[s,n]=p.useState(()=>{try{const a=localStorage.getItem(Ac);if(a)return JSON.parse(a)}catch{}return{params:Xc.medium,activePreset:"medium"}}),[o,r]=p.useState(()=>{var i,c,l;const a=(l=(c=(i=E.getState().preferences)==null?void 0:i.canvasConfig)==null?void 0:c.background)==null?void 0:l.savedPresets;if(a&&a.length>0)return a;try{const d=localStorage.getItem(BN);if(d){const u=JSON.parse(d);return u.length>0&&E.setState(h=>{var g,f,w;return{...h,preferences:{...h.preferences,canvasConfig:{...(g=h.preferences)==null?void 0:g.canvasConfig,background:{...(w=(f=h.preferences)==null?void 0:f.canvasConfig)==null?void 0:w.background,savedPresets:u}}}}}),u}}catch{}return Z.background.savedPresets});return p.useEffect(()=>{localStorage.setItem(Ac,JSON.stringify(s))},[s]),p.useEffect(()=>{E.setState(a=>{var i,c,l;return{...a,preferences:{...a.preferences,canvasConfig:{...(i=a.preferences)==null?void 0:i.canvasConfig,background:{...(l=(c=a.preferences)==null?void 0:c.canvasConfig)==null?void 0:l.background,savedPresets:o}}}}}),Z.background.savedPresets=o},[o]),t.jsx(zN,{config:s,setConfig:n,savedPresets:o,setSavedPresets:r,onTextureChange:e})}function zN({config:e,setConfig:s,savedPresets:n,setSavedPresets:o,onTextureChange:r}){const{params:a,activePreset:i}=e,[c,l]=p.useState(null),[d,u]=p.useState(""),{theme:h}=qc(),g=p.useMemo(()=>h==="dark"?!0:h==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[h]),f=100-a.bgLightness;p.useEffect(()=>{E.setState(S=>{var C;return{...S,preferences:{...S.preferences,canvasConfig:{...(C=S.preferences)==null?void 0:C.canvasConfig,background:{paperTexture:typeof i=="string"&&!lo.includes(i)?"custom":i,customParams:a}}}}}),Z.background.paperTexture=typeof i=="string"&&!lo.includes(i)?"custom":i,Z.background.customParams=a},[a,i]);const w=(S,C)=>{s(M=>({...M,params:{...M.params,[S]:C},activePreset:"custom"}))},m=S=>{S!=="custom"&&(s({params:Xc[S],activePreset:S}),r==null||r(S))},x=S=>{s({params:S.params,activePreset:S.id})},y=()=>{m("none")},v=()=>{const S={id:`preset-${Date.now()}`,name:`Preset ${n.length+1}`,params:{...a}};o(C=>[...C,S]),s(C=>({...C,activePreset:S.id}))},N=S=>{o(C=>C.filter(M=>M.id!==S)),i===S&&m("none")},b=S=>{l(S.id),u(S.name)},j=()=>{c&&d.trim()&&o(S=>S.map(C=>C.id===c?{...C,name:d.trim()}:C)),l(null),u("")},R=()=>{l(null),u("")};return t.jsxs("div",{className:"texture-config space-y-4 p-4","data-test":"texture-config",children:[t.jsxs("div",{className:"presets","data-test":"texture-presets",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx(Ee,{className:"text-xs text-muted-foreground uppercase",children:"Presets"}),t.jsxs("div",{className:"flex gap-1",children:[t.jsxs(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:v,"data-test":"save-preset",children:[t.jsx(Jt,{className:"w-3 h-3 mr-1"}),"Save"]}),t.jsxs(Q,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:y,"data-test":"reset-texture",children:[t.jsx(Zo,{className:"w-3 h-3 mr-1"}),"Reset"]})]})]}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:lo.filter(S=>S!=="custom").map(S=>t.jsx(Q,{variant:i===S?"default":"outline",size:"sm",className:"h-7 text-xs",onClick:()=>m(S),"data-test":"paper-texture-preset-button",children:Zc[S]},S))})]}),n.length>0&&t.jsxs("div",{className:"saved-presets","data-test":"saved-presets",children:[t.jsx(Ee,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Saved"}),t.jsx("div",{className:"space-y-1",children:n.map(S=>t.jsx("div",{className:"flex items-center gap-1","data-test":"paper-texture-saved-preset",children:c===S.id?t.jsxs(t.Fragment,{children:[t.jsx(Re,{value:d,onChange:C=>u(C.target.value),className:"h-7 text-xs flex-1",onKeyDown:C=>{C.key==="Enter"&&j(),C.key==="Escape"&&R()},autoFocus:!0,"data-test":"preset-name-input"}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:j,"data-test":"save-preset-name",children:t.jsx(Ys,{className:"w-3 h-3"})}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:R,"data-test":"cancel-edit",children:t.jsx(Be,{className:"w-3 h-3"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(Q,{variant:i===S.id?"default":"outline",size:"sm",className:"h-7 text-xs flex-1 justify-start",onClick:()=>x(S),"data-test":"load-saved-preset",children:S.name}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>b(S),"data-test":"edit-preset",children:t.jsx(Nl,{className:"w-3 h-3"})}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:()=>N(S.id),"data-test":"delete-preset",children:t.jsx(yt,{className:"w-3 h-3"})})]})},S.id))})]}),t.jsxs("div",{className:"controls space-y-3","data-test":"texture-controls",children:[t.jsx(Ee,{className:"text-xs text-muted-foreground uppercase",children:"Texture"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-frequency",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Ee,{className:"text-xs",children:"Frequency"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.baseFrequency.toFixed(2)})]}),t.jsx(Yt,{value:[a.baseFrequency],onValueChange:([S])=>w("baseFrequency",S),min:.1,max:2,step:.05})]}),t.jsxs("div",{className:"control-group","data-test":"control-octaves",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Ee,{className:"text-xs",children:"Octaves"}),t.jsx("span",{className:"text-xs text-muted-foreground font-mono",children:a.numOctaves})]}),t.jsx(Yt,{value:[a.numOctaves],onValueChange:([S])=>w("numOctaves",S),min:1,max:6,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-opacity",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Ee,{className:"text-xs",children:"Opacity"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[(a.opacity*100).toFixed(0),"%"]})]}),t.jsx(Yt,{value:[a.opacity],onValueChange:([S])=>w("opacity",S),min:0,max:.8,step:.05})]})]})]}),t.jsxs("div",{className:"bg-controls space-y-3","data-test":"bg-controls",children:[t.jsx(Ee,{className:"text-xs text-muted-foreground uppercase",children:"Background"}),t.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[t.jsxs("div",{className:"control-group","data-test":"control-hue",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Ee,{className:"text-xs",children:"Hue"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgHue,"°"]})]}),t.jsx(Yt,{value:[a.bgHue],onValueChange:([S])=>w("bgHue",S),min:0,max:360,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-saturation",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Ee,{className:"text-xs",children:"Saturation"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgSaturation,"%"]})]}),t.jsx(Yt,{value:[a.bgSaturation],onValueChange:([S])=>w("bgSaturation",S),min:0,max:100,step:1})]}),t.jsxs("div",{className:"control-group","data-test":"control-lightness",children:[t.jsxs("div",{className:"flex justify-between mb-1",children:[t.jsx(Ee,{className:"text-xs",children:"Lightness"}),t.jsxs("span",{className:"text-xs text-muted-foreground font-mono",children:[a.bgLightness,"%"]})]}),t.jsx(Yt,{value:[a.bgLightness],onValueChange:([S])=>w("bgLightness",S),min:0,max:100,step:1})]})]})]}),t.jsxs("div",{className:"preview","data-test":"texture-preview",children:[t.jsx(Ee,{className:"text-xs text-muted-foreground uppercase mb-2 block",children:"Preview"}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{className:"relative","data-test":"preview-light",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(ep,{className:`w-3 h-3 ${g?"text-muted-foreground":"text-primary"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${g?"":"ring-2 ring-primary"}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${a.bgLightness}%)`},"data-test":"preview-swatch-light",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-light"})})]}),t.jsxs("div",{className:"relative","data-test":"preview-dark",children:[t.jsx("div",{className:"absolute top-1 left-1 z-10",children:t.jsx(tp,{className:`w-3 h-3 ${g?"text-primary":"text-muted-foreground"}`})}),t.jsx("div",{className:`h-14 rounded border relative overflow-hidden ${g?"ring-2 ring-primary":""}`,style:{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${f}%)`},"data-test":"preview-swatch-dark",children:a.opacity>0&&t.jsx("div",{className:"absolute inset-0",style:{opacity:a.opacity,backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`},"data-test":"preview-texture-dark"})})]})]})]})]})}function Ic({title:e,action:s,isOpen:n}){return t.jsxs("div",{"data-test":"settings-section-header",className:"border-b pb-1 mb-3 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(Ct,{className:ve("h-3 w-3 text-muted-foreground transition-transform",!n&&"-rotate-90")}),t.jsx("h3",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:e})]}),s]})}function _N(){var S;const[e,s]=p.useState(""),[n,o]=p.useState(new Set),r=C=>{o(M=>{const I=new Set(M);return I.has(C)?I.delete(C):I.add(C),I})},a=z(C=>{var M,I;return((I=(M=C.preferences)==null?void 0:M.arrangeButton)==null?void 0:I.nodeGap)??be.ARRANGE_NODE_GAP}),i=z(C=>{var M,I;return((I=(M=C.preferences)==null?void 0:M.arrangeButton)==null?void 0:I.gridColumns)??be.ARRANGE_GRID_COLUMNS}),c=z(C=>C.getArrangeGridRows()),l=z(C=>C.setArrangeNodeGap),d=z(C=>C.setArrangeGridColumns),u=z(C=>C.setArrangeGridRows),h=async C=>{Z.persistState=!!C.persistState,Z.autosave=!!C.autosave,Z.hideOverlay=!!C.hideOverlay,Z.hideToolbar=!!C.hideToolbar,Z.background.paperTexture=C.backgroundPaperTexture,Z.arrows.type=C.arrowType,Z.arrows.REVERSE_CURVE=!!C.arrowReverseCurve,Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=Number(C.arrowSShapeFactor),Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=!!C.arrowSShapeReversed,Z.arrows.CUBIC_HORIZONTAL_BIAS=Number(C.arrowHorizontalBias),Z.arrows.reverseArrowOnMultipleConnect=!!C.arrowReverseOnMultipleConnect,Z.highlightAndCreate.createConnectingArrow=!!C.highlightCreateArrow,Z.highlightAndCreate.createHighlight=!!C.highlightCreateHighlight,Z.nodeOptions.maxNodeWidth=Number(C.nodeMaxWidth),Z.nodeOptions.resizeBorderWidth=Number(C.nodeResizeBorderWidth),Z.zoom.min=Number(C.zoomMin),Z.zoom.max=Number(C.zoomMax),Z.zoom.intensity=Number(C.zoomIntensity),Z.history.historyLimit=Number(C.historyLimit),Z.history.tabletHistoryLimit=Number(C.tabletHistoryLimit),Z.history.archiveLimit=Number(C.archiveLimit),Z.history.tabletArchiveLimit=Number(C.tabletArchiveLimit),Z.holdToSelect.holdDurationMs=Number(C.holdDurationMs),Z.holdToSelect.movementThresholdPx=Number(C.holdMovementThresholdPx),Z.holdToSelect.indicatorDelayMs=Number(C.holdIndicatorDelayMs),Z.holdToSelect.indicatorTopOffset=Number(C.holdIndicatorTopOffset),Z.holdToSelect.indicatorBottomOffset=Number(C.holdIndicatorBottomOffset),E.setState(M=>{var I,A,O;return{...M,preferences:{...M.preferences,splitNodeGap:Number(C.splitNodeGap),canvasConfig:{...(I=M.preferences)==null?void 0:I.canvasConfig,persistState:!!C.persistState,autosave:!!C.autosave,hideOverlay:!!C.hideOverlay,hideToolbar:!!C.hideToolbar,background:{...(O=(A=M.preferences)==null?void 0:A.canvasConfig)==null?void 0:O.background,paperTexture:C.backgroundPaperTexture},arrows:{type:C.arrowType,REVERSE_CURVE:!!C.arrowReverseCurve,CUBIC_ARROW_S_SHAPE_FACTOR:Number(C.arrowSShapeFactor),CUBIC_ARROW_S_SHAPE_REVERSED:!!C.arrowSShapeReversed,CUBIC_HORIZONTAL_BIAS:Number(C.arrowHorizontalBias),reverseArrowOnMultipleConnect:!!C.arrowReverseOnMultipleConnect},nodeOptions:{maxNodeWidth:Number(C.nodeMaxWidth),resizeBorderWidth:Number(C.nodeResizeBorderWidth)},zoom:{min:Number(C.zoomMin),max:Number(C.zoomMax),intensity:Number(C.zoomIntensity)}}},uiState:{...M.uiState,isOverlayVisible:!C.hideOverlay,toolbar:{...M.uiState.toolbar,isVisible:!C.hideToolbar}}}}),Se.success("Settings saved!",{description:"Canvas configuration has been updated.",duration:3e3})},g=[{title:"Persistence",fields:[{name:"persistState",label:"Persist State",type:"checkbox"},{name:"autosave",label:"Autosave",type:"checkbox"}]},{title:"UI",fields:[{name:"hideOverlay",label:"Hide Overlay",type:"checkbox"},{name:"hideToolbar",label:"Hide Toolbar",type:"checkbox"}]},{title:"Background",fields:[{name:"backgroundPaperTexture",label:"Paper Texture",type:"select",options:lo.map(C=>({value:C,label:Zc[C]}))}]},{title:"Highlight & Create ($)",fields:[{name:"highlightCreateArrow",label:"Create Connecting Arrow",type:"checkbox"},{name:"highlightCreateHighlight",label:"Create Highlight",type:"checkbox"}]},{title:"Arrows",fields:[{name:"arrowType",label:"Type",type:"select",options:bu.map(C=>({value:C,label:Nu[C]}))},{name:"arrowSShapeFactor",label:"S-Shape Factor",type:"number",placeholder:"0-2",step:.1},{name:"arrowHorizontalBias",label:"Horizontal Bias",type:"number",placeholder:"0=auto, 1=none",step:.1},{name:"arrowReverseCurve",label:"Reverse Curve",type:"checkbox"},{name:"arrowSShapeReversed",label:"S-Shape Reversed",type:"checkbox"},{name:"arrowReverseOnMultipleConnect",label:"Reverse on Multiple Connect",type:"checkbox"}]},{title:"Nodes",fields:[{name:"nodeMaxWidth",label:"Max Width (px)",type:"number",placeholder:"100-2000"},{name:"nodeResizeBorderWidth",label:"Resize Border Width (px)",type:"number",placeholder:"1-50"},{name:"splitNodeGap",label:"Split Node Gap (px)",type:"number",placeholder:"0-100"}]},{title:"Zoom",fields:[{name:"zoomMin",label:"Min",type:"number",placeholder:"0.01-1"},{name:"zoomMax",label:"Max",type:"number",placeholder:"1-10"},{name:"zoomIntensity",label:"Intensity",type:"number",placeholder:"0.01-1"}]},{title:"Hold-to-Select (Phone)",fields:[{name:"holdDurationMs",label:"Hold Duration (ms)",type:"number",placeholder:"500-3000"},{name:"holdMovementThresholdPx",label:"Movement Threshold (px)",type:"number",placeholder:"5-50"},{name:"holdIndicatorDelayMs",label:"Indicator Delay (ms)",type:"number",placeholder:"0-500"},{name:"holdIndicatorTopOffset",label:"Indicator Top Offset (px)",type:"number",placeholder:"0-100"},{name:"holdIndicatorBottomOffset",label:"Indicator Bottom Offset (px)",type:"number",placeholder:"0-150"}]}],[f,w]=p.useState(!1);p.useEffect(()=>{const C=()=>w(window.innerWidth<1280);return C(),window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[]);const m={title:"History",fields:f?[{name:"tabletHistoryLimit",label:"In-Memory Limit",type:"number",placeholder:"10-200"},{name:"tabletArchiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-1000"}]:[{name:"historyLimit",label:"In-Memory Limit",type:"number",placeholder:"10-500"},{name:"archiveLimit",label:"Archive Limit (IndexedDB)",type:"number",placeholder:"100-2000"}]},x=[...g,m],y=p.useMemo(()=>{const C=x.map(M=>M.title);return C.push("Arrange"),C},[x]),v=()=>o(new Set(y)),N=()=>o(new Set),b=p.useMemo(()=>{if(!e.trim())return x;const C=e.toLowerCase();return x.filter(M=>M.title.toLowerCase().includes(C))},[x,e]),j=p.useMemo(()=>e.trim()?"arrange".includes(e.toLowerCase()):!0,[e]),R={persistState:Z.persistState,autosave:Z.autosave,hideOverlay:Z.hideOverlay,hideToolbar:Z.hideToolbar,backgroundPaperTexture:Z.background.paperTexture,highlightCreateArrow:Z.highlightAndCreate.createConnectingArrow,highlightCreateHighlight:Z.highlightAndCreate.createHighlight,arrowType:Z.arrows.type,arrowReverseCurve:Z.arrows.REVERSE_CURVE,arrowSShapeFactor:Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,arrowSShapeReversed:Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,arrowHorizontalBias:Z.arrows.CUBIC_HORIZONTAL_BIAS,arrowReverseOnMultipleConnect:Z.arrows.reverseArrowOnMultipleConnect,nodeMaxWidth:Z.nodeOptions.maxNodeWidth,nodeResizeBorderWidth:Z.nodeOptions.resizeBorderWidth,splitNodeGap:((S=E.getState().preferences)==null?void 0:S.splitNodeGap)??be.NEW_NODE_SEGMENT_SPACING,zoomMin:Z.zoom.min,zoomMax:Z.zoom.max,zoomIntensity:Z.zoom.intensity,historyLimit:Z.history.historyLimit,tabletHistoryLimit:Z.history.tabletHistoryLimit,archiveLimit:Z.history.archiveLimit,tabletArchiveLimit:Z.history.tabletArchiveLimit,holdDurationMs:Z.holdToSelect.holdDurationMs,holdMovementThresholdPx:Z.holdToSelect.movementThresholdPx,holdIndicatorDelayMs:Z.holdToSelect.indicatorDelayMs,holdIndicatorTopOffset:Z.holdToSelect.indicatorTopOffset,holdIndicatorBottomOffset:Z.holdToSelect.indicatorBottomOffset};return t.jsxs(Gs,{className:"h-full",children:[t.jsx("div",{className:"sticky top-0 z-10 bg-background p-3 pb-2 border-b","data-test":"settings-search-header",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(rs,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),t.jsx(Re,{type:"text",placeholder:"Search settings...",value:e,onChange:C=>s(C.target.value),className:"h-7 pl-7 text-xs","data-test":"settings-search-input"})]}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:N,title:"Expand all sections","data-test":"settings-expand-all-button",children:t.jsx(sp,{className:"h-4 w-4"})}),t.jsx(Q,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:v,title:"Collapse all sections","data-test":"settings-collapse-all-button",children:t.jsx(np,{className:"h-4 w-4"})})]})}),t.jsxs(Pp,{onSubmit:h,defaultValues:R,className:"p-3 space-y-4",formId:"canvas-settings-form",children:[b.map(C=>{const M=!n.has(C.title);return t.jsxs(gs,{open:M,onOpenChange:()=>r(C.title),"data-test":"settings-section-collapsible",children:[t.jsx(fs,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:I=>{I.altKey&&(I.preventDefault(),v())},children:t.jsx(Ic,{title:C.title,action:C.title==="Background"?t.jsx(FN,{}):void 0,isOpen:M})})}),t.jsx(ms,{children:t.jsx(Dp,{fields:C.fields,layout:"two-column",className:"space-y-2",labelClassName:"text-xs"})})]},C.title)}),j&&t.jsxs(gs,{open:!n.has("Arrange"),onOpenChange:()=>r("Arrange"),"data-test":"settings-section-arrange",children:[t.jsx(fs,{asChild:!0,children:t.jsx("button",{type:"button",className:"w-full text-left cursor-pointer",onClick:C=>{C.altKey&&(C.preventDefault(),v())},children:t.jsx(Ic,{title:"Arrange",isOpen:!n.has("Arrange")})})}),t.jsx(ms,{children:t.jsx(Nr,{nodeGap:a,gridColumns:i,gridRows:c,onNodeGapChange:l,onGridColumnsChange:d,onGridRowsChange:u,showRows:!0})})]})]})]})}const VN=()=>{const e=E.getState(),s=e.exportCanvasData,n=e.importCanvasData,o=p.useRef(null),[r,a]=p.useState(!1),[i,c]=p.useState(!1),[l,d]=p.useState(null),u=()=>{var g;(g=o.current)==null||g.click()},h=g=>{var m;const f=(m=g.target.files)==null?void 0:m[0];if(!f)return;a(!0),d(null);const w=new FileReader;w.onload=x=>{var v;const y=(v=x.target)==null?void 0:v.result;if(typeof y=="string"){const N=n(y,{replace:i});d(N),N.projectsImported>0&&Se.success(`Successfully imported ${N.projectsImported} project${N.projectsImported>1?"s":""}`),N.projectsSkipped>0&&Se.warning(`Skipped ${N.projectsSkipped} project${N.projectsSkipped>1?"s":""} (already exist)`),N.projectsImported===0&&N.projectsSkipped===0&&Se.error("No projects found in the import file")}else console.error("Failed to read file content."),Se.error("Failed to read file content");a(!1),o.current&&(o.current.value="")},w.onerror=x=>{console.error("Error reading file:",x),Se.error("Error reading file"),a(!1),o.current&&(o.current.value="")},w.readAsText(f)};return t.jsxs("div",{className:"space-y-4","data-test":"data-io-panel",children:[t.jsxs("div",{"data-test":"data-export-section",children:[t.jsx(Ee,{className:"text-sm font-medium",children:"Export"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Download all canvas projects as JSON"}),t.jsxs(Q,{variant:"outline",size:"sm",onClick:s,className:"w-full","data-test":"canvas-export-button",children:[t.jsx(op,{className:"h-4 w-4 mr-2"}),"Export Data"]})]}),t.jsxs("div",{"data-test":"data-import-section",children:[t.jsx(Ee,{className:"text-sm font-medium",children:"Import"}),t.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Import canvas projects from a JSON file"}),t.jsxs("div",{className:"flex items-center justify-between mb-3","data-test":"canvas-replace-mode-control",children:[t.jsxs("div",{children:[t.jsx(Ee,{htmlFor:"canvas-replace-mode",className:"text-xs font-medium",children:"Replace existing data"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Delete all before import"})]}),t.jsx(Co,{id:"canvas-replace-mode",checked:i,onCheckedChange:c,disabled:r,"data-test":"canvas-replace-mode-switch"})]}),t.jsxs(Q,{variant:"outline",size:"sm",onClick:u,disabled:r,className:"w-full","data-test":"canvas-import-select-file-button",children:[t.jsx(ap,{className:"h-4 w-4 mr-2"}),r?"Importing...":"Select File"]}),t.jsx("input",{type:"file",ref:o,accept:".json",style:{display:"none"},onChange:h,"data-test":"canvas-import-file-input"})]}),l&&t.jsxs("div",{className:"space-y-2 p-3 border rounded-md bg-muted/50","data-test":"canvas-import-result",children:[l.projectsImported>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-green-600","data-test":"canvas-imported-count",children:[t.jsx(Ba,{className:"h-3 w-3"}),t.jsxs("span",{children:["Imported: ",l.projectsImported]})]}),l.projectsSkipped>0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-yellow-600","data-test":"canvas-skipped-count",children:[t.jsx(ko,{className:"h-3 w-3"}),t.jsxs("span",{children:["Skipped: ",l.projectsSkipped]})]}),l.projectsImported===0&&l.projectsSkipped===0&&t.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-600","data-test":"canvas-no-projects",children:[t.jsx(ko,{className:"h-3 w-3"}),t.jsx("span",{children:"No projects found"})]})]})]})},UN=()=>t.jsx(Go,{storageKey:"canvas-data-io",title:"Data Import/Export",icon:t.jsx(el,{className:"h-5 w-5"}),variant:"outline",size:"icon",contentClassName:"w-72",side:"left",align:"end",children:t.jsx(VN,{})}),Oa=Object.values(ku).map(e=>({value:e,label:Au[e]})),GN=()=>{const[e,s]=p.useState(()=>{var i;return((i=dn.getState().ui)==null?void 0:i.keyboardLanguage)??or}),[n,o]=p.useState(()=>{var c;const i=(c=dn.getState().ui)==null?void 0:c.enabledKeyboardLanguages;return Array.isArray(i)&&i.length>0?i:Su}),r=()=>{var u;if(n.length<=1)return;const i=n.indexOf(e),c=i===-1?0:(i+1)%n.length,l=n[c];s(l),dn.update("ui",{keyboardLanguage:l});const d=((u=Oa.find(h=>h.value===l))==null?void 0:u.label)??l;Se(`${ju[l]} Keyboard: ${d}`,{duration:1500})},a=(i,c)=>{let l;if(c)l=Oa.map(d=>d.value).filter(d=>n.includes(d)||d===i);else{if(n.length<=1)return;l=n.filter(d=>d!==i)}if(o(l),dn.update("ui",{enabledKeyboardLanguages:l}),!l.includes(e)){const d=l[0];s(d),dn.update("ui",{keyboardLanguage:d})}};return t.jsx(Cu,{label:t.jsx(rp,{className:"h-5 w-5"}),onAction:r,variant:"outline",size:"icon",tooltipText:`${la[e]} - Click to cycle, hold for settings`,popoverContent:t.jsxs("div",{className:"space-y-3 p-1","data-test":"keyboard-language-panel",children:[t.jsx(Ee,{className:"text-sm font-medium",children:"Languages to cycle"}),t.jsx("div",{className:"space-y-2",children:Oa.map(i=>{const c=n.includes(i.value),l=n.length===1&&c;return t.jsxs("div",{className:"flex items-center space-x-2","data-test":"keyboard-language-option",children:[t.jsx(We,{id:`lang-${i.value}`,checked:c,onCheckedChange:d=>a(i.value,!!d),disabled:l}),t.jsx(Ee,{htmlFor:`lang-${i.value}`,className:`cursor-pointer ${l?"opacity-50":""}`,children:i.label})]},i.value)})}),t.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t","data-test":"current-language-indicator",children:["Current: ",t.jsx("span",{className:"font-medium",children:la[e]}),n.length>1&&t.jsxs("span",{className:"ml-1",children:["(cycling ",n.map(i=>la[i]).join(" → "),")"]})]})]})})},YN=[],KN=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState("move"),[r,a]=p.useState(null),i=p.useRef(null),c=z(x=>{var y;return((y=x.projectCanvas.getActive())==null?void 0:y.coreState.selectedNodes)??YN}),l=z(x=>{var y;return(y=x.projectCanvas.getActive())==null?void 0:y.id}),d=z(x=>x.copyNodesToCanvas),u=z(x=>x.moveNodesToCanvas),h=c.length===0,g=()=>{if(!h){if(i.current){const x=i.current.getBoundingClientRect();a({x:x.left-320-16,y:Math.max(16,x.top+x.height/2-400/2)})}s(!0)}},f=x=>{const y=c.map(N=>N.id),v={nodeIds:y,targetCanvasId:x.canvasId,targetWorkspaceId:x.workspaceId,targetProjectId:x.projectId};n==="copy"?(d(v),Se.success(`Copied ${y.length} node${y.length>1?"s":""} to "${x.canvasName}"`)):(u(v),Se.success(`Moved ${y.length} node${y.length>1?"s":""} to "${x.canvasName}"`)),s(!1)},w=()=>{s(!1)},m=t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-move-nodes-title",children:[t.jsx(Q,{variant:n==="move"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("move"),"data-test":"canvas-move-nodes-move-option",children:"Move"}),t.jsx(Q,{variant:n==="copy"?"default":"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>o("copy"),"data-test":"canvas-move-nodes-copy-option",children:"Copy"}),t.jsxs("span",{className:"text-xs text-muted-foreground ml-1",children:[c.length," node",c.length!==1?"s":""]})]});return t.jsxs(t.Fragment,{children:[t.jsx(Zt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(Q,{ref:i,variant:"outline",size:"icon",disabled:h,onClick:g,"data-test":"canvas-move-nodes-button",title:"Move/copy nodes",children:t.jsx(ip,{className:"h-5 w-5"})})}),t.jsx(Bt,{children:t.jsx("p",{children:h?"Select nodes to move/copy":"Move/copy nodes to canvas"})})]})}),t.jsx(Td,{onCanvasSelected:f,excludeCanvasId:l,selectionModeTitle:m,isOpen:e,onClose:w,popoverPosition:r})]})};class XN{constructor(s){He(this,"namespace","canvas.collapse");this.hooks=s}getActions(){return[{id:"collapse:all",label:"Collapse all nodes",category:"Collapse",icon:t.jsx(Io,{className:"h-3 w-3"})},{id:"expand:all",label:"Expand all nodes",category:"Collapse",icon:t.jsx(Pn,{className:"h-3 w-3"})}]}getConfig(){return{}}setConfig(s){}execute(s,n){switch(s){case"collapse:all":this.hooks.collapseAll();break;case"expand:all":this.hooks.expandAll();break;default:console.warn(`CollapseFacade: Unknown action "${s}"`)}}}function qN(){const e=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed||r.updateNode(c.id,{isCollapsed:!0})})},[]),s=p.useCallback(()=>{const r=E.getState(),a=r.projectCanvas.getActive();Object.values((a==null?void 0:a.coreState.nodes)??{}).forEach(c=>{c.isCollapsed&&r.updateNode(c.id,{isCollapsed:!1})})},[]),n=p.useMemo(()=>({collapseAll:e,expandAll:s}),[e,s]),o=p.useMemo(()=>new XN(n),[n]);return p.useEffect(()=>(it.register("collapse",{name:"Collapse",getActions:()=>o.getActions()}),rt.register("collapse",o),()=>{it.unregister("collapse"),rt.unregister("collapse")}),[o]),o}const ZN=[],JN=10,QN={content:!0,title:!0,id:!1,type:!1,tags:!1},eS=e=>{if(e.title)return e.title;if(typeof e.content=="string"){const s=e.content.split(`
`)[0];return s.length>50?s.substring(0,50)+"...":s||"(empty)"}return"(empty)"},tS=(e,s,n,o)=>{if(!s.trim())return!0;const r=n?s:s.toLowerCase(),a=i=>i?(n?i:i.toLowerCase()).includes(r):!1;if(o.content&&typeof e.content=="string"&&a(e.content)||o.title&&a(e.title)||o.id&&a(e.id)||o.type&&a(e.type))return!0;if(o.tags&&e.tags&&e.tags.length>0){const i=e.tags.map(c=>typeof c=="string"?c:c.title).join(", ");if(a(i))return!0}return!1},sS=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),[r,a]=p.useState(""),[i,c]=p.useState(!1),[l,d]=p.useState(QN),[u,h]=p.useState(!1),[g,f]=p.useState([]),[w,m]=p.useState("nodes"),x=p.useRef(null),y=qN(),v=z(k=>{var T;return((T=k.projectCanvas.getActive())==null?void 0:T.coreState.nodes)??ZN}),N=i||l.id||l.type||l.tags||!l.content||!l.title,b=p.useMemo(()=>r.trim()?Object.values(l).some(T=>T)?v.filter(T=>tS(T,r,i,l)):[]:v,[v,r,i,l]),j=p.useMemo(()=>v.filter(k=>k.isCollapsed).length,[v]),R=p.useMemo(()=>v.filter(k=>!k.isCollapsed).length,[v]),S=p.useMemo(()=>g.map(k=>v.find(T=>T.id===k)).filter(k=>k!==void 0).slice(0,5),[g,v]),C=()=>{if(x.current){const k=x.current.getBoundingClientRect();o({x:k.left-360-16,y:Math.max(16,k.top+k.height/2-450/2)})}s(!0)},M=()=>{s(!1),m("nodes")},I=p.useCallback(k=>{f(T=>{const L=T.filter(H=>H!==k);return[k,...L].slice(0,JN)})},[]),A=p.useCallback(k=>{const T=E.getState(),L=v.find(H=>H.id===k);L&&(T.updateNode(k,{isCollapsed:!L.isCollapsed}),I(k))},[v,I]),O=p.useCallback(()=>{if(r.trim()){const k=E.getState();b.forEach(T=>{T.isCollapsed||(k.updateNode(T.id,{isCollapsed:!0}),I(T.id))})}else y.execute("collapse:all")},[b,r,I,y]),F=p.useCallback(()=>{if(r.trim()){const k=E.getState();b.forEach(T=>{T.isCollapsed&&(k.updateNode(T.id,{isCollapsed:!1}),I(T.id))})}else y.execute("expand:all")},[b,r,I,y]),B=p.useCallback(k=>{Kn(k)},[]),W=w==="recent"?"Recent":t.jsxs("div",{className:"flex items-center gap-2","data-test":"canvas-collapse-title",children:[t.jsxs(Q,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:O,"data-test":"canvas-collapse-all-button",children:[t.jsx(Io,{className:"h-3 w-3 mr-1"}),"Collapse ",r.trim()?`(${b.length})`:"All"]}),t.jsxs(Q,{variant:"outline",size:"sm",className:"h-6 px-2 text-xs",onClick:F,"data-test":"canvas-expand-all-button",children:[t.jsx(Pn,{className:"h-3 w-3 mr-1"}),"Expand ",r.trim()?`(${b.length})`:"All"]})]}),P=w==="recent"?t.jsx(Q,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>m("nodes"),title:"Back to Nodes","data-test":"canvas-collapse-back-button",children:t.jsx(Xs,{className:"h-3.5 w-3.5"})}):t.jsx(Q,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>m("recent"),title:"Recent Collapse/Expand History","data-test":"canvas-collapse-recent-button",children:t.jsx(as,{className:"h-3.5 w-3.5"})});return t.jsxs(t.Fragment,{children:[t.jsx(Zt,{delayDuration:300,children:t.jsxs(Wt,{children:[t.jsx(Ht,{asChild:!0,children:t.jsx(Q,{ref:x,variant:"outline",size:"icon",onClick:C,"data-test":"canvas-collapse-button",title:"Collapse/expand nodes",children:t.jsx(Io,{className:"h-5 w-5"})})}),t.jsx(Bt,{children:t.jsxs("p",{children:["Collapse/expand nodes (",j," collapsed, ",R," expanded)"]})})]})}),t.jsx(Ve,{isVisible:e,onClose:M,title:W,triggerPosition:n??void 0,shouldCloseManually:!0,resizable:!0,initialSize:{width:360,height:450},headerActions:P,children:t.jsx("div",{className:"p-3 space-y-3","data-test":"canvas-collapse-popover-content",children:w==="nodes"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"search-section relative flex items-center gap-1","data-test":"canvas-collapse-search-section",children:[t.jsx(rs,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground pointer-events-none z-10","data-test":"canvas-collapse-search-icon"}),t.jsx(Re,{type:"text",placeholder:"Search nodes...",value:r,onChange:k=>a(k.target.value),className:ve("h-8 text-sm pl-8",r?"pr-16":"pr-10"),autoFocus:!0,"data-test":"canvas-collapse-search-input"}),r&&t.jsx(Q,{variant:"ghost",size:"icon",onClick:()=>a(""),className:"absolute right-10 top-1/2 -translate-y-1/2 h-5 w-5 hover:bg-muted","aria-label":"Clear search","data-test":"canvas-collapse-clear-button",children:t.jsx(Be,{className:"h-3 w-3"})}),N&&t.jsx("div",{className:ve("absolute top-1/2 -translate-y-1/2 h-1.5 w-1.5 rounded-full bg-primary pointer-events-none z-10",r?"right-16":"right-11"),"data-test":"canvas-collapse-filter-indicator"}),t.jsxs(ht,{open:u,onOpenChange:h,children:[t.jsx(pt,{asChild:!0,children:t.jsx(Q,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6","aria-label":"Search settings","data-test":"canvas-collapse-settings-button",children:t.jsx(Jo,{className:"h-3.5 w-3.5"})})}),t.jsx(gt,{align:"end",side:"bottom",className:"w-52",style:{zIndex:Te.draggablePopoverDropdown},"data-test":"canvas-collapse-settings-panel",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:"collapse-case-sensitive",checked:i,onCheckedChange:k=>c(!!k),"data-test":"canvas-collapse-case-sensitive-checkbox"}),t.jsx("label",{htmlFor:"collapse-case-sensitive",className:"text-sm cursor-pointer",children:"Case sensitive"})]}),t.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[t.jsx("p",{className:"text-xs text-muted-foreground",children:"Search in:"}),t.jsx("div",{className:"space-y-1.5",children:Object.entries({content:"Content",title:"Title",id:"ID",type:"Type",tags:"Tags"}).map(([k,T])=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(We,{id:`collapse-node-${k}`,checked:l[k],onCheckedChange:L=>d(H=>({...H,[k]:!!L})),"data-test":"canvas-collapse-field-checkbox"}),t.jsx("label",{htmlFor:`collapse-node-${k}`,className:"text-sm cursor-pointer",children:T})]},k))})]})]})})]})]}),t.jsxs("div",{className:"stats-section flex items-center gap-2 text-xs text-muted-foreground","data-test":"canvas-collapse-stats",children:[t.jsxs(Ze,{variant:"secondary","data-test":"canvas-collapse-collapsed-count",children:[j," collapsed"]}),t.jsxs(Ze,{variant:"outline","data-test":"canvas-collapse-expanded-count",children:[R," expanded"]}),r.trim()&&t.jsxs("span",{"data-test":"canvas-collapse-filtered-count",children:["(",b.length," matching)"]})]}),t.jsxs("div",{className:"nodes-list-section space-y-1","data-test":"canvas-collapse-nodes-section",children:[t.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:r.trim()?`Results (${b.length})`:`All Nodes (${v.length})`}),t.jsxs("div",{className:"max-h-[300px] overflow-y-auto space-y-1","data-test":"canvas-collapse-nodes-list",children:[b.map(k=>t.jsx(Tc,{node:k,onToggle:()=>A(k.id),onClick:()=>B(k)},k.id)),b.length===0&&r.trim()&&t.jsx("p",{className:"text-xs text-muted-foreground py-2 text-center","data-test":"canvas-collapse-no-results",children:"No nodes found"})]})]})]}):t.jsx("div",{className:"recent-view-section space-y-1","data-test":"canvas-collapse-recent-view",children:S.length>0?t.jsx("div",{className:"max-h-[350px] overflow-y-auto space-y-1","data-test":"canvas-collapse-recent-list",children:S.map(k=>t.jsx(Tc,{node:k,onToggle:()=>A(k.id),onClick:()=>B(k)},k.id))}):t.jsx("p",{className:"text-xs text-muted-foreground py-8 text-center","data-test":"canvas-collapse-recent-empty",children:"No recent collapse/expand history"})})})})]})},Tc=({node:e,onToggle:s,onClick:n})=>{const o=na(e.type),r=eS(e),a=e.id.substring(0,6);return t.jsxs("div",{className:"flex items-center gap-2 p-1.5 rounded hover:bg-accent/50 group","data-test":"canvas-collapse-node-item",children:[t.jsx(Q,{variant:"ghost",size:"icon",className:"h-4 w-4 flex-shrink-0",onClick:i=>{i.stopPropagation(),s()},title:e.isCollapsed?"Expand":"Collapse","data-test":"canvas-collapse-toggle-button",children:e.isCollapsed?t.jsx(on,{className:"h-3.5 w-3.5 text-muted-foreground"}):t.jsx(Ct,{className:"h-3.5 w-3.5"})}),t.jsxs("div",{className:"flex-1 flex items-center gap-1.5 cursor-pointer min-w-0",onClick:n,"data-test":"canvas-collapse-node-info",children:[o&&t.jsx("span",{className:"flex-shrink-0 text-muted-foreground",children:o}),t.jsx("span",{className:"text-xs truncate flex-1",children:r}),t.jsx("span",{className:"text-[10px] text-muted-foreground flex-shrink-0",children:a})]}),e.isCollapsed&&t.jsx(Ze,{variant:"secondary",className:"text-[9px] px-1 py-0 h-4","data-test":"canvas-collapse-badge",children:"collapsed"})]})},Ec=[],nS=[],oS=({isVisible:e,onClose:s})=>{const n=z(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.coreState.selectedNodes)??Ec}),o=z(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.coreState.nodes)??Ec}),r=z(f=>{var w;return((w=f.projectCanvas.getActive())==null?void 0:w.coreState.arrows)??nS});z(f=>{var w;return(w=f.preferences)==null?void 0:w.canvasConfig});const a=z(f=>f.updateNode),i=n.length>0,c=p.useMemo(()=>i?Rl(r,n):r,[i,n,r]),l=p.useCallback(f=>Ml({includeConfig:f}),[]),d=p.useMemo(()=>{const f=Math.round(window.innerWidth*.85),w=Math.round(window.innerHeight*.85),m=Math.round((window.innerWidth-f)/2),x=Math.round((window.innerHeight-w)/2);return{initialSize:{width:f,height:w},triggerPosition:{x:m,y:x}}},[]),u=p.useCallback(f=>{const w=Array.isArray(f)?f:f.nodes;Array.isArray(w)&&w.forEach(m=>{m&&m.id&&a(m.id,m)})},[a]),h=c.length,g=i?`Selected Nodes (${n.length})${h>0?` + Arrows (${h})`:""}`:`All Canvas (${o.length} nodes, ${r.length} arrows)`;return t.jsx(Go,{storageKey:"json-viewer-config",initialConfig:{includeCanvasConfig:!1},children:(f,w,m)=>{const x=l(f.includeCanvasConfig),y={nodes:[]},v=()=>{x&&Pl(x)};return t.jsx(Ve,{isVisible:e,onClose:s,title:g,resizable:!0,initialSize:d.initialSize,shouldCloseManually:!0,triggerPosition:d.triggerPosition,headerActions:t.jsxs("div",{className:"flex items-center gap-1","data-test":"json-viewer-header-actions",children:[t.jsx(m,{title:"JSON Viewer Settings",contentClassName:"w-64",contentStyle:{zIndex:Te.draggablePopoverDropdown},children:t.jsxs("div",{className:"flex items-center space-x-2","data-test":"include-canvas-config-option",children:[t.jsx(We,{id:"includeCanvasConfig",checked:f.includeCanvasConfig,onCheckedChange:N=>w(b=>({...b,includeCanvasConfig:!!N})),"data-test":"include-canvas-config-checkbox"}),t.jsx(Ee,{htmlFor:"includeCanvasConfig",className:"text-xs cursor-pointer",children:"Include Canvas configuration"})]})}),t.jsx("button",{type:"button",className:"p-1 rounded hover:bg-accent transition-colors",onClick:N=>{N.stopPropagation(),v()},onMouseDown:N=>N.stopPropagation(),"aria-label":"Copy JSON",title:"Copy","data-test":"json-viewer-copy-button",children:t.jsx(Pt,{size:14})})]}),children:t.jsx(Cl,{data:x??y,onDataChange:u})})}})},aS=()=>{const[e,s]=p.useState(!1);return t.jsxs(t.Fragment,{children:[t.jsx(Q,{variant:"outline",size:"icon",onClick:()=>s(!0),"data-test":"canvas-json-viewer-button",title:"View JSON Data",children:t.jsx(Qo,{className:"h-5 w-5"})}),t.jsx(oS,{isVisible:e,onClose:()=>s(!1)})]})},rS=[],iS=()=>{const e=z(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.coreState.layers)??rS}),s=z(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.coreState.activeLayerId)??null}),n=z(m=>m.layer),o=p.useMemo(()=>e.length===0?[Jc()]:[...e].sort((m,x)=>x.order-m.order),[e]),r=p.useCallback((m,x,y)=>{m.stopPropagation(),n.setVisibility(x,!y)},[n]),a=p.useMemo(()=>o.map(m=>({id:m.id,label:m.name,icon:m.isLocked?t.jsx(Ao,{className:"h-3 w-3 text-muted-foreground"}):t.jsx("button",{onClick:x=>r(x,m.id,m.isVisible),className:"hover:text-foreground transition-colors","data-test":"layer-visibility-toggle",title:m.isVisible?"Hide layer":"Show layer",children:m.isVisible?t.jsx(qt,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"}):t.jsx(ys,{className:"h-3 w-3 text-muted-foreground/50 hover:text-foreground"})}),data:{type:"layer",...m}})),[o,r]),i=m=>{n.setActive(m.id)},c=(m,x)=>{n.rename(m,x)},l=m=>{n.delete(m)},d=m=>{const x=m.length;m.forEach((y,v)=>{const N=x-1-v;n.reorder(y.id,N)})},u=m=>`Delete layer "${m.label}"? Nodes will be moved to the layer below.`,h=m=>{const x=m.data;return x?[{id:"toggle-visibility",label:x.isVisible?"Hide Layer":"Show Layer",icon:x.isVisible?t.jsx(ys,{className:"h-4 w-4 mr-2"}):t.jsx(qt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setVisibility(x.id,!x.isVisible)}},{id:"toggle-lock",label:x.isLocked?"Unlock Layer":"Lock Layer",icon:x.isLocked?t.jsx(bl,{className:"h-4 w-4 mr-2"}):t.jsx(Ao,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.setLocked(x.id,!x.isLocked)}},{id:"duplicate",label:"Duplicate Layer",icon:t.jsx(Pt,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.duplicate(x.id)}},{id:"merge-down",label:"Merge Down",icon:t.jsx(lp,{className:"h-4 w-4 mr-2"}),onClick:()=>{n.mergeDown(x.id)}}]:null},g=()=>{n.create()},f=p.useCallback((m,x)=>{n.setOpacity(m,x)},[n]),w=p.useCallback((m,x,y,v)=>{const N=m.data;return N?t.jsxs("div",{"data-test":"layer-item-with-opacity",children:[v,t.jsxs("div",{className:"flex items-center gap-1 px-2 py-0 mt-1 ml-8 opacity-50 hover:opacity-100 transition-opacity","data-test":"layer-opacity-row",children:[t.jsx(cp,{className:"h-2 w-2 text-muted-foreground/60 flex-shrink-0"}),t.jsx(Yt,{value:[N.opacity],onValueChange:([b])=>f(m.id,b),min:0,max:100,step:1,className:"flex-1 [&>span:first-child]:h-0.5 [&>span:first-child>span]:bg-muted-foreground/40 [&_[role=slider]]:h-2 [&_[role=slider]]:w-2","data-test":"layer-opacity-slider"}),t.jsxs("span",{className:"text-[9px] text-muted-foreground/60 w-6 text-right","data-test":"layer-opacity-value",children:[N.opacity,"%"]})]})]}):v},[f]);return t.jsxs("div",{className:"layer-manager flex flex-col h-full","data-test":"canvas-layer-manager",children:[t.jsx(Gs,{className:"layer-list flex-1 min-h-0","data-test":"layer-list-scroll-area",children:t.jsx("div",{className:"layer-tree-container p-2","data-test":"layer-tree-container",children:t.jsx(qs,{data:a,onItemClick:i,onUpdate:c,onDelete:e.length>1?l:void 0,onReorder:d,selectedId:s,deleteConfirmMessage:u,enableEdit:!0,enableDelete:e.length>1,enableDrag:!0,moreOptionsItems:h,dropdownZIndex:Te.draggablePopoverDropdown,renderNode:w})})}),t.jsx("div",{className:"layer-actions border-t p-2","data-test":"layer-actions",children:t.jsxs(Q,{variant:"outline",size:"sm",className:"w-full",onClick:g,"data-test":"layer-add-button",children:[t.jsx(wt,{className:"h-3 w-3 mr-1"}),"Add Layer"]})})]})},cS=180,lS=()=>{const[e,s]=p.useState(!1),[n,o]=p.useState(null),r=p.useRef(null),a=()=>{if(e){s(!1);return}if(r.current){const i=r.current.getBoundingClientRect(),c=280,l=350,d=i.left+i.width/2,u=i.top+i.height/2;o({x:d-c/2-cS,y:u-l/2})}s(!0)};return t.jsxs(t.Fragment,{children:[t.jsx(is,{ref:r,variant:"secondary",size:"sm",tooltip:"Manage layers",onClick:a,className:"canvas-layer-button","data-test":"canvas-layer-button",children:t.jsx(nn,{className:"h-4 w-4"})}),t.jsx(Ve,{isVisible:e,onClose:()=>s(!1),title:"Layers",resizable:!0,initialSize:{width:280,height:350},triggerPosition:n??void 0,children:t.jsx(iS,{})})]})},dS=({onSessionSelect:e})=>{const{sessions:s,loadingSessions:n,sessionsError:o,pagination:r,currentPage:a,searchSessions:i,refreshSessions:c,handlePageChange:l,handleLoadMore:d}=Iu({loadOnMount:!1,subscribeToSSE:!1}),[u,h]=p.useState(null),[g,f]=p.useState(!1),{messages:w,sessionDetails:m,metadata:x,loading:y,pagination:v,loadOlderMessages:N,searchMessages:b,refreshSession:j,addOptimisticMessage:R,removeOptimisticMessage:S}=Tu(u,{loadOnMount:!0,subscribeToSSE:!0}),C=400,M=-240,I=p.useMemo(()=>{const P=Math.round(window.innerWidth*.6),k=Math.round(window.innerHeight*.8),H=window.innerWidth-30+M-P,$=Math.round((window.innerHeight-k)/2);return{size:{width:P,height:k},position:{x:H,y:$}}},[M]),A=P=>{h(P),f(!0),e==null||e(P)},O=()=>{f(!1)},F=async(P,k)=>{try{const T=await Wa.searchMessages(P,k);console.log("Message search results:",T)}catch(T){console.error("Message search failed:",T)}},B=async(P,k)=>{await b(P,k)},W=t.jsx(Op,{sessions:s,loading:n,error:o,onSessionSelect:A,selectedSessionId:u,onRefresh:c,pagination:r,currentPage:a,onPageChange:l,onLoadMore:d,onSearch:i,onMessageSearch:F});return t.jsxs(t.Fragment,{children:[t.jsx(cn,{popoverId:"claude-sessions",icon:dp,tooltip:"Claude Sessions",popoverTitle:"Claude Sessions",popoverContent:W,initialSize:{width:C,height:600},leftOffset:M,resizable:!0,dataTest:"canvas-claude-session-button"}),t.jsx(Ve,{isVisible:g,onClose:O,title:(m==null?void 0:m.customName)??(m==null?void 0:m.name)??"Chat",shouldCloseManually:!0,resizable:!0,initialSize:I.size,initialPosition:I.position,children:t.jsxs("div",{className:"flex flex-col h-full","data-test":"claude-chat-popover-content",children:[t.jsx("div",{className:"flex-1 overflow-auto","data-test":"claude-chat-messages-area",children:t.jsx(Eu,{messages:w,sessionDetails:m,metadata:x,loading:y,pagination:v,onLoadOlder:N,onSearch:B,onNameUpdated:j})}),u&&t.jsx("div",{className:"border-t p-2","data-test":"claude-chat-input-area",children:t.jsx(Ru,{sessionId:u,onSendSuccess:()=>{j()},onAddOptimisticMessage:R,onRemoveOptimisticMessage:S})})]})})]})},uS=e=>{const{className:s}=e,{history:n,lastAction:o,executeLastAction:r,hasExecutor:a}=Sr(),i=o&&a(o.executorId),c=p.useCallback(()=>{i&&r()},[i,r]),l=n.length>0;return t.jsx(_n,{expandTitle:"Actions & Presets",expandContent:t.jsx(cd,{}),onClick:c,disabled:!l,variant:"outline",size:"icon",className:s,popoverSize:{width:300,height:380},title:o?`Repeat: ${o.label}`:"No action to repeat",dataTest:"canvas-repeat-action-button",headerActions:t.jsx(ld,{}),children:t.jsx(Zo,{className:"h-5 w-5"})})},Rc=380,Mc=360,Pc=e=>{const{className:s}=e,[n,o]=p.useState(!1),[r,a]=p.useState(void 0),i=z(d=>d.setActiveGlobalOverlay),c=()=>{i(xs.STUDY)},l=d=>{const u=d.currentTarget.getBoundingClientRect();a({x:u.left-Mc-16,y:(window.innerHeight-Rc)/2}),o(!0)};return t.jsxs(t.Fragment,{children:[t.jsxs(oa,{position:"right",className:s,children:[t.jsx(GN,{}),t.jsx(aS,{}),t.jsx(KN,{}),t.jsx(sS,{}),t.jsx(lS,{}),t.jsx(dS,{}),t.jsx(UN,{}),t.jsx(uS,{}),t.jsx(Q,{variant:"outline",size:"icon",onClick:c,title:"Enter Study Mode","data-test":"mobile-right-toolbar-study-mode",children:t.jsx(up,{className:"h-5 w-5"})}),t.jsx(Q,{variant:"outline",size:"icon",onClick:l,"data-test":"mobile-right-toolbar-settings",title:"Settings",children:t.jsx(Un,{className:"h-5 w-5"})})]}),t.jsx(Ve,{isVisible:n,onClose:()=>o(!1),title:"Canvas Settings",resizable:!0,initialSize:{width:Mc,height:Rc},shouldCloseManually:!0,triggerPosition:r,headerActions:t.jsx("button",{type:"submit",form:"canvas-settings-form",className:"p-1 rounded hover:bg-accent transition-colors",onClick:d=>d.stopPropagation(),onMouseDown:d=>d.stopPropagation(),"aria-label":"Save settings",title:"Save","data-test":"canvas-settings-save-button",children:t.jsx(Jt,{size:14})}),children:t.jsx(_N,{})})]})},hS=e=>{const{className:s}=e,n=z(c=>c.setActiveGlobalOverlay),o=()=>{n(xs.NONE)},r=()=>{console.log("Previous card")},a=()=>{console.log("Next card")},i=()=>{console.log("Flip card")};return t.jsxs(oa,{position:"right",className:s,children:[t.jsx(Q,{variant:"outline",size:"icon",onClick:o,title:"Exit Study Mode","data-test":"study-mode-exit-button",children:t.jsx(Be,{className:"h-5 w-5"})}),t.jsx(Q,{variant:"outline",size:"icon",onClick:r,title:"Previous Card","data-test":"study-mode-prev-button",children:t.jsx(hp,{className:"h-5 w-5"})}),t.jsx(Q,{variant:"outline",size:"icon",onClick:a,title:"Next Card","data-test":"study-mode-next-button",children:t.jsx(on,{className:"h-5 w-5"})}),t.jsx(Q,{variant:"outline",size:"icon",onClick:i,title:"Flip Card","data-test":"study-mode-flip-button",children:t.jsx(pp,{className:"h-5 w-5"})})]})},pS=()=>{switch(z(s=>s.uiState.activeGlobalOverlay)){case xs.STUDY:return{right:t.jsx(hS,{})};case xs.PAIRING:return{right:t.jsx(Pc,{})};case xs.NONE:default:return{right:t.jsx(Pc,{})}}},gS=5,Dc=[];function fS({items:e,onSelect:s,placeholder:n="Search...",getGroup:o,storageKey:r,maxRecentItems:a=gS,enablePinning:i=!1,openShortcut:c,repeatLastShortcut:l,renderItem:d,renderEmpty:u,open:h,onOpenChange:g}){const[f,w]=p.useState(!1),m=h!==void 0,x=m?h:f,y=p.useCallback(V=>{m||w(V),g==null||g(V)},[m,g]),[v,N]=p.useState(""),[b,j]=p.useState(""),R=`${r}-recently-used`,S=`${r}-search-options`,[C,M]=p.useState(()=>{try{const V=localStorage.getItem(R);return V?JSON.parse(V):[]}catch{return[]}}),[I,A]=p.useState(()=>{try{const V=localStorage.getItem(S);return V?JSON.parse(V):{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}catch{return{matchCase:!1,matchWholeWord:!1,mode:"fuzzy"}}}),O=p.useCallback(V=>{A(V);try{localStorage.setItem(S,JSON.stringify(V))}catch{}},[S]),F=z(p.useCallback(V=>{var D,Y;return i?((Y=(D=V.preferences)==null?void 0:D.pinnedPaletteItems)==null?void 0:Y[r])??Dc:Dc},[i,r])),B=p.useMemo(()=>i?F.map(V=>e.find(D=>D.id===V)).filter(V=>V!==void 0):[],[i,F,e]),W=p.useCallback(V=>i?F.includes(V):!1,[i,F]),P=p.useCallback((V,D)=>{D&&(D.stopPropagation(),D.preventDefault()),i&&E.getState().togglePinPaletteItem(r,V)},[i,r]),k=p.useMemo(()=>Mu(I),[I]),{navigateResults:T}=Pu(v,N),L=p.useMemo(()=>{const V={};return e.forEach(D=>{const Y=o?o(D):D.group??"General";V[Y]||(V[Y]=[]),V[Y].push(D)}),V},[e,o]),H=p.useMemo(()=>C.filter(V=>!F.includes(V)).map(V=>e.find(D=>D.id===V)).filter(V=>V!==void 0),[C,e,F]),$=p.useCallback(V=>{y(!1),j(""),s(V),M(D=>{const Y=D.filter(ie=>ie!==V.id),te=[V.id,...Y].slice(0,a);try{localStorage.setItem(R,JSON.stringify(te))}catch{}return te})},[y,s,a,R]);p.useEffect(()=>{const V=[];if(c){const D=Ur.register({key:c.key,ctrlKey:c.ctrl,altKey:c.alt,metaKey:c.meta,preventDefault:!0,callback:()=>y(!x)});V.push(D)}if(l&&C.length>0){const D=Ur.register({key:l.key,ctrlKey:l.ctrl,altKey:l.alt,metaKey:l.meta,preventDefault:!0,callback:()=>{const Y=C[0],te=e.find(ie=>ie.id===Y);te&&s(te)}});V.push(D)}return()=>{V.forEach(D=>D())}},[c,l,x,y,C,e,s]),p.useEffect(()=>{if(!x)return;const V=D=>{if(i&&D.key==="Enter"&&D.ctrlKey){D.preventDefault(),D.stopPropagation();const we=v.split("-");let ge;we[0]==="recent"||we[0]==="pinned"?ge=we[1]:ge=we[0],ge&&P(ge);return}if(D.key!=="ArrowUp"&&D.key!=="ArrowDown")return;const Y=Array.from(document.querySelectorAll("[cmdk-item]")).filter(we=>we.getAttribute("data-disabled")!=="true");if(Y.length===0)return;const te=Y.map(we=>we.getAttribute("data-value")||""),ie=te.indexOf(v);D.key==="ArrowUp"&&ie<=0?(D.preventDefault(),D.stopPropagation(),N(te[Y.length-1])):D.key==="ArrowDown"&&ie>=Y.length-1&&(D.preventDefault(),D.stopPropagation(),N(te[0]))};return document.addEventListener("keydown",V,{capture:!0}),()=>document.removeEventListener("keydown",V,{capture:!0})},[x,v,i,P]);const _=V=>t.jsxs("div",{className:"flex justify-between items-center w-full","data-test":"command-palette-item-content",children:[t.jsxs("div",{className:"flex flex-col","data-test":"command-palette-item-text",children:[t.jsx("span",{"data-test":"command-palette-item-label",children:V.label}),V.description&&t.jsx("span",{className:"text-xs text-muted-foreground","data-test":"command-palette-item-description",children:V.description})]}),V.shortcut&&t.jsx("kbd",{className:"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground","data-test":"command-palette-item-shortcut",children:V.shortcut})]}),G=V=>{const D=W(V.id),Y=d?d(V):_(V);return i?t.jsxs("div",{className:"flex items-center w-full group","data-test":"command-palette-item-wrapper",children:[t.jsx("div",{className:"flex-1 min-w-0",children:Y}),t.jsx(Q,{type:"button",variant:"ghost",size:"smIcon",onClick:te=>P(V.id,te),className:`shrink-0 ${D?"opacity-100":"opacity-0 group-hover:opacity-100"}`,title:D?"Unpin (Ctrl+Enter)":"Pin (Ctrl+Enter)","data-test":"command-palette-pin-button",children:D?t.jsx(wl,{className:"text-muted-foreground","data-test":"command-palette-pin-icon-off"}):t.jsx(xl,{className:"text-muted-foreground","data-test":"command-palette-pin-icon"})})]}):Y};return t.jsxs(Du,{open:x,onOpenChange:y,value:v,onValueChange:N,filter:k,"data-test":"command-palette-dialog",children:[t.jsx(Ou,{placeholder:n,initialOptions:I,onSearchOptionsChange:O,onSearchChange:j,onNavigate:T}),t.jsxs(Lu,{"data-test":"command-palette-list",children:[t.jsx(Wu,{"data-test":"command-palette-empty",children:u?u():"No results found."}),i&&B.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(da,{heading:"Pinned","data-test":"command-palette-group-pinned",children:B.map(V=>t.jsx(ua,{value:`pinned-${V.id}-${V.label}`,onSelect:()=>$(V),"data-test":"command-palette-item-pinned",children:G(V)},`pinned-${V.id}`))}),t.jsx(ha,{"data-test":"command-palette-separator-pinned"})]}),H.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(da,{heading:"Recently Used","data-test":"command-palette-group-recent",children:H.map(V=>t.jsx(ua,{value:`recent-${V.id}-${V.label}`,onSelect:()=>$(V),"data-test":"command-palette-item-recent",children:G(V)},`recent-${V.id}`))}),t.jsx(ha,{"data-test":"command-palette-separator-recent"})]}),Object.entries(L).map(([V,D],Y)=>t.jsxs("div",{"data-test":"command-palette-group-container",children:[Y>0&&t.jsx(ha,{"data-test":"command-palette-separator"}),t.jsx(da,{heading:V,"data-test":"command-palette-group",children:D.map(te=>t.jsx(ua,{value:`${te.id}-${te.label}-${te.description||""}`,onSelect:()=>$(te),"data-test":"command-palette-item",children:G(te)},te.id))})]},V))]})]})}const mS=({open:e,onOpenChange:s})=>{const n=z(l=>{var d;return((d=l.state)==null?void 0:d.projects)??{}}),o=z(l=>{var d;return(d=l.state)==null?void 0:d.activeProjectId}),r=p.useMemo(()=>{const l=[];for(const[d,u]of Object.entries(n))for(const[h,g]of Object.entries(u.workspaces))for(const[f,w]of Object.entries(g.canvases))w.hideFromSearch||l.push({id:f,label:w.name,description:`${u.name} / ${g.name}`,projectId:d,workspaceId:h,canvasId:f,projectName:u.name,workspaceName:g.name});return l.sort((d,u)=>{if(d.projectId===o&&u.projectId!==o)return-1;if(u.projectId===o&&d.projectId!==o)return 1;const h=d.projectName.localeCompare(u.projectName);if(h!==0)return h;const g=d.workspaceName.localeCompare(u.workspaceName);return g!==0?g:d.label.localeCompare(u.label)}),l},[n,o]),a=p.useCallback(l=>{E.getState().projectCanvas.switch(l.canvasId)},[]),i=p.useCallback(l=>t.jsxs("div",{className:"flex items-center gap-1.5 w-full min-w-0","data-test":"canvas-picker-item",children:[t.jsx(nn,{className:"!h-3 !w-3 text-muted-foreground shrink-0"}),t.jsx("span",{className:"shrink-0 font-medium","data-test":"canvas-picker-item-label",children:l.label}),t.jsxs("span",{className:"text-xs text-muted-foreground truncate",title:`${l.projectName} / ${l.workspaceName} / ${l.label}`,"data-test":"canvas-picker-item-path",children:[l.projectName," / ",l.workspaceName," / ",l.label]})]}),[]),c=p.useCallback(()=>t.jsxs("div",{className:"text-center py-4","data-test":"canvas-picker-empty",children:[t.jsx("p",{className:"text-muted-foreground",children:"No canvases found."}),t.jsx("p",{className:"text-xs text-muted-foreground/70 mt-1",children:"Create a canvas to get started."})]}),[]);return t.jsx(fS,{items:r,onSelect:a,placeholder:"Search canvases...",storageKey:"canvas-picker-palette",maxRecentItems:10,enablePinning:!0,openShortcut:{key:"p",ctrl:!0},renderItem:i,renderEmpty:c,open:e,onOpenChange:s,"data-test":"canvas-picker-palette"})};function Oc(e,s){const{selected:n}=s;if(e==="selected")return n.map(o=>o.content??"").filter(o=>String(o).trim()).join(`
`);if(e.startsWith("selected[")){const o=Jr(e,{selected:n});return o==null?"":typeof o=="object"?JSON.stringify(o):String(o)}if(e.startsWith("selected.")){const o=e.slice(9);return n.map(r=>{const a={node:r},i=Jr(`node.${o}`,a);return i==null?"":typeof i=="object"?JSON.stringify(i):String(i)}).filter(r=>String(r).trim()).join(`
`)}return""}function xS({formulas:e,inputRef:s,onFormulaExecute:n,getSelectedNodes:o,fieldCompletions:r=[]}){const[a,i]=p.useState(!1),[c,l]=p.useState(""),[d,u]=p.useState(0),[h,g]=p.useState(null),[f,w]=p.useState({top:0,left:0}),[m,x]=p.useState("formula"),[y,v]=p.useState(null),N=p.useMemo(()=>{if(m==="field"){const I=c.toLowerCase();return r.filter(A=>!I||A.field.toLowerCase().startsWith(I)||A.name.toLowerCase().includes(I)).map(A=>({id:A.id,name:A.name,trigger:A.field,description:A.description}))}if(!c)return e;const M=c.toLowerCase();return e.filter(I=>I.trigger.toLowerCase().startsWith(M)||I.name.toLowerCase().includes(M))},[e,r,c,m]);p.useMemo(()=>{u(0)},[N.length]);const b=p.useCallback(()=>{i(!1),l(""),g(null),u(0),x("formula"),v(null)},[]),j=p.useCallback(M=>{const I=Hp(M);if(I){const A=M.getBoundingClientRect(),O=window.getComputedStyle(M),F=parseInt(O.lineHeight||O.fontSize)||20;w({top:A.top+I.top-F-Z.slashCommand.menuGapAboveInput,left:A.left+I.left})}},[]),R=p.useCallback(M=>{var $,_,G,V,D,Y;const I=s.current;if(!I||h===null)return;const A=I.selectionStart??0,O=I.value,F={query:c,fullText:O,cursorPosition:A,equalPosition:h};if(m==="field"&&y){const te=`${y}.${M.trigger}`;let ie;if(o){const K=o();ie=Oc(te,{selected:K})}else ie="";const we=ie??"",ge=O.substring(0,h),X=O.substring(A),ce=ge+we+X,ue=(($=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:$.set)||((_=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:_.set);ue&&(ue.call(I,ce),I.dispatchEvent(new Event("input",{bubbles:!0})));const ee=h+we.length;I.setSelectionRange(ee,ee),n==null||n({...M,trigger:te},ie),b();return}if(M.insertTrigger){const te=`=${M.trigger}`,ie=O.substring(0,h),we=O.substring(A),ge=ie+te+we,X=((G=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:G.set)||((V=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:V.set);X&&(X.call(I,ge),I.dispatchEvent(new Event("input",{bubbles:!0})));const ce=h+te.length;I.setSelectionRange(ce,ce),b();return}let B;if(M.onSelect)B=M.onSelect(F);else if(o){const te=o();B=Oc(M.trigger,{selected:te})}else B="";const W=B??"",P=O.substring(0,h),k=O.substring(A),T=P+W+k,L=((D=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:D.set)||((Y=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:Y.set);L&&(L.call(I,T),I.dispatchEvent(new Event("input",{bubbles:!0})));const H=h+W.length;I.setSelectionRange(H,H),n==null||n(M,B),b()},[s,h,c,m,y,n,o,b]),S=p.useCallback(M=>{const I=M.currentTarget,A=I.selectionStart??0,O=I.value;if(M.key==="="&&!a){const F=A>0?O[A-1]:"";(A===0||/\s/.test(F))&&(j(I),g(A),i(!0),l(""),u(0),x("formula"),v(null));return}if(M.key==="."&&!a&&r.length>0){let F=-1;for(let B=A-1;B>=0;B--){if(O[B]==="="){const W=B>0?O[B-1]:"";if(B===0||/\s/.test(W)){F=B;break}}if(/\s/.test(O[B]))break}if(F>=0){const B=O.substring(F+1,A);e.find(P=>P.insertTrigger&&P.trigger===B)&&(j(I),g(F),i(!0),l(""),u(0),x("field"),v(B))}return}a&&(M.key==="ArrowDown"?(M.preventDefault(),u(F=>F<N.length-1?F+1:0)):M.key==="ArrowUp"?(M.preventDefault(),u(F=>F>0?F-1:N.length-1)):M.key==="Enter"||M.key==="Tab"?N.length>0&&(M.preventDefault(),R(N[d])):M.key==="Escape"&&(M.preventDefault(),b()))},[a,N,d,R,b,j,e,r.length]),C=p.useCallback(M=>{if(!a||h===null)return;if(h>=M.length||M[h]!=="="){b();return}const I=s.current,A=(I==null?void 0:I.selectionStart)??M.length;if(m==="field"){const O=h+1+((y==null?void 0:y.length)??0);if(A<=O||M[O]!=="."){b();return}const F=M.substring(O+1,A);if(F.includes(" ")){b();return}l(F)}else{const O=M.substring(h+1,A);if(O.includes(" ")){b();return}l(O)}},[a,h,m,y,s,b]);return{isOpen:a,query:c,filteredFormulas:N,selectedIndex:d,handleKeyDown:S,handleChange:C,selectFormula:R,close:b,menuPosition:f,isFieldMode:m==="field"}}const Rd=({formulas:e,selectedIndex:s,position:n,onSelect:o,onClose:r,triggerPrefix:a="="})=>{const i=p.useRef(null),c=p.useRef(null);p.useEffect(()=>{var d;(d=c.current)==null||d.scrollIntoView({block:"nearest"})},[s]),p.useEffect(()=>{const d=u=>{i.current&&!i.current.contains(u.target)&&r()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[r]);const l=t.jsx("div",{ref:i,"data-test":"formula-menu",className:ve("fixed min-w-[200px] max-w-[300px]","rounded-md border bg-popover p-1 shadow-md",e.length>0&&"max-h-[200px] overflow-y-auto"),style:{top:n.top,left:n.left,zIndex:Te.slashCommandMenu,transform:"translateY(-100%)"},children:e.length===0?t.jsx("div",{"data-test":"formula-menu-empty",className:"py-2 px-2 text-sm text-muted-foreground text-center",children:"No formulas found"}):e.map((d,u)=>t.jsxs("div",{ref:u===s?c:void 0,"data-test":"formula-item",className:ve("flex items-center gap-2 rounded-sm px-2 py-1.5 text-sm cursor-pointer","select-none outline-none",u===s?"bg-accent text-accent-foreground":"hover:bg-accent/50"),onClick:()=>o(d),children:[d.icon&&t.jsx("span",{"data-test":"formula-icon",className:"flex-shrink-0 w-4 h-4",children:d.icon}),t.jsxs("div",{"data-test":"formula-content",className:"flex flex-col flex-1 min-w-0",children:[t.jsxs("span",{"data-test":"formula-name",className:"font-medium truncate",children:[a,d.trigger]}),d.description&&t.jsx("span",{"data-test":"formula-description",className:"text-xs text-muted-foreground truncate",children:d.description})]})]},d.id))});return sn.createPortal(l,document.body)};Rd.displayName="FormulaMenu";const wS=[{id:"selected",name:"Selected Nodes",trigger:"selected",description:"Access selected nodes",insertTrigger:!0}],yS=[{id:"content",name:"content",field:"content",description:"Node content text"},{id:"title",name:"title",field:"title",description:"Node title"},{id:"id",name:"id",field:"id",description:"Node ID"}];var Dt=(e=>(e.DEFAULT="default",e.CLAUDE="claude",e))(Dt||{});const vS={default:"",claude:"Claude"};function bS({content:e,srcLang:s,toLang:n}){return`Translate the following text from ${s} to ${n}: \`${e}\``}const Lc={ENGLISH:"English",VIETNAMESE:"Vietnamese"},NS=e=>{var s;return((s=e.ui)==null?void 0:s.keyboardLanguage)??or},SS=({onSend:e,placeholder:s="Type a message...",disabled:n=!1})=>{const[o,r]=p.useState(""),[a,i]=p.useState(Dt.DEFAULT),[c,l]=p.useState(null),[d,u]=p.useState(!1),[h,g]=p.useState(!0),[f,w]=p.useState(!1),[m,x]=p.useState(!1),[y,v]=p.useState(null),N=p.useRef(null),b=p.useRef(null),j=p.useRef(null),R=p.useRef(null),S=z(ae=>{var re;return((re=ae.uiState)==null?void 0:re.isOverlayVisible)??!0}),C=z(ae=>ae.toggleOverlayVisibility),M=z(Oe.selectSelectedNodes),I=z(ae=>{var re;return((re=ae.uiState)==null?void 0:re.dragInfo)!==null}),A=yo(NS),O=z(ae=>ae.uiState.activeChatNodeId),[F,B]=p.useState(()=>typeof window<"u"?window.innerWidth<vs:!1),[W,P]=p.useState(()=>typeof window<"u"?window.innerWidth<Z.chatInput.tabletBreakpoint:!1);p.useEffect(()=>{const ae=()=>{B(window.innerWidth<vs),P(window.innerWidth<Z.chatInput.tabletBreakpoint)};return window.addEventListener("resize",ae),()=>window.removeEventListener("resize",ae)},[]),p.useEffect(()=>{if(M.length===1){const re=M[0].data;if(re!=null&&re.sessionId){i(Dt.CLAUDE),l(re.sessionId);const me=re.role!=="assistant";g(me);return}}else R.current=null},[M,I]),p.useEffect(()=>{var ae;b.current=((ae=N.current)==null?void 0:ae.getTextArea())??null}),p.useEffect(()=>{const ae=()=>{var re,me;(me=(re=N.current)==null?void 0:re.getTextArea())==null||me.focus()};return window.addEventListener("focus",ae),()=>window.removeEventListener("focus",ae)},[]);const k=p.useCallback(()=>{var ds;if(!O||!F)return;const ae=E.getState(),re=ae.getNodeById(O);if(!re||re.type!==le.CHAT||!((ds=ae.projectCanvas.getActive())==null?void 0:ds.viewState))return;const Ne=j.current;if(!Ne)return;const xe=document.querySelector("[data-canvas-container]"),ye=(xe==null?void 0:xe.getBoundingClientRect().top)??0,Ae=(xe==null?void 0:xe.getBoundingClientRect().left)??0,Pe=Ne.getBoundingClientRect().top,Fe=window.innerWidth,Me=ae.getNodeById(re.id),Ue=(Me==null?void 0:Me.data)??{},$e=re.width??0,Qe=re.height??0,et=re.y+Qe,vt=re.x+$e,cs=Pe-ye-et,ls=Fe-Ae-vt;ae.setActiveCanvasViewState(Qt=>({...Qt,targetView:{targetOffset:{x:ls,y:cs},targetScale:1,animationStartTime:0,animationDuration:Z.claudeChat.alignScrollDuration}})),ae.updateNode(re.id,{data:{...Ue,viewMode:"chat"}})},[O,F]),T=p.useCallback(()=>{k()},[k]),L=p.useCallback(()=>{var ae;return((ae=E.getState().projectCanvas.getActive())==null?void 0:ae.coreState.selectedNodes)??[]},[]),H=p.useMemo(()=>[{id:"claude",name:"Claude",trigger:"claude",description:"Send to Claude AI",onSelect:()=>(i(Dt.CLAUDE),"")},{id:"claude-project-select",name:"Claude Project Select",trigger:"claude project select",description:"Select Claude project for next message",onSelect:()=>(w(!0),i(Dt.CLAUDE),"")},{id:"translate-selected",name:"Translate Selected",trigger:"translate selected",description:"Translate selected node content",onSelect:()=>{var Ne;const re=((Ne=L()[0])==null?void 0:Ne.content)??"";return re?bS({content:re,srcLang:Lc.ENGLISH,toLang:Lc.VIETNAMESE}):(Se.warning("No content selected",{description:"Select a node with content first"}),"")}}],[c,f,y,L]),{isOpen:$,filteredCommands:_,selectedIndex:G,handleKeyDown:V,handleChange:D,selectCommand:Y,close:te,menuPosition:ie}=Lp({commands:H,inputRef:b}),{isOpen:we,filteredFormulas:ge,selectedIndex:X,handleKeyDown:ce,handleChange:ue,selectFormula:ee,close:K,menuPosition:U,isFieldMode:q}=xS({formulas:wS,inputRef:b,getSelectedNodes:L,fieldCompletions:yS}),se=p.useCallback(ae=>{const re=ae.target.value;r(re),D(re),ue(re);const me=W?Z.chatInput.maxRows*24+16:200,Ne=ae.target;Ne.style.height="auto",Ne.style.height=`${Math.min(Ne.scrollHeight,me)}px`},[D,ue,W]),ne=p.useCallback(()=>{var Dr,Or;const ae=E.getState();if(O){const Vt=ae.getNodeById(O);if(Vt&&Vt.type===le.CHAT)return Vt}const re=j.current;if(!re)return null;const me=(Dr=ae.projectCanvas.getActive())==null?void 0:Dr.viewState;if(!me)return null;const{scale:Ne,offset:xe}=me,ye=re.getBoundingClientRect(),{viewMode:Ae,windowed:ke,desktopWidth:Pe,desktopHeight:Fe}=Z.chatNode,Me=((Or=window.visualViewport)==null?void 0:Or.width)??window.innerWidth,Ue=document.querySelector("[data-canvas-container]"),$e=(Ue==null?void 0:Ue.getBoundingClientRect().top)??0,Qe=ye.top,et=document.querySelector('[data-test="canvas-chat-input-textarea-container"]'),vt=et==null?void 0:et.getBoundingClientRect();let cs,ls;if(F&&Ae==="fullwidth")cs=Me,ls=$e;else{const Vt=F?ke.mobileViewportGap:ke.desktopViewportGap;cs=F?Me-Vt*2:Math.min((vt==null?void 0:vt.width)??ye.width,Pe),F||((vt==null?void 0:vt.right)??ye.right)-cs,ls=$e+Vt}const ds=F?Qe-ls:Fe,Qt=cs,ra=ds,Er=(Ue==null?void 0:Ue.getBoundingClientRect().left)??0,Rr=F?Me:(vt==null?void 0:vt.right)??Me,Mr=(Rr-Er-xe.x)/Ne-Qt,Pr=(Qe-$e-xe.y)/Ne-ra,ia={id:De(),type:le.CHAT,x:Mr,y:Pr,width:Qt,height:ra,title:"Chat",data:{childNodeIds:[],maxHeight:Z.chatNode.defaultMaxHeight,viewMode:"chat"}};ae.addNode(ia,void 0,{dontSelect:!0}),ae.setActiveChatNodeId(ia.id,!1);const Fd=Pr+ra,$d=Mr+Qt,zd=Rr-Er-$d,_d=Qe-$e-Fd;return ae.setActiveCanvasViewState(Vt=>({...Vt,targetView:{targetOffset:{x:zd,y:_d},targetScale:1,animationStartTime:0,animationDuration:Z.claudeChat.alignScrollDuration}})),ia},[O,F,S]),oe=p.useCallback((ae,re)=>{var Qt;const me=ne();if(!me)return null;const Ne=E.getState(),xe=F?Z.chatInput.mobile.nodeFontSize:void 0,ye=me.data,Ae=(me.width??400)-16,Pe=bs(ae)+16,Fe=Math.min(Pe,Ae),Ue=Hu(ae,{containerWidth:Fe,fontSize:xe,skipPaddingSubtraction:!0})+be.NODE_Y_PADDING,$e={id:De(),type:le.TEXT,x:me.x,y:me.y,width:Fe,height:Ue,content:ae,...re&&{data:re},...xe&&{styles:{fontSize:xe}}};Ne.addNode($e,void 0,{dontSelect:!0}),Ne.updateNode(me.id,{data:{...ye,childNodeIds:[...ye.childNodeIds||[],$e.id]}});const Qe=40,et=16,ls=((((Qt=ye.childNodeIds)==null?void 0:Qt.length)??0)+1)*(Ue+8),ds=Math.min(Qe+et+ls,Z.chatNode.defaultMaxHeight);return ds>(me.height??0)&&Ne.updateNode(me.id,{height:ds}),$e},[ne,F]),fe=p.useCallback(async()=>{var me;const ae=o.trim();if(!ae)return;const re=(me=N.current)==null?void 0:me.getTextArea();if(a===Dt.CLAUDE){u(!0);try{let Ne=c;if(!Ne){const ye=await Wa.createSession();if(!ye.success||!ye.sessionId)throw new Error(ye.error??"Failed to create Claude session");Ne=ye.sessionId,l(Ne)}oe(ae,{sessionId:Ne,role:"user"});const xe=await Wa.sendMessage({sessionId:Ne,message:ae});if(!xe.success)throw new Error(xe.error??"Failed to send message to Claude");oe(xe.response,{sessionId:Ne,role:"assistant"}),e==null||e(ae),r(""),re&&(re.style.height="auto",re.focus())}catch(Ne){const xe=Ne instanceof Error?Ne.message:"Unknown error";Se.error("Claude API error",{description:xe}),c&&oe(`Error: ${xe}`,{sessionId:c,role:"error"})}finally{u(!1)}return}oe(ae),e==null||e(ae),r(""),i(Dt.DEFAULT),re&&(re.style.height="auto",re.focus())},[o,e,a,c,oe]),he=p.useCallback(()=>{if(a===Dt.CLAUDE){const ae=(y==null?void 0:y.split("/").pop())??"",re=c?ei(c,3,3):"new";return ae?`[${ae}] ${re}`:c?ei(c,3,3):"Claude"}return vS[a]},[a,c,y]),de=p.useCallback(ae=>{if(V(ae),ce(ae),!($&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(ae.key))&&!(we&&["ArrowUp","ArrowDown","Enter","Tab","Escape"].includes(ae.key))&&ae.key==="Enter"&&!$&&!we){if(W)return;ae.shiftKey||(ae.preventDefault(),fe())}},[fe,V,ce,$,we,W]),pe=W?Z.chatInput.maxRows*24+16:200;return t.jsxs("div",{ref:j,className:"w-screen md:w-[50vw] pr-2",style:{zIndex:Te.canvasChatInput},"data-test":"canvas-chat-input-container","data-ui-panel":"true",children:[$&&t.jsx(Wp,{commands:_,selectedIndex:G,position:ie,onSelect:Y,onClose:te}),we&&t.jsx(Rd,{formulas:ge,selectedIndex:X,position:U,onSelect:ee,onClose:K,triggerPrefix:q?".":"="}),f&&t.jsxs("div",{"data-test":"chat-input-project-selector",className:"absolute bottom-full mb-2 left-0 right-0 bg-background border rounded-lg shadow-lg p-3",style:{zIndex:Te.canvasChatInput+1},children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-sm font-medium",children:"Select Claude Project"}),t.jsx("button",{"data-test":"chat-input-project-selector-close",onClick:()=>w(!1),className:"p-1 hover:bg-muted rounded",children:t.jsx(Be,{className:"h-4 w-4"})})]}),t.jsx(Bu,{variant:"select",onChange:ae=>{v(typeof ae=="string"?ae:null),setTimeout(()=>{var me,Ne;l(null),i(Dt.CLAUDE),w(!1),(Ne=(me=N.current)==null?void 0:me.getTextArea())==null||Ne.focus()},0)}})]}),a!==Dt.DEFAULT&&t.jsxs("div",{"data-test":"chat-input-mode-indicator",className:"absolute -top-7 left-2 flex items-center gap-1 px-2 pl-2 py-1 bg-primary text-primary-foreground text-xs font-medium rounded-t-md",children:[t.jsx("span",{"data-test":"chat-input-mode-label",children:he()}),t.jsx("button",{"data-test":"chat-input-mode-clear",onClick:()=>{i(Dt.DEFAULT),l(null)},className:"p-0.5 hover:bg-primary-foreground/20 rounded",title:"Clear mode",children:t.jsx(Be,{className:"h-3 w-3"})})]}),t.jsxs("div",{className:"flex items-center pb-1","data-test":"canvas-chat-input-wrapper",children:[t.jsxs("div",{className:"relative",children:[t.jsx(Q,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 h-10 w-10 bg-background rounded-lg",title:"More actions","data-test":"canvas-chat-input-plus-button",onClick:()=>x(!m),children:t.jsx(wt,{className:"h-5 w-5"})}),m&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0",style:{zIndex:Te.popover-1},onClick:()=>x(!1),"data-test":"canvas-chat-input-plus-menu-backdrop"}),t.jsx("div",{className:"absolute bottom-full left-0 mb-2 w-auto p-1 rounded-md border bg-popover text-popover-foreground shadow-md",style:{zIndex:Te.popover},"data-test":"canvas-chat-input-plus-menu",children:t.jsx(Q,{type:"button",variant:"ghost",size:"sm",className:"w-full justify-start gap-2 whitespace-nowrap",onClick:()=>{C(),x(!1)},"data-test":"canvas-chat-input-toggle-overlay",children:S?t.jsxs(t.Fragment,{children:[t.jsx(ys,{className:"h-4 w-4"}),t.jsx("span",{children:"Hide Overlay"})]}):t.jsxs(t.Fragment,{children:[t.jsx(qt,{className:"h-4 w-4"}),t.jsx("span",{children:"Show Overlay"})]})})})]})]}),t.jsx("div",{className:"flex-1 min-w-0 bg-background border rounded-lg shadow-lg","data-test":"canvas-chat-input-textarea-container",children:t.jsx(zc,{ref:N,value:o,onChange:se,onKeyDown:de,onFocus:T,placeholder:s,className:"min-h-[40px] resize-none border-0 focus-visible:ring-0 focus-visible:ring-offset-0",style:{maxHeight:`${pe}px`,fontSize:F?Z.chatInput.mobile.fontConfig.cssFontSize:void 0,lineHeight:F?Z.chatInput.mobile.fontConfig.cssLineHeight:void 0},rows:1,showFilePicker:!0,showCopyButton:!1,showAudioButton:!0,showConfigButton:!1,audioButtonVariant:"muted",useMarkdown:!1,readOnly:n||d,keyboard:A})}),t.jsx(Q,{type:"button",size:"icon",onClick:fe,disabled:n||!o.trim()||d,className:"flex-shrink-0 h-10 w-10 ml-2","data-test":"canvas-chat-input-send-button",children:d?t.jsx(Yn,{className:"h-4 w-4 animate-spin","data-test":"canvas-chat-input-loading"}):t.jsx(gp,{className:"h-4 w-4"})})]})]})},CS=[],jS=()=>{const e=z(h=>h.uiState.switchLayerDialog),s=z(h=>{var g;return((g=h.projectCanvas.getActive())==null?void 0:g.coreState.layers)??CS}),n=z(h=>{var g;return((g=h.projectCanvas.getActive())==null?void 0:g.coreState.activeLayerId)??xt}),o=(e==null?void 0:e.isOpen)??!1,r=(e==null?void 0:e.targetLayerId)??xt,a=s.find(h=>h.id===r),i=(a==null?void 0:a.name)??(r===xt?"Default Layer":"Unknown Layer"),c=s.find(h=>h.id===n),l=(c==null?void 0:c.name)??(n===xt?"Default Layer":"Unknown Layer"),d=()=>{E.getState().setUiState(h=>({...h,switchLayerDialog:null}))},u=()=>{E.getState().layer.setActive(r),d()};return t.jsx(_c,{open:o,onOpenChange:h=>!h&&d(),children:t.jsxs(Vc,{"data-test":"switch-layer-dialog",children:[t.jsxs(Uc,{children:[t.jsx(Gc,{"data-test":"switch-layer-dialog-title",children:"Node on Different Layer"}),t.jsxs(Fu,{"data-test":"switch-layer-dialog-description",children:['You are currently on the "',l,'" layer. The node you clicked is on the "',i,'" layer. Would you like to switch to that layer?']})]}),t.jsxs($u,{"data-test":"switch-layer-dialog-footer",children:[t.jsx(Q,{variant:"outline",onClick:d,"data-test":"switch-layer-dialog-cancel",children:"Cancel"}),t.jsx(Q,{onClick:u,"data-test":"switch-layer-dialog-confirm",children:"Switch Layer"})]})]})})},kS=2e3,AS=[],Wc=[],ln={offset:{x:0,y:0},scale:1,targetView:null},IS=Ie.memo(({node:e,isSelected:s})=>{const a=(typeof e.content=="string"?e.content:"").split(`
`).filter(w=>w.trim().length>0),i=e.width??200,c=e.height??100,l=Math.max(a.length,1),d=Math.min(20,c/l),u=8,h="hsl(var(--muted))",g=s?"2px solid #2563eb":"1px solid hsl(var(--border))",f="hsl(var(--foreground))";return t.jsx("div",{style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${i}px`,height:`${c}px`,backgroundColor:h,border:g,borderRadius:"4px",padding:`${u}px`,display:"flex",flexDirection:"column",gap:`${Math.min(4,d*.2)}px`,overflow:"hidden",willChange:"transform",backfaceVisibility:"hidden"},children:a.slice(0,Math.floor(c/d)).map((w,m)=>{const x=w.length,y=Math.max(...a.map(N=>N.length),1),v=Math.max(20,x/y*90);return t.jsx("div",{style:{height:`${Math.max(2,d-4)}px`,width:`${v}%`,backgroundColor:s?"#93c5fd":f,borderRadius:"2px"}},m)})})});IS.displayName="SimplifiedNode";const Md=Ie.memo(({nodes:e,selectedNodeIds:s,selectedNodesCount:n,scale:o,offset:r})=>{const a=o<bn,i=p.useMemo(()=>{if(o>=bn)return e;const c=window.innerWidth,l=window.innerHeight,d=-r.x/o,u=-r.y/o,h=d+c/o,g=u+l/o,f=500/o;return e.filter(m=>{const x=m.x+(m.width??200),y=m.y+(m.height??100);return m.x<h+f&&x>d-f&&m.y<g+f&&y>u-f})},[e,o,r]);return a?t.jsx(t.Fragment,{children:i.map(c=>t.jsx(Uo,{node:c,isSelected:s.has(c.id),selectedNodesCount:n,useSimplifiedRendering:!0},c.id))}):t.jsx(t.Fragment,{children:e.map(c=>t.jsx(Uo,{node:c,isSelected:s.has(c.id),selectedNodesCount:n},c.id))})},(e,s)=>{const n=e.scale<bn,o=s.scale<bn;return!(n!==o||o&&(e.scale!==s.scale||e.offset.x!==s.offset.x||e.offset.y!==s.offset.y)||e.nodes!==s.nodes||e.selectedNodeIds!==s.selectedNodeIds||e.selectedNodesCount!==s.selectedNodesCount)});Md.displayName="CanvasNodesRenderer";const TS=[],Pd=Ie.memo(({groupNodes:e,selectedNodeIds:s})=>{const n=z(a=>{var i;return((i=a.projectCanvas.getActive())==null?void 0:i.viewState)??ln}),{scale:o,offset:r}=n;return e.length===0?null:t.jsx("div",{className:"absolute top-0 left-0 origin-top-left","data-test":"canvas-groups-layer",style:{transform:`translate3d(${r.x}px, ${r.y}px, 0) scale(${o})`,zIndex:Te.canvasGroups,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:t.jsx("div",{style:{pointerEvents:"auto"},children:e.map(a=>t.jsx(Uo,{node:a,isSelected:s.has(a.id),selectedNodesCount:s.size},a.id))})})});Pd.displayName="CanvasGroupsLayer";const Dd=Ie.memo(({nodes:e,selectedNodeIds:s,layers:n})=>{const o=z(m=>{var x;return((x=m.projectCanvas.getActive())==null?void 0:x.viewState)??ln}),{scale:r,offset:a}=o,i=p.useRef(0),c=p.useRef(r),l=p.useRef(!1),d=p.useRef(null),u=p.useRef(new Map),h=p.useMemo(()=>e.filter(m=>!m.isPinned),[e]),g=p.useMemo(()=>e.filter(m=>m.isPinned),[e]),f=p.useMemo(()=>n.length===0?[Jc()]:[...n].sort((m,x)=>m.order-x.order),[n]),w=p.useMemo(()=>{const m=new Map;return f.forEach(x=>{m.set(x.id,[])}),m.has(xt)||m.set(xt,[]),h.forEach(x=>{const y=x.layerId??xt,v=m.get(y);if(v)v.push(x);else{const N=m.get(xt);N&&N.push(x)}}),m},[h,f]);return p.useEffect(()=>{i.current+=1,c.current!==r&&(l.current||(l.current=!0,u.current.forEach(x=>{x&&(x.style.willChange="transform, contents")})),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{l.current=!1,u.current.forEach(x=>{x&&(x.style.willChange="")})},200)),c.current=r},[r,e.length]),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"absolute top-0 left-0 origin-top-left",style:{transform:`translate3d(${a.x}px, ${a.y}px, 0) scale(${r})`,zIndex:Te.canvasNodes,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3,pointerEvents:"none"},children:[t.jsx(DS,{scale:r,offset:a}),f.map((m,x)=>{const y=w.get(m.id)??[];return m.isVisible?t.jsx("div",{ref:v=>{u.current.set(m.id,v)},"data-layer-id":m.id,"data-layer-name":m.name,"data-test":"canvas-layer-container",style:{zIndex:x,opacity:m.opacity/100,pointerEvents:m.isLocked?"none":"auto"},children:t.jsx(Md,{nodes:y,selectedNodeIds:s,selectedNodesCount:s.size,scale:r,offset:a})},m.id):null})]}),g.length>0&&t.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:Te.canvasNodes+1},children:t.jsx("div",{style:{pointerEvents:"auto"},children:g.map(m=>t.jsx(Uo,{node:m,isSelected:s.has(m.id),selectedNodesCount:s.size},m.id))})})]})});Dd.displayName="CanvasTransformLayer";const ES=({arrows:e,selectedArrows:s})=>{const n=z(c=>{var l;return((l=c.projectCanvas.getActive())==null?void 0:l.viewState)??ln}),{scale:o,offset:r}=n,a=c=>!s.some(d=>d.id===c.id)||s.length>1,i=e.filter(a);return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:Te.canvasArrows,willChange:"transform"},children:t.jsxs("g",{transform:`translate(${r.x}, ${r.y}) scale(${o})`,style:{touchAction:"none"},children:[i.map(c=>t.jsx(jd,{arrow:c},c.id)),t.jsx(Fb,{})]})})},RS=Ie.memo(ES,(e,s)=>e.arrows.length!==s.arrows.length||e.selectedArrows.length!==s.selectedArrows.length?!1:e.arrows===s.arrows&&e.selectedArrows===s.selectedArrows),MS=({selectedArrows:e})=>{const s=z(r=>{var a;return((a=r.projectCanvas.getActive())==null?void 0:a.viewState)??ln}),{scale:n,offset:o}=s;return e.length!==1?null:t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:Te.canvasNodes+1,willChange:"transform"},children:t.jsx("g",{transform:`translate(${o.x}, ${o.y}) scale(${n})`,style:{touchAction:"none"},children:t.jsx(jd,{arrow:e[0]},e[0].id)})})},PS=Ie.memo(MS,(e,s)=>e.selectedArrows.length!==s.selectedArrows.length?!1:e.selectedArrows===s.selectedArrows),Od=Ie.memo(()=>{const e=z(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??ln}),{scale:s,offset:n}=e;return t.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:Te.canvasNodes+2,willChange:"transform"},"data-test":"temporary-drawing-layer",children:t.jsx("g",{transform:`translate(${n.x}, ${n.y}) scale(${s})`,style:{touchAction:"none"},children:t.jsx($b,{})})})});Od.displayName="CanvasTemporaryDrawingLayer";const Ld=Ie.memo(()=>{const e=z(o=>{var r;return((r=o.projectCanvas.getActive())==null?void 0:r.viewState)??ln}),{scale:s,offset:n}=e;return t.jsx(Vb,{scale:s,offset:n})});Ld.displayName="CanvasGridLayer";const DS=({scale:e,offset:s,x:n=0,y:o=0})=>t.jsx("div",{style:{position:"absolute",left:n*e,top:o*e,width:12,height:12,background:"darkred",borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 2px #0008",cursor:"pointer",zIndex:10,transform:"translate(-50%, -50%)",userSelect:"none"},title:`Canvas origin (${n.toFixed(1)}, ${o.toFixed(1)})`}),OS=()=>{const e=z(H=>H.uiState.isOverlayVisible??!0);z(H=>H.uiState.addNodeType);const s=z(H=>H.uiState.mode),n=z(H=>H.uiState.isPanning),o=z(H=>H.uiState.selectFromDrawMode),r=z(H=>{var $,_,G;return((G=(_=($=H.preferences)==null?void 0:$.canvasConfig)==null?void 0:_.background)==null?void 0:G.paperTexture)??Z.background.paperTexture}),a=z(H=>{var $,_,G;return((G=(_=($=H.preferences)==null?void 0:$.canvasConfig)==null?void 0:_.background)==null?void 0:G.customParams)??Z.background.customParams}),{theme:i}=qc(),c=Ie.useMemo(()=>i==="dark"?!0:i==="light"?!1:window.matchMedia("(prefers-color-scheme: dark)").matches,[i]),l=r!=="custom"&&zu[r]||"",d=Ie.useMemo(()=>{if(!a||a.opacity===0)return{};const H=c?100-a.bgLightness:a.bgLightness;return{backgroundColor:`hsl(${a.bgHue} ${a.bgSaturation}% ${H}%)`,position:"relative"}},[a,c]),u=Ie.useMemo(()=>!a||a.opacity===0?null:{position:"absolute",inset:0,opacity:a.opacity,pointerEvents:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='${a.baseFrequency}' numOctaves='${a.numOctaves}' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E")`,zIndex:0},[a]),h=p.useRef(0),g=p.useRef(performance.now());p.useEffect(()=>{h.current+=1;const H=performance.now();H-g.current>=2e3&&(h.current=0,g.current=H)});const[f,w]=p.useState(()=>typeof window<"u"?window.innerWidth<vs:!1);p.useEffect(()=>{const H=()=>w(window.innerWidth<vs);return window.addEventListener("resize",H),()=>window.removeEventListener("resize",H)},[]);const m=z(H=>H.toggleOverlayVisibility),x=NN(),y=z(H=>{var $;return(($=H.projectCanvas.getActive())==null?void 0:$.coreState.selectedNodes)??AS}),v=z(H=>{var $;return(($=H.projectCanvas.getActive())==null?void 0:$.coreState.arrows)??Wc}),N=z(H=>{var $;return(($=H.projectCanvas.getActive())==null?void 0:$.coreState.selectedArrows)??Wc}),b=z(H=>{var $;return(($=H.projectCanvas.getActive())==null?void 0:$.coreState.layers)??TS}),j=z(H=>H.saveStateToLocalStorage),R=pS(),S=z(H=>H.uiState.activeGlobalOverlay),C=S&&S!==xs.NONE;p.useEffect(()=>{Z.autosave&&setInterval(()=>{typeof j=="function"&&j()},kS)},[]);const M=p.useMemo(()=>new Set(y.map(H=>H.id)),[y]),I=p.useMemo(()=>{const H=new Set;return x.forEach($=>{if($.type===le.GROUP&&$.isCollapsed){const _=$.data;_!=null&&_.childNodeIds&&_.childNodeIds.forEach(G=>H.add(G))}if($.type===le.CHAT){const _=$.data;_!=null&&_.childNodeIds&&_.childNodeIds.forEach(G=>H.add(G))}}),H},[x]),A=p.useMemo(()=>{const H=vf(x,v);return I.forEach($=>H.add($)),H},[x,v,I]),{visibleGroupNodes:O,visibleNonGroupNodes:F}=p.useMemo(()=>{const H=x.filter(G=>!A.has(G.id)),$=[],_=[];return H.forEach(G=>{G.type===le.GROUP?$.push(G):_.push(G)}),{visibleGroupNodes:$,visibleNonGroupNodes:_}},[x,A]),B=p.useMemo(()=>v.filter(H=>{const $=H.startNodeId!==null&&A.has(H.startNodeId),_=H.endNodeId!==null&&A.has(H.endNodeId);return!$&&!_}),[v,A]),W=p.useMemo(()=>N.filter(H=>{const $=H.startNodeId!==null&&A.has(H.startNodeId),_=H.endNodeId!==null&&A.has(H.endNodeId);return!$&&!_}),[N,A]),P=t.jsx(Q,{variant:"outline",size:"icon",onClick:m,className:"h-7 w-7","data-prevent-canvas-click":!0,title:e?"Hide Overlay":"Show Overlay","data-test":"canvas-toggle-overlay-button",children:e?t.jsx(ys,{className:"h-4 w-4"}):t.jsx(qt,{className:"h-4 w-4"})}),k=t.jsx("div",{className:"flex items-center space-x-2",children:P}),T=s===J.DRAW||s===J.SELECT&&o,L=p.useMemo(()=>s===J.MOVE?n?"grabbing":"grab":s===J.DRAW?"crosshair":"default",[s,n]);return t.jsxs("div",{className:je("relative w-full h-full select-none",C&&"ring-2 ring-primary ring-inset",l),"data-canvas-content":!0,"data-global-overlay":S,style:{cursor:L,...d},children:[u&&t.jsx("div",{style:u,"data-test":"custom-texture-overlay"}),t.jsx(Ld,{}),t.jsx(Pd,{groupNodes:O,selectedNodeIds:M}),t.jsx(RS,{arrows:B,selectedArrows:W}),t.jsx(Dd,{nodes:F,selectedNodeIds:M,layers:b}),t.jsx(PS,{selectedArrows:W}),t.jsx(Od,{}),t.jsx(Vl,{}),t.jsx(ub,{}),t.jsx(xb,{}),t.jsx(Lb,{}),t.jsx(Em,{}),t.jsx(um,{isContentVisible:e,topMargin:"70px",topLeft:t.jsx(t.Fragment,{children:t.jsxs(t.Fragment,{children:[t.jsx(_b,{}),t.jsx(Uv,{}),t.jsx(pm,{})]})}),topRight:t.jsxs(t.Fragment,{children:[t.jsx(gd,{}),t.jsx(Bb,{})]}),bottomRight:e&&t.jsx("div",{className:"flex flex-col gap-2",children:t.jsx(Vv,{})}),bottom:t.jsx(Am,{}),alwaysVisibleBottomLeft:!f&&t.jsx("div",{className:"flex flex-col gap-2",children:k}),left:T?void 0:t.jsx(AN,{}),right:T?void 0:R.right,footer:t.jsx(SS,{})}),T&&t.jsx("div",{className:"absolute top-1/2 transform -translate-y-1/2 pointer-events-auto z-50 left-2","data-prevent-canvas-click":!0,"data-test":"draw-mode-toolbar-container",children:t.jsx(HN,{})}),t.jsx(mS,{}),t.jsx(jS,{})]})},LS=({sourceNode:e,allNodes:s,onNodeSelect:n,onClose:o,isVisible:r})=>{const[a,i]=p.useState(""),c=p.useMemo(()=>{const h=(e.highlights||[]).map(g=>g.linkedNodeId).filter(g=>g!==void 0);return s.filter(g=>h.includes(g.id))},[e.highlights,s]),l=p.useMemo(()=>{if(!a)return c;const u=a.toLowerCase();return c.filter(h=>(typeof h.content=="string"?h.content:"").toLowerCase().includes(u))},[c,a]),d=p.useMemo(()=>l.map(u=>{const h=typeof u.content=="string"?u.content:"[Complex content]",g=h.length>50?h.substring(0,50)+"...":h;return t.jsx("div",{className:"text-sm",children:g},u.id)}),[l]);return t.jsxs(Ve,{isVisible:r,onClose:o,title:`Linked Nodes (${c.length})`,initialPosition:"center","data-test":"linked-nodes-popover",children:[t.jsx("div",{className:"search-field px-3 py-2 border-b border-border",children:t.jsx("input",{type:"text",className:"w-full px-2 py-1 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:"Search linked nodes...",value:a,onChange:u=>i(u.target.value)})}),t.jsx("div",{className:"linked-nodes-list overflow-hidden",children:d.length>0?t.jsx(rr,{itemList:d,maxHeight:"200px",itemStyles:"border border-border",onSelectionChange:u=>{if(u.length>0){const h=l[u[0]];h&&(n(h),o())}}}):t.jsx("div",{className:"empty-state px-3 py-4 text-sm text-muted-foreground text-center",children:a?"No matching nodes found":"No linked nodes yet"})})]})},Hc=({node:e,isChanged:s})=>{const n=e.title||e.id,o=typeof e.content=="string"?e.content:"";return t.jsxs("div",{className:`absolute border-2 ${s?"border-green-500 ring-2 ring-green-500/30":"border-black"} bg-white rounded p-1`,style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:`${be.FONT_SIZE_MINI}px`},children:[t.jsx("div",{className:"font-semibold text-[10px] truncate",children:n}),t.jsx("div",{className:"text-[8px] text-muted-foreground truncate",children:o.substring(0,50)})]})},WS=({isVisible:e,changes:s,previewNodes:n,currentNodes:o,arrows:r,executionResult:a,onApply:i,onCancel:c})=>{const l=s.length>0,[d,u]=p.useState("canvas"),h=new Set(s.map(f=>f.nodeId)),g=p.useMemo(()=>{if(!a)return null;const f={workflow:{success:a.success,duration:`${a.duration}ms`,executedNodes:a.executedNodeCount,errors:a.errors.length},steps:[],changes:{totalNodes:s.length,updates:s.map(w=>({nodeId:w.nodeId,before:w.before,after:w.after}))}};return a.nodeStates&&a.nodeStates.forEach((w,m)=>{var x;(x=w.executionData)!=null&&x.steps&&w.executionData.steps.forEach(y=>{var N,b,j,R;const v={type:y.stepType,label:y.label,order:y.order};y.stepType==="source"?v.sourceData=w.executionData.sourceData:y.stepType==="loop"?v.items=((N=w.executionData.sourceData)==null?void 0:N.length)||0:y.stepType==="if"?(v.config=y.config,v.conditionResult=y.conditionResult,v.checkedNodes=((b=y.checkedNodes)==null?void 0:b.length)||0,v.matchedNodes=((j=y.checkedNodes)==null?void 0:j.filter(S=>S.matches).map(S=>S.nodeId))||[]):y.stepType==="nodeUpdate"&&(v.targets=((R=w.executionData.nodeUpdates)==null?void 0:R.length)||0),f.steps.push(v)})}),f},[a,s]);return t.jsx(Ve,{isVisible:e,onClose:c,title:"Workflow Dry Run Results",shouldCloseManually:!0,resizable:!0,initialSize:{width:1200,height:700},children:t.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[t.jsxs("div",{className:"p-4 bg-muted border-b border-border flex items-center justify-between",children:[t.jsx("div",{className:"text-sm",children:l?t.jsxs(t.Fragment,{children:[t.jsx("strong",{children:s.length})," node",s.length!==1?"s":""," will be updated"]}):t.jsx("span",{className:"text-muted-foreground",children:"No changes to apply"})}),l&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{"data-test":"dry-run-view-canvas-button",onClick:()=>u("canvas"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="canvas"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(qt,{size:14}),"Canvas Preview"]}),t.jsxs("button",{"data-test":"dry-run-view-list-button",onClick:()=>u("list"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="list"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(ur,{size:14}),"Details"]}),t.jsxs("button",{"data-test":"dry-run-view-json-button",onClick:()=>u("json"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="json"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[t.jsx(Qo,{size:14}),"JSON"]})]})]}),t.jsx("div",{className:"flex-1 overflow-hidden",children:l?d==="json"?t.jsx("div",{className:"h-full overflow-auto p-4 bg-gray-50","data-test":"dry-run-json-view",children:t.jsx("pre",{className:"text-xs font-mono bg-background border border-border rounded p-4 whitespace-pre-wrap break-words",children:JSON.stringify(g,null,2)})}):d==="canvas"?t.jsxs("div",{className:"h-full flex gap-2 p-2",children:[t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-muted px-2 py-1 text-xs font-semibold border-b border-border",children:"Current State"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:o.map(f=>t.jsx(Hc,{node:f,isChanged:h.has(f.id)},f.id))})]}),t.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[t.jsx("div",{className:"bg-green-500/10 px-2 py-1 text-xs font-semibold border-b border-green-500/30 text-green-700 dark:text-green-400",children:"Preview (After Apply)"}),t.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:n.map(f=>t.jsx(Hc,{node:f,isChanged:h.has(f.id)},f.id))})]})]}):t.jsx("div",{className:"h-full overflow-y-auto p-4 space-y-4",children:s.map((f,w)=>t.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-2 bg-background",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:f.nodeId}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",w+1]})]}),f.before.title!==f.after.title&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Title"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:f.before.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(_t,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:f.after.title||t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),f.before.content!==f.after.content&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Content"}),t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20 font-mono max-h-24 overflow-y-auto",children:f.before.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:f.before.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),t.jsx(_t,{size:16,className:"text-muted-foreground flex-shrink-0 mt-1"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20 font-mono max-h-24 overflow-y-auto",children:f.after.content?t.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:f.after.content}):t.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),(()=>{const m=Array.isArray(f.before.tags)?f.before.tags:[],x=Array.isArray(f.after.tags)?f.after.tags:[],y=m.map(b=>b.title).sort().join(", "),v=x.map(b=>b.title).sort().join(", ");return y!==v?t.jsxs("div",{className:"space-y-1","data-test":"dry-run-tags-change",children:[t.jsxs("div",{className:"text-xs font-semibold text-muted-foreground flex items-center gap-1",children:[t.jsx($n,{size:12}),"Tags"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:m.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:m.map(b=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-destructive/20 rounded text-xs",children:["#",b.title]},b.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})}),t.jsx(_t,{size:16,className:"text-muted-foreground flex-shrink-0"}),t.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:x.length>0?t.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(b=>t.jsxs("span",{className:"px-1.5 py-0.5 bg-green-500/20 rounded text-xs",children:["#",b.title]},b.id))}):t.jsx("span",{className:"text-muted-foreground italic text-xs",children:"no tags"})})]})]}):null})()]},f.nodeId))}):t.jsx("div",{className:"text-center text-muted-foreground py-8",children:"The workflow executed successfully but made no changes to the canvas nodes."})}),t.jsxs("div",{className:"p-4 border-t border-border flex items-center justify-end gap-2",children:[t.jsxs("button",{"data-test":"dry-run-cancel-button",onClick:c,className:"px-4 py-2 text-sm border border-border rounded hover:bg-accent transition-colors flex items-center gap-2",children:[t.jsx(Be,{size:16}),"Cancel"]}),l&&t.jsxs("button",{"data-test":"dry-run-apply-button",onClick:i,className:"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors flex items-center gap-2",children:[t.jsx(Ys,{size:16}),"Apply Changes"]})]})]})})},Wd=Ie.memo(({canvasId:e,canvasName:s,projectName:n,workspaceName:o,isActive:r,isDragging:a,onClose:i,onClick:c,onAuxClick:l,dragRef:d})=>{const u=`${n} / ${o} / ${s}`;return t.jsxs("div",{ref:d,"data-test":"canvas-tab",className:ve("group flex items-center gap-1 px-3 py-1.5 text-sm","border-r border-border","cursor-pointer select-none","min-w-[100px]","transition-colors duration-150",r?"bg-background text-foreground border-b-2 border-b-primary":"bg-muted/50 text-muted-foreground hover:bg-accent hover:text-accent-foreground"),style:{maxWidth:Z.tabBar.maxTabWidth,opacity:a?Z.tabBar.dragSourceOpacity:void 0},onClick:c,onAuxClick:l,title:u,children:[t.jsx("span",{"data-test":"canvas-tab-title",className:"truncate flex-1",children:s}),t.jsx("button",{"data-test":"canvas-tab-close",className:ve("ml-1 p-0.5 rounded-sm","opacity-0 group-hover:opacity-100","hover:bg-destructive/20 hover:text-destructive","transition-opacity duration-150",r&&"opacity-60"),onClick:h=>{h.stopPropagation(),i(h)},title:"Close tab",children:t.jsx(Be,{className:"h-3 w-3"})})]})});Wd.displayName="CanvasTab";const HS=As,sr="canvas-tab-bar-zone",Hd=Ie.memo(({tab:e,isActive:s,isDragging:n,manager:o,onClose:r,onClick:a,onAuxClick:i})=>{const c=$p(o,e.canvasId,{canvasId:e.canvasId,dropZoneId:sr});return t.jsx(Wd,{canvasId:e.canvasId,canvasName:e.canvasName,projectName:e.projectName,workspaceName:e.workspaceName,isActive:s,isDragging:n,onClose:l=>{l.stopPropagation(),r(e.canvasId)},onClick:()=>a(e.canvasId),onAuxClick:l=>{l.button===1&&(l.preventDefault(),i(e.canvasId))},dragRef:c})});Hd.displayName="DraggableTab";const Bd=Ie.memo(()=>{const e=p.useRef(null),s=z(j=>{var R;return((R=j.preferences)==null?void 0:R.openTabs)??HS}),n=z(j=>{var R;return((R=j.projectCanvas.getActive())==null?void 0:R.id)??null}),o=z(j=>{var R;return((R=j.state)==null?void 0:R.activeProjectId)??null}),r=z(j=>{var S,C,M;const R=(S=j.state)==null?void 0:S.activeProjectId;return R?((M=(C=j.state)==null?void 0:C.projects[R])==null?void 0:M.activeWorkspaceId)??null:null}),a=p.useMemo(()=>{var R;const j=((R=E.getState().state)==null?void 0:R.projects)??{};return s.map(S=>{const C=j[S.projectId],M=C==null?void 0:C.workspaces[S.workspaceId],I=M==null?void 0:M.canvases[S.canvasId];return{canvasId:S.canvasId,canvasName:(I==null?void 0:I.name)??"Unknown",projectId:S.projectId,projectName:(C==null?void 0:C.name)??"Unknown",workspaceId:S.workspaceId,workspaceName:(M==null?void 0:M.name)??"Unknown",exists:!!I}}).filter(S=>S.exists)},[s]),i=p.useRef({switchCanvas:E.getState().projectCanvas.switch,closeTab:E.getState().closeTab,reorderTabs:E.getState().reorderTabs,createCanvas:E.getState().projectCanvas.create,openTab:E.getState().openTab});p.useEffect(()=>{if(!n||!o||!r)return;s.some(R=>R.canvasId===n)||i.current.openTab(n,o,r)},[n,o,r,s]);const[c,l]=p.useState(null),[d,u]=p.useState(null),h=p.useRef(a);h.current=a;const g=p.useMemo(()=>({onDragStart:j=>{var S;const R=((S=j.item.data)==null?void 0:S.canvasId)??null;u(R)},onDragMove:j=>{l(j.sortIndex)},onDrop:j=>{var O;const R=(O=j.item.data)==null?void 0:O.canvasId,S=j.sortIndex??0;if(!R)return;const C=h.current.map(F=>F.canvasId),M=C.indexOf(R);if(M===-1)return;const I=[...C];I.splice(M,1);const A=M<S?S-1:S;I.splice(A,0,R),i.current.reorderTabs(I)},onDragEnd:()=>{l(null),u(null)}}),[]),{manager:f}=Bp({snap:{enabled:!1,threshold:10},sort:{enabled:!0,orientation:"horizontal",threshold:.5},dragThreshold:5},g),w=Fp(f,sr),m=p.useCallback(j=>{e&&(e.current=j),w(j)},[w,e]),x=p.useCallback(j=>{i.current.switchCanvas(j)},[]),y=p.useCallback(j=>{i.current.closeTab(j)},[]),v=p.useCallback(j=>{i.current.closeTab(j)},[]),N=p.useCallback(()=>{const j=i.current.createCanvas("New Canvas");j&&i.current.switchCanvas(j)},[]),b=p.useCallback(()=>{E.getState().setUiState(j=>({...j,floatingHeaderExpanded:!j.floatingHeaderExpanded}))},[]);return p.useEffect(()=>{if(!n||!e.current)return;const j=e.current.querySelector(`[data-test="canvas-tab-${n}"]`);j&&j.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},[n]),a.length===0?t.jsxs("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border px-1",children:[t.jsx("div",{className:"flex-1"}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:ve("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:N,title:"New canvas",children:t.jsx(wt,{className:"h-4 w-4"})}),t.jsx("button",{"data-test":"floating-header-toggle-button",className:ve("flex items-center justify-center","h-7 w-7 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onPointerDown:b,title:"Toggle header",children:t.jsx(Ct,{className:"h-4 w-4"})})]}):t.jsxs("div",{"data-test":"canvas-tab-bar",className:"flex items-center h-9 bg-muted/30 border-b border-border",children:[t.jsx("div",{ref:m,"data-drop-zone":sr,className:"flex-1 flex items-center overflow-x-auto scrollbar-thin scrollbar-thumb-border",style:{scrollbarWidth:"thin"},children:a.map((j,R)=>{const S=c===R&&d!==j.canvasId,C=c===R+1&&R===a.length-1&&d!==j.canvasId;return t.jsxs(Ie.Fragment,{children:[S&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:Z.tabBar.dropIndicator.width,opacity:Z.tabBar.dropIndicator.opacity}}),t.jsx(Hd,{tab:j,isActive:j.canvasId===n,isDragging:j.canvasId===d,manager:f,onClose:y,onClick:x,onAuxClick:v}),C&&t.jsx("div",{"data-test":"tab-drop-indicator",className:"h-5 bg-primary rounded-full mx-0.5",style:{width:Z.tabBar.dropIndicator.width,opacity:Z.tabBar.dropIndicator.opacity}})]},j.canvasId)})}),t.jsx("button",{"data-test":"canvas-tab-add-button",className:ve("flex items-center justify-center","h-7 w-7 mx-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onClick:N,title:"New canvas",children:t.jsx(wt,{className:"h-4 w-4"})}),t.jsx("button",{"data-test":"floating-header-toggle-button",className:ve("flex items-center justify-center","h-7 w-7 mr-1 rounded-sm","text-muted-foreground hover:text-foreground","hover:bg-accent","transition-colors duration-150"),onPointerDown:b,title:"Toggle header",children:t.jsx(Ct,{className:"h-4 w-4"})})]})});Bd.displayName="CanvasTabBar";function BS({open:e,onOpenChange:s}){const n=z(p.useCallback(m=>{var x,y;return((y=(x=m.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:y.current)??null},[])),o=z(p.useCallback(m=>{var x,y;return((y=(x=m.projectCanvas.getActive())==null?void 0:x.undoTree)==null?void 0:y.root)??null},[])),r=z(p.useCallback(m=>{var y,v;const x=(v=(y=m.projectCanvas.getActive())==null?void 0:y.undoTree)==null?void 0:v.nodes;return x?Object.keys(x).length:0},[])),{allNodes:a,currentNode:i,canUndo:c,canRedo:l,treeData:d}=p.useMemo(()=>{const m=E.getState();return{allNodes:m.undo.getAllNodes(),currentNode:m.undo.getCurrent(),canUndo:m.undo.canUndo(),canRedo:m.undo.canRedo(),treeData:m.undo.getTreeData()}},[n,o,r]),u=p.useCallback(()=>{E.getState().undo.undo()},[]),h=p.useCallback(()=>{E.getState().undo.redo()},[]),g=p.useCallback(m=>{E.getState().undo.jumpTo(m)},[]),f=p.useCallback(()=>{E.getState().undo.clear()},[]),w=p.useMemo(()=>{if(!d||a.length===0)return null;const m=d.root;return m?FS(a,m,(i==null?void 0:i.id)??null):null},[a,d,i]);return t.jsx(_u,{open:e,onOpenChange:s,children:t.jsxs(Vu,{side:"right",className:"w-80 sm:w-96","data-test":"undo-tree-explorer",children:[t.jsx(Uu,{children:t.jsxs(Gu,{className:"flex items-center gap-2",children:[t.jsx(gr,{className:"h-5 w-5"}),"Undo History"]})}),t.jsxs("div",{className:"mt-4 space-y-4","data-test":"undo-tree-controls",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(Q,{variant:"outline",size:"sm",onClick:u,disabled:!c,"data-test":"undo-button",children:[t.jsx(cr,{className:"h-4 w-4 mr-1"}),"Undo"]}),t.jsxs(Q,{variant:"outline",size:"sm",onClick:h,disabled:!l,"data-test":"redo-button",children:[t.jsx(sl,{className:"h-4 w-4 mr-1"}),"Redo"]}),t.jsx(Q,{variant:"ghost",size:"sm",onClick:f,disabled:a.length===0,className:"ml-auto text-muted-foreground hover:text-destructive","data-test":"clear-history-button",children:t.jsx(yt,{className:"h-4 w-4"})})]}),t.jsxs("div",{className:"text-sm text-muted-foreground","data-test":"history-stats",children:[a.length," operations in history"]}),t.jsx(Gs,{className:"h-[calc(100vh-200px)]","data-test":"undo-tree-scroll",children:w?t.jsx("div",{className:"pr-4","data-test":"undo-tree-content",children:w.map((m,x)=>t.jsx($S,{item:m,isCurrent:m.node.id===(i==null?void 0:i.id),onJump:g,isLast:x===w.length-1},m.node.id))}):t.jsxs("div",{className:"text-center text-muted-foreground py-8","data-test":"empty-history",children:["No undo history yet.",t.jsx("br",{}),t.jsx("span",{className:"text-xs",children:"Drag nodes or resize them to start recording."})]})})]})]})})}function FS(e,s,n){const o=new Map(e.map(i=>[i.id,i])),r=[];function a(i,c,l,d,u){const h=o.get(i);h&&(r.push({node:h,depth:c,hasSiblings:u,isLastChild:d,branchIndex:l}),h.children.forEach((g,f)=>{a(g,c+1,f,f===h.children.length-1,h.children.length>1)}))}return a(s,0,0,!0,!1),r}function $S({item:e,isCurrent:s,onJump:n,isLast:o}){const{node:r,depth:a,hasSiblings:i,branchIndex:c}=e,l=p.useMemo(()=>new Date(r.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),[r.timestamp]);return t.jsxs("div",{className:"relative",style:{marginLeft:a*16},"data-test":"undo-tree-node",children:[a>0&&t.jsx("div",{className:ve("absolute left-[-12px] top-0 h-full w-px bg-border",o&&"h-3")}),a>0&&t.jsx("div",{className:"absolute left-[-12px] top-3 w-3 h-px bg-border"}),i&&c>0&&t.jsx("div",{className:"absolute left-[-14px] top-2 w-2 h-2 rounded-full bg-muted-foreground/50",title:`Branch ${c+1}`}),t.jsx("button",{onClick:()=>n(r.id),className:ve("w-full text-left px-2 py-1.5 rounded-md text-sm transition-colors","hover:bg-accent hover:text-accent-foreground",s&&"bg-primary/10 border border-primary/30 font-medium"),"data-test":"undo-tree-jump-button",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:ve("w-2 h-2 rounded-full flex-shrink-0",s?"bg-primary":"bg-muted-foreground/30")}),t.jsx("span",{className:"truncate flex-1",children:r.label??r.operation.type}),t.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[t.jsx(as,{className:"h-3 w-3"}),l]})]})})]})}const zS=()=>{const e=z(l=>l.uiState.holdSelectProgress),[s,n]=p.useState(0),[o,r]=p.useState(null);if(p.useEffect(()=>{const l=document.querySelector('[data-test="canvas-tab-bar"]'),d=document.querySelector('[data-test="canvas-chat-input-container"]');if(l&&d){const u=l.getBoundingClientRect(),h=d.getBoundingClientRect();r({top:u.bottom,bottom:window.innerHeight-h.top})}else r({top:Z.holdToSelect.indicatorTopOffset,bottom:Z.holdToSelect.indicatorBottomOffset})},[e]),p.useEffect(()=>{if(!e){n(0);return}let l;const d=Date.now(),u=e.durationMs,h=()=>{const g=Date.now()-d,f=Math.min(g/u,1);n(f),f<1&&e&&(l=requestAnimationFrame(h))};return l=requestAnimationFrame(h),()=>{l&&cancelAnimationFrame(l)}},[e]),!e||!o)return null;const i=e.touchX<window.innerWidth/2?"right":"left",c=s*100;return t.jsx("div",{className:je("fixed w-0.5 z-50 pointer-events-none",i==="left"?"left-1":"right-1"),style:{top:`${o.top}px`,bottom:`${o.bottom}px`},"data-test":"hold-progress-indicator",children:t.jsxs("div",{className:"relative w-full h-full flex items-center justify-center",children:[t.jsx("div",{className:"absolute w-full bg-primary rounded-full",style:{height:`${c}%`,top:`${50-c/2}%`},"data-test":"hold-progress-line"}),t.jsx("div",{className:"absolute bg-primary/30 rounded-full blur-sm",style:{height:`${c}%`,top:`${50-c/2}%`,width:"2px"},"data-test":"hold-progress-glow"}),t.jsx("div",{className:je("absolute w-0.5 h-0.5 rounded-full bg-primary shadow-lg transition-transform duration-150",s>0?"scale-100":"scale-0"),style:{top:"50%",transform:`translateY(-50%) scale(${s>0?1:0})`},"data-test":"hold-progress-dot"})]})})},co=50,_S=()=>{var i;const e=z(c=>c.uiState.nodeHoldToResize),s=(i=e==null?void 0:e.edge)==null?void 0:i.includes("-");if(!e||!s||e.touchX===void 0||e.touchY===void 0)return null;const{touchX:n,touchY:o,isHolding:r,isReady:a}=e;return t.jsx("div",{className:je("fixed rounded-full pointer-events-none","transition-all duration-150",a?"bg-emerald-500/30 shadow-[0_0_20px_10px_rgba(16,185,129,0.4)]":r?"bg-amber-500/20 shadow-[0_0_15px_8px_rgba(245,158,11,0.3)]":"bg-primary/10"),style:{width:co,height:co,left:n-co/2,top:o-co/2,zIndex:9999},"data-test":"resize-hold-indicator"})},yC=({width:e,height:s,className:n,style:o})=>{var N;const r=p.useRef(null),a="cursor-default",i=z(b=>b.uiState.isHoldSelectActive??!1),c=p.useRef(E.getState().setCanvasDimensions),l=p.useRef(async(b=!1,j)=>{var B,W;const R=E.getState(),S=((B=R.projectCanvas.getActive())==null?void 0:B.coreState.nodes)??[],C=((W=R.projectCanvas.getActive())==null?void 0:W.coreState.arrows)??[];let M=j;if(!M){const P=S.find(k=>{var T;return((T=k.data)==null?void 0:T.nodeType)==="workflowOrchestration"});M=(P==null?void 0:P.id)||"wf-orchestration-001"}const I=new Zs;I.loadWorkflow(S,C);const A=await I.executeWorkflow(M),O=[],F=b?S.map(P=>({...P})):[];return A.nodeStates&&(A.nodeUpdates&&A.nodeUpdates.length>0&&A.nodeUpdates.forEach(P=>{const k=S.find(T=>T.id===P.nodeId);if(k){const T=Array.isArray(k.tags)?k.tags:[],L=P.updates.tags!==void 0?Array.isArray(P.updates.tags)?P.updates.tags:[]:T;if(O.push({nodeId:P.nodeId,before:{title:k.title,content:typeof k.content=="string"?k.content:void 0,tags:T},after:{title:P.updates.title!==void 0?P.updates.title:k.title,content:P.updates.content!==void 0?P.updates.content:typeof k.content=="string"?k.content:void 0,tags:L}}),b){const H=F.find($=>$.id===P.nodeId);H&&(P.updates.title!==void 0&&(H.title=P.updates.title),P.updates.content!==void 0&&(H.content=P.updates.content),P.updates.tags!==void 0&&(H.tags=P.updates.tags))}}b||R.updateNode(P.nodeId,P.updates)}),A.nodeStates.forEach((P,k)=>{var D,Y,te;const T=S.find(ie=>ie.id===k);if(!T)return;const L=(D=T.data)==null?void 0:D.nodeType,H=T.type,G=L==="workflowSource"||H==="WORKFLOW_SOURCE"||(L==="workflowOrchestration"||H==="WORKFLOW_ORCHESTRATION");let V=((Y=P.executionData)==null?void 0:Y.formattedOutput)||((te=P.executionData)==null?void 0:te.output)||T.content;if(V!=null&&typeof V=="object"&&(V=JSON.stringify(V,null,2)),!b){const ie={content:G?T.content:V,data:{...T.data||{},executionState:P.executionState}};R.updateNode(k,ie)}})),{...A,success:A.success,errors:A.errors||[],changes:O,previewNodes:F,currentNodes:S,arrows:C}}),[d,u]=p.useState({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null}),[h,g]=p.useState({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]});p.useEffect(()=>{const b=r.current;if(!b)return;c.current(b.offsetWidth,b.offsetHeight);const j=new ResizeObserver(R=>{for(const S of R){const{width:C,height:M}=S.contentRect;c.current(C,M)}});return j.observe(b),()=>{j.disconnect()}},[]),p.useEffect(()=>{var b;(b=r.current)==null||b.focus()},[]);const f=p.useMemo(()=>({executeWorkflow:(b,j)=>l.current(b,j),showDryRunResults:b=>{g({isVisible:!0,changes:b.changes||[],previewNodes:b.previewNodes||[],currentNodes:b.currentNodes||[],arrows:b.arrows||[],executionResult:b})},showLinkedNodesPopover:(b,j)=>{u({isVisible:!0,sourceNode:b,newlyCreatedNodeId:j||null})}}),[]),w=b=>{const{newlyCreatedNodeId:j}=d;if(j){const R=E.getState(),S=R.getNodeById(j);if(S&&typeof S.content=="string"){const M=(typeof b.content=="string"?b.content:"")+`

`+S.content;R.updateNode(b.id,{content:M}),R.deleteNodeById(j)}}},m=()=>{u({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null})},x=((N=E.getState().projectCanvas.getActive())==null?void 0:N.coreState.nodes)??[],y=z(b=>b.uiState.undoTreeExplorerOpen??!1),v=p.useCallback(b=>{E.getState().setUiState(j=>({...j,undoTreeExplorerOpen:b}))},[]);return t.jsx(ev,{value:f,children:t.jsx(Gp,{value:r,children:t.jsxs("div",{className:"flex flex-col",style:{width:e,height:s},children:[t.jsx(Bd,{}),t.jsxs("div",{ref:r,id:"CanvasAppV2","data-canvas-container":!0,className:je("relative","overflow-hidden","focus:outline-none","flex-1",a,n,i&&"ring-2 ring-inset ring-primary/50 bg-primary/5"),style:{touchAction:"none",...o},tabIndex:0,children:[t.jsx(dm,{}),t.jsx(OS,{}),t.jsx(zS,{}),t.jsx(_S,{}),d.sourceNode&&t.jsx(LS,{sourceNode:d.sourceNode,allNodes:x,onNodeSelect:w,onClose:m,isVisible:d.isVisible}),t.jsx(WS,{isVisible:h.isVisible,changes:h.changes,previewNodes:h.previewNodes,currentNodes:h.currentNodes,arrows:h.arrows,executionResult:h.executionResult,onApply:async()=>{g({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]}),await l.current(!1)},onCancel:()=>{g({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]})}}),t.jsx(BS,{open:y,onOpenChange:v})]})]})})})};export{yC as C,As as E,wC as a,Al as c,_p as s,z as u};
