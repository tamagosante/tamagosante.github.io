var yi=Object.defineProperty;var Ni=(e,t,n)=>t in e?yi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var fe=(e,t,n)=>Ni(e,typeof t!="symbol"?t+"":t,n);import{j as i,r as S,R as je,b as bi}from"./react-vendor-BOZDwKwV.js";import{C as K,n as re,b as H,a as Z,W as Le}from"./index.browser-BYu060nj.js";import{_ as wr,bx as wn,by as st,bz as Bt,as as Mn,aM as Be,B as X,W as ve,aH as ft,aI as gt,aJ as pt,aK as ht,bw as vr,a8 as Ci,bA as qe,S as Pn,a as _n,b as On,c as Fn,d as $n,be as Sr,bf as yr,bg as Nr,bh as br,bi as Cr,w as it,aq as ji,ac as Uo,ad as Go,ae as Yo,q as Vt,aL as We,bo as jr,y as Ii,a3 as ki,bj as Ri,z as Ei,E as Ai,bk as Ti,aD as Xo,Z as Di,$ as Mi,a0 as Pi,bB as ws,bC as vs,bD as Ss,bE as at,bF as _i,bG as Kn,X as ys,bH as Ns}from"./index-Cmkaodfg.js";import{s as Oi,b as Fi,c as $i}from"./string-C17ai3Kd.js";import{b as Li}from"./random-CIc2u2bh.js";import{t as oe}from"./utils-CGefl9Xh.js";import{a as ae}from"./ui-utils-BxIQ3qGg.js";import{aA as bs,c as Ko,az as Hi,ap as jt,be as Cs,aK as Ir,a7 as Ut,r as Wi,z as zi,q as pn,W as vn,x as Ln,n as Bi,bi as Vi,H as Ui,bj as Gi,bk as Gt,j as Yi,d as Xi,bl as Ki,y as mt,O as Sn,t as yn,b7 as qi,bm as Zi,aS as Ji,D as Ke,bn as kr,bo as Qi,bp as Rr,bq as ea,J as qo,ab as Nn,br as js,bs as Er,bt as ta,bu as na,bv as oa,bw as sa,bx as Ar,a4 as Tr,L as ra,F as ia,by as aa,M as la,m as Is,bz as hn,bA as ca,bf as da,bB as ua,bC as fa,g as ga,bD as pa,bE as ks,ad as ha,bF as ma,bG as Rs,bH as xa,bI as wa,X as Ze,V as Oe,ao as bn,bc as va,bJ as Sa,v as Hn,bK as ya,ak as Na,bL as ba,an as Zo,bM as Dr,Y as ho,aE as Ca,a2 as ja,I as mo,ah as xo,aj as Ia,bN as ka,bO as Ra,A as Ea,bP as Aa,bQ as Ta,k as Da,aa as Ma,a8 as Pa,E as _a,aH as Oa,bR as Fa,am as $a,ag as La}from"./icons-Cf9puwNc.js";import{T as Ha}from"./TextareaPopoverAtCursor-CTiQM1rI.js";import{d as Wa,t as Es}from"./definitionHelper-cMYKfgYf.js";import{T as za}from"./textarea-BYE7lOdv.js";import{D as Ba}from"./DragDropManager-BCQ9eUTy.js";import{D as Va}from"./DraggableTree-CLiJf_vF.js";import{u as Ua}from"./useOcr-UEiJANMF.js";import{A as Ga,a as Ya}from"./alert-DmIJ9i2z.js";import{D as Xa}from"./DraggableCrudTree-Cnti-YJb.js";import{E as Ka}from"./easy-form-BOcKu_hU.js";import{M as qa}from"./MobileLogViewerButton-vWqOu4ib.js";const Mr=S.createContext(null),Za=({children:e,value:t})=>i.jsx(Mr.Provider,{value:t,children:e}),Jo=()=>{const e=S.useContext(Mr);if(e===null)throw new Error("useCanvasRef must be used within a CanvasRefProvider");return e},Ja=e=>{const t=Jo(),n=S.useRef(e);S.useEffect(()=>{n.current=e},[e]),S.useEffect(()=>{const o=t.current;if(!o)return;const s=j=>{var C,I;return(I=(C=n.current.pointer)==null?void 0:C.onPointerDown)==null?void 0:I.call(C,j)},r=j=>{var E,y;const C=['[data-prevent-canvas-click="true"]'],I=j.target;if(C.some(v=>I.closest(v)))return;const T=j;(y=(E=n.current.pointer)==null?void 0:E.onDblClick)==null||y.call(E,T)},a=j=>{var C,I;return(I=(C=n.current.pointer)==null?void 0:C.onPointerMove)==null?void 0:I.call(C,j)},l=j=>{var C,I;return(I=(C=n.current.pointer)==null?void 0:C.onPointerUp)==null?void 0:I.call(C,j)},c=j=>{var C,I;return(I=(C=n.current.pointer)==null?void 0:C.onPointerLeave)==null?void 0:I.call(C,j)},d=j=>{var T,E;const C=["#itemList"],I=j.target;C.some(y=>I.closest(y))||(E=(T=n.current).wheel)==null||E.call(T,j)},u=j=>{var C,I;return(I=(C=n.current.keyboard)==null?void 0:C.onKeyDown)==null?void 0:I.call(C,j)},g=j=>{var C,I;return(I=(C=n.current.keyboard)==null?void 0:C.onKeyUp)==null?void 0:I.call(C,j)},p=j=>{var C,I;return(I=(C=n.current.keyboard)==null?void 0:C.onCopy)==null?void 0:I.call(C,j)},f=j=>{var C,I;return(I=(C=n.current.touch)==null?void 0:C.onTouchStart)==null?void 0:I.call(C,j)},h=j=>{var C,I;return(I=(C=n.current.touch)==null?void 0:C.onTouchMove)==null?void 0:I.call(C,j)},m=j=>{var C,I;return(I=(C=n.current.touch)==null?void 0:C.onTouchEnd)==null?void 0:I.call(C,j)},{pointer:x,wheel:w,touch:b,keyboard:N}=e;return x!=null&&x.onPointerDown&&o.addEventListener("pointerdown",s),x!=null&&x.onDblClick&&o.addEventListener("dblclick",r),x!=null&&x.onPointerMove&&o.addEventListener("pointermove",a),x!=null&&x.onPointerUp&&window.addEventListener("pointerup",l),x!=null&&x.onPointerLeave&&o.addEventListener("pointerleave",c),w&&o.addEventListener("wheel",d,{passive:!1}),b!=null&&b.onTouchStart&&o.addEventListener("touchstart",f,{passive:!1}),b!=null&&b.onTouchMove&&o.addEventListener("touchmove",h,{passive:!1}),b!=null&&b.onTouchEnd&&o.addEventListener("touchend",m,{passive:!1}),N!=null&&N.onKeyDown&&window.addEventListener("keydown",u),N!=null&&N.onKeyUp&&window.addEventListener("keyup",g),N!=null&&N.onCopy&&window.addEventListener("copy",p),()=>{x!=null&&x.onPointerDown&&o.removeEventListener("pointerdown",s),x!=null&&x.onPointerMove&&o.removeEventListener("pointermove",a),x!=null&&x.onPointerUp&&window.removeEventListener("pointerup",l),x!=null&&x.onPointerLeave&&o.removeEventListener("pointerleave",c),w&&o.removeEventListener("wheel",d),b!=null&&b.onTouchStart&&o.removeEventListener("touchstart",f),b!=null&&b.onTouchMove&&o.removeEventListener("touchmove",h),b!=null&&b.onTouchEnd&&o.removeEventListener("touchend",m),N!=null&&N.onKeyDown&&window.removeEventListener("keydown",u),N!=null&&N.onKeyUp&&window.removeEventListener("keyup",g)}},[t])},Qo=()=>{const e=Jo();return S.useCallback(t=>{const n=e.current;if(!n)return console.error("Canvas container ref not available in useGetRelativeMousePos"),{x:0,y:0};const o=n.getBoundingClientRect();return{x:t.clientX-o.left,y:t.clientY-o.top}},[e])},Te=(e,t,n)=>({x:Number(((e.x-n.x)/t).toFixed(3)),y:Number(((e.y-n.y)/t).toFixed(3))}),As=e=>{let t;const n=new Set,o=(d,u)=>{const g=typeof d=="function"?d(t):d;if(!Object.is(g,t)){const p=t;t=u??(typeof g!="object"||g===null)?g:Object.assign({},t,g),n.forEach(f=>f(t,p))}},s=()=>t,l={setState:o,getState:s,getInitialState:()=>c,subscribe:d=>(n.add(d),()=>n.delete(d))},c=t=e(o,s,l);return l},es=(e=>e?As(e):As),Qa=e=>e;function ts(e,t=Qa){const n=je.useSyncExternalStore(e.subscribe,je.useCallback(()=>t(e.getState()),[e,t]),je.useCallback(()=>t(e.getInitialState()),[e,t]));return je.useDebugValue(n),n}class Ts{static loadPreset(t){const n=new Map,o=this.convertStepsToRows(t.steps,n),s=n.get(1)||"row_1";return{id:`wf-preset-${t.id}`,x:0,y:0,width:400,height:300,type:K.RECT,title:t.name,content:t.description,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:o},inputHandles:[{id:`input_${s}`,name:"All Nodes",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Result",type:"output",dataType:"any"}]}}}static convertStepsToRows(t,n,o){return t.map(s=>{const r=re();n.set(s.order,r);const a={id:r,label:s.label,order:s.order,stepType:s.type};if(s.config){const l=JSON.parse(JSON.stringify(s.config));l.dataSource==="row_1"&&(l.dataSource=n.get(1)||"row_1"),a.config=l}return s.children&&s.children.length>0&&(a.children=this.convertStepsToRows(s.children,n,s.order)),a})}static async loadPresetFromFile(t){const n=await wr(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]),o=JSON.parse(n.readFileSync(t,"utf-8"));return this.loadPreset(o)}}const el="add-index-to-title",tl="Add Index to Title",nl="Adds loop index number to each node's title",ol=[{type:"source",label:"All Nodes Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Add index to title",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:"{{loop.index}}. {{loop.current.title}}"}]}}]}],sl={id:el,name:tl,description:nl,steps:ol},rl="clear-all-titles",il="Clear All Titles",al="Clears all node titles",ll=[{type:"source",label:"All Nodes Source",order:1},{type:"loop",label:"Loop through nodes",order:2,children:[{type:"nodeUpdate",label:"Clear title",order:20,config:{mode:"simple",dataSource:"row_1",simpleFieldUpdates:[{field:"title",template:""}]}}]}],cl={id:rl,name:il,description:al,steps:ll};function dl(){const e="workflow-templates-project",t="workflow-templates-workspace",n=Ts.loadPreset(sl),o=Ts.loadPreset(cl),s="canvas-workflow-presets",r={id:s,name:"ðŸŽ¨ Workflow Presets",createdAt:Date.now(),lastModified:Date.now(),coreState:{nodes:[{id:re(8),x:50,y:50,type:K.TEXT,content:`ðŸŽ¨ Workflow Presets Library

Reusable workflow templates powered by JSON configuration.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

How to Use:
1. Copy a preset workflow node below (Ctrl+C / Cmd+C)
2. Paste into your target canvas (Ctrl+V / Cmd+V)
3. Click Execute button on the workflow node
4. Done! All canvas nodes are processed automatically

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Key Features (WF-32):
âœ… Source node is OPTIONAL - workflows iterate through all canvas nodes
âœ… Templates use loop context: {{loop.index}}, {{loop.current.title}}
âœ… Simple mode with field updates or advanced mode with explicit targets

See: _docs/guidelines/canvas/workflow-presets-and-execution.md`,styles:{fontSize:"14px",fontWeight:"bold",textColor:"#1f2937"}},{id:re(8),x:50,y:400,type:K.TEXT,content:`ðŸ“ Add Index to Title

Adds sequential numbers to node titles.
Template: {{loop.index}}. {{loop.current.title}}

Result: "1. Title", "2. Title", "3. Title", etc.`,styles:{fontSize:"13px",textColor:"#1f2937"}},{...n,x:50,y:550},{id:re(8),x:450,y:400,type:K.TEXT,content:`ðŸ—‘ï¸ Clear All Titles

Removes all node titles.
Template: "" (empty string)

Result: All nodes have empty titles.`,styles:{fontSize:"13px",textColor:"#1f2937"}},{...o,x:450,y:550}],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1,targetView:null}},a={id:t,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),canvases:{[s]:r},activeCanvasId:s};return{id:e,name:"Workflow Templates",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[t]:a},activeWorkspaceId:t}}const ul=[{id:re(8),x:600,y:100,type:K.TEXT,content:"Node 2 - Text"}],ut={nameInput:"wf-name-input-001",orchestration:"wf-orchestration-001",output:"wf-output-001"},fl=[{id:ut.nameInput,x:100,y:350,width:200,height:80,type:K.TEXT,title:"âœï¸ Processing {{loop.current}}",content:`Alice
Bob
Carol`,data:{nodeType:"textInput",parameters:{label:"Enter your name",placeholder:"Type your name here...",defaultValue:"John"},inputHandles:[],outputHandles:[{id:"output_main",name:"User Input",type:"output",dataType:"string"}]},styles:{backgroundColor:"#3b82f6",textColor:"#ffffff",borderColor:"#2563eb"}},{id:ut.orchestration,x:400,y:250,width:200,height:360,type:K.RECT,title:"ðŸ”€ Workflow: {{loop.current}}",content:"Orchestrate steps",data:{nodeType:"workflowOrchestration",showExecuteButton:!0,executeButtonPosition:"top-right",parameters:{rows:[{id:"row_1",label:"Step 1: Source",order:1,stepType:"source"},{id:"row_2",label:"Step 2: Loop",order:2,stepType:"loop",children:[{id:"row_3",label:"Step 3: Update Nodes",order:3,stepType:"nodeUpdate",config:{dataSource:"row_1",targets:[{nodeId:"wf-name-input-001",updates:{title:"âœï¸ Processing {{loop.current}}"}},{nodeId:"wf-orchestration-001",updates:{title:"ðŸ”€ Workflow: {{loop.current}}"}},{nodeId:"wf-output-001",updates:{title:"ðŸ“¤ Output: {{loop.current}}"}}]}}]}]},inputHandles:[{id:"input_row_1",name:"Step 1 Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Combined Output",type:"output",dataType:"object"}]},styles:{backgroundColor:"#8b5cf6",textColor:"#ffffff",borderColor:"#7c3aed"}},{id:"wf-email-input-001",x:100,y:470,width:200,height:80,type:K.TEXT,title:"ðŸ“§ Item {{loop.index}}/{{loop.total}}",content:"john@example.com",data:{nodeType:"textInput",parameters:{label:"Enter your email",placeholder:"Type your email here...",defaultValue:"john@example.com"},inputHandles:[],outputHandles:[{id:"output_main",name:"Email",type:"output",dataType:"string"}]},styles:{backgroundColor:"#3b82f6",textColor:"#ffffff",borderColor:"#2563eb"}},{id:"wf-source-001",x:100,y:600,width:200,height:120,type:K.TEXT,title:"ðŸ“¦ Data Source",content:'{"users": ["Alice", "Bob", "Carol"], "count": 3, "timestamp": "2025-11-12"}',data:{nodeType:"workflowSource",displayFormat:"json",inputHandles:[],outputHandles:[{id:"output_main",name:"Source Data",type:"output",dataType:"object"}]},styles:{backgroundColor:"#10b981",textColor:"#ffffff",borderColor:"#059669"}},{id:ut.output,x:700,y:250,width:200,height:180,type:K.TEXT,title:"ðŸ“¤ Output: {{loop.current}}",content:"Display result",data:{nodeType:"textOutput",parameters:{template:"{{input}}"},inputHandles:[{id:"input_main",name:"Data",type:"input",dataType:"any"}],outputHandles:[{id:"output_main",name:"Formatted Output",type:"output",dataType:"string"}]},styles:{backgroundColor:"#f59e0b",textColor:"#ffffff",borderColor:"#d97706"}},{id:re(8),x:100,y:50,type:K.TEXT,content:`ðŸ“‹ Workflow Demo: nodeUpdate Step Type
Source â†’ Loop â†’ nodeUpdate step updates any node fields (title, content, styles, etc.)
Click play button (top right of workflow node) â†’ Titles show {{loop.current}} = Alice`,styles:{fontSize:"14px",fontWeight:"bold",textColor:"#1f2937"}}],gl=[{id:"wf-arrow-001",startNodeId:ut.nameInput,endNodeId:ut.orchestration,startPoint:{x:300,y:390},endPoint:{x:400,y:290},label:"step 1"},{id:"wf-arrow-003",startNodeId:ut.orchestration,endNodeId:ut.output,startPoint:{x:600,y:320},endPoint:{x:700,y:320},label:"combined"}],pl={nodes:fl,arrows:gl,selectedNodes:[],selectedArrows:[]},hl={offset:{x:50,y:50},scale:1,targetView:null},wo=re(10),ml={id:wo,name:"My First Canvas",createdAt:Date.now(),lastModified:Date.now(),coreState:pl,viewState:hl},vo=re(10),xl={id:vo,name:"Default Workspace",createdAt:Date.now(),lastModified:Date.now(),canvases:{[wo]:ml},activeCanvasId:wo},So=re(10),wl={id:So,name:"My Project",createdAt:Date.now(),lastModified:Date.now(),workspaces:{[vo]:xl},activeWorkspaceId:vo},Ue={version:"3.6.8",dataVersion:"1.0.0",flags:{debug:{logEvents:!1,showDebugOverlay:!0},feature:{}},preferences:{segmentedButtons:{}},uiState:{mode:H.SELECT,addNodeType:K.TEXT,isPanning:!1,isDrawing:!1,mouseCursor:"cursor-default",selectionBox:null,temporaryArrow:null,nodeToFocusId:null,isOverlayVisible:!1,useCurvedArrows:!1,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},toolbar:{isVisible:!0,toolbarActions:[]},overlay:{}},state:{nodes:ul,projects:{[So]:wl,"workflow-templates-project":dl()},activeProjectId:So}},vl=(e,t,n,o,s)=>{const r=e.x+(e.width??100)/2,a=e.y+(e.height??50)/2,l=(s==null?void 0:s.verticalPositionRatio)??.5,c=n/2-r*t,d=o*l-a*t;return{x:c,y:d}},Sl=(e,t,n,o=500,s)=>{const{uiState:r,projectCanvas:a,setActiveCanvasViewState:l}=t(),c=a.getActive();if(!c){console.warn("Cannot center view: No active canvas.");return}const d=c.coreState.nodes,u=c.viewState.scale,g=typeof n=="string"?d==null?void 0:d.find(w=>w.id===n):n,p=r==null?void 0:r.canvasWidth,f=r==null?void 0:r.canvasHeight;if(!g){console.warn("Cannot center view: Node dimensions not found.");return}if(!p||!f){console.warn("Cannot center view: Canvas dimensions not found.");return}const h=vl(g,u,p,f,s!=null&&s.verticalOnly?{verticalPositionRatio:Z.writeMode.scrollVerticalPositionRatio}:void 0),m=c.viewState.offset,x=s!=null&&s.verticalOnly?{x:m.x,y:h.y}:h;l(w=>({...w,targetView:{targetOffset:x,targetScale:u,animationStartTime:0,animationDuration:o}}))},yl=(e,t)=>{e(n=>{const o=n.projectCanvas.getActive();if(!o)return{};const s=new Set(o.coreState.selectedNodes.map(r=>r.id));return s.size===0?{}:(n.setActiveCanvasCoreState(r=>{const a=r.nodes.filter(c=>!s.has(c.id)),l=r.arrows.filter(c=>!(c.startNodeId&&s.has(c.startNodeId)||c.endNodeId&&s.has(c.endNodeId)));return{...r,nodes:a,arrows:l,selectedNodes:[]}}),{})})},Nl=(e,t)=>{e(n=>{const o=n.projectCanvas.getActive();if(!o)return{};const s=new Set(o.coreState.selectedArrows.map(r=>r.id));return s.size===0?{}:(n.setActiveCanvasCoreState(r=>{const a=r.arrows.filter(l=>!s.has(l.id));return{...r,arrows:a,selectedArrows:[]}}),{})})},Rt=e=>(t,n)=>{e(o=>{if(!o.state)return o;const s=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,r=s&&s.activeWorkspaceId?s.workspaces[s.activeWorkspaceId]:null,a=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!a)return o;const l=a.coreState,c=l.nodes.findIndex(h=>h.id===t);if(c===-1)return o;const d=new Date().toISOString(),u={...n,updatedAt:d},g=[...l.nodes];g[c]={...g[c],...u};const f=l.selectedNodes.some(h=>h.id===t)?l.selectedNodes.map(h=>h.id===t?{...h,...u}:h):l.selectedNodes;return window.__nodes=g,window.__selectedNodes=f,{...o,state:{...o.state,projects:{...o.state.projects,[o.state.activeProjectId]:{...s,lastModified:Date.now(),workspaces:{...s.workspaces,[s.activeWorkspaceId]:{...r,lastModified:Date.now(),canvases:{...r.canvases,[r.activeCanvasId]:{...a,coreState:{...l,nodes:g,selectedNodes:f},lastModified:Date.now()}}}}}}}}})},bl=e=>{const{projectCanvas:t}=e(),n=bt.getState(),o=n==null?void 0:n.mousePosition,s=t.getActive(),r=(s==null?void 0:s.viewState.scale)??1,a=(s==null?void 0:s.viewState.offset)??{x:0,y:0};return!o||!s?null:Te(o,r,a)};var Pr=Symbol.for("immer-nothing"),Ds=Symbol.for("immer-draftable"),De=Symbol.for("immer-state");function _e(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var Yt=Object.getPrototypeOf;function It(e){return!!e&&!!e[De]}function xt(e){var t;return e?_r(e)||Array.isArray(e)||!!e[Ds]||!!((t=e.constructor)!=null&&t[Ds])||qt(e)||zn(e):!1}var Cl=Object.prototype.constructor.toString(),Ms=new WeakMap;function _r(e){if(!e||typeof e!="object")return!1;const t=Object.getPrototypeOf(e);if(t===null||t===Object.prototype)return!0;const n=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;if(n===Object)return!0;if(typeof n!="function")return!1;let o=Ms.get(n);return o===void 0&&(o=Function.toString.call(n),Ms.set(n,o)),o===Cl}function Cn(e,t,n=!0){Wn(e)===0?(n?Reflect.ownKeys(e):Object.keys(e)).forEach(s=>{t(s,e[s],e)}):e.forEach((o,s)=>t(s,o,e))}function Wn(e){const t=e[De];return t?t.type_:Array.isArray(e)?1:qt(e)?2:zn(e)?3:0}function yo(e,t){return Wn(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Or(e,t,n){const o=Wn(e);o===2?e.set(t,n):o===3?e.add(n):e[t]=n}function jl(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}function qt(e){return e instanceof Map}function zn(e){return e instanceof Set}function ct(e){return e.copy_||e.base_}function No(e,t){if(qt(e))return new Map(e);if(zn(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const n=_r(e);if(t===!0||t==="class_only"&&!n){const o=Object.getOwnPropertyDescriptors(e);delete o[De];let s=Reflect.ownKeys(o);for(let r=0;r<s.length;r++){const a=s[r],l=o[a];l.writable===!1&&(l.writable=!0,l.configurable=!0),(l.get||l.set)&&(o[a]={configurable:!0,writable:!0,enumerable:l.enumerable,value:e[a]})}return Object.create(Yt(e),o)}else{const o=Yt(e);if(o!==null&&n)return{...e};const s=Object.create(o);return Object.assign(s,e)}}function ns(e,t=!1){return Bn(e)||It(e)||!xt(e)||(Wn(e)>1&&Object.defineProperties(e,{set:Qt,add:Qt,clear:Qt,delete:Qt}),Object.freeze(e),t&&Object.values(e).forEach(n=>ns(n,!0))),e}function Il(){_e(2)}var Qt={value:Il};function Bn(e){return e===null||typeof e!="object"?!0:Object.isFrozen(e)}var kl={};function wt(e){const t=kl[e];return t||_e(0,e),t}var Xt;function Fr(){return Xt}function Rl(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Ps(e,t){t&&(wt("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function bo(e){Co(e),e.drafts_.forEach(El),e.drafts_=null}function Co(e){e===Xt&&(Xt=e.parent_)}function _s(e){return Xt=Rl(Xt,e)}function El(e){const t=e[De];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function Os(e,t){t.unfinalizedDrafts_=t.drafts_.length;const n=t.drafts_[0];return e!==void 0&&e!==n?(n[De].modified_&&(bo(t),_e(4)),xt(e)&&(e=jn(t,e),t.parent_||In(t,e)),t.patches_&&wt("Patches").generateReplacementPatches_(n[De].base_,e,t.patches_,t.inversePatches_)):e=jn(t,n,[]),bo(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==Pr?e:void 0}function jn(e,t,n){if(Bn(t))return t;const o=e.immer_.shouldUseStrictIteration(),s=t[De];if(!s)return Cn(t,(r,a)=>Fs(e,s,t,r,a,n),o),t;if(s.scope_!==e)return t;if(!s.modified_)return In(e,s.base_,!0),s.base_;if(!s.finalized_){s.finalized_=!0,s.scope_.unfinalizedDrafts_--;const r=s.copy_;let a=r,l=!1;s.type_===3&&(a=new Set(r),r.clear(),l=!0),Cn(a,(c,d)=>Fs(e,s,r,c,d,n,l),o),In(e,r,!1),n&&e.patches_&&wt("Patches").generatePatches_(s,n,e.patches_,e.inversePatches_)}return s.copy_}function Fs(e,t,n,o,s,r,a){if(s==null||typeof s!="object"&&!a)return;const l=Bn(s);if(!(l&&!a)){if(It(s)){const c=r&&t&&t.type_!==3&&!yo(t.assigned_,o)?r.concat(o):void 0,d=jn(e,s,c);if(Or(n,o,d),It(d))e.canAutoFreeze_=!1;else return}else a&&n.add(s);if(xt(s)&&!l){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1||t&&t.base_&&t.base_[o]===s&&l)return;jn(e,s),(!t||!t.scope_.parent_)&&typeof o!="symbol"&&(qt(n)?n.has(o):Object.prototype.propertyIsEnumerable.call(n,o))&&In(e,s)}}}function In(e,t,n=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&ns(t,n)}function Al(e,t){const n=Array.isArray(e),o={type_:n?1:0,scope_:t?t.scope_:Fr(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let s=o,r=os;n&&(s=[o],r=Kt);const{revoke:a,proxy:l}=Proxy.revocable(s,r);return o.draft_=l,o.revoke_=a,l}var os={get(e,t){if(t===De)return e;const n=ct(e);if(!yo(n,t))return Tl(e,n,t);const o=n[t];return e.finalized_||!xt(o)?o:o===qn(e.base_,t)?(Zn(e),e.copy_[t]=Io(o,e)):o},has(e,t){return t in ct(e)},ownKeys(e){return Reflect.ownKeys(ct(e))},set(e,t,n){const o=$r(ct(e),t);if(o!=null&&o.set)return o.set.call(e.draft_,n),!0;if(!e.modified_){const s=qn(ct(e),t),r=s==null?void 0:s[De];if(r&&r.base_===n)return e.copy_[t]=n,e.assigned_[t]=!1,!0;if(jl(n,s)&&(n!==void 0||yo(e.base_,t)))return!0;Zn(e),jo(e)}return e.copy_[t]===n&&(n!==void 0||t in e.copy_)||Number.isNaN(n)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=n,e.assigned_[t]=!0),!0},deleteProperty(e,t){return qn(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,Zn(e),jo(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){const n=ct(e),o=Reflect.getOwnPropertyDescriptor(n,t);return o&&{writable:!0,configurable:e.type_!==1||t!=="length",enumerable:o.enumerable,value:n[t]}},defineProperty(){_e(11)},getPrototypeOf(e){return Yt(e.base_)},setPrototypeOf(){_e(12)}},Kt={};Cn(os,(e,t)=>{Kt[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}});Kt.deleteProperty=function(e,t){return Kt.set.call(this,e,t,void 0)};Kt.set=function(e,t,n){return os.set.call(this,e[0],t,n,e[0])};function qn(e,t){const n=e[De];return(n?ct(n):e)[t]}function Tl(e,t,n){var s;const o=$r(t,n);return o?"value"in o?o.value:(s=o.get)==null?void 0:s.call(e.draft_):void 0}function $r(e,t){if(!(t in e))return;let n=Yt(e);for(;n;){const o=Object.getOwnPropertyDescriptor(n,t);if(o)return o;n=Yt(n)}}function jo(e){e.modified_||(e.modified_=!0,e.parent_&&jo(e.parent_))}function Zn(e){e.copy_||(e.copy_=No(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var Dl=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.useStrictIteration_=!0,this.produce=(t,n,o)=>{if(typeof t=="function"&&typeof n!="function"){const r=n;n=t;const a=this;return function(c=r,...d){return a.produce(c,u=>n.call(this,u,...d))}}typeof n!="function"&&_e(6),o!==void 0&&typeof o!="function"&&_e(7);let s;if(xt(t)){const r=_s(this),a=Io(t,void 0);let l=!0;try{s=n(a),l=!1}finally{l?bo(r):Co(r)}return Ps(r,o),Os(s,r)}else if(!t||typeof t!="object"){if(s=n(t),s===void 0&&(s=t),s===Pr&&(s=void 0),this.autoFreeze_&&ns(s,!0),o){const r=[],a=[];wt("Patches").generateReplacementPatches_(t,s,r,a),o(r,a)}return s}else _e(1,t)},this.produceWithPatches=(t,n)=>{if(typeof t=="function")return(a,...l)=>this.produceWithPatches(a,c=>t(c,...l));let o,s;return[this.produce(t,n,(a,l)=>{o=a,s=l}),o,s]},typeof(e==null?void 0:e.autoFreeze)=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof(e==null?void 0:e.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy),typeof(e==null?void 0:e.useStrictIteration)=="boolean"&&this.setUseStrictIteration(e.useStrictIteration)}createDraft(e){xt(e)||_e(8),It(e)&&(e=Ml(e));const t=_s(this),n=Io(e,void 0);return n[De].isManual_=!0,Co(t),n}finishDraft(e,t){const n=e&&e[De];(!n||!n.isManual_)&&_e(9);const{scope_:o}=n;return Ps(o,t),Os(void 0,o)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}setUseStrictIteration(e){this.useStrictIteration_=e}shouldUseStrictIteration(){return this.useStrictIteration_}applyPatches(e,t){let n;for(n=t.length-1;n>=0;n--){const s=t[n];if(s.path.length===0&&s.op==="replace"){e=s.value;break}}n>-1&&(t=t.slice(n+1));const o=wt("Patches").applyPatches_;return It(e)?o(e,t):this.produce(e,s=>o(s,t))}};function Io(e,t){const n=qt(e)?wt("MapSet").proxyMap_(e,t):zn(e)?wt("MapSet").proxySet_(e,t):Al(e,t);return(t?t.scope_:Fr()).drafts_.push(n),n}function Ml(e){return It(e)||_e(10,e),Lr(e)}function Lr(e){if(!xt(e)||Bn(e))return e;const t=e[De];let n,o=!0;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,n=No(e,t.scope_.immer_.useStrictShallowCopy_),o=t.scope_.immer_.shouldUseStrictIteration()}else n=No(e,!0);return Cn(n,(s,r)=>{Or(n,s,Lr(r))},o),t&&(t.finalized_=!1),n}var Pl=new Dl,xe=Pl.produce;const ss=e=>{var o,s,r;if(!e.state)return null;const t=e.state.activeProjectId?(o=e.state.projects)==null?void 0:o[e.state.activeProjectId]:null,n=t&&t.activeWorkspaceId?(s=t.workspaces)==null?void 0:s[t.activeWorkspaceId]:null;return n&&n.activeCanvasId?(r=n.canvases)==null?void 0:r[n.activeCanvasId]:null},_l=(e,t)=>e(xe(n=>{n.uiState.temporaryArrow=t})),Ol=(e,t)=>e(xe(n=>{var s,r,a,l,c,d;const o=ss(n);if(o!=null&&o.coreState){const u=typeof t=="function"?t(o.coreState.arrows):t;o.coreState.arrows=u,o.coreState.selectedArrows.length>0&&(o.coreState.selectedArrows=o.coreState.selectedArrows.map(f=>u.find(m=>m.id===f.id)||f)),o.lastModified=Date.now();const g=(l=(a=(r=(s=n.state)==null?void 0:s.projects)==null?void 0:r[n.state.activeProjectId])==null?void 0:a.workspaces)==null?void 0:l[n.state.projects[n.state.activeProjectId].activeWorkspaceId];g&&(g.lastModified=Date.now());const p=(d=(c=n.state)==null?void 0:c.projects)==null?void 0:d[n.state.activeProjectId];p&&(p.lastModified=Date.now())}})),Fl=(e,t)=>e(xe(n=>{var s,r,a,l,c,d;const o=ss(n);if(o!=null&&o.coreState){const u=Array.isArray(t)?t:[],g=new Set(u.map(h=>h.id));o.coreState.selectedArrows=o.coreState.arrows.filter(h=>g.has(h.id)),o.lastModified=Date.now();const p=(l=(a=(r=(s=n.state)==null?void 0:s.projects)==null?void 0:r[n.state.activeProjectId])==null?void 0:a.workspaces)==null?void 0:l[n.state.projects[n.state.activeProjectId].activeWorkspaceId];p&&(p.lastModified=Date.now());const f=(d=(c=n.state)==null?void 0:c.projects)==null?void 0:d[n.state.activeProjectId];f&&(f.lastModified=Date.now())}})),$l=(e,t)=>e(xe(n=>{var s,r,a,l,c,d;const o=ss(n);if(o!=null&&o.coreState){o.coreState.arrows.push(t),o.lastModified=Date.now();const u=(l=(a=(r=(s=n.state)==null?void 0:s.projects)==null?void 0:r[n.state.activeProjectId])==null?void 0:a.workspaces)==null?void 0:l[n.state.projects[n.state.activeProjectId].activeWorkspaceId];u&&(u.lastModified=Date.now());const g=(d=(c=n.state)==null?void 0:c.projects)==null?void 0:d[n.state.activeProjectId];g&&(g.lastModified=Date.now())}})),Ll=(e,t,n,o)=>{e(xe(s=>{var c,d;const r=(c=s.state)!=null&&c.activeProjectId?s.state.projects[s.state.activeProjectId]:null,a=r!=null&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,l=a!=null&&a.activeCanvasId?a.canvases[a.activeCanvasId]:null;if((d=l==null?void 0:l.coreState)!=null&&d.arrows){const u=l.coreState.arrows.findIndex(g=>g.id===n);if(u!==-1){if(l.coreState.arrows[u]={...l.coreState.arrows[u],...o},l.coreState.selectedArrows){const p=l.coreState.selectedArrows.findIndex(f=>f.id===n);p!==-1&&(l.coreState.selectedArrows[p]={...l.coreState.selectedArrows[p],...o})}const g=Date.now();l.lastModified=g,a&&(a.lastModified=g),r&&(r.lastModified=g)}}}))},Hl=(e,t)=>({setTemporary:n=>_l(e,n),setAll:n=>Ol(e,n),setSelected:n=>Fl(e,n),add:n=>$l(e,n),update:(n,o)=>Ll(e,t,n,o)}),Ve=8,q={DEFAULT_NODE_WIDTH:120,DEFAULT_NODE_HEIGHT:34,NODE_X_PADDING:8,NODE_Y_PADDING:8,nodeSpacing:20,NODE_ALIGNMENT_PADDING:16,writeMode:{yRatio:.67},MIN_RESIZE_WIDTH:100,MIN_RESIZE_HEIGHT:100,HANDLE_OFFSET:Ve/2,HANDLE_BG_COLOR:"bg-primary",HANDLE_BORDER_COLOR:"border-primary-foreground",SELECTION_RING_COLOR:"ring-ring",SELECTED_BORDER_COLOR:"border-ring"},Hr={textNodeXPadding:q.NODE_X_PADDING*4},{DEFAULT_NODE_WIDTH:kn,DEFAULT_NODE_HEIGHT:Rn}=q,En=e=>{const t=e.x,n=e.y,o=e.width??kn,s=e.height??Rn;return{x1:t,y1:n,x2:t+o,y2:n+s}},An=(e,t)=>{for(let n=t.length-1;n>=0;n--){const o=t[n],s=En(o);if(e.x>=s.x1&&e.x<=s.x2&&e.y>=s.y1&&e.y<=s.y2)return o}return null},ko=e=>{const t=e.x,n=e.y,o=e.width??kn,s=e.height??Rn;return{x:t+o/2,y:n+s/2}},Wl=(e,t)=>e.x===t.x&&e.y===t.y,Vn=(e,t)=>{const n=wn(e)+q.NODE_X_PADDING*2,s=st(e,n,void 0,t)+q.NODE_Y_PADDING*2;return{width:n,height:s}},zl=(e,t)=>{const n=En(t);return e.filter(o=>{if(o.id===t.id)return!1;const s=En(o);return!(s.x2<n.x1||s.x1>n.x2||s.y2<n.y1||s.y1>n.y2)})},Bl=(e,t="bottom")=>{if(!e.length)return null;switch(t){case"left":return e.reduce((n,o)=>o.x<n.x?o:n,e[0]);case"right":return e.reduce((n,o)=>o.x+(o.width??kn)>n.x+(n.width??kn)?o:n,e[0]);case"top":return e.reduce((n,o)=>o.y<n.y?o:n,e[0]);case"bottom":return e.reduce((n,o)=>o.y+(o.height??Rn)>n.y+(n.height??Rn)?o:n,e[0]);default:return null}},Vl=(e,t)=>e(n=>({uiState:{...n.uiState,mode:t}})),Ul=(e,t)=>e(n=>({uiState:{...n.uiState,zoomSubMode:t}})),Gl=(e,t)=>e(n=>({uiState:{...n.uiState,zoomSubMode:n.uiState.zoomSubMode==="zoom:lock"?"zoom":"zoom:lock"}})),Yl=(e,t)=>e(n=>({uiState:{...n.uiState,writeSubMode:t}})),Xl=(e,t)=>e(n=>({uiState:{...n.uiState,writeSubMode:n.uiState.writeSubMode===Le.AUDIO?Le.WRITE:Le.AUDIO}})),Kl=(e,t)=>e(()=>({mousePosition:t})),ql=(e,t)=>e(n=>({uiState:{...n.uiState,isPanning:t}})),Zl=(e,t)=>e(n=>({uiState:{...n.uiState,selectionBox:t}})),Jl=(e,t)=>e(n=>({uiState:{...n.uiState,writeModeStartPosition:t}})),Ql=(e,t)=>e(n=>({uiState:{...n.uiState,dragInfo:t}})),ec=(e,t)=>e(n=>({uiState:{...n.uiState,resizingNode:t}})),tc=(e,t)=>e(n=>({uiState:{...n.uiState,nodeToFocusId:t}})),nc=(e,t)=>{var o;if(!t)return;const n=e().projectCanvas.getActive();return(o=n==null?void 0:n.coreState.nodes)==null?void 0:o.find(s=>s.id===t)},oc=(e,t)=>e(n=>({uiState:{...n.uiState,addNodeType:t}})),sc=(e,t,n)=>e(o=>({uiState:{...o.uiState,canvasWidth:t,canvasHeight:n}})),rc=(e,t)=>e(n=>({uiState:t(n.uiState)})),ic=(e,t)=>e(n=>(n.setActiveCanvasCoreState(o=>{if(o.nodes.length>0&&t.length===0)return console.trace("NOOO should not happend"),o;const s=typeof t=="function"?t(o.nodes):t;return{...o,nodes:s}}),{})),ac=(e,t)=>e(n=>(n.setActiveCanvasCoreState(o=>{const s=Array.isArray(t)?t:[],r=new Set(s.map(c=>c.id)),a=o.nodes.map(c=>({...c,isEditing:!1})),l=a.filter(c=>r.has(c.id));return{...o,nodes:a,selectedNodes:l}}),{})),lc=(e,t)=>e(n=>(n.setActiveCanvasCoreState(o=>{const s=o.selectedNodes.filter(a=>a.id!==t),r=o.nodes.map(a=>a.id===t?{...a,isEditing:!1}:a);return{...o,nodes:r,selectedNodes:s}}),{})),cc=(e,t,n,o={dontOverlap:!1,dontSelect:!1})=>e(s=>(s.setActiveCanvasCoreState(r=>{const a=new Date().toISOString(),l={...t,createdAt:t.createdAt??a,updatedAt:a};n!==void 0&&(l.content=n);let c=t.y;const d=r.nodes;if(o.dontOverlap){const p=zl(d,t),f=Bl(p);f&&(c=f.y+(f.height??0)),l.y=c+q.nodeSpacing}const u=[...d,l],g=o.dontSelect?r.selectedNodes:[l];return{...r,nodes:u,selectedNodes:g,selectedArrows:o.dontSelect?r.selectedArrows:[]}}),{})),dc=(e,t)=>e(n=>({state:t(n.state)})),uc=e=>(t,n)=>Rt(e)(t,{content:n}),fc=e=>(t,n)=>Rt(e)(t,{subContent:n}),gc=e=>(t,n)=>Rt(e)(t,{title:n}),pc=e=>(t,n)=>Rt(e)(t,{...n}),hc=e=>{var n;const t=e().projectCanvas.getActive();return(n=t==null?void 0:t.coreState.nodes)==null?void 0:n.find(o=>o.isEditing)},mc=(e,t)=>e(n=>(n.setActiveCanvasCoreState(o=>{const s=o.nodes.filter(l=>l.id!==t),r=o.selectedNodes.filter(l=>l.id!==t),a=o.arrows.filter(l=>l.startNodeId!==t&&l.endNodeId!==t);return{...o,nodes:s,selectedNodes:r,arrows:a}}),n.uiState.nodeToFocusId===t&&e(o=>({uiState:{...o.uiState,nodeToFocusId:null}})),{})),xc=e=>e(t=>(t.setActiveCanvasCoreState(n=>({...n,nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]})),{})),wc=(e,t)=>e(n=>({flags:t(n.flags)})),vc=e=>e(Ue),Sc=e=>e(t=>({uiState:{...t.uiState,isOverlayVisible:!t.uiState.isOverlayVisible}})),yc=e=>e(t=>({uiState:{...t.uiState,useCurvedArrows:!t.uiState.useCurvedArrows}})),Nc=(e,t)=>e(n=>({uiState:{...n.uiState,nodeUpdateSettings:{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[],...n.uiState.nodeUpdateSettings||{},...t}}})),bc=(e,t)=>e(n=>({uiState:{...n.uiState,zoomMarks:t.sort((o,s)=>o-s)}})),Cc=(e,t)=>e(n=>{const o=n.uiState.zoomMarks||[];return o.includes(t)?n:{uiState:{...n.uiState,zoomMarks:[...o,t].sort((s,r)=>s-r)}}}),jc=(e,t)=>e(n=>({uiState:{...n.uiState,zoomMarks:(n.uiState.zoomMarks||[]).filter(o=>o!==t)}})),Ic=e=>{const t=e().state;if(!t){console.error("Cannot export: State is not available.");return}const o=JSON.stringify(t,null,2),s=new Blob([o],{type:"application/json"}),r=URL.createObjectURL(s),a=document.createElement("a");a.href=r,a.download=`markop-canvas-export-${new Date().toISOString()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)},kc=(e,t,n={})=>{const{replace:o=!1}=n;try{const s=JSON.parse(t);if((!s||typeof s.projects!="object")&&s.projects!==null)throw new Error("Invalid data format: Missing or invalid 'projects' structure.");const r=s.projects??{};let a=0,l=0;if(o){let c=s.activeProjectId;c&&!r[c]?(console.warn("Imported activeProjectId does not exist in the imported projects. Resetting active project."),c=Object.keys(r)[0]??null):!c&&Object.keys(r).length>0&&(c=Object.keys(r)[0]),a=Object.keys(r).length,e(d=>({...d,state:{projects:r,activeProjectId:c??null,nodes:void 0,arrows:void 0,selectedArrows:void 0},uiState:{...d.uiState,dragInfo:null,resizingNode:null,temporaryArrow:null,selectionBox:null,isPanning:!1,nodeToFocusId:null}})),console.log(`Canvas data replaced: ${a} project(s) imported.`)}else e(c=>{var g;const d=((g=c.state)==null?void 0:g.projects)??{},u={...d};for(const[p,f]of Object.entries(r))d[p]?(l++,console.warn(`Project "${f.name}" (${p}) already exists, skipping.`)):(u[p]=f,a++);return{...c,state:{...c.state,projects:u}}}),console.log(`Canvas data merged: ${a} project(s) imported, ${l} skipped.`);return{projectsImported:a,projectsSkipped:l}}catch(s){return console.error("Failed to import canvas project data:",s),{projectsImported:0,projectsSkipped:0}}},Rc=(e,t,n)=>{const o=re(10),s=Date.now(),r=re(10),a={id:r,name:"Default Canvas",createdAt:s,lastModified:s,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1}},l=re(10),c={id:l,name:"Default Workspace",createdAt:s,lastModified:s,canvases:{[r]:a},activeCanvasId:r},d={id:o,name:n||"New Project",createdAt:s,lastModified:s,workspaces:{[l]:c},activeWorkspaceId:l};return e(xe(u=>{u.state||(u.state={projects:{},activeProjectId:null}),u.state.projects[o]=d,u.state.activeProjectId=o})),o},Ec=(e,t,n)=>{e(xe(o=>{var s;(s=o.state)!=null&&s.projects[n]?o.state.activeProjectId=n:console.warn(`Project with ID ${n} not found.`)}))},Ac=(e,t,n)=>{e(xe(o=>{var s;if((s=o.state)!=null&&s.projects[n]&&(delete o.state.projects[n],o.state.activeProjectId===n)){const r=Object.keys(o.state.projects);o.state.activeProjectId=r.length>0?r[0]:null}}))},Tc=(e,t,n,o)=>{e(xe(s=>{var a;const r=(a=s.state)==null?void 0:a.projects[n];r&&(o.name!==void 0&&(r.name=o.name),r.lastModified=o.lastModified??Date.now())}))},Wr=e=>{const t=e().state;if(!t)return null;const{projects:n,activeProjectId:o}=t;return o?n[o]??null:null},Dc=(e,t)=>({create:n=>Rc(e,t,n),switch:n=>Ec(e,t,n),delete:n=>Ac(e,t,n),updateMetadata:(n,o)=>Tc(e,t,n,o),getActive:()=>Wr(t)}),Mc=(e,t,n)=>{var d;const o=(d=t().state)==null?void 0:d.activeProjectId;if(!o)return null;const s=re(10),r=Date.now(),a=re(10),l={id:a,name:"Default Canvas",createdAt:r,lastModified:r,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1}},c={id:s,name:n||"New Workspace",createdAt:r,lastModified:r,canvases:{[a]:l},activeCanvasId:a};return e(xe(u=>{var p;const g=(p=u.state)==null?void 0:p.projects[o];g&&(g.workspaces[s]=c,g.activeWorkspaceId=s,g.lastModified=r)})),s},Pc=(e,t,n)=>{e(xe(o=>{var r;const s=(r=o.state)!=null&&r.activeProjectId?o.state.projects[o.state.activeProjectId]:null;s&&s.workspaces[n]?(s.activeWorkspaceId=n,s.lastModified=Date.now()):console.warn(`Workspace with ID ${n} not found in active project.`)}))},_c=(e,t,n)=>{e(xe(o=>{var r;const s=(r=o.state)!=null&&r.activeProjectId?o.state.projects[o.state.activeProjectId]:null;if(s&&s.workspaces[n]&&(delete s.workspaces[n],s.lastModified=Date.now(),s.activeWorkspaceId===n)){const a=Object.keys(s.workspaces);s.activeWorkspaceId=a.length>0?a[0]:null}}))},Oc=(e,t,n,o)=>{e(xe(s=>{var l;const r=(l=s.state)!=null&&l.activeProjectId?s.state.projects[s.state.activeProjectId]:null,a=r?r.workspaces[n]:null;if(a){o.name!==void 0&&(a.name=o.name);const c=o.lastModified??Date.now();a.lastModified=c,r&&(r.lastModified=c)}}))},rs=e=>{const t=Wr(e);return t&&t.activeWorkspaceId?t.workspaces[t.activeWorkspaceId]??null:null},Fc=(e,t)=>({create:n=>Mc(e,t,n),switch:n=>Pc(e,t,n),delete:n=>_c(e,t,n),updateMetadata:(n,o)=>Oc(e,t,n,o),getActive:()=>rs(t)}),St={CanvasStateV2:!1,useSelectionHandler:!1,useArrowDrawingV2:!1,useCanvasKeyboardEventsV2:!1,useCanvasMouseEventsV2:!1,WriteModeHandlerV2:!1},$c=(e,t,n)=>{var d;const o=(d=t().state)==null?void 0:d.activeProjectId,s=rs(t),r=s==null?void 0:s.id;if(!o||!r)return null;const a=re(10),l=Date.now(),c={id:a,name:n||"New Canvas",createdAt:l,lastModified:l,coreState:{nodes:[],arrows:[],selectedNodes:[],selectedArrows:[]},viewState:{offset:{x:50,y:50},scale:1}};return e(xe(u=>{var f;const g=(f=u.state)==null?void 0:f.projects[o],p=g==null?void 0:g.workspaces[r];p&&(p.canvases[a]=c,p.activeCanvasId=a,p.lastModified=l,g&&(g.lastModified=l))})),a},Lc=(e,t,n)=>{e(xe(o=>{if(!o.state)return;let s=null,r=null;for(const[d,u]of Object.entries(o.state.projects)){for(const[g,p]of Object.entries(u.workspaces))if(p.canvases[n]){s=d,r=g;break}if(s)break}if(!s||!r){console.warn(`Canvas with ID ${n} not found in any workspace.`);return}const a=Date.now();o.state.activeProjectId!==s&&(o.state.activeProjectId=s);const l=o.state.projects[s];if(!l)return;l.activeWorkspaceId!==r&&(l.activeWorkspaceId=r);const c=l.workspaces[r];c&&(c.activeCanvasId=n,c.lastModified=a,l.lastModified=a)}))},Hc=(e,t,n)=>{e(xe(o=>{var a;const s=(a=o.state)!=null&&a.activeProjectId?o.state.projects[o.state.activeProjectId]:null,r=s&&s.activeWorkspaceId?s.workspaces[s.activeWorkspaceId]:null;if(r&&r.canvases[n]){delete r.canvases[n];const l=Date.now();if(r.lastModified=l,s&&(s.lastModified=l),r.activeCanvasId===n){const c=Object.keys(r.canvases);r.activeCanvasId=c.length>0?c[0]:null}}}))},Wc=(e,t,n,o)=>{e(xe(s=>{var c;const r=(c=s.state)!=null&&c.activeProjectId?s.state.projects[s.state.activeProjectId]:null,a=r&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]:null,l=a?a.canvases[n]:null;if(l){o.name!==void 0&&(l.name=o.name);const d=o.lastModified??Date.now();l.lastModified=d,a&&(a.lastModified=d),r&&(r.lastModified=d)}}))},zc=e=>{const t=rs(e),n=t&&t.activeCanvasId?t.canvases[t.activeCanvasId]??null:null;return window.activeCanvas=n,n},Bc=(e,t)=>({create:n=>$c(e,t,n),switch:n=>Lc(e,t,n),delete:n=>Hc(e,t,n),updateMetadata:(n,o)=>Wc(e,t,n,o),getActive:()=>zc(t)}),Vc=e=>(t,n)=>{Rt(e)(t,{styles:n})};class yt{constructor(t,n=!1){fe(this,"enabled");fe(this,"name");this.name=t,this.enabled=n}setEnabled(t){this.enabled=t}formatMessage(t){return[`[${this.name}]`,...t]}log(...t){this.enabled&&console.log(...this.formatMessage(t))}warn(...t){this.enabled&&console.warn(...this.formatMessage(t))}error(...t){this.enabled&&console.error(...this.formatMessage(t))}}const Uc=(e,t,n,o)=>{const s=n/2-e.x*t,r=o/2-e.y*t;return{x:s,y:r}},Gc=(e,t)=>{const n=t.find(a=>a.id===e.startNodeId),o=t.find(a=>a.id===e.endNodeId),s=n?ko(n):e.startPoint,r=o?ko(o):e.endPoint;return{x:(s.x+r.x)/2,y:(s.y+r.y)/2}},Yc=(e,t,n,o=500)=>{const{uiState:s,projectCanvas:r,setActiveCanvasViewState:a}=t(),l=r.getActive();if(!l){console.warn("Cannot center view: No active canvas.");return}const c=l.coreState.arrows,d=l.coreState.nodes,u=l.viewState.scale,g=s==null?void 0:s.canvasWidth,p=s==null?void 0:s.canvasHeight,f=typeof n=="string"?c==null?void 0:c.find(x=>x.id===n):n;if(!f){console.warn("Cannot center view: Arrow not found.");return}if(!g||!p){console.warn("Cannot center view: Canvas dimensions not found.");return}const h=Gc(f,d),m=Uc(h,u,g,p);a(x=>({...x,targetView:{targetOffset:m,targetScale:u,animationStartTime:performance.now(),animationDuration:o}}))},Xc=e=>t=>{e(xe(n=>{var c;if(!n.state)return;const o=n.state.activeProjectId?n.state.projects[n.state.activeProjectId]:null,s=o&&o.activeWorkspaceId?o.workspaces[o.activeWorkspaceId]:null,r=s&&s.activeCanvasId?s.canvases[s.activeCanvasId]:null;if(!((c=r==null?void 0:r.coreState)!=null&&c.nodes))return;const a=new Date().toISOString();let l=null;r.coreState.nodes=r.coreState.nodes.map(d=>{const u=t.find(f=>f.id===d.id);if(!u)return d;let g=!1,p=!1;for(const f in u)if(u[f]!==d[f]){g=!0,(f==="x"||f==="y")&&(p=!0);break}return g&&p&&(l=d.id),g?{...d,...u,updatedAt:a}:d}),l&&(n.uiState.lastUpdatedNodeId=l),r.lastModified=Date.now(),s&&(s.lastModified=Date.now()),o&&(o.lastModified=Date.now())}),!1)},Kc=/^c-(\d+_)?(.+)$/;function Un(e){const t=Kc.exec(e),n=Li();return t?`${t[1]?`c-${parseInt(t[1],10)+1}_`:"c-1_"}${t[2]}`+n:`c-${e}`+n}Un("abc");Un("c-abc");Un("c-1_abc");const qc=e=>e(t=>(t.setActiveCanvasCoreState(n=>{const o=n.selectedNodes,s=o.map(a=>a.content).join(`
`);Oi(s);const r=o.map(a=>{const l=a.height??q.DEFAULT_NODE_HEIGHT,c=a.y+l+q.nodeSpacing,d=Un(a.id);return{...a,id:d,y:c,x:a.x+q.nodeSpacing}});return{...n,nodes:[...n.nodes,...r],selectedNodes:r}}),{})),Ro="markop-canvas-v2-storage",$s=new yt("CanvasStateV2",St.CanvasStateV2),Zc=()=>{try{const e=localStorage.getItem(Ro);if(e){const t=JSON.parse(e);return t.dataVersion!==Ue.dataVersion?(localStorage.removeItem(Ro),null):{version:t.version,dataVersion:t.dataVersion,state:t.state,uiState:t.uiState,flags:t.flags,preferences:t.preferences}}}catch(e){console.error("[PERSISTENCE] Failed to load from localStorage:",e)}return null},lt=Zc();var mr,xr;const Jc=lt===null?Ue:{...Ue,...lt,uiState:{...Ue.uiState,...lt.uiState||{},temporaryArrow:null,selectionBox:null,dragInfo:null,resizingNode:null},state:{projects:((mr=lt.state)==null?void 0:mr.projects)||((xr=Ue.state)==null?void 0:xr.projects)||{},...Ue.state,...lt.state||{}},flags:{...Ue.flags,...lt.flags||{}},preferences:{...Ue.preferences,...lt.preferences||{}}},Qc=(e,t)=>({...Jc,setMode:n=>Vl(e,n),setZoomSubMode:n=>Ul(e,n),toggleZoomSubMode:()=>Gl(e),setWriteSubMode:n=>Yl(e,n),toggleWriteSubMode:()=>Xl(e),setActiveCanvasViewState:n=>{e(o=>{if(!o.state)return o;const s=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,r=s&&s.activeWorkspaceId?s.workspaces[s.activeWorkspaceId]:null,a=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;if(!a)return o;const l=n(a.viewState);if(l===a.viewState)return o;const c=Date.now();return{...o,state:{...o.state,projects:{...o.state.projects,[o.state.activeProjectId]:{...s,lastModified:c,workspaces:{...s.workspaces,[s.activeWorkspaceId]:{...r,lastModified:c,canvases:{...r.canvases,[r.activeCanvasId]:{...a,viewState:l,lastModified:c}}}}}}}}})},setIsPanning:n=>ql(e,n),setSelectionBox:n=>Zl(e,n),setWriteModeStartPosition:n=>Jl(e,n),setDragInfo:n=>Ql(e,n),setResizingNode:n=>ec(e,n),setNodeToFocusId:n=>tc(e,n),getNodeById:n=>nc(t,n),setAddNodeType:n=>oc(e,n),setCanvasDimensions:(n,o)=>sc(e,n,o),toggleOverlayVisibility:()=>Sc(e),toggleCurvedArrows:()=>yc(e),setNodeUpdateSettings:n=>Nc(e,n),setZoomMarks:n=>bc(e,n),addZoomMark:n=>Cc(e,n),removeZoomMark:n=>jc(e,n),setUiState:n=>rc(e,n),setActiveCanvasCoreState:n=>e(xe(o=>{if(!o.state)return;const s=o.state.activeProjectId?o.state.projects[o.state.activeProjectId]:null,r=s&&s.activeWorkspaceId?s.workspaces[s.activeWorkspaceId]:null,a=r&&r.activeCanvasId?r.canvases[r.activeCanvasId]:null;a&&(a.coreState=n(a.coreState),a.lastModified=Date.now(),r&&(r.lastModified=Date.now()),s&&(s.lastModified=Date.now()))})),setNodes:n=>ic(e,n),setSelectedNodes:n=>ac(e,n),unselectNodeById:n=>lc(e,n),addNode:(n,o,s)=>cc(e,n,o,s),copyNodes:()=>qc(e),setState:n=>dc(e,n),updateNode:(n,o)=>Rt(e)(n,o),updateNodes:n=>Xc(e)(n),updateNodeContent:(n,o)=>uc(e)(n,o),updateNodeSubContent:(n,o)=>fc(e)(n,o),updateNodeTitle:(n,o)=>gc(e)(n,o),updateNodeGeometry:(n,o)=>pc(e)(n,o),updateNodeStyles:(n,o)=>Vc(e)(n,o),getEditingNode:()=>hc(t),project:Dc(e,t),workspace:Fc(e,t),projectCanvas:Bc(e,t),arrow:Hl(e,t),getCanvasMouseCoords:()=>bl(t),deleteSelectedNodes:()=>yl(e),deleteSelectedArrows:()=>Nl(e),deleteNodeById:n=>mc(e,n),deleteAll:()=>xc(e),setFlags:n=>wc(e,n),getSegmentedButtonAction:n=>{var s,r;return((r=(s=t().preferences)==null?void 0:s.segmentedButtons)==null?void 0:r[n])??null},setSegmentedButtonAction:(n,o)=>{e(xe(s=>{s.preferences||(s.preferences={segmentedButtons:{}}),s.preferences.segmentedButtons||(s.preferences.segmentedButtons={}),s.preferences.segmentedButtons[n]=o}))},getKeepArrowsOnSplit:()=>{var o;return((o=t().preferences)==null?void 0:o.keepArrowsOnSplit)??!0},setKeepArrowsOnSplit:n=>{e(xe(o=>{o.preferences||(o.preferences={}),o.preferences.keepArrowsOnSplit=n}))},getLastUsedBorder:()=>{var n,o,s,r,a,l;return{lastUsedColor:((o=(n=t().preferences)==null?void 0:n.borderButton)==null?void 0:o.lastUsedColor)??"hsl(var(--primary))",lastUsedWidth:((r=(s=t().preferences)==null?void 0:s.borderButton)==null?void 0:r.lastUsedWidth)??"1px",lastUsedStyle:((l=(a=t().preferences)==null?void 0:a.borderButton)==null?void 0:l.lastUsedStyle)??"solid"}},setLastUsedBorder:(n,o,s)=>{e(xe(r=>{r.preferences||(r.preferences={}),r.preferences.borderButton||(r.preferences.borderButton={}),r.preferences.borderButton.lastUsedColor=n,r.preferences.borderButton.lastUsedWidth=o,r.preferences.borderButton.lastUsedStyle=s}))},resetState:()=>vc(e),scrollToNode:(n,o=500,s)=>Sl(e,t,n,o,s),scrollToArrow:(n,o=500)=>Yc(e,t,n,o),addTagToNode:(n,o)=>{const s=t().getNodeById(n);if(!s)return;const r=typeof o=="string"?{id:Math.random().toString(36).slice(2,10),title:o}:o,a=s.tags||[];a.some(c=>c.title===r.title)||t().updateNode(n,{tags:[...a,r]})},removeTagFromNode:(n,o)=>{const s=t().getNodeById(n);!s||!s.tags||t().updateNode(n,{tags:s.tags.filter(r=>r.id!==o)})},getNodesByTag:n=>{const o=t().projectCanvas.getActive();return o?(o.coreState.nodes||[]).filter(r=>{var a;return(a=r.tags)==null?void 0:a.some(l=>l.title===n)}):[]},hasTag:(n,o)=>{const s=t().getNodeById(n);return!s||!s.tags?!1:s.tags.some(r=>r.title===o)},exportCanvasData:()=>Ic(t),importCanvasData:(n,o)=>kc(e,n,o),saveStateToLocalStorage:()=>{try{const n={version:t().version,dataVersion:t().dataVersion,state:t().state,uiState:t().uiState,flags:t().flags,preferences:t().preferences},{temporaryArrow:o,selectionBox:s,dragInfo:r,resizingNode:a,...l}=n.uiState,c={...n,uiState:l};localStorage.setItem(Ro,JSON.stringify(c)),$s.log("Canvas state saved to localStorage.")}catch(n){$s.error("Failed to save state to localStorage",n),oe.error("Save failed",{description:n instanceof Error?n.message:"Failed to save canvas",duration:3e3})}}}),ed=Qc,$=es()(ed);let Jn=null;const td=1e3;Z.autosave&&Z.persistState&&$.subscribe(e=>{Jn&&clearTimeout(Jn),Jn=setTimeout(()=>{e.saveStateToLocalStorage()},td)});const nd={mousePosition:null},od=(e,t)=>({...nd,setMousePosition:n=>Kl(e,n)}),bt=es()(od),zr=[],B=e=>ts($,e),kt=e=>ts(bt,e);function sd(e){var n;const t=e;(t==null?void 0:t.tagName)!=="TEXTAREA"&&((n=window.getSelection())==null||n.removeAllRanges())}const He=new yt("useCanvasMouseEventsV2",St.useCanvasMouseEventsV2),rd=e=>{const t=e.target,n=t.closest("[data-canvas-container]");return!n||t.closest("[data-ui-panel]")?null:n},id=()=>{S.useEffect(()=>{const e=()=>{if(document.pointerLockElement===null){const t=$.getState().uiState.mode,n=$.getState().uiState.zoomSubMode;if(t===H.ZOOM&&n==="zoom:lock"){const o=$.getState().setZoomSubMode;o("zoom"),He.log("Pointer lock released, reset to zoom mode")}}};return document.addEventListener("pointerlockchange",e),()=>{document.removeEventListener("pointerlockchange",e)}},[])},ad=e=>{const t=Qo(),n=kt(a=>a.setMousePosition),o=$.getState(),s=o.uiState.mode,r=o.setIsPanning;return S.useCallback(a=>{const l=t(a);n(l),He.log("Generic Pointer Down:",l.x,l.y),sd(a.target);const c=$.getState().uiState.mode,d=$.getState().uiState.zoomSubMode;if(c===H.ZOOM&&a.button===0){const x=rd(a);if(x){const w=$.getState().setZoomSubMode;d==="zoom:lock"?document.exitPointerLock():(x.requestPointerLock(),w("zoom:lock")),a.preventDefault();return}}if(!(a.button===1||a.button===0&&s===H.MOVE||a.button===-1))return;const g=a.target,p=g.closest("[data-node-id]"),f=g.id.includes("resize-handle-"),h=g.closest("[data-ui-panel]");if(f||h)return;let m=!1;s===H.MOVE?m=!0:p||(m=!0),m&&(He.log("Starting Panning"),r(!0),e(l),a.preventDefault())},[t,n,r,e,s])},ld=()=>{var a;const e=Qo(),t=$.getState(),n=(a=t.uiState)==null?void 0:a.isPanning,o=kt(l=>l.setMousePosition),s=t.setActiveCanvasViewState,r=kt(l=>l.mousePosition);return S.useCallback(l=>{const c=$.getState().uiState.mode,d=$.getState().uiState.zoomSubMode,u=document.pointerLockElement!==null;if(c===H.ZOOM&&d==="zoom:lock"&&u){const f=l.movementX,h=l.movementY;s(m=>({...m,offset:{x:m.offset.x+f,y:m.offset.y+h}}));return}const p=e(l);if(n&&r){const f=p.x-r.x,h=p.y-r.y;s(m=>({...m,offset:{x:m.offset.x+f,y:m.offset.y+h}}))}o(p)},[e,o,n,r,s])},cd=e=>{var r;const t=Qo(),n=$.getState(),o=(r=n.uiState)==null?void 0:r.isPanning,s=n.setIsPanning;return S.useCallback(a=>{const l=t(a);He.log("Generic Pointer Up:",l.x,l.y),o&&(s(!1),e(null),He.log("Stopped Panning"))},[t,o,s,e])},dd=e=>{var r;const t=$.getState(),n=(r=t.uiState)==null?void 0:r.isPanning,o=t.setIsPanning,s=kt(a=>a.setMousePosition);return S.useCallback(()=>{n&&(o(!1),e(null),He.log("Stopped Panning (Mouse Leave)")),s(null)},[n,o,e,s])},At={current:null},Qn={current:null},eo={current:0},ud=()=>{const e=$.getState(),t=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=kt(s=>s.mousePosition);return S.useCallback(s=>{s.preventDefault();const r=t();if(!r)return;const{scale:a,offset:l}=r.viewState,d=$.getState().uiState.mode===H.ZOOM;if(s.ctrlKey||s.metaKey||d){if(!o)return;const{min:u,max:g,intensity:p}=Z.zoom,f=s.deltaY<0?1:-1;let h;if(a<=.1){const A=a+f*.01;h=Math.max(u,Math.min(g,A)),h=Math.round(h*100)/100}else{const A=a+f*p*a,T=Math.max(u,Math.min(g,A));h=(f>0?Math.ceil:Math.floor)(T*10)/10}if(h===a)return;const m=Te(o,a,l),x=o.x-m.x*h,w=o.y-m.y*h,b=isNaN(x)?0:x,N=isNaN(w)?0:w,j=isNaN(h)?1:h,C=performance.now(),I=C-eo.current;At.current={newScale:j,newOffsetX:b,newOffsetY:N},I>=16?(n(A=>({...A,scale:j,offset:{x:b,y:N}})),eo.current=C,At.current=null):(Qn.current&&clearTimeout(Qn.current),Qn.current=setTimeout(()=>{if(At.current){const{newScale:A,newOffsetX:T,newOffsetY:E}=At.current;n(y=>({...y,scale:A,offset:{x:T,y:E}})),eo.current=performance.now(),At.current=null}},16-I))}else n(u=>{var w,b;let g=s.deltaX,p=s.deltaY;s.shiftKey&&(g=p,p=0);const f=(((w=u.offset)==null?void 0:w.x)??0)-g,h=(((b=u.offset)==null?void 0:b.y)??0)-p,m=isNaN(f)?0:f,x=isNaN(h)?0:h;return{...u,offset:{x:m,y:x}}})},[t,n,o])},fd=()=>{const e=$.getState(),t=e.uiState.mode,n=e.getCanvasMouseCoords,o=e.addNode,s=e.setNodeToFocusId;return S.useCallback(r=>{if(t!==H.SELECT){He.log("Double Click ignored: Not in SELECT mode.");return}if(r.target.closest("[data-node-id], [data-arrow-id]")){He.log("Double Click ignored: Clicked on existing element.");return}const l=n();if(!l){He.log("Double Click ignored: Could not get canvas coordinates.");return}He.log("Double Click on background: Adding node at",l);const c=re(10);o({id:c,x:l.x,y:l.y,content:"",type:K.TEXT}),s(c),r.preventDefault(),r.stopPropagation()},[t,n,o])};class me{static buildTextNode(t,n,o){return{id:re(10),type:K.TEXT,content:n,x:t.x,y:t.y,width:t.width,height:t.height,styles:o}}static buildTextNodeV2(t){return{id:re(10),type:K.TEXT,content:t.content||"",x:t.x||0,y:t.y||0,width:t.width||100,height:t.height||100,styles:t.styles||{},options:t.options||{lockSize:!0},...t}}static buildTableNode(t){return{id:re(10),type:K.TABLE,content:{data:[{id:"r1",col1:"Data1",col2:"Data2"},{id:"r2",col1:"Data3",col2:"Data4"}]},x:t.x,y:t.y,width:t.width||400,height:t.height||250,styles:{textAlign:"left"}}}static buildTextCardNode(t){return{id:re(10),type:K.TEXTCARD,title:"",content:"",x:t.x,y:t.y,width:t.width||300,height:t.height||150,styles:{textAlign:"left"}}}static buildWorkflowOrchestrationNode(t){return{id:`wf-orchestration-${re(6)}`,type:K.WORKFLOW_ORCHESTRATION,title:"Workflow",content:"",x:t.x,y:t.y,width:t.width||400,height:t.height||500,data:{nodeType:"orchestration",showExecuteButton:!0,parameters:{rows:[{id:"row_1",label:"Step 1",order:1,stepType:"source",children:[]}]}}}}static buildWorkflowSourceNode(t){return{id:`wf-source-${re(6)}`,type:K.WORKFLOW_SOURCE,title:"Source",content:"",x:t.x,y:t.y,width:t.width||300,height:t.height||200,data:{displayFormat:"raw"}}}static buildWorkflowDefinitionNode(t){return{id:`wf-def-${re(6)}`,type:K.WORKFLOW_DEFINITION,title:"Workflow Runner",content:"",x:t.x,y:t.y,width:t.width||280,height:t.height||180,data:{definitionId:void 0,instanceId:void 0,lastExecutionStatus:"idle"}}}static buildOCRNode(t){return{id:`ocr-${re(6)}`,type:K.OCR,title:"OCR",content:"",x:t.x,y:t.y,width:t.width||350,height:t.height||500,data:{image:void 0,extractedText:void 0,detectedLanguage:void 0,confidence:void 0}}}}const gd=Object.freeze(Object.defineProperty({__proto__:null,CanvasNodeBuilderV2:me},Symbol.toStringTag,{value:"Module"}));function is(e,t,n="right",o={}){var d;const{shouldFocus:s=!0}=o,r=$.getState();let a=e.width,l=e.height;if(!a||!l){const u=Z.nodeOptions.maxNodeWidth;a=Math.min(wn(e.content),u)+q.NODE_X_PADDING*2,l=Math.min(st(e.content,u))+q.NODE_Y_PADDING*2}switch((d=r.projectCanvas.getActive())==null||d.viewState.offset,n){case"left":e.x=t.x-a-q.nodeSpacing*3,e.y=t.y;break;case"right":e.x=t.x+(t.width??0)+q.nodeSpacing*3,e.y=t.y;break;case"above":e.y=t.y-q.nodeSpacing*3;break;case"below":e.y=t.y+(t.height??0)+q.nodeSpacing;break}const c={...e,width:a,height:l};r.addNode(c,void 0,{dontOverlap:!0,dontSelect:!0}),s&&r.setNodeToFocusId(t.id);{const u=()=>Math.random().toString(36).slice(2,10),g=p=>({x:(p.x??0)+(p.width??0)/2,y:(p.y??0)+(p.height??0)/2});window.setTimeout(()=>{r.arrow.add({id:u(),startNodeId:t.id,endNodeId:c.id,startPoint:g(t),endPoint:g(c)})},0)}}function Br(e,t,n){let o=e;for(;o&&!o.hasAttribute("data-text-position-container");)o=o.parentElement;if(!o)return null;const s=window.getComputedStyle(e),r=document.createElement("div");r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.visibility="hidden",r.style.font=s.font,r.style.fontSize=s.fontSize,r.style.fontFamily=s.fontFamily,r.style.fontWeight=s.fontWeight,r.style.lineHeight=s.lineHeight,r.style.letterSpacing=s.letterSpacing,r.style.wordSpacing=s.wordSpacing,r.style.padding=s.padding,r.style.width=`${e.clientWidth}px`,r.style.border="none",r.style.whiteSpace=s.whiteSpace,r.style.wordWrap=s.wordWrap,r.style.overflowWrap=s.overflowWrap,r.textContent=e.value,o?o.appendChild(r):document.body.appendChild(r);try{const a=document.createRange(),l=r.firstChild;if(!l||l.nodeType!==Node.TEXT_NODE)return null;a.setStart(l,t),a.setEnd(l,n);const c=a.getClientRects();if(c.length===0)return null;const d=c[0],u=o==null?void 0:o.getBoundingClientRect();if(!u)return null;const g={top:d.top-u.top,left:d.left-u.left},p=parseFloat(s.paddingTop)||0,f=parseFloat(s.paddingLeft)||0,h=g.top-p,m=g.left-f;return{top:h,left:m,width:d.width,height:d.height}}finally{o&&r.parentNode===o?o.removeChild(r):r.parentNode===document.body&&document.body.removeChild(r)}}const Pe=e=>/[\w\u00C0-\u024F]/.test(e);function Ls(e,t){if(!e||t<0||t>e.length)return!1;const n=e[t]||"",o=e[t-1]||"",s=Pe(o),r=Pe(n);return s&&!r||!s&&r}function pd(e,t){if(!e||t<0||t>e.length)return null;const n=e[t]||"",o=e[t-1]||"";if(!Pe(n)&&!Pe(o))return null;let s=t;for(;s>0&&Pe(e[s-1]);)s--;let r=t;for(;r<e.length&&Pe(e[r]);)r++;return s<r?{start:s,end:r,word:e.substring(s,r)}:null}function Hs(e,t){const n=pd(e,t);return n?{start:n.start,end:n.end}:null}function Ws(e,t){if(!e||t<0||t>e.length)return null;let n=t;for(;n>0&&!Pe(e[n-1]);)n--;if(n===0)return null;let o=n;for(;o>0&&Pe(e[o-1]);)o--;let s=t;for(;s<e.length&&!Pe(e[s]);)s++;if(s>=e.length)return null;let r=s;for(;r<e.length&&Pe(e[r]);)r++;return{start:o,end:r}}function zs(e,t){for(;t>0&&Pe(e[t-1]);)t--;return t}function Bs(e,t){for(;t<e.length&&Pe(e[t]);)t++;return t}function hd(e,t,n){var g;const o=document.createRange(),s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let r=0,a=null,l=0,c=null,d=0,u;for(;u=s.nextNode();){const p=((g=u.textContent)==null?void 0:g.length)||0;if(!a&&r+p>=t&&(a=u,l=t-r),!c&&r+p>=n){c=u,d=n-r;break}r+=p}if(a&&c)try{return o.setStart(a,l),o.setEnd(c,d),o}catch(p){return console.warn("Failed to create text range:",p),null}return null}const md="__paste-create__";function xd(e){const t=e.split(md);if(t.length===2)try{return{isContentCapture:!0,data:JSON.parse(t[1])}}catch{return{isContentCapture:!1,content:e}}return{isContentCapture:!1,content:t[0]}}const wd=25,Se=class Se{onMouseDown(t){const n=$.getState(),o=n.uiState,{mode:s,addNodeType:r}=o,a=n.getCanvasMouseCoords();if(s!==H.ADD||r!==K.TEXT||!a)return!1;const l=me.buildTextNode(a,"");return n.addNode(l),n.setNodeToFocusId(l.id),!0}async onPaste(t){var f;const n=$.getState(),o=await Fi();if(!o)return!1;const s=xd(o);if(s.isContentCapture){const h=n.getCanvasMouseCoords();if(h)return this.createNodesFromContentCapture(s.data,h),n.setNodeToFocusId(null),t.preventDefault(),!0}const r=s.isContentCapture?o:s.content,{mode:a,addNodeType:l,nodeToFocusId:c}=n.uiState,d=((f=n.projectCanvas.getActive())==null?void 0:f.coreState.selectedNodes)??[];if(c){const h=n.getNodeById(c);if(h&&typeof h.content=="string"&&d.length>0){const x=(h.content||"")+r;return n.updateNode(h.id,{...h,content:x}),t.preventDefault(),!0}}const u=n.getCanvasMouseCoords(),g=a===H.ADD&&l===K.TEXT&&u,p=!c&&u;if(g){const h=me.buildTextNode(u,r);return n.addNode(h),n.setNodeToFocusId(h.id),n.setMode(H.SELECT),n.setAddNodeType(null),t.preventDefault(),!0}else if(p){const h=n.getSegmentedButtonAction("canvas-fit-width");let m=null;if(h){const j=/Set width to (\d+)px/.exec(h);j&&(m=parseInt(j[1],10))}let x,w,b;if(m)w=Bt(r,{containerWidth:m})+q.NODE_Y_PADDING*2,x=m,b=!0;else{let j;const C=document.querySelector("textarea[data-node-textarea]");if(C){const T=window.getComputedStyle(C).lineHeight;if(T&&T!=="normal"){const E=parseFloat(T);isNaN(E)||(j=E)}}const I=Vn(r,j);x=I.width,w=I.height,b=!1}const N=me.buildTextNodeV2({x:u.x,y:u.y,width:x,height:w,content:r,styles:{textAlign:"left"},options:{lockSize:b}});return n.addNode(N),n.setNodeToFocusId(N.id),t.preventDefault(),!0}return!1}createNodesFromContentCapture(t,n){const o=$.getState(),{pasteWidth:s,nodeGap:r}=Z.contentCapture,a=Math.min(...t.nodes.map(u=>u.x)),l=n.x-a,c=new Map;let d=n.y;for(const u of t.nodes){const g=u.content||"",f=Bt(g,{containerWidth:s})+q.NODE_Y_PADDING*2,h=me.buildTextNodeV2({x:u.x+l,y:d,width:s,height:f,content:g,title:u.title,styles:{textAlign:"left"},options:{lockSize:!0}});c.set(u.id,h.id),o.addNode(h),d+=f+r}for(const u of t.arrows){const g=u.startNodeId?c.get(u.startNodeId):null,p=u.endNodeId?c.get(u.endNodeId):null;g&&p&&o.arrow.add({id:re(10),startNodeId:g,endNodeId:p,startPoint:{x:0,y:0},endPoint:{x:0,y:0}})}}onCopy(t){var g,p;const{focus:n,sourceNode:o,side:s="right"}=t||{focus:!0},r=$.getState(),{mode:a,nodeToFocusId:l}=r.uiState;if(!a)return null;const c=((g=r.projectCanvas.getActive())==null?void 0:g.coreState.selectedNodes)??[],d=Date.now();let u=!1;if(Se.lastCopyTimestamp&&d-Se.lastCopyTimestamp<Se.DOUBLE_COPY_INTERVAL_MS&&(u=!0),Se.lastCopyTimestamp=d,u)return null;{let f=o;return f||(f=c[0],f||(f=(((p=r.projectCanvas.getActive())==null?void 0:p.coreState.nodes)??[]).find(w=>w.id===l))),vd(f,n?l:null,n,s)}}highlightAndCreateNode(t,n="right"){var d;const o=$.getState(),s=document.activeElement,r=(s==null?void 0:s.tagName)==="TEXTAREA",a=(s==null?void 0:s.classList.contains("markdown-textarea"))&&s.isContentEditable;let l=!1,c=null;if(r){const u=s,g=u.value;let p=u.selectionStart,f=u.selectionEnd;if(p===f)if(Ls(g,p)){const h=Ws(g,p);h&&(p=h.start,f=h.end)}else{const h=Hs(g,p);h&&(p=h.start,f=h.end)}else p=zs(g,p),f=Bs(g,f);(p!==u.selectionStart||f!==u.selectionEnd)&&u.setSelectionRange(p,f),l=p!==f}else if(a){const u=window.getSelection(),g=s.textContent||"";let p=!!(u&&!u.isCollapsed&&u.toString().trim());if(u&&u.rangeCount>0){const f=u.getRangeAt(0),h=document.createRange();h.setStart(s,0),h.setEnd(f.startContainer,f.startOffset);let m=h.toString().length;const x=document.createRange();x.setStart(s,0),x.setEnd(f.endContainer,f.endOffset);let w=x.toString().length;if(m===w)if(Ls(g,m)){const b=Ws(g,m);b&&(m=b.start,w=b.end)}else{const b=Hs(g,m);b&&(m=b.start,w=b.end)}else m=zs(g,m),w=Bs(g,w);if(m!==w){const b=hd(s,m,w);b&&(u.removeAllRanges(),u.addRange(b),c=b.cloneRange(),p=!0)}}l=p,l&&u&&u.rangeCount>0&&!c&&(c=u.getRangeAt(0).cloneRange())}if(l){t.preventDefault();const{nodeToFocusId:u}=o.uiState,g=o.projectCanvas.getActive();let f=((g==null?void 0:g.coreState.selectedNodes)??[])[0];!f&&u&&(f=((g==null?void 0:g.coreState.nodes)??[]).find(b=>b.id===u));const h=r?s.selectionStart:0,m=r?s.selectionEnd:0;Se.dismissPopoverCallback&&Se.dismissPopoverCallback();const x=this.onCopy({focus:!1,sourceNode:f,side:n});if(setTimeout(()=>{if(s.focus(),r)s.setSelectionRange(h,m);else if(a&&c){const w=window.getSelection();w&&(w.removeAllRanges(),w.addRange(c))}},0),f!=null&&f.highlights&&f.highlights.length>1&&x){const b=(((d=o.projectCanvas.getActive())==null?void 0:d.coreState.nodes)??[]).find(j=>j.id===f.id),N=window.__showLinkedNodesPopover;N&&b&&N(b,x)}}else{const{nodeToFocusId:u}=o.uiState,g=o.projectCanvas.getActive();let f=((g==null?void 0:g.coreState.selectedNodes)??[])[0];if(!f&&u&&(f=((g==null?void 0:g.coreState.nodes)??[]).find(m=>m.id===u)),f!=null&&f.highlights&&f.highlights.length>0){t.preventDefault();const h=window.__showLinkedNodesPopover;h&&h(f,null)}}}static registerSelectionCallback(t){Se.selectionChangeCallback=t}static unregisterSelectionCallback(){Se.selectionChangeCallback=null}static registerDismissPopoverCallback(t){Se.dismissPopoverCallback=t}static unregisterDismissPopoverCallback(){Se.dismissPopoverCallback=null}onTextSelect(t,n,o){const s=n!==o;Se.selectionChangeCallback&&Se.selectionChangeCallback(s)}};fe(Se,"lastCopyTimestamp",null),fe(Se,"DOUBLE_COPY_INTERVAL_MS",400),fe(Se,"selectionChangeCallback",null),fe(Se,"dismissPopoverCallback",null);let Xe=Se;function vd(e,t,n=!0,o="right"){var T;if(!e)return console.warn("No target node found for copy action."),null;const s=document.activeElement,r=(s==null?void 0:s.tagName)==="TEXTAREA",a=(s==null?void 0:s.classList.contains("markdown-textarea"))&&s.isContentEditable;let l="",c=null,d=0,u=0;if(r){const E=s;d=E.selectionStart,u=E.selectionEnd,l=E.value.substring(d,u);const y=Br(E,d,u);if(y)c=new DOMRect(0,y.top,y.width,y.height);else{const _=4+(E.value.substring(0,d).split(`
`).length-1)*24;c=new DOMRect(0,_,0,24)}}else if(a){const E=window.getSelection();if(l=(E==null?void 0:E.toString())||"",E&&E.rangeCount>0){const y=E.getRangeAt(0),v=s.getBoundingClientRect(),k=y.getClientRects();if(k.length>0){const M=k[0],D=M.top-v.top;c=new DOMRect(0,D,M.width,M.height)}const R=document.createRange();R.setStart(s,0),R.setEnd(y.startContainer,y.startOffset),d=R.toString().length,u=d+l.length}}else{const E=window.getSelection();if(l=(E==null?void 0:E.toString())||"",E&&E.rangeCount>0){const y=E.getRangeAt(0).cloneRange(),v=document.createElement("span");v.style.position="absolute",v.textContent="â€‹",y.insertNode(v),c=v.getBoundingClientRect(),(T=v.parentNode)==null||T.removeChild(v)}}const g=$.getState();let p;const f="rgb(198, 183, 0)";if((r||a)&&d!==u){const E=e.highlights||[],y=E.find(v=>v.start===d&&v.end===u);if(y)p=y.id;else{p=Math.random().toString(36).slice(2,10);const v={id:p,start:d,end:u,color:f,createdAt:Date.now()},k=[...E,v];g.updateNode(e.id,{highlights:k})}}const h=g.getSegmentedButtonAction("canvas-fit-width");let m=null;if(h){const E=h.match(/Set width to (\d+)px/);E&&(m=parseInt(E[1],10))}let x,w,b,N;const j=document.querySelector("textarea[data-node-textarea]")||document.querySelector(".markdown-textarea[data-node-textarea]");if(j){const y=window.getComputedStyle(j).lineHeight;if(y&&y!=="normal"){const v=parseFloat(y);isNaN(v)||(N=v)}}if(m)w=Bt(l,{containerWidth:m})+q.NODE_Y_PADDING*2,x=m,b=!0;else{const E=Vn(l,N);x=E.width,w=E.height,b=!1}const C=me.buildTextNodeV2({content:l,width:x,height:w,linkedHighlightId:p,linkedSourceNodeId:e.id,options:{lockSize:b}});let I=e.y;if(c){const E=c.top;I=e.y+E,I-=wd}const A=t||e.id;if(is(C,{...e,y:I,id:A},o,{shouldFocus:n}),p){const E=g.getNodeById(e.id),v=((E==null?void 0:E.highlights)||[]).map(k=>k.id===p?{...k,linkedNodeId:C.id}:k);g.updateNode(e.id,{highlights:v})}return C.id}const Sd=1e3,yd=500,Nd=500,bd=250,Cd=2e3,jd=1e3,Id=500;class kd{handleArrowKey(t,n=!1,o=!1){const s=$.getState(),r=s.projectCanvas.getActive();if(!r)return!1;const a=r.coreState.selectedNodes??[];if(a.length===0)return!1;const l=r.coreState.nodes??[],c=new Set(a.map(f=>f.id)),d=l.filter(f=>c.has(f.id));let u=Sd,g=yd;o?(u=Cd,g=jd):n&&(u=Nd,g=bd);const p=d.map(f=>{const h={id:f.id};switch(t.key){case"ArrowLeft":{const m=f.x,w=Math.round(m/u)-1;h.x=w*u;break}case"ArrowRight":{const m=f.x,w=Math.round(m/u)+1;h.x=w*u;break}case"ArrowUp":{const m=f.y,w=Math.round(m/g)-1;h.y=w*g;break}case"ArrowDown":{const m=f.y,w=Math.round(m/g)+1;h.y=w*g;break}}return h});return s.updateNodes(p),this.animateViewportToCenter(p,r),t.preventDefault(),!0}animateViewportToCenter(t,n){if(t.length===0||!n)return;const s=$.getState().setActiveCanvasViewState,r=n.viewState,a=r.scale,l=r.offset,c=n.coreState.nodes??[],d=new Map(c.map(I=>[I.id,I]));let u=0,g=0;t.forEach(I=>{const A=d.get(I.id);if(A){const T=I.x??A.x,E=I.y??A.y;u+=T,g+=E}});const p=u/t.length,f=g/t.length,h=window.innerWidth,m=window.innerHeight,x=h/2-p*a,w=m/2-f*a,b=performance.now(),N=l.x,j=l.y,C=I=>{const A=I-b,T=Math.min(A/Id,1),E=1-Math.pow(1-T,3),y=N+(x-N)*E,v=j+(w-j)*E;s(k=>({...k,offset:{x:y,y:v}})),T<1&&requestAnimationFrame(C)};requestAnimationFrame(C)}}function Rd(){const e=document.activeElement;if(!e)return null;const t=["INPUT","TEXTAREA"].includes(e.nodeName??""),n=e.contentEditable==="true";return t||n}class Ed{constructor(){fe(this,"activeCallback",null)}registerCallback(t){this.activeCallback=t}unregisterCallback(t){this.activeCallback===t&&(this.activeCallback=null)}applyHighlight(t){return this.activeCallback?(this.activeCallback(t),!0):!1}hasActiveCallback(){return this.activeCallback!==null}}const Ot=new Ed,Ad=new yt("useCanvasKeyboardEventsV2",St.useCanvasKeyboardEventsV2),Td=["q","Q","!","$","1","%","5"],Dd=()=>{const e=$.getState(),t=e.uiState.mode,n=e.setMode,o=e.setZoomSubMode,s=e.setWriteSubMode,r=e.toggleWriteSubMode,a=e.setAddNodeType,l=e.setNodeToFocusId,c=e.copyNodes,d=e.setSelectedNodes,u=e.deleteSelectedNodes,g=e.deleteSelectedArrows,p=e.setActiveCanvasViewState,f=S.useRef(new Xe),h=S.useRef(new kd);return S.useCallback(m=>{var C;if(m.key==="Escape"){n(H.SELECT),l(null),a(null),d([]);return}if((m.key==="h"||m.key==="H")&&(m.ctrlKey||m.metaKey)){m.preventDefault(),Ot.applyHighlight();return}const x=m.key==="Enter"&&m.ctrlKey,w=m.key==="a"&&t===H.WRITE;if(t===H.WRITE&&!x&&!w)return;const b=Rd(),N=Td.includes(m.key);if(b&&!N)return;if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(m.key)){const I=e.projectCanvas.getActive(),A=(I==null?void 0:I.coreState.selectedNodes)??[];if(t===H.GRID&&A.length>0){const T=m.ctrlKey,E=m.shiftKey;if(h.current.handleArrowKey(m,T,E))return}if(m.ctrlKey&&A.length>0&&t!==H.GRID){const T=e.uiState.lastUpdatedNodeId;if(!T)return;const E=(C=I==null?void 0:I.coreState.nodes)==null?void 0:C.find(v=>v.id===T);if(!E)return;const y=A.map(v=>{const k={id:v.id};switch(m.key){case"ArrowLeft":case"ArrowRight":k.x=E.x;break;case"ArrowUp":case"ArrowDown":k.y=E.y;break}return k});e.updateNodes(y),m.preventDefault();return}if(A.length===0){const T=m.shiftKey?100:30;p(E=>{let y=0,v=0;switch(m.key){case"ArrowUp":v=T;break;case"ArrowDown":v=-T;break;case"ArrowLeft":y=T;break;case"ArrowRight":y=-T;break}return{...E,offset:{x:E.offset.x+y,y:E.offset.y+v}}}),m.preventDefault();return}}switch(m.key){case"a":t===H.WRITE?r():n(H.DRAW_ARROW);break;case"c":if(m.ctrlKey){c();break}console.clear();break;case"v":if(m.ctrlKey){const I=e.projectCanvas.getActive();if(((I==null?void 0:I.coreState.selectedNodes)??[]).some(E=>E.type===K.OCR))break;f.current.onPaste(m);break}n(H.SELECT);break;case"g":n(H.GRID);break;case"h":case"H":t===H.MOVE?(n(H.ZOOM),o("zoom")):t===H.ZOOM?n(H.MOVE):n(H.MOVE);break;case"n":{n(H.ADD),e.uiState.addNodeType||a(K.TABLE);break}case"q":if(m.ctrlKey){f.current.onCopy();break}break;case"Q":if(m.ctrlKey&&m.shiftKey){f.current.onCopy();break}break;case"$":case"1":case"!":{f.current.highlightAndCreateNode(m,"right");break}case"%":case"5":{f.current.highlightAndCreateNode(m,"left");break}case"t":n(H.ADD),a(K.TEXT);break;case"w":n(H.WRITE),s(Le.WRITE);break;case"Delete":case"Backspace":u(),g(),m.preventDefault();break}},[t,n,o,s,r,a,u,g,p,e])},Md=()=>S.useCallback(e=>{Ad.log("Key Up:",e.key)},[]),Tn=(e,t)=>e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y,as=e=>({x:e.x,y:e.y,width:e.width??100,height:e.height??50}),Vs={SELECTION_BOX_END:"selectionBoxEnd"};class Pd{constructor(){fe(this,"listeners",{})}subscribe(t,n){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(n),()=>{this.unsubscribe(t,n)}}unsubscribe(t,n){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(o=>o!==n))}dispatch(t,n){this.listeners[t]&&this.listeners[t].forEach(o=>{try{o(n)}catch(s){console.error(`Error in event listener for ${t} event:`,s)}})}}const _d=new Pd,dt=new yt("useSelectionHandler",St.useSelectionHandler),en=100,tn=15,ls=e=>{const n=e.target.closest("[data-canvas-container]");if(!n)return console.warn("Canvas container not found, falling back to offsetX/Y"),{x:e.offsetX,y:e.offsetY};const o=n.getBoundingClientRect();return{x:e.clientX-o.left,y:e.clientY-o.top}},Od=()=>{var c;const e=$.getState(),t=e.uiState.mode,n=(c=e.uiState)==null?void 0:c.isPanning,o=e.setSelectionBox,s=e.setSelectedNodes,r=e.setNodeToFocusId,a=e.arrow.setSelected,l=Mn();return S.useCallback(d=>{const u=ls(d);if(t===H.MOVE)return;const g=d.target,p=g.closest("[data-node-id]"),f=g.closest("[data-arrow-id]"),h=g.closest("[data-ui-panel]"),m=g.closest("[data-grid-svg]"),x=m&&m.getAttribute("data-grid-active")==="true",w=!!g.closest("foreignObject");if((t===H.SELECT||t===H.GRID||t===H.WRITE)&&(d.button===0||d.button===-1)&&!n){if(p||f||h||x||w)return;const b=d.shiftKey&&!d.ctrlKey&&!d.metaKey,N=e.projectCanvas.getActive(),j=(N==null?void 0:N.coreState.selectedNodes)??[],C=(N==null?void 0:N.coreState.nodes)??[],I=(N==null?void 0:N.viewState.scale)??1,A=(N==null?void 0:N.viewState.offset)??{x:0,y:0};if(b&&j.length>0){const T=Te(u,I,A),E=j[j.length-1],y=[{x:E.x,y:E.y},{x:E.x+(E.width??0),y:E.y},{x:E.x,y:E.y+(E.height??0)},{x:E.x+(E.width??0),y:E.y+(E.height??0)}];let v=y[0],k=0;y.forEach(P=>{const O=Math.sqrt(Math.pow(P.x-T.x,2)+Math.pow(P.y-T.y,2));O>k&&(k=O,v=P)});const R={x:Math.min(v.x,T.x),y:Math.min(v.y,T.y),width:Math.abs(v.x-T.x),height:Math.abs(v.y-T.y)},M=C.filter(P=>{const O=as(P);return Tn(O,R)}),D=new Set(j.map(P=>P.id)),_=M.filter(P=>!D.has(P.id)),L=[...j,..._];s(L);return}if(dt.log("Selection Mouse Down on Background:",u.x,u.y),t===H.WRITE){const T=e.projectCanvas.getActive(),E=(T==null?void 0:T.viewState.scale)??1,y=(T==null?void 0:T.viewState.offset)??{x:0,y:0},v=Te(u,E,y);wr(async()=>{const{CanvasNodeBuilderV2:k}=await Promise.resolve().then(()=>gd);return{CanvasNodeBuilderV2:k}},void 0).then(({CanvasNodeBuilderV2:k})=>{const R=k.buildTextNode(v,"");R.isEditing=!0,e.addNode(R,""),e.setNodeToFocusId(R.id)});return}s([]),a([]),r(null),(!l||d.pointerType!=="touch")&&o({start:u,end:u})}},[t,n,o,s,r,a,l,e])},Fd=()=>{const e=$.getState(),t=e.setSelectionBox,n=e.setActiveCanvasViewState,o=B(d=>d.uiState),s=o==null?void 0:o.selectionBox,r=S.useRef(null),a=S.useRef({x:0,y:0}),l=S.useRef(null),c=S.useCallback(()=>{var h,m;const d=$.getState().projectCanvas.getActive(),u=(h=$.getState().uiState)==null?void 0:h.selectionBox;if(!d||!u){r.current!==null&&(cancelAnimationFrame(r.current),r.current=null);return}const g=d.viewState.offset;let p=0,f=0;if(p=a.current.x,f=a.current.y,p!==0||f!==0){n(w=>({...w,offset:{x:g.x+p,y:g.y+f}}));const x=(m=$.getState().uiState)==null?void 0:m.selectionBox;if(x){const w={x:x.start.x+p,y:x.start.y+f};t({start:w,end:x.end})}}r.current=requestAnimationFrame(c)},[n,t]);return S.useEffect(()=>()=>{r.current!==null&&cancelAnimationFrame(r.current)},[]),S.useEffect(()=>{s||(l.current=null)},[s]),S.useCallback(d=>{var A;if(!s)return;const u=(A=$.getState().uiState)==null?void 0:A.selectionBox;if(!u)return;const g=ls(d),p=window.innerWidth,f=window.innerHeight;let h=0,m=0;l.current&&(h=g.x-l.current.x,m=g.y-l.current.y),l.current={x:g.x,y:g.y},t({start:u.start,end:g});const x=d.clientX,w=d.clientY,b=w<en&&m<0,N=w>f-en&&m>0,j=x<en&&h<0,C=x>p-en&&h>0,I=b||N||j||C;if(I){let T=0,E=0;b&&(E=tn),N&&(E=-tn),j&&(T=tn),C&&(T=-tn),a.current={x:T,y:E},r.current===null&&(r.current=requestAnimationFrame(c))}else!I&&r.current!==null&&(cancelAnimationFrame(r.current),r.current=null,a.current={x:0,y:0})},[t,s,c])},$d=()=>{var a;const e=$.getState(),t=e.setSelectionBox,n=(a=e.uiState)==null?void 0:a.selectionBox,o=e.projectCanvas.getActive,s=e.setSelectedNodes,r=e.arrow.setSelected;return S.useCallback(l=>{const c=ls(l),d=o(),u=(d==null?void 0:d.coreState.nodes)??[],g=(d==null?void 0:d.coreState.arrows)??[],p=(d==null?void 0:d.viewState.scale)??1,f=(d==null?void 0:d.viewState.offset)??{x:0,y:0};if(n){dt.log("Selection Mouse Up:",c.x,c.y),dt.log("Stopped Marquee Selection");const h={x:Math.min(n.start.x,c.x),y:Math.min(n.start.y,c.y),width:Math.abs(n.start.x-c.x),height:Math.abs(n.start.y-c.y)},m=Te({x:h.x,y:h.y},p,f),x=Te({x:h.x+h.width,y:h.y+h.height},p,f),w={x:m.x,y:m.y,width:x.x-m.x,height:x.y-m.y},b=5;if(h.width<b&&h.height<b){t(null),s([]),r([]);return}const N=u.filter(C=>{const I=as(C);return Tn(I,w)});dt.log("Selected Nodes by Marquee:",N.map(C=>C.content)),s(N);const j=g.filter(C=>{const I=Math.min(C.startPoint.x,C.endPoint.x),A=Math.min(C.startPoint.y,C.endPoint.y),T=Math.max(C.startPoint.x,C.endPoint.x),E=Math.max(C.startPoint.y,C.endPoint.y),y={x:I,y:A,width:T-I,height:E-A};return dt.log(">>>> _ >>>> ~ useSelectionHandler.ts:164 ~ arrowBBox:",y),Tn(y,w)});dt.log("Selected Arrows by Marquee:",j.map(C=>C.id)),r(j),N.length>0&&(_d.dispatch(Vs.SELECTION_BOX_END,{selectedNodes:N}),dt.log(`Dispatched ${Vs.SELECTION_BOX_END} event with nodes:`,N.map(C=>C.id))),t(null)}},[n,o,t,s,r])},Ld=()=>{const e=bt.getState().mousePosition??null,n=$.getState().projectCanvas.getActive,o=n(),s=(o==null?void 0:o.viewState.scale)??1,r=(o==null?void 0:o.viewState.offset)??{x:0,y:0},a=S.useMemo(()=>e?Te(e,s,r):null,[e,s,r]);return{screenCoords:e,canvasCoords:a}},Ee={"I am dragging a node near the <edge> edge":"I am dragging a node near the <edge> edge","I am dragging a node near the top edge":"I am dragging a node near the top edge","I am dragging a node toward the <edge> edge":"I am dragging a node toward the <edge> edge","I am in GRID mode":"I am in GRID mode","I am in MOVE mode":"I am in MOVE mode","I am in SELECT mode":"I am in SELECT mode","I am in WRITE mode":"I am in WRITE mode","I have a canvas with nodes":"I have a canvas with nodes","I have selected a node":"I have selected a node","auto-scroll is active":"auto-scroll is active"},Qe={"I click on a node":"I click on a node","I hold Ctrl and click on another node":"I hold Ctrl and click on another node","I hold Ctrl and click on one of the selected nodes":"I hold Ctrl and click on one of the selected nodes","I hold Shift and click on a node":"I hold Shift and click on a node"},Ye=100;let Vr=!1;const Hd=e=>{Vr=e};let Eo=0,Ur=0;const mn={[Ee["I have a canvas with nodes"]]:()=>{const e=$.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.nodes.length)??0)>0},[Ee["I have selected a node"]]:()=>{const e=$.getState().projectCanvas.getActive();return((e==null?void 0:e.coreState.selectedNodes.length)??0)>0},[Ee["I am dragging a node near the top edge"]]:e=>$.getState().uiState.dragInfo?(e??Eo)<Ye:!1,[Ee["I am dragging a node near the <edge> edge"]]:(e,t,n)=>{if(!$.getState().uiState.dragInfo)return!1;const r=t??Ur,a=n??Eo;switch(e){case"top":return a<Ye;case"bottom":return a>window.innerHeight-Ye;case"left":return r<Ye;case"right":return r>window.innerWidth-Ye;default:return!1}},[Ee["auto-scroll is active"]]:()=>Vr,[Ee["I am dragging a node toward the <edge> edge"]]:(e,t,n)=>{if(!$.getState().uiState.dragInfo)return!1;const r=mn[Ee["I am dragging a node near the <edge> edge"]](e);if(!r)return!1;if(t===void 0&&n===void 0)return r;switch(e){case"top":return(n??0)<0;case"bottom":return(n??0)>0;case"left":return(t??0)<0;case"right":return(t??0)>0;default:return!1}}},Wd=(e,t)=>{Ur=e,Eo=t},nt=15,Gr=(e,t)=>{if(e===null||t===null)return{x:0,y:0};let n=0,o=0;const s=window.innerWidth,r=window.innerHeight;return e<Ye?n=nt:e>s-Ye&&(n=-nt),t<Ye?o=nt:t>r-Ye&&(o=-nt),{x:n,y:o}},zd=(e,t)=>({x:-e.x/t,y:-e.y/t}),nn={getScrollDeltaForMousePosition:(e,t)=>Gr(e,t),shouldScroll:e=>e.x!==0||e.y!==0,applyDeltaToPosition:(e,t,n)=>({x:Number((e+n.x).toFixed(2)),y:Number((t+n.y).toFixed(2))})},Ft={calculateScrollDelta:(e,t)=>{if(e){const n=Gr(e.x,e.y),o=nn.shouldScroll(n);return{delta:n,shouldUpdateLastDelta:o}}return{delta:t,shouldUpdateLastDelta:!1}},calculateNewOffset:(e,t)=>({x:e.x+t.x,y:e.y+t.y}),updateNodesForScroll:(e,t,n)=>e.map(o=>{if(t.has(o.id)){const s=nn.applyDeltaToPosition(o.x,o.y,n);return{...o,...s}}return o}),updateSelectedNodesForScroll:(e,t)=>e.map(n=>{const o=nn.applyDeltaToPosition(n.x,n.y,t);return{...n,...o}}),processAutoScrollFrame:e=>{const{mousePosition:t,lastScrollDelta:n,currentOffset:o,scale:s,nodes:r,selectedNodes:a}=e,{delta:l}=Ft.calculateScrollDelta(t,n);if(!nn.shouldScroll(l))return{shouldScroll:!1,scrollDelta:l,newOffset:o,updatedNodes:r,updatedSelectedNodes:a};const d=Ft.calculateNewOffset(o,l),u=zd(l,s),g=new Set(a.map(h=>h.id)),p=Ft.updateNodesForScroll(r,g,u),f=Ft.updateSelectedNodesForScroll(a,u);return{shouldScroll:!0,scrollDelta:l,newOffset:d,updatedNodes:p,updatedSelectedNodes:f}}},Ao={isShiftPressed:e=>e.shiftKey&&!e.ctrlKey&&!e.metaKey,isCtrlPressed:e=>e.ctrlKey||e.metaKey,noModifiersPressed:e=>!e.shiftKey&&!e.ctrlKey&&!e.metaKey&&!e.altKey},Bd=e=>{const t=$.getState().projectCanvas.getActive();return(t==null?void 0:t.coreState.selectedNodes.some(n=>n.id===e))??!1},on=()=>{const e=$.getState().projectCanvas.getActive();return(e==null?void 0:e.coreState.selectedNodes)??[]},To={isClickOnEditingElement:e=>!!e.closest("[data-is-editing='true']"),hasActiveTextSelection:()=>{const e=window.getSelection();return e!==null&&!e.isCollapsed&&e.toString().length>0},getSelectedText:()=>{const e=window.getSelection();return(e==null?void 0:e.toString())??""},isInsideTextInput:e=>{const t=e.tagName.toLowerCase();return t==="textarea"||t==="input"?!0:!!e.closest('textarea, input, [contenteditable="true"]')}},Vd=(e,t)=>{const n=[];for(const o of t)o.startNodeId===e&&o.endNodeId&&n.push(o.endNodeId);return n},Ud=(e,t,n)=>{const o=new Set(e),s=new Set,r=[...e],a=new Set(e);for(;r.length>0;){const c=r.shift(),d=Vd(c,n);for(const u of d)a.has(u)||t.some(g=>g.id===u)&&(a.add(u),s.add(u),r.push(u))}return t.filter(c=>s.has(c.id)&&!o.has(c.id))};let Gd=!0;const Us={isDragInProgress:()=>{var t;const e=(t=$.getState().uiState)==null?void 0:t.dragInfo;return e!=null},isDragWithSelectedNodes:()=>{var o;const e=$.getState();if(!((o=e.uiState)==null?void 0:o.dragInfo))return!1;const n=e.projectCanvas.getActive();return((n==null?void 0:n.coreState.selectedNodes.length)??0)>0},isFirstMoveEvent:()=>Gd,[Ee["I am in SELECT mode"]]:()=>$.getState().uiState.mode===H.SELECT,[Ee["I am in GRID mode"]]:()=>$.getState().uiState.mode===H.GRID,[Ee["I am in MOVE mode"]]:()=>$.getState().uiState.mode===H.MOVE,[Ee["I am in WRITE mode"]]:()=>$.getState().uiState.mode===H.WRITE,canDragInCurrentMode:()=>{const e=$.getState().uiState.mode;return e===H.SELECT||e===H.GRID||e===H.WRITE},isPrimaryButton:e=>e.button===0||e.button===-1},Tt={calculateScreenDelta:e=>{const{screenCoords:t,prevScreenPos:n}=e;if(!t&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:null,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!0};if(t&&!n)return{screenDelta:{x:0,y:0},newPrevScreenPos:t,newDragDirection:null,isFirstMoveEvent:!0,shouldSkipFrame:!0};if(t&&n){const o={x:t.x-n.x,y:t.y-n.y},s=o.x!==0||o.y!==0?o:null;return{screenDelta:o,newPrevScreenPos:t,newDragDirection:s,isFirstMoveEvent:!1,shouldSkipFrame:!1}}return{screenDelta:{x:0,y:0},newPrevScreenPos:n,newDragDirection:null,isFirstMoveEvent:!1,shouldSkipFrame:!1}},screenDeltaToCanvasDelta:(e,t)=>({x:e.x/t,y:e.y/t}),checkAutoScrollEdges:e=>{const{screenCoords:t,dragDirection:n,draggedNode:o,scale:s,offset:r}=e;let a=!1;o&&(a=o.y*s+r.y<=0&&n.y<0);const l=a,c=mn[Ee["I am dragging a node toward the <edge> edge"]]("bottom",n.x,n.y),d=mn[Ee["I am dragging a node toward the <edge> edge"]]("left",n.x,n.y),u=mn[Ee["I am dragging a node toward the <edge> edge"]]("right",n.x,n.y);return{shouldAutoScroll:l||c||d||u}},calculateMouseLeftWindowDelta:e=>{const{lastCoords:t,viewportWidth:n,viewportHeight:o}=e;if(!t)return{shouldStartAutoScroll:!1,scrollDelta:{x:0,y:0}};let s=0,r=0;return t.x<n/2?s=nt:s=-nt,t.y<o/2?r=nt:r=-nt,{shouldStartAutoScroll:!0,scrollDelta:{x:s,y:r}}},calculateNodeMoves:e=>{const{canvasDelta:t,draggedNodeId:n,selectedNodes:o,nodes:s,arrows:r,isCtrlPressed:a}=e,l=Math.round(t.x),c=Math.round(t.y);if(l===0&&c===0)return{shouldUpdate:!1,updatedNodes:s,updatedSelectedNodes:o};const d=new Set(o.map(f=>f.id));let u=new Set(d);if(a&&Ud(Array.from(d),s,r).forEach(h=>u.add(h.id)),u.size===0)return{shouldUpdate:!1,updatedNodes:s,updatedSelectedNodes:o};const g=s.map(f=>u.has(f.id)?{...f,x:Number((f.x+t.x).toFixed(2)),y:Number((f.y+t.y).toFixed(2))}:f),p=o.map(f=>u.has(f.id)?{...f,x:Number((f.x+t.x).toFixed(2)),y:Number((f.y+t.y).toFixed(2))}:f);return{shouldUpdate:!0,updatedNodes:g,updatedSelectedNodes:p}}},Yd=(e,t)=>{const n=[{x:e.x,y:e.y},{x:e.x+(e.width??0),y:e.y},{x:e.x,y:e.y+(e.height??0)},{x:e.x+(e.width??0),y:e.y+(e.height??0)}];let o=n[0],s=0;return n.forEach(r=>{const a=Math.sqrt(Math.pow(r.x-t.x,2)+Math.pow(r.y-t.y,2));a>s&&(s=a,o=r)}),o},Xd=(e,t)=>({x:Math.min(e.x,t.x),y:Math.min(e.y,t.y),width:Math.abs(e.x-t.x),height:Math.abs(e.y-t.y)}),Kd=(e,t)=>e.filter(n=>{const o=as(n);return Tn(o,t)}),qd=(e,t)=>{const n=new Set(e.map(s=>s.id)),o=t.filter(s=>!n.has(s.id));return[...e,...o]},$t={[Qe["I hold Shift and click on a node"]]:(e,t)=>{const o=$.getState().projectCanvas.getActive(),s=(o==null?void 0:o.coreState.selectedNodes)??[],r=(o==null?void 0:o.coreState.nodes)??[];if(s.length===0)return[e];const a=s[s.length-1],l=Yd(a,t),c=Xd(l,t),d=Kd(r,c);return qd(s,d)},[Qe["I hold Ctrl and click on one of the selected nodes"]]:e=>on().filter(n=>n.id!==e.id),[Qe["I hold Ctrl and click on another node"]]:e=>[...on(),e],[Qe["I click on a node"]]:(e,t)=>t?on():[e],handleNodeMouseDown:e=>{const{node:t,event:n,canvasCoords:o}=e,s=on(),r=Bd(t.id);if(Ao.isShiftPressed(n)&&s.length>0)return{action:"shift_select",shouldStartDrag:!1,newSelection:$t[Qe["I hold Shift and click on a node"]](t,o)};if(Ao.isCtrlPressed(n))return r?{action:"ctrl_toggle_remove",shouldStartDrag:!1,newSelection:$t[Qe["I hold Ctrl and click on one of the selected nodes"]](t)}:{action:"ctrl_toggle_add",shouldStartDrag:!0,newSelection:$t[Qe["I hold Ctrl and click on another node"]](t),dragStartOffset:{x:o.x-t.x,y:o.y-t.y}};const a=$t[Qe["I click on a node"]](t,r);return{action:r?"keep_selection":"replace_selection",shouldStartDrag:!0,newSelection:a,dragStartOffset:{x:o.x-t.x,y:o.y-t.y}}}},Lt=new yt("useNodeDragHandler",St.useCanvasMouseEventsV2),Zd=e=>{const t=$.getState(),n=t.setDragInfo,o=t.setSelectedNodes;return S.useCallback(s=>{const r=$.getState().getCanvasMouseCoords();if(!Us.canDragInCurrentMode()||!Us.isPrimaryButton(s))return;s.stopPropagation();const a=s.target;if(To.isClickOnEditingElement(a)){Lt.log("Node Mouse Down: Clicked on editing node, skipping drag initialization");return}if(!r){Lt.warn("Node Mouse Down: Canvas coordinates not available.");return}const l=$t.handleNodeMouseDown({node:e,event:s,canvasCoords:r});o(l.newSelection),Lt.log(`Node Mouse Down: ${l.action}`,e.id,"Selection count:",l.newSelection.length),l.shouldStartDrag&&l.dragStartOffset&&(n({draggedNodeId:e.id,dragStartOffset:l.dragStartOffset}),Lt.log("Node Drag Start on:",e.id))},[e,n,o])},Jd=()=>{var p,f;const e=$.getState(),t=(p=e.uiState)==null?void 0:p.dragInfo,n=e.setActiveCanvasCoreState,o=e.setActiveCanvasViewState,{canvasCoords:s}=Ld(),r=e.projectCanvas.getActive,a=((f=r())==null?void 0:f.coreState.selectedNodes)??[],l=S.useRef(null),c=S.useRef({x:0,y:0}),d=S.useRef(null),u=S.useRef({x:0,y:0});S.useEffect(()=>{t&&(d.current=null)},[t]);const g=S.useCallback(()=>{var w;const h=$.getState().projectCanvas.getActive(),m=(w=$.getState().uiState)==null?void 0:w.dragInfo;if(!h||!m){l.current!==null&&(cancelAnimationFrame(l.current),l.current=null);return}const x=Ft.processAutoScrollFrame({mousePosition:bt.getState().mousePosition??null,lastScrollDelta:c.current,currentOffset:h.viewState.offset,scale:h.viewState.scale,nodes:h.coreState.nodes,selectedNodes:h.coreState.selectedNodes});x.shouldScroll&&(c.current=x.scrollDelta,o(b=>({...b,offset:x.newOffset})),n(b=>({...b,nodes:x.updatedNodes,selectedNodes:x.updatedSelectedNodes}))),l.current=requestAnimationFrame(g)},[o,n]);return S.useEffect(()=>()=>{l.current!==null&&cancelAnimationFrame(l.current)},[]),S.useCallback(h=>{if(!t||a.length===0)return;const m=bt.getState().mousePosition??null,x=Tt.calculateScreenDelta({screenCoords:m,prevScreenPos:d.current});if(x.newPrevScreenPos!==null&&(d.current=x.newPrevScreenPos),x.newDragDirection&&(u.current=x.newDragDirection),x.shouldSkipFrame)return;const w=$.getState().projectCanvas.getActive();if(!w)return;const b=w.viewState.scale,N=Tt.screenDeltaToCanvasDelta(x.screenDelta,b);if(m){Wd(m.x,m.y);const I=w.coreState.nodes.find(T=>T.id===t.draggedNodeId),A=Tt.checkAutoScrollEdges({screenCoords:m,dragDirection:u.current,draggedNode:I,scale:b,offset:w.viewState.offset});Hd(A.shouldAutoScroll),A.shouldAutoScroll&&l.current===null?l.current=requestAnimationFrame(g):!A.shouldAutoScroll&&l.current!==null&&(cancelAnimationFrame(l.current),l.current=null)}else if(l.current===null){const I=Tt.calculateMouseLeftWindowDelta({lastCoords:bt.getState().mousePosition??null,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight});I.shouldStartAutoScroll&&(c.current=I.scrollDelta,l.current=requestAnimationFrame(g))}const j=h.target;if(To.isClickOnEditingElement(j)||To.hasActiveTextSelection())return;const C=Tt.calculateNodeMoves({canvasDelta:N,draggedNodeId:t.draggedNodeId,selectedNodes:a,nodes:w.coreState.nodes,arrows:w.coreState.arrows||[],isCtrlPressed:Ao.isCtrlPressed(h)});C.shouldUpdate&&(n(I=>({...I,nodes:C.updatedNodes,selectedNodes:C.updatedSelectedNodes})),e.setUiState(I=>({...I,lastUpdatedNodeId:t.draggedNodeId})))},[t,s,n,a,g])},Qd=()=>{var o;const e=$.getState(),t=(o=e.uiState)==null?void 0:o.dragInfo,n=e.setDragInfo;return S.useCallback(s=>{t&&(Lt.log("Node Drag End (Pointer Up on):",t.draggedNodeId),n(null))},[t,n])},sn=20,et=(e,t)=>{const n=$.getState(),o=n.uiState.mode,s=n.setResizingNode;return S.useCallback(r=>{if(o!==H.SELECT||r.button!==0&&r.button!==-1)return;r.stopPropagation();const a=n.projectCanvas.getActive(),l=(a==null?void 0:a.viewState.scale)??1,c=(a==null?void 0:a.viewState.offset)??{x:0,y:0},d={x:r.clientX,y:r.clientY},u=Te(d,l,c),g=a==null?void 0:a.coreState.nodes.find(f=>f.id===e.id),p={x:(g==null?void 0:g.x)??e.x,y:(g==null?void 0:g.y)??e.y,width:(g==null?void 0:g.width)??e.width??100,height:(g==null?void 0:g.height)??e.height??50};console.log("Resize Start:",e.id,"Handle:",t),s({id:e.id,handle:t,startNodeRect:p,startPointerPos:u})},[e,t,o,s])},eu=()=>{var o;const e=$.getState(),t=(o=e.uiState)==null?void 0:o.resizingNode,n=e.setActiveCanvasCoreState;return S.useCallback(s=>{if(!t)return;const{id:r,handle:a,startNodeRect:l,startPointerPos:c}=t,d=e.projectCanvas.getActive(),u=(d==null?void 0:d.viewState.scale)??1,g=(d==null?void 0:d.viewState.offset)??{x:0,y:0},p={x:s.clientX,y:s.clientY},f=Te(p,u,g),h=f.x-c.x,m=f.y-c.y;let x=l.x,w=l.y,b=l.width,N=l.height;a.includes("left")&&(b=Math.round(Math.max(sn,l.width-h)),x=l.x+l.width-b),a.includes("right")&&(b=Math.round(Math.max(sn,l.width+h))),a.includes("top")&&(N=Math.round(Math.max(sn,l.height-m)),w=l.y+l.height-N),a.includes("bottom")&&(N=Math.round(Math.max(sn,l.height+m))),n(j=>{const C=j.nodes.findIndex(T=>T.id===r);if(C===-1)return j;const I=[...j.nodes];I[C]={...I[C],x,y:w,width:b,height:N};const A=j.selectedNodes.map(T=>T.id===r?{...T,x,y:w,width:b,height:N}:T);return{...j,nodes:I,selectedNodes:A}})},[t,n,e])},tu=()=>{var s;const e=$.getState(),t=(s=e.uiState)==null?void 0:s.resizingNode,n=e.setResizingNode,o=e.updateNode;return S.useCallback(r=>{var a;if(t){const{id:l,handle:c}=t,d=c.includes("top")||c.includes("bottom"),u=c.includes("left")||c.includes("right");if(d)o(l,{options:{lockSize:!0}});else if(u){const g=e.projectCanvas.getActive(),p=g==null?void 0:g.coreState.nodes.find(h=>h.id===l),f=((a=p==null?void 0:p.data)==null?void 0:a.nodeType)==="workflowOrchestration";if(p&&p.content&&p.width&&!f){const h=st(p.content,p.width)+q.NODE_Y_PADDING*2;o(l,{height:h,options:{lockSize:!0}})}}console.log("Resize End:",l),n(null)}},[t,n,o,e])},nu=(e,t,n)=>{const{x1:o,y1:s,x2:r,y2:a}=n,{x:l,y:c}=e,{x:d,y:u}=t,g=d-l,p=u-c;let f=-1/0,h=1/0;const m=(w,b,N,j)=>{if(Math.abs(b)<1e-6)return w>=N&&w<=j;let C=(N-w)/b,I=(j-w)/b;return C>I&&([C,I]=[I,C]),f=Math.max(f,C),h=Math.min(h,I),f<=h};if(!m(l,g,o,r)||!m(c,p,s,a)||f>1||h<0)return null;const x=Math.max(0,f);return x<=1?{x:l+x*g,y:c+x*p}:null},Ae=(e,t,n,o,s)=>{var d;if(!e)return t;const r=o.find(u=>u.id===e);if((r==null?void 0:r.width)===void 0||r.height===void 0)return t;if(s){const u=`[data-row-connector="${s}"][data-node-id="${e}"]`,g=document.querySelector(u);if(g){const p=g.getBoundingClientRect(),f=document.querySelector("[data-canvas-content]");if(f){const h=f.getBoundingClientRect(),m=p.left+p.width/2-h.left,x=p.top+p.height/2-h.top,b=(d=$.getState().projectCanvas.getActive())==null?void 0:d.viewState;return b?Te({x:m,y:x},b.scale,b.offset):{x:m,y:x}}}else return t}const a=En(r),l=ko(r);return nu(n,l,a)??l};class Yr{}fe(Yr,"arrows",{canDrawArrow:t=>t.length<=1});const ou=30,Dn=(e,t)=>{const n=document.elementsFromPoint(e,t);for(const r of n){const a=r.getAttribute("data-row-connector"),l=r.getAttribute("data-node-id");if(a&&l)return{nodeId:l,rowId:a}}const o=document.querySelectorAll("[data-row-connector]");let s=null;return o.forEach(r=>{const a=r.getBoundingClientRect(),l=a.left+a.width/2,c=a.top+a.height/2,d=Math.sqrt(Math.pow(e-l,2)+Math.pow(t-c,2));if(d<=ou){const u=r.getAttribute("data-row-connector")??"",g=r.getAttribute("data-node-id")??"";u&&g&&(!s||d<s.distance)&&(s={nodeId:g,rowId:u,distance:d})}}),s},su=Z.arrows.reverseArrowOnMultipleConnect,Ne=new yt("useArrowDrawingV2",St.useArrowDrawingV2),ru=()=>{const e=$.getState(),t=e.uiState.mode,n=e.projectCanvas.getActive(),o=e.arrow.setTemporary,s=e.getCanvasMouseCoords,r=(n==null?void 0:n.coreState.nodes)??[];return S.useCallback(a=>{if(t!==H.DRAW_ARROW)return;Ne.log("Fired in DRAW_ARROW mode.");const l=s();if(!l){Ne.log("No start point found.");return}const c=An(l,r),d=(c==null?void 0:c.id)??null;d?Ne.log(`Starting arrow draw from within node: ${d}`):Ne.log("Starting arrow draw from background."),Ne.log("Setting temporary arrow at",l,"with startNodeId:",d),o({startPoint:l,endPoint:l,startNodeId:d}),a.stopPropagation()},[t,s,o,r])},iu=()=>{const e=$.getState(),t=e.uiState.mode,n=e.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.nodes)??[],s=e.arrow.setTemporary,r=e.uiState.temporaryArrow,a=e.getCanvasMouseCoords;return S.useCallback(l=>{if(t!==H.DRAW_ARROW||!r)return;let c=a();if(!c)return;const d=Dn(l.clientX,l.clientY);d&&(c=Ae(d.nodeId,c,r.startPoint,o,d.rowId)),s({...r,endPoint:c}),l.stopPropagation()},[t,r,a,s,o])},rn=(e,t)=>{const n=$.getState(),o=n.setMode,s=n.arrow.setTemporary,r=n.uiState.mode;return S.useCallback(a=>{if(r!==H.SELECT)return;Ne.log(`useQuickArrowHandleMouseDownHandler: Fired on node ${e.id}, handle ${t}.`),a.stopPropagation();const l=e.width??100,c=e.height??50;let d;switch(t){case"top":d={x:e.x+l/2,y:e.y};break;case"bottom":d={x:e.x+l/2,y:e.y+c};break;case"left":d={x:e.x,y:e.y+c/2};break;case"right":d={x:e.x+l,y:e.y+c/2};break}Ne.log("Switching to DRAW_ARROW mode."),o(H.DRAW_ARROW),Ne.log("Setting temporary arrow from node",e.id),s({startPoint:d,endPoint:d,startNodeId:e.id})},[e,t,s,o,r])},au=()=>{const e=$.getState(),t=e.uiState.mode,n=e.projectCanvas.getActive(),o=e.arrow.setTemporary,s=e.arrow.add,r=e.uiState.temporaryArrow,a=e.setMode,l=(n==null?void 0:n.coreState.nodes)??[],c=(n==null?void 0:n.coreState.selectedNodes)??[],d=e.getCanvasMouseCoords;return S.useCallback(u=>{var C;if(t!==H.DRAW_ARROW||!r)return;Ne.log("useArrowMouseUpHandler: Fired.");const g=d();if(!g){Ne.log("No final mouse coords found, resetting."),j();return}const{startPoint:p,startNodeId:f}=r,h=l.find(I=>I.id===f);let m=null,x=null,w=g;const b=Dn(u.clientX,u.clientY);if(b)m=b.nodeId,x=b.rowId,Ne.log("Row connector found:",b);else{const I=An(g,l);I&&(((C=I.data)==null?void 0:C.nodeType)==="workflowOrchestration"||(m=I.id)),Ne.log("Target node found:",(I==null?void 0:I.id)??"None")}if(c.forEach(I=>{if(m&&m!==I.id)if(w=Ae(m,g,p,l,x),su&&c.length>1){Ne.log(`Creating arrow from target node ${m} to selected node ${I.id}`);const T={id:re(10),startPoint:w,endPoint:p,startNodeId:m,endNodeId:I.id??null,startRowId:x,label:""};s(T)}else{Ne.log(`Creating arrow from selected node ${I.id} to target node ${m}`);const T={id:re(10),startPoint:p,endPoint:w,startNodeId:I.id??null,endNodeId:m,endRowId:x,label:""};s(T)}}),c.length===0&&!m){Ne.log("Creating naked arrow.");const I={id:re(10),startPoint:p,endPoint:w,startNodeId:f??null,endNodeId:null,label:""};s(I)}if(m&&m!==(h==null?void 0:h.id)&&c.length===0){w=Ae(m,g,p,l,x),Ne.log(`Creating arrow from selected node ${h==null?void 0:h.id} to target node ${m}`);const I={id:re(10),startPoint:p,endPoint:w,startNodeId:(h==null?void 0:h.id)??null,endNodeId:m,endRowId:x,label:""};Yr.arrows.canDrawArrow(c)&&s(I)}j();function j(){Ne.log("Resetting state."),o(null),a(H.SELECT),u.stopPropagation()}},[t,r,s,o,a,l,c,d])},Gs=(e,t)=>{const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)},Ys=(e,t)=>({x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}),lu=()=>{const e=$.getState(),t=e.projectCanvas.getActive,n=e.setActiveCanvasViewState,o=e.setIsPanning,s=S.useRef(null),r=S.useRef(null),a=S.useCallback(d=>{const u=t();if(u)if(d.touches.length===1){const g=d.touches[0],p=d.target,f=p.closest("[data-node-id]"),h=p.id.includes("resize-handle-"),m=p.closest("[data-ui-panel]");if(f||h||m){r.current=null;return}r.current={startX:g.clientX,startY:g.clientY,initialOffsetX:u.viewState.offset.x,initialOffsetY:u.viewState.offset.y},o(!0),s.current=null}else if(d.touches.length===2){const g=d.touches[0],p=d.touches[1];s.current={initialDistance:Gs(g,p),initialScale:u.viewState.scale,center:Ys(g,p)},r.current=null,o(!1)}else s.current=null,r.current=null,o(!1)},[t,o]),l=S.useCallback(d=>{const u=t();if(u){if(d.touches.length===1&&r.current){d.preventDefault();const g=d.touches[0],p=g.clientX-r.current.startX,f=g.clientY-r.current.startY;n(h=>({...h,offset:{x:r.current.initialOffsetX+p,y:r.current.initialOffsetY+f}}))}else if(d.touches.length===2&&s.current){d.preventDefault();const{scale:g,offset:p}=u.viewState,f=d.touches[0],h=d.touches[1],m=Gs(f,h);Ys(f,h);const x=m/s.current.initialDistance;let w=s.current.initialScale*x;const{min:b,max:N}=Z.zoom;w=Math.max(b,Math.min(N,w)),w<=.1?w=Math.round(w*100)/100:w=Math.round(w*10)/10;const j=Te(s.current.center,g,p),C=s.current.center.x-j.x*w,I=s.current.center.y-j.y*w;n(A=>({...A,scale:w,offset:{x:C,y:I}}))}}},[t,n]),c=S.useCallback(d=>{if(d.touches.length===0)s.current=null,r.current=null,o(!1);else if(d.touches.length===1){if(s.current=null,!r.current){const u=$.getState().projectCanvas.getActive();if(u){const g=d.touches[0];r.current={startX:g.clientX,startY:g.clientY,initialOffsetX:u.viewState.offset.x,initialOffsetY:u.viewState.offset.y},o(!0)}}}else d.touches.length>=2&&(r.current=null,o(!1))},[o]);return{handleTouchStart:a,handleTouchMove:l,handleTouchEnd:c}},cu=300,du=30,uu=()=>{const e=S.useRef(null),t=Jo();return S.useCallback(n=>{var c,d;const o=$.getState(),s=o.uiState.mode;o.getCanvasMouseCoords;const r=o.addNode,a=o.setNodeToFocusId;if(s!==H.SELECT){e.current=null;return}if(n.target.closest("[data-node-id], [data-arrow-id]")){e.current=null;return}if(n.touches.length===0&&n.changedTouches.length>0){const u=n.changedTouches[0],g={timestamp:Date.now(),x:u.clientX,y:u.clientY};if(e.current){const p=g.timestamp-e.current.timestamp,f=Math.sqrt(Math.pow(g.x-e.current.x,2)+Math.pow(g.y-e.current.y,2));if(p<cu&&f<du){const h=o.projectCanvas.getActive();if(!h){e.current=null;return}const{scale:m,offset:x}=h.viewState,w=t.current;if(!w){e.current=null;return}const b=w.getBoundingClientRect(),N=g.x-b.left,j=g.y-b.top,C=Te({x:N,y:j},m,x);if(!C){e.current=null;return}const I=re(10);r({id:I,x:C.x,y:C.y,content:"",type:K.TEXT,isEditing:!0}),a(I);const A=((c=window.visualViewport)==null?void 0:c.height)||window.innerHeight;if(g.y>A/2){const E=()=>{var R,M;const y=window.innerHeight,v=((R=window.visualViewport)==null?void 0:R.height)||window.innerHeight;if(y-v>100){const D=C.y*m+x.y,L=v*.33-D;o.setActiveCanvasViewState(P=>({...P,targetView:{targetOffset:{x:x.x,y:x.y+L},targetScale:m,animationStartTime:0,animationDuration:1600}})),(M=window.visualViewport)==null||M.removeEventListener("resize",E)}};(d=window.visualViewport)==null||d.addEventListener("resize",E),setTimeout(()=>{var y;(y=window.visualViewport)==null||y.removeEventListener("resize",E)},2e3)}n.preventDefault(),n.stopPropagation(),e.current=null;return}}e.current=g}},[t])},fu=e=>1-Math.pow(1-e,3),gu={offset:{x:0,y:0},scale:1,targetView:null},pu=()=>{const e=B(l=>{var c;return((c=l.projectCanvas.getActive())==null?void 0:c.viewState)??gu}),t=$.getState(),n=t.projectCanvas.getActive,o=t.setActiveCanvasViewState,s=S.useRef(null),r=S.useRef({x:0,y:0}),a=S.useRef(1);S.useEffect(()=>{const l=e.offset,c=e.scale,d=e.targetView;if(d){if(d.animationStartTime===0){const g=performance.now();o(p=>({...p,targetView:p.targetView?{...p.targetView,animationStartTime:g}:null}));return}r.current=l,a.current=c;const u=g=>{var j;const p=(j=n())==null?void 0:j.viewState,f=p==null?void 0:p.targetView;if(!f){s.current&&(cancelAnimationFrame(s.current),s.current=null);return}const h=g-f.animationStartTime,m=Math.min(h/f.animationDuration,1),x=fu(m),w=r.current.x+(f.targetOffset.x-r.current.x)*x,b=r.current.y+(f.targetOffset.y-r.current.y)*x,N=a.current+(f.targetScale-a.current)*x;o(C=>({...C,offset:{x:w,y:b},scale:N})),m<1?s.current=requestAnimationFrame(u):(o(C=>({...C,offset:f.targetOffset,scale:f.targetScale,targetView:null})),s.current=null)};s.current=requestAnimationFrame(u)}return()=>{s.current&&(cancelAnimationFrame(s.current),s.current=null)}},[e,n,o])};class Do{static isInGivenAreaInCanvas(t,n,o){if(n.x===void 0||n.y===void 0)return!1;let s=!0,r=!0;if(o.xRatio!==void 0){const a=t.x+o.xRatio*t.width;s=n.x>=a}if(o.yRatio!==void 0){const a=t.y+o.yRatio*t.height;r=n.y>=a}return s&&r}static createGridForCanvas(t,n=3){const{width:o,height:s}=t,r=[],a=o/n,l=s/n;for(let c=0;c<=n;c++){const d=[];for(let u=0;u<=n;u++)d.push({x:u*a,y:c*l});r.push(d)}return r}static focusElementAndMoveCursorToEnd(t){if(!t)return;t.hasAttribute("tabindex")||t.setAttribute("tabindex","-1"),t.focus();const n=document.createRange(),o=window.getSelection();if(o)try{n.selectNodeContents(t),n.collapse(!1),o.removeAllRanges(),o.addRange(n)}catch(s){console.error("Failed to set cursor position:",s)}}}fe(Do,"getCanvasCenter",(t,n,o)=>{if(!t)return console.warn("Container not available for center calculation."),{x:0,y:0};if(!n)return console.warn("Offset not available for center calculation."),{x:0,y:0};const{clientWidth:s,clientHeight:r}=t,a=s/2,l=r/2,c=(a-n.x)/o,d=(l-n.y)/o;return{x:c,y:d}});const an=new yt("WriteModeHandlerV2",St.WriteModeHandlerV2);class hu{constructor(){fe(this,"s")}onKeyDown(t){const n=$.getState();this.s=n;const o=this.s.uiState,r=t.target.closest("#CanvasAppV2"),a=this.s.projectCanvas.getActive(),l=a==null?void 0:a.viewState,c=(l==null?void 0:l.offset)??{x:0,y:0},d=(l==null?void 0:l.scale)??1;if(!r||!l)return an.warn("Canvas or active canvas viewState not available."),!0;if(t.key==="Enter"&&t.ctrlKey){Be.clientLogsApiClient.sendLogs("ctrl_enter_pressed",{v:1,step:"start"},"write-mode-debug.log");const m=this.s.getEditingNode();if(Be.clientLogsApiClient.sendLogs("ctrl_enter_current_node",{hasEditingNode:!!m,nodeId:(m==null?void 0:m.id)??null,nodeIsEditing:(m==null?void 0:m.isEditing)??null},"write-mode-debug.log"),!m)return!0;this.s.unselectNodeById(m.id);const x={x:m.x,y:m.y+(m.height??30)+30},w=me.buildTextNode(x,"");Be.clientLogsApiClient.sendLogs("ctrl_enter_next_node_built",{nextNodeId:w.id,nextNodeIsEditing:w.isEditing,position:x},"write-mode-debug.log");const b={x:(0-c.x)/d,y:(0-c.y)/d,width:r.clientWidth/d,height:r.clientHeight/d},N=Do.isInGivenAreaInCanvas(b,w,{yRatio:Z.writeMode.scrollYRatio});Be.clientLogsApiClient.sendLogs("ctrl_enter_before_add",{nextNodeId:w.id,willScroll:N},"write-mode-debug.log"),this.addNode(w);const j=$.getState(),C=j.getNodeById(w.id);return Be.clientLogsApiClient.sendLogs("ctrl_enter_after_add",{nextNodeId:w.id,nodeToFocusId:j.uiState.nodeToFocusId,addedNodeIsEditing:(C==null?void 0:C.isEditing)??null},"write-mode-debug.log"),N&&setTimeout(()=>{n.scrollToNode(w,Z.writeMode.scrollDuration,{verticalOnly:!0})},50),!0}if(o.nodeToFocusId)return!0;const{mode:p}=o;if(p!==H.WRITE)return!1;const f=t.key,h=t.ctrlKey||t.metaKey;if(f.length===1&&!h&&f!=="Enter"){const m=$.getState(),x=m.uiState.writeModeStartPosition,w=x??Do.getCanvasCenter(r,c,d),b=me.buildTextNode(w,"");return this.addNode(b),x&&m.setWriteModeStartPosition(null),an.log(`WRITE Mode: Key "${f}" pressed. Created node ${b.id} at position (${w.x}, ${w.y}) and requested focus.`),!0}return f==="Escape"?(an.log("WRITE Mode: Escape pressed. Global handler will switch mode."),!1):(an.log(`WRITE Mode: Key "${f}" ignored by WriteModeHandler.`),!0)}onKeyUp(t){return!0}addNode(t){Be.clientLogsApiClient.sendLogs("addNode_start",{nodeId:t.id,isEditingBefore:t.isEditing},"write-mode-debug.log"),t.isEditing=!0,Be.clientLogsApiClient.sendLogs("addNode_isEditing_set",{nodeId:t.id,isEditingAfter:t.isEditing},"write-mode-debug.log"),this.s.addNode(t,""),Be.clientLogsApiClient.sendLogs("addNode_added_to_state",{nodeId:t.id},"write-mode-debug.log"),this.s.setNodeToFocusId(t.id),Be.clientLogsApiClient.sendLogs("addNode_focus_set",{nodeId:t.id,nodeToFocusId:this.s.uiState.nodeToFocusId},"write-mode-debug.log")}}class mu{onMouseDown(t){const n=$.getState(),o=n.uiState,{mode:s,addNodeType:r}=o;if(s!==H.ADD)return!1;const a=n.getCanvasMouseCoords();if(!a)return!1;let l=!1;if(r===K.TABLE){const c=me.buildTableNode(a);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(r===K.TEXTCARD){const c=me.buildTextCardNode(a);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(r===K.WORKFLOW_ORCHESTRATION){const c=me.buildWorkflowOrchestrationNode(a);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(r===K.WORKFLOW_SOURCE){const c=me.buildWorkflowSourceNode(a);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(r===K.WORKFLOW_DEFINITION){const c=me.buildWorkflowDefinitionNode(a);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}else if(r===K.OCR){const c=me.buildOCRNode(a);n.addNode(c),n.setNodeToFocusId(c.id),l=!0}return l?(n.setMode(H.SELECT),n.setAddNodeType(null),t.stopPropagation(),!0):!1}}const xu=()=>{const[e,t]=S.useState(null),n=S.useRef(new hu),o=S.useRef(new Xe),s=S.useRef(new mu),r=ad(t),a=ld(),l=cd(t),c=dd(t),d=ud(),u=fd(),g=Dd(),p=Md(),f=Od(),h=Fd(),m=$d(),x=Jd(),w=Qd(),b=eu(),N=tu(),j=ru(),C=iu(),I=au(),{handleTouchStart:A,handleTouchMove:T,handleTouchEnd:E}=lu(),y=uu(),v=$.getState(),k=v.setMode,R=v.setAddNodeType,M=v.uiState,D=je.useMemo(()=>({pointer:{onPointerDown:_=>{$.getState().uiState.mode===H.ADD&&s.current.onMouseDown(_)||(r(_),f(_),j(_),o.current.onMouseDown(_))},onPointerMove:_=>{a(_),h(_),x(_),b(_),C(_)},onPointerUp:_=>{l(_),m(_),w(_),N(_),I(_)},onPointerLeave:c,onDblClick:u},wheel:d,touch:{onTouchStart:A,onTouchMove:T,onTouchEnd:_=>{E(_),y(_)}},keyboard:{onKeyDown:_=>{n.current.onKeyDown(_),g(_)},onKeyUp:p}}),[r,f,j,a,h,x,b,C,l,m,w,N,I,c,d,A,T,E,g,p,u,y,k,R,M.mode,M.addNodeType,s]);return Ja(D),pu(),id(),null},wu=({top:e,bottom:t,left:n,right:o,topLeft:s,topRight:r,bottomLeft:a,bottomRight:l,alwaysVisibleBottomLeft:c,isContentVisible:d=!0})=>{const u=Mn(),[g,p]=S.useState({top:!1,bottom:!1,left:!1,right:!1,topLeft:!1,topRight:!1,bottomLeft:!1,bottomRight:!1,alwaysVisibleBottomLeft:!1}),f=m=>{p(x=>({...x,[m]:!x[m]}))},h=(m,x,w)=>i.jsx(X,{variant:"ghost",size:"icon",onClick:()=>f(m),className:`h-11 w-11 bg-background/30 backdrop-blur-sm hover:bg-background/50 transition-colors ${w}`,"data-prevent-canvas-click":!0,"data-ui-panel":!0,title:`Toggle ${m}`,"data-test":`mobile-toggle-${m}`,children:i.jsx(x,{className:"h-5 w-5 opacity-70"})});return i.jsxs("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},"data-ui-panel":"canvas-overlay","data-test":"canvas-overlay-container",children:[e&&i.jsx("div",{className:"absolute top-2 left-1/2 transform -translate-x-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top",children:e}),d&&t&&i.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom",children:u?i.jsxs("div",{className:"flex flex-col items-center gap-2",children:[g.bottom&&i.jsx("div",{children:t}),h("bottom",bs,"")]}):t}),d&&n&&i.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-left",children:u?i.jsxs("div",{className:"flex flex-row items-center gap-2",children:[h("left",bs,""),g.left&&i.jsx("div",{children:n})]}):n}),d&&o&&i.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-right",children:u?i.jsxs("div",{className:"flex flex-row items-center gap-2",children:[g.right&&i.jsx("div",{children:o}),h("right",Ko,"")]}):o}),d&&s&&i.jsx("div",{className:"absolute top-4 left-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-left",children:u?i.jsxs("div",{className:"flex flex-col items-start gap-1",children:[h("topLeft",Hi,""),g.topLeft&&i.jsx("div",{children:s})]}):s}),d&&r&&i.jsx("div",{className:"absolute top-2 right-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-top-right",children:u?i.jsxs("div",{className:"flex flex-col items-end gap-1",children:[h("topRight",jt,""),g.topRight&&i.jsx("div",{children:r})]}):r}),d&&a&&i.jsx("div",{className:"absolute bottom-2 left-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-left",children:u?i.jsxs("div",{className:"flex flex-col items-start gap-1",children:[g.bottomLeft&&i.jsx("div",{children:a}),h("bottomLeft",Cs,"")]}):a}),c&&i.jsx("div",{className:"absolute left-2 pointer-events-auto",style:{bottom:d&&a?"5rem":"0.5rem"},"data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-always-visible-bottom-left",children:u?i.jsxs("div",{className:"flex flex-col items-start gap-1",children:[g.alwaysVisibleBottomLeft&&i.jsx("div",{children:c}),h("alwaysVisibleBottomLeft",Cs,"")]}):c}),d&&l&&i.jsx("div",{className:"absolute bottom-2 right-2 pointer-events-auto","data-prevent-canvas-click":!0,"data-test":"canvas-overlay-region-bottom-right",children:u?i.jsxs("div",{className:"flex flex-col items-end gap-1",children:[g.bottomRight&&i.jsx("div",{children:l}),h("bottomRight",Ir,"")]}):l})]})},vu={offset:{x:0,y:0},scale:1,targetView:null},Su=()=>{var u,g;const e=B(p=>{var f;return((f=p.projectCanvas.getActive())==null?void 0:f.viewState)??vu}),t=B(p=>p.uiState),n=t==null?void 0:t.selectionBox,o=kt(p=>p.mousePosition)??null,s=e.scale??1,r=e.offset??{x:0,y:0},a=p=>{const f=Math.max(.01,Math.min(4,p));$.getState().setActiveCanvasViewState(h=>({...h,scale:f}))},l=p=>{let f;p==="up"?s<.1?f=Math.round((s+.01)*100)/100:f=Math.round((s+.1)*10)/10:s<=.1?f=Math.round((s-.01)*100)/100:f=Math.round((s-.1)*10)/10,a(f)},c=p=>{p.key==="ArrowUp"?(p.preventDefault(),l("up")):p.key==="ArrowDown"&&(p.preventDefault(),l("down"))},d=()=>{$.getState().setActiveCanvasViewState(p=>({...p,offset:{x:0,y:0},scale:1,targetView:null}))};return i.jsxs("div",{className:"text-xs p-1 bg-background/30 backdrop-blur-sm rounded pointer-events-auto",children:[i.jsxs("div",{className:"flex items-center gap-1",children:[i.jsx("label",{className:"opacity-70",children:"Zoom:"}),i.jsx("input",{type:"number",value:s.toFixed(2),onChange:p=>a(parseFloat(p.target.value)||1),onKeyDown:c,min:"0.01",max:"4.0",step:"any",className:"w-16 px-1 py-0.5 text-xs border-0 rounded bg-background/50","data-test":"canvas-debug-zoom-input"}),i.jsx("button",{onClick:d,className:"px-1.5 py-0.5 text-xs border-0 rounded bg-background/50 hover:bg-background/70 transition-colors",title:"Reset view to 0,0","data-test":"canvas-debug-reset-button",children:"Reset"})]}),i.jsxs("div",{children:["Offset: X: ",((u=r==null?void 0:r.x)==null?void 0:u.toFixed(0))??0,", Y: ",((g=r==null?void 0:r.y)==null?void 0:g.toFixed(0))??0]}),i.jsxs("div",{children:["Mouse:"," ",o?`X: ${o.x.toFixed(0)}, Y: ${o.y.toFixed(0)}`:"N/A"]}),i.jsxs("div",{children:["M+O:"," ",o&&r?`X: ${(o.x-r.x).toFixed(0)}, Y: ${(o.y-r.y).toFixed(0)}`:"N/A"]}),i.jsxs("div",{children:["SelBox:",n?i.jsxs(i.Fragment,{children:[i.jsx("div",{children:`S:(${n.start.x.toFixed(0)},${n.start.y.toFixed(0)})`}),i.jsx("div",{children:` E:(${n.end.x.toFixed(0)},${n.end.y.toFixed(0)})`})]}):"N/A"]})]})},ze=e=>{const{className:t,mainAction:n,dropdownActions:o=[],variant:s,size:r,dropdownMenuClassName:a,dropdownTriggerButtonId:l="options-menu-button",dropdownPosition:c="bottom",dropdownHorizontalAlign:d="container-right",persistenceKey:u,...g}=e,[p,f]=S.useState(!1),h=S.useRef(null),m=S.useRef(null),[x,w]=S.useState(d),[b,N]=S.useState(c),[j,C]=S.useState(!1),I=()=>u?$.getState().getSegmentedButtonAction(u):null,[A,T]=S.useState(I),E=D=>{D.stopPropagation(),f(_=>(_||C(!1),!_))},y=()=>{if(A){const D=o.find(_=>_.label===A);D&&!D.disabled&&D.onClick?D.onClick():n.onClick()}else n.onClick()},v=(D,_)=>{D(),T(_),u&&$.getState().setSegmentedButtonAction(u,_),f(!1)};S.useEffect(()=>{if(p&&m.current&&h.current){const D=m.current,_=h.current,L=D.getBoundingClientRect();_.getBoundingClientRect();const P=window.innerWidth,O=window.innerHeight,W=16,z=L.right>P-W,U=L.left<W;w(z&&!U?"container-right":U&&!z?"container-edge-right":d);const V=L.bottom>O-W,ee=L.top<W;N(V&&!ee?"top":ee&&!V?"bottom":c),C(!0)}},[p,d,c]),S.useEffect(()=>{const D=_=>{h.current&&!h.current.contains(_.target)&&f(!1)};return p?document.addEventListener("pointerdown",D):document.removeEventListener("pointerdown",D),()=>{document.removeEventListener("pointerdown",D)}},[p]);const k=o&&o.length>0;let R=n.text||n.label;if(A){const D=o.find(_=>_.label===A);D&&(R=D.label)}const M=D=>D.stopPropagation();return i.jsxs("div",{id:"UiSegmentedButton",ref:h,"data-prevent-canvas-click":!0,className:ve("ui-segmented-button","relative inline-flex items-stretch",t),...g,children:[i.jsx(ft,{delayDuration:300,children:i.jsxs(gt,{children:[i.jsx(pt,{asChild:!0,children:i.jsxs(X,{variant:s,size:r,onClick:D=>{D.stopPropagation(),y()},"aria-label":n.label,disabled:n.disabled,className:ve("ui-segmented-button__main-action",{"rounded-r-none":k,"border-r-0":k&&s==="outline","focus:z-10":k}),children:[n.icon,n.text&&i.jsx("span",{children:n.text})]})}),i.jsx(ht,{children:i.jsx("p",{children:R})})]})}),k&&i.jsxs(i.Fragment,{children:[i.jsx(X,{id:l,variant:s,size:r,onClick:E,"aria-haspopup":"true","aria-expanded":p,"aria-label":"Toggle dropdown options",disabled:n.disabled||!o.some(D=>!D.disabled),className:ve("ui-segmented-button__dropdown-trigger","rounded-l-none",r!=="icon"&&"px-1",{"focus:z-10":k}),children:i.jsx(Ut,{className:"ui-segmented-button__caret-icon w-1.5 h-2.5"})}),p&&i.jsx("div",{ref:m,onPointerDown:M,onPointerUp:M,onClick:M,className:ve("ui-segmented-button__dropdown-menu","absolute w-56 rounded-md shadow-lg z-10","bg-popover text-popover-foreground border","transition-opacity duration-75",{"opacity-0 pointer-events-none":!j,"opacity-100":j,"right-0":x==="container-right","left-full":x==="container-edge-right"||x==="middle-right","-translate-x-1/2":x==="middle-right"},b==="top"?`${x==="container-right"?"origin-bottom-right":"origin-bottom-left"} bottom-full mb-2`:`${x==="container-right"?"origin-top-right":"origin-top-left"} mt-[28px]`,a),role:"menu","aria-orientation":"vertical","aria-labelledby":l,children:i.jsx("div",{className:"py-1",role:"none",children:o.map((D,_)=>D.customRender?i.jsx("div",{children:D.customRender()},_):i.jsxs(X,{variant:"ghost",size:"sm",onClick:()=>v(D.onClick,D.label),disabled:D.disabled,className:ve("ui-segmented-button__dropdown-item","w-full justify-start text-left font-normal"),role:"menuitem",children:[D.icon&&i.jsx("span",{className:"mr-2",children:D.icon})," ",D.label]},_))})})]})]})},yu=e=>{const{className:t,variant:n}=e,o=$.getState(),s=o.setMode,r=o.setAddNodeType,a=o.setSelectionBox,l=()=>{s(H.ADD),r(K.TABLE),a(null)},c=()=>{s(H.ADD),r(K.TEXTCARD),a(null)},d=()=>{s(H.ADD),r(K.WORKFLOW_ORCHESTRATION),a(null)},u=()=>{s(H.ADD),r(K.WORKFLOW_SOURCE),a(null)},g=()=>{s(H.ADD),r(K.WORKFLOW_DEFINITION),a(null)},p=()=>{s(H.ADD),r(K.OCR),a(null)},f=[{label:"Table",icon:i.jsx(Wi,{className:"h-2.5 w-2.5"}),onClick:l},{label:"Text Card",icon:i.jsx(zi,{className:"h-2.5 w-2.5"}),onClick:c},{label:"OCR",icon:i.jsx(pn,{className:"h-2.5 w-2.5"}),onClick:p},{label:"Workflow",icon:i.jsx(vn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Source",icon:i.jsx(Ir,{className:"h-2.5 w-2.5"}),onClick:u},{label:"WF Runner",icon:i.jsx(Ln,{className:"h-2.5 w-2.5"}),onClick:g}],[h,m]=S.useState(f[0]),x=b=>{m(b),b.onClick()},w=()=>{h.onClick()};return i.jsx("div",{id:"ToolbarAddCustomNode",className:ae("",t),"data-test":"toolbar-add-custom-node-button",children:i.jsx(ze,{size:"sm",variant:n??"default",mainAction:{icon:h.icon,onClick:w,text:"(n)",label:`Add ${h.label}`},dropdownActions:f.map(b=>({...b,onClick:()=>x(b)})),dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})},Nu=e=>{const{className:t,style:n}=e,o=Mn(),s=B(w=>w.uiState.mode),r=B(w=>w.uiState.addNodeType),a=B(w=>w.uiState.zoomSubMode),l=B(w=>w.uiState.writeSubMode),c=$.getState(),d=c.setMode,u=c.setAddNodeType,g=c.setZoomSubMode,p=c.setWriteSubMode,f=c.toggleWriteSubMode,h=c.saveStateToLocalStorage,m=w=>{d(w)},x=()=>{d(H.ADD),u(K.TEXT)};return i.jsxs("div",{className:ae("p-2 bg-background border shadow pointer-events-auto rounded flex items-center",o?"flex-wrap gap-2 w-full max-w-lg":"space-x-2",t),style:{...n},onMouseDown:w=>w.stopPropagation(),"data-ui-panel":"canvas-toolbar",children:[i.jsxs(X,{variant:s===H.SELECT?"default":"secondary",size:o?"icon":"sm",onClick:()=>m(H.SELECT),title:"Select (v)","data-test":"canvas-toolbar-select-mode-button",children:[i.jsx(Bi,{className:"h-4 w-4"}),!o&&i.jsx("span",{className:"ml-1",children:"(v)"})]}),i.jsxs("div",{className:"relative","data-test":"canvas-toolbar-move-mode-wrapper",children:[i.jsxs(X,{variant:s===H.MOVE||s===H.ZOOM?"default":"secondary",size:o?"icon":"sm",className:ae(s===H.ZOOM&&a==="zoom:lock"&&"bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white"),onClick:()=>{s===H.MOVE?(m(H.ZOOM),g("zoom")):s===H.ZOOM?(document.pointerLockElement&&document.exitPointerLock(),m(H.MOVE)):m(H.MOVE)},title:s===H.ZOOM&&a==="zoom:lock"?"Zoom:Lock Mode (click or Esc to exit)":s===H.ZOOM?"Zoom Mode (h to toggle Pan)":"Pan Mode (h to toggle Zoom)","data-test":"canvas-toolbar-move-mode-button",children:[s===H.ZOOM?i.jsx(Vi,{className:"h-4 w-4"}):i.jsx(Ui,{className:"h-4 w-4"}),!o&&i.jsx("span",{className:"ml-1",children:"(h)"})]}),i.jsx(ft,{children:i.jsxs(gt,{delayDuration:200,children:[i.jsx(pt,{asChild:!0,children:i.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-move-mode-info-icon",children:i.jsx(jt,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),i.jsx(ht,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-move-mode-info-tooltip",children:i.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-move-mode-info-content",children:[i.jsxs("p",{children:[i.jsx("strong",{children:"Pan Mode (h):"})," Drag to pan the canvas"]}),i.jsxs("p",{children:[i.jsx("strong",{children:"Zoom Mode (h again):"})," Scroll or drag to zoom"]}),i.jsxs("p",{children:[i.jsx("strong",{children:"Zoom:Lock:"})," Double-click canvas to lock zoom, move mouse to zoom"]}),i.jsx("p",{className:"text-muted-foreground",children:"Press 'h' to toggle between Pan and Zoom"})]})})]})})]}),i.jsxs(X,{variant:s===H.GRID?"default":"secondary",size:o?"icon":"sm",onClick:()=>m(H.GRID),title:"Grid Mode (g)","data-test":"canvas-toolbar-grid-mode-button",children:[i.jsx(Gi,{className:"h-4 w-4"}),!o&&i.jsx("span",{className:"ml-1",children:"(g)"})]}),i.jsxs(X,{variant:s===H.DRAW_ARROW?"default":"secondary",size:o?"icon":"sm",onClick:()=>m(H.DRAW_ARROW),"data-test":"canvas-toolbar-draw-arrow-button",children:[i.jsx(Gt,{className:"h-4 w-4"}),!o&&i.jsx("span",{className:"ml-1",children:"(a)"})]}),i.jsxs(X,{variant:s===H.ADD&&r===K.TEXT?"default":"secondary",size:o?"icon":"sm",onClick:x,title:"Text (t)","data-test":"canvas-toolbar-text-mode-button",children:[i.jsx(Yi,{className:"h-4 w-4"}),!o&&i.jsx("span",{className:"ml-1",children:"(T)"})]}),i.jsxs("div",{className:"relative","data-test":"canvas-toolbar-write-mode-wrapper",children:[i.jsxs(X,{variant:s===H.WRITE?"default":"secondary",size:o?"icon":"sm",className:ae(s===H.WRITE&&l===Le.AUDIO&&"bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-500 text-white"),onClick:()=>{s===H.WRITE?f():(m(H.WRITE),p(Le.WRITE))},title:s===H.WRITE&&l===Le.AUDIO?"Write:Audio Mode (a to toggle)":"Write (w, then a for audio)","data-test":"canvas-toolbar-write-mode-button",children:[s===H.WRITE&&l===Le.AUDIO?i.jsx(Xi,{className:"h-4 w-4"}):i.jsx(Ki,{className:"h-4 w-4"}),!o&&i.jsx("span",{className:"ml-1",children:"(w)"})]}),i.jsx(ft,{children:i.jsxs(gt,{delayDuration:200,children:[i.jsx(pt,{asChild:!0,children:i.jsx("div",{className:"absolute -top-1 -right-1 bg-muted rounded-full p-0.5 cursor-help hover:bg-accent","data-test":"canvas-toolbar-write-mode-info-icon",children:i.jsx(jt,{className:"h-2.5 w-2.5 text-muted-foreground"})})}),i.jsx(ht,{side:"top",className:"max-w-xs","data-test":"canvas-toolbar-write-mode-info-tooltip",children:i.jsxs("div",{className:"text-xs space-y-1","data-test":"canvas-toolbar-write-mode-info-content",children:[i.jsxs("p",{children:[i.jsx("strong",{children:"Write Mode (w):"})," Create nodes with Ctrl+Enter"]}),i.jsxs("p",{children:[i.jsx("strong",{children:"Write:Audio (w, then a):"})," Auto-starts voice recording when creating nodes"]}),i.jsx("p",{className:"text-muted-foreground",children:"Click button again or press 'a' to toggle audio mode"})]})})]})})]}),i.jsx(yu,{variant:s===H.ADD&&(r===K.TABLE||r===K.TEXTCARD||r===K.OCR||r===K.WORKFLOW_ORCHESTRATION||r===K.WORKFLOW_SOURCE||r===K.WORKFLOW_DEFINITION)?"default":"secondary"}),i.jsx(X,{variant:"secondary",size:o?"icon":"sm",onClick:h,title:"Save to Local Storage","data-test":"canvas-toolbar-save-button",children:i.jsx(mt,{className:"h-4 w-4"})})]})},bu=({startX:e,startY:t,endX:n,endY:o})=>{const s=Math.min(e,n),r=Math.min(t,o),a=Math.abs(e-n),l=Math.abs(t-o);return a===0||l===0?null:i.jsx("div",{className:"absolute border border-ring bg-ring/20 pointer-events-none",style:{left:`${s}px`,top:`${r}px`,width:`${a}px`,height:`${l}px`,zIndex:20}})},Cu=({node:e})=>i.jsxs("div",{className:ae("bg-background border border-foreground p-2",e.className),style:{width:e.width?`${e.width}px`:"100px",height:e.height?`${e.height}px`:"50px",whiteSpace:"pre-line"},children:[e.content||"Rect"," "]});class ju{createHighlight(t,n,o){return{id:n??re(),start:t.start,end:t.end,color:t.color,createdAt:o??Date.now()}}validateHighlight(t,n){return t.start<0?{valid:!1,error:"Highlight start cannot be negative"}:t.end>n?{valid:!1,error:`Highlight end (${t.end}) exceeds text length (${n})`}:t.start>=t.end?{valid:!1,error:"Highlight start must be less than end"}:{valid:!0}}findOverlapping(t,n,o,s){const r=(s==null?void 0:s.includeTouching)??!1;return t.filter(a=>r?!(a.end<n||a.start>o):!(a.end<=n||a.start>=o))}deleteHighlight(t,n){return t.filter(o=>o.id!==n)}sortHighlights(t){return[...t].sort((n,o)=>n.start!==o.start?n.start-o.start:n.end-o.end)}}function Iu(e){if(e instanceof HTMLTextAreaElement){const t=e.selectionStart,n=e.selectionEnd;return t===n?null:{start:t,end:n}}if(e.isContentEditable){const t=window.getSelection();if(!t||t.isCollapsed||t.rangeCount===0)return null;const n=t.getRangeAt(0),o=document.createRange();o.setStart(e,0),o.setEnd(n.startContainer,n.startOffset);const s=o.toString().length,r=s+t.toString().length;return s===r?null:{start:s,end:r}}return null}const ku="rgb(198, 183, 0)";function Ru({textareaRef:e,node:t,updateNode:n,enabled:o=!0,defaultColor:s=ku}){const r=S.useRef(new ju),a=S.useCallback(d=>{if(!e.current||!o){console.warn("useTextHighlighting: Cannot apply highlight - textarea not available or disabled");return}const u=Iu(e.current);if(!u){console.warn("useTextHighlighting: No text selected");return}const g=t.highlights||[],p=r.current.findOverlapping(g,u.start,u.end);if(p.length>0){let b=g;for(const N of p)b=r.current.deleteHighlight(b,N.id);if(n(t.id,{highlights:b.length>0?b:void 0}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const N=window.getSelection();N&&N.collapseToEnd()}console.log("ðŸ—‘ï¸ Highlights removed:",p.length);return}const f=r.current.createHighlight({start:u.start,end:u.end,color:d||s}),h=t.content||"",m=r.current.validateHighlight(f,h.length);if(!m.valid){console.error("useTextHighlighting: Invalid highlight",m.error);return}const x=[...g,f],w=r.current.sortHighlights(x);if(n(t.id,{highlights:w}),e.current)if(e.current instanceof HTMLTextAreaElement)e.current.setSelectionRange(u.end,u.end);else{const b=window.getSelection();b&&b.collapseToEnd()}console.log("âœ¨ Highlight applied:",{start:u.start,end:u.end,color:f.color})},[e,o,t,n,s]),l=d=>{const u=t.highlights||[],g=r.current.deleteHighlight(u,d);n(t.id,{highlights:g.length>0?g:void 0}),console.log("ðŸ—‘ï¸ Highlight removed:",d)},c=()=>{n(t.id,{highlights:void 0}),console.log("ðŸ§¹ All highlights cleared")};return S.useEffect(()=>{if(!o||!e.current)return;const d=()=>{Ot.registerCallback(a)},u=()=>{Ot.unregisterCallback(a)},g=e.current;return g.addEventListener("focus",d),g.addEventListener("blur",u),document.activeElement===g&&Ot.registerCallback(a),()=>{g.removeEventListener("focus",d),g.removeEventListener("blur",u),Ot.unregisterCallback(a)}},[o,e,a]),{applyHighlight:a,removeHighlight:l,clearAllHighlights:c}}function cs(e,t={}){var x;const{duration:n=500,targetScale:o,highlightYOffset:s}=t,r=$.getState(),a=(x=r.projectCanvas.getActive())==null?void 0:x.viewState;if(!a)return;const l=document.getElementById("CanvasAppV2");if(!l)return;const c=l.getBoundingClientRect(),d=c.width/2,u=c.height/2,g=o??a.scale,p=e.x*g,f=e.y*g,h=s!==void 0?f+s*g:f+(e.height||0)*g/2,m={x:d-p-(e.width||0)*g/2,y:u-h};r.setActiveCanvasViewState(w=>({...w,targetView:{targetOffset:m,targetScale:g,animationStartTime:performance.now(),animationDuration:n}})),r.setSelectedNodes([e]),r.setNodeToFocusId(e.id)}const Eu=({text:e,highlights:t,className:n})=>{const o=S.useRef(null),s=S.useRef(null),[r,a]=S.useState([]),[l,c]=S.useState(0),[d,u]=S.useState(1);S.useEffect(()=>{var m;const p=$.subscribe(x=>{var N;const w=(N=x.projectCanvas.getActive())==null?void 0:N.viewState,b=(w==null?void 0:w.scale)??1;u(b)}),h=(m=$.getState().projectCanvas.getActive())==null?void 0:m.viewState;return u((h==null?void 0:h.scale)??1),p},[]);const g=p=>{var x;if(!p)return;const m=(((x=$.getState().projectCanvas.getActive())==null?void 0:x.coreState.nodes)??[]).find(w=>w.id===p);if(!m){console.warn(`Linked node ${p} not found`);return}cs(m,{duration:400})};return S.useEffect(()=>{var m,x;const p=o.current;if(!p)return;const f=((m=p.parentElement)==null?void 0:m.querySelector("textarea"))||((x=p.parentElement)==null?void 0:x.querySelector(".markdown-textarea"));if(!f)return;c(f.clientWidth);const h=new ResizeObserver(w=>{for(const b of w)b.target===f&&c(f.clientWidth)});return h.observe(f),()=>{h.disconnect()}},[]),S.useEffect(()=>{if(!o.current||!s.current||!t||t.length===0){a([]);return}const p=requestAnimationFrame(()=>{var I,A;if(!o.current||!s.current)return;const f=o.current,h=((I=f.parentElement)==null?void 0:I.querySelector("textarea"))||((A=f.parentElement)==null?void 0:A.querySelector(".markdown-textarea"));if(!h){a([]);return}const m=s.current,x=window.getComputedStyle(h);m.style.font=x.font,m.style.fontSize=x.fontSize,m.style.fontFamily=x.fontFamily,m.style.fontWeight=x.fontWeight,m.style.lineHeight=x.lineHeight,m.style.letterSpacing=x.letterSpacing,m.style.wordSpacing=x.wordSpacing,m.style.padding=x.padding,m.style.paddingLeft=x.paddingLeft,m.style.paddingRight=x.paddingRight,m.style.paddingTop=x.paddingTop,m.style.paddingBottom=x.paddingBottom,m.style.width=`${h.clientWidth}px`,m.style.border="none";const w=parseFloat(x.borderTopWidth)||0,b=parseFloat(x.borderLeftWidth)||0;m.style.top=`${w}px`,m.style.left=`${b}px`,m.style.wordWrap=x.wordWrap,m.style.whiteSpace=x.whiteSpace,m.style.overflowWrap=x.overflowWrap,m.style.boxSizing=x.boxSizing,m.style.textAlign=x.textAlign,m.style.direction=x.direction,m.style.wordBreak=x.wordBreak,m.textContent=e;const N=h.getBoundingClientRect(),j=f.getBoundingClientRect(),C=[];for(const T of t){const E=Math.min(T.start,e.length),y=Math.min(T.end,e.length);if(E>=y)continue;const v=e.substring(E,y);try{const k=document.createRange(),R=m.firstChild;if(!R||R.nodeType!==Node.TEXT_NODE)continue;k.setStart(R,E),k.setEnd(R,y);const M=k.getClientRects();for(let D=0;D<M.length;D++){const _=M[D],L={top:_.top-j.top,left:_.left-j.left},P={top:_.top-N.top,left:_.left-N.left},O=parseFloat(x.borderTopWidth)||0,W=L.top-O,z=parseFloat(x.paddingLeft)||0,U=P.left-z,V=_.width,ee=_.height,te=W/d,le=U/d,ye=V/d+8,pe=ee/d;C.push({id:`${T.id}-${D}`,top:te,left:le,width:ye,height:pe,color:T.color,linkedNodeId:T.linkedNodeId,highlightedText:v})}}catch(k){console.error("Error calculating highlight rect:",k)}}a(C)});return()=>{cancelAnimationFrame(p)}},[e,t,l,d]),!t||t.length===0?null:i.jsxs(i.Fragment,{children:[i.jsx("div",{ref:s,className:ae("mirror-div absolute inset-0 pointer-events-none whitespace-pre-wrap"),"aria-hidden":"true"}),i.jsx("div",{ref:o,className:ae("highlight-renderer","absolute inset-0","z-20","pointer-events-none",n),"aria-hidden":"true",children:r.map(p=>i.jsx("mark",{"data-test":"highlight-mark",className:ae("absolute",p.linkedNodeId?"cursor-pointer pointer-events-auto":"pointer-events-none"),onClick:p.linkedNodeId?()=>g(p.linkedNodeId):void 0,style:{top:`${p.top}px`,left:`${p.left}px`,width:`${p.width}px`,height:`${p.height}px`,backgroundColor:p.color,opacity:.4,borderRadius:"2px"}},p.id))})]})},Au=4,Tu=24;function Du(e,t){const n=e.split(`
`);let o=0;for(let s=0;s<n.length;s++){const r=n[s].length,a=o+r;if(t<=a)return s;o=a+1}return n.length-1}function Mu(e,t,n=Au,o=Tu){const s=Du(e,t.start);return n+s*o+o/2}function Pu({textareaRef:e,onCopy:t,onHighlight:n,onDelete:o,onLink:s,onHighlightAndCreateNode:r,onDefine:a}){const[l,c]=S.useState(!1),[d,u]=S.useState({start:0,end:0}),g=S.useRef({start:0,end:0}),p=S.useRef(null),f=S.useRef(!1);S.useEffect(()=>{const x=()=>{f.current=!0,c(!1)};return Xe.registerDismissPopoverCallback(x),()=>{Xe.unregisterDismissPopoverCallback()}},[]),S.useEffect(()=>(Xe.registerSelectionCallback(x=>{c(x)}),p.current=setInterval(()=>{const x=e.current;if(!x)return;const w=x.selectionStart,b=x.selectionEnd,N=w!==b;N&&((w!==g.current.start||b!==g.current.end)&&(f.current=!1),g.current={start:w,end:b},u({start:w,end:b})),f.current||c(N)},100),()=>{Xe.unregisterSelectionCallback(),p.current&&clearInterval(p.current)}),[e]);const h=()=>{const x=e.current;return x?(x.value??"").substring(d.start,d.end):""},m=(x,w)=>{x.preventDefault(),x.stopPropagation(),f.current=!0;const b=e.current;b&&(b.focus(),b.setSelectionRange(d.start,d.end)),w&&w(),setTimeout(()=>{c(!1)},20)};return i.jsx(Ha,{inputRef:e,show:l,updateOn:d,offset:{top:4,left:0},children:i.jsxs("div",{className:"text-selection-popover bg-popover text-popover-foreground border border-border rounded-md shadow-lg p-1","data-test":"text-selection-popover",onPointerDown:x=>{x.preventDefault()},style:{touchAction:"none"},children:[i.jsxs("div",{className:"flex items-center gap-1",children:[t&&i.jsx("button",{"data-test":"text-selection-copy-button",onPointerDown:x=>m(x,t),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Create linked node",children:i.jsx(Sn,{className:"w-4 h-4"})}),r&&i.jsx("button",{"data-test":"text-selection-highlight-create-button",onPointerDown:x=>m(x,r),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight & create linked node",children:i.jsx(yn,{className:"w-4 h-4"})}),a&&i.jsx("button",{"data-test":"text-selection-define-button",onPointerDown:x=>m(x,a),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Define word",children:i.jsx(qi,{className:"w-4 h-4"})}),n&&i.jsx("button",{"data-test":"text-selection-highlight-button",onPointerDown:x=>m(x,n),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Highlight text",children:i.jsx(Zi,{className:"w-4 h-4"})}),s&&i.jsx("button",{"data-test":"text-selection-link-button",onPointerDown:x=>m(x,s),className:"action-button p-2 rounded hover:bg-accent hover:text-accent-foreground transition-colors",title:"Link to node",children:i.jsx(Ji,{className:"w-4 h-4"})}),o&&i.jsx("button",{"data-test":"text-selection-delete-button",onPointerDown:x=>m(x,o),className:"action-button p-2 rounded hover:bg-destructive hover:text-destructive-foreground transition-colors",title:"Delete selection",children:i.jsx(Ke,{className:"w-4 h-4"})})]}),i.jsxs("div",{className:"selection-preview text-xs text-muted-foreground mt-1 px-2 py-1 max-w-[200px] truncate",children:['"',h(),'"']})]})})}const Xs=(e,t)=>{const o=$.getState().projectCanvas.getActive();if(!o)return null;const r=(o.coreState.nodes||[]).filter(l=>{var c;return l.linkedSourceNodeId===e&&((c=l.tags)==null?void 0:c.some(d=>d.title===t))});return r.length===0?null:Math.max(...r.map(l=>(l.y??0)+(l.height??0)))},_u=({node:e,isEditing:t,preventEdit:n})=>{const o=d=>({id:Math.random().toString(36).slice(2,10),title:d}),s=d=>({x:(d.x??0)+(d.width??0)/2,y:(d.y??0)+(d.height??0)/2}),r=(d,u)=>{const g=$.getState(),p=()=>Math.random().toString(36).slice(2,10);window.setTimeout(()=>{g.arrow.add({id:p(),startNodeId:d.id,endNodeId:u.id,startPoint:s(d),endPoint:s(u)})},0)},a=S.useCallback(()=>{const d=$.getState(),u=q.DEFAULT_NODE_WIDTH,g=q.DEFAULT_NODE_HEIGHT,p=40,f=e.x+(e.width??0)/3-u/2,h=Xs(e.id,"left"),m=h!==null?h+p:e.y+(e.height??0)+p,x=me.buildTextNodeV2({content:"",linkedSourceNodeId:e.id});x.x=f,x.y=m,x.width=u,x.height=g,x.tags=[o("left")],d.addNode(x,void 0,{dontOverlap:!0}),d.setNodeToFocusId(x.id),r(e,x)},[e]),l=S.useCallback(()=>{const d=$.getState(),u=q.DEFAULT_NODE_WIDTH,g=q.DEFAULT_NODE_HEIGHT,p=40,f=e.x+2*(e.width??0)/3-u/2,h=Xs(e.id,"right"),m=h!==null?h+p:e.y+(e.height??0)+p,x=me.buildTextNodeV2({content:"",linkedSourceNodeId:e.id});x.x=f,x.y=m,x.width=u,x.height=g,x.tags=[o("right")],d.addNode(x,void 0,{dontOverlap:!0}),d.setNodeToFocusId(x.id),r(e,x)},[e]);return!t||n||!(e.content&&e.content.trim().length>0)?null:i.jsxs(i.Fragment,{children:[i.jsx(X,{"data-test":"create-left-child-node-button",size:"icon",variant:"ghost",className:"create-left-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:d=>{d.stopPropagation(),d.preventDefault(),a()},title:"Create linked node on the left",children:"+"}),i.jsx(X,{"data-test":"create-right-child-node-button",size:"icon",variant:"ghost",className:"create-right-child-node absolute z-[9999] h-6 w-6 text-muted-foreground hover:text-foreground pointer-events-auto",style:{left:`${2*(e.width||0)/3}px`,top:`${(e.height||0)+8}px`,transform:"translateX(-50%)"},onPointerDown:d=>{d.stopPropagation(),d.preventDefault(),l()},title:"Create linked node on the right",children:"+"})]})},to=[];function Gn(){const e=B(l=>{var c;return((c=l.projectCanvas.getActive())==null?void 0:c.coreState.selectedNodes)??to}),t=B(l=>l.updateNode),n=S.useRef(to);e.length===0?n.current=to:(e.length!==n.current.length||!e.every((l,c)=>{var d;return l.id===((d=n.current[c])==null?void 0:d.id)}))&&(n.current=e);const o=S.useCallback(l=>{const c=l||n.current;if(c.length===0)return;let d;const u=document.querySelector("textarea[data-node-textarea]"),g=document.querySelector(".markdown-textarea[data-node-textarea]"),p=u||g;if(p){const m=window.getComputedStyle(p).lineHeight;if(m&&m!=="normal"){const x=parseFloat(m);isNaN(x)||(d=x)}}const f=c.map(h=>{if(!(h!=null&&h.id)||!h.content||typeof h.content!="string")return null;const{width:m,height:x}=Vn(h.content,d);return m>0?{id:h.id,payload:{...h,width:m,height:x}}:null}).filter(h=>h!==null);f.length>0&&f.forEach(h=>{t(h.id,{width:h.payload.width,height:h.payload.height,options:{...h.payload.options,lockSize:!1}})})},[t]),s=S.useCallback((l,c)=>{const u=(c||n.current).map(g=>{if(!(g!=null&&g.id))return null;const p=g.content||"",h=Bt(p,{containerWidth:l})+q.NODE_Y_PADDING*2;return{id:g.id,payload:{...g,width:l,height:h,options:{...g.options,lockSize:!0}}}}).filter(g=>g!==null);u.length>0&&u.forEach(g=>{t(g.id,{width:g.payload.width,height:g.payload.height,options:g.payload.options})})},[t]),r=S.useRef({fitNodeDimensions:null,setFixedWidth:null,stableSelectedNodes:null});return r.current={fitNodeDimensions:o,setFixedWidth:s,stableSelectedNodes:n.current},S.useMemo(()=>({fitNodeDimensions:o,setFixedWidth:s,selectedNodes:n.current}),[o,s])}const Ou="type here...",Fu=24,$u=[],Lu=({node:e})=>{const t=S.useRef({}),n=S.useRef(null),o=S.useRef(null),[s,r]=S.useState(!1),[a,l]=S.useState(e.content||""),c=Mn();S.useEffect(()=>{if(n.current){const P=n.current.getTextArea();P&&(o.current=P)}},[n.current]);const d=B(P=>P.updateNodeContent),u=B(P=>P.updateNode),g=B(P=>P.setMode),p=B(P=>P.uiState.nodeToFocusId),f=B(P=>P.uiState.mode),h=B(P=>P.uiState.writeSubMode),m=B(P=>P.uiState.dragInfo);m==null||m.draggedNodeId,e.id;const x=B(P=>{var O;return((O=P.projectCanvas.getActive())==null?void 0:O.coreState.selectedNodes)??$u}),w=S.useMemo(()=>!!x.some(P=>P.id===e.id),[x,e.id]),b=w&&p===e.id;t.current={updateNodeContent:d,updateNode:u,setMode:g,nodeToFocusId:p,mode:f,writeSubMode:h,dragInfo:m,selectedNodes:x};const{fitNodeDimensions:N}=Gn(),j=P=>{const O=P.target.value;l(O),d(e.id,O)},C=S.useCallback(P=>{var le;P.preventDefault();const O=P.clipboardData.getData("text"),W=(le=n.current)==null?void 0:le.getTextArea();if(!W)return;const z=W.selectionStart,U=W.selectionEnd,V=W.value,ee=V.substring(0,z)+O+V.substring(U);W.value=ee;const te=z+O.length;W.setSelectionRange(te,te),l(ee),d(e.id,ee),setTimeout(()=>{const pe=$.getState().getNodeById(e.id);pe&&N([pe])},10)},[e.id,d,N]),I=S.useCallback(()=>{setTimeout(()=>{const O=$.getState().getNodeById(e.id);O&&N([O])},10)},[e.id,N]);Ru({textareaRef:o,node:e,updateNode:u,enabled:s,defaultColor:void 0});const A=S.useCallback(P=>{r(P),u(e.id,{isEditing:P})},[u,e.id]),T=S.useCallback(()=>{var P;d(e.id,a),A(!1),u(e.id,{isEditing:!1}),(P=window.getSelection())==null||P.removeAllRanges()},[e.id,e.width,e.height,d,a,u]),E=S.useCallback(P=>{e.isEditing&&P.shiftKey},[e.isEditing]),y=S.useCallback(()=>{var O;if(!e.isEditing)return;const P=(O=n.current)==null?void 0:O.getTextArea();P&&P.focus()},[e.isEditing]),v=S.useCallback(P=>{if(!P)return"";if("value"in P&&typeof P.value=="string")return P.value;const O=U=>{let V="";for(const ee of U.childNodes)if(ee.nodeType===Node.TEXT_NODE)V+=ee.textContent||"";else if(ee.nodeType===Node.ELEMENT_NODE){const te=ee;if(te.tagName==="BR")V+=`
`;else if(te.tagName==="DIV"||te.tagName==="P"){const le=O(te);V+=le+`
`}else V+=O(te)}return V};return O(P).replace(/\n+$/,"")},[]),k=S.useCallback(P=>{var ye,pe,Ie,be,Re,$e;if(P.key==="Escape"){T(),A(!1),g(H.SELECT),(pe=(ye=n.current)==null?void 0:ye.getTextArea())==null||pe.blur();return}if(P.key==="Enter"&&P.ctrlKey){const F=(Ie=n.current)==null?void 0:Ie.getTextArea(),Y=v(F);d(e.id,Y);return}const O=(be=n.current)==null?void 0:be.getTextArea(),W=v(O),z=te(W),U=le(W,P.key==="Enter"),V=(Re=e.options)!=null&&Re.lockSize?e.width:z,ee=($e=e.options)!=null&&$e.lockSize?e.height:U;u(e.id,{width:V,height:ee,isEditing:!0});function te(F,Y=q.DEFAULT_NODE_WIDTH,G=Hr.textNodeXPadding){const de=F.split(/\n|&nbsp;/).map(he=>vr(he)).reduce((he,we)=>Math.max(he,we),0)+G,ne=Math.max(de,Y);return Math.max(ne,e.width??0)}function le(F,Y=!1){var ne;let se=F.split(/\n|&nbsp;/).length,ie=q.DEFAULT_NODE_HEIGHT;const ce=(ne=n.current)==null?void 0:ne.getTextArea();let de=Fu;if(ce){const he=window.getComputedStyle(ce).lineHeight;if(he&&he!=="normal"){const we=parseFloat(he);isNaN(we)||(de=we)}}return se===1&&!Y?(ie=Math.max(ie,e.height??0),ie):(Y&&(se+=1),ie+=(se-1)*de,ie=Math.max(ie,e.height??0),ie)}},[T,d,u,e.id,e.width,v]);S.useEffect(()=>{p||A(!1)},[p]),S.useEffect(()=>{!w&&s&&A(!1)},[w,s,A]),S.useEffect(()=>{var O,W;if(!b)return;A(!0),l(e.content||"");const P=(O=n.current)==null?void 0:O.getTextArea();if(P){P.readOnly=!1,P.focus({preventScroll:!0}),P.click();const z=((W=P.value)==null?void 0:W.length)??0;P.selectionStart=P.selectionEnd=z}window.setTimeout(()=>{var V,ee;const z=(V=n.current)==null?void 0:V.getTextArea();if(z&&document.activeElement!==z){z.readOnly=!1,z.focus({preventScroll:!0}),z.click();const te=((ee=z.value)==null?void 0:ee.length)??0;z.selectionStart=z.selectionEnd=te}},50)},[b,e.content]),S.useEffect(()=>{var O;const P=(O=n.current)==null?void 0:O.getTextArea();if(P)return P.addEventListener("blur",T),()=>{P.removeEventListener("blur",T)}},[T,e.id]),S.useEffect(()=>{l(e.content||"")},[e.content]);const R=S.useCallback(()=>{const O=$.getState().TextModeHandler;if(O){const W=new O;W&&typeof W.onCopy=="function"&&W.onCopy()}},[]),M=S.useCallback(()=>{var O,W;const P=new KeyboardEvent("keydown",{key:"h",ctrlKey:!0,bubbles:!0});(W=(O=n.current)==null?void 0:O.getTextArea())==null||W.dispatchEvent(P)},[]),D=S.useCallback(()=>{var U;const P=(U=n.current)==null?void 0:U.getTextArea();if(!P)return;const O=P.selectionStart,W=P.selectionEnd,z=a.substring(0,O)+a.substring(W);l(z),d(e.id,z),setTimeout(()=>{var V,ee;(ee=(V=n.current)==null?void 0:V.getTextArea())==null||ee.setSelectionRange(O,O)},0)},[a,e.id,d]),_=S.useCallback(()=>{var z;if(!((z=n.current)==null?void 0:z.getTextArea()))return;const O=new Xe,W=new KeyboardEvent("keydown",{key:"!"});O.highlightAndCreateNode(W)},[]),L=S.useCallback(async()=>{var F,Y;const P=(F=n.current)==null?void 0:F.getTextArea();if(!P)return;const O=P.selectionStart,W=P.selectionEnd,U=P.value.substring(O,W);if(!U.trim())return;const V=$.getState(),ee="rgb(198, 183, 0)",te=await Wa(U.trim(),"English");let le;if(O!==W){const G=e.highlights||[],se=G.find(ie=>ie.start===O&&ie.end===W);if(se)le=se.id;else{le=Math.random().toString(36).slice(2,10);const ie={id:le,start:O,end:W,color:ee,createdAt:Date.now()},ce=[...G,ie];V.updateNode(e.id,{highlights:ce})}}const ye=`${U}

${te.definition}`,pe=me.buildTextNodeV2({content:ye,linkedHighlightId:le,linkedSourceNodeId:e.id}),Ie=Br(P,O,W),be=(Y=V.projectCanvas.getActive())==null?void 0:Y.viewState,Re=(be==null?void 0:be.scale)??1;let $e=e.y;if(Ie){const G=Ie.top/Re;$e=e.y+G}if(is(pe,{...e,y:$e,id:e.id}),le){const G=V.getNodeById(e.id),ie=((G==null?void 0:G.highlights)||[]).map(ce=>ce.id===le?{...ce,linkedNodeId:pe.id}:ce);V.updateNode(e.id,{highlights:ie})}},[e]);return i.jsxs(i.Fragment,{children:[e.linkedHighlightId&&e.linkedSourceNodeId&&w&&x.length===1&&i.jsx("div",{className:"absolute z-50 cursor-pointer","data-test":`text-node-linked-highlight-indicator-${e.id}`,style:{left:`${(e.width||0)+8}px`,top:"4px"},onClick:P=>{var ee;P.stopPropagation();const z=(((ee=$.getState().projectCanvas.getActive())==null?void 0:ee.coreState.nodes)??[]).find(te=>te.id===e.linkedSourceNodeId);if(!z)return;const U=(z.highlights||[]).find(te=>te.id===e.linkedHighlightId);let V;U&&typeof z.content=="string"&&(V=Mu(z.content,U,4,24)),cs(z,{duration:400,highlightYOffset:V})},title:"Navigate to source highlight",children:i.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18","data-test":`text-node-linked-highlight-icon-${e.id}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-yellow-600 hover:text-yellow-700",children:[i.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),i.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}),i.jsx(_u,{node:e,isEditing:!!s,preventEdit:!1}),i.jsxs("div",{className:"relative w-full h-full","data-text-position-container":"true","data-test":`text-node-position-container-${e.id}`,children:[!s&&w&&x.length<=1&&c&&i.jsx("div",{className:"absolute inset-0 z-20 cursor-pointer",onClick:y,onTouchEnd:P=>{P.preventDefault(),y()},"data-text-node-click-overlay":"true","data-test":`text-node-mobile-click-overlay-${e.id}`}),s&&i.jsx(Pu,{textareaRef:o,onCopy:R,onHighlight:M,onDelete:D,onHighlightAndCreateNode:_,onDefine:L,"data-test":`text-node-selection-popover-${e.id}`}),i.jsx(Eu,{text:a,highlights:e.highlights,"data-test":`text-node-highlight-renderer-${e.id}`}),i.jsx(Ci,{ref:n,value:a,onChange:j,onPaste:C,onBlur:T,onKeyDown:k,onMouseDown:E,onClick:y,placeholder:Ou,readOnly:!s,showFilePicker:!1,showAudioButton:s,audioButtonVariant:"muted",autoStartAudioRecording:b&&f===H.WRITE&&h===Le.AUDIO,onAudioTranscriptionComplete:I,useMarkdown:!0,showBuiltInPopover:!1,"data-test":`text-node-textarea-${e.id}`,className:ae("relative","m-0 p-1 w-full h-full","min-h-0","resize-none","border",e.className,{"overflow-hidden":!c||!s,"overflow-y-auto":c&&s,"pointer-events-none":!s&&!w||x.length>1,"cursor-text":s,"cursor-default":!s,"select-text":s,"text-muted-foreground":!a&&!s}),style:{zIndex:qe.nodeTextarea}})]})]})},no={left:i.jsx(Rr,{className:"h-4 w-4"}),center:i.jsx(Qi,{className:"h-4 w-4"}),right:i.jsx(kr,{className:"h-4 w-4"})},Hu=e=>{const{className:t,value:n,defaultValue:o=Z.nodeStyles.textAlign,onAlignmentChange:s}=e,[r,a]=S.useState(n??o);S.useEffect(()=>{n!==void 0&&a(n)},[n]);const l=c=>{const d=c;s==null||s(d),a(d)};return i.jsx("div",{id:"UiAlignmentSelector",className:`${t}`,children:i.jsxs(Pn,{value:r,onValueChange:l,children:[i.jsxs(_n,{className:"[&&]:h-8 w-[80px] py-0 focus:ring-0 border-0 [&&]:bg-secondary",children:["T",i.jsx(On,{placeholder:"Select alignment",children:no[r]})]}),i.jsx(Fn,{children:Object.keys(no).map(c=>i.jsx($n,{value:c,children:i.jsxs("div",{className:"flex items-center gap-2",children:[no[c]," ",i.jsx("span",{className:"capitalize",children:c})]})},c))})]})})},Wu=()=>{var r;const e=$.getState(),t=((r=e.projectCanvas.getActive())==null?void 0:r.coreState.selectedNodes)??[],n=e.updateNodes,o=S.useMemo(()=>{var a;if(t.length===1)return(a=t[0].styles)==null?void 0:a.textAlign},[t]);return{handleAlignmentChange:S.useCallback(a=>{if(t.length===0)return;const l=t.map(c=>({...c,id:c.id,styles:{...c.styles,textAlign:a}}));n(l)},[t,n]),currentAlignment:o}},Zt=S.forwardRef((e,t)=>{const{className:n,children:o}=e;return i.jsx(X,{ref:t,id:"ConfigurationButton",variant:"secondary",size:"icon","aria-label":"Configuration button",className:`h-6 w-6 p-0.5 rounded hover:bg-secondary/80 flex-shrink-0 flex items-center justify-center ${n||null}`,...e,children:o})});Zt.displayName="ConfigurationButton";function zu(e,t,n=!1){let o=null;const s=function(...r){const a=this,l=()=>{o=null,n||e.apply(a,r)},c=n&&!o;o!==null&&clearTimeout(o),o=setTimeout(l,t),c&&e.apply(a,r)};return s.cancel=()=>{o!==null&&(clearTimeout(o),o=null)},s}const Bu=Z.text.debounceInput,Vu=e=>{const{className:t,content:n,onValueChange:o}=e,[s,r]=S.useState(n),a=S.useCallback(zu(c=>{o==null||o(c)},Bu),[o]),l=c=>{const d=c.target.value;r(d),a(d)};return i.jsx(za,{id:"CanvasTextEditor",className:ae("h-[90%]","bg-background",t),style:{fontSize:Z.text.fontSize},value:s,onChange:l,"data-test":"canvas-text-editor-textarea"})},Xr=e=>{var u;const{className:t}=e,n=$.getState(),o=n.projectCanvas.getActive(),s=o==null?void 0:o.coreState,r=n.updateNodeSubContent,l=((s==null?void 0:s.selectedNodes)??[])[0],c=(u=l==null?void 0:l.content)==null?void 0:u.toString().slice(0,30),d=S.useCallback(g=>{l&&r(l.id,g)},[l,r]);return i.jsxs(Sr,{children:[i.jsx(yr,{asChild:!0,children:i.jsx(Zt,{id:"CanvasTextEditorButton",className:t,tooltip:"Open Text Editor",variant:"ghost","data-test":"canvas-text-editor-button",children:i.jsx(ea,{})})}),i.jsxs(Nr,{id:"canvas-text-editor-dialog",className:"sm:max-w-[70vw] h-[80vh] bg-secondary",style:{display:"unset"},"aria-describedby":"Text editor dialog",children:[i.jsx(br,{children:i.jsx(Cr,{children:c})}),i.jsx(Vu,{content:l==null?void 0:l.subContent,onValueChange:d})]})]})},Ks=15,Uu=["?","!"],Gu=(e=!1)=>{const t=$.getState(),n=t.projectCanvas.getActive(),o=(n==null?void 0:n.coreState.selectedNodes)??[],s=t.addNode,r=t.deleteSelectedNodes,a=t.setSelectedNodes,l=t.updateNodes,c=t.arrow.add,{fitNodeDimensions:d}=Gn(),u=S.useCallback(w=>{if(o.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const b=o[0];if(!b.content||typeof b.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}const N=w==="paragraph"?/(\n\n)/:w==="line"?/(\n)/:w==="comma"?/(,)/:w==="period"?/(\.)/:new RegExp(`([${Uu.join("")}])`),j=b.content.split(N),C=[];for(let k=0;k<j.length;k+=2){const R=j[k],M=j[k+1];(R||M)&&C.push((R||"")+(M||""))}if(C.length===0){console.warn("useNodeSplitter: No segments found after split.");return}if(C.length===1&&C[0]===b.content){console.warn(`useNodeSplitter: No ${w==="paragraph"?"double":w==="line"?"single":w==="comma"?"comma":w==="period"?"period":"custom character"} found to split content. Original node not modified.`);return}const I=b.x,A=b.y;b.width;const T=b.id;e||r();let E=A,y=0;const v=[];C.forEach((k,R)=>{const M=w==="comma"||w==="paragraph"||w==="period"||w==="custom"?k.trim():k;if((w==="paragraph"||w==="comma"||w==="period"||w==="custom")&&M===""&&C.length>1)return;const D=Math.min(wn(M),Z.nodeOptions.maxNodeWidth)+q.NODE_X_PADDING*2,_=st(M,D)+q.NODE_Y_PADDING*2;let L;if(R===0?L=A:L=E+y+Ks,e&&R===0){l([{id:T,content:M,width:D,height:_}]),E=L,y=_+q.nodeSpacing;return}const O={...me.buildTextNodeV2({...b,id:T+"-split-"+R,x:I,y:L,width:D,height:_,content:M})};s(O),v.push(O),e&&c({id:re(10),startNodeId:T,endNodeId:O.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),E=L,y=_+q.nodeSpacing}),v.length>0&&a(v)},[o,s,r,a,d,e,l,c]),g=S.useCallback(()=>{u("paragraph")},[u]),p=S.useCallback(()=>{u("line")},[u]),f=S.useCallback(()=>{u("comma")},[u]),h=S.useCallback(()=>{u("period")},[u]),m=S.useCallback(()=>{u("custom")},[u]),x=S.useCallback(w=>{if(o.length!==1){console.warn("useNodeSplitter: Exactly one node must be selected.");return}const b=o[0];if(!b.content||typeof b.content!="string"){console.warn("useNodeSplitter: Selected node has no content to split.");return}let N;try{N=new RegExp(`(${w})`,"g")}catch(k){console.error("useNodeSplitter: Invalid regex pattern",k);return}const j=b.content.split(N),C=[];for(let k=0;k<j.length;k+=2){const R=j[k]||"",M=j[k+1]||"",D=(R+M).trim();D&&C.push(D)}if(C.length===0){console.warn("useNodeSplitter: No segments found with regex pattern.");return}if(C.length===1&&C[0]===b.content.trim()){console.warn("useNodeSplitter: Regex pattern did not match content.");return}const I=b.x,A=b.y,T=b.id;e||r();let E=A,y=0;const v=[];C.forEach((k,R)=>{if(k==="")return;const M=Math.min(wn(k),Z.nodeOptions.maxNodeWidth)+q.NODE_X_PADDING*2,D=st(k,M)+q.NODE_Y_PADDING*2;let _;if(R===0?_=A:_=E+y+Ks,e&&R===0){l([{id:T,content:k,width:M,height:D}]),E=_,y=D+q.nodeSpacing;return}const P={...me.buildTextNodeV2({...b,id:T+"-split-"+R,x:I,y:_,width:M,height:D,content:k})};s(P),v.push(P),e&&c({id:re(10),startNodeId:T,endNodeId:P.id,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}),E=_,y=D+q.nodeSpacing}),v.length>0&&a(v)},[o,s,r,a,e,l,c]);return{splitNodeContentByParagraph:g,splitNodeContentByLine:p,splitNodeContentByComma:f,splitNodeContentByPeriod:h,splitNodeContentByCustomCharacter:m,splitNodeContentByRegexKeep:x}},qs="canvas-split-regex-history",Zs="canvas-split-before-enabled",Yu=10,Xu=({onSplit:e,selectedNodeContent:t=""})=>{const n=S.useCallback(()=>{try{const m=localStorage.getItem(qs);return m?JSON.parse(m):[]}catch{return[]}},[]),[o,s]=S.useState(()=>n()[0]||""),[r,a]=S.useState(()=>{try{return localStorage.getItem(Zs)==="true"}catch{return!1}}),[l,c]=S.useState(null),[d,u]=S.useState(0);S.useEffect(()=>{try{localStorage.setItem(Zs,String(r))}catch(m){console.warn("Failed to save split before preference",m)}},[r]);const g=S.useCallback((m,x)=>m?x?`\\n(?=${m})`:m:"",[]),p=S.useCallback(m=>{if(!m)return;const w=n().filter(N=>N!==m),b=[m,...w].slice(0,Yu);try{localStorage.setItem(qs,JSON.stringify(b))}catch(N){console.warn("Failed to save regex history",N)}},[n]);S.useEffect(()=>{if(!o){c(null),u(0);return}try{const m=g(o,r),x=new RegExp(`(${m})`,"g");if(c(!0),t){const w=t.match(x);u(w?w.length:0)}else u(0)}catch{c(!1),u(0)}},[o,t,r,g]);const f=S.useCallback(()=>{if(!o||!l)return;p(o);const m=g(o,r);e(m)},[o,l,e,p,r,g]),h=S.useCallback(m=>{m.key==="Enter"&&(m.preventDefault(),m.stopPropagation(),f())},[f]);return i.jsxs("div",{className:"regex-split-item px-3 py-2 space-y-2",onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"none"},children:[i.jsx("div",{className:"text-sm font-medium text-foreground",children:"Split and keep by regex:"}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("div",{className:"relative flex-1",children:[i.jsx("input",{type:"text",value:o,onChange:m=>s(m.target.value),onKeyDown:h,placeholder:"Art \\d+",className:ve("w-full px-2 py-1 text-sm border rounded","bg-background text-foreground","focus:outline-none focus:ring-2 focus:ring-primary",l===!1&&"border-destructive focus:ring-destructive",l===!0&&"border-green-500 focus:ring-green-500"),onPointerDown:m=>{m.stopPropagation()},style:{touchAction:"auto"},"data-test":"regex-split-pattern-input"}),i.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none",children:[l===!0&&i.jsx(qo,{className:"h-2.5 w-2.5 text-green-500"}),l===!1&&i.jsx(Nn,{className:"h-2.5 w-2.5 text-destructive"})]})]}),i.jsx("button",{onPointerDown:m=>{m.stopPropagation(),f()},disabled:!l,className:ve("p-1.5 rounded transition-colors",l?"hover:bg-accent text-accent-foreground cursor-pointer":"opacity-50 cursor-not-allowed"),title:"Execute split",style:{touchAction:"none"},"data-test":"regex-split-execute-button",children:i.jsx(Ln,{className:"h-2.5 w-2.5"})})]}),i.jsxs("div",{children:[i.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:r,onChange:m=>a(m.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:m=>{m.stopPropagation()},"data-test":"regex-split-before-checkbox"}),i.jsx("span",{className:"text-muted-foreground",children:"Split before pattern"})]}),r&&o&&i.jsxs("div",{className:"text-xs text-muted-foreground/70 font-mono ml-4 mt-0.5",children:["(\\n(?=",o,"))"]})]}),l&&d>0&&i.jsxs("div",{className:"text-xs text-muted-foreground",children:[d," match",d!==1?"es":""," found"]}),l===!1&&o&&i.jsx("div",{className:"text-xs text-destructive",children:"Invalid regex pattern"})]})},Ku=e=>{const{className:t}=e,n=B(x=>{var w;return((w=x.preferences)==null?void 0:w.keepArrowsOnSplit)??!0}),o=B(x=>x.setKeepArrowsOnSplit),r=$.getState().projectCanvas.getActive(),a=(r==null?void 0:r.coreState.selectedNodes)??[],l=a.length===1&&typeof a[0].content=="string"?a[0].content:"",{splitNodeContentByParagraph:c,splitNodeContentByLine:d,splitNodeContentByComma:u,splitNodeContentByPeriod:g,splitNodeContentByCustomCharacter:p,splitNodeContentByRegexKeep:f}=Gu(n),h={icon:i.jsx(js,{}),onClick:c,label:"Split content by paragraph",text:"Split"},m=[{label:"Split by paragraph",icon:i.jsx(js,{className:"h-2.5 w-2.5"}),onClick:c},{label:"Split by line",icon:i.jsx(Er,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Split by comma",icon:i.jsx(ta,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Split by period",icon:i.jsx(na,{className:"h-2.5 w-2.5"}),onClick:g},{label:"Split by special character",icon:i.jsx(yn,{className:"h-2.5 w-2.5"}),onClick:p},{label:"Keep and create arrows",icon:null,customRender:()=>i.jsx("div",{className:"px-3 py-2",onPointerDown:x=>{x.stopPropagation()},children:i.jsxs("label",{className:"flex items-center gap-1.5 text-xs cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:n,onChange:x=>o(x.target.checked),className:"w-3 h-3 cursor-pointer",onPointerDown:x=>{x.stopPropagation()},"data-test":"toolbar-split-keep-arrows-checkbox"}),i.jsx("span",{className:"text-muted-foreground",children:"Keep and create arrows"})]})})},{label:"Split and keep by regex",icon:i.jsx(oa,{className:"h-2.5 w-2.5"}),customRender:()=>i.jsx(Xu,{onSplit:f,selectedNodeContent:l})}];return i.jsx("div",{id:"CanvasTextSplitButtonContainer",className:ve("flex items-center",t),"data-test":"toolbar-split-button",children:i.jsx(ze,{mainAction:h,dropdownActions:m,variant:"outline",size:"compact",persistenceKey:"toolbar-split-button"})})};function qu(e){return!e||e.trim()===""?0:e.trim().split(/\s+/).filter(t=>t.length>0).length}const Zu=[".","!","?",":",";"],Ju=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","Ph.D","M.D","B.A","M.A","B.S","M.S","Inc","Ltd","Co","Corp","etc","vs","e.g","i.e","a.m","p.m","St","Ave","Blvd","Rd","vol","no"];function Qu(e,t){if(t<=0||t>=e.length-1)return!1;let n=t-1;for(;n>=0&&/[a-zA-Z.]/.test(e[n]);)n--;n++;const o=e.substring(n,t);return!!(Ju.includes(o)||o.length===1&&/[A-Z]/.test(o)||t>1&&e[t-2]===".")}function ef(e,t){const n=[".","!","?",","];let o=e.length;for(const s of n){const r=e.indexOf(s,t);r!==-1&&r<o&&(o=r)}return o}function tf(e,t){const n=[];for(let s=0;s<e.length;s++)e[s]===","&&n.push(s);const o=[];for(let s=0;s<n.length;s++){const r=n[s],a=ef(e,r+1),l=e.substring(r+1,a).trim();qu(l)>=t&&o.push(r)}return o}function Js(e){if(!e)return e;let t="",n=0;for(;n<e.length;){const o=e[n];if(Zu.includes(o)){if(o==="."&&Qu(e,n)){t+=o,n++;continue}for(t+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(t+=`
`)}else t+=o,n++}return t}function Qs(e,t=3){if(!e)return e;const n=tf(e,t);if(n.length===0)return e;let o=e;for(let s=n.length-1;s>=0;s--){const r=n[s];let a=r+1;for(;a<o.length&&o[a]===" ";)a++;o=o.substring(0,r+1)+`
`+o.substring(a)}return o}const Kr=["&",";"];function er(e){if(!e)return e;let t="",n=0;for(;n<e.length;){const o=e[n];if(Kr.includes(o)){for(t+=o,n++;n<e.length&&/\s/.test(e[n]);)n++;n<e.length&&(t+=`
`)}else t+=o,n++}return t}const nf=()=>{const e=$.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],o=e.updateNodeContent,s=S.useCallback((d,u=3)=>{if(n.length===0){console.warn("useNodeInsideSplitter: No nodes selected.");return}n.forEach(g=>{if(!g.content||typeof g.content!="string"){console.warn(`useNodeInsideSplitter: Node ${g.id} has no content to split.`);return}let p;if(d==="sentence")p=Js(g.content);else if(d==="smartComma")p=Qs(g.content,u);else if(d==="smartCharacter")p=er(g.content);else if(d==="all")p=Js(g.content),p=Qs(p,u),p=er(p);else{console.warn(`useNodeInsideSplitter: Unknown mode "${d}"`);return}if(p===g.content){console.warn(`useNodeInsideSplitter: No ${d==="sentence"?"sentence endings":"qualifying commas"} found in node ${g.id}. Content not modified.`);return}o(g.id,p);const f=e.getSegmentedButtonAction("canvas-fit-width");let h=null;if(f){const b=f.match(/Set width to (\d+)px/);b&&(h=parseInt(b[1],10))}let m,x,w;if(h)x=Bt(p,{containerWidth:h})+q.NODE_Y_PADDING*2,m=h,w=!0;else{let b;const N=document.querySelector("textarea[data-node-textarea]");if(N){const I=window.getComputedStyle(N).lineHeight;if(I&&I!=="normal"){const A=parseFloat(I);isNaN(A)||(b=A)}}const j=Vn(p,b);m=j.width,x=j.height,w=!1}e.updateNode(g.id,{content:p,width:m,height:x,options:{...g.options,lockSize:w}})})},[n,o,e]),r=S.useCallback(()=>{s("sentence")},[s]),a=S.useCallback((d=3)=>{s("smartComma",d)},[s]),l=S.useCallback(()=>{s("smartCharacter")},[s]),c=S.useCallback((d=3)=>{s("all",d)},[s]);return{splitInsideBySentence:r,splitInsideBySmartComma:a,splitInsideBySmartCharacter:l,splitInsideByAll:c}},of=({onSplit:e})=>{const[t,n]=S.useState(3);return i.jsxs("div",{className:"px-2 py-1.5 space-y-2","data-test":"toolbar-split-inside-text-button",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(Ar,{className:"h-2.5 w-2.5 flex-shrink-0"}),i.jsx("span",{className:"text-xs",children:"Split by smart comma"})]}),i.jsxs("div",{className:"flex items-center gap-2 pl-4",children:[i.jsx("label",{className:"text-[10px] text-muted-foreground whitespace-nowrap",children:"Min words:"}),i.jsx(it,{type:"number",min:"1",max:"20",value:t,onChange:o=>n(Math.max(1,parseInt(o.target.value)||3)),className:"h-6 w-16 text-xs",onClick:o=>o.stopPropagation(),"data-test":"split-inside-min-words-input"}),i.jsx(X,{size:"sm",variant:"secondary",className:"h-6 text-xs px-2",onClick:o=>{o.stopPropagation(),e(t)},"data-test":"split-inside-smart-comma-button",children:"Split"})]})]})},sf=({onSplit:e})=>i.jsx(ft,{delayDuration:300,children:i.jsxs(gt,{children:[i.jsx(pt,{asChild:!0,children:i.jsxs(X,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),e()},className:"w-full justify-start text-left font-normal",children:[i.jsx(Tr,{className:"h-2.5 w-2.5 mr-2"}),"Split by smart character"]})}),i.jsx(ht,{side:"right",children:i.jsxs("p",{className:"text-xs",children:["Split after: ",Kr.map(t=>`'${t}'`).join(", ")]})})]})}),rf=e=>{const{className:t}=e,{splitInsideBySentence:n,splitInsideBySmartComma:o,splitInsideBySmartCharacter:s,splitInsideByAll:r}=nf(),a={icon:i.jsx(ia,{}),onClick:n,label:"Split inside by sentence",text:"Split Inside"},l=[{label:"Split inside by sentence",icon:i.jsx(sa,{className:"h-2.5 w-2.5"}),onClick:n},{label:"Split inside by smart comma",icon:i.jsx(Ar,{className:"h-2.5 w-2.5"}),customRender:()=>i.jsx(of,{onSplit:o})},{label:"Split by smart character",icon:i.jsx(Tr,{className:"h-2.5 w-2.5"}),customRender:()=>i.jsx(sf,{onSplit:s})},{label:"Split by all",icon:i.jsx(ra,{className:"h-2.5 w-2.5"}),onClick:()=>r(3)}];return i.jsx("div",{id:"ToolbarSplitInsideTextButtonContainer",className:ve("flex items-center",t),children:i.jsx(ze,{mainAction:a,dropdownActions:l,variant:"outline",size:"compact"})})},oo=e=>{let t="";if(typeof e.content=="string"&&(t+=e.content+`
`),e.subContent){if(typeof e.subContent=="string")t+=e.subContent+`
`;else if(typeof e.subContent=="object"&&"lines"in e.subContent){const{lines:n}=e.subContent;typeof n=="string"?t+=n+`
`:Array.isArray(n)&&n.forEach(o=>{typeof o=="string"?t+=o+`
`:o&&Array.isArray(o.words)&&(t+=o.words.join(" ")+`
`)})}}return t.trim()},af=e=>{const{className:t,variant:n}=e,o=$.getState(),s=o.projectCanvas.getActive(),r=(s==null?void 0:s.coreState.selectedNodes)??[],a=o.addNode,l=o.setNodeToFocusId,c=async(m,x)=>{if(r.length===0){console.log(`AI ${m}: No nodes selected.`);return}let w=r.map(oo).join(`

---

`);if(x&&(w=`${x}:

${w}`),!w.trim()){console.log(`AI ${m}: Selected nodes have no text content.`);return}console.log(`AI ${m} - Prompt:`,w);try{const b=await ji.generateCompletion(w,void 0,{stream:!1});console.log(`AI ${m} - Response:`,b);const N=b==null?void 0:b.response;if(typeof N=="string"&&N.trim()){let j={x:100,y:100};if(r.length>0){const I=r[0];j={x:I.x,y:I.y+(I.height??q.DEFAULT_NODE_HEIGHT)+q.nodeSpacing}}const C=me.buildTextNode(j,N);a(C),l(C.id),console.log(`AI ${m}: Created new node ${C.id} with AI response.`)}else(typeof N!="string"||!N.trim())&&console.log(`AI ${m}: Received empty or invalid response from AI.`)}catch(b){console.error(`AI ${m} - Error:`,b)}},d=()=>{c("Generate Text","Continue writing based on the following text")},u=()=>{c("Summarize Selection","Summarize the following text")},g=()=>{c("Ask Question","Based on the following, answer any implied questions or provide information")},p=async()=>{if(r.length===0){console.log("Translate to VN: No nodes selected.");return}const m=r.map(oo).join(`

`);if(!m.trim()){console.log("Translate to VN: Selected nodes have no text content.");return}console.log("Translate to VN - Input:",m);try{const x=await Es(m,"English","Vietnamese");console.log("Translate to VN - Response:",x);const w=x.output;if(w!=null&&w.trim()){let b={x:100,y:100};if(r.length>0){const j=r[0];b={x:j.x,y:j.y+(j.height??q.DEFAULT_NODE_HEIGHT)+q.nodeSpacing}}const N=me.buildTextNode(b,w);a(N),l(N.id),console.log(`Translate to VN: Created new node ${N.id} with Vietnamese translation.`)}else console.log("Translate to VN: Received empty translation.")}catch(x){console.error("Translate to VN - Error:",x)}},f=async()=>{if(r.length===0){console.log("Translate to EN: No nodes selected.");return}const m=r.map(oo).join(`

`);if(!m.trim()){console.log("Translate to EN: Selected nodes have no text content.");return}console.log("Translate to EN - Input:",m);try{const x=await Es(m,"Vietnamese","English");console.log("Translate to EN - Response:",x);const w=x.output;if(w!=null&&w.trim()){let b={x:100,y:100};if(r.length>0){const j=r[0];b={x:j.x,y:j.y+(j.height??q.DEFAULT_NODE_HEIGHT)+q.nodeSpacing}}const N=me.buildTextNode(b,w);a(N),l(N.id),console.log(`Translate to EN: Created new node ${N.id} with English translation.`)}else console.log("Translate to EN: Received empty translation.")}catch(x){console.error("Translate to EN - Error:",x)}},h=[{label:"Generate Text",icon:i.jsx(yn,{className:"h-2.5 w-2.5"}),onClick:d},{label:"Summarize",icon:i.jsx(aa,{className:"h-2.5 w-2.5"}),onClick:u},{label:"Ask Question",icon:i.jsx(la,{className:"h-2.5 w-2.5"}),onClick:g},{label:"Translate to VN",icon:i.jsx(Is,{className:"h-2.5 w-2.5"}),onClick:p},{label:"Translate to EN",icon:i.jsx(Is,{className:"h-2.5 w-2.5"}),onClick:f}];return i.jsx("div",{id:"ToolbarAi",className:ae("ToolbarAi",t),"data-test":"toolbar-ai-button",children:i.jsx(ze,{size:"compact",variant:n??"secondary",mainAction:{icon:i.jsx(yn,{className:"h-2.5 w-2.5"}),onClick:()=>{console.log("Main AI Action clicked")},text:"AI",label:"Trigger AI actions"},dropdownActions:h,dropdownPosition:"top",dropdownHorizontalAlign:"middle-right"})})},lf=()=>{const{fitNodeDimensions:e,setFixedWidth:t,selectedNodes:n}=Gn(),o=n.length===0,s=[{label:"Set width to 700px",icon:i.jsx(hn,{className:"h-2.5 w-2.5"}),onClick:()=>t(700),disabled:o},{label:"Set width to 550px",icon:i.jsx(hn,{className:"h-2.5 w-2.5"}),onClick:()=>t(550),disabled:o},{label:"Set width to 850px",icon:i.jsx(hn,{className:"h-2.5 w-2.5"}),onClick:()=>t(850),disabled:o},{label:"Fit node dimensions",icon:i.jsx(ca,{className:"h-2.5 w-2.5"}),onClick:()=>e(),disabled:o}],r=s[0];return i.jsx(ze,{mainAction:r,dropdownActions:s,variant:"outline",size:"compact",persistenceKey:"canvas-fit-width","data-test":"canvas-fit-width-button"})},Dt=50,cf=()=>{const e=$.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],o=(t==null?void 0:t.coreState.nodes)??{},s=e.updateNode,r=S.useCallback(u=>{if(n.length!==1){console.warn("useNodePusher: Exactly one node must be selected to push other nodes.");return}const g=n[0],p=[];Object.values(o).forEach(h=>{if(h.id===g.id)return;let m=!1;const x={id:h.id};switch(u){case"down":h.y>=g.y+(g.height??0)&&(x.y=h.y+Dt,m=!0);break;case"up":h.y+(h.height??0)<=(g.y??0)&&(x.y=h.y-Dt,m=!0);break;case"right":h.x>=g.x+(g.width??0)&&(x.x=h.x+Dt,m=!0);break;case"left":h.x+(h.width??0)<=g.x&&(x.x=h.x-Dt,m=!0);break}m&&p.push(x)}),p.length>0?(p.forEach(h=>s(h.id,h)),console.log(`Pushed ${p.length} nodes ${u} by ${Dt}px.`)):console.warn(`No nodes found to push ${u}.`)},[n,o,s]),a=S.useCallback(()=>r("down"),[r]),l=S.useCallback(()=>r("up"),[r]),c=S.useCallback(()=>r("left"),[r]),d=S.useCallback(()=>r("right"),[r]);return{pushNodesDown:a,pushNodesUp:l,pushNodesLeft:c,pushNodesRight:d,selectedNodes:n}},df=e=>{const{className:t}=e,{pushNodesDown:n,pushNodesUp:o,pushNodesLeft:s,pushNodesRight:r,selectedNodes:a}=cf(),l=a.length!==1,c={icon:i.jsx(ga,{}),onClick:n,label:"Push nodes",text:"Push",disabled:l},d=[{label:"Push Down",icon:i.jsx(da,{className:"h-2.5 w-2.5"}),onClick:n,disabled:l},{label:"Push Up",icon:i.jsx(ua,{className:"h-2.5 w-2.5"}),onClick:o,disabled:l},{label:"Push Left",icon:i.jsx(fa,{className:"h-2.5 w-2.5"}),onClick:s,disabled:l},{label:"Push Right",icon:i.jsx(Gt,{className:"h-2.5 w-2.5"}),onClick:r,disabled:l}];return i.jsx("div",{id:"PushNodesButtonContainer",className:ve("flex items-center",t),"data-test":"toolbar-push-nodes-button",children:i.jsx(ze,{mainAction:c,dropdownActions:d,variant:"outline",size:"compact"})})},uf=()=>{const e=$.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],o=(t==null?void 0:t.coreState.arrows)??[];e.addNode,e.deleteSelectedNodes;const s=e.deleteNodeById,r=e.setSelectedNodes,a=e.updateNodes,l=e.arrow.setAll,c=S.useCallback(g=>{if(n.length<2){console.warn("useNodeJoiner: At least two nodes must be selected to join.");return}const p=[...n].sort((N,j)=>N.y<j.y?-1:N.y>j.y?1:N.x<j.x?-1:N.x>j.x?1:0),f=p[0],h=p.slice(1),m=p.reduce((N,j)=>(j.width??0)>(N.width??0)?j:N,p[0]),x=p.map(N=>typeof N.content=="string"?N.content.trim():"").filter(N=>N.length>0).join(g);if(x.length===0&&p.every(N=>!(typeof N.content=="string"&&N.content.trim()))){console.warn("useNodeJoiner: All selected nodes have empty content. No node created.");return}const w=m.width??q.DEFAULT_NODE_WIDTH,b=st(x,w)+q.NODE_Y_PADDING*2;a([{id:f.id,content:x,width:m.width,height:b}]);{const N=new Set(h.map(I=>I.id)),C=o.map(I=>{const A=I.startNodeId&&N.has(I.startNodeId),T=I.endNodeId&&N.has(I.endNodeId);return A&&T||A&&I.endNodeId===f.id||T&&I.startNodeId===f.id?null:A||T?{...I,startNodeId:A?f.id:I.startNodeId,endNodeId:T?f.id:I.endNodeId}:I}).filter(I=>I!==null).filter((I,A,T)=>I?A===T.findIndex(E=>E&&E.startNodeId===I.startNodeId&&E.endNodeId===I.endNodeId):!1);l(C)}h.forEach(N=>{s(N.id)}),r([f]),console.log("Nodes joined into first node:",f.id)},[n,o,a,s,r,l]),d=S.useCallback(()=>{c(" ")},[c]),u=S.useCallback(()=>{c(`
`)},[c]);return{joinNodes:d,joinNodesWithNewline:u,selectedNodes:n}},ff=()=>{const{joinNodes:e,joinNodesWithNewline:t,selectedNodes:n}=uf(),o=n.length<2,s=[{label:"Join with newline",icon:i.jsx(Er,{className:"h-2.5 w-2.5"}),onClick:t,disabled:o},{label:"Join with space",icon:i.jsx(pa,{className:"h-2.5 w-2.5"}),onClick:e,disabled:o}],r={...s[0],text:"Join"};return i.jsx(ze,{mainAction:r,dropdownActions:s,variant:"outline",size:"compact","data-test":"canvas-join-nodes-button"})},gf=[{name:"Red",value:"#ef4444",twClass:"bg-red-500"},{name:"Orange",value:"#f97316",twClass:"bg-orange-500"},{name:"Yellow",value:"#eab308",twClass:"bg-yellow-500"},{name:"Green",value:"#22c55e",twClass:"bg-green-500"},{name:"Teal",value:"#14b8a6",twClass:"bg-teal-500"},{name:"Cyan",value:"#06b6d4",twClass:"bg-cyan-500"},{name:"Blue",value:"#3b82f6",twClass:"bg-blue-500"},{name:"Violet",value:"#8b5cf6",twClass:"bg-violet-500"},{name:"Purple",value:"#a855f7",twClass:"bg-purple-500"},{name:"Pink",value:"#ec4899",twClass:"bg-pink-500"},{name:"White",value:"#ffffff",twClass:"bg-white"},{name:"Black",value:"#000000",twClass:"bg-black"},{name:"Transparent",value:"transparent",twClass:"bg-transparent border-dashed border-neutral-400"}],pf=e=>{if(e.startsWith("hsl(")){const t=/hsl\(\s*(\d+)\s*,\s*(\d+%)\s*,\s*(\d+%)\s*\)/.exec(e);if(t){const n=parseInt(t[1]),o=parseInt(t[2])/100,s=parseInt(t[3])/100;if(o===0){const d=Math.round(s*255).toString(16).padStart(2,"0");return`#${d}${d}${d}`}const r=d=>(d+n/30)%12,a=o*Math.min(s,1-s),l=d=>s-a*Math.max(-1,Math.min(r(d)-3,Math.min(9-r(d),1))),c=d=>Math.round(d*255).toString(16).padStart(2,"0");return`#${c(l(0))}${c(l(8))}${c(l(4))}`}}return console.warn(`convertHslToHex: Could not convert HSL string "${e}" to HEX. Returning as is or black.`),e.startsWith("#")?e:"#000000"},hf=({currentColor:e,onColorSelect:t,currentBorderWidth:n,onBorderWidthChange:o})=>{const[s,r]=S.useState(e),[a,l]=S.useState(n);S.useEffect(()=>{r(e)},[e]),S.useEffect(()=>{l(n)},[n]);const c=u=>{r(u),t(u)},d=u=>{const g=parseInt(u.target.value,10);isNaN(g)||(l(g),o(g))};return i.jsxs("div",{className:"p-2 grid grid-cols-5 gap-2 bg-popover rounded-md shadow-md",children:[gf.map(u=>i.jsx("button",{type:"button",title:u.name,onClick:()=>c(u.value),className:ve("w-6 h-6 rounded-full border-2 cursor-pointer focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",u.twClass,u.value===s?"ring-2 ring-ring ring-offset-2":"border-muted",u.value==="white"&&"border-neutral-300"),style:u.value.startsWith("hsl(")?{backgroundColor:u.value}:{},"aria-label":`Select color ${u.name}`,"data-test":`color-picker-${u.name.toLowerCase().replace(/\s+/g,"-")}`},u.value)),i.jsx("input",{type:"color",value:s.startsWith("hsl")?pf(s):s,onChange:u=>c(u.target.value),className:"mt-2 w-full col-span-5 h-8 bg-secondary","data-test":"color-picker-custom-color-input"}),i.jsxs("div",{className:"mt-3 pt-3 border-t border-border col-span-5",children:[i.jsx("label",{htmlFor:"border-width-input",className:"block text-sm font-medium text-foreground mb-1",children:"Border Width"}),i.jsx("input",{type:"number",id:"border-width-input",value:a,onChange:d,min:"0",max:"50",className:"mt-1 w-full col-span-5 h-8 p-2 rounded-md border border-input bg-background text-foreground focus:ring-ring focus:border-ring","data-test":"color-picker-border-width-input"})]})]})},mf=()=>{var I,A,T,E;const e=B(y=>y.updateNode),t=B(y=>{var v;return((v=y.projectCanvas.getActive())==null?void 0:v.coreState.selectedNodes)??[]}),[n,o]=S.useState(!1),[s,r]=S.useState("hsl(var(--primary))"),[a,l]=S.useState("1px"),[c,d]=S.useState("solid"),u=$.getState().getLastUsedBorder(),g=u.lastUsedColor,p=u.lastUsedWidth,f=u.lastUsedStyle;S.useEffect(()=>{if(t.length===1){const v=t[0].styles,k=(v==null?void 0:v.borderColor)||"hsl(var(--primary))",R=(v==null?void 0:v.borderWidth)||"1px",M=(v==null?void 0:v.borderStyle)||"solid";r(k),l(R),d(M)}else t.length===0&&(r("hsl(var(--primary))"),l("1px"),d("solid"))},[t]);const h=(y,v,k)=>{t.forEach(R=>{const M={...R.styles,borderWidth:y,borderStyle:v,borderColor:k};y===void 0&&v===void 0&&k===void 0&&(M.border=void 0);const D={styles:M};e(R.id,D)})},m=()=>{h(p,f,g)},x=y=>{h(a,c,y),r(y),$.getState().setLastUsedBorder(y,a,c),$.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},w=y=>{const v=`${y}px`;h(v,c,s),l(v),$.getState().setLastUsedBorder(s,v,c),$.getState().setSegmentedButtonAction("canvas-border-width","Apply last used border color")},b=()=>{l(void 0),d(void 0),r(void 0),h(void 0,void 0,void 0)},N=[{label:"Apply last used border color",icon:i.jsx("span",{style:{color:g==="transparent"?void 0:g,display:"inline-flex"},children:i.jsx(ks,{className:"h-2.5 w-2.5"})}),onClick:()=>{m()},disabled:t.length===0},{label:"Set Border Color",icon:i.jsx("span",{style:{color:s==="transparent"?void 0:s,display:"inline-flex"},children:i.jsx(ha,{className:"h-2.5 w-2.5"})}),onClick:()=>{o(!0)},disabled:t.length===0},{label:"Remove Border",icon:i.jsx(ma,{className:"h-2.5 w-2.5"}),onClick:()=>{b()},disabled:t.length===0||!((A=(I=t[0])==null?void 0:I.styles)!=null&&A.borderWidth)&&!((E=(T=t[0])==null?void 0:T.styles)!=null&&E.border)}],j={...N[0],icon:i.jsx("span",{style:{color:s==="transparent"?void 0:s,display:"inline-flex"},children:i.jsx(ks,{className:"h-2.5 w-2.5"})})},C=y=>{if(!y)return 1;const v=parseInt(y,10);return isNaN(v)?1:v};return i.jsxs(Uo,{open:n,onOpenChange:o,children:[i.jsx(Go,{asChild:!0,children:i.jsx("div",{style:{display:"inline-flex"},"data-test":"canvas-border-width-button",children:i.jsx(ze,{mainAction:j,dropdownActions:N,variant:"outline",size:"compact",persistenceKey:"canvas-border-width"})})}),i.jsx(Yo,{className:"w-auto p-0",sideOffset:5,onCloseAutoFocus:y=>y.preventDefault(),"data-test":"canvas-border-width-popover",children:i.jsx(hf,{currentColor:s,onColorSelect:x,currentBorderWidth:C(a),onBorderWidthChange:w})})]})},xf=()=>{const e=$.getState(),t=e.projectCanvas.getActive(),n=(t==null?void 0:t.coreState.selectedNodes)??[],o=e.updateNode;return{removeExtraNewLines:S.useCallback(()=>{if(n.length!==1){console.warn("useNodeLineManipulation: Exactly one node must be selected.");return}const r=n[0];if(!r.content||typeof r.content!="string"){console.warn("useNodeLineManipulation: Selected node has no content to modify.");return}const a=r.content.replace(/\n\n+/g,`
`);if(a===r.content){console.warn("useNodeLineManipulation: No extra new lines found. Node content not changed.");return}const l=st(a,r.width??0-q.NODE_X_PADDING)+q.NODE_Y_PADDING*2,c={id:r.id,content:a,height:l};o(c.id,c),console.log("Action: Removed extra new lines from node content.")},[n,o])}},wf=e=>{const{className:t}=e,{removeExtraNewLines:n}=xf(),o={icon:i.jsx(Rs,{}),onClick:n,label:"Remove extra new lines",text:"Lines"},s=[{label:"Remove extra new lines",icon:i.jsx(Rs,{className:"h-2.5 w-2.5"}),onClick:n}];return i.jsx("div",{id:"ToolbarLinesButtonContainer",className:ve("flex items-center",t),"data-test":"toolbar-lines-button",children:i.jsx(ze,{mainAction:o,dropdownActions:s,variant:"outline",size:"compact"})})},vf=e=>{const{className:t,...n}=e,o=()=>{var a;const s=$.getState();(((a=s.projectCanvas.getActive())==null?void 0:a.coreState.selectedNodes)??[]).length>0&&s.deleteSelectedNodes()};return i.jsx(Zt,{id:"ToolbarDeleteNodesButton",className:t,type:"button",onClick:o,"data-test":"toolbar-delete-nodes-button",...n,children:i.jsx(Ke,{className:"h-2.5 w-2.5"})})},Sf=e=>{if(!e||e.length===0)return[];const t=[...e].sort((a,l)=>(a.y??0)-(l.y??0)),n=[];let o=[],s=0,r=0;for(const a of t){const l=a.y??0,c=a.height??0;if(o.length===0){o.push(a),s=l,r=l+c;continue}l>=s&&l<=r?(o.push(a),r=Math.max(r,l+c)):(n.push(o),o=[a],s=l,r=l+c)}return o.length>0&&n.push(o),n},yf=e=>{if(!e||e.length===0)return[];const t=[...e].sort((a,l)=>(a.x??0)-(l.x??0)),n=[];let o=[],s=0,r=0;for(const a of t){const l=a.x??0,c=a.width??0;if(o.length===0){o.push(a),s=l,r=l+c;continue}l>=s&&l<=r?(o.push(a),r=Math.max(r,l+c)):(n.push(o),o=[a],s=l,r=l+c)}return o.length>0&&n.push(o),n},Nf=(e,t,n)=>{const o=new Map;if(!e||e.length===0)return o;if(t==="left"){const s=[...e].sort((r,a)=>{if(r.createdAt&&a.createdAt){const l=new Date(r.createdAt).getTime()-new Date(a.createdAt).getTime();if(l!==0)return l}return(r.x??0)-(a.x??0)});for(let r=1;r<s.length;r++){const a=s[r-1],l=s[r],c=(a.x??0)+(a.width??0);if((l.x??0)<c+n){const u=c+n;o.set(l.id,{x:u}),s[r]={...l,x:u}}}}else{const s=[...e].sort((r,a)=>{if(r.createdAt&&a.createdAt){const d=new Date(r.createdAt).getTime()-new Date(a.createdAt).getTime();if(d!==0)return d}const l=(r.x??0)+(r.width??0);return(a.x??0)+(a.width??0)-l});for(let r=1;r<s.length;r++){const a=s[r-1],l=s[r],c=a.x??0;if((l.x??0)+(l.width??0)>c-n){const u=c-n-(l.width??0);o.set(l.id,{x:u}),s[r]={...l,x:u}}}}return o},bf=(e,t,n)=>{const o=new Map;if(!e||e.length===0)return o;if(t==="top"){const s=[...e].sort((r,a)=>{if(r.createdAt&&a.createdAt){const l=new Date(r.createdAt).getTime()-new Date(a.createdAt).getTime();if(l!==0)return l}return(r.y??0)-(a.y??0)});for(let r=1;r<s.length;r++){const a=s[r-1],l=s[r],c=(a.y??0)+(a.height??0);if((l.y??0)<c+n){const u=c+n;o.set(l.id,{y:u}),s[r]={...l,y:u}}}}else{const s=[...e].sort((r,a)=>{if(r.createdAt&&a.createdAt){const d=new Date(r.createdAt).getTime()-new Date(a.createdAt).getTime();if(d!==0)return d}const l=(r.y??0)+(r.height??0);return(a.y??0)+(a.height??0)-l});for(let r=1;r<s.length;r++){const a=s[r-1],l=s[r],c=a.y??0;if((l.y??0)+(l.height??0)>c-n){const u=c-n-(l.height??0);o.set(l.id,{y:u}),s[r]={...l,y:u}}}}return o},so={left:i.jsx(Rr,{className:"h-2.5 w-2.5"}),right:i.jsx(kr,{className:"h-2.5 w-2.5"}),top:i.jsx(wa,{className:"h-2.5 w-2.5"}),bottom:i.jsx(xa,{className:"h-2.5 w-2.5"})},Cf=e=>{var f;const{className:t,value:n,defaultValue:o="left",onAlignmentChange:s}=e,r=$.getState(),a=((f=r.projectCanvas.getActive())==null?void 0:f.coreState.selectedNodes)??[],[l,c]=S.useState(n??o);S.useEffect(()=>{n!==void 0&&c(n)},[n]);const d=h=>{if(!a||a.length===0)return;const m=a.filter(j=>typeof j.x=="number"&&typeof j.y=="number"&&typeof j.width=="number"&&typeof j.height=="number");if(m.length===0)return;const x=h==="left"||h==="right"?Sf(m):yf(m);let w;switch(h){case"left":w=Math.min(...m.map(j=>j.x));break;case"right":w=Math.max(...m.map(j=>(j.x??0)+(j.width??0)));break;case"top":w=Math.min(...m.map(j=>j.y));break;case"bottom":w=Math.max(...m.map(j=>(j.y??0)+(j.height??0)));break;default:return}const b=new Map;for(const j of m)switch(h){case"left":b.set(j.id,{x:w});break;case"right":b.set(j.id,{x:w-(j.width??0)});break;case"top":b.set(j.id,{y:w});break;case"bottom":b.set(j.id,{y:w-(j.height??0)});break}const N=q.NODE_ALIGNMENT_PADDING;for(const j of x){const C=j.map(A=>{const T=b.get(A.id);return T?{...A,...T}:A});(h==="left"||h==="right"?Nf(C,h,N):bf(C,h,N)).forEach((A,T)=>{const E=b.get(T)||{};b.set(T,{...E,...A})})}b.forEach((j,C)=>{r.updateNode(C,j)})},u=h=>{s==null||s(h),c(h),d(h)},g={icon:i.jsxs(i.Fragment,{children:["N",so[l]]}),onClick:()=>u(l),label:`Align ${l}`,text:""},p=Object.keys(so).map(h=>({label:`Align ${h}`,icon:so[h],onClick:()=>u(h)}));return i.jsx("div",{id:"ToolbarNodesAlignmentButton",className:ve("flex items-center",t),"data-test":"toolbar-nodes-alignment-button",children:i.jsx(ze,{mainAction:g,dropdownActions:p,variant:"outline",size:"compact"})})},jf=e=>{const{className:t}=e,{handleAlignmentChange:n,currentAlignment:o}=Wu();return i.jsxs("div",{className:ae("p-0.5 gap-0.5","bg-primary-foreground shadow","flex items-center flex-wrap","pointer-events-auto",t),"data-test":"canvas-node-configurations-toolbar",children:[i.jsx(Xr,{}),i.jsx(vf,{}),i.jsx(Hu,{value:o,onAlignmentChange:n}),i.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),i.jsx(Cf,{}),i.jsx(mf,{}),i.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),i.jsx(Ku,{}),i.jsx(rf,{}),i.jsx(wf,{}),i.jsx(lf,{}),i.jsx(ff,{}),i.jsx(df,{}),i.jsx("div",{className:"h-3 w-px bg-border mx-0.5"}),i.jsx(af,{})]})},If=({node:e})=>i.jsx("div",{className:ae("relative","bg-primary-foreground shadow flex items-center space-x-2 pointer-events-auto"),"data-test":"node-quick-panel-container","data-node-id":e.id,"data-node-type":e.type,children:i.jsx(jf,{})}),tr=30,kf=({node:e,isOpen:t,children:n})=>{const[o,s]=S.useState({top:0,left:0}),r=S.useRef(null);return S.useEffect(()=>{if(!t)return;const a=()=>{var b,N;const c=document.getElementById(`NodeContainerV2-${e.id}`);if(!c)return;const d=c.getBoundingClientRect(),u=((b=r.current)==null?void 0:b.offsetHeight)||250,g=((N=r.current)==null?void 0:N.offsetWidth)||350,p=window.innerWidth,f=window.innerHeight,h=20;let m=d.left+d.width/2-g/2;const x=d.top-u-tr;let w;if(x>=h)w=x;else{const j=d.bottom+tr;j+u<=f-h?w=j:w=h}m<h?m=h:m+g>p-h&&(m=p-g-h),s({top:w,left:m})};a();const l=setTimeout(a,100);return window.addEventListener("scroll",a,!0),window.addEventListener("resize",a),()=>{clearTimeout(l),window.removeEventListener("scroll",a,!0),window.removeEventListener("resize",a)}},[t,e.id,e.x,e.y]),i.jsxs(i.Fragment,{children:[n,t&&bi.createPortal(i.jsx("div",{ref:r,className:"fixed pointer-events-auto",style:{top:`${o.top}px`,left:`${o.left}px`,zIndex:1500,maxWidth:"90vw"},onPointerDown:a=>a.stopPropagation(),onTouchStart:a=>a.stopPropagation(),onWheel:a=>a.stopPropagation(),children:i.jsx(If,{node:e})}),document.body)]})},Rf=[{position:"top",cursor:"cursor-crosshair",classes:"top-0 left-1/2 -translate-x-1/2"},{position:"bottom",cursor:"cursor-crosshair",classes:"bottom-0 left-1/2 -translate-x-1/2"},{position:"left",cursor:"cursor-crosshair",classes:"left-0 top-1/2 -translate-y-1/2"},{position:"right",cursor:"cursor-crosshair",classes:"right-0 top-1/2 -translate-y-1/2"}],tt=8,ln=Z.nodeOptions.resizeBorderWidth,ge={corner:{width:tt,height:tt},edge:{horizontal:{height:ln,width:`calc(100% - ${tt*2}px)`},vertical:{width:ln,height:`calc(100% - ${tt*2}px)`}},position:{cornerTop:`-${tt}px`,cornerLeft:`-${tt}px`,cornerBottom:"100%",cornerRight:"100%",edgeTop:`-${ln}px`,edgeLeft:`-${ln}px`,topEdge:`${tt}px`,leftEdge:`${tt}px`},edgePosition:{bottom:"100%",left:"100%"}},Ef=[{position:"top-left",cursor:"cursor-nwse-resize",classes:"z-10",style:{...ge.corner,top:ge.position.cornerTop,left:ge.position.cornerLeft}},{position:"top-right",cursor:"cursor-nesw-resize",classes:"z-10",style:{...ge.corner,top:ge.position.cornerTop,left:ge.position.cornerRight}},{position:"bottom-left",cursor:"cursor-nesw-resize",classes:"z-10",style:{...ge.corner,top:ge.position.cornerBottom,left:ge.position.cornerLeft}},{position:"bottom-right",cursor:"cursor-nwse-resize",classes:"z-10",style:{...ge.corner,top:ge.position.cornerBottom,left:ge.position.cornerRight}},{position:"top",cursor:"cursor-ns-resize",classes:"",style:{...ge.edge.horizontal,top:ge.position.edgeTop,left:ge.position.leftEdge}},{position:"bottom",cursor:"cursor-ns-resize",classes:"",style:{...ge.edge.horizontal,top:ge.edgePosition.bottom,left:ge.position.leftEdge}},{position:"left",cursor:"cursor-ew-resize",classes:"",style:{...ge.edge.vertical,top:ge.position.topEdge,left:ge.position.edgeLeft}},{position:"right",cursor:"cursor-ew-resize",classes:"",style:{...ge.edge.vertical,top:ge.position.topEdge,left:ge.edgePosition.left}}],Af=e=>{const t=et(e,"top-left"),n=et(e,"top-right"),o=et(e,"bottom-left"),s=et(e,"bottom-right"),r=et(e,"top"),a=et(e,"bottom"),l=et(e,"left"),c=et(e,"right");return{"top-left":t,"top-right":n,"bottom-left":o,"bottom-right":s,top:r,bottom:a,left:l,right:c}},{HANDLE_BG_COLOR:Tf,HANDLE_BORDER_COLOR:Df}=q,Mo=8,Po=20,Nt=(Po-Mo)/2,Mf=({node:e,isSelected:t,mode:n})=>{const o=t&&n===H.SELECT,s=Af(e);return o?i.jsx(i.Fragment,{children:Ef.map(({position:r,cursor:a,classes:l,style:c})=>{const d=s[r];return["top","right","bottom","left"].includes(r)?i.jsx("div",{"data-test":`resize-handle-${r}`,id:`resize-handle-${e.id}-${r}`,className:ae("absolute","hover:bg-primary/5 transition-colors",l,a),style:{...c,touchAction:"none",zIndex:qe.canvasResizeHandles},onPointerDown:g=>{g.stopPropagation(),d(g)}},r):i.jsx("div",{"data-test":`resize-handle-${r}`,id:`resize-handle-${e.id}-${r}`,className:ae("absolute",l,a),style:{width:Po,height:Po,top:typeof(c==null?void 0:c.top)=="string"?`calc(${c.top} - ${Nt}px)`:(c==null?void 0:c.top)-Nt,left:typeof(c==null?void 0:c.left)=="string"?`calc(${c.left} - ${Nt}px)`:(c==null?void 0:c.left)-Nt,touchAction:"none",zIndex:qe.canvasResizeHandles},onPointerDown:g=>{g.stopPropagation(),d(g)},children:i.jsx("div",{className:ae("absolute border",Tf,Df),style:{width:Mo,height:Mo,top:Nt,left:Nt,pointerEvents:"none"}})},r)})}):null},Pf=e=>{const t=rn(e,"top"),n=rn(e,"bottom"),o=rn(e,"left"),s=rn(e,"right");return S.useMemo(()=>({top:t,bottom:n,left:o,right:s}),[t,n,o,s])},cn=-10,_f=({node:e,isSelected:t,mode:n})=>{const o=t&&n===H.SELECT,s=Pf(e);return o?i.jsx(i.Fragment,{children:Rf.map(({position:r,cursor:a,classes:l})=>{const c=s[r];return i.jsx("div",{"data-test":`quick-arrow-handle-${r}`,id:`arrow-handle-${e.id}-${r}`,className:ae("absolute border rounded-full z-10","bg-blue-500","border-blue-700",l.replace(/-translate-\w+-1\/2/g,"").trim(),a,"pointer-events-auto"),style:{width:`${Ve}px`,height:`${Ve}px`,top:l.includes("top-0")?`${cn-Ve}px`:l.includes("bottom-0")?`calc(100% + ${Ve-cn}px)`:`calc(50% - ${Ve/2}px)`,left:l.includes("left-0")?`${cn-Ve}px`:l.includes("right-0")?`calc(100% + ${Ve-cn}px)`:`calc(50% - ${Ve/2}px)`},onMouseDown:d=>{d.stopPropagation(),c(d)}},`arrow-${r}`)})}):null},Of=e=>{var g;const{node:t,mode:n,isPopoverOpen:o,setIsPopoverOpen:s}=e,r=Zd(t),a=$.getState(),l=(g=a.projectCanvas.getActive())==null?void 0:g.coreState.selectedNodes,c=a.setSelectedNodes,d=S.useRef({x:NaN,y:NaN});return{handleMouseDown:S.useCallback(p=>{const f={x:p.clientX,y:p.clientY};if(d.current=f,n===H.MOVE)return;const h=p.target,m=l==null?void 0:l.some(A=>A.id===t.id),x=m&&(l==null?void 0:l.length)===1,w=h.closest(`[id^="resize-handle-${t.id}-"]`),b=h.closest(`[id^="arrow-handle-${t.id}-"]`),N=h.closest("[data-drag-handle]"),C=(h.tagName==="TEXTAREA"||h.closest("textarea")||h.closest("[contenteditable]")||h.closest("[data-node-textarea]")||h.closest(".markdown-textarea")||h.isContentEditable)&&x&&!t.isEditing&&o,I=h.closest(".audio-button-wrapper")||h.closest(".voice-input-button")||h.closest(".nav-button")||h.closest(".chunk-counter");if(C){const A=$.getState(),T=p.clientX,E=p.clientY;s(!1),A.setNodeToFocusId(t.id),requestAnimationFrame(()=>{try{let y=null;if(document.caretRangeFromPoint)y=document.caretRangeFromPoint(T,E);else if(document.caretPositionFromPoint){const v=document.caretPositionFromPoint(T,E);v&&(y=document.createRange(),y.setStart(v.offsetNode,v.offset),y.collapse(!0))}if(y){const v=window.getSelection();v&&(v.removeAllRanges(),v.addRange(y))}}catch{}});return}if(w||b||N||I){s(!1);return}m||s(!1),!t.isEditing&&!C&&r(p)},[t,c,r,n,l,o]),initialClickPoint:d}};/**
   * table-core
   *
   * Copyright (c) TanStack
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE.md file in the root directory of this source tree.
   *
   * @license MIT
   */function ot(e,t){return typeof e=="function"?e(t):e}function Me(e,t){return n=>{t.setState(o=>({...o,[e]:ot(n,o[e])}))}}function Yn(e){return e instanceof Function}function Ff(e){return Array.isArray(e)&&e.every(t=>typeof t=="number")}function $f(e,t){const n=[],o=s=>{s.forEach(r=>{n.push(r);const a=t(r);a!=null&&a.length&&o(a)})};return o(e),n}function J(e,t,n){let o=[],s;return r=>{let a;n.key&&n.debug&&(a=Date.now());const l=e(r);if(!(l.length!==o.length||l.some((u,g)=>o[g]!==u)))return s;o=l;let d;if(n.key&&n.debug&&(d=Date.now()),s=t(...l),n==null||n.onChange==null||n.onChange(s),n.key&&n.debug&&n!=null&&n.debug()){const u=Math.round((Date.now()-a)*100)/100,g=Math.round((Date.now()-d)*100)/100,p=g/16,f=(h,m)=>{for(h=String(h);h.length<m;)h=" "+h;return h};console.info(`%câ± ${f(g,5)} /${f(u,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*p,120))}deg 100% 31%);`,n==null?void 0:n.key)}return s}}function Q(e,t,n,o){return{debug:()=>{var s;return(s=e==null?void 0:e.debugAll)!=null?s:e[t]},key:!1,onChange:o}}function Lf(e,t,n,o){const s=()=>{var a;return(a=r.getValue())!=null?a:e.options.renderFallbackValue},r={id:`${t.id}_${n.id}`,row:t,column:n,getValue:()=>t.getValue(o),renderValue:s,getContext:J(()=>[e,n,t,r],(a,l,c,d)=>({table:a,column:l,row:c,cell:d,getValue:d.getValue,renderValue:d.renderValue}),Q(e.options,"debugCells"))};return e._features.forEach(a=>{a.createCell==null||a.createCell(r,n,t,e)},{}),r}function Hf(e,t,n,o){var s,r;const l={...e._getDefaultColumnDef(),...t},c=l.accessorKey;let d=(s=(r=l.id)!=null?r:c?typeof String.prototype.replaceAll=="function"?c.replaceAll(".","_"):c.replace(/\./g,"_"):void 0)!=null?s:typeof l.header=="string"?l.header:void 0,u;if(l.accessorFn?u=l.accessorFn:c&&(c.includes(".")?u=p=>{let f=p;for(const m of c.split(".")){var h;f=(h=f)==null?void 0:h[m]}return f}:u=p=>p[l.accessorKey]),!d)throw new Error;let g={id:`${String(d)}`,accessorFn:u,parent:o,depth:n,columnDef:l,columns:[],getFlatColumns:J(()=>[!0],()=>{var p;return[g,...(p=g.columns)==null?void 0:p.flatMap(f=>f.getFlatColumns())]},Q(e.options,"debugColumns")),getLeafColumns:J(()=>[e._getOrderColumnsFn()],p=>{var f;if((f=g.columns)!=null&&f.length){let h=g.columns.flatMap(m=>m.getLeafColumns());return p(h)}return[g]},Q(e.options,"debugColumns"))};for(const p of e._features)p.createColumn==null||p.createColumn(g,e);return g}const Ce="debugHeaders";function nr(e,t,n){var o;let r={id:(o=n.id)!=null?o:t.id,column:t,index:n.index,isPlaceholder:!!n.isPlaceholder,placeholderId:n.placeholderId,depth:n.depth,subHeaders:[],colSpan:0,rowSpan:0,headerGroup:null,getLeafHeaders:()=>{const a=[],l=c=>{c.subHeaders&&c.subHeaders.length&&c.subHeaders.map(l),a.push(c)};return l(r),a},getContext:()=>({table:e,header:r,column:t})};return e._features.forEach(a=>{a.createHeader==null||a.createHeader(r,e)}),r}const Wf={createTable:e=>{e.getHeaderGroups=J(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.left,e.getState().columnPinning.right],(t,n,o,s)=>{var r,a;const l=(r=o==null?void 0:o.map(g=>n.find(p=>p.id===g)).filter(Boolean))!=null?r:[],c=(a=s==null?void 0:s.map(g=>n.find(p=>p.id===g)).filter(Boolean))!=null?a:[],d=n.filter(g=>!(o!=null&&o.includes(g.id))&&!(s!=null&&s.includes(g.id)));return dn(t,[...l,...d,...c],e)},Q(e.options,Ce)),e.getCenterHeaderGroups=J(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.left,e.getState().columnPinning.right],(t,n,o,s)=>(n=n.filter(r=>!(o!=null&&o.includes(r.id))&&!(s!=null&&s.includes(r.id))),dn(t,n,e,"center")),Q(e.options,Ce)),e.getLeftHeaderGroups=J(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.left],(t,n,o)=>{var s;const r=(s=o==null?void 0:o.map(a=>n.find(l=>l.id===a)).filter(Boolean))!=null?s:[];return dn(t,r,e,"left")},Q(e.options,Ce)),e.getRightHeaderGroups=J(()=>[e.getAllColumns(),e.getVisibleLeafColumns(),e.getState().columnPinning.right],(t,n,o)=>{var s;const r=(s=o==null?void 0:o.map(a=>n.find(l=>l.id===a)).filter(Boolean))!=null?s:[];return dn(t,r,e,"right")},Q(e.options,Ce)),e.getFooterGroups=J(()=>[e.getHeaderGroups()],t=>[...t].reverse(),Q(e.options,Ce)),e.getLeftFooterGroups=J(()=>[e.getLeftHeaderGroups()],t=>[...t].reverse(),Q(e.options,Ce)),e.getCenterFooterGroups=J(()=>[e.getCenterHeaderGroups()],t=>[...t].reverse(),Q(e.options,Ce)),e.getRightFooterGroups=J(()=>[e.getRightHeaderGroups()],t=>[...t].reverse(),Q(e.options,Ce)),e.getFlatHeaders=J(()=>[e.getHeaderGroups()],t=>t.map(n=>n.headers).flat(),Q(e.options,Ce)),e.getLeftFlatHeaders=J(()=>[e.getLeftHeaderGroups()],t=>t.map(n=>n.headers).flat(),Q(e.options,Ce)),e.getCenterFlatHeaders=J(()=>[e.getCenterHeaderGroups()],t=>t.map(n=>n.headers).flat(),Q(e.options,Ce)),e.getRightFlatHeaders=J(()=>[e.getRightHeaderGroups()],t=>t.map(n=>n.headers).flat(),Q(e.options,Ce)),e.getCenterLeafHeaders=J(()=>[e.getCenterFlatHeaders()],t=>t.filter(n=>{var o;return!((o=n.subHeaders)!=null&&o.length)}),Q(e.options,Ce)),e.getLeftLeafHeaders=J(()=>[e.getLeftFlatHeaders()],t=>t.filter(n=>{var o;return!((o=n.subHeaders)!=null&&o.length)}),Q(e.options,Ce)),e.getRightLeafHeaders=J(()=>[e.getRightFlatHeaders()],t=>t.filter(n=>{var o;return!((o=n.subHeaders)!=null&&o.length)}),Q(e.options,Ce)),e.getLeafHeaders=J(()=>[e.getLeftHeaderGroups(),e.getCenterHeaderGroups(),e.getRightHeaderGroups()],(t,n,o)=>{var s,r,a,l,c,d;return[...(s=(r=t[0])==null?void 0:r.headers)!=null?s:[],...(a=(l=n[0])==null?void 0:l.headers)!=null?a:[],...(c=(d=o[0])==null?void 0:d.headers)!=null?c:[]].map(u=>u.getLeafHeaders()).flat()},Q(e.options,Ce))}};function dn(e,t,n,o){var s,r;let a=0;const l=function(p,f){f===void 0&&(f=1),a=Math.max(a,f),p.filter(h=>h.getIsVisible()).forEach(h=>{var m;(m=h.columns)!=null&&m.length&&l(h.columns,f+1)},0)};l(e);let c=[];const d=(p,f)=>{const h={depth:f,id:[o,`${f}`].filter(Boolean).join("_"),headers:[]},m=[];p.forEach(x=>{const w=[...m].reverse()[0],b=x.column.depth===h.depth;let N,j=!1;if(b&&x.column.parent?N=x.column.parent:(N=x.column,j=!0),w&&(w==null?void 0:w.column)===N)w.subHeaders.push(x);else{const C=nr(n,N,{id:[o,f,N.id,x==null?void 0:x.id].filter(Boolean).join("_"),isPlaceholder:j,placeholderId:j?`${m.filter(I=>I.column===N).length}`:void 0,depth:f,index:m.length});C.subHeaders.push(x),m.push(C)}h.headers.push(x),x.headerGroup=h}),c.push(h),f>0&&d(m,f-1)},u=t.map((p,f)=>nr(n,p,{depth:a,index:f}));d(u,a-1),c.reverse();const g=p=>p.filter(h=>h.column.getIsVisible()).map(h=>{let m=0,x=0,w=[0];h.subHeaders&&h.subHeaders.length?(w=[],g(h.subHeaders).forEach(N=>{let{colSpan:j,rowSpan:C}=N;m+=j,w.push(C)})):m=1;const b=Math.min(...w);return x=x+b,h.colSpan=m,h.rowSpan=x,{colSpan:m,rowSpan:x}});return g((s=(r=c[0])==null?void 0:r.headers)!=null?s:[]),c}const ds=(e,t,n,o,s,r,a)=>{let l={id:t,index:o,original:n,depth:s,parentId:a,_valuesCache:{},_uniqueValuesCache:{},getValue:c=>{if(l._valuesCache.hasOwnProperty(c))return l._valuesCache[c];const d=e.getColumn(c);if(d!=null&&d.accessorFn)return l._valuesCache[c]=d.accessorFn(l.original,o),l._valuesCache[c]},getUniqueValues:c=>{if(l._uniqueValuesCache.hasOwnProperty(c))return l._uniqueValuesCache[c];const d=e.getColumn(c);if(d!=null&&d.accessorFn)return d.columnDef.getUniqueValues?(l._uniqueValuesCache[c]=d.columnDef.getUniqueValues(l.original,o),l._uniqueValuesCache[c]):(l._uniqueValuesCache[c]=[l.getValue(c)],l._uniqueValuesCache[c])},renderValue:c=>{var d;return(d=l.getValue(c))!=null?d:e.options.renderFallbackValue},subRows:[],getLeafRows:()=>$f(l.subRows,c=>c.subRows),getParentRow:()=>l.parentId?e.getRow(l.parentId,!0):void 0,getParentRows:()=>{let c=[],d=l;for(;;){const u=d.getParentRow();if(!u)break;c.push(u),d=u}return c.reverse()},getAllCells:J(()=>[e.getAllLeafColumns()],c=>c.map(d=>Lf(e,l,d,d.id)),Q(e.options,"debugRows")),_getAllCellsByColumnId:J(()=>[l.getAllCells()],c=>c.reduce((d,u)=>(d[u.column.id]=u,d),{}),Q(e.options,"debugRows"))};for(let c=0;c<e._features.length;c++){const d=e._features[c];d==null||d.createRow==null||d.createRow(l,e)}return l},zf={createColumn:(e,t)=>{e._getFacetedRowModel=t.options.getFacetedRowModel&&t.options.getFacetedRowModel(t,e.id),e.getFacetedRowModel=()=>e._getFacetedRowModel?e._getFacetedRowModel():t.getPreFilteredRowModel(),e._getFacetedUniqueValues=t.options.getFacetedUniqueValues&&t.options.getFacetedUniqueValues(t,e.id),e.getFacetedUniqueValues=()=>e._getFacetedUniqueValues?e._getFacetedUniqueValues():new Map,e._getFacetedMinMaxValues=t.options.getFacetedMinMaxValues&&t.options.getFacetedMinMaxValues(t,e.id),e.getFacetedMinMaxValues=()=>{if(e._getFacetedMinMaxValues)return e._getFacetedMinMaxValues()}}},qr=(e,t,n)=>{var o,s;const r=n==null||(o=n.toString())==null?void 0:o.toLowerCase();return!!(!((s=e.getValue(t))==null||(s=s.toString())==null||(s=s.toLowerCase())==null)&&s.includes(r))};qr.autoRemove=e=>Fe(e);const Zr=(e,t,n)=>{var o;return!!(!((o=e.getValue(t))==null||(o=o.toString())==null)&&o.includes(n))};Zr.autoRemove=e=>Fe(e);const Jr=(e,t,n)=>{var o;return((o=e.getValue(t))==null||(o=o.toString())==null?void 0:o.toLowerCase())===(n==null?void 0:n.toLowerCase())};Jr.autoRemove=e=>Fe(e);const Qr=(e,t,n)=>{var o;return(o=e.getValue(t))==null?void 0:o.includes(n)};Qr.autoRemove=e=>Fe(e);const ei=(e,t,n)=>!n.some(o=>{var s;return!((s=e.getValue(t))!=null&&s.includes(o))});ei.autoRemove=e=>Fe(e)||!(e!=null&&e.length);const ti=(e,t,n)=>n.some(o=>{var s;return(s=e.getValue(t))==null?void 0:s.includes(o)});ti.autoRemove=e=>Fe(e)||!(e!=null&&e.length);const ni=(e,t,n)=>e.getValue(t)===n;ni.autoRemove=e=>Fe(e);const oi=(e,t,n)=>e.getValue(t)==n;oi.autoRemove=e=>Fe(e);const us=(e,t,n)=>{let[o,s]=n;const r=e.getValue(t);return r>=o&&r<=s};us.resolveFilterValue=e=>{let[t,n]=e,o=typeof t!="number"?parseFloat(t):t,s=typeof n!="number"?parseFloat(n):n,r=t===null||Number.isNaN(o)?-1/0:o,a=n===null||Number.isNaN(s)?1/0:s;if(r>a){const l=r;r=a,a=l}return[r,a]};us.autoRemove=e=>Fe(e)||Fe(e[0])&&Fe(e[1]);const Ge={includesString:qr,includesStringSensitive:Zr,equalsString:Jr,arrIncludes:Qr,arrIncludesAll:ei,arrIncludesSome:ti,equals:ni,weakEquals:oi,inNumberRange:us};function Fe(e){return e==null||e===""}const Bf={getDefaultColumnDef:()=>({filterFn:"auto"}),getInitialState:e=>({columnFilters:[],...e}),getDefaultOptions:e=>({onColumnFiltersChange:Me("columnFilters",e),filterFromLeafRows:!1,maxLeafRowFilterDepth:100}),createColumn:(e,t)=>{e.getAutoFilterFn=()=>{const n=t.getCoreRowModel().flatRows[0],o=n==null?void 0:n.getValue(e.id);return typeof o=="string"?Ge.includesString:typeof o=="number"?Ge.inNumberRange:typeof o=="boolean"||o!==null&&typeof o=="object"?Ge.equals:Array.isArray(o)?Ge.arrIncludes:Ge.weakEquals},e.getFilterFn=()=>{var n,o;return Yn(e.columnDef.filterFn)?e.columnDef.filterFn:e.columnDef.filterFn==="auto"?e.getAutoFilterFn():(n=(o=t.options.filterFns)==null?void 0:o[e.columnDef.filterFn])!=null?n:Ge[e.columnDef.filterFn]},e.getCanFilter=()=>{var n,o,s;return((n=e.columnDef.enableColumnFilter)!=null?n:!0)&&((o=t.options.enableColumnFilters)!=null?o:!0)&&((s=t.options.enableFilters)!=null?s:!0)&&!!e.accessorFn},e.getIsFiltered=()=>e.getFilterIndex()>-1,e.getFilterValue=()=>{var n;return(n=t.getState().columnFilters)==null||(n=n.find(o=>o.id===e.id))==null?void 0:n.value},e.getFilterIndex=()=>{var n,o;return(n=(o=t.getState().columnFilters)==null?void 0:o.findIndex(s=>s.id===e.id))!=null?n:-1},e.setFilterValue=n=>{t.setColumnFilters(o=>{const s=e.getFilterFn(),r=o==null?void 0:o.find(u=>u.id===e.id),a=ot(n,r?r.value:void 0);if(or(s,a,e)){var l;return(l=o==null?void 0:o.filter(u=>u.id!==e.id))!=null?l:[]}const c={id:e.id,value:a};if(r){var d;return(d=o==null?void 0:o.map(u=>u.id===e.id?c:u))!=null?d:[]}return o!=null&&o.length?[...o,c]:[c]})}},createRow:(e,t)=>{e.columnFilters={},e.columnFiltersMeta={}},createTable:e=>{e.setColumnFilters=t=>{const n=e.getAllLeafColumns(),o=s=>{var r;return(r=ot(t,s))==null?void 0:r.filter(a=>{const l=n.find(c=>c.id===a.id);if(l){const c=l.getFilterFn();if(or(c,a.value,l))return!1}return!0})};e.options.onColumnFiltersChange==null||e.options.onColumnFiltersChange(o)},e.resetColumnFilters=t=>{var n,o;e.setColumnFilters(t?[]:(n=(o=e.initialState)==null?void 0:o.columnFilters)!=null?n:[])},e.getPreFilteredRowModel=()=>e.getCoreRowModel(),e.getFilteredRowModel=()=>(!e._getFilteredRowModel&&e.options.getFilteredRowModel&&(e._getFilteredRowModel=e.options.getFilteredRowModel(e)),e.options.manualFiltering||!e._getFilteredRowModel?e.getPreFilteredRowModel():e._getFilteredRowModel())}};function or(e,t,n){return(e&&e.autoRemove?e.autoRemove(t,n):!1)||typeof t>"u"||typeof t=="string"&&!t}const Vf=(e,t,n)=>n.reduce((o,s)=>{const r=s.getValue(e);return o+(typeof r=="number"?r:0)},0),Uf=(e,t,n)=>{let o;return n.forEach(s=>{const r=s.getValue(e);r!=null&&(o>r||o===void 0&&r>=r)&&(o=r)}),o},Gf=(e,t,n)=>{let o;return n.forEach(s=>{const r=s.getValue(e);r!=null&&(o<r||o===void 0&&r>=r)&&(o=r)}),o},Yf=(e,t,n)=>{let o,s;return n.forEach(r=>{const a=r.getValue(e);a!=null&&(o===void 0?a>=a&&(o=s=a):(o>a&&(o=a),s<a&&(s=a)))}),[o,s]},Xf=(e,t)=>{let n=0,o=0;if(t.forEach(s=>{let r=s.getValue(e);r!=null&&(r=+r)>=r&&(++n,o+=r)}),n)return o/n},Kf=(e,t)=>{if(!t.length)return;const n=t.map(r=>r.getValue(e));if(!Ff(n))return;if(n.length===1)return n[0];const o=Math.floor(n.length/2),s=n.sort((r,a)=>r-a);return n.length%2!==0?s[o]:(s[o-1]+s[o])/2},qf=(e,t)=>Array.from(new Set(t.map(n=>n.getValue(e))).values()),Zf=(e,t)=>new Set(t.map(n=>n.getValue(e))).size,Jf=(e,t)=>t.length,ro={sum:Vf,min:Uf,max:Gf,extent:Yf,mean:Xf,median:Kf,unique:qf,uniqueCount:Zf,count:Jf},Qf={getDefaultColumnDef:()=>({aggregatedCell:e=>{var t,n;return(t=(n=e.getValue())==null||n.toString==null?void 0:n.toString())!=null?t:null},aggregationFn:"auto"}),getInitialState:e=>({grouping:[],...e}),getDefaultOptions:e=>({onGroupingChange:Me("grouping",e),groupedColumnMode:"reorder"}),createColumn:(e,t)=>{e.toggleGrouping=()=>{t.setGrouping(n=>n!=null&&n.includes(e.id)?n.filter(o=>o!==e.id):[...n??[],e.id])},e.getCanGroup=()=>{var n,o;return((n=e.columnDef.enableGrouping)!=null?n:!0)&&((o=t.options.enableGrouping)!=null?o:!0)&&(!!e.accessorFn||!!e.columnDef.getGroupingValue)},e.getIsGrouped=()=>{var n;return(n=t.getState().grouping)==null?void 0:n.includes(e.id)},e.getGroupedIndex=()=>{var n;return(n=t.getState().grouping)==null?void 0:n.indexOf(e.id)},e.getToggleGroupingHandler=()=>{const n=e.getCanGroup();return()=>{n&&e.toggleGrouping()}},e.getAutoAggregationFn=()=>{const n=t.getCoreRowModel().flatRows[0],o=n==null?void 0:n.getValue(e.id);if(typeof o=="number")return ro.sum;if(Object.prototype.toString.call(o)==="[object Date]")return ro.extent},e.getAggregationFn=()=>{var n,o;if(!e)throw new Error;return Yn(e.columnDef.aggregationFn)?e.columnDef.aggregationFn:e.columnDef.aggregationFn==="auto"?e.getAutoAggregationFn():(n=(o=t.options.aggregationFns)==null?void 0:o[e.columnDef.aggregationFn])!=null?n:ro[e.columnDef.aggregationFn]}},createTable:e=>{e.setGrouping=t=>e.options.onGroupingChange==null?void 0:e.options.onGroupingChange(t),e.resetGrouping=t=>{var n,o;e.setGrouping(t?[]:(n=(o=e.initialState)==null?void 0:o.grouping)!=null?n:[])},e.getPreGroupedRowModel=()=>e.getFilteredRowModel(),e.getGroupedRowModel=()=>(!e._getGroupedRowModel&&e.options.getGroupedRowModel&&(e._getGroupedRowModel=e.options.getGroupedRowModel(e)),e.options.manualGrouping||!e._getGroupedRowModel?e.getPreGroupedRowModel():e._getGroupedRowModel())},createRow:(e,t)=>{e.getIsGrouped=()=>!!e.groupingColumnId,e.getGroupingValue=n=>{if(e._groupingValuesCache.hasOwnProperty(n))return e._groupingValuesCache[n];const o=t.getColumn(n);return o!=null&&o.columnDef.getGroupingValue?(e._groupingValuesCache[n]=o.columnDef.getGroupingValue(e.original),e._groupingValuesCache[n]):e.getValue(n)},e._groupingValuesCache={}},createCell:(e,t,n,o)=>{e.getIsGrouped=()=>t.getIsGrouped()&&t.id===n.groupingColumnId,e.getIsPlaceholder=()=>!e.getIsGrouped()&&t.getIsGrouped(),e.getIsAggregated=()=>{var s;return!e.getIsGrouped()&&!e.getIsPlaceholder()&&!!((s=n.subRows)!=null&&s.length)}}};function eg(e,t,n){if(!(t!=null&&t.length)||!n)return e;const o=e.filter(r=>!t.includes(r.id));return n==="remove"?o:[...t.map(r=>e.find(a=>a.id===r)).filter(Boolean),...o]}const tg={getInitialState:e=>({columnOrder:[],...e}),getDefaultOptions:e=>({onColumnOrderChange:Me("columnOrder",e)}),createColumn:(e,t)=>{e.getIndex=J(n=>[Wt(t,n)],n=>n.findIndex(o=>o.id===e.id),Q(t.options,"debugColumns")),e.getIsFirstColumn=n=>{var o;return((o=Wt(t,n)[0])==null?void 0:o.id)===e.id},e.getIsLastColumn=n=>{var o;const s=Wt(t,n);return((o=s[s.length-1])==null?void 0:o.id)===e.id}},createTable:e=>{e.setColumnOrder=t=>e.options.onColumnOrderChange==null?void 0:e.options.onColumnOrderChange(t),e.resetColumnOrder=t=>{var n;e.setColumnOrder(t?[]:(n=e.initialState.columnOrder)!=null?n:[])},e._getOrderColumnsFn=J(()=>[e.getState().columnOrder,e.getState().grouping,e.options.groupedColumnMode],(t,n,o)=>s=>{let r=[];if(!(t!=null&&t.length))r=s;else{const a=[...t],l=[...s];for(;l.length&&a.length;){const c=a.shift(),d=l.findIndex(u=>u.id===c);d>-1&&r.push(l.splice(d,1)[0])}r=[...r,...l]}return eg(r,n,o)},Q(e.options,"debugTable"))}},io=()=>({left:[],right:[]}),ng={getInitialState:e=>({columnPinning:io(),...e}),getDefaultOptions:e=>({onColumnPinningChange:Me("columnPinning",e)}),createColumn:(e,t)=>{e.pin=n=>{const o=e.getLeafColumns().map(s=>s.id).filter(Boolean);t.setColumnPinning(s=>{var r,a;if(n==="right"){var l,c;return{left:((l=s==null?void 0:s.left)!=null?l:[]).filter(g=>!(o!=null&&o.includes(g))),right:[...((c=s==null?void 0:s.right)!=null?c:[]).filter(g=>!(o!=null&&o.includes(g))),...o]}}if(n==="left"){var d,u;return{left:[...((d=s==null?void 0:s.left)!=null?d:[]).filter(g=>!(o!=null&&o.includes(g))),...o],right:((u=s==null?void 0:s.right)!=null?u:[]).filter(g=>!(o!=null&&o.includes(g)))}}return{left:((r=s==null?void 0:s.left)!=null?r:[]).filter(g=>!(o!=null&&o.includes(g))),right:((a=s==null?void 0:s.right)!=null?a:[]).filter(g=>!(o!=null&&o.includes(g)))}})},e.getCanPin=()=>e.getLeafColumns().some(o=>{var s,r,a;return((s=o.columnDef.enablePinning)!=null?s:!0)&&((r=(a=t.options.enableColumnPinning)!=null?a:t.options.enablePinning)!=null?r:!0)}),e.getIsPinned=()=>{const n=e.getLeafColumns().map(l=>l.id),{left:o,right:s}=t.getState().columnPinning,r=n.some(l=>o==null?void 0:o.includes(l)),a=n.some(l=>s==null?void 0:s.includes(l));return r?"left":a?"right":!1},e.getPinnedIndex=()=>{var n,o;const s=e.getIsPinned();return s?(n=(o=t.getState().columnPinning)==null||(o=o[s])==null?void 0:o.indexOf(e.id))!=null?n:-1:0}},createRow:(e,t)=>{e.getCenterVisibleCells=J(()=>[e._getAllVisibleCells(),t.getState().columnPinning.left,t.getState().columnPinning.right],(n,o,s)=>{const r=[...o??[],...s??[]];return n.filter(a=>!r.includes(a.column.id))},Q(t.options,"debugRows")),e.getLeftVisibleCells=J(()=>[e._getAllVisibleCells(),t.getState().columnPinning.left],(n,o)=>(o??[]).map(r=>n.find(a=>a.column.id===r)).filter(Boolean).map(r=>({...r,position:"left"})),Q(t.options,"debugRows")),e.getRightVisibleCells=J(()=>[e._getAllVisibleCells(),t.getState().columnPinning.right],(n,o)=>(o??[]).map(r=>n.find(a=>a.column.id===r)).filter(Boolean).map(r=>({...r,position:"right"})),Q(t.options,"debugRows"))},createTable:e=>{e.setColumnPinning=t=>e.options.onColumnPinningChange==null?void 0:e.options.onColumnPinningChange(t),e.resetColumnPinning=t=>{var n,o;return e.setColumnPinning(t?io():(n=(o=e.initialState)==null?void 0:o.columnPinning)!=null?n:io())},e.getIsSomeColumnsPinned=t=>{var n;const o=e.getState().columnPinning;if(!t){var s,r;return!!((s=o.left)!=null&&s.length||(r=o.right)!=null&&r.length)}return!!((n=o[t])!=null&&n.length)},e.getLeftLeafColumns=J(()=>[e.getAllLeafColumns(),e.getState().columnPinning.left],(t,n)=>(n??[]).map(o=>t.find(s=>s.id===o)).filter(Boolean),Q(e.options,"debugColumns")),e.getRightLeafColumns=J(()=>[e.getAllLeafColumns(),e.getState().columnPinning.right],(t,n)=>(n??[]).map(o=>t.find(s=>s.id===o)).filter(Boolean),Q(e.options,"debugColumns")),e.getCenterLeafColumns=J(()=>[e.getAllLeafColumns(),e.getState().columnPinning.left,e.getState().columnPinning.right],(t,n,o)=>{const s=[...n??[],...o??[]];return t.filter(r=>!s.includes(r.id))},Q(e.options,"debugColumns"))}};function og(e){return e||(typeof document<"u"?document:null)}const un={size:150,minSize:20,maxSize:Number.MAX_SAFE_INTEGER},ao=()=>({startOffset:null,startSize:null,deltaOffset:null,deltaPercentage:null,isResizingColumn:!1,columnSizingStart:[]}),sg={getDefaultColumnDef:()=>un,getInitialState:e=>({columnSizing:{},columnSizingInfo:ao(),...e}),getDefaultOptions:e=>({columnResizeMode:"onEnd",columnResizeDirection:"ltr",onColumnSizingChange:Me("columnSizing",e),onColumnSizingInfoChange:Me("columnSizingInfo",e)}),createColumn:(e,t)=>{e.getSize=()=>{var n,o,s;const r=t.getState().columnSizing[e.id];return Math.min(Math.max((n=e.columnDef.minSize)!=null?n:un.minSize,(o=r??e.columnDef.size)!=null?o:un.size),(s=e.columnDef.maxSize)!=null?s:un.maxSize)},e.getStart=J(n=>[n,Wt(t,n),t.getState().columnSizing],(n,o)=>o.slice(0,e.getIndex(n)).reduce((s,r)=>s+r.getSize(),0),Q(t.options,"debugColumns")),e.getAfter=J(n=>[n,Wt(t,n),t.getState().columnSizing],(n,o)=>o.slice(e.getIndex(n)+1).reduce((s,r)=>s+r.getSize(),0),Q(t.options,"debugColumns")),e.resetSize=()=>{t.setColumnSizing(n=>{let{[e.id]:o,...s}=n;return s})},e.getCanResize=()=>{var n,o;return((n=e.columnDef.enableResizing)!=null?n:!0)&&((o=t.options.enableColumnResizing)!=null?o:!0)},e.getIsResizing=()=>t.getState().columnSizingInfo.isResizingColumn===e.id},createHeader:(e,t)=>{e.getSize=()=>{let n=0;const o=s=>{if(s.subHeaders.length)s.subHeaders.forEach(o);else{var r;n+=(r=s.column.getSize())!=null?r:0}};return o(e),n},e.getStart=()=>{if(e.index>0){const n=e.headerGroup.headers[e.index-1];return n.getStart()+n.getSize()}return 0},e.getResizeHandler=n=>{const o=t.getColumn(e.column.id),s=o==null?void 0:o.getCanResize();return r=>{if(!o||!s||(r.persist==null||r.persist(),lo(r)&&r.touches&&r.touches.length>1))return;const a=e.getSize(),l=e?e.getLeafHeaders().map(w=>[w.column.id,w.column.getSize()]):[[o.id,o.getSize()]],c=lo(r)?Math.round(r.touches[0].clientX):r.clientX,d={},u=(w,b)=>{typeof b=="number"&&(t.setColumnSizingInfo(N=>{var j,C;const I=t.options.columnResizeDirection==="rtl"?-1:1,A=(b-((j=N==null?void 0:N.startOffset)!=null?j:0))*I,T=Math.max(A/((C=N==null?void 0:N.startSize)!=null?C:0),-.999999);return N.columnSizingStart.forEach(E=>{let[y,v]=E;d[y]=Math.round(Math.max(v+v*T,0)*100)/100}),{...N,deltaOffset:A,deltaPercentage:T}}),(t.options.columnResizeMode==="onChange"||w==="end")&&t.setColumnSizing(N=>({...N,...d})))},g=w=>u("move",w),p=w=>{u("end",w),t.setColumnSizingInfo(b=>({...b,isResizingColumn:!1,startOffset:null,startSize:null,deltaOffset:null,deltaPercentage:null,columnSizingStart:[]}))},f=og(n),h={moveHandler:w=>g(w.clientX),upHandler:w=>{f==null||f.removeEventListener("mousemove",h.moveHandler),f==null||f.removeEventListener("mouseup",h.upHandler),p(w.clientX)}},m={moveHandler:w=>(w.cancelable&&(w.preventDefault(),w.stopPropagation()),g(w.touches[0].clientX),!1),upHandler:w=>{var b;f==null||f.removeEventListener("touchmove",m.moveHandler),f==null||f.removeEventListener("touchend",m.upHandler),w.cancelable&&(w.preventDefault(),w.stopPropagation()),p((b=w.touches[0])==null?void 0:b.clientX)}},x=rg()?{passive:!1}:!1;lo(r)?(f==null||f.addEventListener("touchmove",m.moveHandler,x),f==null||f.addEventListener("touchend",m.upHandler,x)):(f==null||f.addEventListener("mousemove",h.moveHandler,x),f==null||f.addEventListener("mouseup",h.upHandler,x)),t.setColumnSizingInfo(w=>({...w,startOffset:c,startSize:a,deltaOffset:0,deltaPercentage:0,columnSizingStart:l,isResizingColumn:o.id}))}}},createTable:e=>{e.setColumnSizing=t=>e.options.onColumnSizingChange==null?void 0:e.options.onColumnSizingChange(t),e.setColumnSizingInfo=t=>e.options.onColumnSizingInfoChange==null?void 0:e.options.onColumnSizingInfoChange(t),e.resetColumnSizing=t=>{var n;e.setColumnSizing(t?{}:(n=e.initialState.columnSizing)!=null?n:{})},e.resetHeaderSizeInfo=t=>{var n;e.setColumnSizingInfo(t?ao():(n=e.initialState.columnSizingInfo)!=null?n:ao())},e.getTotalSize=()=>{var t,n;return(t=(n=e.getHeaderGroups()[0])==null?void 0:n.headers.reduce((o,s)=>o+s.getSize(),0))!=null?t:0},e.getLeftTotalSize=()=>{var t,n;return(t=(n=e.getLeftHeaderGroups()[0])==null?void 0:n.headers.reduce((o,s)=>o+s.getSize(),0))!=null?t:0},e.getCenterTotalSize=()=>{var t,n;return(t=(n=e.getCenterHeaderGroups()[0])==null?void 0:n.headers.reduce((o,s)=>o+s.getSize(),0))!=null?t:0},e.getRightTotalSize=()=>{var t,n;return(t=(n=e.getRightHeaderGroups()[0])==null?void 0:n.headers.reduce((o,s)=>o+s.getSize(),0))!=null?t:0}}};let fn=null;function rg(){if(typeof fn=="boolean")return fn;let e=!1;try{const t={get passive(){return e=!0,!1}},n=()=>{};window.addEventListener("test",n,t),window.removeEventListener("test",n)}catch{e=!1}return fn=e,fn}function lo(e){return e.type==="touchstart"}const ig={getInitialState:e=>({columnVisibility:{},...e}),getDefaultOptions:e=>({onColumnVisibilityChange:Me("columnVisibility",e)}),createColumn:(e,t)=>{e.toggleVisibility=n=>{e.getCanHide()&&t.setColumnVisibility(o=>({...o,[e.id]:n??!e.getIsVisible()}))},e.getIsVisible=()=>{var n,o;const s=e.columns;return(n=s.length?s.some(r=>r.getIsVisible()):(o=t.getState().columnVisibility)==null?void 0:o[e.id])!=null?n:!0},e.getCanHide=()=>{var n,o;return((n=e.columnDef.enableHiding)!=null?n:!0)&&((o=t.options.enableHiding)!=null?o:!0)},e.getToggleVisibilityHandler=()=>n=>{e.toggleVisibility==null||e.toggleVisibility(n.target.checked)}},createRow:(e,t)=>{e._getAllVisibleCells=J(()=>[e.getAllCells(),t.getState().columnVisibility],n=>n.filter(o=>o.column.getIsVisible()),Q(t.options,"debugRows")),e.getVisibleCells=J(()=>[e.getLeftVisibleCells(),e.getCenterVisibleCells(),e.getRightVisibleCells()],(n,o,s)=>[...n,...o,...s],Q(t.options,"debugRows"))},createTable:e=>{const t=(n,o)=>J(()=>[o(),o().filter(s=>s.getIsVisible()).map(s=>s.id).join("_")],s=>s.filter(r=>r.getIsVisible==null?void 0:r.getIsVisible()),Q(e.options,"debugColumns"));e.getVisibleFlatColumns=t("getVisibleFlatColumns",()=>e.getAllFlatColumns()),e.getVisibleLeafColumns=t("getVisibleLeafColumns",()=>e.getAllLeafColumns()),e.getLeftVisibleLeafColumns=t("getLeftVisibleLeafColumns",()=>e.getLeftLeafColumns()),e.getRightVisibleLeafColumns=t("getRightVisibleLeafColumns",()=>e.getRightLeafColumns()),e.getCenterVisibleLeafColumns=t("getCenterVisibleLeafColumns",()=>e.getCenterLeafColumns()),e.setColumnVisibility=n=>e.options.onColumnVisibilityChange==null?void 0:e.options.onColumnVisibilityChange(n),e.resetColumnVisibility=n=>{var o;e.setColumnVisibility(n?{}:(o=e.initialState.columnVisibility)!=null?o:{})},e.toggleAllColumnsVisible=n=>{var o;n=(o=n)!=null?o:!e.getIsAllColumnsVisible(),e.setColumnVisibility(e.getAllLeafColumns().reduce((s,r)=>({...s,[r.id]:n||!(r.getCanHide!=null&&r.getCanHide())}),{}))},e.getIsAllColumnsVisible=()=>!e.getAllLeafColumns().some(n=>!(n.getIsVisible!=null&&n.getIsVisible())),e.getIsSomeColumnsVisible=()=>e.getAllLeafColumns().some(n=>n.getIsVisible==null?void 0:n.getIsVisible()),e.getToggleAllColumnsVisibilityHandler=()=>n=>{var o;e.toggleAllColumnsVisible((o=n.target)==null?void 0:o.checked)}}};function Wt(e,t){return t?t==="center"?e.getCenterVisibleLeafColumns():t==="left"?e.getLeftVisibleLeafColumns():e.getRightVisibleLeafColumns():e.getVisibleLeafColumns()}const ag={createTable:e=>{e._getGlobalFacetedRowModel=e.options.getFacetedRowModel&&e.options.getFacetedRowModel(e,"__global__"),e.getGlobalFacetedRowModel=()=>e.options.manualFiltering||!e._getGlobalFacetedRowModel?e.getPreFilteredRowModel():e._getGlobalFacetedRowModel(),e._getGlobalFacetedUniqueValues=e.options.getFacetedUniqueValues&&e.options.getFacetedUniqueValues(e,"__global__"),e.getGlobalFacetedUniqueValues=()=>e._getGlobalFacetedUniqueValues?e._getGlobalFacetedUniqueValues():new Map,e._getGlobalFacetedMinMaxValues=e.options.getFacetedMinMaxValues&&e.options.getFacetedMinMaxValues(e,"__global__"),e.getGlobalFacetedMinMaxValues=()=>{if(e._getGlobalFacetedMinMaxValues)return e._getGlobalFacetedMinMaxValues()}}},lg={getInitialState:e=>({globalFilter:void 0,...e}),getDefaultOptions:e=>({onGlobalFilterChange:Me("globalFilter",e),globalFilterFn:"auto",getColumnCanGlobalFilter:t=>{var n;const o=(n=e.getCoreRowModel().flatRows[0])==null||(n=n._getAllCellsByColumnId()[t.id])==null?void 0:n.getValue();return typeof o=="string"||typeof o=="number"}}),createColumn:(e,t)=>{e.getCanGlobalFilter=()=>{var n,o,s,r;return((n=e.columnDef.enableGlobalFilter)!=null?n:!0)&&((o=t.options.enableGlobalFilter)!=null?o:!0)&&((s=t.options.enableFilters)!=null?s:!0)&&((r=t.options.getColumnCanGlobalFilter==null?void 0:t.options.getColumnCanGlobalFilter(e))!=null?r:!0)&&!!e.accessorFn}},createTable:e=>{e.getGlobalAutoFilterFn=()=>Ge.includesString,e.getGlobalFilterFn=()=>{var t,n;const{globalFilterFn:o}=e.options;return Yn(o)?o:o==="auto"?e.getGlobalAutoFilterFn():(t=(n=e.options.filterFns)==null?void 0:n[o])!=null?t:Ge[o]},e.setGlobalFilter=t=>{e.options.onGlobalFilterChange==null||e.options.onGlobalFilterChange(t)},e.resetGlobalFilter=t=>{e.setGlobalFilter(t?void 0:e.initialState.globalFilter)}}},cg={getInitialState:e=>({expanded:{},...e}),getDefaultOptions:e=>({onExpandedChange:Me("expanded",e),paginateExpandedRows:!0}),createTable:e=>{let t=!1,n=!1;e._autoResetExpanded=()=>{var o,s;if(!t){e._queue(()=>{t=!0});return}if((o=(s=e.options.autoResetAll)!=null?s:e.options.autoResetExpanded)!=null?o:!e.options.manualExpanding){if(n)return;n=!0,e._queue(()=>{e.resetExpanded(),n=!1})}},e.setExpanded=o=>e.options.onExpandedChange==null?void 0:e.options.onExpandedChange(o),e.toggleAllRowsExpanded=o=>{o??!e.getIsAllRowsExpanded()?e.setExpanded(!0):e.setExpanded({})},e.resetExpanded=o=>{var s,r;e.setExpanded(o?{}:(s=(r=e.initialState)==null?void 0:r.expanded)!=null?s:{})},e.getCanSomeRowsExpand=()=>e.getPrePaginationRowModel().flatRows.some(o=>o.getCanExpand()),e.getToggleAllRowsExpandedHandler=()=>o=>{o.persist==null||o.persist(),e.toggleAllRowsExpanded()},e.getIsSomeRowsExpanded=()=>{const o=e.getState().expanded;return o===!0||Object.values(o).some(Boolean)},e.getIsAllRowsExpanded=()=>{const o=e.getState().expanded;return typeof o=="boolean"?o===!0:!(!Object.keys(o).length||e.getRowModel().flatRows.some(s=>!s.getIsExpanded()))},e.getExpandedDepth=()=>{let o=0;return(e.getState().expanded===!0?Object.keys(e.getRowModel().rowsById):Object.keys(e.getState().expanded)).forEach(r=>{const a=r.split(".");o=Math.max(o,a.length)}),o},e.getPreExpandedRowModel=()=>e.getSortedRowModel(),e.getExpandedRowModel=()=>(!e._getExpandedRowModel&&e.options.getExpandedRowModel&&(e._getExpandedRowModel=e.options.getExpandedRowModel(e)),e.options.manualExpanding||!e._getExpandedRowModel?e.getPreExpandedRowModel():e._getExpandedRowModel())},createRow:(e,t)=>{e.toggleExpanded=n=>{t.setExpanded(o=>{var s;const r=o===!0?!0:!!(o!=null&&o[e.id]);let a={};if(o===!0?Object.keys(t.getRowModel().rowsById).forEach(l=>{a[l]=!0}):a=o,n=(s=n)!=null?s:!r,!r&&n)return{...a,[e.id]:!0};if(r&&!n){const{[e.id]:l,...c}=a;return c}return o})},e.getIsExpanded=()=>{var n;const o=t.getState().expanded;return!!((n=t.options.getIsRowExpanded==null?void 0:t.options.getIsRowExpanded(e))!=null?n:o===!0||o!=null&&o[e.id])},e.getCanExpand=()=>{var n,o,s;return(n=t.options.getRowCanExpand==null?void 0:t.options.getRowCanExpand(e))!=null?n:((o=t.options.enableExpanding)!=null?o:!0)&&!!((s=e.subRows)!=null&&s.length)},e.getIsAllParentsExpanded=()=>{let n=!0,o=e;for(;n&&o.parentId;)o=t.getRow(o.parentId,!0),n=o.getIsExpanded();return n},e.getToggleExpandedHandler=()=>{const n=e.getCanExpand();return()=>{n&&e.toggleExpanded()}}}},_o=0,Oo=10,co=()=>({pageIndex:_o,pageSize:Oo}),dg={getInitialState:e=>({...e,pagination:{...co(),...e==null?void 0:e.pagination}}),getDefaultOptions:e=>({onPaginationChange:Me("pagination",e)}),createTable:e=>{let t=!1,n=!1;e._autoResetPageIndex=()=>{var o,s;if(!t){e._queue(()=>{t=!0});return}if((o=(s=e.options.autoResetAll)!=null?s:e.options.autoResetPageIndex)!=null?o:!e.options.manualPagination){if(n)return;n=!0,e._queue(()=>{e.resetPageIndex(),n=!1})}},e.setPagination=o=>{const s=r=>ot(o,r);return e.options.onPaginationChange==null?void 0:e.options.onPaginationChange(s)},e.resetPagination=o=>{var s;e.setPagination(o?co():(s=e.initialState.pagination)!=null?s:co())},e.setPageIndex=o=>{e.setPagination(s=>{let r=ot(o,s.pageIndex);const a=typeof e.options.pageCount>"u"||e.options.pageCount===-1?Number.MAX_SAFE_INTEGER:e.options.pageCount-1;return r=Math.max(0,Math.min(r,a)),{...s,pageIndex:r}})},e.resetPageIndex=o=>{var s,r;e.setPageIndex(o?_o:(s=(r=e.initialState)==null||(r=r.pagination)==null?void 0:r.pageIndex)!=null?s:_o)},e.resetPageSize=o=>{var s,r;e.setPageSize(o?Oo:(s=(r=e.initialState)==null||(r=r.pagination)==null?void 0:r.pageSize)!=null?s:Oo)},e.setPageSize=o=>{e.setPagination(s=>{const r=Math.max(1,ot(o,s.pageSize)),a=s.pageSize*s.pageIndex,l=Math.floor(a/r);return{...s,pageIndex:l,pageSize:r}})},e.setPageCount=o=>e.setPagination(s=>{var r;let a=ot(o,(r=e.options.pageCount)!=null?r:-1);return typeof a=="number"&&(a=Math.max(-1,a)),{...s,pageCount:a}}),e.getPageOptions=J(()=>[e.getPageCount()],o=>{let s=[];return o&&o>0&&(s=[...new Array(o)].fill(null).map((r,a)=>a)),s},Q(e.options,"debugTable")),e.getCanPreviousPage=()=>e.getState().pagination.pageIndex>0,e.getCanNextPage=()=>{const{pageIndex:o}=e.getState().pagination,s=e.getPageCount();return s===-1?!0:s===0?!1:o<s-1},e.previousPage=()=>e.setPageIndex(o=>o-1),e.nextPage=()=>e.setPageIndex(o=>o+1),e.firstPage=()=>e.setPageIndex(0),e.lastPage=()=>e.setPageIndex(e.getPageCount()-1),e.getPrePaginationRowModel=()=>e.getExpandedRowModel(),e.getPaginationRowModel=()=>(!e._getPaginationRowModel&&e.options.getPaginationRowModel&&(e._getPaginationRowModel=e.options.getPaginationRowModel(e)),e.options.manualPagination||!e._getPaginationRowModel?e.getPrePaginationRowModel():e._getPaginationRowModel()),e.getPageCount=()=>{var o;return(o=e.options.pageCount)!=null?o:Math.ceil(e.getRowCount()/e.getState().pagination.pageSize)},e.getRowCount=()=>{var o;return(o=e.options.rowCount)!=null?o:e.getPrePaginationRowModel().rows.length}}},uo=()=>({top:[],bottom:[]}),ug={getInitialState:e=>({rowPinning:uo(),...e}),getDefaultOptions:e=>({onRowPinningChange:Me("rowPinning",e)}),createRow:(e,t)=>{e.pin=(n,o,s)=>{const r=o?e.getLeafRows().map(c=>{let{id:d}=c;return d}):[],a=s?e.getParentRows().map(c=>{let{id:d}=c;return d}):[],l=new Set([...a,e.id,...r]);t.setRowPinning(c=>{var d,u;if(n==="bottom"){var g,p;return{top:((g=c==null?void 0:c.top)!=null?g:[]).filter(m=>!(l!=null&&l.has(m))),bottom:[...((p=c==null?void 0:c.bottom)!=null?p:[]).filter(m=>!(l!=null&&l.has(m))),...Array.from(l)]}}if(n==="top"){var f,h;return{top:[...((f=c==null?void 0:c.top)!=null?f:[]).filter(m=>!(l!=null&&l.has(m))),...Array.from(l)],bottom:((h=c==null?void 0:c.bottom)!=null?h:[]).filter(m=>!(l!=null&&l.has(m)))}}return{top:((d=c==null?void 0:c.top)!=null?d:[]).filter(m=>!(l!=null&&l.has(m))),bottom:((u=c==null?void 0:c.bottom)!=null?u:[]).filter(m=>!(l!=null&&l.has(m)))}})},e.getCanPin=()=>{var n;const{enableRowPinning:o,enablePinning:s}=t.options;return typeof o=="function"?o(e):(n=o??s)!=null?n:!0},e.getIsPinned=()=>{const n=[e.id],{top:o,bottom:s}=t.getState().rowPinning,r=n.some(l=>o==null?void 0:o.includes(l)),a=n.some(l=>s==null?void 0:s.includes(l));return r?"top":a?"bottom":!1},e.getPinnedIndex=()=>{var n,o;const s=e.getIsPinned();if(!s)return-1;const r=(n=s==="top"?t.getTopRows():t.getBottomRows())==null?void 0:n.map(a=>{let{id:l}=a;return l});return(o=r==null?void 0:r.indexOf(e.id))!=null?o:-1}},createTable:e=>{e.setRowPinning=t=>e.options.onRowPinningChange==null?void 0:e.options.onRowPinningChange(t),e.resetRowPinning=t=>{var n,o;return e.setRowPinning(t?uo():(n=(o=e.initialState)==null?void 0:o.rowPinning)!=null?n:uo())},e.getIsSomeRowsPinned=t=>{var n;const o=e.getState().rowPinning;if(!t){var s,r;return!!((s=o.top)!=null&&s.length||(r=o.bottom)!=null&&r.length)}return!!((n=o[t])!=null&&n.length)},e._getPinnedRows=(t,n,o)=>{var s;return((s=e.options.keepPinnedRows)==null||s?(n??[]).map(a=>{const l=e.getRow(a,!0);return l.getIsAllParentsExpanded()?l:null}):(n??[]).map(a=>t.find(l=>l.id===a))).filter(Boolean).map(a=>({...a,position:o}))},e.getTopRows=J(()=>[e.getRowModel().rows,e.getState().rowPinning.top],(t,n)=>e._getPinnedRows(t,n,"top"),Q(e.options,"debugRows")),e.getBottomRows=J(()=>[e.getRowModel().rows,e.getState().rowPinning.bottom],(t,n)=>e._getPinnedRows(t,n,"bottom"),Q(e.options,"debugRows")),e.getCenterRows=J(()=>[e.getRowModel().rows,e.getState().rowPinning.top,e.getState().rowPinning.bottom],(t,n,o)=>{const s=new Set([...n??[],...o??[]]);return t.filter(r=>!s.has(r.id))},Q(e.options,"debugRows"))}},fg={getInitialState:e=>({rowSelection:{},...e}),getDefaultOptions:e=>({onRowSelectionChange:Me("rowSelection",e),enableRowSelection:!0,enableMultiRowSelection:!0,enableSubRowSelection:!0}),createTable:e=>{e.setRowSelection=t=>e.options.onRowSelectionChange==null?void 0:e.options.onRowSelectionChange(t),e.resetRowSelection=t=>{var n;return e.setRowSelection(t?{}:(n=e.initialState.rowSelection)!=null?n:{})},e.toggleAllRowsSelected=t=>{e.setRowSelection(n=>{t=typeof t<"u"?t:!e.getIsAllRowsSelected();const o={...n},s=e.getPreGroupedRowModel().flatRows;return t?s.forEach(r=>{r.getCanSelect()&&(o[r.id]=!0)}):s.forEach(r=>{delete o[r.id]}),o})},e.toggleAllPageRowsSelected=t=>e.setRowSelection(n=>{const o=typeof t<"u"?t:!e.getIsAllPageRowsSelected(),s={...n};return e.getRowModel().rows.forEach(r=>{Fo(s,r.id,o,!0,e)}),s}),e.getPreSelectedRowModel=()=>e.getCoreRowModel(),e.getSelectedRowModel=J(()=>[e.getState().rowSelection,e.getCoreRowModel()],(t,n)=>Object.keys(t).length?fo(e,n):{rows:[],flatRows:[],rowsById:{}},Q(e.options,"debugTable")),e.getFilteredSelectedRowModel=J(()=>[e.getState().rowSelection,e.getFilteredRowModel()],(t,n)=>Object.keys(t).length?fo(e,n):{rows:[],flatRows:[],rowsById:{}},Q(e.options,"debugTable")),e.getGroupedSelectedRowModel=J(()=>[e.getState().rowSelection,e.getSortedRowModel()],(t,n)=>Object.keys(t).length?fo(e,n):{rows:[],flatRows:[],rowsById:{}},Q(e.options,"debugTable")),e.getIsAllRowsSelected=()=>{const t=e.getFilteredRowModel().flatRows,{rowSelection:n}=e.getState();let o=!!(t.length&&Object.keys(n).length);return o&&t.some(s=>s.getCanSelect()&&!n[s.id])&&(o=!1),o},e.getIsAllPageRowsSelected=()=>{const t=e.getPaginationRowModel().flatRows.filter(s=>s.getCanSelect()),{rowSelection:n}=e.getState();let o=!!t.length;return o&&t.some(s=>!n[s.id])&&(o=!1),o},e.getIsSomeRowsSelected=()=>{var t;const n=Object.keys((t=e.getState().rowSelection)!=null?t:{}).length;return n>0&&n<e.getFilteredRowModel().flatRows.length},e.getIsSomePageRowsSelected=()=>{const t=e.getPaginationRowModel().flatRows;return e.getIsAllPageRowsSelected()?!1:t.filter(n=>n.getCanSelect()).some(n=>n.getIsSelected()||n.getIsSomeSelected())},e.getToggleAllRowsSelectedHandler=()=>t=>{e.toggleAllRowsSelected(t.target.checked)},e.getToggleAllPageRowsSelectedHandler=()=>t=>{e.toggleAllPageRowsSelected(t.target.checked)}},createRow:(e,t)=>{e.toggleSelected=(n,o)=>{const s=e.getIsSelected();t.setRowSelection(r=>{var a;if(n=typeof n<"u"?n:!s,e.getCanSelect()&&s===n)return r;const l={...r};return Fo(l,e.id,n,(a=o==null?void 0:o.selectChildren)!=null?a:!0,t),l})},e.getIsSelected=()=>{const{rowSelection:n}=t.getState();return fs(e,n)},e.getIsSomeSelected=()=>{const{rowSelection:n}=t.getState();return $o(e,n)==="some"},e.getIsAllSubRowsSelected=()=>{const{rowSelection:n}=t.getState();return $o(e,n)==="all"},e.getCanSelect=()=>{var n;return typeof t.options.enableRowSelection=="function"?t.options.enableRowSelection(e):(n=t.options.enableRowSelection)!=null?n:!0},e.getCanSelectSubRows=()=>{var n;return typeof t.options.enableSubRowSelection=="function"?t.options.enableSubRowSelection(e):(n=t.options.enableSubRowSelection)!=null?n:!0},e.getCanMultiSelect=()=>{var n;return typeof t.options.enableMultiRowSelection=="function"?t.options.enableMultiRowSelection(e):(n=t.options.enableMultiRowSelection)!=null?n:!0},e.getToggleSelectedHandler=()=>{const n=e.getCanSelect();return o=>{var s;n&&e.toggleSelected((s=o.target)==null?void 0:s.checked)}}}},Fo=(e,t,n,o,s)=>{var r;const a=s.getRow(t,!0);n?(a.getCanMultiSelect()||Object.keys(e).forEach(l=>delete e[l]),a.getCanSelect()&&(e[t]=!0)):delete e[t],o&&(r=a.subRows)!=null&&r.length&&a.getCanSelectSubRows()&&a.subRows.forEach(l=>Fo(e,l.id,n,o,s))};function fo(e,t){const n=e.getState().rowSelection,o=[],s={},r=function(a,l){return a.map(c=>{var d;const u=fs(c,n);if(u&&(o.push(c),s[c.id]=c),(d=c.subRows)!=null&&d.length&&(c={...c,subRows:r(c.subRows)}),u)return c}).filter(Boolean)};return{rows:r(t.rows),flatRows:o,rowsById:s}}function fs(e,t){var n;return(n=t[e.id])!=null?n:!1}function $o(e,t,n){var o;if(!((o=e.subRows)!=null&&o.length))return!1;let s=!0,r=!1;return e.subRows.forEach(a=>{if(!(r&&!s)&&(a.getCanSelect()&&(fs(a,t)?r=!0:s=!1),a.subRows&&a.subRows.length)){const l=$o(a,t);l==="all"?r=!0:(l==="some"&&(r=!0),s=!1)}}),s?"all":r?"some":!1}const Lo=/([0-9]+)/gm,gg=(e,t,n)=>si(rt(e.getValue(n)).toLowerCase(),rt(t.getValue(n)).toLowerCase()),pg=(e,t,n)=>si(rt(e.getValue(n)),rt(t.getValue(n))),hg=(e,t,n)=>gs(rt(e.getValue(n)).toLowerCase(),rt(t.getValue(n)).toLowerCase()),mg=(e,t,n)=>gs(rt(e.getValue(n)),rt(t.getValue(n))),xg=(e,t,n)=>{const o=e.getValue(n),s=t.getValue(n);return o>s?1:o<s?-1:0},wg=(e,t,n)=>gs(e.getValue(n),t.getValue(n));function gs(e,t){return e===t?0:e>t?1:-1}function rt(e){return typeof e=="number"?isNaN(e)||e===1/0||e===-1/0?"":String(e):typeof e=="string"?e:""}function si(e,t){const n=e.split(Lo).filter(Boolean),o=t.split(Lo).filter(Boolean);for(;n.length&&o.length;){const s=n.shift(),r=o.shift(),a=parseInt(s,10),l=parseInt(r,10),c=[a,l].sort();if(isNaN(c[0])){if(s>r)return 1;if(r>s)return-1;continue}if(isNaN(c[1]))return isNaN(a)?-1:1;if(a>l)return 1;if(l>a)return-1}return n.length-o.length}const Mt={alphanumeric:gg,alphanumericCaseSensitive:pg,text:hg,textCaseSensitive:mg,datetime:xg,basic:wg},vg={getInitialState:e=>({sorting:[],...e}),getDefaultColumnDef:()=>({sortingFn:"auto",sortUndefined:1}),getDefaultOptions:e=>({onSortingChange:Me("sorting",e),isMultiSortEvent:t=>t.shiftKey}),createColumn:(e,t)=>{e.getAutoSortingFn=()=>{const n=t.getFilteredRowModel().flatRows.slice(10);let o=!1;for(const s of n){const r=s==null?void 0:s.getValue(e.id);if(Object.prototype.toString.call(r)==="[object Date]")return Mt.datetime;if(typeof r=="string"&&(o=!0,r.split(Lo).length>1))return Mt.alphanumeric}return o?Mt.text:Mt.basic},e.getAutoSortDir=()=>{const n=t.getFilteredRowModel().flatRows[0];return typeof(n==null?void 0:n.getValue(e.id))=="string"?"asc":"desc"},e.getSortingFn=()=>{var n,o;if(!e)throw new Error;return Yn(e.columnDef.sortingFn)?e.columnDef.sortingFn:e.columnDef.sortingFn==="auto"?e.getAutoSortingFn():(n=(o=t.options.sortingFns)==null?void 0:o[e.columnDef.sortingFn])!=null?n:Mt[e.columnDef.sortingFn]},e.toggleSorting=(n,o)=>{const s=e.getNextSortingOrder(),r=typeof n<"u"&&n!==null;t.setSorting(a=>{const l=a==null?void 0:a.find(f=>f.id===e.id),c=a==null?void 0:a.findIndex(f=>f.id===e.id);let d=[],u,g=r?n:s==="desc";if(a!=null&&a.length&&e.getCanMultiSort()&&o?l?u="toggle":u="add":a!=null&&a.length&&c!==a.length-1?u="replace":l?u="toggle":u="replace",u==="toggle"&&(r||s||(u="remove")),u==="add"){var p;d=[...a,{id:e.id,desc:g}],d.splice(0,d.length-((p=t.options.maxMultiSortColCount)!=null?p:Number.MAX_SAFE_INTEGER))}else u==="toggle"?d=a.map(f=>f.id===e.id?{...f,desc:g}:f):u==="remove"?d=a.filter(f=>f.id!==e.id):d=[{id:e.id,desc:g}];return d})},e.getFirstSortDir=()=>{var n,o;return((n=(o=e.columnDef.sortDescFirst)!=null?o:t.options.sortDescFirst)!=null?n:e.getAutoSortDir()==="desc")?"desc":"asc"},e.getNextSortingOrder=n=>{var o,s;const r=e.getFirstSortDir(),a=e.getIsSorted();return a?a!==r&&((o=t.options.enableSortingRemoval)==null||o)&&(!(n&&(s=t.options.enableMultiRemove)!=null)||s)?!1:a==="desc"?"asc":"desc":r},e.getCanSort=()=>{var n,o;return((n=e.columnDef.enableSorting)!=null?n:!0)&&((o=t.options.enableSorting)!=null?o:!0)&&!!e.accessorFn},e.getCanMultiSort=()=>{var n,o;return(n=(o=e.columnDef.enableMultiSort)!=null?o:t.options.enableMultiSort)!=null?n:!!e.accessorFn},e.getIsSorted=()=>{var n;const o=(n=t.getState().sorting)==null?void 0:n.find(s=>s.id===e.id);return o?o.desc?"desc":"asc":!1},e.getSortIndex=()=>{var n,o;return(n=(o=t.getState().sorting)==null?void 0:o.findIndex(s=>s.id===e.id))!=null?n:-1},e.clearSorting=()=>{t.setSorting(n=>n!=null&&n.length?n.filter(o=>o.id!==e.id):[])},e.getToggleSortingHandler=()=>{const n=e.getCanSort();return o=>{n&&(o.persist==null||o.persist(),e.toggleSorting==null||e.toggleSorting(void 0,e.getCanMultiSort()?t.options.isMultiSortEvent==null?void 0:t.options.isMultiSortEvent(o):!1))}}},createTable:e=>{e.setSorting=t=>e.options.onSortingChange==null?void 0:e.options.onSortingChange(t),e.resetSorting=t=>{var n,o;e.setSorting(t?[]:(n=(o=e.initialState)==null?void 0:o.sorting)!=null?n:[])},e.getPreSortedRowModel=()=>e.getGroupedRowModel(),e.getSortedRowModel=()=>(!e._getSortedRowModel&&e.options.getSortedRowModel&&(e._getSortedRowModel=e.options.getSortedRowModel(e)),e.options.manualSorting||!e._getSortedRowModel?e.getPreSortedRowModel():e._getSortedRowModel())}},Sg=[Wf,ig,tg,ng,zf,Bf,ag,lg,vg,Qf,cg,dg,ug,fg,sg];function yg(e){var t,n;const o=[...Sg,...(t=e._features)!=null?t:[]];let s={_features:o};const r=s._features.reduce((p,f)=>Object.assign(p,f.getDefaultOptions==null?void 0:f.getDefaultOptions(s)),{}),a=p=>s.options.mergeOptions?s.options.mergeOptions(r,p):{...r,...p};let c={...{},...(n=e.initialState)!=null?n:{}};s._features.forEach(p=>{var f;c=(f=p.getInitialState==null?void 0:p.getInitialState(c))!=null?f:c});const d=[];let u=!1;const g={_features:o,options:{...r,...e},initialState:c,_queue:p=>{d.push(p),u||(u=!0,Promise.resolve().then(()=>{for(;d.length;)d.shift()();u=!1}).catch(f=>setTimeout(()=>{throw f})))},reset:()=>{s.setState(s.initialState)},setOptions:p=>{const f=ot(p,s.options);s.options=a(f)},getState:()=>s.options.state,setState:p=>{s.options.onStateChange==null||s.options.onStateChange(p)},_getRowId:(p,f,h)=>{var m;return(m=s.options.getRowId==null?void 0:s.options.getRowId(p,f,h))!=null?m:`${h?[h.id,f].join("."):f}`},getCoreRowModel:()=>(s._getCoreRowModel||(s._getCoreRowModel=s.options.getCoreRowModel(s)),s._getCoreRowModel()),getRowModel:()=>s.getPaginationRowModel(),getRow:(p,f)=>{let h=(f?s.getPrePaginationRowModel():s.getRowModel()).rowsById[p];if(!h&&(h=s.getCoreRowModel().rowsById[p],!h))throw new Error;return h},_getDefaultColumnDef:J(()=>[s.options.defaultColumn],p=>{var f;return p=(f=p)!=null?f:{},{header:h=>{const m=h.header.column.columnDef;return m.accessorKey?m.accessorKey:m.accessorFn?m.id:null},cell:h=>{var m,x;return(m=(x=h.renderValue())==null||x.toString==null?void 0:x.toString())!=null?m:null},...s._features.reduce((h,m)=>Object.assign(h,m.getDefaultColumnDef==null?void 0:m.getDefaultColumnDef()),{}),...p}},Q(e,"debugColumns")),_getColumnDefs:()=>s.options.columns,getAllColumns:J(()=>[s._getColumnDefs()],p=>{const f=function(h,m,x){return x===void 0&&(x=0),h.map(w=>{const b=Hf(s,w,x,m),N=w;return b.columns=N.columns?f(N.columns,b,x+1):[],b})};return f(p)},Q(e,"debugColumns")),getAllFlatColumns:J(()=>[s.getAllColumns()],p=>p.flatMap(f=>f.getFlatColumns()),Q(e,"debugColumns")),_getAllFlatColumnsById:J(()=>[s.getAllFlatColumns()],p=>p.reduce((f,h)=>(f[h.id]=h,f),{}),Q(e,"debugColumns")),getAllLeafColumns:J(()=>[s.getAllColumns(),s._getOrderColumnsFn()],(p,f)=>{let h=p.flatMap(m=>m.getLeafColumns());return f(h)},Q(e,"debugColumns")),getColumn:p=>s._getAllFlatColumnsById()[p]};Object.assign(s,g);for(let p=0;p<s._features.length;p++){const f=s._features[p];f==null||f.createTable==null||f.createTable(s)}return s}function Ng(){return e=>J(()=>[e.options.data],t=>{const n={rows:[],flatRows:[],rowsById:{}},o=function(s,r,a){r===void 0&&(r=0);const l=[];for(let d=0;d<s.length;d++){const u=ds(e,e._getRowId(s[d],d,a),s[d],d,r,void 0,a==null?void 0:a.id);if(n.flatRows.push(u),n.rowsById[u.id]=u,l.push(u),e.options.getSubRows){var c;u.originalSubRows=e.options.getSubRows(s[d],d),(c=u.originalSubRows)!=null&&c.length&&(u.subRows=o(u.originalSubRows,r+1,u))}}return l};return n.rows=o(t),n},Q(e.options,"debugTable","getRowModel",()=>e._autoResetPageIndex()))}function bg(e){const t=[],n=o=>{var s;t.push(o),(s=o.subRows)!=null&&s.length&&o.getIsExpanded()&&o.subRows.forEach(n)};return e.rows.forEach(n),{rows:t,flatRows:e.flatRows,rowsById:e.rowsById}}function Cg(e,t,n){return n.options.filterFromLeafRows?jg(e,t,n):Ig(e,t,n)}function jg(e,t,n){var o;const s=[],r={},a=(o=n.options.maxLeafRowFilterDepth)!=null?o:100,l=function(c,d){d===void 0&&(d=0);const u=[];for(let p=0;p<c.length;p++){var g;let f=c[p];const h=ds(n,f.id,f.original,f.index,f.depth,void 0,f.parentId);if(h.columnFilters=f.columnFilters,(g=f.subRows)!=null&&g.length&&d<a){if(h.subRows=l(f.subRows,d+1),f=h,t(f)&&!h.subRows.length){u.push(f),r[f.id]=f,s.push(f);continue}if(t(f)||h.subRows.length){u.push(f),r[f.id]=f,s.push(f);continue}}else f=h,t(f)&&(u.push(f),r[f.id]=f,s.push(f))}return u};return{rows:l(e),flatRows:s,rowsById:r}}function Ig(e,t,n){var o;const s=[],r={},a=(o=n.options.maxLeafRowFilterDepth)!=null?o:100,l=function(c,d){d===void 0&&(d=0);const u=[];for(let p=0;p<c.length;p++){let f=c[p];if(t(f)){var g;if((g=f.subRows)!=null&&g.length&&d<a){const m=ds(n,f.id,f.original,f.index,f.depth,void 0,f.parentId);m.subRows=l(f.subRows,d+1),f=m}u.push(f),s.push(f),r[f.id]=f}}return u};return{rows:l(e),flatRows:s,rowsById:r}}function kg(){return e=>J(()=>[e.getPreFilteredRowModel(),e.getState().columnFilters,e.getState().globalFilter],(t,n,o)=>{if(!t.rows.length||!(n!=null&&n.length)&&!o){for(let p=0;p<t.flatRows.length;p++)t.flatRows[p].columnFilters={},t.flatRows[p].columnFiltersMeta={};return t}const s=[],r=[];(n??[]).forEach(p=>{var f;const h=e.getColumn(p.id);if(!h)return;const m=h.getFilterFn();m&&s.push({id:p.id,filterFn:m,resolvedValue:(f=m.resolveFilterValue==null?void 0:m.resolveFilterValue(p.value))!=null?f:p.value})});const a=(n??[]).map(p=>p.id),l=e.getGlobalFilterFn(),c=e.getAllLeafColumns().filter(p=>p.getCanGlobalFilter());o&&l&&c.length&&(a.push("__global__"),c.forEach(p=>{var f;r.push({id:p.id,filterFn:l,resolvedValue:(f=l.resolveFilterValue==null?void 0:l.resolveFilterValue(o))!=null?f:o})}));let d,u;for(let p=0;p<t.flatRows.length;p++){const f=t.flatRows[p];if(f.columnFilters={},s.length)for(let h=0;h<s.length;h++){d=s[h];const m=d.id;f.columnFilters[m]=d.filterFn(f,m,d.resolvedValue,x=>{f.columnFiltersMeta[m]=x})}if(r.length){for(let h=0;h<r.length;h++){u=r[h];const m=u.id;if(u.filterFn(f,m,u.resolvedValue,x=>{f.columnFiltersMeta[m]=x})){f.columnFilters.__global__=!0;break}}f.columnFilters.__global__!==!0&&(f.columnFilters.__global__=!1)}}const g=p=>{for(let f=0;f<a.length;f++)if(p.columnFilters[a[f]]===!1)return!1;return!0};return Cg(t.rows,g,e)},Q(e.options,"debugTable","getFilteredRowModel",()=>e._autoResetPageIndex()))}function Rg(e){return t=>J(()=>[t.getState().pagination,t.getPrePaginationRowModel(),t.options.paginateExpandedRows?void 0:t.getState().expanded],(n,o)=>{if(!o.rows.length)return o;const{pageSize:s,pageIndex:r}=n;let{rows:a,flatRows:l,rowsById:c}=o;const d=s*r,u=d+s;a=a.slice(d,u);let g;t.options.paginateExpandedRows?g={rows:a,flatRows:l,rowsById:c}:g=bg({rows:a,flatRows:l,rowsById:c}),g.flatRows=[];const p=f=>{g.flatRows.push(f),f.subRows.length&&f.subRows.forEach(p)};return g.rows.forEach(p),g},Q(t.options,"debugTable"))}function Eg(){return e=>J(()=>[e.getState().sorting,e.getPreSortedRowModel()],(t,n)=>{if(!n.rows.length||!(t!=null&&t.length))return n;const o=e.getState().sorting,s=[],r=o.filter(c=>{var d;return(d=e.getColumn(c.id))==null?void 0:d.getCanSort()}),a={};r.forEach(c=>{const d=e.getColumn(c.id);d&&(a[c.id]={sortUndefined:d.columnDef.sortUndefined,invertSorting:d.columnDef.invertSorting,sortingFn:d.getSortingFn()})});const l=c=>{const d=c.map(u=>({...u}));return d.sort((u,g)=>{for(let f=0;f<r.length;f+=1){var p;const h=r[f],m=a[h.id],x=m.sortUndefined,w=(p=h==null?void 0:h.desc)!=null?p:!1;let b=0;if(x){const N=u.getValue(h.id),j=g.getValue(h.id),C=N===void 0,I=j===void 0;if(C||I){if(x==="first")return C?-1:1;if(x==="last")return C?1:-1;b=C&&I?0:C?x:-x}}if(b===0&&(b=m.sortingFn(u,g,h.id)),b!==0)return w&&(b*=-1),m.invertSorting&&(b*=-1),b}return u.index-g.index}),d.forEach(u=>{var g;s.push(u),(g=u.subRows)!=null&&g.length&&(u.subRows=l(u.subRows))}),d};return{rows:l(n.rows),flatRows:s,rowsById:n.rowsById}},Q(e.options,"debugTable","getSortedRowModel",()=>e._autoResetPageIndex()))}/**
   * react-table
   *
   * Copyright (c) TanStack
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE.md file in the root directory of this source tree.
   *
   * @license MIT
   */function ps(e,t){return e?Ag(e)?S.createElement(e,t):e:null}function Ag(e){return Tg(e)||typeof e=="function"||Dg(e)}function Tg(e){return typeof e=="function"&&(()=>{const t=Object.getPrototypeOf(e);return t.prototype&&t.prototype.isReactComponent})()}function Dg(e){return typeof e=="object"&&typeof e.$$typeof=="symbol"&&["react.memo","react.forward_ref"].includes(e.$$typeof.description)}function Mg(e){const t={state:{},onStateChange:()=>{},renderFallbackValue:null,...e},[n]=S.useState(()=>({current:yg(t)})),[o,s]=S.useState(()=>n.current.initialState);return n.current.setOptions(r=>({...r,...e,state:{...o,...e.state},onStateChange:a=>{s(a),e.onStateChange==null||e.onStateChange(a)}})),n.current}function Pg({table:e}){return i.jsxs("div",{className:"flex items-center justify-between space-x-2 py-4",children:[i.jsxs("div",{className:"flex-1 text-sm text-muted-foreground",children:[e.getFilteredSelectedRowModel().rows.length," of"," ",e.getFilteredRowModel().rows.length," row(s) selected."]}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx("span",{className:"text-sm",children:"Rows per page:"}),i.jsxs(Pn,{value:`${e.getState().pagination.pageSize}`,onValueChange:t=>{e.setPageSize(Number(t))},children:[i.jsx(_n,{className:"h-8 w-[70px]",children:i.jsx(On,{placeholder:e.getState().pagination.pageSize})}),i.jsx(Fn,{side:"top",children:[10,20,30,40,50].map(t=>i.jsx($n,{value:`${t}`,children:t},t))})]})]}),i.jsxs("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium",children:["Page ",e.getState().pagination.pageIndex+1," of"," ",e.getPageCount()]}),i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsxs(X,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>e.setPageIndex(0),disabled:!e.getCanPreviousPage(),children:[i.jsx("span",{className:"sr-only",children:"Go to first page"}),"<<"]}),i.jsx(X,{variant:"outline",size:"sm",onClick:()=>e.previousPage(),disabled:!e.getCanPreviousPage(),children:"Previous"}),i.jsx(X,{variant:"outline",size:"sm",onClick:()=>e.nextPage(),disabled:!e.getCanNextPage(),children:"Next"}),i.jsxs(X,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>e.setPageIndex(e.getPageCount()-1),disabled:!e.getCanNextPage(),children:[i.jsx("span",{className:"sr-only",children:"Go to last page"}),">>"]})]})]})}function _g({row:e,onRowClick:t}){return i.jsx("tr",{className:`${e.getIsSelected()?"bg-blue-50":""} cursor-pointer`,onClick:()=>t==null?void 0:t(e.original),children:e.getVisibleCells().map(n=>i.jsx("td",{className:"p-3 whitespace-nowrap text-sm border-b",style:{width:`calc(var(--col-${n.column.id}-size) * 1px)`},children:ps(n.column.columnDef.cell,n.getContext())},n.id))},e.id)}function sr({row:e,table:t,onRowClick:n}){const o=e.getIsPinned(),s=o==="top"?e.getPinnedIndex():0,r=o==="bottom"?e.getPinnedIndex():0,a=t.getBottomRows().length,l=33;return i.jsx("tr",{className:`${e.getIsSelected()?"bg-blue-100":"bg-blue-50"} sticky z-10`,style:{top:o==="top"?`${s*l+48}px`:void 0,bottom:o==="bottom"?`${(a-1-r)*l}px`:void 0},onClick:()=>n==null?void 0:n(e.original),children:e.getVisibleCells().map(d=>i.jsx("td",{className:"p-1 whitespace-nowrap text-sm border-b",style:{width:`calc(var(--col-${d.column.id}-size) * 1px)`},children:ps(d.column.columnDef.cell,d.getContext())},d.id))},e.id)}function Og({table:e,columns:t,keepPinnedRows:n,columnSizeVars:o,onRowClick:s}){const r=n?e.getRowModel().rows:e.getCenterRows();return i.jsxs("tbody",{className:"bg- divide-y divide-gray-200",children:[e.getTopRows().map(a=>i.jsx(sr,{row:a,table:e,onRowClick:s},a.id)),r.length>0?r.map(a=>i.jsx(_g,{row:a,onRowClick:s},a.id)):e.getTopRows().length===0&&e.getBottomRows().length===0&&i.jsx("tr",{children:i.jsx("td",{colSpan:t.length,className:"px-4 py-1 text-center text-sm",children:"No results found"})}),e.getBottomRows().map(a=>i.jsx(sr,{row:a,table:e,onRowClick:s},a.id))]})}function Fg({table:e,columns:t,keepPinnedRows:n,columnSizeVars:o,onRowClick:s}){return i.jsx("div",{id:"UiDataTableTable",className:"rounded-md border overflow-x-auto",children:i.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border-separate border-spacing-0",style:{...o,width:e.getTotalSize(),tableLayout:"fixed"},children:[i.jsx("thead",{className:"background sticky top-0 z-20",children:e.getHeaderGroups().map(r=>i.jsx("tr",{children:r.headers.map(a=>i.jsxs("th",{className:"relative px-2 py-3 text-left text-xs font-medium uppercase tracking-wider bg-primary-foreground select-none border-b",style:{width:`calc(var(--header-${a.id}-size) * 1px)`},colSpan:a.colSpan,children:[i.jsxs("div",{className:"flex items-center space-x-1 cursor-pointer",onClick:a.column.getToggleSortingHandler(),children:[a.isPlaceholder?null:ps(a.column.columnDef.header,a.getContext()),i.jsx("span",{children:{asc:"â–²",desc:"â–¼"}[a.column.getIsSorted()]??null})]}),a.column.getCanResize()&&i.jsx("div",{onDoubleClick:()=>a.column.resetSize(),onMouseDown:a.getResizeHandler(),onTouchStart:a.getResizeHandler(),className:`resizer ${a.column.getIsResizing()?"isResizing":""}`})]},a.id))},r.id))}),i.jsx(Og,{table:e,columns:t,onRowClick:s,keepPinnedRows:n,columnSizeVars:o})]})})}const $g=({value:e,onChange:t,debounce:n=200,...o})=>{const[s,r]=S.useState(e);return S.useEffect(()=>{r(e)},[e]),S.useEffect(()=>{const a=setTimeout(()=>{t(s)},n);return()=>clearTimeout(a)},[s,t,n]),i.jsx(it,{...o,value:s,onChange:a=>r(a.target.value)})};function go(e,t,n={}){const{renderDisplay:o=c=>c,width:s,inputType:r="text"}=n,a=s?parseInt(s.replace("px",""),10):void 0;return{accessorKey:e,header:()=>i.jsx("div",{children:t}),size:a,cell:({row:c,column:d,table:u,getValue:g})=>{const p=g(),{isEditing:f,updateData:h}=u.options.meta||{},[m,x]=S.useState(p);S.useEffect(()=>{x(p)},[p]);const w=()=>{h&&h(c.index,d.id,m)};if(f)return i.jsx("input",{type:r,value:m??"",onChange:N=>x(N.target.value),onBlur:w,className:"w-full p-1 border rounded bg-transparent"});const b=c.original;return i.jsx(i.Fragment,{children:o(p,b)})}}}function Lg({data:e,columns:t,keepPinnedRows:n,filterField:o,filterPlaceholder:s,onRowClick:r,onAddNewRow:a,topRight:l,isEditing:c,onDataUpdate:d}){const[u,g]=S.useState(""),[p,f]=S.useState({}),[{pageIndex:h,pageSize:m},x]=S.useState({pageIndex:0,pageSize:10}),[w,b]=S.useState([]),[N,j]=S.useState({top:[],bottom:[]}),[C,I]=S.useState({}),A=Mg({data:e,columns:t,keepPinnedRows:n,columnResizeMode:"onChange",state:{globalFilter:u,rowSelection:p,pagination:{pageIndex:h,pageSize:m},sorting:w,rowPinning:N,columnSizing:C},meta:{isEditing:c,updateData:d},initialState:{pagination:{pageIndex:0,pageSize:10}},onPaginationChange:x,onSortingChange:b,onRowPinningChange:j,onColumnSizingChange:I,onGlobalFilterChange:g,enableRowSelection:!0,onRowSelectionChange:f,getCoreRowModel:Ng(),getFilteredRowModel:kg(),getPaginationRowModel:Rg(),getSortedRowModel:Eg(),globalFilterFn:(E,y,v)=>{const k=v.toLowerCase();if(o){const R=E.getValue(o);return String(R).toLowerCase().includes(k)}for(const R in E.original){const M=E.original[R];if(typeof M=="string"&&M.toLowerCase().includes(k))return!0}return!1}}),T=S.useMemo(()=>{const E=A.getFlatHeaders(),y={};for(let v=0;v<E.length;v++){const k=E[v];y[`--header-${k.id}-size`]=k.getSize(),y[`--col-${k.column.id}-size`]=k.column.getSize()}return y},[A.getState().columnSizing,A.getState().columnSizingInfo]);return i.jsxs("div",{className:"",children:[i.jsxs("div",{className:"flex items-center justify-between py-4 space-x-4",children:[i.jsx($g,{placeholder:s||"Filter all columns...",value:u??"",onChange:E=>g(String(E)),className:"max-w-sm"}),i.jsxs("div",{className:"flex items-center space-x-2",children:[l," ",a&&i.jsx(X,{onClick:a,size:"sm",children:"Add New Row"})]})]}),i.jsx(Fg,{table:A,columns:t,onRowClick:r,keepPinnedRows:n,columnSizeVars:T}),i.jsx(Pg,{table:A})]})}const Hg=[go("id","ID",{width:"50px"}),go("name","Name",{width:"150px"}),go("value","Value",{width:"100px"})],Wg=[{id:"1",name:"Item A",value:100},{id:"2",name:"Item B",value:200},{id:"3",name:"Item C",value:150}],zg=({node:e})=>{const t=Wg,n=Hg;return i.jsx("div",{style:{width:"100%",height:"100%",overflow:"auto"},children:i.jsx(Lg,{data:t,columns:n})})},Bg=({node:e,preventEdit:t})=>{var A;const n=S.useRef(null),o=S.useRef(null),[s,r]=S.useState(!1),[a,l]=S.useState(e.title||""),[c,d]=S.useState(e.content||""),u=$.getState(),g=u.updateNode,p=u.setMode,f=u.uiState.nodeToFocusId,h=(A=u.projectCanvas.getActive())==null?void 0:A.coreState,m=(h==null?void 0:h.selectedNodes)??[],x=m.some(T=>T.id===e.id),w=x&&f===e.id,b=T=>{l(T.target.value)},N=T=>{d(T.target.value)},j=S.useCallback(()=>{var T;g(e.id,{title:a,content:c,isEditing:!1}),r(!1),(T=window.getSelection())==null||T.removeAllRanges()},[e.id,g,a,c]),C=S.useCallback(()=>{x&&m.length<=1&&!t&&(r(!0),g(e.id,{isEditing:!0}))},[x,m.length,t,g,e.id]),I=S.useCallback(T=>{var E,y;if(T.key==="Escape"){j(),p(H.SELECT),(E=n.current)==null||E.blur(),(y=o.current)==null||y.blur();return}},[j,p]);return S.useEffect(()=>{w&&s&&n.current&&n.current.focus()},[w,s]),S.useEffect(()=>{l(e.title||""),d(e.content||"")},[e.title,e.content]),i.jsxs("div",{className:"w-full h-full flex flex-col",children:[i.jsx("div",{className:"title-section border-b",children:i.jsx("input",{ref:n,type:"text",value:a,onChange:b,onBlur:j,onMouseDown:C,onKeyDown:I,placeholder:"Title...",className:ae("w-full px-2 py-1","text-sm font-semibold","border-none focus:outline-none","bg-transparent",{"pointer-events-none":t,"cursor-text":s,"cursor-default":!s}),readOnly:!s})}),i.jsx("div",{className:"content-section flex-1",children:i.jsx("textarea",{ref:o,value:c,onChange:N,onBlur:j,onMouseDown:C,onKeyDown:I,placeholder:"Content...",className:ae("w-full h-full","px-2 py-1","text-sm","border-none focus:outline-none","bg-transparent","resize-none","overflow-hidden",{"pointer-events-none":t,"cursor-text":s,"cursor-default":!s}),readOnly:!s})})]})};function ri({tags:e,onAddTag:t,onRemoveTag:n,quickTags:o=["left","right","todo","important"],className:s}){const[r,a]=S.useState(""),l=()=>{const c=r.trim();c&&(t(c),a(""))};return i.jsxs("div",{className:ve("tag-management-ui space-y-3",s),"data-test":"tag-management-ui-container",children:[e.length>0&&i.jsxs("div",{className:"current-tags space-y-2","data-test":"tag-management-current-tags-section",children:[i.jsx("div",{className:"tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-current-tags-label",children:"Current Tags"}),i.jsx("div",{className:"tags-list flex flex-wrap gap-1","data-test":"tag-management-current-tags-list",children:e.map(c=>i.jsxs(Vt,{variant:"secondary",className:"tag-badge text-xs flex items-center gap-1","data-test":`tag-management-tag-${c}`,children:[c,i.jsx("button",{onClick:()=>n(c),className:"tag-remove-button ml-1 hover:text-destructive",title:"Remove tag","data-test":`tag-management-remove-tag-${c}-button`,children:i.jsx(Ze,{className:"h-3 w-3"})})]},c))})]}),i.jsxs("div",{className:"add-tag-section space-y-2","data-test":"tag-management-add-tag-section",children:[i.jsx("div",{className:"add-tag-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-add-tag-label",children:"Add Tag"}),i.jsxs("div",{className:"add-tag-input-group flex gap-2","data-test":"tag-management-add-tag-input-group",children:[i.jsx(it,{placeholder:"Enter tag name...",value:r,onChange:c=>a(c.target.value),onKeyDown:c=>{c.key==="Enter"&&r.trim()&&(c.preventDefault(),l())},className:"tag-input h-8 text-sm",autoFocus:!0,"data-test":"tag-management-tag-input"}),i.jsx(X,{variant:"default",size:"sm",className:"add-tag-button h-8",onClick:l,disabled:!r.trim(),"data-test":"tag-management-add-tag-button",children:i.jsx(Oe,{className:"h-4 w-4"})})]})]}),o.length>0&&i.jsxs("div",{className:"quick-tags-section space-y-2","data-test":"tag-management-quick-tags-section",children:[i.jsx("div",{className:"quick-tags-label text-xs font-semibold text-muted-foreground","data-test":"tag-management-quick-tags-label",children:"Quick Add"}),i.jsx("div",{className:"quick-tags-list flex flex-wrap gap-1","data-test":"tag-management-quick-tags-list",children:o.map(c=>{const d=e.includes(c);return i.jsx(Vt,{variant:d?"default":"outline",className:ve("quick-tag cursor-pointer hover:opacity-80",d&&"opacity-50 cursor-not-allowed"),onClick:()=>{d||t(c)},"data-test":`tag-management-quick-tag-${c}`,children:c},c)})})]})]})}function Vg({nodeId:e,tags:t=[],className:n}){const[o,s]=S.useState(!1),r=S.useMemo(()=>t.map(c=>c.title),[t]),a=S.useCallback(c=>{const d=$.getState(),u={id:Math.random().toString(36).slice(2,10),title:c};d.addTagToNode(e,u)},[e]),l=S.useCallback(c=>{const d=$.getState(),u=t.find(g=>g.title===c);u&&d.removeTagFromNode(e,u.id)},[e,t]);return i.jsxs(Uo,{open:o,onOpenChange:s,"data-test":"tag-selector-popover",children:[i.jsx(Go,{asChild:!0,children:i.jsx(Zt,{className:n,onClick:c=>{c.stopPropagation()},title:"Manage tags",variant:"ghost","data-test":"tag-selector-trigger-button",children:i.jsx(bn,{})})}),i.jsx(Yo,{className:"tag-selector-popover w-64 p-3",align:"start","data-test":"tag-selector-popover-content",children:i.jsx(ri,{tags:r,onAddTag:a,onRemoveTag:l})})]})}function Ug({node:e,className:t}){const n=o=>{var d;o.stopPropagation();const s=$.getState(),r=(d=s.projectCanvas.getActive())==null?void 0:d.viewState,a=s.updateNode;if(!r)return;const{scale:l,offset:c}=r;if(e.isPinned){const u=(e.x-c.x)/l,g=(e.y-c.y)/l;a(e.id,{isPinned:!1,x:u,y:g})}else{const u=e.x*l+c.x,g=e.y*l+c.y;a(e.id,{isPinned:!0,x:u,y:g})}};return i.jsx(Zt,{className:t,onClick:n,title:e.isPinned?"Unpin from viewport":"Pin to viewport",variant:"ghost",children:e.isPinned?i.jsx(va,{className:"h-4 w-4 text-blue-500"}):i.jsx(Sa,{className:"h-4 w-4"})})}const{DEFAULT_NODE_WIDTH:Gg}=q,Yg=({node:e,isSingleNodeSelected:t})=>{const[n,o]=S.useState(!1),[s,r]=S.useState(e.title||""),a=S.useRef(null);S.useEffect(()=>{r(e.title||"")},[e.title]),S.useEffect(()=>()=>{const d=s.trim();d&&d!==e.title&&$.getState().updateNodeTitle(e.id,d)},[e.id,s]),S.useEffect(()=>{n&&a.current&&(a.current.focus(),a.current.select())},[n]);const l=S.useCallback(()=>{const d=s.trim();d&&d!==e.title&&$.getState().updateNodeTitle(e.id,d),o(!1)},[e.id,s,e.title]),c=S.useCallback(d=>{d.key==="Enter"?(d.preventDefault(),l()):d.key==="Escape"&&(d.preventDefault(),r(e.title||""),o(!1))},[l,e.title]);return!e.title&&!t?null:i.jsx("div",{className:"absolute flex items-center gap-1 pointer-events-auto",style:{top:"-28px",left:"0px",maxWidth:`${e.width??Gg}px`},children:t?i.jsx("input",{ref:a,type:"text",value:s,onChange:d=>r(d.target.value),onBlur:l,onKeyDown:c,placeholder:"Add title...",className:"text-xs px-2 py-0.5 bg-background/90 w-full",onClick:d=>{d.stopPropagation(),o(!0)}}):e.title?i.jsx("div",{className:"text-xs px-2 py-0.5 bg-background/90 truncate",children:e.title}):null})};function Xg(e,t){return e.node.title===t.node.title&&e.node.width===t.node.width&&e.isSingleNodeSelected===t.isSingleNodeSelected}const Kg=je.memo(Yg,Xg),{DEFAULT_NODE_WIDTH:qg}=q;function Zg({node:e,isSelected:t,scale:n}){const s=(typeof e.content=="string"?e.content:"").split(`

`).filter(g=>g.trim().length>0),r=e.width??qg;e.height??q.DEFAULT_NODE_HEIGHT;const a=24,c=document.createElement("canvas").getContext("2d"),d=[];if(c){c.font=getComputedStyle(document.body).font;for(const g of s){const p=g.split(`
`);let f=0;for(const x of p){if(x.trim()===""){f++;continue}const w=x.split(" ");let b="",N=1;for(let j=0;j<w.length;j++){const C=w[j],I=b+(b?" ":"")+C;c.measureText(I).width>r&&b!==""?(N++,b=C):b=I}f+=N}const h=g.length;let m;h<100?m=40+h/100*20:h<300?m=60+(h-100)/200*25:m=Math.min(95,85+(h-300)/500*10),d.push({lines:f,widthPercent:Math.round(m),charCount:h})}}return{jsx:i.jsx("div",{className:"w-full h-full flex flex-col gap-2 p-2",children:d.map((g,p)=>i.jsx("div",{className:"rounded flex flex-col gap-[2px]",style:{height:`${g.lines*a}px`,width:`${g.widthPercent}%`,backgroundColor:"transparent"},children:Array.from({length:g.lines}).map((f,h)=>i.jsx("div",{className:"rounded",style:{height:`${a-4}px`,width:"100%",backgroundColor:t?"#93c5fd":"hsl(var(--foreground))"}},h))},p))}),blockMetrics:d}}const ii=S.createContext(null),ai=()=>{const e=S.useContext(ii);if(!e)throw new Error("useWorkflowExecution must be used within a WorkflowExecutionProvider. Make sure CanvasAppV2 wraps its content with the provider.");return e},Jg=({children:e,value:t})=>i.jsx(ii.Provider,{value:t,children:e}),li=({nodeId:e,label:t="Execute Workflow",className:n})=>{const[o,s]=S.useState(!1),[r,a]=S.useState(null),l=ai(),{executeWorkflow:c}=l,d=g=>{g.stopPropagation()},u=async g=>{g.stopPropagation(),s(!0),a(null);try{await c(!1,e)}catch(p){const f=p instanceof Error?p.message:String(p);a(f)}finally{s(!1)}};return i.jsxs("div",{className:"w-full",children:[i.jsx(X,{"data-test":"workflow-execute-button",onPointerDown:d,onClick:u,disabled:o,className:ve("w-full bg-primary hover:bg-primary/70 text-primary-foreground","disabled:bg-muted disabled:text-muted-foreground disabled:cursor-not-allowed",n),size:"sm",children:o?i.jsxs(i.Fragment,{children:[i.jsx(Hn,{className:"w-4 h-4 animate-spin"}),"Executing..."]}):i.jsxs(i.Fragment,{children:[i.jsx(Ln,{className:"w-4 h-4"}),t]})}),r&&i.jsxs("div",{className:"text-xs text-destructive mt-1",children:["Error: ",r]})]})},Qg=({executionState:e,duration:t,className:n})=>{if(!e||e==="idle")return null;const s={pending:{color:"bg-gray-500",textColor:"text-white",icon:null,label:"Pending"},running:{color:"bg-blue-500",textColor:"text-white",icon:i.jsx(Hn,{className:"w-3 h-3 animate-spin"}),label:"Running"},success:{color:"bg-green-500",textColor:"text-white",icon:i.jsx(qo,{className:"w-3 h-3"}),label:"Success"},error:{color:"bg-red-500",textColor:"text-white",icon:i.jsx(Ze,{className:"w-3 h-3"}),label:"Error"}}[e];return i.jsxs("div",{className:ve("absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium","flex items-center gap-1",s.color,s.textColor,n),children:[s.icon,i.jsx("span",{children:s.label}),t&&i.jsxs("span",{className:"ml-1",children:["(",t,"ms)"]})]})},rr=[{value:"title",label:"Title",type:"string"},{value:"content",label:"Content",type:"string"},{value:"x",label:"X Position",type:"number"},{value:"y",label:"Y Position",type:"number"},{value:"width",label:"Width",type:"number"},{value:"height",label:"Height",type:"number"},{value:"styles.backgroundColor",label:"Background Color",type:"string"},{value:"styles.textColor",label:"Text Color",type:"string"},{value:"styles.fontSize",label:"Font Size",type:"string"},{value:"styles.fontWeight",label:"Font Weight",type:"string"},{value:"isPinned",label:"Is Pinned",type:"boolean"}],ep=({isVisible:e,onClose:t,allNodes:n,currentConfig:o,onSave:s,initialPosition:r,initialSize:a})=>{const[l,c]=S.useState((o==null?void 0:o.mode)||"simple"),[d,u]=S.useState(()=>o!=null&&o.simpleFieldUpdates&&o.simpleFieldUpdates.length>0?o.simpleFieldUpdates:o!=null&&o.simpleConfig?[{field:o.simpleConfig.field,template:o.simpleConfig.template}]:[{field:"content",template:"{{loop.current}}"}]),[g,p]=S.useState(()=>(o==null?void 0:o.mode)==="advanced"&&(o!=null&&o.targets)?o.targets.map(y=>({nodeId:y.nodeId,fields:Object.entries(y.updates).map(([v,k])=>({field:v,value:String(k)}))})):[]),f=()=>{u([...d,{field:"content",template:"{{loop.current}}"}])},h=y=>{d.length!==1&&u(d.filter((v,k)=>k!==y))},m=(y,v)=>{const k=[...d];k[y].field=v,u(k)},x=(y,v)=>{const k=[...d];k[y].template=v,u(k)},w=()=>{const y=d.filter(k=>k.template.trim());if(y.length===0)return;const v=n.map(k=>({nodeId:k.id,fields:y.map(({field:R,template:M})=>({field:R,value:M}))}));p(v)},b=()=>{p([...g,{nodeId:"",fields:[{field:"title",value:""}]}])},N=y=>{p(g.filter((v,k)=>k!==y))},j=(y,v)=>{const k=[...g];k[y].nodeId=v,p(k)},C=y=>{const v=[...g];v[y].fields.push({field:"title",value:""}),p(v)},I=(y,v)=>{const k=[...g];k[y].fields=k[y].fields.filter((R,M)=>M!==v),p(k)},A=(y,v,k)=>{const R=[...g];R[y].fields[v].field=k,p(R)},T=(y,v,k)=>{const R=[...g];R[y].fields[v].value=k,p(R)},E=()=>{let y=[];if(l==="simple"){const v=d.filter(k=>k.template.trim());if(v.length===0)return;y=n.map(k=>{const R={};return v.forEach(({field:M,template:D})=>{if(M.includes(".")){const _=M.split(".");let L=R;for(let P=0;P<_.length-1;P++)L[_[P]]||(L[_[P]]={}),L=L[_[P]];L[_[_.length-1]]=D}else R[M]=D}),{nodeId:k.id,updates:R}})}else if(y=g.filter(v=>v.nodeId&&v.fields.length>0).map(v=>{const k={};return v.fields.forEach(({field:R,value:M})=>{if(M)if(R.includes(".")){const D=R.split(".");let _=k;for(let L=0;L<D.length-1;L++)_[D[L]]||(_[D[L]]={}),_=_[D[L]];_[D[D.length-1]]=M}else k[R]=M}),{nodeId:v.nodeId,updates:k}}),y.length===0)return;s({mode:l,dataSource:(o==null?void 0:o.dataSource)||"row_1",targets:y,simpleFieldUpdates:l==="simple"?d:void 0}),t()};return i.jsx(We,{isVisible:e,onClose:t,title:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{children:"Configure Node Update"}),i.jsx(ft,{children:i.jsxs(gt,{children:[i.jsx(pt,{asChild:!0,children:i.jsx(jt,{size:14,className:"text-muted-foreground cursor-help"})}),i.jsx(ht,{side:"right",className:"max-w-xs",children:i.jsxs("div",{className:"text-xs space-y-1",children:[i.jsxs("div",{children:[i.jsx("strong",{children:"Templates:"})," ",i.jsx("code",{children:"{{loop.current}}"}),", ",i.jsx("code",{children:"{{loop.index}}"}),", ",i.jsx("code",{children:"{{loop.total}}"})]}),i.jsxs("div",{children:[i.jsx("strong",{children:"Default:"})," ",i.jsx("code",{children:"{{loop.current}}"})," replaces entire value"]}),i.jsxs("div",{children:[i.jsx("strong",{children:"Custom:"})," ",i.jsx("code",{children:"New: {{loop.current}}"})," adds prefix"]})]})})]})})]}),shouldCloseManually:!0,resizable:!0,initialSize:a||{width:500,height:800},initialPosition:r,children:i.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[i.jsxs("div",{className:"flex border-b border-border",children:[i.jsx("button",{onClick:()=>c("simple"),className:`flex-1 px-4 py-2 text-sm font-medium transition-colors ${l==="simple"?"border-b-2 border-primary text-primary bg-accent/50":"text-muted-foreground hover:text-foreground hover:bg-accent/30"}`,children:"Simple"}),i.jsx("button",{onClick:()=>c("advanced"),className:`flex-1 px-4 py-2 text-sm font-medium transition-colors ${l==="advanced"?"border-b-2 border-primary text-primary bg-accent/50":"text-muted-foreground hover:text-foreground hover:bg-accent/30"}`,children:"Advanced"})]}),i.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:l==="simple"?i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:["Update the same fields across ",i.jsx("strong",{children:"all nodes"})," (",n.length," nodes)"]}),d.map((y,v)=>i.jsx("div",{className:"space-y-2",children:i.jsxs("div",{className:"flex gap-3 items-end",children:[i.jsxs("div",{className:"w-1/3",children:[v===0&&i.jsx("label",{className:"text-sm font-medium block mb-2",children:"Field to Update"}),i.jsx("select",{value:y.field,onChange:k=>m(v,k.target.value),className:"w-full text-sm border border-border rounded px-3 py-2 bg-background",children:rr.map(k=>i.jsx("option",{value:k.value,children:k.label},k.value))})]}),i.jsxs("div",{className:"w-2/3",children:[v===0&&i.jsx("label",{className:"text-sm font-medium block mb-2",children:"Template Value"}),i.jsx("input",{type:"text",value:y.template,onChange:k=>x(v,k.target.value),placeholder:"e.g., {{loop.current}} or New: {{loop.current}}",className:"w-full text-sm border border-border rounded px-3 py-2 bg-background"})]}),d.length>1&&i.jsx("button",{onClick:()=>h(v),className:"p-2 rounded hover:bg-destructive/10 text-destructive mb-0.5",title:"Remove field",children:i.jsx(Ke,{size:16})})]})},v)),i.jsxs("button",{onClick:f,className:"w-full text-sm flex items-center justify-center gap-2 py-2 border border-dashed border-border rounded hover:bg-accent",children:[i.jsx(Oe,{size:16})," Add Field"]})]}):i.jsxs(i.Fragment,{children:[g.length===0&&d.some(y=>y.template.trim())&&i.jsxs("div",{className:"bg-muted/50 border border-border rounded-lg p-3",children:[i.jsxs("div",{className:"text-sm mb-2",children:[i.jsx("strong",{children:"Start from Simple Mode?"}),i.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Import ",d.filter(y=>y.template.trim()).length," field update(s) for all ",n.length," nodes"]})]}),i.jsxs("button",{onClick:w,className:"w-full text-sm flex items-center justify-center gap-2 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90",children:[i.jsx(Oe,{size:16})," Import from Simple Mode"]})]}),g.map((y,v)=>i.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-3",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("span",{className:"text-sm font-semibold",children:["Target ",v+1]}),i.jsx("button",{onClick:()=>N(v),className:"p-1 rounded hover:bg-destructive/10 text-destructive",title:"Remove target",children:i.jsx(Ke,{size:14})})]}),i.jsxs("div",{children:[i.jsx("label",{className:"text-xs font-medium block mb-1",children:"Node"}),i.jsxs("select",{value:y.nodeId,onChange:k=>j(v,k.target.value),className:"w-full text-sm border border-border rounded px-2 py-1 bg-background",children:[i.jsx("option",{value:"",children:"Select node..."}),n.map(k=>i.jsx("option",{value:k.id,children:k.title||k.id},k.id))]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx("label",{className:"text-xs font-medium block",children:"Fields to Update"}),y.fields.map((k,R)=>i.jsxs("div",{className:"flex gap-2",children:[i.jsx("select",{value:k.field,onChange:M=>A(v,R,M.target.value),className:"flex-1 text-xs border border-border rounded px-2 py-1 bg-background",children:rr.map(M=>i.jsx("option",{value:M.value,children:M.label},M.value))}),i.jsx("input",{type:"text",value:k.value,onChange:M=>T(v,R,M.target.value),placeholder:"Value or template",className:"flex-1 text-xs border border-border rounded px-2 py-1 bg-background"}),i.jsx("button",{onClick:()=>I(v,R),className:"p-1 rounded hover:bg-destructive/10 text-destructive",title:"Remove field",disabled:y.fields.length===1,children:i.jsx(Ke,{size:14})})]},R)),i.jsxs("button",{onClick:()=>C(v),className:"text-xs flex items-center gap-1 text-primary hover:underline",children:[i.jsx(Oe,{size:12})," Add Field"]})]})]},v)),i.jsxs("button",{onClick:b,className:"w-full text-sm flex items-center justify-center gap-2 py-2 border border-dashed border-border rounded hover:bg-accent",children:[i.jsx(Oe,{size:16})," Add Target Node"]})]})}),i.jsxs("div",{className:"border-t border-border p-3 flex justify-end gap-2",children:[i.jsx("button",{"data-test":"node-update-config-cancel-button",onClick:t,className:"px-3 py-1.5 text-sm border border-border rounded hover:bg-accent",children:"Cancel"}),i.jsx("button",{"data-test":"node-update-config-save-button",onClick:E,className:"px-3 py-1.5 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90",children:"Save"})]})]})})},tp=[{value:"title",label:"Title",type:"string"},{value:"content",label:"Content",type:"string"},{value:"x",label:"X Position",type:"number"},{value:"y",label:"Y Position",type:"number"},{value:"width",label:"Width",type:"number"},{value:"height",label:"Height",type:"number"},{value:"isPinned",label:"Is Pinned",type:"boolean"}],ir=[{value:"equals",label:"Equals",description:"Exact match (===)"},{value:"notEquals",label:"Not Equals",description:"Not an exact match (!==)"},{value:"contains",label:"Contains",description:"Field includes the value"},{value:"notContains",label:"Not Contains",description:"Field does not include the value"},{value:"matches",label:"Matches Regex",description:"Field matches regex pattern (use /pattern/)"},{value:"notMatches",label:"Not Matches Regex",description:"Field does not match regex pattern"},{value:"greaterThan",label:"Greater Than",description:"Numeric comparison (>)"},{value:"lessThan",label:"Less Than",description:"Numeric comparison (<)"},{value:"greaterThanOrEqual",label:"Greater Than or Equal",description:"Numeric comparison (>=)"},{value:"lessThanOrEqual",label:"Less Than or Equal",description:"Numeric comparison (<=)"}],np=({isVisible:e,onClose:t,currentConfig:n,onSave:o,initialPosition:s,initialSize:r})=>{var f;const[a,l]=S.useState((n==null?void 0:n.field)||"title"),[c,d]=S.useState((n==null?void 0:n.operator)||"equals"),[u,g]=S.useState((n==null?void 0:n.expectedValue)||""),p=()=>{if(!u.trim())return;o({field:a,operator:c,expectedValue:u}),t()};return i.jsx(We,{isVisible:e,onClose:t,title:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{children:"Configure If Condition"}),i.jsx(ft,{children:i.jsxs(gt,{children:[i.jsx(pt,{asChild:!0,children:i.jsx(jt,{size:14,className:"text-muted-foreground cursor-help"})}),i.jsx(ht,{side:"right",className:"max-w-xs",children:i.jsxs("div",{className:"text-xs space-y-1",children:[i.jsxs("div",{children:[i.jsx("strong",{children:"Templates:"})," Use ",i.jsx("code",{children:"{{users}}"}),", ",i.jsx("code",{children:"{{count}}"})," in expected value"]}),i.jsxs("div",{children:[i.jsx("strong",{children:"Example:"})," title contains ",i.jsx("code",{children:"{{loop.current}}"})]})]})})]})})]}),shouldCloseManually:!0,resizable:!0,initialSize:r||{width:400,height:300},initialPosition:s,children:i.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[i.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[i.jsx("div",{className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:"Check if a field meets a specific condition"}),i.jsxs("div",{children:[i.jsx("label",{className:"text-sm font-medium block mb-2",children:"Field to Check"}),i.jsx("select",{value:a,onChange:h=>l(h.target.value),className:"w-full text-sm border border-border rounded px-3 py-2 bg-background",children:tp.map(h=>i.jsx("option",{value:h.value,children:h.label},h.value))})]}),i.jsxs("div",{children:[i.jsx("label",{className:"text-sm font-medium block mb-2",children:"Comparison Operator"}),i.jsx("select",{value:c,onChange:h=>d(h.target.value),className:"w-full text-sm border border-border rounded px-3 py-2 bg-background",children:ir.map(h=>i.jsx("option",{value:h.value,children:h.label},h.value))}),i.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:(f=ir.find(h=>h.value===c))==null?void 0:f.description})]}),i.jsxs("div",{children:[i.jsx("label",{className:"text-sm font-medium block mb-2",children:"Expected Value"}),i.jsx("input",{type:"text",value:u,onChange:h=>g(h.target.value),placeholder:"e.g., {{users}}, Alice, or /pattern/",className:"w-full text-sm border border-border rounded px-3 py-2 bg-background"}),i.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Supports templates ","{{users}}",", ","{{count}}",", ","{{loop.current}}"," and regex /pattern/"]})]})]}),i.jsxs("div",{className:"border-t border-border p-3 flex justify-end gap-2",children:[i.jsx("button",{"data-test":"if-step-config-cancel-button",onClick:t,className:"px-3 py-1.5 text-sm border border-border rounded hover:bg-accent",children:"Cancel"}),i.jsx("button",{"data-test":"if-step-config-save-button",onClick:p,className:"px-3 py-1.5 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-primary",disabled:!u.trim(),children:"Save"})]})]})})};class gn{static convertOrchestrationNode(t,n){var l;const o=t.data,s=((l=o==null?void 0:o.parameters)==null?void 0:l.rows)||[],r=this.convertRowsToNodes(s),a=[...this.createConnectionsFromRowHierarchy(s),...this.createConnectionsFromArrows(t.id,n)];return{nodes:r,connections:a}}static convertRowsToNodes(t){const n=[];for(const o of t){const s={id:o.id,type:o.stepType||"unknown",parameters:{label:o.label,order:o.order,...o.config||{}},inputHandles:this.createHandlesForStepType(o.stepType,"input",o.id),outputHandles:this.createHandlesForStepType(o.stepType,"output",o.id)};if(n.push(s),o.children&&o.children.length>0){const r=this.convertRowsToNodes(o.children);n.push(...r)}}return n}static createHandlesForStepType(t,n,o){const s=["source","transform","nodeUpdate","condition","if"],r=["source","transform","nodeUpdate","condition","if","loop"];return n==="input"&&s.includes(t)?[{id:`input_${o}`,name:"Input",type:"input",dataType:"any"}]:n==="output"&&r.includes(t)?[{id:`output_${o}`,name:"Output",type:"output",dataType:"any"}]:[]}static createConnectionsFromRowHierarchy(t,n){const o=[];for(const s of t)if(n&&o.push({id:`conn_${n}_to_${s.id}`,sourceNodeId:n,sourceHandleId:`output_${n}`,targetNodeId:s.id,targetHandleId:`input_${s.id}`}),s.children&&s.children.length>0){const r=this.createConnectionsFromRowHierarchy(s.children,s.id);o.push(...r)}return o}static createConnectionsFromArrows(t,n){const o=[],s=n.filter(r=>r.endNodeId===t&&r.endRowId);for(const r of s){const a={id:r.id,sourceNodeId:r.startNodeId||"",sourceHandleId:r.startRowId||`output_${r.startNodeId}`,targetNodeId:r.endRowId||"",targetHandleId:r.endRowId||`input_${r.endRowId}`};o.push(a)}return o}static getWorkflowName(t){return t.title||"Untitled Workflow"}static getWorkflowDescription(t){var s,r;const n=t.data,o=((r=(s=n==null?void 0:n.parameters)==null?void 0:s.rows)==null?void 0:r.length)||0;return`Workflow with ${o} step${o!==1?"s":""}`}}class op{constructor(t=[]){fe(this,"crudService");this.crudService=new jr(t)}create(t){const n=new Date().toISOString(),o=this.crudService.create({name:t.name,description:t.description,tags:t.tags||[],nodes:t.nodes||[],connections:t.connections||[],version:1,createdAt:n,updatedAt:n});if(!o)throw new Error("Failed to create workflow definition");return o}getAll(){return this.crudService.readAll()}getById(t){return this.crudService.readById(t)}update(t,n){const o=this.crudService.readById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);const s={...o,...n,id:o.id,createdAt:o.createdAt,updatedAt:new Date().toISOString(),version:(o.version||1)+1};return this.crudService.update(s),s}delete(t){this.crudService.delete(t)}findByTag(t){return this.crudService.readAll().filter(n=>{var o;return(o=n.tags)==null?void 0:o.includes(t)})}findByName(t){const n=t.toLowerCase();return this.crudService.readAll().filter(o=>o.name.toLowerCase().includes(n))}count(){return this.crudService.count()}clear(){this.crudService.clear()}updateNodes(t,n){return this.update(t,{nodes:n})}updateConnections(t,n){return this.update(t,{connections:n})}addNode(t,n){const o=this.getById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);const s=[...o.nodes,n];return this.updateNodes(t,s)}removeNode(t,n){const o=this.getById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);const s=o.nodes.filter(a=>a.id!==n),r=o.connections.filter(a=>a.sourceNodeId!==n&&a.targetNodeId!==n);return this.update(t,{nodes:s,connections:r})}addConnection(t,n){const o=this.getById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);const s=[...o.connections,n];return this.updateConnections(t,s)}removeConnection(t,n){const o=this.getById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);const s=o.connections.filter(r=>r.id!==n);return this.updateConnections(t,s)}duplicate(t,n){const o=this.getById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);return this.create({name:n,description:o.description,tags:o.tags?[...o.tags]:void 0,nodes:o.nodes.map(s=>({...s})),connections:o.connections.map(s=>({...s}))})}}class ar{static toWorkflowNode(t,n){const o=t.data,s=(o==null?void 0:o.nodeType)||"unknown",r={...(o==null?void 0:o.parameters)||{}};(t.type===K.TEXT||t.type===K.RECT)&&t.content&&(r._nodeContent=t.content);let a=(o==null?void 0:o.inputHandles)||[],l=(o==null?void 0:o.outputHandles)||[];if(n){const c=n.get(s);c&&(c.inputs&&(a=c.inputs.map(d=>({id:d.id,name:d.name,type:"input",dataType:d.dataType}))),c.outputs&&(l=c.outputs.map(d=>({id:d.id,name:d.name,type:"output",dataType:d.dataType}))))}return{id:t.id,type:s,parameters:r,inputHandles:a,outputHandles:l,executionState:o==null?void 0:o.executionState,executionData:o==null?void 0:o.executionData}}static toWorkflowNodes(t,n){return t.filter(o=>{const s=o.data;return s&&s.nodeType&&s.nodeType!=="unknown"}).map(o=>this.toWorkflowNode(o,n))}static toWorkflowConnection(t){const n=t.startNodeId||"",o=t.endNodeId||"";let s;if(t.endRowId)s=`input_${t.endRowId}`;else if(t.label){const r=t.label.match(/step\s+(\d+)/i);r?s=`input_row_${r[1]}`:s=`handle-${o}-in`}else s=`handle-${o}-in`;return{id:t.id,sourceNodeId:n,sourceHandleId:`handle-${n}-out`,targetNodeId:o,targetHandleId:s,isValid:!0,dataType:"any"}}static toWorkflowConnections(t){const n=new Map;return t.forEach(o=>{const s=o.endNodeId||"";n.has(s)||n.set(s,[]),n.get(s).push(o)}),t.map(o=>{const s=o.startNodeId||"",r=o.endNodeId||"";let a=`handle-${r}-in`;if(o.endRowId)a=`input_${o.endRowId}`;else if(o.label){const l=o.label.match(/step\s+(\d+)/i);l?a=`input_row_${l[1]}`:a=`handle-${r}-in`}else{const l=n.get(r)||[];if(l.findIndex(d=>d.id===o.id)>=0){const d=new Set;l.forEach(g=>{if(g.label){const p=g.label.match(/step\s+(\d+)/i);p&&d.add(parseInt(p[1]))}});let u=1;for(const g of l)if(!(g.label&&g.label.match(/step\s+(\d+)/i))){for(;d.has(u);)u++;if(g.id===o.id){a=`input_row_${u}`;break}d.add(u),u++}}else a=`handle-${r}-in`}return{id:o.id,sourceNodeId:s,sourceHandleId:`handle-${s}-out`,targetNodeId:r,targetHandleId:a,isValid:!0,dataType:"any"}})}static fromWorkflowNode(t,n){return{id:t.id,x:(n==null?void 0:n.x)??0,y:(n==null?void 0:n.y)??0,type:K.RECT,data:{nodeType:t.type,parameters:t.parameters,inputHandles:t.inputHandles,outputHandles:t.outputHandles,executionState:t.executionState,executionData:t.executionData}}}static fromWorkflowConnection(t){return{id:t.id,startNodeId:t.sourceNodeId,endNodeId:t.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0}}}}class sp{constructor(){fe(this,"definitions",new Map)}register(t){this.definitions.set(t.type,t)}get(t){return this.definitions.get(t)}getAll(){return Array.from(this.definitions.values())}getByCategory(t){return this.getAll().filter(n=>n.category===t)}search(t){if(!t||t.trim()==="")return[];const n=t.toLowerCase();return this.getAll().filter(o=>{var s;return!!(o.name.toLowerCase().includes(n)||o.description.toLowerCase().includes(n)||(s=o.tags)!=null&&s.some(r=>r.toLowerCase().includes(n)))})}has(t){return this.definitions.has(t)}unregister(t){this.definitions.delete(t)}clear(){this.definitions.clear()}}class rp{constructor(t="workflow-executions"){fe(this,"storageKey");this.storageKey=t}async save(t){const n=await this.loadAll();n[t.id]=this.serializeExecution(t),this.saveAll(n)}async get(t){const o=(await this.loadAll())[t];return o?this.deserializeExecution(o):null}async listByWorkflow(t,n){const o=await this.loadAll(),s=Object.values(o).filter(r=>r.workflowId===t).map(r=>this.deserializeExecution(r)).sort((r,a)=>new Date(a.startTime).getTime()-new Date(r.startTime).getTime());return n?s.slice(0,n):s}async listRecent(t){const n=await this.loadAll(),o=Object.values(n).map(s=>this.deserializeExecution(s)).sort((s,r)=>new Date(r.startTime).getTime()-new Date(s.startTime).getTime());return t?o.slice(0,t):o}async delete(t){const n=await this.loadAll();delete n[t],this.saveAll(n)}async deleteByWorkflow(t){const n=await this.loadAll(),o=Object.entries(n).filter(([s,r])=>r.workflowId!==t).reduce((s,[r,a])=>({...s,[r]:a}),{});this.saveAll(o)}async clear(){localStorage.removeItem(this.storageKey)}async loadAll(){try{const t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):{}}catch(t){return console.error("Failed to load executions from localStorage:",t),{}}}saveAll(t){try{const n=JSON.stringify(t);localStorage.setItem(this.storageKey,n)}catch(n){throw console.error("Failed to save executions to localStorage:",n),new Error("Failed to save executions: localStorage quota may be exceeded")}}serializeExecution(t){return{...t,nodeExecutions:t.nodeExecutions?Array.from(t.nodeExecutions.entries()):[]}}deserializeExecution(t){return{...t,nodeExecutions:new Map(Array.isArray(t.nodeExecutions)?t.nodeExecutions:[])}}}class ip{constructor(t,n){this.nodeRegistry=t,this.executionStore=n}async executeWorkflow(t,n,o,s){const r={workflowId:this.generateId("workflow"),executionId:this.generateId("execution"),startTime:new Date().toISOString(),status:"running",executionData:new Map,errors:[],allCanvasNodes:o};try{if(t.length===0)return r.status="completed",r;const a=this.findTriggerNode(t,s),l=this.computeExecutionOrder(t,n,a);return await this.executeNodesInOrder(l,n,r),r.errors.length===0?r.status="completed":r.status="failed",await this.saveExecutionRecord(r,t),r}catch(a){return r.status="failed",r.errors.push({nodeId:r.currentNodeId||"unknown",message:a instanceof Error?a.message:String(a),timestamp:new Date().toISOString(),stack:a instanceof Error?a.stack:void 0}),r}}findTriggerNode(t,n){if(n){const s=t.find(r=>r.id===n);if(!s)throw new Error(`Specified trigger node '${n}' not found`);return s}const o=t.filter(s=>{const r=this.nodeRegistry.get(s.type);return(r==null?void 0:r.category)==="trigger"});if(o.length===0){const s=t.filter(r=>{const a=this.nodeRegistry.get(r.type);return(a==null?void 0:a.type)==="workflowOrchestration"});if(s.length===0)throw new Error("No trigger node found in workflow");if(s.length>1)throw new Error("Multiple orchestration nodes found - specify which one to execute");return s[0]}if(o.length>1)throw new Error("Multiple trigger nodes found in workflow");return o[0]}computeExecutionOrder(t,n,o){const s=new Map,r=new Map;t.forEach(d=>{s.set(d.id,[]),r.set(d.id,0)}),n.forEach(d=>{const u=s.get(d.sourceNodeId)||[];u.push(d.targetNodeId),s.set(d.sourceNodeId,u),r.set(d.targetNodeId,(r.get(d.targetNodeId)||0)+1)});const a=[o.id],l=[],c=new Set;for(;a.length>0;){const d=a.shift();if(c.has(d))throw new Error("Circular dependency detected in workflow");c.add(d);const u=t.find(p=>p.id===d);if(!u)continue;l.push(u),(s.get(d)||[]).forEach(p=>{const f=r.get(p)||0;r.set(p,f-1),r.get(p)===0&&a.push(p)})}return l}async executeNodesInOrder(t,n,o){var s;for(const r of t){o.currentNodeId=r.id;try{const a=this.nodeRegistry.get(r.type);if(!a)throw new Error(`Node type '${r.type}' not found in registry`);const l=this.getInputDataForNode(r,n,o),c=await a.executor(r,l,o);o.executionData.set(r.id,c)}catch(a){const l={nodeId:r.id,message:a instanceof Error?a.message:String(a),timestamp:new Date().toISOString(),stack:a instanceof Error?a.stack:void 0};if(o.errors.push(l),!((s=r.parameters)!=null&&s.continueOnError))break}}}getInputDataForNode(t,n,o){const s=n.filter(l=>l.targetNodeId===t.id);if(s.length===0)return null;const r=t.inputHandles&&t.inputHandles.length>1;if(s.length===1&&!r){const l=s[0];return o.executionData.get(l.sourceNodeId)}const a=new Map;return s.forEach(l=>{const c=o.executionData.get(l.sourceNodeId);c!==void 0&&a.set(l.targetHandleId,{_sourceNodeId:l.sourceNodeId,_data:c})}),a}async saveExecutionRecord(t,n){const o={id:t.executionId,workflowId:t.workflowId,startTime:t.startTime,endTime:new Date().toISOString(),duration:Date.now()-new Date(t.startTime).getTime(),status:t.status,nodeExecutions:new Map,errors:t.errors};n.forEach(s=>{const r=t.executionData.get(s.id);r!==void 0&&o.nodeExecutions.set(s.id,{nodeId:s.id,nodeType:s.type,startTime:t.startTime,endTime:new Date().toISOString(),status:"success",input:{},output:r})}),await this.executionStore.save(o)}generateId(t){return`${t}-${Date.now()}-${Math.random().toString(36).substring(7)}`}}const ap={type:"manualTrigger",category:"trigger",name:"Manual Trigger",description:"Manually start the workflow with a button click",parameters:[{name:"label",displayName:"Button Label",type:"string",required:!1,default:"Execute Workflow",placeholder:"Enter button label",description:"Label for the trigger button"}],inputs:[],outputs:[{id:"output_main",name:"Trigger Output",dataType:"object",required:!1}],executor:async(e,t,n)=>{const s={value:e.parameters._nodeContent||"",timestamp:new Date().toISOString(),executionId:n.executionId,triggeredBy:"manual"};return e.parameters.label&&(s.label=e.parameters.label),s},version:1,author:"System"},lp={type:"textInput",category:"data",name:"Text Input",description:"Collect text input from user",version:1,parameters:[{name:"label",displayName:"Input Label",type:"string",required:!0,default:"Enter text",description:"Label shown to the user"},{name:"placeholder",displayName:"Placeholder",type:"string",required:!1,default:"",description:"Placeholder text in input field"},{name:"defaultValue",displayName:"Default Value",type:"string",required:!1,default:"",description:"Pre-filled value"}],inputs:[{id:"input_main",name:"Trigger",dataType:"any",required:!1}],outputs:[{id:"output_main",name:"User Input",dataType:"string",required:!0}],executor:async(e,t,n)=>({value:e.parameters._nodeContent||e.parameters.defaultValue||"John Doe",label:e.parameters.label,timestamp:new Date().toISOString()})},cp={type:"textOutput",category:"data",name:"Text Output",description:"Display formatted text output",version:1,parameters:[{name:"template",displayName:"Output Template",type:"string",required:!1,default:"Result: {{input}}",description:"Template for output. Use {{input}} for input data"}],inputs:[{id:"input_main",name:"Data",dataType:"any",required:!0}],outputs:[{id:"output_main",name:"Formatted Output",dataType:"string",required:!0}],executor:async(e,t,n)=>{let s=e.parameters.template||"Result: {{input}}";if(t&&typeof t=="object"){const r=t.value||t.formattedOutput||t.output||t.label||JSON.stringify(t);s=s.replace(/\{\{input\}\}/g,r)}else s=s.replace(/\{\{input\}\}/g,String(t||""));return{output:s,formattedOutput:s,timestamp:new Date().toISOString()}}},dp={type:"workflowSource",category:"data",name:"Workflow Source",description:"Provide static data as workflow source",version:1,parameters:[{name:"displayFormat",displayName:"Display Format",type:"string",required:!1,default:"json",description:"How to display the data (json, text)"}],inputs:[],outputs:[{id:"output_main",name:"Source Data",dataType:"object",required:!0}],executor:async(e,t,n)=>{const o=e.parameters._nodeContent||"";let s;try{s=JSON.parse(o)}catch{s=o}return{value:o,output:s,timestamp:new Date().toISOString()}}};function ci(e,t,n,o){e=e.trim();const s={loop:t||{},source:n||{},if:o||{}};try{let r=s,a=e;for(;a.length>0;){const l=a.match(/^\.?([a-zA-Z_][a-zA-Z0-9_]*)/);if(l){const c=l[1];r=r==null?void 0:r[c],a=a.slice(l[0].length);continue}if(a.startsWith("[")){let c=0,d=-1;for(let g=0;g<a.length;g++)if(a[g]==="["&&c++,a[g]==="]"&&(c--,c===0)){d=g;break}if(d===-1)break;const u=a.slice(1,d);if(/^\d+$/.test(u)){const g=parseInt(u,10);r=r==null?void 0:r[g]}else{const g=ci(u,t,n,o);r=r==null?void 0:r[g]}a=a.slice(d+1);continue}break}return r==null?"":typeof r=="object"?JSON.stringify(r):String(r)}catch{return""}}function Ht(e,t,n,o){return e?e.replace(/\{\{([^}]+)\}\}/g,(r,a)=>ci(a,t,n,o)):""}function Ho(e,t,n,o){if(typeof e=="string")return Ht(e,t,n,o);if(Array.isArray(e))return e.map(s=>Ho(s,t,n,o));if(e&&typeof e=="object"){const s={};for(const r in e)s[r]=Ho(e[r],t,n,o);return s}return e}const up={type:"workflowOrchestration",category:"logic",name:"Workflow",description:"Orchestrate multiple inputs in a specific order",version:1,parameters:[{name:"rows",displayName:"Workflow Steps",type:"json",required:!1,default:[{id:"row_1",label:"Step 1",order:1},{id:"row_2",label:"Step 2",order:2}],description:"Define workflow steps and their order"}],inputs:[{id:"input_row_1",name:"Step 1 Input",dataType:"any",required:!1},{id:"input_row_2",name:"Step 2 Input",dataType:"any",required:!1}],outputs:[{id:"output_main",name:"Combined Output",dataType:"object",required:!0}],executor:async(e,t,n)=>{const o=e.parameters.rows||[{id:"row_1",label:"Step 1",order:1},{id:"row_2",label:"Step 2",order:2}];let s;t instanceof Map?s=t:t&&typeof t=="object"?s=new Map(Object.entries(t)):s=new Map;function r(N){const j=[];return N.forEach(C=>{j.push(C),C.children&&Array.isArray(C.children)&&j.push(...r(C.children))}),j}const a=r(o),l=[];a.forEach(N=>{const j=`input_${N.id}`,C=s.get(j);if(C!==void 0||["nodeUpdate","if","loop"].includes(N.stepType)){const A=C==null?void 0:C._sourceNodeId,T=(C==null?void 0:C._data)!==void 0?C._data:C;l.push({label:N.label,data:T,order:N.order,sourceNodeId:A,stepType:N.stepType||"empty",config:N.config})}}),l.sort((N,j)=>N.order-j.order);const c=l.find(N=>N.stepType==="source");let d=[],u;if(c){const N=typeof c.data=="object"&&c.data!==null?c.data.value||c.data.output||c.data.formattedOutput||c.data:String(c.data);if(typeof N=="string")try{const j=JSON.parse(N);u=j,Array.isArray(j)?d=j:d=Object.values(j)}catch{N.includes(`
`)?d=N.split(`
`).filter(j=>j.trim()):d=[N]}else Array.isArray(N)?d=N:typeof N=="object"&&N!==null?(u=N,d=Object.values(N)):d=[N]}let g=null,p=null,f=new Map;const h=l.map(N=>{if(g===!1&&N.stepType!=="if")return{...N,skipped:!0,skipReason:"if_condition_false"};if(N.stepType==="source")return{...N,sourceData:d,sourceCount:d.length};if(N.stepType==="loop"){const j=d.length>0?d:[];return j.length===0&&l.forEach(C=>{if(C.order!==N.order&&C.stepType!=="source"){const I=typeof C.data=="object"&&C.data!==null?C.data.value||C.data.output||C.data.formattedOutput||JSON.stringify(C.data):String(C.data);j.push(I)}}),{...N,loopValues:j,loopCount:j.length}}if(N.stepType==="if"){const j=N.config||{},{field:C,operator:I,expectedValue:A}=j,T=d.length>0?{current:d[0],index:1,total:d.length,values:d}:void 0,E=Ht(A||"",T,u);let y=!1,v=[];n.allCanvasNodes&&Array.isArray(n.allCanvasNodes)&&n.allCanvasNodes.forEach(R=>{let M;C&&C.includes(".")?M=C.split(".").reduce((O,W)=>O==null?void 0:O[W],R):M=R[C];let D=!1;const _=String(M??""),L=String(E);switch(I){case"equals":D=_===L;break;case"notEquals":D=_!==L;break;case"contains":D=_.includes(L);break;case"notContains":D=!_.includes(L);break;case"matches":case"notMatches":const P=E.match(/^\/(.+)\/([gimsuvy]*)$/);if(P)try{const O=P[1],W=P[2],z=new RegExp(O,W),U=_.match(z),V=U!==null;D=I==="matches"?V:!V,D&&U&&/\((?!\?)/.test(O)&&f.set(R.id,Array.from(U))}catch{D=!1}else{const O=_.includes(E);D=I==="matches"?O:!O}break;case"greaterThan":D=Number(M)>Number(E);break;case"lessThan":D=Number(M)<Number(E);break;case"greaterThanOrEqual":D=Number(M)>=Number(E);break;case"lessThanOrEqual":D=Number(M)<=Number(E);break;default:D=!1}D&&(y=!0),v.push({nodeId:R.id,fieldValue:M,matches:D})}),g=y;const k=v.filter(R=>R.matches);return p=k.length>0?new Set(k.map(R=>R.nodeId)):null,{...N,conditionResult:y,checkedNodes:v,config:{...j,evaluatedExpectedValue:E}}}if(N.stepType==="nodeUpdate"){const j=N.config||{},C=N.order>=10,I=[],A=d.length>0?d:n.allCanvasNodes||[],T=C&&A.length>0?A.length:1;for(let E=0;E<T;E++){const y=A.length>0?{current:A[E],index:E+1,total:A.length,values:A}:void 0;n.allCanvasNodes&&Array.isArray(n.allCanvasNodes)&&n.allCanvasNodes.forEach(R=>{if(p&&!p.has(R.id))return;const M=f.has(R.id)?{capture:f.get(R.id)}:void 0,D={};let _=!1;if(R.title&&typeof R.title=="string"&&/\{\{[^}]+\}\}/.test(R.title)){const P=Ht(R.title,y,u,M);D.title=P,_=!0}R.content&&typeof R.content=="string"&&/\{\{[^}]+\}\}/.test(R.content)&&(D.content=Ht(R.content,y,u,M),_=!0),_&&I.push({nodeId:R.id,updates:D})});const v=j.simpleFieldUpdates||[];if(v.length>0&&y&&y.current&&y.current.id){const R=f.has(y.current.id)?{capture:f.get(y.current.id)}:void 0,M={};v.forEach(_=>{const{field:L,template:P}=_,O=Ht(P,y,u,R);M[L]=O});const D=I.find(_=>_.nodeId===y.current.id);D?Object.assign(D.updates,M):I.push({nodeId:y.current.id,updates:M})}(j.targets||[]).forEach(R=>{if(y&&y.current&&y.current.id&&R.nodeId!==y.current.id||p&&!p.has(R.nodeId))return;const M=f.has(R.nodeId)?{capture:f.get(R.nodeId)}:void 0,D=I.find(L=>L.nodeId===R.nodeId),_=Ho(R.updates,y,u,M);D?Object.assign(D.updates,_):I.push({nodeId:R.nodeId,updates:_})})}return{...N,nodeUpdates:I,loopContext:void 0}}return N}),m=[];h.forEach(N=>{N.stepType==="nodeUpdate"&&"nodeUpdates"in N&&!("skipped"in N)&&m.push(...N.nodeUpdates)});const x={steps:h,stepCount:h.length,timestamp:new Date().toISOString(),sourceData:d,hasSource:d.length>0,nodeUpdates:m},w=h.map(N=>{const j=N.sourceNodeId?` â† ${N.sourceNodeId}`:" (not connected)";return`${N.label}${j}`}).join(`
`),b=h.map(N=>N.stepType==="source"&&"sourceData"in N?`Source: ${N.sourceCount} items
${N.sourceData.join(`
`)}`:N.stepType==="loop"&&"loopValues"in N?N.loopValues.map((C,I)=>`[${I+1}] ${C}`).join(`
`):typeof N.data=="object"&&N.data!==null?N.data.value||N.data.output||N.data.formattedOutput||JSON.stringify(N.data):String(N.data)).join(`
`);return{...x,rowConnections:w,formattedOutput:b}}};class di{constructor(){fe(this,"nodes",[]);fe(this,"arrows",[]);fe(this,"nodeRegistry");fe(this,"executionStore");fe(this,"executionService");this.nodeRegistry=new sp,this.executionStore=new rp,this.executionService=new ip(this.nodeRegistry,this.executionStore),this.registerDefaultNodes()}registerDefaultNodes(){this.nodeRegistry.register(ap),this.nodeRegistry.register(lp),this.nodeRegistry.register(cp),this.nodeRegistry.register(dp),this.nodeRegistry.register(up)}loadWorkflow(t,n){this.nodes=t,this.arrows=n}async executeWorkflow(t){var o;const n=Date.now();try{const s=ar.toWorkflowNodes(this.nodes,this.nodeRegistry),r=ar.toWorkflowConnections(this.arrows),a=await this.executionService.executeWorkflow(s,r,this.nodes,t),l=this.buildNodeStates(a,s);let c=[];const d=Array.from(l.entries()).find(([u,g])=>{const p=s.find(m=>m.id===u),f=(p==null?void 0:p.type)==="workflowOrchestration",h=!!g.executionData;return f&&(u===t||h)});if(d){const[u,g]=d;c=((o=g.executionData)==null?void 0:o.nodeUpdates)||[]}return{success:a.status==="completed",executionId:a.executionId,duration:Date.now()-n,executedNodeCount:a.executionData.size,errors:a.errors.map(u=>({nodeId:u.nodeId,message:u.message})),nodeStates:l,nodeUpdates:c}}catch(s){return{success:!1,error:s instanceof Error?s.message:String(s),errors:[],duration:Date.now()-n}}}buildNodeStates(t,n){const o=new Map;return n.forEach(s=>{const r=t.errors.some(d=>d.nodeId===s.id),a=t.executionData.has(s.id),l=r?"error":a?"success":"idle",c=t.executionData.get(s.id);o.set(s.id,{executionState:l,executionData:c})}),o}async getExecutionHistory(t=10){return await this.executionStore.listRecent(t)}async getExecution(t){return await this.executionStore.get(t)}async clearHistory(){await this.executionStore.clear()}getRegisteredNodeTypes(){return this.nodeRegistry.getAll().map(t=>t.type)}}class Wo{constructor(t=[],n=[]){fe(this,"definitionService");fe(this,"instanceService");fe(this,"executionFacade");this.definitionService=new op(t),this.instanceService=new jr(n),this.executionFacade=new di}createDefinition(t){return this.definitionService.create(t)}getAllDefinitions(){return this.definitionService.getAll()}getDefinitionById(t){return this.definitionService.getById(t)}updateDefinition(t,n){return this.definitionService.update(t,n)}deleteDefinition(t){this.instanceService.filterByKey("definitionId",t).forEach(o=>this.instanceService.delete(o.id)),this.definitionService.delete(t)}findDefinitionsByTag(t){return this.definitionService.findByTag(t)}findDefinitionsByName(t){return this.definitionService.findByName(t)}duplicateDefinition(t,n){return this.definitionService.duplicate(t,n)}createInstance(t,n){const o=this.definitionService.getById(t);if(!o)throw new Error(`Workflow definition not found: ${t}`);const s=new Date().toISOString(),r=this.instanceService.create({definitionId:t,name:n||o.name,status:"idle",createdAt:s,executionHistory:[]});if(!r)throw new Error("Failed to create workflow instance");return r}getAllInstances(){return this.instanceService.readAll()}getInstanceById(t){return this.instanceService.readById(t)}getInstancesByDefinitionId(t){return this.instanceService.filterByKey("definitionId",t)}updateInstance(t,n){const o=this.instanceService.readById(t);if(!o)throw new Error(`Workflow instance not found: ${t}`);const s={...o,...n,id:o.id,createdAt:o.createdAt};this.instanceService.update(s)}deleteInstance(t){this.instanceService.delete(t)}async executeInstance(t,n={}){var r;const o=this.instanceService.readById(t);if(!o)throw new Error(`Workflow instance not found: ${t}`);const s=this.definitionService.getById(o.definitionId);if(!s)throw new Error(`Workflow definition not found: ${o.definitionId}`);this.updateInstance(t,{status:"running"});try{const a=this.convertWorkflowNodesToCanvas(s.nodes),l=this.convertWorkflowConnectionsToCanvas(s.connections);this.executionFacade.loadWorkflow(a,l);const c=await this.executionFacade.executeWorkflow(n.triggerNodeId||((r=a[0])==null?void 0:r.id)||""),d=c.executionId?await this.executionFacade.getExecution(c.executionId):null;if(d){const g=[...o.executionHistory,d];this.updateInstance(t,{status:c.success?"completed":"failed",lastExecutedAt:new Date().toISOString(),executionHistory:g})}return{success:c.success,executionId:c.executionId||"",instanceId:t,definitionId:o.definitionId,duration:c.duration||0,executedNodeCount:c.executedNodeCount||0,errors:c.errors||[],nodeUpdates:c.nodeUpdates}}catch(a){throw this.updateInstance(t,{status:"failed"}),a}}getExecutionHistory(t){const n=this.instanceService.readById(t);if(!n)throw new Error(`Workflow instance not found: ${t}`);return n.executionHistory}clearExecutionHistory(t){this.updateInstance(t,{executionHistory:[]})}convertWorkflowNodesToCanvas(t){return t.map(n=>({id:n.id,x:0,y:0,type:"workflow",data:{nodeType:n.type,parameters:n.parameters,inputHandles:n.inputHandles,outputHandles:n.outputHandles},width:200,height:100}))}convertWorkflowConnectionsToCanvas(t){return t.map(n=>({id:n.id,startNodeId:n.sourceNodeId,endNodeId:n.targetNodeId,startPoint:{x:0,y:0},endPoint:{x:0,y:0},startRowId:n.sourceHandleId,endRowId:n.targetHandleId}))}getStats(){const t=this.instanceService.readAll(),n=t.reduce((o,s)=>(o[s.status]=(o[s.status]||0)+1,o),{});return{totalDefinitions:this.definitionService.count(),totalInstances:t.length,instancesByStatus:n}}clearAll(){this.definitionService.clear(),this.instanceService.clear()}}class zo{constructor(t,n){fe(this,"workflowManager");this.getCanvasState=n,this.workflowManager=t||new Wo}saveWorkflow(t){const{nodeId:n,name:o,description:s,tags:r}=t,{node:a,arrows:l}=this.getNodeAndArrows(n),{nodes:c,connections:d}=gn.convertOrchestrationNode(a,l),u=o||gn.getWorkflowName(a),g=s||gn.getWorkflowDescription(a),f=this.workflowManager.getAllDefinitions().find(h=>h.name===u);return f?this.workflowManager.updateDefinition(f.id,{nodes:c,connections:d,description:g,tags:r||f.tags}):this.workflowManager.createDefinition({name:u,description:g,tags:r||[],nodes:c,connections:d})}loadWorkflow(t){const{definitionId:n,position:o={x:100,y:100},existingNodeId:s}=t,r=this.workflowManager.getDefinitionById(n);if(!r)throw new Error(`Workflow definition not found: ${n}`);const a=this.convertWorkflowNodesToRows(r.nodes,r.connections);return{id:s||`workflow-orch-${Date.now()}`,type:"WORKFLOW_ORCHESTRATION",title:r.name,content:r.description||"",x:o.x,y:o.y,width:400,height:600,data:{nodeType:"workflowOrchestration",showExecuteButton:!0,parameters:{rows:a},inputHandles:this.createInputHandlesFromRows(a),outputHandles:[]}}}validateWorkflow(t){var s;const n=[],o=[];try{const{node:r,arrows:a}=this.getNodeAndArrows(t),l=r.data,c=((s=l==null?void 0:l.parameters)==null?void 0:s.rows)||[];c.length===0&&n.push("Workflow must have at least one step");const d=c.filter(f=>!f.stepType||f.stepType==="empty");d.length>0&&o.push(`${d.length} step(s) have no type configured`);const u=new Set(a.filter(f=>f.endNodeId===t&&f.endRowId).map(f=>f.endRowId)),p=c.filter(f=>f.stepType==="source").filter(f=>!u.has(f.id));return p.length>0&&o.push(`${p.length} source step(s) have no input connections`),{valid:n.length===0,errors:n,warnings:o}}catch(r){return{valid:!1,errors:[`Validation failed: ${String(r)}`],warnings:o}}}canSave(t){const n=this.validateWorkflow(t);return{valid:n.valid,errors:n.errors}}previewDefinition(t){const{node:n,arrows:o}=this.getNodeAndArrows(t),{nodes:s,connections:r}=gn.convertOrchestrationNode(n,o);return{nodes:s,connections:r,nodeCount:s.length,connectionCount:r.length}}addRow(t){var p;const{nodeId:n,stepType:o,label:s,parentRowId:r,config:a}=t,{node:l}=this.getNodeAndArrows(n),c=l.data,d=((p=c==null?void 0:c.parameters)==null?void 0:p.rows)||[],u=d.length+1,g={id:re(),label:s||`Step ${u}`,order:u,stepType:o,config:a||{}};if(r){const f=this.addRowToParent(d,r,g);this.updateNodeRows(n,f)}else{const f=[...d,g];this.updateNodeRows(n,f)}return g}updateRow(t){var d;const{nodeId:n,rowId:o,updates:s}=t,{node:r}=this.getNodeAndArrows(n),a=r.data,l=((d=a==null?void 0:a.parameters)==null?void 0:d.rows)||[],c=this.updateRowRecursive(l,o,s);this.updateNodeRows(n,c)}deleteRow(t){var c;const{nodeId:n,rowId:o}=t,{node:s}=this.getNodeAndArrows(n),r=s.data,a=((c=r==null?void 0:r.parameters)==null?void 0:c.rows)||[],l=this.deleteRowRecursive(a,o);this.updateNodeRows(n,l)}reorderRows(t){var d;const{nodeId:n,rowOrders:o}=t,{node:s}=this.getNodeAndArrows(n),r=s.data,a=((d=r==null?void 0:r.parameters)==null?void 0:d.rows)||[],l=new Map(o.map(u=>[u.rowId,u.order])),c=this.updateRowOrders(a,l);this.updateNodeRows(n,c)}getTemplates(){return[{id:"simple-transform",name:"Simple Transform",description:"Data input â†’ transformation â†’ output"},{id:"conditional-flow",name:"Conditional Flow",description:"Data input â†’ condition check â†’ branching logic"},{id:"loop-process",name:"Loop Processing",description:"Data input â†’ loop over items â†’ process each"}]}createFromTemplate(t){const{templateId:n,name:o}=t,r={"simple-transform":{name:o||"Simple Transform Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"transform-1",type:"transform",parameters:{label:"Transform Data"},inputHandles:[{id:"input_transform-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_transform-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"transform-1",targetHandleId:"input_transform-1"}]},"conditional-flow":{name:o||"Conditional Flow Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"condition-1",type:"if",parameters:{label:"Check Condition"},inputHandles:[{id:"input_condition-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_condition-1_true",name:"True",type:"output",dataType:"any"},{id:"output_condition-1_false",name:"False",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"condition-1",targetHandleId:"input_condition-1"}]},"loop-process":{name:o||"Loop Processing Workflow",nodes:[{id:"source-1",type:"source",parameters:{label:"Data Source"},inputHandles:[{id:"input_source-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_source-1",name:"Output",type:"output",dataType:"any"}]},{id:"loop-1",type:"loop",parameters:{label:"Process Each Item"},inputHandles:[{id:"input_loop-1",name:"Input",type:"input",dataType:"any"}],outputHandles:[{id:"output_loop-1",name:"Output",type:"output",dataType:"any"}]}],connections:[{id:"conn-1",sourceNodeId:"source-1",sourceHandleId:"output_source-1",targetNodeId:"loop-1",targetHandleId:"input_loop-1"}]}}[n];if(!r)throw new Error(`Template not found: ${n}`);return this.workflowManager.createDefinition({name:r.name,description:`Created from ${n} template`,tags:["template",n],nodes:r.nodes,connections:r.connections})}exportWorkflow(t){const n=this.workflowManager.getDefinitionById(t);if(!n)throw new Error(`Workflow definition not found: ${t}`);return JSON.stringify(n,null,2)}exportWorkflows(t){const n=t.map(o=>this.workflowManager.getDefinitionById(o)).filter(o=>o!==void 0);return JSON.stringify(n,null,2)}exportAllWorkflows(){const t=this.workflowManager.getAllDefinitions();return JSON.stringify(t,null,2)}importWorkflow(t){try{const n=JSON.parse(t);if(!n.name||!Array.isArray(n.nodes)||!Array.isArray(n.connections))throw new Error("Invalid workflow format: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:n.name,description:n.description,tags:n.tags||[],nodes:n.nodes,connections:n.connections})}catch(n){throw new Error(`Failed to import workflow: ${n instanceof Error?n.message:String(n)}`)}}importWorkflows(t){try{const n=JSON.parse(t);if(!Array.isArray(n))throw new Error("Invalid format: expected array of workflows");return n.map(o=>{if(!o.name||!Array.isArray(o.nodes)||!Array.isArray(o.connections))throw new Error("Invalid workflow format in array: missing name, nodes, or connections");return this.workflowManager.createDefinition({name:o.name,description:o.description,tags:o.tags||[],nodes:o.nodes,connections:o.connections})})}catch(n){throw new Error(`Failed to import workflows: ${n instanceof Error?n.message:String(n)}`)}}downloadWorkflow(t){const n=this.exportWorkflow(t),o=this.workflowManager.getDefinitionById(t);if(!o)return;const s=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(s),a=document.createElement("a");a.href=r,a.download=`${o.name.replace(/[^a-z0-9]/gi,"_")}.workflow.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)}downloadWorkflows(t){const n=this.exportWorkflows(t),o=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(o),r=document.createElement("a");r.href=s,r.download=`workflows_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}bulkDeleteDefinitions(t){t.forEach(n=>{this.workflowManager.deleteDefinition(n)})}bulkDuplicateDefinitions(t){return t.map((n,o)=>{const s=this.workflowManager.getDefinitionById(n);if(!s)throw new Error(`Definition not found: ${n}`);return this.workflowManager.duplicateDefinition(n,`${s.name} (Copy ${o+1})`)})}bulkAddTags(t,n){t.forEach(o=>{const s=this.workflowManager.getDefinitionById(o);if(!s)return;const r=s.tags||[],a=[...new Set([...r,...n])];this.workflowManager.updateDefinition(o,{tags:a})})}bulkRemoveTags(t,n){t.forEach(o=>{const s=this.workflowManager.getDefinitionById(o);if(!s)return;const a=(s.tags||[]).filter(l=>!n.includes(l));this.workflowManager.updateDefinition(o,{tags:a})})}getBulkStats(t){const n=t.map(a=>this.workflowManager.getDefinitionById(a)).filter(a=>a!==void 0),o=new Set;let s=0,r=0;return n.forEach(a=>{s+=a.nodes.length,r+=a.connections.length,(a.tags||[]).forEach(l=>o.add(l))}),{count:n.length,totalNodes:s,totalConnections:r,tags:Array.from(o)}}getNodeAndArrows(t){if(!this.getCanvasState)throw new Error("Canvas state getter not provided");const{nodes:n,arrows:o}=this.getCanvasState(),s=n.find(r=>r.id===t);if(!s)throw new Error(`Node not found: ${t}`);return{node:s,arrows:o}}convertWorkflowNodesToRows(t,n){const o=new Map;for(const l of n)if(l.sourceHandleId.startsWith("output_")&&l.targetHandleId.startsWith("input_")){const c=l.sourceNodeId,d=l.targetNodeId;o.has(c)||o.set(c,[]),o.get(c).push(d)}const s=new Set,r=(l,c)=>{s.add(l.id);const u=(o.get(l.id)||[]).filter(g=>!s.has(g)).map((g,p)=>{const f=t.find(h=>h.id===g);return f?r(f,p+1):null}).filter(Boolean);return{id:l.id,label:l.parameters.label||`Step ${c}`,order:c,stepType:l.type,config:l.parameters,children:u.length>0?u:void 0}};return t.filter(l=>!n.some(c=>c.targetNodeId===l.id)).map((l,c)=>r(l,c+1))}createInputHandlesFromRows(t){const n=[],o=s=>{s.stepType==="source"&&n.push({id:`input_${s.id}`,name:s.label,type:"input",dataType:"any"}),s.children&&s.children.forEach(r=>o(r))};return t.forEach(o),n}updateNodeRows(t,n){if(!this.getCanvasState)throw new Error("Cannot update rows without canvas state");const o=this.createInputHandlesFromRows(n);return{rows:n,inputHandles:o}}addRowToParent(t,n,o){return t.map(s=>{if(s.id===n){const r=s.children||[];return{...s,children:[...r,o]}}return s.children?{...s,children:this.addRowToParent(s.children,n,o)}:s})}updateRowRecursive(t,n,o){return t.map(s=>s.id===n?{...s,...o}:s.children?{...s,children:this.updateRowRecursive(s.children,n,o)}:s)}deleteRowRecursive(t,n){return t.filter(o=>o.id!==n).map(o=>o.children?{...o,children:this.deleteRowRecursive(o.children,n)}:o)}updateRowOrders(t,n){return t.map(o=>{const s=n.get(o.id),r=s!==void 0?{...o,order:s}:o;return r.children?{...r,children:this.updateRowOrders(r.children,n)}:r}).sort((o,s)=>o.order-s.order)}}const ui="workflow-manager-storage",fi=()=>{try{const e=localStorage.getItem(ui);if(e)return JSON.parse(e)}catch(e){console.error("[WorkflowManager] Failed to load from localStorage:",e)}return null},fp=e=>{try{localStorage.setItem(ui,JSON.stringify(e))}catch(t){console.error("[WorkflowManager] Failed to save to localStorage:",t)}},Ct=fi(),lr=(Ct==null?void 0:Ct.definitions)||[],cr=(Ct==null?void 0:Ct.instances)||[],xn=es((e,t)=>{const n=new Wo(lr,cr);return{definitions:lr,instances:cr,facade:n,selectedDefinitionId:null,selectedInstanceId:null,isExecuting:!1,lastExecutionResult:null,createDefinition:o=>{const s=n.createDefinition(o),r=n.getAllDefinitions();return e({definitions:r}),t().saveToStorage(),s},updateDefinition:(o,s)=>{const r=n.updateDefinition(o,s),a=n.getAllDefinitions();return e({definitions:a}),t().saveToStorage(),r},deleteDefinition:o=>{n.deleteDefinition(o);const s=n.getAllDefinitions(),r=n.getAllInstances();e({definitions:s,instances:r,selectedDefinitionId:t().selectedDefinitionId===o?null:t().selectedDefinitionId}),t().saveToStorage()},duplicateDefinition:(o,s)=>{const r=n.duplicateDefinition(o,s),a=n.getAllDefinitions();return e({definitions:a}),t().saveToStorage(),r},findDefinitionsByTag:o=>n.findDefinitionsByTag(o),findDefinitionsByName:o=>n.findDefinitionsByName(o),createInstance:(o,s)=>{const r=n.createInstance(o,s),a=n.getAllInstances();return e({instances:a}),t().saveToStorage(),r},updateInstance:(o,s)=>{n.updateInstance(o,s);const r=n.getAllInstances();e({instances:r}),t().saveToStorage()},deleteInstance:o=>{n.deleteInstance(o);const s=n.getAllInstances();e({instances:s,selectedInstanceId:t().selectedInstanceId===o?null:t().selectedInstanceId}),t().saveToStorage()},getInstancesByDefinitionId:o=>n.getInstancesByDefinitionId(o),executeInstance:async(o,s)=>{e({isExecuting:!0});try{const r=await n.executeInstance(o,s),a=n.getAllInstances();return e({instances:a,isExecuting:!1,lastExecutionResult:r}),t().saveToStorage(),r}catch(r){throw e({isExecuting:!1}),r}},selectDefinition:o=>{e({selectedDefinitionId:o})},selectInstance:o=>{e({selectedInstanceId:o})},getStats:()=>n.getStats(),clearAll:()=>{n.clearAll(),e({definitions:[],instances:[],selectedDefinitionId:null,selectedInstanceId:null,lastExecutionResult:null}),t().saveToStorage()},loadFromStorage:()=>{const o=fi();if(o){const s=new Wo(o.definitions,o.instances);e({definitions:o.definitions,instances:o.instances,facade:s})}},saveToStorage:()=>{fp({definitions:t().definitions,instances:t().instances})}}}),gp=({node:e,nodes:t,arrows:n,updateNode:o})=>{var d;const s=e.data,r=((d=s==null?void 0:s.parameters)==null?void 0:d.rows)||[],a=xn.getState().definitions,l=()=>{try{const g=new zo(xn.getState().facade,()=>({nodes:t,arrows:n})).saveWorkflow({nodeId:e.id});oe.success("Workflow saved",{description:`"${g.name}" saved successfully (v${g.version})`})}catch(u){oe.error("Failed to save workflow",{description:u instanceof Error?u.message:String(u)})}},c=u=>{if(!u){oe.error("No workflow selected",{description:"Please select a workflow to load"});return}try{const p=new zo(xn.getState().facade,()=>({nodes:t,arrows:n})).loadWorkflow({definitionId:u,existingNodeId:e.id});o(e.id,{title:p.title,content:p.content,data:p.data}),oe.success("Workflow loaded",{description:`"${p.title}" loaded successfully`})}catch(g){oe.error("Failed to load workflow",{description:g instanceof Error?g.message:String(g)})}};return i.jsx(Ii,{storageKey:`workflow-more-options-${e.id}`,initialConfig:{autoSaveEnabled:!1,selectedDefinitionId:""},children:(u,g,p)=>(S.useEffect(()=>{if(!u.autoSaveEnabled||r.length===0)return;const f=setTimeout(()=>{l()},3e3);return()=>clearTimeout(f)},[r,u.autoSaveEnabled]),i.jsx(p,{icon:i.jsx(ba,{className:"h-4 w-4"}),variant:"ghost",size:"icon",buttonClassName:"workflow-more-options-button",contentClassName:"w-80",title:"Workflow Options",children:i.jsxs("div",{className:"workflow-options-panel space-y-4",children:[i.jsxs("div",{className:"save-section space-y-2",children:[i.jsx("h4",{className:"text-sm font-semibold",children:"Save Workflow"}),i.jsxs("button",{"data-test":"workflow-save-to-manager-button",onClick:f=>{f.stopPropagation(),l()},className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:[i.jsx(mt,{className:"h-4 w-4"}),"Save to Workflow Manager"]})]}),i.jsxs("div",{className:"load-section space-y-2",children:[i.jsx("h4",{className:"text-sm font-semibold",children:"Load Workflow"}),i.jsx("p",{className:"text-xs text-muted-foreground",children:"Select a workflow to load into this node"}),i.jsxs(Pn,{"data-test":"workflow-load-select",value:u.selectedDefinitionId,onValueChange:f=>{g({...u,selectedDefinitionId:f})},children:[i.jsx(_n,{"data-test":"workflow-load-select-trigger",children:i.jsx(On,{placeholder:"Select workflow..."})}),i.jsx(Fn,{children:a.length===0?i.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No saved workflows found"}):a.map(f=>i.jsxs($n,{value:f.id,children:[f.name," (v",f.version,")"]},f.id))})]}),i.jsxs("button",{"data-test":"workflow-load-confirm-button",onClick:f=>{f.stopPropagation(),c(u.selectedDefinitionId),g({...u,selectedDefinitionId:""})},disabled:!u.selectedDefinitionId,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm border rounded hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[i.jsx(ya,{className:"h-4 w-4"}),"Load"]})]}),i.jsx("div",{className:"auto-save-section space-y-2 pt-2 border-t",children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"space-y-0.5",children:[i.jsx("h4",{className:"text-sm font-semibold",children:"Auto-Save"}),i.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically save after changes (3s delay)"})]}),i.jsx("button",{"data-test":"workflow-auto-save-toggle",onClick:f=>{f.stopPropagation();const h=!u.autoSaveEnabled;g({...u,autoSaveEnabled:h}),oe.info(h?"Auto-save enabled":"Auto-save disabled",{description:h?"Workflow will save automatically after changes":"Manual save required"})},className:`w-10 h-10 flex items-center justify-center rounded transition-colors border ${u.autoSaveEnabled?"bg-primary text-primary-foreground border-primary":"hover:bg-accent border-border"}`,title:u.autoSaveEnabled?"Disable auto-save":"Enable auto-save",children:i.jsx(Na,{className:"h-4 w-4"})})]})})]})}))})},pp=({node:e,nodes:t,arrows:n,showTextConfig:o,rows:s,updateNode:r,onToggleTextConfig:a,onSetJsonConfigText:l,onSetJsonError:c})=>{const d=e.data,{executeWorkflow:u,showDryRunResults:g}=ai(),p=h=>{if(h.stopPropagation(),!o){const m={nodeId:e.id,nodeType:d==null?void 0:d.nodeType,rows:s,connections:n.filter(x=>x.endNodeId===e.id||x.startNodeId===e.id)};l(JSON.stringify(m,null,2)),c(null)}a()},f=async h=>{h.stopPropagation();const m=await u(!0,e.id);g(m)};return i.jsxs("div",{className:"workflow-header font-semibold mb-2 text-sm border-b pb-1 flex justify-between items-center",children:[i.jsx("span",{children:o?"JSON Config":"Orchestration Rows"}),(d==null?void 0:d.showExecuteButton)&&i.jsxs("div",{className:"execute-button-container flex items-center gap-1.5",children:[i.jsx(X,{"data-test":"workflow-toggle-json-button",onClick:p,variant:o?"default":"outline",size:"icon",className:"h-8 w-8",title:o?"View visual steps":"View workflow as JSON",children:o?i.jsx(Zo,{className:"h-4 w-4"}):i.jsx(Dr,{className:"h-4 w-4"})}),i.jsx(X,{"data-test":"workflow-dry-run-button",onClick:f,variant:"outline",size:"icon",className:"h-8 w-8",title:"Dry Run (preview changes without applying)",children:i.jsx(ho,{className:"h-4 w-4"})}),i.jsx(li,{nodeId:e.id,label:"",className:"h-8 w-8"}),i.jsx(gp,{node:e,nodes:t,arrows:n,updateNode:r})]})]})},hp=({node:e,jsonConfigText:t,jsonError:n,onJsonConfigTextChange:o,onJsonErrorChange:s,onClose:r,updateNode:a})=>{const l=e.data,c=p=>{p.stopPropagation();try{const f=JSON.parse(t);if(!f.rows||!Array.isArray(f.rows)){s('Invalid JSON: "rows" must be an array');return}a(e.id,{data:{...l,parameters:{...l.parameters,rows:f.rows}}}),s(null),r()}catch(f){s(`Invalid JSON: ${f.message}`)}},d=p=>{p.stopPropagation(),navigator.clipboard.writeText(t)},u=p=>{o(p.target.value),s(null)},g=p=>{p.preventDefault(),p.stopPropagation();const f=p.currentTarget,h=f.scrollTop<f.scrollHeight-f.clientHeight,m=f.scrollTop>0,x=p.deltaY>0;(x&&h||!x&&m)&&(f.scrollTop+=p.deltaY)};return i.jsxs("div",{className:"workflow-json-wrapper h-full w-full flex flex-col gap-1",onWheel:p=>{p.stopPropagation()},children:[i.jsx("div",{className:"workflow-textarea-parent flex-1 w-full min-h-0",onWheel:p=>{p.stopPropagation()},children:i.jsx("textarea",{value:t,onChange:u,onClick:p=>p.stopPropagation(),onPointerDown:p=>p.stopPropagation(),onWheel:g,className:"workflow-textarea w-full h-full text-[10px] font-mono bg-background border-0 p-1 resize-none focus:outline-none overflow-auto",spellCheck:!1})}),n&&i.jsx("div",{className:"text-[10px] text-destructive bg-destructive/10 border-t border-destructive/20 px-1 py-1",children:n}),i.jsxs("div",{className:"flex gap-1 border-t pt-1",children:[i.jsx("button",{"data-test":"workflow-json-save-button",onClick:c,className:"flex-1 px-2 py-1 text-[10px] bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors",children:"Save"}),i.jsx("button",{"data-test":"workflow-json-copy-button",onClick:d,className:"px-2 py-1 text-[10px] border border-border rounded hover:bg-accent transition-colors",children:"Copy"})]})]})},mp=({node:e,rows:t,rowElementsRef:n,connectorOffsetLeft:o,stepTypesWithConnectors:s})=>i.jsx("div",{className:"workflow-connector-layer absolute top-0 bottom-0 pointer-events-none",style:{left:`${o}px`},children:t.map(r=>{if(!s.includes(r.stepType))return null;const a=r.id.replace("row_",""),l=r.label||`Step ${a}`,c=n.current.get(r.id);if(!c)return null;const d=c.getBoundingClientRect(),u=c.closest(".bg-background.border.p-3");if(!u)return null;const g=u.getBoundingClientRect(),p=d.top+d.height/2-g.top;return i.jsx("div",{"data-row-connector":r.id,"data-node-id":e.id,className:"absolute w-3 h-3 rounded-full border-2 border bg-background cursor-crosshair hover:bg-accent transition-colors pointer-events-auto",style:{left:"0",top:`${p}px`,transform:"translateY(-50%)"},title:`Connect to ${l}`,onClick:f=>{f.stopPropagation()}},`connector-${r.id}`)})}),xp=-28,zt=["source"],wp=["loop","nodeUpdate","transform","condition","if"],vp=[{id:"source",label:"Source",description:"Provides data for downstream steps"},{id:"loop",label:"Loop",description:"Iterate through source data"},{id:"nodeUpdate",label:"Node Update",description:"Update any node fields with loop data"},{id:"if",label:"If",description:"Conditional check on node fields"},{id:"transform",label:"Transform",description:"Transform input data"},{id:"condition",label:"Condition",description:"Conditional branching"},{id:"empty",label:"Empty",description:"Pass through data unchanged"}],Sp=({row:e,node:t,nodes:n,incomingArrows:o,selectedRowId:s,configPopoverOpen:r,rowElementsRef:a,onRowClick:l,onConfigureRow:c,onDeleteRow:d,onSelectedRowIdChange:u})=>{const g=$i(e.id,2,2),p=e.stepType||"empty",f=o.find(x=>x.endRowId===e.id);let h="";if(f){const x=n.find(b=>b.id===f.startNodeId);h=`${(x==null?void 0:x.title)||(x==null?void 0:x.content)||f.startNodeId}`}else wp.includes(p)?h=e.label||`${g}`:p==="source"?h=`${g} (not connected)`:h=e.label||`${g}`;if(p==="nodeUpdate"&&e.config){const x=e.config.targets||[];if(x.length>0){const w=new Set;x.forEach(N=>{N.updates&&Object.keys(N.updates).forEach(j=>{typeof N.updates[j]=="object"&&j==="styles"?Object.keys(N.updates[j]).forEach(C=>{w.add(`${j}.${C}`)}):w.add(j)})});const b=Array.from(w);if(b.length>0){const N=b.slice(0,2).join(", "),j=b.length>2?`, +${b.length-2}`:"";h+=` â†’ ${N}${j}`}}}return h=(e.order!=null?`${e.order}. `:"")+h,e.id,i.jsx("div",{ref:x=>{x&&a.current.set(e.id,x)},"data-workflow-row":`${t.id}:${e.id}`,className:"relative p-1.5 bg-background rounded border transition-all duration-200 hover:shadow-md hover:border-primary hover:-translate-y-0.5",children:i.jsxs("div",{className:"flex items-center justify-between gap-2",children:[i.jsx("span",{className:"flex-1",children:h}),i.jsxs("div",{className:"flex items-center gap-1",children:[i.jsxs(Uo,{onOpenChange:x=>{u(x?e.id:null)},children:[i.jsx(Go,{asChild:!0,children:i.jsx("button",{"data-test":"workflow-step-type-button",onClick:x=>{x.stopPropagation()},className:"text-[10px] px-1 py-0.5 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-colors cursor-pointer",title:"Change step type",children:p})}),s===e.id&&i.jsxs(Yo,{className:"w-64 p-2",side:"right",align:"start",children:[i.jsx("div",{className:"text-xs font-semibold mb-2 text-muted-foreground",children:"Select Step Type"}),i.jsx("div",{className:"space-y-1",children:vp.map(x=>i.jsxs("button",{onClick:()=>c(e.id,x.id),className:"w-full text-left p-2 text-xs hover:bg-accent rounded flex flex-col",children:[i.jsx("div",{className:"font-semibold",children:x.label}),i.jsx("div",{className:"text-[10px] text-muted-foreground",children:x.description})]},x.id))})]})]}),(p==="nodeUpdate"||p==="if")&&i.jsx("button",{"data-test":"workflow-row-config-button",onClick:x=>{x.stopPropagation(),x.preventDefault(),l(e.id,x,"gear")},className:"p-1 hover:bg-accent rounded transition-colors",title:"Configure step",children:i.jsx(Ko,{size:12,className:"text-muted-foreground"})}),i.jsx("button",{"data-test":"workflow-row-delete-button",onClick:x=>{x.stopPropagation(),x.preventDefault(),d(e.id)},className:"p-1 hover:bg-destructive/10 text-destructive rounded transition-colors",title:"Delete step",children:i.jsx(Ke,{size:12})})]})]})})},yp=({node:e,rows:t,updateNode:n})=>{const o=e.data,[s,r]=S.useState(null),[a,l]=S.useState(!1),[c,d]=S.useState(!1),[u,g]=S.useState(!1),[p,f]=S.useState(null),[h,m]=S.useState(null),x=(E,y)=>{for(const v of E){if(v.id===y)return v;if(v.children){const k=x(v.children,y);if(k)return k}}return null},w=(E,y,v)=>E.map(k=>k.id===y?{...k,...v}:k.children?{...k,children:w(k.children,y,v)}:k),b=(E,y)=>E.filter(v=>v.id!==y).map(v=>v.children?{...v,children:b(v.children,y)}:v);return{selectedRowId:s,setSelectedRowId:r,configPopoverOpen:a,setConfigPopoverOpen:l,showNodeUpdateConfig:c,setShowNodeUpdateConfig:d,showIfStepConfig:u,setShowIfStepConfig:g,popoverPosition:p,popoverSize:h,handleAddRow:()=>{const E=t.length+1,y={id:re(),label:`Step ${E}`,order:E,stepType:"empty"},v=[...t,y];v.sort((M,D)=>M.order-D.order);const R=v.filter(M=>zt.includes(M.stepType)).map(M=>({id:`input_${M.id}`,name:M.label,type:"input",dataType:"any"}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:v},inputHandles:R}})},handleRowClick:(E,y,v)=>{const k=x(t,E);r(E);const R=window.innerWidth,M=window.innerHeight,D=y.clientX,_=y.clientY,P=D<R/2?D+100:D-100;f({x:P,y:_});const O=Math.floor(M*.8);if(m({width:500,height:O}),v==="badge")l(!0);else if(v==="gear"){const z=k==null?void 0:k.stepType;z==="nodeUpdate"?d(!0):z==="if"&&g(!0)}},handleConfigureRow:(E,y)=>{const v=w(t,E,{stepType:y});n(e.id,{data:{...o,parameters:{...o.parameters,rows:v}}}),r(null)},handleDeleteRow:E=>{const y=b(t,E),k=y.filter(R=>zt.includes(R.stepType)).map((R,M)=>({id:R.id,position:"left",offsetY:96+M*32}));n(e.id,{data:{...o,parameters:{...o.parameters,rows:y},inputHandles:k}})},handleSaveNodeUpdateConfig:E=>{if(!s)return;const y=w(t,s,{stepType:"nodeUpdate",config:E});n(e.id,{data:{...o,parameters:{...o.parameters,rows:y}}}),d(!1),r(null)},handleSaveIfStepConfig:E=>{if(!s)return;const y=w(t,s,{stepType:"if",config:E});n(e.id,{data:{...o,parameters:{...o.parameters,rows:y}}}),g(!1),r(null)},findRowRecursive:x}},dr=({node:e})=>{var A,T,E;const t=e.data,n=((A=t==null?void 0:t.parameters)==null?void 0:A.rows)||[],[o,s]=S.useState(!1),[r,a]=S.useState(""),[l,c]=S.useState(null);S.useEffect(()=>{if(!o)return;const y=v=>{var R;const k=v.target;if(k.closest(".workflow-json-wrapper")){const M=(R=k.closest(".workflow-json-wrapper"))==null?void 0:R.querySelector("textarea");if(M){v.stopPropagation(),v.preventDefault();const D=M.scrollTop<M.scrollHeight-M.clientHeight,_=M.scrollTop>0,L=v.deltaY>0;(L&&D||!L&&_)&&(M.scrollTop+=v.deltaY)}}};return document.addEventListener("wheel",y,{capture:!0,passive:!1}),()=>{document.removeEventListener("wheel",y,{capture:!0})}},[o]);const[d,u]=S.useState(()=>new Set(n.filter(y=>y.children&&y.children.length>0).map(y=>y.id))),g=S.useRef(null),p=S.useRef(new Map),[f,h]=S.useState(null),m=B(y=>{var v;return((v=y.projectCanvas.getActive())==null?void 0:v.coreState.arrows)??[]}),x=B(y=>{var v;return((v=y.projectCanvas.getActive())==null?void 0:v.coreState.nodes)??[]}),b=B(y=>{var v;return((v=y.projectCanvas.getActive())==null?void 0:v.coreState.selectedNodes)??[]}).some(y=>y.id===e.id),N=B(y=>y.updateNode),j=yp({node:e,rows:n,updateNode:N}),C=m.filter(y=>y.endNodeId===e.id&&y.endRowId);S.useEffect(()=>{let y=[...n],v=!1;const k=new Set;C.forEach(M=>{M.endRowId&&k.add(M.endRowId)});const R=y.length;if(y=y.filter(M=>{const D=M.stepType&&M.stepType!=="empty";return k.has(M.id)||D}),y.length!==R&&(v=!0),v){y.sort((_,L)=>_.order-L.order);const D=y.filter(_=>zt.includes(_.stepType)).map(_=>({id:`input_${_.id}`,name:_.label,type:"input",dataType:"any"}));N(e.id,{data:{...t,parameters:{...t.parameters,rows:y},inputHandles:D}})}},[C.length,e.id,N]),S.useEffect(()=>(g.current=new Ba({sort:{enabled:!0,orientation:"vertical",threshold:.5},dragThreshold:3},{onDragStart:()=>!0,onDragMove:({sortIndex:y})=>{y!==null&&h(y)},onDrop:({item:y,sortIndex:v})=>{if(v==null)return;const k=y.data.rowId,R=[...n],M=R.findIndex(P=>P.id===k);if(M===-1)return;const[D]=R.splice(M,1);R.splice(v,0,D),R.forEach((P,O)=>{P.order=O+1});const L=R.filter(P=>zt.includes(P.stepType)).map((P,O)=>({id:P.id,position:"left",offsetY:96+O*32}));N(e.id,{data:{...t,parameters:{...t.parameters,rows:R},inputHandles:L}})},onDragEnd:()=>{h(null)}}),()=>{var y;(y=g.current)==null||y.destroy(),p.current.clear()}),[e.id]),S.useEffect(()=>{if(!g.current)return;const y=document.querySelector(`[data-workflow-rows="${e.id}"]`);y&&!y.dataset.dropZoneRegistered&&(g.current.registerDropZone(`workflow-rows-${e.id}`,y,void 0,{nodeId:e.id}),y.dataset.dropZoneRegistered="true"),n.forEach(k=>{const R=document.querySelector(`[data-drag-handle="${k.id}"]`);R&&!R.dataset.dndRegistered&&(g.current.registerDraggable(k.id,R,{rowId:k.id}),R.dataset.dndRegistered="true")});const v=new Set(n.map(k=>k.id));p.current.forEach((k,R)=>{v.has(R)||(g.current.unregisterDraggable(R),p.current.delete(R))})},[n,e.id]);const I=y=>{const k=y.target.closest("[data-drag-handle]"),R=document.querySelector(`[data-node-id="${e.id}"]`);R==null||R.getBoundingClientRect(),n.map(M=>{const D=document.querySelector(`[data-workflow-row="${e.id}:${M.id}"]`);if(D){const _=D.getBoundingClientRect();return{rowId:M.id,screenY:_.top+_.height/2,top:_.top,bottom:_.bottom,height:_.height}}return{rowId:M.id,error:"element not found"}}),b&&!k&&y.stopPropagation()};return i.jsxs("div",{className:"workflow-node-container bg-background border p-3 w-full h-full flex flex-col relative overflow-visible",onPointerDown:I,children:[i.jsx(mp,{node:e,rows:n,rowElementsRef:p,connectorOffsetLeft:xp,stepTypesWithConnectors:zt}),i.jsx(pp,{node:e,nodes:x,arrows:m,showTextConfig:o,rows:n,updateNode:N,onToggleTextConfig:()=>s(!o),onSetJsonConfigText:a,onSetJsonError:c}),i.jsx("div",{className:"workflow-content-area flex-1 w-full text-xs overflow-y-auto relative","data-workflow-rows":e.id,onWheel:y=>{o&&y.stopPropagation()},children:o?i.jsx(hp,{node:e,jsonConfigText:r,jsonError:l,onJsonConfigTextChange:a,onJsonErrorChange:c,onClose:()=>s(!1),updateNode:N}):i.jsx(Va,{data:n,defaultExpandedIds:d,onReorder:y=>{const v=(D,_=1)=>D.map((L,P)=>{const O=_+P;return{...L,order:O,children:L.children?v(L.children,O*10):L.children}}),k=v(y),R=new Set(k.filter(D=>D.children&&D.children.length>0).map(D=>D.id)),M=new Set(d);R.forEach(D=>{d.has(D)||M.add(D)}),u(M),N(e.id,{data:{...t,parameters:{...t.parameters,rows:k}}})},renderCustomContent:y=>i.jsx(Sp,{row:y,node:e,nodes:x,incomingArrows:C,selectedRowId:j.selectedRowId,configPopoverOpen:j.configPopoverOpen,rowElementsRef:p,onRowClick:j.handleRowClick,onConfigureRow:j.handleConfigureRow,onDeleteRow:j.handleDeleteRow,onSelectedRowIdChange:j.setSelectedRowId})})}),i.jsx("button",{"data-test":"workflow-add-row-button",onClick:j.handleAddRow,className:"mt-2 w-full py-1 text-xs border bg-background hover:bg-accent rounded",children:"+ Add Row"}),j.showNodeUpdateConfig&&j.selectedRowId&&i.jsx(ep,{isVisible:j.showNodeUpdateConfig,onClose:()=>{j.setShowNodeUpdateConfig(!1),j.setSelectedRowId(null)},allNodes:x,currentConfig:(T=j.findRowRecursive(n,j.selectedRowId))==null?void 0:T.config,onSave:j.handleSaveNodeUpdateConfig,initialPosition:j.popoverPosition||void 0,initialSize:j.popoverSize||void 0}),j.showIfStepConfig&&j.selectedRowId&&i.jsx(np,{isVisible:j.showIfStepConfig,onClose:()=>{j.setShowIfStepConfig(!1),j.setSelectedRowId(null)},currentConfig:(E=j.findRowRecursive(n,j.selectedRowId))==null?void 0:E.config,onSave:j.handleSaveIfStepConfig,initialPosition:j.popoverPosition||void 0,initialSize:j.popoverSize||void 0})]})},Np="type here...",bp=24,Cp=[],ur=({node:e,preventEdit:t})=>{var y;const n=S.useRef(null),[o,s]=S.useState(t),[r,a]=S.useState(e.content||""),l=e.data,c=(l==null?void 0:l.displayFormat)||"raw",d=B(v=>v.updateNodeContent),u=B(v=>v.updateNode),g=B(v=>v.setMode),p=B(v=>v.uiState.nodeToFocusId),f=B(v=>v.uiState.dragInfo);f==null||f.draggedNodeId,e.id;const h=B(v=>{var k;return((k=v.projectCanvas.getActive())==null?void 0:k.coreState.selectedNodes)??Cp}),m=S.useMemo(()=>!!h.some(v=>v.id===e.id),[h,e.id]),x=m&&p===e.id,{fitNodeDimensions:w}=Gn(),b=S.useMemo(()=>{if(c==="json")try{const v=JSON.parse(r);return JSON.stringify(v,null,2)}catch{return r}return r},[r,c]),N=v=>{a(v.target.value)},j=S.useCallback(v=>{v.preventDefault();const k=v.clipboardData.getData("text"),R=n.current;if(!R)return;const M=R.selectionStart,D=R.selectionEnd,_=R.value,L=_.substring(0,M)+k+_.substring(D);R.value=L;const P=M+k.length;R.setSelectionRange(P,P),a(L),d(e.id,L)},[e.id,d]),C=S.useCallback(v=>{s(v),u(e.id,{isEditing:v})},[u,e.id]),I=S.useCallback(()=>{var v;d(e.id,r),C(!1),u(e.id,{isEditing:!1}),(v=window.getSelection())==null||v.removeAllRanges()},[e.id,d,r,u]),A=S.useCallback(v=>{if(v.shiftKey){!o&&m&&h.length<=1&&(C(!0),setTimeout(()=>{var R;return(R=n.current)==null?void 0:R.focus()},0));return}const k=m&&h.length<=1;k&&C(k)},[o,m,h.length]),T=S.useCallback(v=>{var P,O,W,z;if(v.key==="Escape"){I(),C(!1),g(H.SELECT),(P=n.current)==null||P.blur();return}if(v.key==="Enter"&&v.ctrlKey){const U=((O=n.current)==null?void 0:O.value)||"";d(e.id,U);return}const k=((W=n.current)==null?void 0:W.value)??"",R=_(k),M=L(k,v.key==="Enter"),D=(z=e.options)!=null&&z.lockSize?e.width:R;u(e.id,{width:D,height:M,isEditing:!0});function _(U,V=q.DEFAULT_NODE_WIDTH,ee=Hr.textNodeXPadding){const ye=U.split(/\n/).map(be=>vr(be)).reduce((be,Re)=>Math.max(be,Re),0)+ee,pe=Math.max(ye,V);return Math.max(pe,e.width??0)}function L(U,V=!1){let te=U.split(/\n/).length,le=q.DEFAULT_NODE_HEIGHT;return te===1&&!V?(le=Math.max(le,e.height??0),le):(V&&(te+=1),le+=(te-1)*bp,le=Math.max(le,e.height??0),le)}},[I,d,u,e.id,e.width]);S.useEffect(()=>{p||C(!1)},[p]),S.useEffect(()=>{x&&(C(!0),a(e.content||""),window.setTimeout(()=>{const v=n.current;v&&(v.focus(),v.selectionStart=v.selectionEnd=v.value.length)},0))},[x,e.content]),S.useEffect(()=>{a(e.content||"")},[e.content]);const E=S.useCallback(()=>{const v=c==="raw"?"json":"raw";u(e.id,{data:{...l,displayFormat:v}})},[c,e.id,l,u]);return i.jsxs("div",{className:"relative w-full h-full",children:[m&&i.jsx("button",{onClick:E,className:"absolute -top-7 right-0 z-50 px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100 transition-colors",title:`Switch to ${c==="raw"?"JSON":"raw"} format`,children:c==="raw"?"Raw":"JSON"}),i.jsx("textarea",{spellCheck:!1,ref:n,id:`WorkflowSourceNode-${e.id}`,value:o?r:b,onChange:N,onPaste:j,onBlur:I,onKeyDown:T,onMouseDown:A,placeholder:Np,"data-is-editing":t?!1:o,className:ae("relative z-10","m-0 p-1 w-full h-full","resize-none","overflow-hidden","border","font-mono",e.className,{"pointer-events-none":t,"cursor-text":o,"cursor-default":!o,"select-text":o,"text-muted-foreground":!r&&!o}),style:{textAlign:(y=e.styles)==null?void 0:y.textAlign,fontSize:c==="json"?"12px":Z.text.fontSize,lineHeight:c==="json"?"1.4":"1.5"},readOnly:!o})]})},ke=e=>ts(xn,e),jp=[],Ip=({node:e,preventEdit:t})=>{const n=B(b=>b.updateNode),o=B(b=>{var N;return((N=b.projectCanvas.getActive())==null?void 0:N.coreState.selectedNodes)??jp}),s=ke(b=>b.definitions),r=ke(b=>b.createInstance),a=ke(b=>b.executeInstance),l=ke(b=>b.isExecuting),c=S.useMemo(()=>!!o.some(b=>b.id===e.id),[o,e.id]),d=e.data||{},{definitionId:u,instanceId:g,lastExecutionStatus:p="idle"}=d,f=S.useMemo(()=>s.find(b=>b.id===u),[s,u]),h=S.useCallback(b=>{const N=r(b,`${(f==null?void 0:f.name)||"Workflow"} Instance`);n(e.id,{data:{...d,definitionId:b,instanceId:N.id,lastExecutionStatus:"idle"},title:(f==null?void 0:f.name)||"Workflow"})},[e.id,d,n,r,f]),m=S.useCallback(async()=>{if(!g){console.warn("No instance selected");return}try{n(e.id,{data:{...d,lastExecutionStatus:"running"}});const b=await a(g);n(e.id,{data:{...d,lastExecutionStatus:b.success?"completed":"failed"}})}catch{n(e.id,{data:{...d,lastExecutionStatus:"failed"}})}},[g,d,e.id,n,a]),x=S.useMemo(()=>{switch(p){case"running":return i.jsx(Hn,{className:"h-4 w-4 animate-spin text-blue-500"});case"completed":return i.jsx(ja,{className:"h-4 w-4 text-green-500"});case"failed":return i.jsx(Ca,{className:"h-4 w-4 text-red-500"});default:return i.jsx(vn,{className:"h-4 w-4 text-gray-400"})}},[p]),w=S.useMemo(()=>{switch(p){case"running":return"border-blue-500";case"completed":return"border-green-500";case"failed":return"border-red-500";default:return"border-border"}},[p]);return i.jsxs("div",{className:ae("workflow-definition-node w-full h-full p-3 bg-background border-2 rounded flex flex-col gap-2",w,{"ring-2 ring-primary":c}),children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(vn,{className:"h-5 w-5 text-primary"}),i.jsx("span",{className:"text-sm font-semibold",children:"Workflow"})]}),x]}),i.jsxs(Pn,{value:u||"",onValueChange:h,disabled:t,children:[i.jsx(_n,{className:"w-full h-8 text-xs",children:i.jsx(On,{placeholder:"Select workflow..."})}),i.jsx(Fn,{children:s.length===0?i.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground",children:"No workflows available"}):s.map(b=>i.jsx($n,{value:b.id,className:"text-xs",children:b.name},b.id))})]}),u&&i.jsx("div",{className:"flex gap-1",children:i.jsxs(X,{size:"sm",variant:"default",className:"flex-1 h-7 text-xs",onClick:m,disabled:!u||l||t,children:[i.jsx(Ln,{className:"h-3 w-3 mr-1"}),"Execute"]})}),f&&c&&i.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-2 space-y-1",children:[i.jsxs("div",{children:["Nodes: ",f.nodes.length]}),i.jsxs("div",{children:["Connections: ",f.connections.length]}),f.tags&&f.tags.length>0&&i.jsx("div",{className:"flex gap-1 flex-wrap",children:f.tags.map(b=>i.jsx("span",{className:"px-1 py-0.5 bg-primary/10 text-primary rounded text-[10px]",children:b},b))})]})]})},kp=({node:e})=>{const t=B(v=>v.updateNode),n=S.useRef(null),o=S.useRef(null),[s,r]=S.useState(!1),a=S.useRef(null),c=B(v=>{const k=v.projectCanvas.getActive();return(k==null?void 0:k.coreState.selectedNodes)??[]}).some(v=>v.id===e.id),d=B(v=>{const k=v.projectCanvas.getActive();return(k==null?void 0:k.coreState.nodes)??[]}),u=e.data||{},[g,p]=S.useState(u.image||null),{result:f,isProcessing:h,error:m,processBlob:x,cancel:w,reset:b}=Ua();S.useEffect(()=>{o.current&&c&&o.current.focus()},[c]),S.useEffect(()=>{if(!c)return;const v=async k=>{var M;k.preventDefault(),k.stopPropagation();const R=(M=k.clipboardData)==null?void 0:M.items;if(R){for(const D of R)if(D.type.startsWith("image/")){const _=D.getAsFile();if(_){const L=new FileReader;L.onload=()=>{const P=L.result;p(P),b(),t(e.id,{data:{...u,image:P}})},L.readAsDataURL(_)}break}}};return document.addEventListener("paste",v),()=>{document.removeEventListener("paste",v)}},[c,e.id,u,t,b]),S.useEffect(()=>{if(!f)return;const v=f.timestamp.toISOString();if(a.current===v)return;const k=f.extractedText||"[No text detected in image]",R={image:g||void 0,extractedText:f.extractedText,detectedLanguage:f.detectedLanguage,confidence:f.confidence,processingTime:f.processingTime,timestamp:f.timestamp.toISOString()};t(e.id,{data:R,content:f.extractedText});const M=me.buildTextNodeV2({content:k});is(M,e,"right",{shouldFocus:!1}),a.current=v},[f,g,e.id,e,t,d.length]);const N=S.useCallback(async v=>{var R;const k=(R=v.target.files)==null?void 0:R[0];if(k&&k.type.startsWith("image/")){const M=new FileReader;M.onload=()=>{const D=M.result;p(D),b(),t(e.id,{data:{...u,image:D}})},M.readAsDataURL(k)}},[b,e.id,u,t]),j=S.useCallback(async()=>{if(!g)return;const k=await(await fetch(g)).blob();await x(k)},[g,x]),C=S.useCallback(async()=>{if(!g)return;const k=await(await fetch(g)).blob();await x(k,{downscale:!0,downscaleFactor:.5})},[g,x]),I=S.useCallback(()=>{w()},[w]),A=S.useCallback(()=>{p(null),b(),n.current&&(n.current.value=""),t(e.id,{data:{},content:""})},[b,e.id,t]),T=S.useCallback(async()=>{const v=(f==null?void 0:f.extractedText)||u.extractedText;if(v)try{await navigator.clipboard.writeText(v),r(!0),setTimeout(()=>r(!1),2e3)}catch(k){console.error("Failed to copy:",k)}},[f,u]),E=S.useCallback(v=>{var R;v.preventDefault(),v.stopPropagation();const k=(R=v.clipboardData)==null?void 0:R.items;if(k){for(const M of k)if(M.type.startsWith("image/")){const D=M.getAsFile();if(D){const _=new FileReader;_.onload=()=>{const L=_.result;p(L),b(),t(e.id,{data:{...u,image:L}})},_.readAsDataURL(D)}break}}},[e.id,u,b,t]),y=f||(u.extractedText?{extractedText:u.extractedText,detectedLanguage:u.detectedLanguage,confidence:u.confidence,processingTime:u.processingTime}:null);return i.jsxs("div",{className:"canvas-ocr-node w-full h-full p-4 flex flex-col gap-3 overflow-auto",children:[i.jsxs("div",{className:"ocr-header flex items-center justify-between pb-2 border-b border-border",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(pn,{className:"h-4 w-4 text-primary"}),i.jsx("h3",{className:"text-sm font-semibold",children:"OCR Node"})]}),g&&i.jsx(X,{"data-test":"ocr-clear-button",variant:"ghost",size:"sm",onClick:A,className:"h-6 px-2",children:i.jsx(Ze,{className:"h-3 w-3"})})]}),i.jsx("div",{ref:o,className:"image-input-area border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onPaste:E,tabIndex:0,role:"button","aria-label":"Paste image area",children:g?i.jsxs("div",{className:"image-preview-container space-y-2",children:[i.jsx("img",{src:g,alt:"OCR preview",className:"image-preview max-w-full max-h-32 mx-auto rounded-lg shadow-sm"}),i.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready for OCR"})]}):i.jsxs("div",{className:"empty-state space-y-2",children:[i.jsx(mo,{className:"w-6 h-6 mx-auto text-muted-foreground"}),i.jsx("p",{className:"text-xs text-muted-foreground",children:"Paste image (Ctrl+V) or upload"})]})}),i.jsxs("div",{className:"upload-controls",children:[i.jsx("input",{ref:n,type:"file",accept:"image/*",onChange:N,className:"hidden"}),i.jsxs(X,{"data-test":"ocr-upload-button",variant:"outline",size:"sm",onClick:()=>{var v;return(v=n.current)==null?void 0:v.click()},className:"w-full",children:[i.jsx(mo,{className:"w-3 h-3 mr-2"}),"Upload Image"]})]}),m&&!h&&i.jsxs(Ga,{variant:"destructive",children:[i.jsx(Nn,{className:"h-4 w-4"}),i.jsx(Ya,{className:"text-xs",children:m})]}),i.jsx("div",{className:"ocr-controls flex flex-col gap-2",children:h?i.jsxs(X,{"data-test":"ocr-cancel-button",variant:"destructive",onClick:I,className:"w-full",size:"sm",children:[i.jsx(Hn,{className:"w-3 h-3 mr-2 animate-spin"}),"Cancel"]}):i.jsxs(i.Fragment,{children:[i.jsxs(X,{"data-test":"ocr-extract-button",onClick:j,disabled:!g,className:"w-full",size:"sm",children:[i.jsx(pn,{className:"w-3 h-3 mr-2"}),"Extract Text"]}),i.jsxs(X,{"data-test":"ocr-extract-downscale-button",onClick:C,disabled:!g,variant:"outline",className:"w-full",size:"sm",children:[i.jsx(pn,{className:"w-3 h-3 mr-2"}),"Downscale and Extract"]})]})}),y&&i.jsxs("div",{className:"ocr-results space-y-2 flex-1 flex flex-col",children:[i.jsxs("div",{className:"results-header flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[i.jsx(xo,{className:"w-3 h-3 text-green-600"}),i.jsx("span",{children:"Extracted"})]}),i.jsx(X,{"data-test":"ocr-copy-result-button",variant:"ghost",size:"sm",onClick:T,className:"h-6 px-2",children:s?i.jsxs(i.Fragment,{children:[i.jsx(xo,{className:"w-3 h-3 mr-1 text-green-600"}),i.jsx("span",{className:"text-xs",children:"Copied!"})]}):i.jsxs(i.Fragment,{children:[i.jsx(Sn,{className:"w-3 h-3 mr-1"}),i.jsx("span",{className:"text-xs",children:"Copy"})]})})]}),(y.detectedLanguage||y.confidence||y.processingTime)&&i.jsxs("div",{className:"results-metadata text-xs text-muted-foreground space-y-1",children:[y.detectedLanguage&&i.jsxs("div",{children:["Language: ",y.detectedLanguage]}),y.confidence&&i.jsxs("div",{children:["Confidence: ",y.confidence]}),y.processingTime&&i.jsxs("div",{children:["Time: ",y.processingTime,"ms"]})]}),i.jsx("div",{className:"results-text flex-1 p-3 bg-muted rounded-lg font-mono text-xs whitespace-pre-wrap break-words overflow-y-auto",children:y.extractedText})]})]})},{DEFAULT_NODE_WIDTH:Rp,DEFAULT_NODE_HEIGHT:Ep}=q,Ap=[],Tp=({node:e,isSelected:t,selectedNodesCount:n,useSimplifiedRendering:o=!1})=>{var I;const s=S.useRef({}),[r,a]=S.useState(!1),l=B(A=>A.uiState.mode),c=B(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.coreState.selectedNodes)??Ap}),d=B(A=>{var T;return((T=A.projectCanvas.getActive())==null?void 0:T.viewState.scale)??1}),u=B(A=>!!A.uiState.dragInfo),g=B(A=>!!A.uiState.resizingNode);s.current={mode:l,selectedNodes:c,scale:d};const p=n??c.length,f=c.some(A=>A.id===e.id),h=t&&p===1,m=c.length>0&&((I=c[c.length-1])==null?void 0:I.id)===e.id,{handleMouseDown:x,initialClickPoint:w}=Of({node:e,mode:l,isPopoverOpen:r,setIsPopoverOpen:a}),b=S.useCallback(A=>{const T={x:A.clientX,y:A.clientY};if(!Wl(w.current,T))return;const y=!e.isEditing&&m;return a(y),y},[e,h,f,m,c.length,r]);S.useEffect(()=>{if(!f){a(!1);return}if(e.isEditing){a(!1);return}u||g||(m?a(!0):f&&!m&&a(!1))},[c,e.isEditing,f,h,m,e.id,u,g]),S.useEffect(()=>{(u||g)&&a(!1)},[u,g]);const N=()=>{if(o){const{jsx:y}=Zg({node:e,isSelected:t,scale:d});return y}const A=e.data,T=(A==null?void 0:A.nodeType)==="workflowOrchestration",E=(A==null?void 0:A.nodeType)==="workflowSource";if(T)return i.jsx(dr,{node:e});if(E)return i.jsx(ur,{node:e,preventEdit:!f});switch(e.type){case K.RECT:return i.jsx(Cu,{node:e});case K.TEXT:return i.jsx(Lu,{node:e});case K.TABLE:return i.jsx(zg,{node:e});case K.TEXTCARD:return i.jsx(Bg,{node:e});case K.WORKFLOW_ORCHESTRATION:return i.jsx(dr,{node:e});case K.WORKFLOW_SOURCE:return i.jsx(ur,{node:e,preventEdit:!f});case K.WORKFLOW_DEFINITION:return i.jsx(Ip,{node:e,preventEdit:!f});case K.OCR:return i.jsx(kp,{node:e});default:return i.jsx("div",{children:"Unknown Node Type"})}},j=Z.getSelectionRingClass(t),C=e.styles;return i.jsx(kf,{node:e,isOpen:r,children:i.jsxs("div",{id:`NodeContainerV2-${e.id}`,className:ae("node-container-main","absolute group","cursor-grab","select-none","rounded","overflow-visible",t&&j),style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width??Rp}px`,height:`${e.height??Ep}px`,transformOrigin:"0 0",border:C==null?void 0:C.border,borderWidth:C==null?void 0:C.borderWidth,borderColor:C==null?void 0:C.borderColor,borderStyle:C!=null&&C.borderWidth?(C==null?void 0:C.borderStyle)||"solid":C==null?void 0:C.borderStyle,willChange:"transform",backfaceVisibility:"hidden"},onPointerDown:x,onPointerUp:b,"data-node-id":e.id,children:[i.jsx(Kg,{node:e,isSingleNodeSelected:h}),e.isPinned&&i.jsx("div",{className:"pin-indicator-border absolute pointer-events-none rounded border-[3px] border-primary",style:{top:"-6px",left:"-6px",right:"-6px",bottom:"-6px",zIndex:1e3}}),(()=>{var v;const A=e.data,T=A==null?void 0:A.nodeType,E=A==null?void 0:A.executionState,y=(v=A==null?void 0:A.executionData)==null?void 0:v.duration;return T&&E?i.jsx(Qg,{executionState:E,duration:y}):null})(),h&&i.jsxs("div",{className:ae("node-actions-sidebar absolute","gap-1","items-center"),style:{left:-50},children:[i.jsx("div",{className:"pin-button-wrapper",children:i.jsx(Ug,{node:e})}),i.jsx("div",{className:"text-editor-button-wrapper",children:e.subContent?i.jsx(Xr,{className:"my-2"}):null}),i.jsx("div",{className:"tag-selector-wrapper",children:i.jsx(Vg,{nodeId:e.id,tags:e.tags})})]}),i.jsxs("section",{className:"node-content-section h-[100%] overflow-visible",children:[i.jsx("div",{id:`node-content-${e.id}`,className:ae("node-content-inner relative w-full h-full overflow-visible","flex",{}),children:N()}),(()=>{var y;const A=e.data,T=(A==null?void 0:A.nodeType)==="manualTrigger",E=(y=A==null?void 0:A.parameters)==null?void 0:y.label;return T?i.jsx("div",{className:"manual-trigger-button-container absolute bottom-2 left-2 right-2 px-2",children:i.jsx(li,{nodeId:e.id,label:E})}):null})(),i.jsxs(i.Fragment,{children:[i.jsx(Mf,{node:e,isSelected:h,mode:l}),i.jsx(_f,{node:e,isSelected:h,mode:l})]})]})]})})};function Dp(e,t){var w,b,N;if(e.node===t.node&&e.isSelected===t.isSelected&&e.selectedNodesCount===t.selectedNodesCount&&e.useSimplifiedRendering===t.useSimplifiedRendering)return!0;const n=e.node.x===t.node.x,o=e.node.y===t.node.y,s=n&&o,r=e.node.width===t.node.width,a=e.node.height===t.node.height,l=r&&a,c=e.isSelected===t.isSelected,d=e.node.content===t.node.content,u=e.node.type===t.node.type,g=e.node.isEditing===t.node.isEditing,p=e.node.styles===t.node.styles,f=((w=e.node.tags)==null?void 0:w.length)===((b=t.node.tags)==null?void 0:b.length)&&((N=e.node.tags)==null?void 0:N.every((j,C)=>{var I;return j===((I=t.node.tags)==null?void 0:I[C])})),h=e.node.isPinned===t.node.isPinned,m=e.selectedNodesCount===t.selectedNodesCount;return!!(s&&l&&c&&d&&u&&g&&p&&f&&h&&m)}const Bo=je.memo(({node:e,isSelected:t,selectedNodesCount:n,useSimplifiedRendering:o})=>i.jsx(Tp,{node:e,isSelected:t,selectedNodesCount:n,useSimplifiedRendering:o}),Dp),Mp=e=>{const{className:t,style:n}=e,o=B(l=>l.uiState.mode),s=B(l=>l.uiState.zoomSubMode),r=B(l=>l.uiState.writeSubMode);let a=o;return o===H.ZOOM&&s==="zoom:lock"?a="zoom:lock":o===H.WRITE&&r===Le.AUDIO&&(a="write:audio"),i.jsxs("div",{className:`text-xs p-1 bg-background/50 rounded pointer-events-auto ${t}`,style:{...n},"data-test":"canvas-mode-info",children:["Mode: ",a||"N/A"]})},Pp=e=>{const{className:t,style:n}=e,[o,s]=S.useState(1),[r,a]=S.useState([]);S.useEffect(()=>{const x=$.subscribe(N=>{const j=N.projectCanvas.getActive();j&&s(j.viewState.scale),a(N.uiState.zoomMarks||[])}),w=$.getState(),b=w.projectCanvas.getActive();return b&&s(b.viewState.scale),a(w.uiState.zoomMarks||[]),x},[]);const l=x=>{const w=x[0],b=$.getState(),N=b.projectCanvas.getActive();if(!N)return;const{scale:j,offset:C}=N.viewState,I=document.getElementById("CanvasAppV2");if(!I)return;const A=I.getBoundingClientRect(),T={x:A.width/2,y:A.height/2},E=Te(T,j,C),y=T.x-E.x*w,v=T.y-E.y*w,k=isNaN(y)?0:y,R=isNaN(v)?0:v,M=isNaN(w)?1:w;b.setActiveCanvasViewState(D=>({...D,scale:M,offset:{x:k,y:R}}))},{min:c,max:d,marks:u}=Z.zoom,g=Math.round(o*100),p=Array.from(new Set([...u,...r])).sort((x,w)=>x-w),f=()=>{const x=Math.round(o*100)/100;$.getState().addZoomMark(x)},h=x=>{$.getState().removeZoomMark(x)},m=x=>r.includes(x);return i.jsxs("div",{"data-ui-panel":"zoom-slider","data-test":"canvas-zoom-slider",className:`flex flex-col gap-2 p-2 bg-background/50 rounded pointer-events-auto min-w-[200px] ${t}`,style:{...n},children:[i.jsxs("div",{className:"flex items-center justify-between text-xs",children:[i.jsx("span",{children:"Zoom"}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("span",{className:"font-mono",children:[g,"%"]}),i.jsx(X,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0",onClick:f,title:"Save current zoom level","data-test":"canvas-zoom-save-button",children:i.jsx(Oe,{className:"h-3 w-3"})})]})]}),i.jsxs("div",{className:"relative",children:[i.jsx(ki,{value:[o],onValueChange:l,min:c,max:d,step:.01,className:"cursor-pointer","data-test":"canvas-zoom-slider"}),i.jsx("div",{className:"relative h-4 mt-1 px-3",children:p.map(x=>{const w=(x-c)/(d-c)*100,b=m(x);return i.jsxs("div",{className:"absolute flex flex-col items-center group",style:{left:`${w}%`,transform:"translateX(-50%)"},children:[i.jsxs("div",{className:"cursor-pointer hover:opacity-70 transition-opacity flex flex-col items-center",onClick:()=>l([x]),title:`Zoom to ${Math.round(x*100)}%`,children:[i.jsx("div",{className:`w-px h-2 ${b?"bg-primary/60":"bg-muted-foreground/40"}`}),i.jsx("span",{className:`text-[10px] mt-0.5 ${b?"text-primary":"text-muted-foreground"}`,children:x===1?"1Ã—":`${x}Ã—`})]}),b&&i.jsx("button",{className:"opacity-0 group-hover:opacity-100 absolute -top-2 right-0 h-3 w-3 rounded-full bg-destructive/80 hover:bg-destructive flex items-center justify-center transition-opacity",onClick:N=>{N.stopPropagation(),h(x)},title:"Remove mark","data-test":"canvas-zoom-remove-mark-button",children:i.jsx(Ze,{className:"h-2 w-2 text-destructive-foreground"})})]},x)})})]})]})},hs=e=>{const{header:t,itemList:n,maxHeight:o,selectedIndices:s,selectedValues:r,getItemValue:a=(P,O)=>O,onSelectionChange:l,searchable:c=!1,searchPlaceholder:d="Search...",filterItem:u=(P,O)=>String(P).toLowerCase().includes(O.toLowerCase()),showAllOption:g=c,allOptionLabel:p="All",enableDelete:f=!1,onItemDelete:h,itemStyles:m="",moreOptions:x,initiallyCollapsed:w=!1,...b}=e,N=S.useRef({}),j=S.useRef(!1),[C,I]=S.useState(new Set(s)),[A,T]=S.useState(s==null?void 0:s[s.length-1]),[E,y]=S.useState(""),[v,k]=S.useState(w);S.useEffect(()=>{const P=Array.from(C),O=s||[];if(P.length!==O.length||!P.every((W,z)=>W===O[z])){j.current=!0,I(new Set(s));const W=s==null?void 0:s[s.length-1];T(W)}},[s]),S.useEffect(()=>{if(r===void 0)return;const P=new Set,O=new Set(r);if(n.forEach((W,z)=>{O.has(a(W,z))&&P.add(z)}),P.size!==C.size||!Array.from(P).every(W=>C.has(W))){j.current=!0,I(P);const W=r[r.length-1],z=n.findIndex((U,V)=>a(U,V)===W);T(z!==-1?z:void 0)}},[r,n,a]),S.useEffect(()=>{if(j.current){const P=A;if(P!==void 0&&C.has(P)){const O=N.current[P];O&&O.scrollIntoView({behavior:"smooth",block:"nearest"})}j.current=!1}},[C,A]);const R=(P,O)=>{const W=L[P],z=n.findIndex(V=>V===W);if(z===-1)return;let U=new Set(C);if(O.shiftKey&&A!==void 0){const V=Math.min(A,z),ee=Math.max(A,z);for(let te=V;te<=ee;te++)L.some(ye=>n[te]===ye)&&U.add(te)}else O.ctrlKey||O.metaKey?(U.has(z)?U.delete(z):U.add(z),T(z)):(U=new Set([z]),T(z));if(I(U),l){const V=Array.from(U),ee=V.map(te=>a(n[te],te));l(V,ee)}},M=(P,O)=>{if(O.stopPropagation(),h){const W=a(n[P],P);h(P,W)}},D=()=>{y(""),I(new Set),T(void 0),l&&l([],[])},_=()=>{k(!v)},L=E&&c?n.filter((P,O)=>u(P,E,O)):n;return i.jsxs("div",{id:"UiList","data-test":"ui-list-container",className:"bg-background text-foreground select-none",...b,children:[t?i.jsxs("div",{id:"header-container","data-test":"ui-list-header-container",className:"flex justify-between items-center sticky top-0 bg-background z-10 py-2 px-2 border-b border-border",children:[i.jsx("div",{"data-test":"ui-list-header-content",className:`flex-grow ${typeof t=="string"?"font-bold":""}`,children:t}),x&&i.jsx("div",{className:"flex items-center ml-2 flex-shrink-0","data-test":"ui-list-more-options",children:x}),i.jsx(X,{variant:"ghost",size:"sm",onClick:_,className:"p-1 h-auto flex-shrink-0","aria-label":v?"Expand list":"Collapse list","data-test":"ui-list-collapse-toggle",children:v?i.jsx(Ut,{size:16}):i.jsx(Ia,{size:16})})]}):null,!v&&i.jsxs(i.Fragment,{children:[c&&i.jsx("div",{className:"sticky top-0 bg-background z-10 py-2 px-2 border-b border-border","data-test":"ui-list-search-container",children:i.jsx("input",{type:"text",className:"w-full px-3 py-2 border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:d,value:E,onChange:P=>y(P.target.value),"data-test":"ui-list-search-input"})}),i.jsxs("div",{id:"itemList","data-test":"ui-list-items-container",className:ae("space-y-1 py-1 p-2 overflow-auto"),style:{maxHeight:o},children:[c&&g&&i.jsx("div",{className:`p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${!E&&C.size===0?"bg-accent text-accent-foreground font-semibold":""} select-none ${m}`,onClick:D,"data-test":"ui-list-all-option",children:p}),L.map((P,O)=>{const W=P,z=n.findIndex(V=>V===W),U=C.has(z);return i.jsxs("div",{ref:V=>N.current[z]=V,className:`flex justify-between items-center p-0.5 cursor-pointer rounded-sm hover:bg-accent hover:text-accent-foreground ${U?"bg-accent text-accent-foreground font-semibold":""} select-none ${m}`,onClick:V=>R(O,V),"data-test":`ui-list-item-${z}`,children:[i.jsx("span",{className:"flex-grow","data-test":`ui-list-item-content-${z}`,children:P}),f&&i.jsx(ka,{onClick:V=>M(z,V),className:"ml-2 px-1 py-0 text-xs text-destructive-foreground rounded hover:bg-destructive/80 focus:outline-none focus:ring-1 focus:ring-destructive","aria-label":`Delete item ${z+1}`,"data-test":`ui-list-item-delete-${z}`})]},z)})]})]})]})},_p=(e,t)=>S.useMemo(()=>{if(t.length!==1)return-1;const n=t[0].id;return e.findIndex(o=>o.id===n)},[e,t]),Op={[K.RECT]:i.jsx(hn,{className:"w-4 h-4"}),[K.TEXT]:i.jsx(Ra,{className:"w-4 h-4"})},gi=e=>Op[e]??null,vt=S.forwardRef(({tooltip:e,children:t,...n},o)=>i.jsx(ft,{children:i.jsxs(gt,{children:[i.jsx(pt,{asChild:!0,children:i.jsx(X,{ref:o,...n,children:t})}),i.jsx(ht,{children:typeof e=="string"?i.jsx("p",{children:e}):e})]})}));vt.displayName="ButtonWithTooltip";const Fp=({nodes:e,selectedNodes:t,updateNodes:n,saveStateToLocalStorage:o})=>{const[s,r]=S.useState(!1),[a,l]=S.useState(null),[c,d]=S.useState(!1),u=S.useRef(null),g=S.useCallback(h=>{const x=(c?e:t).map(w=>{const b=w.tags||[];if(b.some(C=>C.title===h))return w;const j={id:Math.random().toString(36).slice(2,10),title:h};return{...w,tags:[...b,j]}});n(x),o()},[c,e,t,n,o]),p=S.useCallback(h=>{const x=(c?e:t).map(w=>{const b=w.tags||[];return b.some(j=>j.title===h)?{...w,tags:b.filter(j=>j.title!==h)}:w});n(x),o()},[c,e,t,n,o]),f=je.useMemo(()=>{const h=c?e:t,m=new Set;return h.forEach(x=>{(x.tags||[]).forEach(w=>m.add(w.title))}),Array.from(m).sort()},[c,e,t]);return i.jsxs(i.Fragment,{children:[i.jsx(vt,{ref:u,onMouseDown:h=>h.stopPropagation(),onClick:h=>{if(h.stopPropagation(),u.current){const m=u.current.getBoundingClientRect();l({x:m.left,y:m.bottom+4})}r(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Tag nodes","data-test":"nodes-info-tag-button",children:i.jsx(bn,{})}),i.jsx(We,{isVisible:s,onClose:()=>r(!1),title:"Tag Nodes",triggerPosition:a??void 0,children:i.jsxs("div",{className:"p-3 space-y-3",children:[i.jsxs("div",{className:"apply-to-section space-y-2 pb-2 border-b",children:[i.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:c,onChange:h=>d(h.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"tag-apply-to-all-checkbox"}),i.jsx("span",{children:"Apply to all nodes"})]}),i.jsx("div",{className:"text-xs text-muted-foreground ml-6",children:c?`Will apply to all ${e.length} nodes`:`Will apply to ${t.length} selected node${t.length!==1?"s":""}`})]}),i.jsx(ri,{tags:f,onAddTag:g,onRemoveTag:p})]})})]})},$p=(e,t,n,o)=>{const s=n?t:t.toLowerCase(),r=[];if(o){if(!e.title)return null;const c=n?e.title:e.title.toLowerCase();let d=0,u=c.indexOf(s,d);for(;u!==-1;){const g=Math.max(0,u-40),p=Math.min(e.title.length,u+s.length+40);let f=e.title.substring(g,p);g>0&&(f="..."+f),p<e.title.length&&(f=f+"..."),r.push({context:f,startIndex:u}),d=u+1,u=c.indexOf(s,d)}return r.length===0?null:{nodeId:e.id,node:e,matches:r}}if(typeof e.content!="string")return null;const l=e.content.split(`
`);return l.forEach((c,d)=>{const u=n?c:c.toLowerCase();let g=0,p=u.indexOf(s,g);for(;p!==-1;){const f=Math.max(0,p-40),h=Math.min(c.length,p+s.length+40);let m=c.substring(f,h);f>0&&(m="..."+m),h<c.length&&(m=m+"..."),r.push({lineNumber:l.length>1?d+1:void 0,context:m,startIndex:p}),g=p+1,p=u.indexOf(s,g)}}),r.length===0?null:{nodeId:e.id,node:e,matches:r}},Lp=e=>{const{node:t,matches:n}=e,o=gi(t.type),s=String(t.content),r=s?`${s.substring(0,15)}${s.length>15?"...":""}`:"(No Content)",a=t.id.substring(0,6),l=`[x:${Math.round(t.x)},y:${Math.round(t.y)}]`,c=`[w:${Math.round(t.width??0)},h:${Math.round(t.height??0)}]`;return i.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5",children:[i.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full",children:[i.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0",children:[o&&i.jsx("span",{className:"flex-shrink-0",children:o}),i.jsx("span",{className:"truncate",children:r}),t.isEditing&&i.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0",children:"[E]"}),i.jsxs(Vt,{variant:"secondary",className:"ml-1 text-[10px] px-1 py-0",children:[n.length," ",n.length===1?"match":"matches"]})]}),i.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1",children:a})]}),i.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1",children:[l," ",c]})]})},Hp=(e,t,n,o)=>{const s=n?t:t.toLowerCase(),a=(n?e.context:e.context.toLowerCase()).indexOf(s);if(a===-1)return i.jsxs("div",{className:"text-xs font-mono flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&i.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),i.jsx("span",{className:"flex-1",children:e.context})]});const l=e.context.substring(0,a),c=e.context.substring(a,a+t.length),d=e.context.substring(a+t.length);return i.jsxs("div",{className:"text-xs font-mono break-all flex gap-2 cursor-pointer hover:bg-accent/50 rounded px-1 -mx-1",children:[e.lineNumber&&i.jsxs("span",{className:"text-muted-foreground flex-shrink-0 min-w-[50px] text-right",children:["L",e.lineNumber,":"]}),i.jsxs("span",{className:"flex-1",children:[l,i.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-600 font-semibold",children:c}),d]})]})},Wp=({nodes:e,setSelectedNodes:t})=>{const[n,o]=S.useState(!1),[s,r]=S.useState(null),[a,l]=S.useState(""),[c,d]=S.useState(!1),[u,g]=S.useState(!1),p=S.useRef(null),[f,h]=S.useState(new Set),m=S.useMemo(()=>{if(!a.trim())return[];const C=[];return e.forEach(I=>{if(f.has(I.id))return;const A=$p(I,a,c,u);A&&C.push(A)}),C},[e,a,c,u,f]),x=S.useMemo(()=>m.reduce((C,I)=>C+I.matches.length,0),[m]),w=S.useCallback(()=>{if(m.length>0){const C=m.map(I=>I.node);t(C)}},[m,t]),b=S.useCallback(C=>{h(I=>new Set(I).add(C))},[]),N=S.useCallback(C=>{const I=C.node;t([I]),$.getState().scrollToNode(I.id)},[t]),j=S.useCallback((C,I)=>{const A=C.node;t([A]);const E=I?(I-1)*20:0;cs(A,{highlightYOffset:E})},[t]);return i.jsxs(i.Fragment,{children:[i.jsx(vt,{ref:p,onMouseDown:C=>C.stopPropagation(),onClick:C=>{if(C.stopPropagation(),p.current){const I=p.current.getBoundingClientRect();r({x:I.left,y:I.bottom+4})}o(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Find nodes","data-test":"nodes-info-find-button",children:i.jsx(ho,{})}),i.jsx(We,{isVisible:n,onClose:()=>{o(!1)},title:"Find Nodes",triggerPosition:s??void 0,shouldCloseManually:!0,children:i.jsxs("div",{className:"p-3 space-y-3",children:[i.jsxs("div",{className:"search-section space-y-2",children:[i.jsx("div",{className:"search-label text-xs font-semibold text-muted-foreground",children:"Search"}),i.jsxs("div",{className:"search-input-group flex gap-2",children:[i.jsx(it,{placeholder:u?"Search node titles...":"Search node content...",value:a,onChange:C=>l(C.target.value),onKeyDown:C=>{C.key==="Enter"&&a.trim()&&(C.preventDefault(),w())},className:"search-input h-8 text-sm",autoFocus:!0,"data-test":"find-nodes-search-input"}),i.jsx(vt,{variant:"default",size:"sm",className:"find-button h-8",onClick:w,disabled:!a.trim()||m.length===0,tooltip:"Search nodes","data-test":"find-nodes-search-button",children:i.jsx(ho,{})})]})]}),i.jsxs("div",{className:"options-section space-y-2",children:[i.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:c,onChange:C=>d(C.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"find-nodes-case-sensitive-checkbox"}),i.jsx("span",{children:"Case sensitive"})]}),i.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:u,onChange:C=>g(C.target.checked),className:"w-4 h-4 cursor-pointer","data-test":"find-nodes-only-title-checkbox"}),i.jsx("span",{children:"Only find in title"})]})]}),a.trim()&&i.jsx("div",{className:"results-section space-y-2",children:i.jsx("div",{className:"results-info flex items-center justify-between",children:i.jsx("span",{className:"text-xs text-muted-foreground",children:m.length===0?"No matches found":i.jsxs(i.Fragment,{children:["Found ",i.jsx(Vt,{variant:"secondary",className:"mx-1",children:x}),x===1?"match":"matches"," in"," ",i.jsx(Vt,{variant:"secondary",className:"mx-1",children:m.length}),m.length===1?"node":"nodes"]})})})}),m.length>0&&i.jsx("div",{className:"nodes-list-section space-y-2 max-h-[400px] overflow-y-auto",children:m.map(C=>i.jsx("div",{className:"node-matches-container border border-border rounded-md overflow-hidden",children:i.jsxs("div",{className:"relative",children:[i.jsx("button",{onClick:()=>b(C.nodeId),className:"absolute top-2 right-2 z-10 p-1 hover:bg-destructive/20 rounded transition-colors",title:"Remove from results","data-test":"find-nodes-remove-result-button",children:i.jsx(Ze,{className:"w-4 h-4 text-destructive"})}),i.jsxs("div",{className:"bg-background text-foreground select-none",children:[i.jsx("div",{className:"flex justify-between items-center py-2 px-2 border-b border-border cursor-pointer hover:bg-accent/50",onClick:()=>N(C),children:Lp(C)}),i.jsx("div",{className:"space-y-1 py-1 p-2 overflow-auto",style:{maxHeight:"200px"},children:C.matches.map((I,A)=>i.jsx("div",{onClick:T=>{T.stopPropagation(),j(C,I.lineNumber)},children:Hp(I,a,c)},A))})]})]})},C.nodeId))})]})})]})},zp=({nodes:e,selectedNodes:t,updateNodes:n,saveStateToLocalStorage:o})=>{var N;const s=$.getState(),r=s.setNodeUpdateSettings,a=((N=s.uiState)==null?void 0:N.nodeUpdateSettings)??{deleteInAllNodes:!0,deleteWholeLine:!1,searchHistory:[]},[l,c]=S.useState(!1),[d,u]=S.useState(a.searchHistory[0]??""),[g,p]=S.useState(null),f=je.useRef(null),[h,m]=S.useState(a.deleteInAllNodes),[x,w]=S.useState(a.deleteWholeLine),b=S.useCallback(()=>{if(!d)return;const C=(h?e:t).map(A=>{if(typeof A.content!="string")return A;let T=A.content;x?T=T.split(`
`).filter(R=>!R.includes(d)).join(`
`):T=T.split(d).join("");const E=A.width??q.DEFAULT_NODE_WIDTH,y=st(T,E)+q.NODE_Y_PADDING*2;return{...A,content:T,height:y}});n(C);const I=[d,...a.searchHistory.filter(A=>A!==d)].slice(0,10);r({deleteInAllNodes:h,deleteWholeLine:x,searchHistory:I}),o(),console.log(`Deleted "${d}" from ${C.length} nodes (wholeLine: ${x})`)},[d,h,x,e,t,n,a.searchHistory,r,o]);return i.jsxs(i.Fragment,{children:[i.jsx(vt,{ref:f,onMouseDown:j=>j.stopPropagation(),onClick:j=>{if(j.stopPropagation(),f.current){const C=f.current.getBoundingClientRect();p({x:C.left,y:C.bottom+4})}c(!0)},variant:"ghost",size:"smIcon",className:"p-0.5 h-auto",tooltip:"Update nodes","data-test":"nodes-info-update-button",children:i.jsx(Ea,{})}),i.jsx(We,{isVisible:l,onClose:()=>c(!1),title:"Update Nodes",triggerPosition:g??void 0,children:i.jsxs("div",{className:"p-3 space-y-3",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("input",{type:"text",value:d,onChange:j=>u(j.target.value),placeholder:"Text to delete...",className:"flex-1 px-2 py-1 text-sm border rounded bg-background","data-test":"update-nodes-search-input"}),i.jsxs("button",{onClick:b,disabled:!d,className:"flex items-center gap-1 px-2 py-1 text-sm rounded bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors","data-test":"update-nodes-delete-button",children:[i.jsx(Ke,{className:"w-3 h-3"}),"Delete"]})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:h,onChange:j=>{const C=j.target.checked;m(C),r({deleteInAllNodes:C}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-all-nodes-checkbox"}),i.jsx("span",{children:"Delete in all nodes"})]}),i.jsxs("label",{className:"flex items-center gap-2 text-sm cursor-pointer",children:[i.jsx("input",{type:"checkbox",checked:x,onChange:j=>{const C=j.target.checked;w(C),r({deleteWholeLine:C}),o()},className:"w-4 h-4 cursor-pointer","data-test":"update-nodes-whole-line-checkbox"}),i.jsx("span",{children:"Delete whole line"})]})]}),i.jsx("div",{className:"text-xs text-muted-foreground",children:h?`Will update all ${e.length} nodes`:`Will update ${t.length} selected node${t.length!==1?"s":""}`})]})})]})},Bp=e=>{const t=gi(e.type),n=String(e.content??""),o=n?`${n.substring(0,15)}${n.length>15?"...":""}`:"(No Content)",s=e.id.substring(0,6),r=`[x:${Math.round(e.x)},y:${Math.round(e.y)}]`,a=`[w:${Math.round(e.width??0)},h:${Math.round(e.height??0)}]`;return i.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"node-display-element",children:[i.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"node-display-top-row",children:[i.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"node-display-content",children:[t&&i.jsx("span",{className:"flex-shrink-0","data-test":"node-display-icon",children:t}),i.jsx("span",{className:"truncate","data-test":"node-display-text",children:o}),e.isEditing&&i.jsx("span",{className:"text-blue-500 ml-1 flex-shrink-0","data-test":"node-display-editing-indicator",children:"[E]"})]}),i.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"node-display-id",children:s})]}),i.jsxs("div",{className:"text-muted-foreground text-[10px] w-full pr-1","data-test":"node-display-coords",children:[r," ",a]})]})},Vp=e=>{const{className:t,style:n}=e,o=$.getState(),s=o.projectCanvas.getActive(),r=(s==null?void 0:s.coreState.nodes)??[],a=(s==null?void 0:s.coreState.selectedNodes)??[],l=o.setSelectedNodes,c=o.scrollToNode,d=o.updateNodes,u=o.saveStateToLocalStorage,g=S.useCallback((h,m)=>{const x=h.length>0?h[0]:-1;if(x>=0&&x<r.length){const w=r[x];l([w]),c(w.id)}else l([])},[r,l,c]),p=_p(r,a),f=p!==-1?[p]:[];return i.jsx("div",{"data-ui-panel":"canvas-node-infos","data-test":"canvas-node-infos-container",className:ae("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded p-1 pointer-events-auto border",t),style:{...n},onMouseDown:h=>h.stopPropagation(),children:i.jsx(hs,{header:i.jsx("span",{className:"text-xs","data-test":"canvas-node-infos-header",children:"Nodes"}),itemList:r.map(Bp),onSelectionChange:g,selectedIndices:f,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0,moreOptions:i.jsxs(i.Fragment,{children:[i.jsx(Wp,{nodes:r,setSelectedNodes:l}),i.jsx(Fp,{nodes:r,selectedNodes:a,updateNodes:d,saveStateToLocalStorage:u}),i.jsx(zp,{nodes:r,selectedNodes:a,updateNodes:d,saveStateToLocalStorage:u})]})})})},Up=()=>{const e=$.getState(),t=e.exportCanvasData,n=e.importCanvasData,o=S.useRef(null),[s,r]=S.useState(!1),[a,l]=S.useState(!1),[c,d]=S.useState(!1),[u,g]=S.useState(null),p=()=>{var m;(m=o.current)==null||m.click()},f=m=>{var b;const x=(b=m.target.files)==null?void 0:b[0];if(!x)return;l(!0),g(null);const w=new FileReader;w.onload=N=>{var C;const j=(C=N.target)==null?void 0:C.result;if(typeof j=="string"){const I=n(j,{replace:c});g(I),I.projectsImported>0&&oe.success(`Successfully imported ${I.projectsImported} project${I.projectsImported>1?"s":""}`),I.projectsSkipped>0&&oe.warning(`Skipped ${I.projectsSkipped} project${I.projectsSkipped>1?"s":""} (already exist)`),I.projectsImported===0&&I.projectsSkipped===0&&oe.error("No projects found in the import file")}else console.error("Failed to read file content."),oe.error("Failed to read file content");l(!1),o.current&&(o.current.value="")},w.onerror=N=>{console.error("Error reading file:",N),oe.error("Error reading file"),l(!1),o.current&&(o.current.value="")},w.readAsText(x)},h=()=>{r(!1),g(null),d(!1)};return i.jsxs("div",{className:"flex space-x-2","data-test":"canvas-data-io",children:[i.jsxs(X,{variant:"outline",size:"sm",onClick:t,"data-test":"canvas-export-button",children:["Export ",i.jsx(Aa,{})]}),i.jsxs(Sr,{open:s,onOpenChange:r,children:[i.jsx(yr,{asChild:!0,children:i.jsxs(X,{variant:"outline",size:"sm","data-test":"canvas-import-button",children:["Import ",i.jsx(Ta,{})]})}),i.jsxs(Nr,{"data-test":"canvas-import-dialog",className:"sm:max-w-[500px]",children:[i.jsxs(br,{children:[i.jsx(Cr,{children:"Import Canvas Projects"}),i.jsx(Ri,{children:"Import canvas projects from a JSON file. You can choose to merge with existing projects or replace them entirely."})]}),i.jsxs("div",{className:"space-y-4 py-4","data-test":"canvas-import-options",children:[i.jsxs("div",{className:"flex items-center justify-between","data-test":"canvas-replace-mode-control",children:[i.jsxs("div",{children:[i.jsx(Ei,{htmlFor:"canvas-replace-mode",className:"text-sm font-medium",children:"Replace existing data"}),i.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"When enabled, all existing projects will be deleted before importing"})]}),i.jsx(Ai,{id:"canvas-replace-mode",checked:c,onCheckedChange:d,disabled:a,"data-test":"canvas-replace-mode-switch"})]}),u&&i.jsx("div",{className:"space-y-2 p-4 border rounded-md bg-muted/50","data-test":"canvas-import-result",children:i.jsxs("div",{className:"space-y-1",children:[u.projectsImported>0&&i.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600","data-test":"canvas-imported-count",children:[i.jsx(xo,{className:"h-4 w-4"}),i.jsxs("span",{children:["Projects imported: ",u.projectsImported]})]}),u.projectsSkipped>0&&i.jsxs("div",{className:"flex items-center gap-2 text-sm text-yellow-600","data-test":"canvas-skipped-count",children:[i.jsx(Nn,{className:"h-4 w-4"}),i.jsxs("span",{children:["Projects skipped (already exist): ",u.projectsSkipped]})]}),u.projectsImported===0&&u.projectsSkipped===0&&i.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600","data-test":"canvas-no-projects",children:[i.jsx(Nn,{className:"h-4 w-4"}),i.jsx("span",{children:"No projects found in the import file"})]})]})})]}),i.jsxs(Ti,{children:[i.jsx(X,{variant:"outline",onClick:h,disabled:a,"data-test":"canvas-import-close-button",children:"Close"}),i.jsx(X,{onClick:p,disabled:a,"data-test":"canvas-import-select-file-button",children:a?"Importing...":"Select File"})]}),i.jsx("input",{type:"file",ref:o,accept:".json",style:{display:"none"},onChange:f,"data-test":"canvas-import-file-input"})]})]})]})},po=({position:e,onMouseDown:t,onDoubleClick:n,variant:o="end",size:s=4,className:r})=>i.jsx("circle",{"data-test":`arrow-handle-${o}`,cx:e.x,cy:e.y,r:s,fill:"hsl(var(--primary))",stroke:"hsl(var(--primary-foreground))",strokeWidth:1,onPointerDown:t,onDoubleClick:n,className:ae("cursor-move",r),style:{pointerEvents:"all",touchAction:"none"}}),fr=Z.arrows.REVERSE_CURVE,Gp=(e,t)=>{const n=(e.x+t.x)/2,o=(e.y+t.y)/2,s=t.x-e.x,r=t.y-e.y,a=Math.sqrt(s*s+r*r);if(a===0)return{path:`M ${e.x} ${e.y}`,controlPoint:e};const l=-r/a,c=s/a;let d=a*.2;(!fr&&e.x<t.x||fr&&e.x>t.x)&&(d=-d);const u=n+l*d,g=o+c*d,p={x:u,y:g};return{path:`M ${e.x} ${e.y} Q ${u} ${g}, ${t.x} ${t.y}`,controlPoint:p}},Yp=Z.arrows.REVERSE_CURVE,Xp=(e,t)=>{let n=t.x-e.x;const o=t.y-e.y,s=Math.sqrt(n*n+o*o),r=Math.max(20,s*.15);if(s===0)return{x:0,y:r};let a=-o,l=n;Yp||(n=-n),n<0&&(a=-a,l=-l);const c=a/s,d=l/s;return{x:c*r,y:d*r}},Kp=(e,t,n)=>{const o=S.useMemo(()=>{const l=t.find(g=>g.id===e.startNodeId),c=t.find(g=>g.id===e.endNodeId),d=l?Ae(e.startNodeId,e.startPoint,e.endPoint,t,e.startRowId):e.startPoint;return c?Ae(e.endNodeId,e.endPoint,d,t,e.endRowId):e.endPoint},[t,e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId]),s=S.useMemo(()=>{const l=t.find(u=>u.id===e.startNodeId),d=t.find(u=>u.id===e.endNodeId)?Ae(e.endNodeId,e.endPoint,e.startPoint,t,e.endRowId):e.endPoint;return l?Ae(e.startNodeId,e.startPoint,d,t,e.startRowId):e.startPoint},[t,e.startNodeId,e.endNodeId,e.startPoint,e.endPoint,e.startRowId,e.endRowId]),r=S.useMemo(()=>{const l=(s.x+o.x)/2,c=(s.y+o.y)/2;if(e.controlPointOffset)return{x:l+e.controlPointOffset.x,y:c+e.controlPointOffset.y};{const d=Xp(s,o),u=o.x-s.x,g=o.y-s.y,p=u>0?l-d.x:l+d.x,f=g<0?c-d.y:c+d.y;return{x:p,y:f}}},[e.controlPointOffset,s,o,n]),{path:a}=S.useMemo(()=>Gp(s,o),[s,o,n]);return{actualStartPoint:s,actualEndPoint:o,bezierPath:a,controlPoint:r}},qp=(e,t,n,o,s)=>{const r=$.getState();r.scrollToArrow;const a=r.uiState.mode,l=r.projectCanvas.getActive(),c=(l==null?void 0:l.viewState.scale)??1,d=(l==null?void 0:l.coreState.nodes)??[],u=r.arrow.setAll,g=r.arrow.setSelected,p=r.setSelectedNodes,[f,h]=S.useState(null),[m,x]=S.useState(null),[w,b]=S.useState(null),N=S.useRef(null),j=S.useCallback((C,I)=>{a!==H.SELECT||C.button!==0&&C.button!==-1||(C.stopPropagation(),h(I),x({x:C.clientX,y:C.clientY}),b({...e,startPoint:t,endPoint:n,controlPointOffset:o}),N.current=I==="start"?t:I==="end"?n:o,s||(p([]),g([e])))},[a,e,t,n,o,s,g,p]);return S.useEffect(()=>{const C=A=>{var L;if(!f||!m||!w)return;const T=A.clientX-m.x,E=A.clientY-m.y,y=T/c,v=E/c,k=f==="start"?w.startPoint:f==="end"?w.endPoint:w.controlPointOffset;let R={x:k.x+y,y:k.y+v};const M=Dn(A.clientX,A.clientY);let D=null,_=null;if(M){D=M.nodeId,_=M.rowId;const P=f==="start"?w.endPoint:f==="end"?w.startPoint:w.controlPointOffset;R=Ae(D,R,P,d,_)}else{const P=An(R,d);if(P&&!(((L=P.data)==null?void 0:L.nodeType)==="workflowOrchestration")){D=P.id;const W=f==="start"?w.endPoint:f==="end"?w.startPoint:w.controlPointOffset;R=Ae(D,R,W,d)}}N.current=R,u(P=>P.map(O=>{if(O.id===w.id){const W={...O};if(f==="start")W.startPoint=R,W.startNodeId=D,W.startRowId=_;else if(f==="end")W.endPoint=R,W.endNodeId=D,W.endRowId=_;else if(f==="control"){const z=O.startNodeId?Ae(O.startNodeId,O.startPoint,O.endPoint,d,O.startRowId):O.startPoint,U=O.endNodeId?Ae(O.endNodeId,O.endPoint,O.startPoint,d,O.endRowId):O.endPoint,V=(z.x+U.x)/2,ee=(z.y+U.y)/2,te={x:R.x-V,y:R.y-ee};W.controlPointOffset=te}return W}return O}))},I=A=>{var E;if(!f||!w)return;const T=N.current;if(T){const y=Dn(A.clientX,A.clientY);let v=null,k=null;const R=f==="start"?w.endPoint:f==="end"?w.startPoint:w.controlPointOffset;let M;if(y)v=y.nodeId,k=y.rowId,M=Ae(v,T,R,d,k);else{const D=An(T,d);D?((E=D.data)==null?void 0:E.nodeType)==="workflowOrchestration"?M=T:(v=D.id,M=Ae(v,T,R,d)):M=T}u(D=>D.map(_=>{if(_.id===w.id){const L={..._};return f==="start"?(L.startPoint=M,L.startNodeId=v,L.startRowId=k):f==="end"&&(L.endPoint=M,L.endNodeId=v,L.endRowId=k),L}return _}))}h(null),x(null),b(null),N.current=null};return f&&(window.addEventListener("pointermove",C),window.addEventListener("pointerup",I)),()=>{window.removeEventListener("pointermove",C),window.removeEventListener("pointerup",I)}},[f,m,w,c,u,d]),{handleMouseDownOnHandle:j}},Zp=(e,t,n)=>`M ${e.x} ${e.y} Q ${t.x} ${t.y} ${n.x} ${n.y}`,Jp=(e,t,n,o)=>`M ${e.x} ${e.y} C ${t.x} ${t.y} ${n.x} ${n.y} ${o.x} ${o.y}`,Vo=({startPoint:e,endPoint:t,controlPoint:n,cubicControlPoints:o,useCurvedArrows:s,stroke:r,strokeWidth:a,markerEndId:l,strokeDasharray:c,isHitbox:d=!1,onPointerDown:u})=>{s=!0;const g={stroke:r,strokeWidth:a,fill:"none",strokeDasharray:c,markerEnd:!d&&l?`url(#${l})`:void 0,onPointerDown:u,style:{pointerEvents:"auto"}};if(s&&o&&o.length===2){const[p,f]=o,h=Jp(e,p,f,t);return i.jsx("path",{d:h,...g})}if(s&&n){const p=Zp(e,n,t);return i.jsx("path",{d:p,...g})}return i.jsx("line",{x1:e.x,y1:e.y,x2:t.x,y2:t.y,...g})},Qp=({isSelected:e,label:t,labelPosition:n,labelInput:o,setLabelInput:s,onLabelChange:r,onLabelBlur:a,onLabelKeyDown:l})=>{const f=t.length*7.199999999999999+12,h=20;return e?i.jsx("foreignObject",{x:n.x-50,y:n.y-15,width:"100",height:"30",style:{pointerEvents:"auto"},children:i.jsx(it,{"data-test":"arrow-label-input",type:"text",value:o,onChange:r,onBlur:a,onKeyDown:l,onMouseDown:m=>m.stopPropagation(),placeholder:"Label",className:"w-full h-full text-[12px]! text-center p-0.5 bg-background border border-border rounded-sm focus:ring-1 focus:ring-ring focus:outline-none"})}):t?i.jsxs(i.Fragment,{children:[i.jsx("rect",{x:n.x-f/2,y:n.y-h/2,width:f,height:h,fill:"hsl(var(--background))",rx:"3",ry:"3",style:{pointerEvents:"none"}}),i.jsx("text",{x:n.x,y:n.y,fill:"hsl(var(--foreground))",fontSize:12,textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:t})]}):null},eh=({markerId:e,strokeColor:t,markerOrientation:n})=>i.jsx("defs",{children:i.jsx("marker",{id:e,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:n,markerUnits:"strokeWidth",children:i.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:t})})}),th=({arrow:e})=>{const t=B(y=>{var v,k;return((k=(v=y.projectCanvas.getActive())==null?void 0:v.coreState.selectedArrows)==null?void 0:k.some(R=>R.id===e.id))??!1}),n=B(y=>y.uiState.mode),o=B(y=>y.arrow.setSelected),s=B(y=>y.setSelectedNodes),r=B(y=>{var v;return((v=y.projectCanvas.getActive())==null?void 0:v.coreState.nodes)??[]}),a=!0,l=B(y=>y.arrow.update),{actualStartPoint:c,actualEndPoint:d,controlPoint:u}=Kp(e,r,a),{handleMouseDownOnHandle:g}=qp(e,c,d,u,t),p=y=>{n!==H.SELECT||y.button!==0&&y.button!==-1||(y.stopPropagation(),s([]),o([e]))},f=y=>{y.stopPropagation(),l(e.id,{controlPointOffset:null})},[h,m]=S.useState(e.label||"");S.useEffect(()=>{m(e.label||"")},[e.label]);const x=y=>{m(y.target.value),l(e.id,{label:y.target.value})},w=()=>{e.label!==h&&l(e.id,{label:h})},b=y=>{y.key==="Enter"&&y.currentTarget.blur(),y.stopPropagation()},N=0,j=S.useMemo(()=>{if(u){const y=(c.x+d.x)/2,v=(c.y+d.y)/2;return{x:y-(u.x-y),y:v-(u.y-v)+N}}return{x:(c.x+d.x)/2,y:(c.y+d.y)/2+N}},[c,d,u,a]),C=t?Z.arrows.styles.lineSelected:Z.arrows.styles.line,I=t?1.5:1,A=t&&n===H.SELECT,T="auto-start-reverse",E=`arrowhead-${e.id}`;return i.jsxs("g",{"data-arrow-id":e.id,style:{cursor:n===H.SELECT?"pointer":"default"},children:[i.jsx(eh,{markerId:E,strokeColor:C,markerOrientation:T}),i.jsx(Vo,{startPoint:c,endPoint:d,controlPoint:u,useCurvedArrows:a,stroke:C,strokeWidth:I,markerEndId:E}),i.jsx(Vo,{startPoint:c,endPoint:d,controlPoint:u,useCurvedArrows:a,stroke:"transparent",strokeWidth:15,isHitbox:!0,onPointerDown:p}),A&&i.jsxs(i.Fragment,{children:[i.jsx(po,{position:c,onMouseDown:y=>g(y,"start")}),i.jsx(po,{position:d,onMouseDown:y=>g(y,"end")}),u&&i.jsx(po,{position:u,onMouseDown:y=>g(y,"control"),onDoubleClick:f,variant:"control"})]}),i.jsx(Qp,{isSelected:t,label:e.label||"",labelPosition:j,labelInput:h,setLabelInput:m,onLabelChange:x,onLabelBlur:w,onLabelKeyDown:b})]})};function nh(e,t){const n=e.arrow,o=t.arrow,s=n.startPoint.x===o.startPoint.x&&n.startPoint.y===o.startPoint.y,r=n.endPoint.x===o.endPoint.x&&n.endPoint.y===o.endPoint.y,a=n.label===o.label,l=n.controlPointOffset==null&&o.controlPointOffset==null||n.controlPointOffset!=null&&o.controlPointOffset!=null&&n.controlPointOffset.x===o.controlPointOffset.x&&n.controlPointOffset.y===o.controlPointOffset.y;return s&&r&&a&&l}const pi=je.memo(th,nh),oh=e=>{const t=i.jsx(Gt,{className:"h-3 w-3"}),n=e.startNodeId?`Node ${e.startNodeId.substring(0,4)}`:`(${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)})`,o=e.endNodeId?`Node ${e.endNodeId.substring(0,4)}`:`(${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)})`,s=`${n} -> ${o}`,r=e.id.substring(0,6),a=`S: [${Math.round(e.startPoint.x)}, ${Math.round(e.startPoint.y)}]`,l=`E: [${Math.round(e.endPoint.x)}, ${Math.round(e.endPoint.y)}]`;return i.jsxs("div",{className:"flex flex-col text-xs w-full space-y-0.5","data-test":"arrow-display-element",children:[i.jsxs("div",{className:"flex items-center justify-between space-x-1.5 w-full","data-test":"arrow-display-top-row",children:[i.jsxs("div",{className:"flex items-center space-x-1.5 flex-grow min-w-0","data-test":"arrow-display-content",children:[t&&i.jsx("span",{className:"flex-shrink-0","data-test":"arrow-display-icon",children:t}),i.jsx("span",{className:"truncate","data-test":"arrow-display-text",children:s})]}),i.jsx("span",{className:"text-muted-foreground text-[10px] flex-shrink-0 ml-1","data-test":"arrow-display-id",children:r})]}),i.jsxs("div",{className:"text-muted-foreground text-[10px] w-full flex justify-between pr-1","data-test":"arrow-display-coords",children:[i.jsx("span",{"data-test":"arrow-display-start-coords",children:a}),i.jsx("span",{"data-test":"arrow-display-end-coords",children:l})]})]})},sh=(e,t)=>t.length!==1?-1:e.findIndex(n=>n.id===t[0].id),rh=e=>{const{className:t,style:n}=e,o=$.getState(),s=o.projectCanvas.getActive(),r=(s==null?void 0:s.coreState.arrows)??[],a=(s==null?void 0:s.coreState.selectedArrows)??[],l=o.arrow.setSelected,c=o.scrollToArrow,d=S.useCallback((p,f)=>{const h=p.length>0?p[0]:-1;if(h>=0&&h<r.length){const m=r[h];l([m]),c(m),console.log("Selected arrow from list:",m.id)}else l([])},[r,l]),u=sh(r,a),g=u!==-1?[u]:[];return i.jsx("div",{"data-test":"canvas-arrow-infos-container",className:ae("max-h-[30vh] overflow-scroll","w-62 bg-background/80 rounded p-1 pointer-events-auto border",t),style:{...n},onMouseDown:p=>p.stopPropagation(),children:i.jsx(hs,{header:i.jsx("span",{className:"text-xs","data-test":"canvas-arrow-infos-header",children:"Arrows"}),itemList:r.map(oh),onSelectionChange:d,selectedIndices:g,maxHeight:"calc(100% - 40px)",allOptionLabel:"None",initiallyCollapsed:!0})})},ih=()=>{const e=B(a=>a.uiState.temporaryArrow),t=B(a=>{var l;return((l=a.uiState)==null?void 0:l.useCurvedArrows)??!1}),{startPoint:n,endPoint:o}=e??{};if(!n||!o)return null;const s=t?"auto-start-reverse":"auto",r="temporary-arrowhead";return i.jsxs("g",{children:[i.jsx("defs",{children:i.jsx("marker",{id:r,markerWidth:"10",markerHeight:"7",refX:"10",refY:"3.5",orient:s,markerUnits:"strokeWidth",children:i.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"grey"})})}),i.jsx(Vo,{startPoint:n,endPoint:o,useCurvedArrows:t,stroke:"grey",strokeWidth:1,strokeDasharray:"4 2",markerEndId:r})]})},ah=30,lh=2e3,ch=()=>{const[e,t]=S.useState(0),n=S.useRef(0),o=S.useRef(performance.now()),s=S.useRef(performance.now()),r=S.useRef([]);return S.useEffect(()=>{let a=!0;function l(){n.current+=1;const c=performance.now();if(c-o.current>=1e3){const d=n.current;t(d),r.current.push(d),r.current.length>10&&r.current.shift(),c-s.current>=lh&&(s.current=c),n.current=0,o.current=c}a&&requestAnimationFrame(l)}return requestAnimationFrame(l),()=>{a=!1}},[]),i.jsxs("div",{className:"text-xs pl-1",style:{color:e<ah?"red":"inherit"},children:["FPS: ",e]})},Pt=1e3,_t=500,dh=({scale:e,offset:t})=>{const n=B(v=>v.uiState.mode),[o,s]=S.useState(null),[r,a]=S.useState(null),l=B(v=>{var k;return((k=v.projectCanvas.getActive())==null?void 0:k.coreState.nodes)??zr}),c=B(v=>v.setSelectedNodes),d=window.innerWidth,u=window.innerHeight,g=-t.x/e,p=-t.y/e,f=g+d/e,h=p+u/e,m=Math.floor(g/Pt)*Pt,x=Math.ceil(f/Pt)*Pt,w=Math.floor(p/_t)*_t,b=Math.ceil(h/_t)*_t,N=[];for(let v=m;v<=x;v+=Pt)N.push(v);const j=[];for(let v=w;v<=b;v+=_t)j.push(v);const C=S.useCallback(v=>{const R=v.currentTarget.getBoundingClientRect(),M=v.clientX-R.left,D=v.clientY-R.top,_=(M-t.x)/e,L=(D-t.y)/e,P=M,O=R.width-M,W=D,z=R.height-D,U=50,V=P<U||O<U,ee=W<U||z<U;s({canvasX:_,canvasY:L,showVertical:ee,showHorizontal:V})},[e,t]),I=S.useCallback(()=>{s(null),a(null)},[]),A=S.useCallback(v=>{if(o&&(o.showVertical||o.showHorizontal)){v.stopPropagation(),v.preventDefault();const k=o.showVertical?"vertical":"horizontal";a({isDragging:!0,startX:o.canvasX,startY:o.canvasY,currentX:o.canvasX,currentY:o.canvasY,dragType:k})}},[o]),T=S.useCallback(v=>{if(!r||!r.isDragging)return;v.stopPropagation(),v.preventDefault();const k=Math.min(r.startX,r.currentX),R=Math.max(r.startX,r.currentX),M=Math.min(r.startY,r.currentY),D=Math.max(r.startY,r.currentY),_=l.filter(L=>{const P=L.width??200,O=L.height??100,W=L.x+P,z=L.y+O;return r.dragType==="vertical"?L.x<=R&&W>=k:L.y<=D&&z>=M});_.length>0&&c(_),a(null)},[r,l,c]),E=C,y=S.useCallback(v=>{if(E(v),r!=null&&r.isDragging){v.stopPropagation(),v.preventDefault();const R=v.currentTarget.getBoundingClientRect(),M=v.clientX-R.left,D=v.clientY-R.top,_=(M-t.x)/e,L=(D-t.y)/e;a({...r,currentX:_,currentY:L})}},[E,r,t,e]);return n!==H.GRID?null:i.jsx("svg",{"data-grid-svg":"true","data-grid-active":o!=null&&o.showVertical||o!=null&&o.showHorizontal?"true":"false",className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{zIndex:o!=null&&o.showVertical||o!=null&&o.showHorizontal?999:0,pointerEvents:"auto",cursor:o?r!=null&&r.isDragging?"grabbing":"grab":"default"},onMouseMove:y,onMouseLeave:I,onMouseDown:A,onMouseUp:T,children:i.jsxs("g",{transform:`translate(${t.x}, ${t.y}) scale(${e})`,children:[N.map(v=>i.jsx("line",{x1:v,y1:p,x2:v,y2:h,stroke:v===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:v===0?2/e:1/e,style:{pointerEvents:"none"}},`v-${v}`)),j.map(v=>i.jsx("line",{x1:g,y1:v,x2:f,y2:v,stroke:v===0?"rgba(59, 130, 246, 0.5)":"rgba(148, 163, 184, 0.3)",strokeWidth:v===0?2/e:1/e,style:{pointerEvents:"none"}},`h-${v}`)),o&&o.showVertical&&i.jsx("line",{x1:o.canvasX,y1:p,x2:o.canvasX,y2:h,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-vertical"),o&&o.showHorizontal&&i.jsx("line",{x1:g,y1:o.canvasY,x2:f,y2:o.canvasY,stroke:"rgba(59, 130, 246, 0.9)",strokeWidth:2/e,strokeDasharray:`${10/e} ${5/e}`,style:{pointerEvents:"none"}},"hover-horizontal"),r&&r.isDragging&&(()=>{const v=Math.min(r.startX,r.currentX),k=Math.max(r.startX,r.currentX),R=Math.min(r.startY,r.currentY),M=Math.max(r.startY,r.currentY);return r.dragType==="vertical"?i.jsx("rect",{x:v,y:p,width:k-v,height:h-p,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range"):i.jsx("rect",{x:g,y:R,width:f-g,height:M-R,fill:"rgba(59, 130, 246, 0.15)",stroke:"rgba(59, 130, 246, 0.6)",strokeWidth:2/e,style:{pointerEvents:"none"}},"drag-range")})(),N.map(v=>i.jsx("text",{x:v,y:p+20/e,fill:"rgba(100, 116, 139, 0.6)",fontSize:12/e,textAnchor:"middle",style:{pointerEvents:"none"},children:v},`label-v-${v}`)),j.map(v=>i.jsx("text",{x:g+20/e,y:v,fill:"rgba(100, 116, 139, 0.6)",fontSize:12/e,textAnchor:"start",dominantBaseline:"middle",style:{pointerEvents:"none"},children:v},`label-h-${v}`)),o&&(o.showVertical||o.showHorizontal)&&(()=>{let v=l,k="",R=o.canvasX,M=o.canvasY-30/e;if(r!=null&&r.isDragging){const D=Math.min(r.startX,r.currentX),_=Math.max(r.startX,r.currentX),L=Math.min(r.startY,r.currentY),P=Math.max(r.startY,r.currentY);v=l.filter(O=>{const W=O.width??200,z=O.height??100,U=O.x+W,V=O.y+z;return r.dragType==="vertical"?O.x<=_&&U>=D:O.y<=P&&V>=L}),k=`Release to select ${v.length} node${v.length!==1?"s":""}`,R=(D+_)/2,M=r.dragType==="vertical"?p+30/e:(L+P)/2}else o.showVertical&&(v=v.filter(D=>{const _=D.width??200,L=D.x+_;return D.x<=o.canvasX&&L>=o.canvasX})),o.showHorizontal&&(v=v.filter(D=>{const _=D.height??100,L=D.y+_;return D.y<=o.canvasY&&L>=o.canvasY})),k=`Click/drag to select ${v.length} node${v.length!==1?"s":""}`;return i.jsxs("g",{children:[i.jsx("rect",{x:R-70/e,y:M-12/e,width:140/e,height:24/e,fill:"rgba(0, 0, 0, 0.9)",rx:4/e,style:{pointerEvents:"none"}}),i.jsx("text",{x:R,y:M,fill:"white",fontSize:12/e,fontWeight:"bold",textAnchor:"middle",dominantBaseline:"middle",style:{pointerEvents:"none"},children:k})]},"tooltip")})()]})})},uh=180,fh=()=>{const e=B(y=>{var v;return((v=y.state)==null?void 0:v.projects)??{}}),t=B(y=>{var v;return((v=y.state)==null?void 0:v.activeProjectId)??""}),n=B(y=>y.project),o=B(y=>y.workspace),s=B(y=>y.projectCanvas),r=S.useMemo(()=>t?e[t]??null:null,[e,t]),a=S.useMemo(()=>r!=null&&r.activeWorkspaceId?r.workspaces[r.activeWorkspaceId]??null:null,[r]),[l,c]=S.useState(""),[d,u]=S.useState(null),[g,p]=S.useState(!1),[f,h]=S.useState(null),m=S.useRef(null),x=S.useMemo(()=>Object.values(e).sort((y,v)=>(y.sortOrder??0)-(v.sortOrder??0)).map(y=>({id:y.id,label:y.name,data:{type:"project",id:y.id,name:y.name,isActive:y.id===t},children:Object.values(y.workspaces).sort((v,k)=>(v.sortOrder??0)-(k.sortOrder??0)).map(v=>({id:v.id,label:v.name,data:{type:"workspace",id:v.id,name:v.name,isActive:v.id===y.activeWorkspaceId},children:Object.values(v.canvases).sort((k,R)=>(k.sortOrder??0)-(R.sortOrder??0)).map(k=>({id:k.id,label:k.name,data:{type:"canvas",id:k.id,name:k.name,isActive:k.id===v.activeCanvasId}}))}))})),[e,t]),w=S.useMemo(()=>{const y=new Set;return t&&y.add(t),r!=null&&r.activeWorkspaceId&&y.add(r.activeWorkspaceId),y},[t,r]),b=y=>{const v=l.trim()||`New ${y}`;y==="project"?n.create(v):y==="workspace"?o.create(v):y==="canvas"&&s.create(v),c(""),u(null)},N=y=>i.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[i.jsx(it,{"data-test":`projects-new-${y}-input`,type:"text",placeholder:`New ${y} name...`,value:l,onChange:v=>c(v.target.value),onKeyDown:v=>v.key==="Enter"&&b(y),autoFocus:!0,className:"h-6 text-sm flex-grow"}),i.jsx(X,{"data-test":`projects-save-${y}-button`,variant:"ghost",size:"sm",onClick:()=>b(y),children:i.jsx(mt,{className:"h-3 w-3"})}),i.jsx(X,{"data-test":`projects-cancel-${y}-button`,variant:"ghost",size:"sm",onClick:()=>{u(null),c("")},children:i.jsx(Ze,{className:"h-3 w-3"})})]}),j=y=>{var k;const v=(k=y.data)==null?void 0:k.type;v==="project"?n.switch(y.id):v==="workspace"?o.switch(y.id):v==="canvas"&&s.switch(y.id)},C=(y,v)=>{const k=M=>{var D;for(const _ of M){if(_.id===y)return(D=_.data)==null?void 0:D.type;if(_.children){const L=k(_.children);if(L)return L}}return null},R=k(x);R==="project"?n.updateMetadata(y,{name:v}):R==="workspace"?o.updateMetadata(y,{name:v}):R==="canvas"&&s.updateMetadata(y,{name:v})},I=y=>{const v=R=>{var M;for(const D of R){if(D.id===y)return(M=D.data)==null?void 0:M.type;if(D.children){const _=v(D.children);if(_)return _}}return null},k=v(x);k==="project"?n.delete(y):k==="workspace"?o.delete(y):k==="canvas"&&s.delete(y)},A=y=>{var k;return`Are you sure you want to delete this ${((k=y.data)==null?void 0:k.type)??"item"}: "${y.label}"?`},T=y=>{const v=$.getState().setState;v(xe(k=>{if(!k)return;const R=Date.now();y.forEach((M,D)=>{var O;const _=k.projects[M.id];if(!_)return;_.sortOrder=D,_.lastModified=R;const L=new Set,P=new Map;(O=M.children)==null||O.forEach((W,z)=>{var V;const U=_.workspaces[W.id];if(U){U.sortOrder=z,U.lastModified=R,L.add(W.id);const ee=new Set;P.set(W.id,ee),(V=W.children)==null||V.forEach((te,le)=>{const ye=U.canvases[te.id];if(ye)ye.sortOrder=le,ye.lastModified=R,ee.add(te.id);else{let pe=null,Ie=null;for(const[be,Re]of Object.entries(_.workspaces))if(Re.canvases[te.id]){pe=Re.canvases[te.id],Ie=be;break}if(pe)Ie&&Ie!==W.id&&(delete _.workspaces[Ie].canvases[te.id],_.workspaces[Ie].lastModified=R);else for(const[be,Re]of Object.entries(k.projects))if(be!==M.id){for(const[$e,F]of Object.entries(Re.workspaces))if(F.canvases[te.id]){pe=F.canvases[te.id],Ie=$e,delete F.canvases[te.id],F.lastModified=R,Re.lastModified=R;break}if(pe)break}pe&&(U.canvases[te.id]=pe,pe.sortOrder=le,pe.lastModified=R,ee.add(te.id))}})}})})}))},E=()=>{if(g){p(!1),u(null),c("");return}if(m.current){const y=m.current.getBoundingClientRect(),v=320,k=400,R=y.left+y.width/2,M=y.top+y.height/2;h({x:R-v/2+uh,y:M-k/2})}p(!0)};return i.jsxs(i.Fragment,{children:[i.jsx(vt,{ref:m,variant:"secondary",size:"sm",tooltip:"Manage projects",onClick:E,className:"canvas-projects-manager-button","data-test":"canvas-projects-manager-button",children:i.jsx(Da,{className:"h-4 w-4"})}),i.jsx(We,{isVisible:g,onClose:()=>{p(!1),u(null),c("")},title:"Projects",resizable:!0,initialSize:{width:320,height:400},triggerPosition:f??void 0,children:i.jsxs("div",{className:"manager-content flex flex-col space-y-2 p-2 h-full overflow-hidden",children:[i.jsx(Xo,{className:"tree-scroll-area flex-1 min-h-0",children:i.jsx("div",{className:"tree-container space-y-1 pr-2",children:i.jsx(Xa,{data:x,onItemClick:j,onUpdate:C,onDelete:I,onReorder:T,defaultExpandedIds:w,selectedId:(a==null?void 0:a.activeCanvasId)??null,deleteConfirmMessage:A,enableEdit:!0,enableDelete:!0,enableDrag:!0})})}),d?N(d):i.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t",children:[i.jsxs(X,{"data-test":"projects-add-project-button",variant:"outline",size:"sm",className:"add-project-button flex-1",onClick:()=>u("project"),title:"Add Project",children:[i.jsx(Oe,{className:"h-3 w-3 mr-1"})," Pr"]}),r&&i.jsxs(X,{"data-test":"projects-add-workspace-button",variant:"outline",size:"sm",className:"add-workspace-button flex-1",onClick:()=>u("workspace"),title:"Add Workspace",children:[i.jsx(Oe,{className:"h-3 w-3 mr-1"})," Wo"]}),a&&i.jsxs(X,{"data-test":"projects-add-canvas-button",variant:"outline",size:"sm",className:"add-canvas-button flex-1",onClick:()=>u("canvas"),title:"Add Canvas",children:[i.jsx(Oe,{className:"h-3 w-3 mr-1"})," Ca"]})]})]})})]})};function hi({node:e,onItemClick:t,onUpdate:n,onDelete:o,level:s=0,defaultExpandedIds:r,selectedId:a,enableEdit:l=!0,enableDelete:c=!0,deleteConfirmMessage:d,renderNode:u}){var k;const[g,p]=S.useState((r==null?void 0:r.has(e.id))??!1),[f,h]=S.useState(!1),[m,x]=S.useState(e.label),w=e.children&&e.children.length>0,b=a===e.id,N=S.useRef(null);S.useEffect(()=>{b&&N.current&&N.current.scrollIntoView({behavior:"smooth",block:"nearest"})},[b]);const j=R=>{R.stopPropagation(),f||(w&&p(!g),t==null||t(e))},C=()=>{m.trim()&&m!==e.label&&(n==null||n(e.id,m.trim())),h(!1)},I=()=>{x(e.label),h(!1)},A=R=>{R.stopPropagation();const M=(d==null?void 0:d(e))??`Are you sure you want to delete "${e.label}"?`;window.confirm(M)&&(o==null||o(e.id))},T={paddingLeft:`${s*1.5}rem`},E=w?i.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0",children:g?i.jsx(Ut,{className:"h-4 w-4"}):i.jsx(Pa,{className:"h-4 w-4"})}):i.jsx("div",{className:"tree-item-chevron w-4 h-4 mr-2 flex-shrink-0"}),y=i.jsxs("div",{ref:N,className:ve("crud-tree-item flex items-center py-1.5 px-2 hover:bg-accent hover:text-accent-foreground cursor-pointer rounded-sm transition-colors group",b&&"bg-primary/10 border border-primary"),style:T,onClick:j,children:[E,e.icon&&i.jsx("div",{className:"tree-item-custom-icon mr-2 flex-shrink-0",children:e.icon}),f?i.jsxs("div",{className:"edit-controls flex items-center space-x-1 flex-grow",children:[i.jsx(it,{type:"text",value:m,onChange:R=>x(R.target.value),onKeyDown:R=>{R.key==="Enter"&&C(),R.key==="Escape"&&I()},autoFocus:!0,className:"h-6 text-sm flex-grow",onClick:R=>R.stopPropagation()}),i.jsx(X,{variant:"ghost",size:"sm",onClick:R=>{R.stopPropagation(),C()},className:"h-6 w-6 p-0",children:i.jsx(mt,{className:"h-3 w-3"})}),i.jsx(X,{variant:"ghost",size:"sm",onClick:R=>{R.stopPropagation(),I()},className:"h-6 w-6 p-0",children:i.jsx(Ze,{className:"h-3 w-3"})})]}):i.jsxs(i.Fragment,{children:[i.jsx("span",{className:"tree-item-label flex-grow truncate",title:e.label,children:e.label}),i.jsxs("div",{className:"item-actions flex items-center space-x-0.5 opacity-0 group-hover:opacity-100",children:[l&&n&&i.jsx(X,{variant:"ghost",size:"sm",onClick:R=>{R.stopPropagation(),h(!0)},className:"h-6 w-6 p-0",children:i.jsx(Ma,{className:"h-3 w-3"})}),c&&o&&i.jsx(X,{variant:"ghost",size:"sm",onClick:A,className:"h-6 w-6 p-0 text-destructive hover:text-destructive",children:i.jsx(Ke,{className:"h-3 w-3"})})]})]})]}),v=u?u(e,b,!!w,y):y;return w?i.jsxs(Di,{open:g,onOpenChange:p,children:[i.jsx(Mi,{asChild:!0,children:i.jsx("div",{children:v})}),i.jsx(Pi,{children:i.jsx("div",{className:"tree-item-children",children:(k=e.children)==null?void 0:k.map(R=>i.jsx(hi,{node:R,onItemClick:t,onUpdate:n,onDelete:o,level:s+1,defaultExpandedIds:r,selectedId:a,enableEdit:l,enableDelete:c,deleteConfirmMessage:d,renderNode:u},R.id))})})]}):i.jsx(i.Fragment,{children:v})}function gh({data:e,onItemClick:t,onUpdate:n,onDelete:o,className:s,defaultExpandedIds:r,selectedId:a,enableEdit:l=!0,enableDelete:c=!0,deleteConfirmMessage:d,renderNode:u}){return i.jsx("div",{className:ve("crud-tree-root",s),children:e.map(g=>i.jsx(hi,{node:g,onItemClick:t,onUpdate:n,onDelete:o,defaultExpandedIds:r,selectedId:a,enableEdit:l,enableDelete:c,deleteConfirmMessage:d,renderNode:u},g.id))})}const ph=180,hh=()=>{const e=ke(F=>F.definitions),t=ke(F=>F.instances),n=ke(F=>F.selectedDefinitionId),o=ke(F=>F.createDefinition),s=ke(F=>F.updateDefinition),r=ke(F=>F.deleteDefinition);ke(F=>F.duplicateDefinition);const a=ke(F=>F.createInstance),l=ke(F=>F.deleteInstance),c=ke(F=>F.selectDefinition),d=B(F=>{var Y;return((Y=F.projectCanvas.getActive())==null?void 0:Y.coreState.nodes)??zr}),u=B(F=>{var Y;return((Y=F.state)==null?void 0:Y.projects)??{}}),[g,p]=S.useState(""),[f,h]=S.useState(null),[m,x]=S.useState(!1),[w,b]=S.useState(null),[N,j]=S.useState(new Set),C=S.useRef(null),I=S.useRef(null),A=ke(F=>F.facade),T=S.useMemo(()=>new zo(A),[A]),E=S.useMemo(()=>{const F=u["workflow-templates-project"],Y=[];F&&Object.values(F.workspaces).forEach(ne=>{Object.values(ne.canvases).forEach(ue=>{ue.coreState.nodes.filter(we=>{var Je;return((Je=we.data)==null?void 0:Je.nodeType)==="workflowOrchestration"}).forEach(we=>{var ms,xs;const Je=we.data,Et=((xs=(ms=Je==null?void 0:Je.parameters)==null?void 0:ms.rows)==null?void 0:xs.length)||0,Jt=typeof we.title=="string"?we.title:"",Si=typeof we.content=="string"?we.content:"";Y.push({id:`preset-${we.id}`,label:Jt||Si||`Preset (${Et} steps)`,data:{type:"preset-workflow",id:we.id,nodeId:we.id,rowCount:Et,canvasId:ue.id,canvasName:ue.name}})})})});const G=new Set(Y.map(ne=>{var ue;return(ue=ne.data)==null?void 0:ue.nodeId})),ie=d.filter(ne=>{var ue;return((ue=ne.data)==null?void 0:ue.nodeType)==="workflowOrchestration"&&!G.has(ne.id)}).map(ne=>{var Et,Jt;const ue=ne.data,he=((Jt=(Et=ue==null?void 0:ue.parameters)==null?void 0:Et.rows)==null?void 0:Jt.length)||0,we=typeof ne.title=="string"?ne.title:"",Je=typeof ne.content=="string"?ne.content:"";return{id:ne.id,label:we||Je||`Workflow (${he} steps)`,data:{type:"canvas-workflow",id:ne.id,nodeId:ne.id,rowCount:he}}}),ce=e.map(ne=>{const ue=t.filter(he=>he.definitionId===ne.id);return{id:ne.id,label:ne.name,data:{type:"definition",id:ne.id,name:ne.name,isActive:ne.id===n,description:ne.description,tags:ne.tags},children:ue.map(he=>({id:he.id,label:he.name,data:{type:"instance",id:he.id,name:he.name,status:he.status,definitionId:he.definitionId}}))}}),de=[];return Y.length>0&&de.push({id:"section-presets",label:`ðŸ“š Workflow Presets (${Y.length})`,data:{type:"section",section:"presets"},children:Y}),ie.length>0&&de.push({id:"section-canvas",label:`ðŸŽ¨ Current Canvas (${ie.length})`,data:{type:"section",section:"canvas"},children:ie}),ce.length>0&&de.push({id:"section-saved",label:`ðŸ’¾ Saved Workflows (${ce.length})`,data:{type:"section",section:"saved"},children:ce}),de},[d,e,t,n,u]),y=S.useMemo(()=>{const F=new Set;return F.add("section-presets"),F.add("section-canvas"),F.add("section-saved"),n&&F.add(n),F},[n]),v=F=>{const Y=g.trim()||`New ${F}`;F==="definition"?o({name:Y}):F==="instance"&&n&&a(n,Y),p(""),h(null)},k=F=>i.jsxs("div",{className:"add-input-container flex items-center space-x-1 p-1.5",children:[i.jsx(it,{"data-test":`workflow-new-${F}-input`,type:"text",placeholder:`New ${F} name...`,value:g,onChange:Y=>p(Y.target.value),onKeyDown:Y=>Y.key==="Enter"&&v(F),autoFocus:!0,className:"h-6 text-sm flex-grow"}),i.jsx(X,{"data-test":`workflow-save-${F}-button`,variant:"ghost",size:"sm",onClick:()=>v(F),children:i.jsx(mt,{className:"h-3 w-3"})}),i.jsx(X,{"data-test":`workflow-cancel-${F}-button`,variant:"ghost",size:"sm",onClick:()=>{h(null),p("")},children:i.jsx(Ze,{className:"h-3 w-3"})})]}),R=F=>{var G;((G=F.data)==null?void 0:G.type)==="definition"&&c(F.id)},M=(F,Y)=>{const G=ie=>{var ce;for(const de of ie){if(de.id===F)return(ce=de.data)==null?void 0:ce.type;if(de.children){const ne=G(de.children);if(ne)return ne}}return null},se=G(E);se==="section"||se==="preset-workflow"||se==="canvas-workflow"||(se==="definition"?s(F,{name:Y}):se==="instance"&&console.warn("Instance rename not yet implemented"))},D=F=>{const Y=se=>{var ie;for(const ce of se){if(ce.id===F)return(ie=ce.data)==null?void 0:ie.type;if(ce.children){const de=Y(ce.children);if(de)return de}}return null},G=Y(E);G==="section"||G==="preset-workflow"||G==="canvas-workflow"||(G==="definition"?r(F):G==="instance"&&l(F))},_=F=>{var G;return`Are you sure you want to delete this ${((G=F.data)==null?void 0:G.type)??"item"}: "${F.label}"?`},L=()=>{if(m){x(!1),h(null),p("");return}if(C.current){const F=C.current.getBoundingClientRect(),Y=320,G=400,se=F.left+F.width/2,ie=F.top+F.height/2;b({x:se-Y/2+ph,y:ie-G/2})}x(!0)},P=()=>{if(N.size===0){oe.error("No workflows selected");return}try{const F=Array.from(N);T.downloadWorkflows(F),oe.success(`Exported ${N.size} workflow(s)`,{description:"Workflows downloaded as JSON file"})}catch(F){oe.error("Export failed",{description:F instanceof Error?F.message:"Unknown error"})}},O=()=>{try{const F=T.exportAllWorkflows(),Y=new Blob([F],{type:"application/json"}),G=URL.createObjectURL(Y),se=document.createElement("a");se.href=G,se.download=`all-workflows-${Date.now()}.json`,se.click(),URL.revokeObjectURL(G),oe.success("Exported all workflows",{description:`${e.length} workflow(s) downloaded`})}catch(F){oe.error("Export failed",{description:F instanceof Error?F.message:"Unknown error"})}},W=()=>{var F;(F=I.current)==null||F.click()},z=F=>{var se;const Y=(se=F.target.files)==null?void 0:se[0];if(!Y)return;const G=new FileReader;G.onload=ie=>{var ce;try{const de=(ce=ie.target)==null?void 0:ce.result,ne=T.importWorkflows(de);oe.success(`Imported ${ne.length} workflow(s)`,{description:"Workflows added to manager"})}catch(de){oe.error("Import failed",{description:de instanceof Error?de.message:"Invalid JSON"})}},G.readAsText(Y),F.target.value=""},U=F=>{const Y=new Set(N);Y.has(F)?Y.delete(F):Y.add(F),j(Y)},V=()=>{N.size===e.length?j(new Set):j(new Set(e.map(F=>F.id)))},ee=()=>{if(N.size!==0&&window.confirm(`Are you sure you want to delete ${N.size} workflow(s)?`))try{T.bulkDeleteDefinitions(Array.from(N)),j(new Set),oe.success(`Deleted ${N.size} workflow(s)`)}catch(F){oe.error("Bulk delete failed",{description:F instanceof Error?F.message:"Unknown error"})}},te=()=>{if(N.size!==0)try{const F=T.bulkDuplicateDefinitions(Array.from(N));j(new Set),oe.success(`Duplicated ${F.length} workflow(s)`,{description:'New workflows created with " (copy)" suffix'})}catch(F){oe.error("Bulk duplicate failed",{description:F instanceof Error?F.message:"Unknown error"})}},le=()=>{if(N.size===0)return;const F=window.prompt("Enter tags (comma-separated):");if(!F)return;const Y=F.split(",").map(G=>G.trim()).filter(Boolean);if(Y.length===0){oe.error("No valid tags provided");return}try{T.bulkAddTags(Array.from(N),Y),oe.success(`Added tags to ${N.size} workflow(s)`,{description:`Tags: ${Y.join(", ")}`})}catch(G){oe.error("Bulk add tags failed",{description:G instanceof Error?G.message:"Unknown error"})}},ye=()=>{if(N.size===0)return;const F=window.prompt("Enter tags to remove (comma-separated):");if(!F)return;const Y=F.split(",").map(G=>G.trim()).filter(Boolean);if(Y.length===0){oe.error("No valid tags provided");return}try{T.bulkRemoveTags(Array.from(N),Y),oe.success(`Removed tags from ${N.size} workflow(s)`,{description:`Tags: ${Y.join(", ")}`})}catch(G){oe.error("Bulk remove tags failed",{description:G instanceof Error?G.message:"Unknown error"})}},pe=()=>{if(N.size!==0)try{const F=T.getBulkStats(Array.from(N));oe.info("Bulk Statistics",{description:`Workflows: ${F.count} | Nodes: ${F.totalNodes} | Connections: ${F.totalConnections} | Tags: ${F.tags.length}`})}catch(F){oe.error("Failed to get statistics",{description:F instanceof Error?F.message:"Unknown error"})}},Ie=(F,Y)=>{Y.stopPropagation();try{const G=T.loadWorkflow({definitionId:F,position:{x:100,y:100}});oe.success("Workflow loaded",{description:"Loaded workflow to canvas at position (100, 100)"})}catch(G){oe.error("Failed to load workflow",{description:G instanceof Error?G.message:"Unknown error"})}},be=(F,Y)=>{Y.stopPropagation();try{const G=T.saveWorkflow({nodeId:F});oe.success("Workflow saved",{description:`"${G.name}" saved as version ${G.version}`})}catch(G){oe.error("Failed to save workflow",{description:G instanceof Error?G.message:"Unknown error"})}},Re=(F,Y)=>{Y.stopPropagation();try{const G=u["workflow-templates-project"];if(!G)throw new Error("Workflow Templates project not found");let se=null,ie=!1;if(Object.values(G.workspaces).forEach(ne=>{Object.values(ne.canvases).forEach(ue=>{const he=ue.coreState.nodes.find(we=>we.id===F);he&&(se=he,ie=!0)})}),!se)throw new Error("Preset workflow not found");const ce=$.getState(),de={...se,id:`copied-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,x:150,y:150};ce.addNode(de),oe.success("Preset copied",{description:"Workflow preset copied to current canvas"})}catch(G){oe.error("Failed to copy preset",{description:G instanceof Error?G.message:"Unknown error"})}},$e=N.size===e.length&&e.length>0;return N.size>0&&N.size<e.length,i.jsxs(i.Fragment,{children:[i.jsx(vt,{ref:C,variant:"secondary",size:"sm",tooltip:"Manage workflows",onClick:L,className:"workflow-manager-button","data-test":"workflow-manager-button",children:i.jsx(vn,{className:"h-4 w-4"})}),i.jsx(We,{isVisible:m,onClose:()=>{x(!1),h(null),p("")},title:"Workflow Manager",resizable:!0,initialSize:{width:420,height:450},triggerPosition:w??void 0,children:i.jsxs("div",{className:"manager-content flex flex-col space-y-2 p-2 flex-1 overflow-hidden",children:[i.jsxs("div",{className:"toolbar-row flex items-center gap-1 pb-1 border-b",children:[i.jsxs(ws,{children:[i.jsx(vs,{asChild:!0,children:i.jsxs(X,{"data-test":"workflow-export-dropdown",variant:"outline",size:"sm",className:"flex-1",children:[i.jsx(_a,{className:"h-3 w-3 mr-1"}),"Export",i.jsx(Ut,{className:"h-3 w-3 ml-1"})]})}),i.jsxs(Ss,{style:{zIndex:qe.skipLink},children:[i.jsxs(at,{"data-test":"workflow-export-selected",onClick:P,children:["Export Selected (",N.size,")"]}),i.jsxs(at,{"data-test":"workflow-export-all",onClick:O,children:["Export All (",e.length,")"]})]})]}),i.jsxs(X,{"data-test":"workflow-import-button",variant:"outline",size:"sm",className:"flex-1",onClick:W,title:"Import workflows from JSON",children:[i.jsx(mo,{className:"h-3 w-3 mr-1"}),"Import"]}),i.jsx("input",{"data-test":"workflow-import-file-input",ref:I,type:"file",accept:".json",onChange:z,className:"hidden"})]}),N.size>0&&i.jsxs("div",{className:"bulk-toolbar flex items-center gap-1 pb-1 border-b bg-primary/5 p-1.5 rounded",children:[i.jsxs("span",{className:"text-xs text-muted-foreground flex-shrink-0",children:[N.size," selected"]}),i.jsxs(ws,{children:[i.jsx(vs,{asChild:!0,children:i.jsxs(X,{"data-test":"workflow-bulk-actions-dropdown",variant:"ghost",size:"sm",className:"flex-1",children:[i.jsx(Ut,{className:"h-3 w-3 mr-1"}),"Bulk Actions"]})}),i.jsxs(Ss,{style:{zIndex:qe.skipLink},children:[i.jsx(_i,{children:"Bulk Operations"}),i.jsx(Kn,{}),i.jsxs(at,{"data-test":"workflow-bulk-duplicate",onClick:te,children:[i.jsx(Sn,{className:"h-3 w-3 mr-2"}),"Duplicate"]}),i.jsxs(at,{"data-test":"workflow-bulk-delete",onClick:ee,children:[i.jsx(Ke,{className:"h-3 w-3 mr-2"}),"Delete"]}),i.jsx(Kn,{}),i.jsxs(at,{"data-test":"workflow-bulk-add-tags",onClick:le,children:[i.jsx(bn,{className:"h-3 w-3 mr-2"}),"Add Tags"]}),i.jsxs(at,{"data-test":"workflow-bulk-remove-tags",onClick:ye,children:[i.jsx(bn,{className:"h-3 w-3 mr-2"}),"Remove Tags"]}),i.jsx(Kn,{}),i.jsxs(at,{"data-test":"workflow-bulk-stats",onClick:pe,children:[i.jsx(Oa,{className:"h-3 w-3 mr-2"}),"Show Statistics"]})]})]})]}),e.length>0&&i.jsxs("div",{className:"select-all-row flex items-center gap-2 px-2 py-1",children:[i.jsx(ys,{"data-test":"workflow-select-all-checkbox",checked:$e,onCheckedChange:V,className:"h-4 w-4","aria-label":"Select all workflows"}),i.jsx("span",{className:"text-xs text-muted-foreground",children:$e?"Deselect All":"Select All"})]}),i.jsx(Xo,{className:"tree-scroll-area flex-1",children:i.jsx("div",{className:"tree-container space-y-1 pr-2",children:i.jsx(gh,{data:E,onItemClick:R,onUpdate:M,onDelete:D,defaultExpandedIds:y,selectedId:n,deleteConfirmMessage:_,renderNode:(F,Y,G,se)=>{var ie,ce,de,ne;return((ie=F.data)==null?void 0:ie.type)==="section"?i.jsx("div",{className:"flex items-center gap-2 w-full",children:i.jsx("div",{className:"flex-1 font-semibold",children:se})}):((ce=F.data)==null?void 0:ce.type)==="preset-workflow"?i.jsxs("div",{className:"flex items-center gap-2 w-full",children:[i.jsx("div",{className:"flex-1",children:se}),i.jsx(X,{"data-test":"workflow-copy-preset-button",variant:"ghost",size:"sm",className:"h-6 w-6 p-0 flex-shrink-0",onClick:ue=>Re(F.data.nodeId,ue),title:"Copy preset to current canvas",children:i.jsx(Sn,{className:"h-3 w-3"})})]}):((de=F.data)==null?void 0:de.type)==="canvas-workflow"?i.jsxs("div",{className:"flex items-center gap-2 w-full",children:[i.jsx("div",{className:"flex-1",children:se}),i.jsx(X,{"data-test":"workflow-save-canvas-button",variant:"ghost",size:"sm",className:"h-6 w-6 p-0 flex-shrink-0",onClick:ue=>be(F.data.nodeId,ue),title:"Save workflow",children:i.jsx(mt,{className:"h-3 w-3"})})]}):((ne=F.data)==null?void 0:ne.type)==="definition"?i.jsxs("div",{className:"flex items-center gap-2 w-full",children:[i.jsx(ys,{"data-test":"workflow-definition-checkbox",checked:N.has(F.id),onCheckedChange:()=>U(F.id),className:"h-4 w-4 flex-shrink-0",onClick:ue=>ue.stopPropagation()}),i.jsx("div",{className:"flex-1",children:se}),i.jsx(X,{"data-test":"workflow-load-button",variant:"ghost",size:"sm",className:"h-6 w-6 p-0 flex-shrink-0",onClick:ue=>Ie(F.id,ue),title:"Load workflow to canvas",children:i.jsx(Fa,{className:"h-3 w-3"})})]}):se}})})}),f?k(f):i.jsxs("div",{className:"add-buttons-row flex items-center gap-1 pt-2 border-t",children:[i.jsxs(X,{"data-test":"workflow-add-definition-button",variant:"outline",size:"sm",className:"add-definition-button flex-1",onClick:()=>h("definition"),title:"Add Workflow Definition",children:[i.jsx(Oe,{className:"h-3 w-3 mr-1"})," Workflow"]}),n&&i.jsxs(X,{"data-test":"workflow-add-instance-button",variant:"outline",size:"sm",className:"add-instance-button flex-1",onClick:()=>h("instance"),title:"Add Workflow Instance",children:[i.jsx(Oe,{className:"h-3 w-3 mr-1"})," Instance"]})]})]})})]})},mi=e=>{const{className:t,style:n,children:o,position:s="left"}=e;return i.jsx("div",{className:ae("p-2 bg-background border shadow flex flex-col items-center space-y-2 pointer-events-auto rounded",t),style:{...n},onMouseDown:r=>r.stopPropagation(),"data-test":`canvas-vertical-toolbar-${s}`,children:o})},mh=e=>{const{className:t,style:n}=e;return i.jsxs(mi,{className:t,style:n,position:"left",children:[i.jsx(fh,{}),i.jsx(hh,{})]})};function xh(){const e=async o=>{Z.persistState=!!o.persistState,Z.autosave=!!o.autosave,Z.hideOverlay=!!o.hideOverlay,Z.hideToolbar=!!o.hideToolbar,Z.arrows.REVERSE_CURVE=!!o.arrowReverseCurve,Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR=Number(o.arrowSShapeFactor),Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED=!!o.arrowSShapeReversed,Z.arrows.reverseArrowOnMultipleConnect=!!o.arrowReverseOnMultipleConnect,Z.nodeOptions.maxNodeWidth=Number(o.nodeMaxWidth),Z.nodeOptions.resizeBorderWidth=Number(o.nodeResizeBorderWidth),Z.zoom.min=Number(o.zoomMin),Z.zoom.max=Number(o.zoomMax),Z.zoom.intensity=Number(o.zoomIntensity),$.setState(s=>{var r;return{...s,preferences:{...s.preferences,canvasConfig:{...(r=s.preferences)==null?void 0:r.canvasConfig,persistState:!!o.persistState,autosave:!!o.autosave,hideOverlay:!!o.hideOverlay,hideToolbar:!!o.hideToolbar,arrows:{REVERSE_CURVE:!!o.arrowReverseCurve,CUBIC_ARROW_S_SHAPE_FACTOR:Number(o.arrowSShapeFactor),reverseArrowOnMultipleConnect:!!o.arrowReverseOnMultipleConnect},nodeOptions:{maxNodeWidth:Number(o.nodeMaxWidth),resizeBorderWidth:Number(o.nodeResizeBorderWidth)},zoom:{min:Number(o.zoomMin),max:Number(o.zoomMax),intensity:Number(o.zoomIntensity)}}},uiState:{...s.uiState,isOverlayVisible:!o.hideOverlay,toolbar:{...s.uiState.toolbar,isVisible:!o.hideToolbar}}}}),oe.success("Settings saved!",{description:"Canvas configuration has been updated.",duration:3e3})},t=[{name:"persistState",label:"Persist State",type:"checkbox"},{name:"autosave",label:"Autosave",type:"checkbox"},{name:"hideOverlay",label:"Hide Overlay",type:"checkbox"},{name:"hideToolbar",label:"Hide Toolbar",type:"checkbox"},{name:"arrowReverseCurve",label:"Arrow Reverse Curve",type:"checkbox"},{name:"arrowSShapeFactor",label:"Arrow S-Shape Factor",type:"number",placeholder:"0-2",validation:{min:0,max:2}},{name:"arrowSShapeReversed",label:"Arrow S-Shape Reversed",type:"checkbox"},{name:"arrowReverseOnMultipleConnect",label:"Reverse Arrow on Multiple Connect",type:"checkbox"},{name:"nodeMaxWidth",label:"Node Max Width (px)",type:"number",placeholder:"100-2000",validation:{min:100,max:2e3}},{name:"nodeResizeBorderWidth",label:"Resize Border Width (px)",type:"number",placeholder:"1-50",validation:{min:1,max:50}},{name:"zoomMin",label:"Zoom Min",type:"number",placeholder:"0.01-1",validation:{min:.01,max:1}},{name:"zoomMax",label:"Zoom Max",type:"number",placeholder:"1-10",validation:{min:1,max:10}},{name:"zoomIntensity",label:"Zoom Intensity",type:"number",placeholder:"0.01-1",validation:{min:.01,max:1}}],n={persistState:Z.persistState,autosave:Z.autosave,hideOverlay:Z.hideOverlay,hideToolbar:Z.hideToolbar,arrowReverseCurve:Z.arrows.REVERSE_CURVE,arrowSShapeFactor:Z.arrows.CUBIC_ARROW_S_SHAPE_FACTOR,arrowSShapeReversed:Z.arrows.CUBIC_ARROW_S_SHAPE_REVERSED,arrowReverseOnMultipleConnect:Z.arrows.reverseArrowOnMultipleConnect,nodeMaxWidth:Z.nodeOptions.maxNodeWidth,nodeResizeBorderWidth:Z.nodeOptions.resizeBorderWidth,zoomMin:Z.zoom.min,zoomMax:Z.zoom.max,zoomIntensity:Z.zoom.intensity};return i.jsx(Xo,{className:"h-full",children:i.jsx("div",{className:"p-3","data-test":"canvas-settings-form",children:i.jsx(Ka,{fields:t,onSubmit:e,submitLabel:"Save Settings",defaultValues:n,className:"space-y-3",submitButtonPosition:"top",layout:"two-column",hideSubmitButton:!0,formId:"canvas-settings-form"})})})}const wh=e=>{const{className:t}=e,[n,o]=S.useState(!1),[s,r]=S.useState(void 0),a=l=>{const c=l.currentTarget.getBoundingClientRect();r({x:c.left-360-16,y:c.top}),o(!0)};return i.jsxs(i.Fragment,{children:[i.jsxs(mi,{position:"right",className:t,children:[i.jsx(X,{variant:"outline",size:"icon",onClick:a,className:"h-10 w-10","data-test":"mobile-right-toolbar-settings",title:"Settings",children:i.jsx(Ko,{className:"h-5 w-5"})}),i.jsx(X,{variant:"outline",size:"icon",onClick:()=>console.log("Info clicked"),className:"h-10 w-10","data-test":"mobile-right-toolbar-info",title:"Info",children:i.jsx(jt,{className:"h-5 w-5"})})]}),i.jsx(We,{isVisible:n,onClose:()=>o(!1),title:"Canvas Settings",resizable:!0,initialSize:{width:360,height:380},shouldCloseManually:!0,triggerPosition:s,headerActions:i.jsx("button",{type:"submit",form:"canvas-settings-form",className:"p-1 rounded hover:bg-accent transition-colors",onClick:l=>l.stopPropagation(),onMouseDown:l=>l.stopPropagation(),"aria-label":"Save settings",title:"Save","data-test":"canvas-settings-save-button",children:i.jsx(mt,{size:14})}),children:i.jsx(xh,{})})]})},vh=2e3,gr=[],pr=[],Xn={offset:{x:0,y:0},scale:1,targetView:null},Sh=je.memo(({node:e,isSelected:t})=>{const r=(typeof e.content=="string"?e.content:"").split(`
`).filter(h=>h.trim().length>0),a=e.width??200,l=e.height??100,c=Math.max(r.length,1),d=Math.min(20,l/c),u=8,g="hsl(var(--muted))",p=t?"2px solid #2563eb":"1px solid hsl(var(--border))",f="hsl(var(--foreground))";return i.jsx("div",{style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${a}px`,height:`${l}px`,backgroundColor:g,border:p,borderRadius:"4px",padding:`${u}px`,display:"flex",flexDirection:"column",gap:`${Math.min(4,d*.2)}px`,overflow:"hidden",willChange:"transform",backfaceVisibility:"hidden"},children:r.slice(0,Math.floor(l/d)).map((h,m)=>{const x=h.length,w=Math.max(...r.map(N=>N.length),1),b=Math.max(20,x/w*90);return i.jsx("div",{style:{height:`${Math.max(2,d-4)}px`,width:`${b}%`,backgroundColor:t?"#93c5fd":f,borderRadius:"2px"}},m)})})});Sh.displayName="SimplifiedNode";const xi=je.memo(({nodes:e,selectedNodeIds:t,selectedNodesCount:n,scale:o,offset:s})=>{const r=S.useRef({});r.current={nodes:e,selectedNodeIds:t,selectedNodesCount:n,scale:o,offset:s};const a=o<Ns,l=S.useRef(a);S.useEffect(()=>{l.current!==a&&(l.current=a)},[a,o,e.length]);const c=S.useMemo(()=>{if(o>=Ns)return e;const d=window.innerWidth,u=window.innerHeight,g=-s.x/o,p=-s.y/o,f=g+d/o,h=p+u/o,m=500/o;return e.filter(w=>{const b=w.x+(w.width??200),N=w.y+(w.height??100);return w.x<f+m&&b>g-m&&w.y<h+m&&N>p-m})},[e,o,s]);return a?i.jsx(i.Fragment,{children:c.map(d=>i.jsx(Bo,{node:d,isSelected:t.has(d.id),selectedNodesCount:n,useSimplifiedRendering:!0},d.id))}):i.jsx(i.Fragment,{children:e.map(d=>i.jsx(Bo,{node:d,isSelected:t.has(d.id),selectedNodesCount:n},d.id))})});xi.displayName="CanvasNodesRenderer";const wi=je.memo(({nodes:e,selectedNodeIds:t})=>{const n=B(p=>{var f;return((f=p.projectCanvas.getActive())==null?void 0:f.viewState)??Xn}),{scale:o,offset:s}=n,r=S.useRef(0),a=S.useRef(o),[l,c]=S.useState(!1),d=S.useRef(null),u=S.useMemo(()=>e.filter(p=>!p.isPinned),[e]),g=S.useMemo(()=>e.filter(p=>p.isPinned),[e]);return S.useEffect(()=>{r.current+=1,a.current!==o&&(c(!0),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{c(!1)},200)),a.current=o},[o,l,e.length]),i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"absolute top-0 left-0 w-full h-full origin-top-left",style:{transform:`translate3d(${s.x}px, ${s.y}px, 0) scale(${o})`,zIndex:qe.canvasNodes,willChange:"transform",backfaceVisibility:"hidden",perspective:1e3},children:[i.jsx(jh,{scale:o,offset:s}),i.jsx("div",{style:{...l&&{willChange:"transform, contents"}},children:i.jsx(xi,{nodes:u,selectedNodeIds:t,selectedNodesCount:t.size,scale:o,offset:s})})]}),g.length>0&&i.jsx("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:qe.canvasNodes+1},children:i.jsx("div",{style:{pointerEvents:"auto"},children:g.map(p=>i.jsx(Bo,{node:p,isSelected:t.has(p.id),selectedNodesCount:t.size},p.id))})})]})});wi.displayName="CanvasTransformLayer";const yh=({arrows:e,selectedArrows:t})=>{const n=B(l=>{var c;return((c=l.projectCanvas.getActive())==null?void 0:c.viewState)??Xn}),{scale:o,offset:s}=n,r=l=>!t.some(d=>d.id===l.id)||t.length>1,a=e.filter(r);return i.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:qe.canvasArrows,willChange:"transform"},children:i.jsxs("g",{transform:`translate(${s.x}, ${s.y}) scale(${o})`,style:{touchAction:"none"},children:[a.map(l=>i.jsx(pi,{arrow:l},l.id)),i.jsx(ih,{})]})})},Nh=je.memo(yh,(e,t)=>e.arrows.length!==t.arrows.length||e.selectedArrows.length!==t.selectedArrows.length?!1:e.arrows===t.arrows&&e.selectedArrows===t.selectedArrows),bh=({selectedArrows:e})=>{const t=B(s=>{var r;return((r=s.projectCanvas.getActive())==null?void 0:r.viewState)??Xn}),{scale:n,offset:o}=t;return e.length!==1?null:i.jsx("svg",{className:"absolute top-0 left-0 w-full h-full overflow-visible",style:{pointerEvents:"none",touchAction:"none",zIndex:qe.canvasNodes+1,willChange:"transform"},children:i.jsx("g",{transform:`translate(${o.x}, ${o.y}) scale(${n})`,style:{touchAction:"none"},children:i.jsx(pi,{arrow:e[0]},e[0].id)})})},Ch=je.memo(bh,(e,t)=>e.selectedArrows.length!==t.selectedArrows.length?!1:e.selectedArrows===t.selectedArrows),vi=je.memo(()=>{const e=B(o=>{var s;return((s=o.projectCanvas.getActive())==null?void 0:s.viewState)??Xn}),{scale:t,offset:n}=e;return i.jsx(dh,{scale:t,offset:n})});vi.displayName="CanvasGridLayer";const jh=({scale:e,offset:t,x:n=0,y:o=0})=>i.jsx("div",{style:{position:"absolute",left:n*e,top:o*e,width:12,height:12,background:"darkred",borderRadius:"50%",border:"2px solid white",boxShadow:"0 0 2px #0008",cursor:"pointer",zIndex:10,transform:"translate(-50%, -50%)",userSelect:"none"},title:`Canvas origin (${n.toFixed(1)}, ${o.toFixed(1)})`}),Ih=()=>{const e=B(w=>w.uiState),t=e==null?void 0:e.selectionBox,n=(e==null?void 0:e.isOverlayVisible)??!0;e==null||e.addNodeType;const o=e==null?void 0:e.mode,s=e==null?void 0:e.isPanning,r=S.useRef(0),a=S.useRef(performance.now());S.useEffect(()=>{r.current+=1;const w=performance.now();w-a.current>=2e3&&(r.current=0,a.current=w)});const l=B(w=>w.toggleOverlayVisibility),c=B(w=>{var b;return((b=w.projectCanvas.getActive())==null?void 0:b.coreState.nodes)??gr}),d=B(w=>{var b;return((b=w.projectCanvas.getActive())==null?void 0:b.coreState.selectedNodes)??gr}),u=B(w=>{var b;return((b=w.projectCanvas.getActive())==null?void 0:b.coreState.arrows)??pr}),g=B(w=>{var b;return((b=w.projectCanvas.getActive())==null?void 0:b.coreState.selectedArrows)??pr}),p=B(w=>w.saveStateToLocalStorage);S.useEffect(()=>{Z.autosave&&setInterval(()=>{typeof p=="function"&&p()},vh)},[]);const f=S.useMemo(()=>new Set(d.map(w=>w.id)),[d]),h=i.jsx(X,{variant:"outline",size:"icon",onClick:l,className:"h-7 w-7","data-prevent-canvas-click":!0,title:n?"Hide Overlay":"Show Overlay","data-test":"canvas-toggle-overlay-button",children:n?i.jsx($a,{className:"h-4 w-4"}):i.jsx(Zo,{className:"h-4 w-4"})}),m=i.jsx("div",{className:"flex items-center space-x-2",children:h}),x=S.useMemo(()=>o===H.MOVE?s?"grabbing":"grab":"default",[o,s]);return i.jsxs("div",{className:ae("relative w-full h-full select-none"),"data-canvas-content":!0,style:{cursor:x},children:[i.jsx(vi,{}),i.jsx(Nh,{arrows:u,selectedArrows:g}),i.jsx(wi,{nodes:c,selectedNodeIds:f}),i.jsx(Ch,{selectedArrows:g}),t&&i.jsx(bu,{startX:t.start.x,startY:t.start.y,endX:t.end.x,endY:t.end.y}),i.jsx(ch,{}),i.jsx(wu,{isContentVisible:n,topLeft:i.jsx(i.Fragment,{children:i.jsx(Su,{})}),top:m,topRight:i.jsxs(i.Fragment,{children:[i.jsx(Vp,{}),i.jsx(rh,{})]}),right:i.jsx(wh,{}),bottomRight:i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx(qa,{}),i.jsx(Up,{})]}),bottom:i.jsx(Nu,{}),bottomLeft:n&&i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx(Mp,{}),i.jsx(Pp,{})]}),left:i.jsx(mh,{})})]})},kh=({sourceNode:e,allNodes:t,onNodeSelect:n,onClose:o,isVisible:s})=>{const[r,a]=S.useState(""),l=S.useMemo(()=>{const g=(e.highlights||[]).map(p=>p.linkedNodeId).filter(p=>p!==void 0);return t.filter(p=>g.includes(p.id))},[e.highlights,t]),c=S.useMemo(()=>{if(!r)return l;const u=r.toLowerCase();return l.filter(g=>(typeof g.content=="string"?g.content:"").toLowerCase().includes(u))},[l,r]),d=S.useMemo(()=>c.map(u=>{const g=typeof u.content=="string"?u.content:"[Complex content]",p=g.length>50?g.substring(0,50)+"...":g;return i.jsx("div",{className:"text-sm",children:p},u.id)}),[c]);return i.jsxs(We,{isVisible:s,onClose:o,title:`Linked Nodes (${l.length})`,initialPosition:"bottom-right","data-test":"linked-nodes-popover",children:[i.jsx("div",{className:"search-field px-3 py-2 border-b border-border",children:i.jsx("input",{type:"text",className:"w-full px-2 py-1 text-sm border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring bg-background placeholder:text-muted-foreground",placeholder:"Search linked nodes...",value:r,onChange:u=>a(u.target.value)})}),i.jsx("div",{className:"linked-nodes-list overflow-hidden",children:d.length>0?i.jsx(hs,{itemList:d,maxHeight:"200px",itemStyles:"border border-border",onSelectionChange:u=>{if(u.length>0){const g=c[u[0]];g&&(n(g),o())}}}):i.jsx("div",{className:"empty-state px-3 py-4 text-sm text-muted-foreground text-center",children:r?"No matching nodes found":"No linked nodes yet"})})]})},hr=({node:e,isChanged:t})=>{const n=e.title||e.id,o=typeof e.content=="string"?e.content:"";return i.jsxs("div",{className:`absolute border-2 ${t?"border-green-500 ring-2 ring-green-500/30":"border-black"} bg-white rounded p-1`,style:{left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,fontSize:"10px"},children:[i.jsx("div",{className:"font-semibold text-[10px] truncate",children:n}),i.jsx("div",{className:"text-[8px] text-muted-foreground truncate",children:o.substring(0,50)})]})},Rh=({isVisible:e,changes:t,previewNodes:n,currentNodes:o,arrows:s,executionResult:r,onApply:a,onCancel:l})=>{const c=t.length>0,[d,u]=S.useState("canvas"),g=new Set(t.map(f=>f.nodeId)),p=S.useMemo(()=>{if(!r)return null;const f={workflow:{success:r.success,duration:`${r.duration}ms`,executedNodes:r.executedNodeCount,errors:r.errors.length},steps:[],changes:{totalNodes:t.length,updates:t.map(h=>({nodeId:h.nodeId,before:h.before,after:h.after}))}};return r.nodeStates&&r.nodeStates.forEach((h,m)=>{var x;(x=h.executionData)!=null&&x.steps&&h.executionData.steps.forEach(w=>{var N,j,C,I;const b={type:w.stepType,label:w.label,order:w.order};w.stepType==="source"?b.sourceData=h.executionData.sourceData:w.stepType==="loop"?b.items=((N=h.executionData.sourceData)==null?void 0:N.length)||0:w.stepType==="if"?(b.config=w.config,b.conditionResult=w.conditionResult,b.checkedNodes=((j=w.checkedNodes)==null?void 0:j.length)||0,b.matchedNodes=((C=w.checkedNodes)==null?void 0:C.filter(A=>A.matches).map(A=>A.nodeId))||[]):w.stepType==="nodeUpdate"&&(b.targets=((I=h.executionData.nodeUpdates)==null?void 0:I.length)||0),f.steps.push(b)})}),f},[r,t]);return i.jsx(We,{isVisible:e,onClose:l,title:"Workflow Dry Run Results",shouldCloseManually:!0,resizable:!0,initialSize:{width:1200,height:700},children:i.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden",children:[i.jsxs("div",{className:"p-4 bg-muted border-b border-border flex items-center justify-between",children:[i.jsx("div",{className:"text-sm",children:c?i.jsxs(i.Fragment,{children:[i.jsx("strong",{children:t.length})," node",t.length!==1?"s":""," will be updated"]}):i.jsx("span",{className:"text-muted-foreground",children:"No changes to apply"})}),c&&i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs("button",{"data-test":"dry-run-view-canvas-button",onClick:()=>u("canvas"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="canvas"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[i.jsx(Zo,{size:14}),"Canvas Preview"]}),i.jsxs("button",{"data-test":"dry-run-view-list-button",onClick:()=>u("list"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="list"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[i.jsx(La,{size:14}),"Details"]}),i.jsxs("button",{"data-test":"dry-run-view-json-button",onClick:()=>u("json"),className:`px-3 py-1 text-xs rounded flex items-center gap-1 ${d==="json"?"bg-primary text-primary-foreground":"bg-background border border-border"}`,children:[i.jsx(Dr,{size:14}),"JSON"]})]})]}),i.jsx("div",{className:"flex-1 overflow-hidden",children:c?d==="json"?i.jsx("div",{className:"h-full overflow-auto p-4 bg-gray-50",children:i.jsx("pre",{className:"text-xs font-mono bg-background border border-border rounded p-4 overflow-x-auto",children:JSON.stringify(p,null,2)})}):d==="canvas"?i.jsxs("div",{className:"h-full flex gap-2 p-2",children:[i.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[i.jsx("div",{className:"bg-muted px-2 py-1 text-xs font-semibold border-b border-border",children:"Current State"}),i.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:o.map(f=>i.jsx(hr,{node:f,isChanged:g.has(f.id)},f.id))})]}),i.jsxs("div",{className:"flex-1 border border-border rounded overflow-hidden flex flex-col",children:[i.jsx("div",{className:"bg-green-500/10 px-2 py-1 text-xs font-semibold border-b border-green-500/30 text-green-700 dark:text-green-400",children:"Preview (After Apply)"}),i.jsx("div",{className:"flex-1 relative bg-gray-50 overflow-auto",children:n.map(f=>i.jsx(hr,{node:f,isChanged:g.has(f.id)},f.id))})]})]}):i.jsx("div",{className:"overflow-y-auto p-4 space-y-4",children:t.map((f,h)=>i.jsxs("div",{className:"border border-border rounded-lg p-3 space-y-2 bg-background",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:f.nodeId}),i.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",h+1]})]}),f.before.title!==f.after.title&&i.jsxs("div",{className:"space-y-1",children:[i.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Title"}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20",children:f.before.title||i.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),i.jsx(Gt,{size:16,className:"text-muted-foreground flex-shrink-0"}),i.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20",children:f.after.title||i.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]}),f.before.content!==f.after.content&&i.jsxs("div",{className:"space-y-1",children:[i.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Content"}),i.jsxs("div",{className:"flex items-start gap-2",children:[i.jsx("div",{className:"flex-1 text-sm bg-destructive/10 text-destructive px-2 py-1 rounded border border-destructive/20 font-mono max-h-24 overflow-y-auto",children:f.before.content?i.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:f.before.content}):i.jsx("span",{className:"text-muted-foreground italic",children:"empty"})}),i.jsx(Gt,{size:16,className:"text-muted-foreground flex-shrink-0 mt-1"}),i.jsx("div",{className:"flex-1 text-sm bg-green-500/10 text-green-700 dark:text-green-400 px-2 py-1 rounded border border-green-500/20 font-mono max-h-24 overflow-y-auto",children:f.after.content?i.jsx("pre",{className:"whitespace-pre-wrap text-xs",children:f.after.content}):i.jsx("span",{className:"text-muted-foreground italic",children:"empty"})})]})]})]},f.nodeId))}):i.jsx("div",{className:"text-center text-muted-foreground py-8",children:"The workflow executed successfully but made no changes to the canvas nodes."})}),i.jsxs("div",{className:"p-4 border-t border-border flex items-center justify-end gap-2",children:[i.jsxs("button",{"data-test":"dry-run-cancel-button",onClick:l,className:"px-4 py-2 text-sm border border-border rounded hover:bg-accent transition-colors flex items-center gap-2",children:[i.jsx(Ze,{size:16}),"Cancel"]}),c&&i.jsxs("button",{"data-test":"dry-run-apply-button",onClick:a,className:"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90 transition-colors flex items-center gap-2",children:[i.jsx(qo,{size:16}),"Apply Changes"]})]})]})})},Xh=({width:e,height:t,className:n,style:o})=>{var x;const s=S.useRef(null),r="cursor-default",a=S.useRef($.getState().setCanvasDimensions),l=S.useRef(async(w=!1,b)=>{var v,k;const N=$.getState(),j=((v=N.projectCanvas.getActive())==null?void 0:v.coreState.nodes)??[],C=((k=N.projectCanvas.getActive())==null?void 0:k.coreState.arrows)??[];let I=b;if(!I){const R=j.find(M=>{var D;return((D=M.data)==null?void 0:D.nodeType)==="workflowOrchestration"});I=(R==null?void 0:R.id)||"wf-orchestration-001"}const A=new di;A.loadWorkflow(j,C);const T=await A.executeWorkflow(I),E=[],y=w?j.map(R=>({...R})):[];return T.nodeStates&&(T.nodeUpdates&&T.nodeUpdates.length>0&&T.nodeUpdates.forEach(R=>{const M=j.find(D=>D.id===R.nodeId);if(M&&(E.push({nodeId:R.nodeId,before:{title:M.title,content:typeof M.content=="string"?M.content:void 0},after:{title:R.updates.title!==void 0?R.updates.title:M.title,content:R.updates.content!==void 0?R.updates.content:typeof M.content=="string"?M.content:void 0}}),w)){const D=y.find(_=>_.id===R.nodeId);D&&(R.updates.title!==void 0&&(D.title=R.updates.title),R.updates.content!==void 0&&(D.content=R.updates.content))}w||N.updateNode(R.nodeId,R.updates)}),T.nodeStates.forEach((R,M)=>{var W,z,U,V;const D=j.find(ee=>ee.id===M);if(!D)return;const _=((W=D.data)==null?void 0:W.nodeType)==="workflowSource",L=((z=D.data)==null?void 0:z.nodeType)==="workflowOrchestration",P=_||L,O=((U=R.executionData)==null?void 0:U.formattedOutput)||((V=R.executionData)==null?void 0:V.output)||D.content;if(!w){const ee={content:P?D.content:O,data:{...D.data||{},executionState:R.executionState}};N.updateNode(M,ee)}})),{...T,success:T.success,errors:T.errors||[],changes:E,previewNodes:y,currentNodes:j,arrows:C}}),[c,d]=S.useState({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null}),[u,g]=S.useState({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]});S.useEffect(()=>{const w=s.current;if(!w)return;a.current(w.offsetWidth,w.offsetHeight);const b=new ResizeObserver(N=>{for(const j of N){const{width:C,height:I}=j.contentRect;a.current(C,I)}});return b.observe(w),()=>{b.disconnect()}},[]),S.useEffect(()=>{var w;(w=s.current)==null||w.focus()},[]);const p=S.useMemo(()=>({executeWorkflow:(w,b)=>l.current(w,b),showDryRunResults:w=>{g({isVisible:!0,changes:w.changes||[],previewNodes:w.previewNodes||[],currentNodes:w.currentNodes||[],arrows:w.arrows||[],executionResult:w.result})},showLinkedNodesPopover:(w,b)=>{d({isVisible:!0,sourceNode:w,newlyCreatedNodeId:b||null})}}),[]),f=w=>{const{newlyCreatedNodeId:b}=c;if(b){const N=$.getState(),j=N.getNodeById(b);if(j&&typeof j.content=="string"){const I=(typeof w.content=="string"?w.content:"")+`

`+j.content;N.updateNode(w.id,{content:I}),N.deleteNodeById(b)}}},h=()=>{d({isVisible:!1,sourceNode:null,newlyCreatedNodeId:null})},m=((x=$.getState().projectCanvas.getActive())==null?void 0:x.coreState.nodes)??[];return i.jsx(Jg,{value:p,children:i.jsx(Za,{value:s,children:i.jsxs("div",{ref:s,id:"CanvasAppV2","data-canvas-container":!0,className:ae("relative","overflow-hidden","focus:outline-none",r,n),style:{width:e,height:t,touchAction:"none",...o},tabIndex:0,children:[i.jsx(xu,{}),i.jsx(Ih,{}),c.sourceNode&&i.jsx(kh,{sourceNode:c.sourceNode,allNodes:m,onNodeSelect:f,onClose:h,isVisible:c.isVisible}),i.jsx(Rh,{isVisible:u.isVisible,changes:u.changes,previewNodes:u.previewNodes,currentNodes:u.currentNodes,arrows:u.arrows,executionResult:u.executionResult,onApply:async()=>{g({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]}),await l.current(!1)},onCancel:()=>{g({isVisible:!1,changes:[],previewNodes:[],currentNodes:[],arrows:[]})}})]})})})};export{Xh as C};
