var T=Object.defineProperty;var E=(s,t,e)=>t in s?T(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var g=(s,t,e)=>E(s,typeof t!="symbol"?t+"":t,e);function Z(s){const t=s.getBoundingClientRect();return{width:t.width,height:t.height}}function S(s){const t=s.getBoundingClientRect();return{x:t.left,y:t.top}}function k(s,t){return s.x>=t.left&&s.x<=t.right&&s.y>=t.top&&s.y<=t.bottom}function C(s,t){return{x:Math.round(s.x/t.x)*t.x,y:Math.round(s.y/t.y)*t.y}}function z(s,t,e){const n={...s};let i=e,r=e;return t.forEach(h=>{const d=S(h),a=Z(h),u=[d.x,d.x+a.width],o=[d.y,d.y+a.height];u.forEach(l=>{const m=Math.abs(s.x-l);m<i&&(i=m,n.x=l)}),o.forEach(l=>{const m=Math.abs(s.y-l);m<r&&(r=m,n.y=l)})}),n}function L(s,t,e=[]){if(!t.enabled)return s;let n={...s};return t.snapToGrid&&(n=C(n,t.snapToGrid)),t.snapToElements&&e.length>0&&(n=z(n,e,t.threshold)),n}let c=null,p=null,y=null,D=null;const w=30;function M(s,t){var u;const e=t.filter(o=>k(s,o.rect));if(e.length===0)return c=null,p=null,null;if(c&&p&&e.length>0){const o=((u=t.find(f=>f.zone.id===(c==null?void 0:c.id)))==null?void 0:u.depth)??-1,l=e.some(f=>f.zone.id===(c==null?void 0:c.id)),m=Math.max(...e.map(f=>f.depth));if(!l&&o>=m){y||(y=p);const f=Math.abs(s.x-y.x),x=Math.abs(s.y-p.y);if(f<w&&x>0)return c;y=null}else y=null}if(e.length===1){if(e[0].depth===0&&c&&p){const o=Math.abs(s.x-p.x),l=Math.abs(s.y-p.y),m=c.id==="root";if(o<w&&l>0&&!m)return c}return c=e[0].zone,p=s,e[0].zone}let n=e[0],i=n.depth,r=n.rect.width*n.rect.height;for(const o of e){const l=o.rect.width*o.rect.height;(o.depth>i||o.depth===i&&l<r)&&(i=o.depth,r=l,n=o)}const d=(D?Math.abs(s.x-D.x):0)>=w;if(c&&p&&n.zone.id!==c.id){const o=e.find(l=>l.zone.id===c.id);if(o&&n.depth!==o.depth&&!d)return c}const a=typeof document<"u"?document.elementFromPoint(s.x,s.y):null;if(a){let o=a,l=null;for(;o&&!l;)l=o.getAttribute("data-drag-handle"),l||(o=o.parentElement);if(l&&o){const m=o.getBoundingClientRect(),f=m.top+m.height/2;if(s.y>=f){const b=t.find(P=>P.zone.id===l&&P.depth>n.depth);b&&b.depth>n.depth&&(D?Math.abs(s.x-D.x):0)>=w&&(n=b)}}}return(!c||c.id!==n.zone.id)&&(D=s),c=n.zone,p=s,n.zone}function I(s,t,e,n,i){if(e.length===0)return 0;const r=n==="vertical",h=[...e].sort((a,u)=>{const o=a.element.getBoundingClientRect(),l=u.element.getBoundingClientRect();return r?o.top-l.top:o.left-l.left}),d=h.filter(a=>a.id!==i.id);if(d.length===0)return 0;for(let a=0;a<d.length;a++){const u=d[a],o=u.element.getBoundingClientRect(),l=r?o.top+o.height/2:o.left+o.width/2;if((r?s.y:s.x)<l)return h.indexOf(u)}return h.length}function v(s){return"touches"in s&&s.touches.length>0?{x:s.touches[0].clientX,y:s.touches[0].clientY}:"clientX"in s?{x:s.clientX,y:s.clientY}:{x:0,y:0}}const A={snap:{enabled:!1,threshold:10},sort:{enabled:!1,orientation:"vertical",threshold:.5},dragThreshold:5,autoScroll:{enabled:!1,speed:10,margin:50}};class B{constructor(t,e){g(this,"draggables",new Map);g(this,"dropZones",new Map);g(this,"config");g(this,"callbacks");g(this,"state");g(this,"animationFrameId",null);g(this,"scrollInterval",null);g(this,"dragPreview",null);g(this,"lastMoveTimestamp",0);g(this,"cachedZoneGeometry",[]);g(this,"lastTouchTime",0);g(this,"pendingTouchStart",null);g(this,"pendingMouseStart",null);this.config={...A,...t},this.callbacks=e||{},this.state=this.getInitialState(),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this)}getInitialState(){return{isDragging:!1,item:null,startPosition:{x:0,y:0},currentPosition:{x:0,y:0},offset:{x:0,y:0},currentDropZone:null,potentialDropZone:null,sortIndex:null}}registerDraggable(t,e,n){const i={id:t,element:e,data:n};this.draggables.set(t,i),e.style.setProperty("user-select","none","important"),e.style.setProperty("-webkit-user-select","none","important"),e.style.setProperty("-moz-user-select","none","important"),e.style.setProperty("-ms-user-select","none","important"),e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.setProperty("cursor","move","important"),e.style.setProperty("touch-action","manipulation","important"),e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),e.__dndItem=i}unregisterDraggable(t){const e=this.draggables.get(t);e&&(e.element.style.removeProperty("user-select"),e.element.style.removeProperty("-webkit-user-select"),e.element.style.removeProperty("-moz-user-select"),e.element.style.removeProperty("-ms-user-select"),e.element.style.removeProperty("cursor"),e.element.style.removeProperty("touch-action"),e.element.style.userSelect="",e.element.style.webkitUserSelect="",e.element.removeEventListener("mousedown",this.handleMouseDown),e.element.removeEventListener("touchstart",this.handleTouchStart),delete e.element.__dndItem,this.draggables.delete(t))}registerDropZone(t,e,n,i){const r={id:t,element:e,accepts:n,data:i};this.dropZones.set(t,r),e.__dndZone=r}unregisterDropZone(t){const e=this.dropZones.get(t);e&&(delete e.element.__dndZone,this.dropZones.delete(t))}handleMouseDown(t){if(Date.now()-this.lastTouchTime<500)return;const e=t.currentTarget.__dndItem;if(!e)return;const i=t.target.tagName.toLowerCase();if(i==="input"||i==="textarea"||i==="button"||i==="select")return;const r=v(t);this.pendingMouseStart={item:e,position:r},document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp)}handleTouchStart(t){this.lastTouchTime=Date.now();const e=t.currentTarget.__dndItem;if(!e)return;const i=t.target.tagName.toLowerCase();if(i==="input"||i==="textarea"||i==="button"||i==="select")return;const r=v(t);this.pendingTouchStart={item:e,position:r},document.addEventListener("touchmove",this.handleTouchMove,{passive:!0}),document.addEventListener("touchend",this.handleTouchEnd)}startDrag(t,e){const n=S(t.element),i={x:e.x-n.x,y:e.y-n.y};this.cachedZoneGeometry=Array.from(this.dropZones.values()).map(r=>{const h=r.element.getBoundingClientRect();let d=0,a=r.element;for(;a.parentElement&&(a=a.parentElement,a.hasAttribute("data-drop-zone")&&d++,!a.hasAttribute("data-tree-root")););return{id:r.id,rect:{left:h.left,top:h.top,right:h.right,bottom:h.bottom,width:h.width,height:h.height},depth:d,zone:r}}),this.state={isDragging:!1,item:t,startPosition:e,currentPosition:e,offset:i,currentDropZone:null,potentialDropZone:null,sortIndex:null},document.body.style.userSelect="none",document.body.style.webkitUserSelect="none"}createDragPreview(){if(this.state.item)try{const t=this.state.item.element;this.dragPreview=t.cloneNode(!0),this.dragPreview.style.position="fixed",this.dragPreview.style.pointerEvents="none",this.dragPreview.style.zIndex="999999",this.dragPreview.style.opacity="0.4",this.dragPreview.style.transform="rotate(2deg)",this.dragPreview.style.transition="none",this.dragPreview.style.boxShadow="0 2px 8px rgba(0,0,0,0.15)",this.dragPreview.style.display="block",this.dragPreview.style.visibility="visible";const e=t.getBoundingClientRect();this.dragPreview.style.width=`${e.width}px`,this.dragPreview.style.height=`${e.height}px`,this.updateDragPreviewPosition(this.state.currentPosition),document.body.appendChild(this.dragPreview)}catch(t){console.error("[DragDrop] Failed to create drag preview:",t)}}updateDragPreviewPosition(t){if(!this.dragPreview||!this.state.item)return;const e=t.x-this.state.offset.x,n=t.y-this.state.offset.y;this.dragPreview.style.left=`${e}px`,this.dragPreview.style.top=`${n}px`}removeDragPreview(){this.dragPreview&&this.dragPreview.parentNode&&(this.dragPreview.parentNode.removeChild(this.dragPreview),this.dragPreview=null),document.body.style.userSelect="",document.body.style.webkitUserSelect=""}handleMouseMove(t){const e=v(t);if(this.pendingMouseStart&&!this.state.item){const n=this.config.dragThreshold||5;if(Math.hypot(e.x-this.pendingMouseStart.position.x,e.y-this.pendingMouseStart.position.y)>n)t.preventDefault(),this.startDrag(this.pendingMouseStart.item,this.pendingMouseStart.position),this.pendingMouseStart=null;else return}this.state.item&&this.updateDrag(e)}handleTouchMove(t){const e=v(t);if(this.pendingTouchStart&&!this.state.item){const n=this.config.dragThreshold||5;if(Math.hypot(e.x-this.pendingTouchStart.position.x,e.y-this.pendingTouchStart.position.y)>n)this.startDrag(this.pendingTouchStart.item,this.pendingTouchStart.position),this.pendingTouchStart=null;else return}this.state.item&&this.updateDrag(e)}updateDrag(t){var r,h,d;if(!this.state.item)return;const e=this.config.dragThreshold||5,n=Math.hypot(t.x-this.state.startPosition.x,t.y-this.state.startPosition.y);if(!this.state.isDragging&&n>e&&(this.state.isDragging=!0,this.createDragPreview(),this.callbacks.onDragStart&&this.callbacks.onDragStart({item:this.state.item,position:this.state.startPosition})===!1)){this.cancelDrag();return}if(!this.state.isDragging)return;this.updateDragPreviewPosition(t);let i=t;if((r=this.config.snap)!=null&&r.enabled){const a=Array.from(this.draggables.values()).filter(u=>{var o;return u.id!==((o=this.state.item)==null?void 0:o.id)}).map(u=>u.element);i=L(t,this.config.snap,a)}if(this.state.currentPosition=i,this.state.potentialDropZone=M(i,this.cachedZoneGeometry),(h=this.config.sort)!=null&&h.enabled&&this.state.potentialDropZone){const a=this.getItemsInDropZone(this.state.potentialDropZone);this.state.sortIndex=I(i,this.state.potentialDropZone.element,a,this.config.sort.orientation,this.state.item)}this.lastMoveTimestamp=Date.now(),this.callbacks.onDragMove&&this.callbacks.onDragMove({item:this.state.item,position:i,dropZone:this.state.potentialDropZone,sortIndex:this.state.sortIndex}),(d=this.config.autoScroll)!=null&&d.enabled&&this.handleAutoScroll(t)}handleMouseUp(t){if(document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),this.pendingMouseStart&&!this.state.item){this.pendingMouseStart=null;return}if(this.state.item){const e=v(t);this.endDrag(e)}}handleTouchEnd(t){if(document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),this.pendingTouchStart&&!this.state.item){const e=this.pendingTouchStart.item.element;this.pendingTouchStart=null,setTimeout(()=>{const n=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(n)},0);return}if(this.state.item){const e=v(t);this.endDrag(e)}}endDrag(t){var a;const e=this.state.isDragging,n=this.state.item;let i=this.state.potentialDropZone,r=this.state.sortIndex;if(t){const u=M(t,this.cachedZoneGeometry);if(u&&(i=u,(a=this.config.sort)!=null&&a.enabled&&i&&n)){const o=this.getItemsInDropZone(i);r=I(t,i.element,o,this.config.sort.orientation,n)}}this.removeDragPreview(),this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null);const h=this.state.currentPosition,d=this.state.startPosition;this.state=this.getInitialState(),e&&n&&(i&&this.callbacks.onDrop&&this.callbacks.onDrop({item:n,dropZone:i,position:h,sortIndex:r}),this.callbacks.onDragEnd&&this.callbacks.onDragEnd({item:n,startPosition:d,endPosition:h,dropZone:i,sortIndex:r,cancelled:!1}))}cancelDrag(){const t=this.state.item;this.removeDragPreview(),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),this.pendingTouchStart=null,this.pendingMouseStart=null,this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null),t&&this.callbacks.onDragEnd&&this.callbacks.onDragEnd({item:t,startPosition:this.state.startPosition,endPosition:this.state.currentPosition,dropZone:null,sortIndex:null,cancelled:!0}),this.state=this.getInitialState()}getItemsInDropZone(t){const e=[];return this.draggables.forEach(n=>{var i;((i=n.data)==null?void 0:i.dropZoneId)===t.id&&e.push(n)}),e}handleAutoScroll(t){var h;if(!((h=this.config.autoScroll)!=null&&h.enabled))return;const e=this.config.autoScroll.margin,n=this.config.autoScroll.speed;let i=0,r=0;t.x<e?i=-n:t.x>window.innerWidth-e&&(i=n),t.y<e?r=-n:t.y>window.innerHeight-e&&(r=n),i!==0||r!==0?this.scrollInterval||(this.scrollInterval=window.setInterval(()=>{window.scrollBy(i,r)},16)):this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null)}getState(){return{...this.state}}getCachedZoneGeometry(){return this.cachedZoneGeometry}updateConfig(t){this.config={...this.config,...t}}updateCallbacks(t){this.callbacks={...this.callbacks,...t}}destroy(){this.draggables.forEach(t=>this.unregisterDraggable(t.id)),this.dropZones.forEach(t=>this.unregisterDropZone(t.id)),(this.state.isDragging||this.pendingTouchStart||this.pendingMouseStart)&&this.cancelDrag(),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.scrollInterval&&clearInterval(this.scrollInterval)}}export{B as D};
