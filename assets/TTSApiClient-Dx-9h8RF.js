var N=Object.defineProperty;var E=(d,t,e)=>t in d?N(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var g=(d,t,e)=>E(d,typeof t!="symbol"?t+"":t,e);import{r as f,j as l}from"./react-vendor-Byz07MLO.js";import{t as L}from"./utils-DjFvUtuq.js";import{y as h,aq as T,L as x,aj as w,ax as n}from"./index-BbgB-sev.js";import{aj as S}from"./icons-Detj0uxE.js";const p=[{code:"en",label:"English",nativeName:"English"},{code:"vi",label:"Vietnamese",nativeName:"Tiếng Việt"}],j="en",U=["en","vi"],I=()=>{const[d,t]=f.useState(()=>{var a,r;return((r=(a=h.getState().app)==null?void 0:a.tts)==null?void 0:r.language)??j}),[e,o]=f.useState(()=>{var r,s;const a=(s=(r=h.getState().app)==null?void 0:r.tts)==null?void 0:s.enabledLanguages;return Array.isArray(a)&&a.length>0?a:U}),i=()=>{if(e.length<=1)return;const a=e.indexOf(d),r=a===-1?0:(a+1)%e.length,s=e[r];t(s),h.update("app",{tts:{language:s}});const c=p.find(y=>y.code===s),v=c?`${c.label} (${c.nativeName})`:s;L(`TTS Language: ${v}`,{duration:1500})},u=(a,r)=>{let s;if(r)s=p.map(c=>c.code).filter(c=>e.includes(c)||c===a);else{if(e.length<=1)return;s=e.filter(c=>c!==a)}if(o(s),h.update("app",{tts:{enabledLanguages:s}}),!s.includes(d)){const c=s[0];t(c),h.update("app",{tts:{language:c}})}},m=p.find(a=>a.code===d),b=m?`${m.label} (${m.nativeName})`:d;return l.jsx(T,{label:l.jsx(S,{className:"h-5 w-5"}),onAction:i,variant:"outline",size:"icon",tooltipText:`TTS: ${b} - Click to cycle, hold for settings`,popoverContent:l.jsxs("div",{className:"space-y-3 p-1","data-test":"tts-language-panel",children:[l.jsx(x,{className:"text-sm font-medium",children:"Languages to cycle"}),l.jsx("div",{className:"space-y-2",children:p.map(a=>{const r=e.includes(a.code),s=e.length===1&&r;return l.jsxs("div",{className:"flex items-center space-x-2","data-test":"tts-language-option",children:[l.jsx(w,{id:`tts-lang-${a.code}`,checked:r,onCheckedChange:c=>u(a.code,!!c),disabled:s}),l.jsxs(x,{htmlFor:`tts-lang-${a.code}`,className:`cursor-pointer ${s?"opacity-50":""}`,children:[a.label," (",a.nativeName,")"]})]},a.code)})}),l.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t","data-test":"current-tts-language-indicator",children:["Current: ",l.jsx("span",{className:"font-medium",children:b}),e.length>1&&l.jsxs("span",{className:"ml-1",children:["(cycling ",e.map(a=>{const r=p.find(s=>s.code===a);return r?r.label:a}).join(" → "),")"]})]})]})})};class A{constructor(){g(this,"baseUrl");g(this,"serviceName","TTSApiClient");g(this,"audioElement",null);this.baseUrl="http://192.168.2.70:9876",n.info(`Initialized TTS client with baseUrl: ${this.baseUrl}`,this.serviceName)}async synthesize(t){if(!this.baseUrl)throw n.error("No TTS API base URL configured",this.serviceName),new Error("TTS API base URL not configured");if(!t.text||t.text.trim().length===0)throw n.error("Text input is empty",this.serviceName),new Error("Text input cannot be empty");if(t.text.length>5e3)throw n.error("Text exceeds maximum length of 5000 characters",this.serviceName),new Error("Text exceeds maximum length of 5000 characters");n.info(`Generating speech with model "${t.voice||"default"}" and language "${t.language||"en"}" for text: "${t.text.substring(0,50)}..."`,this.serviceName);try{const e=await fetch(`${this.baseUrl}/api/tts/synthesize-audio`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t.text,voice:t.voice,language:t.language||"en"})});if(!e.ok){let i=`HTTP error! status: ${e.status}`;try{const u=await e.json();i=u.error||u.message||i}catch{}throw n.error(`TTS synthesis failed: ${i}`,this.serviceName),new Error(i)}const o=await e.blob();if(!o.type.includes("audio"))throw n.error(`Unexpected response type: ${o.type}`,this.serviceName),new Error("Response is not audio data");return n.info(`Successfully generated audio: ${o.size} bytes`,this.serviceName),{success:!0,audioBlob:o}}catch(e){const o=e instanceof Error?e.message:String(e);return n.error(`Failed to generate speech: ${o}`,this.serviceName),{success:!1,error:o}}}playAudio(t,e,o=1){if(!t||!t.type.includes("audio"))throw n.error("Invalid audio blob provided",this.serviceName),new Error("Invalid audio blob");this.stopAudio();const i=URL.createObjectURL(t);this.audioElement=new Audio(i);const u=Math.max(.25,Math.min(4,o));this.audioElement.playbackRate=u,this.audioElement.addEventListener("loadedmetadata",()=>{this.audioElement.playbackRate=u},{once:!0}),e?this.audioElement.onended=()=>{URL.revokeObjectURL(i),e()}:this.audioElement.onended=()=>{URL.revokeObjectURL(i)},this.audioElement.play().catch(m=>{n.error(`Failed to play audio: ${m}`,this.serviceName),URL.revokeObjectURL(i)}),n.info(`Audio playback started at ${u}x speed (requested: ${o}x)`,this.serviceName)}stopAudio(){this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0,n.info("Audio playback stopped",this.serviceName))}downloadAudio(t,e="audio.wav"){if(!t||!t.type.includes("audio"))throw n.error("Invalid audio blob provided for download",this.serviceName),new Error("Invalid audio blob");const o=URL.createObjectURL(t),i=document.createElement("a");i.href=o,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),n.info(`Audio downloaded as ${e}`,this.serviceName)}getAudioElement(){return this.audioElement}isPlaying(){return this.audioElement?!this.audioElement.paused:!1}setPlaybackSpeed(t){if(!this.audioElement){n.warning("No audio element to set speed",this.serviceName);return}const e=Math.max(.25,Math.min(4,t));this.audioElement.playbackRate=e,n.info(`Playback speed set to ${e}x`,this.serviceName)}updatePlaybackSpeed(t){if(!this.audioElement){n.warning("No audio element to update speed",this.serviceName);return}const e=Math.max(.25,Math.min(4,t));this.audioElement.playbackRate=e,n.info(`Playback speed updated to ${e}x (live)`,this.serviceName)}}const P=new A;export{I as T,P as t};
