import{u as te,d as ae,r as o,j as t}from"./react-vendor-Byz07MLO.js";import{u as se,D as ie}from"./data-table-BsBSQvmG.js";import{v as k,I as ne,a as v,f as B,A as le,D as oe,C as re,b as ce,c as de,g as ue,L as U,S as me,h as fe,i as xe,j as he,k as V,l as pe,e as ge}from"./index-hTFRJyrx.js";import{T as be}from"./textarea-ZFIB_HyS.js";import{t as ve,d as Ce}from"./definitionHelper-CZKT8hW2.js";import{u as je}from"./useVietnameseTyping-CIW9gKE9.js";import{T as Ne,P as we}from"./TextareaPopoverAtCursor-DB-dMS5D.js";import{P as ke,a as ye,S as Te,X as Se,b as De,L as Ee,c as Ie,T as Pe,D as Ae,U as Re}from"./icons-yhbeTEay.js";import"./table-BU9steQ-.js";import"./utils-G1l1U0hd.js";import"./radix-ui-9f16WUVy.js";import"./ui-utils-BxIQ3qGg.js";import"./cursorPosition-otMhJ5rZ.js";function Ge(){const{listId:m="default"}=te(),S=ae(),[g,x]=o.useState([]),[D,A]=o.useState(null),[N,y]=o.useState({text:"",definition:""}),[E,I]=o.useState(null),[T,q]=o.useState(!0),[j,J]=o.useState("translation"),[c,L]=o.useState(null),R=o.useRef(!1),h=o.useRef(new Set),f=je({maxRows:3,maxColumnsPerRow:7,enabled:!0}),C=o.useCallback(e=>{if(!c)return;const s=e.map(a=>({id:a.id,text:a.text,definition:a.definition,playCount:a.playCount})),i=`vocabulary-entries-${m}`;localStorage.setItem(i,JSON.stringify(s)),k.updateEntryCount(m,s.length),console.log("ðŸ’¾ Auto-saved",s.length,"entries to list:",c.name)},[m,c]),K=o.useCallback(e=>{const s={id:e.id??`vocab-${Date.now()}`,text:e.transcription??"",definition:"",audioChunk:e,playCount:0,startTime:e.startTime};x(i=>{const a=[s,...i];return R.current=!0,queueMicrotask(()=>C(a)),a})},[C]),W=o.useCallback(e=>{x(s=>s.map(i=>{var a;if(((a=i.audioChunk)==null?void 0:a.id)===e.id){const n={...i,audioChunk:e,text:!i.text&&e.transcription?e.transcription:i.text};return n.definition.trim()&&h.current.add(n.id),n}return i}))},[]),G=o.useCallback(e=>{x(s=>{var n,u;const i=s.find(r=>{var p;return((p=r.audioChunk)==null?void 0:p.id)===e});if(!i)return console.log("ðŸ—‘ï¸ Chunk deleted but no matching entry:",e),s;if(!i.text||((n=i.audioChunk)==null?void 0:n.transcriptionStatus)==="pending"||((u=i.audioChunk)==null?void 0:u.transcriptionStatus)==="processing"){console.log("ðŸ—‘ï¸ Deleting entry with no/pending transcription for chunk:",e),h.current.delete(i.id);const r=s.filter(p=>p.id!==i.id);return queueMicrotask(()=>C(r)),r}const a=s.filter(r=>r.text===i.text);if(a.length===1){const r=a[0];console.log("ðŸ—‘ï¸ Deleting vocabulary entry with matching transcription:",r.text),h.current.delete(r.id);const p=s.filter(d=>d.id!==r.id);return queueMicrotask(()=>C(p)),p}else if(a.length>1)return console.log("âš ï¸ Multiple entries match transcription, skipping auto-delete:",i.text),s.map(r=>r.id===i.id?{...r,audioChunk:null}:r);return s})},[C]);o.useEffect(()=>{k.migrateOldData();const e=k.getListById(m);if(!e){S("/vocabulary/default",{replace:!0});return}L(e)},[m,S]),o.useEffect(()=>{if(!c)return;(async()=>{const s=`vocabulary-session-${m}`,i=await B.loadChunksBySession(s),a=`vocabulary-entries-${m}`,n=localStorage.getItem(a),u=n?JSON.parse(n):[],r=new Map(u.map(d=>[d.id,d])),p=i.map(d=>{const l=r.get(d.id??""),b={id:d.id??`vocab-${Date.now()}-${Math.random()}`,text:(l==null?void 0:l.text)??d.transcription??"",definition:(l==null?void 0:l.definition)??"",audioChunk:d,playCount:(l==null?void 0:l.playCount)??0,startTime:d.startTime};return b.definition.trim()&&h.current.add(b.id),b}).sort((d,l)=>l.startTime.getTime()-d.startTime.getTime());x(p),queueMicrotask(()=>{R.current=!0})})()},[m,c]),o.useEffect(()=>{!R.current||!c||C(g)},[g,C,c]);const P=o.useCallback(async(e,s)=>{x(i=>i.map(a=>a.id===e?{...a,isTranslating:!0}:a));try{let i;if(j==="translation")i=(await ve(s,"vi","en")).output;else{const a=await Ce(s,"English");i=a.definition,a.partOfSpeech&&(i=`(${a.partOfSpeech}) ${i}`),a.examples&&a.examples.length>0&&(i+=`

Examples:
${a.examples.map(n=>`â€¢ ${n}`).join(`
`)}`)}x(a=>a.map(n=>n.id===e?{...n,definition:i,isTranslating:!1}:n))}catch(i){console.error(`${j==="translation"?"Translation":"Definition"} failed:`,i),x(a=>a.map(n=>n.id===e?{...n,isTranslating:!1}:n))}},[j]);o.useEffect(()=>{if(!T)return;const e=g.filter(s=>s.text.trim()&&!s.definition.trim()&&!s.isTranslating&&!h.current.has(s.id));e.length>0&&console.log("ðŸ”„ Auto-translate triggered for",e.length,"entries:",e.map(s=>s.id)),e.forEach(s=>{h.current.add(s.id),P(s.id,s.text)})},[g,T,P]),o.useEffect(()=>{T||h.current.clear()},[T]);const M=o.useCallback(e=>{A(e.id),y({text:e.text,definition:e.definition})},[]),O=o.useCallback(e=>{x(s=>s.map(i=>i.id===e?{...i,text:N.text,definition:N.definition}:i)),A(null),y({text:"",definition:""})},[N]),$=o.useCallback(()=>{A(null),y({text:"",definition:""})},[]),z=o.useCallback(e=>{e.text.trim()&&(h.current.add(e.id),P(e.id,e.text))},[P]),_=o.useCallback(()=>{if(!c)return;const e=prompt("Enter a new name for this list:",c.name);e!=null&&e.trim()&&e.trim()!==c.name&&(k.updateList(m,{name:e.trim()}),L(k.getListById(m)))},[c,m]),H=o.useCallback(async()=>{if(!c)return;confirm(`Are you sure you want to delete "${c.name}"? This will remove all vocabulary entries and audio recordings in this list.`)&&(await k.deleteList(m)?S("/vocabulary/default"):alert("Cannot delete the last vocabulary list."))},[c,m,S]),X=o.useCallback(()=>{const e=g.map(u=>({id:u.id,text:u.text,definition:u.definition,playCount:u.playCount,startTime:u.startTime.toISOString()})),s=JSON.stringify(e,null,2),i=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(i),n=document.createElement("a");n.href=a,n.download=`vocabulary-${(c==null?void 0:c.name)||"list"}-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)},[g,c]),Q=o.useCallback(e=>{var a;const s=(a=e.target.files)==null?void 0:a[0];if(!s)return;const i=new FileReader;i.onload=n=>{var u;try{const r=JSON.parse((u=n.target)==null?void 0:u.result);if(!Array.isArray(r)){console.error("Invalid import data: not an array");return}x(p=>{const d=new Map(p.map(l=>[l.id,l]));return r.forEach(l=>{const b=d.get(l.id);if(b)b.text=l.text,b.definition=l.definition,b.playCount=l.playCount,l.definition.trim()&&h.current.add(l.id);else{const ee={id:l.id,text:l.text,definition:l.definition,audioChunk:null,playCount:l.playCount,startTime:l.startTime?new Date(l.startTime):new Date};d.set(l.id,ee),l.definition.trim()&&h.current.add(l.id)}}),[...d.values()].sort((l,b)=>b.startTime.getTime()-l.startTime.getTime())}),console.log("âœ… Imported",r.length,"vocabulary entries")}catch(r){console.error("Failed to import vocabulary:",r)}},i.readAsText(s),e.target.value=""},[]),F=o.useCallback(async e=>{var s;if((s=e.audioChunk)!=null&&s.blob){if(E===e.id){I(null);return}try{I(e.id);const i=new Audio(URL.createObjectURL(e.audioChunk.blob));i.onended=()=>{I(null),x(a=>a.map(n=>n.id===e.id?{...n,playCount:n.playCount+1}:n))},await i.play()}catch(i){console.error("Failed to play audio:",i),I(null)}}},[E]),Y=o.useMemo(()=>[{key:"text",header:"Text",sortable:!0,accessor:e=>{var i;const s=(i=e.audioChunk)==null?void 0:i.transcriptionStatus;return s==="pending"||s==="processing"?t.jsxs("div",{className:"text-loading flex items-center gap-2",children:[t.jsx("span",{className:"animate-spin w-4 h-4 border-2 border-current border-r-transparent rounded-full"}),t.jsx("span",{className:"text-sm text-muted-foreground",children:s==="pending"?"Pending...":"Processing..."})]}):s==="failed"?t.jsx("span",{className:"text-destructive text-sm italic",children:"Transcription failed"}):D===e.id?t.jsxs("div",{className:"relative",children:[t.jsx(ne,{ref:f.inputRef,value:N.text,onChange:a=>y(n=>({...n,text:a.target.value})),onInput:f.handleInput,onKeyDown:f.handleKeyDown,placeholder:"Enter text",className:"vocab-text-input"}),t.jsx(Ne,{inputRef:f.inputRef,show:f.showPopover,children:t.jsx("div",{className:"vietnamese-popover bg-popover text-popover-foreground shadow-md rounded-md border p-2",children:t.jsx(we,{items:f.diacritics,selectedIndex:f.selectedIndex,gridColumns:Math.min(f.diacritics.length,7),onItemClick:a=>f.selectDiacritic(a),itemClassName:"px-3 py-2",selectedItemClassName:"bg-accent text-accent-foreground",unselectedItemClassName:""})})})]}):t.jsx("span",{className:`vocab-text ${e.text?"":"text-muted-foreground italic"}`,children:e.text||"Click edit to add text"})}},{key:"definition",header:"Definition/Notes",sortable:!0,accessor:e=>e.isTranslating?t.jsxs("div",{className:"definition-translating flex items-center gap-2",children:[t.jsx("span",{className:"animate-spin w-4 h-4 border-2 border-current border-r-transparent rounded-full"}),t.jsx("span",{className:"text-sm text-muted-foreground",children:j==="translation"?"Translating...":"Defining..."})]}):D===e.id?t.jsx(be,{value:N.definition,onChange:s=>y(i=>({...i,definition:s.target.value})),placeholder:"Enter definition or notes",className:"vocab-definition-input min-h-[60px]"}):t.jsx("span",{className:`vocab-definition ${e.definition?"":"text-muted-foreground italic"}`,children:e.definition||"Click edit to add definition"})},{key:"audio",header:"Audio",sortable:!1,width:120,accessor:e=>{var s;return t.jsxs("div",{className:"audio-controls flex items-center gap-2",children:[t.jsx(v,{size:"sm",variant:"outline",onClick:()=>F(e),disabled:!((s=e.audioChunk)!=null&&s.blob),className:"audio-play-button",children:E===e.id?t.jsx(ke,{className:"w-4 h-4"}):t.jsx(ye,{className:"w-4 h-4"})}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[e.playCount,"x"]})]})}},{key:"actions",header:"Actions",sortable:!1,width:150,accessor:e=>t.jsx("div",{className:"action-buttons flex gap-1",children:D===e.id?t.jsxs(t.Fragment,{children:[t.jsx(v,{size:"sm",variant:"default",onClick:()=>O(e.id),className:"save-button",children:t.jsx(Te,{className:"w-4 h-4"})}),t.jsx(v,{size:"sm",variant:"outline",onClick:$,className:"cancel-button",children:t.jsx(Se,{className:"w-4 h-4"})})]}):t.jsxs(t.Fragment,{children:[t.jsx(v,{size:"sm",variant:"outline",onClick:()=>M(e),className:"edit-button",children:t.jsx(De,{className:"w-4 h-4"})}),t.jsx(v,{size:"sm",variant:"outline",onClick:()=>z(e),disabled:!e.text.trim()||e.isTranslating,className:"translate-button",title:"Translate text to definition",children:t.jsx(Ee,{className:"w-4 h-4"})})]})})}],[D,N,E,j,M,O,$,F,z,f.showPopover,f.diacritics,f.selectedIndex]),w=se({data:g,columns:Y,initialSortBy:"text",initialSortOrder:"asc",initialPageSize:10,enableSelection:!0,selectionOptions:{multiSelect:!0,getRowId:e=>e.id}}),Z=o.useCallback(async()=>{const s=Array.from(w.selection.selectedRows).map(a=>g[a]).filter(Boolean);await Promise.all(s.filter(a=>{var n;return(n=a.audioChunk)==null?void 0:n.id}).map(a=>B.deleteChunk(a.audioChunk.id)));const i=s.map(a=>a.id);i.forEach(a=>h.current.delete(a)),x(a=>{const n=a.filter(u=>!i.includes(u.id));return queueMicrotask(()=>C(n)),n}),w.selection.actions.deselectAll()},[w.selection,g,C]);return t.jsxs("div",{className:"vocabulary-page lg:h-full flex flex-col lg:flex-row gap-6 p-6 overflow-auto lg:overflow-hidden",children:[t.jsx("div",{className:"audio-panel-wrapper lg:flex-[1]",children:t.jsx(le,{sessionName:`vocabulary-session-${m}`,initialConfig:{autoCreateChunks:!1,silenceDetectionConfig:{...oe,minActiveDuration:500}},onChunkCreated:K,onChunkUpdated:W,onChunkDeleted:G})}),t.jsx("div",{className:"vocabulary-table-container flex-1 lg:flex-[3] flex flex-col lg:order-1 min-h-[600px] lg:min-h-0",children:t.jsxs(re,{className:"flex-1 flex flex-col min-h-full lg:min-h-0",children:[t.jsxs(ce,{className:"flex-shrink-0",children:[t.jsxs("div",{className:"title-row flex items-center justify-between mb-2",children:[t.jsxs(de,{children:[(c==null?void 0:c.name)??"Vocabulary"," Entries"]}),t.jsxs("div",{className:"list-actions flex items-center gap-1",children:[t.jsx(ue,{title:"Vocabulary Settings",buttonClassName:"h-8 w-8",contentClassName:"w-[320px]",variant:"ghost",size:"icon",storageKey:"vocabulary-config",children:t.jsxs("div",{className:"vocabulary-config-content space-y-3",children:[t.jsxs("div",{className:"vocab-mode-setting space-y-1",children:[t.jsx(U,{htmlFor:"vocab-mode",className:"text-sm font-semibold",children:"Mode"}),t.jsxs(me,{value:j,onValueChange:e=>J(e),children:[t.jsx(fe,{id:"vocab-mode",className:"h-9 text-sm",children:t.jsx(xe,{})}),t.jsxs(he,{children:[t.jsx(V,{value:"translation",children:t.jsxs("div",{className:"flex flex-col items-start",children:[t.jsx("span",{className:"font-medium",children:"Translation"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"Translate to another language"})]})}),t.jsx(V,{value:"definition",children:t.jsxs("div",{className:"flex flex-col items-start",children:[t.jsx("span",{className:"font-medium",children:"Dictionary Definition"}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"Define in the same language"})]})})]})]}),t.jsx("p",{className:"text-xs text-muted-foreground leading-tight",children:j==="translation"?"Translate text from one language to another":"Provide dictionary definitions in the same language"})]}),t.jsxs("div",{className:"auto-translate-setting space-y-1",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(U,{htmlFor:"auto-translate",className:"text-sm font-semibold",children:"Auto-Process"}),t.jsx(pe,{id:"auto-translate",checked:T,onCheckedChange:q})]}),t.jsx("p",{className:"text-xs text-muted-foreground leading-tight",children:j==="translation"?"Automatically translate new entries":"Automatically define new entries"})]})]})}),t.jsx(v,{variant:"ghost",size:"sm",onClick:_,title:"Rename list",className:"rename-list-button h-8 w-8 p-0",children:t.jsx(Ie,{className:"w-4 h-4"})}),t.jsx(v,{variant:"ghost",size:"sm",onClick:H,title:"Delete list",className:"delete-list-button h-8 w-8 p-0 text-destructive hover:text-destructive",children:t.jsx(Pe,{className:"w-4 h-4"})})]})]}),t.jsx("div",{className:"header-content flex items-center justify-between",children:t.jsxs("div",{className:"header-actions flex items-center gap-2",children:[t.jsxs(v,{variant:"outline",size:"sm",onClick:X,disabled:g.length===0,className:"download-vocabulary-button",title:"Download vocabulary as JSON",children:[t.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Export"]}),t.jsxs(v,{variant:"outline",size:"sm",onClick:()=>{var e;return(e=document.getElementById("import-vocabulary-input"))==null?void 0:e.click()},className:"import-vocabulary-button",title:"Import vocabulary from JSON",children:[t.jsx(Re,{className:"w-4 h-4 mr-2"}),"Import"]}),t.jsx("input",{id:"import-vocabulary-input",type:"file",accept:".json",onChange:Q,style:{display:"none"}}),w.selection.selectedRows.size>0&&t.jsxs(v,{variant:"destructive",onClick:Z,size:"sm",children:["Delete Selected (",w.selection.selectedRows.size,")"]})]})})]}),t.jsx(ge,{className:"flex-1 flex flex-col p-4 min-h-0",children:t.jsx(ie,{table:w,searchPlaceholder:"Search vocabulary...",pageSizeOptions:[10,20,50],emptyMessage:"No vocabulary entries yet. Start recording to add words!",className:"flex-1 flex flex-col min-h-0"})})]})})]})}export{Ge as VocabularyPage};
