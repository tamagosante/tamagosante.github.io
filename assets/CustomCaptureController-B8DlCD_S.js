var ya=Object.defineProperty;var Sa=(g,t,a)=>t in g?ya(g,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):g[t]=a;var Q=(g,t,a)=>Sa(g,typeof t!="symbol"?t+"":t,a);import{r as d,j as s}from"./react-vendor-Byz07MLO.js";import{N as Ke,aE as De,b_ as Ca,ay as ts,S as Je,h as Ve,j as Xe,k as ce,ac as Oe,L as Le,I as Ye,a as ae,i as ss,aQ as ja,b$ as Na,bb as va,aY as Fa,aZ as wa,a_ as ka}from"./index-CJ-Awmlc.js";import{t as D}from"./utils-DjFvUtuq.js";import{D as as}from"./DraggableCrudTree-C1-qpnFJ.js";import{a4 as Aa,W as Ea,a2 as vt,_ as Ia,O as Ft,g as wt,X as Be,bs as rs,b2 as Ta,bt as Kt,at as kt,C as ct,E as Pa,af as ns,z as Yt,$ as At,bu as ls,aa as Et,R as It,bv as Zt,ag as is,T as cs,aM as $a,bw as Da,bx as Ma,i as La,ab as Ra,U as Tt,as as Oa,bh as Ba,ap as _a,e as Qt,by as za,bz as qa,bA as Ua,aj as Wa,S as Ja,q as Va,D as Xa}from"./icons-Detj0uxE.js";class Ga{generate(t,a){if(t.id&&this.isStableId(t.id)){const o=`#${CSS.escape(t.id)}`;if(this.validate(o,t,a))return o}for(const o of["data-test","data-testid","data-id","data-cy"]){const u=t.getAttribute(o);if(u){const m=`[${o}="${CSS.escape(u)}"]`;if(this.validate(m,t,a))return m}}const e=t.getAttribute("aria-label");if(e){const o=`[aria-label="${CSS.escape(e)}"]`;if(this.validate(o,t,a))return o}const r=this.generateSemanticSelector(t,a);if(r)return r;const l=this.generateClassSelector(t,a);if(l&&this.validate(l,t,a))return l;const n=this.generateTextSelector(t,a);return n||this.generatePathSelector(t,a)}generateItemSelector(t,a){if(t.length===0)return null;const e=t[0],r=this.findCommonClasses(t);if(r.length>0){const n=`.${CSS.escape(r[0])}`;if(a.querySelectorAll(`:scope > ${n}`).length===t.length)return n}const l=e.tagName.toLowerCase();if(t.every(n=>n.tagName.toLowerCase()===l)){const n=l;if(a.querySelectorAll(`:scope > ${n}`).length===t.length)return n}return":scope > *"}validate(t,a,e){try{const l=(e||document).querySelectorAll(t);return l.length===1&&l[0]===a}catch{return!1}}isStableId(t){return![/^[a-f0-9]{8,}$/i,/^\d+$/,/^:r\d+:$/,/_\d{10,}/,/[a-z]+\d{5,}/i].some(e=>e.test(t))}generateClassSelector(t,a){const e=this.getStableClasses(t);if(e.length===0)return null;for(const l of e){const n=`.${CSS.escape(l)}`;if(this.validate(n,t,a))return n}const r=t.tagName.toLowerCase();for(const l of e){const n=`${r}.${CSS.escape(l)}`;if(this.validate(n,t,a))return n}if(e.length>=2)for(let l=0;l<e.length-1;l++)for(let n=l+1;n<e.length;n++){const o=`.${CSS.escape(e[l])}.${CSS.escape(e[n])}`;if(this.validate(o,t,a))return o}return null}generateSemanticSelector(t,a){var l;const e=t.tagName.toLowerCase(),r=["href","name","alt","type","role","src","for","action"];for(const n of r){const o=t.getAttribute(n);if(o)if((n==="src"||n==="href")&&o.includes("/")){const u=(l=o.split("/").pop())==null?void 0:l.split("?")[0];if(u){const m=`${e}[${n}*="${CSS.escape(u)}"]`;if(this.validate(m,t,a))return m}}else{const u=`${e}[${n}="${CSS.escape(o)}"]`;if(this.validate(u,t,a))return u}}return null}generateTextSelector(t,a){const e=Array.from(t.childNodes).filter(r=>r.nodeType===Node.TEXT_NODE).map(r=>{var l;return(l=r.textContent)==null?void 0:l.trim()}).filter(Boolean).join(" ").trim();if(e&&e.length>=2&&e.length<=50){const r=t.tagName.toLowerCase(),l=this.getStableClasses(t);if(l.length>0){const n=`${r}.${CSS.escape(l[0])}`;if(this.validate(n,t,a))return n}}return null}generatePathSelector(t,a){const e=[];let r=t;const l=a||document.documentElement,n=15;for(;r&&r!==l&&r!==document.body;){const m=r.parentElement;if(!m)break;const h=Array.from(m.children).indexOf(r)+1,c=r.tagName.toLowerCase();if(e.unshift(`${c}:nth-child(${h})`),r=m,e.length>=2){const x=e.join(" > ");if(this.validate(x,t,a))return x}if(e.length>=n)break}const o=e.join(" > ");if(!this.validate(o,t,a)){const m=this.getStableClasses(t);for(const f of m){const h=e[0],c=/^([a-z]+):nth-child\((\d+)\)$/.exec(h);if(c){const[,x,C]=c,w=[...e];w[0]=`${x}.${CSS.escape(f)}:nth-child(${C})`;const j=w.join(" > ");if(this.validate(j,t,a))return j}}for(const f of m){const h=/^([a-z]+):nth-child\(\d+\)$/.exec(e[0]);if(h){const[,c]=h,x=[...e];x[0]=`${c}.${CSS.escape(f)}`;const C=x.join(" > ");if(this.validate(C,t,a))return C}}}return a&&r===l&&e.length>0?`:scope > ${o}`:o}getStableClasses(t){return Array.from(t.classList).filter(e=>!(e.length===0||[/^[a-z]{1,2}\d{3,}$/i,/^_[a-f0-9]+$/i,/^\d/,/[a-f0-9]{8,}/i,/__[a-z]+_[a-z0-9]+$/i,/\[.+\]/].some(l=>l.test(e))||/["'\\]/.test(e)))}findCommonClasses(t){return t.length===0?[]:this.getStableClasses(t[0]).filter(e=>t.every(r=>r.classList.contains(e)))}}const Me=new Ga;class Ka{constructor(){Q(this,"MIN_PATTERN_ITEMS",2);Q(this,"MAX_SAMPLE_ITEMS",5)}detectPattern(t){const a=Array.from(t.children);if(a.length<this.MIN_PATTERN_ITEMS)return null;const e=this.groupByStructure(a),r=Array.from(e.entries()).sort((f,h)=>h[1].length-f[1].length);if(r.length===0)return null;const[l,n]=r[0];if(n.length<this.MIN_PATTERN_ITEMS)return null;const o=Me.generate(t),u=Me.generateItemSelector(n,t);if(!u)return null;const m=n.slice(0,this.MAX_SAMPLE_ITEMS).map(f=>this.extractTextPreview(f));return{containerElement:t,containerSelector:o,itemElements:n,itemSelector:u,itemCount:n.length,sampleItems:m}}getStructureSignature(t){const a=t.tagName.toLowerCase(),e=this.getNormalizedClassSignature(t),r=t.children.length;return{tagName:a,classSignature:e,childCount:r}}haveSimilarStructure(t,a){const e=this.getStructureSignature(t),r=this.getStructureSignature(a);return e.tagName===r.tagName&&e.classSignature===r.classSignature}extractArrayData(t){return t.itemElements.map(a=>a.innerText.trim())}groupByStructure(t){const a=new Map;for(const e of t){const r=this.getStructureSignature(e),l=this.signatureToKey(r),n=a.get(l)||[];n.push(e),a.set(l,n)}return a}signatureToKey(t){return`${t.tagName}|${t.classSignature}|${t.childCount}`}getNormalizedClassSignature(t){return Array.from(t.classList).filter(r=>!this.isDynamicClass(r)).sort().join(" ")}isDynamicClass(t){return[/^[a-z]{1,3}\d{3,}$/i,/^_[a-f0-9]+$/i,/^\d/,/[a-f0-9]{8,}/i,/__[a-z]+_[a-z0-9]+$/i,/^css-/,/^sc-/,/^chakra-/,/^MuiBox-/].some(e=>e.test(t))}extractTextPreview(t,a=100){const e=t.innerText.trim();return e.length<=a?e:e.slice(0,a)+"..."}}const Ht=new Ka,rt={child:.4,ratio:.3,depth:.2,selector:.1},nt={childCap:10,depthPenalty:0,classBonus:20,idBonus:10},Ya={strict:{minChildren:10,sameTag:!0,maxDepth:15,limit:20},balanced:{minChildren:5,sameTag:!0,maxDepth:20,limit:20},deep:{minChildren:5,sameTag:!0,maxDepth:30,limit:20},relaxed:{minChildren:3,sameTag:!1,maxDepth:20,limit:20},"grid-finder":{minChildren:8,sameTag:!0,maxDepth:25,limit:20}};class Za{calculateScore(t,a=rt,e=nt){const{childCount:r,sameTagRatio:l,depth:n,hasClass:o,hasId:u}=t,{childCap:m,depthPenalty:f,classBonus:h,idBonus:c}=e,x=Math.min(r/m,1)*100,C=l,w=Math.max(0,100-n*f),j=h+c;let k=0;o&&(k+=h),u&&(k+=c),k=k/j*100;const F=a.child*x+a.ratio*C+a.depth*w+a.selector*k;return Math.round(F)}analyzeContainer(t,a,e={},r=rt,l=nt){const{minChildren:n=5,sameTag:o=!0}=e,u=Array.from(t.children);if(u.length<n)return null;const m={};for(const S of u){const L=S.tagName;m[L]=(m[L]||0)+1}const h=Object.entries(m).sort((S,L)=>L[1]-S[1])[0],c=h?h[1]/u.length*100:0;if(!(!o||c>=80))return null;const C=Me.generate(t),w=!!t.className,j=!!t.id,k={element:t,selector:C,childCount:u.length,dominantTag:h?h[0].toLowerCase():null,dominantTagCount:h?h[1]:0,sameTagRatio:Math.round(c),depth:a,hasClass:w,hasId:j},F=this.calculateScore(k,r,l);return{...k,score:F}}findBestContainerAncestor(t,a={},e=rt,r=nt){const{maxDepth:l=20,limit:n=10}=a,o=[];let u=t.parentElement,m=this.getElementDepth(t)-1;for(;u&&m>=0&&o.length<l&&!(u.tagName==="BODY"||u.tagName==="HTML");){const f=this.analyzeContainer(u,m,a,e,r);f&&o.push(f),u=u.parentElement,m--}return o.sort((f,h)=>h.score-f.score),o.slice(0,n)}scanPageContainers(t={},a=rt,e=nt){const{maxDepth:r=20,limit:l=20,bottomUp:n=!1}=t,o=n?this.findContainersBottomUp(document.body,t,a,e):this.findContainersTopDown(document.body,0,r,t,a,e);return o.sort((u,m)=>m.score-u.score),o.slice(0,l)}scanWithPreset(t){const a=Ya[t];return this.scanPageContainers(a)}findSiblings(t,a=5){const e=[],r=t.tagName.toLowerCase();let l=t.parentElement,n=0;for(;l&&n<a;){const o=l.tagName.toLowerCase();if(o==="body"||o==="html")break;const u=Me.generate(l),m=l.querySelectorAll(`:scope > ${r}`);m.length>1&&e.push({containerSelector:u,itemSelector:r,matchCount:m.length,score:this.calculateSiblingScore(m.length,n,!0)});const f=l.querySelectorAll(r);f.length>m.length&&f.length>1&&e.push({containerSelector:u,itemSelector:r,matchCount:f.length,score:this.calculateSiblingScore(f.length,n,!1)}),l=l.parentElement,n++}return e.sort((o,u)=>u.score-o.score),e}findFromElement(t,a="both"){const e=[],r=[];if(a==="container"||a==="both"){const o=this.findBestContainerAncestor(t,{minChildren:3,sameTag:!1,maxDepth:10,limit:10});e.push(...o)}if(a==="sibling"||a==="both"){const o=this.findSiblings(t);for(const u of o)try{const m=document.querySelector(u.containerSelector);if(m&&!e.some(f=>f.element===m)){const f=this.analyzeContainer(m,this.getElementDepth(m),{minChildren:2,sameTag:!1});f&&(f.score=Math.min(100,f.score+Math.min(u.matchCount*2,20)),r.push(f))}}catch{}}const l=new Set,n=[];for(const o of[...e,...r])l.has(o.element)||(l.add(o.element),n.push(o));return n.sort((o,u)=>u.score-o.score),n.slice(0,15)}calculateSiblingScore(t,a,e){const r=Math.min(t,20)*3,l=(5-a)*10,n=e?15:0;return r+l+n}findContainersTopDown(t,a,e,r,l,n){const o=[];if(a>e)return o;const u=this.analyzeContainer(t,a,r,l,n);u&&o.push(u);const m=Array.from(t.children);for(const f of m){const h=this.findContainersTopDown(f,a+1,e,r,l,n);o.push(...h)}return o}findContainersBottomUp(t,a,e,r){const{maxDepth:l=20}=a,n=new Set,o=[],u=[],m=(f,h)=>{u.push({el:f,depth:h});const c=Array.from(f.children);for(const x of c)m(x,h+1)};m(t,0),u.sort((f,h)=>h.depth-f.depth);for(const{el:f,depth:h}of u){if(h>l)continue;const c=f.parentElement;if(!c||c.tagName==="BODY"||c.tagName==="HTML"||n.has(c))continue;const x=h-1;if(x<0)continue;const C=this.analyzeContainer(c,x,a,e,r);C&&(n.add(c),o.push(C))}return o}getElementDepth(t){let a=0,e=t;for(;e&&e!==document.documentElement;)a++,e=e.parentElement;return a}}const lt=new Za;class Pt{static getExtensionURL(t){var a,e;return typeof chrome<"u"&&((a=chrome.runtime)!=null&&a.getURL)?chrome.runtime.getURL(t):typeof browser<"u"&&((e=browser.runtime)!=null&&e.getURL)?browser.runtime.getURL(t):null}static async getConfigForDomain(t){const a=this.normalizeDomain(t);if(this.cache.has(a))return this.cache.get(a)??null;try{let e=this.getExtensionURL(`site-configs/${a}.json`);e||(e=`/site-configs/${a}.json`);const r=await fetch(e);if(!r.ok)return this.cache.set(a,null),null;const l=await r.json();return this.cache.set(a,l),l}catch{return this.cache.set(a,null),null}}static clearCache(){this.cache.clear()}static normalizeDomain(t){return t.replace(/^www\./,"").toLowerCase()}}Q(Pt,"cache",new Map);class Qa{constructor(){Q(this,"schema");Q(this,"capturedData",{});Q(this,"listeners",new Set);this.schema=this.createEmptySchema()}onChange(t){return this.listeners.add(t),()=>{this.listeners.delete(t)}}notifyListeners(){this.listeners.forEach(t=>t({phase:"capturing",mode:"mapped",schema:this.schema,selectedFieldId:null,capturedData:this.capturedData,inspectorActive:!1}))}createEmptySchema(t="Untitled Schema"){return{id:Ke(10),name:t,fields:[],createdAt:Date.now(),updatedAt:Date.now()}}extractTextWithExclusions(t,a){if(!a||a.length===0)return t.innerText.trim();const e=t.cloneNode(!0);for(const r of a)e.querySelectorAll(r).forEach(n=>n.remove());return e.innerText.trim()}getSchema(){return{...this.schema,fields:[...this.schema.fields]}}getState(){return{schema:this.getSchema(),capturedData:{...this.capturedData}}}setSchemaName(t){this.schema.name=t,this.schema.updatedAt=Date.now(),this.notifyListeners()}getNextOrder(t){const a=this.schema.fields.filter(e=>e.parentId===t);return a.length>0?Math.max(...a.map(e=>e.order))+1:0}calculatePath(t,a){if(!a)return t;const e=this.schema.fields.find(r=>r.id===a);return e?e.type==="array"?`${e.path}[].${t}`:e.type==="parentSelector"?`${e.path}.${t}`:`${e.path}.${t}`:t}addField(t,a,e=null){const r={id:Ke(10),name:t,path:this.calculatePath(t,e),type:a,parentId:e,order:this.getNextOrder(e)};return this.schema.fields.push(r),this.schema.updatedAt=Date.now(),this.notifyListeners(),r}updateField(t,a){const e=this.schema.fields.find(r=>r.id===t);e&&(a.name&&a.name!==e.name&&(e.name=a.name,e.path=this.calculatePath(e.name,e.parentId),this.updateDescendantPaths(e.id)),a.type&&(e.type=a.type),"mapping"in a&&(e.mapping=a.mapping),"containerSelector"in a&&(e.containerSelector=a.containerSelector),"itemSelector"in a&&(e.itemSelector=a.itemSelector),"containerSelectorFilters"in a&&(e.containerSelectorFilters=a.containerSelectorFilters),"itemSelectorFilters"in a&&(e.itemSelectorFilters=a.itemSelectorFilters),this.schema.updatedAt=Date.now(),this.notifyListeners())}updateDescendantPaths(t){const a=this.schema.fields.filter(e=>e.parentId===t);for(const e of a)e.path=this.calculatePath(e.name,e.parentId),this.updateDescendantPaths(e.id)}removeField(t){const a=new Set,e=r=>{a.add(r),this.schema.fields.filter(l=>l.parentId===r).forEach(l=>e(l.id))};e(t),this.schema.fields=this.schema.fields.filter(r=>!a.has(r.id)),this.schema.updatedAt=Date.now(),Array.from(a).forEach(r=>{const l=this.schema.fields.find(n=>n.id===r);l&&this.deleteNestedValue(this.capturedData,l.path)}),this.notifyListeners()}reorderFields(t,a){t.forEach((e,r)=>{const l=this.schema.fields.find(n=>n.id===e);(l==null?void 0:l.parentId)===a&&(l.order=r)}),this.schema.updatedAt=Date.now(),this.notifyListeners()}mapElementToField(t,a){var u;const e=this.schema.fields.find(m=>m.id===t);if(!e)return;const r=this.findContextForElement(e,a);let l=Me.generate(a,r);const n=a.innerText.trim(),o=this.findParentArrayInfo(e,a);if(o&&r){const{items:m,clickedItemIndex:f}=o;if(m[f]&&m.length>1){let c=!0;for(let x=0;x<m.length;x++){if(x===f)continue;if(m[x].querySelectorAll(l).length===0){c=!1;break}}if(!c){const x=this.findRobustSelectorForArrayChild(a,m,f);x&&(l=x)}}}e.mapping={selector:l,sampleValue:n,selectorFilters:(u=e.mapping)==null?void 0:u.selectorFilters},e.type==="array"&&!e.containerSelector&&(e.containerSelector=l),this.setNestedValue(this.capturedData,e.path,n),this.schema.updatedAt=Date.now(),this.notifyListeners()}findParentArrayInfo(t,a){if(!t.parentId)return null;let e=t.parentId;for(;e;){const r=this.schema.fields.find(l=>l.id===e);if(!r)break;if(r.type==="array"&&r.itemSelector&&r.containerSelector){const l=document.querySelector(r.containerSelector);if(l){const n=Array.from(l.querySelectorAll(r.itemSelector));let o=0;if(a){for(let u=0;u<n.length;u++)if(n[u].contains(a)){o=u;break}}return{items:n,clickedItemIndex:o}}}e=r.parentId}return null}findRobustSelectorForArrayChild(t,a,e){const r=a[e],l=this.getPathFromAncestor(t,r);if(l.length===0)return null;const n=Me.getStableClasses(t);for(const h of n){const c=`.${CSS.escape(h)}`;let x=!0;for(let C=0;C<a.length;C++)if(a[C].querySelectorAll(c).length===0){x=!1;break}if(x)return c}const o=t.tagName.toLowerCase();for(const h of n){const c=`${o}.${CSS.escape(h)}`;let x=!0;for(let C=0;C<a.length;C++)if(a[C].querySelectorAll(c).length===0){x=!1;break}if(x)return c}const m=`:scope ${l.map(h=>h.tagName.toLowerCase()).join(" > ")}`;let f=!0;for(let h=0;h<a.length;h++){const c=a[h];try{if(c.querySelectorAll(m).length===0){f=!1;break}}catch{f=!1;break}}return f?m:null}getPathFromAncestor(t,a){const e=[];let r=t;for(;r&&r!==a;)e.unshift(r),r=r.parentElement;return e}findContextForField(t){if(t.parentId)return this.findContextForFieldRecursive(t.parentId,document)}findContextForFieldRecursive(t,a){if(!t)return;const e=this.schema.fields.find(r=>r.id===t);if(e){if(e.type==="array"&&e.itemSelector&&e.containerSelector){const l=(e.parentId&&this.findContextForFieldRecursive(e.parentId,a)||document).querySelector(e.containerSelector);if(l){const n=l.querySelector(e.itemSelector);if(n)return n}return}else if(e.type==="parentSelector"&&e.containerSelector){const l=(e.parentId&&this.findContextForFieldRecursive(e.parentId,a)||document).querySelector(e.containerSelector);return l||void 0}return this.findContextForFieldRecursive(e.parentId,a)}}findContextForElement(t,a){if(!t.parentId)return;let e=t.parentId;for(;e;){const r=this.schema.fields.find(l=>l.id===e);if(!r)break;if(r.type==="array"&&r.itemSelector&&r.containerSelector){const l=document.querySelector(r.containerSelector);if(l){const n=l.querySelectorAll(r.itemSelector);for(let u=0;u<n.length;u++){const m=n[u];if(m.contains(a))return m}const o=l.querySelector(r.itemSelector);if(o)return o}}else if(r.type==="parentSelector"&&r.containerSelector){const l=document.querySelector(r.containerSelector);if(l)return l}e=r.parentId}}unmapField(t){const a=this.schema.fields.find(e=>e.id===t);a&&(a.mapping=void 0,this.deleteNestedValue(this.capturedData,a.path),this.schema.updatedAt=Date.now(),this.notifyListeners())}detectArrayPattern(t){return Ht.detectPattern(t)}findContainerAncestors(t,a){return lt.findBestContainerAncestor(t,a)}scanPageContainers(t){return lt.scanPageContainers(t)}scanContainersWithPreset(t){return lt.scanWithPreset(t)}findContainersFromElement(t,a="both"){return lt.findFromElement(t,a)}confirmArrayPattern(t,a){const e=this.schema.fields.find(l=>l.id===a);if(!e)return;e.type="array",e.containerSelector=t.containerSelector,e.itemSelector=t.itemSelector,e.mapping={selector:t.containerSelector,sampleValue:`[${t.itemCount} items]`};const r=Ht.extractArrayData(t);this.setNestedValue(this.capturedData,e.path,r),this.schema.updatedAt=Date.now(),this.notifyListeners()}extractSelectors(){const t={},a=this.schema.fields.filter(e=>e.parentId===null);for(const e of a){const r=this.extractFieldSelector(e);t[e.name]=r}return t}extractFieldSelector(t){var e,r,l,n,o,u,m;if(t.type==="array"){const f=this.schema.fields.filter(x=>x.parentId===t.id),h=!!(t.containerSelector||(e=t.containerSelectorFilters)!=null&&e.length),c=!!(t.itemSelector||(r=t.itemSelectorFilters)!=null&&r.length);if(h&&c||f.length>0){const x={},C=((l=t.containerSelectorFilters)==null?void 0:l.join(""))??"";x._container=t.containerSelector?t.containerSelector+C:C||null;const w=((n=t.itemSelectorFilters)==null?void 0:n.join(""))??"";x._item=t.itemSelector?t.itemSelector+w:w||null;for(const j of f)x[j.name]=this.extractFieldSelector(j);return x}return null}else if(t.type==="parentSelector"){const f=this.schema.fields.filter(c=>c.parentId===t.id);if(!!(t.containerSelector||(o=t.containerSelectorFilters)!=null&&o.length)||f.length>0){const c={},x=((u=t.containerSelectorFilters)==null?void 0:u.join(""))??"";c._container=t.containerSelector?t.containerSelector+x:x||null;for(const C of f)c[C.name]=this.extractFieldSelector(C);return c}return null}else if(t.mapping){const f=((m=t.mapping.selectorFilters)==null?void 0:m.join(""))??"";return!t.mapping.selector&&!f?null:(t.mapping.selector??"")+f}const a=this.schema.fields.filter(f=>f.parentId===t.id);if(a.length>0){const f={};for(const h of a)f[h.name]=this.extractFieldSelector(h);return f}return null}applyCapture(){var e,r,l;const t={},a=this.schema.fields.filter(n=>n.parentId===null);for(const n of a)try{const o=!!(n.containerSelector||(e=n.containerSelectorFilters)!=null&&e.length),u=!!(n.itemSelector||(r=n.itemSelectorFilters)!=null&&r.length);if(n.type==="array"&&o&&u){const m=this.extractArrayField(n);m.length>0&&this.setNestedValue(t,n.path,m)}else if(n.type==="parentSelector"&&o){const m=this.extractParentSelectorField(n);Object.keys(m).length>0&&this.setNestedValue(t,n.path,m)}else if(n.mapping){const m=n.mapping.selector??"",f=((l=n.mapping.selectorFilters)==null?void 0:l.join(""))??"",h=m+f;if(!h)continue;const c=n.mapping.matchIndex??0,x=document.querySelectorAll(h),C=x[c]??x[0];if(C){const w=C;let j;const k=n.mapping.extractAttributes;if(k&&k.length>0)if(k.length===1)j=w.getAttribute(k[0])??"";else{const F={};for(const S of k)F[S]=w.getAttribute(S)??"";j=F}else j=this.extractTextWithExclusions(w,n.mapping.excludeChildren);this.setNestedValue(t,n.path,j)}}}catch(o){console.warn(`[CustomCapture] Failed to extract field ${n.name}:`,o)}return this.capturedData=t,t}extractArrayField(t){var x,C;const a=t.containerSelector??"",e=((x=t.containerSelectorFilters)==null?void 0:x.join(""))??"",r=a+e,l=t.itemSelector??"",n=((C=t.itemSelectorFilters)==null?void 0:C.join(""))??"",o=l+n;if(!r||!o)return[];const u=t.containerMatchIndex??0,m=document.querySelectorAll(r),f=m[u]??m[0];if(!f)return[];const h=f.querySelectorAll(o),c=this.schema.fields.filter(w=>w.parentId===t.id);return c.length===0?Array.from(h).map(w=>{var F,S;const j=w,k=(F=t.mapping)==null?void 0:F.extractAttributes;if(k&&k.length>0){if(k.length===1)return{value:j.getAttribute(k[0])??""};const L={};for(const R of k)L[R]=j.getAttribute(R)??"";return L}return{value:this.extractTextWithExclusions(j,(S=t.mapping)==null?void 0:S.excludeChildren)}}):Array.from(h).map((w,j)=>{const k=w;return this.extractNestedFields(c,k)})}selectElementsByMatchMode(t,a,e,r){const l=Array.from(t);if(l.length===0)return[];switch(a??"single"){case"first":return l.slice(0,1);case"last":return l.slice(-1);case"all":return l;case"all-but-first":return l.slice(1);case"all-but-last":return l.slice(0,-1);case"range":const o=r??e;return l.slice(e,o+1);case"single":default:const u=l[e]??l[0];return u?[u]:[]}}generateFallbackSelectors(t){const a=[],e=t.replace(/:nth-child\(\d+\)/g,"");e!==t&&a.push(e);const r=e.split(/\s*>\s*/);if(r.length>1){const l=r[r.length-1].trim();if(l&&a.push(l),r.length>2){const n=r.slice(-2).join(" > ");a.push(n)}}if(r.length>2){const l=`${r[0].trim()} ${r[r.length-1].trim()}`;a.push(l)}return a}extractElementValue(t,a,e){if(a&&a.length>0){if(a.length===1)return t.getAttribute(a[0])??"";const r={};for(const l of a)r[l]=t.getAttribute(l)??"";return r}return this.extractTextWithExclusions(t,e)}extractNestedFields(t,a){var r,l,n,o,u;const e={};for(const m of t)try{const f=this.schema.fields.filter(w=>w.parentId===m.id),h=f.length>0,c=!!(m.containerSelector||(r=m.containerSelectorFilters)!=null&&r.length),x=!!(m.itemSelector||(l=m.itemSelectorFilters)!=null&&l.length);if(m.type==="array"&&c&&x&&h){const w=m.containerSelector??"",j=((n=m.containerSelectorFilters)==null?void 0:n.join(""))??"",k=w+j,F=m.itemSelector??"",S=((o=m.itemSelectorFilters)==null?void 0:o.join(""))??"",L=F+S,R=k?a.querySelector(k):a;if(R){const q=R.querySelectorAll(L);q.length>0?e[m.name]=Array.from(q).map(H=>{const Z=H;return this.extractNestedFields(f,Z)}):e[m.name]=[]}else e[m.name]=[];continue}if(m.mapping){const w=m.mapping.selector??"",j=((u=m.mapping.selectorFilters)==null?void 0:u.join(""))??"",k=w+j;if(k){const F=m.mapping.matchMode??"single",S=m.mapping.matchIndex??0,L=m.mapping.matchIndexEnd;let R=a.querySelectorAll(k);if(R.length===0&&k.includes(":nth-child")){const H=this.generateFallbackSelectors(k);for(const Z of H)try{const W=a.querySelectorAll(Z);if(W.length>0){R=W;break}}catch{}}const q=this.selectElementsByMatchMode(R,F,S,L);if(q.length>0){const H=F!=="single"&&F!=="first"&&F!=="last";h?H&&q.length>1?e[m.name]=q.map(Z=>this.extractNestedFields(f,Z)):e[m.name]=this.extractNestedFields(f,q[0]):H&&q.length>1?e[m.name]=q.map(Z=>this.extractElementValue(Z,m.mapping.extractAttributes,m.mapping.excludeChildren)):e[m.name]=this.extractElementValue(q[0],m.mapping.extractAttributes,m.mapping.excludeChildren)}}else h&&(e[m.name]=this.extractNestedFields(f,a))}else h&&(e[m.name]=this.extractNestedFields(f,a))}catch(f){console.warn(`[CustomCapture] Failed to extract field ${m.name}:`,f)}return e}extractParentSelectorField(t){var f;const a=t.containerSelector??"",e=((f=t.containerSelectorFilters)==null?void 0:f.join(""))??"",r=a+e;if(!r)return{};const l=t.containerMatchIndex??0,n=document.querySelectorAll(r),o=n[l]??n[0];if(!o)return{};const u=this.schema.fields.filter(h=>h.parentId===t.id),m=o;return this.extractNestedFields(u,m)}extractData(){return this.applyCapture()}generateExport(){return{schemaName:this.schema.name,schemaId:this.schema.id,capturedAt:Date.now(),url:window.location.href,data:this.extractData()}}toTreeNodes(){const t=a=>this.schema.fields.filter(e=>e.parentId===a).sort((e,r)=>e.order-r.order).map(e=>({id:e.id,label:this.getFieldLabel(e),children:t(e.id),data:e}));return t(null)}getFieldLabel(t){const a=this.getTypeIcon(t.type),e=t.mapping?" ✓":"";return`${a} ${t.name}${e}`}getTypeIcon(t){switch(t){case"string":return"T";case"number":return"#";case"boolean":return"?";case"array":return"[]";case"object":return"{}";default:return"·"}}updateFromTree(t){const a=(e,r)=>{e.forEach((l,n)=>{const o=this.schema.fields.find(u=>u.id===l.id);o&&(o.parentId=r,o.order=n,o.path=this.calculatePath(o.name,r)),l.children&&a(l.children,l.id)})};a(t,null),this.schema.updatedAt=Date.now(),this.notifyListeners()}setNestedValue(t,a,e){const r=a.replace(/\[\]/g,"").split(".");let l=t;for(let n=0;n<r.length-1;n++){const o=r[n];(!(o in l)||typeof l[o]!="object")&&(l[o]={}),l=l[o]}l[r[r.length-1]]=e}deleteNestedValue(t,a){const e=a.replace(/\[\]/g,"").split(".");let r=t;for(let l=0;l<e.length-1;l++){const n=e[l];if(!(n in r))return;r=r[n]}delete r[e[e.length-1]]}getField(t){return this.schema.fields.find(a=>a.id===t)}getFieldByName(t){return this.schema.fields.find(a=>a.name===t)}getFieldElement(t,a){var o,u;const e=this.schema.fields.find(m=>m.id===t);if(!e)return null;let r,l,n=null;if(a==="container"?(r=e.containerSelector,l=e.containerSelectorFilters):a==="item"?e.containerSelector&&e.itemSelector?(n=document.querySelector(e.containerSelector),r=e.itemSelector,l=e.itemSelectorFilters):(r=e.itemSelector,l=e.itemSelectorFilters):(r=(o=e.mapping)==null?void 0:o.selector,l=(u=e.mapping)==null?void 0:u.selectorFilters,e.parentId&&(n=this.findContextForField(e)??null)),!r&&(l!=null&&l.length)&&(r=l.join("")),!r)return null;try{return n?n.querySelector(r):document.querySelector(r)}catch{return null}}getFieldElementAttributes(t,a){const e=this.getFieldElement(t,a);if(!e)return[];const r=[];for(const l of Array.from(e.attributes))r.push({name:l.name,value:l.value});return r}getFieldSelectorMatches(t,a,e=!0){var u,m,f,h,c;const r=this.schema.fields.find(x=>x.id===t);if(!r)return[];let l,n;if(a==="container")l=r.containerSelector,n=r.containerSelectorFilters;else if(a==="item")l=r.itemSelector,n=r.itemSelectorFilters;else if(l=(u=r.mapping)==null?void 0:u.selector,n=(m=r.mapping)==null?void 0:m.selectorFilters,r.parentId){let x=null,C=r.parentId;for(;C;){const w=this.schema.fields.find(j=>j.id===C);if(!w)break;if(w.containerSelector&&w.itemSelector){x=w;break}C=w.parentId??null}if(x){const w=l?l+((n==null?void 0:n.join(""))??""):(n==null?void 0:n.join(""))??"";if(!w)return[];try{const j=document.querySelector(x.containerSelector);if(!j)return[];const k=j.querySelectorAll(x.itemSelector);if(k.length===0)return[];if(e){const F=((f=r.mapping)==null?void 0:f.matchMode)??"single",S=((h=r.mapping)==null?void 0:h.matchIndex)??0,L=(c=r.mapping)==null?void 0:c.matchIndexEnd,R=[];return k.forEach(q=>{const H=q.querySelectorAll(w);this.selectElementsByMatchMode(H,F,S,L).forEach(W=>R.push(W))}),R}else{const S=k[0].querySelectorAll(w);return Array.from(S)}}catch{return[]}}}const o=l?l+((n==null?void 0:n.join(""))??""):(n==null?void 0:n.join(""))??"";if(!o)return[];try{const x=document.querySelectorAll(o);return Array.from(x)}catch{return[]}}getFieldSelectorMatchCount(t,a){return this.getFieldSelectorMatches(t,a).length}setFieldMatchIndex(t,a,e){const r=this.schema.fields.find(l=>l.id===t);r&&(e==="container"?r.containerMatchIndex=a:e==="item"?r.itemMatchIndex=a:r.mapping&&(r.mapping.matchIndex=a),this.schema.updatedAt=Date.now(),this.notifyListeners())}setFieldMatchMode(t,a,e,r){const l=this.schema.fields.find(n=>n.id===t);l!=null&&l.mapping&&(l.mapping.matchMode=a,e!==void 0&&(l.mapping.matchIndex=e),r!==void 0&&(l.mapping.matchIndexEnd=r),(a==="first"||a==="all")&&(l.mapping.matchIndex=0,l.mapping.matchIndexEnd=void 0),this.schema.updatedAt=Date.now(),this.notifyListeners())}setFieldExtractAttributes(t,a){const e=this.schema.fields.find(r=>r.id===t);e!=null&&e.mapping&&(e.mapping.extractAttributes=a.filter(r=>r!=="innerText"),this.schema.updatedAt=Date.now(),this.notifyListeners())}getFieldDomContext(t){var e;const a=this.schema.fields.find(r=>r.id===t);if(!((e=a==null?void 0:a.mapping)!=null&&e.selector))return null;try{let r=null;const l=a.mapping.selector;if(l.startsWith(":scope")&&a.parentId){const h=this.findContextForField(a);h&&(r=h.querySelector(l))}else r=document.querySelector(l);if(!(r!=null&&r.parentElement))return null;const n=r.parentElement,o=Array.from(n.children),u=o.indexOf(r),m=this.buildDomNodeInfo(n,!1,"parent"),f=o.map((h,c)=>{const x=h===r,C=this.buildDomNodeInfo(h,x,`sibling-${c}`);if(x){const w=Array.from(h.children);w.length>0&&(C.children=w.map((j,k)=>this.buildDomNodeInfo(j,!1,`child-${k}`)))}return C});return{parent:m,siblings:f,capturedIndex:u}}catch(r){return console.warn(`[CustomCapture] Failed to get DOM context for field ${a.name}:`,r),null}}getFieldDomContextBySelector(t){if(!t)return null;console.log("[scope-debug] getFieldDomContextBySelector:",{selector:t,hasScope:t.startsWith(":scope")});try{if(t.startsWith(":scope"))return console.warn("[scope-debug] Cannot query :scope selector from document - need context element"),null;const a=document.querySelector(t);if(!(a!=null&&a.parentElement))return null;const e=a.parentElement,r=Array.from(e.children),l=r.indexOf(a),n=this.buildDomNodeInfo(e,!1,"parent"),o=r.map((u,m)=>{const f=u===a,h=this.buildDomNodeInfo(u,f,`sibling-${m}`);if(f){const c=Array.from(u.children);c.length>0&&(h.children=c.map((x,C)=>this.buildDomNodeInfo(x,!1,`child-${C}`)))}return h});return{parent:n,siblings:o,capturedIndex:l}}catch(a){return console.warn(`[CustomCapture] Failed to get DOM context for selector ${t}:`,a),null}}buildDomNodeInfo(t,a,e){var o;const r=((o=t.innerText)==null?void 0:o.trim())||"",l=r.length>30?r.slice(0,30)+"...":r;let n;try{n=Me.generate(t)}catch{}return{tagName:t.tagName.toLowerCase(),id:t.id||void 0,classes:Array.from(t.classList),generatedSelector:n,textPreview:l||void 0,isCaptured:a,key:e}}remapFieldToParent(t,a){var l,n;const e=this.schema.fields.find(o=>o.id===t);let r;if(a==="container"?r=(e==null?void 0:e.containerSelector)??void 0:a==="item"?e!=null&&e.containerSelector&&(e!=null&&e.itemSelector)?r=`${e.containerSelector} ${e.itemSelector}`:r=(e==null?void 0:e.itemSelector)??void 0:r=(l=e==null?void 0:e.mapping)==null?void 0:l.selector,!e||!r)return null;try{const o=document.querySelector(r);if(!(o!=null&&o.parentElement))return null;const u=o.parentElement,m=e.mapping?{...e.mapping}:{selector:r,sampleValue:""},f=a==="item"&&e.containerSelector?document.querySelector(e.containerSelector):void 0,h=Me.generate(u,f??void 0),c=u.innerText.trim();a==="container"?e.containerSelector=h:a==="item"?e.itemSelector=h:(e.mapping={selector:h,sampleValue:c,extractAttributes:m.extractAttributes},(e.type==="array"||e.type==="parentSelector")&&(e.containerSelector=h));const x=(n=e.mapping)==null?void 0:n.extractAttributes;if(x&&x.length>0)if(x.length===1){const C=u.getAttribute(x[0])??"";this.setNestedValue(this.capturedData,e.path,C)}else{const C={};for(const w of x)C[w]=u.getAttribute(w)??"";this.setNestedValue(this.capturedData,e.path,C)}else this.setNestedValue(this.capturedData,e.path,c);return this.schema.updatedAt=Date.now(),this.notifyListeners(),m}catch(o){return console.warn(`[CustomCapture] Failed to remap field ${e.name} to parent:`,o),null}}remapFieldToSibling(t,a,e){var n,o;const r=this.schema.fields.find(u=>u.id===t);let l;if(e==="container"?l=(r==null?void 0:r.containerSelector)??void 0:e==="item"?r!=null&&r.containerSelector&&(r!=null&&r.itemSelector)?l=`${r.containerSelector} ${r.itemSelector}`:l=(r==null?void 0:r.itemSelector)??void 0:l=(n=r==null?void 0:r.mapping)==null?void 0:n.selector,!r||!l)return null;try{const u=document.querySelector(l);if(!(u!=null&&u.parentElement))return null;const m=u.parentElement,h=Array.from(m.children)[a];if(!h)return null;const c=r.mapping?{...r.mapping}:{selector:l,sampleValue:""},x=e==="item"&&r.containerSelector?document.querySelector(r.containerSelector):void 0,C=Me.generate(h,x??void 0),w=h.innerText.trim();e==="container"?r.containerSelector=C:e==="item"?r.itemSelector=C:(r.mapping={selector:C,sampleValue:w,extractAttributes:c.extractAttributes},(r.type==="array"||r.type==="parentSelector")&&(r.containerSelector=C));const j=(o=r.mapping)==null?void 0:o.extractAttributes;if(j&&j.length>0)if(j.length===1){const k=h.getAttribute(j[0])??"";this.setNestedValue(this.capturedData,r.path,k)}else{const k={};for(const F of j)k[F]=h.getAttribute(F)??"";this.setNestedValue(this.capturedData,r.path,k)}else this.setNestedValue(this.capturedData,r.path,w);return this.schema.updatedAt=Date.now(),this.notifyListeners(),c}catch(u){return console.warn(`[CustomCapture] Failed to remap field ${r.name} to sibling:`,u),null}}restoreFieldMapping(t,a){const e=this.schema.fields.find(r=>r.id===t);if(e){e.mapping={...a};try{let r=null;const l=a.selector;if(l.startsWith(":scope")&&e.parentId){const n=this.findContextForField(e);n&&(r=n.querySelector(l))}else r=document.querySelector(l);if(r){const n=r,o=a.extractAttributes;if(o&&o.length>0)if(o.length===1){const u=n.getAttribute(o[0])??"";this.setNestedValue(this.capturedData,e.path,u)}else{const u={};for(const m of o)u[m]=n.getAttribute(m)??"";this.setNestedValue(this.capturedData,e.path,u)}else this.setNestedValue(this.capturedData,e.path,n.innerText.trim())}}catch(r){console.warn(`[CustomCapture] Failed to restore data for field ${e.name}:`,r)}this.schema.updatedAt=Date.now(),this.notifyListeners()}}clear(){this.schema=this.createEmptySchema(),this.capturedData={},this.notifyListeners()}reset(t){this.schema=this.createEmptySchema(t),this.capturedData={},this.notifyListeners()}importSchema(t){try{return t.fields&&Array.isArray(t.fields)?this.importFullSchema(t):this.importSelectorsFormat(t)}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}importFullSchema(t){const a=t.name||"Imported Schema",e=t.fields;if(!Array.isArray(e))return{success:!1,error:"Fields must be an array"};this.schema=this.createEmptySchema(a);for(const r of e){const l={id:r.id||Ke(10),name:r.name,path:r.path||r.name,type:r.type||"string",parentId:r.parentId||null,order:r.order??this.schema.fields.length,containerSelector:r.containerSelector,itemSelector:r.itemSelector,containerSelectorFilters:r.containerSelectorFilters,itemSelectorFilters:r.itemSelectorFilters,containerMatchIndex:r.containerMatchIndex,itemMatchIndex:r.itemMatchIndex,mapping:r.mapping};this.schema.fields.push(l)}return this.schema.updatedAt=Date.now(),this.capturedData={},this.notifyListeners(),{success:!0}}importSelectorsFormat(t){this.schema=this.createEmptySchema("Imported Schema");let a=0;for(const[e,r]of Object.entries(t))this.importField(e,r,null,e,a++);return this.schema.updatedAt=Date.now(),this.capturedData={},this.notifyListeners(),{success:!0}}importField(t,a,e,r,l){if(typeof a=="string"){let n=a,o;const u=a.lastIndexOf("@");u>0&&(n=a.slice(0,u),o=[a.slice(u+1)]);const m={id:Ke(10),name:t,path:r,type:"string",parentId:e,order:l,mapping:{selector:n,extractAttributes:o}};this.schema.fields.push(m)}else if(a==null){const n={id:Ke(10),name:t,path:r,type:"string",parentId:e,order:l,mapping:{selector:""}};this.schema.fields.push(n)}else if(typeof a=="object"){const n=a,o="_item"in n,u=o?"array":"parentSelector",m=typeof n._container=="string"?n._container:void 0,f=o&&typeof n._item=="string"?n._item:void 0,h={id:Ke(10),name:t,path:r,type:u,parentId:e,order:l,containerSelector:m,itemSelector:f,mapping:m?{selector:m}:void 0};this.schema.fields.push(h);let c=0;for(const[x,C]of Object.entries(n)){if(x.startsWith("_"))continue;const w=u==="array"?`${r}[].${x}`:`${r}.${x}`;this.importField(x,C,h.id,w,c++)}}}async loadFromSiteConfig(){try{const t=window.location.hostname,a=await Pt.getConfigForDomain(t);if(!a)return{success:!1,error:`No site config found for ${t}`};if(!a.customCapture)return{success:!1,error:`Site config for ${a.name} has no customCapture section`};const e=this.importSchema(a.customCapture);return e.success?{success:!0,siteName:a.name}:e}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}}class Ha{constructor(t){this.adapter=t}extract(t){const a=[];return this.processElement(t,a),a}processElement(t,a){const e=this.adapter.getTagName(t);if(this.isHeading(e)){a.push({type:"heading",level:this.getHeadingLevel(e),text:this.adapter.getAllText(t).trim()});return}if(e==="p"){const r=this.adapter.getAllText(t).trim();r&&a.push({type:"paragraph",text:r});return}if(e==="ul"||e==="ol"){const r={type:"list",listType:e==="ol"?"ordered":"unordered",children:[]};for(const l of this.adapter.getChildren(t))this.adapter.getTagName(l)==="li"&&r.children.push({type:"list-item",text:this.adapter.getAllText(l).trim()});r.children.length>0&&a.push(r);return}if(e==="li"){a.push({type:"list-item",text:this.adapter.getAllText(t).trim()});return}if(e==="blockquote"){a.push({type:"blockquote",text:this.adapter.getAllText(t).trim()});return}if(e==="strong"||e==="b"){a.push({type:"strong",text:this.adapter.getAllText(t).trim()});return}if(e==="em"||e==="i"){a.push({type:"emphasis",text:this.adapter.getAllText(t).trim()});return}if(this.adapter.hasChildren(t))for(const r of this.adapter.getChildren(t))this.processElement(r,a);else{const r=this.adapter.getDirectText(t).trim();r&&a.push({type:"text",text:r})}}isHeading(t){return/^h[1-6]$/.test(t)}getHeadingLevel(t){return parseInt(t.charAt(1),10)}}function er(g){var a;const t=[];for(const e of g)switch(e.type){case"heading":t.push("#".repeat(e.level||1)+" "+e.text);break;case"paragraph":t.push(e.text||""),t.push("");break;case"text":t.push(e.text||"");break;case"list":for(let r=0;r<(((a=e.children)==null?void 0:a.length)||0);r++){const l=e.children[r],n=e.listType==="ordered"?`${r+1}.`:"-";t.push(`${n} ${l.text}`)}t.push("");break;case"list-item":t.push("- "+e.text);break;case"blockquote":t.push("> "+e.text);break;case"strong":t.length>0&&!t[t.length-1].match(/^(#|>|-|\d+\.|\s*$)/)?t[t.length-1]+=" **"+e.text+"**":t.push("**"+e.text+"**");break;case"emphasis":t.length>0&&!t[t.length-1].match(/^(#|>|-|\d+\.|\s*$)/)?t[t.length-1]+=" *"+e.text+"*":t.push("*"+e.text+"*");break}return t.join(`
`).trim()}class tr{getChildren(t){return Array.from(t.children)}getTagName(t){return t.tagName.toLowerCase()}getDirectText(t){let a="";for(const e of t.childNodes)e.nodeType===Node.TEXT_NODE&&(a+=e.textContent||"");return a}getAllText(t){return t.innerText||t.textContent||""}hasChildren(t){return t.children.length>0}}class sr{static extract(t,a){var u,m,f;console.log("[SiteExtractor] extract() called"),console.log("[SiteExtractor] clicked element:",t);const e=(u=a.comments)==null?void 0:u.commentContainerSelector,r=(m=a.comments)==null?void 0:m.commentSelector,l=(f=a.comments)==null?void 0:f.fields;if(console.log(`[SiteExtractor] commentContainerSelector: "${e}"`),console.log(`[SiteExtractor] commentSelector: "${r}"`),!r)return console.log("[SiteExtractor] NO commentSelector configured - returning null"),null;let n=t.closest(r);if(!n&&e&&r){const h=t.closest(e);h&&(n=h.querySelector(r),console.log("[SiteExtractor] Found via parent container:",n))}if(console.log("[SiteExtractor] container found:",n),!n)return console.log("[SiteExtractor] NO CONTAINER - returning null"),null;const o={siteName:a.name};if(l){for(const[h,c]of Object.entries(l))if(c){const x=n.querySelector(c);if(console.log(`[SiteExtractor] field "${h}" selector "${c}" => element:`,x),x){const C=this.extractTextWithParagraphs(x);console.log(`[SiteExtractor] field "${h}" text: "${C.substring(0,50)}..."`),o[h]=C}}}return console.log("[SiteExtractor] result:",o),o}static extractTextWithParagraphs(t){var l;const a=t.cloneNode(!0);return a.querySelectorAll("p").forEach((n,o)=>{(o>0||n.previousSibling)&&n.insertAdjacentText("beforebegin",`
`)}),a.querySelectorAll("br").forEach(n=>{n.replaceWith(`
`)}),((l=a.textContent)==null?void 0:l.trim())||""}}const ar="0.2.4";class rr{constructor(t="content-capture-inspector"){Q(this,"ownerId");Q(this,"clickCallbacks",new Set);Q(this,"stateCallbacks",new Set);Q(this,"unsubscribeService",null);Q(this,"boundClickHandler",null);Q(this,"isManaged",!1);Q(this,"semanticExtractor");Q(this,"siteConfig",null);Q(this,"handleClick",t=>{if(!De.getState())return;const e=t.composedPath()[0]||t.target;if(e.closest(".inspector-tooltip")||e.closest(".content-capture-popover")||e.closest("[data-radix-select-content]")||e.closest("[data-radix-popper-content-wrapper]")||e.closest("[role='option']")||this.isOwnUIElement(e))return;t.preventDefault(),t.stopPropagation();const r=this.extractSemanticContent(e);let l;this.siteConfig&&(l=sr.extract(e,this.siteConfig)||void 0);const n={element:e,text:this.extractText(e),tagName:e.tagName.toLowerCase(),classes:Array.from(e.classList),dataTest:e.getAttribute("data-test")||void 0,semanticNodes:r.nodes,semanticMarkdown:r.markdown,siteFields:l};this.clickCallbacks.forEach(o=>o(n))});this.ownerId=t;const a=new tr;this.semanticExtractor=new Ha(a)}async init(){console.log(`[InspectorFacade] v${ar} init() for: ${window.location.hostname}`),this.siteConfig=await Pt.getConfigForDomain(window.location.hostname),console.log("[InspectorFacade] Site config:",this.siteConfig)}onElementClick(t){return this.clickCallbacks.add(t),()=>{this.clickCallbacks.delete(t)}}onStateChange(t){return this.stateCallbacks.add(t),()=>{this.stateCallbacks.delete(t)}}extractText(t){return(t.innerText||t.textContent||"").replace(/\s+/g," ").trim()}extractSemanticContent(t){const a=this.semanticExtractor.extract(t),e=er(a);return{nodes:a,markdown:e}}isOwnUIElement(t){const a=["word-extractor-app","word-extractor-app-body","word-extractor-mount","watcher-context-menu"];if(t.id&&a.includes(t.id)||t.closest("#word-extractor-app"))return!0;const e=t.getRootNode();if(e instanceof ShadowRoot){const n=e.host;if(n&&a.includes(n.id))return!0}const r=["custom-capture-controller","custom-capture-content","content-capture-controller","custom-selector","field-dialog","array-dialog","draggable-popover-container","draggable-popover-wrapper","schema-panel","preview-panel","watcher-extension-app"];let l=t;for(;l;){const n=l.getAttribute("data-test");if(n){for(const o of r)if(n===o||n.startsWith(o))return!0}l=l.parentElement}return!1}startManaging(){this.isManaged||(this.isManaged=!0,De.claimTooltip(this.ownerId),De.claimPanel(this.ownerId),De.claimClickHandling(this.ownerId),this.unsubscribeService=De.subscribe(t=>{this.stateCallbacks.forEach(a=>a(t))}),this.boundClickHandler=this.handleClick,document.addEventListener("click",this.boundClickHandler,!0))}stopManaging(){this.isManaged&&(this.isManaged=!1,De.releaseTooltip(this.ownerId),De.releasePanel(this.ownerId),De.releaseClickHandling(this.ownerId),this.unsubscribeService&&(this.unsubscribeService(),this.unsubscribeService=null),this.boundClickHandler&&(document.removeEventListener("click",this.boundClickHandler,!0),this.boundClickHandler=null))}activate(){De.activate()}deactivate(){De.deactivate()}isActive(){return De.getState()}getOwnerId(){return this.ownerId}destroy(){this.stopManaging(),this.clickCallbacks.clear(),this.stateCallbacks.clear()}}class nr{constructor(){Q(this,"captureFacade");Q(this,"inspectorFacade");Q(this,"phase","idle");Q(this,"mode","mapped");Q(this,"selectedFieldId",null);Q(this,"listeners",new Set);Q(this,"unsubscribeCapture",null);Q(this,"unsubscribeInspectorClick",null);Q(this,"fieldNamePromptCallback",null);Q(this,"arrayPatternConfirmCallback",null);Q(this,"pendingArraySelectorType",null);this.captureFacade=new Qa,this.inspectorFacade=new rr("custom-capture-inspector")}onStateChange(t){return this.listeners.add(t),()=>{this.listeners.delete(t)}}setFieldNamePromptCallback(t){this.fieldNamePromptCallback=t}setArrayPatternConfirmCallback(t){this.arrayPatternConfirmCallback=t}getState(){const t=this.captureFacade.getState();return{phase:this.phase,mode:this.mode,schema:t.schema,selectedFieldId:this.selectedFieldId,capturedData:t.capturedData,inspectorActive:this.inspectorFacade.isActive()}}notifyListeners(){const t=this.getState();this.listeners.forEach(a=>a(t))}setPhase(t){this.phase=t,this.notifyListeners()}async startCapture(t="mapped",a=!1){this.phase==="idle"&&(this.mode=t,await this.inspectorFacade.init(),a||this.captureFacade.clear(),this.unsubscribeCapture=this.captureFacade.onChange(()=>{this.notifyListeners()}),this.unsubscribeInspectorClick=this.inspectorFacade.onElementClick(async e=>{await this.handleElementClick(e.element)}),this.inspectorFacade.startManaging(),t==="mapped"?this.setPhase("capturing"):(this.inspectorFacade.activate(),this.setPhase("capturing")))}async handleElementClick(t){if(!(this.phase!=="capturing"&&this.phase!=="selecting-field")&&this.mode!=="list"&&!this.isOwnUIElement(t)){if(this.mode==="mapped"&&this.selectedFieldId){const a=this.captureFacade.getField(this.selectedFieldId);if((a==null?void 0:a.type)==="parentSelector"){await this.handleMappedModeClick(t);return}if(this.pendingArraySelectorType){await this.handleMappedModeClick(t);return}if((a==null?void 0:a.type)==="array"){let e=this.captureFacade.detectArrayPattern(t);if(!e){const r=this.captureFacade.findContainerAncestors(t,{minChildren:2,sameTag:!0,maxDepth:10});for(const l of r){if(e=this.captureFacade.detectArrayPattern(l.element),e&&e.itemCount>=2)break;e=null}}if(e&&e.itemCount>=2){await this.handleArrayPattern(e,t);return}}}this.mode==="quick"?await this.handleQuickModeClick(t):await this.handleMappedModeClick(t)}}async handleQuickModeClick(t){if(!this.fieldNamePromptCallback){const r=this.generateFieldName(t),l=this.captureFacade.addField(r,"string");this.captureFacade.mapElementToField(l.id,t);return}const a=this.generateFieldName(t),e=await this.fieldNamePromptCallback(t,a);if(e){const r=this.captureFacade.addField(e.name,e.type);this.captureFacade.mapElementToField(r.id,t)}}async handleMappedModeClick(t){if(!this.selectedFieldId){console.warn("[CustomCapture] No field selected for mapping");return}const a=this.captureFacade.getField(this.selectedFieldId);if(this.pendingArraySelectorType&&a){let e=t,r;if(this.pendingArraySelectorType==="item"&&a.containerSelector){const m=((a.parentId?this.captureFacade.findContextForField(a):void 0)||document).querySelector(a.containerSelector);if(m){r=m;let f=t,h=null,c=0;for(;f&&f!==m&&f.parentElement;){const x=f.parentElement,C=x.children.length;C>c&&(c=C,h=f),f=x}h&&c>1&&(e=h)}}else r=this.captureFacade.findContextForField(a);const l=Me.generate(e,r),n=e.innerText.trim().slice(0,50);this.pendingArraySelectorType==="container"?this.captureFacade.updateField(this.selectedFieldId,{containerSelector:l,mapping:{selector:l,sampleValue:n}}):this.captureFacade.updateField(this.selectedFieldId,{itemSelector:l,mapping:{selector:l,sampleValue:n}}),this.pendingArraySelectorType=null}else if((a==null?void 0:a.type)==="parentSelector"){const e=this.captureFacade.findContextForField(a),r=Me.generate(t,e);this.captureFacade.updateField(this.selectedFieldId,{containerSelector:r,mapping:{selector:r,sampleValue:t.innerText.trim().slice(0,50)}})}else this.captureFacade.mapElementToField(this.selectedFieldId,t);this.selectedFieldId=null,this.mode==="mapped"&&this.inspectorFacade.deactivate(),this.setPhase("capturing")}async handleArrayPattern(t,a){if(!this.arrayPatternConfirmCallback){if(this.mode==="quick"){const r=this.generateFieldName(t.containerElement),l=this.captureFacade.addField(r,"array");this.captureFacade.confirmArrayPattern(t,l.id)}return}const e=await this.arrayPatternConfirmCallback(t);if(e!=null&&e.confirmed)if(this.mode==="quick"){const r=e.fieldName||this.generateFieldName(t.containerElement),l=e.type||"array",n=this.captureFacade.addField(r,l);l==="array"?this.captureFacade.confirmArrayPattern(t,n.id):this.captureFacade.mapElementToField(n.id,t.containerElement)}else this.selectedFieldId&&(this.captureFacade.confirmArrayPattern(t,this.selectedFieldId),this.selectedFieldId=null,this.mode==="mapped"&&this.inspectorFacade.deactivate(),this.setPhase("capturing"))}isOwnUIElement(t){const a=["custom-capture-controller","custom-capture-content","custom-selector","field-dialog","array-dialog","draggable-popover-container","draggable-popover-wrapper","schema-panel","preview-panel"];let e=t;for(;e;){const r=e.getAttribute("data-test");if(r){for(const l of a)if(r===l||r.startsWith(l))return!0}e=e.parentElement}return!1}generateFieldName(t){const a=t.getAttribute("data-test");if(a)return this.sanitizeFieldName(a);if(t.id)return this.sanitizeFieldName(t.id);const e=t.getAttribute("aria-label");if(e)return this.sanitizeFieldName(e);const r=t.innerText.trim();if(r){const l=r.split(/\s+/).slice(0,3).join("_");return this.sanitizeFieldName(l)}return`field_${Date.now()%1e4}`}sanitizeFieldName(t){return t.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"").slice(0,30)}setMode(t){this.mode=t,this.notifyListeners()}selectFieldForMapping(t,a){this.selectedFieldId=t,this.pendingArraySelectorType=a??null,this.inspectorFacade.isActive()||this.inspectorFacade.activate(),this.setPhase("selecting-field")}clearFieldSelection(){this.selectedFieldId=null,this.phase==="selecting-field"&&(this.mode==="mapped"&&this.inspectorFacade.deactivate(),this.setPhase("capturing"))}addField(t,a,e=null){return this.captureFacade.addField(t,a,e)}updateField(t,a){this.captureFacade.updateField(t,a)}removeField(t){this.captureFacade.removeField(t)}unmapField(t){this.captureFacade.unmapField(t)}getTreeNodes(){return this.captureFacade.toTreeNodes()}updateFromTree(t){this.captureFacade.updateFromTree(t)}getSchema(){return this.captureFacade.getSchema()}setSchemaName(t){this.captureFacade.setSchemaName(t)}finishCapture(){this.phase!=="capturing"&&this.phase!=="selecting-field"||(this.inspectorFacade.deactivate(),this.selectedFieldId=null,this.setPhase("preview"))}resumeCapture(){this.phase==="preview"&&(this.mode==="mapped"?this.setPhase("capturing"):(this.inspectorFacade.activate(),this.setPhase("capturing")))}closePreview(){this.cleanup(),this.setPhase("idle")}cancel(){this.cleanup(),this.captureFacade.clear(),this.setPhase("idle")}cleanup(){this.inspectorFacade.deactivate(),this.inspectorFacade.stopManaging(),this.unsubscribeCapture&&(this.unsubscribeCapture(),this.unsubscribeCapture=null),this.unsubscribeInspectorClick&&(this.unsubscribeInspectorClick(),this.unsubscribeInspectorClick=null)}getCaptureFacade(){return this.captureFacade}exportJson(){const t=this.captureFacade.generateExport();return JSON.stringify(t,null,2)}exportDataOnly(){const t=this.captureFacade.extractData();return JSON.stringify(t,null,2)}async copyToClipboard(){try{const t=this.exportDataOnly();return await navigator.clipboard.writeText(t),!0}catch{return!1}}destroy(){this.cleanup(),this.inspectorFacade.destroy(),this.listeners.clear()}}function lr({schema:g,selectedFieldId:t,mode:a,onFieldSelect:e,onFieldUpdate:r,onFieldEdit:l,onFieldDelete:n,onReorder:o,onAddChild:u,onAddSiblingBefore:m,onAddSiblingAfter:f,queryRoot:h}){const c=d.useMemo(()=>{const k=F=>g.fields.filter(S=>S.parentId===F).sort((S,L)=>S.order-L.order).map(S=>({id:S.id,label:S.name,children:k(S.id),data:S}));return k(null)},[g.fields]),x=d.useMemo(()=>new Set(g.fields.map(k=>k.id)),[g.fields]),C=d.useCallback(k=>{a==="mapped"&&e(k.id)},[a,e]),w=d.useCallback((k,F,S,L)=>{var Z;const R=k.data,q=(R==null?void 0:R.mapping)!=null,H=a==="mapped"&&k.id===t;return s.jsxs("div",{className:`flex items-center gap-2 w-full group ${H?"bg-primary/10 -mx-2 px-2 rounded":""}`,"data-test":"schema-field",children:[s.jsx("span",{className:"flex-shrink-0","data-test":"field-status-icon",children:q?s.jsx(Aa,{className:"w-3 h-3 text-green-500"}):s.jsx(Ea,{className:"w-3 h-3 text-muted-foreground"})}),s.jsx("span",{className:"flex-shrink-0 text-xs text-muted-foreground font-mono w-4",title:(R==null?void 0:R.type)||"unknown","data-test":"field-type-indicator",children:ir(R==null?void 0:R.type)}),s.jsx("span",{className:"flex-1 truncate",children:L}),((Z=R==null?void 0:R.mapping)==null?void 0:Z.sampleValue)&&s.jsxs("span",{className:"text-xs text-muted-foreground truncate max-w-[100px]",title:R.mapping.sampleValue,"data-test":"field-sample-value",children:['"',R.mapping.sampleValue.slice(0,20),R.mapping.sampleValue.length>20?"...":"",'"']}),R&&s.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0",children:s.jsx(Ca,{onClick:()=>u(R.id),label:"",icon:vt,variant:"ghost",size:"sm",compact:!0,options:[{label:"Add sibling before",onClick:()=>m(R.id)},{label:"Add sibling after",onClick:()=>f(R.id)}],contentStyle:{zIndex:ts.draggablePopoverDropdown},"data-test":"add-field"})})]})},[a,t,u,m,f]),j=d.useCallback(k=>{const F=k.data;return F?[{id:"edit",icon:s.jsx(Ia,{className:"h-3 w-3"}),title:"Edit field",onClick:()=>{l(F.id,F.name,F.type)}}]:null},[l]);return g.fields.length===0?s.jsxs("div",{className:"p-4 text-sm text-muted-foreground text-center","data-test":"empty-schema-message",children:[s.jsx("p",{className:"mb-2",children:"No fields defined yet."}),s.jsx("p",{className:"text-xs",children:a==="quick"?"Click elements on the page to add fields.":"Use + to add fields, then click elements to map."})]}):s.jsx("div",{className:"p-2","data-test":"schema-tree-container",children:s.jsx(as,{data:c,onUpdate:r,onDelete:n,onReorder:o,onItemClick:C,defaultExpandedIds:x,enableEdit:!1,enableDelete:!0,enableDrag:!0,renderNode:w,quickActions:j,queryRoot:h})})}function ir(g){switch(g){case"string":return"T";case"number":return"#";case"boolean":return"?";case"array":return"[]";case"parentSelector":return"{1}";case"object":return"{}";default:return"·"}}function xt({fieldName:g,selectorType:t,onClick:a,onDoubleClick:e}){return s.jsx("button",{onClick:()=>a==null?void 0:a(g,t),onDoubleClick:()=>e==null?void 0:e(g,t),className:"p-1 rounded mr-1",style:{backgroundColor:"#dcfce7"},title:"Click: add filter | Double-click: auto-add classes","data-test":"selector-filter",children:s.jsx(Ta,{className:"w-3 h-3",style:{color:"#16a34a"}})})}function bt({fieldId:g,fieldName:t,selectorType:a,onConfigClick:e,onScanContainersClick:r,onChildFilterClick:l,portalContainer:n}){const o=!a;return s.jsxs(Je,{value:"",onValueChange:u=>{u==="scan-containers"?r==null||r(g):u==="configure"?e==null||e(t):u==="filter-children"&&(l==null||l(t))},children:[s.jsx(Ve,{className:"ml-1 p-1 h-auto w-auto border-0 shadow-none rounded",style:{backgroundColor:"#e5e7eb"},hideChevron:!0,"data-test":"config-button",children:s.jsx(Kt,{className:"w-3 h-3",style:{color:"#4b5563"}})}),s.jsxs(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},container:n,"data-test":"config-menu",children:[s.jsx(ce,{value:"scan-containers",style:{color:"#1f2937"},"data-test":"config-scan-containers",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(kt,{className:"w-3 h-3"}),"Scan containers"]})}),o&&s.jsx(ce,{value:"filter-children",style:{color:"#1f2937"},"data-test":"config-filter-children",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Be,{className:"w-3 h-3"}),"Filter out elements"]})}),s.jsx(ce,{value:"configure",style:{color:"#1f2937"},"data-test":"config-extraction",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Kt,{className:"w-3 h-3"}),"Configure extraction"]})})]})]})}function cr(g){const t=new Map,a=[];for(const r of g)t.set(r.id,{field:r,children:[]});for(const r of g){const l=t.get(r.id);if(r.parentId===null)a.push(l);else{const n=t.get(r.parentId);n&&n.children.push(l)}}const e=r=>{r.sort((l,n)=>l.field.order-n.field.order);for(const l of r)e(l.children)};return e(a),a}function or({schema:g,previewMode:t,selectors:a,content:e,onConfigClick:r,onValueClick:l,onValueHover:n,onRevertClick:o,revertableFields:u,onFieldSelect:m,onArraySelectorClick:f,onSelectorFilterClick:h,onSelectorFilterDoubleClick:c,onScanContainersClick:x,onChildFilterClick:C,onClearSelector:w,onClearFilter:j,onMatchIndexChange:k,onMatchIndexHover:F,getMatchElements:S,portalContainer:L}){const[R,q]=d.useState(new Set),[H,Z]=d.useState(new Set),[W,J]=d.useState(!1);if(d.useEffect(()=>{const Y=g.fields.filter(le=>g.fields.some(V=>V.parentId===le.id)).map(le=>le.id);q(le=>{const V=new Set(le);for(const re of Y)H.has(re)||V.add(re);return V})},[g.fields,H]),g.fields.length===0)return s.jsx("div",{className:"p-4 text-sm text-center h-full flex items-center justify-center",style:{color:"#9ca3af"},"data-test":"empty-preview-message",children:"JSON preview will appear here"});const ee=Y=>{q(le=>{const V=new Set(le);return V.has(Y)?(V.delete(Y),Z(re=>new Set(re).add(Y))):(V.add(Y),Z(re=>{const he=new Set(re);return he.delete(Y),he})),V})},K=cr(g.fields),E=t==="selectors";return s.jsx("div",{className:"h-full flex flex-col","data-test":"json-preview",children:s.jsxs("div",{className:"relative p-2 text-xs font-mono rounded m-2 overflow-auto flex-1",style:{backgroundColor:"rgba(0,0,0,0.03)"},"data-test":"json-content",children:[s.jsxs("button",{onClick:()=>J(!W),className:"absolute top-1 right-1 flex items-center gap-1 text-xs px-1.5 py-0.5 rounded hover:bg-gray-200 transition-colors",style:{color:"#6b7280",backgroundColor:"rgba(255,255,255,0.8)"},title:W?"Expand values":"Collapse values","data-test":"toggle-values-collapse",children:[W?s.jsx(Ft,{className:"w-3 h-3"}):s.jsx(wt,{className:"w-3 h-3"}),s.jsx("span",{children:W?"Expand":"Collapse"})]}),s.jsxs("pre",{className:"m-0 p-0",style:{background:"transparent"},children:[s.jsx("span",{style:{color:"#1f2937"},children:"{"}),K.map((Y,le)=>s.jsx(os,{node:Y,level:1,isLast:le===K.length-1,isSelector:E,selectors:a,content:e,expandedIds:R,onToggle:ee,onConfigClick:r,onValueClick:l,onValueHover:n,onRevertClick:o,revertableFields:u,onFieldSelect:m,onArraySelectorClick:f,onSelectorFilterClick:h,onSelectorFilterDoubleClick:c,onScanContainersClick:x,onChildFilterClick:C,onClearSelector:w,onClearFilter:j,onMatchIndexChange:k,onMatchIndexHover:F,getMatchElements:S,portalContainer:L,valuesCollapsed:W},Y.field.id)),s.jsx("span",{style:{color:"#1f2937"},children:"}"})]})]})})}function os({node:g,level:t,isLast:a,isSelector:e,selectors:r,content:l,parentArrayContent:n,parentSelectors:o,expandedIds:u,onToggle:m,onConfigClick:f,onValueClick:h,onValueHover:c,onRevertClick:x,revertableFields:C,onFieldSelect:w,onArraySelectorClick:j,onSelectorFilterClick:k,onSelectorFilterDoubleClick:F,onScanContainersClick:S,onChildFilterClick:L,onClearSelector:R,onClearFilter:q,onMatchIndexChange:H,onMatchIndexHover:Z,getMatchElements:W,portalContainer:J,valuesCollapsed:ee}){var ye,_e,ge,P,z;const K=ee?12:60,{field:E,children:Y}=g,le=Y.length>0,V=u.has(E.id),re="  ".repeat(t),he=o??r,we=(()=>{if(e){const $=he[E.name];if($===void 0||$==="")return"<no selector>";if(typeof $=="object"&&$!==null){const T=$._container;return T||"<no selector>"}return $==null?"<no selector>":typeof $=="string"?$:String($)}else{if(n&&n.length>0){const N=n[0],T=N==null?void 0:N[E.name];if(T!==void 0){const O=typeof T=="string"?T:JSON.stringify(T),_=he[E.name],B=typeof _=="string"?_:null;let G=0;if(B)if(B.startsWith(":scope"))G=n.length;else try{G=document.querySelectorAll(B).length}catch{G=n.length}else G=n.length;const oe=G>1?G-1:0;return`${O} (+${oe} more)`}return"<not extracted>"}const $=l[E.name];return $!==void 0?typeof $=="string"?$:JSON.stringify($):"<not extracted>"}})(),ie=($=!1)=>$?"#fde047":"#fef9c3",me=we.startsWith("<")&&we.endsWith(">");if(le){const $=E.type==="array",N=E.type==="parentSelector",T=$?"[":"{",O=$?"]":"}",_=he[E.name],B=typeof _=="object"&&_!==null?_:void 0,G=E.containerSelector,oe=E.itemSelector,Fe=B==null?void 0:B._container,Se=B==null?void 0:B._item;let We=0;if($&&!e){if(Array.isArray(l[E.name]))We=l[E.name].length;else if(n&&n.length>0){const A=n[0],Ce=A==null?void 0:A[E.name];Array.isArray(Ce)&&(We=Ce.length)}}const ot=$&&!e&&We>0?`${We} item${We!==1?"s":""}`:`${Y.length} field${Y.length!==1?"s":""}`,ze="  ".repeat(t+1);return s.jsxs("div",{"data-test":"json-field",children:[s.jsxs("div",{className:"flex items-center group",children:[s.jsxs("span",{style:{color:"#2563eb"},children:[re,'"',E.name,'"']}),s.jsx("span",{style:{color:"#1f2937"},children:": "}),s.jsxs("button",{onClick:()=>m(E.id),className:"inline-flex items-center hover:bg-gray-100 rounded px-0.5 transition-colors","data-test":"toggle",children:[V?s.jsx(wt,{className:"w-3 h-3",style:{color:"#6b7280"}}):s.jsx(Ft,{className:"w-3 h-3",style:{color:"#6b7280"}}),s.jsx("span",{style:{color:"#1f2937"},children:T}),!V&&s.jsxs("span",{style:{color:"#9ca3af"},children:[" ",ot," "]}),!V&&s.jsx("span",{style:{color:"#1f2937"},children:O})]}),!V&&!a&&s.jsx("span",{style:{color:"#1f2937"},children:","})]}),V&&s.jsxs(s.Fragment,{children:[e&&(N||$)&&s.jsxs("div",{className:"flex items-start group","data-test":"json-field-_container",children:[s.jsxs("span",{className:"shrink-0",style:{color:"#2563eb"},children:[ze,'"_container"']}),s.jsx("span",{className:"shrink-0",style:{color:"#1f2937"},children:": "}),s.jsxs("div",{className:"flex items-start flex-1 min-w-0",children:[s.jsx(xt,{fieldName:E.name,selectorType:"container",onClick:k,onDoubleClick:F}),E.containerSelectorFilters&&E.containerSelectorFilters.length>0&&s.jsx(s.Fragment,{children:E.containerSelectorFilters.map((A,Ce)=>s.jsxs("span",{className:"shrink-0 inline-flex items-center group/filter",style:{backgroundColor:"#bbf7d0",color:"#166534",borderRadius:"4px",padding:"1px 4px",marginRight:"4px",fontSize:"0.75rem",cursor:"pointer"},title:`Selector filter: ${A} (click to add more)`,"data-test":"field-filter",onClick:()=>k==null?void 0:k(E.name,"container"),onMouseEnter:()=>{const xe=G?G+A:A;c==null||c(xe)},onMouseLeave:()=>c==null?void 0:c(null),children:[yt(A,12),q&&s.jsx("button",{onClick:xe=>{xe.stopPropagation(),q(E.name,Ce,"container")},className:"ml-1 opacity-0 group-hover/filter:opacity-100 hover:text-red-600",title:"Remove filter","data-test":"clear-filter",children:s.jsx(Be,{className:"w-3 h-3"})})]},`filter-${Ce}`))}),G?s.jsxs("span",{className:"inline-flex items-center group/value",style:{backgroundColor:ie(),border:"1px solid #facc15",borderRadius:"4px",padding:"1px 6px"},"data-test":"field-value-_container",children:[s.jsxs("span",{onClick:()=>h==null?void 0:h(E.name,"container"),onMouseEnter:A=>{c==null||c(Fe??null),A.currentTarget.parentElement.style.backgroundColor=ie(!0)},onMouseLeave:A=>{c==null||c(null),A.currentTarget.parentElement.style.backgroundColor=ie(!1)},style:{color:"#a16207",cursor:"pointer"},className:"select-text truncate",title:`Base: ${G}${Fe!==G?`
JSON: ${Fe}`:""} (click to view DOM tree)`,children:['"',Qe(G,K),'"']}),(()=>{const A=(W==null?void 0:W(E.id,"container"))??[];return A.length<=1?null:s.jsx("span",{className:"ml-1 text-xs px-1 rounded",style:{backgroundColor:"#fef3c7",color:"#92400e"},title:`${A.length} matches - click selector to select which one`,"data-test":"match-count-badge",children:A.length})})(),R&&s.jsx("button",{onClick:A=>{A.stopPropagation(),R(E.name,"container")},className:"ml-1 opacity-0 group-hover/value:opacity-100 hover:text-red-600",style:{color:"#a16207"},title:"Clear selector","data-test":"clear-selector",children:s.jsx(Be,{className:"w-3 h-3"})})]}):s.jsx("span",{onClick:j?()=>j(E.id,"container"):void 0,onMouseEnter:j?A=>{A.currentTarget.style.backgroundColor="#f3f4f6"}:void 0,onMouseLeave:j?A=>{A.currentTarget.style.backgroundColor="transparent"}:void 0,style:{color:"#9ca3af",fontStyle:"italic",cursor:j?"pointer":"default",borderRadius:j?"4px":void 0,padding:j?"1px 6px":void 0,transition:"background-color 0.15s"},title:j?"Click to assign container selector":void 0,"data-test":"field-value-_container",children:"null"}),G&&((ye=E.mapping)==null?void 0:ye.extractAttributes)&&E.mapping.extractAttributes.length>0&&s.jsx(s.Fragment,{children:E.mapping.extractAttributes.map(A=>s.jsxs("span",{onClick:()=>f==null?void 0:f(E.name),className:"shrink-0",style:{backgroundColor:"#fed7aa",color:"#c2410c",borderRadius:"4px",padding:"1px 4px",marginLeft:"4px",fontSize:"0.75rem",cursor:"pointer"},title:"Click to change attributes","data-test":"field-attribute",children:["@",A]},A))})]}),s.jsx("div",{className:"shrink-0 ml-1",children:s.jsx(bt,{fieldId:E.id,fieldName:E.name,selectorType:"container",onConfigClick:f,onScanContainersClick:S,portalContainer:J})}),s.jsx("span",{className:"shrink-0",style:{color:"#1f2937"},children:","})]}),e&&$&&s.jsxs("div",{className:"flex items-start group","data-test":"json-field-_item",children:[s.jsxs("span",{className:"shrink-0",style:{color:"#2563eb"},children:[ze,'"_item"']}),s.jsx("span",{className:"shrink-0",style:{color:"#1f2937"},children:": "}),s.jsxs("div",{className:"flex items-start flex-1 min-w-0",children:[s.jsx(xt,{fieldName:E.name,selectorType:"item",onClick:k,onDoubleClick:F}),E.itemSelectorFilters&&E.itemSelectorFilters.length>0&&s.jsx(s.Fragment,{children:E.itemSelectorFilters.map((A,Ce)=>s.jsxs("span",{className:"shrink-0 inline-flex items-center group/filter",style:{backgroundColor:"#bbf7d0",color:"#166534",borderRadius:"4px",padding:"1px 4px",marginRight:"4px",fontSize:"0.75rem",cursor:"pointer"},title:`Selector filter: ${A} (click to add more)`,"data-test":"field-filter",onClick:()=>k==null?void 0:k(E.name,"item"),onMouseEnter:()=>{const xe=oe?oe+A:A,be=Fe?`${Fe} ${xe}`:xe;c==null||c(be)},onMouseLeave:()=>c==null?void 0:c(null),children:[yt(A,12),q&&s.jsx("button",{onClick:xe=>{xe.stopPropagation(),q(E.name,Ce,"item")},className:"ml-1 opacity-0 group-hover/filter:opacity-100 hover:text-red-600",title:"Remove filter","data-test":"clear-filter",children:s.jsx(Be,{className:"w-3 h-3"})})]},`filter-${Ce}`))}),oe?s.jsxs("span",{className:"inline-flex items-center group/value",style:{backgroundColor:ie(),border:"1px solid #facc15",borderRadius:"4px",padding:"1px 6px"},"data-test":"field-value-_item",children:[s.jsxs("span",{onClick:()=>h==null?void 0:h(E.name,"item"),onMouseEnter:A=>{const Ce=Fe&&Se?`${Fe} ${Se}`:Se??null;c==null||c(Ce),A.currentTarget.parentElement.style.backgroundColor=ie(!0)},onMouseLeave:A=>{c==null||c(null),A.currentTarget.parentElement.style.backgroundColor=ie(!1)},style:{color:"#a16207",cursor:"pointer"},className:"select-text truncate",title:`Base: ${oe}${Se!==oe?`
JSON: ${Se}`:""} (click to view DOM tree)`,children:['"',Qe(oe,K),'"']}),R&&s.jsx("button",{onClick:A=>{A.stopPropagation(),R(E.name,"item")},className:"ml-1 opacity-0 group-hover/value:opacity-100 hover:text-red-600",style:{color:"#a16207"},title:"Clear selector","data-test":"clear-selector",children:s.jsx(Be,{className:"w-3 h-3"})})]}):s.jsx("span",{onClick:j?()=>j(E.id,"item"):void 0,onMouseEnter:j?A=>{A.currentTarget.style.backgroundColor="#f3f4f6"}:void 0,onMouseLeave:j?A=>{A.currentTarget.style.backgroundColor="transparent"}:void 0,style:{color:"#9ca3af",fontStyle:"italic",cursor:j?"pointer":"default",borderRadius:j?"4px":void 0,padding:j?"1px 6px":void 0,transition:"background-color 0.15s"},title:j?"Click to assign item selector":void 0,"data-test":"field-value-_item",children:"null"}),oe&&((_e=E.mapping)==null?void 0:_e.extractAttributes)&&E.mapping.extractAttributes.length>0&&s.jsx(s.Fragment,{children:E.mapping.extractAttributes.map(A=>s.jsxs("span",{onClick:()=>f==null?void 0:f(E.name),className:"shrink-0",style:{backgroundColor:"#fed7aa",color:"#c2410c",borderRadius:"4px",padding:"1px 4px",marginLeft:"4px",fontSize:"0.75rem",cursor:"pointer"},title:"Click to change attributes","data-test":"field-attribute",children:["@",A]},A))})]}),s.jsx("div",{className:"shrink-0 ml-1",children:s.jsx(bt,{fieldId:E.id,fieldName:E.name,selectorType:"item",onConfigClick:f,onScanContainersClick:S,portalContainer:J})}),s.jsx("span",{className:"shrink-0",style:{color:"#1f2937"},children:","})]}),Y.map((A,Ce)=>{const xe=!$&&n?n.map(de=>typeof de=="object"&&de!==null&&E.name in de?de[E.name]:void 0).filter(de=>de!==void 0):void 0;let be;if($)Array.isArray(l[E.name])?be=l[E.name]:n&&n.length>0&&(be=n);else if(A.field.type==="array"){const de=xe??n;if(de&&de.length>0){for(const je of de){const qe=je==null?void 0:je[A.field.name];if(Array.isArray(qe)&&qe.length>0){be=qe;break}}if(!be){const je=de[0],qe=je==null?void 0:je[A.field.name];Array.isArray(qe)&&(be=qe)}}}return s.jsx(os,{node:A,level:t+1,isLast:Ce===Y.length-1,isSelector:e,selectors:r,content:l,parentArrayContent:be||xe,parentSelectors:B,expandedIds:u,onToggle:m,onConfigClick:f,onValueClick:h,onValueHover:c,onRevertClick:x,revertableFields:C,onFieldSelect:w,onArraySelectorClick:j,onSelectorFilterClick:k,onSelectorFilterDoubleClick:F,onScanContainersClick:S,onChildFilterClick:L,onClearSelector:R,onClearFilter:q,onMatchIndexChange:H,onMatchIndexHover:Z,getMatchElements:W,portalContainer:J,valuesCollapsed:ee},A.field.id)}),s.jsxs("div",{children:[s.jsxs("span",{style:{color:"#1f2937"},children:[re,O]}),!a&&s.jsx("span",{style:{color:"#1f2937"},children:","})]})]})]})}const pe=(ge=E.mapping)==null?void 0:ge.selector,fe=he[E.name],Ee=e?pe||"<no selector>":we,Re=!!pe&&pe!=="",ne=Ee.startsWith("<")&&Ee.endsWith(">"),Ie=e&&Re&&W?W(E.id):[];return s.jsxs("div",{className:"flex items-start group","data-test":"json-field",children:[s.jsxs("span",{className:"shrink-0",style:{color:"#2563eb"},"data-test":"field-key",children:[re,'"',E.name,'"']}),s.jsx("span",{className:"shrink-0",style:{color:"#1f2937"},children:": "}),s.jsxs("div",{className:"flex items-start flex-1 min-w-0",children:[e&&s.jsx(xt,{fieldName:E.name,onClick:k,onDoubleClick:F}),e&&((P=E.mapping)==null?void 0:P.selectorFilters)&&E.mapping.selectorFilters.length>0&&s.jsx(s.Fragment,{children:E.mapping.selectorFilters.map(($,N)=>s.jsxs("span",{className:"shrink-0 inline-flex items-center group/filter",style:{backgroundColor:"#bbf7d0",color:"#166534",borderRadius:"4px",padding:"1px 4px",marginRight:"4px",fontSize:"0.75rem",cursor:"pointer"},title:`Selector filter: ${$} (click to add more)`,"data-test":"field-filter",onClick:()=>k==null?void 0:k(E.name),onMouseEnter:()=>{const T=pe?pe+$:$;c==null||c(T,E.name)},onMouseLeave:()=>c==null?void 0:c(null,E.name),children:[yt($,12),q&&s.jsx("button",{onClick:T=>{T.stopPropagation(),q(E.name,N)},className:"ml-1 opacity-0 group-hover/filter:opacity-100 hover:text-red-600",title:"Remove filter","data-test":"clear-filter",children:s.jsx(Be,{className:"w-3 h-3"})})]},`filter-${N}`))}),!me&&Re?s.jsxs("span",{className:"inline-flex items-center group/value",style:{backgroundColor:ie(),border:"1px solid #facc15",borderRadius:"4px",padding:"1px 6px"},"data-test":"field-value",children:[s.jsxs("span",{onClick:()=>h==null?void 0:h(E.name),onMouseEnter:$=>{c==null||c(fe??null,E.name),$.currentTarget.parentElement.style.backgroundColor=ie(!0)},onMouseLeave:$=>{c==null||c(null,E.name),$.currentTarget.parentElement.style.backgroundColor=ie(!1)},style:{color:"#a16207",cursor:"pointer"},className:"select-text truncate",title:`Base: ${pe}${fe!==pe?`
JSON: ${fe}`:""} (click to view DOM tree)`,children:['"',Qe(Ee,K),'"']}),Ie.length>1&&s.jsx("span",{className:"ml-1 text-xs px-1 rounded",style:{backgroundColor:"#fef3c7",color:"#92400e"},title:`${Ie.length} matches - click selector to select which one`,"data-test":"match-count-badge",children:Ie.length}),R&&s.jsx("button",{onClick:$=>{$.stopPropagation(),R(E.name)},className:"ml-1 opacity-0 group-hover/value:opacity-100 hover:text-red-600",style:{color:"#a16207"},title:"Clear selector","data-test":"clear-selector",children:s.jsx(Be,{className:"w-3 h-3"})})]}):s.jsxs("span",{onClick:ne&&w?()=>w(E.id):!ne&&h?()=>h(E.name):void 0,style:{color:ne?"#9ca3af":"#16a34a",fontStyle:ne?"italic":"normal",cursor:ne&&w||!ne&&h?"pointer":"default",borderRadius:ne&&w||!ne&&h?"4px":void 0,padding:ne&&w||!ne&&h?"1px 6px":void 0,transition:"background-color 0.15s"},onMouseEnter:$=>{fe&&(c==null||c(fe,E.name)),(ne&&w||!ne&&h)&&($.currentTarget.style.backgroundColor="#f3f4f6")},onMouseLeave:$=>{c==null||c(null,E.name),(ne&&w||!ne&&h)&&($.currentTarget.style.backgroundColor="transparent")},className:"truncate max-w-full",title:ne&&w?"Click to assign selector":!ne&&h?e?"Click to view DOM tree":`Click to view matches
Selector: ${fe||"none"}`:Ee,"data-test":"field-value",children:['"',Qe(Ee,K),'"']}),e&&Re&&((z=E.mapping)==null?void 0:z.extractAttributes)&&E.mapping.extractAttributes.length>0&&s.jsx(s.Fragment,{children:E.mapping.extractAttributes.map($=>s.jsxs("span",{onClick:()=>f==null?void 0:f(E.name),className:"shrink-0",style:{backgroundColor:"#fed7aa",color:"#c2410c",borderRadius:"4px",padding:"1px 4px",marginLeft:"4px",fontSize:"0.75rem",cursor:"pointer"},title:"Click to change attributes","data-test":"field-attribute",children:["@",$]},$))}),e&&Re&&(C==null?void 0:C.has(E.name))&&s.jsx("button",{onClick:()=>x==null?void 0:x(E.name),className:"shrink-0 ml-1 p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity",style:{backgroundColor:"#fef3c7"},title:"Revert to previous selection","data-test":"revert-button",children:s.jsx(rs,{className:"w-3 h-3",style:{color:"#92400e"}})})]}),e&&s.jsx("div",{className:"shrink-0 ml-1",children:s.jsx(bt,{fieldId:E.id,fieldName:E.name,onConfigClick:f,onScanContainersClick:S,onChildFilterClick:L,portalContainer:J})}),!a&&s.jsx("span",{className:"shrink-0",style:{color:"#1f2937"},children:","})]})}function Qe(g,t){return g.length<=t?g:g.slice(0,t-3)+"..."}function yt(g,t){const a=/^\[([^=]+)="(.*)"\]$/.exec(g);if(!a)return Qe(g,t);const[,e,r]=a;return r.length<=t?g:`[${e}="${r.slice(0,t-3)}..."]`}const dr=[{value:"string",label:"Text",icon:"T"},{value:"number",label:"Number",icon:"#"},{value:"boolean",label:"Boolean",icon:"?"},{value:"array",label:"Array",icon:"[]"},{value:"parentSelector",label:"Parent",icon:"{1}"},{value:"object",label:"Object",icon:"{}"}];function ur({isOpen:g,suggestedName:t,editingField:a,onSubmit:e,onCancel:r,portalContainer:l}){const[n,o]=d.useState(""),[u,m]=d.useState("string"),[f,h]=d.useState(""),[c,x]=d.useState(""),C=d.useRef(null),w=!!a;d.useEffect(()=>{g&&(a?(o(a.name),m(a.type),h(a.containerSelector||""),x(a.itemSelector||"")):(o(t),m("string"),h(""),x("")),setTimeout(()=>{var F;return(F=C.current)==null?void 0:F.focus()},100))},[g,t,a]);const j=()=>{const F={name:n.trim(),type:u};return u==="array"&&(f.trim()&&(F.containerSelector=f.trim()),c.trim()&&(F.itemSelector=c.trim())),F};d.useEffect(()=>{if(!g)return;const F=S=>{S.key==="Escape"?r():S.key==="Enter"&&n.trim()&&e(j())};return document.addEventListener("keydown",F),()=>document.removeEventListener("keydown",F)},[g,n,u,f,c,e,r]);const k=()=>{n.trim()&&e(j())};return s.jsx(Oe,{isVisible:g,onClose:r,title:w?"Update Field":"Add Field",shouldCloseManually:!0,initialPosition:{x:window.innerWidth/2-175,y:window.innerHeight/3},className:"!w-[350px]",portalContainer:l,children:s.jsxs("div",{className:"p-3","data-test":"field-dialog",children:[s.jsxs("div",{className:"mb-4",children:[s.jsx(Le,{htmlFor:"field-name",className:"text-xs text-foreground font-medium",children:"Field Name"}),s.jsx(Ye,{ref:C,id:"field-name",value:n,onChange:F=>o(F.target.value),placeholder:"e.g., title, author, description",className:"mt-1 text-foreground","data-test":"field-name-input"})]}),s.jsxs("div",{className:"mb-4",children:[s.jsx(Le,{className:"text-xs text-foreground font-medium",children:"Field Type"}),s.jsx("div",{className:"grid grid-cols-5 gap-1 mt-1","data-test":"field-type-selector",children:dr.map(F=>s.jsxs("button",{type:"button",onClick:()=>m(F.value),onKeyDown:S=>{S.key==="Enter"&&(S.preventDefault(),S.stopPropagation(),m(F.value))},className:"flex flex-col items-center p-2 rounded border text-xs transition-colors",style:{borderColor:u===F.value?"#3b82f6":void 0,backgroundColor:u===F.value?"rgba(59, 130, 246, 0.15)":void 0,color:u===F.value?"#3b82f6":void 0,fontWeight:u===F.value?500:void 0},title:F.label,"data-test":"field-type","data-selected":u===F.value,children:[s.jsx("span",{className:"font-mono text-sm",children:F.icon}),s.jsx("span",{className:"text-[10px] mt-0.5",children:F.label})]},F.value))})]}),u==="array"&&s.jsxs("div",{className:"mb-4 space-y-3","data-test":"array-selectors",children:[s.jsxs("div",{children:[s.jsx(Le,{htmlFor:"container-selector",className:"text-xs text-foreground font-medium",children:"Container Selector"}),s.jsx(Ye,{id:"container-selector",value:f,onChange:F=>h(F.target.value),placeholder:"e.g., .item-list, #products",className:"mt-1 text-foreground font-mono text-xs","data-test":"container-selector-input"}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-1",children:"Parent element containing all items"})]}),s.jsxs("div",{children:[s.jsx(Le,{htmlFor:"item-selector",className:"text-xs text-foreground font-medium",children:"Item Selector"}),s.jsx(Ye,{id:"item-selector",value:c,onChange:F=>x(F.target.value),placeholder:"e.g., .item, > div",className:"mt-1 text-foreground font-mono text-xs","data-test":"item-selector-input"}),s.jsx("p",{className:"text-[10px] text-muted-foreground mt-1",children:"Selector for each item (relative to container)"})]})]}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(ae,{variant:"ghost",size:"sm",onClick:r,"data-test":"field-dialog-cancel",children:"Cancel"}),s.jsx(ae,{size:"sm",onClick:k,disabled:!n.trim(),"data-test":"field-dialog-submit",children:w?"Update Field":"Add Field"})]})]})})}const mr=[{value:"array",label:"Array",icon:"[]"},{value:"string",label:"Text",icon:"T"},{value:"parentSelector",label:"Parent",icon:"{1}"},{value:"object",label:"Object",icon:"{}"}];function fr({isOpen:g,pattern:t,onSubmit:a,onCancel:e,portalContainer:r}){const[l,n]=d.useState(""),[o,u]=d.useState("array"),m=d.useRef(null);if(d.useEffect(()=>{if(g&&t){const c=hr(t);n(c),u("array"),setTimeout(()=>{var x;return(x=m.current)==null?void 0:x.focus()},100)}},[g,t]),d.useEffect(()=>{if(!g)return;const c=x=>{x.key==="Escape"?e():x.key==="Enter"&&l.trim()&&a({confirmed:!0,fieldName:l.trim(),type:o})};return document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)},[g,l,o,a,e]),!t)return null;const f=()=>{a({confirmed:!0,fieldName:l.trim()||void 0,type:o})},h=()=>{a({confirmed:!1})};return s.jsx(Oe,{isVisible:g,onClose:e,title:"Pattern Detected",shouldCloseManually:!0,initialPosition:{x:window.innerWidth/2-175,y:window.innerHeight/3},className:"!w-[350px]",portalContainer:r,children:s.jsxs("div",{className:"p-3","data-test":"array-dialog",children:[s.jsxs("p",{className:"text-sm text-foreground mb-4",children:["Found ",s.jsx("strong",{children:t.itemCount})," similar items."]}),s.jsxs("div",{className:"mb-4","data-test":"array-selectors",children:[s.jsx(Le,{className:"text-xs text-foreground font-medium",children:"Selectors:"}),s.jsxs("div",{className:"mt-1 bg-muted/50 rounded p-2 text-xs font-mono",children:[s.jsxs("div",{className:"truncate",title:t.containerSelector,"data-test":"container-selector",children:[s.jsx("span",{className:"text-muted-foreground",children:"container:"})," ",t.containerSelector]}),s.jsxs("div",{className:"truncate",title:t.itemSelector,"data-test":"item-selector",children:[s.jsx("span",{className:"text-muted-foreground",children:"item:"})," ",t.itemSelector]})]})]}),s.jsxs("div",{className:"mb-4","data-test":"array-sample-items",children:[s.jsx(Le,{className:"text-xs text-foreground font-medium",children:"Sample items:"}),s.jsxs("div",{className:"mt-1 bg-muted/50 rounded p-2 max-h-[100px] overflow-auto",children:[t.sampleItems.slice(0,3).map((c,x)=>s.jsxs("div",{className:"text-xs text-foreground truncate py-0.5 border-b border-border last:border-b-0",title:c,"data-test":"sample-item",children:[x+1,". ",c.slice(0,50),c.length>50?"...":""]},x)),t.itemCount>3&&s.jsxs("div",{className:"text-xs text-muted-foreground pt-1",children:["...and ",t.itemCount-3," more"]})]})]}),s.jsxs("div",{className:"mb-4",children:[s.jsx(Le,{htmlFor:"array-field-name",className:"text-xs text-foreground font-medium",children:"Field Name"}),s.jsx(Ye,{ref:m,id:"array-field-name",value:l,onChange:c=>n(c.target.value),placeholder:"e.g., items, comments, posts",className:"mt-1 text-foreground","data-test":"array-field-name-input"})]}),s.jsxs("div",{className:"mb-4",children:[s.jsx(Le,{className:"text-xs text-foreground font-medium",children:"Field Type"}),s.jsx("div",{className:"grid grid-cols-4 gap-1 mt-1","data-test":"array-field-type-selector",children:mr.map(c=>s.jsxs("button",{type:"button",onClick:()=>u(c.value),className:"flex flex-col items-center p-2 rounded border text-xs transition-colors",style:{borderColor:o===c.value?"#3b82f6":void 0,backgroundColor:o===c.value?"rgba(59, 130, 246, 0.15)":void 0,color:o===c.value?"#3b82f6":void 0,fontWeight:o===c.value?500:void 0},title:c.label,"data-test":"array-field-type","data-selected":o===c.value,children:[s.jsx("span",{className:"font-mono text-sm",children:c.icon}),s.jsx("span",{className:"text-[10px] mt-0.5",children:c.label})]},c.value))})]}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(ae,{variant:"ghost",size:"sm",onClick:h,"data-test":"array-dialog-skip",children:"Skip"}),s.jsx(ae,{variant:"outline",size:"sm",onClick:e,"data-test":"array-dialog-cancel",children:"Cancel"}),s.jsx(ae,{size:"sm",onClick:f,"data-test":"array-dialog-confirm",children:"Create Field"})]})]})})}function hr(g){const t=g.containerElement,a=t.getAttribute("data-test");if(a)return it(a);if(t.id)return it(t.id);const e=t.getAttribute("aria-label");if(e)return it(e);const l=Array.from(t.classList).filter(n=>!(/^[a-z]{1,3}\d{3,}$/i.test(n)||/^css-[a-z0-9]+$/i.test(n)||/^(xs|sm|md|lg|xl|2xl|hover|focus|active|disabled|group|peer|dark|motion|print):/.test(n)||/^(p|m|w|h|gap|space|flex|grid|items|justify|text|bg|border|rounded|shadow|font|leading|tracking|z|opacity|overflow|top|right|bottom|left|inset|max|min|aspect|col|row|order|self|place|content|shrink|grow|basis)-/.test(n)||/^(flex|grid|block|inline|hidden|absolute|relative|fixed|sticky|static|container|prose|truncate|overflow|underline|italic|uppercase|lowercase|capitalize|antialiased|subpixel)$/.test(n)||n.length<=3)).find(n=>/[a-z]{3,}/i.test(n));return l?it(l):"items"}function it(g){return g.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"").slice(0,30)||"items"}function pr(g,t){return t?g==="class"?t.split(/\s+/).filter(Boolean):[t]:[]}function gr(g,t,a=!0){const e=[];a&&e.push({id:"innerText",label:"innerText",icon:s.jsx(ns,{className:"w-3 h-3"}),data:{isInnerText:!0,isSelected:t}});for(const r of g){const n=pr(r.name,r.value).map((o,u)=>({id:`${r.name}:${u}`,label:o,data:{isValue:!0,parentAttr:r.name}}));e.push({id:r.name,label:r.name,children:n.length>0?n:void 0,data:{isAttribute:!0,fullValue:r.value}})}return e}const xr={single:"Single (#)",first:"First only",last:"Last only",all:"All","all-but-first":"All but first","all-but-last":"All but last",range:"Range"};function Nt({isOpen:g,fieldName:t,currentAttributes:a=[],attributes:e,onSelectAttributes:r,onClose:l,portalContainer:n,variant:o="extract",matchCount:u=0,currentMatchIndex:m=0,onMatchIndexChange:f,matchElements:h=[],onMatchIndexHover:c,currentMatchMode:x="single",currentMatchIndexEnd:C,onMatchModeChange:w}){const j=o==="filter",[k,F]=d.useState(new Set(a)),[S,L]=d.useState(!j&&(a.length===0||a.includes("innerText"))),[R,q]=d.useState(new Set),[H,Z]=d.useState(!1),[W,J]=d.useState(x),[ee,K]=d.useState(m),[E,Y]=d.useState(C??m),le=d.useRef(0);le.current+=1;const V=j?{selectedBg:"#dcfce7",checkBorder:"#16a34a",checkBg:"#16a34a",attrBg:"#bbf7d0",attrColor:"#166534"}:{selectedBg:"#e0e7ff",checkBorder:"#4f46e5",checkBg:"#4f46e5",attrBg:"#dbeafe",attrColor:"#1e40af"},re=d.useRef(!1);d.useEffect(()=>{if(g&&!re.current){re.current=!0;const P=new Set(a.filter(z=>z!=="innerText"));F(P),L(!j&&(a.length===0||a.includes("innerText"))),q(new Set),J(x),K(m),Y(C??m)}else g||(re.current=!1)},[g,a,j,x,m,C]);const he=d.useCallback((P,z)=>{z.stopPropagation(),q($=>{const N=new Set($);return N.has(P)?N.delete(P):N.add(P),N})},[]),{visibleAttributes:ve,hiddenAttributes:we}=d.useMemo(()=>{const P=[],z=[];for(const $ of e)R.has($.name)?z.push($):P.push($);return{visibleAttributes:P,hiddenAttributes:z}},[e,R]),ie=d.useMemo(()=>gr(ve,S,!j),[ve,S,j]),me=d.useMemo(()=>new Set(ve.map(P=>P.name)),[ve]),pe=d.useCallback(P=>{var z,$;(z=P.data)!=null&&z.isInnerText?L(N=>!N):($=P.data)!=null&&$.isAttribute&&F(N=>{const T=new Set(N);return T.has(P.id)?T.delete(P.id):T.add(P.id),T})},[k]),fe=d.useCallback(()=>{const P=[];!j&&S&&P.push("innerText"),P.push(...Array.from(k)),r(P),l()},[j,S,k,r,l]),Ee=d.useCallback(()=>{const P=new Set(ve.map(z=>z.name));F(P),j||L(!0)},[ve,j]),Re=d.useCallback(()=>{F(new Set),j||L(!1)},[j]),ne=d.useCallback(()=>{const P=new Set(a.filter(z=>z!=="innerText"));F(P),L(!j&&(a.length===0||a.includes("innerText"))),q(new Set)},[a,j]),Ie=d.useCallback(P=>{J(P),P==="range"?w==null||w(P,ee,E):P==="single"?w==null||w(P,m):w==null||w(P)},[ee,E,m,w]),ye=d.useCallback((P,z)=>{K(P),Y(z),W==="range"&&(w==null||w("range",P,z))},[W,w]),_e=d.useCallback(P=>{W==="single"?f==null||f(P):(J("single"),w==null||w("single",P))},[W,f,w]),ge=d.useCallback((P,z,$)=>{var B,G,oe;const N=(B=P.data)==null?void 0:B.isInnerText,T=(G=P.data)==null?void 0:G.isAttribute,O=(oe=P.data)==null?void 0:oe.isValue;let _=!1;return N?_=S:T&&(_=k.has(P.id)),O?s.jsx("div",{className:"flex items-center py-1 px-2 ml-6",style:{color:"#6b7280"},"data-test":"attribute-value",children:s.jsxs("span",{className:"text-xs font-mono truncate",title:P.label,children:['"',P.label,'"']})}):s.jsxs("div",{className:"flex items-center py-1.5 px-2 rounded cursor-pointer hover:bg-gray-100 group",style:{backgroundColor:_?V.selectedBg:"transparent"},onClick:()=>pe(P),"data-test":"attribute-option",children:[s.jsx("div",{className:"w-4 h-4 border rounded flex items-center justify-center mr-2 flex-shrink-0",style:{borderColor:_?V.checkBorder:"#d1d5db",backgroundColor:_?V.checkBg:"transparent"},children:_&&s.jsx(ct,{className:"w-3 h-3 text-white"})}),P.icon&&s.jsx("span",{className:"mr-2",children:P.icon}),s.jsx("span",{className:"font-mono text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:N?"#f3f4f6":V.attrBg,color:N?"#6b7280":V.attrColor},children:P.label}),N&&s.jsx("span",{className:"text-xs px-2 py-0.5 rounded ml-2",style:{backgroundColor:"#f3f4f6",color:"#6b7280"},children:"default"}),T&&s.jsx("button",{className:"ml-auto opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-gray-200 transition-opacity",onClick:Fe=>he(P.id,Fe),title:"Hide attribute","data-test":"attribute-hide",children:s.jsx(Pa,{className:"w-3 h-3 text-gray-500"})})]})},[S,k,pe,he,V]);return g?s.jsx(Oe,{isVisible:g,onClose:l,title:`Attributes: ${t}`,shouldCloseManually:!0,initialPosition:{x:window.innerWidth-350,y:100},portalContainer:n,showPinButton:!1,headerActions:s.jsxs(Je,{open:H,onOpenChange:Z,value:"",onValueChange:P=>{switch(Z(!1),P){case"select-all":Ee();break;case"clear-all":Re();break;case"reset":ne();break}},children:[s.jsx(Ve,{className:"h-6 w-6 px-0 border-0 shadow-none",style:{backgroundColor:"transparent"},"data-test":"attr-more-actions",hideChevron:!0,children:s.jsx(At,{className:"w-4 h-4",style:{color:"#6b7280"}})}),s.jsxs(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},"data-test":"attr-more-actions-options",container:n,children:[s.jsx(ce,{value:"select-all",style:{color:"#1f2937"},"data-test":"attr-action-select-all",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(ls,{className:"w-3 h-3"}),"Select All"]})}),s.jsx(ce,{value:"clear-all",style:{color:"#1f2937"},"data-test":"attr-action-clear-all",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Et,{className:"w-3 h-3"}),"Clear All"]})}),s.jsx(ce,{value:"reset",style:{color:"#1f2937"},"data-test":"attr-action-reset",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(It,{className:"w-3 h-3"}),"Reset"]})})]})]}),children:s.jsxs("div",{className:"p-2 flex flex-col",style:{backgroundColor:"#ffffff",minWidth:"280px"},"data-test":"attribute-popover-content",children:[j&&u>1&&s.jsxs("div",{className:"mb-2 pb-2 border-b flex flex-col gap-2",style:{borderColor:"#e5e7eb"},"data-test":"filter-match-section",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-xs",style:{color:"#6b7280"},children:[u," matches:"]}),s.jsxs(Je,{value:W,onValueChange:P=>Ie(P),children:[s.jsx(Ve,{className:"h-6 text-xs px-2 flex-1",style:{backgroundColor:"#f3f4f6",borderColor:"#d1d5db"},"data-test":"match-mode-select",children:s.jsx(ss,{})}),s.jsx(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},container:n,"data-test":"match-mode-options",children:Object.entries(xr).map(([P,z])=>s.jsx(ce,{value:P,style:{color:"#1f2937"},"data-test":"match-mode-option",children:z},P))})]})]}),W==="single"&&s.jsxs("div",{className:"flex items-center gap-1 flex-wrap","data-test":"single-mode-indices",children:[Array.from({length:Math.min(u,10)},(P,z)=>s.jsx("button",{onClick:()=>_e(z),onMouseEnter:()=>c==null?void 0:c(h[z]??null),onMouseLeave:()=>c==null?void 0:c(null),className:"w-5 h-5 text-xs rounded flex items-center justify-center",style:{backgroundColor:z===m?"#16a34a":"#f3f4f6",color:z===m?"#ffffff":"#374151"},title:`Select match ${z+1} of ${u}`,"data-test":"filter-match-index",children:z+1},z)),u>10&&s.jsxs("span",{className:"text-xs",style:{color:"#9ca3af"},children:["+",u-10]})]}),W==="range"&&s.jsxs("div",{className:"flex items-center gap-2","data-test":"range-mode-inputs",children:[s.jsx("span",{className:"text-xs",style:{color:"#6b7280"},children:"From:"}),s.jsx(Ye,{type:"number",min:1,max:u,value:ee+1,onChange:P=>{const z=Math.max(0,Math.min(u-1,parseInt(P.target.value,10)-1||0));ye(z,Math.max(z,E))},className:"h-6 w-12 text-xs text-center",style:{backgroundColor:"#f3f4f6",borderColor:"#d1d5db"},"data-test":"range-start-input"}),s.jsx("span",{className:"text-xs",style:{color:"#6b7280"},children:"to:"}),s.jsx(Ye,{type:"number",min:ee+1,max:u,value:E+1,onChange:P=>{const z=Math.max(ee,Math.min(u-1,parseInt(P.target.value,10)-1||0));ye(ee,z)},className:"h-6 w-12 text-xs text-center",style:{backgroundColor:"#f3f4f6",borderColor:"#d1d5db"},"data-test":"range-end-input"}),s.jsxs("span",{className:"text-xs",style:{color:"#9ca3af"},children:["(",E-ee+1," items)"]})]}),["first","last","all","all-but-first","all-but-last"].includes(W)&&s.jsxs("div",{className:"text-xs",style:{color:"#9ca3af"},"data-test":"mode-info",children:[W==="first"&&"Extracts only the first match",W==="last"&&"Extracts only the last match",W==="all"&&`Extracts all ${u} matches as an array`,W==="all-but-first"&&`Extracts ${u-1} matches (skips first)`,W==="all-but-last"&&`Extracts ${u-1} matches (skips last)`]})]}),s.jsxs("div",{className:"max-h-[300px] overflow-auto",children:[e.length===0?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center py-1.5 px-2 rounded cursor-pointer hover:bg-gray-100",style:{backgroundColor:S?"#e0e7ff":"transparent"},onClick:()=>L(!S),"data-test":"attribute-option-innerText",children:[s.jsx("div",{className:"w-4 h-4 border rounded flex items-center justify-center mr-2",style:{borderColor:S?"#4f46e5":"#d1d5db",backgroundColor:S?"#4f46e5":"transparent"},children:S&&s.jsx(ct,{className:"w-3 h-3 text-white"})}),s.jsx(ns,{className:"w-3 h-3 mr-2"}),s.jsx("span",{className:"font-mono text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:"#f3f4f6",color:"#6b7280"},children:"innerText"}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded ml-2",style:{backgroundColor:"#f3f4f6",color:"#6b7280"},children:"default"})]}),s.jsx("div",{className:"text-sm text-center py-4",style:{color:"#9ca3af"},"data-test":"no-attributes-message",children:"No other attributes found"})]}):s.jsx(as,{data:ie,defaultExpandedIds:me,enableEdit:!1,enableDelete:!1,enableDrag:!1,renderNode:ge,onItemClick:pe}),we.length>0&&s.jsxs("div",{className:"mt-3 pt-2 border-t",style:{borderColor:"#e5e7eb"},"data-test":"hidden-section",children:[s.jsxs("div",{className:"text-xs font-medium mb-2 flex items-center gap-1",style:{color:"#9ca3af"},children:[s.jsx(Yt,{className:"w-3 h-3"}),"Hidden (",we.length,")"]}),s.jsx("div",{className:"space-y-1",children:we.map(P=>s.jsxs("div",{className:"flex items-center py-1 px-2 rounded hover:bg-gray-100 group",style:{opacity:.6},"data-test":"hidden-attribute",children:[s.jsx("span",{className:"font-mono text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:"#f3f4f6",color:"#6b7280"},children:P.name}),s.jsx("button",{className:"ml-auto opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-gray-200 transition-opacity",onClick:z=>he(P.name,z),title:"Show attribute","data-test":"attribute-show",children:s.jsx(Yt,{className:"w-3 h-3 text-gray-500"})})]},P.name))})]})]}),s.jsx("div",{className:"mt-3 pt-2 border-t",style:{borderColor:"#e5e7eb"},children:s.jsx(ae,{onClick:fe,className:"w-full",size:"sm",style:j?{backgroundColor:V.checkBg}:void 0,"data-test":"attribute-confirm-button",children:j?`Add ${k.size} filter${k.size!==1?"s":""}`:`Confirm (${S?1:0} + ${k.size} selected)`})})]})}):null}function br({isOpen:g,fieldName:t,currentExcluded:a=[],children:e,onSelectExcluded:r,onClose:l,portalContainer:n}){const[o,u]=d.useState(new Set(a)),[m,f]=d.useState(!1),h=d.useRef(!1);d.useEffect(()=>{g&&!h.current?(h.current=!0,u(new Set(a))):g||(h.current=!1)},[g,a]);const c=d.useCallback(F=>{u(S=>{const L=new Set(S);return L.has(F)?L.delete(F):L.add(F),L})},[]),x=d.useCallback(()=>{r(Array.from(o)),l()},[o,r,l]),C=d.useCallback(()=>{u(new Set(e.map(F=>F.selector)))},[e]),w=d.useCallback(()=>{u(new Set)},[]),j=d.useCallback(()=>{u(new Set(a))},[a]),k=d.useCallback(F=>{let S=F.tagName;return F.classes.length>0&&(S+="."+F.classes.slice(0,2).join("."),F.classes.length>2&&(S+="...")),S},[]);return g?s.jsx(Oe,{isVisible:g,onClose:l,title:`Filter Children: ${t}`,shouldCloseManually:!0,initialPosition:{x:window.innerWidth-350,y:100},portalContainer:n,showPinButton:!1,headerActions:s.jsxs(Je,{open:m,onOpenChange:f,value:"",onValueChange:F=>{switch(f(!1),F){case"select-all":C();break;case"clear-all":w();break;case"reset":j();break}},children:[s.jsx(Ve,{className:"h-6 w-6 px-0 border-0 shadow-none",style:{backgroundColor:"transparent"},"data-test":"child-filter-more-actions",hideChevron:!0,children:s.jsx(At,{className:"w-4 h-4",style:{color:"#6b7280"}})}),s.jsxs(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},"data-test":"child-filter-more-actions-options",container:n,children:[s.jsx(ce,{value:"select-all",style:{color:"#1f2937"},"data-test":"child-filter-action-select-all",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(ls,{className:"w-3 h-3"}),"Exclude All"]})}),s.jsx(ce,{value:"clear-all",style:{color:"#1f2937"},"data-test":"child-filter-action-clear-all",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Et,{className:"w-3 h-3"}),"Include All"]})}),s.jsx(ce,{value:"reset",style:{color:"#1f2937"},"data-test":"child-filter-action-reset",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(It,{className:"w-3 h-3"}),"Reset"]})})]})]}),children:s.jsxs("div",{className:"p-2 flex flex-col",style:{backgroundColor:"#ffffff",minWidth:"280px"},"data-test":"child-filter-popover-content",children:[s.jsx("div",{className:"text-xs mb-2",style:{color:"#6b7280"},children:"Select child elements to exclude from text extraction:"}),s.jsx("div",{className:"max-h-[300px] overflow-auto",children:e.length===0?s.jsx("div",{className:"text-sm text-center py-4",style:{color:"#9ca3af"},"data-test":"no-children-message",children:"No child elements found"}):s.jsx("div",{className:"space-y-1",children:e.map(F=>{const S=o.has(F.selector);return s.jsxs("div",{className:"flex items-center py-1.5 px-2 rounded cursor-pointer hover:bg-gray-100 group",style:{backgroundColor:S?"#fee2e2":"transparent"},onClick:()=>c(F.selector),"data-test":"child-option",children:[s.jsx("div",{className:"w-4 h-4 border rounded flex items-center justify-center mr-2 flex-shrink-0",style:{borderColor:S?"#dc2626":"#d1d5db",backgroundColor:S?"#dc2626":"transparent"},children:S&&s.jsx(Be,{className:"w-3 h-3 text-white"})}),s.jsx("span",{className:"font-mono text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:S?"#fecaca":"#f3f4f6",color:S?"#991b1b":"#374151"},children:k(F)}),F.textPreview&&s.jsxs("span",{className:"ml-2 text-xs truncate max-w-[120px]",style:{color:"#9ca3af"},title:F.textPreview,children:['"',F.textPreview,'"']}),S&&s.jsx("span",{className:"ml-auto text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:"#fecaca",color:"#991b1b"},children:"excluded"})]},F.key)})})}),s.jsx("div",{className:"mt-3 pt-2 border-t",style:{borderColor:"#e5e7eb"},children:s.jsx(ae,{onClick:x,className:"w-full",size:"sm",style:{backgroundColor:"#dc2626"},"data-test":"child-filter-confirm-button",children:o.size===0?"Include All Children":`Exclude ${o.size} element${o.size!==1?"s":""}`})})]})}):null}function yr({isOpen:g,fieldName:t,values:a,onClose:e,portalContainer:r}){if(!g)return null;const l=n=>{if(n===null)return"null";if(n===void 0)return"undefined";if(typeof n=="string")return n;if(typeof n=="number"||typeof n=="boolean")return String(n);if(typeof n=="object")try{return JSON.stringify(n,null,2)}catch{return"[Object]"}return String(n)};return s.jsx(Oe,{isVisible:g,onClose:e,title:`Content: ${t}`,initialPosition:{x:window.innerWidth/2-200,y:100},initialSize:{width:400,height:300},portalContainer:r,resizable:!0,showPinButton:!1,children:s.jsx("div",{className:"p-3 h-full overflow-auto","data-test":"content-popover-body",style:{backgroundColor:"#ffffff"},children:a.length===0?s.jsx("div",{className:"text-sm italic",style:{color:"#9ca3af"},"data-test":"content-popover-empty",children:"No values extracted"}):a.length===1?s.jsx("div",{className:"text-sm whitespace-pre-wrap break-words font-mono",style:{color:"#1f2937",backgroundColor:"#f9fafb",padding:"8px",borderRadius:"4px"},"data-test":"content-popover-single-value",children:l(a[0])}):s.jsxs("div",{className:"space-y-2","data-test":"content-popover-values-list",children:[s.jsxs("div",{className:"text-xs font-medium mb-2",style:{color:"#6b7280"},"data-test":"content-popover-count",children:[a.length," values extracted"]}),a.map((n,o)=>s.jsxs("div",{className:"text-sm whitespace-pre-wrap break-words font-mono",style:{color:"#1f2937",backgroundColor:"#f9fafb",padding:"8px",borderRadius:"4px",borderLeft:"3px solid #3b82f6"},"data-test":"content-popover-value",children:[s.jsxs("span",{className:"text-xs font-medium mr-2",style:{color:"#6b7280"},children:["[",o,"]"]}),l(n)]},o))]})})})}function Sr({isOpen:g,fieldName:t,domContext:a,onSelectParent:e,onSelectSibling:r,onSelectChild:l,onHoverElement:n,onRevert:o,canRevert:u=!1,onClear:m,onClose:f,portalContainer:h,previousChildIndex:c,currentSelector:x,onApplyCustomSelector:C,selectorType:w,containerSelector:j,containerCandidates:k=[],onSelectContainer:F,onHoverContainer:S,initialViewMode:L="tree",matchCount:R=0,currentMatchIndex:q=0,onMatchIndexChange:H,matchElements:Z=[],onMatchIndexHover:W}){const[J,ee]=d.useState(L);d.useEffect(()=>{g&&ee(L)},[g,L]);const[K,E]=d.useState(()=>[{id:crypto.randomUUID(),value:x||"",isSelected:!0,matchCount:0,isValid:!0}]),Y=d.useRef([]),le=d.useRef(null),[V,re]=d.useState(null),[he,ve]=d.useState([]),[we,ie]=d.useState(null);d.useEffect(()=>{g&&(E([{id:crypto.randomUUID(),value:x||"",isSelected:!0,matchCount:0,isValid:!0}]),ee("tree"))},[g,x]);const me=d.useCallback(()=>{Y.current.forEach(N=>{N.style.outline="",N.style.outlineOffset="",N.style.background=""}),Y.current=[]},[]);d.useEffect(()=>()=>{me(),le.current&&clearTimeout(le.current)},[me]),d.useEffect(()=>{J==="tree"&&me()},[J,me]);const pe=d.useCallback(N=>{if(!N.trim())return{count:0,isValid:!0};if(N.startsWith(":scope"))return{count:0,isValid:!0};try{let T;if(w==="item"&&j){const O=document.querySelector(j);O?T=O.querySelectorAll(N):T=document.querySelectorAll(N)}else T=document.querySelectorAll(N);return{count:T.length,isValid:!0}}catch{return{count:0,isValid:!1}}},[w,j]);d.useEffect(()=>{J==="custom"&&E(N=>N.map(T=>{if(T.value.trim()){const O=pe(T.value);return{...T,matchCount:O.count,isValid:O.isValid}}return T}))},[J,pe]);const fe=d.useCallback(N=>{if(me(),!N.trim())return{count:0,isValid:!0};if(N.startsWith(":scope"))return{count:0,isValid:!0};try{let T;if(w==="item"&&j){const O=document.querySelector(j);O?T=O.querySelectorAll(N):T=document.querySelectorAll(N)}else T=document.querySelectorAll(N);return T.forEach(O=>{const _=O;_.style.outline="2px solid #06b6d4",_.style.outlineOffset="2px",_.style.background="#f800dd80",Y.current.push(_)}),{count:T.length,isValid:!0}}catch{return{count:0,isValid:!1}}},[me,w,j]),Ee=d.useCallback((N,T)=>{E(O=>O.map(_=>_.id===N?{..._,value:T}:_)),le.current&&clearTimeout(le.current),le.current=setTimeout(()=>{const O=fe(T);E(_=>_.map(B=>B.id===N?{...B,matchCount:O.count,isValid:O.isValid}:B))},150)},[fe]),Re=d.useCallback(N=>{const T=K.find(O=>O.id===N);if(T){const O=fe(T.value);E(_=>_.map(B=>B.id===N?{...B,matchCount:O.count,isValid:O.isValid}:B))}},[K,fe]),ne=d.useCallback(N=>{E(T=>T.map(O=>({...O,isSelected:O.id===N})))},[]),Ie=d.useCallback(()=>{E(N=>[...N,{id:crypto.randomUUID(),value:"",isSelected:!1,matchCount:0,isValid:!0}])},[]),ye=d.useCallback(N=>{E(T=>{var _;if(T.length<=1)return T;const O=T.filter(B=>B.id!==N);return(_=T.find(B=>B.id===N))!=null&&_.isSelected&&O.length>0&&(O[0].isSelected=!0),O})},[]),_e=d.useCallback(()=>{const N=K.find(T=>T.isSelected);N!=null&&N.value.trim()&&C&&(me(),C(N.value.trim()))},[K,C,me]),ge=d.useCallback(N=>{const T=K.find(O=>O.id===N);if(T!=null&&T.value.trim())try{const O=document.querySelector(T.value.trim());if(!O)return;const _=[];for(const B of Array.from(O.attributes))_.push({name:B.name,value:B.value});ve(_),re(N),ie(null)}catch{}},[K]),P=d.useCallback(N=>{if(!V)return;const T=K.find(O=>O.id===V);if(T!=null&&T.value.trim()){try{const O=document.querySelector(T.value.trim());if(!O)return;let _="";for(const B of N){if(B==="innerText")continue;const G=O.getAttribute(B);if(G)if(B==="class"){const oe=Se=>/^[a-zA-Z_-][a-zA-Z0-9_-]*$/.test(Se),Fe=G.split(/\s+/).filter(Se=>Se&&oe(Se)).slice(0,6);_+=Fe.map(Se=>`.${Se}`).join("")}else B==="id"?_+=`#${G}`:_+=`[${B}="${G}"]`}_&&(E(B=>B.map(G=>G.id===V?{...G,value:_}:G)),setTimeout(()=>{const B=fe(_);E(G=>G.map(oe=>oe.id===V?{...oe,matchCount:B.count,isValid:B.isValid}:oe))},50))}catch{}re(null),ve([])}},[V,K,fe]),z=d.useCallback(()=>{me(),f()},[me,f]);if(!g)return null;const $=K.find(N=>N.isSelected);return s.jsxs(Oe,{isVisible:g,onClose:z,title:`DOM Tree: ${t}`,shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth-450,y:150},initialSize:{width:400,height:420},portalContainer:h,headerActions:s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex rounded overflow-hidden border",style:{borderColor:"#d1d5db"},"data-test":"dom-tree-view-toggle",children:[s.jsx("button",{onClick:()=>ee("tree"),className:"px-2 py-1 flex items-center gap-1 text-xs transition-colors",style:{backgroundColor:J==="tree"?"#3b82f6":"#ffffff",color:J==="tree"?"#ffffff":"#6b7280"},title:"DOM Tree View","data-test":"dom-tree-view-tree",children:s.jsx($a,{className:"w-3 h-3"})}),k.length>0&&s.jsx("button",{onClick:()=>ee("containers"),className:"px-2 py-1 flex items-center gap-1 text-xs transition-colors",style:{backgroundColor:J==="containers"?"#3b82f6":"#ffffff",color:J==="containers"?"#ffffff":"#6b7280"},title:"Container Candidates","data-test":"dom-tree-view-containers",children:s.jsx(Da,{className:"w-3 h-3"})}),x&&s.jsx("button",{onClick:()=>ee("matches"),className:"px-2 py-1 flex items-center gap-1 text-xs transition-colors",style:{backgroundColor:J==="matches"?"#3b82f6":"#ffffff",color:J==="matches"?"#ffffff":"#6b7280"},title:"All Matches","data-test":"dom-tree-view-matches",children:s.jsx(Ma,{className:"w-3 h-3"})}),s.jsx("button",{onClick:()=>ee("custom"),className:"px-2 py-1 flex items-center gap-1 text-xs transition-colors",style:{backgroundColor:J==="custom"?"#3b82f6":"#ffffff",color:J==="custom"?"#ffffff":"#6b7280"},title:"Custom Selector View","data-test":"dom-tree-view-custom",children:s.jsx(La,{className:"w-3 h-3"})})]}),m&&s.jsx(ae,{variant:"ghost",size:"sm",onClick:m,className:"h-6 px-2",title:"Clear selector (set to no selector)","data-test":"dom-tree-clear-button",children:s.jsx(Zt,{className:"w-3 h-3"})}),J==="tree"&&u&&s.jsx(ae,{variant:"ghost",size:"sm",onClick:o,className:"h-6 px-2",title:"Revert to previous selection","data-test":"dom-tree-revert-button",children:s.jsx(rs,{className:"w-3 h-3"})})]}),children:[J==="tree"&&s.jsx("div",{className:"p-3 h-full overflow-auto font-mono text-xs",style:{backgroundColor:"#ffffff"},"data-test":"dom-tree-popover-content",children:a?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"mb-2 pb-2 border-b",style:{borderColor:"#e5e7eb"},"data-test":"dom-tree-parent",children:[s.jsx("div",{className:"text-xs font-medium mb-1",style:{color:"#6b7280"},children:"Parent - click to select"}),s.jsx(St,{node:a.parent,onClick:e,onHover:N=>n==null?void 0:n(N?"parent":null),"data-test":"dom-tree-parent-row"})]}),s.jsxs("div",{"data-test":"dom-tree-children",children:[s.jsxs("div",{className:"text-xs font-medium mb-1",style:{color:"#6b7280"},children:["Children (",a.siblings.length,") - click to select"]}),s.jsx("div",{className:"space-y-1 pl-4 border-l-2",style:{borderColor:"#e5e7eb"},children:a.siblings.map((N,T)=>{var O;return s.jsxs("div",{children:[s.jsx(St,{node:N,onClick:!N.isCaptured&&r?()=>r(T):void 0,onHover:_=>n==null?void 0:n(_?"sibling":null,T),"data-test":"dom-tree-sibling",matchCount:N.isCaptured?R:void 0,currentMatchIndex:N.isCaptured?q:void 0,onMatchIndexChange:N.isCaptured?H:void 0,matchElements:N.isCaptured?Z:void 0,onMatchIndexHover:N.isCaptured?W:void 0}),N.isCaptured&&c!==null&&c!==void 0&&((O=N.children)==null?void 0:O[c])&&s.jsxs("div",{className:"ml-4 mt-1 pl-4 border-l-2 space-y-1",style:{borderColor:"#93c5fd"},"data-test":"dom-tree-previous-child",children:[s.jsx("div",{className:"text-xs font-medium mb-1",style:{color:"#9ca3af"},children:"Previous selection - click to go back"}),s.jsx(St,{node:N.children[c],onClick:l?()=>l(c):void 0,onHover:_=>n==null?void 0:n(_?"child":null,c),"data-test":"dom-tree-previous-child-row"})]})]},N.key)})})]})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center","data-test":"dom-tree-not-found",children:[s.jsx("div",{className:"text-sm font-medium mb-2",style:{color:"#ef4444"},children:"Element not found in DOM"}),s.jsx("div",{className:"text-xs mb-4",style:{color:"#6b7280"},children:"The selector may be outdated or the element has been removed. Use the Clear button to remove this selector."}),m&&s.jsxs(ae,{variant:"outline",size:"sm",onClick:m,"data-test":"dom-tree-clear-inline",children:[s.jsx(Zt,{className:"w-3 h-3 mr-1"}),"Clear Selector"]})]})}),J==="containers"&&s.jsxs("div",{className:"p-3 h-full overflow-auto",style:{backgroundColor:"#ffffff"},"data-test":"containers-view-content",children:[s.jsx("div",{className:"text-xs font-medium mb-2",style:{color:"#6b7280"},children:"Container Candidates - click to select"}),k.length===0?s.jsx("div",{className:"text-center text-sm py-4",style:{color:"#9ca3af"},"data-test":"no-container-candidates",children:"No container candidates found"}):s.jsx("div",{className:"space-y-1","data-test":"container-candidates-list",children:k.map((N,T)=>s.jsx(Cr,{container:N,index:T,onClick:()=>F==null?void 0:F(N),onHover:O=>S==null?void 0:S(O?N.element:null)},T))})]}),J==="matches"&&x&&s.jsx(Nr,{selector:x,selectorType:w,containerSelector:j,highlightedElementsRef:Y,clearAllHighlights:me,onSelectMatch:C}),J==="custom"&&s.jsxs("div",{className:"p-3 h-full flex flex-col",style:{backgroundColor:"#ffffff"},"data-test":"custom-selector-content",children:[s.jsx("div",{className:"text-xs font-medium mb-2",style:{color:"#6b7280"},children:"Custom Selectors - type CSS selectors to test"}),w==="item"&&j&&s.jsxs("div",{className:"mb-2 px-2 py-1 rounded text-xs flex items-center gap-1 cursor-pointer",style:{backgroundColor:"#f0fdf4",border:"1px solid #86efac"},"data-test":"custom-selector-container-scope",onMouseEnter:()=>{me();try{const N=document.querySelector(j);N&&(N.style.outline="2px solid #06b6d4",N.style.outlineOffset="2px",N.style.background="#f800dd80",Y.current.push(N))}catch{}},onMouseLeave:()=>me(),children:[s.jsx("span",{style:{color:"#166534"},className:"shrink-0",children:"Scoped to:"}),s.jsx("span",{className:"truncate",style:{color:"#15803d",fontFamily:"monospace"},title:j,children:j})]}),s.jsx("div",{className:"flex-1 overflow-auto space-y-2","data-test":"custom-selector-inputs",children:K.map(N=>s.jsxs("div",{className:"flex items-start gap-2","data-test":"custom-selector-row",children:[s.jsx("button",{onClick:()=>ne(N.id),className:"mt-2 w-4 h-4 rounded-full border-2 flex items-center justify-center shrink-0 transition-colors",style:{borderColor:N.isSelected?"#3b82f6":"#d1d5db",backgroundColor:N.isSelected?"#3b82f6":"transparent"},title:"Select this selector","data-test":"custom-selector-radio",children:N.isSelected&&s.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:"#ffffff"}})}),s.jsx("div",{className:"flex-1 min-w-0",children:s.jsx(ja,{value:N.value,onChange:T=>Ee(N.id,T.target.value),onFocus:()=>Re(N.id),placeholder:"Enter CSS selector...",rows:1,className:"text-xs font-mono resize-none p-1",style:{borderColor:N.isValid?N.isSelected?"#3b82f6":"#d1d5db":"#ef4444",minHeight:"32px"},"data-test":"custom-selector-input"})}),s.jsx("div",{className:"mt-2 px-2 py-0.5 rounded text-xs shrink-0",style:{backgroundColor:N.isValid?N.matchCount>0?"#dcfce7":"#f3f4f6":"#fef2f2",color:N.isValid?N.matchCount>0?"#16a34a":"#6b7280":"#ef4444"},"data-test":"custom-selector-count",children:N.isValid?N.matchCount===1?"1 match":`${N.matchCount} matches`:"invalid"}),s.jsxs(Je,{open:we===N.id,onOpenChange:T=>ie(T?N.id:null),value:"",onValueChange:T=>{switch(ie(null),T){case"delete":ye(N.id);break;case"list-attributes":ge(N.id);break}},children:[s.jsx(Ve,{className:"mt-2 h-6 w-6 px-0 border-0 shadow-none shrink-0",style:{backgroundColor:"transparent",cursor:"pointer"},"data-test":"custom-selector-menu",hideChevron:!0,children:s.jsx(At,{className:"w-3 h-3",style:{color:"#6b7280"}})}),s.jsxs(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db",cursor:"auto",pointerEvents:"auto"},"data-test":"custom-selector-menu-options",container:h,children:[s.jsx(ce,{value:"list-attributes",style:{color:"#1f2937",cursor:"pointer",pointerEvents:"auto"},disabled:!N.value.trim()||!N.isValid||N.matchCount===0,"data-test":"custom-selector-action-list",children:s.jsxs("span",{className:"flex items-center gap-2",style:{pointerEvents:"none"},children:[s.jsx(is,{className:"w-3 h-3"}),"List attributes"]})}),s.jsx(ce,{value:"delete",style:{color:K.length<=1?"#d1d5db":"#ef4444",cursor:"pointer",pointerEvents:"auto"},disabled:K.length<=1,"data-test":"custom-selector-action-delete",children:s.jsxs("span",{className:"flex items-center gap-2",style:{pointerEvents:"none"},children:[s.jsx(cs,{className:"w-3 h-3"}),"Delete"]})})]})]})]},N.id))}),s.jsxs("button",{onClick:Ie,className:"mt-2 flex items-center gap-1 text-xs py-1 px-2 rounded transition-colors self-start",style:{color:"#3b82f6"},"data-test":"custom-selector-add",children:[s.jsx(vt,{className:"w-3 h-3"}),"Add selector"]}),s.jsx("div",{className:"mt-3 pt-3 border-t",style:{borderColor:"#e5e7eb"},children:s.jsxs(ae,{onClick:_e,disabled:!($!=null&&$.value.trim())||!($!=null&&$.isValid)||!C,className:"w-full",size:"sm","data-test":"custom-selector-apply",children:[s.jsx(ct,{className:"w-3 h-3 mr-1"}),"Apply Selected"]})})]}),s.jsx(Nt,{isOpen:V!==null,fieldName:"Element Attributes",currentAttributes:[],attributes:he,onSelectAttributes:P,onClose:()=>{re(null),ve([])},portalContainer:h,variant:"filter"})]})}function St({node:g,onClick:t,onHover:a,"data-test":e,matchCount:r=0,currentMatchIndex:l=0,onMatchIndexChange:n,matchElements:o=[],onMatchIndexHover:u}){const m=g.id?`#${g.id}`:"",f=!!t,h=g.isCaptured&&r>1,c=g.generatedSelector?g.generatedSelector.length>40?g.generatedSelector.slice(0,37)+"...":g.generatedSelector:null;return s.jsxs("div",{className:`flex items-start gap-2 py-1 px-2 rounded transition-colors ${f?"cursor-pointer":""}`,style:{backgroundColor:g.isCaptured?"#dbeafe":"transparent",border:g.isCaptured?"1px solid #3b82f6":"1px solid transparent"},onClick:t,onMouseEnter:x=>{f&&(x.currentTarget.style.backgroundColor="#f3f4f6"),a==null||a(!0)},onMouseLeave:x=>{f&&(x.currentTarget.style.backgroundColor=g.isCaptured?"#dbeafe":"transparent"),a==null||a(!1)},"data-test":e,children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-1 flex-wrap",children:[s.jsxs("span",{className:"font-bold",style:{color:"#7c3aed"},"data-test":"dom-node-tag",children:["<",g.tagName]}),m&&s.jsx("span",{className:"px-1 rounded",style:{backgroundColor:"#fef3c7",color:"#92400e"},"data-test":"dom-node-id",children:m}),s.jsx("span",{style:{color:"#7c3aed"},children:">"})]}),c&&s.jsxs("div",{className:"text-xs truncate mt-0.5",style:{color:"#16a34a"},title:`Selector: ${g.generatedSelector}`,"data-test":"dom-node-selector",children:["→ ",c]}),g.textPreview&&s.jsxs("div",{className:"text-xs truncate mt-0.5",style:{color:"#6b7280"},title:g.textPreview,"data-test":"dom-node-text",children:['"',g.textPreview,'"']})]}),h&&s.jsxs("div",{className:"flex items-center gap-1 shrink-0","data-test":"match-index-selector",children:[s.jsxs("span",{className:"text-xs",style:{color:"#6b7280"},children:[r,":"]}),Array.from({length:Math.min(r,10)},(x,C)=>s.jsx("button",{onClick:w=>{w.stopPropagation(),n==null||n(C)},onMouseEnter:()=>u==null?void 0:u(o[C]??null),onMouseLeave:()=>u==null?void 0:u(null),className:"text-xs px-1.5 py-0.5 rounded transition-colors",style:{backgroundColor:C===l?"#3b82f6":"#e5e7eb",color:C===l?"#ffffff":"#374151"},title:`Select match ${C+1} of ${r}`,"data-test":"match-index-button",children:C+1},C))]}),g.isCaptured&&s.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded shrink-0",style:{backgroundColor:"#3b82f6",color:"#ffffff"},"data-test":"dom-node-captured-badge",children:"captured"})]})}function Cr({container:g,index:t,onClick:a,onHover:e}){const r=(l,n=35)=>l.length<=n?l:l.slice(0,n-3)+"...";return s.jsxs("button",{type:"button",onClick:a,onMouseEnter:()=>e==null?void 0:e(!0),onMouseLeave:()=>e==null?void 0:e(!1),className:"w-full p-2 text-left rounded transition-colors flex items-start gap-2",style:{backgroundColor:"transparent"},onMouseOver:l=>{l.currentTarget.style.backgroundColor="#f3f4f6"},onMouseOut:l=>{l.currentTarget.style.backgroundColor="transparent"},"data-test":"container-candidate",children:[s.jsx("span",{className:"text-xs font-mono px-1.5 py-0.5 rounded shrink-0",style:{backgroundColor:jr(g.score),color:"#ffffff"},"data-test":"container-score",children:g.score}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("div",{className:"font-mono text-xs truncate",title:g.selector,"data-test":"container-selector",children:r(g.selector)}),s.jsxs("div",{className:"text-xs mt-0.5",style:{color:"#6b7280"},children:[g.childCount," children",g.dominantTag&&s.jsxs("span",{children:[" ","(",g.dominantTagCount," <",g.dominantTag,">, ",g.sameTagRatio,"%)"]})]})]})]})}function jr(g){return g>=80?"#16a34a":g>=60?"#2563eb":g>=40?"#ca8a04":"#dc2626"}function Nr({selector:g,selectorType:t,containerSelector:a,highlightedElementsRef:e,clearAllHighlights:r,onSelectMatch:l}){const[n,o]=d.useState([]);d.useEffect(()=>{if(g.startsWith(":scope")&&!a){o([]);return}try{let f;if(a){const c=document.querySelector(a);c?f=c.querySelectorAll(g):f=document.querySelectorAll(g)}else f=document.querySelectorAll(g);const h=Array.from(f).map(c=>{var w;const x=c,C=((w=x.textContent)==null?void 0:w.trim())||"";return{element:x,tagName:x.tagName.toLowerCase(),id:x.id||null,classes:Array.from(x.classList).slice(0,3),textPreview:C.slice(0,60)+(C.length>60?"...":"")}});o(h)}catch{o([])}},[g,t,a,l]);const u=d.useCallback(f=>{r(),f&&document.body.contains(f)&&(f.style.outline="2px solid #06b6d4",f.style.outlineOffset="2px",f.style.background="#f800dd80",e.current.push(f))},[r,e]),m=d.useCallback(f=>{if(f.scrollIntoView({behavior:"smooth",block:"center"}),l){let h=null;if(a){const j=document.querySelector(a);if(j){let k=f;for(;k&&k!==j;){if(k.parentElement===j){h=k;break}k=k.parentElement}}}const c=[];let x=f;const C=h||document.body;for(;x&&x!==C;){const j=x.tagName.toLowerCase(),k=Array.from(x.classList).filter(F=>F&&/^[a-zA-Z_-][a-zA-Z0-9_-]*$/.test(F));k.length>0?c.unshift(`${j}.${k[0]}`):c.unshift(j),x=x.parentElement}let w;if(c.length>0)h?w=`:scope > ${c.join(" > ")}`:w=c.join(" > ");else{const j=f.tagName.toLowerCase(),k=Array.from(f.classList).filter(F=>F&&/^[a-zA-Z_-][a-zA-Z0-9_-]*$/.test(F));w=k.length>0?j+k.slice(0,4).map(F=>`.${F}`).join(""):j}l(w)}},[l,a]);return s.jsxs("div",{className:"p-3 h-full overflow-auto",style:{backgroundColor:"#ffffff"},"data-test":"matches-view-content",children:[s.jsxs("div",{className:"text-xs font-medium mb-2",style:{color:"#6b7280"},children:[n.length," match",n.length!==1?"es":""," for selector"]}),s.jsx("div",{className:"mb-3 px-2 py-1 rounded text-xs font-mono truncate",style:{backgroundColor:"#f3f4f6",color:"#374151"},title:g,"data-test":"matches-selector",children:g}),t==="item"&&a&&s.jsxs("div",{className:"mb-2 px-2 py-1 rounded text-xs flex items-center gap-1",style:{backgroundColor:"#f0fdf4",border:"1px solid #86efac"},"data-test":"matches-container-scope",children:[s.jsx("span",{style:{color:"#166534"},className:"shrink-0",children:"Scoped to:"}),s.jsx("span",{className:"truncate font-mono",style:{color:"#15803d"},title:a,children:a})]}),n.length===0?s.jsx("div",{className:"text-center text-sm py-4",style:{color:"#9ca3af"},"data-test":"no-matches",children:"No elements found"}):s.jsx("div",{className:"space-y-1","data-test":"matches-list",children:n.map((f,h)=>s.jsxs("button",{type:"button",onClick:()=>m(f.element),onMouseEnter:()=>u(f.element),onMouseLeave:()=>u(null),className:"w-full p-2 text-left rounded transition-colors",style:{backgroundColor:"transparent"},onMouseOver:c=>{c.currentTarget.style.backgroundColor="#f3f4f6"},onMouseOut:c=>{c.currentTarget.style.backgroundColor="transparent"},"data-test":"match-item",children:[s.jsxs("div",{className:"flex items-center gap-1 text-xs font-mono",children:[s.jsxs("span",{className:"font-bold",style:{color:"#7c3aed"},"data-test":"match-tag",children:["<",f.tagName,">"]}),f.id&&s.jsxs("span",{className:"px-1 rounded",style:{backgroundColor:"#fef3c7",color:"#92400e"},"data-test":"match-id",children:["#",f.id]}),s.jsxs("span",{className:"text-xs ml-auto",style:{color:"#9ca3af"},"data-test":"match-index",children:["[",h+1,"]"]})]}),f.classes.length>0&&s.jsxs("div",{className:"text-xs mt-0.5 truncate",style:{color:"#6b7280"},"data-test":"match-classes",children:[".",f.classes.join("."),f.classes.length<f.element.classList.length&&"..."]}),f.textPreview&&s.jsxs("div",{className:"text-xs mt-0.5 truncate",style:{color:"#9ca3af"},title:f.textPreview,"data-test":"match-text",children:['"',f.textPreview,'"']})]},h))})]})}const vr=`{
  "title": "[data-test='page-title']",
  "description": ".description",
  "price": "[data-test='product-price']"
}`,Fr=`{
  "name": "Product Schema",
  "fields": [
    {
      "name": "title",
      "type": "string",
      "mapping": { "selector": "[data-test='title']" }
    },
    {
      "name": "price",
      "type": "string",
      "mapping": {
        "selector": "[data-test='price']",
        "extractAttributes": ["data-value"]
      }
    }
  ]
}`,wr=`{
  "name": "Product List",
  "fields": [
    {
      "id": "products-array",
      "name": "products",
      "type": "array",
      "parentId": null,
      "containerSelector": "[data-test='product-list']",
      "itemSelector": ".product-item"
    },
    { "name": "name", "type": "string", "parentId": "products-array", "mapping": { "selector": "[data-test='product-name']" } },
    { "name": "url", "type": "string", "parentId": "products-array", "mapping": { "selector": "[data-test='product-name']", "extractAttributes": ["href"] } },
    { "name": "price", "type": "string", "parentId": "products-array", "mapping": { "selector": "[data-test='product-price']", "extractAttributes": ["data-value"] } },
    { "name": "rating", "type": "string", "parentId": "products-array", "mapping": { "selector": "[data-test='product-rating']", "extractAttributes": ["data-rating"] } },
    { "name": "image", "type": "string", "parentId": "products-array", "mapping": { "selector": "[data-test='product-image']", "extractAttributes": ["data-src"] } }
  ]
}`;function kr({isOpen:g,onImport:t,onClose:a,portalContainer:e}){const[r,l]=d.useState(""),[n,o]=d.useState(null),[u,m]=d.useState(null),f=()=>{if(o(null),!r.trim()){o("Please enter JSON");return}try{const x=JSON.parse(r),C=t(x);C.success?(l(""),a()):o(C.error||"Import failed")}catch(x){o(x instanceof Error?x.message:"Invalid JSON")}},h=()=>{l(""),o(null),m(null),a()},c=x=>{l({simple:vr,full:Fr,products:wr}[x]),m(x),o(null)};return g?s.jsx(Oe,{isVisible:g,onClose:h,title:"Import Schema",shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth/2-200,y:window.innerHeight/4},initialSize:{width:450,height:400},portalContainer:e,children:s.jsxs("div",{className:"flex flex-col h-full p-3 gap-3","data-test":"import-dialog-content",children:[s.jsxs("div",{className:"flex gap-2 flex-wrap","data-test":"import-example-buttons",children:[s.jsx("button",{onClick:()=>c("simple"),className:"text-xs px-2 py-1 rounded transition-colors",style:{backgroundColor:u==="simple"?"#dbeafe":"#f3f4f6",color:u==="simple"?"#1d4ed8":"#4b5563"},"data-test":"import-example-simple",children:"Simple Format"}),s.jsx("button",{onClick:()=>c("full"),className:"text-xs px-2 py-1 rounded transition-colors",style:{backgroundColor:u==="full"?"#dbeafe":"#f3f4f6",color:u==="full"?"#1d4ed8":"#4b5563"},"data-test":"import-example-full",children:"Full Schema"}),s.jsx("button",{onClick:()=>c("products"),className:"text-xs px-2 py-1 rounded transition-colors font-medium",style:{backgroundColor:u==="products"?"#dcfce7":"#f0fdf4",color:u==="products"?"#15803d":"#166534",border:"1px solid #86efac"},"data-test":"import-example-products",children:"🛒 Product List (Demo)"})]}),s.jsx("textarea",{autoFocus:!0,value:r,onChange:x=>{l(x.target.value),o(null)},placeholder:"Paste JSON here...",className:"flex-1 min-h-0 p-2 text-xs font-mono rounded border resize-none",style:{backgroundColor:"#f9fafb",borderColor:n?"#ef4444":"#d1d5db",color:"#1f2937"},"data-test":"import-json-input"}),n&&s.jsxs("div",{className:"flex items-center gap-2 p-2 rounded text-xs",style:{backgroundColor:"#fef2f2",color:"#dc2626"},"data-test":"import-error",children:[s.jsx(Ra,{className:"w-4 h-4 shrink-0"}),s.jsx("span",{children:n})]}),s.jsxs("div",{className:"flex justify-end gap-2","data-test":"import-actions",children:[s.jsx(ae,{variant:"outline",size:"sm",onClick:h,"data-test":"import-cancel-button",children:"Cancel"}),s.jsxs(ae,{size:"sm",onClick:f,className:"gap-1","data-test":"import-confirm-button",children:[s.jsx(Tt,{className:"w-3 h-3"}),"Import"]})]})]})}):null}function Ar(g){if(g.length===0)return"";const t=new Map,a=[];for(const n of g)t.set(n.id,n);for(const n of g)n.parentId===null&&a.push(n);const e=n=>{switch(n){case"array":return"[]";case"object":return"{}";case"parentSelector":return"{1}";case"number":return"#";case"boolean":return"?";default:return""}},r=[],l=(n,o)=>{const u="  ".repeat(o),m=e(n.type);r.push(`${u}${n.name}${m}`);const f=g.filter(h=>h.parentId===n.id).sort((h,c)=>h.order-c.order);for(const h of f)l(h,o+1)};a.sort((n,o)=>n.order-o.order);for(const n of a)l(n,0);return r.join(`
`)}const Er=[{id:"string",label:"Text",icon:"T",value:""},{id:"number",label:"Number",icon:"#",value:"#"},{id:"boolean",label:"Boolean",icon:"?",value:"?"},{id:"array",label:"Array",icon:"[]",value:"[]"},{id:"parentSelector",label:"Parent Selector",icon:"{1}",value:"{1}"},{id:"object",label:"Object",icon:"{}",value:"{}"}];function es(g){var e;const t=g.split(`
`),a=[];for(const r of t){if(r.trim()==="")continue;const l=((e=r.match(/^(\s*)/))==null?void 0:e[1])||"",n=(l.match(/\t/g)||[]).length,o=l.replace(/\t/g,"").length,u=n+Math.floor(o/2),m=r.trim();if(!m)continue;let f="string",h=m;m.endsWith("[]")?(f="array",h=m.slice(0,-2)):m.endsWith("{}")?(f="object",h=m.slice(0,-2)):m.endsWith("{1}")?(f="parentSelector",h=m.slice(0,-3)):m.endsWith("#")?(f="number",h=m.slice(0,-1)):m.endsWith("?")&&(f="boolean",h=m.slice(0,-1)),a.push({name:h,depth:u,type:f})}return a}function Ir(g){const t=[],a=[];for(const e of g){for(;a.length>0&&a[a.length-1].depth>=e.depth;)a.pop();const r=a.length>0?a[a.length-1].index:null,l=t.length;t.push({name:e.name,parentIndex:r,type:e.type}),a.push({depth:e.depth,index:l})}return t}const Tr=`products[]
  name
  price#
author{1}
  firstName
  lastName`;function Pr({initialFields:g,onApply:t,onCancel:a}){const[e,r]=d.useState(()=>g&&g.length>0?Ar(g):""),l=d.useCallback(()=>{const u=es(e),m=Ir(u);t(m)},[e,t]),n=e.trim()?es(e).length:0,o=d.useMemo(()=>({triggerChar:"/",items:Er,header:"Select type",emptyMessage:"No matches",widthClass:"w-48",zIndex:ts.draggablePopoverDropdown}),[]);return s.jsxs("div",{className:"flex flex-col h-full p-2","data-test":"list-mode-panel",children:[s.jsxs("div",{className:"flex-1 min-h-0 relative",children:[s.jsx(Na,{value:e,onChange:u=>r(u.target.value),placeholder:Tr,className:"w-full h-full resize-none font-mono text-sm",showBuiltInPopover:!1,triggerPopover:o,"data-test":"list-mode-textarea"}),s.jsx("div",{className:"absolute top-1 right-1","data-test":"list-mode-info",children:s.jsx(va,{children:s.jsxs(Fa,{children:[s.jsx(wa,{asChild:!0,children:s.jsx("button",{type:"button",className:"p-1 rounded hover:bg-muted/80 text-muted-foreground hover:text-foreground transition-colors","data-test":"list-mode-info-button",children:s.jsx(Oa,{className:"w-3.5 h-3.5"})})}),s.jsx(ka,{side:"left",className:"max-w-xs","data-test":"list-mode-info-tooltip",children:s.jsxs("div",{className:"text-xs space-y-1",children:[s.jsx("p",{className:"font-medium",children:"Type hints (suffix):"}),s.jsxs("div",{className:"font-mono text-[10px] space-y-0.5",children:[s.jsxs("p",{children:[s.jsx("span",{className:"text-blue-500",children:"[]"})," = array"]}),s.jsxs("p",{children:[s.jsx("span",{className:"text-blue-500",children:"{1}"})," = parent selector"]}),s.jsxs("p",{children:[s.jsx("span",{className:"text-blue-500",children:"{}"})," = object"]}),s.jsxs("p",{children:[s.jsx("span",{className:"text-blue-500",children:"#"})," = number"]}),s.jsxs("p",{children:[s.jsx("span",{className:"text-blue-500",children:"?"})," = boolean"]})]}),s.jsx("p",{className:"text-muted-foreground pt-1",children:"Indentation = nesting"})]})})]})})})]}),s.jsxs("div",{className:"flex items-center justify-between mt-2 pt-2 border-t","data-test":"list-mode-actions",children:[s.jsxs("span",{className:"text-xs text-muted-foreground","data-test":"field-count",children:[n," field",n!==1?"s":""," detected"]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(ae,{variant:"ghost",size:"sm",onClick:a,className:"h-7","data-test":"list-mode-cancel",children:[s.jsx(Be,{className:"w-3 h-3 mr-1"}),"Cancel"]}),s.jsxs(ae,{size:"sm",onClick:l,disabled:n===0,className:"h-7","data-test":"list-mode-apply",children:[s.jsx(ct,{className:"w-3 h-3 mr-1"}),"Apply"]})]})]})]})}const Ct="watcher:custom-captures";function $r({isOpen:g,onClose:t,onLoad:a,portalContainer:e}){const[r,l]=d.useState([]),n=d.useCallback(()=>{try{const c=localStorage.getItem(Ct);if(c){const x=JSON.parse(c);l(x)}else l([])}catch(c){console.warn("[SavedManager] Failed to load captures:",c),l([])}},[]);d.useEffect(()=>{g&&n()},[g,n]);const o=d.useCallback(c=>{try{const x=localStorage.getItem(Ct);if(x){const w=JSON.parse(x).filter(j=>j.id!==c);localStorage.setItem(Ct,JSON.stringify(w)),l(w),D.success("Capture deleted")}}catch{D.error("Failed to delete capture")}},[]),u=d.useCallback(c=>{c.schema?(a(c.schema),t(),D.success(`Loaded "${c.name}"`)):D.error("This capture has no schema to load")},[a,t]),m=c=>new Date(c).toLocaleString(),f=c=>{var x,C;return((C=(x=c.schema)==null?void 0:x.fields)==null?void 0:C.length)??0},h=(c,x=40)=>c.length<=x?c:c.slice(0,x-3)+"...";return s.jsx(Oe,{isVisible:g,onClose:t,title:"Saved Captures",shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth/2-200,y:100},initialSize:{width:400,height:400},portalContainer:e,children:s.jsxs("div",{className:"flex flex-col h-full p-2","data-test":"saved-captures-manager",children:[r.length===0?s.jsx("div",{className:"flex-1 flex items-center justify-center text-sm text-muted-foreground","data-test":"no-captures-message",children:"No saved captures yet"}):s.jsx("div",{className:"flex-1 overflow-auto space-y-2","data-test":"captures-list",children:r.map(c=>s.jsx("div",{className:"border rounded-lg p-3 hover:bg-muted/50 transition-colors","data-test":"capture-item",children:s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("h4",{className:"font-medium text-sm truncate","data-test":"capture-name",children:c.name||"Untitled"}),s.jsxs("p",{className:"text-xs text-muted-foreground truncate flex items-center gap-1",title:c.url,"data-test":"capture-url",children:[s.jsx(Ba,{className:"w-3 h-3 shrink-0"}),h(c.url)]}),s.jsxs("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:[s.jsx("span",{"data-test":"capture-date",children:m(c.capturedAt)}),s.jsxs("span",{"data-test":"capture-field-count",children:[f(c)," fields"]})]})]}),s.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[s.jsx(ae,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0",onClick:()=>u(c),disabled:!c.schema,title:"Load this capture","data-test":"load-capture-button",children:s.jsx(Tt,{className:"w-3.5 h-3.5"})}),s.jsx(ae,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 text-destructive hover:text-destructive",onClick:()=>o(c.id),title:"Delete this capture","data-test":"delete-capture-button",children:s.jsx(cs,{className:"w-3.5 h-3.5"})})]})]})},c.id))}),s.jsxs("div",{className:"pt-2 border-t mt-2 text-xs text-muted-foreground","data-test":"captures-count",children:[r.length," saved capture",r.length!==1?"s":""]})]})})}const Dr=[{value:"balanced",label:"Balanced",description:"5+ children, 80% same tag"},{value:"strict",label:"Strict",description:"10+ children, deep limit"},{value:"relaxed",label:"Relaxed",description:"3+ children, any tags"}],Mr=[{value:"both",label:"Both",description:"Container + sibling detection"},{value:"container",label:"Container",description:"Find parent containers"},{value:"sibling",label:"Sibling",description:"Find broader selectors"}];function Lr({isOpen:g,containers:t,isScanning:a,hasExistingSelector:e,onScan:r,onScanFromElement:l,onSelect:n,onCancel:o,onHighlight:u,portalContainer:m}){const[f,h]=d.useState("balanced"),[c,x]=d.useState("both"),[C,w]=d.useState(null);d.useEffect(()=>{g&&(w(null),x("both"),h("balanced"))},[g]),d.useEffect(()=>{if(!g)return;const S=L=>{L.key==="Escape"&&o()};return document.addEventListener("keydown",S),()=>document.removeEventListener("keydown",S)},[g,o]);const j=d.useCallback(S=>{u==null||u((S==null?void 0:S.element)??null)},[u]),k=d.useCallback(S=>{w(C===S?null:S)},[C]),F=(S,L=40)=>S.length<=L?S:S.slice(0,L-3)+"...";return s.jsx(Oe,{isVisible:g,onClose:o,title:"Find Containers",shouldCloseManually:!0,initialPosition:{x:window.innerWidth/2-200,y:window.innerHeight/4},className:"!w-[400px]",portalContainer:m,children:s.jsxs("div",{className:"p-3","data-test":"container-picker-dialog",children:[e?s.jsxs("div",{className:"mb-4","data-test":"container-mode-selector",children:[s.jsx(Le,{className:"text-xs text-foreground font-medium",children:"Detection mode:"}),s.jsx("div",{className:"grid grid-cols-3 gap-1 mt-1",children:Mr.map(S=>s.jsxs("button",{type:"button",onClick:()=>x(S.value),className:"flex flex-col items-center p-2 rounded border text-xs transition-colors",style:{borderColor:c===S.value?"#3b82f6":void 0,backgroundColor:c===S.value?"rgba(59, 130, 246, 0.15)":void 0,color:c===S.value?"#3b82f6":void 0},title:S.description,"data-test":"mode","data-selected":c===S.value,children:[s.jsx("span",{className:"font-medium",children:S.label}),s.jsx("span",{className:"text-[10px] mt-0.5 opacity-70",children:S.description})]},S.value))})]}):s.jsxs("div",{className:"mb-4","data-test":"container-preset-selector",children:[s.jsx(Le,{className:"text-xs text-foreground font-medium",children:"Detection preset:"}),s.jsx("div",{className:"grid grid-cols-3 gap-1 mt-1",children:Dr.map(S=>s.jsxs("button",{type:"button",onClick:()=>h(S.value),className:"flex flex-col items-center p-2 rounded border text-xs transition-colors",style:{borderColor:f===S.value?"#3b82f6":void 0,backgroundColor:f===S.value?"rgba(59, 130, 246, 0.15)":void 0,color:f===S.value?"#3b82f6":void 0},title:S.description,"data-test":"preset","data-selected":f===S.value,children:[s.jsx("span",{className:"font-medium",children:S.label}),s.jsx("span",{className:"text-[10px] mt-0.5 opacity-70",children:S.description})]},S.value))})]}),s.jsxs(ae,{variant:"outline",size:"sm",onClick:()=>{e&&l?l(c):r(f)},disabled:a,className:"w-full mb-4","data-test":"scan-button",children:[s.jsx(kt,{className:`w-4 h-4 mr-2 ${a?"animate-spin":""}`}),a?"Scanning...":e?"Scan current":"Scan Page"]}),t.length>0&&s.jsxs("div",{"data-test":"container-results",children:[s.jsxs(Le,{className:"text-xs text-foreground font-medium",children:["Found ",t.length," container",t.length!==1?"s":"",":"]}),s.jsx("div",{className:"mt-1 bg-muted/50 rounded max-h-[300px] overflow-auto",children:t.map((S,L)=>s.jsxs("div",{className:"border-b border-border last:border-b-0","data-test":"container-item",children:[s.jsxs("button",{type:"button",onClick:()=>k(L),onMouseEnter:()=>j(S),onMouseLeave:()=>j(null),className:"w-full p-2 text-left hover:bg-muted/80 transition-colors flex items-start gap-2",children:[C===L?s.jsx(wt,{className:"w-4 h-4 mt-0.5 shrink-0 text-muted-foreground"}):s.jsx(Ft,{className:"w-4 h-4 mt-0.5 shrink-0 text-muted-foreground"}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"text-xs font-mono px-1.5 py-0.5 rounded",style:{backgroundColor:Rr(S.score),color:"#fff"},"data-test":"container-score",children:S.score}),s.jsx("span",{className:"text-sm font-mono truncate",title:S.selector,"data-test":"container-selector",children:F(S.selector)})]}),s.jsxs("div",{className:"text-xs text-muted-foreground mt-0.5",children:[S.childCount," children",S.dominantTag&&s.jsxs("span",{children:[" ","(",S.dominantTagCount," <",S.dominantTag,">,"," ",S.sameTagRatio,"% same)"]})]})]})]}),C===L&&s.jsx("div",{className:"px-8 pb-2 text-xs","data-test":"container-details",children:s.jsxs("div",{className:"bg-background rounded p-2 border border-border",children:[s.jsx("div",{className:"font-mono break-all mb-2",children:S.selector}),s.jsx("div",{className:"flex gap-2",children:s.jsx(ae,{size:"sm",onClick:()=>n(S),"data-test":"select-container-button",children:"Use This Container"})})]})})]},L))})]}),t.length===0&&!a&&s.jsx("div",{className:"text-center text-sm text-muted-foreground py-4","data-test":"no-results",children:e?'Click "Scan current" to find alternative selectors':'Click "Scan Page" to find containers'}),s.jsx("div",{className:"flex justify-end gap-2 mt-4",children:s.jsx(ae,{variant:"outline",size:"sm",onClick:o,"data-test":"cancel-button",children:"Cancel"})})]})})}function Rr(g){return g>=80?"#16a34a":g>=60?"#2563eb":g>=40?"#ca8a04":"#dc2626"}const jt="watcher:custom-captures";function Wr({onCaptureComplete:g,autoStart:t=!1,portalContainer:a}){const e=d.useRef(null),[r,l]=d.useState(null),[n,o]=d.useState("selectors"),[u,m]=d.useState(new Map),f=d.useMemo(()=>e.current?e.current.getCaptureFacade().extractSelectors():{},[r==null?void 0:r.schema.fields,r==null?void 0:r.capturedData]),h=d.useMemo(()=>!e.current||n!=="content"?{}:e.current.getCaptureFacade().applyCapture(),[n,r==null?void 0:r.schema.updatedAt]),c=d.useMemo(()=>new Set(u.keys()),[u]),[x,C]=d.useState(!1),[w,j]=d.useState(null),[k,F]=d.useState(""),[S,L]=d.useState(null),[R,q]=d.useState(null),[H,Z]=d.useState(null),[W,J]=d.useState(null),[ee,K]=d.useState(null),[E,Y]=d.useState(!1),[le,V]=d.useState(null),[re,he]=d.useState(null),[ve,we]=d.useState(!1),[ie,me]=d.useState(""),[pe,fe]=d.useState([]),[Ee,Re]=d.useState([]),[ne,Ie]=d.useState(!1),[ye,_e]=d.useState(""),[ge,P]=d.useState(void 0),[z,$]=d.useState([]),[N,T]=d.useState([]),[O,_]=d.useState(!1),[B,G]=d.useState(""),[oe,Fe]=d.useState([]),[Se,We]=d.useState([]),[ot,ze]=d.useState(!1),[A,Ce]=d.useState(""),[xe,be]=d.useState(null),[de,je]=d.useState(null),[qe,dt]=d.useState(null),[se,$t]=d.useState(null),[ds,Dt]=d.useState([]),[us,Mt]=d.useState(!1),[ms,fs]=d.useState(""),[hs,ps]=d.useState([]),[gs,Lt]=d.useState(!1),[xs,Rt]=d.useState(!1),[bs,ut]=d.useState(!1),[ys,He]=d.useState([]),[Ss,Ge]=d.useState(!1),[mt,ft]=d.useState(null),[Cs,Ot]=d.useState(!1),Ze=d.useRef(null),[js,Bt]=d.useState(!1),ke=d.useRef([]);d.useEffect(()=>{const i=new nr;e.current=i,i.setFieldNamePromptCallback((v,I)=>new Promise(M=>{j(v),F(I),q(()=>M),C(!0)})),i.setArrayPatternConfirmCallback(v=>new Promise(I=>{V(v),he(()=>I),Y(!0)}));const p=i.onStateChange(v=>{l({...v})});l(i.getState());let b=!1;const y=localStorage.getItem(jt);if(y)try{const v=JSON.parse(y),I=window.location.href,M=v.find(U=>U.url===I&&U.schema);M!=null&&M.schema&&i.getCaptureFacade().importSchema(M.schema).success&&(b=!0,console.log("Restored saved capture from localStorage"))}catch(v){console.warn("[CustomCapture] Failed to load from localStorage:",v)}return t&&(i.startCapture("mapped",b),b||D.info("Custom Capture activated",{description:"Click elements to map them to fields. Press ESC to finish."})),()=>{p(),i.destroy()}},[t]),d.useEffect(()=>{const i=p=>{!e.current||!r||p.key==="Escape"&&(r.phase==="capturing"||r.phase==="selecting-field")&&e.current.finishCapture()};return document.addEventListener("keydown",i),()=>document.removeEventListener("keydown",i)},[r]);const Ns=d.useCallback(()=>{if(e.current){const i=e.current.getSchema().fields.length>0;e.current.startCapture("mapped",i),D.info("Custom Capture activated",{description:"Click elements to map them to fields. Press ESC to finish."})}},[]),et=d.useCallback(i=>i.replace(/\[([^\]]+)=\\"([^"\\]*)\\"\]/g,"[$1='$2']"),[]),vs=d.useCallback(async()=>{if(e.current)try{const i=e.current.exportDataOnly(),p=et(i);await navigator.clipboard.writeText(p),g==null||g(p),D.success("Content copied to clipboard!")}catch{D.error("Failed to copy to clipboard")}},[g,et]),Fs=d.useCallback(async()=>{if(e.current)try{const i=JSON.stringify(f,null,2),p=et(i);await navigator.clipboard.writeText(p),D.success("Selectors copied to clipboard!")}catch{D.error("Failed to copy to clipboard")}},[f,et]),ws=d.useCallback(i=>{if(!e.current)return{success:!1,error:"Session not initialized"};const b=e.current.getCaptureFacade().importSchema(i);return b.success?(D.success("Schema imported successfully!"),m(new Map)):D.error(`Import failed: ${b.error}`),b},[]),ks=d.useCallback(i=>{if(!e.current)return;e.current.getCaptureFacade().importSchema(i).success&&m(new Map)},[]),As=d.useCallback(async()=>{if(!e.current)return;const p=await e.current.getCaptureFacade().loadFromSiteConfig();p.success?(D.success(`Loaded schema from ${p.siteName}!`),m(new Map)):D.error(p.error||"Failed to load site config")},[]),Es=d.useCallback(()=>{if(!e.current)return;const i=e.current.exportDataOnly(),p=e.current.getSchema(),b=new Blob([i],{type:"application/json"}),y=URL.createObjectURL(b),v=document.createElement("a");v.href=y,v.download=`${p.name||"custom-capture"}-${Date.now()}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(y),D.success("JSON file downloaded!")},[]),Is=d.useCallback(()=>{if(!e.current)return;const i=e.current.getSchema(),b=e.current.getCaptureFacade().extractData(),y={name:i.name,fields:i.fields},v={id:i.id,name:i.name,url:window.location.href,capturedAt:Date.now(),data:b,schema:y},I=localStorage.getItem(jt),M=I?JSON.parse(I):[],U=M.findIndex(X=>X.id===v.id);U>=0?M[U]=v:M.push(v),localStorage.setItem(jt,JSON.stringify(M)),D.success("Capture saved to localStorage!")},[]),Ts=d.useCallback(()=>{var i;(i=e.current)==null||i.closePreview()},[]),Ps=d.useCallback(()=>{var i;(i=e.current)==null||i.resumeCapture(),D.info("Resumed capture mode",{description:"Click elements to capture. Press ESC to finish."})},[]),$s=d.useCallback(()=>{var i;(i=e.current)==null||i.cancel()},[]),Ds=d.useCallback(()=>{e.current&&(j(null),F(""),L(null),Z(null),J(null),K(null),q(null),C(!0))},[]),Ms=d.useCallback(i=>{e.current&&(j(null),F(""),L(null),Z(i),J(null),K(null),q(null),C(!0))},[]),Ls=d.useCallback(i=>{if(!e.current)return;const p=e.current.getCaptureFacade().getField(i);p&&(j(null),F(""),L(null),Z(p.parentId),J(null),K(i),q(null),C(!0))},[]),Rs=d.useCallback(i=>{if(!e.current)return;const p=e.current.getCaptureFacade().getField(i);p&&(j(null),F(""),L(null),Z(p.parentId),J(i),K(null),q(null),C(!0))},[]),Os=d.useCallback((i,p,b)=>{if(!e.current)return;const v=e.current.getCaptureFacade().getField(i);j(null),F(""),L({id:i,name:p,type:b,containerSelector:v==null?void 0:v.containerSelector,itemSelector:v==null?void 0:v.itemSelector}),q(null),C(!0)},[]),_t=d.useCallback(i=>{!e.current||!r||(r.mode!=="mapped"&&e.current.setMode("mapped"),e.current.selectFieldForMapping(i),D.info("Click an element to map to this field"))},[r]),Bs=d.useCallback((i,p)=>{!e.current||!r||(r.mode!=="mapped"&&e.current.setMode("mapped"),e.current.selectFieldForMapping(i,p),D.info(`Click an element to assign as ${p==="container"?"_container":"_item"} selector`))},[r]),zt=d.useCallback(i=>{var p;if(R)R(i);else if(i&&e.current)if(S){const b={name:i.name,type:i.type};i.type==="array"&&(i.containerSelector&&(b.containerSelector=i.containerSelector),i.itemSelector&&(b.itemSelector=i.itemSelector)),e.current.updateField(S.id,b)}else{const b=e.current.getCaptureFacade();if(H){const v=b.getField(H);if(v&&v.type!=="array"&&v.type!=="parentSelector"){const I={type:"parentSelector"};(p=v.mapping)!=null&&p.selector&&(I.containerSelector=v.mapping.selector),e.current.updateField(H,I)}}const y=e.current.addField(i.name,i.type,H);if(i.type==="array"&&(i.containerSelector||i.itemSelector)){const v={};i.containerSelector&&(v.containerSelector=i.containerSelector),i.itemSelector&&(v.itemSelector=i.itemSelector),e.current.updateField(y.id,v)}if(ee||W){const v=ee||W,I=b.getField(v);if(I){const M=b.getSchema().fields.filter(X=>X.parentId===H).sort((X,ue)=>X.order-ue.order),U=M.findIndex(X=>X.id===v);if(U!==-1){const X=ee?I.order:I.order+1;e.current.updateField(y.id,{order:X}),M.forEach((ue,Te)=>{var Pe;ue.id!==y.id&&(ee?Te>=U:Te>U)&&((Pe=e.current)==null||Pe.updateField(ue.id,{order:ue.order+1}))})}}}e.current.setMode("mapped"),e.current.selectFieldForMapping(y.id),D.info("Click an element to map to this field")}C(!1),q(null),j(null),L(null),Z(null),J(null),K(null)},[R,S,H,ee,W]),qt=d.useCallback(i=>{re&&re(i),Y(!1),he(null),V(null)},[re]),_s=d.useCallback((i,p)=>{var b;(b=e.current)==null||b.updateField(i,{name:p})},[]),zs=d.useCallback(i=>{var p;(p=e.current)==null||p.removeField(i)},[]),qs=d.useCallback(i=>{var p;(p=e.current)==null||p.updateFromTree(i)},[]),Us=d.useCallback(i=>{if(!e.current)return;const p=e.current.getCaptureFacade(),b=[];for(const y of i){const v=y.parentIndex!==null?b[y.parentIndex]:null,I=p.addField(y.name,y.type,v);b.push(I.id)}e.current.setMode("mapped"),D.success(`Created ${i.length} fields from list`)},[]),Ws=d.useCallback(()=>{var i;(i=e.current)==null||i.setMode("mapped")},[]),Js=d.useCallback(i=>{var I;if(!e.current)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(i);if(!b)return;const y=p.getFieldElementAttributes(b.id),v=((I=b.mapping)==null?void 0:I.extractAttributes)??[];me(i),fe(y),Re(v),we(!0)},[]),Vs=d.useCallback(i=>{if(!e.current||!ie)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(ie);if(!b)return;p.setFieldExtractAttributes(b.id,i);const y=i.length===0?"innerText":i.map(v=>`@${v}`).join(", ");D.success(`Extracting ${y} for "${ie}"`)},[ie]),Xs=d.useCallback(i=>{var M,U;if(!e.current)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(i);if(!((M=b==null?void 0:b.mapping)!=null&&M.selector))return;const y=p.getFieldElement(b.id);if(!y)return;const v=[];Array.from(y.children).forEach((X,ue)=>{var te;if(!(X instanceof HTMLElement))return;const Te=X.tagName.toLowerCase(),Pe=Array.from(X.classList);let Ae;X.id?Ae=`:scope > #${X.id}`:Ae=`:scope > :nth-child(${ue+1})`;let Ue="";for(const $e of Array.from(X.childNodes))if($e.nodeType===Node.TEXT_NODE){const Ne=(te=$e.textContent)==null?void 0:te.trim();if(Ne){Ue=Ne.slice(0,30)+(Ne.length>30?"...":"");break}}v.push({selector:Ae,tagName:Te,classes:Pe,textPreview:Ue,key:`child-${ue}`})});const I=((U=b.mapping)==null?void 0:U.excludeChildren)??[];G(i),Fe(v),We(I),_(!0)},[]),Gs=d.useCallback(i=>{if(!e.current||!B)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(B);b!=null&&b.mapping&&(p.updateField(b.id,{mapping:{...b.mapping,excludeChildren:i}}),i.length===0?D.success(`Including all children for "${B}"`):D.success(`Excluding ${i.length} child element(s) from "${B}"`))},[B]),Ks=d.useCallback((i,p)=>{var U;if(!e.current)return;const b=e.current.getCaptureFacade(),y=b.getFieldByName(i);if(!y)return;if(n==="content"){const X=[],ue=[];let Te=y;for(;Te.parentId;){const te=b.getField(Te.parentId);if(!te)break;ue.unshift(te),Te=te}let Pe=null,Ae=-1;for(let te=0;te<ue.length;te++){const $e=ue[te];if(($e.type==="array"||$e.type==="parentSelector")&&$e.name in h){Pe=$e,Ae=te;break}}const Ue=[];if(Ae>=0)for(let te=Ae+1;te<ue.length;te++)Ue.push(ue[te].name);if(Ue.push(i),Pe){const te=h[Pe.name];if(Array.isArray(te)){const $e=(Ne,Xt)=>{if(Xt.length===0){Ne!==void 0&&X.push(Ne);return}const[st,...Gt]=Xt;if(Array.isArray(Ne))for(const at of Ne)at&&typeof at=="object"&&st in at&&$e(at[st],Gt);else Ne&&typeof Ne=="object"&&st in Ne&&$e(Ne[st],Gt)};for(const Ne of te)$e(Ne,Ue)}}else{const te=h[i];te!==void 0&&(Array.isArray(te)?X.push(...te):X.push(te))}fs(i),ps(X),Mt(!0);return}let v;p==="container"?v=y.containerSelector:p==="item"?y.containerSelector&&y.itemSelector?v=`${y.containerSelector} ${y.itemSelector}`:v=y.itemSelector:v=(U=y.mapping)==null?void 0:U.selector;let I;v!=null&&v.startsWith(":scope")?I=b.getFieldDomContext(y.id):I=b.getFieldDomContextBySelector(v),Ce(i),be(I),je(null),dt(null),$t(p??null);let M=null;if(p==="container")M=y.containerSelector?document.querySelector(y.containerSelector):null;else if(p==="item")if(y.containerSelector&&y.itemSelector){const X=`${y.containerSelector} ${y.itemSelector}`;M=document.querySelector(X)}else y.itemSelector&&(M=document.querySelector(y.itemSelector));else M=b.getFieldElement(y.id);if(M){const X=b.findContainerAncestors(M,{minChildren:2,sameTag:!0,maxDepth:15});Dt(X)}else Dt([]);ze(!0)},[n,h]),Ys=d.useCallback(()=>{if(!e.current||!A||!xe)return;const i=e.current.getCaptureFacade(),p=i.getFieldByName(A);if(!p)return;const b=xe.capturedIndex,y=i.remapFieldToParent(p.id,se);if(y){de||je(y),u.has(A)||m(I=>{const M=new Map(I);return M.set(A,y),M}),dt(b);const v=i.getFieldDomContext(p.id);be(v),D.success(`Updated "${A}" to parent element`)}else D.error("Failed to select parent element")},[A,de,u,xe,se]),Zs=d.useCallback(i=>{if(!e.current||!A)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(A);if(!b)return;const y=p.remapFieldToSibling(b.id,i,se);if(y){de||je(y),u.has(A)||m(I=>{const M=new Map(I);return M.set(A,y),M});const v=p.getFieldDomContext(b.id);be(v),D.success(`Updated "${A}" to new element`)}else D.error("Failed to update element selection")},[A,de,u,se]),Qs=d.useCallback(i=>{if(!e.current||!A)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(A);if(!b)return;if(p.remapFieldToSibling(b.id,i)){dt(null);const v=p.getFieldDomContext(b.id);be(v),D.success(`Updated "${A}" to child element`)}else D.error("Failed to select child element")},[A]),Hs=d.useCallback(()=>{if(!e.current||!A||!de)return;const i=e.current.getCaptureFacade(),p=i.getFieldByName(A);if(!p)return;i.restoreFieldMapping(p.id,de);const b=i.getFieldDomContext(p.id);be(b),je(null),m(y=>{const v=new Map(y);return v.delete(A),v}),D.success(`Reverted "${A}" to original element`)},[A,de]),ea=d.useCallback(()=>{if(!e.current||!A)return;const i=e.current.getCaptureFacade(),p=i.getFieldByName(A);p&&(se==="container"?(i.updateField(p.id,{containerSelector:void 0}),D.success(`Cleared _container for "${A}"`)):se==="item"?(i.updateField(p.id,{itemSelector:void 0}),D.success(`Cleared _item for "${A}"`)):(i.updateField(p.id,{mapping:void 0,containerSelector:void 0,itemSelector:void 0}),D.success(`Cleared selector for "${A}"`)),ze(!1),be(null),je(null),$t(null))},[A,se]),ta=d.useCallback(i=>{if(!e.current||!A)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(A);b&&(se==="container"?(p.updateField(b.id,{containerSelector:i}),D.success(`Updated container selector for "${A}"`)):se==="item"?(p.updateField(b.id,{itemSelector:i}),D.success(`Updated item selector for "${A}"`)):(p.updateField(b.id,{mapping:{...b.mapping,selector:i}}),D.success(`Updated selector for "${A}"`)),ze(!1))},[A,se]),sa=d.useCallback(()=>{var b,y;if(!e.current||!A)return"";const p=e.current.getCaptureFacade().getFieldByName(A);return p?se==="container"?p.customContainerSelector??p.containerSelector??"":se==="item"?p.customItemSelector??p.itemSelector??"":((b=p.mapping)==null?void 0:b.customSelector)??((y=p.mapping)==null?void 0:y.selector)??"":""},[A,se]),aa=d.useCallback(()=>{if(!e.current||!A)return null;const i=e.current.getCaptureFacade(),p=i.getFieldByName(A);if(!p)return null;if(se==="item")return p.customContainerSelector??p.containerSelector??null;if(p.parentId&&!se){const b=i.getField(p.parentId);if(b){const y=b.containerSelector,v=b.itemSelector;if(y&&v)return`${y} ${v}`;if(y)return y}}return p.customContainerSelector??p.containerSelector??null},[A,se]),ra=d.useCallback(i=>{if(!e.current||!A)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(A);b&&(p.updateField(b.id,{containerSelector:i.selector}),D.success(`Container updated to "${i.selector}"`),ze(!1))},[A]),Ut=d.useCallback(i=>{for(const{element:p,originalOutline:b}of ke.current)p.style.outline=b;ke.current=[],i&&(ke.current.push({element:i,originalOutline:i.style.outline,originalBackground:i.style.background}),i.style.outline="3px solid #3b82f6")},[]),Wt=d.useCallback(i=>{var v;if(!e.current)return;const p=e.current.getCaptureFacade(),b=p.getSchema().fields.find(I=>I.id===i);ft(i),ut(!0);const y=(b==null?void 0:b.containerSelector)||((v=b==null?void 0:b.mapping)==null?void 0:v.selector);if(y)try{const I=document.querySelector(y);if(I){Ze.current=I,Ot(!0),Ge(!0),setTimeout(()=>{const M=p.findContainersFromElement(I,"both");He(M),Ge(!1)},50);return}}catch{}Ze.current=null,Ot(!1),He([])},[]),na=d.useCallback(i=>{e.current&&(Ge(!0),setTimeout(()=>{const b=e.current.getCaptureFacade().scanContainersWithPreset(i);He(b),Ge(!1)},50))},[]),la=d.useCallback(i=>{!e.current||!Ze.current||(Ge(!0),setTimeout(()=>{const b=e.current.getCaptureFacade().findContainersFromElement(Ze.current,i);He(b),Ge(!1)},50))},[]),ia=d.useCallback(i=>{if(!e.current||!mt)return;e.current.getCaptureFacade().updateField(mt,{containerSelector:i.selector}),D.success(`Container set to "${i.selector}"`),ut(!1),ft(null)},[mt]),ca=d.useCallback(i=>{if(!e.current)return;const p=u.get(i);if(!p)return;const b=e.current.getCaptureFacade(),y=b.getFieldByName(i);if(y){if(b.restoreFieldMapping(y.id,p),m(v=>{const I=new Map(v);return I.delete(i),I}),A===i){je(null);const v=b.getFieldDomContext(y.id);be(v)}D.success(`Reverted "${i}" to original element`)}},[u,A]),oa=d.useCallback((i,p)=>{var U;if(!e.current)return;const b=e.current.getCaptureFacade(),y=b.getFieldByName(i);if(!y)return;const v=b.getFieldElementAttributes(y.id,p);let I=[];p==="container"?I=y.containerSelectorFilters??[]:p==="item"?I=y.itemSelectorFilters??[]:I=((U=y.mapping)==null?void 0:U.selectorFilters)??[];const M=I.map(X=>{const ue=/^\[([^=]+)=/.exec(X);return ue?ue[1]:""}).filter(Boolean);_e(i),P(p),$(v),T(M),Ie(!0)},[]),da=d.useCallback(i=>{if(!e.current||!ye)return;const p=e.current.getCaptureFacade(),b=p.getFieldByName(ye);if(!b)return;const y=i.filter(v=>v!=="innerText").map(v=>{const I=z.find(M=>M.name===v);return I?`[${v}="${I.value}"]`:""}).filter(Boolean);ge==="container"?(p.updateField(b.id,{containerSelectorFilters:y}),D.success(`Set ${y.length} filter(s) on _container`)):ge==="item"?(p.updateField(b.id,{itemSelectorFilters:y}),D.success(`Set ${y.length} filter(s) on _item`)):b.mapping&&(p.updateField(b.id,{mapping:{...b.mapping,selectorFilters:y}}),D.success(`Set ${y.length} filter(s) on selector`))},[ye,ge,z]),ua=d.useCallback((i,p)=>{if(Ie(!1),!e.current)return;const b=e.current.getCaptureFacade(),y=b.getFieldByName(i);if(!y)return;const I=b.getFieldElementAttributes(y.id,p).find(U=>U.name==="class");if(!(I!=null&&I.value)){D.info("No classes found on element");return}const M=`[class="${I.value}"]`;if(p==="container"){const U=y.containerSelectorFilters??[];if(U.includes(M)){D.info("Class filter already exists");return}b.updateField(y.id,{containerSelectorFilters:[...U,M]}),D.success("Added class filter to _container")}else if(p==="item"){const U=y.itemSelectorFilters??[];if(U.includes(M)){D.info("Class filter already exists");return}b.updateField(y.id,{itemSelectorFilters:[...U,M]}),D.success("Added class filter to _item")}else if(y.mapping){const U=y.mapping.selectorFilters??[];if(U.includes(M)){D.info("Class filter already exists");return}b.updateField(y.id,{mapping:{...y.mapping,selectorFilters:[...U,M]}}),D.success("Added class filter to selector")}},[]),ma=d.useCallback((i,p)=>{if(!e.current)return;const b=e.current.getCaptureFacade(),y=b.getFieldByName(i);y&&(p==="container"?(b.updateField(y.id,{containerSelector:void 0}),D.success("Cleared _container selector")):p==="item"?(b.updateField(y.id,{itemSelector:void 0}),D.success("Cleared _item selector")):y.mapping&&(b.updateField(y.id,{mapping:{...y.mapping,selector:""}}),D.success(`Cleared selector for "${i}"`)))},[]),fa=d.useCallback((i,p,b)=>{if(!e.current)return;const y=e.current.getCaptureFacade(),v=y.getFieldByName(i);if(v){if(b==="container"){const I=[...v.containerSelectorFilters??[]];I.splice(p,1),y.updateField(v.id,{containerSelectorFilters:I}),D.success("Removed filter from _container")}else if(b==="item"){const I=[...v.itemSelectorFilters??[]];I.splice(p,1),y.updateField(v.id,{itemSelectorFilters:I}),D.success("Removed filter from _item")}else if(v.mapping){const I=[...v.mapping.selectorFilters??[]];I.splice(p,1),y.updateField(v.id,{mapping:{...v.mapping,selectorFilters:I}}),D.success(`Removed filter from "${i}"`)}}},[]),ht=d.useCallback((i,p,b)=>{if(!e.current)return;const y=e.current.getCaptureFacade(),v=y.getFieldByName(i);v&&(y.setFieldMatchIndex(v.id,p,b),D.success(`Selected match ${p+1}`))},[]),ha=d.useCallback((i,p,b,y,v)=>{if(!e.current)return;const I=e.current.getCaptureFacade(),M=I.getFieldByName(i);if(!M)return;I.setFieldMatchMode(M.id,p,b,y);const U={single:`Single match #${(b??0)+1}`,first:"First match only",last:"Last match only",all:"All matches","all-but-first":"All but first","all-but-last":"All but last",range:`Range ${(b??0)+1}-${(y??b??0)+1}`};D.success(`Match mode: ${U[p]}`)},[]),pt=d.useCallback(i=>{for(const{element:p,originalOutline:b,originalBackground:y}of ke.current)p.style.outline=b,p.style.background=y;ke.current=[],i&&(ke.current.push({element:i,originalOutline:i.style.outline,originalBackground:i.style.background}),i.style.outline="3px solid #3b82f6",i.style.outlineOffset="2px",i.style.background="#bfdbfe80")},[]),gt=d.useCallback((i,p,b=!0)=>e.current?e.current.getCaptureFacade().getFieldSelectorMatches(i,p,b):[],[]),pa=d.useCallback((i,p)=>{for(const{element:y,originalOutline:v,originalBackground:I}of ke.current)y.style.outline=v,y.style.background=I;if(ke.current=[],!i)return;let b=[];if(p&&e.current){const y=e.current.getCaptureFacade(),v=y.getFieldByName(p)??y.getSchema().fields.find(I=>I.id===p);v!=null&&v.parentId&&(b=y.getFieldSelectorMatches(v.id))}if(b.length===0&&!i.startsWith(":scope"))try{b=Array.from(document.querySelectorAll(i))}catch{}b.forEach(y=>{ke.current.push({element:y,originalOutline:y.style.outline,originalBackground:y.style.background}),y.style.outline="2px solid #06b6d4",y.style.outlineOffset="2px",y.style.background="#f800dd80"})},[]),ga=d.useCallback((i,p)=>{for(const{element:I,originalOutline:M,originalBackground:U}of ke.current)I.style.outline=M,I.style.background=U;if(ke.current=[],!i||!e.current||!A)return;const b=e.current.getCaptureFacade(),y=b.getFieldByName(A);if(!y)return;const v=b.getFieldElement(y.id,se??void 0);if(v)try{let I=null;if(i==="parent")I=v.parentElement;else if(i==="sibling"&&p!==void 0){const M=v.parentElement;M&&(I=M.children[p])}else i==="child"&&p!==void 0&&(I=v.children[p]);I&&(ke.current.push({element:I,originalOutline:I.style.outline,originalBackground:I.style.background}),I.style.outline="2px solid #06b6d4",I.style.outlineOffset="2px",I.style.background="#f800dd80")}catch{}},[A,se]);if(!r)return null;const Jt=r.schema.fields.length,xa=r.schema.fields.filter(i=>i.mapping).length,Vt=r.phase==="capturing"||r.phase==="selecting-field"||r.phase==="preview",tt=r.phase==="capturing"||r.phase==="selecting-field",ba=tt?`Custom Capture (${xa}/${Jt})`:`Preview (${Jt} fields)`;return s.jsxs("div",{className:"custom-capture-controller","data-test":"custom-capture-controller",children:[!Vt&&s.jsxs(ae,{onClick:Ns,variant:"outline","data-test":"start-custom-capture-button",children:[s.jsx(_a,{className:"w-4 h-4 mr-2"}),"Custom Capture"]}),s.jsx(Oe,{isVisible:Vt,onClose:Ts,title:ba,shouldCloseManually:!0,resizable:!0,initialPosition:{x:window.innerWidth-620,y:20},initialSize:{width:600,height:500},portalContainer:a,showPinButton:!1,headerActions:s.jsxs(s.Fragment,{children:[tt&&s.jsxs(s.Fragment,{children:[s.jsxs(Je,{value:r.mode,onValueChange:i=>{var b;(b=e.current)==null||b.setMode(i);const p={quick:"Click elements to add fields automatically",mapped:"Select a field first, then click element to map",list:"Type an indented list to scaffold your schema"};D.info(`Switched to ${i} mode`,{description:p[i]})},children:[s.jsx(Ve,{className:"h-6 w-24 text-xs",style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},"data-test":"capture-mode-select",children:s.jsx(ss,{})}),s.jsxs(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},"data-test":"capture-mode-options",container:a,children:[s.jsx(ce,{value:"mapped",style:{color:"#1f2937"},"data-test":"capture-mode-mapped",children:s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(is,{className:"w-3 h-3"}),"Mapped"]})}),s.jsx(ce,{value:"quick",style:{color:"#1f2937"},"data-test":"capture-mode-quick",children:s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(za,{className:"w-3 h-3"}),"Quick"]})}),s.jsx(ce,{value:"list",style:{color:"#1f2937"},"data-test":"capture-mode-list",children:s.jsxs("span",{className:"flex items-center gap-1",children:[s.jsx(qa,{className:"w-3 h-3"}),"List"]})})]})]}),s.jsx(ae,{variant:"ghost",size:"sm",onClick:Ds,className:"h-6 px-2",title:"Add Field","data-test":"add-field-button",children:s.jsx(vt,{className:"w-3 h-3"})})]}),!tt&&s.jsx(ae,{variant:"ghost",size:"sm",onClick:Ps,className:"h-6 px-2",title:"Resume Capture","data-test":"resume-capture-button",children:s.jsx(It,{className:"w-3 h-3"})}),s.jsxs(Je,{open:js,onOpenChange:Bt,value:"",onValueChange:i=>{switch(Bt(!1),i){case"scan-containers":if(e.current){const b=e.current.getCaptureFacade().addField("items","array");Wt(b.id)}break;case"load-site-config":As();break;case"save":Is();break;case"manage-saved":Rt(!0);break;case"download":Es();break;case"clear":$s();break}},children:[s.jsx(Ve,{className:"h-6 w-6 px-0 border-0 shadow-none",style:{backgroundColor:"transparent"},"data-test":"more-actions-select",hideChevron:!0,children:s.jsx(Ua,{className:"w-4 h-4",style:{color:"#6b7280"}})}),s.jsxs(Xe,{style:{backgroundColor:"#ffffff",color:"#1f2937",borderColor:"#d1d5db"},"data-test":"more-actions-options",container:a,children:[s.jsx(ce,{value:"scan-containers",style:{color:"#1f2937"},"data-test":"action-scan-containers",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(kt,{className:"w-3 h-3"}),"Scan Containers"]})}),s.jsx(ce,{value:"load-site-config",style:{color:"#1f2937"},"data-test":"action-load-site-config",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Wa,{className:"w-3 h-3"}),"Load Site Config"]})}),s.jsx(ce,{value:"save",style:{color:"#1f2937"},"data-test":"action-save",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Ja,{className:"w-3 h-3"}),"Save to Storage"]})}),s.jsx(ce,{value:"manage-saved",style:{color:"#1f2937"},"data-test":"action-manage-saved",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Va,{className:"w-3 h-3"}),"Manage Saved"]})}),s.jsx(ce,{value:"download",style:{color:"#1f2937"},"data-test":"action-download",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Xa,{className:"w-3 h-3"}),"Download JSON"]})}),s.jsx(ce,{value:"clear",style:{color:"#ef4444"},"data-test":"action-clear",children:s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(Et,{className:"w-3 h-3"}),"Clear All"]})})]})]})]}),className:"opacity-95",children:s.jsxs("div",{className:"flex flex-col h-full","data-test":"custom-capture-content",children:[s.jsx("div",{className:`${r.mode==="list"?"flex-[3]":"flex-1"} min-h-0 overflow-auto border-b`,"data-test":"schema-panel-container",children:r.mode==="list"?s.jsx(Pr,{initialFields:r.schema.fields,onApply:Us,onCancel:Ws}):s.jsx(lr,{schema:r.schema,selectedFieldId:r.selectedFieldId,mode:r.mode,onFieldSelect:_t,onFieldUpdate:_s,onFieldEdit:Os,onFieldDelete:zs,onReorder:qs,onAddChild:Ms,onAddSiblingBefore:Ls,onAddSiblingAfter:Rs,queryRoot:a??void 0})}),s.jsxs("div",{className:`${r.mode==="list"?"flex-[1]":"flex-1"} min-h-0 flex flex-col`,"data-test":"preview-panel-container",children:[s.jsxs("div",{className:"flex border-b shrink-0 sticky top-0 z-10",style:{backgroundColor:"#ffffff"},"data-test":"preview-mode-tabs",children:[s.jsxs("button",{onClick:()=>o("selectors"),className:"flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1",style:{backgroundColor:n==="selectors"?"#ffffff":"#f3f4f6",color:n==="selectors"?"#2563eb":"#6b7280",borderBottom:n==="selectors"?"2px solid #2563eb":"2px solid transparent"},"data-test":"preview-tab-selectors",children:["Selectors",n==="selectors"&&s.jsxs(s.Fragment,{children:[s.jsx("span",{onClick:i=>{i.stopPropagation(),Fs()},className:"p-0.5 rounded hover:bg-blue-100 transition-colors",title:"Copy selectors","data-test":"copy-selectors-button",children:s.jsx(Qt,{className:"w-3 h-3"})}),s.jsx("span",{onClick:i=>{i.stopPropagation(),Lt(!0)},className:"p-0.5 rounded hover:bg-blue-100 transition-colors",title:"Import/Replace schema","data-test":"import-selectors-button",children:s.jsx(Tt,{className:"w-3 h-3"})})]})]}),s.jsxs("button",{onClick:()=>o("content"),className:"flex-1 px-3 py-2 text-xs font-medium transition-colors flex items-center justify-center gap-1",style:{backgroundColor:n==="content"?"#ffffff":"#f3f4f6",color:n==="content"?"#2563eb":"#6b7280",borderBottom:n==="content"?"2px solid #2563eb":"2px solid transparent"},"data-test":"preview-tab-content",children:["Content",n==="content"&&s.jsx("span",{onClick:i=>{i.stopPropagation(),vs()},className:"p-0.5 rounded hover:bg-blue-100 transition-colors",title:"Copy content","data-test":"copy-content-button",children:s.jsx(Qt,{className:"w-3 h-3"})})]})]}),s.jsx("div",{className:"flex-1 min-h-0 overflow-auto",children:s.jsx(or,{schema:r.schema,previewMode:n,selectors:f,content:h,onConfigClick:Js,onValueClick:Ks,onValueHover:pa,onRevertClick:ca,revertableFields:c,onFieldSelect:_t,onArraySelectorClick:Bs,onSelectorFilterClick:oa,onSelectorFilterDoubleClick:ua,onScanContainersClick:Wt,onChildFilterClick:Xs,onClearSelector:ma,onClearFilter:fa,onMatchIndexChange:ht,onMatchIndexHover:pt,getMatchElements:gt,portalContainer:a})})]}),tt&&s.jsx("div",{className:"p-2 bg-muted/50 text-xs text-muted-foreground border-t","data-test":"keyboard-hints",children:r.phase==="selecting-field"?s.jsx("span",{children:"Click an element to map to selected field"}):r.mode==="quick"?s.jsxs("span",{children:["Click elements to add fields. ",s.jsx("span",{className:"font-medium",children:"ESC"})," to finish"]}):s.jsxs("span",{children:["Select a field, then click element. ",s.jsx("span",{className:"font-medium",children:"ESC"})," to finish"]})})]})}),s.jsx(ur,{isOpen:x,suggestedName:k,editingField:S,onSubmit:zt,onCancel:()=>zt(null),portalContainer:a}),s.jsx(fr,{isOpen:E,pattern:le,onSubmit:qt,onCancel:()=>qt(null),portalContainer:a}),s.jsx(Nt,{isOpen:ve,fieldName:ie,currentAttributes:Ee,attributes:pe,onSelectAttributes:Vs,onClose:()=>we(!1),portalContainer:a}),(()=>{var X,ue,Te,Pe;const i=(X=e.current)==null?void 0:X.getCaptureFacade(),p=i==null?void 0:i.getFieldByName(ye),b=p?i.getFieldSelectorMatches(p.id,ge??void 0,!1):[],y=p?i.getFieldSelectorMatches(p.id,ge??void 0,!0):[],v=b.length,I=((ue=p==null?void 0:p.mapping)==null?void 0:ue.matchIndex)??0,M=((Te=p==null?void 0:p.mapping)==null?void 0:Te.matchMode)??"single",U=(Pe=p==null?void 0:p.mapping)==null?void 0:Pe.matchIndexEnd;return s.jsx(Nt,{isOpen:ne,fieldName:`Filter: ${ye}${ge?` (${ge})`:""}`,currentAttributes:N,attributes:z,onSelectAttributes:da,onClose:()=>Ie(!1),portalContainer:a,variant:"filter",matchCount:v,currentMatchIndex:I,onMatchIndexChange:Ae=>ht(ye,Ae,ge??void 0),matchElements:y,onMatchIndexHover:pt,currentMatchMode:M,currentMatchIndexEnd:U,onMatchModeChange:(Ae,Ue,te)=>ha(ye,Ae,Ue,te,ge??void 0)})})(),s.jsx(br,{isOpen:O,fieldName:B,currentExcluded:Se,children:oe,onSelectExcluded:Gs,onClose:()=>_(!1),portalContainer:a}),s.jsx(yr,{isOpen:us,fieldName:ms,values:hs,onClose:()=>Mt(!1),portalContainer:a}),(()=>{var I,M;const i=(I=e.current)==null?void 0:I.getCaptureFacade().getFieldByName(A),p=i?gt(i.id,se??void 0,!1):[],b=i?gt(i.id,se??void 0,!0):[],y=p.length,v=se==="container"?(i==null?void 0:i.containerMatchIndex)??0:se==="item"?(i==null?void 0:i.itemMatchIndex)??0:((M=i==null?void 0:i.mapping)==null?void 0:M.matchIndex)??0;return s.jsx(Sr,{isOpen:ot,fieldName:A,domContext:xe,onSelectParent:Ys,onSelectSibling:Zs,onSelectChild:Qs,onHoverElement:ga,onRevert:Hs,canRevert:!!de,onClear:ea,onClose:()=>ze(!1),portalContainer:a,previousChildIndex:qe,currentSelector:sa(),onApplyCustomSelector:ta,selectorType:se,containerSelector:aa(),containerCandidates:ds,onSelectContainer:ra,onHoverContainer:Ut,initialViewMode:n==="content"?"matches":"tree",matchCount:y,currentMatchIndex:v,onMatchIndexChange:U=>ht(A,U,se??void 0),matchElements:b,onMatchIndexHover:pt})})(),s.jsx(kr,{isOpen:gs,onImport:ws,onClose:()=>Lt(!1),portalContainer:a}),s.jsx($r,{isOpen:xs,onClose:()=>Rt(!1),onLoad:ks,portalContainer:a}),s.jsx(Lr,{isOpen:bs,containers:ys,isScanning:Ss,hasExistingSelector:Cs,onScan:na,onScanFromElement:la,onSelect:ia,onCancel:()=>{ut(!1),ft(null),Ze.current=null},onHighlight:Ut,portalContainer:a})]})}export{Wr as C,rr as I,Pt as S,Qa as a};
