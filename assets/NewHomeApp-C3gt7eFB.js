import{j as r,r as f}from"./react-vendor-Byz07MLO.js";import{a as M}from"./ui-utils-BxIQ3qGg.js";import{a as N,aE as K,bf as L,K as C,ac as G,T as fe,bg as F,bh as ie,O as R,bi as J,aj as me,L as ge,S as xe,h as ye,i as ve,j as Ce,k as we,P as be,$ as Se,Q as je,I as Ne,bj as Pe,bk as Te,b0 as Le,bl as Ae}from"./index-BbgB-sev.js";import{t as k}from"./utils-DjFvUtuq.js";import{bm as Ue,r as ze,D as Ee,C as le,e as ce,b4 as ke,a5 as de,g as Ie,T as Re,a2 as Oe,O as De}from"./icons-Detj0uxE.js";import{c as Be,s as _e,u as _,E as q,a as Me,C as He}from"./CanvasAppV2-diaRJWb7.js";import{m as We,M as $e}from"./MobileLogViewer-BZAVJcj3.js";import{initializeDefaultUsers as Fe,loadActiveUserId as Ve,saveCurrentUser as I,saveActiveUserId as ue,savePresets as E,createTimestamp as H,generateId as Q,loadPresets as Z,saveUsers as D,loadCurrentUser as Xe,loadUsers as Ge}from"./userStoreLocalStorage-D-7v21rP.js";import{switchCanvasStateForUser as Ye}from"./userCanvasStateStorage-BEvN2V8a.js";import"./radix-ui-B6r6BEmy.js";import"./VimInputHandlerV2-Bn_zUAax.js";import"./logging-DcJ9NSa2.js";import"./string-4WCj7OpV.js";import"./clipboardHtmlToMarkdown-BNZmEbgs.js";import"./UiButtonWithExpandOption-BTBhg6Mq.js";import"./TextareaPopoverAtCursor-BhwkV6wH.js";import"./cursorPosition-otMhJ5rZ.js";import"./definitionHelper-B0BF7rqf.js";import"./DraggableCrudTree-DuzWpmL_.js";import"./DragDropManager-CacIWg_Z.js";import"./treeHelpers-DUv_6quS.js";import"./globalFacadeRegistry-BlelMPVg.js";import"./WorkflowRowItem-D2K2N_Kr.js";import"./UiDataTable-D7m-Jspi.js";import"./react-hooks-CNdHs55p.js";import"./markdownToHtml-C-4HvgxL.js";import"./DraggableTree-B-b0vQsJ.js";import"./useOcr-DjwVfUqd.js";import"./alert-BK0jqY_S.js";import"./JsonViewerApp-BHZpouoC.js";import"./context-menu-kZ000qFP.js";import"./easy-form-Bspz1wFS.js";import"./forms-B7OAPNGv.js";import"./form-DpD9XZBk.js";import"./SessionSidebar-DBUw_wJV.js";import"./tree-C6vP2RM6.js";import"./SlashCommandMenu-DnqxuuX6.js";const Ke=({variant:e="ghost",size:o="icon",className:s,iconClassName:t="h-5 w-5",showTooltip:n=!0})=>{const a=()=>{K.toggle();const i=K.getState();k.success(`Element Inspector ${i?"activated":"deactivated"}`,{description:i?"Hover over elements to inspect, click to collect, press ESC to exit":"Inspector mode deactivated",duration:3e3})};return r.jsx(N,{variant:e,size:o,onClick:a,className:s,title:n?"Toggle Element Inspector (Ctrl+Shift+I)":void 0,"aria-label":"Toggle Element Inspector","data-test":"element-inspector-button",children:r.jsx(Ue,{className:t})})},ee=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const o=Math.random()*16|0;return(e==="x"?o:o&3|8).toString(16)}),Je=1,V="cs:",pe={[C.RECT]:0,[C.TEXT]:1,[C.TEXTCARD]:2,[C.DRAWING]:3,[C.CHAT]:4},qe={0:C.RECT,1:C.TEXT,2:C.TEXTCARD,3:C.DRAWING,4:C.CHAT},O=e=>e.slice(0,8),Qe=e=>{if(typeof e=="string")return e;if(typeof e=="number")return String(e);e!=null},Ze=e=>{var n;const o=pe[e.type];if(o===void 0)return null;const s={i:O(e.id),x:Math.round(e.x),y:Math.round(e.y),t:o};e.width&&(s.w=Math.round(e.width)),e.height&&(s.h=Math.round(e.height));const t=Qe(e.content);if(t&&(s.c=t),e.title&&(s.l=e.title),e.type===C.DRAWING&&e.data){const a=e.data,i=Be(a,30);s.d=et(i)}if(e.type===C.CHAT&&e.data){const a=e.data;(n=a.childNodeIds)!=null&&n.length&&(s.ch=a.childNodeIds.map(O))}return s},et=e=>{var s;return(s=e.elements)!=null&&s.length?{el:e.elements.map(t=>{const n={t:t.type==="freehand"?"f":"s",c:t.style.strokeColor,w:t.style.strokeWidth};return t.type==="freehand"&&t.stroke?n.p=_e(t.stroke.smoothedPath,0):t.type==="shape"&&t.shape&&(n.st={t:t.shape.shapeType,s:[Math.round(t.shape.startPoint.x),Math.round(t.shape.startPoint.y)],e:[Math.round(t.shape.endPoint.x),Math.round(t.shape.endPoint.y)]}),n}),iw:e.intrinsicWidth?Math.round(e.intrinsicWidth):void 0,ih:e.intrinsicHeight?Math.round(e.intrinsicHeight):void 0}:void 0},tt=e=>({i:O(e.id),s:e.startNodeId?O(e.startNodeId):null,e:e.endNodeId?O(e.endNodeId):null,sp:[Math.round(e.startPoint.x),Math.round(e.startPoint.y)],ep:[Math.round(e.endPoint.x),Math.round(e.endPoint.y)],l:e.label||void 0}),st=(e,o)=>{const s=e.filter(a=>pe[a.type]!==void 0).map(Ze).filter(a=>a!==null),t=new Set(s.map(a=>a.i)),n=o.filter(a=>{const i=!a.startNodeId||t.has(O(a.startNodeId)),d=!a.endNodeId||t.has(O(a.endNodeId));return i&&d}).map(tt);return{v:Je,n:s,a:n}},te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",B="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",nt=e=>{let o="";const s=e.length;for(let t=0;t<s;t+=3){const n=e[t],a=t+1<s?e[t+1]:0,i=t+2<s?e[t+2]:0,d=n<<16|a<<8|i;o+=B[d>>18&63],o+=B[d>>12&63],t+1<s&&(o+=B[d>>6&63]),t+2<s&&(o+=B[d&63])}return o},rt=e=>{const o={};for(let c=0;c<B.length;c++)o[B[c]]=c;for(let c=0;c<te.length;c++)o[te[c]]=c;const s=e.replace(/[\s=]+/g,""),t=s.length,n=t%4,i=Math.floor(t/4)*3+(n===0?0:n-1),d=new Uint8Array(i);let u=0;for(let c=0;c<t;c+=4){const l=o[s[c]]??0,h=c+1<t?o[s[c+1]]??0:0,m=c+2<t?o[s[c+2]]??0:0,x=c+3<t?o[s[c+3]]??0:0,b=l<<18|h<<12|m<<6|x;u<i&&(d[u++]=b>>16&255),c+2<t&&u<i&&(d[u++]=b>>8&255),c+3<t&&u<i&&(d[u++]=b&255)}return d},ot=async(e,o)=>{const s=st(e,o),t=JSON.stringify(s),a=new TextEncoder().encode(t),i=new CompressionStream("gzip"),d=i.writable.getWriter();d.write(a),d.close();const u=[],c=i.readable.getReader();for(;;){const{done:v,value:A}=await c.read();if(v)break;u.push(A)}const l=u.reduce((v,A)=>v+A.length,0),h=new Uint8Array(l);let m=0;for(const v of u)h.set(v,m),m+=v.length;const x=nt(h),b=V+x;return L.clientLogsApiClient.sendLogs("encode",{compressedBytes:h.length,first10Bytes:Array.from(h.slice(0,10)),base64Length:x.length,first50Chars:x.slice(0,50)},"share-debug.log"),{url:b,stats:{nodeCount:s.n.length,arrowCount:s.a.length,rawSize:t.length,compressedSize:b.length,compressionRatio:Math.round((1-b.length/t.length)*100)}}},se=async e=>{const o=e.trim();if(!o.startsWith(V))return L.clientLogsApiClient.sendLogs("decode_error",{reason:"missing_prefix",inputStart:o.slice(0,20)},"share-debug.log"),null;try{const s=o.slice(V.length),t=rt(s);L.clientLogsApiClient.sendLogs("decode_start",{base64Length:s.length,first50Chars:s.slice(0,50),compressedBytes:t.length,first10Bytes:Array.from(t.slice(0,10))},"share-debug.log");const n=new DecompressionStream("gzip"),a=n.writable.getWriter();a.write(t),a.close();const i=[],d=n.readable.getReader();for(;;){const{done:m,value:x}=await d.read();if(m)break;i.push(x)}const u=i.reduce((m,x)=>m+x.length,0),c=new Uint8Array(u);let l=0;for(const m of i)c.set(m,l),l+=m.length;const h=new TextDecoder().decode(c);return L.clientLogsApiClient.sendLogs("decode_success",{jsonLength:h.length},"share-debug.log"),JSON.parse(h)}catch(s){return L.clientLogsApiClient.sendLogs("decode_error",{reason:"exception",error:s instanceof Error?s.message:String(s)},"share-debug.log"),null}},ne=e=>{const o=new Map,s=e.n.map(n=>{const a=ee();o.set(n.i,a);const i={id:a,x:n.x,y:n.y,type:qe[n.t]??C.RECT};return n.w&&(i.width=n.w),n.h&&(i.height=n.h),n.c&&(i.content=n.c),n.l&&(i.title=n.l),n.d&&(i.data=at(n.d)),i});e.n.forEach((n,a)=>{var i;if((i=n.ch)!=null&&i.length){const d=n.ch.map(u=>o.get(u)).filter(u=>u!==void 0);s[a].data={...s[a].data||{},childNodeIds:d,viewMode:"canvas"}}});const t=e.a.map(n=>({id:ee(),startNodeId:n.s?o.get(n.s)??null:null,endNodeId:n.e?o.get(n.e)??null:null,startPoint:{x:n.sp[0],y:n.sp[1]},endPoint:{x:n.ep[0],y:n.ep[1]},label:n.l}));return{nodes:s,arrows:t}},at=e=>({elements:e.el.map(s=>s.t==="f"&&s.p?{type:"freehand",stroke:{points:[],smoothedPath:s.p},style:{strokeColor:s.c,strokeWidth:s.w,strokeStyle:"solid"}}:s.t==="s"&&s.st?{type:"shape",shape:{shapeType:s.st.t,startPoint:{x:s.st.s[0],y:s.st.s[1]},endPoint:{x:s.st.e[0],y:s.st.e[1]}},style:{strokeColor:s.c,strokeWidth:s.w,strokeStyle:"solid"}}:{type:"freehand",stroke:{points:[],smoothedPath:""},style:{strokeColor:s.c,strokeWidth:s.w,strokeStyle:"solid"}}),intrinsicWidth:e.iw,intrinsicHeight:e.ih}),it=({isOpen:e,onClose:o,triggerPosition:s})=>{const[t,n]=f.useState(""),[a,i]=f.useState(!1),[d,u]=f.useState(null),[c,l]=f.useState(null),h=_(y=>{var g;return((g=y.projectCanvas.getActive())==null?void 0:g.coreState.nodes)??q}),m=_(y=>{var g;return((g=y.projectCanvas.getActive())==null?void 0:g.coreState.arrows)??q}),x=_(y=>y.setNodes),b=_(y=>y.arrow.setAll);f.useEffect(()=>{if(!t||!t.startsWith("cs:")){L.clientLogsApiClient.sendLogs("ui_parse_skip",{reason:t?"no_prefix":"empty",valueLength:(t==null?void 0:t.length)??0,first20:(t==null?void 0:t.slice(0,20))??""},"share-debug.log"),l(null);return}(async()=>{try{L.clientLogsApiClient.sendLogs("ui_parse_start",{valueLength:t.length},"share-debug.log");const g=await se(t);if(!g){L.clientLogsApiClient.sendLogs("ui_parse_null_payload",{valueLength:t.length},"share-debug.log"),l({textCount:0,drawingCount:0,chatCount:0,arrowCount:0,isValid:!1});return}const{nodes:S,arrows:j}=ne(g),P=S.filter(w=>w.type===C.RECT||w.type===C.TEXT||w.type===C.TEXTCARD).length,p=S.filter(w=>w.type===C.DRAWING).length,T=S.filter(w=>w.type===C.CHAT).length;L.clientLogsApiClient.sendLogs("ui_parse_success",{textCount:P,drawingCount:p,chatCount:T,arrowCount:j.length},"share-debug.log"),l({textCount:P,drawingCount:p,chatCount:T,arrowCount:j.length,isValid:!0})}catch(g){L.clientLogsApiClient.sendLogs("ui_parse_error",{error:g instanceof Error?g.message:String(g)},"share-debug.log"),l({textCount:0,drawingCount:0,chatCount:0,arrowCount:0,isValid:!1})}})()},[t]);const v=f.useCallback(async()=>{var y;try{const{url:g,stats:S}=await ot(h,m);if((y=navigator.clipboard)!=null&&y.writeText)await navigator.clipboard.writeText(g);else{const j=document.createElement("textarea");j.value=g,j.style.position="fixed",j.style.left="-9999px",j.style.top="0",document.body.appendChild(j),j.focus(),j.select();const P=document.execCommand("copy");if(document.body.removeChild(j),!P)throw new Error("Copy command failed")}u(S),i(!0),setTimeout(()=>i(!1),2e3),k.success("Canvas copied!",{description:`${S.nodeCount} nodes, ${S.arrowCount} arrows (${S.compressionRatio}% smaller)`})}catch(g){k.error("Failed to copy",{description:g instanceof Error?g.message:"Unknown error"})}},[h,m]),A=f.useCallback(async()=>{if(t.startsWith("cs:"))try{const y=await se(t);if(!y){k.error("Invalid share data");return}const{nodes:g,arrows:S}=ne(y),j=g.filter(w=>w.type===C.RECT||w.type===C.TEXT||w.type===C.TEXTCARD).length,P=g.filter(w=>w.type===C.DRAWING).length,p=g.filter(w=>w.type===C.CHAT).length;g.length>0&&x(w=>[...w,...g]),S.length>0&&b(w=>[...w,...S]);const T=[];j>0&&T.push(`${j} text`),P>0&&T.push(`${P} drawings`),p>0&&T.push(`${p} chats`),S.length>0&&T.push(`${S.length} arrows`),k.success("Canvas imported!",{description:`Added ${T.join(", ")}`}),n(""),l(null),o()}catch(y){k.error("Failed to import",{description:y instanceof Error?y.message:"Invalid data"})}},[t,x,b,o]),z=r.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:v,title:"Copy canvas to clipboard","data-test":"canvas-share-copy-button",children:a?r.jsx(le,{size:14,className:"text-green-500"}):r.jsx(ce,{size:14})});return r.jsx(G,{isVisible:e,onClose:o,title:"Share Canvas",triggerPosition:s,initialSize:{width:400,height:300},resizable:!0,headerActions:z,showPinButton:!1,showInspectorButton:!1,anchorOrigin:"top-right",children:r.jsxs("div",{className:"p-3 flex flex-col gap-3 h-full","data-test":"canvas-share-content",children:[d&&r.jsxs("div",{className:"text-xs text-muted-foreground bg-muted/50 rounded p-2","data-test":"canvas-share-stats",children:["Last copy: ",d.nodeCount," nodes, ",d.arrowCount," arrows",r.jsx("br",{}),"Size: ",d.rawSize," â†’ ",d.compressedSize," bytes (",d.compressionRatio,"% reduction)"]}),r.jsxs("div",{className:"flex flex-col gap-1 flex-1 min-h-0",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("label",{className:"text-xs font-medium",htmlFor:"paste-input",children:"Paste to import:"}),t&&r.jsx("button",{type:"button",onClick:()=>n(""),className:"text-xs text-muted-foreground hover:text-foreground transition-colors","data-test":"canvas-share-clear-button",children:"Clear"})]}),r.jsx(fe,{id:"paste-input",placeholder:"Paste cs:... data here",value:t,onChange:y=>n(y.target.value),className:"flex-1 min-h-[80px] text-xs font-mono resize-none","data-test":"canvas-share-paste-input"}),c&&r.jsx("div",{className:"flex items-center justify-between gap-2 mt-1","data-test":"canvas-share-import-preview",children:c.isValid?r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"text-xs text-muted-foreground",children:[c.textCount>0&&`${c.textCount} text`,c.drawingCount>0&&`${c.drawingCount} drawings`,c.chatCount>0&&`${c.chatCount} chats`,c.arrowCount>0&&`${c.arrowCount} arrows`].filter(Boolean).join(", ")}),r.jsxs(N,{size:"sm",onClick:A,className:"gap-1","data-test":"canvas-share-import-button",children:[r.jsx(Ee,{size:14}),"Import"]})]}):r.jsx("span",{className:"text-xs text-destructive",children:"Invalid share data"})})]})]})})},lt=({onClick:e})=>{const o=s=>{const t=s.currentTarget.getBoundingClientRect();e({x:t.right,y:t.bottom+8})};return r.jsx(N,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5",onClick:o,title:"Share Canvas","data-test":"canvas-share-trigger",children:r.jsx(ze,{className:"h-5 w-5"})})};function X(e){return ie(JSON.stringify(e))}function ct(e){return ie(JSON.stringify(e))}function Y(e){const o=Object.values(e.nodes),s=ct(e);let t=0,n=null;const a={},i={};for(const c of o){const l=X(c);l>t&&(t=l,n=c.id);const h=c.operation.type;a[h]=(a[h]||0)+1,i[h]=(i[h]||0)+l}const d=o.filter(c=>c.children.length>1).length,u=ut(e);return{nodeCount:o.length,totalSizeBytes:s,totalSizeFormatted:F(s),avgNodeSizeBytes:o.length>0?Math.round(s/o.length):0,avgNodeSizeFormatted:F(o.length>0?s/o.length:0),largestNodeSizeBytes:t,largestNodeId:n,operationTypeCounts:a,operationTypeSizes:i,branchCount:d,maxDepth:u}}function dt(e,o){const t=Object.values(e.nodes).map(n=>({nodeId:n.id,operationType:n.operation.type,sizeBytes:X(n),sizeFormatted:F(X(n)),timestamp:n.timestamp,label:n.label||n.operation.type}));return t.sort((n,a)=>a.sizeBytes-n.sizeBytes),o?t.slice(0,o):t}function he(e){const o=Y(e),s=[];for(const[t,n]of Object.entries(o.operationTypeSizes)){const a=o.operationTypeCounts[t]||0;s.push({type:t,count:a,totalSize:n,avgSize:a>0?Math.round(n/a):0,formatted:F(n)})}return s.sort((t,n)=>n.totalSize-t.totalSize),s}function ut(e){if(!e.root)return 0;function o(s,t){if(t.has(s))return 0;t.add(s);const n=e.nodes[s];if(!n)return 0;if(n.children.length===0)return 1;let a=0;for(const i of n.children)a=Math.max(a,o(i,t));return 1+a}return o(e.root,new Set)}function pt(e,o=1e4){return dt(e).filter(s=>s.sizeBytes>o)}function ht(e){const o=Y(e),s=he(e);let t=`# Undo Tree Summary

`;t+=`## Statistics
`,t+=`- Total nodes: ${o.nodeCount}
`,t+=`- Total size: ${o.totalSizeFormatted}
`,t+=`- Average node size: ${o.avgNodeSizeFormatted}
`,t+=`- Branches: ${o.branchCount}
`,t+=`- Max depth: ${o.maxDepth}

`,t+=`## Size by Operation Type
`;for(const n of s)t+=`- ${n.type}: ${n.count} ops, ${n.formatted}
`;return t}function ft(){const[e,o]=f.useState(null),[s,t]=f.useState(!1),[n,a]=f.useState(!1),i=async()=>{a(!0);try{const c=R.getState().undo.getTreeData()??J(),l=Y(c),h=he(c),m=pt(c,5e3),x=await R.getState().undo.getArchiveStats();o({stats:l,byType:h,bloated:m,archive:x})}finally{a(!1)}},d=()=>{const c=R.getState().undo.getTreeData()??J(),l=ht(c);navigator.clipboard.writeText(l),t(!0),setTimeout(()=>t(!1),2e3)};return r.jsxs("div",{className:"flex flex-col gap-2","data-test":"undo-storage-analyzer",children:[r.jsxs("div",{className:"flex gap-2",children:[r.jsx(N,{variant:"outline",size:"sm",onClick:i,disabled:n,"data-test":"analyze-undo-storage-button",children:n?"Analyzing...":"Analyze Undo Storage"}),e&&r.jsx(N,{variant:"outline",size:"sm",onClick:d,"data-test":"copy-undo-summary-button",children:s?"Copied!":"Copy Summary"})]}),e&&r.jsxs("div",{className:"text-xs space-y-2 max-h-48 overflow-y-auto p-2 bg-muted rounded","data-test":"undo-analysis-results",children:[r.jsxs("div",{"data-test":"undo-stats-overview",children:[r.jsx("span",{className:"font-medium",children:"In Memory:"})," ",e.stats.totalSizeFormatted,r.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(",e.stats.nodeCount," nodes, avg ",e.stats.avgNodeSizeFormatted,")"]})]}),e.archive&&r.jsxs("div",{"data-test":"undo-stats-archive",children:[r.jsx("span",{className:"font-medium",children:"Archived:"})," ",r.jsxs("span",{className:"text-muted-foreground",children:[e.archive.archivedCount," / ",e.archive.archiveLimit," nodes"]}),r.jsxs("span",{className:"ml-2 text-muted-foreground",children:["(limit: ",e.archive.historyLimit," in memory)"]})]}),e.byType.length>0&&r.jsxs("div",{"data-test":"undo-stats-by-type",children:[r.jsx("span",{className:"font-medium",children:"By Type:"}),r.jsx("ul",{className:"ml-2",children:e.byType.slice(0,5).map(u=>r.jsxs("li",{className:"text-muted-foreground",children:[u.type,": ",u.formatted," (",u.count,")"]},u.type))})]}),e.bloated.length>0&&r.jsxs("div",{className:"text-amber-600","data-test":"undo-stats-bloated",children:[r.jsxs("span",{className:"font-medium",children:["Bloated (",e.bloated.length,"):"]}),r.jsx("ul",{className:"ml-2",children:e.bloated.slice(0,3).map(u=>r.jsxs("li",{children:[u.label,": ",u.sizeFormatted]},u.nodeId))})]})]})]})}const re="debug-reset-canvas-on-reload";function mt(){const[e,o]=f.useState(!1),[s,t]=f.useState(!1),[n,a]=f.useState(!1),[i,d]=f.useState();f.useEffect(()=>{localStorage.getItem(re)==="true"&&(o(!0),R.getState().resetState())},[]);const u=l=>{o(l),localStorage.setItem(re,String(l))},c=l=>{const h=l.currentTarget.getBoundingClientRect();d({x:h.left,y:h.bottom+8}),a(!0)};return r.jsxs(r.Fragment,{children:[r.jsx(N,{variant:"ghost",size:"icon",className:"hover:bg-secondary/80 rounded p-1.5","data-test":"debug-popover-trigger",onClick:c,children:r.jsx(ke,{className:"h-5 w-5"})}),r.jsx(G,{isVisible:n,onClose:()=>a(!1),title:"Debug Actions",triggerPosition:i,className:"w-72",children:r.jsxs("div",{className:"flex flex-col gap-3 p-3","data-test":"debug-popover-content",children:[r.jsx(N,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>R.getState().resetState(),"data-test":"reset-canvas-state-button",children:"Reset canvas state"}),r.jsx(N,{variant:"outline",size:"sm",className:"border-destructive text-destructive hover:bg-destructive/10",onClick:()=>R.getState().resetEverything(),"data-test":"reset-everything-button",children:"Reset everything"}),r.jsxs("div",{className:"flex items-center gap-2","data-test":"reset-on-reload-container",children:[r.jsx(me,{id:"reset-on-reload",checked:e,onCheckedChange:u,"data-test":"reset-on-reload-checkbox"}),r.jsx(ge,{htmlFor:"reset-on-reload",className:"text-sm cursor-pointer","data-test":"reset-on-reload-label",children:"Reset on reload"})]}),r.jsx("hr",{className:"border-border"}),r.jsx("p",{className:"text-sm font-medium",children:"Storage Analysis"}),r.jsx(ft,{}),r.jsx("hr",{className:"border-border"}),r.jsx("p",{className:"text-sm font-medium",children:"Mobile Logs"}),r.jsxs("div",{className:"flex gap-2","data-test":"mobile-logs-actions",children:[r.jsx(N,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>{const l=!s;t(l),l&&a(!1)},"data-test":"toggle-mobile-logs-button",children:s?"Hide Mobile Logs":"Show Mobile Logs"}),r.jsx(N,{variant:"outline",size:"sm",onClick:async()=>{await We.copyToClipboard()?k.success("Logs copied to clipboard!"):k.error("Failed to copy logs")},title:"Copy mobile logs to clipboard","data-test":"copy-mobile-logs-button",children:r.jsx(ce,{className:"h-4 w-4"})})]})]})}),s&&r.jsx($e,{defaultVisible:!0,autoRefresh:!0,refreshInterval:500,onClose:()=>t(!1)})]})}const W=Fe(),oe=Ve(),$=oe&&W.find(e=>e.id===oe)||W[0];$&&(I($),ue($.id));const ae={currentUser:$||null,users:W,presets:[],isLoading:!1,isOffline:!0,error:null,_apiClient:null},U=Me((e,o)=>({...ae,setApiClient:s=>e({_apiClient:s}),loadUsers:async()=>{e({isLoading:!0,error:null});const s=o()._apiClient;if(s)try{const n=await s.getUsers();D(n),e({users:n,isLoading:!1,isOffline:!1});return}catch{}const t=Ge();e({users:t||[],isLoading:!1,isOffline:!0})},loadActiveUser:async()=>{e({isLoading:!0,error:null});const s=o()._apiClient;if(s)try{const a=await s.getActiveUser();I(a),e({currentUser:a,isLoading:!1,isOffline:!1}),a&&await o().loadPresets(a.id);return}catch{}const t=Xe(),n=Z();e({currentUser:t,presets:n||[],isLoading:!1,isOffline:!0})},setActiveUser:async s=>{e({isLoading:!0,error:null});const t=o()._apiClient,n=o().currentUser;let a=!t;if(t)try{await t.setActiveUser(s),a=!1}catch{a=!0}if(ue(s),s){const d=o().users.find(u=>u.id===s);d?(await Ye((n==null?void 0:n.id)??null,d.id,d.username),I(d),e({currentUser:d,isLoading:!1,isOffline:a}),await o().loadPresets(s)):await o().loadActiveUser()}else I(null),E([]),e({currentUser:null,presets:[],isLoading:!1,isOffline:a})},createUser:async s=>{e({isLoading:!0,error:null});const t=o()._apiClient,n=H(),a={id:Q(),username:s,profilePicture:"",isOnline:!0,lastSeen:n,createdAt:n,updatedAt:n};if(t)try{const d=await t.createUser({username:s}),u=[...o().users,d];return D(u),e({users:u,isLoading:!1,isOffline:!1}),d}catch{}const i=[...o().users,a];return D(i),e({users:i,isLoading:!1,isOffline:!0}),a},updateUser:async(s,t)=>{e({isLoading:!0,error:null});const n=o()._apiClient;if(n)try{const l=await n.updateUser(s,t),h=o().users.map(b=>b.id===s?l:b),m=o().currentUser,x=(m==null?void 0:m.id)===s?l:m;D(h),x&&I(x),e({users:h,currentUser:x,isLoading:!1,isOffline:!1});return}catch{}const a=o().users.find(l=>l.id===s);if(!a){e({error:"User not found",isLoading:!1});return}const i={...a,...t,updatedAt:H()},d=o().users.map(l=>l.id===s?i:l),u=o().currentUser,c=(u==null?void 0:u.id)===s?i:u;D(d),c&&I(c),e({users:d,currentUser:c,isLoading:!1,isOffline:!0})},deleteUser:async s=>{e({isLoading:!0,error:null});const t=o()._apiClient;let n=!t;if(t)try{await t.deleteUser(s),n=!1}catch{n=!0}const a=o().users.filter(u=>u.id!==s),i=o().currentUser,d=(i==null?void 0:i.id)===s;D(a),d&&(I(null),E([])),e({users:a,currentUser:d?null:i,presets:d?[]:o().presets,isLoading:!1,isOffline:n})},loadPresets:async s=>{e({isLoading:!0,error:null});const t=o()._apiClient;if(t)try{const i=await t.getPresets(s);E(i),e({presets:i,isLoading:!1,isOffline:!1});return}catch{}const n=Z(),a=(n==null?void 0:n.filter(i=>i.userId===s))||[];e({presets:a,isLoading:!1,isOffline:!0})},createPreset:async(s,t)=>{const n=o().currentUser;if(!n)throw e({error:"No active user"}),new Error("No active user");e({isLoading:!0,error:null});const a=o()._apiClient,i=H(),d={id:Q(),userId:n.id,name:s,settings:t||{},createdAt:i,updatedAt:i};if(a)try{const c=await a.createPreset(n.id,{name:s,settings:t}),l=[...o().presets,c];return E(l),e({presets:l,isLoading:!1,isOffline:!1}),c}catch{}const u=[...o().presets,d];return E(u),e({presets:u,isLoading:!1,isOffline:!0}),d},updatePreset:async(s,t)=>{e({isLoading:!0,error:null});const n=o()._apiClient;if(n)try{const u=await n.updatePreset(s,t),c=o().presets.map(l=>l.id===s?u:l);E(c),e({presets:c,isLoading:!1,isOffline:!1});return}catch{}const a=o().presets.find(u=>u.id===s);if(!a){e({error:"Preset not found",isLoading:!1});return}const i={...a,...t,updatedAt:H()},d=o().presets.map(u=>u.id===s?i:u);E(d),e({presets:d,isLoading:!1,isOffline:!0})},deletePreset:async s=>{e({isLoading:!0,error:null});const t=o()._apiClient;let n=!t;if(t)try{await t.deletePreset(s),n=!1}catch{n=!0}const a=o().presets.filter(i=>i.id!==s);E(a),e({presets:a,isLoading:!1,isOffline:n})},applyPreset:async s=>{const t=o().currentUser;if(!t){e({error:"No active user"});return}e({isLoading:!0,error:null});const n=o()._apiClient;if(n)try{await n.applyPreset(t.id,s),e({isLoading:!1,isOffline:!1});return}catch{}e({isLoading:!1,isOffline:!0})},clearError:()=>e({error:null}),reset:()=>e(ae)})),gt=320,xt=400;function yt({isOpen:e,onClose:o,triggerPosition:s}){const t=U(p=>p.currentUser),n=U(p=>p.users),a=U(p=>p.presets),i=U(p=>p.setActiveUser),d=U(p=>p.createPreset),u=U(p=>p.deletePreset),c=U(p=>p.applyPreset),l=U(p=>p.isLoading),[h,m]=f.useState(!0),[x,b]=f.useState(""),[v,A]=f.useState(!1),[z,y]=f.useState(null),g=p=>{i(p)},S=async()=>{if(x.trim()){A(!0);try{await d(x.trim()),b("")}finally{A(!1)}}},j=async p=>{y(p.id),await c(p.id)},P=async p=>{await u(p),z===p&&y(null)};return r.jsx(G,{isVisible:e,onClose:o,title:"User Settings",triggerPosition:s,initialSize:{width:gt,height:xt},resizable:!0,shouldCloseManually:!0,anchorOrigin:"top-right","data-test":"user-settings-popover",children:r.jsxs("div",{className:"p-4 space-y-4","data-test":"user-settings-content",children:[r.jsx("section",{"data-test":"user-info-section",children:r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"w-12 h-12 rounded-full bg-muted flex items-center justify-center","data-test":"user-avatar",children:t!=null&&t.profilePicture?r.jsx("img",{src:t.profilePicture,alt:t.username,className:"w-full h-full rounded-full object-cover"}):r.jsx(de,{className:"w-6 h-6 text-muted-foreground"})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"font-medium text-sm","data-test":"user-display-name",children:(t==null?void 0:t.username)||"No user"}),r.jsxs(xe,{value:(t==null?void 0:t.id)||"",onValueChange:g,children:[r.jsx(ye,{className:"h-7 text-xs mt-1","data-test":"user-switcher-select",children:r.jsx(ve,{placeholder:"Switch user"})}),r.jsx(Ce,{"data-test":"user-switcher-dropdown",children:n.map(p=>r.jsx(we,{value:p.id,"data-test":`user-option-${p.id}`,children:p.username},p.id))})]})]})]})}),r.jsxs(be,{open:h,onOpenChange:m,children:[r.jsxs(Se,{className:"flex items-center justify-between w-full py-2 text-sm font-medium hover:bg-muted/50 rounded px-2 -mx-2","data-test":"presets-section-trigger",children:[r.jsx("span",{children:"Presets"}),r.jsx(Ie,{className:M("w-4 h-4 transition-transform",h&&"rotate-180")})]}),r.jsx(je,{"data-test":"presets-section-content",children:r.jsxs("div",{className:"mt-2 space-y-2",children:[a.length===0?r.jsx("p",{className:"text-xs text-muted-foreground py-2","data-test":"no-presets-message",children:"No presets yet. Create one below."}):r.jsx("ul",{className:"space-y-1","data-test":"presets-list",children:a.map(p=>r.jsxs("li",{className:M("flex items-center justify-between px-2 py-1.5 rounded text-sm","hover:bg-muted/50 transition-colors",z===p.id&&"bg-muted"),"data-test":`preset-item-${p.id}`,children:[r.jsxs("button",{className:"flex items-center gap-2 flex-1 text-left",onClick:()=>void j(p),disabled:l,"data-test":`preset-apply-${p.id}`,children:[r.jsx("span",{className:M("w-4 h-4 rounded-full border flex items-center justify-center",z===p.id?"border-primary bg-primary":"border-muted-foreground"),children:z===p.id&&r.jsx(le,{className:"w-3 h-3 text-primary-foreground"})}),r.jsx("span",{children:p.name})]}),r.jsx(N,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>void P(p.id),disabled:l,"data-test":`preset-delete-${p.id}`,children:r.jsx(Re,{className:"w-3 h-3"})})]},p.id))}),r.jsxs("div",{className:"flex items-center gap-2 pt-2","data-test":"create-preset-form",children:[r.jsx(Ne,{placeholder:"New preset name",value:x,onChange:p=>b(p.target.value),onKeyDown:p=>{p.key==="Enter"&&S()},className:"h-8 text-sm",disabled:v,"data-test":"new-preset-input"}),r.jsx(N,{variant:"outline",size:"icon",className:"h-8 w-8",onClick:()=>void S(),disabled:!x.trim()||v,"data-test":"create-preset-button",children:r.jsx(Oe,{className:"w-4 h-4"})})]})]})})]})]})})}function vt({variant:e="ghost",size:o="icon"}){const s=U(c=>c.currentUser),[t,n]=f.useState(!1),[a,i]=f.useState(),d=f.useRef(null),u=()=>{if(d.current){const c=d.current.getBoundingClientRect();i({x:c.right,y:c.bottom+8})}n(!0)};return r.jsxs(r.Fragment,{children:[r.jsx(N,{ref:d,variant:e,size:o,onClick:u,"aria-label":"User settings",title:(s==null?void 0:s.username)||"User settings","data-test":"user-button",children:s!=null&&s.profilePicture?r.jsx("img",{src:s.profilePicture,alt:s.username,className:"w-5 h-5 rounded-full object-cover"}):r.jsx("span",{className:"flex items-center justify-center",children:s!=null&&s.username?r.jsx("span",{className:"text-sm font-medium",children:s.username.charAt(0).toUpperCase()}):r.jsx(de,{className:"h-5 w-5"})})}),r.jsx(yt,{isOpen:t,onClose:()=>n(!1),triggerPosition:a})]})}function Ct({showCollapseButton:e=!1}){const o=_(l=>l.uiState.floatingHeaderExpanded??!1),[s,t]=f.useState(!1),[n,a]=f.useState(),[i,d]=f.useState(!1),u=f.useRef(o);f.useEffect(()=>{if(u.current&&!o){d(!0);const l=setTimeout(()=>d(!1),300);return()=>clearTimeout(l)}u.current=o},[o]);const c=()=>{R.getState().setUiState(l=>({...l,floatingHeaderExpanded:!l.floatingHeaderExpanded}))};return!o&&!i?null:r.jsx("div",{className:"w-[98vw] pointer-events-none flex justify-end","data-test":"floating-header-wrapper",children:r.jsxs("header",{className:M("bg-card text-card-foreground top-0 flex items-center rounded-md p-2 shadow-md pointer-events-auto",o&&"animate-in slide-in-from-right duration-300",i&&"animate-out slide-out-to-right duration-300"),children:[e&&r.jsx(N,{variant:"ghost",size:"icon",onClick:c,"aria-label":"Collapse header","data-test":"floating-header-collapse-button",children:r.jsx(De,{className:"size-5"})}),r.jsxs("div",{className:M("flex items-center gap-2",e&&"ml-2"),children:[r.jsx("h1",{className:"text-xl whitespace-nowrap",children:"CN-1"}),r.jsx(Pe,{}),r.jsx(Te,{variant:"ghost",size:"icon",title:"Audio Recorder"}),r.jsx(Ke,{}),r.jsx(Le,{}),r.jsx(lt,{onClick:l=>{a(l),t(!0)}}),r.jsx(it,{isOpen:s,onClose:()=>t(!1),triggerPosition:n}),r.jsx(mt,{}),r.jsx(vt,{}),r.jsx(Ae,{})]})]})})}function wt(){const[e,o]=f.useState(!1),[s,t]=f.useState({top:0,left:0}),[n,a]=f.useState(null),i=l=>{const h=l.getBoundingClientRect(),m=window.getComputedStyle(l),x=parseInt(m.lineHeight||m.fontSize),b=l.selectionStart,v=document.createElement("div");["boxSizing","width","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontFamily","fontSize","fontWeight","lineHeight","letterSpacing"].forEach(T=>{v.style[T]=m[T]}),v.style.position="absolute",v.style.top=h.top+"px",v.style.left=h.left+"px",v.style.visibility="hidden",v.style.whiteSpace="pre-wrap",v.style.wordWrap="break-word",v.style.overflow="hidden";const z=l.value.substring(0,b);v.textContent=z;const y=document.createElement("span");y.textContent="|",v.appendChild(y),document.body.appendChild(v);const g=y.getBoundingClientRect();document.body.removeChild(v);const S=g.top-h.top,j=g.left-h.left,P=S+x+4-l.scrollTop,p=j-l.scrollLeft;return{top:P,left:p}};return{showPopover:e,popoverPosition:s,handleKeyDown:l=>{if(l.key==="/"&&!e){const h=l.currentTarget,m=h.selectionStart,x=i(h);t(x),a(m),o(!0)}else(l.key==="Escape"||l.key==="Backspace"&&e&&n!==null&&l.currentTarget.selectionStart===n)&&(o(!1),a(null))},handleChange:l=>{e&&n!==null&&(n>=l.length||l[n]!=="/")&&(o(!1),a(null))},closePopover:()=>{o(!1),a(null)}}}const os=()=>{const[e,o]=f.useState("");return wt(),r.jsxs("div",{className:"page-container w-screen h-screen relative bg-background text-foreground",children:[r.jsx("div",{className:"absolute top-10 left-1/2 -translate-x-1/2 z-[60] pointer-events-none",children:r.jsx(Ct,{})}),r.jsx("main",{className:"content-area w-full h-full",children:r.jsx("div",{className:"demo-section h-full",children:r.jsx(He,{width:"100%",height:"100%"})})})]})};export{os as NewHomeApp};
