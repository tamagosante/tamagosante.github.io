var Z=Object.defineProperty;var S=(n,t,e)=>t in n?Z(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var m=(n,t,e)=>S(n,typeof t!="symbol"?t+"":t,e);function T(n){const t=n.getBoundingClientRect();return{width:t.width,height:t.height}}function E(n){const t=n.getBoundingClientRect();return{x:t.left,y:t.top}}function k(n,t){return n.x>=t.left&&n.x<=t.right&&n.y>=t.top&&n.y<=t.bottom}function z(n,t){return{x:Math.round(n.x/t.x)*t.x,y:Math.round(n.y/t.y)*t.y}}function C(n,t,e){const s={...n};let i=e,r=e;return t.forEach(a=>{const h=E(a),c=T(a),u=[h.x,h.x+c.width],o=[h.y,h.y+c.height];u.forEach(l=>{const g=Math.abs(n.x-l);g<i&&(i=g,s.x=l)}),o.forEach(l=>{const g=Math.abs(n.y-l);g<r&&(r=g,s.y=l)})}),s}function L(n,t,e=[]){if(!t.enabled)return n;let s={...n};return t.snapToGrid&&(s=z(s,t.snapToGrid)),t.snapToElements&&e.length>0&&(s=C(s,e,t.threshold)),s}let d=null,f=null,y=null,D=null;const P=30;function I(n,t){var u;const e=t.filter(o=>k(n,o.rect));if(e.length===0)return d=null,f=null,null;if(d&&f&&e.length>0){const o=((u=t.find(p=>p.zone.id===(d==null?void 0:d.id)))==null?void 0:u.depth)??-1,l=e.some(p=>p.zone.id===(d==null?void 0:d.id)),g=Math.max(...e.map(p=>p.depth));if(!l&&o>=g){y||(y=f);const p=Math.abs(n.x-y.x),x=Math.abs(n.y-f.y);if(p<P&&x>0)return d;y=null}else y=null}if(e.length===1){if(e[0].depth===0&&d&&f){const o=Math.abs(n.x-f.x),l=Math.abs(n.y-f.y),g=d.id==="root";if(o<P&&l>0&&!g)return d}return d=e[0].zone,f=n,e[0].zone}let s=e[0],i=s.depth,r=s.rect.width*s.rect.height;for(const o of e){const l=o.rect.width*o.rect.height;(o.depth>i||o.depth===i&&l<r)&&(i=o.depth,r=l,s=o)}const h=(D?Math.abs(n.x-D.x):0)>=P;if(d&&f&&s.zone.id!==d.id){const o=e.find(l=>l.zone.id===d.id);if(o&&s.depth!==o.depth&&!h)return d}const c=typeof document<"u"?document.elementFromPoint(n.x,n.y):null;if(c){let o=c,l=null;for(;o&&!l;)l=o.getAttribute("data-drag-handle"),l||(o=o.parentElement);if(l&&o){const g=o.getBoundingClientRect(),p=g.top+g.height/2;if(n.y>=p){const b=t.find(w=>w.zone.id===l&&w.depth>s.depth);b&&b.depth>s.depth&&(D?Math.abs(n.x-D.x):0)>=P&&(s=b)}}}return(!d||d.id!==s.zone.id)&&(D=n),d=s.zone,f=n,s.zone}function M(n,t,e,s,i){if(e.length===0)return 0;t.getBoundingClientRect();const r=s==="vertical",a=e.filter(h=>h.id!==i.id);if(a.length===0)return 0;for(let h=0;h<a.length;h++){const c=a[h],u=c.element.getBoundingClientRect(),o=r?u.top+u.height/2:u.left+u.width/2;if((r?n.y:n.x)<o)return e.indexOf(c)}return e.length}function v(n){return"touches"in n&&n.touches.length>0?{x:n.touches[0].clientX,y:n.touches[0].clientY}:"clientX"in n?{x:n.clientX,y:n.clientY}:{x:0,y:0}}const A={snap:{enabled:!1,threshold:10},sort:{enabled:!1,orientation:"vertical",threshold:.5},dragThreshold:5,autoScroll:{enabled:!1,speed:10,margin:50}};class U{constructor(t,e){m(this,"draggables",new Map);m(this,"dropZones",new Map);m(this,"config");m(this,"callbacks");m(this,"state");m(this,"animationFrameId",null);m(this,"scrollInterval",null);m(this,"dragPreview",null);m(this,"lastMoveTimestamp",0);m(this,"cachedZoneGeometry",[]);this.config={...A,...t},this.callbacks=e||{},this.state=this.getInitialState(),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this)}getInitialState(){return{isDragging:!1,item:null,startPosition:{x:0,y:0},currentPosition:{x:0,y:0},offset:{x:0,y:0},currentDropZone:null,potentialDropZone:null,sortIndex:null}}registerDraggable(t,e,s){const i={id:t,element:e,data:s};this.draggables.set(t,i),e.style.setProperty("user-select","none","important"),e.style.setProperty("-webkit-user-select","none","important"),e.style.setProperty("-moz-user-select","none","important"),e.style.setProperty("-ms-user-select","none","important"),e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.setProperty("cursor","move","important"),e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),e.__dndItem=i}unregisterDraggable(t){const e=this.draggables.get(t);e&&(e.element.style.removeProperty("user-select"),e.element.style.removeProperty("-webkit-user-select"),e.element.style.removeProperty("-moz-user-select"),e.element.style.removeProperty("-ms-user-select"),e.element.style.removeProperty("cursor"),e.element.style.userSelect="",e.element.style.webkitUserSelect="",e.element.removeEventListener("mousedown",this.handleMouseDown),e.element.removeEventListener("touchstart",this.handleTouchStart),delete e.element.__dndItem,this.draggables.delete(t))}registerDropZone(t,e,s,i){const r={id:t,element:e,accepts:s,data:i};this.dropZones.set(t,r),e.__dndZone=r}unregisterDropZone(t){const e=this.dropZones.get(t);e&&(delete e.element.__dndZone,this.dropZones.delete(t))}handleMouseDown(t){const e=t.currentTarget.__dndItem;if(!e)return;t.preventDefault();const s=v(t);this.startDrag(e,s)}handleTouchStart(t){const e=t.currentTarget.__dndItem;if(!e)return;const s=v(t);this.startDrag(e,s),t.preventDefault()}startDrag(t,e){const s=E(t.element),i={x:e.x-s.x,y:e.y-s.y};this.cachedZoneGeometry=Array.from(this.dropZones.values()).map(r=>{const a=r.element.getBoundingClientRect();let h=0,c=r.element;for(;c.parentElement&&(c=c.parentElement,c.hasAttribute("data-drop-zone")&&h++,!c.hasAttribute("data-tree-root")););return{id:r.id,rect:{left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height},depth:h,zone:r}}),this.state={isDragging:!1,item:t,startPosition:e,currentPosition:e,offset:i,currentDropZone:null,potentialDropZone:null,sortIndex:null},document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),document.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd),document.body.style.userSelect="none",document.body.style.webkitUserSelect="none"}createDragPreview(){if(this.state.item)try{const t=this.state.item.element;this.dragPreview=t.cloneNode(!0),this.dragPreview.style.position="fixed",this.dragPreview.style.pointerEvents="none",this.dragPreview.style.zIndex="999999",this.dragPreview.style.opacity="0.8",this.dragPreview.style.transform="rotate(3deg)",this.dragPreview.style.transition="none",this.dragPreview.style.backgroundColor="white",this.dragPreview.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",this.dragPreview.style.display="block",this.dragPreview.style.visibility="visible",this.dragPreview.style.border="2px solid #3b82f6";const e=t.getBoundingClientRect();this.dragPreview.style.width=`${e.width}px`,this.dragPreview.style.height=`${e.height}px`,this.updateDragPreviewPosition(this.state.currentPosition),document.body.appendChild(this.dragPreview)}catch(t){console.error("[DragDrop] Failed to create drag preview:",t)}}updateDragPreviewPosition(t){if(!this.dragPreview||!this.state.item)return;const e=t.x-this.state.offset.x,s=t.y-this.state.offset.y;this.dragPreview.style.left=`${e}px`,this.dragPreview.style.top=`${s}px`}removeDragPreview(){this.dragPreview&&this.dragPreview.parentNode&&(this.dragPreview.parentNode.removeChild(this.dragPreview),this.dragPreview=null),document.body.style.userSelect="",document.body.style.webkitUserSelect=""}handleMouseMove(t){if(!this.state.item)return;const e=v(t);this.updateDrag(e)}handleTouchMove(t){if(!this.state.item)return;const e=v(t);this.updateDrag(e),t.preventDefault()}updateDrag(t){var r,a,h;if(!this.state.item)return;const e=this.config.dragThreshold||5,s=Math.hypot(t.x-this.state.startPosition.x,t.y-this.state.startPosition.y);if(!this.state.isDragging&&s>e&&(this.state.isDragging=!0,this.createDragPreview(),this.callbacks.onDragStart&&this.callbacks.onDragStart({item:this.state.item,position:this.state.startPosition})===!1)){this.cancelDrag();return}if(!this.state.isDragging)return;this.updateDragPreviewPosition(t);let i=t;if((r=this.config.snap)!=null&&r.enabled){const c=Array.from(this.draggables.values()).filter(u=>{var o;return u.id!==((o=this.state.item)==null?void 0:o.id)}).map(u=>u.element);i=L(t,this.config.snap,c)}if(this.state.currentPosition=i,this.state.potentialDropZone=I(i,this.cachedZoneGeometry),(a=this.config.sort)!=null&&a.enabled&&this.state.potentialDropZone){const c=this.getItemsInDropZone(this.state.potentialDropZone);this.state.sortIndex=M(i,this.state.potentialDropZone.element,c,this.config.sort.orientation,this.state.item)}this.lastMoveTimestamp=Date.now(),this.callbacks.onDragMove&&this.callbacks.onDragMove({item:this.state.item,position:i,dropZone:this.state.potentialDropZone,sortIndex:this.state.sortIndex}),(h=this.config.autoScroll)!=null&&h.enabled&&this.handleAutoScroll(t)}handleMouseUp(t){const e=v(t);this.endDrag(e)}handleTouchEnd(t){const e=v(t);this.endDrag(e)}endDrag(t){var a;const e=this.state.isDragging,s=this.state.item;let i=this.state.potentialDropZone,r=this.state.sortIndex;if(t){const h=I(t,this.cachedZoneGeometry);if(h&&(i=h,(a=this.config.sort)!=null&&a.enabled&&i&&s)){const c=this.getItemsInDropZone(i);r=M(t,i.element,c,this.config.sort.orientation,s)}}this.removeDragPreview(),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null),e&&s&&(i&&this.callbacks.onDrop&&this.callbacks.onDrop({item:s,dropZone:i,position:this.state.currentPosition,sortIndex:r}),this.callbacks.onDragEnd&&this.callbacks.onDragEnd({item:s,startPosition:this.state.startPosition,endPosition:this.state.currentPosition,dropZone:i,sortIndex:r,cancelled:!1})),this.state=this.getInitialState()}cancelDrag(){const t=this.state.item;this.removeDragPreview(),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd),this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null),t&&this.callbacks.onDragEnd&&this.callbacks.onDragEnd({item:t,startPosition:this.state.startPosition,endPosition:this.state.currentPosition,dropZone:null,sortIndex:null,cancelled:!0}),this.state=this.getInitialState()}getItemsInDropZone(t){const e=[];return this.draggables.forEach(s=>{var i;((i=s.data)==null?void 0:i.dropZoneId)===t.id&&e.push(s)}),e}handleAutoScroll(t){var a;if(!((a=this.config.autoScroll)!=null&&a.enabled))return;const e=this.config.autoScroll.margin,s=this.config.autoScroll.speed;let i=0,r=0;t.x<e?i=-s:t.x>window.innerWidth-e&&(i=s),t.y<e?r=-s:t.y>window.innerHeight-e&&(r=s),i!==0||r!==0?this.scrollInterval||(this.scrollInterval=window.setInterval(()=>{window.scrollBy(i,r)},16)):this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null)}getState(){return{...this.state}}getCachedZoneGeometry(){return this.cachedZoneGeometry}updateConfig(t){this.config={...this.config,...t}}updateCallbacks(t){this.callbacks={...this.callbacks,...t}}destroy(){this.draggables.forEach(t=>this.unregisterDraggable(t.id)),this.dropZones.forEach(t=>this.unregisterDropZone(t.id)),this.state.isDragging&&this.cancelDrag(),this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.scrollInterval&&clearInterval(this.scrollInterval)}}export{U as D};
